VERSION 5.00
Object = "{20C62CAE-15DA-101B-B9A8-444553540000}#1.1#0"; "MSMAPI32.OCX"
Object = "{BDC217C8-ED16-11CD-956C-0000C04E4C0A}#1.1#0"; "TABCTL32.OCX"
Object = "{0ECD9B60-23AA-11D0-B351-00A0C9055D8E}#6.0#0"; "MSHFLXGD.OCX"
Object = "{248DD890-BB45-11CF-9ABC-0080C7E7B78D}#1.0#0"; "MSWINSCK.OCX"
Begin VB.Form frmAutoBatchDay 
   BorderStyle     =   1  '單線固定
   Caption         =   "自動批次作業"
   ClientHeight    =   8976
   ClientLeft      =   4848
   ClientTop       =   2148
   ClientWidth     =   9660
   LinkTopic       =   "Form1"
   LockControls    =   -1  'True
   MaxButton       =   0   'False
   MinButton       =   0   'False
   ScaleHeight     =   8976
   ScaleWidth      =   9660
   Begin VB.TextBox TxtFile 
      Height          =   285
      Left            =   3270
      TabIndex        =   23
      Text            =   "TxtFile"
      Top             =   1680
      Width           =   1695
   End
   Begin VB.FileListBox File2 
      Height          =   180
      Left            =   0
      TabIndex        =   22
      Top             =   480
      Visible         =   0   'False
      Width           =   735
   End
   Begin VB.FileListBox File1 
      Height          =   180
      Left            =   1710
      TabIndex        =   21
      Top             =   7290
      Width           =   2655
   End
   Begin VB.PictureBox G_SeekPicColor 
      Height          =   525
      Left            =   450
      ScaleHeight     =   480
      ScaleWidth      =   504
      TabIndex        =   20
      Top             =   7380
      Width           =   555
   End
   Begin VB.PictureBox pic1 
      Height          =   525
      Left            =   1080
      ScaleHeight     =   480
      ScaleWidth      =   504
      TabIndex        =   19
      Top             =   7380
      Width           =   555
   End
   Begin VB.PictureBox tmpPic 
      Height          =   1575
      Left            =   4440
      ScaleHeight     =   127
      ScaleMode       =   3  '像素
      ScaleWidth      =   100
      TabIndex        =   18
      Top             =   7260
      Width           =   1245
      Begin VB.Image tmpImg 
         Height          =   1770
         Left            =   120
         Stretch         =   -1  'True
         Top             =   270
         Width           =   1890
      End
   End
   Begin VB.Timer Timer1 
      Left            =   900
      Top             =   630
   End
   Begin TabDlg.SSTab stb 
      Height          =   5265
      Left            =   165
      TabIndex        =   1
      Top             =   1965
      Width           =   9255
      _ExtentX        =   16341
      _ExtentY        =   9292
      _Version        =   393216
      Tabs            =   2
      TabsPerRow      =   4
      TabHeight       =   520
      TabCaption(0)   =   "承辦人"
      TabPicture(0)   =   "frmAutoBatchDay.frx":0000
      Tab(0).ControlEnabled=   -1  'True
      Tab(0).Control(0)=   "grd(0)"
      Tab(0).Control(0).Enabled=   0   'False
      Tab(0).ControlCount=   1
      TabCaption(1)   =   "繪圖人員"
      TabPicture(1)   =   "frmAutoBatchDay.frx":001C
      Tab(1).ControlEnabled=   0   'False
      Tab(1).Control(0)=   "grd(1)"
      Tab(1).ControlCount=   1
      Begin MSHierarchicalFlexGridLib.MSHFlexGrid grd 
         Height          =   4800
         Index           =   0
         Left            =   60
         TabIndex        =   2
         Top             =   360
         Width           =   9135
         _ExtentX        =   16108
         _ExtentY        =   8467
         _Version        =   393216
         Rows            =   1
         Cols            =   3
         FixedRows       =   0
         FixedCols       =   2
         AllowBigSelection=   0   'False
         ScrollTrack     =   -1  'True
         HighLight       =   2
         AllowUserResizing=   3
         _NumberOfBands  =   1
         _Band(0).Cols   =   3
      End
      Begin MSHierarchicalFlexGridLib.MSHFlexGrid grd 
         Height          =   4800
         Index           =   1
         Left            =   -74940
         TabIndex        =   3
         Top             =   360
         Width           =   9135
         _ExtentX        =   16108
         _ExtentY        =   8467
         _Version        =   393216
         Rows            =   1
         Cols            =   3
         FixedRows       =   0
         FixedCols       =   2
         AllowBigSelection=   0   'False
         ScrollTrack     =   -1  'True
         HighLight       =   2
         AllowUserResizing=   3
         _NumberOfBands  =   1
         _Band(0).Cols   =   3
      End
   End
   Begin VB.TextBox txt1 
      Height          =   264
      Index           =   0
      Left            =   6450
      MaxLength       =   5
      TabIndex        =   12
      Top             =   75
      Width           =   900
   End
   Begin VB.TextBox txt1 
      Height          =   264
      Index           =   1
      Left            =   6450
      Locked          =   -1  'True
      MaxLength       =   2
      TabIndex        =   11
      Text            =   "1"
      Top             =   465
      Width           =   900
   End
   Begin VB.TextBox txt1 
      Height          =   264
      Index           =   2
      Left            =   7530
      MaxLength       =   2
      TabIndex        =   10
      Top             =   465
      Width           =   900
   End
   Begin VB.TextBox txt1 
      Height          =   264
      Index           =   4
      Left            =   7530
      MaxLength       =   2
      TabIndex        =   9
      Top             =   825
      Width           =   900
   End
   Begin VB.TextBox txt1 
      Height          =   264
      Index           =   3
      Left            =   6450
      MaxLength       =   2
      TabIndex        =   8
      Top             =   825
      Width           =   900
   End
   Begin VB.TextBox txt1 
      Height          =   264
      Index           =   6
      Left            =   7530
      MaxLength       =   2
      TabIndex        =   7
      Top             =   1215
      Width           =   900
   End
   Begin VB.TextBox txt1 
      Height          =   264
      Index           =   5
      Left            =   6450
      MaxLength       =   2
      TabIndex        =   6
      Top             =   1215
      Width           =   900
   End
   Begin VB.TextBox txt1 
      Height          =   264
      Index           =   8
      Left            =   7530
      Locked          =   -1  'True
      MaxLength       =   2
      TabIndex        =   5
      Top             =   1605
      Width           =   900
   End
   Begin VB.TextBox txt1 
      Height          =   264
      Index           =   7
      Left            =   6450
      MaxLength       =   2
      TabIndex        =   4
      Top             =   1605
      Width           =   900
   End
   Begin MSMAPI.MAPIMessages MAPIMessages1 
      Left            =   4980
      Top             =   2820
      _ExtentX        =   974
      _ExtentY        =   974
      _Version        =   393216
      AddressEditFieldCount=   1
      AddressModifiable=   0   'False
      AddressResolveUI=   0   'False
      FetchSorted     =   0   'False
      FetchUnreadOnly =   0   'False
   End
   Begin MSMAPI.MAPISession MAPISession1 
      Left            =   3420
      Top             =   2880
      _ExtentX        =   974
      _ExtentY        =   974
      _Version        =   393216
      DownloadMail    =   -1  'True
      LogonUI         =   -1  'True
      NewSession      =   0   'False
   End
   Begin MSWinsockLib.Winsock Winsock1 
      Left            =   0
      Top             =   0
      _ExtentX        =   593
      _ExtentY        =   593
      _Version        =   393216
   End
   Begin VB.Label Label1 
      Caption         =   "考核月份：                             (Ex : 9206)"
      Height          =   180
      Index           =   5
      Left            =   5250
      TabIndex        =   17
      Top             =   135
      Width           =   3465
   End
   Begin VB.Label Label1 
      Caption         =   "第一週日期："
      Height          =   180
      Index           =   3
      Left            =   5250
      TabIndex        =   16
      Top             =   510
      Width           =   1185
   End
   Begin VB.Label Label1 
      Caption         =   "第二週日期："
      Height          =   180
      Index           =   2
      Left            =   5250
      TabIndex        =   15
      Top             =   870
      Width           =   1185
   End
   Begin VB.Label Label1 
      Caption         =   "第三週日期："
      Height          =   180
      Index           =   1
      Left            =   5250
      TabIndex        =   14
      Top             =   1260
      Width           =   1185
   End
   Begin VB.Label Label1 
      Caption         =   "第四週日期："
      Height          =   180
      Index           =   4
      Left            =   5250
      TabIndex        =   13
      Top             =   1650
      Width           =   1185
   End
   Begin VB.Label Label1 
      Caption         =   "無畫面"
      BeginProperty Font 
         Name            =   "標楷體"
         Size            =   80.4
         Charset         =   136
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      ForeColor       =   &H000000FF&
      Height          =   1665
      Index           =   0
      Left            =   30
      TabIndex        =   0
      Top             =   0
      Width           =   5025
   End
End
Attribute VB_Name = "frmAutoBatchDay"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
'Memo By Morgan 2012/12/12 智權人員欄已修改
'Modified by Morgan 2011/11/24 改要顯示畫面以便釐清偶爾會卡到早上的情形
'Memo by Morgan2010/8/10 日期欄已修改
Option Explicit

Dim CalYM As String
'add by nickc 2005/03/17 改成用 winsock 發
Dim Mailing As Boolean
Dim Result$, Sec%
'Modify by Morgan 2010/10/27 改寄往防火牆

'Const Server$ = "exchange"
Const Server$ = "192.168.1.10"
Const Domain$ = "Taie"
Const TimeOut% = 20
Const MailBefore$ = "IMCEAEX-_O=TAIE_OU=DOMAIN_CN=RECIPIENTS_CN="
Const MailAfter$ = "@taie.com.tw"
Const MailReplace$ = "EX:/O=TAIE/OU=DOMAIN/CN=RECIPIENTS/CN="
Dim F_CP14 As String
Dim F_ST02 As String
Dim F_ST03 As String
Dim F_CP01020304 As String
'add by nickc 2008/04/29
Private Type MailQ
     a0k20 As String
     Name As String
     Text As String
End Type

'Add By Sindy 2009/06/04
Const TextPath = "\textfile\"

'Add By Sindy 98/04/02
Dim Rs2 As New ADODB.Recordset
Dim m_Image As New cImage
Dim m_Jpeg  As cJpeg
Public oRtPic As Boolean
Dim bytes() As Byte
'98/04/02 End

'Add by Amy 2013/04/30
Dim Txt_Head As Boolean
Dim ff1 As Integer
Dim FileFullPath As String, Mail_file As String
'2013/04/30 End
Dim FF2 As Integer 'Add by Amy 2014/05/13 for strMenu51

Dim fso As New FileSystemObject
Dim strEngDate As String '系統日英文格式
Dim bolNewPromoterRule As Boolean 'Add by Morgan 2010/9/27 專利處考核新規則
Dim iMailNo As Integer 'EMail序號 Add by Morgan 2011/9/22

Dim WithEvents eventConn As ADODB.Connection
Attribute eventConn.VB_VarHelpID = -1
Dim bolWorkDay As Boolean 'Add by Lydia 2015/05/25 判斷系統當是否為工作天
Dim m_stRptPS As String 'Added by Morgan 2025/11/18

'每天算速度考核
'Modify by Morgan 2010/7/2 Union 會 distinct 資料而造成少算(如不特定案件的支援統計會重複),故改為 Union all
Sub StrMenu()
Dim tmpnext As String
Dim StrSqlB As String
Dim strMA54 As String

On Error GoTo ErrHD

txt1(0).Text = CalYM
Me.txt1(8).Text = PUB_GetMonthDays(Left(Me.txt1(0).Text + 191100, 4), Val(Mid(Me.txt1(0).Text + 191100, 5, 2)))
SetDate
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset
Dim rsB As New ADODB.Recordset
Dim ii As Integer
Dim intColCount As Integer
Dim StrST01 As String, strST03 As String, strST06 As String, strST13 As String, strST16 As String, strNCFPGoal As String, strCFPGoal As String, strGoal As String
SetGrd
    '承辦人速度考核
    With Me.grd(0)
        '員工編號
        'modify by sonia 2014/4/9 加入94007林景郁總經理
        'Modified by Morgan 2022/10/31 +99050
        StrSQLa = "Select * From Staff Where ST04='1' And (ST05='72' or st05='74' Or ST05='76' Or ST05='77' Or ST05='78' Or ST05='79' or st05='87' or st01='94007' or st01='99050') And ST01<>'88024' And ST01<'F' Order By ST06, ST03, ST01 "
        rsA.CursorLocation = adUseClient
        rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
        ii = 2
        intColCount = 0
        While Not rsA.EOF
            .Cols = .Cols + 1
            .TextMatrix(0, ii) = "" & rsA("ST01").Value
            .row = 0
            .col = ii
            .CellAlignment = flexAlignCenterCenter
            .TextMatrix(34, ii) = "" & rsA("ST01").Value
            .TextMatrix(1, ii) = "稿"
            intColCount = intColCount + 1
            rsA.MoveNext
            ii = ii + 1
        Wend
        .Cols = .Cols - 1
        If rsA.State <> adStateClosed Then rsA.Close
        Set rsA = Nothing
        '當月目標件數
        For ii = 2 To intColCount + 2 - 1
            StrST01 = "": strST03 = "": strST06 = "": strST13 = "": strST16 = "": strNCFPGoal = "0": strCFPGoal = "0"
            '非CFP目標件數
            'Modify by Morgan 2010/10/29 改只要抓P,CFP的目標(杜燕文有T的目標)
            'strSQLA = " Select S.ST01, S.ST03, S.ST06, S.ST13, S.ST16, Sum(Nvl(PE05,0)+Nvl(PE07,0)) From Performance, (Select ST01, ST03, ST06, ST13, ST16 From Staff Where ST04='1' And (ST05='72' or st05='74' Or ST05='76' Or ST05='77' Or ST05='78' Or ST05='79' or st05='87' )) S Where S.ST01=PE01 And PE02<>'CFP' And PE03=" & (Val(txt1(0).text) + 191100) & " And PE01='" & .TextMatrix(34, ii) & "' Group By S.ST06, S.ST03, S.ST01, S.ST13, S.ST16 Order By S.ST06, S.ST03, S.ST01 "
            'modify by sonia 2014/4/9 加入94007林景郁總經理
            'Modified by Morgan 2022/10/31 +99050
            StrSQLa = " Select S.ST01, S.ST03, S.ST06, S.ST13, S.ST16, Sum(Nvl(PE05,0)+Nvl(PE07,0)) From Performance, (Select ST01, ST03, ST06, ST13, ST16 From Staff Where ST04='1' And (ST05='72' or st05='74' Or ST05='76' Or ST05='77' Or ST05='78' Or ST05='79' or st05='87' or st01='94007' or st01='99050')) S Where S.ST01=PE01 And PE02='P' And PE03=" & (Val(txt1(0).Text) + 191100) & " And PE01='" & .TextMatrix(34, ii) & "' Group By S.ST06, S.ST03, S.ST01, S.ST13, S.ST16 Order By S.ST06, S.ST03, S.ST01 "
            rsA.CursorLocation = adUseClient
            rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
            If rsA.RecordCount > 0 Then
                StrST01 = "" & rsA.Fields(0).Value
                strST03 = "" & rsA.Fields(1).Value
                strST06 = "" & rsA.Fields(2).Value
                strST13 = "" & rsA.Fields(3).Value
                strST16 = "" & rsA.Fields(4).Value
                strNCFPGoal = "" & rsA.Fields(5).Value
            End If
            If rsA.State <> adStateClosed Then rsA.Close
            Set rsA = Nothing
            'CFP目標件數
            'modify by sonia 2014/4/9 加入94007林景郁總經理
            'Modified by Morgan 2022/10/31 +99050
            StrSqlB = " Select S.ST01, S.ST03, S.ST06, S.ST13, S.ST16, Sum((Nvl(PE05,0)+Nvl(PE07,0)) * 2) From Performance, (Select ST01, ST03, ST06, ST13, ST16 From Staff Where ST04='1' And (ST05='72' or st05='74' Or ST05='76' Or ST05='77' Or ST05='78' Or ST05='79' or st05='87' or st01='94007' or st01='99050')) S Where S.ST01=PE01 And PE02='CFP' And PE03=" & (Val(txt1(0).Text) + 191100) & " And PE01='" & .TextMatrix(34, ii) & "' Group By S.ST06, S.ST03, S.ST01, S.ST13, S.ST16 Order By S.ST06, S.ST03, S.ST01 "
            rsB.CursorLocation = adUseClient
            rsB.Open StrSqlB, cnnConnection, adOpenStatic, adLockReadOnly
            If rsB.RecordCount > 0 Then
                StrST01 = "" & rsB.Fields(0).Value
                strST03 = "" & rsB.Fields(1).Value
                strST06 = "" & rsB.Fields(2).Value
                strST13 = "" & rsB.Fields(3).Value
                strST16 = "" & rsB.Fields(4).Value
                strCFPGoal = "" & rsB.Fields(5).Value
            End If
            If rsB.State <> adStateClosed Then rsB.Close
            Set rsB = Nothing
            .TextMatrix(2, ii) = CalGoal(StrST01, strST03, strST06, strST13, strST16, strNCFPGoal, strCFPGoal)
            DoEvents
        Next ii
        '本月工作天數
        StrSQLa = "Select Count(*) From WorkDay Where WD01>=" & Val(Val((txt1(0).Text) + 191100) & Format(txt1(1).Text, "00")) & " And WD01<=" & Val(Val((txt1(0).Text) + 191100) & Format(txt1(8).Text, "00"))
        rsA.CursorLocation = adUseClient
        rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
        For ii = 2 To intColCount + 2 - 1
            '若當月有目標
            .TextMatrix(3, ii) = "" & rsA.Fields(0).Value
            DoEvents
        Next ii
        If rsA.State <> adStateClosed Then rsA.Close
        Set rsA = Nothing
        '第一週工作天數
        StrSQLa = "Select Count(*) From WorkDay Where WD01>=" & Val(Val((txt1(0).Text) + 191100) & Format(txt1(1).Text, "00")) & " And WD01<=" & Val(Val((txt1(0).Text) + 191100) & Format(txt1(2).Text, "00"))
        rsA.CursorLocation = adUseClient
        rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
        For ii = 2 To intColCount + 2 - 1
            '若當月有目標
                .TextMatrix(4, ii) = "" & rsA.Fields(0).Value
                DoEvents
        Next ii
        If rsA.State <> adStateClosed Then rsA.Close
        Set rsA = Nothing
        '第一週目標
        For ii = 2 To intColCount + 2 - 1
            '若當月有目標
            If .TextMatrix(2, ii) <> "0" Then
               If Val(.TextMatrix(3, ii)) <> 0 Then
                  .TextMatrix(5, ii) = Format(Val(.TextMatrix(4, ii)) / Val(.TextMatrix(3, ii)) * Val(.TextMatrix(2, ii)), "0.00")
               Else
                  .TextMatrix(5, ii) = "0.00"
               End If
            End If
            DoEvents
        Next ii
        '第一週完成
        For ii = 2 To intColCount + 2 - 1
            '若當月有目標
                .TextMatrix(6, ii) = Format(CalFinishNew(.TextMatrix(34, ii), Val(txt1(0).Text & Format(txt1(1).Text, "00")) + 19110000, Val(txt1(0).Text & Format(txt1(2).Text, "00")) + 19110000, False), "0.00")
                DoEvents
        Next ii
        '第一週達成比例
        For ii = 2 To intColCount + 2 - 1
            '若當月有目標
            If .TextMatrix(2, ii) <> "0" Then
               If Val(.TextMatrix(5, ii)) <> 0 Then
                  .TextMatrix(8, ii) = Format(Val(.TextMatrix(6, ii)) / Val(.TextMatrix(5, ii)) * 100, "0.00") & "%"
               Else
                  .TextMatrix(8, ii) = "0.00"
               End If
            End If
            DoEvents
        Next ii
        '第一週得分
        For ii = 2 To intColCount + 2 - 1
            '若當月有目標
           .TextMatrix(7, ii) = CalPoints(Val(Replace(.TextMatrix(8, ii), "%", "")) / 100)
           DoEvents
        Next ii
        
        '第二週工作天數
        StrSQLa = "Select Count(*) From WorkDay Where WD01>=" & Val(Val((txt1(0).Text) + 191100) & Format(txt1(3).Text, "00")) & " And WD01<=" & Val(Val((txt1(0).Text) + 191100) & Format(txt1(4).Text, "00"))
        rsA.CursorLocation = adUseClient
        rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
        For ii = 2 To intColCount + 2 - 1
            '若當月有目標
            .TextMatrix(9, ii) = "" & rsA.Fields(0).Value
            DoEvents
        Next ii
        If rsA.State <> adStateClosed Then rsA.Close
        Set rsA = Nothing
        '第二週目標
        For ii = 2 To intColCount + 2 - 1
            '若當月有目標
            If .TextMatrix(2, ii) <> "0" Then
               If Val(.TextMatrix(3, ii)) <> 0 Then
                  .TextMatrix(10, ii) = Format(Val(.TextMatrix(9, ii)) / Val(.TextMatrix(3, ii)) * Val(.TextMatrix(2, ii)), "0.00")
               Else
                  .TextMatrix(10, ii) = "0.00"
               End If
            End If
            DoEvents
        Next ii
        '第二週完成
        For ii = 2 To intColCount + 2 - 1
'            '若當月有目標
'            If .TextMatrix(2, ii) <> "0" Then
                .TextMatrix(11, ii) = Format(CalFinishNew(.TextMatrix(34, ii), Val(txt1(0).Text & Format(txt1(3).Text, "00")) + 19110000, Val(txt1(0).Text & Format(txt1(4).Text, "00")) + 19110000, False), "0.00")
                DoEvents
'            End If
        Next ii
        '第二週達成比例
        For ii = 2 To intColCount + 2 - 1
            '若當月有目標
            If .TextMatrix(2, ii) <> "0" Then
               If Val(.TextMatrix(10, ii)) <> 0 Then
                  .TextMatrix(12, ii) = Format(Val(.TextMatrix(11, ii)) / Val(.TextMatrix(10, ii)) * 100, "0.00") & "%"
               Else
                  .TextMatrix(12, ii) = "0.00"
               End If
            End If
            DoEvents
        Next ii
        '第二週得分
        For ii = 2 To intColCount + 2 - 1
            '若當月有目標
                .TextMatrix(13, ii) = CalPoints(Val(Replace(.TextMatrix(12, ii), "%", "")) / 100)
                DoEvents
        Next ii
        '第二週累計目標
        For ii = 2 To intColCount + 2 - 1
            '若當月有目標
            If .TextMatrix(2, ii) <> "0" Then
               If Val(.TextMatrix(3, ii)) <> 0 Then
                  .TextMatrix(14, ii) = Format(Val(.TextMatrix(2, ii)) / Val(.TextMatrix(3, ii)) * (Val(.TextMatrix(4, ii)) + Val(.TextMatrix(9, ii))), "0.00")
               Else
                  .TextMatrix(14, ii) = "0.00"
               End If
            End If
            DoEvents
        Next ii
        '第二週累計完成
        For ii = 2 To intColCount + 2 - 1
            '若當月有目標
            .TextMatrix(15, ii) = Format(CalFinishNew(.TextMatrix(34, ii), Val(txt1(0).Text & Format(txt1(1).Text, "00")) + 19110000, Val(txt1(0).Text & Format(txt1(4).Text, "00")) + 19110000, False), "0.00")
            DoEvents
        Next ii
        '第二週累計達成比例
        For ii = 2 To intColCount + 2 - 1
            '若當月有目標
            If .TextMatrix(2, ii) <> "0" Then
               If Val(.TextMatrix(14, ii)) <> 0 Then
                  .TextMatrix(16, ii) = Format(Val(.TextMatrix(15, ii)) / Val(.TextMatrix(14, ii)) * 100, "0.00") & "%"
               Else
                  .TextMatrix(16, ii) = "0.00"
               End If
            End If
            DoEvents
        Next ii
        
        '第三週工作天數
        StrSQLa = "Select Count(*) From WorkDay Where WD01>=" & Val(Val((txt1(0).Text) + 191100) & Format(txt1(5).Text, "00")) & " And WD01<=" & Val(Val((txt1(0).Text) + 191100) & Format(txt1(6).Text, "00"))
        rsA.CursorLocation = adUseClient
        rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
        ii = 2
        For ii = 2 To intColCount + 2 - 1
            '若當月有目標
            .TextMatrix(17, ii) = "" & rsA.Fields(0).Value
            DoEvents
        Next ii
        If rsA.State <> adStateClosed Then rsA.Close
        Set rsA = Nothing
        '第三週目標
        For ii = 2 To intColCount + 2 - 1
            '若當月有目標
            If .TextMatrix(2, ii) <> "0" Then
               If Val(.TextMatrix(3, ii)) <> 0 Then
                  .TextMatrix(18, ii) = Format(Val(.TextMatrix(17, ii)) / Val(.TextMatrix(3, ii)) * Val(.TextMatrix(2, ii)), "0.00")
               Else
                  .TextMatrix(18, ii) = "0.00"
               End If
            End If
            DoEvents
        Next ii
        '第三週完成
        For ii = 2 To intColCount + 2 - 1
            '若當月有目標
            .TextMatrix(19, ii) = Format(CalFinishNew(.TextMatrix(34, ii), Val(txt1(0).Text & Format(txt1(5).Text, "00")) + 19110000, Val(txt1(0).Text & Format(txt1(6).Text, "00")) + 19110000, False), "0.00")
            DoEvents
        Next ii
        '第三週達成比例
        For ii = 2 To intColCount + 2 - 1
            '若當月有目標
            If .TextMatrix(2, ii) <> "0" Then
               If Val(.TextMatrix(18, ii)) <> 0 Then
                  .TextMatrix(20, ii) = Format(Val(.TextMatrix(19, ii)) / Val(.TextMatrix(18, ii)) * 100, "0.00") & "%"
               Else
                  .TextMatrix(20, ii) = "0.00"
               End If
            End If
            DoEvents
        Next ii
        '第三週得分
        For ii = 2 To intColCount + 2 - 1
            '若當月有目標
            .TextMatrix(21, ii) = CalPoints(Val(Replace(.TextMatrix(20, ii), "%", "")) / 100)
            DoEvents
        Next ii
        '第三週累計目標
        For ii = 2 To intColCount + 2 - 1
            '若當月有目標
            If .TextMatrix(2, ii) <> "0" Then
               If Val(.TextMatrix(3, ii)) * (Val(.TextMatrix(4, ii)) + Val(.TextMatrix(9, ii)) + Val(.TextMatrix(17, ii))) <> 0 Then
                  .TextMatrix(22, ii) = Format(Val(.TextMatrix(2, ii)) / Val(.TextMatrix(3, ii)) * (Val(.TextMatrix(4, ii)) + Val(.TextMatrix(9, ii)) + Val(.TextMatrix(17, ii))), "0.00")
               Else
                  .TextMatrix(22, ii) = "0.00"
               End If
            End If
            DoEvents
        Next ii
        '第三週累計完成
        For ii = 2 To intColCount + 2 - 1
            '若當月有目標
            .TextMatrix(23, ii) = Format(CalFinishNew(.TextMatrix(34, ii), Val(txt1(0).Text & Format(txt1(1).Text, "00")) + 19110000, Val(txt1(0).Text & Format(txt1(6).Text, "00")) + 19110000, False), "0.00")
            DoEvents
        Next ii
        '第三週累計達成比例
        For ii = 2 To intColCount + 2 - 1
            '若當月有目標
            If .TextMatrix(2, ii) <> "0" Then
               If Val(.TextMatrix(22, ii)) <> 0 Then
                  .TextMatrix(24, ii) = Format(Val(.TextMatrix(23, ii)) / Val(.TextMatrix(22, ii)) * 100, "0.00") & "%"
               Else
                  .TextMatrix(24, ii) = "0.00"
               End If
            End If
            DoEvents
        Next ii
        
        '第四週工作天數
        StrSQLa = "Select Count(*) From WorkDay Where WD01>=" & Val(Val((txt1(0).Text) + 191100) & Format(txt1(7).Text, "00")) & " And WD01<=" & Val(Val((txt1(0).Text) + 191100) & Format(txt1(8).Text, "00"))
        rsA.CursorLocation = adUseClient
        rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
        ii = 2
        For ii = 2 To intColCount + 2 - 1
            '若當月有目標
           .TextMatrix(25, ii) = "" & rsA.Fields(0).Value
           DoEvents
        Next ii
        If rsA.State <> adStateClosed Then rsA.Close
        Set rsA = Nothing
        '第四週目標
        For ii = 2 To intColCount + 2 - 1
            '若當月有目標
            If .TextMatrix(2, ii) <> "0" Then
               If Val(.TextMatrix(3, ii)) <> 0 Then
                  .TextMatrix(26, ii) = Format(Val(.TextMatrix(25, ii)) / Val(.TextMatrix(3, ii)) * Val(.TextMatrix(2, ii)), "0.00")
               Else
                  .TextMatrix(26, ii) = "0.00"
               End If
            End If
            DoEvents
        Next ii
        '第四週完成
        For ii = 2 To intColCount + 2 - 1
            '若當月有目標
            .TextMatrix(27, ii) = Format(CalFinishNew(.TextMatrix(34, ii), Val(txt1(0).Text & Format(txt1(7).Text, "00")) + 19110000, Val(txt1(0).Text & Format(txt1(8).Text, "00")) + 19110000, False), "0.00")
            DoEvents
        Next ii
        '第四週達成比例
        For ii = 2 To intColCount + 2 - 1
            '若當月有目標
            If .TextMatrix(2, ii) <> "0" Then
               If Val(.TextMatrix(26, ii)) <> 0 Then
                  .TextMatrix(28, ii) = Format(.TextMatrix(27, ii) / Val(.TextMatrix(26, ii)) * 100, "0.00") & "%"
               Else
                  .TextMatrix(28, ii) = "0.00"
               End If
            End If
            DoEvents
        Next ii
        '第四週得分
        For ii = 2 To intColCount + 2 - 1
            '若當月有目標
           .TextMatrix(29, ii) = CalPoints(Val(Replace(.TextMatrix(28, ii), "%", "")) / 100)
           DoEvents
        Next ii
        '第四週累計目標
        For ii = 2 To intColCount + 2 - 1
            '若當月有目標
            If .TextMatrix(2, ii) <> "0" Then
                .TextMatrix(30, ii) = Format(.TextMatrix(2, ii), "0.00")
            End If
            DoEvents
        Next ii
        '第四週累計完成
        For ii = 2 To intColCount + 2 - 1
            '若當月有目標
           .TextMatrix(31, ii) = Format(CalFinishNew(.TextMatrix(34, ii), Val(txt1(0).Text & Format(txt1(1).Text, "00")) + 19110000, Val(txt1(0).Text & Format(txt1(8).Text, "00")) + 19110000, False, , strMA54), "0.00")
           .TextMatrix(35, ii) = strMA54 'Add by Morgan 2009/7/14
           DoEvents
        Next ii
        '第四週累計達成比例
        For ii = 2 To intColCount + 2 - 1
            '若當月有目標
            If .TextMatrix(2, ii) <> "0" Then
               If Val(.TextMatrix(30, ii)) <> 0 Then
                  .TextMatrix(32, ii) = Format(Val(.TextMatrix(31, ii)) / Val(.TextMatrix(30, ii)) * 100, "0.00") & "%"
               Else
                  .TextMatrix(32, ii) = "0.00"
               End If
            End If
            DoEvents
        Next ii
        
        '本月得分平均
        For ii = 2 To intColCount + 2 - 1
            '若當月有目標
            'Added by Morgan 2019/3/18 108考核(工程師本月得分改以整月達成率計算)
            If Val(Trim(str(Val(CalYM) + 191100)) & "01") >= Val(PUB_108RuleDate) Then
               .TextMatrix(33, ii) = CalPoints(Val(Replace(.TextMatrix(32, ii), "%", "")) / 100)
            Else
            'end 2019/3/18
            
                .TextMatrix(33, ii) = Format((Val(.TextMatrix(7, ii)) + Val(.TextMatrix(13, ii)) + Val(.TextMatrix(21, ii)) + Val(.TextMatrix(29, ii))) / 4, "0.00")
                
            End If 'Added by Morgan 2019/3/18
            
               .row = 33
               .col = ii
               .CellAlignment = flexAlignCenterCenter
                DoEvents
        Next ii
    End With
    
'********************************************************
    '繪圖人員速度考核
    With Me.grd(1)
        '員工編號
        StrSQLa = "Select * From Staff Where ST04='1' And (ST05='79' Or ST05='81' Or ST05='82' Or ST05='AC') Order By ST06, ST03, ST01 "
        rsA.CursorLocation = adUseClient
        rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
        ii = 2
        intColCount = 0
        While Not rsA.EOF
            .Cols = .Cols + 1
            .TextMatrix(0, ii) = "" & rsA("ST01").Value
            .TextMatrix(34, ii) = "" & rsA("ST01").Value
            .row = 0
            .col = ii
            .CellAlignment = flexAlignCenterCenter
            .row = 1
            .col = ii
            .TextMatrix(1, ii) = "草"
            .CellAlignment = flexAlignCenterCenter
            .row = 1
            .col = ii + 1
            .CellAlignment = flexAlignCenterCenter
            .Cols = .Cols + 1
            .TextMatrix(0, ii + 1) = "" & rsA("ST01").Value
            .TextMatrix(34, ii + 1) = "" & rsA("ST01").Value
            .TextMatrix(1, ii + 1) = "墨"
            .row = 1
            .col = ii + 2
            .CellAlignment = flexAlignCenterCenter
            .Cols = .Cols + 1
            .TextMatrix(0, ii + 2) = "" & rsA("ST01").Value
            .TextMatrix(34, ii + 2) = ""
            .TextMatrix(1, ii + 2) = ""
            .ColWidth(ii + 2) = 0
            ii = ii + 3
            intColCount = intColCount + 3
            rsA.MoveNext
            DoEvents
        Wend
        .Cols = .Cols - 1
        If rsA.State <> adStateClosed Then rsA.Close
        Set rsA = Nothing
        '當月目標件數
        For ii = 2 To intColCount + 2 - 1 Step 3
            StrST01 = "": strST03 = "": strST06 = "": strST13 = "": strST16 = "": strGoal = "0"
            'Modify by Morgan 2010/10/29 改只要抓P,CFP的目標(杜燕文有T的目標)
            'strSQLA = " Select S.ST01, S.ST03, S.ST06, S.ST13, S.ST16, Sum(Nvl(PE09,0)) From Performance, (Select ST01, ST03, ST06, ST13, ST16 From Staff Where ST04='1' And (ST05='79' Or ST05='81' Or ST05='82' Or ST05='AC')) S Where S.ST01=PE01 And PE03=" & (Val(txt1(0).text) + 191100) & " And PE01='" & .TextMatrix(34, ii) & "' Group By S.ST06, S.ST03, S.ST01, S.ST13, S.ST16 Order By S.ST06, S.ST03, S.ST01 "
            StrSQLa = " Select S.ST01, S.ST03, S.ST06, S.ST13, S.ST16, Sum(Nvl(PE09,0)) From Performance, (Select ST01, ST03, ST06, ST13, ST16 From Staff Where ST04='1' And (ST05='79' Or ST05='81' Or ST05='82' Or ST05='AC')) S Where S.ST01=PE01 AND PE02 IN ('P','CFP') And PE03=" & (Val(txt1(0).Text) + 191100) & " And PE01='" & .TextMatrix(34, ii) & "' Group By S.ST06, S.ST03, S.ST01, S.ST13, S.ST16 Order By S.ST06, S.ST03, S.ST01 "
            rsA.CursorLocation = adUseClient
            rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
            If rsA.RecordCount > 0 Then
                StrST01 = "" & rsA.Fields(0).Value
                strST03 = "" & rsA.Fields(1).Value
                strST06 = "" & rsA.Fields(2).Value
                strST13 = "" & rsA.Fields(3).Value
                strST16 = "" & rsA.Fields(4).Value
                strGoal = Val("" & rsA.Fields(5).Value)
            End If
            If rsA.State <> adStateClosed Then rsA.Close
            Set rsA = Nothing
            .TextMatrix(2, ii) = IIf(strGoal <> "0", Format(strGoal, "0.00"), "0")
            .TextMatrix(2, ii + 1) = IIf(strGoal <> "0", Format(strGoal, "0.00"), "0")
            DoEvents
        Next ii
        '本月工作天數
        StrSQLa = "Select Count(*) From WorkDay Where WD01>=" & Val(Val((txt1(0).Text) + 191100) & Format(txt1(1).Text, "00")) & " And WD01<=" & Val(Val((txt1(0).Text) + 191100) & Format(txt1(8).Text, "00"))
        rsA.CursorLocation = adUseClient
        rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
        For ii = 2 To intColCount + 2 - 1 Step 3
'            '若當月有目標
            .TextMatrix(3, ii) = "" & rsA.Fields(0).Value
            .TextMatrix(3, ii + 1) = "" & rsA.Fields(0).Value
            DoEvents
        Next ii
        If rsA.State <> adStateClosed Then rsA.Close
        Set rsA = Nothing
        '第一週工作天數
        StrSQLa = "Select Count(*) From WorkDay Where WD01>=" & Val(Val((txt1(0).Text) + 191100) & Format(txt1(1).Text, "00")) & " And WD01<=" & Val(Val((txt1(0).Text) + 191100) & Format(txt1(2).Text, "00"))
        rsA.CursorLocation = adUseClient
        rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
        For ii = 2 To intColCount + 2 - 1 Step 3
            '若當月有目標
            .TextMatrix(4, ii) = "" & rsA.Fields(0).Value
            .TextMatrix(4, ii + 1) = "" & rsA.Fields(0).Value
            DoEvents
        Next ii
        If rsA.State <> adStateClosed Then rsA.Close
        Set rsA = Nothing
        '第一週目標
        For ii = 2 To intColCount + 2 - 1 Step 3
            '若當月有目標
            If .TextMatrix(2, ii) <> "0" Then
               If Val(.TextMatrix(3, ii)) <> 0 Then
                  .TextMatrix(5, ii) = Format(Val(.TextMatrix(4, ii)) / Val(.TextMatrix(3, ii)) * Val(.TextMatrix(2, ii)), "0.00")
               Else
                  .TextMatrix(5, ii) = "0.00"
               End If
            End If
            If Val(.TextMatrix(3, ii + 1)) <> 0 Then
               If Val(.TextMatrix(3, ii + 1)) <> 0 Then
                  .TextMatrix(5, ii + 1) = Format(Val(.TextMatrix(4, ii + 1)) / Val(.TextMatrix(3, ii + 1)) * Val(.TextMatrix(2, ii + 1)), "0.00")
               Else
                  .TextMatrix(5, ii + 1) = "0.00"
               End If
            End If
            DoEvents
        Next ii
        '第一週完成
        For ii = 2 To intColCount + 2 - 1 Step 3
            '若當月有目標
           .TextMatrix(6, ii) = Format(CalFinishNew(.TextMatrix(34, ii), Val(txt1(0).Text & Format(txt1(1).Text, "00")) + 19110000, Val(txt1(0).Text & Format(txt1(2).Text, "00")) + 19110000, True), "0.00")
           .TextMatrix(6, ii + 1) = Format(CalFinishNew(.TextMatrix(34, ii), Val(txt1(0).Text & Format(txt1(1).Text, "00")) + 19110000, Val(txt1(0).Text & Format(txt1(2).Text, "00")) + 19110000, True, False), "0.00")
           DoEvents
        Next ii
        '第一週達成比例
        For ii = 2 To intColCount + 2 - 1 Step 3
            '若當月有目標
            If .TextMatrix(2, ii) <> "0" Then
               If Val(.TextMatrix(5, ii)) <> 0 Then
                  .TextMatrix(8, ii) = Format(Val(.TextMatrix(6, ii)) / Val(.TextMatrix(5, ii)) * 100, "0.00") & "%"
               Else
                  .TextMatrix(8, ii) = "0.00"
               End If
            End If
            If .TextMatrix(2, ii + 1) <> "0" Then
               If Val(.TextMatrix(5, ii + 1)) <> 0 Then
                  .TextMatrix(8, ii + 1) = Format(Val(.TextMatrix(6, ii + 1)) / Val(.TextMatrix(5, ii + 1)) * 100, "0.00") & "%"
               Else
                  .TextMatrix(8, ii + 1) = "0.00"
               End If
            End If
            DoEvents
        Next ii
        '第一週得分
        For ii = 2 To intColCount + 2 - 1 Step 3
            '若當月有目標
            .TextMatrix(7, ii) = CalPoints(Val(Replace(.TextMatrix(8, ii), "%", "")) / 100)
            .TextMatrix(7, ii + 1) = CalPoints(Val(Replace(.TextMatrix(8, ii + 1), "%", "")) / 100)
            DoEvents
        Next ii
        
        '第二週工作天數
        StrSQLa = "Select Count(*) From WorkDay Where WD01>=" & Val(Val((txt1(0).Text) + 191100) & Format(txt1(3).Text, "00")) & " And WD01<=" & Val(Val((txt1(0).Text) + 191100) & Format(txt1(4).Text, "00"))
        rsA.CursorLocation = adUseClient
        rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
        For ii = 2 To intColCount + 2 - 1 Step 3
            '若當月有目標
           .TextMatrix(9, ii) = "" & rsA.Fields(0).Value
           .TextMatrix(9, ii + 1) = "" & rsA.Fields(0).Value
           DoEvents
        Next ii
        If rsA.State <> adStateClosed Then rsA.Close
        Set rsA = Nothing
        '第二週目標
        For ii = 2 To intColCount + 2 - 1 Step 3
            '若當月有目標
            If .TextMatrix(2, ii) <> "0" Then
               If Val(.TextMatrix(3, ii)) <> 0 Then
                  .TextMatrix(10, ii) = Format(Val(.TextMatrix(9, ii)) / Val(.TextMatrix(3, ii)) * Val(.TextMatrix(2, ii)), "0.00")
               Else
                  .TextMatrix(10, ii) = "0.00"
               End If
            End If
            If .TextMatrix(2, ii + 1) <> "0" Then
               If Val(.TextMatrix(3, ii + 1)) <> 0 Then
                  .TextMatrix(10, ii + 1) = Format(Val(.TextMatrix(9, ii + 1)) / Val(.TextMatrix(3, ii + 1)) * Val(.TextMatrix(2, ii + 1)), "0.00")
               Else
                  .TextMatrix(10, ii + 1) = "0.00"
               End If
            End If
            DoEvents
        Next ii
        '第二週完成
        For ii = 2 To intColCount + 2 - 1 Step 3
            '若當月有目標
            .TextMatrix(11, ii) = Format(CalFinishNew(.TextMatrix(34, ii), Val(txt1(0).Text & Format(txt1(3).Text, "00")) + 19110000, Val(txt1(0).Text & Format(txt1(4).Text, "00")) + 19110000, True), "0.00")
            .TextMatrix(11, ii + 1) = Format(CalFinishNew(.TextMatrix(34, ii + 1), Val(txt1(0).Text & Format(txt1(3).Text, "00")) + 19110000, Val(txt1(0).Text & Format(txt1(4).Text, "00")) + 19110000, True, False), "0.00")
            DoEvents
        Next ii
        '第二週達成比例
        For ii = 2 To intColCount + 2 - 1 Step 3
            '若當月有目標
            If .TextMatrix(2, ii) <> "0" Then
               If Val(.TextMatrix(10, ii)) <> 0 Then
                  .TextMatrix(12, ii) = Format(Val(.TextMatrix(11, ii)) / Val(.TextMatrix(10, ii)) * 100, "0.00") & "%"
               Else
                  .TextMatrix(12, ii) = "0.00%"
               End If
            End If
            If .TextMatrix(2, ii + 1) <> "0" Then
               If Val(.TextMatrix(10, ii + 1)) <> 0 Then
                  .TextMatrix(12, ii + 1) = Format(Val(.TextMatrix(11, ii + 1)) / Val(.TextMatrix(10, ii + 1)) * 100, "0.00") & "%"
               Else
                  .TextMatrix(12, ii + 1) = "0.00%"
               End If
            End If
            DoEvents
        Next ii
        '第二週得分
        For ii = 2 To intColCount + 2 - 1 Step 3
            '若當月有目標
            .TextMatrix(13, ii) = CalPoints(Val(Replace(.TextMatrix(12, ii), "%", "")) / 100)
            .TextMatrix(13, ii + 1) = CalPoints(Val(Replace(.TextMatrix(12, ii + 1), "%", "")) / 100)
            DoEvents
        Next ii
        '第二週累計目標
        For ii = 2 To intColCount + 2 - 1 Step 3
            '若當月有目標
            If .TextMatrix(2, ii) <> "0" Then
               If Val(.TextMatrix(3, ii)) * (Val(.TextMatrix(4, ii)) + Val(.TextMatrix(9, ii))) <> 0 Then
                  .TextMatrix(14, ii) = Format(Val(.TextMatrix(2, ii)) / Val(.TextMatrix(3, ii)) * (Val(.TextMatrix(4, ii)) + Val(.TextMatrix(9, ii))), "0.00")
               Else
                  .TextMatrix(14, ii) = "0.00"
               End If
            End If
            If .TextMatrix(2, ii + 1) <> "0" Then
               If Val(.TextMatrix(3, ii + 1)) * (Val(.TextMatrix(4, ii + 1)) + Val(.TextMatrix(9, ii + 1))) <> 0 Then
                  .TextMatrix(14, ii + 1) = Format(Val(.TextMatrix(2, ii + 1)) / Val(.TextMatrix(3, ii + 1)) * (Val(.TextMatrix(4, ii + 1)) + Val(.TextMatrix(9, ii + 1))), "0.00")
               Else
                  .TextMatrix(14, ii + 1) = "0.00"
               End If
            End If
            DoEvents
        Next ii
        '第二週累計完成
        For ii = 2 To intColCount + 2 - 1 Step 3
            '若當月有目標
           .TextMatrix(15, ii) = Format(CalFinishNew(.TextMatrix(34, ii), Val(txt1(0).Text & Format(txt1(1).Text, "00")) + 19110000, Val(txt1(0).Text & Format(txt1(4).Text, "00")) + 19110000, True), "0.00")
           .TextMatrix(15, ii + 1) = Format(CalFinishNew(.TextMatrix(34, ii + 1), Val(txt1(0).Text & Format(txt1(1).Text, "00")) + 19110000, Val(txt1(0).Text & Format(txt1(4).Text, "00")) + 19110000, True, False), "0.00")
           DoEvents
        Next ii
        '第二週累計達成比例
        For ii = 2 To intColCount + 2 - 1 Step 3
            '若當月有目標
            If .TextMatrix(2, ii) <> "0" Then
               If Val(.TextMatrix(14, ii)) <> 0 Then
                  .TextMatrix(16, ii) = Format(Val(.TextMatrix(15, ii)) / Val(.TextMatrix(14, ii)) * 100, "0.00") & "%"
               Else
                  .TextMatrix(16, ii) = "0.00"
               End If
            End If
            If .TextMatrix(2, ii + 1) <> "0" Then
               If Val(.TextMatrix(14, ii + 1)) <> 0 Then
                  .TextMatrix(16, ii + 1) = Format(Val(.TextMatrix(15, ii + 1)) / Val(.TextMatrix(14, ii + 1)) * 100, "0.00") & "%"
               Else
                  .TextMatrix(16, ii + 1) = "0.00"
               End If
            End If
            DoEvents
        Next ii
        
        '第三週工作天數
        StrSQLa = "Select Count(*) From WorkDay Where WD01>=" & Val(Val((txt1(0).Text) + 191100) & Format(txt1(5).Text, "00")) & " And WD01<=" & Val(Val((txt1(0).Text) + 191100) & Format(txt1(6).Text, "00"))
        rsA.CursorLocation = adUseClient
        rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
        ii = 2
        For ii = 2 To intColCount + 2 - 1 Step 3
            '若當月有目標
            .TextMatrix(17, ii) = "" & rsA.Fields(0).Value
            .TextMatrix(17, ii + 1) = "" & rsA.Fields(0).Value
            DoEvents
        Next ii
        If rsA.State <> adStateClosed Then rsA.Close
        Set rsA = Nothing
        '第三週目標
        For ii = 2 To intColCount + 2 - 1 Step 3
            '若當月有目標
            If .TextMatrix(2, ii) <> "0" Then
               If Val(.TextMatrix(3, ii)) <> 0 Then
                  .TextMatrix(18, ii) = Format(Val(.TextMatrix(17, ii)) / Val(.TextMatrix(3, ii)) * Val(.TextMatrix(2, ii)), "0.00")
               Else
                  .TextMatrix(18, ii) = "0.00"
               End If
            End If
            If .TextMatrix(2, ii + 1) <> "0" Then
               If Val(.TextMatrix(3, ii + 1)) <> 0 Then
                  .TextMatrix(18, ii + 1) = Format(Val(.TextMatrix(17, ii + 1)) / Val(.TextMatrix(3, ii + 1)) * Val(.TextMatrix(2, ii + 1)), "0.00")
               Else
                  .TextMatrix(18, ii + 1) = "0.00"
               End If
            End If
            DoEvents
        Next ii
        '第三週完成
        For ii = 2 To intColCount + 2 - 1 Step 3
            '若當月有目標
            .TextMatrix(19, ii) = Format(CalFinishNew(.TextMatrix(34, ii), Val(txt1(0).Text & Format(txt1(5).Text, "00")) + 19110000, Val(txt1(0).Text & Format(txt1(6).Text, "00")) + 19110000, True), "0.00")
            .TextMatrix(19, ii + 1) = Format(CalFinishNew(.TextMatrix(34, ii + 1), Val(txt1(0).Text & Format(txt1(5).Text, "00")) + 19110000, Val(txt1(0).Text & Format(txt1(6).Text, "00")) + 19110000, True, False), "0.00")
            DoEvents
        Next ii
        '第三週達成比例
        For ii = 2 To intColCount + 2 - 1 Step 3
            '若當月有目標
            If .TextMatrix(2, ii) <> "0" Then
               If Val(.TextMatrix(18, ii)) <> 0 Then
                  .TextMatrix(20, ii) = Format(Val(.TextMatrix(19, ii)) / Val(.TextMatrix(18, ii)) * 100, "0.00") & "%"
               Else
                  .TextMatrix(20, ii) = "0.00"
               End If
            End If
            If .TextMatrix(2, ii + 1) <> "0" Then
               If Val(.TextMatrix(18, ii + 1)) <> 0 Then
                  .TextMatrix(20, ii + 1) = Format(Val(.TextMatrix(19, ii + 1)) / Val(.TextMatrix(18, ii + 1)) * 100, "0.00") & "%"
               Else
                  .TextMatrix(20, ii + 1) = "0.00"
               End If
            End If
            DoEvents
        Next ii
        '第三週得分
        For ii = 2 To intColCount + 2 - 1 Step 3
            '若當月有目標
            .TextMatrix(21, ii) = CalPoints(Val(Replace(.TextMatrix(20, ii), "%", "")) / 100)
            .TextMatrix(21, ii + 1) = CalPoints(Val(Replace(.TextMatrix(20, ii + 1), "%", "")) / 100)
            DoEvents
        Next ii
        '第三週累計目標
        For ii = 2 To intColCount + 2 - 1 Step 3
            '若當月有目標
            If .TextMatrix(2, ii) <> "0" Then
               If Val(.TextMatrix(3, ii)) * (Val(.TextMatrix(4, ii)) + Val(.TextMatrix(9, ii)) + Val(.TextMatrix(17, ii))) <> 0 Then
                  .TextMatrix(22, ii) = Format(Val(.TextMatrix(2, ii)) / Val(.TextMatrix(3, ii)) * (Val(.TextMatrix(4, ii)) + Val(.TextMatrix(9, ii)) + Val(.TextMatrix(17, ii))), "0.00")
               Else
                  .TextMatrix(22, ii) = "0.00"
               End If
            End If
            If .TextMatrix(2, ii + 1) <> "0" Then
               If Val(.TextMatrix(3, ii + 1)) * (Val(.TextMatrix(4, ii + 1)) + Val(.TextMatrix(9, ii + 1)) + Val(.TextMatrix(17, ii + 1))) <> 0 Then
                  .TextMatrix(22, ii + 1) = Format(Val(.TextMatrix(2, ii + 1)) / Val(.TextMatrix(3, ii + 1)) * (Val(.TextMatrix(4, ii + 1)) + Val(.TextMatrix(9, ii + 1)) + Val(.TextMatrix(17, ii + 1))), "0.00")
               Else
                  .TextMatrix(22, ii + 1) = "0.00"
               End If
            End If
            DoEvents
        Next ii
        '第三週累計完成
        For ii = 2 To intColCount + 2 - 1 Step 3
            '若當月有目標
            .TextMatrix(23, ii) = Format(CalFinishNew(.TextMatrix(34, ii), Val(txt1(0).Text & Format(txt1(1).Text, "00")) + 19110000, Val(txt1(0).Text & Format(txt1(6).Text, "00")) + 19110000, True), "0.00")
            .TextMatrix(23, ii + 1) = Format(CalFinishNew(.TextMatrix(34, ii + 1), Val(txt1(0).Text & Format(txt1(1).Text, "00")) + 19110000, Val(txt1(0).Text & Format(txt1(6).Text, "00")) + 19110000, True, False), "0.00")
            DoEvents
        Next ii
        '第三週累計達成比例
        For ii = 2 To intColCount + 2 - 1 Step 3
            '若當月有目標
            If .TextMatrix(2, ii) <> "0" Then
               If Val(.TextMatrix(22, ii)) <> 0 Then
                  .TextMatrix(24, ii) = Format(Val(.TextMatrix(23, ii)) / Val(.TextMatrix(22, ii)) * 100, "0.00") & "%"
               Else
                  .TextMatrix(24, ii) = "0.00"
               End If
            End If
            If .TextMatrix(2, ii + 1) <> "0" Then
               If Val(.TextMatrix(22, ii + 1)) <> 0 Then
                  .TextMatrix(24, ii + 1) = Format(Val(.TextMatrix(23, ii + 1)) / Val(.TextMatrix(22, ii + 1)) * 100, "0.00") & "%"
               Else
                  .TextMatrix(24, ii + 1) = "0.00"
               End If
            End If
            DoEvents
        Next ii
        
        '第四週工作天數
        StrSQLa = "Select Count(*) From WorkDay Where WD01>=" & Val(Val((txt1(0).Text) + 191100) & Format(txt1(7).Text, "00")) & " And WD01<=" & Val(Val((txt1(0).Text) + 191100) & Format(txt1(8).Text, "00"))
        rsA.CursorLocation = adUseClient
        rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
        ii = 2
        For ii = 2 To intColCount + 2 - 1 Step 3
            '若當月有目標
            .TextMatrix(25, ii) = "" & rsA.Fields(0).Value
            .TextMatrix(25, ii + 1) = "" & rsA.Fields(0).Value
            DoEvents
        Next ii
        If rsA.State <> adStateClosed Then rsA.Close
        Set rsA = Nothing
        '第四週目標
        For ii = 2 To intColCount + 2 - 1 Step 3
            '若當月有目標
            If .TextMatrix(2, ii) <> "0" Then
               If Val(.TextMatrix(3, ii)) <> 0 Then
                  .TextMatrix(26, ii) = Format(Val(.TextMatrix(25, ii)) / Val(.TextMatrix(3, ii)) * Val(.TextMatrix(2, ii)), "0.00")
               Else
                  .TextMatrix(26, ii) = "0.00"
               End If
            End If
            If .TextMatrix(2, ii + 1) <> "0" Then
               If Val(.TextMatrix(3, ii + 1)) <> 0 Then
                  .TextMatrix(26, ii + 1) = Format(Val(.TextMatrix(25, ii + 1)) / Val(.TextMatrix(3, ii + 1)) * Val(.TextMatrix(2, ii + 1)), "0.00")
               Else
                  .TextMatrix(26, ii + 1) = "0.00"
               End If
            End If
            DoEvents
        Next ii
        '第四週完成
        For ii = 2 To intColCount + 2 - 1 Step 3
            '若當月有目標
            .TextMatrix(27, ii) = Format(CalFinishNew(.TextMatrix(34, ii), Val(txt1(0).Text & Format(txt1(7).Text, "00")) + 19110000, Val(txt1(0).Text & Format(txt1(8).Text, "00")) + 19110000, True), "0.00")
            .TextMatrix(27, ii + 1) = Format(CalFinishNew(.TextMatrix(34, ii + 1), Val(txt1(0).Text & Format(txt1(7).Text, "00")) + 19110000, Val(txt1(0).Text & Format(txt1(8).Text, "00")) + 19110000, True, False), "0.00")
        Next ii
        '第四週達成比例
        For ii = 2 To intColCount + 2 - 1 Step 3
            '若當月有目標
            If .TextMatrix(2, ii) <> "0" Then
               If Val(.TextMatrix(26, ii)) <> 0 Then
                  .TextMatrix(28, ii) = Format(Val(.TextMatrix(27, ii)) / Val(.TextMatrix(26, ii)) * 100, "0.00") & "%"
               Else
                  .TextMatrix(28, ii) = "0.00"
               End If
            End If
            If .TextMatrix(2, ii + 1) <> "0" Then
               If Val(.TextMatrix(26, ii + 1)) <> 0 Then
                  .TextMatrix(28, ii + 1) = Format(Val(.TextMatrix(27, ii + 1)) / Val(.TextMatrix(26, ii + 1)) * 100, "0.00") & "%"
               Else
                  .TextMatrix(28, ii + 1) = "0.00"
               End If
            End If
            DoEvents
        Next ii
        '第四週得分
        For ii = 2 To intColCount + 2 - 1 Step 3
            '若當月有目標
            .TextMatrix(29, ii) = CalPoints(Val(Replace(.TextMatrix(28, ii), "%", "")) / 100)
            .TextMatrix(29, ii + 1) = CalPoints(Val(Replace(.TextMatrix(28, ii + 1), "%", "")) / 100)
            DoEvents
        Next ii
        '第四週累計目標
        For ii = 2 To intColCount + 2 - 1 Step 3
            '若當月有目標
            If .TextMatrix(2, ii) <> "0" Then
                .TextMatrix(30, ii) = Format(.TextMatrix(2, ii), "0.00")
            End If
            If .TextMatrix(2, ii + 1) <> "0" Then
                .TextMatrix(30, ii + 1) = Format(.TextMatrix(2, ii + 1), "0.00")
            End If
            DoEvents
        Next ii
        '第四週累計完成
        For ii = 2 To intColCount + 2 - 1 Step 3
            '若當月有目標
            .TextMatrix(31, ii) = Format(CalFinishNew(.TextMatrix(34, ii), Val(txt1(0).Text & Format(txt1(1).Text, "00")) + 19110000, Val(txt1(0).Text & Format(txt1(8).Text, "00")) + 19110000, True), "0.00")
            .TextMatrix(31, ii + 1) = Format(CalFinishNew(.TextMatrix(34, ii + 1), Val(txt1(0).Text & Format(txt1(1).Text, "00")) + 19110000, Val(txt1(0).Text & Format(txt1(8).Text, "00")) + 19110000, True, False), "0.00")
            DoEvents
        Next ii
        '第四週累計達成比例
        For ii = 2 To intColCount + 2 - 1 Step 3
            '若當月有目標
            If .TextMatrix(2, ii) <> "0" Then
               If Val(.TextMatrix(30, ii)) <> 0 Then
                  .TextMatrix(32, ii) = Format(Val(.TextMatrix(31, ii)) / Val(.TextMatrix(30, ii)) * 100, "0.00") & "%"
               Else
                  .TextMatrix(32, ii) = "0.00"
               End If
            End If
            If .TextMatrix(2, ii + 1) <> "0" Then
               If Val(.TextMatrix(30, ii + 1)) <> 0 Then
                  .TextMatrix(32, ii + 1) = Format(Val(.TextMatrix(31, ii + 1)) / Val(.TextMatrix(30, ii + 1)) * 100, "0.00") & "%"
               Else
                  .TextMatrix(32, ii + 1) = "0.00"
               End If
            End If
            DoEvents
        Next ii
        
        '本月得分平均
        For ii = 2 To intColCount + 2 - 1 Step 3
            '若當月有目標  繪圖平均為草 65 % 墨 35 %
            .TextMatrix(33, ii) = Format(((Val(.TextMatrix(7, ii)) + Val(.TextMatrix(13, ii)) + Val(.TextMatrix(21, ii)) + Val(.TextMatrix(29, ii))) / 4 * 0.65) + ((Val(.TextMatrix(7, ii + 1)) + Val(.TextMatrix(13, ii + 1)) + Val(.TextMatrix(21, ii + 1)) + Val(.TextMatrix(29, ii + 1))) / 4 * 0.35), "0.00")
            .TextMatrix(33, ii + 1) = Format(((Val(.TextMatrix(7, ii)) + Val(.TextMatrix(13, ii)) + Val(.TextMatrix(21, ii)) + Val(.TextMatrix(29, ii))) / 4 * 0.65) + ((Val(.TextMatrix(7, ii + 1)) + Val(.TextMatrix(13, ii + 1)) + Val(.TextMatrix(21, ii + 1)) + Val(.TextMatrix(29, ii + 1))) / 4 * 0.35), "0.00")
            .MergeRow(33) = True
            .MergeCol(ii) = True
            .MergeCol(ii + 1) = True
            .row = 33
            .col = ii
            .CellAlignment = flexAlignCenterCenter
            DoEvents
        Next ii
    End With
'ChgGrdColor

'加入存檔
Dim GrdIndex As Integer
Dim GrdCol As Integer
Dim GrdRow As Integer
Dim IsUpdate As Boolean
Dim IsRoung As Boolean
For GrdIndex = 0 To 1
   IsRoung = False
    For GrdCol = 2 To grd(GrdIndex).Cols - 1
         DoEvents
         grd(GrdIndex).col = GrdCol
         grd(GrdIndex).row = 34
         IsUpdate = False
         If Trim(grd(GrdIndex).Text) <> "" Then
            strSql = "select * from monthassess where ma01='" & grd(GrdIndex).Text & "' and ma02=" & Trim(str(Val(CalYM) + 191100)) & " and ma03='" & Trim(str(GrdIndex + 1)) & "' and ma36='"
            If GrdIndex = 0 Then
                strSql = strSql & "0' "
            Else
                grd(GrdIndex).row = 1
                If grd(GrdIndex).Text = "草" Then
                   strSql = strSql & "1' "
                   IsRoung = True
                Else
                   strSql = strSql & "2' "
                   IsRoung = False
                End If
            End If
            grd(GrdIndex).row = 34
            CheckOC
            adoRecordset.CursorLocation = adUseClient
            adoRecordset.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
            If adoRecordset.RecordCount <> 0 Then
               IsUpdate = True
            End If
            CheckOC
            If IsUpdate = True Then
                 '速度資料
                 strSql = "update monthassess set "
                 
                 'Modify by Morgan 2009/7/14
                 'For GrdRow = 2 To grd(GrdIndex).Rows - 2
                 For GrdRow = 2 To 33
                     grd(GrdIndex).row = GrdRow
                     DoEvents
                     strSql = strSql & " ma" & Format(GrdRow + 2, "00") & "=0" & Replace(grd(GrdIndex).Text, "%", "") & ","
                 Next GrdRow
                 '其餘資料
                 grd(GrdIndex).row = 34

                 If GrdIndex = 0 Then '承辦人
                 
                     'Modify by Morgan 2009/7/14 +MA54
                     strSql = strSql & " ma54=" & Val(grd(GrdIndex).TextMatrix(35, GrdCol)) & ","
                     
                     StrSQLa = "select sum(nvl(oCount,0)),sum(nvl(oPoint,0)),sum(nvl(oCount2,0)),sum(nvl(oPoint2,0)),sum(nvl(oCount3,0)),sum(nvl(oCount4,0)),sum(nvl(oCount5,0)),sum(nvl(oPoint3,0))  from ("
                     'Modify by Morgan 2011/5/30 若有建點數分配資料時點數改分配點數(目前有225提供書狀意見及226配合開庭)
                     'strSQLA = strSQLA & "select cp01,cp02,cp09,decode(cp112,'Y',round(nvl(cp97,0) * nvl(cp98,0) * nvl(cp111,1),2),round(cp97 * cp98,2)) as oCount,sum(nvl(cp18,0)-nvl(a1u07/1000,0)) as oPoint,0 as oCount2,0 as oPoint2,0 as oCount3,0 as oCount4,0 as oCount5 from caseprogress,(select a1u03,sum(nvl(a1u07,0)) as a1u07 from acc1u0 where a1u03 in (select cp09 from caseprogress where cp14='" & grd(GrdIndex) & "' and cp27>=" & Trim(str(Val(CalYM) + 191100)) & "01 and cp27<=" & Trim(str(Val(CalYM) + 191100)) & "31) group by a1u03) ABCDE where cp14='" & grd(GrdIndex) & "' and cp27>=" & Trim(str(Val(CalYM) + 191100)) & "01 and cp27<=" & Trim(str(Val(CalYM) + 191100)) & "31 and cp09=a1u03(+) group by cp01,cp02,cp09,decode(cp112,'Y',round(nvl(cp97,0) * nvl(cp98,0) * nvl(cp111,1),2),round(cp97 * cp98,2))"
                     StrSQLa = StrSQLa & "select cp01,cp02,cp09,decode(cp112,'Y',round(nvl(cp97,0) * nvl(cp98,0) * nvl(cp111,1),2),round(cp97 * cp98,2)) as oCount,sum(nvl(a0n03/1000,nvl(cp18,0)-nvl(a1u07/1000,0))) as oPoint,0 as oCount2,0 as oPoint2,0 as oCount3,0 as oCount4,0 as oCount5,sum(decode(CP26,'N',0,nvl(a0n03/1000,cp18-nvl(a1u07/1000,0)))) as oPoint3 from caseprogress,(select a1u03,sum(nvl(a1u07,0)) as a1u07 from acc1u0 where a1u03 in (select cp09 from caseprogress where cp14='" & grd(GrdIndex) & "' and cp27>=" & Trim(str(Val(CalYM) + 191100)) & "01 and cp27<=" & Trim(str(Val(CalYM) + 191100)) & "31) group by a1u03) ABCDE,acc0n0 where a0n02(+)=cp09 and cp14='" & grd(GrdIndex) & "' and cp27>=" & Trim(str(Val(CalYM) + 191100)) & "01 and cp27<=" & Trim(str(Val(CalYM) + 191100)) & "31 and cp09=a1u03(+) group by cp01,cp02,cp09,decode(cp112,'Y',round(nvl(cp97,0) * nvl(cp98,0) * nvl(cp111,1),2),round(cp97 * cp98,2))"
                     
                     'Modify by Morgan 2008/10/28 承辦件數也要加支援
                     'strSQLA = strSQLA & " union select sh06,sh07,sh12,Round(Decode(SH06, 'CFP', Nvl(SH05, 0)/3, Nvl(SH05, 0)/4) ,2) as oCount,0 as oPoint,0 as oCount2,0 as oPoint2,0 as oCount3,0 as oCount4,0 as oCount5 from supporthour where sh02='" & grd(GrdIndex) & "' and sh01>=" & Trim(Str(Val(CalYM) + 191100)) & "01 and sh01<=" & Trim(Str(Val(CalYM) + 191100)) & "31 and sh11='V' "
                     'Modified by Morgan 2014/3/20 --2014/4/1起支援改每小時折計0.2基數
                     'StrSQLa = StrSQLa & " Union All select sh06,sh07,sh12,Round(Decode(SH06, 'CFP', Nvl(SH05, 0)/3, Nvl(SH05, 0)/4) ,2) as oCount,0 as oPoint,Round(Decode(SH06, 'CFP', Nvl(SH05, 0)/3, Nvl(SH05, 0)/4) ,2) as oCount2,0 as oPoint2,0 as oCount3,0 as oCount4,0 as oCount5 from supporthour where sh02='" & grd(GrdIndex) & "' and sh01>=" & Trim(str(Val(CalYM) + 191100)) & "01 and sh01<=" & Trim(str(Val(CalYM) + 191100)) & "31 and sh11='V' "
                     'Modified by Morgan 2019/4/9 108考核支援時數轉換要除組別參數
                     StrSQLa = StrSQLa & " Union All select sh06,sh07,sh12,Round(" & Sh2EPtCode & " / GetDivNum(st70,sh01),2) as oCount,0 as oPoint,Round(" & Sh2EPtCode & " / GetDivNum(st70,sh01),2) as oCount2,0 as oPoint2,0 as oCount3,0 as oCount4,0 as oCount5,0 as oPoint3 from supporthour,staff where st01(+)=sh02 and sh02='" & grd(GrdIndex) & "' and sh01>=" & Trim(str(Val(CalYM) + 191100)) & "01 and sh01<=" & Trim(str(Val(CalYM) + 191100)) & "31 and sh11='V' "
                     'end 2014/3/20
                     
                     If Val(Trim(str(Val(CalYM) + 191100)) & "01") < Val(PUB_108RuleDate) Then 'Added by Morgan 2019/3/18 108考核(取消收文點數轉換,另原修改紀錄及衍生工作紀錄103年就取消,一併排除)
                     
                        'Added by Morgan 2012/4/19 補收文點數
                        'Modified by Morgan 2014/3/20 --2014/4/1起非智權收文改每點折算0.04基數
                        'StrSQLa = StrSQLa & " Union All select cp01,cp02,cp09,Round(nvl(a0n03/1000,cp18)*0.05 ,2) as oCount,0 as oPoint,Round(nvl(a0n03/1000,cp18)*0.05 ,2) as oCount2,0 as oPoint2,0 as oCount3,0 as oCount4,0 as oCount5 from caseprogress,acc0n0 where a0n02(+)=cp09 and cp13='" & grd(GrdIndex) & "' and cp05>=" & Trim(str(Val(CalYM) + 191100)) & "01 and cp05<=" & Trim(str(Val(CalYM) + 191100)) & "31 And nvl(a0n03/1000,cp18)>0 and cp20 is null and cp57 is null and substr(cp12,1,1)<>'S' "
                        'Modified by Lydia 2016/09/14 cp57 is null=>CP159=0
                        StrSQLa = StrSQLa & " Union All select cp01,cp02,cp09,Round(" & Pt2EPtCode & ",2) as oCount,0 as oPoint,Round(" & Pt2EPtCode & ",2) as oCount2,0 as oPoint2,0 as oCount3,0 as oCount4,0 as oCount5,0 as oPoint3 from caseprogress,acc0n0 where a0n02(+)=cp09 and cp13='" & grd(GrdIndex) & "' and cp05>=" & Trim(str(Val(CalYM) + 191100)) & "01 and cp05<=" & Trim(str(Val(CalYM) + 191100)) & "31 And nvl(a0n03/1000,cp18)>0 and cp20 is null and CP159=0 and substr(cp12,1,1)<>'S' "
                        'end 2014/3/20
                        'end 2012/4/19
                        
                        'Add by Morgan 2011/8/1 + 修改紀錄,衍生工作紀錄
                        StrSQLa = StrSQLa & " Union All select mh06,mh07,mh12,Round(Nvl(MH05,0)*0.2 ,2) as oCount,0 as oPoint,Round(Nvl(MH05,0)*0.2 ,2) as oCount2,0 as oPoint2,0 as oCount3,0 as oCount4,0 as oCount5,0 as oPoint3 from ModifyHour where mh02='" & grd(GrdIndex) & "' and mh01>=" & Trim(str(Val(CalYM) + 191100)) & "01 and mh01<=" & Trim(str(Val(CalYM) + 191100)) & "31 and mh11='V' "
                        StrSQLa = StrSQLa & " Union All select eh06,eh07,eh12,Round(Nvl(EH05,0)*0.25 ,2) as oCount,0 as oPoint,Round(Nvl(EH05,0)*0.25 ,2) as oCount2,0 as oPoint2,0 as oCount3,0 as oCount4,0 as oCount5,0 as oPoint3 from ExtendHour where eh02='" & grd(GrdIndex) & "' and eh01>=" & Trim(str(Val(CalYM) + 191100)) & "01 and eh01<=" & Trim(str(Val(CalYM) + 191100)) & "31 and eh11='V' "
                        'end 2011/8/1
                     
                     End If 'Added by Morgan 2019/3/18
                     
                     'Modify by Morgan 2011/5/30 若有建點數分配資料時點數改分配點數(目前有225提供書狀意見及226配合開庭)
                     'strSQLA = strSQLA & " Union All select cp01,cp02,cp09,round(Nvl(SCR02,0),2) as oCount,0 as oPoint,decode(cp112,'Y',round(nvl(cp97,0) * nvl(cp98,0) * nvl(cp111,1),2),round(cp97 * cp98,2)) as oCount2,sum(nvl(cp18,0)-nvl(a1u07/1000,0)) as oPoint2,0 as oCount3,0 as oCount4,0 as oCount5 from specialcaserecord,engineerprogress,caseprogress,(select a1u03,sum(nvl(a1u07,0)) as a1u07 from acc1u0 where a1u03 in (select cp09 from caseprogress where cp14='" & grd(GrdIndex) & "' and cp27>=" & Trim(str(Val(CalYM) + 191100)) & "01 and cp27<=" & Trim(str(Val(CalYM) + 191100)) & "31) group by a1u03) ABCDE where ep02=scr01(+) and ep05='" & grd(GrdIndex) & "' and ep09>=" & Trim(str(Val(CalYM) + 191100)) & "01 and ep09<=" & Trim(str(Val(CalYM) + 191100)) & "31 and 'V'=scr03(+) and ep02=cp09(+) and ep02=a1u03(+) group by cp01,cp02,cp09,round(Nvl(SCR02,0),2),decode(cp112,'Y',round(nvl(cp97,0) * nvl(cp98,0) * nvl(cp111,1),2),round(cp97 * cp98,2))"
                     StrSQLa = StrSQLa & " Union All select cp01,cp02,cp09,round(Nvl(SCR02,0),2) as oCount,0 as oPoint,decode(cp112,'Y',round(nvl(cp97,0) * nvl(cp98,0) * nvl(cp111,1),2),round(cp97 * cp98,2)) as oCount2,sum(nvl(a0n03/1000,nvl(cp18,0)-nvl(a1u07/1000,0))) as oPoint2,0 as oCount3,0 as oCount4,0 as oCount5,0 as oPoint3 from specialcaserecord,engineerprogress,caseprogress,(select a1u03,sum(nvl(a1u07,0)) as a1u07 from acc1u0 where a1u03 in (select cp09 from caseprogress where cp14='" & grd(GrdIndex) & "' and cp27>=" & Trim(str(Val(CalYM) + 191100)) & "01 and cp27<=" & Trim(str(Val(CalYM) + 191100)) & "31) group by a1u03) ABCDE,acc0n0 where a0n02(+)=cp09 and ep02=scr01(+) and ep05='" & grd(GrdIndex) & "' and ep09>=" & Trim(str(Val(CalYM) + 191100)) & "01 and ep09<=" & Trim(str(Val(CalYM) + 191100)) & "31 and 'V'=scr03(+) and ep02=cp09(+) and ep02=a1u03(+) group by cp01,cp02,cp09,round(Nvl(SCR02,0),2),decode(cp112,'Y',round(nvl(cp97,0) * nvl(cp98,0) * nvl(cp111,1),2),round(cp97 * cp98,2))"
                     
                     StrSQLa = StrSQLa & " Union All select cp01,cp02,cp09,0 as oCount,0 as oPoint,0 as oCount2,0 as oPoint2,count(*) as oCount3,0 as oCount4,0 as oCount5,0 as oPoint3 from caseprogress,engineerprogress where ep05='" & grd(GrdIndex) & "' and ep09>=" & Trim(str(Val(CalYM) + 191100)) & "01 and ep09<=" & Trim(str(Val(CalYM) + 191100)) & "31 and ep02=cp09(+) and ep09>cp48  group by cp01,cp02,cp09 "
                     StrSQLa = StrSQLa & " ) AA "
                     CheckOC
                     adoRecordset.CursorLocation = adUseClient
                     adoRecordset.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
                     'Modified by Morgan 2019/3/21 +ma55發文實績點數
                     If adoRecordset.RecordCount <> 0 Then
                           strSql = strSql & " ma37=0" & CheckStr(adoRecordset.Fields(0).Value) & ", "
                           strSql = strSql & " ma40=0" & CheckStr(adoRecordset.Fields(1).Value) & ", "
                           strSql = strSql & " ma43=0" & CheckStr(adoRecordset.Fields(2).Value) & ", "
                           strSql = strSql & " ma50=0" & CheckStr(adoRecordset.Fields(3).Value) & ", "
                           strSql = strSql & " ma51=0" & CheckStr(adoRecordset.Fields(4).Value) & ", "
                           strSql = strSql & " ma52=0" & CheckStr(adoRecordset.Fields(5).Value) & ", "
                           strSql = strSql & " ma47=0" & CheckStr(adoRecordset.Fields(6).Value) & ", "
                           strSql = strSql & " ma55=0" & CheckStr(adoRecordset.Fields(7).Value) & "  "
                     Else
                           strSql = strSql & " ma37=0,ma40=0,ma43=0,ma50=0,ma51=0,ma52=0,ma47=0,ma55=0 "
                     End If
                 Else   ' 繪圖
                     StrSQLa = "select sum(nvl(oCount,0)),sum(nvl(oPoint,0)),sum(nvl(oCount2,0)),sum(nvl(oPoint2,0)),0,sum(nvl(oCount4,0)),sum(nvl(oCount5,0)),sum(nvl(oPoint3,0))  from ("
                     If IsRoung = True Then
                        StrSQLa = StrSQLa & "select cp01,cp02,cp09,0 as oCount,0 as oPoint,0 as oCount2,0 as oPoint2,0 as oCount3,0 as oCount4,decode(ep20,null,nvl(ep16,0) / 2,0) as oCount5,0 as oPoint3 from caseprogress,engineerprogress where ep13='" & grd(GrdIndex) & "' and cp27>=" & Trim(str(Val(CalYM) + 191100)) & "01 and cp27<=" & Trim(str(Val(CalYM) + 191100)) & "31 and ep02=cp09(+)  and cp107='Y' "
                     Else
                        'Modify by Morgan 2011/5/30 若有建點數分配資料時點數改分配點數(目前有225提供書狀意見及226配合開庭)
                        'strSQLA = strSQLA & "select cp01,cp02,cp09,decode(ep29,null,round(cp103 * cp104,2),0) as oCount,sum(nvl(cp18,0)-nvl(a1u07/1000,0)) as oPoint,0 as oCount2,0 as oPoint2,0 as oCount3,0 as oCount4,decode(ep29,null,nvl(ep19,0)/2,0) as oCount5 from caseprogress,engineerprogress,(select a1u03,sum(nvl(a1u07,0)) as a1u07 from acc1u0 where a1u03 in (select cp09 from caseprogress where cp29='" & grd(GrdIndex) & "' and cp27>=" & Trim(str(Val(CalYM) + 191100)) & "01 and cp27<=" & Trim(str(Val(CalYM) + 191100)) & "31) group by a1u03) ABCDE where ep13='" & grd(GrdIndex) & "' and cp27>=" & Trim(str(Val(CalYM) + 191100)) & "01 and cp27<=" & Trim(str(Val(CalYM) + 191100)) & "31 and ep02=cp09(+) and (ep29 is null or ep20||ep29||cp10='NN910') and ep02=a1u03(+) and cp107='Y'  group by cp01,cp02,cp09,decode(ep29,null,round(cp103 * cp104,2),0),decode(ep29,null,nvl(ep19,0)/2,0) "
                        StrSQLa = StrSQLa & "select cp01,cp02,cp09,decode(ep29,null,round(cp103 * cp104,2),0) as oCount,sum(nvl(a0n03/1000,nvl(cp18,0)-nvl(a1u07/1000,0))) as oPoint,0 as oCount2,0 as oPoint2,0 as oCount3,0 as oCount4,decode(ep29,null,nvl(ep19,0)/2,0) as oCount5,sum(decode(CP26,'N',0,nvl(a0n03/1000,cp18-nvl(a1u07/1000,0)))) as oPoint3 from caseprogress,engineerprogress,(select a1u03,sum(nvl(a1u07,0)) as a1u07 from acc1u0 where a1u03 in (select cp09 from caseprogress where cp29='" & grd(GrdIndex) & "' and cp27>=" & Trim(str(Val(CalYM) + 191100)) & "01 and cp27<=" & Trim(str(Val(CalYM) + 191100)) & "31) group by a1u03) ABCDE,acc0n0 where a0n02(+)=cp09 and ep13='" & grd(GrdIndex) & "' and cp27>=" & Trim(str(Val(CalYM) + 191100)) & "01 and cp27<=" & Trim(str(Val(CalYM) + 191100)) & "31 and ep02=cp09(+) and (ep29 is null or ep20||ep29||cp10='NN910') and ep02=a1u03(+) and cp107='Y'  group by cp01,cp02,cp09,decode(ep29,null,round(cp103 * cp104,2),0),decode(ep29,null,nvl(ep19,0)/2,0) "
                     End If
                     If IsRoung = True Then
                        StrSQLa = StrSQLa & " Union All select cp01,cp02,cp09,0 as oCount,0 as oPoint,0 as oCount2,0 as oPoint2,0 as oCount3,decode(ep20,null,nvl(ep16,0)/2,0) as oCount4,0 as oCount5,0 as oPoint3 from engineerprogress,caseprogress where ep13='" & grd(GrdIndex) & "' and ep15>=" & Trim(str(Val(CalYM) + 191100)) & "01 and ep15<=" & Trim(str(Val(CalYM) + 191100)) & "31 and ep02=cp09(+)  and cp107='Y' "
                     Else
                        '繪圖的支援只算在墨圖
                        'Modified by Morgan 2014/3/20 --2014/4/1起支援改每小時折計0.2基數
                        'StrSQLa = StrSQLa & " Union All select sh06,sh07,sh12,Round(Nvl(SH05, 0)/4 ,2) as oCount,0 as oPoint,Round(Nvl(SH05, 0)/4 ,2) as oCount2,0 as oPoint2,0 as oCount3,0 as oCount4,0 as oCount5 from supporthour where sh02='" & grd(GrdIndex) & "' and sh01>=" & Trim(str(Val(CalYM) + 191100)) & "01 and sh01<=" & Trim(str(Val(CalYM) + 191100)) & "31 and sh11='V' "
                        StrSQLa = StrSQLa & " Union All select sh06,sh07,sh12,Round(" & Sh2EPtCode & ",2) as oCount,0 as oPoint,Round(DECODE(sign(SH01-20140401),-1,Decode(SH06, 'CFP', Nvl(SH05,0)/3, Nvl(SH05,0)/4), SH05*0.2),2) as oCount2,0 as oPoint2,0 as oCount3,0 as oCount4,0 as oCount5,0 as oPoint3 from supporthour where sh02='" & grd(GrdIndex) & "' and sh01>=" & Trim(str(Val(CalYM) + 191100)) & "01 and sh01<=" & Trim(str(Val(CalYM) + 191100)) & "31 and sh11='V' "
                        'end 2014/3/20
                        
                        If Val(Trim(str(Val(CalYM) + 191100)) & "01") < Val(PUB_108RuleDate) Then 'Added by Morgan 2019/3/18 108考核(取消收文點數轉換,另原修改紀錄及衍生工作紀錄103年就取消,一併排除)
                        
                           'Added by Morgan 2012/4/19 補收文點數
                           'Modified by Morgan 2014/3/20 --2014/4/1起非智權收文改每點折算0.04基數
                           'StrSQLa = StrSQLa & " Union All select cp01,cp02,cp09,Round(nvl(a0n03/1000,cp18)*0.05 ,2) as oCount,0 as oPoint,Round(nvl(a0n03/1000,cp18)*0.05 ,2) as oCount2,0 as oPoint2,0 as oCount3,0 as oCount4,0 as oCount5 from caseprogress,acc0n0 where a0n02(+)=cp09 and cp13='" & grd(GrdIndex) & "' and cp05>=" & Trim(str(Val(CalYM) + 191100)) & "01 and cp05<=" & Trim(str(Val(CalYM) + 191100)) & "31 And nvl(a0n03/1000,cp18)>0 and cp20 is null and cp57 is null and substr(cp12,1,1)<>'S' "
                           'Modified by Lydia 2016/09/14 cp57 is null=>CP159=0
                           StrSQLa = StrSQLa & " Union All select cp01,cp02,cp09,Round(" & Pt2EPtCode & ",2) as oCount,0 as oPoint,Round(" & Pt2EPtCode & " ,2) as oCount2,0 as oPoint2,0 as oCount3,0 as oCount4,0 as oCount5,0 as oPoint3 from caseprogress,acc0n0 where a0n02(+)=cp09 and cp13='" & grd(GrdIndex) & "' and cp05>=" & Trim(str(Val(CalYM) + 191100)) & "01 and cp05<=" & Trim(str(Val(CalYM) + 191100)) & "31 And nvl(a0n03/1000,cp18)>0 and cp20 is null and CP159=0 and substr(cp12,1,1)<>'S' "
                           'end 2014/3/20
                           'end 2012/4/19
                           
                           'Add by Morgan 2011/8/1 + 修改紀錄,衍生工作紀錄
                           StrSQLa = StrSQLa & " Union All select mh06,mh07,mh12,Round(Nvl(MH05,0)*0.2 ,2) as oCount,0 as oPoint,Round(Nvl(MH05,0)*0.2 ,2) as oCount2,0 as oPoint2,0 as oCount3,0 as oCount4,0 as oCount5,0 as oPoint3 from ModifyHour where mh02='" & grd(GrdIndex) & "' and mh01>=" & Trim(str(Val(CalYM) + 191100)) & "01 and mh01<=" & Trim(str(Val(CalYM) + 191100)) & "31 and mh11='V' "
                           StrSQLa = StrSQLa & " Union All select eh06,eh07,eh12,Round(Nvl(EH05,0)*0.25 ,2) as oCount,0 as oPoint,Round(Nvl(EH05,0)*0.25 ,2) as oCount2,0 as oPoint2,0 as oCount3,0 as oCount4,0 as oCount5,0 as oPoint3 from ExtendHour where eh02='" & grd(GrdIndex) & "' and eh01>=" & Trim(str(Val(CalYM) + 191100)) & "01 and eh01<=" & Trim(str(Val(CalYM) + 191100)) & "31 and eh11='V' "
                           'end 2011/8/1
                           
                        End If 'Added by Morgan 2019/3/18
                        
                        'Modify by Morgan 2011/5/30 若有建點數分配資料時點數改分配點數(目前有225提供書狀意見及226配合開庭)
                        'strSQLA = strSQLA & " Union All select cp01,cp02,cp09,0 as oCount,0 as oPoint,decode(ep29,null,round(cp103 * cp104,2),0) as oCount2,sum(nvl(cp18,0)-nvl(a1u07/1000,0)) as oPoint2,0 as oCount3,decode(ep29,null,nvl(ep19,0)/2,0) as oCount4,0 as oCount5 from engineerprogress,caseprogress,(select a1u03,sum(nvl(a1u07,0)) as a1u07 from acc1u0 where a1u03 in (select cp09 from caseprogress where cp29='" & grd(GrdIndex) & "' and cp27>=" & Trim(str(Val(CalYM) + 191100)) & "01 and cp27<=" & Trim(str(Val(CalYM) + 191100)) & "31) group by a1u03) ABCDE where ep13='" & grd(GrdIndex) & "' and ep18>=" & Trim(str(Val(CalYM) + 191100)) & "01 and ep18<=" & Trim(str(Val(CalYM) + 191100)) & "31 and ep02=cp09(+) and (ep29 is null or ep20||ep29||cp10='NN910') and ep02=a1u03(+) and cp107='Y' group by cp01,cp02,cp09,decode(ep29,null,round(cp103 * cp104,2),0),decode(ep29,null,nvl(ep19,0)/2,0) "
                        StrSQLa = StrSQLa & " Union All select cp01,cp02,cp09,0 as oCount,0 as oPoint,decode(ep29,null,round(cp103 * cp104,2),0) as oCount2,sum(nvl(a0n03/1000,nvl(cp18,0)-nvl(a1u07/1000,0))) as oPoint2,0 as oCount3,decode(ep29,null,nvl(ep19,0)/2,0) as oCount4,0 as oCount5,0 as oPoint3 from engineerprogress,caseprogress,(select a1u03,sum(nvl(a1u07,0)) as a1u07 from acc1u0 where a1u03 in (select cp09 from caseprogress where cp29='" & grd(GrdIndex) & "' and cp27>=" & Trim(str(Val(CalYM) + 191100)) & "01 and cp27<=" & Trim(str(Val(CalYM) + 191100)) & "31) group by a1u03) ABCDE,acc0n0 where a0n02(+)=cp09 and ep13='" & grd(GrdIndex) & "' and ep18>=" & Trim(str(Val(CalYM) + 191100)) & "01 and ep18<=" & Trim(str(Val(CalYM) + 191100)) & "31 and ep02=cp09(+) and (ep29 is null or ep20||ep29||cp10='NN910') and ep02=a1u03(+) and cp107='Y' group by cp01,cp02,cp09,decode(ep29,null,round(cp103 * cp104,2),0),decode(ep29,null,nvl(ep19,0)/2,0) "
                     End If
                     StrSQLa = StrSQLa & " ) AA "
                     CheckOC
                     adoRecordset.CursorLocation = adUseClient
                     adoRecordset.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
                     'Modified by Morgan 2019/3/21 +ma55發文實績點數
                     If adoRecordset.RecordCount <> 0 Then
                           strSql = strSql & " ma37=0" & CheckStr(adoRecordset.Fields(0).Value) & ", "
                           strSql = strSql & " ma40=0" & CheckStr(adoRecordset.Fields(1).Value) & ", "
                           strSql = strSql & " ma43=0" & CheckStr(adoRecordset.Fields(2).Value) & ", "
                           strSql = strSql & " ma50=0" & CheckStr(adoRecordset.Fields(3).Value) & ",ma51=" & GetDelay(grd(GrdIndex), IsRoung) & ", "
                           strSql = strSql & " ma52=0" & CheckStr(adoRecordset.Fields(5).Value) & ", "
                           strSql = strSql & " ma47=0" & CheckStr(adoRecordset.Fields(6).Value) & ", "
                           strSql = strSql & " ma55=0" & CheckStr(adoRecordset.Fields(7).Value) & "  "
                     Else
                           strSql = strSql & " ma37=0,ma40=0,ma43=0,ma50=0,ma51=" & GetDelay(grd(GrdIndex), IsRoung) & ",ma52=0,ma47=0,ma55=0 "
                     End If
                 End If
                 strSql = strSql & " where ma01='" & grd(GrdIndex) & "' and ma02=" & Trim(str(Val(CalYM) + 191100)) & " and ma03='" & Trim(str(GrdIndex + 1)) & "' and ma36='"
                 If GrdIndex = 0 Then
                     strSql = strSql & "0' "
                 Else
                     grd(GrdIndex).row = 1
                     If grd(GrdIndex).Text = "草" Then
                        strSql = strSql & "1' "
                     Else
                        strSql = strSql & "2' "
                     End If
                 End If
            Else
                 'Modify by Morgan 2009/8/4 +ma54
                 'Modified by Morgan 2019/3/21 +ma55(注意欄位順序要和下面的資料一致)
                 strSql = "insert into monthassess (ma01,ma02,ma03,ma04,ma05,ma06,ma07,ma08,ma09,ma10,ma11,ma12,ma13,ma14,ma15,ma16,ma17,ma18,ma19,ma20,ma21,ma22,ma23,ma24,ma25,ma26,ma27,ma28,ma29,ma30,ma31,ma32,ma33,ma34,ma35,ma36,ma37,ma40,ma43,ma50,ma51,ma52,ma47,ma55,ma54) values ('" & grd(GrdIndex) & "'," & Trim(str(Val(CalYM) + 191100)) & ",'" & Trim(str(GrdIndex + 1)) & "', "
                 'Modify by Morgan 2009/8/4
                 'For GrdRow = 2 To grd(GrdIndex).Rows - 2
                 For GrdRow = 2 To 33
                     grd(GrdIndex).row = GrdRow
                     DoEvents
                     strSql = strSql & " 0" & Replace(grd(GrdIndex).Text, "%", "") & ","
                 Next GrdRow
                 '其餘資料
                 grd(GrdIndex).row = 34
                 If GrdIndex = 0 Then '承辦人
                     'ma36
                     strSql = strSql & " '0',"
                     StrSQLa = "select sum(nvl(oCount,0)),sum(nvl(oPoint,0)),sum(nvl(oCount2,0)),sum(nvl(oPoint2,0)),sum(nvl(oCount3,0)),sum(nvl(oCount4,0)),sum(nvl(oCount5,0)),sum(nvl(oPoint3,0))  from ("
                     'Modify by Morgan 2011/5/30 若有建點數分配資料時點數改分配點數(目前有225提供書狀意見及226配合開庭)
                     'strSQLA = strSQLA & "select cp01,cp02,cp09,decode(cp112,'Y',round(nvl(cp97,0) * nvl(cp98,0) * nvl(cp111,1),2),round(cp97 * cp98,2)) as oCount,sum(nvl(cp18,0)-nvl(a1u07/1000,0)) as oPoint,0 as oCount2,0 as oPoint2,0 as oCount3,0 as oCount4,0 as oCount5 from caseprogress,(select a1u03,sum(nvl(a1u07,0)) as a1u07 from acc1u0 where a1u03 in (select cp09 from caseprogress where cp14='" & grd(GrdIndex) & "' and cp27>=" & Trim(str(Val(CalYM) + 191100)) & "01 and cp27<=" & Trim(str(Val(CalYM) + 191100)) & "31) group by a1u03) ABCDE where cp14='" & grd(GrdIndex) & "' and cp27>=" & Trim(str(Val(CalYM) + 191100)) & "01 and cp27<=" & Trim(str(Val(CalYM) + 191100)) & "31 and cp09=a1u03(+) group by cp01,cp02,cp09,decode(cp112,'Y',round(nvl(cp97,0) * nvl(cp98,0) * nvl(cp111,1),2),round(cp97 * cp98,2)) "
                     StrSQLa = StrSQLa & "select cp01,cp02,cp09,decode(cp112,'Y',round(nvl(cp97,0) * nvl(cp98,0) * nvl(cp111,1),2),round(cp97 * cp98,2)) as oCount,sum(nvl(a0n03/1000,nvl(cp18,0)-nvl(a1u07/1000,0))) as oPoint,0 as oCount2,0 as oPoint2,0 as oCount3,0 as oCount4,0 as oCount5,sum(decode(CP26,'N',0,nvl(a0n03/1000,cp18-nvl(a1u07/1000,0)))) as oPoint3 from caseprogress,(select a1u03,sum(nvl(a1u07,0)) as a1u07 from acc1u0 where a1u03 in (select cp09 from caseprogress where cp14='" & grd(GrdIndex) & "' and cp27>=" & Trim(str(Val(CalYM) + 191100)) & "01 and cp27<=" & Trim(str(Val(CalYM) + 191100)) & "31) group by a1u03) ABCDE,acc0n0 where a0n02(+)=cp09 and cp14='" & grd(GrdIndex) & "' and cp27>=" & Trim(str(Val(CalYM) + 191100)) & "01 and cp27<=" & Trim(str(Val(CalYM) + 191100)) & "31 and cp09=a1u03(+) group by cp01,cp02,cp09,decode(cp112,'Y',round(nvl(cp97,0) * nvl(cp98,0) * nvl(cp111,1),2),round(cp97 * cp98,2)) "
                     
                     'Modify by Morgan 2008/10/28 承辦件數也要加支援
                     'strSQLA = strSQLA & " union select sh06,sh07,sh12,Round(Decode(SH06, 'CFP', Nvl(SH05, 0)/3, Nvl(SH05, 0)/4) ,2) as oCount,0 as oPoint,0 as oCount2,0 as oPoint2,0 as oCount3,0 as oCount4,0 as oCount5 from supporthour where sh02='" & grd(GrdIndex) & "' and sh01>=" & Trim(Str(Val(CalYM) + 191100)) & "01 and sh01<=" & Trim(Str(Val(CalYM) + 191100)) & "31 and sh11='V' "
                     'Modified by Morgan 2014/3/20 --2014/4/1起支援改每小時折計0.2基數
                     'StrSQLa = StrSQLa & " Union All select sh06,sh07,sh12,Round(Decode(SH06, 'CFP', Nvl(SH05, 0)/3, Nvl(SH05, 0)/4) ,2) as oCount,0 as oPoint,Round(Decode(SH06, 'CFP', Nvl(SH05, 0)/3, Nvl(SH05, 0)/4) ,2) as oCount2,0 as oPoint2,0 as oCount3,0 as oCount4,0 as oCount5 from supporthour where sh02='" & grd(GrdIndex) & "' and sh01>=" & Trim(str(Val(CalYM) + 191100)) & "01 and sh01<=" & Trim(str(Val(CalYM) + 191100)) & "31 and sh11='V' "
                     'Modified by Morgan 2019/4/9 108考核支援時數轉換要除組別參數
                     StrSQLa = StrSQLa & " Union All select sh06,sh07,sh12,Round(" & Sh2EPtCode & " / GetDivNum(st70,sh01),2) as oCount,0 as oPoint,Round(" & Sh2EPtCode & " / GetDivNum(st70,sh01),2) as oCount2,0 as oPoint2,0 as oCount3,0 as oCount4,0 as oCount5,0 as oPoint3 from supporthour,staff where st01(+)=sh02 and sh02='" & grd(GrdIndex) & "' and sh01>=" & Trim(str(Val(CalYM) + 191100)) & "01 and sh01<=" & Trim(str(Val(CalYM) + 191100)) & "31 and sh11='V' "
                     'end 2014/3/20
                     
                     If Val(Trim(str(Val(CalYM) + 191100)) & "01") < Val(PUB_108RuleDate) Then 'Added by Morgan 2019/3/18 108考核(取消收文點數轉換,另原修改紀錄及衍生工作紀錄103年就取消,一併排除)
                     
                        'Added by Morgan 2012/4/19 補收文點數
                        'Modified by Morgan 2014/3/20 --2014/4/1起非智權收文改每點折算0.04基數
                        'StrSQLa = StrSQLa & " Union All select cp01,cp02,cp09,Round(nvl(a0n03/1000,cp18)*0.05 ,2) as oCount,0 as oPoint,Round(nvl(a0n03/1000,cp18)*0.05 ,2) as oCount2,0 as oPoint2,0 as oCount3,0 as oCount4,0 as oCount5 from caseprogress,acc0n0 where a0n02(+)=cp09 and cp13='" & grd(GrdIndex) & "' and cp05>=" & Trim(str(Val(CalYM) + 191100)) & "01 and cp05<=" & Trim(str(Val(CalYM) + 191100)) & "31 And nvl(a0n03/1000,cp18)>0 and cp20 is null and cp57 is null and substr(cp12,1,1)<>'S' "
                        'Modified by Lydia 2016/09/14 cp57 is null=>CP159=0
                        StrSQLa = StrSQLa & " Union All select cp01,cp02,cp09,Round(" & Pt2EPtCode & ",2) as oCount,0 as oPoint,Round(" & Pt2EPtCode & ",2) as oCount2,0 as oPoint2,0 as oCount3,0 as oCount4,0 as oCount5,0 as oPoint3 from caseprogress,acc0n0 where a0n02(+)=cp09 and cp13='" & grd(GrdIndex) & "' and cp05>=" & Trim(str(Val(CalYM) + 191100)) & "01 and cp05<=" & Trim(str(Val(CalYM) + 191100)) & "31 And nvl(a0n03/1000,cp18)>0 and cp20 is null and CP159=0 and substr(cp12,1,1)<>'S' "
                        'end 2014/3/20
                        'end 2012/4/19
                        
                        'Add by Morgan 2011/8/1 + 修改紀錄,衍生工作紀錄
                        StrSQLa = StrSQLa & " Union All select mh06,mh07,mh12,Round(Nvl(MH05,0)*0.2 ,2) as oCount,0 as oPoint,Round(Nvl(MH05,0)*0.2 ,2) as oCount2,0 as oPoint2,0 as oCount3,0 as oCount4,0 as oCount5,0 as oPoint3 from ModifyHour where mh02='" & grd(GrdIndex) & "' and mh01>=" & Trim(str(Val(CalYM) + 191100)) & "01 and mh01<=" & Trim(str(Val(CalYM) + 191100)) & "31 and mh11='V' "
                        StrSQLa = StrSQLa & " Union All select eh06,eh07,eh12,Round(Nvl(EH05,0)*0.25 ,2) as oCount,0 as oPoint,Round(Nvl(EH05,0)*0.25 ,2) as oCount2,0 as oPoint2,0 as oCount3,0 as oCount4,0 as oCount5,0 as oPoint3 from ExtendHour where eh02='" & grd(GrdIndex) & "' and eh01>=" & Trim(str(Val(CalYM) + 191100)) & "01 and eh01<=" & Trim(str(Val(CalYM) + 191100)) & "31 and eh11='V' "
                        'end 2011/8/1
                        
                     End If 'Added by Morgan 2019/3/18
                     
                     'Modify by Morgan 2011/5/30 若有建點數分配資料時點數改分配點數(目前有225提供書狀意見及226配合開庭)
                     'strSQLA = strSQLA & " Union All select cp01,cp02,cp09,round(Nvl(SCR02,0),2) as oCount,0 as oPoint,decode(cp112,'Y',round(nvl(cp97,0) * nvl(cp98,0) * nvl(cp111,1),2),round(cp97 * cp98,2)) as oCount2,sum(nvl(cp18,0)-nvl(a1u07/1000,0)) as oPoint2,0 as oCount3,0 as oCount4,0 as oCount5 from specialcaserecord,engineerprogress,caseprogress,(select a1u03,sum(nvl(a1u07,0)) as a1u07 from acc1u0 where a1u03 in (select cp09 from caseprogress where cp14='" & grd(GrdIndex) & "' and cp27>=" & Trim(str(Val(CalYM) + 191100)) & "01 and cp27<=" & Trim(str(Val(CalYM) + 191100)) & "31) group by a1u03) ABCDE where ep02=scr01(+) and ep05='" & grd(GrdIndex) & "' and ep09>=" & Trim(str(Val(CalYM) + 191100)) & "01 and ep09<=" & Trim(str(Val(CalYM) + 191100)) & "31 and 'V'=scr03(+) and ep02=cp09(+) and ep02=a1u03(+) group by cp01,cp02,cp09,round(Nvl(SCR02,0),2),decode(cp112,'Y',round(nvl(cp97,0) * nvl(cp98,0) * nvl(cp111,1),2),round(cp97 * cp98,2)) "
                     StrSQLa = StrSQLa & " Union All select cp01,cp02,cp09,round(Nvl(SCR02,0),2) as oCount,0 as oPoint,decode(cp112,'Y',round(nvl(cp97,0) * nvl(cp98,0) * nvl(cp111,1),2),round(cp97 * cp98,2)) as oCount2,sum(nvl(a0n03/1000,nvl(cp18,0)-nvl(a1u07/1000,0))) as oPoint2,0 as oCount3,0 as oCount4,0 as oCount5,0 as oPoint3 from specialcaserecord,engineerprogress,caseprogress,(select a1u03,sum(nvl(a1u07,0)) as a1u07 from acc1u0 where a1u03 in (select cp09 from caseprogress where cp14='" & grd(GrdIndex) & "' and cp27>=" & Trim(str(Val(CalYM) + 191100)) & "01 and cp27<=" & Trim(str(Val(CalYM) + 191100)) & "31) group by a1u03) ABCDE,acc0n0 where a0n02(+)=cp09 and ep02=scr01(+) and ep05='" & grd(GrdIndex) & "' and ep09>=" & Trim(str(Val(CalYM) + 191100)) & "01 and ep09<=" & Trim(str(Val(CalYM) + 191100)) & "31 and 'V'=scr03(+) and ep02=cp09(+) and ep02=a1u03(+) group by cp01,cp02,cp09,round(Nvl(SCR02,0),2),decode(cp112,'Y',round(nvl(cp97,0) * nvl(cp98,0) * nvl(cp111,1),2),round(cp97 * cp98,2)) "
                     
                     StrSQLa = StrSQLa & " Union All select cp01,cp02,cp09,0 as oCount,0 as oPoint,0 as oCount2,0 as oPoint2,count(*) as oCount3,0 as oCount4,0 as oCount5,0 as oPoint3 from caseprogress,engineerprogress where ep05='" & grd(GrdIndex) & "' and ep09>=" & Trim(str(Val(CalYM) + 191100)) & "01 and ep09<=" & Trim(str(Val(CalYM) + 191100)) & "31 and ep02=cp09(+) and ep09>cp48  group by cp01,cp02,cp09 "
                     StrSQLa = StrSQLa & " ) AA "
                     CheckOC
                     adoRecordset.CursorLocation = adUseClient
                     adoRecordset.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
                     'Modified by Morgan 2019/3/21 +ma55發文實績點數
                     If adoRecordset.RecordCount <> 0 Then
                           strSql = strSql & " 0" & CheckStr(adoRecordset.Fields(0).Value) & ", "
                           strSql = strSql & " 0" & CheckStr(adoRecordset.Fields(1).Value) & ", "
                           strSql = strSql & " 0" & CheckStr(adoRecordset.Fields(2).Value) & ", "
                           strSql = strSql & " 0" & CheckStr(adoRecordset.Fields(3).Value) & ", "
                           strSql = strSql & " 0" & CheckStr(adoRecordset.Fields(4).Value) & ", "
                           strSql = strSql & " 0" & CheckStr(adoRecordset.Fields(5).Value) & ", "
                           strSql = strSql & " 0" & CheckStr(adoRecordset.Fields(6).Value) & ", "
                           strSql = strSql & " 0" & CheckStr(adoRecordset.Fields(7).Value) & "  "
                     Else
                           strSql = strSql & " 0,0,0,0,0,0,0,0 "
                     End If
                     strSql = strSql & "," & Val(grd(GrdIndex).TextMatrix(35, GrdCol))
                     
                 Else   ' 繪圖
                     grd(GrdIndex).row = 1
                     'ma36
                     strSql = strSql & " " & IIf(grd(GrdIndex).Text = "草", "'1'", "'2'") & ","
                     grd(GrdIndex).row = 34
                     StrSQLa = "select sum(nvl(oCount,0)),sum(nvl(oPoint,0)),sum(nvl(oCount2,0)),sum(nvl(oPoint2,0)),0,sum(nvl(oCount4,0)),sum(nvl(oCount5,0)),sum(nvl(oPoint3,0))  from ("
                     If IsRoung = True Then
                        StrSQLa = StrSQLa & "select cp01,cp02,cp09,0 as oCount,0 as oPoint,0 as oCount2,0 as oPoint2,0 as oCount3,0 as oCount4,decode(ep20,null,nvl(ep16,0)/2,0) as oCount5,0 as oPoint3 from caseprogress,engineerprogress where ep13='" & grd(GrdIndex) & "' and cp27>=" & Trim(str(Val(CalYM) + 191100)) & "01 and cp27<=" & Trim(str(Val(CalYM) + 191100)) & "31 and ep02=cp09(+)  and cp107='Y' "
                     Else
                        'Modify by Morgan 2011/5/30 若有建點數分配資料時點數改分配點數(目前有225提供書狀意見及226配合開庭)
                        'strSQLA = strSQLA & "select cp01,cp02,cp09,decode(ep29,null,round(cp103 * cp104,2),0) as oCount,sum(nvl(cp18,0)-nvl(a1u07/1000,0)) as oPoint,0 as oCount2,0 as oPoint2,0 as oCount3,0 as oCount4,decode(ep29,null,nvl(ep19,0)/2,0) as oCount5 from caseprogress,engineerprogress,(select a1u03,sum(nvl(a1u07,0)) as a1u07 from acc1u0 where a1u03 in (select cp09 from caseprogress where cp29='" & grd(GrdIndex) & "' and cp27>=" & Trim(str(Val(CalYM) + 191100)) & "01 and cp27<=" & Trim(str(Val(CalYM) + 191100)) & "31) group by a1u03) ABCDE where ep13='" & grd(GrdIndex) & "' and cp27>=" & Trim(str(Val(CalYM) + 191100)) & "01 and cp27<=" & Trim(str(Val(CalYM) + 191100)) & "31 and ep02=cp09(+) and (ep29 is null or ep20||ep29||cp10='NN910')  and ep02=a1u03(+) and cp107='Y' group by cp01,cp02,cp09,decode(ep29,null,round(cp103 * cp104,2),0),decode(ep29,null,nvl(ep19,0)/2,0) "
                        StrSQLa = StrSQLa & "select cp01,cp02,cp09,decode(ep29,null,round(cp103 * cp104,2),0) as oCount,sum(nvl(a0n03/1000,nvl(cp18,0)-nvl(a1u07/1000,0))) as oPoint,0 as oCount2,0 as oPoint2,0 as oCount3,0 as oCount4,decode(ep29,null,nvl(ep19,0)/2,0) as oCount5,sum(decode(CP26,'N',0,nvl(a0n03/1000,cp18-nvl(a1u07/1000,0)))) as oPoint3 from caseprogress,engineerprogress,(select a1u03,sum(nvl(a1u07,0)) as a1u07 from acc1u0 where a1u03 in (select cp09 from caseprogress where cp29='" & grd(GrdIndex) & "' and cp27>=" & Trim(str(Val(CalYM) + 191100)) & "01 and cp27<=" & Trim(str(Val(CalYM) + 191100)) & "31) group by a1u03) ABCDE,acc0n0 where a0n02(+)=cp09 and ep13='" & grd(GrdIndex) & "' and cp27>=" & Trim(str(Val(CalYM) + 191100)) & "01 and cp27<=" & Trim(str(Val(CalYM) + 191100)) & "31 and ep02=cp09(+) and (ep29 is null or ep20||ep29||cp10='NN910')  and ep02=a1u03(+) and cp107='Y' group by cp01,cp02,cp09,decode(ep29,null,round(cp103 * cp104,2),0),decode(ep29,null,nvl(ep19,0)/2,0) "
                        
                     End If
                     If IsRoung = True Then
                        StrSQLa = StrSQLa & " Union All select cp01,cp02,cp09,0 as oCount,0 as oPoint,0 as oCount2,0 as oPoint2,0 as oCount3,decode(ep20,null,nvl(ep16,0)/2,0) as oCount4,0 as oCount5,0 as oPoint3 from engineerprogress,caseprogress where ep13='" & grd(GrdIndex) & "' and ep15>=" & Trim(str(Val(CalYM) + 191100)) & "01 and ep15<=" & Trim(str(Val(CalYM) + 191100)) & "31 and ep02=cp09(+) and cp107='Y' "
                     Else
                        'Modified by Morgan 2014/3/20 --2014/4/1起支援改每小時折計0.2基數
                        'StrSQLa = StrSQLa & " Union All select sh06,sh07,sh12,Round(Round(Nvl(SH05, 0)/4 ,2) ,2) as oCount,0 as oPoint,Round(Nvl(SH05, 0)/4 ,2) as oCount2,0 as oPoint2,0 as oCount3,0 as oCount4,0 as oCount5 from supporthour where sh02='" & grd(GrdIndex) & "' and sh01>=" & Trim(str(Val(CalYM) + 191100)) & "01 and sh01<=" & Trim(str(Val(CalYM) + 191100)) & "31 and sh11='V' "
                        StrSQLa = StrSQLa & " Union All select sh06,sh07,sh12,Round(" & Sh2EPtCode & ",2) as oCount,0 as oPoint,Round(" & Sh2EPtCode & ",2) as oCount2,0 as oPoint2,0 as oCount3,0 as oCount4,0 as oCount5,0 as oPoint3 from supporthour where sh02='" & grd(GrdIndex) & "' and sh01>=" & Trim(str(Val(CalYM) + 191100)) & "01 and sh01<=" & Trim(str(Val(CalYM) + 191100)) & "31 and sh11='V' "
                        'end 2014/3/20
                        
                        If Val(Trim(str(Val(CalYM) + 191100)) & "01") < Val(PUB_108RuleDate) Then 'Added by Morgan 2019/3/18 108考核(取消收文點數轉換,另原修改紀錄及衍生工作紀錄103年就取消,一併排除)
                        
                           'Added by Morgan 2012/4/19 補收文點數
                           'Modified by Morgan 2014/3/20 --2014/4/1起非智權收文改每點折算0.04基數
                           'StrSQLa = StrSQLa & " Union All select cp01,cp02,cp09,Round(nvl(a0n03/1000,cp18)*0.05 ,2) as oCount,0 as oPoint,Round(nvl(a0n03/1000,cp18)*0.05 ,2) as oCount2,0 as oPoint2,0 as oCount3,0 as oCount4,0 as oCount5 from caseprogress,acc0n0 where a0n02(+)=cp09 and cp13='" & grd(GrdIndex) & "' and cp05>=" & Trim(str(Val(CalYM) + 191100)) & "01 and cp05<=" & Trim(str(Val(CalYM) + 191100)) & "31 And nvl(a0n03/1000,cp18)>0 and cp20 is null and cp57 is null and substr(cp12,1,1)<>'S' "
                           'Modified by Lydia 2016/09/14 cp57 is null=>CP159=0
                           StrSQLa = StrSQLa & " Union All select cp01,cp02,cp09,Round(" & Pt2EPtCode & ",2) as oCount,0 as oPoint,Round(" & Pt2EPtCode & ",2) as oCount2,0 as oPoint2,0 as oCount3,0 as oCount4,0 as oCount5,0 as oPoint3 from caseprogress,acc0n0 where a0n02(+)=cp09 and cp13='" & grd(GrdIndex) & "' and cp05>=" & Trim(str(Val(CalYM) + 191100)) & "01 and cp05<=" & Trim(str(Val(CalYM) + 191100)) & "31 And nvl(a0n03/1000,cp18)>0 and cp20 is null and CP159=0 and substr(cp12,1,1)<>'S' "
                           'end 2014/3/20
                           'end 2012/4/19
                        
                           'Add by Morgan 2011/8/1 + 修改紀錄,衍生工作紀錄
                           StrSQLa = StrSQLa & " Union All select mh06,mh07,mh12,Round(Nvl(MH05,0)*0.2 ,2) as oCount,0 as oPoint,Round(Nvl(MH05,0)*0.2 ,2) as oCount2,0 as oPoint2,0 as oCount3,0 as oCount4,0 as oCount5,0 as oPoint3 from ModifyHour where mh02='" & grd(GrdIndex) & "' and mh01>=" & Trim(str(Val(CalYM) + 191100)) & "01 and mh01<=" & Trim(str(Val(CalYM) + 191100)) & "31 and mh11='V' "
                           StrSQLa = StrSQLa & " Union All select eh06,eh07,eh12,Round(Nvl(EH05,0)*0.25 ,2) as oCount,0 as oPoint,Round(Nvl(EH05,0)*0.25 ,2) as oCount2,0 as oPoint2,0 as oCount3,0 as oCount4,0 as oCount5,0 as oPoint3 from ExtendHour where eh02='" & grd(GrdIndex) & "' and eh01>=" & Trim(str(Val(CalYM) + 191100)) & "01 and eh01<=" & Trim(str(Val(CalYM) + 191100)) & "31 and eh11='V' "
                           'end 2011/8/1
                           
                        End If 'Added by Morgan 2019/3/18
                        
                        'Modify by Morgan 2011/5/30 若有建點數分配資料時點數改分配點數(目前有225提供書狀意見及226配合開庭)
                        'strSQLA = strSQLA & " Union All select cp01,cp02,cp09,0 as oCount,0 as oPoint,decode(ep29,null,round(cp103 * cp104,2),0) as oCount2,sum(nvl(cp18,0)-nvl(a1u07/1000,0)) as oPoint2,0 as oCount3,decode(ep29,null,nvl(ep19,0)/2,0) as oCount4,0 as oCount5 from engineerprogress,caseprogress,(select a1u03,sum(nvl(a1u07,0)) as a1u07 from acc1u0 where a1u03 in (select cp09 from caseprogress where cp29='" & grd(GrdIndex) & "' and cp27>=" & Trim(str(Val(CalYM) + 191100)) & "01 and cp27<=" & Trim(str(Val(CalYM) + 191100)) & "31) group by a1u03) ABCDE where ep13='" & grd(GrdIndex) & "' and ep18>=" & Trim(str(Val(CalYM) + 191100)) & "01 and ep18<=" & Trim(str(Val(CalYM) + 191100)) & "31 and ep02=cp09(+) and (ep29 is null or ep20||ep29||cp10='NN910')  and ep02=a1u03(+) and cp107='Y'  group by cp01,cp02,cp09,decode(ep29,null,round(cp103 * cp104,2),0),decode(ep29,null,nvl(ep19,0)/2,0) "
                        StrSQLa = StrSQLa & " Union All select cp01,cp02,cp09,0 as oCount,0 as oPoint,decode(ep29,null,round(cp103 * cp104,2),0) as oCount2,sum(nvl(a0n03/1000,nvl(cp18,0)-nvl(a1u07/1000,0))) as oPoint2,0 as oCount3,decode(ep29,null,nvl(ep19,0)/2,0) as oCount4,0 as oCount5,0 as oPoint3 from engineerprogress,caseprogress,(select a1u03,sum(nvl(a1u07,0)) as a1u07 from acc1u0 where a1u03 in (select cp09 from caseprogress where cp29='" & grd(GrdIndex) & "' and cp27>=" & Trim(str(Val(CalYM) + 191100)) & "01 and cp27<=" & Trim(str(Val(CalYM) + 191100)) & "31) group by a1u03) ABCDE,acc0n0 where a0n02(+)=cp09 and ep13='" & grd(GrdIndex) & "' and ep18>=" & Trim(str(Val(CalYM) + 191100)) & "01 and ep18<=" & Trim(str(Val(CalYM) + 191100)) & "31 and ep02=cp09(+) and (ep29 is null or ep20||ep29||cp10='NN910')  and ep02=a1u03(+) and cp107='Y'  group by cp01,cp02,cp09,decode(ep29,null,round(cp103 * cp104,2),0),decode(ep29,null,nvl(ep19,0)/2,0) "
                     End If
                     StrSQLa = StrSQLa & " ) AA "
                     CheckOC
                     adoRecordset.CursorLocation = adUseClient
                     adoRecordset.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
                     'Modified by Morgan 2019/3/21 +ma55發文實績點數
                     If adoRecordset.RecordCount <> 0 Then
                           strSql = strSql & " 0" & CheckStr(adoRecordset.Fields(0).Value) & ", "
                           strSql = strSql & " 0" & CheckStr(adoRecordset.Fields(1).Value) & ", "
                           strSql = strSql & " 0" & CheckStr(adoRecordset.Fields(2).Value) & ", "
                           strSql = strSql & " 0" & CheckStr(adoRecordset.Fields(3).Value) & "," & GetDelay(grd(GrdIndex), IsRoung) & ", "
                           strSql = strSql & " 0" & CheckStr(adoRecordset.Fields(5).Value) & ", "
                           strSql = strSql & " 0" & CheckStr(adoRecordset.Fields(6).Value) & ", "
                           strSql = strSql & " 0" & CheckStr(adoRecordset.Fields(7).Value) & "  "
                     Else
                           strSql = strSql & " 0,0,0,0," & GetDelay(grd(GrdIndex), IsRoung) & ",0,0,0 "
                     End If
                     strSql = strSql & "," & Val(grd(GrdIndex).TextMatrix(35, GrdCol))
                  End If
                 strSql = strSql & " ) "
            End If
            cnnConnection.Execute strSql
            strSql = "'"
         End If
    Next GrdCol
   '本月達成率
   cnnConnection.Execute "update monthassess set ma38=decode(ma04,0,0,round((ma37/ma04) ,2)),ma44=decode(ma04,0,0,round((ma43/ma04),2)) where ma02=" & Trim(str(Val(CalYM) + 191100)) & " "
    For GrdCol = 2 To grd(GrdIndex).Cols - 1
         grd(GrdIndex).col = GrdCol
         grd(GrdIndex).row = 0
         'Modify by Morgan 2010/10/29 改只要抓P,CFP的目標(杜燕文有T的目標)
         'Modified by Morgan 2019/3/21 點數目標抓錯欄位
         'StrSQLa = "select st02,sum(Nvl(decode(pe02,'CFP',pe05 * 2,pe05),0)+Nvl(decode(pe02,'CFP',pe07 * 2 ,PE07),0)) as T1,sum(Nvl(PE11,0)) as T2,sum(Nvl(PE10,0)) as T3  from staff,Performance where st01='" & grd(GrdIndex).text & "' and " & Trim(str(Val(CalYM) + 191100)) & "=pe03(+) and st01=pe01(+) AND (PE02 IS NULL OR PE02 IN ('P','CFP')) group by st02 "
         StrSQLa = "select st02,sum(nvl(pe06,0) + nvl(pe08,0)) as T1,sum(Nvl(PE11,0)) as T2,sum(Nvl(PE10,0)) as T3  from staff,Performance where st01='" & grd(GrdIndex).Text & "' and " & Trim(str(Val(CalYM) + 191100)) & "=pe03(+) and st01=pe01(+) AND (PE02 IS NULL OR PE02 IN ('P','CFP')) group by st02 "
         CheckOC
         adoRecordset.CursorLocation = adUseClient
         adoRecordset.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
         If adoRecordset.RecordCount <> 0 Then
               'Modified by Morgan 2019/3/21 +ma56發文實績點數達成率,修正原語法少了ma01所以過去都沒有資料(最後一筆是99999不繪圖沒有目標)
               cnnConnection.Execute "update monthassess set ma41=decode(" & Val(CheckStr(adoRecordset.Fields("T1").Value)) & ",0,0,round((ma40/" & Val(CheckStr(adoRecordset.Fields("T1").Value)) & ")*100,2)),ma56=decode(" & Val(CheckStr(adoRecordset.Fields("T1").Value)) & ",0,0,round((ma55/" & Val(CheckStr(adoRecordset.Fields("T1").Value)) & ")*100,2))  where ma01='" & grd(GrdIndex).Text & "' and ma02=" & Trim(str(Val(CalYM) + 191100)) & " and ma03='1' "
               cnnConnection.Execute "update monthassess set ma41=decode(" & Val(CheckStr(adoRecordset.Fields("T2").Value)) & ",0,0,round((ma40/" & Val(CheckStr(adoRecordset.Fields("T2").Value)) & ")*100,2)),ma48=decode(" & Val(CheckStr(adoRecordset.Fields("T3").Value)) & ",0,0,round((ma47/" & Val(CheckStr(adoRecordset.Fields("T3").Value)) & ")*100,2)),ma56=decode(" & Val(CheckStr(adoRecordset.Fields("T2").Value)) & ",0,0,round((ma55/" & Val(CheckStr(adoRecordset.Fields("T2").Value)) & ")*100,2))  where ma01='" & grd(GrdIndex).Text & "' and ma02=" & Trim(str(Val(CalYM) + 191100)) & " and ma03='2' "
              grd(GrdIndex).Text = CheckStr(adoRecordset.Fields(0).Value)
         End If
   Next GrdCol
Next GrdIndex
'更新繪圖之修改及複雜時數
cnnConnection.Execute "update monthassess set ma53=(select sum(nvl(ep21,0)+nvl(ep22,0)+nvl(ep23,0)+nvl(ep24,0)+nvl(ep25,0)) from caseprogress,engineerprogress where cp09=ep02(+) and ep13=ma01 and cp27>=" & Trim(str(Val(CalYM) + 191100)) & "01 and cp27<=" & Trim(str(Val(CalYM) + 191100)) & "31 and cp01 in ('P','CFP','FCP') ) where ma03='2' and ma36='1' and ma02=" & Trim(str(Val(CalYM) + 191100)) & " "

'算得分
SetPoint '程序太大改寫函數

CheckOC
'發 mail
tmpnext = "準備發 mail..."
Dim ArrMail As Variant
Dim MailCount As Integer
Dim strOfficeKind As String
  If Mailing = False Then
  Else
    WLog "發生錯誤！"
  End If

Exit Sub

ErrHD:

   WLog "每天算速度考核發生錯誤！" & Err.Description
'發 mail
tmpnext = "準備發 mail..."
  If Mailing = False Then
  Else
    WLog "發生錯誤！"
  End If

End Sub

Private Sub eventConn_ExecuteComplete(ByVal RecordsAffected As Long, ByVal pError As ADODB.Error, adStatus As ADODB.EventStatusEnum, ByVal pCommand As ADODB.Command, ByVal pRecordset As ADODB.Recordset, ByVal pConnection As ADODB.Connection)
   WCmdLog pCommand.CommandText
End Sub

Function WCmdLog(oStrLog As String)
On Error GoTo ErrHnd

Dim ffa As Integer
ffa = FreeFile
Open App.path & "\cmdlog.log" For Append As ffa
Print #ffa, Trim(Now) & "  ==>  " & oStrLog
Close ffa

ErrHnd:
End Function

Private Sub KillCmdLog()
On Error GoTo ErrHnd
   Kill App.path & "\cmdlog.log"
ErrHnd:
End Sub

'Added by Morgan 2018/5/28
Private Sub ChkFolder()
   Dim strPath As String
On Error GoTo ErrHnd

   strPath = App.path & TextPath
   If Dir(strPath, vbDirectory) = "" Then
      MkDir strPath
   End If
ErrHnd:
End Sub

Private Sub Form_Initialize()
Dim oik As Integer
Dim oCalYM As String
Dim sChoice As String
Dim comString As String 'Added by Morgan 2020/9/29

comString = Command '讀取啟動參數

strUserNum = "QPGMR" 'Add By Sindy 2016/12/15
bolMailFailNoAlert = True 'Added by Morgan 2014/1/23 寄信都不要彈錯誤訊息
pub_HostName = PUB_ReadHostName 'Add by Morgan 2009/8/21
g_strWriteSysLogFilePath = App.path & "\autobatchdaylog.log" '欲記錄Log的完整路徑及檔名 Add By Sindy 2018/5/28

'每天算速度考核
'edit by nickc  算當月及前一月 2 個月
Set cnnConnection = New ADODB.Connection

'Modified by Morgan 2018/7/24 執行VB時改可選擇連線
'cnnConnection.ConnectionString = CnStr
'Modified by Morgan 2022/3/23 修正執行檔Provider未換新版問題
If InStr(UCase(Pub_GetModuleFileName), "VB6.EXE") > 0 Then
   sChoice = Trim(InputBox("1.【 正式 】資料庫" & vbCrLf & vbCrLf & "2.【 測試 】資料庫", "請選擇連線", "2"))
   If sChoice = "" Then End
End If

cnnConnection.ConnectionTimeout = 60
cnnConnection.Provider = IIf(strProvider <> "", strProvider, cProvider)
If sChoice = "" Then
   cnnConnection.Properties("Data Source").Value = "m51con"
Else
   cnnConnection.Properties("Data Source").Value = IIf(sChoice = "1", "Live", "Test")
End If
cnnConnection.Properties("User ID").Value = UserName
cnnConnection.Properties("Password").Value = Password
'end 2022/3/23

cnnConnection.Open

Set eventConn = cnnConnection 'Added by Morgan 2012/3/12
KillCmdLog 'Added by Morgan 2012/3/12

Debug.Print PUB_GetDbTerminal

strSrvDate(1) = ServerDate
strSrvDate(2) = strSrvDate(1) - 19110000

PUB_SetSystemVar 'Add By Sindy 2017/9/6 設定系統變數
PUB_SetUserData 'Added by Morgan 2017/11/22 設定使用者資料庫參數
PUB_SyncClientDateTime 'Added by Morgan 2023/7/17

'Add by Lydia 2015/05/25 判斷系統當是否為工作天
If ChkWorkDay(strSrvDate(1)) = True Then
   bolWorkDay = True
End If

If strSrvDate(1) >= "20101026" Then
   bolNewPromoterRule = True
End If

pub_OS = GetVersion32 'Add By Sindy 2014/4/24
Call PUB_GetTMdebate 'Add By Sindy 2013/5/15

''add by nickc 2007/10/31 只有 2007/11/01 才作
'If strSrvDate(1) = "20071101" Then
'    StrMenu10
'End If

ChkFolder 'Added by Morgan 2018/5/28 檢查輸出資料夾是否存在

If UCase(comString) <> "" Then
   'Add By Amy 2024/01/18 + flg38
   If comString = "38" Then
      GoTo flg38
   ElseIf comString = "46" Then
      GoTo flg46
   'Add By Sindy 2020/11/10 + flg100
   ElseIf comString = "100" Then
      GoTo flg100
   'Add By Sindy 2024/10/3 + flg100
   ElseIf comString = "27" Then
      GoTo flg27
   End If
End If

'add by nickc 2005/11/03 執行execute 動作
WLog "開始    執行更新"
StrMenuExc
WLog "完畢    執行更新"


'20140213START ADD By eric
WLog "開始    主張優先權之 P 案與 CFP 案超過 5 個工作天未提供優先權資料，發mail提醒 P 案程序人員與 CFP 案承辦人員"
StrMenu48
WLog "完畢    主張優先權之 P 案與 CFP 案超過 5 個工作天未提供優先權資料，發mail提醒 P 案程序人員與 CFP 案承辦人員"
'20140213END
   
If bolWorkDay = True Then 'Added by Morgan 2021/2/1 工作天執行就可，否則Mail會重複發
   'add by nickc 2006/08/18 先做，再算分數
   WLog "開始   會稿完成日未輸卻已發文上會完日=發文日並紀錄且通知工程師已上會完日、會稿完成日前面相關日期未輸入完整發 mail 給工程師"
   StrMenu8
   WLog "完畢   會稿完成日未輸卻已發文上會完日=發文日並紀錄且通知工程師已上會完日、會稿完成日前面相關日期未輸入完整發 mail 給工程師"
End If

'Set cnnConnection = New ADODB.Connection
'cnnConnection.ConnectionString = CnStr
'cnnConnection.Open
'
'Debug.Print PUB_GetDbTerminal

'Removed by Morgan 2021/11/9 108考核已取消會稿加乘
''Add by Morgan 2010/9/27
'If bolNewPromoterRule Then
'
'   'Modified by Morgan 2012/8/1
'   'WLog "開始   計算承辦期限"
'   'StrMenu19
'   'WLog "完畢   計算承辦期限"
'   'Removed by Morgan 2020/9/18 取消,改回即時通知--郭雅娟
'   'WLog "開始   齊備日異動通知"
'   'StrMenu33
'   'WLog "完畢   齊備日異動通知"
'   'end 2020/9/18
'   'end 2012/8/1
'
'   WLog "開始   計算會稿加乘"
'   StrMenu20
'   WLog "完畢   計算會稿加乘"
'End If
''end 2010/9/27
'end 2021/11/9

strSql = "select  max(wd01) from workday where wd01<=" & strSrvDate(1) & " "
CheckOC
adoRecordset.CursorLocation = adUseClient
adoRecordset.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
oCalYM = Trim(str(Val(Mid(CheckStr(adoRecordset.Fields(0).Value), 1, 6)) - 191100))
CheckOC
For oik = 0 To 1
   CalYM = Mid(Format(DateAdd("m", (oik * -1), Format(Trim(oCalYM + 191100) & "01", "@@@@/@@/@@")), "YYYYMMDD"), 1, 6) - 191100
   
'Removed by Morgan 2012/7/18
'   If Not bolNewPromoterRule Then  'Add by Morgan 2010/9/27
'      'add by nickc 2006/02/10 要比速度考核先做
'      WLog "開始   計算會稿加乘註記" & CalYM
'      Debug.Print Timer
'      StrMenu6
'      Debug.Print Timer
'      WLog "完畢   計算會稿加乘註記" & CalYM
'   End If
   
   WLog "開始    計算速度考核" & CalYM
   Debug.Print Timer
   StrMenu
   Debug.Print Timer
   WLog "完畢   計算速度考核" & CalYM
Next oik

EveryDayBatch 'Added by Morgan 2012/1/16 每天都要執行的批次集中以便補跑

'add by nickc 2005/09/09 商標該結未結或不該結而結
'2008/10/13 add by sonia 加入工作天才做條件
'If ChkWorkDay(strSrvDate(1)) = True Then
If bolWorkDay = True Then 'Add by Lydia 2015/05/25
'Mark by Amy 2018/08/30 T延展改至待處理區處理,10507外商已於按結案通知時直接閉卷
'   WLog "開始   該結未結"
'   StrMenu2
'   WLog "完畢   該結未結"
   'end 2018/08/30
   WLog "開始   不該結而結"
   StrMenu3
   WLog "完畢   不該結而結"
   
   'Added by Morgan 2013/5/15
   WLog "開始   電子送件待確認更新"
   StrMenu39
   WLog "完畢   電子送件待確認更新"
   

   'Added by Morgan 2013/5/21
'Removed by Morgan 2020/2/21 取消(分所沒送件了,且彥葶也會幫北所發文)--辜
'   WLog "開始   分所智財局送件提醒-->分所出納"
'   StrMenu40
'   WLog "完畢   分所智財局送件提醒-->分所出納"
'
'   WLog "開始   分所智財局送件提醒-->北所財務"
'   StrMenu41
'   WLog "完畢   分所智財局送件提醒-->北所財務"
'end 2020/2/21
   'end 2013/5/21
End If

If bolWorkDay = True Then 'Added by Morgan 2021/2/1 工作天執行就可，否則Mail會重複發
   'add by nickc 2006/02/10
   WLog "開始   逾承辦期限有完稿無會稿"
   StrMenu5
   WLog "完畢   逾承辦期限有完稿無會稿"
   'Add by Morgan 2006/3/27
   WLog "開始   告建議性處分未齊備且准駁通知已逾5個月"
   StrMenu7
   WLog "完畢   告建議性處分未齊備且准駁通知已逾5個月"
End If

'2007/9/13 add by sonia
'2008/10/13 add by sonia 加入工作天才做條件
'If ChkWorkDay(strSrvDate(1)) = True Then
If bolWorkDay = True Then 'Add by Lydia 2015/05/25
   WLog "開始   智慧局註冊費通知函超過5工作天未列印"
   StrMenu9
   WLog "完畢   智慧局註冊費通知函超過5工作天未列印"
End If
'2007/9/13 END
'add by nickc 2008/04/24 加入智權人員未收款管制
'Modify by Morgan 2008/6/11 加判斷工作天才做
'If ChkWorkDay(strSrvDate(1)) = True Then 'Modify By Sindy 2013/9/2 工作天控管在發mail的if裡頭
'Remove by Lydia 2018/08/22 (應收帳款管控)取消預定收款日,改成付款週期
'   WLog "開始   智權人員未收款管制超過 5 工作天未收"
'   StrMenu10
'   WLog "完畢   智權人員未收款管制超過 5 工作天未收"
'end 2018/08/22
'End If
'end 2008/5/27
'2008/8/5 add by sonia 加入分所智權人員未收款管制給分所財務
'If ChkWorkDay(strSrvDate(1)) = True Then
'Remove by Lydia 2018/08/22 (應收帳款管控)取消預定收款日,改成付款週期
'If bolWorkDay = True Then 'Add by Lydia 2015/05/25
'   WLog "開始   分所智權人員未收款管制超過 5 工作天未收"
'   StrMenu11
'   WLog "完畢   分所智權人員未收款管制超過 5 工作天未收"
'End If
'end 2018/08/22
'2008/8/5 END

'2008922 add by toni 加入延展案於期滿六個月的前一個工作天發mail提醒承辦人
'If ChkWorkDay(strSrvDate(1)) = True Then
If bolWorkDay = True Then 'Add by Lydia 2015/05/25
   WLog "開始   延展案於期滿六個月的前一個工作天發mail提醒承辦人"
   StrMenu12
   WLog "完畢   延展案於期滿六個月的前一個工作天發mail提醒承辦人"
End If
'20080922 END

'Add by Morgan 2009/6/18
'批次更新薪資異動資料
WLog "開始   批次更新薪資異動資料"
Call StrMenu14
WLog "完畢   批次更新薪資異動資料"

'Add by Morgan 2009/6/18
'批次閉卷被主張國內優先權滿15個月案件
WLog "開始   批次閉卷被主張國內優先權滿15個月案件"
Call StrMenu16
WLog "完畢   批次閉卷被主張國內優先權滿15個月案件"

'Revmoed by Morgan 2014/2/25 改在 trigger=> ACC0K0_BEFORE
''Add by Sindy 2010/4/28
''批次更新暫不列印收據註記(Y=>NULL)
'WLog "開始   批次更新暫不列印收據註記(Y=>NULL)"
'Call StrMenu17
'WLog "完畢   批次更新暫不列印收據註記(Y=>NULL)"

'Add By Sindy 2009/08/18 延展案於期滿六個月前一個工作天發mail提醒承辦人
'Modify By Sindy 2010/8/2 每月改每日Run
'If ChkWorkDay(Format(Now, "YYYYMMDD")) = True Then
'Modify By Sindy 2015/7/14 改為每月的1日及16日才發
If Right(strSrvDate(1), 2) = "01" Or Right(strSrvDate(1), 2) = "16" Then
'2015/7/14 END
   WLog "開始   FCT延展案於期滿六個月的前一個工作天發mail提醒承辦人(Sindy)"
   Call StrMenu18
   WLog "完畢   FCT延展案於期滿六個月的前一個工作天發mail提醒承辦人"
End If
'2009/08/18 END

'Add by Morgan 2011/5/19
WLog "開始   會議室預約提醒"
   Call StrMenu22
WLog "完畢   會議室預約提醒"

If bolWorkDay = True Then 'Added by Morgan 2021/2/1 工作天執行就可，否則Mail會重複發
   'Added by Morgan 2014/5/8
   If Val(strSrvDate(1)) >= 20140515 Then
      WLog "開始   智權文件寄送待確認案件數通知"
      StrMenu50
      WLog "完畢   智權文件寄送待確認案件數通知"
   End If
   'end 2014/5/8
End If

''Add by Sindy 2010/10/25
''臨時版本, 更新salescontroldate資料
'WLog "開始   臨時版本, 更新salescontroldate資料"
'Call StrMenu21
'WLog "完畢   臨時版本, 更新salescontroldate資料"

'Add By Sindy 2011/10/7
'strUserNum = "administrator" 'Modify By Sindy 2016/12/15 往前提
WLog "開始   檢查每月出缺勤統計是否有未確認的資料(Sindy)"
StrMenu24
WLog "完畢   檢查每月出缺勤統計是否有未確認的資料"

WLog "開始   檢查員工個人資料明細是否有未確認的資料(Sindy)"
StrMenu25
WLog "完畢   檢查員工個人資料明細是否有未確認的資料"

WLog "開始   檢查職務代理人已離職通知(Sindy)"
StrMenu26
WLog "完畢   檢查職務代理人已離職通知"

'Modify By Sindy 2023/3/24 + 檢查接洽單簽核主管尚有待簽核資料，再次發通知信
flg27: 'Add By Sindy 2024/10/3
'Add by Sindy 2025/9/30
If bolWorkDay = True Then
'2025/9/30 END
   WLog "開始   檢查尚未簽核完畢的表單下一處理人員是否離職或休假(Sindy)"
   StrMenu27
   WLog "完畢   檢查尚未簽核完畢的表單下一處理人員是否離職或休假"
End If

'Add By Sindy 2011/10/24
WLog "開始   更新9001通知開庭者且法定期限<系統日的發文日(Sindy)"
StrMenu28
WLog "完畢   更新9001通知開庭者且法定期限<系統日的發文日"

'Add By Sindy 加入工作天才做條件
'If ChkWorkDay(strSrvDate(1)) = True Then
If bolWorkDay = True Then 'Add by Lydia 2015/05/25
   'Add By Sindy 2012/4/3
   WLog "開始   非台灣專利案工程師分案通知(Sindy)"
   StrMenu30
   WLog "完畢   非台灣專利案工程師分案通知"
   
   'Added by Morgan 2012/9/17
   WLog "開始   FCP年費暫不繳納期限通知"
   StrMenu34
   WLog "完畢   FCP年費暫不繳納期限通知"
End If

'Add By Sindy 2012/5/15
'Modified by Lydia 2019/04/10 台灣商標爭議案=> 台灣商標案
'Modified by Lydia 2022/07/15 台灣商標案=>台灣商標著作權案
WLog "開始   台灣商標著作權案未發文未取消收文且未上齊備日案件，通知收文智權人員(Sindy)"
StrMenu31
WLog "完畢   台灣商標著作權案未發文未取消收文且未上齊備日案件，通知收文智權人員"
'end 2019/04/10

'Add By Sindy 2012/5/15
'Modified by Lydia 2019/04/10 台灣商標爭議案=> 台灣商標案
'Modified by Lydia 2022/07/15 台灣商標案=>台灣商標著作權案
WLog "開始   台灣商標著作權案未發文未取消收文且逾承辦期限且要會稿但未輸入會稿日案件，通知內商主管(Sindy)"
StrMenu32
WLog "完畢   台灣商標著作權案未發文未取消收文且逾承辦期限且要會稿但未輸入會稿日案件，通知內商主管"
'end 2019/04/10

'Add By Sindy 2012/10/1
WLog "開始   客戶平台下次更新日期將至其前7日開始,E-Mail通知系統設定之管理人員(Sindy)"
StrMenu35
WLog "完畢   客戶平台下次更新日期將至其前7日開始,E-Mail通知系統設定之管理人員"
WLog "開始   客戶平台擁有者已離職時,E-Mail通知系統設定之管理人員"
StrMenu36
WLog "完畢   客戶平台擁有者已離職時,E-Mail通知系統設定之管理人員"
'2012/10/1 End

'Add By Sindy 2012/11/13
WLog "開始   [暫不列印收據]當程序於送件日三個月後自動列印收據(Sindy)"
Call StrMenu37
WLog "完畢   [暫不列印收據]當程序於送件日三個月後自動列印收據"
'2012/11/13 End

'Add By Sindy 2013/7/31 每星期一通知刷卡異常未確認資料
If Weekday(Format(strSrvDate(1), "####-##-##")) = 2 Then
   WLog "開始   通知刷卡異常未確認資料(Sindy)"
   Call StrMenu44
   WLog "完畢   通知刷卡異常未確認資料"
End If
'2013/7/31 End

'Set cnnConnection = New ADODB.Connection
'cnnConnection.ConnectionString = CnStr
'cnnConnection.Open
'
'Debug.Print PUB_GetDbTerminal

'Add By Amy 2013/04/30 請作單內容存檔
flg38:
 WLog "開始    請作單附件新增(Amy)"
  StrMenu38
 WLog "完畢    請作單附件新增"
 '2013/04/30 End

'Add By Amy 2013/07/09 發文時未於系統貼指定代表圖,一直發Mail給繪圖及工程師直到補齊
'If ChkWorkDay(strSrvDate(1)) = True Then
 If bolWorkDay = True Then 'Add by Lydia 2015/05/25
    WLog "開始    發文時未貼指定代表圖發Mail (Amy)"
    StrMenu43
    WLog "完畢    發文時未貼指定代表圖發Mail"
 End If
 '2013/07/09 End


'Add by Amy 2013/08/23 電子送件未稽核 mail 給發文人員的二級主管
'Modify by Amy 2013/08/30 +工作天才跑
'If ChkWorkDay(strSrvDate(1)) = True Then
If bolWorkDay = True Then 'Add by Lydia 2015/05/25
    WLog "開始   電子送件未稽核 mail 給發文人員的二級主管 (Amy)"
    StrMenu45
    WLog "完畢   電子送件未稽核 mail 給發文人員的二級主管"
End If
'end 2013/08/23

'Add By Sindy 2014/3/25
WLog "開始    FC案件收文應收帳款提醒(Sindy)"
   StrMenu49
WLog "完畢    FC案件收文應收帳款提醒"
'2014/3/25 End

'Add by Amy 2013/12/11
WLog "開始    PCT申請案進入國家階段期限到期時自動上可結餘日 (Amy)"
StrMenu47
WLog "完畢    PCT申請案進入國家階段期限到期時自動上可結餘日"
'end 2013/12/11

'Add by Amy 2014/04/25 刪除TempTB 避免資料太分散,造成抓資料慢
WLog "開始    執行刪除TempTB (Amy)"
StrMenuDelTempTB
WLog "完畢    執行刪除TempTB"
'end 2014/04/25

'Mark by Amy 2015/08/26 辜決定取消不做
''Add by Amy 2014/05/13 客戶匯款4天未繳款通知書
'If strSrvDate(1) >= "20160101" Then
' 'If ChkWorkDay(strSrvDate(1)) = True Then
' If bolWorkDay = True Then 'Add by Lydia 2015/05/25
'    WLog "開始    客戶匯款4天未繳款通知書"
'    StrMenu51
'    WLog "完畢    客戶匯款4天未繳款通知書"
' End If
'End If
''end 2014/05/13

'Add By Sindy 2014/6/23 將自行管制且未完成的資料, 到期時以清單方式發E-mail通知管制人
'If ChkWorkDay(strSrvDate(1)) = True Then
If bolWorkDay = True Then 'Add by Lydia 2015/05/25
    WLog "開始    未發文案件自行管制期限到期通知(Sindy)"
    StrMenu52
    WLog "完畢    未發文案件自行管制期限到期通知"
End If
'2014/6/23 END

'Add by Amy 2015/01/22 北所分案日檢查
'If ChkWorkDay(strSrvDate(1)) = True Then
If bolWorkDay = True Then 'Add by Lydia 2015/05/25
    WLog "開始    北所分案日檢查 (Amy)"
    StrMenu55
    WLog "完畢    北所分案日檢查"
End If
'end 2015/01/22

'Add by Lydia 2015/02/11 CF結匯金額異常通知
'If ChkWorkDay(strSrvDate(1)) = True Then
If bolWorkDay = True Then 'Add by Lydia 2015/05/25
    WLog "開始    CF結匯金額異常通知"
    StrMenu56
    WLog "完畢    CF結匯金額異常通知"
End If
'end 2015/02/11

'Add by Sindy 2015/2/25 大陸商標代理收達後管制提申(每星期一通知)
'Modify By Sindy 2016/9/5 原為每週一通知, 改為每週一及週四通知
If Weekday(Format(strSrvDate(1), "####-##-##")) = 2 Or _
   Weekday(Format(strSrvDate(1), "####-##-##")) = 5 Then
    WLog "開始   大陸商標代理收達後管制提申(Sindy)"
    StrMenu57
    WLog "完畢   大陸商標代理收達後管制提申"
End If
'2015/2/25 END

'Add By Sindy 2015/3/31 每週五固定要的資料-新舊客戶案件統計資料
If Weekday(Format(strSrvDate(1), "####-##-##")) = 6 Then
   WLog "開始   新舊客戶案件統計資料(Sindy)"
   Call StrMenu58
   WLog "完畢   新舊客戶案件統計資料"
End If
'2015/3/31 End

'Added by Lydia 2015/04/28
'If ChkWorkDay(strSrvDate(1)) = True Then
If bolWorkDay = True Then 'Add by Lydia 2015/05/25
    WLog "開始    寰華案信函管理異常通知"
    StrMenu60
    WLog "完畢    寰華案信函管理異常通知"
End If
'end 2015/04/28

'Add By Sindy 2015/5/11 外商程序組之系統自動提醒期限
'If ChkWorkDay(strSrvDate(1)) = True Then
If bolWorkDay = True Then 'Add by Lydia 2015/05/25
   WLog "開始   外商程序組之系統自動提醒期限(Sindy)"
   Call StrMenu61
   WLog "完畢   外商程序組之系統自動提醒期限"
End If
'2015/5/11 End

'Added by Lydia 2015/05/25
If bolWorkDay = True Then
    'Added by Lydia 2024/11/12
    If strSrvDate(1) >= 查名單網中系統啟用日 Then
       WLog "開始    查名單(網中)-查名單量統計和排序(Lydia)"
       StrMenu62_New
       WLog "完畢    查名單(網中)-查名單量統計和排序"
    Else
    'end 2024/11/12
       WLog "開始    商標查名單量統計和排序(Lydia)"
       StrMenu62
       WLog "完畢    商標查名單量統計和排序"
    End If
End If
'end 2015/05/25

'Add By Sindy 2015/8/3
If bolWorkDay = True Then
    WLog "開始    FCT審查報告已逾承辦期限(Sindy)"
    StrMenu65
    WLog "完畢    FCT審查報告已逾承辦期限"
End If
'2015/8/3 END

'Add by Amy 2015/08/10 FCT,T,TB,TC,TD,TF,TM,TR,TS,TT每月1日及16日自動發催審表給承辦人
If Right(strSrvDate(1), 2) = "01" Or Right(strSrvDate(1), 2) = "16" Then
    WLog "開始  每月自動發催審表給承辦人 (Amy)"
    StrMenu66
    WLog "完畢  每月自動發催審表給承辦人"
End If
 'end 2015/08/10
 
'Add by Amy 2015/09/15 +收文逾三個月未發文商標案件-專業部通知
'每月第1個工作天執行
If strSrvDate(1) = GetMonthStdDay(Left(strSrvDate(1), 6)) Then
    WLog "開始    收文逾三個月未發文商標案件-每月第1個工作天專業部通知(Amy)"
        StrMenu67
    WLog "完畢    收文逾三個月未發文商標案件-每月第1個工作天專業部通知"
End If
'每月第3個工作天執行
If strSrvDate(2) = PUB_GetWorkDayAfterSysDate(CDbl(GetMonthStdDay(Left(strSrvDate(1), 6))), 2) Then
    WLog "開始    收文逾三個月未發文商標案件-智權部通知(Amy)"
        StrMenu68
    WLog "完畢    收文逾三個月未發文商標案件-智權部通知"
End If
'每月第1個工作天後第7個日曆天執行
If strSrvDate(1) = ChangeWDateStringToWString(DateAdd("d", 7, ChangeWStringToWDateString(DBDATE(GetMonthStdDay(Left(strSrvDate(1), 6)))))) Then
    WLog "開始    收文逾三個月未發文商標案件-專業部通知(再提醒)(Amy)"
        StrMenu69
    WLog "完畢    收文逾三個月未發文商標案件-專業部通知(再提醒)"
End If
'end 2015/09/15

'add by sonia 2016/1/11 薪資及年終獎金入帳通知,互助會得標通知
If bolWorkDay = True Then
   WLog "開始   薪資及年終獎金入帳通知"
   Call StrMenu71
   WLog "完畢   薪資及年終獎金入帳通知"
End If
'end 2016/1/11

'add by sonia 2016/1/19 扣繳憑單資料開放查詢通知
If Right(strSrvDate(2), 4) = "0301" Then
   WLog "開始   扣繳憑單資料開放查詢通知"
   Call StrMenu72
   WLog "完畢   扣繳憑單資料開放查詢通知"
End If
'end 2016/1/11

'Add By Sindy 2016/3/16
If bolWorkDay = True Then
   WLog "開始   專利處未會(圖/文)完畢超過3個工作天清除齊備日(Sindy)"
   Call StrMenu74
   WLog "完畢   專利處未會(圖/文)完畢超過3個工作天清除齊備日"
End If
'2016/3/16 End

'Modify by Amy 2019/08/30 上線 'Add 2016/4/29(因客戶檔log文字切割問題所以未上)
If bolWorkDay = True Then
   WLog "開始   非電腦中心變更申請地址提醒CFT承辦人及智權人員 (Amy)"
   StrMenu75
   WLog "完畢   非電腦中心變更申請地址提醒CFT承辦人及智權人員"
End If
'end 2016/4/29

'Added by Lydia 2016/04/01 商標處大陸案催審輪值通知(每月1,16日後的第4個工作天) ---暫時不上線
'Modified by Lydia 2016/04/19 已開過說明會,開始輪值通知
If strSrvDate(1) = CompWorkDay(4, Left(strSrvDate(1), 6) & "01") Or strSrvDate(1) = CompWorkDay(4, Left(strSrvDate(1), 6) & "16") Then
    WLog "開始    商標處大陸案催審輪值通知(Lydia)"
       StrMenu70
    WLog "完畢    商標處大陸案催審輪值通知"
End If
'end 2016/04/01

'Added by Lydia 2016/07/01
If bolWorkDay = True Then
    WLog "開始   T案之國外收款及抵帳開收據通知(Lydia)"
    StrMenu77
    WLog "完畢   T案之國外收款及抵帳開收據通知"
End If
'end 2016/07/01

'Added by Lydia 2016/08/23 DHL提單號碼使用狀況提醒
'Mark by Lydia 2024/09/04 因為113/9/30就要關閉FTP，目前提單號碼有效期到113/9/8，所以先停止通知
'If bolWorkDay = True Then
'    WLog "開始   DHL提單號碼使用狀況提醒(Lydia)"
'    StrMenu78
'    WLog "完畢   DHL提單號碼使用狀況提醒"
'End If
''end 2016/08/23
'end 2024/09/04

'Add by Amy 2016/10/28
If bolWorkDay = True Then
   WLog "開始   圖書借閱記錄到期前三日清單(Amy)"
   StrMenu80
   WLog "完畢   圖書借閱記錄到期前三日清單"
End If

'Added by Lydia 2016/11/08 國外固定寄催款單給代理人
    WLog "開始   國外固定寄催款單給代理人(Lydia)"
    StrMenu81
    WLog "完畢   國外固定寄催款單給代理人"
'end 2016/11/08

'Add By Sindy 2016/12/14 P,CFP分析及核駁分析之會稿完成時間設定
If strSrvDate(1) >= 20161224 Then '2016/12/21上線,程式"系統自動會完"12/24才要執行
   If bolWorkDay = True Then
      WLog "開始   P,CFP分析及核駁分析之會稿完成時間設定(Sindy)"
      StrMenu82
      WLog "完畢   P,CFP分析及核駁分析之會稿完成時間設定"
   End If
End If

'Added by Lydia 2017/02/09
If bolWorkDay = True Then
   '單月的第三個工作天-抓前二個月專利修正無收費案件
   If strSrvDate(1) = CompWorkDay(3, Left(strSrvDate(1), 6) & "01") And Val(Mid(strSrvDate(1), 5, 2)) Mod 2 = 1 Then
      WLog "開始   專利修正無收費案件(Lydia)"
      StrMenu83
      WLog "完畢   專利修正無收費案件"
   End If
End If
'end 2017/02/09

'Add by Amy 2017/03/08 MCTF管控智權人員資料更新(只執行一次)
If strSrvDate(1) = "20170324" Then
    WLog "開始   MCTF管控智權人員資料更新(Amy)"
    StrRunOnlyOne
    WLog "完畢   MCTF管控智權人員資料更新"
End If
'end 2017/01/24

'Added by Lydia 2017/03/16 前半個月之專利及商標審查意見通知件數統計(每月03,18日自動執行)
If Val(Right(strSrvDate(1), 2)) = 3 Or Val(Right(strSrvDate(1), 2)) = 18 Then
    WLog "開始   專利及商標審查意見通知件數統計(Lydia)"
    StrMenu84
    WLog "完畢   專利及商標審查意見通知件數統計"
End If
'end 2017/03/16

'Added by Lydia 2017/05/23 T收款寄證催款提醒
If bolWorkDay = True Then
    WLog "開始   T收款寄證催款提醒(Lydia)"
    StrMenu85
    WLog "完畢   T收款寄證催款提醒"
End If
'end 2017/05/23

'Added by Lydia 2017/06/08 台灣商標延展案可辦日前10個工作天預先通知北中所人員
If bolWorkDay = True Then
   WLog "開始   台灣商標延展案可辦日前10個工作天預先通知北中所人員(Lydia)"
   Call StrMenu86(1)
   WLog "完畢   台灣商標延展案可辦日前10個工作天預先通知北中所人員"
End If
'Added by Lydia 2017/06/08 台灣商標延展案可辦日前一個月預先通知南高所人員
   WLog "開始   台灣商標延展案可辦日前一個月預先通知南高所人員(Lydia)"
   Call StrMenu86(2)
   WLog "完畢   台灣商標延展案可辦日前一個月預先通知南高所人員"
   
'Added by Lydia 2017/06/21 台灣商標案勝訴滿3個月提醒承辦人
   'Modified by Lydia 2018/05/02 不限台灣
   WLog "開始   商標案勝訴滿3個月提醒承辦人(Lydia)"
   Call StrMenu87
   WLog "完畢   商標案勝訴滿3個月提醒承辦人"
   
'Added by Lydia 2018/05/16 國外部新增客戶及代理人清單
If bolWorkDay = True Then
   'Modified by Lydia 2020/02/15 更名「國外部新增客戶及代理人清單」=>「新增客戶及代理人清單」
   WLog "開始   新增客戶及代理人清單(Lydia)"
   'Modify by Amy 2025/11/18 原:Call StrMenu92
   Call StrMenu92(False)
   WLog "完畢   新增客戶及代理人清單"
End If
'Add by Amy 2025/11/18 每年第1個工作天產生去年整年資料
If Mid(strSrvDate(1), 5, 4) = "0101" Then
   WLog "開始   新增客戶及代理人年度清單-去年(Amy)"
   Call StrMenu92(True)
   WLog "完畢   新增客戶及代理人年度清單-去年"
End If

'Added by Lydia 2018/06/21 互惠名單委案通知
If bolWorkDay = True Then
   'Modified by Lydia 2018/06/26 委案=>往來
   WLog "開始   互惠名單往來通知(Lydia)"
   Call StrMenu93
   WLog "完畢   互惠名單往來通知"
End If

'Add By Sindy 2019/1/31 每月的15日才發
If Right(strSrvDate(1), 2) = "15" Then
   WLog "開始   上月收款之可扣繳收據但收據抬頭不存在！請確認後修改資料(Sindy)"
   Call StrMenu94
   WLog "完畢   上月收款之可扣繳收據但收據抬頭不存在！請確認後修改資料"
End If
'2019/1/31 END

'Added by Lydia 2019/03/21 大陸商標延展案可辦日前10個工作天預先通知北中所人員
If bolWorkDay = True Then
   WLog "開始   大陸商標延展案可辦日前10個工作天預先通知北中所人員(Lydia)"
   Call StrMenu95(1)
   WLog "完畢   大陸商標延展案可辦日前10個工作天預先通知北中所人員"
End If
'Added by Lydia 2019/03/21 大陸商標延展案可辦日前一個月預先通知南高所人員
   WLog "開始   大陸商標延展案可辦日前一個月預先通知南高所人員(Lydia)"
   Call StrMenu95(2)
   WLog "完畢   大陸商標延展案可辦日前一個月預先通知南高所人員"

'Add by Sindy 2019/7/3 大陸商申提申後管制催申請案號(10日,20日,最後一日)
If Right(strSrvDate(1), 2) = "10" Or _
   Right(strSrvDate(1), 2) = "20" Or _
   Val(DBDATE(DateAdd("m", 1, DateSerial(Year(Date), Month(Date), 1)) - 1)) = Val(strSrvDate(1)) Then
    WLog "開始   大陸商申提申後管制催申請案號(Sindy)"
    StrMenu96
    WLog "完畢   大陸商申提申後管制催申請案號"
End If
'2019/7/3 END

'Added by Lydia 2018/08/15 每星期一和星期三提供外專英文組工程師認翻譯案的清單
If Weekday(Format(strSrvDate(1), "####-##-##")) = 2 Or Weekday(Format(strSrvDate(1), "####-##-##")) = 4 Then
   WLog "開始   提供外專英文組工程師認翻譯案的清單(Lydia)"
   Call StrMenu98
   WLog "完畢   提供外專英文組工程師認翻譯案的清單"
End If
'end 2019/08/15

flg100:
'Add By Sindy 2020/5/26 商標處信件處理結果檢核表
If bolWorkDay = True Then
   WLog "開始   商標處信件處理結果檢核表(Sindy)"
   Call StrMenu100
   WLog "完畢   商標處信件處理結果檢核表"
End If
'2020/5/26 END

'Add By Sindy 2023/5/8 外商信件處理結果檢核表
If bolWorkDay = True Then
   WLog "開始   外商信件處理結果檢核表(Sindy)"
   Call StrMenu120
   WLog "完畢   外商信件處理結果檢核表"
End If
'2023/5/8 END

'Add by Amy 2020/05/27 新Y編號委案後第一道收文的專業發文完成後通知業拓
If bolWorkDay = True Then
   WLog "開始   新Y編號委案第一道發文後通知業拓(Amy)"
   Call StrMenu101
   WLog "完畢   新Y編號委案第一道發文後通知業拓"
End If

'Add by Sindy 2021/4/15 FCP新案翻譯未核完/未完稿，達本所期限前1個月，發EMail通知核稿人
If bolWorkDay = True Then
   WLog "開始   FCP新案翻譯未核完/未完稿期限控管，達本所期限前1個月，發EMail通知相關人員(Sindy)"
   Call StrMenu104
   WLog "完畢   FCP新案翻譯未核完/未完稿期限控管，達本所期限前1個月，發EMail通知相關人員"
End If

'Added by Lydia 2021/07/21 ACS智財顧問案之顧問期間到期通知
If bolWorkDay = True Then
   WLog "開始   ACS智財顧問案之顧問期間到期通知(Lydia)"
   Call StrMenu105
   WLog "完畢   ACS智財顧問案之顧問期間到期通知 "
End If

'Add by Amy 2021/09/22 合約資料正本存檔提醒
WLog "開始   合約資料正本存檔提醒(Amy)"
    Call StrMenu106
WLog "完畢   合約資料正本存檔提醒"

'Add By Sindy 2021/10/15 ACS檢查歷程狀況的檢核表
If bolWorkDay = True Then
   WLog "開始   ACS檢查歷程狀況的清單(Sindy)"
   Call StrMenu108
   WLog "完畢   ACS檢查歷程狀況的清單"
End If
'2021/10/15 END

'Add By Sindy 2021/12/17 FCP請款作業稽核
WLog "開始   FCP請款作業稽核(Sindy)"
Call StrMenu109
WLog "完畢   FCP請款作業稽核"
'2021/12/17 END

'cancel by sonia 2025/8/27 改在StrMenu141做
''Add by Amy 2022/07/19 P案非台灣案收到專利權消滅函時由系統自動上結餘日期
'WLog "開始   P案非台灣案收到專利權消滅函時由系統自動上結餘日期(Amy)"
'Call StrMenu116
'WLog "完畢   P案非台灣案收到專利權消滅函時由系統自動上結餘日期"
'end 2025/8/27

'Add by Amy 2022/09/07 P案非台灣案收到專利權消滅函舊資料系統自動上結餘日期-只跑一次
If strSrvDate(1) = "20220908" Then
    WLog "開始   P案非台灣案收到專利權消滅函系統自動上結餘日期-補舊資料(Amy)"
    Call StrMenu116_OnlyOne
    WLog "完畢   P案非台灣案收到專利權消滅函系統自動上結餘日期-補舊資料"
End If

'Added by Lydia 2023/02/09
WLog "開始   法律顧問及智財顧問服務狀況通知(Lydia)"
Call StrMenu118
WLog "完畢   法律顧問及智財顧問服務狀況通知"

'Added by Lydia 2023/04/13
If Weekday(ChangeWStringToWDateString(strSrvDate(1))) = 2 Then 'Added by Lydia 2023/07/28 教威:將超過本所期限和本所期限前的前21日或90日通知的系統管制期限通知，全部彙整於每周一通知
   'Modified by Lydia 2023/12/07 「ACS系統-TIPS案件管制期限到期通知」更名「ACS案件管制期限到期通知」
   'Modified by Lydai 2025/05/15 「ACS案件管制期限到期通知」更名「ACS案件本所期限通知」
   WLog "開始   ACS案件本所期限通知(Lydia)"
   Call StrMenu119
   WLog "完畢   ACS案件本所期限通知"
End If

'Add by Amy 2023/07/25
If bolWorkDay = True Then
   WLog "開始   CF案件結餘結算作業,借貸不平案件系統通知檢查(Amy)"
   Call StrMenu121
   WLog "完畢   CF案件結餘結算作業,借貸不平案件系統通知檢查"
End If

'add by sonia 2025/4/28 每月25日跑專用期過期半年或閉卷半年(抓6~7個月)者補上可結餘日
If Right(strSrvDate(1), 2) = "25" Then
   WLog "開始   專用期過期半年或閉卷半年者補上可結餘日(Sonia)"
   Call StrMenu141
   WLog "完畢   專用期過期半年或閉卷半年者補上可結餘日"
End If
'end 2025/4/28

'Added by Lydia 2023/07/27
WLog "開始   FCP專利連結案管制專利權期滿通知(Lydia)"
Call StrMenu122
WLog "完畢   FCP專利連結案管制專利權期滿"

'Added by Lydia 2023/07/28
If bolWorkDay = True Then
   WLog "開始   外專新案建檔待比對管制(Lydia)"
   Call StrMenu123
   WLog "完畢   外專新案建檔待比對管制"
End If

'Added by Lydia 2023/08/21
If bolWorkDay = True Then
   WLog "開始   外專舊案收文提醒缺檔(Lydia)"
   Call StrMenu124
   WLog "完畢   外專舊案收文提醒缺檔"
End If

'Added by Lydia 2023/10/05
If bolWorkDay = True Then
   WLog "開始   外專寄請款函作業稽核(Lydia)"
   Call StrMenu125
   WLog "完畢   外專寄請款函作業稽核"
End If

'Added by Lydia 2025/04/23
If bolWorkDay = True Then
   WLog "開始   外專工程師寄信稽核作業(Lydia)"
   Call StrMenu140
   WLog "完畢   外專工程師寄信稽核作業"
End If

'Added by Lydia 2025/06/05
If bolWorkDay = True Then
   WLog "開始   外專程序大項作業稽核(Lydia)"
   Call StrMenu142
   WLog "完畢   外專程序大項作業稽核"
End If

'Modify by Amy 2024/01/31 上線
If bolWorkDay = True Then
   WLog "開始   設定風險檢查對象之潛在客戶已收文列表(Amy)"
   Call StrMenu127
   WLog "完畢   設定風險檢查對象之潛在客戶已收文列表"
End If
'Modify by Amy 2024/02/02 上線
'Modify by Amy 2025/09/04 建立者->負責同仁 原:負責同仁=建立者,1140728 風險編號001/002 改負責同仁
If bolWorkDay = True Then
   WLog "開始   風險檢查對象延展日前10個工作天通知負責同仁延展(Amy)"
   Call StrMenu129
   WLog "完畢   風險檢查對象延展日前10個工作天通知負責同仁延展"
End If
If bolWorkDay = True Then
   WLog "開始   風險檢查對象三個月屆滿取消設定並發信通知負責同仁(Amy)"
   Call StrMenu130
   WLog "完畢   風險檢查對象三個月屆滿取消設定並發信通知負責同仁"
End If
'end 2025/09/04
'end 2024/02/02

'Added by Morgan 2024/1/5
If strSrvDate(1) >= 指定日期啟用日 Then
   If bolWorkDay = True Then
      WLog "開始   P/CFP案指定送件日提醒(Morgan)"
      Call StrMenu128
      WLog "完畢   P/CFP案指定送件日提醒"
   End If
End If
'end 2024/1/5

'Added by Lydia 2024/03/12 外商程序組每月工作報告表:每月第1個工作天執行
If strSrvDate(1) = GetMonthStdDay(Left(strSrvDate(1), 6)) Then
   WLog "開始   外商程序組每月工作報告表(Lydia)"
   Call StrMenu131
   WLog "完畢   外商程序組每月工作報告表"
End If
'end 2024/03/12

'Add By Sindy 2024/5/31
If bolWorkDay = True Then
   WLog "開始   檢查客戶檔ID輸入8碼6,第一次通知智權人員和發文人員(Sindy)"
   Call StrMenu134
   WLog "完畢   檢查客戶檔ID輸入8碼6,第一次通知智權人員和發文人員"
End If
'2024/5/31 END

'Added by Lydia 2024/10/30 律師出庭費領取通知：系統日=FCL/L案發文日+1,2,3個月，每月10日統一通知
If Right(strSrvDate(1), 2) = "10" Then
   WLog "開始   律師出庭費領取通知(Lydia)"
   Call StrMenu132
   WLog "完畢   律師出庭費領取通知"
End If
'end 2024/10/30

'Added by Lydia 2024/10/30 律師出庭費未領取清單：每年第1個工作天寄發excel給(出庭費未領取通知副本收受者), 副本財務處
If Mid(strSrvDate(1), 5, 2) = "01" And strSrvDate(1) = GetMonthStdDay(Left(strSrvDate(1), 6)) Then
   WLog "開始   律師出庭費未領取清單(Lydia)"
   Call StrMenu133
   WLog "完畢   律師出庭費未領取清單"
End If
'end 2024/10/30

'Added by Lydia 2025/07/08 應收帳款逾付款週期管制表; 從每月批次frmAutoBatch.StrMenu21搬過來
'1. 於每季第一個工作天請發送予該智權人員。2. 於每季第三個工作天請發送予區主管及智權主管。
If bolWorkDay = True And Val(Mid(strSrvDate(1), 5, 2)) Mod 3 = 1 Then
   If strSrvDate(1) = CompWorkDay(1, Mid(strSrvDate(1), 1, 6) & "01") Or strSrvDate(1) = CompWorkDay(3, Mid(strSrvDate(1), 1, 6) & "01") Then
      WLog "開始   應收帳款逾付款週期管制表(Lydia)"
      StrMenu143
      WLog "完畢   應收帳款逾付款週期管制表"
   End If
End If

'**********************************************************************
'**********************************************************************
'
' 下列程式固定放最後面才執行
'
'**********************************************************************
'**********************************************************************

'Memo 商標圖存入偶而會失敗,固定放最後執行
'Add By Sindy 98/04/02 讀取商標圖並存入DB中
'If ChkWorkDay(strSrvDate(1)) = True Then
'Mark by Amy 2018/07/24 不使用-Sindy
'If bolWorkDay = True Then 'Add by Lydia 2015/05/25
'   WLog "開始   讀取商標圖並存入DB中(Sindy)"
'   Call StrMenu13
'   WLog "完畢   讀取商標圖並存入DB中"
'End If
'98/04/02 END

'Added by Morgan 2015/4/29
'Modified by Morgan 2015/6/16 改先做
WLog "開始   更正FTP檔案路徑"
Call StrMenu59
WLog "完畢   更正FTP檔案路徑"
'end 2015/4/29

'Added by Morgan 2017/8/14
WLog "開始   刪除電子公文原始檔(合併前的pdf)"
Call StrMenu88
WLog "完畢   刪除電子公文原始檔(合併前的pdf)"
'end 2017/8/14

'Add By Sindy 2013/11/18
'If bolWorkDay = True Then 'Add by Lydia 2015/05/25  Sindy 2017/8/30 Mark
   'Add By Sindy 2013/8/23
   WLog "開始   合併卷宗區PDF檔案(Sindy)"
   Call StrMenu42
   WLog "完畢   合併卷宗區PDF檔案"
   '2013/8/23 End

flg46:
   WLog "開始   已發文或已取消收文的專利案,刪除歷程附件檔及原始檔暫存區(Sindy)"
   Call StrMenu46
   WLog "完畢   已發文或已取消收文的專利案,刪除歷程附件檔及原始檔暫存區"
   
   'Add By Sindy 2016/2/4
   WLog "開始   定期清除國外部/專利處/商標處郵件實體檔(Sindy)"
   Call StrMenu73
   WLog "完畢   定期清除國外部/專利處/商標處郵件實體檔"
   '2016/2/4 End
'End If
'2013/11/18 End

'Added by Lydia 2016/10/26 查名單歷史資料刪除(商標每月1、16號公告約在三天後拿到註冊證) =>抓1、16號後的第四個工作天
'Memo by Lydia 2018/03/23 先暫停 (嘉雯: 反應找不到T211730的委查單HA6090926)
'Memo by Lydia 2018/03/28 恢復執行 (資料已補,並且修正問題)
If strSrvDate(1) = CompWorkDay(5, Mid(strSrvDate(1), 1, 6) & "01") Or strSrvDate(1) = CompWorkDay(5, Mid(strSrvDate(1), 1, 6) & "16") Then
    WLog "開始   查名單歷史資料刪除(Lydia)"
    StrMenu79
    WLog "完畢   查名單歷史資料刪除"
End If
'end 2016/10/26

'Modified by Lydia 2015/08/03 移到下方
'Added by Lydia 2015/07/30
'Modified by Lydia 2015/08/27 P大陸發明案公開期限之控管,改到每月第一個工作天執行
'If Weekday(ChangeWStringToWDateString(strSrvDate(1))) = 2 Then '周一執行
If strSrvDate(1) = GetMonthStdDay(Left(strSrvDate(1), 6)) Then
    WLog "開始    P大陸發明案公開期限之控管(Lydia)"
      StrMenu63
    WLog "完畢    P大陸發明案公開期限之控管"
End If
If Weekday(ChangeWStringToWDateString(strSrvDate(1))) = 7 Then '周六執行
    'Modified by Lydia 2015/08/10
    'WLog "開始    智權部業務目標及達成通知"
    WLog "開始    決策會工作報告-智權部目標及達成統計(Lydia)"
      StrMenu64
    'WLog "完畢    智權部業務目標及達成通知"
    WLog "完畢    決策會工作報告-智權部目標及達成統計"
End If
'end 2015/07/30

'Add by Amy 2016/05/13 每週四發下週一至週日預約會議室部門列表給夏慧珠(Word)
If Weekday(Format(strSrvDate(1), "####-##-##")) = 5 Then
    WLog "開始    預約會議室部門列表通知-夏慧珠(Amy)"
        StrMenu76
    WLog "完畢    預約會議室部門列表通知-夏慧珠"
End If
'end 2016/05/13

'Add by Amy 2018/01/31 工作日發前一個工作日新建客戶明細給葉特助(Excel)
If bolWorkDay = True Then
    WLog "開始    新建客戶明細-葉特助(Amy)"
        StrMenu89
    WLog "完畢    新建客戶明細-葉特助"
End If

'Added by Morgan 2018/2/2 文雄
If Weekday(ChangeWStringToWDateString(strSrvDate(1))) = 2 Then '每周一執行
    WLog "開始  專利處已齊備未會稿案件清單 (Morgan)"
        StrMenu90
    WLog "完畢  專利處已齊備未會稿案件清單"
End If
'end 2018/2/2

'Added by Lydia 2018/03/09
If bolWorkDay = True Then
   WLog "開始   FCP中說進度發文批次刪除案號資料夾的.msg檔(Lydia)"
   Call StrMenu91
   WLog "完畢   FCP中說進度發文批次刪除案號資料夾的.msg檔"
End If
'end 2018/03/09

'Add by Sindy 2019/8/13
If bolWorkDay = True Then
   WLog "開始   更新顧問過期一個月的未續簽資料(Sindy)"
   Call StrMenu97
   WLog "完畢   更新顧問過期一個月的未續簽資料"
End If
'2019/8/13 END

'Add by Amy 2020/02/18 刪除有會議室預約但無對應之教育訓練資料
If strSrvDate(1) >= 教育訓練登錄啟用日 Then
    WLog "開始   刪除有會議室預約但無對應之教育訓練資料(Amy)"
    StrMenu99
    WLog "完畢   刪除有會議室預約但無對應之教育訓練資料"
End If

'Added by Morgan 2020/7/28
WLog "開始   HP檔案加密壓縮(Morgan)"
Call StrMenu102
WLog "完畢   HP檔案加密壓縮"
'end 2020/7/28

'Added by Lydia 2021/01/18 CFP,CFT英國脫歐案自動上傳檔案
'Mark by Lydia 2021/01/28 確認下載完成並且正在進行發通知函作業，停止自動上傳功能。
'If bolWorkDay = True Then
'   WLog "開始   CFP,CFT英國脫歐案自動上傳檔案(Lydia)"
'   Call StrRunUpNa239
'   WLog "完畢   CFP,CFT英國脫歐案自動上傳檔案"
'End If
''end 2021/01/18
'end 2021/01/28


'Added by Morgan 2021/9/30
WLog "開始   長庚醫院案件管制(Morgan)"
Call StrMenu107
WLog "完畢   長庚醫院案件管制"
'end 2021/9/30

'Added by Morgan 2022/6/8
WLog "開始   欣興電子期限管控(Morgan)"
Call StrMenu114
WLog "完畢   欣興電子期限管控"
'end 2022/6/8


'Added by Morgan 2022/2/8 E化案件清單通知
If bolWorkDay = True Then
   WLog "開始   E化案件清單通知(Morgan)"
   Call StrMenu110
   WLog "完畢   E化案件清單通知"
End If
'end 2022/2/8

'Added by Morgan 2022/9/20 每周一執行
'CFP美國催維持費且尚未收文維持費之案件明細
'Removed by Morgan 2022/12/23 暫停通知--杜燕文
'If Weekday(ChangeWStringToWDateString(strSrvDate(1))) = 2 Then
'   WLog "開始   美國維持費未收文案件(Morgan)"
'   Call StrMenu117
'   WLog "完畢   美國維持費未收文案件"
'End If
'end 2022/9/20

'Added by Lydia 2022/02/22 外專紙本公文資料稽核表
If bolWorkDay = True Then
   WLog "開始   外專紙本公文資料稽核表(Lydia)"
   Call StrMenu111
   WLog "完畢   外專紙本公文資料稽核表"
End If
'end 2022/02/22

'Added by Lydia 2022/02/24 外專申請人異動請檢查個案設定之清單
If bolWorkDay = True Then
   WLog "開始   外專申請人異動請檢查個案設定之清單(Lydia)"
   Call StrMenu112
   WLog "完畢   外專申請人異動請檢查個案設定之清單"
End If
'end 2022/02/24

'Added by Morgan 2024/7/22
If bolWorkDay = True Then
   WLog "開始   專利處C類來函承辦人非專利處人員案件清單(Morgan)"
   Call StrMenu135
   WLog "完畢   專利處C類來函承辦人非專利處人員案件清單"
End If
'end 2024/7/22

'Added by Morgan 2024/7/31
If bolWorkDay = True Then
   WLog "開始   前日放颱風假的所別當天有同仁請假通知(Morgan)"
   Call StrMenu136
   WLog "完畢   前日放颱風假的所別當天有同仁請假通知"
End If
'end 2024/7/31

'Add By Sindy 2024/11/15
If bolWorkDay = True Then
   WLog "開始   紙本送件掃瞄上傳卷宗區稽核(Sindy)"
   Call StrMenu137
   WLog "完畢   紙本送件掃瞄上傳卷宗區稽核"
End If

'Add By Sindy 2024/12/11
'If bolWorkDay = True Then
   WLog "開始   檢查可補休資料(Sindy)"
   Call StrMenu138
   WLog "完畢   檢查可補休資料"
'End If

'Add By Sindy 2025/2/3
If bolWorkDay = True Then
   WLog "開始   稽核有掛相關卷號FCL未分案，於隔日發通知提醒分案人員(Sindy)"
   Call StrMenu139
   WLog "完畢   稽核有掛相關卷號FCL未分案，於隔日發通知提醒分案人員"
End If

''Add By Sindy 2023/10/24 通知填寫工作評價
'If Right(strSrvDate(1), 2) = "01" Or Right(strSrvDate(1), 2) = "06" Or Right(strSrvDate(1), 2) = "12" Then
'   WLog "開始   通知填寫工作評價(Sindy)"
'   Call StrMenu126
'   WLog "完畢   通知填寫工作評價"
'End If
''2023/10/24 END

   
'Added by Morgan 2025/11/18
If bolWorkDay = True Then
   WLog "開始   CFP外翻給案已達完稿期限通知(Morgan)"
   Call StrMenu144
   WLog "完畢   CFP外翻給案已達完稿期通知"
End If
'end 2025/11/18

'Add By Sindy 2021/11/1 暫時檢查; and length(a1k01)<>10=舊資料
If bolWorkDay = True Then
   strSql = "select * from acc1k0 where a1k29 is null and a1k12 is null and a1k25 is null" & _
   " and (a1k39+a1k40)=0 and (a1k32<>'C' or a1k32 is null) and length(a1k01)<>10 and nvl(a1k08,0)>0" & _
   " order by a1k01 desc"
   CheckOC
   adoRecordset.CursorLocation = adUseClient
   adoRecordset.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If adoRecordset.RecordCount > 0 Then
      PUB_SendMail strUserNum, "97038", "", "請款單有外幣金額未計算(a1k39+a1k40)=0,提醒！", "如旨" & vbCrLf & vbCrLf & strSql, , , , , , , , , , True, , , , False
   End If
   CheckOC
   
   strSql = "select * from acc1k0 where a1k39>0 and (decode(a1k18,'NTD',a1k11,a1k08)<>(a1k39+a1k40)) and a1k12 is null and a1k25 is null and (a1k32<>'C' or a1k32 is null) and (a1k29<>'Y' or a1k29 is null)"
   CheckOC
   adoRecordset.CursorLocation = adUseClient
   adoRecordset.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If adoRecordset.RecordCount > 0 Then
      PUB_SendMail strUserNum, "97038", "", "請款單有請款金額<>外幣金額合計,提醒！", "如旨" & vbCrLf & vbCrLf & strSql, , , , , , , , , , True, , , , False
   End If
   CheckOC
End If
'2021/11/1 END

'Added by Lydia 2022/03/10 整批直接更新造字
'Mark by Lydia 2022/03/22 先使用測試Table
''If bolWorkDay = True Then  '不限制工作天
   WLog "開始   整批直接更新造字(Lydia)"
   Call StrMenu113
   WLog "完畢   整批直接更新造字"
''End If
''end 2022/03/10

WLog "每日批次結束..............................." & vbCrLf & vbCrLf 'Modified by Morgan 2021/10/6 加兩個跳行方便看

'Remove by Morgan 2009/9/30 改放每月批次跑
''Add by Morgan 2009/9/3
'If InStr("0101,0401,0701,1001", Mid(strSrvDate(1), 5)) > 0 Then
'   WLog "開始   FCP終止辦理詢問函及清單"
'   StrMenu15
'   WLog "完畢   FCP終止辦理詢問函及清單"
'End If

'Remove by Morgan 2009/6/29 改手動執行(執行時間會超過1天)
''Add by Morgan 2008/12/24
'If Dir(App.Path & "\" & "TeAutoMail.exe") <> "" Then
'   Shell App.Path & "\" & "TeAutoMail.exe", vbNormalFocus
'End If
''end 2008/12/24

'Add By Sindy 2011/9/20
If cnnConnection.State <> adStateClosed Then
   cnnConnection.Close
   Set cnnConnection = Nothing
End If
'2011/9/20 End
End
End Sub

'Added by Morgan 2012/1/16
'每天都要執行的批次(補跑時要執行的部分,有別於只要執行最新的就可以)
Private Sub EveryDayBatch()
   
   'Add by Morgan 2005/10/13
   StrMenu4
   
'Removed by Morgan 2019/10/25 取消，改用下面報表
'   'Add by Morgan 2011/5/20
'   '每月勞健保異動報表-每月25日
'   If Right(strSrvDate(1), 2) = "25" Then
'      WLog "開始   每月勞健保異動報表(Morgan)"
'      Call StrMenu23
'      WLog "完畢   每月勞健保異動報表"
'   End If
'end 2019/10/25
   
   'Added by Morgan 2019/9/10
   '退休金提繳工資調整表-每個月倒數第3個工作天(報表+調整表)
   'Modified by Morgan 2023/5/29
   'strExc(0) = CompWorkDay(3, CompDate(2, -1, Left(CompDate(1, 1, strSrvDate(1)), 6) & "01"), 1)
   intI = Val(Pub_GetSpecMan("SUWD"))
   If intI > 0 Then
      strExc(0) = CompWorkDay(intI, CompDate(2, -1, Left(CompDate(1, 1, strSrvDate(1)), 6) & "01"), 1)
   'end 2023/5/29
   
      If strSrvDate(1) = strExc(0) Then
         WLog "開始   每月退休金提繳工資調整表(Morgan)"
         PUB_ExportSalaryUpdate , , True, True
         WLog "完畢   每月退休金提繳工資調整表"
      End If
      
   End If 'Added by Morgan 2023/5/29
   
   '勞健保薪資調整表 8/20,2/20
   If Mid(strSrvDate(1), 5, 2) = "08" Or Mid(strSrvDate(1), 5, 2) = "02" Then
      If Right(strSrvDate(1), 2) = "20" Then
         WLog "開始   勞健保薪資調整表(Morgan)"
         PUB_ExportSalaryUpdate2 TextPath, True
         WLog "完畢   勞健保薪資調整表"
      End If
      '該月倒數第2個工作天通知人事進行三合一檔案上傳
      strExc(0) = CompWorkDay(2, CompDate(2, -1, Left(CompDate(1, 1, strSrvDate(1)), 6) & "01"), 1)
      If strSrvDate(1) = strExc(0) Then
         'Modified by Morgan 2019/11/4 改正本 A8034，副本 劉經理
         'Modify By Sindy 2024/3/11 副本改用 國外大陸出差通知人員
         PUB_SendMail strUserNum, Pub_GetSpecMan("人事室出缺勤電子簽核"), "", "三合一媒體檔上傳健保局提醒！", "如旨", , , , , , Pub_GetSpecMan("國外大陸出差通知人員"), , , , True, , , , False
      End If
   End If
   
   'end 2019/9/10
   
   'Add By Sindy 2011/10/26
   'Modify By Sindy 2017/1/4 增加檢查員工到職滿半年及滿一年,給其特別假
   WLog "開始   試用期滿通知(Sindy)"
   StrMenu29
   WLog "完畢   試用期滿通知"
   
   'Added by Lydia 2020/12/03
   'Remove by Lydia 2020/12/07 取消：因為有時主管要延長試用期或者不續用，不見得一定在試用期滿前確定
   'WLog "開始   新進人員試用期滿製作職務用章及名片通知(Lydia)"
   'StrMenu103
   'WLog "完畢   新進人員試用期滿製作職務用章及名片通知"
   'end 2020/12/07
   
   'Addedby Morgan 2024/6/20 已設定不索取CF對帳單的代理人清單
   '5月最後1個工作天寄發
   'Modified by Morgan 2025/6/13 115起改每年6月最後1個工作天寄發
   'If strSrvDate(1) = CompWorkDay(1, Left(strSrvDate(1), 4) & "0601", 1) Then
   If strSrvDate(1) > "20260101" And strSrvDate(1) = CompWorkDay(1, Left(strSrvDate(1), 4) & "0701", 1) Then
   'end
      WLog "開始   已設定不索取CF對帳單的代理人清單(Morgan)"
      PUB_NoSoaList True
      WLog "完畢   已設定不索取CF對帳單的代理人清單"
   End If
   'end 2024/6/20

End Sub

Private Sub Form_Unload(Cancel As Integer)
Set frmAutoBatchDay = Nothing
End Sub

'Modify by Morgan 2009/7/14 +strMA54:累計會稿量
Private Function CalFinishNew(StrST01 As String, strDateFrom As String, strDateTo As String, oIsDraw As Boolean, Optional oIsRough As Boolean = True, Optional strMA54 As String) As String
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset
Dim dblNCFP As Double '非CFP件數
Dim dblCFP As Double 'CFP件數
Dim dblMonth As Double '在職月份
Dim dblDeMA54 As Double '累計未會稿件數
'Add by Morgan 2010/3/30 累計會稿量
Dim StrSqlB As String
Dim rsB As New ADODB.Recordset

dblDeMA54 = 0

DoEvents
CalFinishNew = "0"
dblNCFP = 0: dblCFP = 0
StrSQLa = "Select * From EngineerProgress, CaseProgress Where EP02=CP09 "
If oIsDraw = True Then
   If oIsRough = True Then
      StrSQLa = StrSQLa & " and ep20 is null and EP13='" & StrST01 & "' And EP15>=" & strDateFrom & " And EP15<=" & strDateTo
   Else
      StrSQLa = StrSQLa & " and ep29 is null and EP13='" & StrST01 & "' And EP18>=" & strDateFrom & " And EP18<=" & strDateTo
   End If
Else
   StrSQLa = StrSQLa & " and EP05='" & StrST01 & "' And EP09>=" & strDateFrom & " And EP09<=" & strDateTo
   
   'Add by Morgan 2010/3/30 累計會稿量統計條件改只考慮會稿日區間,不管完稿日區間
   'Modify by Morgan 2010/9/27 +智權人員為工程師的以收文點數*0.05換算為基數
   'Modify by Morgan 2010/11/4 +智權人員收文不算(74018杜燕文)
   'If bolNewPromoterRule Then 'Removed by Morgan 2014/3/20 早已實施不用再判斷
      StrSqlB = "select nvl(sum(pp),0) from (select sum(cp97 * cp98 * decode(cp112,'Y',nvl(cp111,1),1)) pp from engineerprogress,caseprogress where EP05='" & StrST01 & "' And EP07>=" & strDateFrom & " And EP07<=" & strDateTo & " and cp09(+)=EP02 "
      
      If Val(strDateFrom) < Val(PUB_108RuleDate) Then 'Added by Morgan 2019/3/18 108考核(取消收文點數轉換,另原修改紀錄及衍生工作紀錄103年就取消,一併排除)
         
         'Modify by Morgan 2011/5/30 若有建點數分配資料時點數改分配點數(目前有225提供書狀意見及226配合開庭)
         'strSQLB = strSQLB & " union all Select Sum(cp18*0.05) pp From caseprogress Where cp13='" & strST01 & "' And cp05>=" & strDateFrom & " And cp05<=" & strDateTo & " And cp18>0 and cp20 is null and cp57 is null and substr(cp12,1,1)<>'S'"
         'Modified by Morgan 2014/3/20 --2014/4/1起非智權收文改每點折算0.04基數
         'StrSqlB = StrSqlB & " union all Select Sum(nvl(a0n03/1000,cp18)*0.05) pp From caseprogress,acc0n0 Where a0n02(+)=cp09 and cp13='" & strST01 & "' And cp05>=" & strDateFrom & " And cp05<=" & strDateTo & " And nvl(a0n03/1000,cp18)>0 and cp20 is null and cp57 is null and substr(cp12,1,1)<>'S'"
         'Modified by Lydia 2016/09/14 cp57 is null => CP159=0
         StrSqlB = StrSqlB & " union all Select Sum(" & Pt2EPtCode & ") pp From caseprogress,acc0n0 Where a0n02(+)=cp09 and cp13='" & StrST01 & "' And cp05>=" & strDateFrom & " And cp05<=" & strDateTo & " And nvl(a0n03/1000,cp18)>0 and cp20 is null and CP159=0 and substr(cp12,1,1)<>'S'"
         'end 2014/3/20
         'Add by Morgan 2011/8/1 + 修改紀錄,衍生工作紀錄
         StrSqlB = StrSqlB & " Union All Select Sum(Round(Nvl(MH05,0)*0.2 ,2)) pp From ModifyHour Where MH02='" & StrST01 & "' And MH01>=" & strDateFrom & " And MH01<=" & strDateTo & " And MH11='V'"
         StrSqlB = StrSqlB & " Union All Select Sum(Round(Nvl(EH05,0)*0.25 ,2)) pp From ExtendHour Where EH02='" & StrST01 & "' And EH01>=" & strDateFrom & " And EH01<=" & strDateTo & " And EH11='V'"
         'end 2011/8/1
         
      End If 'Added by Morgan 2019/3/18
         
      'Modified by Morgan 2014/3/20 --2014/4/1起支援改每小時折計0.2基數
      'StrSqlB = StrSqlB & " union all Select Sum(Round(Decode(SH06, 'CFP', Nvl(SH05,0)/3, Nvl(SH05,0)/4),2)) pp From SupportHour Where SH02='" & strST01 & "' And SH01>=" & strDateFrom & " And SH01<=" & strDateTo & " And SH11='V' ) X"
      'Modified by Morgan 2019/4/9 108考核支援時數轉換要除組別參數
      StrSqlB = StrSqlB & " union all Select Sum(Round(" & Sh2EPtCode & " / GetDivNum(st70,sh01),2)) pp From SupportHour,staff Where st01(+)=sh02 and SH02='" & StrST01 & "' And SH01>=" & strDateFrom & " And SH01<=" & strDateTo & " And SH11='V' ) X"
      'end 2014/3/20
      
   'Removed by Morgan 2014/3/20 早已實施不用再判斷
   'Else
   '   StrSqlB = "select nvl(sum(pp),0) from (select sum(cp97 * cp98 * decode(cp112,'Y',nvl(cp111,1),1)) pp from engineerprogress,caseprogress where EP05='" & strST01 & "' And EP07>=" & strDateFrom & " And EP07<=" & strDateTo & " and cp09(+)=EP02 " & _
   '      " union all Select Sum(Round(Decode(SH06, 'CFP', Nvl(SH05,0)/3, Nvl(SH05,0)/4) ,2)) pp From SupportHour Where SH02='" & strST01 & "' And SH01>=" & strDateFrom & " And SH01<=" & strDateTo & " And SH11='V' ) X"
   'End If
   'end 2014/3/20
   
   If rsB.State <> adStateClosed Then rsB.Close
   rsB.CursorLocation = adUseClient
   rsB.Open StrSqlB, cnnConnection, adOpenStatic, adLockReadOnly
   If rsB.RecordCount > 0 Then
      strMA54 = rsB(0)
   End If
   'end 2010/3/30
End If

If rsA.State <> adStateClosed Then rsA.Close
rsA.CursorLocation = adUseClient
rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
While Not rsA.EOF
   If oIsDraw = False Then
      'edit by nickc 2006/02/22
      'CalFinishNew = Str((Val("" & rsA.Fields("cp97").Value) * Val("" & rsA.Fields("cp98").Value)) + Val(CalFinishNew))
      'Modify by Morgan 2010/10/26
      'CalFinishNew = str((Val("" & rsA.Fields("cp97").Value) * Val("" & rsA.Fields("cp98").Value) * IIf(CheckStr(rsA.Fields("cp112")) = "Y", Val(CheckStr(rsA.Fields("cp111"))), 1)) + Val(CalFinishNew))
      CalFinishNew = str((Val("" & rsA.Fields("cp97").Value) * Val("" & rsA.Fields("cp98").Value) * IIf(CheckStr(rsA.Fields("cp112")) = "Y", Val(CheckStr(IIf(IsNull(rsA.Fields("cp111")), 1, rsA.Fields("cp111")))), 1)) + Val(CalFinishNew))
      
      'Remove by Morgan 2010/3/30 累計會稿量統計條件改只考慮會稿日區間,不管完稿日區間
      ''Add by Morgan 2009/7/14
      'If IsNull(rsA.Fields("ep07")) Then
      '   dblDeMA54 = dblDeMA54 + Val("" & rsA.Fields("cp97").Value) * Val("" & rsA.Fields("cp98").Value) * IIf(CheckStr(rsA.Fields("cp112")) = "Y", Val(CheckStr(rsA.Fields("cp111"))), 1)
      'End If
      
   Else
      If oIsRough = True Then  '草圖
         CalFinishNew = str((Val("" & rsA.Fields("cp100").Value) * Val("" & rsA.Fields("cp101").Value)) + Val(CalFinishNew))
      Else
         CalFinishNew = str((Val("" & rsA.Fields("cp103").Value) * Val("" & rsA.Fields("cp104").Value)) + Val(CalFinishNew))
      End If
   End If
   'Debug.Print "收文號：" & CheckStr(rsA.Fields("cp09")) & " 完稿日：" & CheckStr(rsA.Fields("ep09")) & "   案號：" & CheckStr(rsA.Fields("cp01")) & "-" & CheckStr(rsA.Fields("cp02")) & "-" & CheckStr(rsA.Fields("cp03")) & "-" & CheckStr(rsA.Fields("cp04")) & "   案件性質:" & CheckStr(rsA.Fields("cp10")) & "計件值:" & Str((Val("" & rsA.Fields("cp97").Value) * Val("" & rsA.Fields("cp98").Value) * IIf(CheckStr(rsA.Fields("cp112")) = "Y", Val(CheckStr(rsA.Fields("cp111"))), 1)))
    rsA.MoveNext
Wend

If rsA.State <> adStateClosed Then rsA.Close
If oIsDraw = False Then
      'edit by nickc 2008/03/14 與實際速度考核的公式沒有同步
      'strSQLA = "Select Sum(Round(Decode(SH06, 'CFP', Nvl(SH05,0)/8, Nvl(SH05,0)/4) ,2)) From SupportHour Where SH02='" & strST01 & "' And SH01>=" & strDateFrom & " And SH01<=" & strDateTo & " And SH11='V' "
      'Modified by Morgan 2014/3/20 --2014/4/1起支援改每小時折計0.2基數
      'StrSQLa = "Select Sum(Round(Decode(SH06, 'CFP', Nvl(SH05,0)/3, Nvl(SH05,0)/4) ,2)) pp From SupportHour Where SH02='" & strST01 & "' And SH01>=" & strDateFrom & " And SH01<=" & strDateTo & " And SH11='V' "
      'Modified by Morgan 2019/4/9 108考核支援時數轉換要除組別參數
      StrSQLa = "Select Sum(Round(" & Sh2EPtCode & " / GetDivNum(st70,sh01),2)) pp From SupportHour,staff Where st01(+)=sh02 and SH02='" & StrST01 & "' And SH01>=" & strDateFrom & " And SH01<=" & strDateTo & " And SH11='V' "
      'end 2014/3/20
      'Add by Morgan 2010/11/8
      'Modified by Morgan 2019/3/18 108考核(取消收文點數轉換,另原修改紀錄及衍生工作紀錄103年就取消,一併排除,另新制早上線不必再判斷)
      'If bolNewPromoterRule Then
      If Val(strDateFrom) < Val(PUB_108RuleDate) Then
      'end 2019/3/18
      
         'Add by Morgan 2011/8/1 + 修改紀錄,衍生工作紀錄
         StrSQLa = StrSQLa & " Union All Select Sum(Round(Nvl(MH05,0)*0.2 ,2)) pp From ModifyHour Where MH02='" & StrST01 & "' And MH01>=" & strDateFrom & " And MH01<=" & strDateTo & " And MH11='V'"
         StrSQLa = StrSQLa & " Union All Select Sum(Round(Nvl(EH05,0)*0.25 ,2)) pp From ExtendHour Where EH02='" & StrST01 & "' And EH01>=" & strDateFrom & " And EH01<=" & strDateTo & " And EH11='V'"
         'end 2011/8/1
         'Modify by Morgan 2011/5/30 若有建點數分配資料時點數改分配點數(目前有225提供書狀意見及226配合開庭)
         'strSQLA = "select sum(pp) from (" & strSQLA & " union all Select Sum(cp18*0.05) pp From caseprogress Where cp13='" & strST01 & "' And cp05>=" & strDateFrom & " And cp05<=" & strDateTo & " And cp18>0 and cp20 is null and cp57 is null and substr(cp12,1,1)<>'S') X"
         'Modified by Morgan 2014/3/20 --2014/4/1起非智權收文改每點折算0.04基數
         'StrSQLa = "select sum(pp) from (" & StrSQLa & " union all Select Sum(nvl(a0n03/1000,cp18)*0.05) pp From caseprogress,acc0n0 Where a0n02(+)=cp09 and cp13='" & strST01 & "' And cp05>=" & strDateFrom & " And cp05<=" & strDateTo & " And nvl(a0n03/1000,cp18)>0 and cp20 is null and cp57 is null and substr(cp12,1,1)<>'S') X"
         'Modified by Lydia 2016/09/14 cp57 is null => CP159=0
         StrSQLa = "select sum(pp) from (" & StrSQLa & " union all Select Sum(" & Pt2EPtCode & ") pp From caseprogress,acc0n0 Where a0n02(+)=cp09 and cp13='" & StrST01 & "' And cp05>=" & strDateFrom & " And cp05<=" & strDateTo & " And nvl(a0n03/1000,cp18)>0 and cp20 is null and CP159=0 and substr(cp12,1,1)<>'S') X"
         'end 2014/3/20
      End If
      rsA.CursorLocation = adUseClient
      rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
      If rsA.RecordCount > 0 Then
          CalFinishNew = Val(CalFinishNew) + Val("" & rsA.Fields(0).Value)
      End If
      
Else
      '與工程師算法相同，4 hr= 一件，，但是因為草墨各一件，所以除4  因為草墨都會各來抓一次
      'Modified by Morgan 2014/3/20 --2014/4/1起支援改每小時折計0.2基數(原來沒有和工程師同步,本次一併更正)
      'StrSQLa = "Select Sum(Round(Nvl(SH05,0)/4,2)) pp From SupportHour,staff Where SH02='" & strST01 & "' And SH01>=" & strDateFrom & " And SH01<=" & strDateTo & " And SH11='V' AND ST01(+)=SH02 AND ST05<>'79' "
      StrSQLa = "Select Sum(Round(" & Sh2EPtCode & ",2)) pp From SupportHour,staff Where SH02='" & StrST01 & "' And SH01>=" & strDateFrom & " And SH01<=" & strDateTo & " And SH11='V' AND ST01(+)=SH02 AND ST05<>'79' "
      'end 2014/3/20
      
      'Add by Morgan 2010/11/8
      'Modified by Morgan 2019/3/18 108考核(取消收文點數轉換,另原修改紀錄及衍生工作紀錄103年就取消,一併排除,另新制早上線不必再判斷)
      'If bolNewPromoterRule Then
      If Val(strDateFrom) < Val(PUB_108RuleDate) Then
      'end 2019/3/18
      
         'Add by Morgan 2011/8/1 + 修改紀錄,衍生工作紀錄
         StrSQLa = StrSQLa & " Union All Select Sum(Round(Nvl(MH05,0)*0.2 ,2)) pp From ModifyHour,staff Where MH02='" & StrST01 & "' And MH01>=" & strDateFrom & " And MH01<=" & strDateTo & " And MH11='V' AND ST01(+)=MH02 AND ST05<>'79' "
         StrSQLa = StrSQLa & " Union All Select Sum(Round(Nvl(EH05,0)*0.25 ,2)) pp From ExtendHour,staff Where EH02='" & StrST01 & "' And EH01>=" & strDateFrom & " And EH01<=" & strDateTo & " And EH11='V' AND ST01(+)=EH02 AND ST05<>'79' "
         'end 2011/8/1
         'Modify by Morgan 2011/5/30 若有建點數分配資料時點數改分配點數(目前有225提供書狀意見及226配合開庭)
         'strSQLA = "select sum(pp) from (" & strSQLA & " union all Select Sum(cp18*0.05) pp From caseprogress Where cp13='" & strST01 & "' And cp05>=" & strDateFrom & " And cp05<=" & strDateTo & " And cp18>0 and cp20 is null and cp57 is null and substr(cp12,1,1)<>'S') X"
         'Modified by Morgan 2014/3/20 --2014/4/1起非智權收文改每點折算0.04基數
         'StrSQLa = "select sum(pp) from (" & StrSQLa & " union all Select Sum(nvl(a0n03/1000,cp18)*0.05) pp From caseprogress,acc0n0 Where a0n02(+)=cp09 and cp13='" & strST01 & "' And cp05>=" & strDateFrom & " And cp05<=" & strDateTo & " And nvl(a0n03/1000,cp18)>0 and cp20 is null and cp57 is null and substr(cp12,1,1)<>'S') X"
         'Modified by Lydia 2016/09/14 cp57 is null => CP159=0
         StrSQLa = "select sum(pp) from (" & StrSQLa & " union all Select Sum(" & Pt2EPtCode & ") pp From caseprogress,acc0n0 Where a0n02(+)=cp09 and cp13='" & StrST01 & "' And cp05>=" & strDateFrom & " And cp05<=" & strDateTo & " And nvl(a0n03/1000,cp18)>0 and cp20 is null and CP159=0 and substr(cp12,1,1)<>'S') X"
         'end 2014/3/20
      End If
      
      rsA.CursorLocation = adUseClient
      rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
      If rsA.RecordCount > 0 Then
         If oIsRough = True Then  '草圖
            'edit by nickc 2005/08/03
            'CalFinishNew = Val(CalFinishNew) + (Val("" & rsA.Fields(0).Value) * 0.65 * 2)
            CalFinishNew = Val(CalFinishNew) + (Val("" & rsA.Fields(0).Value) * 0.65 * 2)
         Else
            'edit by nickc 2005/08/03
            'CalFinishNew = Val(CalFinishNew) + (Val("" & rsA.Fields(0).Value) * 0.35 * 2)
            CalFinishNew = Val(CalFinishNew) + (Val("" & rsA.Fields(0).Value) * 0.35 * 2)
         End If
      End If
      
      
End If

'Remove by Morgan 2010/3/30 累計會稿量統計條件改只考慮會稿日區間,不管完稿日區間
'strMA54 = Format(Val(CalFinishNew) - dblDeMA54, "0.00") 'Add by Morgan 2009/7/14

CalFinishNew = Format(CalFinishNew, "0.00")

Set rsA = Nothing
Set rsB = Nothing
End Function

Private Function CalGoal(StrST01 As String, strST03 As String, strST06 As String, strST13 As String, strST16 As String, strNCFPGoal As String, strCFPGoal As String) As String
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset
Dim dblMonth As Double '月份
'新制算法
CalGoal = Format(Val(strNCFPGoal) + Val(strCFPGoal), "0.00")
End Function

Private Sub SetDate()
Dim intWeekDay As Integer

intWeekDay = Weekday(ChangeTStringToWDateString(Me.txt1(0).Text & Format(Me.txt1(1).Text, "00")))
'若1號小於星期三
If intWeekDay < 4 Then
    Me.txt1(2).Text = Day(DateAdd("d", ((7 - intWeekDay)), ChangeTStringToWDateString(Me.txt1(0).Text & Format(Me.txt1(1).Text, "00"))))
'若1號大於等於星期三
Else
    Me.txt1(2).Text = Day(DateAdd("d", ((7 - intWeekDay) + 7), ChangeTStringToWDateString(Me.txt1(0).Text & Format(Me.txt1(1).Text, "00"))))
End If
Me.txt1(3).Text = Day(DateAdd("d", 1, ChangeTStringToWDateString(Me.txt1(0).Text & Format(Me.txt1(2).Text, "00"))))
Me.txt1(4).Text = Day(DateAdd("d", 6, ChangeTStringToWDateString(Me.txt1(0).Text & Format(Me.txt1(3).Text, "00"))))
Me.txt1(5).Text = Day(DateAdd("d", 1, ChangeTStringToWDateString(Me.txt1(0).Text & Format(Me.txt1(4).Text, "00"))))
Me.txt1(6).Text = Day(DateAdd("d", 6, ChangeTStringToWDateString(Me.txt1(0).Text & Format(Me.txt1(5).Text, "00"))))
Me.txt1(7).Text = Day(DateAdd("d", 1, ChangeTStringToWDateString(Me.txt1(0).Text & Format(Me.txt1(6).Text, "00"))))

End Sub

Public Function PUB_GetMonthDays(intYear As Integer, intMonth As Integer) As Integer
Dim ii As Integer
PUB_GetMonthDays = 1
For ii = 1 To 31
   If Not IsDate(intYear & "/" & intMonth & "/" & ii) Then
      PUB_GetMonthDays = ii - 1
       Exit For
   End If
   PUB_GetMonthDays = ii
Next ii
End Function

'計算得分
Private Function CalPoints(strPercent As String) As String
    
strPercent = Format(Val("" & strPercent) * 100, "##0")
If Val(strPercent) >= 200 Then
    CalPoints = "40"
ElseIf Val(strPercent) >= 190 Then
    CalPoints = "39"
ElseIf Val(strPercent) >= 180 Then
    CalPoints = "38"
ElseIf Val(strPercent) >= 170 Then
    CalPoints = "37"
ElseIf Val(strPercent) >= 160 Then
    CalPoints = "36"
ElseIf Val(strPercent) >= 150 Then
    CalPoints = "35"
ElseIf Val(strPercent) >= 140 Then
    CalPoints = "34"
ElseIf Val(strPercent) >= 130 Then
    CalPoints = "33"
ElseIf Val(strPercent) >= 120 Then
    CalPoints = "32"
ElseIf Val(strPercent) >= 110 Then
    CalPoints = "31"
ElseIf Val(strPercent) >= 100 Then
    CalPoints = "30"
ElseIf Val(strPercent) >= 90 Then
    CalPoints = "26"
ElseIf Val(strPercent) >= 80 Then
    CalPoints = "22"
ElseIf Val(strPercent) >= 70 Then
    CalPoints = "18"
ElseIf Val(strPercent) >= 60 Then
    CalPoints = "14"
ElseIf Val(strPercent) >= 50 Then
    CalPoints = "10"
ElseIf Val(strPercent) >= 40 Then
    CalPoints = "6"
ElseIf Val(strPercent) >= 30 Then
    CalPoints = "2"
Else
    CalPoints = "0"
End If
    
End Function

'取得在職月份的比重
Private Function GetWeights(dblMonth As Double) As Double

'Modify by Morgan 2004/5/10
'If dblMonth >= 4 And dblMonth <= 6 Then
If dblMonth <= 6 Then
    GetWeights = 4
ElseIf dblMonth >= 7 And dblMonth <= 9 Then
    GetWeights = 3.5
ElseIf dblMonth >= 10 And dblMonth <= 12 Then
    GetWeights = 3
ElseIf dblMonth >= 13 And dblMonth <= 18 Then
    GetWeights = 2.5
ElseIf dblMonth >= 19 And dblMonth <= 24 Then
    GetWeights = 2.25
ElseIf dblMonth >= 25 Then
    GetWeights = 2
'避免程式錯誤
Else
    GetWeights = 1
End If

End Function

Private Sub SetGrd()
Dim ii As Integer

    For ii = 0 To Me.grd.Count - 1
        With Me.grd(ii)
            .Visible = False
            'Modify by Morgan 2009/7/14 +累計會稿量
            '.Rows = 35
            .Rows = 36
            
            .Cols = 3
            .TextMatrix(0, 0) = Val(Right(CalYM, 2))
            .TextMatrix(0, 1) = "月份"
            .TextMatrix(1, 0) = Val(Right(CalYM, 2))
            .TextMatrix(1, 1) = "月份"
            .TextMatrix(2, 0) = "目標": .TextMatrix(2, 1) = "件數"
            .TextMatrix(3, 0) = "本月": .TextMatrix(3, 1) = "工作天數"
            .TextMatrix(4, 0) = "第一週": .TextMatrix(4, 1) = "本週工作天數"
            .TextMatrix(5, 0) = "第一週": .TextMatrix(5, 1) = "本週目標"
            .TextMatrix(6, 0) = "第一週": .TextMatrix(6, 1) = "本週完成"
            .TextMatrix(7, 0) = "第一週": .TextMatrix(7, 1) = "本週得分"
            .TextMatrix(8, 0) = "第一週": .TextMatrix(8, 1) = "達成比例"
            .TextMatrix(9, 0) = "第二週": .TextMatrix(9, 1) = "本週工作天數"
            .TextMatrix(10, 0) = "第二週": .TextMatrix(10, 1) = "本週目標"
            .TextMatrix(11, 0) = "第二週": .TextMatrix(11, 1) = "本週完成"
            .TextMatrix(12, 0) = "第二週": .TextMatrix(12, 1) = "本週達成比例"
            .TextMatrix(13, 0) = "第二週": .TextMatrix(13, 1) = "本週得分"
            .TextMatrix(14, 0) = "第二週": .TextMatrix(14, 1) = "累計目標"
            .TextMatrix(15, 0) = "第二週": .TextMatrix(15, 1) = "累計完成"
            .TextMatrix(16, 0) = "第二週": .TextMatrix(16, 1) = "累計達成比例"
            
            .TextMatrix(17, 0) = "第三週": .TextMatrix(17, 1) = "本週工作天數"
            .TextMatrix(18, 0) = "第三週": .TextMatrix(18, 1) = "本週目標"
            .TextMatrix(19, 0) = "第三週": .TextMatrix(19, 1) = "本週完成"
            .TextMatrix(20, 0) = "第三週": .TextMatrix(20, 1) = "本週達成比例"
            .TextMatrix(21, 0) = "第三週": .TextMatrix(21, 1) = "本週得分"
            .TextMatrix(22, 0) = "第三週": .TextMatrix(22, 1) = "累計目標"
            .TextMatrix(23, 0) = "第三週": .TextMatrix(23, 1) = "累計完成"
            .TextMatrix(24, 0) = "第三週": .TextMatrix(24, 1) = "累計達成比例"
            
            .TextMatrix(25, 0) = "第四週": .TextMatrix(25, 1) = "本週工作天數"
            .TextMatrix(26, 0) = "第四週": .TextMatrix(26, 1) = "本週目標"
            .TextMatrix(27, 0) = "第四週": .TextMatrix(27, 1) = "本週完成"
            .TextMatrix(28, 0) = "第四週": .TextMatrix(28, 1) = "本週達成比例"
            .TextMatrix(29, 0) = "第四週": .TextMatrix(29, 1) = "本週得分"
            .TextMatrix(30, 0) = "第四週": .TextMatrix(30, 1) = "累計目標"
            .TextMatrix(31, 0) = "第四週": .TextMatrix(31, 1) = "累計完成"
            .TextMatrix(32, 0) = "第四週": .TextMatrix(32, 1) = "累計達成比例"
            
            .TextMatrix(33, 0) = "本月": .TextMatrix(33, 1) = "得分平均"
            
            .TextMatrix(34, 0) = "員工": .TextMatrix(34, 1) = "編號"
            .RowHeight(34) = 0
            
            'Add by Morgan 2009/7/14 +累計會稿量
            .TextMatrix(35, 0) = "本月": .TextMatrix(35, 1) = "累計會稿量"
            .RowHeight(35) = 0
            
            .MergeCells = flexMergeRestrictRows
            .MergeRow(0) = True
            .MergeCol(0) = True
            .MergeRow(1) = True
            .MergeCol(1) = True
            'add by nickc 2005/03/02 因為這一定會是新制
            If ii = 1 Then
               .MergeRow(33) = True
            End If
            .ColWidth(0) = 800
            .ColWidth(1) = 1200
            .Visible = True
        End With
    Next ii
    '預設目前在第一筆的位置
    With Me.grd(0)
        .row = 0
        .col = 2
    End With
End Sub

Function GetDelay(oUser As String, oIsRoung As Boolean) As Integer
Dim strMonthLastDate As String '某月份最後一天
Dim strBeginDate As String
Dim strEndDate As String
Dim StrSQLC As String
Dim NickRS As New ADODB.Recordset
Dim strSQL1 As String
Dim StrSQL6 As String
    GetDelay = 0
    Screen.MousePointer = vbHourglass
    Set NickRS = New ADODB.Recordset
      strBeginDate = Left(ChangeWDateStringToWString(DateAdd("m", -1, ChangeWStringToWDateString((Val(CalYM) + 191100) & "01"))), 6) & "01"
      strEndDate = Left((Val(CalYM) + 191100), 6) & PUB_GetMonthDays(Left((Val(CalYM) + 191100), 4), Mid((Val(CalYM) + 191100), 5, 2))
      strSQL1 = " AND CP05<=" & Val(CalYM) + 191100 & "31 "
      StrSQL6 = " AND CP05<=" & Val(CalYM) + 191100 & "31 "
      strSQL1 = " AND EP13='" & Trim(oUser) & "' " & strSQL1
      strSQL1 = strSQL1 & " And cp05>=19980101 "
      StrSQL6 = " AND EP13='" & Trim(oUser) & "'  " & StrSQL6
      StrSQL6 = StrSQL6 & " And cp05>=19980101 "
      strSQL1 = strSQL1 & " and ((cp21='Y' and (ep20 is null or ep29 is null)) or cp21 is null) "
      StrSQL6 = StrSQL6 & " and ((cp21='Y' and (ep20 is null or ep29 is null)) or cp21 is null) "
    
    StrSQLC = "SELECT EP13, CP10, EP14, '1', EP15, CP07, CP27, CP09, CP57, PA08 FROM ENGINEERPROGRESS,CASEPROGRESS,PATENT WHERE CP01 IN ('P','CFP','FCP') AND EP02=CP09(+) AND CP01=PA01(+) AND CP02=PA02(+) AND CP03=PA03(+) AND CP04=PA04(+) AND EP13='" & Trim(oUser) & "' And EP20 Is Null And (EP14>=" & strBeginDate & " And EP14<=" & strEndDate & " ) " & StrSQL6
    StrSQLC = StrSQLC & " Union SELECT EP13, CP10, Nvl(EP17, EP08), '2', EP18, CP07, CP27, CP09, CP57, PA08 FROM ENGINEERPROGRESS,CASEPROGRESS,PATENT WHERE CP01 IN ('P','CFP','FCP') AND EP02=CP09(+) AND CP01=PA01(+) AND CP02=PA02(+) AND CP03=PA03(+) AND CP04=PA04(+) AND EP13='" & Trim(oUser) & "' And EP29 Is Null And (EP17>=" & strBeginDate & " And EP17<=" & strEndDate & " ) " & StrSQL6
    
    NickRS.CursorLocation = adUseClient
    NickRS.Open StrSQLC, cnnConnection, adOpenStatic, adLockReadOnly
    If NickRS.RecordCount <> 0 Then
       NickRS.MoveFirst
       Do While NickRS.EOF = False
           Select Case CheckStr(NickRS.Fields("PA08").Value)
              Case "3"
               If CheckStr(NickRS.Fields(3)) = "1" Then  '草圖
                    If oIsRoung = True Then
                         '若有草齊日及草完日
                         If "" & NickRS.Fields(2).Value <> "" And "" & NickRS.Fields(4).Value <> "" Then
                             '草完日必須為當月
                             If Left("" & NickRS.Fields(4).Value, 6) = "" & (Val(txt1(0).Text) + 191100) Then
                                 If GetWorkDay(CheckStr(NickRS.Fields(4)), "" & NickRS.Fields(2).Value) > 5 Then
                                     GetDelay = GetDelay + 1
                                 End If
                             End If
     '                    '若無發文日有草齊日無草完日無取消收文日
                         '若有草齊日無草完日
'edit by nickc 2005/04/18 瓊玉說無完稿日不算逾時
'                          ElseIf "" & NickRS.Fields(2).Value <> "" And "" & NickRS.Fields(4).Value = "" Then
'                              If GetWorkDay(strEndDate, CheckStr(NickRS.Fields(2))) > 5 Then
'                                 GetDelay = GetDelay + 1
'                              End If
                         End If
                    End If
               Else '墨圖
                   '若有墨齊日及墨完日
                   If oIsRoung = False Then
                         If "" & NickRS.Fields(2).Value <> "" And "" & NickRS.Fields(4).Value <> "" Then
                             '墨完日必須為當月
                             If Left("" & NickRS.Fields(4).Value, 6) = "" & (Val(txt1(0).Text) + 191100) Then
                                 If GetWorkDay(CheckStr(NickRS.Fields(4)), "" & NickRS.Fields(2).Value) > 3 Then
                                     GetDelay = GetDelay + 1
                                 End If
                             End If
     '                    '若無發文日有墨齊日無墨完日無取消收文日
                         '若有墨齊日無墨完日
'edit by nickc 2005/04/18 瓊玉說無完稿日不算逾時
'                          ElseIf "" & NickRS.Fields(2).Value <> "" And "" & NickRS.Fields(4).Value = "" Then
'                              If GetWorkDay(strEndDate, CheckStr(NickRS.Fields(2))) > 3 Then
'                                  GetDelay = GetDelay + 1
'                              End If
                         End If
                    End If
               End If
           Case Else
               If CheckStr(NickRS.Fields(3)) = "1" Then  '草圖
                    If oIsRoung = True Then
                            '若有草齊日及草完日
                            If "" & NickRS.Fields(2).Value <> "" And "" & NickRS.Fields(4).Value <> "" Then
                                '草完日必須為當月
                                If Left("" & NickRS.Fields(4).Value, 6) = "" & (Val(txt1(0).Text) + 191100) Then
                                    If GetWorkDay(CheckStr(NickRS.Fields(4)), "" & NickRS.Fields(2).Value) > 4 Then
                                       GetDelay = GetDelay + 1
                                    End If
                                End If
        '                    '若無發文日有草齊日無草完日無取消收文日
                            '若有草齊日無草完日
'edit by nickc 2005/04/18 瓊玉說無完稿日不算逾時
'                             ElseIf "" & NickRS.Fields(2).Value <> "" And "" & NickRS.Fields(4).Value = "" Then
'                                 If GetWorkDay(strEndDate, CheckStr(NickRS.Fields(2))) > 4 Then
'                                    GetDelay = GetDelay + 1
'                                 End If
                            End If
                       End If
               Else '墨圖
                    If oIsRoung = False Then
                            '若有墨齊日及墨完日
                            If "" & NickRS.Fields(2).Value <> "" And "" & NickRS.Fields(4).Value <> "" Then
                                '墨完日必須為當月
                                If Left("" & NickRS.Fields(4).Value, 6) = "" & (Val(txt1(0).Text) + 191100) Then
                                    If GetWorkDay((CheckStr(NickRS.Fields(4))), "" & NickRS.Fields(2).Value) > 3 Then
                                        GetDelay = GetDelay + 1
                                    End If
                                End If
        '                    '若無發文日有墨齊日無墨完日無取消收文日
                            '若有墨齊日無墨完日
'edit by nickc 2005/04/18 瓊玉說無完稿日不算逾時
'                             ElseIf "" & NickRS.Fields(2).Value <> "" And "" & NickRS.Fields(4).Value = "" Then
'                                 If GetWorkDay(strEndDate, CheckStr(NickRS.Fields(2))) > 3 Then
'                                    GetDelay = GetDelay + 1
'                                 End If
                            End If
                    End If
               End If
           End Select
           NickRS.MoveNext
       Loop
   End If
   If NickRS.State = 1 Then NickRS.Close
   Screen.MousePointer = vbDefault
End Function

Private Sub Timer1_Timer()
   Sec = Sec + 1
End Sub

'add by nickc 2005/09/09 該結未結
Sub StrMenu2()
 On Error GoTo DebugErr
Dim ff As Integer
Dim i As Integer
Dim A01 As String
Dim A02 As String
Dim A03 As String
Dim A04 As String
Dim A05 As String
'add by nickc 2006/04/19
Dim A06 As String
Dim A07 As String
'add by nickc 2006/06/12
Dim A08 As String
Dim iCount As Long
Dim TempFileName As String
Dim TempFileNameT As String
Dim TempFileNameFCT As String
Dim ArrMail As Variant
Dim tmpnext As String
Dim StrMenu2I As Integer
Dim System_2 As String      '系統日減 2 工作天
Dim sReceiver As String
Dim Recip
'Add By Sindy 2010/01/04
Dim j As Integer
Dim strSysCode As String
'2010/01/04 End

'tmpnext = "準備連資料庫..."
'Set cnnConnection = New ADODB.Connection
'cnnConnection.ConnectionString = CnStr
'cnnConnection.Open

'Modify By Sindy 2010/01/04 增加通知外商程序人員
' j = 1 : 商標
' j = 2 : 外商(已過法定期限未收到指示,承辦按結案按鈕通知)
For j = 1 To 2
      'Add by Morgan 2008/7/2 因工作要輪替，改抓特殊人員設定
      tmpnext = "讀取收件者..."
      If j = 1 Then
         sReceiver = Pub_GetSpecMan("P")
         If sReceiver = "" Then sReceiver = "79041"
      Else
         sReceiver = Pub_GetSpecMan("P_FCT")
         'If sReceiver = "" Then sReceiver = "79041"
      End If
      'end 2008/7/2
      
      'edit by nickc 2006/04/28 改通通發，但是因為系統是在過12點時做，所以系統日當天不會有案子
      'System_2 = CompWorkDay(2, strSrvDate(1), 1)
      System_2 = strSrvDate(1)
      'edit by nickc 2006/04/19 解除期限前放法定期限，加智權人員
      'StrSQL = "select np02||'-'||np03||'-'||np04||'-'||np05,rpad(cu04,10,' '),rpad(sqldatet(np08),10,' '),rpad(sqldatet(np08),10,' '),rpad(tm05||tm06||tm07,20,' ') " & _
               " From nextprogress,trademark,customer " & _
               " where np02='T' and np07=102 and np11 is null and np01 in (select ti02 from t102inform where ti01<" & System_2 & ") " & _
               " and np02=tm01(+) and np03=tm02(+) and np04=tm03(+) and np05=tm04(+) and substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+) " & _
               " order by 1 "
      'edit by nickc 2006/06/12 加入案件性質跟第二期註冊費
      'StrSQL = "select np02||'-'||np03||'-'||np04||'-'||np05,rpad(cu04,10,' '),rpad(sqldatet(np08),10,' '),rpad(sqldatet(np09),10,' '),rpad(sqldatet(ti01),10,' '),rpad(tm05||tm06||tm07,20,' '),rpad(st02,10,' ') " & _
               " From nextprogress,trademark,customer,staff,t102inform " & _
               " where np02='T' and np07=102 and np11 is null and np01 in (select ti02 from t102inform where ti01<" & System_2 & ") " & _
               " and np02=tm01(+) and np03=tm02(+) and np04=tm03(+) and np05=tm04(+) and substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+) and np10=st01(+) and np01=ti02(+)  " & _
               " order by 1 "
      'edit by nickc 2007/04/12 加入下一程序序號
      'strSQL = "select np02||'-'||np03||'-'||np04||'-'||np05,rpad(cu04,10,' '),rpad(sqldatet(np08),10,' '),rpad(sqldatet(np09),10,' '),rpad(sqldatet(ti01),10,' '),rpad(tm05||tm06||tm07,20,' '),rpad(st02,10,' '),rpad(nvl(cpm03,cpm04),10,' ') " & _
               " From nextprogress,trademark,customer,staff,t102inform,casepropertymap " & _
               " where np02='T' and np07 in (102,716) and np11 is null and np01 in (select ti02 from t102inform where ti01<" & System_2 & ") " & _
               " and np02=tm01(+) and np03=tm02(+) and np04=tm03(+) and np05=tm04(+) and substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+) and np10=st01(+) and np01=ti02(+) and np02=cpm01(+) and to_char(np07)=cpm02(+)  " & _
               " order by 1 "
      'Modify By Sindy 2010/01/04
      If j = 1 Then
         strSysCode = " np02 in ('T','TF') "
      Else
         strSysCode = " np02='FCT' "
      End If
      strSql = "select np02||'-'||np03||'-'||np04||'-'||np05,rpad(cu04,10,' '),rpad(sqldatet(np08),10,' '),rpad(sqldatet(np09),10,' '),rpad(sqldatet(ti01),10,' '),rpad(tm05||tm06||tm07,20,' '),rpad(st02,10,' '),rpad(nvl(cpm03,cpm04),10,' ') " & _
               " From nextprogress,trademark,customer,staff,t102inform,casepropertymap " & _
               " where " & strSysCode & " and np07 in (102,716) and np11 is null and (np01,np22) in (select ti02,ti04 from t102inform where ti01<" & System_2 & ") " & _
               " and np02=tm01(+) and np03=tm02(+) and np04=tm03(+) and np05=tm04(+) and substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+) and np10=st01(+) and np01=ti02(+) and np22=ti04(+) and np02=cpm01(+) and to_char(np07)=cpm02(+)  " & _
               " order by 1 "
      Set Rs = New ADODB.Recordset
      Rs.CursorLocation = adUseClient
      Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      tmpnext = "已取得資料..."
      With Rs
              TempFileName = ""
              If .RecordCount > 0 And .RecordCount <> 0 Then
                     .MoveFirst
                     If ff > 0 Then Close #ff
                      ff = FreeFile
                      'Modify By Sindy 2009/06/04
                      'TempFileName = "c:\待結案件明細.txt"
                      'Modify By Sindy 2010/01/04
                      If j = 1 Then
                        TempFileName = App.path & TextPath & "待結案件明細.txt"
                      Else
                        TempFileName = App.path & TextPath & "外商待結案件明細.txt"
                      End If
                      '2009/06/04 End
                      Open TempFileName For Output As ff
                      'Added by Lydia 2016/10/19 加報表抬頭
                      Print #ff, Space(35) & IIf(j = 1, "待結案件明細", "外商待結案件明細")
                      Print #ff, ""
                      'end 2016/10/19
                      
                      Print #ff, "本所案號        申請人名稱  本所期限    法定期限   解除期限   智權人員   案件名稱　　　　　　 案件性質"
                      Print #ff, "=============   =========== ========    ========   ========   =========  ==================== =========="
                      tmpnext = "開檔中..."
                     
                     Do While Not .EOF
                          A01 = "" & (.Fields(0).Value)
                          A02 = "" & (.Fields(1).Value)
                          A03 = "" & (.Fields(2).Value)
                          A04 = "" & (.Fields(3).Value)
                          A05 = "" & (.Fields(4).Value)
                          'add by nickc 2006/04/19
                          A06 = "" & (.Fields(5).Value)
                          A07 = "" & (.Fields(6).Value)
                          'add by nickc 2006/06/12
                          A08 = "" & (.Fields(7).Value)
                          tmpnext = "寫檔..."
                          'edit by nickc 2006/04/19
                          'Print #ff, A01 & " " & A02 & "  " & A03 & "  " & A04 & " " & A05
                          'Modify By Sindy 2010/01/04
                          If j = 1 Then
                              Print #ff, A01 & "   " & A02 & "  " & A03 & "  " & A04 & " " & A05 & " " & A07 & " " & A06 & " " & A08
                          Else
                              Print #ff, A01 & " " & A02 & "  " & A03 & "  " & A04 & " " & A05 & " " & A07 & " " & A06 & " " & A08
                          End If
                          .MoveNext
                     Loop
              End If
      End With
      Close ff
      tmpnext = "關檔..."
      If TempFileName <> "" Then
         'Modify By Sindy 2011/10/27
         SendMAPIMail sReceiver, "待結案件明細", "敬閱者：" & vbCrLf & "待結明細 " & IIf(TempFileName = "", "資料庫找不到資料", "資料如附件") & "！" & vbCrLf & vbCrLf & vbCrLf & vbCrLf & "請橫印！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", TempFileName
         
'         '發 mail
'         tmpnext = "準備發 mail..."
'         MAPISession1.LogonUI = False
'         MAPISession1.UserName = "administrator"
'         tmpnext = "準備登入郵件伺服器..."
'         MAPISession1.SignOn
'         tmpnext = "登入郵件伺服器..."
'         MAPIMessages1.SessionID = MAPISession1.SessionID
'         '發葉經理
'         MAPIMessages1.MsgIndex = -1
'         tmpnext = "建立郵件..."
'         MAPIMessages1.Compose
'         MAPIMessages1.MsgSubject = "待結案件明細"
'         MAPIMessages1.MsgNoteText = "敬閱者：" & vbCrLf & "待結明細 " & IIf(TempFileName = "", "資料庫找不到資料", "資料如附件") & "！" & vbCrLf & vbCrLf & vbCrLf & vbCrLf & "請橫印！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心"
'         MAPIMessages1.AttachmentIndex = 0
'         MAPIMessages1.AttachmentPosition = 0
'         MAPIMessages1.AttachmentPathName = TempFileName
'
'         'Modify by Morgan 2008/7/2 +多收件者控制
'         Recip = Split(sReceiver, ";")
'         For i = 0 To UBound(Recip)
'            MAPIMessages1.RecipIndex = i
'            'Modify by Morgan 2009/4/3
'            'MAPIMessages1.RecipDisplayName = Recip(i)
'            MAPIMessages1.RecipDisplayName = ChkMailId(Recip(i))
'            MAPIMessages1.ResolveName
'         Next
'
'         tmpnext = "準備存入郵件..."
'         MAPIMessages1.Send
'         MAPISession1.SignOff
      'edit by nickc 2006/03/20 因為 taient4 的服務預設關閉
      '   Shell "net send /domain:taient4 '每日自動郵件資料已送出，請清除郵件備份' ", vbNormalNoFocus
      End If
Next j
Set Rs = Nothing
'Set cnnConnection = Nothing
Exit Sub
DebugErr:
   'MsgBox tmpnext & " " & Err.Description
   WLog tmpnext & " " & Err.Description
   'Add by Morgan 2009/4/3 發信失敗要登出
'   If MAPISession1.SessionID <> 0 Then MAPISession1.SignOff
End Sub

'add by nickc 2005/09/09 不該結而結
Sub StrMenu3()
 On Error GoTo DebugErr
Dim ff As Integer
Dim i As Integer
Dim A01 As String
Dim A02 As String
Dim A03 As String
Dim A04 As String
Dim A05 As String
'add by nickc 2006/04/19
Dim A06 As String
Dim A07 As String
'add by nickc 2006/06/12
Dim A08 As String

Dim iCount As Long
Dim TempFileName As String
Dim TempFileNameT As String
Dim TempFileNameFCT As String
Dim ArrMail As Variant
Dim tmpnext As String
Dim StrMenu2I As Integer
Dim System_2 As String      '系統日減 2 工作天
Dim sReceiver As String
Dim Recip
'Add By Sindy 2010/01/04
Dim j As Integer
Dim strSysCode As String
Dim strNP11 As String
Dim strWhere As String
'2010/01/04 End
Dim bolIsWrite As Boolean, bolWrite As Boolean 'Add By Sindy 2012/10/29

'tmpnext = "準備連資料庫..."
'Set cnnConnection = New ADODB.Connection
'cnnConnection.ConnectionString = CnStr
'cnnConnection.Open

'Modify By Sindy 2010/01/04 增加通知外商程序人員
' j = 1 : 商標
' j = 2 : 外商(已過法定期限,承辦未按結案按鈕通知但結案且結案日>法定)
'MODIFY BY SONIA 2015/10/30 外商不跑了,因為離職人員期限轉主管, 後續多為新人處理, 無法按結案按鈕都填結案單
'For j = 1 To 2
For j = 1 To 1
      'Add by Morgan 2008/7/2 因工作要輪替，改抓特殊人員設定
      tmpnext = "讀取收件者..."
      If j = 1 Then
         sReceiver = Pub_GetSpecMan("P")
         If sReceiver = "" Then sReceiver = "79041"
      Else
         'MODIFY BY SONIA 2015/10/30 外商不跑了,因為離職人員期限轉主管, 後續多為新人處理, 無法按結案按鈕都填結案單
         sReceiver = Pub_GetSpecMan("P_FCT")
         'If sReceiver = "" Then sReceiver = "79041"
      End If
      'end 2008/7/2
      
      'System_2 = CompWorkDay(2, strSrvDate(1), 1)
      'edit by nickc 2006/04/20 解除期限前放法定期限，加智權人員
      'StrSQL = "select distinct np02||'-'||np03||'-'||np04||'-'||np05,rpad(cu04,10,' '),rpad(sqldatet(np08),10,' ')," & _
                      " rpad(sqldatet(np08),10,' '),rpad(tm05||tm06||tm07,20,' ') " & _
                      " From nextprogress,trademark,customer  where np02='T' and np07=102 " & _
                      " and np11>20050912 and np01 not in (select ti02 from t102inform) " & _
                      " and np02=tm01(+) and np03=tm02(+) and np04=tm03(+) and np05=tm04(+) " & _
                      " and substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+)  order by 1 "
      'edit by nickc 2006/06/12
      'StrSQL = "select distinct np02||'-'||np03||'-'||np04||'-'||np05,rpad(cu04,10,' '),rpad(sqldatet(np08),10,' ')," & _
                      " rpad(sqldatet(np09),10,' '),rpad(sqldatet(ti01),10,' '),rpad(tm05||tm06||tm07,20,' '),rpad(st02,10,' ') " & _
                      " From nextprogress,trademark,customer,staff,t102inform  where np02='T' and np07=102 " & _
                      " and np11>20050912 and np01 not in (select ti02 from t102inform) " & _
                      " and np02=tm01(+) and np03=tm02(+) and np04=tm03(+) and np05=tm04(+) " & _
                      " and substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+) and np10=st01(+) and np01=ti02(+)  order by 1 "
      'Modify By Sindy 2010/01/04
      strWhere = ""
      If j = 1 Then
         strSysCode = " np02 in ('T','TF') "
         strNP11 = "20050912"
'         'Add By Sindy 2012/10/19
'         '抓出的資料若為102延展時, 再抓該案下一程序之716第二期註冊費期限, 若716第二期註冊費之np06 is null or np06='N'者,
'         '表示該筆716第二期註冊費未委託本所辦理, 則延展期限由商標處上網查詢
'         '確認該案件未繳716第二期註冊費時, 商標處會將延展期限做解除期限, 故此類資料不必再列入不該結而結案件明細清單.
'         strWhere = " and (np07='716' or (np07='102' and not exists (select * from nextprogress n2 where n2.np02=np02 and n2.np03=np03 and n2.np04=np04 and n2.np05=np05 and n2.np07='716' and (n2.np06 is null or n2.np06='N')))) "
'         '2012/10/19 End
         'ADD BY SONIA 2015/11/20 剔除延展之解除期限原因為86者,T-151745(發證後有敗訴來函且未閉卷,因有管制延展期限由承辦人確認應解除期限)
         'Modify By Sindy 2022/12/2 剔除解除期限原因為79(逾期未處理計算結餘)者,T-132859
          strWhere = " and np07||np12<>'10286' and NP12<>'79' "
         'END 2015/11/20
      Else
         'MODIFY BY SONIA 2015/10/30 外商不跑了,因為離職人員期限轉主管, 後續多為新人處理, 無法按結案按鈕都填結案單
         strSysCode = " np02='FCT' "
         strNP11 = "20100107"
         strWhere = " and np11>np09 "
      End If
      'Modify by Amy 2023/02/14 +Where ti06 is null,若ti06= 'Y'應該也要出現在清單list
      strSql = "select distinct np02||'-'||np03||'-'||np04||'-'||np05,rpad(cu04,10,' '),rpad(sqldatet(np08),10,' ')," & _
               " rpad(sqldatet(np09),10,' '),rpad(nvl(sqldatet(ti01),' '),10,' '),rpad(tm05||tm06||tm07,20,' '),rpad(st02,10,' '),rpad(nvl(cpm03,cpm04),10,' ') " & _
               " From nextprogress,trademark,customer,staff,t102inform,casepropertymap  where " & strSysCode & " and np07 in (102,716) " & _
               " and np11>" & strNP11 & " and (np01,np22) not in (select ti02,ti04 from t102inform Where ti06 is null) and np02=cpm01(+) and to_char(np07)=cpm02(+)  " & _
               " and np02=tm01(+) and np03=tm02(+) and np04=tm03(+) and np05=tm04(+) " & _
               " and substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+) and np10=st01(+) and np01=ti02(+) and np22=decode(ti04,null,np22,ti04) " & strWhere & " order by 1 "
      Set Rs = New ADODB.Recordset
      Rs.CursorLocation = adUseClient
      Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      tmpnext = "已取得資料..."
      With Rs
         TempFileName = ""
         bolIsWrite = False 'Add By Sindy 2012/10/29
         If .RecordCount > 0 And .RecordCount <> 0 Then
            .MoveFirst
            If ff > 0 Then Close #ff
            ff = FreeFile
            'Modify By Sindy 2009/06/04
            'TempFileName = "c:\不該結而結案件明細.txt"
            'Modify By Sindy 2010/01/04
            If j = 1 Then
              TempFileName = App.path & TextPath & "不該結而結案件明細.txt"
            Else
              TempFileName = App.path & TextPath & "外商不該結而結案件明細.txt"
            End If
            '2009/06/04 End
            Open TempFileName For Output As ff
            'Added by Lydia 2016/10/19 加報表抬頭
            Print #ff, Space(35) & IIf(j = 1, "不該結而結案件明細", "外商不該結而結案件明細")
            Print #ff, ""
            'end 2016/10/19
            
            Print #ff, "本所案號        申請人名稱  本所期限    法定期限   解除期限   智權人員   案件名稱　　　　　　 案件性質"
            Print #ff, "=============   =========== ========    ========   ========   =========  ==================== =========="
            tmpnext = "開檔中..."
            Do While Not .EOF
               'Add By Sindy 2012/10/29
               '抓出的資料若為102延展時, 再抓該案下一程序之716第二期註冊費期限, 若716第二期註冊費之np06 is null or np06='N'者,
               '表示該筆716第二期註冊費未委託本所辦理, 則延展期限由商標處上網查詢
               '確認該案件未繳716第二期註冊費時, 商標處會將延展期限做解除期限, 故此類資料不必再列入不該結而結案件明細清單.
               strSql = "select np01 from nextprogress " & _
                        "where np02||'-'||np03||'-'||np04||'-'||np05='" & .Fields(0) & "' " & _
                        "and np07='716' " & _
                        "and (np06 is null or np06='N') "
               CheckOC
               adoRecordset.CursorLocation = adUseClient
               adoRecordset.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
               If j = 1 And Trim(.Fields(7)) = "延展" And adoRecordset.RecordCount > 0 Then
                  bolWrite = False
               Else
                  bolWrite = True
               End If
               CheckOC
               If bolWrite = True Then
                  bolIsWrite = True
               '2012/10/29 End
                  A01 = "" & (.Fields(0).Value)
                  A02 = "" & (.Fields(1).Value)
                  A03 = "" & (.Fields(2).Value)
                  A04 = "" & (.Fields(3).Value)
                  A05 = "" & (.Fields(4).Value)
                  'add by nickc 2006/04/19
                  A06 = "" & (.Fields(5).Value)
                  A07 = "" & (.Fields(6).Value)
                  'add by nickc 2006/06/12
                  A08 = "" & (.Fields(7).Value)
                  tmpnext = "寫檔..."
                  'Modify By Sindy 2010/01/04
                  If j = 1 Then
                     Print #ff, A01 & "   " & A02 & "  " & A03 & "  " & A04 & " " & A05 & " " & A07 & " " & A06 & " " & A08
                  Else
                     Print #ff, A01 & " " & A02 & "  " & A03 & "  " & A04 & " " & A05 & " " & A07 & " " & A06 & " " & A08
                  End If
               End If
               .MoveNext
            Loop
         End If
      End With
      Close ff
      tmpnext = "關檔..."
      'Modify By Sindy 2012/10/29
      'If TempFileName <> "" Then
      If TempFileName <> "" And bolIsWrite = True Then
      '2012/10/29 End
         'Modify By Sindy 2011/10/27
         SendMAPIMail sReceiver, "不該結而結案件明細", "敬閱者：" & vbCrLf & "不該結而結案件明細 " & IIf(TempFileName = "", "資料庫找不到資料", "資料如附件") & "！" & vbCrLf & vbCrLf & vbCrLf & vbCrLf & "請橫印！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", TempFileName
         
'         '發 mail
'         tmpnext = "準備發 mail..."
'         MAPISession1.LogonUI = False
'         MAPISession1.UserName = "administrator"
'         tmpnext = "準備登入郵件伺服器..."
'         MAPISession1.SignOn
'         tmpnext = "登入郵件伺服器..."
'         MAPIMessages1.SessionID = MAPISession1.SessionID
'         '發葉經理
'         MAPIMessages1.MsgIndex = -1
'         tmpnext = "建立郵件..."
'         MAPIMessages1.Compose
'         MAPIMessages1.MsgSubject = "不該結而結案件明細"
'         MAPIMessages1.MsgNoteText = "敬閱者：" & vbCrLf & "不該結而結案件明細 " & IIf(TempFileName = "", "資料庫找不到資料", "資料如附件") & "！" & vbCrLf & vbCrLf & vbCrLf & vbCrLf & "請橫印！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心"
'         MAPIMessages1.AttachmentIndex = 0
'         MAPIMessages1.AttachmentPosition = 0
'         MAPIMessages1.AttachmentPathName = TempFileName
'
'         'Modify by Morgan 2008/7/2 +多收件者控制
'         Recip = Split(sReceiver, ";")
'         For i = 0 To UBound(Recip)
'            MAPIMessages1.RecipIndex = i
'            'Modify by Morgan 2009/4/3
'            'MAPIMessages1.RecipDisplayName = Recip(i)
'            MAPIMessages1.RecipDisplayName = ChkMailId(Recip(i))
'            MAPIMessages1.ResolveName
'         Next
'
'         tmpnext = "準備存入郵件..."
'         MAPIMessages1.Send
'         MAPISession1.SignOff
      'edit by nickc 2006/03/20 因為 taient4 的服務預設關閉
      '   Shell "net send /domain:taient4 '每日自動郵件資料已送出，請清除郵件備份' ", vbNormalNoFocus
      End If
Next j
Set Rs = Nothing
'Set cnnConnection = Nothing
Exit Sub
DebugErr:
   'MsgBox tmpnext & " " & Err.Description
   WLog tmpnext & " " & Err.Description
   'Add by Morgan 2009/4/3 發信失敗要登出
'   If MAPISession1.SessionID <> 0 Then MAPISession1.SignOff
End Sub

'Add by Morgan 2005/10/13
'產生並Mail代理人案件收達/提申管制表
Private Sub StrMenu4()

   Dim strText As String, strFileName As String, strRptDate As String, strPS As String
   Dim strDataDate As String, strTo As String
   'Dim strCFPMan As String 'CFP 管制人 'Removed by Morgan 2017/11/1
   Dim strCC As String     '系統特殊設定收受者
   
On Error GoTo ErrHand
   
   'Modified by Morgan 2012/2/29 寄給 79017 改為 86032(預定6月底改回)
   'Modified by Morgan 2012/6/28 7/1 改回 79017
   'Modified by Morgan 2015/3/31 改抓特殊設定
   'If Val(strSrvDate(1)) >= 20120701 Then
   '   strCFPMan = "79017"
   'Else
   '   strCFPMan = "86032"
   'End If
   'strCFPMan = Pub_GetSpecMan("CFP每日報表管制人") 'Removed by Morgan 2017/11/1 改寄各承辦人
   'end 2015/3/31
   
'   If cnnConnection.State = adStateClosed Then
'      cnnConnection.ConnectionString = CnStr
'      cnnConnection.Open
'   End If
   
   'Modified by Morgan 2012/1/16 統一用變數以方便重跑
   'strRptDate = Format(Format(Now, "YYYY") - 1911) & Format(Now, "/MM/DD")
   strRptDate = Format(strSrvDate(2), "@@@/@@/@@")
   
   strPS = vbCrLf & vbCrLf & vbCrLf & String(2, "　") & "列印注意事項：" & vbCrLf & _
         vbCrLf & String(4, "　") & "1.利用筆記本開啟附件" & _
         vbCrLf & String(4, "　") & "2.將視窗展開到最大" & _
         vbCrLf & String(4, "　") & "3.取消<自動換行>設定" & _
         vbCrLf & String(4, "　") & "4.<字型>設定為<細明體 標準 11>" & _
         vbCrLf & String(4, "　") & "5.左右邊界分別設<10mm 0mm>" & _
         vbCrLf & String(4, "　") & "6.選擇<橫印>"
   
   m_stRptPS = strPS 'Added by Morgan 2025/11/18
   
   WLog "開始   P代理人案件收達管制表"
   If CreateFile1("P", strRptDate, strFileName) = True Then
      strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & "P代理人案件收達管制表(" & strRptDate & ") " & _
         IIf(strFileName = "", "無需管制資料！", "資料如附件！") & _
         vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & strPS
      
      If strSrvDate(1) < P業務區劃分啟用日 Then 'Added by Morgan 2024/12/16 改業務區劃分後直接寄改管制人
         SendMAPIMail "79075", "P代理人案件收達管制表(" & strRptDate & ")", strText, strFileName
      End If
   End If
   WLog "完畢   代理人案件收達管制表"
   
   'Added by Morgan 2014/11/10
   WLog "開始   FMP寰華案件代理人案件收達管制表"
   'Modified by Morgan 2023/6/21 FMP寰華案改寄管制程序及其主管,沒案件就不必通知--敏莉
   'If CreateFile1("P", strRptDate, strFileName, True) = True Then
   '   strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & "FMP寰華案件代理人案件收達管制表(" & strRptDate & ") " & _
   '      IIf(strFileName = "", "無需管制資料！", "資料如附件！") & _
   '      vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & strPS
   '   'modify by sonia 2016/6/28 73023改86024  2016/7/5改系統特殊設定人員
   '   'SendMAPIMail "86024", "FMP寰華案件代理人案件收達管制表(" & strRptDate & ")", strText, strFileName
   '   strCC = Pub_GetSpecMan("寰華案外專程序窗口")
   '   SendMAPIMail strCC, "FMP寰華案件代理人案件收達管制表(" & strRptDate & ")", strText, strFileName
   'End If
   Call CreateFile1("P", strRptDate, strFileName, True, strPS)
   'end 2023/6/21
   WLog "完畢   FMP寰華案件代理人案件收達管制表"
   '
      
   WLog "開始   P案領證年費代理人收達管制表"
   'Add by Morgan 2010/12/17
   strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & _
      "P案領證年費代理人收達管制表(" & strRptDate & ")" & _
      vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & strPS
   Call CreateFile14(strRptDate, strText)
   'end 2010/12/17
   WLog "完畢   P案領證年費代理人收達管制表"
   
   'Add by Morgan 2019/1/29
   WLog "開始   FMP寰華案領證年費代理人收達管制表"
   strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & _
      "FMP寰華案領證年費代理人收達管制表(" & strRptDate & ")" & _
      vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & strPS
   Call CreateFile14(strRptDate, strText, True)
   WLog "完畢  FMP寰華案領證年費代理人收達管制表"
   'end 2019/1/29
   
   WLog "開始   CFP代理人案件收達管制表"
   'Modified by Morgan 2017/10/31 CFP改直接寄給承辦人--甄妮106/10/27請作單
   If CreateFile1("CFP", strRptDate, strFileName, , strPS) = True Then
      'strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & "CFP代理人案件收達管制表(" & strRptDate & ") " & _
         IIf(strFileName = "", "無需管制資料！", "資料如附件！") & _
         vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & strPS
      'SendMAPIMail strCFPMan, "CFP代理人案件收達管制表(" & strRptDate & ")", strText, strFileName
   End If
   WLog "完畢   CFP代理人案件收達管制表"

   
   'Modify by Morgan 2009/6/9
'   If CreateFile2("P", strRptDate, strFileName) = True Then
'      strText = "Dear Amy," & vbCrLf & vbCrLf & String(2, "　") & "P代理人案件提申管制表(" & strRptDate & ") " & _
'         IIf(strFileName = "", "無需管制資料！", "資料如附件！") & _
'         vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & strPS
'      SendMAPIMail "79075", "P代理人案件提申管制表(" & strRptDate & ")", strText, strFileName
'   End If
'
'   If CreateFile2("CFP", strRptDate, strFileName) = True Then
'      strText = "Dear Servena," & vbCrLf & vbCrLf & String(2, "　") & "CFP代理人案件提申管制表(" & strRptDate & ") " & _
'         IIf(strFileName = "", "無需管制資料！", "資料如附件！") & _
'         vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & strPS
'      SendMAPIMail strCFPMan, "CFP代理人案件提申管制表(" & strRptDate & ")", strText, strFileName
'   End If

   '新提申管制表
   WLog "開始   P代理人案件提申管制表"
   If CreateFile12("P", strRptDate, strFileName) = True Then
      strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & "P代理人案件提申管制表(" & strRptDate & ") " & _
         IIf(strFileName = "", "無需管制資料！", "資料如附件！") & _
         vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & strPS
      
      If strSrvDate(1) < P業務區劃分啟用日 Then 'Added by Morgan 2024/12/16 改業務區劃分後直接寄改管制人
         SendMAPIMail "79075", "P代理人案件提申管制表(" & strRptDate & ")", strText, strFileName
      End If
   End If
   WLog "完畢   P代理人案件提申管制表"
   
   'Added by Morgan 2014/11/10
   WLog "開始   FMP寰華案件代理人案件提申管制表"
   'Modified by Morgan 2023/6/20 FMP寰華案改寄管制程序及其主管,沒案件就不必通知--敏莉
   'If CreateFile12("P", strRptDate, strFileName, True) = True Then
   '   strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & "FMP寰華案件代理人案件提申管制表(" & strRptDate & ") " & _
   '      IIf(strFileName = "", "無需管制資料！", "資料如附件！") & _
   '      vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & strPS
   '   'modify by sonia 2016/6/28 73023改86024  2016/7/5改系統特殊設定人員
   '   'SendMAPIMail "86024", "FMP寰華案件代理人案件提申管制表(" & strRptDate & ")", strText, strFileName
   '   strCC = Pub_GetSpecMan("寰華案外專程序窗口")
   '   SendMAPIMail strCC, "FMP寰華案件代理人案件提申管制表(" & strRptDate & ")", strText, strFileName
   'End If
   Call CreateFile12("P", strRptDate, strFileName, True, strPS)
   'end 2023/6/20
   WLog "完畢   FMP寰華案件代理人案件提申管制表"
   'end 2014/11/10
   
   WLog "開始   CFP代理人案件提申管制表"
   'Modified by Morgan 2017/10/31 CFP改直接寄給承辦人--甄妮106/10/27請作單
   If CreateFile12("CFP", strRptDate, strFileName, , strPS) = True Then
      'strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & "CFP代理人案件提申管制表(" & strRptDate & ") " & _
         IIf(strFileName = "", "無需管制資料！", "資料如附件！") & _
         vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & strPS
      'SendMAPIMail strCFPMan, "CFP代理人案件提申管制表(" & strRptDate & ")", strText, strFileName
   End If
   WLog "完畢   CFP代理人案件提申管制表"
   'end 2009/4/23
   
'Removed by Morgan 2013/5/29 已設定提申天數併入案件提申管制表
'   'Added by Morgan 2012/3/21
'   WLog "開始   CFP答辯提申管制表"
'   If CreateFile16(strRptDate, strFileName) = True Then
'      strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & "CFP答辯提申管制表(" & strRptDate & ") " & _
'         IIf(strFileName = "", "無需管制資料！", "資料如附件！") & _
'         vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & strPS
'      SendMAPIMail strCFPMan, "CFP答辯提申管制表(" & strRptDate & ")", strText, strFileName
'   End If
'   WLog "完畢   CFP答辯提申管制表"
   
   WLog "開始   EPC檢索報告來函管制表"
   'Modified by Morgan 2017/10/31 CFP改直接寄給承辦人--甄妮106/10/27請作單
   If CreateFile17(strRptDate, strFileName, strPS) = True Then
      'strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & "EPC檢索報告來函管制表(" & strRptDate & ") " & _
      '   IIf(strFileName = "", "無需管制資料！", "資料如附件！") & _
      '   vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & strPS
      'SendMAPIMail strCFPMan, "EPC檢索報告來函管制表(" & strRptDate & ")", strText, strFileName
   End If
   WLog "完畢   EPC檢索報告來函管制表"
   'end 2012/3/21
   
   WLog "開始   准予延緩公告來函管制表"
   'Add by Morgan 2006/10/14
   If CreateFile3(strRptDate, strFileName, strPS) = True Then
      If strSrvDate(1) < P業務區劃分啟用日 Then 'Added by Morgan 2024/12/16 改業務區劃分後直接寄改管制人
      
         strText = "Dear Amy," & vbCrLf & vbCrLf & String(2, "　") & "准予延緩公告來函管制表(" & strRptDate & ") " & _
            IIf(strFileName = "", "無需管制資料！", "資料如附件！") & _
            vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & strPS
         SendMAPIMail "79075", "准予延緩公告來函管制表(" & strRptDate & ")", strText, strFileName
         
      End If
   End If
   WLog "完畢   准予延緩公告來函管制表"
   
   'Add by Morgan 2007/8/20
   WLog "開始   P受理通知書未收達管制表"
   If CreateFile4("P", strRptDate, strFileName, , strPS) = True Then
      If strSrvDate(1) < P業務區劃分啟用日 Then 'Added by Morgan 2024/12/16 改業務區劃分後直接寄改管制人
      
         strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & "P受理通知書未收達管制表(" & strRptDate & ") " & _
            IIf(strFileName = "", "無需管制資料！", "資料如附件！") & _
            vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & strPS
         SendMAPIMail "79075", "P受理通知書未收達管制表(" & strRptDate & ")", strText, strFileName
      End If
   End If
   WLog "完畢   P受理通知書未收達管制表"
   'end 2007/8/20
   
   'Add by Morgan 2014/11/10
   WLog "開始  FMP寰華案件受理通知書未收達管制表"
   'Modified by Morgan 2023/6/20 FMP寰華案改寄管制程序及其主管,沒案件就不必通知--敏莉
   'If CreateFile4("P", strRptDate, strFileName, True) = True Then
   '   strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & "FMP寰華案件受理通知書未收達管制表(" & strRptDate & ") " & _
   '      IIf(strFileName = "", "無需管制資料！", "資料如附件！") & _
   '      vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & strPS
   '   'modify by sonia 2016/6/28 73023改86024  2016/7/5改系統特殊設定人員
   '   'SendMAPIMail "86024", "FMP寰華案件受理通知書未收達管制表(" & strRptDate & ")", strText, strFileName
   '   strCC = Pub_GetSpecMan("寰華案外專程序窗口")
   '   SendMAPIMail strCC, "FMP寰華案件受理通知書未收達管制表(" & strRptDate & ")", strText, strFileName
   'End If
   Call CreateFile4("P", strRptDate, strFileName, True, strPS)
   'end 2023/6/20
   WLog "完畢   FMP寰華案件受理通知書未收達管制表"
   'end 2014/11/10
   
   
   WLog "開始   CFP已提申3個月尚無申請號管制表"
   'Add by Morgan 2009/6/8
   'Modified by Morgan 2017/10/31 CFP改直接寄給承辦人--甄妮106/10/27請作單
   If CreateFile4("CFP", strRptDate, strFileName, , strPS) = True Then
      'strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & "CFP已提申3個月尚無申請號管制表(" & strRptDate & ") " & _
      '   IIf(strFileName = "", "無需管制資料！", "資料如附件！") & _
      '   vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & strPS
      'SendMAPIMail strCFPMan, "CFP已提申3個月尚無申請號管制表(" & strRptDate & ")", strText, strFileName
   End If '
   'end 2007/8/20
   WLog "完畢   CFP已提申3個月尚無申請號管制表"
   
   'Added by Morgan 2020/8/18
   WLog "開始   CFP年費已提申無收據管制表"
   If CreateFile21(strRptDate, , strPS) = True Then
      '直接寄給管制人
   End If '
   WLog "完畢   CFP年費已提申無收據管制表"
   'end 2020/8/18
   
   'Add by Morgan 2009/8/25
   WLog "開始   P催審管制表"
   '催審管制表
   If CreateFile9("P", strRptDate, strFileName, , strPS) = True Then
      If strSrvDate(1) < P業務區劃分啟用日 Then 'Added by Morgan 2024/12/16 改業務區劃分後直接寄改管制人
      
         strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & "P催審管制表(" & strRptDate & ") " & _
            IIf(strFileName = "", "無需管制資料！", "資料如附件！") & _
            vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & strPS
            
         SendMAPIMail "79075", "P催審管制表(" & strRptDate & ")", strText, strFileName
      End If
   End If
   WLog "完畢   P催審管制表"
   
   'Add by Morgan 2014/11/10
   WLog "開始   FMP寰華案件催審管制表"
   '催審管制表
   'Modified by Morgan 2023/6/19 FMP寰華案改寄管制程序及其主管,沒案件就不必通知--敏莉
   'If CreateFile9("P", strRptDate, strFileName, True) = True Then
   '   strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & "FMP寰華案件催審管制表(" & strRptDate & ") " & _
   '      IIf(strFileName = "", "無需管制資料！", "資料如附件！") & _
   '      vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & strPS
   '   'modify by sonia 2016/6/28 73023改86024  2016/7/5改系統特殊設定人員
   '   'SendMAPIMail "86024", "FMP寰華案件催審管制表(" & strRptDate & ")", strText, strFileName
   '   strCC = Pub_GetSpecMan("寰華案外專程序窗口")
   '   SendMAPIMail strCC, "FMP寰華案件催審管制表(" & strRptDate & ")", strText, strFileName
   'End If
   Call CreateFile9("P", strRptDate, strFileName, True, strPS)
   'end 2023/6/19
   WLog "完畢   FMP寰華案件催審管制表"
   'end 2014/11/10
   
   WLog "開始   CFP催審管制表"
   'Modified by Morgan 2017/10/31 CFP改直接寄給承辦人--甄妮106/10/27請作單
   If CreateFile9("CFP", strRptDate, strFileName, , strPS) = True Then
      'strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & "CFP催審管制表(" & strRptDate & ") " & _
      '   IIf(strFileName = "", "無需管制資料！", "資料如附件！") & _
      '   vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & strPS
      'SendMAPIMail strCFPMan, "CFP催審管制表(" & strRptDate & ")", strText, strFileName
   End If
   WLog "完畢   CFP催審管制表"
   'end 2009/8/25
   
   'Add by Morgan 2008/6/9
   If ChkWorkDay(CompDate(2, -1, strSrvDate(1))) = True Then
      
      WLog "開始   台南所待寄客戶信函清單"
      If CreateFile5(strRptDate, strFileName) = True Then
         strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & strRptDate & "台南所" & _
            IIf(strFileName = "", "無待寄客戶信函！", "待寄客戶信函清單如附件！") & _
            vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & strPS
         SendMAPIMail "79053", "台南所待寄客戶信函清單(" & strRptDate & ")", strText, strFileName
      End If
      WLog "完畢   台南所待寄客戶信函清單"
      
      'Add by Morgan 2009/4/22
'Removed by Morgan 2020/9/21 取消(已改用原文字計算)--何淑華
'      WLog "開始   翻譯發文案件清單"
'      If CreateFile11(strRptDate, strFileName) = True Then
'         'Modified by Morgan 2012/1/16 統一用變數以方便重跑
'         'strDataDate = Format(Now - 1, "ee/mm/dd")
'         strDataDate = Format(CompDate(2, -1, strSrvDate(1)) - 19110000, "@@@/@@/@@")
'
'         strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & strDataDate & _
'            IIf(strFileName = "", " 無翻譯發文案件清單！", " 翻譯發文案件清單如附件！") & _
'            vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & strPS
'         'modify by sonia 2016/7/1 73023改86013
'         'modify by sonia 2016/7/15 86013
'         'SendMAPIMail "86013", "翻譯發文案件清單(" & strDataDate & ")", strText, strFileName
'         strCC = Pub_GetSpecMan("M")
'         SendMAPIMail strCC, "翻譯發文案件清單(" & strDataDate & ")", strText, strFileName
'      End If
'      WLog "完畢   翻譯發文案件清單"
'end 2020/9/21
      
   End If
   'end 2008/6/9
   
   'Add by Morgan 2008/6/10
   If ChkWorkDay(strSrvDate(1)) = True Then
   
      WLog "開始   C類來函未發文控管清單"
      If CreateFile6(strRptDate, strFileName) = True Then
         strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & strRptDate & _
            IIf(strFileName = "", "無C類來函未發文資料！", "C類來函未發文控管清單如附件！") & _
            vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & strPS
         SendMAPIMail "patent@taie.com.tw", "C類來函未發文控管清單(" & strRptDate & ")", strText, strFileName
      End If
      WLog "完畢   C類來函未發文控管清單"
      
      'Add by Morgan 2008/8/6
      'C類來函已會稿未發文控管清單
      WLog "開始   C類來函已會稿未發文控管清單如附件"
      strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & strRptDate & _
         "C類來函已會稿未發文控管清單如附件！" & _
         vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & strPS
      Call CreateFile7(strRptDate, strText)
      WLog "完畢   C類來函已會稿未發文控管清單如附件"
      'end 2008/8/6
      
      'Added by Morgan 2021/11/11
      '林經理2021/11/15退休，MCT案清單收受者為鄭天雲 A4021 、沈佳穎 96003 ，副本王雅雯 A2017 ；非MCT案，清單收受者為林嘉雯 84027 及林承慧 86048 ，副本王雅雯
      If strSrvDate(1) >= "20211115" Then
         WLog "開始   內商C類來函未發文控管清單-MCT案"
         If CreateFile8(strRptDate, strFileName, "Y") = True Then
            strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & strRptDate & _
               IIf(strFileName = "", "無內商C類來函未發文資料！", "內商C類來函未發文控管清單-MCT案如附件！") & _
               vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & strPS
            SendMAPIMail "A4021;96003", "內商C類來函未發文控管清單-MCT案(" & strRptDate & ")", strText, strFileName, , , "A2017"
         End If
         WLog "完畢   內商C類來函未發文控管清單-MCT案"
                  
         WLog "開始   內商C類來函未發文控管清單-非MCT案"
         If CreateFile8(strRptDate, strFileName, "N") = True Then
            strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & strRptDate & _
               IIf(strFileName = "", "無內商C類來函未發文資料！", "內商C類來函未發文控管清單-非MCT案如附件！") & _
               vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & strPS
            SendMAPIMail "84027;86048", "內商C類來函未發文控管清單-非MCT案(" & strRptDate & ")", strText, strFileName, , , "A2017"
         End If
         WLog "完畢   內商C類來函未發文控管清單-非MCT案"
         
      Else
      'end 2021/11/11
         'Add by Morgan 2008/10/20
         WLog "開始   內商C類來函未發文控管清單"
         If CreateFile8(strRptDate, strFileName) = True Then
            strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & strRptDate & _
               IIf(strFileName = "", "無內商C類來函未發文資料！", "內商C類來函未發文控管清單如附件！") & _
               vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & strPS
            'Modified by Lydia 2016/10/19 改發為林經理，並同時副本通知葉特助。
            'SendMAPIMail "67002", "內商C類來函未發文控管清單(" & strRptDate & ")", strText, strFileName
            'Modify by Amy 2020/05/05 副本取消通知葉特助
            'SendMAPIMail "69008", "內商C類來函未發文控管清單(" & strRptDate & ")", strText, strFileName, , , "67002"
            SendMAPIMail "69008", "內商C類來函未發文控管清單(" & strRptDate & ")", strText, strFileName
         End If
         WLog "完畢   內商C類來函未發文控管清單"
      End If
      
      'Add by Morgan 2010/1/25
      WLog "開始   順稿期限管制表"
      If CreateFile13("P", strRptDate, strFileName, , strPS) = True Then
         If strSrvDate(1) < P業務區劃分啟用日 Then 'Added by Morgan 2024/12/16 改業務區劃分後直接寄改管制人
         
            strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & "順稿期限管制表(" & strRptDate & ") " & _
               IIf(strFileName = "", "無需管制資料！", "資料如附件！") & _
               vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & strPS
         
            SendMAPIMail "79075", "順稿期限管制表(" & strRptDate & ")", strText, strFileName
         End If
      End If
      WLog "完畢   順稿期限管制表"
      
      'Added by Morgan 2014/11/10
      WLog "開始   FMP寰華案件順稿期限管制表"
      'Modified by Morgan 2023/6/16 FMP寰華案改寄管制程序及其主管,沒案件就不必通知--敏莉
      'If CreateFile13("P", strRptDate, strFileName, True) = True Then
      '   strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & "FMP寰華案件順稿期限管制表(" & strRptDate & ") " & _
      '      IIf(strFileName = "", "無需管制資料！", "資料如附件！") & _
      '      vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & strPS
      '   'modify by sonia 2016/6/28 73023改86024  2016/7/5改系統特殊設定人員
      '   'SendMAPIMail "86024", "FMP寰華案件順稿期限管制表(" & strRptDate & ")", strText, strFileName
      '   strCC = Pub_GetSpecMan("寰華案外專程序窗口")
      '   SendMAPIMail strCC, "FMP寰華案件順稿期限管制表(" & strRptDate & ")", strText, strFileName
      'End If
      Call CreateFile13("P", strRptDate, strFileName, True, strPS)
      'end 2023/6/16
      WLog "完畢   FMP寰華案件順稿期限管制表"
      'end 2014/11/10
      
      'Add by Morgan 2011/4/25
      'Removed by Morgan 2020/9/2 取消(改抓介紹案源)
      'WLog "開始   配合開庭尚未與法務案建立關聯案件清單"
      'If CreateFile15(strRptDate, strFileName) = True Then
      '   strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & "配合開庭尚未與法務案建立關聯案件清單(" & strRptDate & ") " & _
      '      IIf(strFileName = "", "無需管制資料！", "資料如附件！") & _
      '      vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & strPS
      '   SendMAPIMail "73022", "配合開庭尚未與法務案建立關聯案件清單(" & strRptDate & ")", strText, strFileName
      'End If
      'WLog "完畢   配合開庭尚未與法務案建立關聯案件清單"
   
      'Added by Morgan 2018/4/17
      'Add By Sindy 2021/1/21 + 增加內商通知
      WLog "開始   內專待審核帳單通知(Morgan)"
      If CreateFile20() = True Then
         WLog "完畢   內專待審核帳單通知"
      End If
      'end 2018/4/17
      
      'Added by Morgan 2024/6/26
      WLog "開始   卷宗區無客戶函清單(Morgan)"
      If CreateFile22(strRptDate, , strPS) = True Then
         WLog "完畢   卷宗區無客戶函清單"
      End If
      'end 2024/6/26
   End If
   'end 2008/6/10
   
   'Added by Morgan 2012/3/28
   '每月5號產生 TW-SUPA每月期限報表
   If Right(strSrvDate(1), 2) = "05" Then
      WLog "開始   TW-SUPA每月期限報表(Morgan)"
      strTo = Pub_GetSpecMan("A6")
      If CreateFile18(strRptDate, strFileName) = True Then
         strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & strRptDate & _
            IIf(strFileName = "", "無TW-SUPA每月期限報表資料！", "TW-SUPA每月期限報表如附件！") & _
            vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & strPS
         SendMAPIMail strTo, "TW-SUPA每月期限報表(" & strRptDate & ")", strText, strFileName
      End If
      WLog "完畢   TW-SUPA每月期限報表"
   End If
   
   'Added by Morgan 2015/12/10
   '每月1號跑台灣案B類收文"主動修正"及"修正" 件數統計給慧汶
   If Right(strSrvDate(1), 2) = "01" Then
      'Modified by Morgan 2016/11/8
      'strExc(1) = "台灣案內部收文修正及主動修正件數統計"
      strExc(1) = "台灣案內部收文修正及主動修正發文件數統計(Morgan)"
      'end 2016/11/8
      'Modified by Morgan 2016/5/3
      'strTo = "79017"
      strTo = "79075"
      'end 2016/5/3
      WLog "開始   " & strExc(1)
      Call CreateFile19(strTo, strExc(1))
      WLog "完畢   " & strExc(1)
   End If

ErrHand:

End Sub

'Added by Morgan 2015/12/10
Private Function CreateFile19(ByVal pTo As String, ByVal PTitle As String) As Boolean
   
   Dim stSQL As String, ii As Integer
   Dim stSubject As String, stContent As String, strDate As String
   Dim intArr(0 To 1) As Integer  'Added by Lydia 2018/08/16
   
   strDate = CompDate(1, -1, Left(strSrvDate(1), 6) & "01")
   stSubject = (Left(strDate, 4) - 1911) & "年" & Val(Mid(strDate, 5, 2)) & "月份" & PTitle
   
On Error GoTo ErrHandle

   'Modified by Morgan 2016/11/8
   '改發文件數且要排除同日有A類申復205發文者(抓發文日)--郭 Ex.P110704,P111879
   'Modified by Lydia 2018/08/16 SUBSTRB=>SUBSTR
   stSQL = "select st02 工程師,SUBSTR(lpad(count(*),5,' ')||' 件',1,8) 發文件數" & _
      " From caseprogress a, staff, patent" & _
      " where cp01='P' and cp27>=" & strDate & " and cp27<=" & strDate & "+30" & _
      " and cp10 in ('203','204') and cp09>'B'" & _
      " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04 and pa09='000'" & _
      " and st01(+)=cp14 and not exists(select * from caseprogress b where b.cp01=a.cp01" & _
      " and b.cp02=a.cp02 and b.cp03=a.cp03 and b.cp04=a.cp04 and b.cp10='205'" & _
      " and b.cp27=a.cp27 and b.cp09<'B')" & _
      " group by st02" & _
      " order by 2 desc,1"
   'end 2016/11/8
   If Rs.State <> adStateClosed Then Rs.Close
   With Rs
   .CursorLocation = adUseClient
   .Open stSQL, cnnConnection, adOpenForwardOnly, adLockReadOnly
   If .RecordCount > 0 Then
      'Modified by Lydia 2018/08/16 改成指定字串長度
      'stContent = convForm(.Fields(0).Name, .Fields(0).DefinedSize)
      'stContent = stContent & " " & convForm(.Fields(1).Name, .Fields(1).DefinedSize)
      'stContent = stContent & vbCrLf & String(.Fields(0).DefinedSize, "-")
      'stContent = stContent & " " & String(.Fields(1).DefinedSize, "-")
      intArr(0) = 8
      intArr(1) = 8
      stContent = convForm("" & .Fields(0).Name, intArr(0))
      stContent = stContent & " " & convForm("" & .Fields(1).Name, intArr(1))
      stContent = stContent & vbCrLf & String(intArr(0), "-")
      stContent = stContent & " " & String(intArr(1), "-")
      'end 2018/08/16
      .MoveFirst
      ii = 0
      Do While Not .EOF
          'Modified by Lydia 2018/08/16 改成指定字串長度
'         stContent = stContent & vbCrLf & convForm(.Fields(0), .Fields(0).DefinedSize)
'         stContent = stContent & " " & convForm(.Fields(1), .Fields(1).DefinedSize)
'         ii = ii + Val(.Fields(1))
         stContent = stContent & vbCrLf & convForm("" & .Fields(0), intArr(0))
         stContent = stContent & " " & convForm("" & .Fields(1), intArr(1))
         ii = ii + Val("" & .Fields(1))
         'end 2018/08/16
         .MoveNext
      Loop
      
      'Modified by Lydia 2018/08/16 改成指定字串長度
'      stContent = stContent & vbCrLf & String(.Fields(0).DefinedSize, "-")
'      stContent = stContent & " " & String(.Fields(1).DefinedSize, "-")
'      stContent = stContent & vbCrLf & convForm("共" & .RecordCount & "人", .Fields(0).DefinedSize) & " " & convForm(ii & " 件", .Fields(1).DefinedSize, , True)
      stContent = stContent & vbCrLf & String(intArr(0), "-")
      stContent = stContent & " " & String(intArr(1), "-")
      stContent = stContent & vbCrLf & convForm("共" & .RecordCount & "人", intArr(0)) & " " & convForm(ii & " 件", intArr(1), , True)
      'end 2018/08/16
      stContent = Replace(stContent, " ", "&nbsp;") '為避免後面的字型設定無效，必需手動轉空白(因tag內的空白不可轉否則無效)
      stContent = "<DIV style=""FONT: 12pt 細明體"">" & stContent & "</DIV>"
   Else
      stContent = "無符合資料!!"
   End If
   End With
   
   SendMAPIMail pTo, stSubject, stContent, , , , , , True
   CreateFile19 = True
   
   
ErrHandle:
   If Err.Number <> 0 Then
      WLog PTitle & Err.Description
   End If
   Set Rs = Nothing

End Function
'Add by Morgan 2005/10/13
'代理人案件收達管制表
'新申請案&讓與案，發文後第7天&第14天以後
'Modified by Morgan 2014/11/10 +bolIsOurFMP:是否FMP寰華案件
Private Function CreateFile1(ByVal p_Sys As String, ByVal p_RptDate As String, ByRef p_FileName As String, Optional bolIsOurFMP As Boolean, Optional p_PS As String) As Boolean
'Added by Lydia 2017/02/16 設定欄位
Dim strTitle As String    '欄位抬頭名稱
Dim strTitleLine As String '欄位抬頭底線

   Dim stSQL As String
   Dim ff As Integer
   Dim strContent As String
   Dim tmpnext As String
   Dim stPID As String
   Dim lngRecs As Long
   Dim stFileName As String
   Dim iDays As Integer
   Dim stCon As String
   Dim stCFPMailList As String, strText As String, strPIDName As String 'Added by Morgan 2017/10/31
   Dim rsQuery As ADODB.Recordset 'Added by Morgan 2020/2/21
   Dim mSeqNo As String 'Added by Lydia 2021/07/09
   Dim strFMPPID As String, strFMPPSup As String 'Added by Morgan 2023/6/21
   Dim bolPNewRule As Boolean 'Added by Morgan 2024/12/30 P案(非FMP)是否用新管制人規則
   
   p_FileName = ""
   lngRecs = 0
   stCon = ""
   
   'Added by Morgan 2024/12/30
   If p_Sys = "P" And bolIsOurFMP = False And strSrvDate(1) >= P業務區劃分啟用日 Then
      bolPNewRule = True
   Else
      bolPNewRule = False
   End If
   'end 2024/12/30
   
'Remove by Morgan 2010/1/15 不用了
'   Dim strCP10 As String
'   If p_Sys = "CFP" Then
'      'Modify by Morgan 2009/7/3 +107
'      'Modify by Morgan 2009/9/2 +118--慧汶
'      'Modify by Morgan 2009/12/2 +224 -- 禧佩
'      strCP10 = "'101','102','103','104','105','107','109','110','112','113','114','117','118','224'" & _
'         ",'301','302','303','304','305','306','307','701'"
'   Else
'      strCP10 = "'101','102','103','104','105','109','110','112','113','114','117'" & _
'         ",'301','302','303','304','305','306','307','701'"
'   End If
   
   'Add by Morgan 2010/1/15
   If p_Sys = "CFP" Then
      iDays = 14
   Else
      iDays = 7
      'Added by Morgan 2014/11/10
      If bolIsOurFMP Then
         stCon = stCon & " and exists"
      Else
         stCon = stCon & " and not exists"
      End If
      'Modified by Morgan 2015/10/26 +判斷發文人員部門為F22外專程序
      'Modified by Morgan 2018/8/28 修正發文人員部門判斷(原程式抓到承辦人)
      stCon = stCon & "(select * from caseprogress b,staff c where b.cp01=np02 and b.cp02=np03 and b.cp03=np04 and b.cp04=np05 and b.cp31='Y' and b.cp44='Y53374000' and b.cp12 like 'F%' and c.st01(+)=b.cp83 and (b.cp83 is null or c.st03='F22'))"
      'end 2015/10/26
      'end 2014/11/10
   End If
   
On Error GoTo ErrHandle


   'Modify by Morgan 2009/12/9
   'Modify by Morgan 2009/1/4 延期執行(維持原狀)
   'If Val(strSrvDate(1)) > 20091231 Then
'Modify by Morgan 2010/1/15 開始改抓NP期限管制
   'If Val(strSrvDate(1)) > 20991231 Then
      'Modify by Morgan 2010/12/17 P案的領證年費除外(另外跑報表)
      'Modify by Morgan 2016/5/20 +代理人編號,代理人排序
      'Modified by Lydia 2016/09/14 CP27=>CP158 ; CP57 IS NULL =>CP159=0
      'Modified by Lydia 2017/02/16 抓FMP管制人
      'stSQL = "SELECT ST02 C01" & _
         ",CP158-19110000 C02, CP05-19110000 C03, CP09 C04,CP01||'-'||CP02||'-'||CP03||'-'||CP04 C05" & _
         ",NVL(PA05,NVL(PA06,PA07)) C06,PTM03 C07,NA03 C08" & _
         ",DECODE(PA09,'000',CPM03,CPM04) C09" & _
         ",CP44||' '||DECODE(SK03,0,(NVL(FA04,DECODE(FA05,NULL,FA06,FA05||' '||FA63||' '||FA64||' '||FA65)))" & _
         ",(NVL(FA04,DECODE(FA05,NULL,FA06,FA05||' '||FA63||' '||FA64||' '||FA65)))) C10" & _
         "," & GetCaseIdSQL() & " PID,CP44" & _
         " FROM NEXTPROGRESS,CASEPROGRESS a,PATENT,STAFF,SYSTEMKIND,CASEPROPERTYMAP,NATION,FAGENT,PATENTTRADEMARKMAP" & _
         " WHERE NP02='" & p_Sys & "' AND NP06 IS NULL AND NP07='997'" & stCon & _
         " AND (TO_DATE(NP08,'YYYYMMDD')=TRUNC(TO_DATE(" & strSrvDate(1) & ",'YYYYMMDD')) OR TO_DATE(CP158,'YYYYMMDD')<=TRUNC(TO_DATE(" & strSrvDate(1) & ",'YYYYMMDD')-" & iDays & "))" & _
         " AND CP09(+)=NP01 AND CP01||CP10 NOT IN ('P601','P605') AND CP158>0 AND CP24 IS NULL AND CP46 IS NULL AND CP47 IS NULL AND CP159=0" & _
         " AND PA01(+)=CP01 AND PA02(+)=CP02 AND PA03(+)=CP03 AND PA04(+)=CP04 AND PA57||PA108 IS NULL" & _
         " AND ST01(+)=CP14 AND SK01(+)=CP01 AND NA01(+)=PA09" & _
         " AND CPM01(+)=CP01 AND CPM02(+)=CP10" & _
         " AND PTM01(+)='1' AND PTM02(+)=PA08" & _
         " AND FA01(+)=SUBSTR(CP44,1,8) AND FA02(+)=SUBSTR(CP44,9,1) ORDER BY PID,CP44,1,2,3,4"
      stSQL = "SELECT ST02 C01" & _
         ",CP158-19110000 C02, CP05-19110000 C03, CP09 C04,CP01||'-'||CP02||'-'||CP03||'-'||CP04 C05" & _
         ",NVL(PA05,NVL(PA06,PA07)) C06,PTM03 C07,NA03 C08" & _
         ",DECODE(PA09,'000',CPM03,CPM04) C09" & _
         ",CP44||' '||DECODE(SK03,0,(NVL(F1.FA04,DECODE(F1.FA05,NULL,F1.FA06,F1.FA05||' '||F1.FA63||' '||F1.FA64||' '||F1.FA65)))" & _
         ",(NVL(F1.FA04,DECODE(F1.FA05,NULL,F1.FA06,F1.FA05||' '||F1.FA63||' '||F1.FA64||' '||F1.FA65)))) C10" & _
         "," & GetCaseIdSQL() & " PID,CP44,NVL(F2.FA10,C1.CU10) FA10" & _
         " FROM NEXTPROGRESS,CASEPROGRESS a,PATENT,STAFF,SYSTEMKIND,CASEPROPERTYMAP,NATION,FAGENT F1,PATENTTRADEMARKMAP,CUSTOMER C1,FAGENT F2" & _
         " WHERE NP02='" & p_Sys & "' AND NP06 IS NULL AND NP07='997'" & stCon & _
         " AND (TO_DATE(NP08,'YYYYMMDD')=TRUNC(TO_DATE(" & strSrvDate(1) & ",'YYYYMMDD')) OR TO_DATE(CP158,'YYYYMMDD')<=TRUNC(TO_DATE(" & strSrvDate(1) & ",'YYYYMMDD')-" & iDays & "))" & _
         " AND CP09(+)=NP01 AND CP01||CP10 NOT IN ('P601','P605') AND CP158>0 AND CP24 IS NULL AND CP46 IS NULL AND CP47 IS NULL AND CP159=0" & _
         " AND PA01(+)=CP01 AND PA02(+)=CP02 AND PA03(+)=CP03 AND PA04(+)=CP04 AND PA57||PA108 IS NULL" & _
         " AND ST01(+)=CP14 AND SK01(+)=CP01 AND NA01(+)=PA09" & _
         " AND CPM01(+)=CP01 AND CPM02(+)=CP10" & _
         " AND PTM01(+)='1' AND PTM02(+)=PA08" & _
         " AND F1.FA01(+)=SUBSTR(CP44,1,8) AND F1.FA02(+)=SUBSTR(CP44,9,1)" & _
         " AND SUBSTR(PA75,1,8)=F2.FA01(+) AND SUBSTR(PA75,9,1)=F2.FA02(+) AND SUBSTR(PA26,1,8)=C1.CU01(+) AND SUBSTR(PA26,9,1)=C1.CU02(+)"
         
      stSQL = "SELECT  C01,C02,C03,C04,C05,C06,C07,C08,C09,C10,PID,CP44,NVL(NA79,NA16) FMP,NVL(ST02,' ') FMPMAN FROM (" & stSQL & "),NATION,STAFF WHERE FA10=NA01(+) AND NVL(NA79,NA16)=ST01(+)"
      If bolIsOurFMP Then
         stSQL = stSQL & " ORDER BY PID,FMP,CP44,1,2,3,4"
      Else
         stSQL = stSQL & " ORDER BY PID,CP44,1,2,3,4"
      End If
      'end 2017/02/16
'   Else
'      stSQL = "SELECT ST02 C01" & _
'         ",CP27-19110000 C02, CP05-19110000 C03, CP09 C04,CP01||'-'||CP02||'-'||CP03||'-'||CP04 C05" & _
'         ",NVL(PA05,NVL(PA06,PA07)) C06,PTM03 C07,NA03 C08" & _
'         ",DECODE(PA09,'000',CPM03,CPM04) C09" & _
'         ",DECODE(SK03,0,(NVL(FA04,DECODE(FA05,NULL,FA06,FA05||' '||FA63||' '||FA64||' '||FA65)))" & _
'         ",(NVL(FA04,DECODE(FA05,NULL,FA06,FA05||' '||FA63||' '||FA64||' '||FA65)))) C10" & _
'         ",decode(pa09,'000','1')||decode(instr('020,044,013',pa09),0,'','2')" & _
'         "||decode(instr('101,011,231',pa09),0,'',decode(mod(CP02,2),1,'3','4')) PID" & _
'         " FROM ( select C1.CP14,C1.CP27,C1.CP05,C1.CP09,C1.CP01,C1.CP02,C1.CP03,C1.CP04" & _
'         ",PA05,PA06,PA07,PA08,PA09,C1.CP10,C1.CP44" & _
'         " from caseprogress C1,patent" & _
'         " where C1.CP01='" & p_Sys & "' AND C1.CP46 IS NULL AND C1.CP47 IS NULL AND C1.CP24 IS NULL AND C1.CP57 IS NULL" & _
'         " AND C1.CP44>'Y' AND C1.CP27>TO_CHAR(TO_DATE(" & strSrvDate(1) & ",'YYYYMMDD')-180,'YYYYMMDD')" & _
'         " and C1.cp10 in (" & strCP10 & ")" & _
'         " and C1.cp01=pa01(+) and C1.cp02=pa02(+) and C1.cp03=pa03(+) and C1.cp04=pa04(+)" & _
'         " and pa09<>'000' and pa10 is null AND PA57 IS NULL" & _
'         " AND TO_DATE(C1.CP27,'YYYYMMDD')<=TO_DATE(" & strSrvDate(1) & ",'YYYYMMDD')-7" & _
'         " AND ( TO_DATE(C1.CP27,'YYYYMMDD')=TRUNC(TO_DATE(" & strSrvDate(1) & ",'YYYYMMDD'))-7" & _
'         " OR TO_DATE(C1.CP27,'YYYYMMDD')<=TO_DATE(" & strSrvDate(1) & ",'YYYYMMDD')-14 )" & _
'         " ) X,STAFF,SYSTEMKIND,CASEPROPERTYMAP,NATION,FAGENT,PATENTTRADEMARKMAP" & _
'         " WHERE ST01(+)=CP14 AND SK01(+)=CP01 AND NA01(+)=PA09" & _
'         " AND CPM01(+)=CP01 AND CPM02(+)=CP10" & _
'         " AND PTM01(+)='1' AND PTM02(+)=PA08" & _
'         " AND FA01(+)=SUBSTR(CP44,1,8) AND FA02(+)=SUBSTR(CP44,9,1) ORDER BY PID,1,2,3,4"
'   End If
     
   'Modified by Morgan 2020/2/21 CFP管制人 109/4/1以後改業務區劃分
   'If rs.State <> adStateClosed Then rs.Close
   'With rs
   '   .CursorLocation = adUseClient
   '   .Open stSQL, cnnConnection, adOpenForwardOnly, adLockReadOnly
   intI = 1
   Set Rs = ClsLawReadRstMsg(intI, stSQL)
   'Modified by Lydia 2020/03/05 改成常數
   'If p_Sys = "CFP" And strSrvDate(1) >= 20200401 Then
   'Modified by Morgan 2024/12/27 +bolPNewRule
   'If (p_Sys = "CFP" And strSrvDate(1) >= CFP業務區劃分啟用日) Then
   If p_Sys = "CFP" Or bolPNewRule Then
   'end 2024/12/30
      If intI = 1 Then
         'Modified by Lydia 2021/07/09 取得序號mSeqNo
         Set rsQuery = PUB_CreateRecordset(Rs, , , 300, Me.Name, mSeqNo)
         With rsQuery
         .MoveFirst
         Do While Not .EOF
            'Added by Morgan 2024/12/30
            If p_Sys = "P" Then
               .Fields("PID") = PUB_GetPHandler(.Fields("C05"))
            Else
            'end 2024/12/30
            
               .Fields("PID") = PUB_GetCFPHandler(.Fields("C05"))
            End If
            .MoveNext
         Loop
         .UpdateBatch 'Added by Lydia 2021/07/09
         '.Sort = "PID,CP44,C01,C02,C03,C04" 'Remove by Lydia 2021/07/09
         End With
         'Added by Lydia 2021/07/09 重新查詢; 因為出現錯誤「無法在其定義長度是不明或過長的資料行執行 Relate、Compute By、及 Sort 操作。」
         strSql = "Select R001 As C01,R002 As C02, R003 As C03, R004 As C04,R005 As C05,R006 As C06, R007 As C07, R008 As C08, R009 As C09," & _
                     "R010 As C10, R011 As PID, R012 As CP44, R013 As FMP, R014 As FMPMAN " & _
                     "From Rdatafactory Where Id='" & strUserNum & "' And Formname='" & Me.Name & "'  And Seqno='" & mSeqNo & "' " & _
                     "ORDER BY PID,CP44,C01,C02,C03,C04 "
         intI = 1
         Set rsQuery = ClsLawReadRstMsg(intI, strSql)
         'end 2021/07/09
      Else
         Set rsQuery = Rs
      End If
   Else
      Set rsQuery = Rs
   End If
   With rsQuery
   'end 2020/2/21
      If .RecordCount > 0 Then
         .MoveFirst
         stPID = "" & .Fields("pid")
         'Added by Morgan 2023/6/21
         If bolIsOurFMP Then
            strFMPPID = "" & .Fields("FMP")
            strPIDName = "" & .Fields("FMPMAN")
         Else
         'end 2023/6/21
            strPIDName = GetPIDName(stPID) 'Added by Morgan 2017/10/31
         End If 'Added by Morgan 2023/6/21
         
         If ff > 0 Then Close #ff
         ff = FreeFile
         'Modify By Sindy 2009/06/04
         'stFileName = "C:\" & p_Sys & "代理人案件收達管制表(" & GetPIDName(stPID) & ").txt"
         'Added by Morgan 2014/11/10
         If bolIsOurFMP Then
            stFileName = App.path & TextPath & "FMP寰華案件代理人案件收達管制表(" & strPIDName & ").txt"
            'Added by Lydia 2017/02/16 設定欄位
                strTitle = "管制人 承辦人 發文日    收文日    收文號    本所案號        案件名稱                 種類   申請國家 案件性質   代理人    "
            strTitleLine = "------ ------ --------- --------- --------- --------------- ------------------------ ------ -------- ---------- --------------------"
            'end 2017/02/16
         Else
         'end 2014/11/10
            stFileName = App.path & TextPath & p_Sys & "代理人案件收達管制表(" & strPIDName & ").txt"
            'Added by Lydia 2017/02/16 設定欄位
                strTitle = "承辦人 發文日    收文日    收文號    本所案號        案件名稱                 種類   申請國家 案件性質   代理人    "
            strTitleLine = "------ --------- --------- --------- --------------- ------------------------ ------ -------- ---------- --------------------"
            'end 2017/02/16
         End If 'Added by Morgan 2014/11/10
         '2009/06/04 End
         Open stFileName For Output As ff
         'Added by Lydia 2016/10/19 加報表抬頭
         Print #ff, Space(40) & IIf(bolIsOurFMP = True, "FMP寰華案件代理人案件收達管制表(" & strPIDName & ")", p_Sys & "代理人案件收達管制表(" & strPIDName & ")")
         Print #ff, ""
         'end 2016/10/19
                      
         Print #ff, ""
         Print #ff, "日期：" & p_RptDate
         Print #ff, ""
         'Modified by by Lydia 2017/02/16 設定欄位
         'Print #ff, "承辦人 發文日    收文日    收文號    本所案號        案件名稱                 種類   申請國家 案件性質   代理人    "
         'Print #ff, "------ --------- --------- --------- --------------- ------------------------ ------ -------- ---------- --------------------"
         Print #ff, strTitle
         Print #ff, strTitleLine
         'end 2017/02/16
         
         tmpnext = "開檔中..."
         Do While Not .EOF
            'Modified by Morgan 2023/6/21
            'If stPID <> "" & .Fields("pid") Then
            If stPID <> "" & .Fields("pid") Or (bolIsOurFMP And strFMPPID <> "" & .Fields("FMP")) Then
            'end 2023/6/21
               'Modified by by Lydia 2017/02/16 設定欄位
               'Print #ff, "------ --------- --------- --------- --------------- ------------------------ ------ -------- ---------- --------------------"
               Print #ff, strTitleLine
               'end 2017/02/16
               Print #ff, "共" & lngRecs & "筆"
               Close ff
               p_FileName = p_FileName & stFileName & ";"
               
               'Added by Morgan 2017/10/31 CFP改直接寄給承辦人--甄妮106/10/27請作單
               If p_Sys = "CFP" Then
                  strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & _
                     p_Sys & "代理人案件收達管制表(" & p_RptDate & ")(" & strPIDName & ") 資料如附件！" & _
                     vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & p_PS
                  SendMAPIMail stPID, p_Sys & "代理人案件收達管制表(" & p_RptDate & ")(" & strPIDName & ")", strText, stFileName
                  stCFPMailList = stCFPMailList & stPID & ";"
               
               'Added by Morgan 2023/6/21
               ElseIf bolIsOurFMP Then
                  strFMPPSup = PUB_GetFCPProSup(strFMPPID)
                  strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & _
                     "FMP寰華案件代理人案件收達管制表(" & p_RptDate & ")(" & strPIDName & ") 資料如附件！" & _
                     vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & p_PS
                  SendMAPIMail strFMPPID, "FMP寰華案件代理人案件收達管制表(" & p_RptDate & ")(" & strPIDName & ")", strText, stFileName, , , strFMPPSup
               'end 2023/6/21
               
               End If
               'end 2017/10/31
               
               lngRecs = 0
               stPID = "" & .Fields("pid")
               'Added by Morgan 2023/6/21
               If bolIsOurFMP Then
                  strFMPPID = "" & .Fields("FMP")
                  strPIDName = "" & .Fields("FMPMAN")
               Else
               'end 2023/6/21
                  strPIDName = GetPIDName(stPID) 'Added by Morgan 2017/10/31
               End If 'Added by Morgan 2023/6/21
               
               If ff > 0 Then Close #ff
               ff = FreeFile
               'Modify By Sindy 2009/06/04
               'stFileName = "C:\" & p_Sys & "代理人案件收達管制表(" & strPIdName & ").txt"
               'Added by Morgan 2014/11/10
               If bolIsOurFMP Then
                  stFileName = App.path & TextPath & "FMP寰華案件代理人案件收達管制表(" & strPIDName & ").txt"
               Else
               'end 2014/11/10
                  stFileName = App.path & TextPath & p_Sys & "代理人案件收達管制表(" & strPIDName & ").txt"
               End If 'Added by Morgan 2014/11/10
               '2009/06/04 End
               Open stFileName For Output As ff
                'Added by Lydia 2016/10/19 加報表抬頭
                Print #ff, Space(40) & IIf(bolIsOurFMP = True, "FMP寰華案件代理人案件收達管制表(" & strPIDName & ")", p_Sys & "代理人案件收達管制表(" & strPIDName & ")")
                Print #ff, ""
                'end 2016/10/19
                
               Print #ff, ""
               Print #ff, "日期：" & p_RptDate
               Print #ff, ""
               'Modified by by Lydia 2017/02/16 設定欄位
               'Print #ff, "承辦人 發文日    收文日    收文號    本所案號        案件名稱                 種類   申請國家 案件性質   代理人    "
               'Print #ff, "------ --------- --------- --------- --------------- ------------------------ ------ -------- ---------- --------------------"
               Print #ff, strTitle
               Print #ff, strTitleLine
               'end 2017/02/16
            End If
            lngRecs = lngRecs + 1
            strContent = ""
            'Added by Lydia 2017/02/16 +管制人
            If bolIsOurFMP Then
               strContent = strContent & convForm("" & .Fields("FMPMAN"), 6) & " " '管制人
            End If
            'end 2017/02/16
            strContent = strContent & convForm("" & .Fields("C01"), 6) '承辦人
            strContent = strContent & " " & Format(.Fields("C02"), "@@@/@@/@@") '發文日
            strContent = strContent & " " & Format(.Fields("C03"), "@@@/@@/@@") '收文日
            strContent = strContent & " " & convForm(.Fields("C04"), 9) '收文號
            strContent = strContent & " " & convForm(.Fields("C05"), 15) '本所案號
            strContent = strContent & " " & convForm("" & .Fields("C06"), 24) '案件名稱
            strContent = strContent & " " & convForm("" & .Fields("C07"), 6) '種類
            strContent = strContent & " " & convForm("" & .Fields("C08"), 8) '申請國家
            strContent = strContent & " " & convForm("" & .Fields("C09"), 10) '案件性質
            'Modified by Morgan 2014/9/9 有可能沒有代理人(美國中間接的案子延期發文), Ex.CFP-27141
            strContent = strContent & " " & convForm("" & .Fields("C10"), 20) '代理人
            tmpnext = "寫檔..."
            Print #ff, strContent
            .MoveNext
         Loop
         'Modified by by Lydia 2017/02/16 設定欄位
         'Print #ff, "------ --------- --------- --------- --------------- ------------------------ ------ -------- ---------- --------------------"
         Print #ff, strTitleLine
         'end 2017/02/16
         Print #ff, "共" & lngRecs & "筆"
         Close ff
         p_FileName = p_FileName & stFileName
         
         'Added by Morgan 2017/10/31 CFP改直接寄給承辦人--甄妮106/10/27請作單
         'Modified by Morgan 2024/12/30 +bolPNewRule
         If p_Sys = "CFP" Or bolPNewRule Then
            strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & _
               p_Sys & "代理人案件收達管制表(" & p_RptDate & ")(" & strPIDName & ") 資料如附件！" & _
               vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & p_PS
            SendMAPIMail stPID, p_Sys & "代理人案件收達管制表(" & p_RptDate & ")(" & strPIDName & ")", strText, stFileName
            stCFPMailList = stCFPMailList & stPID & ";"
            
         'Added by Morgan 2023/6/21
         ElseIf bolIsOurFMP Then
            strFMPPSup = PUB_GetFCPProSup(strFMPPID)
            strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & _
               "FMP寰華案件代理人案件收達管制表(" & p_RptDate & ")(" & strPIDName & ") 資料如附件！" & _
               vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & p_PS
            SendMAPIMail strFMPPID, "FMP寰華案件代理人案件收達管制表(" & p_RptDate & ")(" & strPIDName & ")", strText, stFileName, , , strFMPPSup
         'end 2023/6/21
         End If
         'end 2017/10/31
         
         'MsgBox "資料寫入完畢！"
      Else
         'MsgBox "無符合資料！"
      End If
   End With
   
   'Added by Morgan 2017/10/31 CFP改直接寄給承辦人--甄妮106/10/27請作單
   'Modified by Morgan 2024/12/30 +bolPNewRule
   'If p_Sys = "CFP" Then
   '   stSQL = "select na73 from nation union select na74 from nation order by 1"
   '   'Added by Morgan 2020/2/21
   '   If strSrvDate(1) >= 20200401 Then
   '      stSQL = "select distinct a0916 from acc090 order by 1"
   '   End If
   '   'end 2020/2/21
   If p_Sys = "CFP" Or bolPNewRule Then
      If p_Sys = "CFP" Then
         stSQL = "select distinct a0916 from acc090 where a0916 is not null order by 1"
      Else
         stSQL = "select distinct a0917 from acc090 where a0917 is not null order by 1"
      End If
      
      If Rs.State <> adStateClosed Then Rs.Close
      With Rs
      .CursorLocation = adUseClient
      .Open stSQL, cnnConnection, adOpenForwardOnly, adLockReadOnly
      If .RecordCount > 0 Then
         Do While Not .EOF
            If Not IsNull(.Fields(0)) Then
               stPID = .Fields(0)
               If InStr(stCFPMailList, stPID) = 0 Then
                  strPIDName = GetPIDName(stPID)
                 'Modified by Morgan 2024/12/30
                  'strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & _
                     p_Sys & "代理人案件收達管制表(" & p_RptDate & ")(" & strPIdName & ") 無需管制資料！" & _
                     vbCrLf & vbCrLf & String(25, "　") & "電腦中心"
                  'SendMAPIMail stPID, "CFP代理人案件收達管制表(" & p_RptDate & ")(" & strPIdName & ")", strText
                  SendMAPIMail stPID, p_Sys & "代理人案件收達管制表(" & p_RptDate & ")(" & strPIDName & ") 無需管制資料！", "如旨"
                  'end 2024/12/30
               End If
            End If
            .MoveNext
         Loop
      End If
      
      
      End With
   End If
   'end 2017/10/31
      
   CreateFile1 = True
   Set rsQuery = Nothing 'Added by Morgan 2020/2/21
   Exit Function
   
ErrHandle:
   WLog tmpnext & " " & Err.Description
   Set rsQuery = Nothing 'Added by Morgan 2020/2/21
End Function

'Removed by Morgan 2014/12/10 不再使用
''Add by Morgan 2005/10/13
''代理人案件提申管制表
''新申請案&讓與案，發文後第15(45)天&第一次後每15天&第90天以後-->抓國家檔設定
'Private Function CreateFile2(ByVal p_Sys As String, ByVal p_RptDate As String, ByRef p_FileName As String) As Boolean
'程式碼已刪除
'End Function

'Add by Morgan 2006/10/12
'准予延緩公告來函管制表
'系統日>=預定公告日-5天
Private Function CreateFile3(ByVal p_RptDate As String, ByRef p_FileName As String, ByVal p_PS As String) As Boolean
   
   Dim stSQL As String
   Dim ff As Integer
   Dim strContent As String
   Dim tmpnext As String
   Dim stVTB0 As String
   'Added by Morgan 2025/1/7
   Dim rsQuery As ADODB.Recordset
   Dim lngRecs As Long
   Dim mSeqNo As String, stPID As String, strPIDName As String, stMailList As String
   Dim stFileName As String, strText As String, strTitle As String
   'end 2025/1/7
   
   p_FileName = ""
   
On Error GoTo ErrHandle
   
   stVTB0 = "select PA01,PA02,PA03,PA04,PA11,a.cp27 cp27a,a.cp71,b.cp27 cp27b, decode(length(a.cp71),8,a.cp71,7,a.cp71+19110000,1,GetPrePA14(b.cp27,a.cp71)) pa14x" & _
      " from caseprogress a, caseprogress b, patent" & _
      " where a.cp01='P' and a.cp10='412' and a.cp27>" & (strSrvDate(1) - 10000) & _
      " and b.cp01(+)=a.cp01 and b.cp02(+)=a.cp02 and b.cp03(+)=a.cp03 and b.cp04(+)=a.cp04 and b.cp10='601'" & _
      " and pa01(+)=a.cp01 and pa02(+)=a.cp02 and pa03(+)=a.cp03 and pa04(+)=a.cp04 and pa14 is null" & _
      " and not exists(select * from caseprogress c where c.cp43=a.cp09 and c.cp10='1906')"
  
  'Modified by Morgan 2025/1/7 +PID
   stSQL = "select PA01||'-'||PA02||'-'||PA03||'-'||PA04 C1, PA11 C2, cp27a-19110000 C3, pa14x-19110000 C4, cp27b-19110000 C5, cp71 C6,'' PID" & _
      " from (" & stVTB0 & ") X where GETWORKDATE(to_char(to_date(pa14x,'yyyymmdd')-5,'yyyymmdd'))<=" & strSrvDate(1)
   
   If Rs.State <> adStateClosed Then Rs.Close
   Rs.CursorLocation = adUseClient
   Rs.Open stSQL, cnnConnection, adOpenForwardOnly, adLockReadOnly
   If Rs.RecordCount > 0 Then
   
      'Added by Morgan 2025/1/7
      If strSrvDate(1) >= P業務區劃分啟用日 Then
         Set rsQuery = PUB_CreateRecordset(Rs, , , 300, Me.Name, mSeqNo)
         With rsQuery
            .MoveFirst
            Do While Not .EOF
               .Fields("PID") = PUB_GetPHandler(.Fields("C1"))
               .MoveNext
            Loop
            .UpdateBatch
            
            stVTB0 = "select R001 as " & .Fields(0).Name
            For intI = 2 To .Fields.Count
               stVTB0 = stVTB0 & ", R" & Format(intI, "000") & " as " & .Fields(intI - 1).Name
            Next
            stVTB0 = stVTB0 & " from Rdatafactory Where Id='" & strUserNum & "' And Formname='" & Me.Name & "'  And Seqno='" & mSeqNo & "'"
         End With
         stSQL = "Select X.* From (" & stVTB0 & ") X order by PID,C1"
         intI = 1
         Set Rs = ClsLawReadRstMsg(intI, stSQL)
      End If
      'end 2025/1/7
      
      With Rs
         .MoveFirst
         
         'Modified by Morgan 2025/1/8
         ''Modify By Sindy 2009/06/04
         ''p_FileName = "C:\" & "准予延緩公告來函管制表.txt"
         'p_FileName = App.path & TextPath & "准予延緩公告來函管制表.txt"
         ''2009/06/04 End
         strTitle = "准予延緩公告來函管制表"
         If strSrvDate(1) >= P業務區劃分啟用日 Then
            stPID = "" & .Fields("pid")
            strPIDName = GetPIDName(stPID)
            strTitle = strTitle & "(" & strPIDName & ")"
         Else
            strTitle = "准予延緩公告來函管制表"
         End If
         stFileName = App.path & TextPath & strTitle & ".txt"
         p_FileName = p_FileName & stFileName & ";"
         lngRecs = 0
         'end 2025/1/8
         
         If ff > 0 Then Close #ff
         ff = FreeFile
         'Modified by Morgan 2025/1/8
         'Open p_FileName For Output As ff
         Open stFileName For Output As ff
         'end 2025/1/8
         'Added by Lydia 2016/10/19 加報表抬頭
         'Modified by Morgan 2025/1/8
         'Print #ff, Space(25) & "准予延緩公告來函管制表"
         Print #ff, Space(25) & strTitle
         'end 2025/1/8
         'end 2016/10/19
         
         Print #ff, ""
         Print #ff, "日期：" & p_RptDate
         Print #ff, ""
         Print #ff, "本所案號        申請案號     延緩公告發文日 預定公告日 領證發文日 延緩公告月數/日期"
         Print #ff, "--------------- ------------ -------------- ---------- ---------- -----------------"
         tmpnext = "開檔中..."
         Do While Not .EOF
            'Added by Morgan 2025/1/8
            If stPID <> "" & .Fields("pid") Then
               Print #ff, "--------------- ------------ -------------- ---------- ---------- -----------------"
               Print #ff, "共" & lngRecs & "筆"
               Close ff
            
               strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & _
                  "准予延緩公告來函管制表(" & p_RptDate & ")(" & strPIDName & ") 資料如附件！" & _
                  vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & p_PS
               SendMAPIMail stPID, "准予延緩公告來函管制表(" & p_RptDate & ")(" & strPIDName & ")", strText, stFileName
               stMailList = stMailList & stPID & ";"
               
               strTitle = "准予延緩公告來函管制表"
               stPID = "" & .Fields("pid")
               strPIDName = GetPIDName(stPID)
               strTitle = strTitle & "(" & strPIDName & ")"
               stFileName = App.path & TextPath & strTitle & ".txt"
               p_FileName = p_FileName & stFileName & ";"
               lngRecs = 0
         
               If ff > 0 Then Close #ff
               ff = FreeFile
               Open stFileName For Output As ff
               Print #ff, Space(25) & strTitle
               
               Print #ff, ""
               Print #ff, "日期：" & p_RptDate
               Print #ff, ""
               Print #ff, "本所案號        申請案號     延緩公告發文日 預定公告日 領證發文日 延緩公告月數/日期"
               Print #ff, "--------------- ------------ -------------- ---------- ---------- -----------------"
            End If
            'end 2025/1/8
            
            strContent = Empty
            strContent = strContent & convForm(.Fields("C1"), 15) '本所案號
            strContent = strContent & " " & convForm(.Fields("C2"), 12) '申請案號
            strContent = strContent & " " & convForm(Format(.Fields("C3"), "@@@/@@/@@"), 14) '延緩公告發文日
            strContent = strContent & " " & convForm(Format(.Fields("C4"), "@@@/@@/@@"), 10) '預定公告日
            strContent = strContent & " " & convForm(Format(.Fields("C5"), "@@@/@@/@@"), 10) '領證發文日
            strContent = strContent & " " & convForm(.Fields("C6"), 17) '延緩公告月數/日期
            
            tmpnext = "寫檔..."
            Print #ff, strContent
            lngRecs = lngRecs + 1 'Added by Morgan 2025/1/8
            .MoveNext
         Loop
         Print #ff, "--------------- ------------ -------------- ---------- ---------- -----------------"
         'Modified by Morgan 2025/1/8
         'Print #ff, "共" & .RecordCount & "筆"
         Print #ff, "共" & lngRecs & "筆"
         'end 2025/1/8
         Close ff
      End With
      
      'Added by Morgan 2025/1/8
      If strSrvDate(1) >= P業務區劃分啟用日 Then
         strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & _
            "准予延緩公告來函管制表(" & p_RptDate & ")(" & strPIDName & ") 資料如附件！" & _
            vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & p_PS
         SendMAPIMail stPID, "准予延緩公告來函管制表(" & p_RptDate & ")(" & strPIDName & ")", strText, stFileName
         stMailList = stMailList & stPID & ";"
         stFileName = ""
      End If
      'end 2025/1/8
   End If
   
   'Added by Morgan 2025/1/8
   If strSrvDate(1) >= P業務區劃分啟用日 Then
      stSQL = "select distinct a0917 from acc090 where a0917 is not null order by 1"
      intI = 1
      Set Rs = ClsLawReadRstMsg(intI, stSQL)
      If intI = 1 Then
         With Rs
         Do While Not .EOF
            If Not IsNull(.Fields(0)) Then
               stPID = .Fields(0)
               If InStr(stMailList, stPID) = 0 Then
                  strPIDName = GetPIDName(stPID)
                  SendMAPIMail stPID, "准予延緩公告來函管制表(" & p_RptDate & ")(" & strPIDName & ") 無需管制資料！", "如旨"
               End If
            End If
            .MoveNext
         Loop
         End With
      End If
   End If
   'end 2025/1/8
   
   CreateFile3 = True
   Set rsQuery = Nothing 'Added by Morgan 2025/1/7
   Exit Function
   
ErrHandle:
   WLog tmpnext & " " & Err.Description
   Set rsQuery = Nothing 'Added by Morgan 2025/1/7
End Function

'Add by Morgan 2007/8/16
'受理通知書未收達管制表
'非台灣案,申請日超過三個月未收到副本
'Modify by Morgan 2009/6/8
'CFP也要控管但判斷無申請號且要依程序管制規則分開
'Modified by Morgan 2014/11/10 +bolIsOurFMP:是否FMP寰華案件
Private Function CreateFile4(ByVal p_Sys As String, ByVal p_RptDate As String, ByRef p_FileName As String, Optional bolIsOurFMP As Boolean, Optional p_PS As String) As Boolean
   
   Dim stSQL As String
   Dim ff As Integer
   Dim strContent As String
   Dim tmpnext As String
   Dim stCon As String, stRptFileName As String
   Dim stPID As String
   Dim lngRecs As Long
   Dim stFileName As String
   Dim stVTB As String
   'Added by Lydia 2017/02/16 設定欄位
   Dim strTitle As String    '欄位抬頭名稱
   Dim strTitleLine As String '欄位抬頭底線
   Dim stCFPMailList As String, strText As String, strPIDName As String 'Added by Morgan 2017/10/31
   Dim rsQuery As ADODB.Recordset 'Added by Morgan 2020/2/21
   Dim mSeqNo As String 'Added by Lydia 2021/07/09
   Dim strFMPPID As String, strFMPPSup As String 'Added by Morgan 2023/6/20
   Dim bolPNewRule As Boolean 'Added by Morgan 2025/1/8 P案(非FMP)是否用新管制人規則
   
   p_FileName = ""
   lngRecs = 0
   stCon = ""
   
   'Added by Morgan 2025/1/8
   If p_Sys = "P" And bolIsOurFMP = False And strSrvDate(1) >= P業務區劃分啟用日 Then
      bolPNewRule = True
   Else
      bolPNewRule = False
   End If
   'end 2025/1/8
   
   
   If p_Sys = "P" Then
      'Added by Morgan 2014/11/10
      If bolIsOurFMP Then
         stCon = stCon & " and exists"
      Else
         stCon = stCon & " and not exists"
      End If
      'Modified by Morgan 2015/10/26 +判斷發文人員部門為F22外專程序
      'Modified by Morgan 2018/8/28 修正發文人原部門判斷(原程式抓到承辦人)
      stCon = stCon & "(select * from caseprogress c,staff d where c.cp01=b.cp01 and c.cp02=b.cp02 and c.cp03=b.cp03 and c.cp04=b.cp04 and c.cp31='Y' and c.cp44='Y53374000' and c.cp12 like 'F%' and d.st01(+)=c.cp83 and (c.cp83 is null or d.st03='F22'))"
      'end 2015/10/26
      'end 2014/11/10
      
      'Modified by Morgan 2024/12/17 加副本(中間程序)以免程序不請處，因申請程序才會有官方的受理通知書。
      'stRptFileName = "受理通知書未收達管制表"
      stRptFileName = "受理通知書(副本)未收達管制表"
      'end 2024/12/17
      'Modified by Morgan 2012/2/10 是否已收副本取消 pa140 改放 cp145 因為非新案的案件性質也可能有副本,另加案件性質 203,204,205,107,803,804
      'stCon = " and pa140 is null"
      'stVTB = "select pa01 X01,pa02 X02,pa03 X03,pa04 X04,substrb(max(cp27||cp09),9) X05" & _
         " from patent A,caseprogress B where pa01='" & p_Sys & "' and pa04='00' and pa09<>'000'" & stCon & _
         " and pa10>" & (strSrvDate(1) - 10000) & " and pa09 not in ('102','018','117') and cp01(+)=pa01 and cp02(+)=pa02 and cp03(+)=pa03 and cp04(+)=pa04" & _
         " AND CP57 IS NULL AND CP44>'Y' and cp27>0 AND cp47<TO_CHAR(ADD_MONTHS(TO_DATE(" & strSrvDate(1) & ",'YYYYMMDD'),-3),'YYYYMMDD')" & _
         " and cp10 in ('101','102','103','104','105','109','110','112','113','114','117','301','302','303','304','305'" & _
         ",'306','307') group by pa01,pa02,pa03,pa04"
      'Modified by Morgan 2012/10/15 已有准駁也不再列
      'Modified by Morgan 2013/4/16 +503 行政訴訟
      'Modified by Morgan 2014/3/4 +新申請程序改2個月,後續程序改1個月
      'stVTB = "select cp01 X01,cp02 X02,cp03 X03,cp04 X04,cp09 X05" & _
         " from caseprogress B,patent A" & _
         " where cp01='" & p_Sys & "' and cp04='00' and cp24||cp145||cp57 is null and cp27>" & (strSrvDate(1) - 10000) & _
         " AND CP44>'Y'" & _
         " AND cp47<TO_CHAR(ADD_MONTHS(TO_DATE(" & strSrvDate(1) & ",'YYYYMMDD'),-3),'YYYYMMDD')" & _
         " and cp10 in ('101','102','103','104','105','109','110','112','113','114','117','301'" & _
         ",'302','303','304','305','306','307','203','204','205','107','803','804','503')" & _
         " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04 and pa09<>'000'"
      'Modified by Morgan 2020/3/6 統一改1個月--玲玲 decode(instr('" & NewCasePtyList & "',cp10),0,-1,-2)
      stVTB = "select cp01 X01,cp02 X02,cp03 X03,cp04 X04,cp09 X05" & _
         " from caseprogress B,patent A" & _
         " where cp01='" & p_Sys & "' and cp04='00' and cp24||cp145||cp57 is null and cp27>" & (strSrvDate(1) - 10000) & stCon & _
         " AND CP44>'Y'" & _
         " AND cp47<TO_CHAR(ADD_MONTHS(TO_DATE(" & strSrvDate(1) & ",'YYYYMMDD'),-1),'YYYYMMDD')" & _
         " and cp10 in ('101','102','103','104','105','109','110','112','113','114','117','301'" & _
         ",'302','303','304','305','306','307','203','204','205','107','803','804','503')" & _
         " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04 and pa09<>'000'"
      'Added by Lydia 2015/04/21 + P案非台灣案繳年費605,請增加副本收達控管(CP46-3個月)
      'Modified by Morgan 2017/8/30 改2個月
      'Modified by Morgan 2020/3/6 改1個月--玲玲
      stVTB = stVTB & " union all select cp01 X01,cp02 X02,cp03 X03,cp04 X04,cp09 X05" & _
         " from caseprogress B,patent A" & _
         " where cp01='" & p_Sys & "' and cp04='00' and cp24||cp145||cp57 is null and cp27>" & (strSrvDate(1) - 10000) & stCon & _
         " AND CP44>'Y'" & _
         " AND cp46<TO_CHAR(ADD_MONTHS(TO_DATE(" & strSrvDate(1) & ",'YYYYMMDD'),-1),'YYYYMMDD') and cp10='605' " & _
         " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04 and pa09<>'000'"
   Else
      stRptFileName = "已提申3個月尚無申請號管制表"
      
      stCon = " and pa11 is null"
      'Modify by Morgan 2009/9/3 加拿大及馬來西亞改4個月
      'Modify by Morgan 2010/6/14 巴西改6個月
      'Modified by Lydia 2016/09/14  CP57 IS NULL AND CP44>'Y' and cp27>0= > CP44>'Y' AND CP158>0 AND CP159=0 ; substrb(max(cp27||cp09),9) => substrb(max(cp158||cp09),9)
      'Modified by Lydia 2018/08/16 SUBSTRB=>SUBSTR
      stVTB = "select pa01 X01,pa02 X02,pa03 X03,pa04 X04,SUBSTR(max(cp158||cp09),9) X05" & _
         " from patent A,caseprogress B where pa01='" & p_Sys & "' and pa04='00' and pa09<>'000'" & stCon & _
         " and pa10>" & (strSrvDate(1) - 10000) & " and pa09 not in ('102','018','117') and cp01(+)=pa01 and cp02(+)=pa02 and cp03(+)=pa03 and cp04(+)=pa04" & _
         " AND CP44>'Y' AND CP158>0 AND CP159=0 AND cp47<TO_CHAR(ADD_MONTHS(TO_DATE(" & strSrvDate(1) & ",'YYYYMMDD'),-3),'YYYYMMDD')" & _
         " and cp10 in ('101','102','103','104','105','109','110','112','113','114','117','301','302','303','304','305'" & _
         ",'306','307') group by pa01,pa02,pa03,pa04" & _
         " union all" & _
         " select pa01 X01,pa02 X02,pa03 X03,pa04 X04,SUBSTR(max(cp158||cp09),9) X05" & _
         " from patent A,caseprogress B where pa01='" & p_Sys & "' and pa04='00' and pa09<>'000'" & stCon & _
         " and pa10>" & (strSrvDate(1) - 10000) & " and pa09 in ('102','018') and cp01(+)=pa01 and cp02(+)=pa02 and cp03(+)=pa03 and cp04(+)=pa04" & _
         " AND CP44>'Y' AND CP158>0 AND CP159=0 AND cp47<TO_CHAR(ADD_MONTHS(TO_DATE(" & strSrvDate(1) & ",'YYYYMMDD'),-4),'YYYYMMDD')" & _
         " and cp10 in ('101','102','103','104','105','109','110','112','113','114','117','301','302','303','304','305'" & _
         ",'306','307') group by pa01,pa02,pa03,pa04" & _
         " union all" & _
         " select pa01 X01,pa02 X02,pa03 X03,pa04 X04,SUBSTR(max(cp158||cp09),9) X05" & _
         " from patent A,caseprogress B where pa01='" & p_Sys & "' and pa04='00' and pa09<>'000'" & stCon & _
         " and pa10>" & (strSrvDate(1) - 10000) & " and pa09 in ('117') and cp01(+)=pa01 and cp02(+)=pa02 and cp03(+)=pa03 and cp04(+)=pa04" & _
         " AND CP44>'Y' AND CP158>0 AND CP159=0 AND cp47<TO_CHAR(ADD_MONTHS(TO_DATE(" & strSrvDate(1) & ",'YYYYMMDD'),-6),'YYYYMMDD')" & _
         " and cp10 in ('101','102','103','104','105','109','110','112','113','114','117','301','302','303','304','305'" & _
         ",'306','307') group by pa01,pa02,pa03,pa04"
      
   End If
   
On Error GoTo ErrHandle

   'Modify by Morgan 2008/4/21 701拿掉--敏惠
   'Added by Lydia 2015/04/21 + P案非台灣案繳年費605,請增加副本收達控管(CP46-3個月),其他以提申日控管
   'Modify by Morgan 2016/5/20 +代理人編號,代理人排序
   'Modified by Lydia 2017/02/16 抓FMP管制人
   'stSQL = "SELECT ST02 C01" & _
      ",decode(CP10,'605',CP46-19110000,CP47-19110000) C02, CP27-19110000 C03, CP09 C04,CP01||'-'||CP02||'-'||CP03||'-'||CP04 C05" & _
      ",NVL(PA05,NVL(PA06,PA07)) C06,PTM03 C07,NA03 C08" & _
      ",DECODE(PA09,'000',CPM03,CPM04) C09" & _
      ",CP44||' '||NVL(FA04,DECODE(FA05,NULL,FA06,FA05||' '||FA63||' '||FA64||' '||FA65)) C10" & _
      "," & GetCaseIdSQL() & " PID,CP44" & _
      " FROM (" & stVTB & ") X,PATENT,CASEPROGRESS,STAFF,SYSTEMKIND,CASEPROPERTYMAP,NATION,FAGENT,PATENTTRADEMARKMAP" & _
      " WHERE PA01(+)=X01 AND PA02(+)=X02 AND PA03(+)=X03 AND PA04(+)=X04" & _
      " AND CP09(+)=X05 AND ST01(+)=CP14 AND SK01(+)=CP01 AND NA01(+)=PA09" & _
      " AND CPM01(+)=CP01 AND CPM02(+)=CP10" & _
      " AND PTM01(+)='1' AND PTM02(+)=PA08" & _
      " AND FA01(+)=SUBSTR(CP44,1,8) AND FA02(+)=SUBSTR(CP44,9,1) ORDER BY PID,CP44, 1,2,3,4"
   stSQL = "SELECT ST02 C01" & _
      ",decode(CP10,'605',CP46-19110000,CP47-19110000) C02, CP27-19110000 C03, CP09 C04,CP01||'-'||CP02||'-'||CP03||'-'||CP04 C05" & _
      ",NVL(PA05,NVL(PA06,PA07)) C06,PTM03 C07,NA03 C08" & _
      ",DECODE(PA09,'000',CPM03,CPM04) C09" & _
      ",CP44||' '||NVL(F1.FA04,DECODE(F1.FA05,NULL,F1.FA06,F1.FA05||' '||F1.FA63||' '||F1.FA64||' '||F1.FA65)) C10" & _
      "," & GetCaseIdSQL() & " PID,CP44,NVL(F2.FA10,C1.CU10) FA10" & _
      " FROM (" & stVTB & ") X,PATENT,CASEPROGRESS,STAFF,SYSTEMKIND,CASEPROPERTYMAP,NATION,FAGENT F1,PATENTTRADEMARKMAP,CUSTOMER C1,FAGENT F2" & _
      " WHERE PA01(+)=X01 AND PA02(+)=X02 AND PA03(+)=X03 AND PA04(+)=X04" & _
      " AND CP09(+)=X05 AND ST01(+)=CP14 AND SK01(+)=CP01 AND NA01(+)=PA09" & _
      " AND CPM01(+)=CP01 AND CPM02(+)=CP10" & _
      " AND PTM01(+)='1' AND PTM02(+)=PA08" & _
      " AND F1.FA01(+)=SUBSTR(CP44,1,8) AND F1.FA02(+)=SUBSTR(CP44,9,1)" & _
      " AND SUBSTR(PA75,1,8)=F2.FA01(+) AND SUBSTR(PA75,9,1)=F2.FA02(+) AND SUBSTR(PA26,1,8)=C1.CU01(+) AND SUBSTR(PA26,9,1)=C1.CU02(+)"
      
   stSQL = "SELECT  C01,C02,C03,C04,C05,C06,C07,C08,C09,C10,PID,CP44,NVL(NA79,NA16) FMP,NVL(ST02,' ') FMPMAN FROM (" & stSQL & "),NATION,STAFF WHERE FA10=NA01(+) AND NVL(NA79,NA16)=ST01(+)"
   If bolIsOurFMP Then
      stSQL = stSQL & " ORDER BY PID,FMP,CP44,1,2,3,4"
   Else
      stSQL = stSQL & " ORDER BY PID,CP44,1,2,3,4"
   End If
   'end 2017/02/16
   
   'Modified by Morgan 2020/2/21 CFP管制人 109/4/1以後改業務區劃分
   'If rs.State <> adStateClosed Then rs.Close
   'With rs
   '   .CursorLocation = adUseClient
   '   .Open stSQL, cnnConnection, adOpenForwardOnly, adLockReadOnly
   intI = 1
   Set Rs = ClsLawReadRstMsg(intI, stSQL)
   'Modified by Morgan 2025/1/8 +bolPNewRule
   'If p_Sys = "CFP" And strSrvDate(1) >= 20200401 Then
   If p_Sys = "CFP" Or bolPNewRule Then
   'end 2025/1/8
      If intI = 1 Then
         'Modified by Lydia 2021/07/09 取得序號mSeqNo
         Set rsQuery = PUB_CreateRecordset(Rs, , , 300, Me.Name, mSeqNo)
         With rsQuery
         .MoveFirst
         Do While Not .EOF
            'Added by Morgan 2025/1/8
            If p_Sys = "P" Then
               .Fields("PID") = PUB_GetPHandler(.Fields("C05"))
            Else
            'end 2025/1/8
            
               .Fields("PID") = PUB_GetCFPHandler(.Fields("C05"))
            End If
            .MoveNext
         Loop
         .UpdateBatch 'Added by Lydia 2021/07/09
         '.Sort = "PID,CP44,C01,C02,C03,C04" 'Remove by Lydia 2021/07/09
         End With
         'Added by Lydia 2021/07/09 重新查詢; 因為出現錯誤「無法在其定義長度是不明或過長的資料行執行 Relate、Compute By、及 Sort 操作。」
         strSql = "Select R001 As C01,R002 As C02, R003 As C03, R004 As C04,R005 As C05,R006 As C06, R007 As C07, R008 As C08, R009 As C09," & _
                     "R010 As C10, R011 As PID, R012 As CP44, R013 As FMP, R014 As FMPMAN " & _
                     "From Rdatafactory Where Id='" & strUserNum & "' And Formname='" & Me.Name & "'  And Seqno='" & mSeqNo & "' " & _
                     "ORDER BY PID,CP44,C01,C02,C03,C04 "
         intI = 1
         Set rsQuery = ClsLawReadRstMsg(intI, strSql)
         'end 2021/07/09
      Else
         Set rsQuery = Rs
      End If
   Else
      Set rsQuery = Rs
   End If
   With rsQuery
   'end 2020/2/21
      If .RecordCount > 0 Then
         .MoveFirst
         stPID = "" & .Fields("pid")
         'Added by Morgan 2023/6/20
         If bolIsOurFMP Then
            strFMPPID = "" & .Fields("FMP")
            strPIDName = "" & .Fields("FMPMAN")
         Else
         'end 2023/6/20
            strPIDName = GetPIDName(stPID) 'Added by Morgan 2017/10/31
         End If 'Added by Morgan 2023/6/20
         If ff > 0 Then Close #ff
         ff = FreeFile
         'Modify By Sindy 2009/06/04
         'p_FileName = "C:\" & p_Sys & "受理通知書未收達管制表.txt"
         'Added by Morgan 2014/11/10
         If bolIsOurFMP Then
            stFileName = App.path & TextPath & "FMP寰華案件" & stRptFileName & "(" & strPIDName & ").txt"
            'Added by Lydia 2017/02/16 設定欄位
                strTitle = "管制人 承辦人 提申日    發文日    收文號    本所案號        案件名稱                 種類   申請國家 案件性質   代理人              "
            strTitleLine = "------ ------ --------- --------- --------- --------------- ------------------------ ------ -------- ---------- --------------------"
            'end 2017/02/16
         Else
         'end 2014/11/10
            stFileName = App.path & TextPath & p_Sys & stRptFileName & "(" & strPIDName & ").txt"
            'Added by Lydia 2017/02/16 設定欄位
                strTitle = "承辦人 提申日    發文日    收文號    本所案號        案件名稱                 種類   申請國家 案件性質   代理人              "
            strTitleLine = "------ --------- --------- --------- --------------- ------------------------ ------ -------- ---------- --------------------"
            'end 2017/02/16
         End If 'Added by Morgan 2014/11/10
         '2009/06/04 End
         Open stFileName For Output As ff
         'Added by Lydia 2016/10/19 加報表抬頭
         Print #ff, Space(40) & IIf(bolIsOurFMP = True, "FMP寰華案件" & stRptFileName & "(" & strPIDName & ")", p_Sys & stRptFileName & "(" & strPIDName & ")")
         'end 2016/10/19
         Print #ff, ""
         Print #ff, "日期：" & p_RptDate
         Print #ff, ""
         'Modified by Lydia 2017/02/16 設定欄位
         'Print #ff, "承辦人 提申日    發文日    收文號    本所案號        案件名稱                 種類   申請國家 案件性質   代理人              "
         'Print #ff, "------ --------- --------- --------- --------------- ------------------------ ------ -------- ---------- --------------------"
         Print #ff, strTitle
         Print #ff, strTitleLine
         'end 2017/02/16
         
         tmpnext = "開檔中..."
         
         .MoveFirst
         Do While Not .EOF
            'Modified by Morgan 2023/6/20
            'If stPID <> "" & .Fields("pid") Then
            If stPID <> "" & .Fields("pid") Or (bolIsOurFMP And strFMPPID <> "" & .Fields("FMP")) Then
            'end 2023/6/20
               'Modified by Lydia 2017/02/16 設定欄位
               'Print #ff, "------ --------- --------- --------- --------------- ------------------------ ------ -------- ---------- --------------------"
               Print #ff, strTitleLine
               'end 2017/02/16
               Print #ff, "共" & lngRecs & "筆"
               Close ff
               p_FileName = p_FileName & stFileName & ";"
               
               'Added by Morgan 2017/10/31 CFP改直接寄給承辦人--甄妮106/10/27請作單
               'Modified by Morgan 2025/1/8 +bolPNewRule
               'If p_Sys = "CFP" Then
               If p_Sys = "CFP" Or bolPNewRule Then
               'end 2025/1/8
                  strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & _
                     p_Sys & stRptFileName & "(" & p_RptDate & ")(" & strPIDName & ") 資料如附件！" & _
                     vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & p_PS
                  SendMAPIMail stPID, p_Sys & stRptFileName & "(" & p_RptDate & ")(" & strPIDName & ")", strText, stFileName
                  stCFPMailList = stCFPMailList & stPID & ";"
               'Added by Morgan 2023/6/20
               ElseIf bolIsOurFMP Then
                  strFMPPSup = PUB_GetFCPProSup(strFMPPID)
                  strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & _
                     "FMP寰華案件" & stRptFileName & "(" & p_RptDate & ")(" & strPIDName & ") 資料如附件！" & _
                     vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & p_PS
                  SendMAPIMail strFMPPID, "FMP寰華案件" & stRptFileName & "(" & p_RptDate & ")(" & strPIDName & ")", strText, stFileName, , , strFMPPSup
               'end 2023/6/20
               End If
               'end 2017/10/31
               
               lngRecs = 0
               stPID = "" & .Fields("pid")
               'Added by Morgan 2023/6/20
               If bolIsOurFMP Then
                  strFMPPID = "" & .Fields("FMP")
                  strPIDName = "" & .Fields("FMPMAN")
               Else
               'end 2023/6/20
                  strPIDName = GetPIDName(stPID) 'Added by Morgan 2017/10/31
               End If 'Added by Morgan 2023/6/20
               
               If ff > 0 Then Close #ff
               ff = FreeFile
               'Added by Morgan 2014/11/10
               If bolIsOurFMP Then
                  stFileName = App.path & TextPath & "FMP寰華案件" & stRptFileName & "(" & strPIDName & ").txt"
               Else
               'end 2014/11/10
                  stFileName = App.path & TextPath & p_Sys & stRptFileName & "(" & strPIDName & ").txt"
               End If 'Added by Morgan 2014/11/10
               Open stFileName For Output As ff
               'Added by Lydia 2016/10/19 加報表抬頭
               Print #ff, Space(40) & IIf(bolIsOurFMP = True, "FMP寰華案件" & stRptFileName & "(" & strPIDName & ")", p_Sys & stRptFileName & "(" & strPIDName & ")")
               'end 2016/10/19
               Print #ff, ""
               Print #ff, "日期：" & p_RptDate
               Print #ff, ""
               'Modified by Lydia 2017/02/16 設定欄位
               'Print #ff, "承辦人 提申日    發文日    收文號    本所案號        案件名稱                 種類   申請國家 案件性質   代理人              "
               'Print #ff, "------ --------- --------- --------- --------------- ------------------------ ------ -------- ---------- --------------------"
               Print #ff, strTitle
               Print #ff, strTitleLine
               'end 2017/02/16
            End If
            lngRecs = lngRecs + 1
            
            strContent = ""
            'Added by Lydia 2017/02/16 +管制人
            If bolIsOurFMP Then
               strContent = strContent & convForm("" & .Fields("FMPMAN"), 6) & " " '管制人
            End If
            'end 2017/02/16
            
            strContent = strContent & convForm("" & .Fields("C01"), 6) '承辦人
            strContent = strContent & " " & Format(.Fields("C02"), "@@@/@@/@@") '申請日
            strContent = strContent & " " & Format(.Fields("C03"), "@@@/@@/@@") '發文日
            strContent = strContent & " " & convForm(.Fields("C04"), 9) '收文號
            strContent = strContent & " " & convForm(.Fields("C05"), 15) '本所案號
            strContent = strContent & " " & convForm(.Fields("C06"), 24) '案件名稱
            strContent = strContent & " " & convForm(.Fields("C07"), 6) '種類
            strContent = strContent & " " & convForm(.Fields("C08"), 8) '申請國家
            strContent = strContent & " " & convForm(.Fields("C09"), 10) '案件性質
            strContent = strContent & " " & convForm(.Fields("C10"), 20) '代理人
            tmpnext = "寫檔..."
            Print #ff, strContent
            .MoveNext
         Loop
         'Modified by Lydia 2017/02/16 設定欄位
         'Print #ff, "------ --------- --------- --------- --------------- ------------------------ ------ -------- ---------- --------------------"
         Print #ff, strTitleLine
         'end 2017/02/16
         Print #ff, "共" & lngRecs & "筆"
         Close ff
         p_FileName = p_FileName & stFileName
         
         'Added by Morgan 2017/10/31 CFP改直接寄給承辦人--甄妮106/10/27請作單
         'Modified by Morgan 2025/1/8 +bolPNewRule
         'If p_Sys = "CFP" Then
         If p_Sys = "CFP" Or bolPNewRule Then
         'end 2025/1/8
            strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & _
               p_Sys & stRptFileName & "(" & p_RptDate & ")(" & strPIDName & ") 資料如附件！" & _
               vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & p_PS
            SendMAPIMail stPID, p_Sys & stRptFileName & "(" & p_RptDate & ")(" & strPIDName & ")", strText, stFileName
            stCFPMailList = stCFPMailList & stPID & ";"
         'Added by Morgan 2023/6/20
         ElseIf bolIsOurFMP Then
            strFMPPSup = PUB_GetFCPProSup(strFMPPID)
            strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & _
               "FMP寰華案件" & stRptFileName & "(" & p_RptDate & ")(" & strPIDName & ") 資料如附件！" & _
               vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & p_PS
            SendMAPIMail strFMPPID, "FMP寰華案件" & stRptFileName & "(" & p_RptDate & ")(" & strPIDName & ")", strText, stFileName, , , strFMPPSup
         'end 2023/6/20
         End If
         'end 2017/10/31
         'MsgBox "資料寫入完畢！"
      Else
         'MsgBox "無符合資料！"
      End If
   End With
   
   'Added by Morgan 2017/10/31 CFP改直接寄給承辦人--甄妮106/10/27請作單
   'Modified by Morgan 2025/1/8 +bolPNewRule
   'If p_Sys = "CFP" Then
   '   stSQL = "select na73 from nation union select na74 from nation order by 1"
   '   'Added by Morgan 2020/2/21
   '   If strSrvDate(1) >= 20200401 Then
   '      stSQL = "select distinct a0916 from acc090 order by 1"
   '   End If
   '   'end 2020/2/21
   If p_Sys = "CFP" Or bolPNewRule Then
      If p_Sys = "CFP" Then
         stSQL = "select distinct a0916 from acc090 where a0916 is not null order by 1"
      Else
         stSQL = "select distinct a0917 from acc090 where a0917 is not null order by 1"
      End If
   'end 2025/1/8
      If Rs.State <> adStateClosed Then Rs.Close
      With Rs
      .CursorLocation = adUseClient
      .Open stSQL, cnnConnection, adOpenForwardOnly, adLockReadOnly
      If .RecordCount > 0 Then
         Do While Not .EOF
            If Not IsNull(.Fields(0)) Then
               stPID = .Fields(0)
               If InStr(stCFPMailList, stPID) = 0 Then
                  strPIDName = GetPIDName(stPID)
                  'Modified by Morgan 2025/1/8
                  'strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & _
                     "CFP已提申3個月尚無申請號管制表(" & p_RptDate & ")(" & strPIdName & ") 無需管制資料！" & _
                     vbCrLf & vbCrLf & String(25, "　") & "電腦中心"
                  'SendMAPIMail stPID, "CFP已提申3個月尚無申請號管制表(" & p_RptDate & ")(" & strPIdName & ")", strText
                  SendMAPIMail stPID, p_Sys & stRptFileName & "(" & p_RptDate & ")(" & strPIDName & ") 無需管制資料！", "如旨"
                  'end 2025/1/8
               End If
            End If
            .MoveNext
         Loop
      End If
      End With
   End If
   'end 2017/10/31
      
   CreateFile4 = True
   Set rsQuery = Nothing 'Added by Morgan 2020/2/21
   Exit Function
   
ErrHandle:
   WLog tmpnext & " " & Err.Description
   Set rsQuery = Nothing 'Added by Morgan 2020/2/21
End Function

'Add by Morgan 2005/10/13
'發Mail
'20140219 增加傳入副本收件人編號(CCr$)  Modify By eric
'Modified by Lydia 2015/08/03 + 密件副本(p_BCCr$)
'Modified by Morgan 2015/12/10 + p_HTML
'Modify By Sindy 2025/2/3
'         +stReceiveNo：收文號
'         +bolDefCont：預設帶入收文性質Email內文
Private Function SendMAPIMail(ByVal p_RecID$, ByVal p_Sub$, ByVal p_Text$, _
   Optional p_AttPath$, Optional p_RecName$, Optional bolAbsenceSys As Boolean = False, _
   Optional CCr$, Optional p_BCCr$, Optional p_HTML As Boolean = False, _
   Optional ByVal stReceiveNo As String = "", Optional ByVal bolDefCont As Boolean = False) As Boolean

Dim m_strMailKind As String 'Add By Sindy 2023/7/13

'Added by Morgan 2019/9/10
'統一改 HTML 格式
If p_HTML = False Then
   p_Text = Replace(p_Text & " ", " ", "&nbsp;")  '為避免後面的字型設定無效，必需手動轉空白(因tag內的空白不可轉否則無效),最後面多加一個空白避免內文沒有
   p_Text = "<DIV style=""FONT: 12pt 細明體"">" & p_Text & "</DIV>"
   p_HTML = True
End If
'end 2019/9/10

'Added by Morgan 2014/1/2
bolMailSendOk = False
'Modified by Lydia 2015/08/03 + 密件副本(p_BCCr$)
'PUB_SendMail strUserNum, p_RecID, "", p_Sub, p_Text, vbCrLf & vbCrLf & "***此信件為系統自動寄出，請勿直接回覆。***", Replace(p_AttPath, ";", "*"), False, , , CCr$, "QPGMR", "系統管理員", , bolAbsenceSys, False
'Modified by Morgan 2019/10/25 +bolShowErrMsg=False
'Modify By Sindy 2023/7/13
If InStr(p_Sub, "信件處理結果檢核表") > 0 Then
   '加參數 m_strMailKind  = "1": 寄信種類; 1.分信通知
   m_strMailKind = "1"
End If
'Modify By Sindy 2025/2/3 +stReceiveNo +bolDefCont
'PUB_SendMail strUserNum, p_RecID, "", p_Sub, p_Text, vbCrLf & vbCrLf & "***此信件為系統自動寄出，請勿直接回覆。***", Replace(p_AttPath, ";", "*"), p_HTML, , , CCr$, "QPGMR", "系統管理員", , bolAbsenceSys, False, p_BCCr$, , False, , , , , , , , , , m_strMailKind
PUB_SendMail strUserNum, p_RecID, stReceiveNo, _
   p_Sub, p_Text, vbCrLf & vbCrLf & "***此信件為系統自動寄出，請勿直接回覆。***", _
   Replace(p_AttPath, ";", "*"), p_HTML, , , CCr$, "QPGMR", "系統管理員", , bolAbsenceSys, False, _
   p_BCCr$, , False, , , , , , , , , , m_strMailKind, , bolDefCont
'2025/2/3 END
'2023/7/13 END
'PUB_SendMail strUserNum, p_RecID, "", p_Sub, p_Text, vbCrLf & vbCrLf & "***此信件為系統自動寄出，請勿直接回覆。***", Replace(p_AttPath, ";", "*"), False, , , , "QPGMR", "電腦中心", , bolAbsenceSys, False
'Added by Morgan 2014/1/23
SendMAPIMail = bolMailSendOk
If bolMailSendOk = False Then
   'Modify By Sindy 2014/12/15
   'WLog "寄信失敗!! -->主旨:" & p_Sub & "  內容:" & p_Text & " 附件:" & p_AttPath
   WLog p_RecID & "寄信失敗!! -->主旨:" & p_Sub & "  內容:" & p_Text & " 附件:" & p_AttPath
   '2014/12/15 END
End If
'end 2014/1/23

'Removed by Morgan 2014/1/3 取消 Outlook 寄信,都改用 SMTP
'
'Dim tmpnext As String, bolResume As Boolean
'Dim ii As Integer, arrAtt, i As Integer, j As Integer
'Dim strRecID As String, Recip As Variant
'Dim strMailBox As String 'Added by Morgan 2012/5/3
'
'   'Add by Morgan 2009/2/23
'   strRecID = ChkMailId(p_RecID)
'
'
'   'Added by Morgan 2012/9/5
'   If strRecID = "9997" Then
'      SendMAPIMail = True
'      Exit Function
'   End If
'   'end 2012/9/5
'
'On Error GoTo ErrHandle
'
'   'Add by Morgan 2008/8/27 改多附件
'   If p_AttPath$ <> Empty Then
'      arrAtt = Split(p_AttPath$, ";")
'      p_Text$ = Space(UBound(arrAtt) + 1) & vbCrLf & p_Text$
'   End If
'
'   'Add By Sindy 2011/10/27 收件人請假時則同時副本發案件職代
'   Dim strTempCC As String
'   If bolAbsenceSys = False Then '非出缺勤系統才需控管案件職代
'      strTempCC = GetCaseDutyAgent(strRecID, "", False)
'      If strTempCC <> "" Then
'         'stCCReceiver = stCCReceiver & ";" & strTempCC
'         p_Text$ = "因收件人請假，請副本收件人處理此郵件。" & vbCrLf & vbCrLf & p_Text$
'      End If
'   End If
'   '2011/10/27 End
'
'   '發 mail
'   tmpnext = "準備發 mail..."
'   MAPISession1.LogonUI = False
'   MAPISession1.UserName = "administrator"
'   tmpnext = "準備登入郵件伺服器..."
'   MAPISession1.SignOn
'   tmpnext = "登入郵件伺服器..."
'   MAPIMessages1.SessionID = MAPISession1.SessionID
'
'   MAPIMessages1.MsgIndex = -1
'   tmpnext = "建立郵件..."
'   MAPIMessages1.Compose
'   MAPIMessages1.MsgSubject = p_Sub$
'   'Modified by Morgan 2013/6/26
'   'MAPIMessages1.MsgNoteText = p_Text$
'   MAPIMessages1.MsgNoteText = p_Text$ & vbCrLf & vbCrLf & "***此信件為系統自動寄出，請勿直接回覆。***"
'   'end 2013/6/26
'
'   arrAtt = Split(p_AttPath$, ";")
'   If p_AttPath$ <> Empty Then
'      'Add by Morgan 2008/8/27 改多附件
'      For ii = 0 To UBound(arrAtt)
'         If arrAtt(ii) <> "" Then
'            MAPIMessages1.AttachmentIndex = ii
'            MAPIMessages1.AttachmentPosition = ii
'            MAPIMessages1.AttachmentPathName = arrAtt(ii)
'         End If
'      Next
'   End If
''   MAPIMessages1.RecipIndex = 0
''   MAPIMessages1.RecipType = 1
''   MAPIMessages1.RecipDisplayName = strRecID
''   tmpnext = "解析收件者 " & strRecID & "(" & p_RecName & ") 信箱..."
''   MAPIMessages1.ResolveName
'   Recip = Split(strRecID, ";")
'   For i = 0 To UBound(Recip)
'      MAPIMessages1.RecipIndex = i 'RecipIndex要在RecipType之前
'      MAPIMessages1.RecipType = 1 'Add By Sindy 2011/10/27 主要收件者
'      'Modified by Morgan 2012/5/3 一率加 @taie.com.tw 否則當收件人為離職信箱隱藏時會解析失敗(Ex. 96027)
'      'MAPIMessages1.RecipDisplayName = ChkMailId(Recip(i))
'      strMailBox = ChkMailId(Recip(i))
'      If InStr(strMailBox, "@") = 0 Then strMailBox = strMailBox & "@taie.com.tw"
'      MAPIMessages1.RecipDisplayName = strMailBox
'      'end 2012/5/3
'      tmpnext = "解析收件者 " & Recip(i) & " 信箱..."
'      MAPIMessages1.ResolveName
'   Next i
'
'   'Add By Sindy 2011/10/27 收件人請假時則同時副本發案件職代
'   If strTempCC <> "" Then
'      Recip = Split(strTempCC, ";")
'      For j = 0 To UBound(Recip)
'         MAPIMessages1.RecipIndex = i + j
'         MAPIMessages1.RecipType = 2 '副本
'         'Modified by Morgan 2012/5/3 一率加 @taie.com.tw 否則當收件人為離職信箱隱藏時會解析失敗(Ex. 96027)
'         'MAPIMessages1.RecipDisplayName = ChkMailId(Recip(j))
'         strMailBox = ChkMailId(Recip(j))
'         If InStr(strMailBox, "@") = 0 Then strMailBox = strMailBox & "@taie.com.tw"
'         MAPIMessages1.RecipDisplayName = strMailBox
'         'end 2012/5/3
'         MAPIMessages1.ResolveName
'      Next j
'   End If
'   '2011/10/27 End
'
'   tmpnext = "準備存入郵件..."
'   MAPIMessages1.Send
'   MAPISession1.SignOff
'   'Shell "net send /domain:taient4 '每日自動郵件資料已送出，請清除郵件備份' ", vbNormalNoFocus
'   SendMAPIMail = True
'   Exit Function
'ErrHandle:
''Modify by Morgan 2007/9/17 改寫Log,否則Mail掛掉不會停
''   If bolResume = False And Err.Number = 32050 Then
''      Err.Clear
''      bolResume = True
''      Resume Next
''   End If
'   WLog tmpnext & " " & Err.Description
''end 2007/9/17
'   'Add by Morgan 2009/4/3 發信失敗要登出
'   If MAPISession1.SessionID <> 0 Then MAPISession1.SignOff
End Function

'Add by Morgan 2005/10/13
'限定字串長度
'Remove by Lydia 2018/08/24 併入basQuery
'Private Function convForm(ByVal p_InStr As String, ByVal p_Num As Integer, Optional ByVal p_Char As String = " ", Optional p_AlignRight As Boolean = False) As String
'   If p_AlignRight Then
'      convForm = StrConv(RightB(StrConv(String(p_Num, p_Char) & p_InStr, vbFromUnicode), p_Num), vbUnicode)
'   Else
'      convForm = StrConv(LeftB(StrConv(p_InStr & String(p_Num, p_Char), vbFromUnicode), p_Num), vbUnicode)
'   End If
'End Function
'end 2018/08/24

'add by nickc 2005/11/03
Sub StrMenuExc()
Dim fn As Integer
Dim SqlExc As String
'add by nickc 2006/03/20
Dim fn2 As Integer
Dim IsNeedUpdate As Boolean
Dim intR As Integer 'Added by Morgan 2022/5/30
Dim strText As String, strText2 As String, arrText() As String, ii As Integer 'Added by Morgan 2023/11/15

On Error GoTo ErrHea
'檢查檔案
If Dir(App.path & "\executeSql.sql") <> "" Then
   If Dir(App.path & "\executeSql2.sql") <> "" Then
        Kill App.path & "\executeSql2.sql"
   End If
   
   'Modified by Morgan 2023/11/15 改以UTF-8格式開啟
   'fn = FreeFile
   'Open App.path & "\executeSql.sql" For Input As fn
   'fn2 = FreeFile
   'Open App.path & "\executeSql2.sql" For Output As fn2
   'Do While Not EOF(fn)
   '   Line Input #fn, SqlExc
   If PUB_IsBig5File(App.path & "\executeSql.sql", False) Then
      strText = PUB_ReadTextFile(App.path & "\executeSql.sql")
   Else
      strText = PUB_ReadTextFile(App.path & "\executeSql.sql", "UTF-8")
   End If
   arrText = Split(strText, vbCrLf)
   strText2 = ""
   For ii = 0 To UBound(arrText)
      SqlExc = arrText(ii)
   'end 2023/11/15

      If Trim(SqlExc) <> "" Then
         'add by nickc 2006/03/20
         IsNeedUpdate = False
         'edit by nickc 2006/04/27 改判斷數字
         'If InStr(1, Mid(Trim(SqlExc), 1, 6), "INSERT") <> 0 Or InStr(1, Mid(Trim(SqlExc), 1, 6), "UPDATE") <> 0 Or InStr(1, Mid(Trim(SqlExc), 1, 6), "DELETE") <> 0 Then
         If Val(Mid(Trim(SqlExc), 1, 6)) = 0 Then
            IsNeedUpdate = True
         Else
            If Mid(Trim(SqlExc), 1, 8) <= strSrvDate(1) Then
                IsNeedUpdate = True
                SqlExc = Mid(Trim(SqlExc), 9)
            Else
                IsNeedUpdate = False
            End If
         End If
         If IsNeedUpdate = True Then
            WLog "語法：" & SqlExc
            cnnConnection.Execute SqlExc, intR
            If Err = 0 Then
               WLog "成功：" & intR & " 筆"
            Else
               WLog "失敗：" & Err.Description
               Err.Clear
            End If
         Else
            'Modified by Morgan 2023/11/15
            'Print #fn2, SqlExc
            strText2 = strText2 & SqlExc & vbCrLf
            'end 2023/11/15
         End If
      End If
   'Modified by Morgan 2023/11/15
   'Loop
   'Close #fn
   'Close #fn2
   Next
   PUB_SaveUTF8NoBOM App.path & "\executeSql2.sql", strText2
   'end 2023/11/15
End If
Kill App.path & "\executeSql.sql"
Name App.path & "\executeSql2.sql" As App.path & "\executeSql.sql"
Exit Sub
ErrHea:
    Resume Next
End Sub

'add by nickc 2006/02/10 逾承辦期限有完稿日無會稿日 P 3 天，CFP 5 天
Sub StrMenu5()
On Error GoTo DebugErr
   Dim ff As Integer
   Dim i As Integer
   Dim A01 As String
   Dim A02 As String
   Dim A03 As String
   Dim A04 As String
   Dim A05 As String
   Dim A06 As String
   Dim A07 As String
   Dim A08 As String
   Dim A09 As String
   Dim A10 As String
   Dim A11 As String
   Dim A12 As String
   Dim A13 As String
   Dim A14 As String
   Dim A15 As String
   Dim iCount As Long
   Dim TempFileName As String
   Dim TempFileNameSeek As String
   Dim ThisFileName As Variant
   
   Dim StrSQL6 As String
   Dim p_Date As String
   Dim CFP_Date As String
   Dim tmpnext As String
   
'   tmpnext = "準備連資料庫..."
'   Set cnnConnection = New ADODB.Connection
'   cnnConnection.ConnectionString = CnStr
'   cnnConnection.Open
   TempFileName = ""

   p_Date = CompWorkDay(3, strSrvDate(1), 1)
   CFP_Date = CompWorkDay(5, strSrvDate(1), 1)
   
   'Modify by Morgan 2008/10/29 有判斷適用的就可否則新加的案件性質會抓不到
   'StrSQL6 = StrSQL6 + " AND (CP27 IS NULL  and CP57 IS NULL) and cp05>=19980101  and ep09 is not null and ep07 is null and cp112='Y' "
   'StrSQL6 = StrSQL6 & " AND CP10<>'1101' and substr(cp09,1,1) in ('A','C') and cp10 not in ('106','121','201','202','203','204','206','207','211','212','411','416','417','421','901','902','906','909','910','911','916','917','1002','1209','1908','1902','407','920','404','215','214','408','1205','1206','401','413','429','505','506','915') "
   'Modified by Lydia 2016/09/14 (CP27 IS NULL  and CP57 IS NULL) = > CP158=0 and cp159=0
   StrSQL6 = StrSQL6 + " AND  CP158=0 and cp159=0 and cp05+0>=19980101  and ep09 is not null and ep07 is null and cp112='Y' "
   
   'Modified by Lydia 2016/09/14 CP27=>CP158
   'modify by sonia 2022/4/29 二句的decode(ep04,null,decode(st06,'1','73022','2','82026','3','74018','4','74018','71011'),ep04)->decode(ep04,null,decode(st06,'1','99050','2','94019','3','73022','4','73022','99050'),ep04)
   strSql = "SELECT CP14,st02," & SQLDate("CP05") & " as cp05,CP01||'-'||CP02||'-'||CP03||'-'||CP04 as sortA,NVL(PA05,NVL(PA06,PA07)),DECODE(PA09,'000',PTM03,PTM04),nvl(DECODE(PA09,'000',CPM03,CPM04),cp10)," & SQLDate("CP48") & "," & SQLDate("CP06") & "," & SQLDate("CP07") & "," & SQLDate("EP06") & "," & SQLDate("EP09") & "," & SQLDate("EP28") & "," & SQLDate("EP08") & "," & SQLDate("CP158") & ",cp09,decode(ep04,null,decode(st06,'1','99050','2','94019','3','" & Left(pub_PMan, 5) & "','4','" & Left(pub_PMan, 5) & "','99050'),ep04) as ep04 " & _
            " FROM CASEPROGRESS,ENGINEERPROGRESS,STAFF,PATENT,CASEPROPERTYMAP,PATENTTRADEMARKMAP " & _
            " WHERE CP09=EP02(+) AND CP01=pa01(+) AND CP02=PA02(+) AND CP03=PA03(+) AND CP04=PA04(+) AND CP14=ST01(+)  and cp01=cpm01(+) and cp10=cpm02(+) AND '1'=PTM01(+) AND PA08=PTM02(+) " & StrSQL6 & _
            " AND CP01='P' and cp48<=" & p_Date
   strSql = strSql & " union " & _
            " SELECT CP14,st02," & SQLDate("CP05") & " as cp05,CP01||'-'||CP02||'-'||CP03||'-'||CP04 as sortA,NVL(PA05,NVL(PA06,PA07)),DECODE(PA09,'000',PTM03,PTM04),nvl(DECODE(PA09,'000',CPM03,CPM04),cp10)," & SQLDate("CP48") & "," & SQLDate("CP06") & "," & SQLDate("CP07") & "," & SQLDate("EP06") & "," & SQLDate("EP09") & "," & SQLDate("EP28") & "," & SQLDate("EP08") & "," & SQLDate("CP158") & ",cp09,decode(ep04,null,decode(st06,'1','99050','2','94019','3','" & Left(pub_PMan, 5) & "','4','" & Left(pub_PMan, 5) & "','99050'),ep04) as ep04 " & _
            " FROM CASEPROGRESS,ENGINEERPROGRESS,STAFF,PATENT,CASEPROPERTYMAP,PATENTTRADEMARKMAP " & _
            " WHERE CP09=EP02(+) AND CP01=pa01(+) AND CP02=PA02(+) AND CP03=PA03(+) AND CP04=PA04(+) AND CP14=ST01(+)  and cp01=cpm01(+) and cp10=cpm02(+) AND '1'=PTM01(+) AND PA08=PTM02(+)  " & StrSQL6 & _
            " AND CP01='CFP' and cp48<=" & CFP_Date
            
   strSql = strSql & " order by ep04,cp14,cp05,sortA "
   
CheckOC
Set Rs = New ADODB.Recordset
Rs.CursorLocation = adUseClient
Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
tmpnext = "已取得資料..."
TempFileNameSeek = ""
With Rs
    TempFileName = ""
    If .RecordCount > 0 And .RecordCount <> 0 Then
        .MoveFirst
        ff = FreeFile
        Do While Not .EOF
            If InStr(1, TempFileNameSeek, CheckStr(.Fields("ep04"))) = 0 Then
                TempFileName = CheckStr(.Fields("ep04"))
                TempFileNameSeek = TempFileNameSeek & "," & CheckStr(.Fields("ep04"))
                If ff > 0 Then Close #ff
                ff = FreeFile
                'Modify By Sindy 2009/06/04
                'Open "c:\" & TempFileName & ".txt" For Output As ff
                Open App.path & TextPath & TempFileName & ".txt" For Output As ff
                '2009/06/04 End
                'Added by Lydia 2016/10/19 加報表抬頭
                Print #ff, Space(45) & "逾承辦期限有完稿日無會稿日" & TempFileName
                Print #ff, ""
                'end 2016/10/19
                
                Print #ff, "承辦人   收文日    收文號    本所案號　　　　案件名稱             專利種類 案件性質 承辦期限  本所期限  法定期限  文件齊備日  完稿日    預定會稿日  會稿完成日  "
                Print #ff, "======== ========= ========= =============== ==================== ======== ======== ========= ========= ========= =========== ========= =========== =========== "
            End If
            tmpnext = "開檔中..."
            A01 = "" & convForm(CheckStr(.Fields(1).Value), 8)
            A02 = "" & convForm(CheckStr(.Fields(2).Value), 9)
            A03 = "" & convForm(CheckStr(.Fields(3).Value), 15)
            A04 = "" & convForm(CheckStr(.Fields(4).Value), 20)
            A05 = "" & convForm(CheckStr(.Fields(5).Value), 8)
            A06 = "" & convForm(CheckStr(.Fields(6).Value), 8)
            A07 = "" & convForm(CheckStr(.Fields(7).Value), 9)
            A08 = "" & convForm(CheckStr(.Fields(8).Value), 9)
            A09 = "" & convForm(CheckStr(.Fields(9).Value), 9)
            A10 = "" & convForm(CheckStr(.Fields(10).Value), 11)
            A11 = "" & convForm(CheckStr(.Fields(11).Value), 9)
            A12 = "" & convForm(CheckStr(.Fields(12).Value), 11)
            A13 = "" & convForm(CheckStr(.Fields(13).Value), 11)
            'A14 = "" & convForm(CheckStr(.Fields(14).Value), 9)
            A15 = "" & convForm(CheckStr(.Fields(15).Value), 9)
            tmpnext = "寫檔..."
            'Debug.Print A01 & " " & A02 & " " & A15 & " " & A03 & " " & A04 & " " & A05 & " " & A06 & " " & A07 & " " & A08 & " " & A09 & " " & A10 & " " & A11 & " " & A12 & " " & A13 & " " & A14
            Print #ff, A01 & " " & A02 & " " & A15 & " " & A03 & " " & A04 & " " & A05 & " " & A06 & " " & A07 & " " & A08 & " " & A09 & " " & A10 & " " & A11 & " " & A12 & " " & A13
            .MoveNext
        Loop
    End If
End With
Close ff
tmpnext = "關檔..."
If TempFileNameSeek <> "" Then
   ThisFileName = Split(TempFileNameSeek, ",")
   For iCount = 0 To UBound(ThisFileName)
        If ThisFileName(iCount) <> "" Then
            TempFileName = ThisFileName(iCount)
            '發 mail
            'Modify By Sindy 2009/06/04
            'SendMAPIMail TempFileName, "逾承辦期限有完稿日無會稿日，案件明細", "Dear Sirs," & vbCrLf & "          逾承辦期限有完稿日無會稿日 資料如附件！" & vbCrLf & vbCrLf & vbCrLf & vbCrLf & "          請橫印！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", "c:\" & TempFileName & ".txt"
            SendMAPIMail TempFileName, "逾承辦期限有完稿日無會稿日，案件明細", "Dear Sirs," & vbCrLf & "          逾承辦期限有完稿日無會稿日 資料如附件！" & vbCrLf & vbCrLf & vbCrLf & vbCrLf & "          請橫印！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", App.path & TextPath & TempFileName & ".txt"
            '2009/06/04 End
        End If
   Next iCount
'edit by nickc 2006/03/20 因為 taient4 的服務預設關閉
'   Shell "net send /domain:taient4 '每日自動郵件資料已送出，請清除郵件備份' ", vbNormalNoFocus
End If
Set Rs = Nothing
'Set cnnConnection = Nothing
Exit Sub
DebugErr:
        'MsgBox tmpnext & " " & Err.Description
        WLog tmpnext & " " & Err.Description
End Sub

'Removed by Morgan 2014/3/20 不再使用
''add by nickc 2006/02/10 計算會稿加乘註記，僅承辦人 還區分有無核稿人
'Sub StrMenu6()
''先取得所有承辦人及其目標和核稿人
''跑迴圈，一次只算一個承辦人
''抓該承辦人所有案子，累計承辦量，若適用則更新會稿加乘註記，不適用則繼續累加承辦量
'Dim rs1 As New ADODB.Recordset   '最外圈用
'Dim Rs2 As New ADODB.Recordset   '單一承辦人所有案子
'Dim Rs3 As New ADODB.Recordset   '單一承辦人當天所有適用的案子
'Dim Rs4 As New ADODB.Recordset   '會稿加乘註記
'Dim Rs5 As New ADODB.Recordset   '大陸案件會稿加乘檢查
'Dim tmpTarget As Double          '目標
'Dim tmpAddUpTarget As Double     '目前累計承辦量
'Dim tmpSt01 As String            '暫存承辦人
'Dim MaxWorkDay As Integer        '本月最大工作天
'Dim NowWorkDay As Integer        '月初到現在有多少工作天
'Dim OneWorkDay As Double         '一個工作天需做多少件
'Dim TheMData(1 To 31) As Boolean '該月資料 該天是工作天就會 true
'Dim ThisSvrDate As String        '系統日
'Dim i As Integer                 '暫時變數
'Dim CalDay As Integer            '目前累計工作天
'Dim IsDelay As Boolean           '是否延遲
'Dim EpDay As Integer             '承辦天數
''Add by Morgan 2008/10/21
'Dim strRule1 As String           '適用規則
'Dim strRule2 As String           '次規則代碼
'Dim strRule3 As String           '是否有核稿人
'Dim strDate1 As String           '以收文日計算起算日
'Dim StrDate2 As String           '以本所期限計算起算日
'Dim kk As Integer
'
''清每月暫存變數
'For i = 1 To 31
'    TheMData(i) = False
'Next i
'NowWorkDay = 0
'ThisSvrDate = strSrvDate(1)
'txt1(0).text = CalYM
''抓該月基本資料
'strSql = "select * from workday where wd01>=" & (Val(txt1(0).text) + 191100) & "01 and wd01<=" & (Val(txt1(0).text) + 191100) & "31 order by wd01 "
'Set rs1 = New ADODB.Recordset
'rs1.CursorLocation = adUseClient
'rs1.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
'If rs1.RecordCount <> 0 Then
'    MaxWorkDay = rs1.RecordCount
'    rs1.MoveFirst
'    Do While Not rs1.EOF
'        TheMData(Val(Right(CheckStr(rs1.Fields("wd01")), 2))) = True
'        If CheckStr(rs1.Fields("wd01")) <= ThisSvrDate Then
'            NowWorkDay = NowWorkDay + 1
'        End If
'        rs1.MoveNext
'    Loop
'Else
'    '沒有該月工作資料
''    SendMail Server$, "administrator", "Administrator", "Nickc", "93013", "計算會稿加乘註記", "Dear Sirs," & vbCrLf & "          未定義" & CalYM & "工作天！" & vbCrLf & vbCrLf & vbCrLf & vbCrLf & "          請橫印！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心"
'    Exit Sub
'End If
''查所有工程師和他的目標，沒目標的不出來
'strSql = "select st01,Sum(decode(pe02,'CFP',(Nvl(PE05,0)+Nvl(PE07,0)) * 2,Nvl(PE05,0)+Nvl(PE07,0))) from staff,performance where st03>='P10' and st03<='P11' and st04='1' And (ST05='72' or st05='74' Or ST05='76' Or ST05='77' Or ST05='78' Or ST05='79' or st05='87' ) And ST01<>'88024' And ST01<'F' and pe01=st01(+) and pe03=" & (Val(txt1(0).text) + 191100) & " group by st01"
'Set rs1 = New ADODB.Recordset
'rs1.CursorLocation = adUseClient
'rs1.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
'If rs1.RecordCount <> 0 Then
'
'    rs1.MoveFirst
'    Do While Not rs1.EOF
'        '忘記要除以所有工作天了 edit by nickc 2006/03/21
'        'tmpTarget = Val(CheckStr(Rs1.Fields(1)))
'        tmpTarget = Val(CheckStr(rs1.Fields(1))) / MaxWorkDay
'        tmpSt01 = CheckStr(rs1.Fields(0))
'
''Remove by Morgan 2008/10/17 改在更新會稿日時 Trigger 做
''        'add by nickc 2006/06/01 加入檢查滿半年沒
''        strSQL = "select st13 from staff where st01='" & tmpSt01 & "' "
''        Set Rs2 = New ADODB.Recordset
''        If Rs2.State = 1 Then Rs2.Close
''        Rs2.CursorLocation = adUseClient
''        Rs2.Open strSQL, cnnConnection, adOpenStatic, adLockReadOnly
''        If Rs2.RecordCount <> 0 And Val(CheckStr(Rs2.Fields(0))) <> 0 Then
''            If DateDiff("m", ChangeWStringToWDateString(CheckStr(Rs2.Fields("st13"))), ChangeWStringToWDateString(ThisSvrDate)) >= 7 Then
''                cnnConnection.Execute "update caseprogress set cp112='Y' where cp01 in ('P','CFP') and cp112 is null and cp10 in ('101','102') and cp14='" & tmpSt01 & "' and cp27 is null and cp57 is null "
''                cnnConnection.Execute "update caseprogress set cp112='N' where cp01 in ('P','CFP') and cp112 is null and cp10 not in ('101','102') and cp14='" & tmpSt01 & "' and cp05>=20060101 "
''            End If
''        End If
'        Debug.Print tmpSt01
'        CalDay = 0
'
'
'        '先更新適用，但還沒有輸入會稿日的暫時會稿加乘註記
'        cnnConnection.Execute "update caseprogress set cp111=1 where cp09 in (select cp09 from caseprogress,engineerprogress where cp09=ep02(+) and cp14='" & tmpSt01 & "' and (cp111 is null  or ep07 is null )) "
'
'        For i = 1 To 31
'            If TheMData(i) = True Then
'                CalDay = CalDay + 1
'
'                'Modify by Morgan 2010/3/24 達成計算要考慮會稿加乘註記，當日的會稿加乘註記先預設要倒扣,若計算後有達成目標再重新用不倒扣計算
'                'Modify by Morgan 2010/3/29 支援紀錄也要算
'                'Memo by Morgan 2010/3/30 是否達成目標用累計會稿量判斷(上月完稿當月才會稿的也算,可接受上月份統計數字有變動)--柄佑
'                'IsDelay = False
'                ''查該工程師1號到該天的計件，沒計件值的不出來
'                'strSQL = "select sum(cp97 * cp98) from caseprogress,engineerprogress where cp14='" & tmpSt01 & "' aND cp09=ep02(+) and ep07>=" & (Val(txt1(0).text) + 191100) & "01 and ep07<=" & (Val(txt1(0).text) + 191100) & Format(i, "00") & " order by ep07"
'                'Set Rs2 = New ADODB.Recordset
'                'If Rs2.State = 1 Then Rs2.Close
'                'Rs2.CursorLocation = adUseClient
'                'Rs2.Open strSQL, cnnConnection, adOpenStatic, adLockReadOnly
'                ''若是有資料，且 計件值不為 0
'                ''edit by nickc 2008/01/03 修正
'                ''If Rs2.RecordCount <> 0 And Val(CheckStr(Rs2.Fields(0))) <> 0 Then
'                'If Rs2.RecordCount <> 0 Then
'                '    '若是當時計件值未達當時承辦目標時
'                '    If Val(CheckStr(Rs2.Fields(0))) < (tmpTarget * CalDay) Then
'                '        IsDelay = True
'                '    End If
'                For kk = 1 To 2
'
'                     '先預設要倒扣
'                     If kk = 1 Then
'                        IsDelay = True
'                     Else
'                        strSql = "select sum(pp) from (select sum(cp97 * cp98 * decode(cp112,'Y',nvl(cp111,1),1)) pp from engineerprogress,caseprogress where ep05='" & tmpSt01 & "' aND cp09(+)=ep02 and ep07>=" & (Val(txt1(0).text) + 191100) & "01 and ep07<=" & (Val(txt1(0).text) + 191100) & Format(i, "00") & _
'                        " union all Select Sum(Round(Decode(SH06, 'CFP', Nvl(SH05,0)/3, Nvl(SH05,0)/4) ,2)) pp From SupportHour Where SH02='" & tmpSt01 & "' And SH01>=" & (Val(txt1(0).text) + 191100) & "01 And SH01<=" & (Val(txt1(0).text) + 191100) & Format(i, "00") & " And SH11='V' ) X"
'                        If Rs2.State = 1 Then Rs2.Close
'                        Rs2.CursorLocation = adUseClient
'                        Rs2.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
'                        If Rs2.RecordCount <> 0 Then
'                           If Val(CheckStr(Rs2.Fields(0))) < (tmpTarget * CalDay) Then
'                              Exit For
'                           Else
'                              IsDelay = False
'                           End If
'                        Else
'                           Exit For
'                        End If
'                     End If
'
'                'end 2010/3/24
'
'                    '查出所有當天資料，且適用的
'                    'Modify by Morgan 2008/10/23 加判斷會稿加乘適用規則CPM05,會稿加乘註記改抓 MeetScript
'                    'strSQL = "select *  from caseprogress,engineerprogress,promoterproofreader where cp14='" & tmpSt01 & "' aND cp09=ep02(+) and ep07=" & (Val(txt1(0).text) + 191100) & Format(i, "00") & "  and cp01=pp01(+) and cp14=pp02(+) and cp10=pp03(+) and cp112='Y' order by ep07 "
'                    strSql = "select *  from engineerprogress,caseprogress,promoterproofreader,casepropertymap where ep05='" & tmpSt01 & "' aND cp09(+)=ep02 and ep07=" & (Val(txt1(0).text) + 191100) & Format(i, "00") & "  and cp01=pp01(+) and cp14=pp02(+) and cp10=pp03(+) and cp112='Y' and cpm01(+)=cp01 and cpm02(+)=cp10 order by ep07 "
'                    Set Rs3 = New ADODB.Recordset
'                    If Rs3.State = 1 Then Rs3.Close
'                    Rs3.CursorLocation = adUseClient
'                    Rs3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
'                    If Rs3.RecordCount <> 0 Then
'                        Rs3.MoveFirst
'                        Do While Not Rs3.EOF
'                           strRule1 = "" & Rs3.Fields("cpm05")
'                           'Modify by Morgan 2008/10/23 要區分A,B規則
'                           'Modify by Morgan 2010/2/1 +C規則(CFP案適用P案A規則者)
'                           If strRule1 = "A" Or strRule1 = "C" Then
'                              '檢查齊備到會稿幾個工作天
'                              EpDay = GetWorkDay(CheckStr(Rs3.Fields("ep07")), CheckStr(Rs3.Fields("ep06")))
'                              '抓會稿加乘註記
'                              '優先判斷是否有預設核稿人(若沒有預設核稿人時即使個案有設也用無核稿人的加乘註記)
'                              If CheckStr(Rs3.Fields("pp04")) = "" Then
'                                 '沒核稿人
'                                 'strSQL = "select ea07 from EngAssemble where ea01='2' and ea02='" & CheckStr(rs3.Fields("cp01")) & "' and ea03<=" & EpDay & " and ea05>=" & EpDay & " " & IIf(IsDelay = False, " and ea07 >1 ", "")
'                                 strRule3 = "2"
'                              Else
'                                 'add by nickc 2007/03/06 加入 P 的不管，CFP 的，若是承辦人與核稿人相同，表示為無核稿人
'                                 If CheckStr(Rs3.Fields("cp01")) = "CFP" And CheckStr(Rs3.Fields("EP05")) = CheckStr(Rs3.Fields("EP04")) Then
'                                     'strSQL = "select ea07 from EngAssemble where ea01='2' and ea02='" & CheckStr(rs3.Fields("cp01")) & "' and ea03<=" & EpDay & " and ea05>=" & EpDay & " " & IIf(IsDelay = False, " and ea07 >1 ", "")
'                                     strRule3 = "2"
'                                 ElseIf CheckStr(Rs3.Fields("EP05")) = "" Then
'                                     'strSQL = "select ea07 from EngAssemble where ea01='2' and ea02='" & CheckStr(rs3.Fields("cp01")) & "' and ea03<=" & EpDay & " and ea05>=" & EpDay & " " & IIf(IsDelay = False, " and ea07 >1 ", "")
'                                     strRule3 = "2"
'                                 Else
'                                     'strSQL = "select ea07 from EngAssemble where ea01='1' and ea02='" & CheckStr(rs3.Fields("cp01")) & "' and ea03<=" & EpDay & " and ea05>=" & EpDay & " " & IIf(IsDelay = False, " and ea07 >1 ", "")
'                                     strRule3 = "1"
'                                 End If
'                              End If
'                              If strRule3 = "1" Then
'                                 strSql = "select MS06 from MeetScript where MS01='" & strRule1 & "' and MS02='1' and MS03='" & CheckStr(Rs3.Fields("cp01")) & "' and MS04<=" & EpDay & " and MS05>=" & EpDay & " " & IIf(IsDelay = False, " and MS06 >1 ", "")
'                              Else
'                                 strSql = "select MS07 from MeetScript where MS01='" & strRule1 & "' and MS02='1' and MS03='" & CheckStr(Rs3.Fields("cp01")) & "' and MS04<=" & EpDay & " and MS05>=" & EpDay & " " & IIf(IsDelay = False, " and MS06 >1 ", "")
'                              End If
'                           '規則B
'                           Else
'                              strRule2 = "1"
'                              If Not IsNull(Rs3.Fields("cp06")) Then
'                                 'P案若超過14個工作天或本所期限前6個工作天，以較早的為準，適用倒扣
'                                 If Rs3.Fields("cp01") = "P" Then
'                                    strDate1 = CompWorkDay(15, CheckStr(Rs3.Fields("ep06")))
'                                    StrDate2 = CompWorkDay(5, Rs3.Fields("cp06"), 1)
'                                 'CFP案若超過20個工作天或本所期限前10個工作天，以較早的為準，適用倒扣
'                                 Else
'                                    strDate1 = CompWorkDay(21, CheckStr(Rs3.Fields("ep06")))
'                                    StrDate2 = CompWorkDay(9, Rs3.Fields("cp06"), 1)
'                                 End If
'                                 If StrDate2 <= strDate1 Then
'                                    strRule2 = "2"
'                                 End If
'                              End If
'                              '以所限計算
'                              If strRule2 = "2" Then
'                                 EpDay = GetWorkDay(Rs3.Fields("CP06"), Rs3.Fields("EP07"))
'                              '以齊備日計算
'                              Else
'                                 EpDay = GetWorkDay(Rs3.Fields("EP07"), Rs3.Fields("EP06"))
'                              End If
'                              strSql = "select MS06 from MeetScript where MS01='" & strRule1 & "' and MS02='" & strRule2 & "' and MS03='" & CheckStr(Rs3.Fields("cp01")) & "' and MS04<=" & EpDay & " and MS05>=" & EpDay & " " & IIf(IsDelay = False, " and MS06 >1 ", "")
'                           End If
'
'                           Set Rs4 = New ADODB.Recordset
'                           If Rs4.State = 1 Then Rs4.Close
'                           Rs4.CursorLocation = adUseClient
'                           Rs4.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
'                           If Rs4.RecordCount <> 0 Then
'                              If Rs4.Fields(0) > 1 And Rs3("cp01") = "P" And (Rs3("cp10") = "101" Or Rs3("cp10") = "102" Or Rs3("cp10") = "103") Then
'                                 '若與台灣案同一工程師時大陸案不適用大於1的會稿加乘註記
'                                    strSql = "select 1 from patent a where pa01='" & Rs3("cp01") & "' and pa02='" & Rs3("cp02") & "' and pa03='" & Rs3("cp03") & "' and pa04='" & Rs3("cp04") & "' and pa09='020'" & _
'                                       " and exists(select * from casemap,caseprogress,patent b where cm01=a.pa01 and cm02=a.pa02 and cm03=a.pa03 and cm04=a.pa04 and cm10='0'" & _
'                                       " and cp01(+)=cm05 and cp02(+)=cm06 and cp03(+)=cm07 and cp04(+)=cm08 and cp10 in ('101','102','103') and cp14='" & Rs3("cp14") & "'" & _
'                                       " and b.pa01(+)=cp01 and b.pa02(+)=cp02 and b.pa03(+)=cp03 and b.pa04(+)=cp04 and b.pa09='000')"
'                                 If Rs5.State = 1 Then Rs5.Close
'                                 Rs5.CursorLocation = adUseClient
'                                 Rs5.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
'                                 If Rs5.RecordCount <> 0 Then
'                                    cnnConnection.Execute "update caseprogress set cp111=1 where cp09='" & CheckStr(Rs3.Fields("cp09")) & "'"
'                                 Else
'                                    cnnConnection.Execute "update caseprogress set cp111=" & CheckStr(Rs4.Fields(0)) & " where cp09='" & CheckStr(Rs3.Fields("cp09")) & "' "
'                                 End If
'                              Else
'                                 cnnConnection.Execute "update caseprogress set cp111=" & CheckStr(Rs4.Fields(0)) & " where cp09='" & CheckStr(Rs3.Fields("cp09")) & "' "
'                              End If
'                           Else
'                              cnnConnection.Execute "update caseprogress set cp111=1 where cp09='" & CheckStr(Rs3.Fields("cp09")) & "'"
'                           End If
'
'                           Rs3.MoveNext
'                        Loop
'                    End If
'                'End If
'                Next
'            End If
'        Next i
'        rs1.MoveNext
'    Loop
'End If
'Set rs1 = Nothing
'Set Rs2 = Nothing
'Set Rs3 = Nothing
'Set Rs4 = Nothing
'Set Rs5 = Nothing
'End Sub

'Add by Morgan 2006/3/27
'檢查有未齊備的"告建議性處分"內部收文且逾"准駁通知日+5個月"時,齊備日上系統日並發Mail通知承辦人
Private Sub StrMenu7()

   Dim stSQL As String, stContent As String, stSubject As String, stCP48 As String
   
On Error GoTo ErrHand
'   If cnnConnection.State = adStateClosed Then
'      cnnConnection.ConnectionString = CnStr
'      cnnConnection.Open
'   End If
   With adoRecordset
      If .State <> adStateClosed Then .Close
'edit by nickc 2007/10/05
'      stSQL = "select cp01,cp02,cp03,cp04,cp05,cp06,cp09,cp14,pa05,pa20,st02,to_char(sysdate+nvl(cf04,0),'yyyymmdd') cp48N" & _
         " From caseprogress, patent, engineerprogress, staff, CASEFEE" & _
         " where cp01='CFP' and cp05>20060301 and substr(cp09,1,1)='B' and cp10='222' and cp27 is null" & _
         " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04 and pa09='101'" & _
         " and pa20>0 and pa20<to_char(add_months(sysdate,-5),'YYYYMMDD')" & _
         " and ep02(+)=cp09 and ep06 is null and st01(+)=cp14" & _
         " AND CF01(+)=PA01 AND CF02(+)=PA09 AND CF03=CP10"
      'Modified by Lydia 2016/09/14 cp27 is null => CP158=0
      stSQL = "select cp01,cp02,cp03,cp04,cp05,cp06,cp09,cp14,pa05,pa20,st02,to_char(sysdate+nvl(cf04,0),'yyyymmdd') cp48N,pa09,cp10,to_char(sysdate,'yyyymmdd') as osysdate " & _
         " From caseprogress, patent, engineerprogress, staff, CASEFEE" & _
         " where cp01='CFP' and cp05>20060301 and substr(cp09,1,1)='B' and cp10='222' and CP158=0" & _
         " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04 and pa09='101'" & _
         " and pa20>0 and pa20<to_char(add_months(sysdate,-5),'YYYYMMDD')" & _
         " and ep02(+)=cp09 and ep06 is null and st01(+)=cp14" & _
         " AND CF01(+)=PA01 AND CF02(+)=PA09 AND CF03=CP10"
      .CursorLocation = adUseClient
      .Open stSQL, cnnConnection, adOpenForwardOnly, adLockReadOnly
      If .RecordCount > 0 Then
         .MoveFirst
         Do While Not .EOF
            If Not IsNull(.Fields("cp14")) Then
'edit by nickc 2007/10/05 改抓有時效性的
'               stCP48 = .Fields("cp48N")
'               With RS
'                  If .State <> adStateClosed Then .Close
'                  '
'                  stSQL = "select wd01 from workday where wd01>=" & stCP48 & " AND WD01<TO_CHAR(TO_DATE(" & stCP48 & ",'YYYYMMDD')+14,'YYYYMMDD') ORDER BY 1 ASC"
'                  .CursorLocation = adUseClient
'                  .Open stSQL, cnnConnection, adOpenForwardOnly, adLockReadOnly
'                  If .RecordCount > 0 Then
'                     stCP48 = .Fields(0)
'                  End If
'               End With
'               If stCP48 > "" & .Fields("CP06") Then
'                  stCP48 = .Fields("CP06")
'               End If
               stCP48 = Pub_GetHandleDay(CheckStr(.Fields("cp01")), CheckStr(.Fields("pa09")), CheckStr(.Fields("cp10")), CheckStr(.Fields("osysdate")), CheckStr(.Fields("cp06")))
               '更新文齊日
               stSQL = "UPDATE ENGINEERPROGRESS SET EP06=to_char(sysdate,'YYYYMMDD') WHERE EP02='" & .Fields("cp09") & "'"
               cnnConnection.Execute stSQL
               '更新承辦期限
               stSQL = "UPDATE CASEPROGRESS SET CP48=" & stCP48 & " WHERE CP09='" & .Fields("cp09") & "'"
               cnnConnection.Execute stSQL
               
               stSubject = .Fields("cp01") & "-" & .Fields("cp02") & "-" & .Fields("cp03") & "-" & .Fields("cp04") & "文件齊備通知！"
               stContent = "收文號：" & .Fields("cp09") & _
                  vbCrLf & "本所案號：" & .Fields("cp01") & "-" & .Fields("cp02") & "-" & .Fields("cp03") & "-" & .Fields("cp04") & _
                  vbCrLf & "案件名稱：" & .Fields("pa05") & _
                  vbCrLf & "案件性質：222 告建議性處分" & _
                  vbCrLf & "收文日：" & (.Fields("cp05") - 19110000) \ 10000 & " 年 " & Right(.Fields("cp05"), 4) \ 100 & " 月 " & Val(Right(.Fields("cp05"), 2)) & " 日" & _
                  vbCrLf & "承辦人：" & .Fields("cp14") & " " & .Fields("st02")
               If Not IsNull(.Fields("CP06")) Then
                  stContent = stContent & vbCrLf & vbCrLf & "本所期限：" & (.Fields("cp06") - 19110000) \ 10000 & " 年 " & Right(.Fields("cp06"), 4) \ 100 & " 月 " & Val(Right(.Fields("cp06"), 2)) & " 日"
               End If
               stContent = stContent & _
                  vbCrLf & "本案最終核駁通知(" & Format(.Fields("pa20") - 19110000, "###/##/##") & ")已逾5個月，系統自動上文件齊備日！"
               SendMAPIMail .Fields("cp14"), stSubject, stContent, ""
            End If
            .MoveNext
         Loop
      End If
   End With
   
ErrHand:

End Sub

'add by nickc 2006/08/18 會稿完成日未輸卻已發文上會完日=發文日並紀錄且通知工程師已上會完日、會稿完成日前面相關日期未輸入完整發 mail 給工程師
Sub StrMenu8()
 On Error GoTo DebugErr
Dim i As Integer
Dim iCount As Long
Dim oCP27 As String
Dim StrSQL6 As String
Dim tmpnext As String
Dim Rs3 As New ADODB.Recordset
Dim tmpM_cp09 As String
Dim tmpM_cp48 As String

'tmpnext = "準備連資料庫..."
'Set cnnConnection = New ADODB.Connection
'cnnConnection.ConnectionString = CnStr
'cnnConnection.Open
'TempFileName = ""
'   P_Date = CompWorkDay(3, strSrvDate(1), 1)
'   CFP_Date = CompWorkDay(5, strSrvDate(1), 1)

'Modified by Morgan 2013/5/24 回抓1年應該就可以了
'If Trim(strSrvDate(1)) >= "20060824" Then
'    'oCP27 = CompWorkDay(2, strSrvDate(1), 1)
'    oCP27 = "20050101"
'Else
'    oCP27 = "20030201"
'End If
 oCP27 = (strSrvDate(1) \ 10000 - 1) & "0101"
'end 2013/5/24

'避免錯誤，所以將其他的都上  2006/11/14
'2009/4/23 modify by sonia 加案件性質922檢還樣品證據P-085588
'Modify by Morgan 2009/6/30 +933覆函
'2010/1/6 modify by sonia 加938超頁費,939超項費
'modify by sonia 2015/1/19 +123主張優惠期 P109322
'modify by sonia 2015/1/20 +927其他翻譯,946摘要英譯,1003通知補文件{與郭確認但保留代理人通知修正1224(CFP-024379-1)}
'Modify by Amy 2015/02/10 +226 配合開庭(P-107944-0-00)
'modify by sonia 2015/2/26 +430保密審查(P-110461)
'modify by sonia 2015/11/19 +955去電聯絡單
'modify by sonia 2016/1/19 + 947超圖費
'modify by sonia 2019/10/22 +427合併檢索及實審(CFP-031234)
'Modified by Morgan 2021/1/11 +993改系統類別
'****此處加案件性質,下面還有一句也要加入
   CheckOC
   strSql = "SELECT CP14,st02," & SQLDate("CP05") & " as cp05,CP01||'-'||CP02||'-'||CP03||'-'||CP04 as sortA,NVL(PA05,NVL(PA06,PA07)) as PAName,nvl(DECODE(PA09,'000',CPM03,CPM04),cp10) as CPMName,CP48,CP06,CP07,EP06,ep07,EP09,EP28,CP27,cp09,ep34,cp31,sqldatet(cp06) as cp06t,sqldatet(cp07) as cp07t,sqldatet(cp27) as cp27t,pa26,cp10,st03 " & _
           " FROM CASEPROGRESS,ENGINEERPROGRESS,STAFF,CASEPROPERTYMAP,patent " & _
    " WHERE CP09=EP02(+) AND CP01=pa01(+) AND CP02=PA02(+) AND CP03=PA03(+) AND CP04=PA04(+) AND CP14=ST01(+)  and cp01=cpm01(+) and cp10=cpm02(+) and ep08 is null and cp01 in ('P','CFP') and cp14 is not null and cp05>=20030201 " & _
    " and cp27>=" & oCP27 & _
    " AND CP10<>'1101' and ep08 is null and ((st03<>'P12' and st03>='P' and st03<='P19') or st03='F51') and ((cp04 = '00' and substr(cp09,1,1)='B') or substr(cp09,1,1) in ('A','C')) and cp10 in ('106','121','123','201','202','203','204','206','207','211','212','226','411','416','417','421','427','430','901','902','906','909','910','911','916','917','922','927','938','939','946','1002','1003','1209','1908','1902','407','920','404','215','214','408','1205','1206','401','413','429','505','506','915','933','955','947','993') and ep06 is not null and ep07 is not null "
    '" AND CP27>=" & oCP27
   strSql = strSql & " order by cp14,cp05,sortA "
Set Rs = New ADODB.Recordset
Rs.CursorLocation = adUseClient
Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
tmpnext = "已取得資料...全上"
With Rs
    If .RecordCount > 0 And .RecordCount <> 0 Then
        .MoveFirst
        Do While Not .EOF
            '符合正常規則 上 會稿完成日=發文日
            If CheckStr(.Fields("ep06")) <> "" And CheckStr(.Fields("ep07")) <> "" Then
                iCount = 0
                cnnConnection.Execute "update engineerprogress set ep08=" & CheckStr(.Fields("cp27")) & " where ep02='" & CheckStr(.Fields("cp09")) & "' ", iCount
            End If
            .MoveNext
        Loop
    End If
End With

'正常的規則
'2009/4/23 modify by sonia 加案件性質922檢還樣品證據P-085588
   CheckOC
   'Modify by Morgan 2009/5/11 +cp13
   'Modify by Morgan 2009/6/30 +排除 933覆函
   '2010/1/6 modify by sonia 加938超頁費,939超項費
   'Modify by Morgan 2011/5/6 +943繪圖超時
   'Modify by Morgan 2011/6/3 +st04
   'Modified by Morgan 2014/12/30 +931 繪圖
   'modify by sonia 2015/1/19 +123主張優惠期 P109322
   'modify by sonia 2015/1/20 +927其他翻譯,946摘要英譯,1003通知補文件{與郭確認但保留代理人通知修正1224(CFP-024379-1)}
   'Modify by Amy 2015/02/10 +226 配合開庭(P-107944-0-00)
   'modify by sonia 2015/2/26 +430保密審查(P-110461)
   'modify by sonia 2015/11/19 +955去電聯絡單
   'modify by sonia 2016/1/19 + 947超圖費
   'modify by sonia 2019/10/22 +427合併檢索及實審(CFP-031234)
   'Modified by Morgan 2021/1/11 +993改系統類別
   strSql = "SELECT CP14,st02," & SQLDate("CP05") & " as cp05,CP01||'-'||CP02||'-'||CP03||'-'||CP04 as sortA,NVL(PA05,NVL(PA06,PA07)) as PAName,nvl(DECODE(PA09,'000',CPM03,CPM04),cp10) as CPMName,CP48,CP06,CP07,EP06,ep07,EP09,EP28,CP27,cp09,ep34,cp31,sqldatet(cp06) as cp06t,sqldatet(cp07) as cp07t,sqldatet(cp27) as cp27t,pa26,cp10,st03,cp13,st04 " & _
           " FROM CASEPROGRESS,ENGINEERPROGRESS,STAFF,CASEPROPERTYMAP,patent " & _
    " WHERE CP09=EP02(+) AND CP01=pa01(+) AND CP02=PA02(+) AND CP03=PA03(+) AND CP04=PA04(+) AND CP14=ST01(+)  and cp01=cpm01(+) and cp10=cpm02(+) and ep08 is null and cp01 in ('P','CFP') and cp14 is not null and cp05>=20030201 " & _
    " and cp27>=" & oCP27 & _
    " AND CP10<>'1101' and ep08 is null and ((st03<>'P12' and st03>='P' and st03<='P19') or st03='F51') and ((cp04 = '00' and substr(cp09,1,1)='B') or substr(cp09,1,1) in ('A','C')) and cp10 not in ('106','121','123','201','202','203','204','206','207','211','212','226','411','416','417','421','427','430','901','902','906','909','910','911','916','917','922','927','938','939','946','1002','1003','1209','1908','1902','407','920','404','215','214','408','1205','1206','401','413','429','505','506','915','933','943','931','955','947','993') "
    '" AND CP27>=" & oCP27
   strSql = strSql & " order by cp14,cp05,sortA "
Set Rs = New ADODB.Recordset
Rs.CursorLocation = adUseClient
Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
tmpnext = "已取得資料...正常"
With Rs
    If .RecordCount > 0 And .RecordCount <> 0 Then
        .MoveFirst
        Do While Not .EOF
            '符合正常規則 上 會稿完成日=發文日
            If CheckStr(.Fields("ep06")) <> "" And CheckStr(.Fields("ep07")) <> "" Then
                iCount = 0
                tmpnext = "已取得資料...正常...準備更新 會稿完成日=發文日 "
                cnnConnection.Execute "update engineerprogress set ep08=" & CheckStr(.Fields("cp27")) & " where ep02='" & CheckStr(.Fields("cp09")) & "' ", iCount
                If iCount <> 0 Then
                    'add by nickc 2006/08/24 新增到紀錄檔 協理要看
                    strSql = "insert into pat_log (pl01) values ('" & CheckStr(.Fields("cp09")) & "' ) "
                    cnnConnection.Execute strSql
                    '有更新到，更新相關動作 1.通知國外承辦 2.通知智權人員 3.有相關要扣相關的承辦天   4.會完日要上到相關國外的文齊，重算期限
                    'SendMail Server$, "系統管理員", "Administrator", CheckStr(.Fields("st02")), CheckStr(.Fields("cp14")), "◎系統代發提醒通知◎", "Dear Sirs," & vbCrLf & "由於此案已經發文，卻沒有會稿完成日，！" & vbCrLf & vbCrLf & vbCrLf & vbCrLf & "          請橫印！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心"
                    '=========================================================================================
                    tmpnext = "已取得資料...正常...準備更新 相關案 "
                    If CheckStr(.Fields("ep34")) <> "N" Then
                        F_CP14 = ""
                        F_ST02 = ""
                        F_ST03 = ""
                        F_CP01020304 = ""
                        F_CP14 = GetF_CP14(CheckStr(.Fields("sortA")))
                        If SystemNumber(Trim(CheckStr(.Fields("sortA"))), 1) = "P" And F_CP14 <> "" And UCase(CheckStr(.Fields("cp31"))) = "Y" Then
                            's = MsgBox("本案有國外案件(" & F_CP01020304 & ")一併申請，請將資料轉給國外承辦人(" & F_ST02 & ")！", , "警告！")
                            'SendMail Server$, "系統管理員", "Administrator", CheckStr(.Fields("st02")), ChkMailId(.Fields("cp14")), "◎系統代發提醒通知◎" & "本案(" & CheckStr(.Fields("sortA")) & ")有國外案件(" & F_CP01020304 & ")一併申請，請將資料轉給國外承辦人(" & F_ST02 & ")！", "此訊息是半夜系統自動代發！" & vbCrLf & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心"
                            'Modify By Sindy 2011/10/28 SendMail 改Call SendMAPIMail
                            SendMAPIMail ChkMailId(.Fields("cp14")), "本案(" & CheckStr(.Fields("sortA")) & ")有國外案件(" & F_CP01020304 & ")一併申請，請將資料轉給國外承辦人(" & F_ST02 & ")！", "此訊息是半夜系統自動代發！" & vbCrLf & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心"
                            'add by nick 2004/12/16  修正發 mail  每個人都要發
                            Dim tmpArr931216_F_ST03 As Variant
                            Dim tmpArr931216_F_CP14 As Variant
                            Dim tmpArr931216_F_CP01020303 As Variant
                            Dim tmpIndexI As Integer
                            Dim tmpF_CP0104 As String
                            Dim tmpDelayDay As Integer
                            Dim tmpP_Rs As New ADODB.Recordset
                            tmpArr931216_F_ST03 = Split(F_ST03, ",")
                            tmpArr931216_F_CP14 = Split(F_CP14, ",")
                            tmpArr931216_F_CP01020303 = Split(F_CP01020304, ",")
                            For tmpIndexI = 0 To UBound(tmpArr931216_F_ST03)
                                '將本會稿完成日上到相關國外的文件齊備日，並重算承辦期限
                                tmpF_CP0104 = tmpArr931216_F_CP01020303(tmpIndexI)
                                'edit by nickc 2007/10/09 改抓有時效
                                'strSQL = "select cp06,cp09,cf04 from caseprogress,engineerprogress,casefee,patent where pa01='" & SystemNumber(tmpF_CP0104, 1) & "' and pa02='" & SystemNumber(tmpF_CP0104, 2) & "' and pa03='" & SystemNumber(tmpF_CP0104, 3) & "' and pa04='" & SystemNumber(tmpF_CP0104, 4) & "' " & _
                                                                   " and pa01=cp01(+) and pa02=cp02(+) and pa03=cp03(+) and pa04=cp04(+)  and pa01=cf01 and cp10=cf03 and pa09=cf02 and cp10 in ('101','102','103','104','105','201') and cp09=ep02(+) and ep06 is null "
                                strSql = "select cp06,cp09,pa01,pa09,cp10 from caseprogress,engineerprogress,patent where pa01='" & SystemNumber(tmpF_CP0104, 1) & "' and pa02='" & SystemNumber(tmpF_CP0104, 2) & "' and pa03='" & SystemNumber(tmpF_CP0104, 3) & "' and pa04='" & SystemNumber(tmpF_CP0104, 4) & "' " & _
                                                                   " and pa01=cp01(+) and pa02=cp02(+) and pa03=cp03(+) and pa04=cp04(+)  and cp10 in (" & GetAddStr(CaseMapOut) & ") and cp09=ep02(+) and ep06 is null "
                                Set Rs3 = New ADODB.Recordset
                                If Rs3.State = 1 Then Rs3.Close
                                   Rs3.CursorLocation = adUseClient
                                   Rs3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
                                   If Rs3.RecordCount <> 0 Then
                                        Rs3.MoveFirst
                                        Do While Not Rs3.EOF
                                            'edit by nickc 2005/09/30 若是相關是 CFP 則看 P 有沒延遲，有要扣 CFP 的天數，且要同一承辦人
                                            tmpDelayDay = 0
                                            If SystemNumber(tmpF_CP0104, 1) = "CFP" And F_CP14 = Trim(Left(CheckStr(.Fields("cp14")), 6)) Then
                                                tmpDelayDay = GetWorkDay(CheckStr(.Fields("ep09")), CheckStr(.Fields("ep06")))
                                                Set tmpP_Rs = New ADODB.Recordset
                                                If tmpP_Rs.State = 1 Then tmpP_Rs.Close
                                                tmpP_Rs.CursorLocation = adUseClient
                                                tmpP_Rs.Open "select * from casefee,caseprogress,patent where cp09='" & CheckStr(.Fields("cp09")) & "' and cp01=pa01(+) and cp02=pa02(+) and cp03=pa03(+) and cp04=pa04(+) and cp01=cf01 and cf02=pa09 and cf03=cp10 and cp14='" & Trim(Left(CheckStr(.Fields("cp14")), 6)) & "' ", cnnConnection, adOpenStatic, adLockReadOnly
                                                If tmpP_Rs.RecordCount <> 0 Then
                                                      If tmpDelayDay > CheckStr(tmpP_Rs.Fields("cf04").Value) Then
                                                            tmpDelayDay = tmpDelayDay - Val(CheckStr(tmpP_Rs.Fields("cf04").Value))
                                                      Else
                                                            tmpDelayDay = 0
                                                      End If
                                                Else
                                                   tmpDelayDay = 0
                                                End If
                                            End If
                                            tmpM_cp09 = "" & Rs3.Fields("cp09").Value
                                            'edit by nickc 2005/09/30 加入計算延遲
'edit by nickc 2007/10/09  改抓有時效天數
'                                            tmpM_cp48 = CompWorkDay(RS3.Fields("cf04").Value - IIf(SystemNumber(tmpF_CP0104, 1) = "CFP", tmpDelayDay, 0), CheckStr(.Fields("cp27")), 0)    '因為會完日更新為發文日
'                                            If tmpM_cp48 <> "" And Not IsNull(RS3.Fields("cp06").Value) Then
'                                                '若承辦期限大於本所期限
'                                                If tmpM_cp48 > Trim(RS3.Fields("cp06").Value) Then
'                                                    tmpM_cp48 = Trim(RS3.Fields("cp06").Value)
'                                                End If
'                                            End If
                                             'edit by nickc 2007/10/31
                                             'tmpM_cp48 = Pub_GetHandleDay(CheckStr(rs3.Fields("pa01")), CheckStr(rs3.Fields("pa09")), CheckStr(rs3.Fields("cp10")), CheckStr(.Fields("cp27")), CheckStr(rs3.Fields("cp06")), CheckStr(rs3.Fields("cp09")), tmpDelayDay)
                                             'cnnConnection.Execute "update engineerprogress set ep06=" & CheckStr(.Fields("cp27")) & " where ep02='" & tmpM_cp09 & "' "
                                             'cnnConnection.Execute "update caseprogress set cp48=" & tmpM_cp48 & " Where cp09='" & tmpM_cp09 & "'  "
                                             'Modify by Morgan 2009/8/3 承辦人相同用會稿日更新,不同則用會稿完成日(發文日)更新
                                             If F_CP14 = Trim(Left(CheckStr(.Fields("cp14")), 6)) Then
                                                tmpM_cp48 = Pub_GetHandleDay(CheckStr(Rs3.Fields("pa01")), CheckStr(Rs3.Fields("pa09")), CheckStr(Rs3.Fields("cp10")), CheckStr(.Fields("ep07")), CheckStr(Rs3.Fields("cp06")), CheckStr(Rs3.Fields("cp09")), tmpDelayDay)
                                                If tmpM_cp48 <> "" Then
                                                    cnnConnection.Execute "update engineerprogress set ep06=" & CheckStr(.Fields("ep07")) & " where ep02='" & tmpM_cp09 & "' "
                                                    cnnConnection.Execute "update caseprogress set cp48=" & tmpM_cp48 & " Where cp09='" & tmpM_cp09 & "'  "
                                                End If
                                             Else
                                                tmpM_cp48 = Pub_GetHandleDay(CheckStr(Rs3.Fields("pa01")), CheckStr(Rs3.Fields("pa09")), CheckStr(Rs3.Fields("cp10")), CheckStr(.Fields("cp27")), CheckStr(Rs3.Fields("cp06")), CheckStr(Rs3.Fields("cp09")), tmpDelayDay)
                                                If tmpM_cp48 <> "" Then
                                                    cnnConnection.Execute "update engineerprogress set ep06=" & CheckStr(.Fields("cp27")) & " where ep02='" & tmpM_cp09 & "' "
                                                    cnnConnection.Execute "update caseprogress set cp48=" & tmpM_cp48 & " Where cp09='" & tmpM_cp09 & "'  "
                                                End If
                                             End If
                                            Rs3.MoveNext
                                        Loop
                                   End If
                                Set Rs3 = Nothing
                                tmpnext = "已取得資料...正常...準備 發 mail "
                                If UCase(tmpArr931216_F_ST03(tmpIndexI)) = "F51" Or UCase(tmpArr931216_F_ST03(tmpIndexI)) = "F52" Then
                                    'edit by nickc 2006/06/05 因為倪穎慧離職，所以改回郭
                                    'SendMail CheckStr(.Fields("cp14")), "79075", "", "◎系統代發提醒通知◎" & lbl1(7) & "已會稿完成！(相關國外案：" + tmpArr931216_F_CP01020303(tmpIndexI) + ")", " ", ""
                                    'edit by nickc 2007/10/17 改抓table
                                    'SendMail Server$, CheckStr(.Fields("st02")), CheckStr(.Fields("cp14")), GetPrjSalesNM("79075"), "79075", "◎系統代發提醒通知◎" & CheckStr(.Fields("sortA")) & "已會稿完成！(相關國外案：" + tmpArr931216_F_CP01020303(tmpIndexI) + ")", "此訊息是半夜系統自動代發！"
                                    'edit by nickc 2007/10/31
                                    'SendMail Server$, CheckStr(.Fields("st02")), CheckStr(.Fields("cp14")), GetPrjSalesNM(Pub_GetSpecMan("H")), Pub_GetSpecMan("H"), "◎系統代發提醒通知◎" & CheckStr(.Fields("sortA")) & "已會稿完成！(相關國外案：" + tmpArr931216_F_CP01020303(tmpIndexI) + ")", "此訊息是半夜系統自動代發！"
                                    'SendMail Server$, CheckStr(.Fields("st02")), ChkMailId(.Fields("cp14")), GetPrjSalesNM(Pub_GetSpecMan("H")), Pub_GetSpecMan("H"), "◎系統代發提醒通知◎" & CheckStr(.Fields("sortA")) & "已輸會稿日！(相關國外案：" + tmpArr931216_F_CP01020303(tmpIndexI) + ")", "此訊息是半夜系統自動代發！"
                                    'Modify By Sindy 2011/10/28 SendMail 改Call SendMAPIMail
                                    SendMAPIMail Pub_GetSpecMan("H"), CheckStr(.Fields("sortA")) & "已輸會稿日！(相關國外案：" + tmpArr931216_F_CP01020303(tmpIndexI) + ")", "此訊息是半夜系統自動代發！"
                                Else
                                    'SendMail CheckStr(.Fields("cp14")), tmpArr931216_F_CP14(tmpIndexI), "", "◎系統代發提醒通知◎" & lbl1(7) & "已會稿完成！(相關國外案：" + tmpArr931216_F_CP01020303(tmpIndexI) + ")", " ", ""
                                    'edit by nickc 2007/10/31
                                    'SendMail Server$, CheckStr(.Fields("st02")), CheckStr(.Fields("cp14")), GetPrjSalesNM(tmpArr931216_F_CP14(tmpIndexI)), tmpArr931216_F_CP14(tmpIndexI), "◎系統代發提醒通知◎" & CheckStr(.Fields("sortA")) & "已會稿完成！(相關國外案：" + tmpArr931216_F_CP01020303(tmpIndexI) + ")", "此訊息是半夜系統自動代發！"
                                    'SendMail Server$, CheckStr(.Fields("st02")), ChkMailId(.Fields("cp14")), GetPrjSalesNM(CStr(tmpArr931216_F_CP14(tmpIndexI))), tmpArr931216_F_CP14(tmpIndexI), "◎系統代發提醒通知◎" & CheckStr(.Fields("sortA")) & "已輸會稿日！(相關國外案：" + tmpArr931216_F_CP01020303(tmpIndexI) + ")", "此訊息是半夜系統自動代發！"
                                    'Modify By Sindy 2011/10/28 SendMail 改Call SendMAPIMail
                                    SendMAPIMail CStr(tmpArr931216_F_CP14(tmpIndexI)), CheckStr(.Fields("sortA")) & "已輸會稿日！(相關國外案：" + tmpArr931216_F_CP01020303(tmpIndexI) + ")", "此訊息是半夜系統自動代發！"
                                End If
                             Next tmpIndexI
                             If GetStaffDepartment(CheckStr(.Fields("cp14"))) <> "P12" And ((CheckStr(.Fields("cp10")) >= "101" And CheckStr(.Fields("cp10")) <= "107") Or (CheckStr(.Fields("cp10")) >= "201" And CheckStr(.Fields("cp10")) <= "206") Or (CheckStr(.Fields("cp10")) >= "501" And CheckStr(.Fields("cp10")) <= "504") Or (CheckStr(.Fields("cp10")) >= "801" And CheckStr(.Fields("cp10")) <= "804")) Then
                                  'SendMail CheckStr(.Fields("cp14")), m_CP13, "", "◎系統代發提醒通知◎" & lbl1(7) & "已會稿完成！", vbCrLf + "客戶名稱：" & m_CuNo & vbCrLf & "本所案號： " + lbl1(7) + vbCrLf + "案件名稱： " + lbl1(9).Caption + vbCrLf + "案件性質： " + lbl1(15).Caption + vbCrLf + "本所期限： " + lbl1(17).Caption + vbCrLf + "法定期限： " + lbl1(19).Caption + vbCrLf + "會稿完成日：" + ChangeTStringToTDateString(txt1(7).Text) + vbCrLf + vbCrLf + "已完成會稿！", ""
                                  'edit by nickc 2007/10/31
                                  'SendMail Server$, CheckStr(.Fields("st02")), CheckStr(.Fields("cp14")), GetPrjSalesNM(CheckStr(.Fields("cp13"))), CheckStr(.Fields("cp13")), "◎系統代發提醒通知◎" & CheckStr(.Fields("sortA")) & "已會稿完成！", "此訊息是半夜系統自動代發！" & vbCrLf + "客戶名稱：" & GetCustomerName(CheckStr(.Fields("pa26"))) & vbCrLf & "本所案號： " + CheckStr(.Fields("sortA")) + vbCrLf + "案件名稱： " + CheckStr(.Fields("PAName")) + vbCrLf + "案件性質： " + CheckStr(.Fields("CPMName")) + vbCrLf + "本所期限： " + CheckStr(.Fields("cp06t")) + vbCrLf + "法定期限： " + CheckStr(.Fields("cp07t")) + vbCrLf + "會稿完成日：" + CheckStr(.Fields("cp27t")) + vbCrLf + vbCrLf + "已完成會稿！"
                                  'SendMail Server$, CheckStr(.Fields("st02")), ChkMailId(.Fields("cp14")), GetPrjSalesNM(CheckStr(.Fields("cp13"))), CheckStr(.Fields("cp13")), "◎系統代發提醒通知◎" & CheckStr(.Fields("sortA")) & "已輸會稿日！", "此訊息是半夜系統自動代發！" & vbCrLf + "客戶名稱：" & GetCustomerName(CheckStr(.Fields("pa26"))) & vbCrLf & "本所案號： " + CheckStr(.Fields("sortA")) + vbCrLf + "案件名稱： " + CheckStr(.Fields("PAName")) + vbCrLf + "案件性質： " + CheckStr(.Fields("CPMName")) + vbCrLf + "本所期限： " + CheckStr(.Fields("cp06t")) + vbCrLf + "法定期限： " + CheckStr(.Fields("cp07t")) + vbCrLf + "會稿日：" + ChangeWStringToTDateString(CheckStr(.Fields("ep07"))) + vbCrLf + vbCrLf + "已輸會稿日！"
                                  'Modify By Sindy 2011/10/28 SendMail 改Call SendMAPIMail
                                  SendMAPIMail CheckStr(.Fields("cp13")), CheckStr(.Fields("sortA")) & "已輸會稿日！", "此訊息是半夜系統自動代發！" & vbCrLf + "客戶名稱：" & GetCustomerName(CheckStr(.Fields("pa26"))) & vbCrLf & "本所案號： " + CheckStr(.Fields("sortA")) + vbCrLf + "案件名稱： " + CheckStr(.Fields("PAName")) + vbCrLf + "案件性質： " + CheckStr(.Fields("CPMName")) + vbCrLf + "本所期限： " + CheckStr(.Fields("cp06t")) + vbCrLf + "法定期限： " + CheckStr(.Fields("cp07t")) + vbCrLf + "會稿日：" + ChangeWStringToTDateString(CheckStr(.Fields("ep07"))) + vbCrLf + vbCrLf + "已輸會稿日！"
                             End If
                        End If
                    End If
                    '=========================================================================================
                End If
            
            Else
            '不符正常規則，發 mail 給工程師補
                'Modify by Morgan 2011/6/3 離職就不必再發
                'If CheckStr(.Fields("st03")) <> "F51" Then
                If CheckStr(.Fields("st03")) <> "F51" And .Fields("st04") = "1" Then
                    'SendMail Server$, "系統管理員", "Administrator", CheckStr(.Fields("st02")), ChkMailId(.Fields("cp14")), "◎系統代發提醒通知◎" & "本案(" & CheckStr(.Fields("sortA")) & "," & CheckStr(.Fields("cp09")) & ")已經發文，相關資料未輸入完全，將會影響考核分數，請補齊！", "此訊息是半夜系統自動代發！" & vbCrLf & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心"
                    'Modify By Sindy 2011/10/28 SendMail 改Call SendMAPIMail
                    'Removed by Morgan 2025/5/22 取消此通知--柏翰
                    'SendMAPIMail ChkMailId(.Fields("cp14")), "本案(" & CheckStr(.Fields("sortA")) & "," & CheckStr(.Fields("cp09")) & ")已經發文，相關資料未輸入完全，將會影響考核分數，請補齊！", "此訊息是半夜系統自動代發！" & vbCrLf & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心"
                End If
            End If
            .MoveNext
        Loop
    End If
End With
'Close ff
tmpnext = "關檔..."
Set Rs = Nothing
'Set cnnConnection = Nothing
Exit Sub
DebugErr:
        'MsgBox tmpnext & " " & Err.Description
        WLog tmpnext & " " & Err.Description
End Sub

'2007/9/13 add by sonia 智慧局註冊費通知函超過5工作天未列印
Sub StrMenu9()
Dim i As Integer
Dim tmpnext As String
Dim System_2 As String      '系統日減5工作天

On Error GoTo DebugErr
'   tmpnext = "準備連資料庫..."
'   Set cnnConnection = New ADODB.Connection
'   cnnConnection.ConnectionString = CnStr
'   cnnConnection.Open
   System_2 = CompWorkDay(5, strSrvDate(1), 1)
   'Modified by Lydia 2016/09/14 CP27 IS NULL => CP158=0
   strSql = "select * from caseprogress where cp01='T' AND CP05>=20070913 AND CP05<=" & System_2 & " AND CP10 IN ('1715','1716','1717') AND CP158=0 "
   Set Rs = New ADODB.Recordset
   Rs.CursorLocation = adUseClient
   Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   tmpnext = "已取得資料..."
   With Rs
      If .RecordCount > 0 And .RecordCount <> 0 Then
         'Modify By Sindy 2011/10/27
         'modify by sonia 2016/10/3 取消稱謂
         'SendMAPIMail "67002", "智慧局註冊費通知函超過5工作天未列印", "Dear 葉經理：" & vbCrLf & vbCrLf & "　　有智慧局註冊費通知函超過5工作天的資料未列印, 請注意 !!" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心"
         'Modified by Lydia 2016/10/19 改發為林經理，並同時副本通知葉特助。
         'SendMAPIMail "67002", "智慧局註冊費通知函超過5工作天未列印", "Dear Sirs," & vbCrLf & vbCrLf & "　　有智慧局註冊費通知函超過5工作天的資料未列印, 請注意 !!" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心"
         'Modify by Amy 2020/05/05 副本消取通知葉特助
         'SendMAPIMail "69008", "智慧局註冊費通知函超過5工作天未列印", "Dear Sirs," & vbCrLf & vbCrLf & "　　有智慧局註冊費通知函超過5工作天的資料未列印, 請注意 !!" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", , , , "67002"
         'Modified by Lydia 2021/11/12 收件人69008=>79041
         SendMAPIMail "79041", "智慧局註冊費通知函超過5工作天未列印", "Dear Sirs," & vbCrLf & vbCrLf & "　　有智慧局註冊費通知函超過5工作天的資料未列印, 請注意 !!" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心"
         
'         '發 mail
'         tmpnext = "準備發 mail..."
'         MAPISession1.LogonUI = False
'         MAPISession1.UserName = "administrator"
'         tmpnext = "準備登入郵件伺服器..."
'         MAPISession1.SignOn
'         tmpnext = "登入郵件伺服器..."
'         MAPIMessages1.SessionID = MAPISession1.SessionID
'         '發葉經理
'         MAPIMessages1.MsgIndex = -1
'         tmpnext = "建立郵件..."
'         MAPIMessages1.Compose
'         MAPIMessages1.MsgSubject = "智慧局註冊費通知函超過5工作天未列印"
'         MAPIMessages1.MsgNoteText = "Dear 葉經理：" & vbCrLf & vbCrLf & "　　有智慧局註冊費通知函超過5工作天的資料未列印, 請注意 !!" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心"
'         MAPIMessages1.RecipIndex = 0
'         MAPIMessages1.RecipDisplayName = "67002"
'         MAPIMessages1.ResolveName
'         tmpnext = "準備存入郵件..."
'         MAPIMessages1.Send
'         MAPISession1.SignOff
      End If
   End With
   tmpnext = "關檔..."
   Set Rs = Nothing
'   Set cnnConnection = Nothing
   Exit Sub
DebugErr:
   WLog tmpnext & " " & Err.Description
   'Add by Morgan 2009/4/3 發信失敗要登出
'   If MAPISession1.SessionID <> 0 Then MAPISession1.SignOff
End Sub
'2007/9/13 end
   

Function GetF_CP14(oKey As String) As String
'edit by nick 2005/01/17 新案才發國外承辦人
'StrSql = " select cp14,st02,cp01||'-'||cp02||'-'||cp03||'-'||cp04,st03 From CASEMAP, CASEPROGRESS, STAFF where cm01=cp01(+) and cm02=cp02(+) and cm03=cp03(+) and cm04=cp04(+) and CP14=ST01(+) AND CP31='Y' and cm05='" & SystemNumber(oKey, 1) & "' and cm06='" & SystemNumber(oKey, 2) & "' and cm07='" & SystemNumber(oKey, 3) & "' and cm08='" & SystemNumber(oKey, 4) & "' and cp57 is null and cp27 is null "
'edit by nickc 2005/09/30
'strSQL = " select cp14,st02,cp01||'-'||cp02||'-'||cp03||'-'||cp04,st03 From CASEMAP, CASEPROGRESS, STAFF where cm01=cp01(+) and cm02=cp02(+) and cm03=cp03(+) and cm04=cp04(+) and CP14=ST01(+) AND CP31='Y' and cm05='" & SystemNumber(oKey, 1) & "' and cm06='" & SystemNumber(oKey, 2) & "' and cm07='" & SystemNumber(oKey, 3) & "' and cm08='" & SystemNumber(oKey, 4) & "' and cp57 is null and cp27 is null and cp31='Y' "
'strSQL = " select cp14,st02,cp01||'-'||cp02||'-'||cp03||'-'||cp04,st03 From CASEMAP, CASEPROGRESS, STAFF where cm01=cp01(+) and cm02=cp02(+) and cm03=cp03(+) and cm04=cp04(+) and CP14=ST01(+) AND CP31='Y' and cm05='" & SystemNumber(oKey, 1) & "' and cm06='" & SystemNumber(oKey, 2) & "' and cm07='" & SystemNumber(oKey, 3) & "' and cm08='" & SystemNumber(oKey, 4) & "' and cp57 is null and cp27 is null and cp31='Y' and cm10='0' "
'Modified by Lydia 2016/09/14 cp57 is null and cp27 is null => CP158=0 AND CP159=0
strSql = " select cp14,st02,cp01||'-'||cp02||'-'||cp03||'-'||cp04,st03 From CASEMAP, CASEPROGRESS, STAFF where cm01=cp01(+) and cm02=cp02(+) and cm03=cp03(+) and cm04=cp04(+) and CP14=ST01(+) AND CP31='Y' and cm05='" & SystemNumber(oKey, 1) & "' and cm06='" & SystemNumber(oKey, 2) & "' and cm07='" & SystemNumber(oKey, 3) & "' and cm08='" & SystemNumber(oKey, 4) & "' and CP158=0 AND CP159=0 and cp31='Y' and cm10='0' and cp10 in (" & GetAddStr(CaseMapOut) & ") "
'If cnnConnection.State = adStateClosed Then
'   cnnConnection.ConnectionString = CnStr
'   cnnConnection.Open
'End If
GetF_CP14 = ""
F_ST02 = ""
F_CP01020304 = ""
F_ST03 = ""
CheckOC
With adoRecordset
    .CursorLocation = adUseClient
    .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
    If .RecordCount <> 0 And .RecordCount > 0 Then
        .MoveFirst
        Do While Not .EOF
            If SystemNumber(UCase(CheckStr(.Fields(2).Value)), 1) <> "P" Then
                GetF_CP14 = GetF_CP14 & CheckStr(.Fields(0).Value) & ","
                F_ST02 = F_ST02 & CheckStr(.Fields(1).Value) & ","
                F_CP01020304 = F_CP01020304 & CheckStr(.Fields(2).Value) & ","
                F_ST03 = F_ST03 & CheckStr(.Fields(3).Value) & ","
            End If
            .MoveNext
        Loop
    Else
        GetF_CP14 = ""
        F_ST02 = ""
        F_CP01020304 = ""
        F_ST03 = ""
    End If
End With
If Right(GetF_CP14, 1) = "," Then GetF_CP14 = Mid(GetF_CP14, 1, Len(GetF_CP14) - 1)
If Right(F_ST02, 1) = "," Then F_ST02 = Mid(F_ST02, 1, Len(F_ST02) - 1)
If Right(F_CP01020304, 1) = "," Then F_CP01020304 = Mid(F_CP01020304, 1, Len(F_CP01020304) - 1)
If Right(F_ST03, 1) = "," Then F_ST03 = Mid(F_ST03, 1, Len(F_ST03) - 1)
'   If cnnConnection.State = adStateClosed Then
'      cnnConnection.ConnectionString = CnStr
'      cnnConnection.Open
'   End If
End Function

'僅限 11/01 作
'Sub StrMenu10()
'Dim tmpnext, tmpM_cp09, tmpM_cp48
'Dim rs3 As New ADODB.Recordset
'
'   CheckOC
'   strSQL = "  select distinct c2.cp01||'-'||c2.cp02||'-'||c2.cp03||'-'||c2.cp04 as sortA,c2.cp31 as cp31,st02,c2.cp14 as cp14,e2.ep09 as ep09 ,e2.ep06 as ep06,c2.cp09 as cp09,e2.ep07 as ep07 From CASEMAP, CASEPROGRESS c1,engineerprogress e1, STAFF,caseprogress c2,engineerprogress e2 where cm01='CFP' and cm01=c1.cp01(+) and cm02=c1.cp02(+) and cm03=c1.cp03(+) and cm04=c1.cp04(+) and c2.CP14=ST01(+) AND c1.CP31='Y'  and c1.cp57 is null and c1.cp27 is null and cm10='0' and c1.cp10 in ('101','102','103','104','109','110','112','113','114','115','118','122','201','307') " & _
'                  "  and c1.cp09=e1.ep02 and e1.ep06 is null and cm05=c2.cp01(+) and cm06=c2.cp02(+) and cm07=c2.cp03(+) and cm08=c2.cp04(+) and c2.cp09=e2.ep02(+) and e2.ep07 is not null "
'Set RS = New ADODB.Recordset
'RS.CursorLocation = adUseClient
'RS.Open strSQL, cnnConnection, adOpenStatic, adLockReadOnly
'tmpnext = "已取得資料...正常"
'With RS
'    If .RecordCount > 0 And .RecordCount <> 0 Then
'        .MoveFirst
'        Do While Not .EOF
'            F_CP14 = ""
'            F_ST02 = ""
'            F_ST03 = ""
'            F_CP01020304 = ""
'            F_CP14 = GetF_CP14(CheckStr(.Fields("sortA")))
'            If SystemNumber(Trim(CheckStr(.Fields("sortA"))), 1) = "P" And F_CP14 <> "" And UCase(CheckStr(.Fields("cp31"))) = "Y" Then
'                's = MsgBox("本案有國外案件(" & F_CP01020304 & ")一併申請，請將資料轉給國外承辦人(" & F_ST02 & ")！", , "警告！")
'                SendMail Server$, "系統管理員", "Administrator", CheckStr(.Fields("st02")), CheckStr(.Fields("cp14")), "◎系統代發提醒通知◎" & "本案(" & CheckStr(.Fields("sortA")) & ")有國外案件(" & F_CP01020304 & ")一併申請，請將資料轉給國外承辦人(" & F_ST02 & ")！", "此訊息是半夜系統自動代發！" & vbCrLf & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心"
'
'                'add by nick 2004/12/16  修正發 mail  每個人都要發
'                Dim tmpArr931216_F_ST03 As Variant
'                Dim tmpArr931216_F_CP14 As Variant
'                Dim tmpArr931216_F_CP01020303 As Variant
'                Dim tmpIndexI As Integer
'                Dim tmpF_CP0104 As String
'                Dim tmpDelayDay As Integer
'                Dim tmpP_Rs As New ADODB.Recordset
'                tmpArr931216_F_ST03 = Split(F_ST03, ",")
'                tmpArr931216_F_CP14 = Split(F_CP14, ",")
'                tmpArr931216_F_CP01020303 = Split(F_CP01020304, ",")
'                For tmpIndexI = 0 To UBound(tmpArr931216_F_ST03)
'                    '將本會稿完成日上到相關國外的文件齊備日，並重算承辦期限
'                    tmpF_CP0104 = tmpArr931216_F_CP01020303(tmpIndexI)
'                    strSQL = "select cp06,cp09,pa01,pa09,cp10 from caseprogress,engineerprogress,patent where pa01='" & SystemNumber(tmpF_CP0104, 1) & "' and pa02='" & SystemNumber(tmpF_CP0104, 2) & "' and pa03='" & SystemNumber(tmpF_CP0104, 3) & "' and pa04='" & SystemNumber(tmpF_CP0104, 4) & "' " & _
'                                                       " and pa01=cp01(+) and pa02=cp02(+) and pa03=cp03(+) and pa04=cp04(+)  and cp10 in (" & GetAddStr(CaseMapOut) & ") and cp09=ep02(+) and ep06 is null "
'                    Set rs3 = New ADODB.Recordset
'                    If rs3.State = 1 Then rs3.Close
'                       rs3.CursorLocation = adUseClient
'                       rs3.Open strSQL, cnnConnection, adOpenStatic, adLockReadOnly
'                       If rs3.RecordCount <> 0 Then
'                            rs3.MoveFirst
'                            Do While Not rs3.EOF
'                                'edit by nickc 2005/09/30 若是相關是 CFP 則看 P 有沒延遲，有要扣 CFP 的天數，且要同一承辦人
'                                tmpDelayDay = 0
'                                If SystemNumber(tmpF_CP0104, 1) = "CFP" And F_CP14 = Trim(Left(CheckStr(.Fields("cp14")), 6)) Then
'                                    tmpDelayDay = GetWorkDay(CheckStr(.Fields("ep09")), CheckStr(.Fields("ep06")))
'                                    Set tmpP_Rs = New ADODB.Recordset
'                                    If tmpP_Rs.State = 1 Then tmpP_Rs.Close
'                                    tmpP_Rs.CursorLocation = adUseClient
'                                    tmpP_Rs.Open "select * from casefee,caseprogress,patent where cp09='" & CheckStr(.Fields("cp09")) & "' and cp01=pa01(+) and cp02=pa02(+) and cp03=pa03(+) and cp04=pa04(+) and cp01=cf01 and cf02=pa09 and cf03=cp10 and cp14='" & Trim(Left(CheckStr(.Fields("cp14")), 6)) & "' ", cnnConnection, adOpenStatic, adLockReadOnly
'                                    If tmpP_Rs.RecordCount <> 0 Then
'                                          If tmpDelayDay > CheckStr(tmpP_Rs.Fields("cf04").Value) Then
'                                                tmpDelayDay = tmpDelayDay - Val(CheckStr(tmpP_Rs.Fields("cf04").Value))
'                                          Else
'                                                tmpDelayDay = 0
'                                          End If
'                                    Else
'                                       tmpDelayDay = 0
'                                    End If
'                                End If
'                                tmpM_cp09 = "" & rs3.Fields("cp09").Value
'                                tmpM_cp48 = Pub_GetHandleDay(CheckStr(rs3.Fields("pa01")), CheckStr(rs3.Fields("pa09")), CheckStr(rs3.Fields("cp10")), CheckStr(.Fields("ep07")), CheckStr(rs3.Fields("cp06")), CheckStr(rs3.Fields("cp09")), tmpDelayDay)
'                                If tmpM_cp48 <> "" Then
'                                    cnnConnection.Execute "update engineerprogress set ep06=" & CheckStr(.Fields("ep07")) & " where ep02='" & tmpM_cp09 & "' "
'                                    cnnConnection.Execute "update caseprogress set cp48=" & tmpM_cp48 & " Where cp09='" & tmpM_cp09 & "'  "
'                                    SendMail Server$, "系統管理員", "Administrator", "nickc", "93013", "◎訊息紀錄◎" & "本案(" & CheckStr(.Fields("sortA")) & ")有國外案件(" & F_CP01020304 & ")，國外承辦人(" & F_ST02 & ")，更新收文號：" & tmpM_cp09 & "；齊備日：" & CheckStr(.Fields("ep07")) & "；承辦期限：" & tmpM_cp48 & " ！", "此訊息是半夜系統自動代發！" & vbCrLf & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心"
'                                End If
'                                rs3.MoveNext
'                            Loop
'                       End If
'                    Set rs3 = Nothing
'                    tmpnext = "已取得資料...正常...準備 發 mail "
'                    If UCase(tmpArr931216_F_ST03(tmpIndexI)) = "F51" Or UCase(tmpArr931216_F_ST03(tmpIndexI)) = "F52" Then
'                        SendMail Server$, CheckStr(.Fields("st02")), CheckStr(.Fields("cp14")), GetPrjSalesNM(Pub_GetSpecMan("H")), Pub_GetSpecMan("H"), "◎系統代發提醒通知◎" & CheckStr(.Fields("sortA")) & "已輸會稿日！(相關國外案：" + tmpArr931216_F_CP01020303(tmpIndexI) + ")", "此訊息是半夜系統自動代發！"
'                    Else
'                        SendMail Server$, CheckStr(.Fields("st02")), CheckStr(.Fields("cp14")), GetPrjSalesNM(tmpArr931216_F_CP14(tmpIndexI)), tmpArr931216_F_CP14(tmpIndexI), "◎系統代發提醒通知◎" & CheckStr(.Fields("sortA")) & "已輸會稿日！(相關國外案：" + tmpArr931216_F_CP01020303(tmpIndexI) + ")", "此訊息是半夜系統自動代發！"
'                    End If
'                 Next tmpIndexI
'                 If GetStaffDepartment(CheckStr(.Fields("cp14"))) <> "P12" And ((CheckStr(.Fields("cp10")) >= "101" And CheckStr(.Fields("cp10")) <= "107") Or (CheckStr(.Fields("cp10")) >= "201" And CheckStr(.Fields("cp10")) <= "206") Or (CheckStr(.Fields("cp10")) >= "501" And CheckStr(.Fields("cp10")) <= "504") Or (CheckStr(.Fields("cp10")) >= "801" And CheckStr(.Fields("cp10")) <= "804")) Then
'                      SendMail Server$, CheckStr(.Fields("st02")), CheckStr(.Fields("cp14")), GetPrjSalesNM(CheckStr(.Fields("cp13"))), CheckStr(.Fields("cp13")), "◎系統代發提醒通知◎" & CheckStr(.Fields("sortA")) & "已輸會稿日！", "此訊息是半夜系統自動代發！" & vbCrLf + "客戶名稱：" & GetCustomerName(CheckStr(.Fields("pa26"))) & vbCrLf & "本所案號： " + CheckStr(.Fields("sortA")) + vbCrLf + "案件名稱： " + CheckStr(.Fields("PAName")) + vbCrLf + "案件性質： " + CheckStr(.Fields("CPMName")) + vbCrLf + "本所期限： " + CheckStr(.Fields("cp06t")) + vbCrLf + "法定期限： " + CheckStr(.Fields("cp07t")) + vbCrLf + "會稿完成日：" + CheckStr(.Fields("cp27t")) + vbCrLf + vbCrLf + "已完成會稿！"
'                 End If
'            End If
'            .MoveNext
'        Loop
'    End If
'End With
'End Sub

'edit by nickc 2008/05/14 改成 超過 5工作天
'add by nickc 2008/04/28 智權人員未收款管制超過 2 工作天未收
Sub StrMenu10()
 On Error GoTo DebugErr
'   Dim oDiffTB As String
   Dim stCon As String
   Dim strCon As String
   Dim strTempS(1 To 3) As String
   Dim strTemp(1 To 10) As String
   Dim m_i As Integer
   Dim ff As Integer
   Dim TempFileName As String
   TempFileName = "預定收款明細.txt"
   Dim SeekMail() As MailQ
   Dim tmpnext As String
   Dim IsFind As Boolean
   Dim strSubject As String, strContent As String, TempFilePathName As String 'Add By Sindy 2011/10/27
   
'tmpnext = "準備連資料庫..."
'Set cnnConnection = New ADODB.Connection
'cnnConnection.ConnectionString = CnStr
'cnnConnection.Open
'   oDiffTB = "  select a0k01 oKey,SUM(nvl(a0k06,0)+nvl(a0k07,0)-PAY) diff FROM(  "
'   oDiffTB = oDiffTB & "  SELECT A0K01,nvl(A0K06,0)-sum(nvl(a1u07,0)) as a0k06,nvl(A0K07,0)-sum(nvl(a1u09,0)) as a0k07,sum(nvl(a1u04,0))-sum(nvl(a1u08,0))+sum(nvl(a1u05,0))-sum(nvl(a1u10,0)) PAY "
'   oDiffTB = oDiffTB & "  from acc0k0,ACC1U0 WHERE  (a0k09 is null or a0k09 = 0) AND A0K01=A1U02(+) "
'   oDiffTB = oDiffTB & " and (nvl(a0k06,0)+nvl(a0k07,0)) > (nvl(a0k17,0)+nvl(a0k18,0)) "
'   oDiffTB = oDiffTB & " GROUP BY A0K01,nvl(A0K06,0),nvl(A0K07,0) ) AA "
'   oDiffTB = oDiffTB & " where (nvl(a0k06,0)+nvl(a0k07,0)) > PAY GROUP BY a0k01 "

   'stCon = "select '' as V,decode(AA.所別,'1','北所','2','中所','3','南所','4','高所','其他') as 所別,a0902 as 管制人部門,s3.st02 as 管制人,s1.st02 as 收文智權人員,decode(AA.分類,'1','未發文','2','未處理','3','行事曆','4','未回覆','5','未通知','6','未收款','') as 事件分類,AA.本所期限,AA.法定期限,AA.本所案號,AA.分所號,AA.案件名稱,AA.案件性質,s2.st02 as 承辦人,AA.收文日,AA.發文日,AA.申請人,AA.申請國家,AA.申請案號,AA.收文號,AA.序號 from (" & stCon & ") AA,acc090,staff S1,Staff S2,staff S3 where AA.管制人部門=a0901(+) and AA.收文智權人員=s1.st01(+) and AA.承辦人=s2.st01(+) and AA.管制人=s3.st01(+)  order by AA.所別,AA.管制人部門,AA.管制人,AA.分類,substr(AA.本所期限,2),AA.本所案號 "
   
   'Modified by Morgan 2011/11/23 考慮拆收據情形改抓acc0j0,另+rd06 is null條件
   'strCon = "SELECT st06,a0k01,a0k02,a0k22,a0k20,ST02,A0K03,SUBSTR(CU04,1,10) as cu04,DIFF ,Acase ,pay,min(cp01||'-'||cp02||'-'||cp03||'-'||cp04) as ocp FROM ("
   strCon = "SELECT st06,a0k01,a0k02,a0k22,a0k20,ST02,A0K03,SUBSTR(NVL(NVL(CU04,CU05),CU06),1,10) as cu04,DIFF ,Acase ,pay,min(a0j01) as a0j01 FROM ("
   'end 2011/11/23
   
   strCon = strCon & "  select a0k01,a0k02,A0K03,a0k20,a0k22,SUM(nvl(a0k06,0)+nvl(a0k07,0)-PAY) DIFF,SUM(nvl(a0k06,0)+nvl(a0k07,0)) Acase,sum(pay) pay FROM( "
   strCon = strCon & " SELECT A0K01,a0k02,A0K03,a0k20,a0k22,nvl(A0K06,0)-sum(nvl(a1u07,0)) as a0k06,nvl(A0K07,0)-sum(nvl(a1u09,0)) as a0k07,sum(nvl(a1u04,0))-sum(nvl(a1u08,0))+sum(nvl(a1u05,0))-sum(nvl(a1u10,0)) PAY"
   strCon = strCon & " from acc0k0,ACC1U0 WHERE (a0k09 is null or a0k09 = 0) AND A0K01=A1U02(+)"
   strCon = strCon & " and (nvl(a0k06,0)+nvl(a0k07,0)) > (nvl(a0k17,0)+nvl(a0k18,0)) "
   strCon = strCon & " GROUP BY A0K01,a0k02,A0K03,a0k20,a0k22,nvl(A0K06,0),nvl(A0K07,0) ) AA"
   strCon = strCon & " where (nvl(a0k06,0)+nvl(a0k07,0)) > PAY GROUP BY a0k01,a0k02,A0K03,a0k20,a0k22"
   
   'Modified by Morgan 2011/11/23 考慮拆收據情形改抓acc0j0,另+rd06 is null條件
   'strCon = strCon & " ) NEW,CUSTOMER,STAFF,caseprogress "
   'strCon = strCon & " WHERE a0k01=cp60(+) and SUBSTR(A0K03,1,8)=CU01(+) AND SUBSTR(A0K03,9,1)=CU02(+) AND a0k20=ST01(+) and diff<>0 "
   strCon = strCon & " ) NEW,CUSTOMER,STAFF,acc0j0 "
   strCon = strCon & " WHERE a0k01=a0j13(+) and SUBSTR(A0K03,1,8)=CU01(+) AND SUBSTR(A0K03,9,1)=CU02(+) AND a0k20=ST01(+) and diff<>0 "
   'end 2011/11/23
   
   strCon = strCon & " group by st06,A0K01,a0k22,a0k20,ST02,a0k02,A0K03,SUBSTR(NVL(NVL(CU04,CU05),CU06),1,10),DIFF,Acase,pay "
   'edit by nickc 2008/05/29 北所 5 天，分所 7 天
   '2008/6/17 modify by sonia 加 a0901 判斷業務區,非智權部不必給杜副總
   
   'Modified by Morgan 2011/11/23 考慮拆收據情形改抓acc0j0,另+rd06 is null條件
   'stCon = "select decode(AA.st06,'1','北所','2','中所','3','南所','4','高所','其他') as 所別,a0902 as 部門,aa.st02 as 智權人員,aa.cu04 as 申請人,aa.ocp as 本所案號,sqldatet(AA.a0k02) as 收據日期,AA.a0k01 as 收據號碼,TO_CHAR(AA.Acase,'999,999,999') 收據金額,TO_CHAR(AA.diff,'999,999,999') 未收金額,sqldatet(rd05) 預定收款日,AA.st06||AA.a0k22||' '||AA.a0k20||' '||AA.cu04||'1' as osort,a0908 as okey1,a0k20 as okey2,a0901 from (" & strCon & ") AA,acc090,(select * from ReceivablesDay where (rd01,rd02,rd03) in (select rd01,rd02,max(rd03) from ReceivablesDay where (rd01,rd02) in (select rd01,max(rd02) from ReceivablesDay group by rd01) group by rd01,rd02)) BB,caseprogress,patent where AA.a0k22=a0901(+) and AA.a0k01=cp60(+) and cp09=BB.RD01(+) and cp01=pa01 and cp02=pa02 and cp03=pa03 and cp04=pa04 and pa09<>'000' and AA.st06='1' and BB.rd05<=" & (CompWorkDay(6, strSrvDate(1), 1)) & "  "
   'stCon = stCon & " union select decode(AA.st06,'1','北所','2','中所','3','南所','4','高所','其他') as 所別,a0902 as 部門,aa.st02 as 智權人員,aa.cu04 as 申請人,aa.ocp as 本所案號,sqldatet(AA.a0k02) as 收據日期,AA.a0k01 as 收據號碼,TO_CHAR(AA.Acase,'999,999,999') 收據金額,TO_CHAR(AA.diff,'999,999,999') 未收金額,sqldatet(rd05) 預定收款日,AA.st06||AA.a0k22||' '||AA.a0k20||' '||AA.cu04||'1' as osort,a0908 as okey1,a0k20 as okey2,a0901 from (" & strCon & ") AA,acc090,(select * from ReceivablesDay where (rd01,rd02,rd03) in (select rd01,rd02,max(rd03) from ReceivablesDay where (rd01,rd02) in (select rd01,max(rd02) from ReceivablesDay group by rd01) group by rd01,rd02)) BB,caseprogress,patent where AA.a0k22=a0901(+) and AA.a0k01=cp60(+) and cp09=BB.RD01(+) and cp01=pa01 and cp02=pa02 and cp03=pa03 and cp04=pa04 and pa09<>'000' and AA.st06<>'1' and BB.rd05<=" & (CompWorkDay(8, strSrvDate(1), 1)) & "  "
   'stCon = stCon & " union select decode(AA.st06,'1','北所','2','中所','3','南所','4','高所','其他') as 所別,a0902 as 部門,aa.st02 as 智權人員,aa.cu04 as 申請人,aa.ocp as 本所案號,sqldatet(AA.a0k02) as 收據日期,AA.a0k01 as 收據號碼,TO_CHAR(AA.Acase,'999,999,999') 收據金額,TO_CHAR(AA.diff,'999,999,999') 未收金額,sqldatet(rd05) 預定收款日,AA.st06||AA.a0k22||' '||AA.a0k20||' '||AA.cu04||'1' as osort,a0908 as okey1,a0k20 as okey2,a0901 from (" & strCon & ") AA,acc090,(select * from ReceivablesDay where (rd01,rd02,rd03) in (select rd01,rd02,max(rd03) from ReceivablesDay where (rd01,rd02) in (select rd01,max(rd02) from ReceivablesDay group by rd01) group by rd01,rd02)) BB,caseprogress,trademark where AA.a0k22=a0901(+) and AA.a0k01=cp60(+) and cp09=BB.RD01(+) and cp01=tm01 and cp02=tm02 and cp03=tm03 and cp04=tm04 and tm10<>'000' and AA.st06='1' and BB.rd05<=" & (CompWorkDay(6, strSrvDate(1), 1)) & "  "
   'stCon = stCon & " union select decode(AA.st06,'1','北所','2','中所','3','南所','4','高所','其他') as 所別,a0902 as 部門,aa.st02 as 智權人員,aa.cu04 as 申請人,aa.ocp as 本所案號,sqldatet(AA.a0k02) as 收據日期,AA.a0k01 as 收據號碼,TO_CHAR(AA.Acase,'999,999,999') 收據金額,TO_CHAR(AA.diff,'999,999,999') 未收金額,sqldatet(rd05) 預定收款日,AA.st06||AA.a0k22||' '||AA.a0k20||' '||AA.cu04||'1' as osort,a0908 as okey1,a0k20 as okey2,a0901 from (" & strCon & ") AA,acc090,(select * from ReceivablesDay where (rd01,rd02,rd03) in (select rd01,rd02,max(rd03) from ReceivablesDay where (rd01,rd02) in (select rd01,max(rd02) from ReceivablesDay group by rd01) group by rd01,rd02)) BB,caseprogress,trademark where AA.a0k22=a0901(+) and AA.a0k01=cp60(+) and cp09=BB.RD01(+) and cp01=tm01 and cp02=tm02 and cp03=tm03 and cp04=tm04 and tm10<>'000' and AA.st06<>'1' and BB.rd05<=" & (CompWorkDay(8, strSrvDate(1), 1)) & "  "
   'stCon = stCon & " union select decode(AA.st06,'1','北所','2','中所','3','南所','4','高所','其他') as 所別,a0902 as 部門,aa.st02 as 智權人員,aa.cu04 as 申請人,aa.ocp as 本所案號,sqldatet(AA.a0k02) as 收據日期,AA.a0k01 as 收據號碼,TO_CHAR(AA.Acase,'999,999,999') 收據金額,TO_CHAR(AA.diff,'999,999,999') 未收金額,sqldatet(rd05) 預定收款日,AA.st06||AA.a0k22||' '||AA.a0k20||' '||AA.cu04||'1' as osort,a0908 as okey1,a0k20 as okey2,a0901 from (" & strCon & ") AA,acc090,(select * from ReceivablesDay where (rd01,rd02,rd03) in (select rd01,rd02,max(rd03) from ReceivablesDay where (rd01,rd02) in (select rd01,max(rd02) from ReceivablesDay group by rd01) group by rd01,rd02)) BB,caseprogress,servicepractice where AA.a0k22=a0901(+) and AA.a0k01=cp60(+) and cp09=BB.RD01(+) and cp01=sp01 and cp02=sp02 and cp03=sp03 and cp04=sp04 and sp09<>'000' and AA.st06='1' and BB.rd05<=" & (CompWorkDay(6, strSrvDate(1), 1)) & "  "
   'stCon = stCon & " union select decode(AA.st06,'1','北所','2','中所','3','南所','4','高所','其他') as 所別,a0902 as 部門,aa.st02 as 智權人員,aa.cu04 as 申請人,aa.ocp as 本所案號,sqldatet(AA.a0k02) as 收據日期,AA.a0k01 as 收據號碼,TO_CHAR(AA.Acase,'999,999,999') 收據金額,TO_CHAR(AA.diff,'999,999,999') 未收金額,sqldatet(rd05) 預定收款日,AA.st06||AA.a0k22||' '||AA.a0k20||' '||AA.cu04||'1' as osort,a0908 as okey1,a0k20 as okey2,a0901 from (" & strCon & ") AA,acc090,(select * from ReceivablesDay where (rd01,rd02,rd03) in (select rd01,rd02,max(rd03) from ReceivablesDay where (rd01,rd02) in (select rd01,max(rd02) from ReceivablesDay group by rd01) group by rd01,rd02)) BB,caseprogress,servicepractice where AA.a0k22=a0901(+) and AA.a0k01=cp60(+) and cp09=BB.RD01(+) and cp01=sp01 and cp02=sp02 and cp03=sp03 and cp04=sp04 and sp09<>'000' and AA.st06<>'1' and BB.rd05<=" & (CompWorkDay(8, strSrvDate(1), 1)) & "  "
   'stCon = stCon & " union select decode(AA.st06,'1','北所','2','中所','3','南所','4','高所','其他') as 所別,a0902 as 部門,aa.st02 as 智權人員,aa.cu04 as 申請人,aa.ocp as 本所案號,sqldatet(AA.a0k02) as 收據日期,AA.a0k01 as 收據號碼,TO_CHAR(AA.Acase,'999,999,999') 收據金額,TO_CHAR(AA.diff,'999,999,999') 未收金額,sqldatet(rd05) 預定收款日,AA.st06||AA.a0k22||' '||AA.a0k20||' '||AA.cu04||'1' as osort,a0908 as okey1,a0k20 as okey2,a0901 from (" & strCon & ") AA,acc090,(select * from ReceivablesDay where (rd01,rd02,rd03) in (select rd01,rd02,max(rd03) from ReceivablesDay where (rd01,rd02) in (select rd01,max(rd02) from ReceivablesDay group by rd01) group by rd01,rd02)) BB,caseprogress,lawcase where AA.a0k22=a0901(+) and AA.a0k01=cp60(+) and cp09=BB.RD01(+) and cp01=lc01 and cp02=lc02 and cp03=lc03 and cp04=lc04 and lc15<>'000' and AA.st06='1' and BB.rd05<=" & (CompWorkDay(6, strSrvDate(1), 1)) & "  "
   'stCon = stCon & " union select decode(AA.st06,'1','北所','2','中所','3','南所','4','高所','其他') as 所別,a0902 as 部門,aa.st02 as 智權人員,aa.cu04 as 申請人,aa.ocp as 本所案號,sqldatet(AA.a0k02) as 收據日期,AA.a0k01 as 收據號碼,TO_CHAR(AA.Acase,'999,999,999') 收據金額,TO_CHAR(AA.diff,'999,999,999') 未收金額,sqldatet(rd05) 預定收款日,AA.st06||AA.a0k22||' '||AA.a0k20||' '||AA.cu04||'1' as osort,a0908 as okey1,a0k20 as okey2,a0901 from (" & strCon & ") AA,acc090,(select * from ReceivablesDay where (rd01,rd02,rd03) in (select rd01,rd02,max(rd03) from ReceivablesDay where (rd01,rd02) in (select rd01,max(rd02) from ReceivablesDay group by rd01) group by rd01,rd02)) BB,caseprogress,lawcase where AA.a0k22=a0901(+) and AA.a0k01=cp60(+) and cp09=BB.RD01(+) and cp01=lc01 and cp02=lc02 and cp03=lc03 and cp04=lc04 and lc15<>'000' and AA.st06<>'1' and BB.rd05<=" & (CompWorkDay(8, strSrvDate(1), 1)) & "  "
   'Modified by Lydia 2017/06/21 針對超過預定收款日未收款之控制,取消申請國家<>'000'的限制
   'Modified by Lydia 2017/06/22 還原
   stCon = "select decode(AA.st06,'1','北所','2','中所','3','南所','4','高所','其他') as 所別,a0902 as 部門,aa.st02 as 智權人員,aa.cu04 as 申請人,cp01||'-'||cp02||'-'||cp03||'-'||cp04 as 本所案號,sqldatet(AA.a0k02) as 收據日期,AA.a0k01 as 收據號碼,TO_CHAR(AA.Acase,'999,999,999') 收據金額,TO_CHAR(AA.diff,'999,999,999') 未收金額,sqldatet(rd05) 預定收款日,AA.st06||AA.a0k22||' '||AA.a0k20||' '||AA.cu04||'1' as osort,a0908 as okey1,a0k20 as okey2,a0901 from (" & strCon & ") AA,acc090,(select * from ReceivablesDay where (rd01,rd02,rd03) in (select rd01,rd02,max(rd03) from ReceivablesDay where (rd01,rd02) in (select rd01,max(rd02) from ReceivablesDay where rd06 is null group by rd01) group by rd01,rd02)) BB,caseprogress,patent where AA.a0k22=a0901(+) and AA.a0j01=cp09(+) and cp09=BB.RD01(+) and cp01=pa01 and cp02=pa02 and cp03=pa03 and cp04=pa04 and pa09<>'000' and AA.st06='1' and BB.rd05<=" & (CompWorkDay(6, strSrvDate(1), 1)) & "  "
   stCon = stCon & " union select decode(AA.st06,'1','北所','2','中所','3','南所','4','高所','其他') as 所別,a0902 as 部門,aa.st02 as 智權人員,aa.cu04 as 申請人,cp01||'-'||cp02||'-'||cp03||'-'||cp04 as 本所案號,sqldatet(AA.a0k02) as 收據日期,AA.a0k01 as 收據號碼,TO_CHAR(AA.Acase,'999,999,999') 收據金額,TO_CHAR(AA.diff,'999,999,999') 未收金額,sqldatet(rd05) 預定收款日,AA.st06||AA.a0k22||' '||AA.a0k20||' '||AA.cu04||'1' as osort,a0908 as okey1,a0k20 as okey2,a0901 from (" & strCon & ") AA,acc090,(select * from ReceivablesDay where (rd01,rd02,rd03) in (select rd01,rd02,max(rd03) from ReceivablesDay where (rd01,rd02) in (select rd01,max(rd02) from ReceivablesDay where rd06 is null group by rd01) group by rd01,rd02)) BB,caseprogress,patent where AA.a0k22=a0901(+) and AA.a0j01=cp09(+) and cp09=BB.RD01(+) and cp01=pa01 and cp02=pa02 and cp03=pa03 and cp04=pa04 and pa09<>'000' and AA.st06<>'1' and BB.rd05<=" & (CompWorkDay(8, strSrvDate(1), 1)) & "  "
   stCon = stCon & " union select decode(AA.st06,'1','北所','2','中所','3','南所','4','高所','其他') as 所別,a0902 as 部門,aa.st02 as 智權人員,aa.cu04 as 申請人,cp01||'-'||cp02||'-'||cp03||'-'||cp04 as 本所案號,sqldatet(AA.a0k02) as 收據日期,AA.a0k01 as 收據號碼,TO_CHAR(AA.Acase,'999,999,999') 收據金額,TO_CHAR(AA.diff,'999,999,999') 未收金額,sqldatet(rd05) 預定收款日,AA.st06||AA.a0k22||' '||AA.a0k20||' '||AA.cu04||'1' as osort,a0908 as okey1,a0k20 as okey2,a0901 from (" & strCon & ") AA,acc090,(select * from ReceivablesDay where (rd01,rd02,rd03) in (select rd01,rd02,max(rd03) from ReceivablesDay where (rd01,rd02) in (select rd01,max(rd02) from ReceivablesDay where rd06 is null group by rd01) group by rd01,rd02)) BB,caseprogress,trademark where AA.a0k22=a0901(+) and AA.a0j01=cp09(+) and cp09=BB.RD01(+) and cp01=tm01 and cp02=tm02 and cp03=tm03 and cp04=tm04 and tm10<>'000' and AA.st06='1' and BB.rd05<=" & (CompWorkDay(6, strSrvDate(1), 1)) & "  "
   stCon = stCon & " union select decode(AA.st06,'1','北所','2','中所','3','南所','4','高所','其他') as 所別,a0902 as 部門,aa.st02 as 智權人員,aa.cu04 as 申請人,cp01||'-'||cp02||'-'||cp03||'-'||cp04 as 本所案號,sqldatet(AA.a0k02) as 收據日期,AA.a0k01 as 收據號碼,TO_CHAR(AA.Acase,'999,999,999') 收據金額,TO_CHAR(AA.diff,'999,999,999') 未收金額,sqldatet(rd05) 預定收款日,AA.st06||AA.a0k22||' '||AA.a0k20||' '||AA.cu04||'1' as osort,a0908 as okey1,a0k20 as okey2,a0901 from (" & strCon & ") AA,acc090,(select * from ReceivablesDay where (rd01,rd02,rd03) in (select rd01,rd02,max(rd03) from ReceivablesDay where (rd01,rd02) in (select rd01,max(rd02) from ReceivablesDay where rd06 is null group by rd01) group by rd01,rd02)) BB,caseprogress,trademark where AA.a0k22=a0901(+) and AA.a0j01=cp09(+) and cp09=BB.RD01(+) and cp01=tm01 and cp02=tm02 and cp03=tm03 and cp04=tm04 and tm10<>'000' and AA.st06<>'1' and BB.rd05<=" & (CompWorkDay(8, strSrvDate(1), 1)) & "  "
   stCon = stCon & " union select decode(AA.st06,'1','北所','2','中所','3','南所','4','高所','其他') as 所別,a0902 as 部門,aa.st02 as 智權人員,aa.cu04 as 申請人,cp01||'-'||cp02||'-'||cp03||'-'||cp04 as 本所案號,sqldatet(AA.a0k02) as 收據日期,AA.a0k01 as 收據號碼,TO_CHAR(AA.Acase,'999,999,999') 收據金額,TO_CHAR(AA.diff,'999,999,999') 未收金額,sqldatet(rd05) 預定收款日,AA.st06||AA.a0k22||' '||AA.a0k20||' '||AA.cu04||'1' as osort,a0908 as okey1,a0k20 as okey2,a0901 from (" & strCon & ") AA,acc090,(select * from ReceivablesDay where (rd01,rd02,rd03) in (select rd01,rd02,max(rd03) from ReceivablesDay where (rd01,rd02) in (select rd01,max(rd02) from ReceivablesDay where rd06 is null group by rd01) group by rd01,rd02)) BB,caseprogress,servicepractice where AA.a0k22=a0901(+) and AA.a0j01=cp09(+) and cp09=BB.RD01(+) and cp01=sp01 and cp02=sp02 and cp03=sp03 and cp04=sp04 and sp09<>'000' and AA.st06='1' and BB.rd05<=" & (CompWorkDay(6, strSrvDate(1), 1)) & "  "
   stCon = stCon & " union select decode(AA.st06,'1','北所','2','中所','3','南所','4','高所','其他') as 所別,a0902 as 部門,aa.st02 as 智權人員,aa.cu04 as 申請人,cp01||'-'||cp02||'-'||cp03||'-'||cp04 as 本所案號,sqldatet(AA.a0k02) as 收據日期,AA.a0k01 as 收據號碼,TO_CHAR(AA.Acase,'999,999,999') 收據金額,TO_CHAR(AA.diff,'999,999,999') 未收金額,sqldatet(rd05) 預定收款日,AA.st06||AA.a0k22||' '||AA.a0k20||' '||AA.cu04||'1' as osort,a0908 as okey1,a0k20 as okey2,a0901 from (" & strCon & ") AA,acc090,(select * from ReceivablesDay where (rd01,rd02,rd03) in (select rd01,rd02,max(rd03) from ReceivablesDay where (rd01,rd02) in (select rd01,max(rd02) from ReceivablesDay where rd06 is null group by rd01) group by rd01,rd02)) BB,caseprogress,servicepractice where AA.a0k22=a0901(+) and AA.a0j01=cp09(+) and cp09=BB.RD01(+) and cp01=sp01 and cp02=sp02 and cp03=sp03 and cp04=sp04 and sp09<>'000' and AA.st06<>'1' and BB.rd05<=" & (CompWorkDay(8, strSrvDate(1), 1)) & "  "
   stCon = stCon & " union select decode(AA.st06,'1','北所','2','中所','3','南所','4','高所','其他') as 所別,a0902 as 部門,aa.st02 as 智權人員,aa.cu04 as 申請人,cp01||'-'||cp02||'-'||cp03||'-'||cp04 as 本所案號,sqldatet(AA.a0k02) as 收據日期,AA.a0k01 as 收據號碼,TO_CHAR(AA.Acase,'999,999,999') 收據金額,TO_CHAR(AA.diff,'999,999,999') 未收金額,sqldatet(rd05) 預定收款日,AA.st06||AA.a0k22||' '||AA.a0k20||' '||AA.cu04||'1' as osort,a0908 as okey1,a0k20 as okey2,a0901 from (" & strCon & ") AA,acc090,(select * from ReceivablesDay where (rd01,rd02,rd03) in (select rd01,rd02,max(rd03) from ReceivablesDay where (rd01,rd02) in (select rd01,max(rd02) from ReceivablesDay where rd06 is null group by rd01) group by rd01,rd02)) BB,caseprogress,lawcase where AA.a0k22=a0901(+) and AA.a0j01=cp09(+) and cp09=BB.RD01(+) and cp01=lc01 and cp02=lc02 and cp03=lc03 and cp04=lc04 and lc15<>'000' and AA.st06='1' and BB.rd05<=" & (CompWorkDay(6, strSrvDate(1), 1)) & "  "
   stCon = stCon & " union select decode(AA.st06,'1','北所','2','中所','3','南所','4','高所','其他') as 所別,a0902 as 部門,aa.st02 as 智權人員,aa.cu04 as 申請人,cp01||'-'||cp02||'-'||cp03||'-'||cp04 as 本所案號,sqldatet(AA.a0k02) as 收據日期,AA.a0k01 as 收據號碼,TO_CHAR(AA.Acase,'999,999,999') 收據金額,TO_CHAR(AA.diff,'999,999,999') 未收金額,sqldatet(rd05) 預定收款日,AA.st06||AA.a0k22||' '||AA.a0k20||' '||AA.cu04||'1' as osort,a0908 as okey1,a0k20 as okey2,a0901 from (" & strCon & ") AA,acc090,(select * from ReceivablesDay where (rd01,rd02,rd03) in (select rd01,rd02,max(rd03) from ReceivablesDay where (rd01,rd02) in (select rd01,max(rd02) from ReceivablesDay where rd06 is null group by rd01) group by rd01,rd02)) BB,caseprogress,lawcase where AA.a0k22=a0901(+) and AA.a0j01=cp09(+) and cp09=BB.RD01(+) and cp01=lc01 and cp02=lc02 and cp03=lc03 and cp04=lc04 and lc15<>'000' and AA.st06<>'1' and BB.rd05<=" & (CompWorkDay(8, strSrvDate(1), 1)) & "  "
   ''end 2011/11/23
  
   stCon = stCon & " order by oKey1,oKey2,osort "
   CheckOC
Set Rs = New ADODB.Recordset
Rs.CursorLocation = adUseClient
Rs.Open stCon, cnnConnection, adOpenStatic, adLockReadOnly
tmpnext = "已取得資料...正常"
With Rs
    If .RecordCount > 0 And .RecordCount <> 0 Then
        strTempS(1) = ""
        strTempS(2) = "'"
        strTempS(3) = ""
         tmpnext = "開檔中..."
         ReDim Preserve SeekMail(0) As MailQ
        SeekMail(UBound(SeekMail)).a0k20 = "94007" '"68006"
        SeekMail(UBound(SeekMail)).Name = GetPrjSalesNM("94007")
        .MoveFirst
        Do While Not .EOF
            For m_i = 1 To 10
                strTemp(m_i) = CheckStr(.Fields(m_i - 1))
            Next m_i
'            If CheckStr(.Fields("okey1")) <> strTempS(1) Then
'                strTempS(1) = CheckStr(.Fields("okey1"))
'                strTempS(2) = CheckStr(.Fields("okey2"))
'            Else
'                If CheckStr(.Fields("okey2")) <> strTempS(2) Then
'                    strTempS(2) = CheckStr(.Fields("okey2"))
'                End If
'            End If
            strTemp(1) = StrToStr(strTemp(1) & String(6, " "), 3)
            strTemp(2) = StrToStr(StrToStr(strTemp(2), 4) & String(9, " "), 4.5)
            strTemp(3) = StrToStr(StrToStr(strTemp(3), 4) & String(9, " "), 4.5)
            strTemp(4) = StrToStr(StrToStr(strTemp(4), 10) & String(21, " "), 10.5)
            strTemp(5) = StrToStr(strTemp(5) & String(16, " "), 8)
            strTemp(6) = Replace(StrToStr(strTemp(6) & String(10, " "), 4.5), strTemp(6), "") & strTemp(6) & " "
            strTemp(7) = StrToStr(strTemp(7) & String(11, " "), 5.5)
            strTemp(8) = Replace(StrToStr(strTemp(8) & String(10, " "), 4.5), strTemp(8), "") & strTemp(8) & " "
            strTemp(9) = Replace(StrToStr(strTemp(9) & String(10, " "), 4.5), strTemp(9), "") & strTemp(9) & " "
            strTemp(10) = Replace(StrToStr(strTemp(10) & String(10, " "), 4.5), strTemp(10), "") & strTemp(10) & " "
            tmpnext = "寫檔..."
            '智權人員
            IsFind = False
            For m_i = 0 To UBound(SeekMail)
                If SeekMail(m_i).a0k20 = CheckStr(.Fields("oKey2")) Then
                    IsFind = True
                    Exit For
                End If
            Next m_i
            If IsFind = True Then
                SeekMail(m_i).Text = SeekMail(m_i).Text & strTemp(1) & strTemp(2) & strTemp(3) & strTemp(4) & strTemp(5) & strTemp(6) & strTemp(7) & strTemp(8) & strTemp(9) & strTemp(10) & vbCrLf
            Else
                ReDim Preserve SeekMail(UBound(SeekMail) + 1) As MailQ
                SeekMail(UBound(SeekMail)).a0k20 = CheckStr(.Fields("oKey2"))
                SeekMail(UBound(SeekMail)).Name = CheckStr(.Fields("智權人員"))
                SeekMail(UBound(SeekMail)).Text = strTemp(1) & strTemp(2) & strTemp(3) & strTemp(4) & strTemp(5) & strTemp(6) & strTemp(7) & strTemp(8) & strTemp(9) & strTemp(10) & vbCrLf
            End If
            '部門主管
            'add by nickc 2008/05/29 中二區不管
            'Modify By Sindy 2010/9/15 避免重覆insert資料到文字檔
            'If Trim(strTemp(2)) <> "中二區" Then
            If Trim(strTemp(2)) <> "中二區" And (CheckStr(.Fields("okey1")) <> CheckStr(.Fields("oKey2"))) Then
            '2010/9/15 End
                IsFind = False
                For m_i = 0 To UBound(SeekMail)
                    If SeekMail(m_i).a0k20 = CheckStr(.Fields("okey1")) Then
                        IsFind = True
                        Exit For
                    End If
                Next m_i
                If IsFind = True Then
                    SeekMail(m_i).Text = SeekMail(m_i).Text & strTemp(1) & strTemp(2) & strTemp(3) & strTemp(4) & strTemp(5) & strTemp(6) & strTemp(7) & strTemp(8) & strTemp(9) & strTemp(10) & vbCrLf
                Else
                    ReDim Preserve SeekMail(UBound(SeekMail) + 1) As MailQ
                    SeekMail(UBound(SeekMail)).a0k20 = CheckStr(.Fields("oKey1"))
                    SeekMail(UBound(SeekMail)).Name = GetPrjSalesNM(CheckStr(.Fields("oKey1")))
                    SeekMail(UBound(SeekMail)).Text = strTemp(1) & strTemp(2) & strTemp(3) & strTemp(4) & strTemp(5) & strTemp(6) & strTemp(7) & strTemp(8) & strTemp(9) & strTemp(10) & vbCrLf
                End If
            End If
            '副總
            IsFind = False
            '2008/6/17 add by sonia 加 a0901 判斷業務區,非智權部不必給杜副總
            If Left(.Fields("a0901"), 1) = "S" Then
            '2008/6/17 end
               For m_i = 0 To UBound(SeekMail)
                   If SeekMail(m_i).a0k20 = "94007" Then '68006
                       IsFind = True
                       Exit For
                   End If
               Next m_i
               If IsFind = True Then
                  SeekMail(m_i).Text = SeekMail(m_i).Text & strTemp(1) & strTemp(2) & strTemp(3) & strTemp(4) & strTemp(5) & strTemp(6) & strTemp(7) & strTemp(8) & strTemp(9) & strTemp(10) & vbCrLf
               Else
                  ReDim Preserve SeekMail(UBound(SeekMail) + 1) As MailQ
                  SeekMail(UBound(SeekMail)).a0k20 = "94007" '"68006"
                  SeekMail(UBound(SeekMail)).Name = GetPrjSalesNM("94007")
                  SeekMail(UBound(SeekMail)).Text = strTemp(1) & strTemp(2) & strTemp(3) & strTemp(4) & strTemp(5) & strTemp(6) & strTemp(7) & strTemp(8) & strTemp(9) & strTemp(10) & vbCrLf
               End If
            End If
'            Print #ff, strTemp(1) & " " & strTemp(2) & "  " & strTemp(3) & "  " & strTemp(4) & " " & strTemp(5) & " " & strTemp(6) & " " & strTemp(7) & " " & strTemp(8) & " " & strTemp(9) & " " & strTemp(10)
'            Print #ff2, strTemp(1) & " " & strTemp(2) & "  " & strTemp(3) & "  " & strTemp(4) & " " & strTemp(5) & " " & strTemp(6) & " " & strTemp(7) & " " & strTemp(8) & " " & strTemp(9) & " " & strTemp(10)
'            Print #ff3, strTemp(1) & " " & strTemp(2) & "  " & strTemp(3) & "  " & strTemp(4) & " " & strTemp(5) & " " & strTemp(6) & " " & strTemp(7) & " " & strTemp(8) & " " & strTemp(9) & " " & strTemp(10)
            .MoveNext
        Loop
    Else
        Exit Sub
    End If
End With
tmpnext = "關檔..."
'Close ff
'Close ff2
'Close ff3

For m_i = 0 To UBound(SeekMail)
    '2008/7/16 modify by sonia 沒資料不要寄
    'If SeekMail(m_i).a0k20 <> "" Then
    If SeekMail(m_i).a0k20 <> "" And SeekMail(m_i).Text <> "" Then
    '2008/7/16 end
        If ff > 0 Then Close #ff
         ff = FreeFile
         'Modify By Sindy 2009/06/04
         'If Dir("C:\" & (Trim(strSrvDate(1))) & " " & SeekMail(m_i).a0k20 & TempFileName) <> "" Then Kill "C:\" & (Trim(strSrvDate(1))) & " " & SeekMail(m_i).a0k20 & TempFileName
         'Open "C:\" & (Trim(strSrvDate(1))) & " " & SeekMail(m_i).a0k20 & TempFileName For Output As ff
         If Dir(App.path & TextPath & (Trim(strSrvDate(1))) & " " & SeekMail(m_i).a0k20 & TempFileName) <> "" Then Kill App.path & TextPath & (Trim(strSrvDate(1))) & " " & SeekMail(m_i).a0k20 & TempFileName
         Open App.path & TextPath & (Trim(strSrvDate(1))) & " " & SeekMail(m_i).a0k20 & TempFileName For Output As ff
         '2009/06/04 End
         'Added by Lydia 2016/10/19 加報表抬頭
         Print #ff, Space(35) & (Trim(strSrvDate(1))) & " " & SeekMail(m_i).a0k20 & TempFileName
         Print #ff, ""
         'end 2016/10/19
         
         Print #ff, "所別  部門     智權人員 申請人               本所案號         收據日期 收據號碼   收據金額  未收金額  預定收款日"
         Print #ff, "===== ======== ======== ==================== =============== ========= ========== ========= ========= =========="
         Print #ff, SeekMail(m_i).Text
         Close ff
         
         'Modify By Sindy 2011/10/27
         strSubject = "屆 預定收款日 且未收款或未收齊，已過 北所五個工作天、分所七個工作天 清單  " & ChangeWStringToWDateString(Trim(strSrvDate(1)))
         strContent = "Dear " & SeekMail(m_i).Name & "：" & vbCrLf & "屆 預定收款日 且未收款或未收齊，已過  北所五個工作天、分所七個工作天  清單 資料如附件！" & vbCrLf & vbCrLf & vbCrLf & vbCrLf & "請橫印！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心"
         TempFilePathName = App.path & TextPath & (Trim(strSrvDate(1))) & " " & SeekMail(m_i).a0k20 & TempFileName
         'Modify By Sindy 2013/8/9 杜副總只要每個月1號收到Mail即可,此異動訊息不對外公開
         'Modify By Sindy 2013/9/2 其他人工作天才寄mail
'         If (SeekMail(m_i).a0k20 <> "68006" And ChkWorkDay(strSrvDate(1)) = True) Or _
'            (SeekMail(m_i).a0k20 = "68006" And CStr(Right(Trim(strSrvDate(1)), 2)) = "01") Then
         If (SeekMail(m_i).a0k20 <> "94007" And ChkWorkDay(strSrvDate(1)) = True) Or _
            (SeekMail(m_i).a0k20 = "94007" And CStr(Right(Trim(strSrvDate(1)), 2)) = "01") Then
         '2013/8/9 END
            'Modify By Sindy 2015/7/29 杜副總改林總,且也必須寄一份給何主秘
            If SeekMail(m_i).a0k20 = "94007" Then
               'Modified by Morgan 2019/9/19
               'SendMAPIMail SeekMail(m_i).a0k20 & ";68009", strSubject, strContent, TempFilePathName
               'cancel by sonia 2020/3/4 此功能已不使用且杜主秘68006退休故先取消
               'SendMAPIMail SeekMail(m_i).a0k20 & ";68006", strSubject, strContent, TempFilePathName
            Else
            '2015/7/29 END
               SendMAPIMail SeekMail(m_i).a0k20, strSubject, strContent, TempFilePathName
            End If
         End If
         
'         '發 mail
'        tmpnext = "準備發 mail..."
'        MAPISession1.LogonUI = False
'        MAPISession1.UserName = "administrator"
'        tmpnext = "準備登入郵件伺服器..."
'        MAPISession1.SignOn
'        tmpnext = "登入郵件伺服器..."
'        MAPIMessages1.SessionID = MAPISession1.SessionID
'        MAPIMessages1.MsgIndex = -1
'        tmpnext = "建立郵件..."
'        MAPIMessages1.Compose
'        'edit by nickc 2008/05/14
'        'MAPIMessages1.MsgSubject = "屆 預定收款日 且未收款或未收齊，已過兩個工作天清單  " & ChangeWStringToWDateString(Trim(strSrvDate(1)))
'        'edit by nickc 2008/05/29 北所5天，分所7天
'        'MAPIMessages1.MsgSubject = "屆 預定收款日 且未收款或未收齊，已過五個工作天清單  " & ChangeWStringToWDateString(Trim(strSrvDate(1)))
'        'MAPIMessages1.MsgNoteText = "Dear " & SeekMail(m_i).name & "：" & vbCrLf & "屆 預定收款日 且未收款或未收齊，已過兩個工作天清單 資料如附件！" & vbCrLf & vbCrLf & vbCrLf & vbCrLf & "請橫印！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心"
'        MAPIMessages1.MsgSubject = "屆 預定收款日 且未收款或未收齊，已過 北所五個工作天、分所七個工作天 清單  " & ChangeWStringToWDateString(Trim(strSrvDate(1)))
'        MAPIMessages1.MsgNoteText = "Dear " & SeekMail(m_i).Name & "：" & vbCrLf & "屆 預定收款日 且未收款或未收齊，已過  北所五個工作天、分所七個工作天  清單 資料如附件！" & vbCrLf & vbCrLf & vbCrLf & vbCrLf & "請橫印！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心"
'        MAPIMessages1.AttachmentIndex = 0
'        MAPIMessages1.AttachmentPosition = 0
'        'Modify By Sindy 2009/06/04
'        'MAPIMessages1.AttachmentPathName = "C:\" & (Trim(strSrvDate(1))) & " " & SeekMail(m_i).a0k20 & TempFileName
'        MAPIMessages1.AttachmentPathName = App.Path & TextPath & (Trim(strSrvDate(1))) & " " & SeekMail(m_i).a0k20 & TempFileName
'        '2009/06/04 End
'        MAPIMessages1.RecipIndex = 0
'        'Modify by Morgan 2009/4/3
'        'MAPIMessages1.RecipDisplayName = SeekMail(m_i).a0k20
'        MAPIMessages1.RecipDisplayName = ChkMailId(SeekMail(m_i).a0k20)
'        MAPIMessages1.ResolveName
'        tmpnext = "準備存入郵件..."
'        MAPIMessages1.Send
'        MAPISession1.SignOff
        'Modify By Sindy 2009/06/04
        'Kill "C:\" & (Trim(strSrvDate(1))) & " " & SeekMail(m_i).a0k20 & TempFileName
        Kill App.path & TextPath & (Trim(strSrvDate(1))) & " " & SeekMail(m_i).a0k20 & TempFileName
        '2009/06/04 End
    End If
Next m_i
Set Rs = Nothing
'Set cnnConnection = Nothing
Exit Sub
DebugErr:
   WLog tmpnext & " " & Err.Description
   'Add by Morgan 2009/4/3 發信失敗要登出
'   If MAPISession1.SessionID <> 0 Then MAPISession1.SignOff
End Sub

'2008/8/5 分所智權人員未收款管制超過 5 工作天未收寄給各所財務
Sub StrMenu11()
 On Error GoTo DebugErr
'   Dim oDiffTB As String
   Dim stCon As String
   Dim strCon As String
   Dim strTempS(1 To 3) As String
   Dim strTemp(1 To 10) As String
   Dim m_i As Integer
   Dim ff As Integer
   Dim TempFileName As String
   TempFileName = "預定收款明細.txt"
   Dim SeekMail() As MailQ
   Dim tmpnext As String
   Dim IsFind As Boolean
   Dim m_receiverno As String
   Dim strSubject As String, strContent As String, TempFilePathName As String 'Add By Sindy 2011/10/27
   
'tmpnext = "準備連資料庫..."
'Set cnnConnection = New ADODB.Connection
'cnnConnection.ConnectionString = CnStr
'cnnConnection.Open
'   oDiffTB = "  select a0k01 oKey,SUM(nvl(a0k06,0)+nvl(a0k07,0)-PAY) diff FROM(  "
'   oDiffTB = oDiffTB & "  SELECT A0K01,nvl(A0K06,0)-sum(nvl(a1u07,0)) as a0k06,nvl(A0K07,0)-sum(nvl(a1u09,0)) as a0k07,sum(nvl(a1u04,0))-sum(nvl(a1u08,0))+sum(nvl(a1u05,0))-sum(nvl(a1u10,0)) PAY "
'   oDiffTB = oDiffTB & "  from acc0k0,ACC1U0 WHERE  (a0k09 is null or a0k09 = 0) AND A0K01=A1U02(+) "
'   oDiffTB = oDiffTB & " and (nvl(a0k06,0)+nvl(a0k07,0)) > (nvl(a0k17,0)+nvl(a0k18,0)) "
'   oDiffTB = oDiffTB & " GROUP BY A0K01,nvl(A0K06,0),nvl(A0K07,0) ) AA "
'   oDiffTB = oDiffTB & " where (nvl(a0k06,0)+nvl(a0k07,0)) > PAY GROUP BY a0k01 "

   'Modified by Morgan 2011/11/23 考慮拆收據情形改抓acc0j0,另+rd06 is null條件
   'strCon = "SELECT st06,a0k01,a0k02,a0k22,a0k20,ST02,A0K03,SUBSTR(CU04,1,10) as cu04,DIFF ,Acase ,pay,min(cp01||'-'||cp02||'-'||cp03||'-'||cp04) as ocp FROM ("
   strCon = "SELECT st06,a0k01,a0k02,a0k22,a0k20,ST02,A0K03,SUBSTR(NVL(NVL(CU04,CU05),CU06),1,10) as cu04,DIFF ,Acase ,pay,min(a0j01) as a0j01 FROM ("
   'end 2011/11/23
   
   strCon = strCon & "  select a0k01,a0k02,A0K03,a0k20,a0k22,SUM(nvl(a0k06,0)+nvl(a0k07,0)-PAY) DIFF,SUM(nvl(a0k06,0)+nvl(a0k07,0)) Acase,sum(pay) pay FROM( "
   strCon = strCon & " SELECT A0K01,a0k02,A0K03,a0k20,a0k22,nvl(A0K06,0)-sum(nvl(a1u07,0)) as a0k06,nvl(A0K07,0)-sum(nvl(a1u09,0)) as a0k07,sum(nvl(a1u04,0))-sum(nvl(a1u08,0))+sum(nvl(a1u05,0))-sum(nvl(a1u10,0)) PAY"
   strCon = strCon & " from acc0k0,ACC1U0 WHERE (a0k09 is null or a0k09 = 0) AND A0K01=A1U02(+)"
   strCon = strCon & " and (nvl(a0k06,0)+nvl(a0k07,0)) > (nvl(a0k17,0)+nvl(a0k18,0)) "
   strCon = strCon & " GROUP BY A0K01,a0k02,A0K03,a0k20,a0k22,nvl(A0K06,0),nvl(A0K07,0) ) AA"
   strCon = strCon & " where (nvl(a0k06,0)+nvl(a0k07,0)) > PAY GROUP BY a0k01,a0k02,A0K03,a0k20,a0k22"
   
   'Modified by Morgan 2011/11/23 考慮拆收據情形改抓acc0j0,另+rd06 is null條件
   'strCon = strCon & " ) NEW,CUSTOMER,STAFF,caseprogress "
   'strCon = strCon & " WHERE a0k01=cp60(+) and SUBSTR(A0K03,1,8)=CU01(+) AND SUBSTR(A0K03,9,1)=CU02(+) AND a0k20=ST01(+) and diff<>0 "
   strCon = strCon & " ) NEW,CUSTOMER,STAFF,acc0j0 "
   strCon = strCon & " WHERE a0k01=a0j13(+) and SUBSTR(A0K03,1,8)=CU01(+) AND SUBSTR(A0K03,9,1)=CU02(+) AND a0k20=ST01(+) and diff<>0 "
   'end 2011/11/23
   
   strCon = strCon & " group by st06,A0K01,a0k22,a0k20,ST02,a0k02,A0K03,SUBSTR(NVL(NVL(CU04,CU05),CU06),1,10),DIFF,Acase,pay "
   '分所 5 天
   'Modified by Morgan 2011/11/23 考慮拆收據情形改抓acc0j0,另+rd06 is null條件
   'stCon = "select decode(AA.st06,'1','北所','2','中所','3','南所','4','高所','其他') as 所別,a0902 as 部門,aa.st02 as 智權人員,aa.cu04 as 申請人,aa.ocp as 本所案號,sqldatet(AA.a0k02) as 收據日期,AA.a0k01 as 收據號碼,TO_CHAR(AA.Acase,'999,999,999') 收據金額,TO_CHAR(AA.diff,'999,999,999') 未收金額,sqldatet(rd05) 預定收款日,AA.st06||AA.a0k22||' '||AA.a0k20||' '||AA.cu04||'1' as osort,a0908 as okey1,a0k20 as okey2,a0901 from (" & strCon & ") AA,acc090,(select * from ReceivablesDay where (rd01,rd02,rd03) in (select rd01,rd02,max(rd03) from ReceivablesDay where (rd01,rd02) in (select rd01,max(rd02) from ReceivablesDay group by rd01) group by rd01,rd02)) BB,caseprogress,patent where AA.a0k22=a0901(+) and AA.a0k01=cp60(+) and cp09=BB.RD01(+) and cp01=pa01 and cp02=pa02 and cp03=pa03 and cp04=pa04 and pa09<>'000' and AA.st06<>'1' and BB.rd05<=" & (CompWorkDay(6, strSrvDate(1), 1)) & "  "
   'stCon = stCon & " union select decode(AA.st06,'1','北所','2','中所','3','南所','4','高所','其他') as 所別,a0902 as 部門,aa.st02 as 智權人員,aa.cu04 as 申請人,aa.ocp as 本所案號,sqldatet(AA.a0k02) as 收據日期,AA.a0k01 as 收據號碼,TO_CHAR(AA.Acase,'999,999,999') 收據金額,TO_CHAR(AA.diff,'999,999,999') 未收金額,sqldatet(rd05) 預定收款日,AA.st06||AA.a0k22||' '||AA.a0k20||' '||AA.cu04||'1' as osort,a0908 as okey1,a0k20 as okey2,a0901 from (" & strCon & ") AA,acc090,(select * from ReceivablesDay where (rd01,rd02,rd03) in (select rd01,rd02,max(rd03) from ReceivablesDay where (rd01,rd02) in (select rd01,max(rd02) from ReceivablesDay group by rd01) group by rd01,rd02)) BB,caseprogress,trademark where AA.a0k22=a0901(+) and AA.a0k01=cp60(+) and cp09=BB.RD01(+) and cp01=tm01 and cp02=tm02 and cp03=tm03 and cp04=tm04 and tm10<>'000' and AA.st06<>'1' and BB.rd05<=" & (CompWorkDay(6, strSrvDate(1), 1)) & "  "
   'stCon = stCon & " union select decode(AA.st06,'1','北所','2','中所','3','南所','4','高所','其他') as 所別,a0902 as 部門,aa.st02 as 智權人員,aa.cu04 as 申請人,aa.ocp as 本所案號,sqldatet(AA.a0k02) as 收據日期,AA.a0k01 as 收據號碼,TO_CHAR(AA.Acase,'999,999,999') 收據金額,TO_CHAR(AA.diff,'999,999,999') 未收金額,sqldatet(rd05) 預定收款日,AA.st06||AA.a0k22||' '||AA.a0k20||' '||AA.cu04||'1' as osort,a0908 as okey1,a0k20 as okey2,a0901 from (" & strCon & ") AA,acc090,(select * from ReceivablesDay where (rd01,rd02,rd03) in (select rd01,rd02,max(rd03) from ReceivablesDay where (rd01,rd02) in (select rd01,max(rd02) from ReceivablesDay group by rd01) group by rd01,rd02)) BB,caseprogress,servicepractice where AA.a0k22=a0901(+) and AA.a0k01=cp60(+) and cp09=BB.RD01(+) and cp01=sp01 and cp02=sp02 and cp03=sp03 and cp04=sp04 and sp09<>'000' and AA.st06<>'1' and BB.rd05<=" & (CompWorkDay(6, strSrvDate(1), 1)) & "  "
   'stCon = stCon & " union select decode(AA.st06,'1','北所','2','中所','3','南所','4','高所','其他') as 所別,a0902 as 部門,aa.st02 as 智權人員,aa.cu04 as 申請人,aa.ocp as 本所案號,sqldatet(AA.a0k02) as 收據日期,AA.a0k01 as 收據號碼,TO_CHAR(AA.Acase,'999,999,999') 收據金額,TO_CHAR(AA.diff,'999,999,999') 未收金額,sqldatet(rd05) 預定收款日,AA.st06||AA.a0k22||' '||AA.a0k20||' '||AA.cu04||'1' as osort,a0908 as okey1,a0k20 as okey2,a0901 from (" & strCon & ") AA,acc090,(select * from ReceivablesDay where (rd01,rd02,rd03) in (select rd01,rd02,max(rd03) from ReceivablesDay where (rd01,rd02) in (select rd01,max(rd02) from ReceivablesDay group by rd01) group by rd01,rd02)) BB,caseprogress,lawcase where AA.a0k22=a0901(+) and AA.a0k01=cp60(+) and cp09=BB.RD01(+) and cp01=lc01 and cp02=lc02 and cp03=lc03 and cp04=lc04 and lc15<>'000' and AA.st06<>'1' and BB.rd05<=" & (CompWorkDay(6, strSrvDate(1), 1)) & "  "
   'Modified by Lydia 2017/06/21 針對超過預定收款日未收款之控制,取消申請國家<>'000'的限制
   'Modified by Lydia 2017/06/22 還原
   stCon = "select decode(AA.st06,'1','北所','2','中所','3','南所','4','高所','其他') as 所別,a0902 as 部門,aa.st02 as 智權人員,aa.cu04 as 申請人,cp01||'-'||cp02||'-'||cp03||'-'||cp04 as 本所案號,sqldatet(AA.a0k02) as 收據日期,AA.a0k01 as 收據號碼,TO_CHAR(AA.Acase,'999,999,999') 收據金額,TO_CHAR(AA.diff,'999,999,999') 未收金額,sqldatet(rd05) 預定收款日,AA.st06||AA.a0k22||' '||AA.a0k20||' '||AA.cu04||'1' as osort,a0908 as okey1,a0k20 as okey2,a0901 from (" & strCon & ") AA,acc090,(select * from ReceivablesDay where (rd01,rd02,rd03) in (select rd01,rd02,max(rd03) from ReceivablesDay where (rd01,rd02) in (select rd01,max(rd02) from ReceivablesDay where rd06 is null group by rd01) group by rd01,rd02)) BB,caseprogress,patent where AA.a0k22=a0901(+) and AA.a0j01=cp09(+) and cp09=BB.RD01(+) and cp01=pa01 and cp02=pa02 and cp03=pa03 and cp04=pa04 and pa09<>'000' and AA.st06<>'1' and BB.rd05<=" & (CompWorkDay(6, strSrvDate(1), 1)) & "  "
   stCon = stCon & " union select decode(AA.st06,'1','北所','2','中所','3','南所','4','高所','其他') as 所別,a0902 as 部門,aa.st02 as 智權人員,aa.cu04 as 申請人,cp01||'-'||cp02||'-'||cp03||'-'||cp04 as 本所案號,sqldatet(AA.a0k02) as 收據日期,AA.a0k01 as 收據號碼,TO_CHAR(AA.Acase,'999,999,999') 收據金額,TO_CHAR(AA.diff,'999,999,999') 未收金額,sqldatet(rd05) 預定收款日,AA.st06||AA.a0k22||' '||AA.a0k20||' '||AA.cu04||'1' as osort,a0908 as okey1,a0k20 as okey2,a0901 from (" & strCon & ") AA,acc090,(select * from ReceivablesDay where (rd01,rd02,rd03) in (select rd01,rd02,max(rd03) from ReceivablesDay where (rd01,rd02) in (select rd01,max(rd02) from ReceivablesDay where rd06 is null group by rd01) group by rd01,rd02)) BB,caseprogress,trademark where AA.a0k22=a0901(+) and AA.a0j01=cp09(+) and cp09=BB.RD01(+) and cp01=tm01 and cp02=tm02 and cp03=tm03 and cp04=tm04 and tm10<>'000' and AA.st06<>'1' and BB.rd05<=" & (CompWorkDay(6, strSrvDate(1), 1)) & "  "
   stCon = stCon & " union select decode(AA.st06,'1','北所','2','中所','3','南所','4','高所','其他') as 所別,a0902 as 部門,aa.st02 as 智權人員,aa.cu04 as 申請人,cp01||'-'||cp02||'-'||cp03||'-'||cp04 as 本所案號,sqldatet(AA.a0k02) as 收據日期,AA.a0k01 as 收據號碼,TO_CHAR(AA.Acase,'999,999,999') 收據金額,TO_CHAR(AA.diff,'999,999,999') 未收金額,sqldatet(rd05) 預定收款日,AA.st06||AA.a0k22||' '||AA.a0k20||' '||AA.cu04||'1' as osort,a0908 as okey1,a0k20 as okey2,a0901 from (" & strCon & ") AA,acc090,(select * from ReceivablesDay where (rd01,rd02,rd03) in (select rd01,rd02,max(rd03) from ReceivablesDay where (rd01,rd02) in (select rd01,max(rd02) from ReceivablesDay where rd06 is null group by rd01) group by rd01,rd02)) BB,caseprogress,servicepractice where AA.a0k22=a0901(+) and AA.a0j01=cp09(+) and cp09=BB.RD01(+) and cp01=sp01 and cp02=sp02 and cp03=sp03 and cp04=sp04 and sp09<>'000' and AA.st06<>'1' and BB.rd05<=" & (CompWorkDay(6, strSrvDate(1), 1)) & "  "
   stCon = stCon & " union select decode(AA.st06,'1','北所','2','中所','3','南所','4','高所','其他') as 所別,a0902 as 部門,aa.st02 as 智權人員,aa.cu04 as 申請人,cp01||'-'||cp02||'-'||cp03||'-'||cp04 as 本所案號,sqldatet(AA.a0k02) as 收據日期,AA.a0k01 as 收據號碼,TO_CHAR(AA.Acase,'999,999,999') 收據金額,TO_CHAR(AA.diff,'999,999,999') 未收金額,sqldatet(rd05) 預定收款日,AA.st06||AA.a0k22||' '||AA.a0k20||' '||AA.cu04||'1' as osort,a0908 as okey1,a0k20 as okey2,a0901 from (" & strCon & ") AA,acc090,(select * from ReceivablesDay where (rd01,rd02,rd03) in (select rd01,rd02,max(rd03) from ReceivablesDay where (rd01,rd02) in (select rd01,max(rd02) from ReceivablesDay where rd06 is null group by rd01) group by rd01,rd02)) BB,caseprogress,lawcase where AA.a0k22=a0901(+) and AA.a0j01=cp09(+) and cp09=BB.RD01(+) and cp01=lc01 and cp02=lc02 and cp03=lc03 and cp04=lc04 and lc15<>'000' and AA.st06<>'1' and BB.rd05<=" & (CompWorkDay(6, strSrvDate(1), 1)) & "  "
   ''end 2011/11/23
   'Mark by Lydia 2017/06/22 需求者要求還要討論
   'stCon = "select decode(AA.st06,'1','北所','2','中所','3','南所','4','高所','其他') as 所別,a0902 as 部門,aa.st02 as 智權人員,aa.cu04 as 申請人,cp01||'-'||cp02||'-'||cp03||'-'||cp04 as 本所案號,sqldatet(AA.a0k02) as 收據日期,AA.a0k01 as 收據號碼,TO_CHAR(AA.Acase,'999,999,999') 收據金額,TO_CHAR(AA.diff,'999,999,999') 未收金額,sqldatet(rd05) 預定收款日,AA.st06||AA.a0k22||' '||AA.a0k20||' '||AA.cu04||'1' as osort,a0908 as okey1,a0k20 as okey2,a0901 from (" & strCon & ") AA,acc090,(select * from ReceivablesDay where (rd01,rd02,rd03) in (select rd01,rd02,max(rd03) from ReceivablesDay where (rd01,rd02) in (select rd01,max(rd02) from ReceivablesDay where rd06 is null group by rd01) group by rd01,rd02)) BB,caseprogress,patent where AA.a0k22=a0901(+) and AA.a0j01=cp09(+) and cp09=BB.RD01(+) and cp01=pa01 and cp02=pa02 and cp03=pa03 and cp04=pa04 and AA.st06<>'1' and BB.rd05<=" & (CompWorkDay(6, strSrvDate(1), 1)) & "  "
   'stCon = stCon & " union select decode(AA.st06,'1','北所','2','中所','3','南所','4','高所','其他') as 所別,a0902 as 部門,aa.st02 as 智權人員,aa.cu04 as 申請人,cp01||'-'||cp02||'-'||cp03||'-'||cp04 as 本所案號,sqldatet(AA.a0k02) as 收據日期,AA.a0k01 as 收據號碼,TO_CHAR(AA.Acase,'999,999,999') 收據金額,TO_CHAR(AA.diff,'999,999,999') 未收金額,sqldatet(rd05) 預定收款日,AA.st06||AA.a0k22||' '||AA.a0k20||' '||AA.cu04||'1' as osort,a0908 as okey1,a0k20 as okey2,a0901 from (" & strCon & ") AA,acc090,(select * from ReceivablesDay where (rd01,rd02,rd03) in (select rd01,rd02,max(rd03) from ReceivablesDay where (rd01,rd02) in (select rd01,max(rd02) from ReceivablesDay where rd06 is null group by rd01) group by rd01,rd02)) BB,caseprogress,trademark where AA.a0k22=a0901(+) and AA.a0j01=cp09(+) and cp09=BB.RD01(+) and cp01=tm01 and cp02=tm02 and cp03=tm03 and cp04=tm04 and AA.st06<>'1' and BB.rd05<=" & (CompWorkDay(6, strSrvDate(1), 1)) & "  "
   'stCon = stCon & " union select decode(AA.st06,'1','北所','2','中所','3','南所','4','高所','其他') as 所別,a0902 as 部門,aa.st02 as 智權人員,aa.cu04 as 申請人,cp01||'-'||cp02||'-'||cp03||'-'||cp04 as 本所案號,sqldatet(AA.a0k02) as 收據日期,AA.a0k01 as 收據號碼,TO_CHAR(AA.Acase,'999,999,999') 收據金額,TO_CHAR(AA.diff,'999,999,999') 未收金額,sqldatet(rd05) 預定收款日,AA.st06||AA.a0k22||' '||AA.a0k20||' '||AA.cu04||'1' as osort,a0908 as okey1,a0k20 as okey2,a0901 from (" & strCon & ") AA,acc090,(select * from ReceivablesDay where (rd01,rd02,rd03) in (select rd01,rd02,max(rd03) from ReceivablesDay where (rd01,rd02) in (select rd01,max(rd02) from ReceivablesDay where rd06 is null group by rd01) group by rd01,rd02)) BB,caseprogress,servicepractice where AA.a0k22=a0901(+) and AA.a0j01=cp09(+) and cp09=BB.RD01(+) and cp01=sp01 and cp02=sp02 and cp03=sp03 and cp04=sp04 and AA.st06<>'1' and BB.rd05<=" & (CompWorkDay(6, strSrvDate(1), 1)) & "  "
   'stCon = stCon & " union select decode(AA.st06,'1','北所','2','中所','3','南所','4','高所','其他') as 所別,a0902 as 部門,aa.st02 as 智權人員,aa.cu04 as 申請人,cp01||'-'||cp02||'-'||cp03||'-'||cp04 as 本所案號,sqldatet(AA.a0k02) as 收據日期,AA.a0k01 as 收據號碼,TO_CHAR(AA.Acase,'999,999,999') 收據金額,TO_CHAR(AA.diff,'999,999,999') 未收金額,sqldatet(rd05) 預定收款日,AA.st06||AA.a0k22||' '||AA.a0k20||' '||AA.cu04||'1' as osort,a0908 as okey1,a0k20 as okey2,a0901 from (" & strCon & ") AA,acc090,(select * from ReceivablesDay where (rd01,rd02,rd03) in (select rd01,rd02,max(rd03) from ReceivablesDay where (rd01,rd02) in (select rd01,max(rd02) from ReceivablesDay where rd06 is null group by rd01) group by rd01,rd02)) BB,caseprogress,lawcase where AA.a0k22=a0901(+) and AA.a0j01=cp09(+) and cp09=BB.RD01(+) and cp01=lc01 and cp02=lc02 and cp03=lc03 and cp04=lc04 and AA.st06<>'1' and BB.rd05<=" & (CompWorkDay(6, strSrvDate(1), 1)) & "  "
   'end 2017/06/21
   'end 2017/06/22
   
   stCon = stCon & " order by oKey1,oKey2,osort "
   CheckOC
Set Rs = New ADODB.Recordset
Rs.CursorLocation = adUseClient
Rs.Open stCon, cnnConnection, adOpenStatic, adLockReadOnly
tmpnext = "已取得資料...正常"
With Rs
    If .RecordCount > 0 And .RecordCount <> 0 Then
        strTempS(1) = ""
        strTempS(2) = "'"
        strTempS(3) = ""
        tmpnext = "開檔中..."
        ReDim Preserve SeekMail(0) As MailQ
        ReDim Preserve SeekMail(1) As MailQ
        ReDim Preserve SeekMail(2) As MailQ
        '2015/5/26 MODIFY BY SONIA 分所出納人員改抓系統特殊設定
        ''中所江文鸞
        'SeekMail(0).a0k20 = "85003"
        'SeekMail(0).Name = GetPrjSalesNM("85003")
        ''南所唐玥^
        'SeekMail(1).a0k20 = "71002"
        'SeekMail(1).Name = GetPrjSalesNM("71002")
        ''高所余玉瑛
        'SeekMail(2).a0k20 = "68008"
        'SeekMail(2).Name = GetPrjSalesNM("68008")
        '中所
        SeekMail(0).a0k20 = Pub_GetSpecMan("出納人員-中所")
        SeekMail(0).Name = GetPrjSalesNM(SeekMail(0).a0k20)
        '南所
        SeekMail(1).a0k20 = Pub_GetSpecMan("出納人員-南所")
        SeekMail(1).Name = GetPrjSalesNM(SeekMail(1).a0k20)
        '高所
        SeekMail(2).a0k20 = Pub_GetSpecMan("出納人員-高所")
        SeekMail(2).Name = GetPrjSalesNM(SeekMail(2).a0k20)
        '2015/5/26 END
        .MoveFirst
        Do While Not .EOF
            For m_i = 1 To 10
                strTemp(m_i) = CheckStr(.Fields(m_i - 1))
            Next m_i
            strTemp(1) = StrToStr(strTemp(1) & String(6, " "), 3)
            strTemp(2) = StrToStr(StrToStr(strTemp(2), 4) & String(9, " "), 4.5)
            strTemp(3) = StrToStr(StrToStr(strTemp(3), 4) & String(9, " "), 4.5)
            strTemp(4) = StrToStr(StrToStr(strTemp(4), 10) & String(21, " "), 10.5)
            strTemp(5) = StrToStr(strTemp(5) & String(16, " "), 8)
            strTemp(6) = Replace(StrToStr(strTemp(6) & String(10, " "), 4.5), strTemp(6), "") & strTemp(6) & " "
            strTemp(7) = StrToStr(strTemp(7) & String(11, " "), 5.5)
            strTemp(8) = Replace(StrToStr(strTemp(8) & String(10, " "), 4.5), strTemp(8), "") & strTemp(8) & " "
            strTemp(9) = Replace(StrToStr(strTemp(9) & String(10, " "), 4.5), strTemp(9), "") & strTemp(9) & " "
            strTemp(10) = Replace(StrToStr(strTemp(10) & String(10, " "), 4.5), strTemp(10), "") & strTemp(10) & " "
            tmpnext = "寫檔..."
            '分所財務
            IsFind = False
            For m_i = 0 To UBound(SeekMail)
               '2015/5/26 MODIFY BY SONIA
               'If CheckStr(.Fields(0)) = "中所" Then m_receiverno = "85003"
               'If CheckStr(.Fields(0)) = "南所" Then m_receiverno = "71002"
               'If CheckStr(.Fields(0)) = "高所" Then m_receiverno = "68008"
               If CheckStr(.Fields(0)) = "中所" Then m_receiverno = SeekMail(0).a0k20
               If CheckStr(.Fields(0)) = "南所" Then m_receiverno = SeekMail(1).a0k20
               If CheckStr(.Fields(0)) = "高所" Then m_receiverno = SeekMail(2).a0k20
               '2015/5/26 END
               If SeekMail(m_i).a0k20 = m_receiverno Then
                  IsFind = True
                  Exit For
               End If
            Next m_i
            If IsFind = True Then
               SeekMail(m_i).Text = SeekMail(m_i).Text & strTemp(1) & strTemp(2) & strTemp(3) & strTemp(4) & strTemp(5) & strTemp(6) & strTemp(7) & strTemp(8) & strTemp(9) & strTemp(10) & vbCrLf
            Else
               ReDim Preserve SeekMail(UBound(SeekMail) + 1) As MailQ
               SeekMail(UBound(SeekMail)).a0k20 = m_receiverno
               SeekMail(UBound(SeekMail)).Name = GetPrjSalesNM(m_receiverno)
               SeekMail(UBound(SeekMail)).Text = strTemp(1) & strTemp(2) & strTemp(3) & strTemp(4) & strTemp(5) & strTemp(6) & strTemp(7) & strTemp(8) & strTemp(9) & strTemp(10) & vbCrLf
            End If
            .MoveNext
        Loop
    Else
        Exit Sub
    End If
End With
tmpnext = "關檔..."

For m_i = 0 To UBound(SeekMail)
    '沒資料不要寄
    If SeekMail(m_i).a0k20 <> "" And SeekMail(m_i).Text <> "" Then
        If ff > 0 Then Close #ff
         ff = FreeFile
         'Modify By Sindy 2009/06/04
         'If Dir("C:\" & (Trim(strSrvDate(1))) & " " & SeekMail(m_i).a0k20 & TempFileName) <> "" Then Kill "C:\" & (Trim(strSrvDate(1))) & " " & SeekMail(m_i).a0k20 & TempFileName
         'Open "C:\" & (Trim(strSrvDate(1))) & " " & SeekMail(m_i).a0k20 & TempFileName For Output As ff
         If Dir(App.path & TextPath & (Trim(strSrvDate(1))) & " " & SeekMail(m_i).a0k20 & TempFileName) <> "" Then Kill App.path & TextPath & (Trim(strSrvDate(1))) & " " & SeekMail(m_i).a0k20 & TempFileName
         Open App.path & TextPath & (Trim(strSrvDate(1))) & " " & SeekMail(m_i).a0k20 & TempFileName For Output As ff
         '2009/06/04 End
         'Added by Lydia 2016/10/19 加報表抬頭
         Print #ff, Space(35) & (Trim(strSrvDate(1))) & " " & SeekMail(m_i).a0k20 & TempFileName
         Print #ff, ""
         'end 2016/10/19
         
         Print #ff, "所別  部門     智權人員 申請人               本所案號         收據日期 收據號碼   收據金額  未收金額  預定收款日"
         Print #ff, "===== ======== ======== ==================== =============== ========= ========== ========= ========= =========="
         Print #ff, SeekMail(m_i).Text
         Close ff
         
         'Modify By Sindy 2011/10/27
         strSubject = "屆 預定收款日 且未收款或未收齊，已過 分所五個工作天 清單  " & ChangeWStringToWDateString(Trim(strSrvDate(1)))
         strContent = "Dear " & SeekMail(m_i).Name & "：" & vbCrLf & "屆 預定收款日 且未收款或未收齊，已過  分所五個工作天  清單 資料如附件！ 若已收款，請儘速繳回北所財務處" & vbCrLf & vbCrLf & vbCrLf & vbCrLf & "請橫印！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心"
         TempFilePathName = App.path & TextPath & (Trim(strSrvDate(1))) & " " & SeekMail(m_i).a0k20 & TempFileName
         SendMAPIMail SeekMail(m_i).a0k20, strSubject, strContent, TempFilePathName
         
'         '發 mail
'        tmpnext = "準備發 mail..."
'        MAPISession1.LogonUI = False
'        MAPISession1.UserName = "administrator"
'        tmpnext = "準備登入郵件伺服器..."
'        MAPISession1.SignOn
'        tmpnext = "登入郵件伺服器..."
'        MAPIMessages1.SessionID = MAPISession1.SessionID
'        MAPIMessages1.MsgIndex = -1
'        tmpnext = "建立郵件..."
'        MAPIMessages1.Compose
'        MAPIMessages1.MsgSubject = "屆 預定收款日 且未收款或未收齊，已過 分所五個工作天 清單  " & ChangeWStringToWDateString(Trim(strSrvDate(1)))
'        MAPIMessages1.MsgNoteText = "Dear " & SeekMail(m_i).Name & "：" & vbCrLf & "屆 預定收款日 且未收款或未收齊，已過  分所五個工作天  清單 資料如附件！ 若已收款，請儘速繳回北所財務處" & vbCrLf & vbCrLf & vbCrLf & vbCrLf & "請橫印！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心"
'        MAPIMessages1.AttachmentIndex = 0
'        MAPIMessages1.AttachmentPosition = 0
'        'Modify By Sindy 2009/06/04
'        'MAPIMessages1.AttachmentPathName = "C:\" & (Trim(strSrvDate(1))) & " " & SeekMail(m_i).a0k20 & TempFileName
'        MAPIMessages1.AttachmentPathName = App.Path & TextPath & (Trim(strSrvDate(1))) & " " & SeekMail(m_i).a0k20 & TempFileName
'        '2009/06/04 End
'        MAPIMessages1.RecipIndex = 0
'        'Modify by Morgan 2009/4/3
'        'MAPIMessages1.RecipDisplayName = SeekMail(m_i).a0k20
'        MAPIMessages1.RecipDisplayName = ChkMailId(SeekMail(m_i).a0k20)
'        MAPIMessages1.ResolveName
'        tmpnext = "準備存入郵件..."
'        MAPIMessages1.Send
'        MAPISession1.SignOff
        'Modify By Sindy 2009/06/04
        'Kill "C:\" & (Trim(strSrvDate(1))) & " " & SeekMail(m_i).a0k20 & TempFileName
        Kill App.path & TextPath & (Trim(strSrvDate(1))) & " " & SeekMail(m_i).a0k20 & TempFileName
        '2009/06/04 End
    End If
Next m_i
Set Rs = Nothing
'Set cnnConnection = Nothing
Exit Sub
DebugErr:
   WLog tmpnext & " " & Err.Description
   'Add by Morgan 2009/4/3 發信失敗要登出
'   If MAPISession1.SessionID <> 0 Then MAPISession1.SignOff
End Sub



'Add by Morgan 2008/5/14
'台南所待寄客戶信函清單
Private Function CreateFile5(ByVal p_RptDate As String, ByRef p_FileName As String) As Boolean
   
   Dim stSQL As String
   Dim ff As Integer
   Dim strContent As String
   Dim tmpnext As String
   Dim strZip As String, strAddr As String, strContact As String
   
   p_FileName = ""
   
On Error GoTo ErrHandle
   '來函期限通知
   '專利抓非年費
   stSQL = "select st02 智權人員" & _
      ",pa26||' '||NVL(NVL(CU104,CU04),CU05||' '||CU88||' '||CU89||' '||CU90) 客戶" & _
      ",np02||'-'||np03||decode(np04||np05,'000','',np04||np05) 本所案號" & _
      ",na03 申請國,cu30||cu31 聯絡地址,np02,np03,np04,np05" & _
      " from letterduedayinform,nextprogress X,staff,patent,customer,nation" & _
      " where ldi07=to_char(to_date(" & strSrvDate(1) & ",'yyyymmdd')-1,'yyyymmdd') and np01(+)=ldi01 and np22(+)=ldi02" & _
      " and not (instr('P,CFP',np02)>0 and instr('605,606,607',np07)>0)" & _
      " and not (instr('T,CFT',np02)>0 and np07='102')" & _
      " and st01(+)=np10 and st06='3'" & _
      " and pa01(+)=np02 and pa02(+)=np03 and pa03(+)=np04 and pa04(+)=np05 AND PA01 IS NOT NULL" & _
      " and cu01(+)=substr(pa26,1,8) and cu02(+)=substr(pa26,9)" & _
      " and na01(+)=pa09"
   '商標抓非延展
   stSQL = stSQL & _
      " Union select st02 智權人員" & _
      ",TM23||' '||NVL(NVL(CU104,CU04),CU05||' '||CU88||' '||CU89||' '||CU90) 客戶" & _
      ",np02||'-'||np03||decode(np04||np05,'000','',np04||np05) 本所案號" & _
      ",na03 申請國,cu30||cu31 聯絡地址,np02,np03,np04,np05" & _
      " from letterduedayinform,nextprogress X,staff,TRADEMARK,customer,nation" & _
      " where ldi07=to_char(to_date(" & strSrvDate(1) & ",'yyyymmdd')-1,'yyyymmdd') and np01(+)=ldi01 and np22(+)=ldi02" & _
      " and not (instr('P,CFP',np02)>0 and instr('605,606,607',np07)>0)" & _
      " and not (instr('T,CFT',np02)>0 and np07='102')" & _
      " and st01(+)=np10 and st06='3'" & _
      " and tm01(+)=np02 and tm02(+)=np03 and tm03(+)=np04 and tm04(+)=np05 AND TM01 IS NOT NULL" & _
      " and cu01(+)=substr(TM23,1,8) and cu02(+)=substr(TM23,9)" & _
      " and na01(+)=TM10"
      
   '智權人員報價資料
   stSQL = stSQL & _
      " Union select st02 智權人員" & _
      ",pa26||' '||NVL(NVL(CU104,CU04),CU05||' '||CU88||' '||CU89||' '||CU90) 客戶" & _
      ",np02||'-'||np03||decode(np04||np05,'000','',np04||np05) 本所案號" & _
      ",na03 申請國,cu30||cu31 聯絡地址,np02,np03,np04,np05" & _
      " from LETTERCACHE,nextprogress X,staff,patent,customer,nation" & _
      " where LC11=to_char(to_date(" & strSrvDate(1) & ",'yyyymmdd')-1,'yyyymmdd') and np01(+)=LC01 and np22(+)=LC02" & _
      " and st01(+)=np10 and st06='3'" & _
      " and pa01(+)=np02 and pa02(+)=np03 and pa03(+)=np04 and pa04(+)=np05 AND PA01 IS NOT NULL" & _
      " and cu01(+)=substr(pa26,1,8) and cu02(+)=substr(pa26,9)" & _
      " and na01(+)=pa09"
      
   stSQL = stSQL & _
      " Union select st02 智權人員" & _
      ",TM23||' '||NVL(NVL(CU104,CU04),CU05||' '||CU88||' '||CU89||' '||CU90) 客戶" & _
      ",np02||'-'||np03||decode(np04||np05,'000','',np04||np05) 本所案號" & _
      ",na03 申請國,cu30||cu31 聯絡地址,np02,np03,np04,np05" & _
      " from LETTERCACHE,nextprogress X,staff,trademark,customer,nation" & _
      " where LC11=to_char(to_date(" & strSrvDate(1) & ",'yyyymmdd')-1,'yyyymmdd') and np01(+)=LC01 and np22(+)=LC02" & _
      " and st01(+)=np10 and st06='3'" & _
      " and tm01(+)=np02 and tm02(+)=np03 and tm03(+)=np04 and tm04(+)=np05 AND tm01 IS NOT NULL" & _
      " and cu01(+)=substr(tm23,1,8) and cu02(+)=substr(tm23,9)" & _
      " and na01(+)=tm10"
   
   stSQL = stSQL & " order by 1,2,3"
   
   If Rs.State <> adStateClosed Then Rs.Close
   With Rs
      .CursorLocation = adUseClient
      .Open stSQL, cnnConnection, adOpenForwardOnly, adLockReadOnly
      If .RecordCount > 0 Then
         If ff > 0 Then Close #ff
         ff = FreeFile
         'Modify By Sindy 2009/06/04
         'p_FileName = "C:\台南所待寄客戶信函清單.txt"
         p_FileName = App.path & TextPath & "台南所待寄客戶信函清單.txt"
         '2009/06/04 End
         Open p_FileName For Output As ff
         'Added by Lydia 2016/10/19 加報表抬頭
         Print #ff, Space(35) & "台南所待寄客戶信函清單"
         'end 2016/10/19
         Print #ff, ""
         Print #ff, "列印日期：" & p_RptDate
         Print #ff, "資料日期：" & Format(DateAdd("d", -1, Now), "ee/mm/dd")
         Print #ff, ""
         'Modify by Morgan 2008/8/7
         'Print #ff, "智權人員 客戶                   本所案號      申請國 聯絡地址"
         'Print #ff, "-------- ---------------------- ------------- ------ --------------------------------------------------------------------------------"
         Print #ff, "智權人員 客戶                   本所案號      申請國 接洽人     聯絡地址"
         Print #ff, "-------- ---------------------- ------------- ------ ---------- ---------------------------------------------------------------------"
         'end 2008/8/7
         
         tmpnext = "開檔中..."
         
         .MoveFirst
         Do While Not .EOF
            strContent = ""
            strContent = strContent & convForm("" & .Fields(0), 8) & " "
            strContent = strContent & convForm("" & .Fields(1), 22) & " "
            strContent = strContent & convForm("" & .Fields(2), 14)
            strContent = strContent & convForm("" & .Fields(3), 6) & " "
            'Modify by Morgan 2008/8/7 聯絡地址需先抓接洽人資料
            'strContent = strContent & .Fields(4)
            If PUB_GetAddrRef("", .Fields("np02"), .Fields("np03"), .Fields("np04"), .Fields("np05"), , strContact, strZip, strAddr) = True Then
               strContent = strContent & convForm(strContact, 10) & " "
               strContent = strContent & strZip & strAddr
            End If
            tmpnext = "寫檔..."
            Print #ff, strContent
            .MoveNext
         Loop
         Print #ff, "-------- ---------------------- ------------- ------ --------------------------------------------------------------------------------"
         Print #ff, "共" & .RecordCount & "筆"
         
         Close ff
      End If
   End With
   CreateFile5 = True
   Exit Function
   
ErrHandle:
   WLog tmpnext & " " & Err.Description
   
End Function

'Add by Morgan 2008/6/10
'C類來函未發文清單
Private Function CreateFile6(ByVal p_RptDate As String, ByRef p_FileName As String) As Boolean
   
   Dim stSQL As String
   Dim ff As Integer
   Dim strContent As String
   Dim tmpnext As String
   Dim ii As Integer
   Dim stCP06 As String
   
   p_FileName = ""
   
On Error GoTo ErrHandle

   stCP06 = CompWorkDay(10, Format(Now, "YYYYMMDD"))
   
   '1.超過來函輸入日期 + 承辦工作天*2。
   '2.本所期限將於 10個工作天 內到期。
   'Modify by Morgan 2008/8/27 改判斷有期限的不必限制案件性質 --秀玲,郭
   '" and cp10 in ('1002','1201','1203','1205','1206','1401','1307','1801','1802')"
   'Modified by Lydia 2016/09/14 cp27 is null and cp57 is null=>CP158=0 AND CP159=0
   'Modified by Lydia 2016/12/21 排除D類 cp09>'C' => substr(cp09,1,1)='C'
   'Modified by Lydia 2018/06/05 修改顯示案件性質 '020',CPM04,CPM03 => '000',CPM03,CPM04
   'Modified by Lydia 2018/08/16 SUBSTRB=>SUBSTR
   stSQL = "select SUBSTR(LPAD(SQLDATET(cp06),10,' '),1,10) 本所期限" & _
      ",decode(sign(cp06-" & stCP06 & "),1,' ','*')||cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) 本所案號" & _
      ",SUBSTR(sqldatet(cp66),1,10) 來函輸入日" & _
      ",SUBSTR(Decode(PA09,'000',CPM03,CPM04),1,12) 案件性質" & _
      ",SUBSTR(s1.st02,1,6) 承辦人,SUBSTR(sqldatet(ep09),1,10) 完稿日" & _
      ",SUBSTR(s2.st02,1,8) 智權人員,SUBSTR(na03,1,10) 申請國家" & _
      ",SUBSTR(cu04,1,30) 申請人" & _
      " from ( select cp01,cp02,cp03,cp04,cp66,cp06,cp09,cp10,cp13,cp14,pa09,pa26" & _
      " From caseprogress, patent" & _
      " where cp01 in ('P','CFP') and cp05>20080000 and substr(cp09,1,1)='C' and CP158=0 AND CP159=0" & _
      " and cp06>0 and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04" & _
      " ) X,casefee,casepropertymap,staff s1,engineerprogress,staff s2,nation,customer" & _
      " where cf01(+)=cp01 and cf02(+)=pa09 and cf03(+)=cp10 and cf04>0" & _
      " and (cp06<=" & stCP06 & " or sysdate>to_date(WORKDAYADD(nvl(cf04,0)*2,cp66),'yyyymmdd'))" & _
      " and cpm01(+)=cp01 and cpm02(+)=cp10" & _
      " and s1.st01(+)=cp14 and ep02(+)=cp09" & _
      " and s2.st01(+)=cp13 and na01(+)=pa09" & _
      " and cu01(+)=substr(pa26,1,8) and cu02(+)=substr(pa26,9)" & _
      " order by 1,2"
      
   If Rs.State <> adStateClosed Then Rs.Close
   With Rs
      .CursorLocation = adUseClient
      .Open stSQL, cnnConnection, adOpenForwardOnly, adLockReadOnly
      If .RecordCount > 0 Then
         If ff > 0 Then Close #ff
         ff = FreeFile
         'Modify By Sindy 2009/06/04
         'p_FileName = "C:\C類來函未發文清單.txt"
         p_FileName = App.path & TextPath & "C類來函未發文清單.txt"
         '2009/06/04 End
         Open p_FileName For Output As ff
         'Added by Lydia 2016/10/19 加報表抬頭
         Print #ff, Space(40) & "C類來函未發文清單"
         'end 2016/10/19
         Print #ff, ""
         Print #ff, "列印日期：" & p_RptDate & String(4, "　") & " 本所案號前有*號者表示將於10個工作天內到期"
         Print #ff, ""
         Print #ff, "本所期限   本所案號        來函輸入日 案件性質     承辦人   完稿日     智權人員 申請國家   申請人"
         Print #ff, "---------- --------------- ---------- ------------ ------ ---------- ---------- ---------- ------------------------------"
         
         tmpnext = "開檔中..."
         
         .MoveFirst
         Do While Not .EOF
            strContent = ""
            For ii = 0 To 8
                 'Modified by Lydia 2018/08/16 改成指定字串長度
                 'strContent = strContent & convForm("" & .Fields(ii), .Fields(ii).DefinedSize + 1)
                 Select Case ii
                      Case 0: '本所期限
                           strContent = strContent & convForm("" & .Fields(ii), 10) & " "
                      Case 1: '本所案號
                           strContent = strContent & convForm("" & .Fields(ii), 15) & " "
                      Case 2: '來函輸入日
                           strContent = strContent & convForm("" & .Fields(ii), 10) & " "
                      Case 3: '案件性質
                           strContent = strContent & convForm("" & .Fields(ii), 12) & " "
                      Case 4: '承辦人
                           strContent = strContent & convForm("" & .Fields(ii), 8) & " "
                      Case 5: '完稿日
                           strContent = strContent & convForm("" & .Fields(ii), 10) & " "
                      Case 6: '智權人員
                           strContent = strContent & convForm("" & .Fields(ii), 8) & " "
                      Case 7: '申請國家
                           strContent = strContent & convForm("" & .Fields(ii), 10) & " "
                      Case 8: '申請人
                           strContent = strContent & convForm("" & .Fields(ii), 30) & " "
                 End Select
                 'end 2018/08/16
            Next
            tmpnext = "寫檔..."
            Print #ff, strContent
            .MoveNext
         Loop
         Print #ff, "---------- --------------- ---------- ------------ -------- ---------- -------- ---------- ------------------------------"
         Print #ff, "共" & .RecordCount & "筆"
         
         Close ff
      End If
   End With
   CreateFile6 = True
   Exit Function
   
ErrHandle:
   WLog tmpnext & " " & Err.Description

End Function

'Add by Morgan 2008/8/6
'C類來函已會稿未發文清單
Private Function CreateFile7(ByVal p_RptDate As String, ByRef p_MailContent As String) As Boolean
   
   Dim stSQL As String
   Dim ff As Integer
   Dim strContent As String
   Dim tmpnext As String
   Dim ii As Integer
   Dim stEP07 As String, stEP07T As String
   Dim stCP14 As String
   Dim iRecs As Integer
   Dim strFileName As String
   Dim stVTB As String
   
   'Modify By Sindy 2009/06/04
   'strFileName = "C:\C類來函已會稿未發文清單.txt"
   strFileName = App.path & TextPath & "C類來函已會稿未發文清單.txt"
   '2009/06/04 End

On Error GoTo ErrHandle

   stEP07 = CompWorkDay(2, Format(Now, "YYYYMMDD"), 1)
   stEP07T = CompWorkDay(1, Format(Now, "YYYYMMDD"), 1)
   '已會稿有期限且超過二個工作天
   '先做專利
   'stSQL = "select substrb(sqldatet(cp06),1,10) 本所期限" & _
      ",cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) 本所案號" & _
      ",substrb(sqldatet(cp66),1,10) 來函輸入日" & _
      ",substrb(Decode(Cty,'020',CPM04,CPM03),1,12) 案件性質" & _
      ",substrb(s1.st02,1,6) 承辦人,substrb(sqldatet(ep07),1,10) 會稿日" & _
      ",substrb(s2.st02,1,6) 智權人員,substrb(na03,1,10) 申請國家" & _
      ",substrb(cu04,1,30) 申請人" & _
      " from (select cp01,cp02,cp03,cp04,cp06,cp10,cp13,cp14,cp66,ep07,nvl(pa09,tm10) Cty,nvl(pa26,tm23) App" & _
      " from caseprogress,engineerprogress,patent,trademark" & _
      " where cp05>20080811 and cp06>0 and cp14 is not null and cp09>'C' and  cp27 is null" & _
      " and ep02(+)=cp09 and ep07<" & stEP07 & _
      " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04" & _
      " and tm01(+)=cp01 and tm02(+)=cp02 and tm03(+)=cp03 and tm04(+)=cp04" & _
      ") x,casepropertymap,staff s1,staff s2,nation,customer" & _
      " where cpm01(+)=cp01 and cpm02(+)=cp10" & _
      " and s1.st01(+)=cp14 and s2.st01(+)=cp13 and na01(+)=Cty" & _
      " and cu01(+)=substr(App,1,8) and cu02(+)=substr(App,9)" & _
      " order by 1,2"
   '2008/8/11 modify by sonia cp05>20080811 改為 ep07>=20080811
   'stSQL = "select substrb(sqldatet(cp06),1,10) 本所期限" & _
      ",cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) 本所案號" & _
      ",substrb(sqldatet(cp66),1,10) 來函輸入日" & _
      ",substrb(Decode(na01,'020',CPM04,CPM03),1,12) 案件性質" & _
      ",substrb(s1.st02,1,6) 承辦人,substrb(sqldatet(ep07),1,10) 會稿日" & _
      ",substrb(s2.st02,1,6) 智權人員,substrb(na03,1,10) 申請國家" & _
      ",substrb(cu04,1,30) 申請人,cp14" & _
      " from caseprogress,engineerprogress,patent,casepropertymap,staff s1,staff s2,nation,customer" & _
      " where cp05>20080811 and cp06>0 and cp14 is not null and cp09>'C' and cp27 is null" & _
      " and ep02(+)=cp09 and ep07<" & stEP07 & _
      " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04 and pa01 is not null" & _
      " and cpm01(+)=cp01 and cpm02(+)=cp10" & _
      " and s1.st01(+)=cp14 and s2.st01(+)=cp13 and na01(+)=pa09" & _
      " and cu01(+)=substr(pa26,1,8) and cu02(+)=substr(pa26,9)" & _
      " order by 10,1,2"
      
   'Modify by Morgan 2008/10/22 +內外商,服務業務(先不上)
   If Val(strSrvDate(1)) < 20081118 Then
      'Modified by Lydia 2018/06/05 修改顯示案件性質 '020',CPM04,CPM03 => '000',CPM03,CPM04
      'Modified by Lydia 2018/08/16 SUBSTRB=>SUBSTR
      stSQL = "select SUBSTR(sqldatet(cp06),1,10) 本所期限" & _
         ",cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) 本所案號" & _
         ",SUBSTR(sqldatet(cp66),1,10) 來函輸入日" & _
         ",SUBSTR(Decode(na01,'000',CPM03,CPM04),1,12) 案件性質" & _
         ",SUBSTR(s1.st02,1,6) 承辦人,SUBSTR(sqldatet(ep07),1,10) 會稿日" & _
         ",SUBSTR(s2.st02,1,6) 智權人員,SUBSTR(na03,1,10) 申請國家" & _
         ",SUBSTR(cu04,1,30) 申請人,cp14" & _
         " from caseprogress,engineerprogress,patent,casepropertymap,staff s1,staff s2,nation,customer" & _
         " where ep07>=20080811 and ep07<" & stEP07 & " and ep05 is not null and ep02>'C' and ep10 is null" & _
         " and ep02=cp09(+) and cp06>0 " & _
         " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04 and pa01 is not null" & _
         " and cpm01(+)=cp01 and cpm02(+)=cp10" & _
         " and s1.st01(+)=cp14 and s2.st01(+)=cp13 and na01(+)=pa09" & _
         " and cu01(+)=substr(pa26,1,8) and cu02(+)=substr(pa26,9)"
   Else
      stVTB = "select ep07,cp01,cp02,cp03,cp04,cp06,cp10,cp13,cp14,cp66,pa09 cty,pa26 app from engineerprogress,caseprogress,patent" & _
         " where ep07>=20080811 and ep07<" & stEP07 & " and ep05 is not null and ep02>'C'" & _
         " and ep10 is null and ep02=cp09(+) and cp06>0 and cp01='CFP'" & _
         " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04" & _
         " union select ep07,cp01,cp02,cp03,cp04,cp06,cp10,cp13,cp14,cp66,tm10 cty,tm23 app from engineerprogress,caseprogress,trademark" & _
         " where ep07>=20080811 and ep07<" & stEP07 & " and ep05 is not null and ep02>'C'" & _
         " and ep10 is null and ep02=cp09(+) and cp06>0 and cp01='CFT'" & _
         " and tm01(+)=cp01 and tm02(+)=cp02 and tm03(+)=cp03 and tm04(+)=cp04" & _
         " union select ep07,cp01,cp02,cp03,cp04,cp06,cp10,cp13,cp14,cp66,tm10 cty,tm23 app from engineerprogress,caseprogress,trademark" & _
         " where ep07>=20080811 and ep07<" & stEP07T & " and ep05 is not null and ep02>'C'" & _
         " and ep10 is null and ep02=cp09(+) and cp06>0 and cp01 in ('T','TF')" & _
         " and tm01(+)=cp01 and tm02(+)=cp02 and tm03(+)=cp03 and tm04(+)=cp04" & _
         " union select ep07,cp01,cp02,cp03,cp04,cp06,cp10,cp13,cp14,cp66,sp09 cty,sp08 app from engineerprogress,caseprogress,servicepractice" & _
         " where ep07>=20080811 and ep07<" & stEP07T & " and ep05 is not null and ep02>'C'" & _
         " and ep10 is null and ep02=cp09(+) and cp06>0 and substr(cp01,1,1)='T'" & _
         " and sp01(+)=cp01 and sp02(+)=cp02 and sp03(+)=cp03 and sp04(+)=cp04 and sp01 is not null" & _
         " union select ep07,cp01,cp02,cp03,cp04,cp06,cp10,cp13,cp14,cp66,sp09 cty,sp08 app from engineerprogress,caseprogress,servicepractice" & _
         " where ep07>=20080811 and ep07<" & stEP07 & " and ep05 is not null and ep02>'C'" & _
         " and ep10 is null and ep02=cp09(+) and cp06>0 and substr(cp01,1,1)<>'T'" & _
         " and sp01(+)=cp01 and sp02(+)=cp02 and sp03(+)=cp03 and sp04(+)=cp04 and sp01 is not null"
      'Modified by Lydia 2018/06/05 修改顯示案件性質 '020',CPM04,CPM03 => '000',CPM03,CPM04
      'Modified by Lydia 2018/08/16 SUBSTRB=>SUBSTR
      stSQL = "select SUBSTR(LPAD(SQLDATET(cp06),10,' '),1,10) 本所期限" & _
         ",cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) 本所案號" & _
         ",SUBSTR(sqldatet(cp66),1,10) 來函輸入日" & _
         ",SUBSTR(Decode(na01,'000',CPM03,CPM04),1,12) 案件性質" & _
         ",SUBSTR(s1.st02,1,6) 承辦人,SUBSTR(sqldatet(ep07),1,10) 會稿日" & _
         ",SUBSTR(s2.st02,1,8) 智權人員,SUBSTR(na03,1,10) 申請國家" & _
         ",SUBSTR(cu04,1,30) 申請人,cp14" & _
         " from (" & stVTB & "),casepropertymap,staff s1,staff s2,nation,customer" & _
         " where cpm01(+)=cp01 and cpm02(+)=cp10" & _
         " and s1.st01(+)=cp14 and s2.st01(+)=cp13 and na01(+)=cty" & _
         " and cu01(+)=substr(app,1,8) and cu02(+)=substr(app,9)"
   End If
   
   stSQL = stSQL & " order by 10,1,2"
      
   If Rs.State <> adStateClosed Then Rs.Close
   With Rs
      .CursorLocation = adUseClient
      .Open stSQL, cnnConnection, adOpenForwardOnly, adLockReadOnly
      If .RecordCount > 0 Then
         .MoveFirst
         Do While Not .EOF
            If .Fields("cp14") <> stCP14 Then
               If stCP14 <> "" Then
                  Print #ff, "---------- --------------- ---------- ------------ -------- ---------- -------- ---------- ------------------------------"
                  Print #ff, "共" & iRecs & "筆"
                  Close ff
                  SendMAPIMail stCP14, "C類來函已會稿未發文控管清單(" & p_RptDate & ")", p_MailContent, strFileName
               End If
               
               stCP14 = .Fields("cp14")
               iRecs = 0
               If ff > 0 Then Close #ff
               ff = FreeFile
               Open strFileName For Output As ff
               'Added by Lydia 2016/10/19 加報表抬頭
               Print #ff, Space(40) & "C類來函已會稿未發文控管清單"
               'end 2016/10/19
               Print #ff, ""
               Print #ff, "列印日期：" & p_RptDate & String(2, "　") & "有期限且已逾會稿日(含) 2 個工作天(T,TF案為 1 個工作天)"
               Print #ff, ""
               Print #ff, "本所期限   本所案號        來函輸入日 案件性質     承辦人   會稿日     智權人員 申請國家   申請人"
               Print #ff, "---------- --------------- ---------- ------------ -------- ---------- -------- ---------- ------------------------------"
               tmpnext = "開檔中..."
            End If
            iRecs = iRecs + 1
            strContent = ""
            For ii = 0 To 8
                 'Modified by Lydia 2018/08/16 改成指定字串長度
                 'strContent = strContent & convForm("" & .Fields(ii), .Fields(ii).DefinedSize + 1)
                 Select Case ii
                      Case 0: '本所期限
                           strContent = strContent & convForm("" & .Fields(ii), 10) & " "
                      Case 1: '本所案號
                           strContent = strContent & convForm("" & .Fields(ii), 15) & " "
                      Case 2: '來函輸入日
                           strContent = strContent & convForm("" & .Fields(ii), 10) & " "
                      Case 3: '案件性質
                           strContent = strContent & convForm("" & .Fields(ii), 12) & " "
                      Case 4: '承辦人
                           strContent = strContent & convForm("" & .Fields(ii), 8) & " "
                      Case 5: '完稿日
                           strContent = strContent & convForm("" & .Fields(ii), 10) & " "
                      Case 6: '智權人員
                           strContent = strContent & convForm("" & .Fields(ii), 8) & " "
                      Case 7: '申請國家
                           strContent = strContent & convForm("" & .Fields(ii), 10) & " "
                      Case 8: '申請人
                           strContent = strContent & convForm("" & .Fields(ii), 30) & " "
                 End Select
                 'end 2018/08/16
            Next
            tmpnext = "寫檔..."
            Print #ff, strContent
            .MoveNext
         Loop
         Print #ff, "---------- --------------- ---------- ------------ -------- ---------- -------- ---------- ------------------------------"
         Print #ff, "共" & iRecs & "筆"
         Close ff
         SendMAPIMail stCP14, "C類來函已會稿未發文控管清單(" & p_RptDate & ")", p_MailContent, strFileName
      End If
   End With
   CreateFile7 = True
   Exit Function
   
ErrHandle:
   WLog tmpnext & " " & Err.Description

End Function

'Add by Morgan 2008/6/28
'Modified by Morgan 2021/11/11 +p_MCTFlag:Y=MCT案,N=非MCT案,空=不限
'C類來函未發文清單(內商T*)
Private Function CreateFile8(ByVal p_RptDate As String, ByRef p_FileName As String, Optional p_MCTFlag As String) As Boolean
   
   Dim stSQL As String
   Dim ff As Integer
   Dim strContent As String
   Dim tmpnext As String
   Dim ii As Integer
   Dim stCP06 As String, stCP05 As String, stCP06CN1002 As String
   Dim strConMCT As String 'Added by Morgan 2021/11/11
   
   p_FileName = ""
   
On Error GoTo ErrHandle
   
   'Added by Morgan 2021/11/11
   'MCT案
   If p_MCTFlag = "Y" Then
      strConMCT = " and tm44 is not null and exists(select * from fagent where fa01=substr(tm44,1,8) and fa02(+)=substr(tm44,9) and fa120 like 'MCTF%')"
   '非MCT案
   ElseIf p_MCTFlag = "N" Then
      strConMCT = " and (tm44 is null or not exists(select * from fagent where fa01=substr(tm44,1,8) and fa02(+)=substr(tm44,9) and fa120 like 'MCTF%'))"
   End If
   
   stCP06 = CompWorkDay(10, Format(Now, "YYYYMMDD"))
   stCP06CN1002 = CompWorkDay(5, Format(Now, "YYYYMMDD"))
   stCP05 = CompWorkDay(6, Format(Now, "YYYYMMDD"), 1)
   
   '1.超過來函輸入日期 + 6 個工作天。
   '2.本所期限將於 10個工作天 內到期。
   'Modify by Morgan 2008/11/20 大陸核駁改5個工作天內到期
   'Modified by Lydia 2016/09/14  cp27 is null and cp57 is null=> CP158=0 AND CP159=0
   'Modified by Lydia 2016/12/21 排除D類 cp09>'C' => substr(cp09,1,1)='C'
   'Modified by Lydia 2018/06/05 修改顯示案件性質 '020',CPM04,CPM03 => '000',CPM03,CPM04
   'Modified by Lydia 2018/08/16 SUBSTRB=>SUBSTR
   stSQL = "select SUBSTR(LPAD(SQLDATET(cp06),10,' '),1,10) 本所期限" & _
      ",decode(sign(cp06-" & stCP06 & "),1,' ','*')||cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) 本所案號" & _
      ",SUBSTR(sqldatet(cp05),1,10) 收文日" & _
      ",SUBSTR(Decode(TM10,'000',CPM03,CPM04),1,12) 案件性質" & _
      ",SUBSTR(s1.st02,1,6) 承辦人,SUBSTR(sqldatet(ep09),1,10) 完稿日" & _
      ",SUBSTR(s2.st02,1,6) 智權人員,SUBSTR(na03,1,10) 申請國家" & _
      ",SUBSTR(cu04,1,30) 申請人" & _
      " from caseprogress,trademark,casepropertymap,staff s1,engineerprogress,staff s2,nation,customer" & _
      " where substr(cp01,1,1)='T' AND CP05>20080000 and (cp05<" & stCP05 & " or cp06<=" & stCP06 & ")" & _
      " and substr(cp09,1,1)='C' and CP158=0 AND CP159=0 and cp06>0" & _
      " and tm01(+)=cp01 and tm02(+)=cp02 and tm03(+)=cp03 and tm04(+)=cp04 AND TM01 IS NOT NULL and TM29 IS NULL" & _
      " and cpm01(+)=cp01 and cpm02(+)=cp10" & _
      " and s1.st01(+)=cp14 and ep02(+)=cp09" & _
      " and s2.st01(+)=cp13 and na01(+)=TM10" & _
      " and cu01(+)=substr(TM23,1,8) and cu02(+)=substr(TM23,9)" & _
      " and cp10||tm10<>'1002020'" & strConMCT
   'Add by Morgan 2008/11/20 大陸核駁案
   'Modified by Lydia 2018/06/05 修改顯示案件性質 '020',CPM04,CPM03 => '000',CPM03,CPM04
   'Modified by Lydia 2018/08/16 SUBSTRB=>SUBSTR
   stSQL = stSQL & " union select SUBSTR(LPAD(SQLDATET(cp06),10,' '),1,10) 本所期限" & _
      ",decode(sign(cp06-" & stCP06 & "),1,' ','*')||cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) 本所案號" & _
      ",SUBSTR(sqldatet(cp05),1,10) 收文日" & _
      ",SUBSTR(Decode(TM10,'000',CPM03,CPM04),1,12) 案件性質" & _
      ",SUBSTR(s1.st02,1,6) 承辦人,SUBSTR(sqldatet(ep09),1,10) 完稿日" & _
      ",SUBSTR(s2.st02,1,6) 智權人員,SUBSTR(na03,1,10) 申請國家" & _
      ",SUBSTR(cu04,1,30) 申請人" & _
      " from caseprogress,trademark,casepropertymap,staff s1,engineerprogress,staff s2,nation,customer" & _
      " where substr(cp01,1,1)='T' AND CP05>20080000 and (cp05<" & stCP05 & " or cp06<=" & stCP06CN1002 & ")" & _
      " and substr(cp09,1,1)='C' and CP158=0 AND CP159=0 and cp06>0" & _
      " and tm01(+)=cp01 and tm02(+)=cp02 and tm03(+)=cp03 and tm04(+)=cp04 AND TM01 IS NOT NULL and TM29 IS NULL" & _
      " and cpm01(+)=cp01 and cpm02(+)=cp10" & _
      " and s1.st01(+)=cp14 and ep02(+)=cp09" & _
      " and s2.st01(+)=cp13 and na01(+)=TM10" & _
      " and cu01(+)=substr(TM23,1,8) and cu02(+)=substr(TM23,9)" & _
      " and cp10||tm10='1002020'" & strConMCT
   'end 2008/11/20
   stSQL = stSQL & " order by 1,2"
      
   If Rs.State <> adStateClosed Then Rs.Close
   With Rs
      .CursorLocation = adUseClient
      .Open stSQL, cnnConnection, adOpenForwardOnly, adLockReadOnly
      If .RecordCount > 0 Then
         If ff > 0 Then Close #ff
         ff = FreeFile
         
         'Added by Morgan 2021/11/11
         If p_MCTFlag = "Y" Then
            p_FileName = App.path & TextPath & "C類來函未發文清單(內商)-MCT案.txt"
         ElseIf p_MCTFlag = "N" Then
            p_FileName = App.path & TextPath & "C類來函未發文清單(內商)-非MCT案.txt"
         Else
         'end 2021/11/11
            'Modify By Sindy 2009/06/04
            'p_FileName = "C:\C類來函未發文清單(內商).txt"
            p_FileName = App.path & TextPath & "C類來函未發文清單(內商).txt"
            '2009/06/04 End
         End If
         
         Open p_FileName For Output As ff
         'Added by Morgan 2021/11/11
         If p_MCTFlag = "Y" Then
            Print #ff, Space(40) & "C類來函未發文清單(內商)-MCT案"
         ElseIf p_MCTFlag = "N" Then
            Print #ff, Space(40) & "C類來函未發文清單(內商)-非MCT案"
         Else
         'end 2021/11/11
            'Added by Lydia 2016/10/19 加報表抬頭
            Print #ff, Space(40) & "C類來函未發文清單(內商)"
            'end 2016/10/19
         End If
         Print #ff, ""
         Print #ff, "列印日期：" & p_RptDate & String(2, "　") & "本所案號前有*號者表示將於10個工作天內到期(大陸核駁5個工作天)"
         Print #ff, "　　　　　　　　　　　，其餘為超過來函日後6個工作天。"
         Print #ff, ""
         Print #ff, "本所期限   本所案號        收文日     案件性質     承辦人   完稿日     智權人員 申請國家   申請人"
         Print #ff, "---------- --------------- ---------- ------------ -------- ---------- -------- ---------- ------------------------------"
         
         tmpnext = "開檔中..."
         
         .MoveFirst
         Do While Not .EOF
            strContent = ""
            For ii = 0 To 8
               'Modified by Lydia 2018/08/16 改成指定字串長度
               'strContent = strContent & convForm("" & .Fields(ii), .Fields(ii).DefinedSize + 1)
                 Select Case ii
                      Case 0: '本所期限
                           strContent = strContent & convForm("" & .Fields(ii), 10) & " "
                      Case 1: '本所案號
                           strContent = strContent & convForm("" & .Fields(ii), 15) & " "
                      Case 2: '收文日
                           strContent = strContent & convForm("" & .Fields(ii), 10) & " "
                      Case 3: '案件性質
                           strContent = strContent & convForm("" & .Fields(ii), 12) & " "
                      Case 4: '承辦人
                           strContent = strContent & convForm("" & .Fields(ii), 8) & " "
                      Case 5: '完稿日
                           strContent = strContent & convForm("" & .Fields(ii), 10) & " "
                      Case 6: '智權人員
                           strContent = strContent & convForm("" & .Fields(ii), 8) & " "
                      Case 7: '申請國家
                           strContent = strContent & convForm("" & .Fields(ii), 10) & " "
                      Case 8: '申請人
                           strContent = strContent & convForm("" & .Fields(ii), 30) & " "
                 End Select
                 'end 2018/08/16
            Next
            tmpnext = "寫檔..."
            Print #ff, strContent
            .MoveNext
         Loop
         Print #ff, "---------- --------------- ---------- ------------ -------- ---------- -------- ---------- ------------------------------"
         Print #ff, "共" & .RecordCount & "筆"
         
         Close ff
      End If
   End With
   CreateFile8 = True
   Exit Function
   
ErrHandle:
   WLog tmpnext & " " & Err.Description

End Function
'Modify by Morgan 2009/8/24
'Add by Morgan 2008/8/27
'專利催審管制表
'Modified by Morgan 2019/11/28 程序承辦的程序改30天(申請案除外)，其他仍維持180天--陳玲玲
''第一次管制後領證每3個月(90)天，其他每6個月(180)跑一次
'Modified by Morgan 2014/11/10 +bolIsOurFMP:是否FMP寰華案件
Private Function CreateFile9(ByVal p_Sys As String, ByVal p_RptDate As String, ByRef p_FileName As String, Optional bolIsOurFMP As Boolean, Optional p_PS As String) As Boolean
   
   Dim stSQL As String
   Dim ff As Integer
   Dim strContent As String
   Dim tmpnext As String
   Dim stPID As String
   Dim lngRecs As Long
   Dim stFileName As String
   Dim stVTB As String
   Dim stCon As String
   'Added by Lydia 2017/02/16 設定欄位
   Dim strTitle As String    '欄位抬頭名稱
   Dim strTitleLine As String '欄位抬頭底線
   Dim stCFPMailList As String, strText As String, strPIDName As String, strCP06 As String, strCP09 As String, strCP12 As String, strCP13 As String 'Added by Morgan 2017/10/31
   'Added by Lydia 2019/02/11 CF案最新代理人
   Dim strCP44 As String, strCP45 As String
   Dim rsQuery As ADODB.Recordset 'Added by Morgan 2020/2/21
   Dim mSeqNo As String 'Added by Lydia 2021/07/09
   Dim strFMPPID As String, strFMPPSup As String 'Added by Morgan 2023/6/20
   Dim bolPNewRule As Boolean 'Added by Morgan 2025/1/8 P案(非FMP)是否用新管制人規則
   
   p_FileName = ""
   lngRecs = 0
   stCon = ""
   
   'Added by Morgan 2025/1/8
   If p_Sys = "P" And bolIsOurFMP = False And strSrvDate(1) >= P業務區劃分啟用日 Then
      bolPNewRule = True
   Else
      bolPNewRule = False
   End If
   'end 2025/1/8
   
   'Added by Morgan 2014/11/10
   If p_Sys = "P" Then
      If bolIsOurFMP Then
         stCon = stCon & " and exists"
      Else
         stCon = stCon & " and not exists"
      End If
      'Modified by Morgan 2015/10/26 +判斷發文人員部門為F22外專程序
      'Modified by Morgan 2018/8/28 修正發文人原部門判斷(原程式抓到承辦人)
      stCon = stCon & "(select * from caseprogress b,staff c where b.cp01=np02 and b.cp02=np03 and b.cp03=np04 and b.cp04=np05 and b.cp31='Y' and b.cp44='Y53374000' and b.cp12 like 'F%' and c.st01(+)=b.cp83 and (b.cp83 is null or c.st03='F22'))"
      'end 2015/10/26
   End If
   'end 2014/11/10
   
On Error GoTo ErrHandle
   
   'Modified by Morgan 2012/5/25 +1603
   'Modified by Lydia 2016/09/14 CP57 IS NULL=>CP159=0
   'Modified by Morgan 2019/11/28 程序承辦的程序改30天(申請案除外)，其他仍維持180天--陳玲玲
   'stVTB = "SELECT NP08,CP01,CP02,CP03,CP04,CP10,CP14,CP27,CP09,CP44,CP45 FROM NEXTPROGRESS,CASEPROGRESS" & _
      " WHERE NP02='" & p_Sys & "' AND NP07='411' AND NP06 IS NULL AND CP09(+)=NP01 AND CP10='601' AND CP159=0 AND CP24 IS NULL" & stCon & _
      " AND NP08<=" & strSrvDate(1) & " AND MOD(TO_DATE(" & strSrvDate(1) & ",'YYYYMMDD')-TO_DATE(NP08,'YYYYMMDD'),30)=0" & _
      " UNION ALL SELECT NP08,CP01,CP02,CP03,CP04,NP07,CP14,CP27,CP09,CP44,CP45 FROM NEXTPROGRESS,CASEPROGRESS" & _
      " WHERE NP02='" & p_Sys & "' AND NP07='1603' AND NP06 IS NULL AND CP09(+)=NP01" & stCon & _
      " AND NP08<=" & strSrvDate(1) & " AND MOD(TO_DATE(" & strSrvDate(1) & ",'YYYYMMDD')-TO_DATE(NP08,'YYYYMMDD'),30)=0" & _
      " UNION ALL SELECT NP08,CP01,CP02,CP03,CP04,CP10,CP14,CP27,CP09,CP44,CP45 FROM NEXTPROGRESS,CASEPROGRESS" & _
      " WHERE NP02='" & p_Sys & "' AND NP07='411' AND NP06 IS NULL AND CP09(+)=NP01 AND CP10<>'601' AND CP159=0 AND CP24 IS NULL" & stCon & _
      " AND NP08<=" & strSrvDate(1) & " AND MOD(TO_DATE(" & strSrvDate(1) & ",'YYYYMMDD')-TO_DATE(NP08,'YYYYMMDD'),30)=0"
   'Modified by Morgan 2024/1/9 +1503重為處分--秀玲, 1204通知實審--陳玲玲
   stVTB = "SELECT NP08,CP01,CP02,CP03,CP04,CP10,CP14,CP27,CP09,CP44,CP45 FROM NEXTPROGRESS,CASEPROGRESS,STAFF" & _
      " WHERE NP02='" & p_Sys & "' AND NP07='411' AND NP06 IS NULL AND CP09(+)=NP01 AND CP159=0 AND CP24 IS NULL" & stCon & _
      " AND NP08<=" & strSrvDate(1) & " AND MOD(TO_DATE(" & strSrvDate(1) & ",'YYYYMMDD')-TO_DATE(NP08,'YYYYMMDD'),30)=0" & _
      " AND ST01(+)=CP14 AND CP10 NOT IN (" & NewCasePtyList & ") AND ST03 IN ('P12','F22')" & _
      " UNION ALL SELECT NP08,CP01,CP02,CP03,CP04,NP07,CP14,CP27,CP09,CP44,CP45 FROM NEXTPROGRESS,CASEPROGRESS" & _
      " WHERE NP02='" & p_Sys & "' AND NP07='1503' AND NP06 IS NULL AND CP09(+)=NP01" & stCon & _
      " AND NP08<=" & strSrvDate(1) & " AND MOD(TO_DATE(" & strSrvDate(1) & ",'YYYYMMDD')-TO_DATE(NP08,'YYYYMMDD'),30)=0" & _
      " UNION ALL SELECT NP08,CP01,CP02,CP03,CP04,NP07,CP14,CP27,CP09,CP44,CP45 FROM NEXTPROGRESS,CASEPROGRESS" & _
      " WHERE NP02='" & p_Sys & "' AND NP07='1204' AND NP06 IS NULL AND CP09(+)=NP01" & stCon & _
      " AND NP08<=" & strSrvDate(1) & " AND MOD(TO_DATE(" & strSrvDate(1) & ",'YYYYMMDD')-TO_DATE(NP08,'YYYYMMDD'),30)=0" & _
      " UNION ALL SELECT NP08,CP01,CP02,CP03,CP04,NP07,CP14,CP27,CP09,CP44,CP45 FROM NEXTPROGRESS,CASEPROGRESS" & _
      " WHERE NP02='" & p_Sys & "' AND NP07='1603' AND NP06 IS NULL AND CP09(+)=NP01" & stCon & _
      " AND NP08<=" & strSrvDate(1) & " AND MOD(TO_DATE(" & strSrvDate(1) & ",'YYYYMMDD')-TO_DATE(NP08,'YYYYMMDD'),30)=0" & _
      " UNION ALL SELECT NP08,CP01,CP02,CP03,CP04,CP10,CP14,CP27,CP09,CP44,CP45 FROM NEXTPROGRESS,CASEPROGRESS,STAFF" & _
      " WHERE NP02='" & p_Sys & "' AND NP07='411' AND NP06 IS NULL AND CP09(+)=NP01 AND CP159=0 AND CP24 IS NULL" & stCon & _
      " AND NP08<=" & strSrvDate(1) & " AND MOD(TO_DATE(" & strSrvDate(1) & ",'YYYYMMDD')-TO_DATE(NP08,'YYYYMMDD'),180)=0" & _
      " AND ST01(+)=CP14 AND ( CP10 IN (" & NewCasePtyList & ") OR ST03 NOT IN ('P12','F22'))"
   'end 2019/11/28
   
   'Modified by Lydia 2017/02/16 抓FMP管制人
   'stSQL = "SELECT SUBSTRB(LPAD(SQLDATET(NP08),9,' '),1,9) C01" & _
      ",SUBSTRB(LPAD(SQLDATET(CP27),9,' '),1,9) C02" & _
      ",cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) C03" & _
      ",SUBSTRB(NVL(PA05,NVL(PA06,PA07)),1,20) C04" & _
      ",SUBSTRB(PTM03,1,6) C05" & _
      ",SUBSTRB(DECODE(PA09,'000',CPM03,CPM04),1,10) C06" & _
      ",SUBSTRB(NA03,1,10) C07" & _
      ",SUBSTRB(DECODE(SK03,0,(NVL(FA04,DECODE(FA05,NULL,FA06,FA05||' '||FA63||' '||FA64||' '||FA65)))" & _
      ",(NVL(FA04,DECODE(FA05,NULL,FA06,FA05||' '||FA63||' '||FA64||' '||FA65)))),1,20) C08" & _
      ",SUBSTRB(ST02,1,6) C09" & _
      "," & GetCaseIdSQL() & " PID" & _
      " From (" & stVTB & ") X,PATENT,CASEPROPERTYMAP,NATION,SYSTEMKIND,FAGENT,STAFF,PATENTTRADEMARKMAP" & _
      " WHERE PA01(+)=CP01 AND PA02(+)=CP02 AND PA03(+)=CP03 AND PA04(+)=CP04 AND PA57 IS NULL AND PA108 IS NULL" & _
      " AND CPM01(+)=CP01 AND CPM02(+)=CP10 AND NA01(+)=PA09 AND SK01(+)=CP01" & _
      " AND FA01(+)=SUBSTR(CP44,1,8) AND FA02(+)=SUBSTR(CP44,9,1) AND ST01(+)=CP14" & _
      " AND PTM01(+)='1' AND PTM02(+)=PA08 ORDER BY PID,1,2,3,5"
   'Modified by Lydia 2018/08/16 SUBSTRB=>SUBSTR
   stSQL = "SELECT SUBSTR(LPAD(SQLDATET(NP08),9,' '),1,9) C01" & _
      ",SUBSTR(LPAD(SQLDATET(CP27),9,' '),1,9) C02" & _
      ",cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) C03" & _
      ",SUBSTR(NVL(PA05,NVL(PA06,PA07)),1,20) C04" & _
      ",SUBSTR(PTM03,1,6) C05" & _
      ",SUBSTR(DECODE(PA09,'000',CPM03,CPM04),1,10) C06" & _
      ",SUBSTR(NA03,1,10) C07" & _
      ",SUBSTR(DECODE(SK03,0,(NVL(F1.FA04,DECODE(F1.FA05,NULL,F1.FA06,F1.FA05||' '||F1.FA63||' '||F1.FA64||' '||F1.FA65)))" & _
      ",(NVL(F1.FA04,DECODE(F1.FA05,NULL,F1.FA06,F1.FA05||' '||F1.FA63||' '||F1.FA64||' '||F1.FA65)))),1,20) C08" & _
      ",SUBSTR(ST02,1,6) C09" & _
      "," & GetCaseIdSQL() & " PID,NVL(F2.FA10,C1.CU10) FA10,CP01,CP02,CP03,CP04,CP09,CP44,CP45" & _
      " From (" & stVTB & ") X,PATENT,CASEPROPERTYMAP,NATION,SYSTEMKIND,FAGENT F1,STAFF,PATENTTRADEMARKMAP,CUSTOMER C1,FAGENT F2" & _
      " WHERE PA01(+)=CP01 AND PA02(+)=CP02 AND PA03(+)=CP03 AND PA04(+)=CP04 AND PA57 IS NULL AND PA108 IS NULL" & _
      " AND CPM01(+)=CP01 AND CPM02(+)=CP10 AND NA01(+)=PA09 AND SK01(+)=CP01" & _
      " AND F1.FA01(+)=SUBSTR(CP44,1,8) AND F1.FA02(+)=SUBSTR(CP44,9,1) AND ST01(+)=CP14" & _
      " AND PTM01(+)='1' AND PTM02(+)=PA08 AND SUBSTR(PA75,1,8)=F2.FA01(+) AND SUBSTR(PA75,9,1)=F2.FA02(+) AND SUBSTR(PA26,1,8)=C1.CU01(+) AND SUBSTR(PA26,9,1)=C1.CU02(+)"
   'Modified by Morgan 2020/9/8 調整欄位順序(PID前移,放後面會跟其他程式的大欄位共用導致無法排序)
   'stSQL = "SELECT  C01,C02,C03,C04,C05,C06,C07,C08,C09,PID,NVL(NA79,NA16) FMP,NVL(ST02,' ') FMPMAN,CP01,CP02,CP03,CP04,CP09,CP44,CP45 FROM (" & stSQL & "),NATION,STAFF WHERE FA10=NA01(+) AND NVL(NA79,NA16)=ST01(+)"
   stSQL = "SELECT  C01,C02,C03,C04,PID,C05,C06,C07,C08,C09,NVL(NA79,NA16) FMP,NVL(ST02,' ') FMPMAN,CP01,CP02,CP03,CP04,CP09,CP44,CP45 FROM (" & stSQL & "),NATION,STAFF WHERE FA10=NA01(+) AND NVL(NA79,NA16)=ST01(+)"
   'end 2020/9/8
   If bolIsOurFMP Then
      stSQL = stSQL & " ORDER BY PID,FMP,1,2,3,4"
   Else
      stSQL = stSQL & " ORDER BY PID,1,2,3,4"
   End If
   'end 2017/02/16
   
   'Modified by Morgan 2020/2/21 CFP管制人 109/4/1以後改業務區劃分
   'If rs.State <> adStateClosed Then rs.Close
   'With rs
   '   .CursorLocation = adUseClient
   '   .Open stSQL, cnnConnection, adOpenForwardOnly, adLockReadOnly
   intI = 1
   Set Rs = ClsLawReadRstMsg(intI, stSQL)
   'Modified by Morgan 2025/1/8 +bolPNewRule
   'If p_Sys = "CFP" And strSrvDate(1) >= 20200401 Then
   If p_Sys = "CFP" Or bolPNewRule Then
   'end 2025/1/8
      If intI = 1 Then
         'Modified by Lydia 2021/07/09 取得序號mSeqNo
         Set rsQuery = PUB_CreateRecordset(Rs, , , 300, Me.Name, mSeqNo)
         With rsQuery
         .MoveFirst
         Do While Not .EOF
            'Added by Morgan 2025/1/8
            If p_Sys = "P" Then
               .Fields("PID") = PUB_GetPHandler(.Fields("C03"))
            Else
            'end 2025/1/8
            
               .Fields("PID") = PUB_GetCFPHandler(.Fields("C03"))
            End If
            .MoveNext
         Loop
         .UpdateBatch 'Added by Lydia 2021/07/09
         '.Sort = "PID,CP44,C01,C02,C03,C04"  'Remove by Lydia 2021/07/09
         End With
         'Added by Lydia 2021/07/09 重新查詢; 因為出現錯誤「無法在其定義長度是不明或過長的資料行執行 Relate、Compute By、及 Sort 操作。」
         strSql = "Select R001 As C01,R002 As C02, R003 As C03, R004 As C04,R005 As PID ,R006 As C05, R007 As C06, R008 As C07, R009 As C08," & _
                     "R010 As C09, R011 As FMP, R012 As FMPMAN, R013 AS CP01, R014 AS CP02, R015 AS CP03, R016 AS CP04,R017 AS CP09,R018 AS CP44,R019 AS CP45 " & _
                     "From Rdatafactory Where Id='" & strUserNum & "' And Formname='" & Me.Name & "'  And Seqno='" & mSeqNo & "' " & _
                     "ORDER BY PID,CP44,C01,C02,C03,C04 "
         intI = 1
         Set rsQuery = ClsLawReadRstMsg(intI, strSql)
         'end 2021/07/09
      Else
         Set rsQuery = Rs
      End If
   Else
      Set rsQuery = Rs
   End If
   With rsQuery
   'end 2020/2/21
      If .RecordCount > 0 Then
         .MoveFirst
         stPID = "" & .Fields("pid")
         'Added by Morgan 2023/6/20
         If bolIsOurFMP Then
            strFMPPID = "" & .Fields("FMP")
            strPIDName = "" & .Fields("FMPMAN")
         Else
         'end 2023/6/20
            strPIDName = GetPIDName(stPID) 'Added by Morgan 2017/10/31
         End If 'Added by Morgan 2023/6/20
         
         If ff > 0 Then Close #ff
         ff = FreeFile
         'Added by Morgan 2014/11/10
         If bolIsOurFMP Then
            stFileName = App.path & TextPath & "FMP寰華案件催審管制表(" & strPIDName & ").txt"
            'Added by Lydia 2017/02/16 設定欄位
                strTitle = "管制人 催審期限  發文日    承辦人 本所案號        案件名稱             種類   案件性質   申請國家   代理人"
            strTitleLine = "------ --------- --------- ------ --------------- -------------------- ------ ---------- ---------- --------------------"
            'end 2017/02/16
         Else
         'end 2014/11/10
            stFileName = App.path & TextPath & p_Sys & "催審管制表(" & strPIDName & ").txt"
            'Added by Lydia 2017/02/16 設定欄位
                strTitle = "催審期限  發文日    承辦人 本所案號        案件名稱             種類   案件性質   申請國家   代理人"
            strTitleLine = "--------- --------- ------ --------------- -------------------- ------ ---------- ---------- --------------------"
            'end 2017/02/16
         End If 'Added by Morgan 2014/11/10
         Open stFileName For Output As ff
         'Added by Lydia 2016/10/19 加報表抬頭
         Print #ff, Space(35) & IIf(bolIsOurFMP = True, "FMP寰華案件催審管制表(" & strPIDName & ")", p_Sys & "催審管制表(" & strPIDName & ")")
         'end 2016/10/19
         Print #ff, ""
         Print #ff, "日期：" & p_RptDate
         Print #ff, ""
         'Modified by Lydia 2017/02/16 設定欄位
         'Print #ff, "催審期限  發文日    承辦人 本所案號        案件名稱             種類   案件性質   申請國家   代理人"
         'Print #ff, "--------- --------- ------ --------------- -------------------- ------ ---------- ---------- --------------------"
         Print #ff, strTitle
         Print #ff, strTitleLine
         'end 2017/02/16
         
         tmpnext = "開檔中..."
         
         .MoveFirst
         Do While Not .EOF
            'Modified by Morgan 2023/6/20
            'If stPID <> "" & .Fields("pid") Then
            If stPID <> "" & .Fields("pid") Or (bolIsOurFMP And strFMPPID <> "" & .Fields("FMP")) Then
               'Modified by Lydia 2017/02/16 設定欄位
               'Print #ff, "--------- --------- ------ --------------- -------------------- ------ ---------- ---------- --------------------"
               Print #ff, strTitleLine
               'end 2017/02/16
               
               Print #ff, "共" & lngRecs & "筆"
               Close ff
               p_FileName = p_FileName & stFileName & ";"
               
               'Added by Morgan 2017/10/31 CFP改直接寄給承辦人--甄妮106/10/27請作單
               'Modified by Morgan 2025/1/8 +bolPNewRule
               'If p_Sys = "CFP" Then
               If p_Sys = "CFP" Or bolPNewRule Then
               'end 2025/1/8
                  strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & _
                     p_Sys & "催審管制表(" & p_RptDate & ")(" & strPIDName & ") 資料如附件！" & _
                     vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & p_PS
                  SendMAPIMail stPID, p_Sys & "催審管制表(" & p_RptDate & ")(" & strPIDName & ")", strText, stFileName
                  stCFPMailList = stCFPMailList & stPID & ";"
                  
               'Added by Morgan 2023/6/20
               ElseIf bolIsOurFMP Then
                  strFMPPSup = PUB_GetFCPProSup(strFMPPID)
                  strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & _
                     "FMP寰華案件催審管制表(" & p_RptDate & ")(" & strPIDName & ") 資料如附件！" & _
                     vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & p_PS
                  SendMAPIMail strFMPPID, "FMP寰華案件催審管制表(" & p_RptDate & ")(" & strPIDName & ")", strText, stFileName, , , strFMPPSup
               'end 2023/6/20
               End If
               'end 2017/10/31
               
               lngRecs = 0
               stPID = "" & .Fields("pid")
               'Added by Morgan 2023/6/20
               If bolIsOurFMP Then
                  strFMPPID = "" & .Fields("FMP")
                  strPIDName = "" & .Fields("FMPMAN")
               Else
               'end 2023/6/20
                  strPIDName = GetPIDName(stPID) 'Added by Morgan 2017/10/31
               End If 'Added by Morgan 2023/6/20
               
               If ff > 0 Then Close #ff
               ff = FreeFile
               'Added by Morgan 2014/11/10
               If bolIsOurFMP Then
                  stFileName = App.path & TextPath & "FMP寰華案件催審管制表(" & strPIDName & ").txt"
               Else
               'end 2014/11/10
                  stFileName = App.path & TextPath & p_Sys & "催審管制表(" & strPIDName & ").txt"
               End If 'Added by Morgan 2014/11/10
               Open stFileName For Output As ff
               'Added by Lydia 2016/10/19 加報表抬頭
               Print #ff, Space(30) & IIf(bolIsOurFMP = True, "FMP寰華案件催審管制表(" & strPIDName & ")", p_Sys & "催審管制表(" & strPIDName & ")")
               'end 2016/10/19
               Print #ff, ""
               Print #ff, "日期：" & p_RptDate
               Print #ff, ""
               'Modified by Lydia 2017/02/16 設定欄位
               'Print #ff, "催審期限  發文日    承辦人 本所案號        案件名稱             種類   案件性質   申請國家   代理人"
               'Print #ff, "--------- --------- ------ --------------- -------------------- ------ ---------- ---------- --------------------"
               Print #ff, strTitle
               Print #ff, strTitleLine
               'end 2017/02/16
            End If
            lngRecs = lngRecs + 1
            strContent = Empty
            'Added by Lydia 2017/02/16 +管制人
            If bolIsOurFMP Then
               strContent = convForm("" & .Fields("FMPMAN"), 6) & " " & strContent '管制人
            End If
            'end 2017/02/16
            
            strContent = strContent & convForm("" & .Fields("C01"), 9) '催審期限
            strContent = strContent & " " & convForm("" & .Fields("C02"), 9) '發文日
            strContent = strContent & " " & convForm("" & .Fields("C09"), 6) '承辦人
            strContent = strContent & " " & convForm("" & .Fields("C03"), 15) '本所案號
            strContent = strContent & " " & convForm("" & .Fields("C04"), 20) '案件名稱
            strContent = strContent & " " & convForm("" & .Fields("C05"), 6) '種類
            strContent = strContent & " " & convForm("" & .Fields("C06"), 10) '案件性質
            strContent = strContent & " " & convForm("" & .Fields("C07"), 10) '申請國家
            strContent = strContent & " " & convForm("" & .Fields("C08"), 20) '代理人
            
            tmpnext = "寫檔..."
            Print #ff, strContent
            
            'Added by Morgan 2017/11/13 CFP催審要自動內部收文期限設3個工作天
            If p_Sys = "CFP" Then
               
               strCP09 = AutoNo("B", 6)
               strCP13 = PUB_GetAKindSalesNo(.Fields("CP01"), .Fields("CP02"), .Fields("CP03"), .Fields("CP04"))
               strCP12 = GetSalesArea(strCP13)
               strCP06 = CompWorkDay(3, strSrvDate(1))
               'Modified by Lydia 2019/02/11 改抓最新進度檔最新一道程序的代理人(ex.CFP-026875)
               'strSql = "INSERT INTO CASEPROGRESS (CP01,CP02,CP03,CP04,CP05,CP06,CP09,CP10" & _
                  ",CP12,CP13,CP14,CP20,CP26,CP27,CP32,CP43,CP44,CP45,CP64)" & _
                  " VALUES ('" & .Fields("CP01") & "','" & .Fields("CP02") & "','" & _
                  .Fields("CP03") & "','" & .Fields("CP04") & "'," & strSrvDate(1) & "," & CNULL(strCP06, True) & ",'" & strCP09 & "','411','" & strCP12 & "','" & _
                 strCP13 & "','" & .Fields("pid") & "','N','N',NULL,'N','" & .Fields("CP09") & "','" & .Fields("CP44") & "','" & .Fields("CP45") & "','催審')"
               Call PUB_GetCP44(.Fields("CP01"), .Fields("CP02"), .Fields("CP03"), .Fields("CP04"), strCP44, strExc(0), strCP45)
               strSql = "INSERT INTO CASEPROGRESS (CP01,CP02,CP03,CP04,CP05,CP06,CP09,CP10" & _
                  ",CP12,CP13,CP14,CP20,CP26,CP27,CP32,CP43,CP44,CP45,CP64)" & _
                  " VALUES ('" & .Fields("CP01") & "','" & .Fields("CP02") & "','" & _
                  .Fields("CP03") & "','" & .Fields("CP04") & "'," & strSrvDate(1) & "," & CNULL(strCP06, True) & ",'" & strCP09 & "','411','" & strCP12 & "','" & _
                 strCP13 & "','" & .Fields("pid") & "','N','N',NULL,'N','" & .Fields("CP09") & "','" & strCP44 & "','" & strCP45 & "','催審')"
               'end 2019/02/11
               cnnConnection.Execute strSql, intI
            End If
            .MoveNext
         Loop
         'Modified by Lydia 2017/02/16 設定欄位
         'Print #ff, "--------- --------- ------ --------------- -------------------- ------ ---------- ---------- --------------------"
         Print #ff, strTitleLine
         'end 2017/02/16
         Print #ff, "共" & lngRecs & "筆"
         Close ff
         p_FileName = p_FileName & stFileName
         
         'Added by Morgan 2017/10/31 CFP改直接寄給承辦人--甄妮106/10/27請作單
         'Modified by Morgan 2025/1/8 +bolPNewRule
         'If p_Sys = "CFP" Then
         If p_Sys = "CFP" Or bolPNewRule Then
         'end 2025/1/8
            strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & _
               p_Sys & "催審管制表(" & p_RptDate & ")(" & strPIDName & ") 資料如附件！" & _
               vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & p_PS
            SendMAPIMail stPID, p_Sys & "催審管制表(" & p_RptDate & ")(" & strPIDName & ")", strText, stFileName
            stCFPMailList = stCFPMailList & stPID & ";"
            
         'Added by Morgan 2023/6/20
         ElseIf bolIsOurFMP Then
            strFMPPSup = PUB_GetFCPProSup(strFMPPID)
            strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & _
               "FMP寰華案件催審管制表(" & p_RptDate & ")(" & strPIDName & ") 資料如附件！" & _
               vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & p_PS
            SendMAPIMail strFMPPID, "FMP寰華案件催審管制表(" & p_RptDate & ")(" & strPIDName & ")", strText, stFileName, , , strFMPPSup
         'end 2023/6/20
         End If
         'end 2017/10/31
               
      End If
   End With
   
   'Added by Morgan 2017/10/31 CFP改直接寄給承辦人--甄妮106/10/27請作單
   'Modified by Morgan 2025/1/8 +bolPNewRule
   'If p_Sys = "CFP" Then
   '   stSQL = "select na73 from nation union select na74 from nation order by 1"
   '   'Added by Morgan 2020/2/21
   '   If strSrvDate(1) >= 20200401 Then
   '      stSQL = "select distinct a0916 from acc090 order by 1"
   '   End If
   '   'end 2020/2/21
   If p_Sys = "CFP" Or bolPNewRule Then
      If p_Sys = "CFP" Then
         stSQL = "select distinct a0916 from acc090 where a0916 is not null order by 1"
      Else
         stSQL = "select distinct a0917 from acc090 where a0917 is not null order by 1"
      End If
   'end 2025/1/8
      If Rs.State <> adStateClosed Then Rs.Close
      With Rs
      .CursorLocation = adUseClient
      .Open stSQL, cnnConnection, adOpenForwardOnly, adLockReadOnly
      If .RecordCount > 0 Then
         Do While Not .EOF
            If Not IsNull(.Fields(0)) Then
               stPID = .Fields(0)
               If InStr(stCFPMailList, stPID) = 0 Then
                  strPIDName = GetPIDName(stPID)
                  'Modified by Morgan 2025/1/8
                  'strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & _
                     "CFP催審管制表(" & p_RptDate & ")(" & strPIdName & ") 無需管制資料！" & _
                     vbCrLf & vbCrLf & String(25, "　") & "電腦中心"
                  'SendMAPIMail stPID, "CFP催審管制表(" & p_RptDate & ")(" & strPIdName & ")", strText
                  SendMAPIMail stPID, p_Sys & "催審管制表(" & p_RptDate & ")(" & strPIDName & ") 無需管制資料！", "如旨"
                  'end 2025/1/8
               End If
            End If
            .MoveNext
         Loop
      End If
      End With
   End If
   'end 2017/10/31
   
   CreateFile9 = True
   Set rsQuery = Nothing 'Added by Morgan 2020/2/21
   Exit Function
   
ErrHandle:
   WLog tmpnext & " " & Err.Description
   Set rsQuery = Nothing 'Added by Morgan 2020/2/21
   
End Function


'Add by Morgan 2008/8/27
'專利證書管制表
'第一次管制後每3個月(90)天跑一次
'Removed by Morgan 2022/5/6 沒用,程式碼也有問題,已刪
''Private Function CreateFile10(ByVal p_Sys As String, ByVal p_RptDate As String, ByRef p_FileName As String) As Boolean
'End Function
'end 2022/5/6

'Add by Morgan 2009/4/22
'內翻及巨京翻譯發文案件清單
'Removed by Morgan 2020/9/21 取消(已改用原文字計算)--何淑華
'Private Function CreateFile11(ByVal p_RptDate As String, ByRef p_FileName As String) As Boolean
'
'   Dim stSQL As String
'   Dim ff As Integer
'   Dim strContent As String
'   Dim tmpnext As String
'   Dim stVTB0 As String
'   Dim stVTB1 As String
'
'   p_FileName = ""
'
'On Error GoTo ErrHandle
'
'  '抓前一個工作天發文案件
'  'Modify by Morgan 2009/8/21 +判斷取消收文日
'  'Modify by Morgan 2011/8/1 +北京華陽 F5639
'  'Modified by Morgan 2011/12/7 取消收文的還要判斷有完稿日才要印
'  'Modified by Morgan 2015/5/8 改抓內翻部門(原用staff_idmap來判斷會抓到已離職同仁 Ex.F5220)
'  'Modified by Lydia 2016/09/14 CP27=>CP158 ; CP57=>CP159
'  'Modified by Lydia 2018/08/16 SUBSTRB=>SUBSTR
'  stSQL = " select SUBSTR(SQLDATET(nvl(c1.CP158,c1.CP159))||decode(c1.CP158,null,'#'),1,10) C01" & _
'      ",SUBSTR(SQLDATET(EP09),1,9) C02" & _
'      ",DECODE(c2.CP01,NULL,' ','*')||pa01||'-'||pa02||decode(pa03||pa04,'000','',pa03||pa04) C03" & _
'      ",st02||' '||c1.cp14 C04,pa05 C05" & _
'      " from caseprogress c1,engineerprogress,staff,patent,caseprogress c2,transfee" & _
'      " where (c1.CP158=to_char(to_date(" & strSrvDate(1) & ",'yyyymmdd')-1,'YYYYMMDD') or (EP09>0 and c1.CP158 is null and c1.CP159=to_char(to_date(" & strSrvDate(1) & ",'yyyymmdd')-1,'YYYYMMDD')))" & _
'      " and c1.cp10='201' and SUBSTR(c1.CP14,1,1)='F' and st01(+)=c1.cp14 and ST15 in ('F21','F51','F52','F81')" & _
'      " and (c1.cp14='F5595' or c1.cp14='F5639' or st15='F52') and ep02(+)=c1.cp09" & _
'      " and pa01(+)=c1.cp01 and pa02(+)=c1.cp02 and pa03(+)=c1.cp03 and pa04(+)=c1.cp04" & _
'      " AND c2.CP43(+)=c1.CP09 AND c2.CP10(+)='404' and tf01(+)=c1.CP09 and tf02 is null"
'   If rs.State <> adStateClosed Then rs.Close
'   With rs
'      .CursorLocation = adUseClient
'      .Open stSQL, cnnConnection, adOpenForwardOnly, adLockReadOnly
'      If .RecordCount > 0 Then
'         If ff > 0 Then Close #ff
'         ff = FreeFile
'         'Modify By Sindy 2009/06/04
'         'p_FileName = "C:\" & "翻譯發文案件清單.txt"
'         p_FileName = App.path & TextPath & "翻譯發文案件清單.txt"
'         '2009/06/04 End
'         Open p_FileName For Output As ff
'         'Added by Lydia 2016/10/19 加報表抬頭
'         Print #ff, Space(15) & "翻譯發文案件清單"
'         'end 2016/10/19
'         Print #ff, ""
'         Print #ff, "列印日期：" & p_RptDate
'         Print #ff, ""
'         Print #ff, "發文日     完稿日    本所案號         承辦人       案件名稱                      "
'         Print #ff, "---------- --------- ---------------- ------------ ------------------------------"
'
'         tmpnext = "開檔中..."
'
'         .MoveFirst
'         Do While Not .EOF
'            strContent = Empty
'            strContent = strContent & convForm("" & .Fields("C01") & Space(1), 10) '發文日
'            strContent = strContent & " " & convForm("" & .Fields("C02") & Space(1), 9) '核稿日
'            strContent = strContent & " " & convForm("" & .Fields("C03") & Space(16), 16) '本所案號
'            strContent = strContent & " " & convForm("" & .Fields("C04") & Space(12), 12) '承辦人
'            strContent = strContent & " " & convForm("" & .Fields("C05") & Space(30), 30) '案件名稱
'            tmpnext = "寫檔..."
'            Print #ff, strContent
'            .MoveNext
'         Loop
'         Print #ff, "---------- --------- ---------------- ------------ ------------------------------"
'         Print #ff, "共" & .RecordCount & "筆"
'         Print #ff, ""
'         Print #ff, "翻譯該程序若有延期，本所案號前作 * 標記，若發文日後有 # 號則表示該日期為取消收文日"
'
'
'         Close ff
'      End If
'   End With
'   CreateFile11 = True
'   Exit Function
'
'ErrHandle:
'   WLog tmpnext & " " & Err.Description
'
'End Function

'Add by Morgan 2009/4/23
'新提申管制表
'注意:本程式要與frm050303(提申管制函)同步修改
'Modified by Morgan 2014/11/10 +bolIsOurFMP:是否FMP寰華案件
Private Function CreateFile12(ByVal p_Sys As String, ByVal p_RptDate As String, Optional ByRef p_FileName As String, Optional bolIsOurFMP As Boolean, Optional p_PS As String) As Boolean
   
   Dim stSQL As String
   Dim ff As Integer
   Dim strContent As String
   Dim tmpnext As String
   Dim stVTB As String
   Dim stPID As String
   Dim lngRecs As Long
   Dim stFileName As String
   Dim stCon As String
   'Added by Lydia 2017/02/16 設定欄位
   Dim strTitle As String    '欄位抬頭名稱
   Dim strTitleLine As String '欄位抬頭底線
   Dim stCFPMailList As String, strText As String, strPIDName As String 'Added by Morgan 2017/10/31
   Dim stRptID As String 'Added by Morgan 2018/3/22
   Dim rsQuery As ADODB.Recordset 'Added by Morgan 2020/2/21
   Dim mSeqNo As String 'Added by Lydia 2021/07/09
   Dim strFMPPID As String, strFMPPSup As String 'Added by Morgan 2023/6/20
   Dim bolPNewRule As Boolean 'Added by Morgan 2024/12/30 P案(非FMP)是否用新管制人規則
   
   p_FileName = ""
   lngRecs = 0
   
   'Added by Morgan 2024/12/30
   If p_Sys = "P" And bolIsOurFMP = False And strSrvDate(1) >= P業務區劃分啟用日 Then
      bolPNewRule = True
   Else
      bolPNewRule = False
   End If
   'end 2024/12/30
   
   'Added by Morgan 2014/11/10
   If p_Sys = "P" Then
      'Modified by Morgan 2015/10/26
      'FMP寰華加判斷發文人員為外專程序
      If bolIsOurFMP Then
         stCon = stCon & " and exists"
      Else
         stCon = stCon & " and not exists"
      End If
      'Modified by Morgan 2018/8/28 修正發文人原部門判斷(原程式抓到承辦人)
      stCon = stCon & "(select * from caseprogress b,staff c where b.cp01=np02 and b.cp02=np03 and b.cp03=np04 and b.cp04=np05 and b.cp31='Y' and b.cp44='Y53374000' and b.cp12 like 'F%' and c.st01(+)=b.cp83 and (b.cp83 is null or c.st03='F22'))"
      'end 2015/10/26
   End If
   'end 2014/11/10
   
On Error GoTo ErrHandle
   '1 系統日=提申管制日(已收達)
   '2 系統日=提申管制日+N*提申管制週期(已收達)
   '3 系統日>=發文日+管制底限天數(已收達)
   '4 系統日+3個工作天>=指定(最終)提申日 'Modify by Morgan 2009/9/7
   '5 回代逾期
   
   'Modified by Morgan 2018/3/23 +CP07
   'Modified by Morgan 2014/8/26 +NA73,NA74
   '1
   'Modified by Lydia 2016/09/14 and cp57 is null and cp27>0=>CP159=0 AND CP158>0 ; C4.CP27 IS NULL and C4.cp57 is null=> AND C4.CP158=0 AND C4.CP159=0
   'Modified by Lydia 2017/02/16 +PA75,PA26
   stVTB = " select CP01,CP02,CP03,CP04,CP05,CP07,CP09,CP10,CP14,CP27,CP44,CP46,PA01,PA02,PA05,PA06,PA07,PA08,PA09,NA02,NA03,NP07,NP09,1 id,NA73,NA74,PA75,PA26" & _
      " from nextprogress NP,caseprogress C1,patent,nation" & _
      " where np02='" & p_Sys & "' and np06 is null and np07='998' and np08>" & (strSrvDate(1) - 10000) & stCon & _
      " and cp09(+)=np01 and cp46>0 and CP159=0 AND CP158>0" & _
      " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04 and pa57 is null and pa01 is not null" & _
      " and na01(+)=pa09 and np08=" & strSrvDate(1) & _
      " AND NOT EXISTS(SELECT * FROM CASEPROGRESS C4 WHERE C4.CP01=C1.CP01 AND C4.CP02=C1.CP02 AND C4.CP03=C1.CP03 AND C4.CP04=C1.CP04 AND C4.CP10='936' AND C4.CP158=0 AND C4.CP159=0)"
   '2
   'Modified by Lydia 2016/09/14 and cp57 is null and cp27>0=>CP159=0 AND CP158>0 ; C4.CP27 IS NULL and C4.cp57 is null=> AND C4.CP158=0 AND C4.CP159=0
   'Modified by Lydia 2017/02/16 +PA75,PA26
   stVTB = stVTB & " Union All" & _
      " select CP01,CP02,CP03,CP04,CP05,CP07,CP09,CP10,CP14,CP27,CP44,CP46,PA01,PA02,PA05,PA06,PA07,PA08,PA09,NA02,NA03,NP07,NP09,2 id,NA73,NA74,PA75,PA26" & _
      " from nextprogress NP,caseprogress C1,patent,nation" & _
      " where np02='" & p_Sys & "' and np06 is null and np07='998' and np08>" & (strSrvDate(1) - 10000) & stCon & _
      " and cp09(+)=np01 and cp46>0 and CP159=0 AND CP158>0" & _
      " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04 and pa57 is null and pa01 is not null" & _
      " and na01(+)=pa09 and np08<" & strSrvDate(1) & _
      " and MOD(TO_DATE(" & strSrvDate(1) & ",'YYYYMMDD')-TO_DATE(NP08,'YYYYMMDD'),NVL(NA61,15))=0" & _
      " and TO_DATE(" & strSrvDate(1) & ",'YYYYMMDD')<(TO_DATE(CP27,'YYYYMMDD')+NVL(NA62,90))" & _
      " AND NOT EXISTS(SELECT * FROM CASEPROGRESS C4 WHERE C4.CP01=C1.CP01 AND C4.CP02=C1.CP02 AND C4.CP03=C1.CP03 AND C4.CP04=C1.CP04 AND C4.CP10='936' AND C4.CP158=0 AND C4.CP159=0)"
   '3
   'Modified by Lydia 2016/09/14 and cp57 is null and cp27>0=>CP159=0 AND CP158>0 ; C4.CP27 IS NULL and C4.cp57 is null=> AND C4.CP158=0 AND C4.CP159=0
   'Modified by Morgan 2017/2/8 +已過提申管制日的條件 Ex.CFP16735--玫音
   'Modified by Lydia 2017/02/16 +PA75,PA26
   stVTB = stVTB & " Union All" & _
      " select CP01,CP02,CP03,CP04,CP05,CP07,CP09,CP10,CP14,CP27,CP44,CP46,PA01,PA02,PA05,PA06,PA07,PA08,PA09,NA02,NA03,NP07,NP09,3 id,NA73,NA74,PA75,PA26" & _
      " from nextprogress NP,caseprogress C1,patent,nation" & _
      " where np02='" & p_Sys & "' and np06 is null and np07='998' and np08>" & (strSrvDate(1) - 10000) & stCon & _
      " and cp09(+)=np01 and cp46>0 and CP159=0 AND CP158>0" & _
      " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04 and pa57 is null and pa01 is not null" & _
      " and na01(+)=pa09 and np08<" & strSrvDate(1) & " and TO_DATE(" & strSrvDate(1) & ",'YYYYMMDD')>=(TO_DATE(CP27,'YYYYMMDD')+NVL(NA62,90))" & _
      " AND NOT EXISTS(SELECT * FROM CASEPROGRESS C4 WHERE C4.CP01=C1.CP01 AND C4.CP02=C1.CP02 AND C4.CP03=C1.CP03 AND C4.CP04=C1.CP04 AND C4.CP10='936' AND C4.CP158=0 AND C4.CP159=0)"
   '4
   'Modify by Morgan 2009/9/7 改工作天--慧汶(to_char(sysdate+3,'yyyymmdd')--> WORKDAYADD(-3,to_char(sysdate,'yyyymmdd'))
   'Modified by Lydia 2016/09/14 and cp57 is null and cp27>0=>CP159=0 AND CP158>0 ;
   'Modified by Lydia 2017/02/16 +PA75,PA26
   stVTB = stVTB & " Union All" & _
      " select CP01,CP02,CP03,CP04,CP05,CP07,CP09,CP10,CP14,CP27,CP44,CP46,PA01,PA02,PA05,PA06,PA07,PA08,PA09,NA02,NA03,NP07,NP09,4 id,NA73,NA74,PA75,PA26" & _
      " from (select WORKDAYADD(4," & strSrvDate(1) & ") dd from dual) X" & _
      ",nextprogress NP,caseprogress C1,patent,nation" & _
      " where np08>dd-10000 and np08<=dd and np02='" & p_Sys & "' and np06 is null" & stCon & _
      " and np07 in ('995','996') and cp09(+)=np01 and CP159=0 AND CP158>0" & _
      " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04" & _
      " and pa57 is null and pa01 is not null and na01(+)=pa09"
   '5
   'Modified by Lydia 2016/09/14 C1.cp57 is null and C1.cp27>0=>C1.CP159=0 and C1.CP158>0 ; C4.cp57 is null=> C4.CP159=0 ; AND C4.CP27 IS NULL=> AND C4.CP158=0
   'Modified by Lydia 2017/02/16 +PA75,PA26
   stVTB = stVTB & " Union All" & _
      " select C1.CP01,C1.CP02,C1.CP03,C1.CP04,C1.CP05,C1.CP07,C1.CP09,C1.CP10,C1.CP14,C1.CP27,C1.CP44,C1.CP46,PA01,PA02,PA05,PA06,PA07,PA08,PA09,NA02,NA03,C4.CP10 NP07,C4.CP07 NP09,5 id,NA73,NA74,PA75,PA26" & _
      " from nextprogress NP,caseprogress C1,caseprogress C4,patent,nation" & _
      " where np02='" & p_Sys & "' and np06 is null and np07='998'" & stCon & _
      " and C1.cp09(+)=np01 and C1.cp46>0 and C1.CP159=0 and C1.CP158>0" & _
      " and pa01(+)=C1.cp01 and pa02(+)=C1.cp02 and pa03(+)=C1.cp03 and pa04(+)=C1.cp04 and pa57 is null and pa01 is not null" & _
      " and C4.CP01(+)=C1.CP01 AND C4.CP02(+)=C1.CP02 AND C4.CP03(+)=C1.CP03 AND C4.CP04(+)=C1.CP04" & _
      " AND C4.CP10='936' AND C4.CP06<" & strSrvDate(1) & " AND C4.CP158=0 and C4.CP159=0 " & _
      " and na01(+)=pa09 "
   
   'Modify by Morgan 2016/5/20 +代理人編號,代理人排序
   'Modified by Lydia 2017/02/16 抓FMP管制人
   'stSQL = "SELECT ST02 C01,SQLDATET2(cp27) C02,SQLDATET2(NP09) C03" & _
      ",CP09 C04,CP01||'-'||CP02||decode(CP03||CP04,'000','','-'||CP03||'-'||CP04) C05" & _
      ",NVL(PA05,NVL(PA06,PA07)) C06,PTM03 C07,NA03 C08,DECODE(PA09,'000',CPM03,CPM04) C09" & _
      ",CP44||' '||DECODE(SK03,0,(NVL(FA04,DECODE(FA05,NULL,FA06,FA05||' '||FA63||' '||FA64||' '||FA65)))" & _
      ",(NVL(FA04,DECODE(FA05,NULL,FA06,FA05||' '||FA63||' '||FA64||' '||FA65)))) C10" & _
      ",sqldatet2(CP46) C11,DECODE(NP07,'998',decode(id,1,'一般',2,'週期',3,'底限'),'995','指定','996','最終','936','回代逾期') C12" & _
      "," & GetCaseIdSQL() & " PID,CP44" & _
      " FROM (" & stVTB & ") X,STAFF,SYSTEMKIND,CASEPROPERTYMAP,FAGENT,PATENTTRADEMARKMAP" & _
      " Where ST01(+)=CP14 AND SK01(+)=CP01 AND CPM01(+)=CP01" & _
      " AND CPM02(+)=CP10 AND PTM01(+)='1' AND PTM02(+)=PA08" & _
      " AND FA01(+)=SUBSTR(CP44,1,8) AND FA02(+)=SUBSTR(CP44,9,1) ORDER BY PID,CP44,1,2,3,4"
   'Modified by Morgan 2018/3/22 +Rpt,CFP的605,606,607單獨檔案
   'Modified by Morgan 2022/9/22 CFP的605,606,607再將美國、EPC、EU、德國改為單獨檔案
   stSQL = "SELECT ST02 C01,substr(SQLDATET2(cp27),1,9) C02,substr(SQLDATET2(NP09),1,9) C03" & _
      ",CP09 C04,CP01||'-'||CP02||decode(CP03||CP04,'000','','-'||CP03||'-'||CP04) AS C05" & _
      ",NVL(PA05,NVL(PA06,PA07)) C06,PTM03 C07,NA03 C08,DECODE(PA09,'000',CPM03,CPM04) C09" & _
      ",CP44||' '||DECODE(SK03,0,(NVL(F1.FA04,DECODE(F1.FA05,NULL,F1.FA06,F1.FA05||' '||F1.FA63||' '||F1.FA64||' '||F1.FA65)))" & _
      ",(NVL(F1.FA04,DECODE(F1.FA05,NULL,F1.FA06,F1.FA05||' '||F1.FA63||' '||F1.FA64||' '||F1.FA65)))) C10" & _
      ",substr(SQLDATET2(CP46),1,9) C11,DECODE(NP07,'998',decode(id,1,'一般',2,'週期',3,'底限'),'995','指定','996','最終','936','回代逾期') C12" & _
      "," & GetCaseIdSQL() & " PID,CP44,NVL(F2.FA10,C1.CU10) FA10,DECODE(INSTR('CFP605,CFP606,CFP607',CP01||CP10),0,1,decode(instr('101,221,239,231',pa09),0,2,3)) Rpt,substr(SQLDATET2(CP07),1,9) C13" & _
      " FROM (" & stVTB & ") X,STAFF,SYSTEMKIND,CASEPROPERTYMAP,FAGENT F1,PATENTTRADEMARKMAP,CUSTOMER C1,FAGENT F2" & _
      " Where ST01(+)=CP14 AND SK01(+)=CP01 AND CPM01(+)=CP01" & _
      " AND CPM02(+)=CP10 AND PTM01(+)='1' AND PTM02(+)=PA08" & _
      " AND F1.FA01(+)=SUBSTR(CP44,1,8) AND F1.FA02(+)=SUBSTR(CP44,9,1)" & _
      " AND SUBSTR(PA75,1,8)=F2.FA01(+) AND SUBSTR(PA75,9,1)=F2.FA02(+) AND SUBSTR(PA26,1,8)=C1.CU01(+) AND SUBSTR(PA26,9,1)=C1.CU02(+)"
      
   stSQL = "SELECT  C01,C02,C03,C04,C05,C06,C07,C08,C09,C10,C11,C12,C13,PID,CP44,NVL(NA79,NA16) FMP,NVL(ST02,' ') FMPMAN,Rpt FROM (" & stSQL & "),NATION,STAFF WHERE FA10=NA01(+) AND NVL(NA79,NA16)=ST01(+)"
   If bolIsOurFMP Then
      stSQL = stSQL & " ORDER BY PID,FMP,CP44,1,2,3,4"
   'Added by Morgan 2018/3/23 改依報表別,法定期限,提申期限排序
   ElseIf p_Sys = "CFP" Then
      'Modified by Lydia 2021/07/09
      'stSQL = stSQL & " ORDER BY PID,Rpt,C13,3,2,4"
      stSQL = stSQL & " ORDER BY PID,Rpt,C13,C03,C02,C04"
   'end 2018/3/23
   Else
      stSQL = stSQL & " ORDER BY PID,CP44,1,2,3,4"
   End If
   'end 2017/02/16
  
   'Modified by Morgan 2020/2/21 CFP管制人 109/4/1以後改業務區劃分
   'If rs.State <> adStateClosed Then rs.Close
   'With rs
   '   .CursorLocation = adUseClient
   '   .Open stSQL, cnnConnection, adOpenForwardOnly, adLockReadOnly
   intI = 1
   Set Rs = ClsLawReadRstMsg(intI, stSQL)
   'Modified by Morgan 2024/12/30 +bolPNewRule
   'If p_Sys = "CFP" And strSrvDate(1) >= 20200401 Then
   If p_Sys = "CFP" Or bolPNewRule Then
   'end 2024/12/30
      If intI = 1 Then
         'Modified by Lydia 2021/07/09 取得序號mSeqNo
         Set rsQuery = PUB_CreateRecordset(Rs, , , 300, Me.Name, mSeqNo)
         With rsQuery
         .MoveFirst
         Do While Not .EOF
            'Added by Morgan 2024/12/30
            If p_Sys = "P" Then
               .Fields("PID") = PUB_GetPHandler(.Fields("C05"))
            Else
            'end 2024/12/30
            
               .Fields("PID") = PUB_GetCFPHandler(.Fields("C05"))
            End If
            .MoveNext
         Loop
         .UpdateBatch 'Added by Lydia 2021/07/09
         '.Sort = "PID,Rpt,C13,C03,C02,C04" 'Remove by Lydia 2021/07/09
         End With
         'Added by Lydia 2021/07/09 重新查詢; 因為出現錯誤「無法在其定義長度是不明或過長的資料行執行 Relate、Compute By、及 Sort 操作。」
         'Modified by Morgan 2021/7/16 R016 As FMPMAN,R017 As Rpt --> R017 As FMPMAN, R018 As Rpt
         'Modified by Morgan 2023/6/21 +, R016 As FMP
         strSql = "Select R001 As C01,R002 As C02, R003 As C03, R004 As C04,R005 As C05,R006 As C06, R007 As C07, R008 As C08, R009 As C09," & _
                     "R010 As C10, R011 As C11, R012 As C12, R013 As C13, R014 As pID, R015 As CP44, R016 As FMP, R017 As FMPMAN, R018 As Rpt " & _
                     "From Rdatafactory Where Id='" & strUserNum & "' And Formname='" & Me.Name & "'  And Seqno='" & mSeqNo & "' "
         'Added by Morgan 2024/12/30
         If p_Sys = "P" Then
            strSql = strSql & " ORDER BY PID,CP44,1,2,3,4"
         Else
         'end 2024/12/30
            strSql = strSql & " ORDER BY PID,Rpt,C13,C03,C02,C04 "
         End If
         intI = 1
         Set rsQuery = ClsLawReadRstMsg(intI, strSql)
         'end 2021/07/09
      Else
         Set rsQuery = Rs
      End If
   Else
      Set rsQuery = Rs
   End If
   With rsQuery
   'end 2020/2/21
      If .RecordCount > 0 Then
         .MoveFirst
         stRptID = "" & .Fields("Rpt") 'Added by Morgan 2018/3/22
         stPID = "" & .Fields("pid")
         'Added by Morgan 2023/6/20
         If bolIsOurFMP Then
            strFMPPID = "" & .Fields("FMP")
            strPIDName = "" & .Fields("FMPMAN")
         Else
         'end 2023/6/20
            strPIDName = GetPIDName(stPID) 'Added by Morgan 2017/10/31
         End If 'Added by Morgan 2023/6/20
         
         If ff > 0 Then Close #ff
         ff = FreeFile
         'Modify By Sindy 2009/06/04
         'stFileName = "C:\" & p_Sys & "代理人案件提申管制表(" & strPIdName & ").txt"
         'Added by Morgan 2014/11/10
         If bolIsOurFMP Then
            stFileName = App.path & TextPath & "FMP寰華案件代理人案件提申管制表(" & strPIDName & ").txt"
            'Added by Lydia 2017/02/16 設定欄位
                strTitle = "管制人 承辦人 發文日    提申期限  提申類別 法定期限  本所案號        案件名稱       種類   申請國家 案件性質   代理人               收達日   "
            strTitleLine = "------ ------ --------- --------- -------- --------- --------------- -------------- ------ -------- ---------- -------------------- ---------"
            'end 2017/02/16
         Else
         'end 2014/11/10
            'Modified by Morgan 2018/3/22
            'stFileName = App.path & TextPath & p_Sys & "代理人案件提申管制表(" & strPIdName & ").txt"
            'Modified by Morgan 2022/9/23 +自繳年費
            stFileName = App.path & TextPath & p_Sys & "代理人" & IIf(stRptID = "1", "案件", IIf(stRptID = "2", "年費", "自繳年費")) & "提申管制表(" & strPIDName & ").txt"
            'Added by Lydia 2017/02/16 設定欄位
                strTitle = "承辦人 發文日    提申期限  提申類別 法定期限  本所案號        案件名稱       種類   申請國家 案件性質   代理人               收達日   "
            strTitleLine = "------ --------- --------- -------- --------- --------------- -------------- ------ -------- ---------- -------------------- ---------"
            'end 2017/02/16
         End If 'Added by Morgan 2014/11/10
         '2009/06/04 End
         Open stFileName For Output As ff
         'Added by Lydia 2016/10/19 加報表抬頭
         'Modified by Morgan 2018/3/22
         'Print #ff, Space(40) & IIf(bolIsOurFMP = True, "FMP寰華案件代理人案件提申管制表(" & strPIdName & ")", p_Sys & "代理人案件提申管制表(" & strPIdName & ")")
         'Modified by Morgan 2022/9/23 +自繳年費
         Print #ff, Space(40) & IIf(bolIsOurFMP = True, "FMP寰華案件代理人案件提申管制表(" & strPIDName & ")", p_Sys & "代理人" & IIf(stRptID = "1", "案件", IIf(stRptID = "2", "年費", "自繳年費")) & "提申管制表(" & strPIDName & ")")
         'end 2018/3/22
         'end 2016/10/19
         Print #ff, ""
         Print #ff, "日期：" & p_RptDate
         Print #ff, ""
         'Modified by Lydia 2017/02/16 設定欄位
         'Print #ff, "承辦人 發文日    提申期限  提申類別 法定期限  本所案號        案件名稱       種類   申請國家 案件性質   代理人               收達日   "
         'Print #ff, "------ --------- --------- -------- --------- --------------- -------------- ------ -------- ---------- -------------------- ---------"
         Print #ff, strTitle
         Print #ff, strTitleLine
         'end 2017/02/16
         
         tmpnext = "開檔中..."
         
         Do While Not .EOF
            'Modified by Morgan 2018/3/22
            'If stPID <> "" & .Fields("pid") Then
            'Modified by Morgan 2023/6/20
            'If stPID <> "" & .Fields("pid") Or stRptID <> "" & .Fields("Rpt") Then
            If stPID <> "" & .Fields("pid") Or stRptID <> "" & .Fields("Rpt") Or (bolIsOurFMP And strFMPPID <> "" & .Fields("FMP")) Then
            'end 2023/6/20
               stRptID = "" & .Fields("Rpt")
            'end 2018/3/22
               'Modified by Lydia 2017/02/16 設定欄位
               'Print #ff, "------ --------- --------- -------- --------- --------------- -------------- ------ -------- ---------- -------------------- ---------"
               Print #ff, strTitleLine
               'end 2017/02/16
               Print #ff, "共" & lngRecs & "筆"
               Close ff
               p_FileName = p_FileName & stFileName & ";"
               
               'Added by Morgan 2017/10/31 CFP改直接寄給承辦人--甄妮106/10/27請作單
               'Modified by Morgan 2018/3/23
               'If p_Sys = "CFP" Then
               'Modified by Morgan 2024/12/27 +bolPNewRule
               'If p_Sys = "CFP" And stPID <> "" & .Fields("pid") Then
               If (p_Sys = "CFP" Or bolPNewRule) And stPID <> "" & .Fields("pid") Then
               'end 2024/12/30
               'end 2018/3/22
                  strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & _
                     p_Sys & "代理人案件提申管制表(" & p_RptDate & ")(" & strPIDName & ") 資料如附件！" & _
                     vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & p_PS
                  SendMAPIMail stPID, p_Sys & "代理人案件提申管制表(" & p_RptDate & ")(" & strPIDName & ")", strText, p_FileName
                  stCFPMailList = stCFPMailList & stPID & ";"
                  p_FileName = "" 'Added by Morgan 2018/3/23
               'Added by Morgan 2023/6/20
               ElseIf bolIsOurFMP Then
                  strFMPPSup = PUB_GetFCPProSup(strFMPPID)
                  strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & _
                     "FMP寰華案件代理人案件提申管制表(" & p_RptDate & ")(" & strPIDName & ") 資料如附件！" & _
                     vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & p_PS
                  SendMAPIMail strFMPPID, "FMP寰華案件代理人案件提申管制表(" & p_RptDate & ")(" & strPIDName & ")", strText, stFileName, , , strFMPPSup
               'end 2023/6/20
               End If
               'end 2017/10/31
               
               lngRecs = 0
               stPID = "" & .Fields("pid")
               'Added by Morgan 2023/6/20
               If bolIsOurFMP Then
                  strFMPPID = "" & .Fields("FMP")
                  strPIDName = "" & .Fields("FMPMAN")
               Else
               'end 2023/6/20
                  strPIDName = GetPIDName(stPID) 'Added by Morgan 2017/10/31
               End If 'Added by Morgan 2023/6/20
               
               If ff > 0 Then Close #ff
               ff = FreeFile
               'Modify By Sindy 2009/06/04
               'stFileName = "C:\" & p_Sys & "代理人案件提申管制表(" & strPIdName & ").txt"
               'Added by Morgan 2014/11/10
               If bolIsOurFMP Then
                  stFileName = App.path & TextPath & "FMP寰華案件代理人案件提申管制表(" & strPIDName & ").txt"
               Else
               'end 2014/11/10
                  'Modified by Morgan 2018/3/22
                  'stFileName = App.path & TextPath & p_Sys & "代理人案件提申管制表(" & strPIdName & ").txt"
                  'Modified by Morgan 2022/9/23 +自繳年費
                  stFileName = App.path & TextPath & p_Sys & "代理人" & IIf(stRptID = "1", "案件", IIf(stRptID = "2", "年費", "自繳年費")) & "提申管制表(" & strPIDName & ").txt"
                  'end 2018/3/22
               End If 'Added by Morgan 2014/11/10
               '2009/06/04 End
               Open stFileName For Output As ff
                'Added by Lydia 2016/10/19 加報表抬頭
                'Modified by Morgan 2018/3/22
                'Print #ff, Space(40) & IIf(bolIsOurFMP = True, "FMP寰華案件代理人案件提申管制表(" & strPIdName & ")", p_Sys & "代理人案件提申管制表(" & strPIdName & ")")
                'Modified by Morgan 2022/9/23 +自繳年費
                Print #ff, Space(40) & IIf(bolIsOurFMP = True, "FMP寰華案件代理人案件提申管制表(" & strPIDName & ")", p_Sys & "代理人" & IIf(stRptID = "1", "案件", IIf(stRptID = "2", "年費", "自繳年費")) & "提申管制表(" & strPIDName & ")")
                'end 2018/3/22
                'end 2016/10/19
               Print #ff, ""
               Print #ff, "日期：" & p_RptDate
               Print #ff, ""
               'Modified by Lydia 2017/02/16 設定欄位
               'Print #ff, "承辦人 發文日    提申期限  提申類別 法定期限  本所案號        案件名稱       種類   申請國家 案件性質   代理人               收達日   "
               'Print #ff, "------ --------- --------- -------- --------- --------------- -------------- ------ -------- ---------- -------------------- ---------"
               Print #ff, strTitle
               Print #ff, strTitleLine
               'end 2017/02/16
            End If
            lngRecs = lngRecs + 1
            strContent = convForm("" & .Fields("C01"), 6)  '承辦人
            'Added by Lydia 2017/02/16 +管制人
            If bolIsOurFMP Then
               strContent = convForm("" & .Fields("FMPMAN"), 6) & " " & strContent '管制人
            End If
            'end 2017/02/16
            strContent = strContent & " " & convForm("" & .Fields("C02"), 9) '發文日
            strContent = strContent & " " & convForm("" & .Fields("C03"), 9) '提申期限
            strContent = strContent & " " & convForm("" & .Fields("C12"), 8) '提申類別
            'Modified by Morgan 2018/3/23
            'strContent = strContent & " " & convForm("" & .Fields("C04"), 9) '收文號
            strContent = strContent & " " & convForm("" & .Fields("C13"), 9) '法定期限
            'end 2018/3/23
            strContent = strContent & " " & convForm("" & .Fields("C05"), 15) '本所案號
            strContent = strContent & " " & convForm("" & .Fields("C06"), 14) '案件名稱
            strContent = strContent & " " & convForm("" & .Fields("C07"), 6) '種類
            strContent = strContent & " " & convForm("" & .Fields("C08"), 8) '申請國家
            strContent = strContent & " " & convForm("" & .Fields("C09"), 10) '案件性質
            strContent = strContent & " " & convForm("" & .Fields("C10"), 20) '代理人
            strContent = strContent & " " & convForm("" & .Fields("C11"), 9) '收達日
            tmpnext = "寫檔..."
            Print #ff, strContent
            .MoveNext
         Loop
         'Modified by Lydia 2017/02/16 設定欄位
         'Print #ff, "------ --------- --------- -------- --------- --------------- -------------- ------ -------- ---------- -------------------- ---------"
         Print #ff, strTitleLine
         'end 2017/02/16
         Print #ff, "共" & lngRecs & "筆"
         Close ff
         p_FileName = p_FileName & stFileName
         
         'Added by Morgan 2017/10/31 CFP改直接寄給承辦人--甄妮106/10/27請作單
         'Modified by Morgan 2024/12/27 +bolPNewRule
         'If p_Sys = "CFP" Then
         If p_Sys = "CFP" Or bolPNewRule Then
         'end 2024/12/30
            strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & _
               p_Sys & "代理人案件提申管制表(" & p_RptDate & ")(" & strPIDName & ") 資料如附件！" & _
               vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & p_PS
            SendMAPIMail stPID, p_Sys & "代理人案件提申管制表(" & p_RptDate & ")(" & strPIDName & ")", strText, p_FileName
            stCFPMailList = stCFPMailList & stPID & ";"
            p_FileName = "" 'Added by Morgan 2018/3/23
            
            'Added by Morgan 2022/9/23 自繳年費提申管制表(財務處)
            'Modified by Morgan 2024/11/25 --婉莘/秀玲
            'stPID = "Account"
            stPID = Pub_GetSpecMan("外專請款單已收款通知人員")
            'end 2024/11/25
            strPIDName = "財務處"
            .Sort = "Rpt,C13,C03,C02,C04"
            .MoveFirst
            .Find "Rpt='3'"
            lngRecs = 0
            If Not .EOF Then
               stFileName = App.path & TextPath & p_Sys & "代理人自繳年費提申管制表(" & strPIDName & ").txt"
               strTitle = "承辦人 發文日    提申期限  提申類別 法定期限  本所案號        案件名稱       種類   申請國家 案件性質   代理人               收達日   "
               strTitleLine = "------ --------- --------- -------- --------- --------------- -------------- ------ -------- ---------- -------------------- ---------"
               Open stFileName For Output As ff
               Print #ff, Space(40) & p_Sys & "代理人自繳年費提申管制表(" & strPIDName & ")"
               Print #ff, ""
               Print #ff, "日期：" & p_RptDate
               Print #ff, ""
               Print #ff, strTitle
               Print #ff, strTitleLine
               tmpnext = "開檔中..."
               Do While Not .EOF
                  If .Fields("Rpt") = "3" Then
                     If InStr("Y49572000,Y55766000,Y55627000,Y55645000", Left("" & .Fields("cp44"), 8)) > 0 Then
                        lngRecs = lngRecs + 1
                        strContent = convForm("" & .Fields("C01"), 6)  '承辦人
                        strContent = strContent & " " & convForm("" & .Fields("C02"), 9) '發文日
                        strContent = strContent & " " & convForm("" & .Fields("C03"), 9) '提申期限
                        strContent = strContent & " " & convForm("" & .Fields("C12"), 8) '提申類別
                        strContent = strContent & " " & convForm("" & .Fields("C13"), 9) '法定期限
                        strContent = strContent & " " & convForm("" & .Fields("C05"), 15) '本所案號
                        strContent = strContent & " " & convForm("" & .Fields("C06"), 14) '案件名稱
                        strContent = strContent & " " & convForm("" & .Fields("C07"), 6) '種類
                        strContent = strContent & " " & convForm("" & .Fields("C08"), 8) '申請國家
                        strContent = strContent & " " & convForm("" & .Fields("C09"), 10) '案件性質
                        strContent = strContent & " " & convForm("" & .Fields("C10"), 20) '代理人
                        strContent = strContent & " " & convForm("" & .Fields("C11"), 9) '收達日
                        tmpnext = "寫檔..."
                        Print #ff, strContent
                     End If
                  Else
                     Exit Do
                  End If
                  .MoveNext
               Loop
               
               Print #ff, strTitleLine
               Print #ff, "共" & lngRecs & "筆"
               Close ff
            End If
            
            If lngRecs > 0 Then
               p_FileName = p_FileName & stFileName
               strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & _
                     p_Sys & "代理人案件提申管制表(" & p_RptDate & ")(" & strPIDName & ") 資料如附件！" & _
                     vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & p_PS
               '寄財務人員CC給郭經理
               SendMAPIMail stPID, p_Sys & "代理人案件提申管制表(" & p_RptDate & ")(" & strPIDName & ")", strText, p_FileName, , , "79075"
               stCFPMailList = stCFPMailList & stPID & ";"
               p_FileName = ""
            End If
            'end 2022/9/23
            
            
         'Added by Morgan 2023/6/20
         ElseIf bolIsOurFMP Then
            strFMPPSup = PUB_GetFCPProSup(strFMPPID)
            strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & _
               "FMP寰華案件代理人案件提申管制表(" & p_RptDate & ")(" & strPIDName & ") 資料如附件！" & _
               vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & p_PS
            SendMAPIMail strFMPPID, "FMP寰華案件代理人案件提申管制表(" & p_RptDate & ")(" & strPIDName & ")", strText, stFileName, , , strFMPPSup
         'end 2023/6/20
         End If
         'end 2017/10/31
         
         'MsgBox "資料寫入完畢！"
      Else
         'MsgBox "無符合資料！"
      End If
   End With
   
   'Added by Morgan 2017/10/31 CFP改直接寄給承辦人--甄妮106/10/27請作單
   'Modified by Morgan 2024/12/27 +bolPNewRule
   'If p_Sys = "CFP" Then
   '   stSQL = "select na73 from nation union select na74 from nation order by 1"
   '   'Added by Morgan 2020/2/21
   '   If strSrvDate(1) >= 20200401 Then
   '      stSQL = "select distinct a0916 from acc090 order by 1"
   '   End If
   '   'end 2020/2/21
   If p_Sys = "CFP" Or bolPNewRule Then
      If p_Sys = "CFP" Then
         stSQL = "select distinct a0916 from acc090 where a0916 is not null order by 1"
      Else
         stSQL = "select distinct a0917 from acc090 where a0917 is not null order by 1"
      End If
   'end 2024/12/30
      If Rs.State <> adStateClosed Then Rs.Close
      With Rs
      .CursorLocation = adUseClient
      .Open stSQL, cnnConnection, adOpenForwardOnly, adLockReadOnly
      If .RecordCount > 0 Then
         Do While Not .EOF
            If Not IsNull(.Fields(0)) Then
               stPID = .Fields(0)
               If InStr(stCFPMailList, stPID) = 0 Then
                  strPIDName = GetPIDName(stPID)
                  'Modified by Morgan 2024/12/30
                  'strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & _
                  '   "CFP代理人案件提申管制表(" & p_RptDate & ")(" & strPIdName & ") 無需管制資料！" & _
                  '   vbCrLf & vbCrLf & String(25, "　") & "電腦中心"
                  'SendMAPIMail stPID, "CFP代理人案件提申管制表(" & p_RptDate & ")(" & strPIdName & ")", strText
                  SendMAPIMail stPID, p_Sys & "代理人案件提申管制表(" & p_RptDate & ")(" & strPIDName & ") 無需管制資料！", "如旨"
                  'end 2024/12/30
               End If
            End If
            .MoveNext
         Loop
      End If
      End With
      
   'Added by Morgan 2025/2/11
   End If
   If p_Sys = "CFP" Then
   'end 2025/2/11
   
      'Added by Morgan 2022/9/27
      'Modified by Morgan 2024/11/25 --婉莘/秀玲
      'stPID = "Account"
      stPID = Pub_GetSpecMan("外專請款單已收款通知人員")
      'end 2024/11/25
      If InStr(stCFPMailList, stPID) = 0 Then
         strPIDName = "財務處"
         'Modified by Morgan 2024/12/30
         'strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & _
            "CFP代理人案件提申管制表(" & p_RptDate & ")(" & strPIdName & ") 無需管制資料！" & _
            vbCrLf & vbCrLf & String(25, "　") & "電腦中心"
         '寄財務人員CC給郭經理
         'SendMAPIMail stPID, "CFP代理人案件提申管制表(" & p_RptDate & ")(" & strPIdName & ")", strText, , , , "79075"
         SendMAPIMail stPID, p_Sys & "代理人案件提申管制表(" & p_RptDate & ")(" & strPIDName & ") 無需管制資料！", "如旨", , , , "79075"
         'end 2024/12/30
      End If
      'end 2022/9/27
   End If
   'end 2017/10/31
   
   CreateFile12 = True
   Set rsQuery = Nothing 'Added by Morgan 2020/2/21
   Exit Function
   
ErrHandle:
   WLog tmpnext & " " & Err.Description
   If ff > 0 Then Close #ff
   Set rsQuery = Nothing 'Added by Morgan 2020/2/21
End Function

Private Function GetPIDName(p_PID As String) As String
   
   Select Case p_PID
      Case "1"
         GetPIDName = "台灣"
      Case "2"
         GetPIDName = "大陸"
'Modified by Morgan 2014/8/26 CFP 改抓國家檔設定的程序
'      'Modified by Morgan 2013/7/1 程序國家更改(美洲,大洋洲,非洲(本所案號單號):慧汶,美洲,大洋洲,非洲(本所案號雙號):玫音,歐洲:甄妮,亞洲:禧佩)
'      Case "3"
'         'GetPIDName = "美日德-單"
'         GetPIDName = "美大非-單"
'      Case "4"
'         'GetPIDName = "美日德-雙"
'         GetPIDName = "美大非-雙"
'      Case "5"
'         GetPIDName = "歐洲"
'      Case Else
'         'GetPIDName = "其他國"
'         GetPIDName = "亞洲"
      Case Else
         'Modified by Lydia 2022/03/29 員工名稱有Unicode=> +PUB_UniToBIG5
         GetPIDName = PUB_UniToBIG5(GetStaffName(p_PID, True), "F")
'end 2014/8/26
   End Select
End Function

'add by Toni 20080922 延展案於期滿六個月前一個工作天發mail提醒承辦人
Sub StrMenu12()
On Error GoTo DebugErr
Dim ff As Integer
Dim i As Integer
Dim A01 As String
Dim A02 As String
Dim A03 As String
Dim A04 As String
Dim A05 As String
Dim A06 As String
Dim A07 As String
Dim A08 As String 'Add By Sindy 2014/1/27
Dim iCount As Long
Dim TempFileName As String
Dim TempFileNameSeek As String
Dim ThisFileName As Variant
Dim strTitle As String 'Add By Sindy 2014/1/27

Dim StrSQL6 As String
Dim T_Date As String
Dim tmpnext As String

'tmpnext = "準備連資料庫..."
'Set cnnConnection = New ADODB.Connection
'cnnConnection.ConnectionString = CnStr
'cnnConnection.Open
   
   'Modify By Sindy 2013/7/26
   '************************************************************************
   'T*案,不含馬德里,因TF是3個月
   '************************************************************************
   TempFileName = ""

   T_Date = CompWorkDay(2, strSrvDate(1), 0)           '後一個工作天

   'Add By Sindy 2014/1/27
   If Val(T_Date) < 20140501 Then
      strTitle = "六個月"
   Else
      strTitle = "六個月(十二個月)"
   End If
   
   CheckOC
   '2008/10/13 modify by sonia 加收文日小於可辦日者條件
   'strSQL = "SELECT nvl(CP14,'67002') as C14,CP01||'-'||CP02||'-'||CP03||'-'||CP04 as sortA,TM15,TM05,TM09,Cu04,ST02,(cp07-19110000) as cp" & _
                  " FROM CaseProgress,Customer,Staff,TradeMark " & _
                  " WHERE substr(cp01,1,1)='T' and  CP10='102'  and  cp07 > 20000000 and (cp27 is null) and (cp57 is null) and (TM29 is null) and TO_CHAR(ADD_MONTHS(TO_date(cp07,'YYYYMMDD'),-6),'YYYYMMDD') <" & T_Date & _
                  "and  cp13=st01(+)  and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+) and substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+)  order by nvl(CP14,'67002'),sortA "
   'Modify By Sindy 2014/1/27 +申請國家,大陸案自2014/05/01起改為期滿前一年即可辦理
   '                                    台灣案期滿前六個月即可辦理
   If Val(T_Date) < 20140501 Then
      'Modified by Lydia 2015/11/24 判斷收款後送件CP141='2'且CP79>0的資料。
      'Modified by Lydia 2016/09/14 and (cp27 is null) and (cp57 is null) => CP158=0 AND CP159=0
      'Modified by Lydia 2016/10/19 67002 =>69008
      'Modified by Lydia 2017/06/01 延展期滿日期改用模組控制
      'strSql = "SELECT nvl(CP14,'69008') as C14,cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) as sortA,TM15,TM05,TM09,Cu04,ST02,(cp07-19110000) as cp,na03,DECODE(CP141,'2',NVL(CP79,0),0) typ2 " & _
               " FROM CaseProgress,Customer,Staff,TradeMark,nation " & _
               " WHERE substr(cp01,1,1)='T' and cp01<>'TF' and  CP10='102'  and  cp07 > 20000000 and CP158=0 AND CP159=0 and (TM29 is null) and TO_CHAR(ADD_MONTHS(TO_date(cp07,'YYYYMMDD'),-6),'YYYYMMDD') < " & T_Date & _
               " and cp05<=TO_CHAR(ADD_MONTHS(TO_date(cp07,'YYYYMMDD'),-6),'YYYYMMDD') and cp13=st01(+) and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+) and substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+)" & _
               " and tm10=na01(+)" & _
               " order by nvl(CP14,'69008'),sortA "
               'workdayadd(-11," & PUB_Get102DeadLine("1", "CP07", 1, 0) & ")
      'Modified by Lydia 2017/06/15 可辦期限前一個工作天日通知 " & PUB_Get102DeadLine("1", "CP07") & " => workdayadd(-2," & PUB_Get102DeadLine("1", "CP07") & ")
      'Modified by Lydia 2021/11/12  69008=>84027
      'Modified by Lydia 2022/11/28 nvl(CP14,'84027')請改為nvl(CP14,decode(tm10,'000','84027','86048'))，即無CP14再依申請國家判斷，台灣案給84027，非台灣案給86048。
      strSql = "SELECTnvl(CP14,decode(tm10,'000','84027','86048')) as C14,cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) as sortA,TM15,TM05,TM09,Cu04,ST02,(cp07-19110000) as cp,na03,DECODE(CP141,'2',NVL(CP79,0),0) typ2 " & _
              " FROM CaseProgress,Customer,Staff,TradeMark,nation " & _
              " WHERE substr(cp01,1,1)='T' and cp01<>'TF' and CP10='102' and cp07 > 20000000 and CP158=0 AND CP159=0 and (TM29 is null) and workdayadd(-2," & PUB_Get102DeadLine("1", "CP07") & ") < " & T_Date & _
              " and cp05<=workdayadd(-2," & PUB_Get102DeadLine("1", "CP07") & ") and cp13=st01(+) and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+) and substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+)" & _
              " and tm10=na01(+)" & _
              " order by nvl(CP14,decode(tm10,'000','84027','86048')),sortA "
   Else
      'Modified by Lydia 2015/11/24 判斷收款後送件CP141='2'且CP79>0的資料。
      'Modified by Lydia 2016/09/14 and (cp27 is null) and (cp57 is null) => CP158=0 AND CP159=0
      'Modified by Lydia 2016/10/19 67002 =>69008
      'Modified by Lydia 2017/06/01 延展期滿日期改用模組控制
      'strSql = "SELECT nvl(CP14,'69008') as C14,cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) as sortA,TM15,TM05,TM09,Cu04,ST02,(cp07-19110000) as cp,na03,DECODE(CP141,'2',NVL(CP79,0),0) typ2 " & _
               " FROM CaseProgress,Customer,Staff,TradeMark,nation " & _
               " WHERE substr(cp01,1,1)='T' and cp01<>'TF' and  CP10='102'  and  cp07 > 20000000 and CP158=0 AND CP159=0 and (TM29 is null) and TO_CHAR(ADD_MONTHS(TO_date(cp07,'YYYYMMDD'),-6),'YYYYMMDD') < " & T_Date & _
               " and cp05<=TO_CHAR(ADD_MONTHS(TO_date(cp07,'YYYYMMDD'),-6),'YYYYMMDD') and cp13=st01(+) and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+) and substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+)" & _
               " and tm10=na01(+) and tm10<>'020'" & _
               " union SELECT nvl(CP14,'69008') as C14,cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) as sortA,TM15,TM05,TM09,Cu04,ST02,(cp07-19110000) as cp,na03,DECODE(CP141,'2',NVL(CP79,0),0) typ2 " & _
               " FROM CaseProgress,Customer,Staff,TradeMark,nation " & _
               " WHERE substr(cp01,1,1)='T' and cp01<>'TF' and  CP10='102'  and  cp07 > 20000000 and CP158=0 AND CP159=0 and (TM29 is null) and TO_CHAR(ADD_MONTHS(TO_date(cp07,'YYYYMMDD'),-12),'YYYYMMDD') < " & T_Date & _
               " and cp05<=TO_CHAR(ADD_MONTHS(TO_date(cp07,'YYYYMMDD'),-12),'YYYYMMDD') and cp13=st01(+) and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+) and substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+)" & _
               " and tm10=na01(+) and tm10='020'" & _
               " order by C14,sortA "
       'Modified by Lydia 2017/06/15 可辦期限前一個工作天日通知  " & PUB_Get102DeadLine("1", "CP07") & " => workdayadd(-2," & PUB_Get102DeadLine("1", "CP07") & ")
       'Modified by Lydia 2021/11/12  69008=>84027
      'Modified by Lydia 2022/11/28 nvl(CP14,'84027')請改為nvl(CP14,decode(tm10,'000','84027','86048'))，即無CP14再依申請國家判斷，台灣案給84027，非台灣案給86048。
      strSql = "SELECT nvl(CP14,decode(tm10,'000','84027','86048')) as C14,cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) as sortA,TM15,TM05,TM09,Cu04,ST02,(cp07-19110000) as cp,na03,DECODE(CP141,'2',NVL(CP79,0),0) typ2 " & _
               " FROM CaseProgress,Customer,Staff,TradeMark,nation " & _
               " WHERE substr(cp01,1,1)='T' and cp01<>'TF' and CP10='102' and cp07 > 20000000 and CP158=0 AND CP159=0 and (TM29 is null) and workdayadd(-2," & PUB_Get102DeadLine("1", "CP07") & ") < " & T_Date & _
               " and cp05<=workdayadd(-2," & PUB_Get102DeadLine("1", "CP07") & ") and cp13=st01(+) and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+) and substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+)" & _
               " and tm10=na01(+) and tm10<>'020'" & _
               " union SELECT nvl(CP14,decode(tm10,'000','84027','86048')) as C14,cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) as sortA,TM15,TM05,TM09,Cu04,ST02,(cp07-19110000) as cp,na03,DECODE(CP141,'2',NVL(CP79,0),0) typ2 " & _
               " FROM CaseProgress,Customer,Staff,TradeMark,nation " & _
               " WHERE substr(cp01,1,1)='T' and cp01<>'TF' and CP10='102' and cp07 > 20000000 and CP158=0 AND CP159=0 and (TM29 is null) and workdayadd(-2," & PUB_Get102DeadLine("2", "CP07") & ") < " & T_Date & _
               " and cp05<=workdayadd(-2," & PUB_Get102DeadLine("2", "CP07") & ") and cp13=st01(+) and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+) and substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+)" & _
               " and tm10=na01(+) and tm10='020'" & _
               " order by C14,sortA "
   End If
   Set Rs = New ADODB.Recordset
   Rs.CursorLocation = adUseClient
   Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   tmpnext = "已取得資料..."
   TempFileNameSeek = ""
   
   With Rs
       TempFileName = ""
       If .RecordCount > 0 And .RecordCount <> 0 Then
           .MoveFirst
           ff = FreeFile
           Do While Not .EOF
               If InStr(1, TempFileNameSeek, CheckStr(.Fields("C14"))) = 0 Then
                   TempFileName = CheckStr(.Fields("C14"))
                   TempFileNameSeek = TempFileNameSeek & "," & CheckStr(.Fields("C14"))
                   If ff > 0 Then Close #ff
                   ff = FreeFile
                   'Modify By Sindy 2009/06/04
                   'Open "c:\" & TempFileName & ".txt" For Output As ff
                   Open App.path & TextPath & TempFileName & ".txt" For Output As ff
                   '2009/06/04 End
                   'Add By Sindy 2009/07/20
                   'Modify By Sindy 2014/1/27
                   'Print #ff, "　　　　　　　　　　　　　　　　　　　　　延展案期滿前六個月可辦案件明細"
                   Print #ff, "　　　　　　　　　　　　　　　　　　　　　延展案期滿前" & strTitle & "可辦案件明細"
                   Print #ff, ""
                   'Added by Lydia 2017/06/15 加註
                   Print #ff, "　　　　　　　　　　　　　　　　　　　　　    可辦期限前一工作天通知"
                   Print #ff, ""
                   'end 2017/06/15
                   '2009/07/20 End
                   'Modified by Lydia 2015/11/24 收款後送件CP141='2'且CP79>0的資料，於清單內之'申請國家'欄之後加註'★收款後送件'。
                   'Print #ff, "本所案號   註冊號                商標名稱             類別                 客戶名稱             智權人員     法定期限 申請國家"
                   'Print #ff, "========== ===================== ==================== ==================== ==================== ============ ======== ========"
                   Print #ff, "本所案號   註冊號                商標名稱             類別                 客戶名稱             智權人員     法定期限 申請國家            "
                   Print #ff, "========== ===================== ==================== ==================== ==================== ============ ======== ===================="
               End If
               tmpnext = "開檔中..."
               A01 = "" & convForm(CheckStr(.Fields(1).Value), 10)
               A02 = "" & convForm(CheckStr(.Fields(2).Value), 20)
               A03 = "" & convForm(CheckStr(.Fields(3).Value), 20)
               A04 = "" & convForm(CheckStr(.Fields(4).Value), 20)
               A05 = "" & convForm(CheckStr(.Fields(5).Value), 20)
               A06 = "" & convForm(CheckStr(.Fields(6).Value), 12)
               A07 = "" & convForm(CheckStr(.Fields(7).Value), 8)
               'Modified by Lydia 2015/11/24
               'A08 = "" & convForm(CheckStr(.Fields(8).Value), 8) 'Add By Sindy 2014/1/27 +申請國家
               A08 = "" & convForm(convForm(CheckStr(.Fields(8).Value), 8) & IIf(Val("" & .Fields("typ2")) > 2, "★收款後送件", ""), 20)
               tmpnext = "寫檔..."
               
               'Modify By Sindy 2014/1/27 +A08
               Print #ff, A01 & " " & A02 & " " & " " & A03 & " " & A04 & " " & A05 & " " & A06 & " " & A07 & " " & A08 & " "
               .MoveNext
           Loop
       End If
   End With
   Close ff
   tmpnext = "關檔..."
   
   If TempFileNameSeek <> "" Then
      ThisFileName = Split(TempFileNameSeek, ",")
      For iCount = 0 To UBound(ThisFileName)
           If ThisFileName(iCount) <> "" Then
               TempFileName = ThisFileName(iCount)
               '發 mail
               'Modify By Sindy 2009/06/04
               'SendMAPIMail TempFileName, "延展案期滿六個月，案件明細", "Dear Sirs," & vbCrLf & "          逾承辦期限有完稿日無會稿日 資料如附件！" & vbCrLf & vbCrLf & vbCrLf & vbCrLf & "          請橫印！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", "c:\" & TempFileName & ".txt"
               'Modify By Sindy 2009/07/20
               'SendMAPIMail TempFileName, "延展案期滿六個月，案件明細", "Dear Sirs," & vbCrLf & "          逾承辦期限有完稿日無會稿日 資料如附件！" & vbCrLf & vbCrLf & vbCrLf & vbCrLf & "          請橫印！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", App.Path & TextPath & TempFileName & ".txt"
               'Modify By Sindy 2014/1/27
               'SendMAPIMail TempFileName, "延展案期滿前六個月可辦案件明細", "Dear Sirs," & vbCrLf & "          延展案期滿前六個月可辦案件明細 資料如附件！" & vbCrLf & vbCrLf & vbCrLf & vbCrLf & "          請橫印！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", App.Path & TextPath & TempFileName & ".txt"
               'Modified by Lydia 2017/06/15 加註"可辦期限前一工作天通知"
               SendMAPIMail TempFileName, "延展案期滿前" & strTitle & "可辦案件明細-可辦期限前一工作天通知", "Dear Sirs," & vbCrLf & "          延展案期滿前" & strTitle & "可辦案件明細 資料如附件！" & vbCrLf & vbCrLf & vbCrLf & vbCrLf & "          請橫印！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", App.path & TextPath & TempFileName & ".txt"
               '2009/06/04 End
           End If
      Next iCount
   'edit by nickc 2006/03/20 因為 taient4 的服務預設關閉
   '   Shell "net send /domain:taient4 '每日自動郵件資料已送出，請清除郵件備份' ", vbNormalNoFocus
   End If

   'ADD By Sindy 2013/7/26
   '************************************************************************
   '馬德里是3個月
   '************************************************************************
   TempFileName = ""
   CheckOC
   '加收文日小於可辦日者條件
   'Modified by Lydia 2016/09/14 and (cp27 is null) and (cp57 is null) => CP158=0 AND CP159=0
   'Modified by Lydia 2016/10/19 67002 =>69008
   'Modified by Lydia 2021/11/12 69008=>84027
   'Modified by Lydia 2022/11/28 nvl(CP14,'84027')請改為nvl(CP14,decode(tm10,'000','84027','86048'))，即無CP14再依申請國家判斷，台灣案給84027，非台灣案給86048
   'strSql = "SELECT nvl(CP14,'84027') as C14,cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) as sortA,TM15,TM05,TM09,Cu04,ST02,(cp07-19110000) as cp" & _
            " FROM CaseProgress,Customer,Staff,TradeMark " & _
            " WHERE cp01='TF' and CP10='102' and cp07 > 20000000 and CP158=0 AND CP159=0 and (TM29 is null) and TO_CHAR(ADD_MONTHS(TO_date(cp07,'YYYYMMDD'),-3),'YYYYMMDD') < " & T_Date & _
            " and cp05<=TO_CHAR(ADD_MONTHS(TO_date(cp07,'YYYYMMDD'),-3),'YYYYMMDD') and cp13=st01(+) and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+) and substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+)  order by nvl(CP14,'84027'),sortA "
   strSql = "SELECT nvl(CP14,decode(tm10,'000','84027','86048')) as C14,cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) as sortA,TM15,TM05,TM09,Cu04,ST02,(cp07-19110000) as cp" & _
            " FROM CaseProgress,Customer,Staff,TradeMark,nation " & _
            " WHERE cp01='TF' and CP10='102' and cp07 > 20000000 and CP158=0 AND CP159=0 and (TM29 is null) and TO_CHAR(ADD_MONTHS(TO_date(cp07,'YYYYMMDD'),-3),'YYYYMMDD') < " & T_Date & _
            " and cp05<=TO_CHAR(ADD_MONTHS(TO_date(cp07,'YYYYMMDD'),-3),'YYYYMMDD') and cp13=st01(+) and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+) and tm10=na01(+) and substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+) " & _
            " order by nvl(CP14,decode(tm10,'000','84027','86048')),sortA "
   Set Rs = New ADODB.Recordset
   Rs.CursorLocation = adUseClient
   Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   tmpnext = "已取得資料..."
   TempFileNameSeek = ""
   With Rs
       TempFileName = ""
       If .RecordCount > 0 And .RecordCount <> 0 Then
           .MoveFirst
           ff = FreeFile
           Do While Not .EOF
               If InStr(1, TempFileNameSeek, CheckStr(.Fields("C14"))) = 0 Then
                   TempFileName = CheckStr(.Fields("C14"))
                   TempFileNameSeek = TempFileNameSeek & "," & CheckStr(.Fields("C14"))
                   If ff > 0 Then Close #ff
                   ff = FreeFile
                   Open App.path & TextPath & TempFileName & ".txt" For Output As ff
                   Print #ff, "　　　　　　　　　　　　　　　　　　　　　延展案期滿前三個月可辦案件明細"
                   Print #ff, ""
                   Print #ff, "本所案號   註冊號                商標名稱             類別                 客戶名稱             智權人員     法定期限    "
                   Print #ff, "========== ===================== ==================== ==================== ==================== ============ ========"
               End If
               tmpnext = "開檔中..."
               A01 = "" & convForm(CheckStr(.Fields(1).Value), 8)
               A02 = "" & convForm(CheckStr(.Fields(2).Value), 20)
               A03 = "" & convForm(CheckStr(.Fields(3).Value), 20)
               A04 = "" & convForm(CheckStr(.Fields(4).Value), 20)
               A05 = "" & convForm(CheckStr(.Fields(5).Value), 20)
               A06 = "" & convForm(CheckStr(.Fields(6).Value), 12)
               A07 = "" & convForm(CheckStr(.Fields(7).Value), 8)
               tmpnext = "寫檔..."
               
               Print #ff, A01 & " " & A02 & " " & " " & A03 & " " & A04 & " " & A05 & " " & A06 & " " & A07 & " "
               .MoveNext
           Loop
       End If
   End With
   Close ff
   tmpnext = "關檔..."
   
   If TempFileNameSeek <> "" Then
      ThisFileName = Split(TempFileNameSeek, ",")
      For iCount = 0 To UBound(ThisFileName)
           If ThisFileName(iCount) <> "" Then
               TempFileName = ThisFileName(iCount)
               '發 mail
               SendMAPIMail TempFileName, "延展案期滿前三個月可辦案件明細", "Dear Sirs," & vbCrLf & "          延展案期滿前三個月可辦案件明細 資料如附件！" & vbCrLf & vbCrLf & vbCrLf & vbCrLf & "          請橫印！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", App.path & TextPath & TempFileName & ".txt"
           End If
      Next iCount
   End If
   '2013/7/26 END
   
   Set Rs = Nothing
   'Set cnnConnection = Nothing
   Exit Sub
   
DebugErr:
   'MsgBox tmpnext & " " & Err.Description
   WLog tmpnext & " " & Err.Description
End Sub
'20080922 end

'Add By Sindy 98/04/02
Private Sub StrMenu13()
'Mark by Amy 2018/07/24 不使用-Sindy
'Dim intDir As Integer
'Dim aa As Integer
'Dim bb As Integer
'Dim cc As Integer
'Dim dd As Integer
'
'Dim tm01 As String
'Dim tm02 As String
'Dim tm03 As String
'Dim tm04 As String
'
'Dim iCount As Long
'Dim TempFileNameA As String
'Dim TempFileNameB As String
'Dim TempFileNameC As String
'Dim TempFileNameD As String
'
'Dim OpenFileA As Boolean
'Dim OpenFileB As Boolean
'Dim OpenFileC As Boolean
'Dim OpenFileD As Boolean
'
'Dim tempPicFName As String
'Dim tempPicNo() As String
'
'Dim tmpNext As String
'Dim SendFileName As String
'Dim LongCnt As Long
'
'On Error GoTo DebugErr
'
'   LongCnt = 0
''   tmpnext = "準備連資料庫..."
''   Set cnnConnection = New ADODB.Connection
''   cnnConnection.ConnectionString = CnStr
''   cnnConnection.Open
'   TempFileNameA = "找不到商標圖案件資料.txt"
'   TempFileNameB = "商標圖重覆.txt"
'   TempFileNameC = "此審定號為多個.txt"
'   TempFileNameD = "不正確的圖片.txt"
'   OpenFileA = False
'   OpenFileB = False
'   OpenFileC = False
'   OpenFileD = False
'
'   CheckOC
'   For intDir = 1 To 2
'      If intDir = 1 Then File1.path = "\\Typing2\商標圖匯入區\單色圖"
'      If intDir = 2 Then File1.path = "\\Typing2\商標圖匯入區\彩色圖"
'      'If File1.ListCount <= 0 Then Exit For
'      LongCnt = LongCnt + 1
'
'      For iCount = 0 To File1.ListCount - 1
'         tempPicFName = Trim(File1.List(iCount))
'         tempPicNo = Split(tempPicFName, ".")
'
'         'If Left(tempPicNo(0), 1) = "0" Then
'         'If Len(tempPicNo(0)) = 8 Then
'         '先抓審定號, 若無, 再抓申請案號
'         strSql = "SELECT * " & _
'                     " FROM TradeMark " & _
'                     " WHERE TM15='" & tempPicNo(0) & "' " & _
'                          " AND TM16='1' " & _
'                          " AND TM10='000' "
'         Set rs = New ADODB.Recordset
'         rs.CursorLocation = adUseClient
'         rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
'         If rs.RecordCount <= 0 Then
'            '申請案號
'            strSql = "SELECT * " & _
'                        " FROM TradeMark " & _
'                        " WHERE TM12='" & tempPicNo(0) & "' " & _
'                             " AND TM10='000' "
'            Set rs = New ADODB.Recordset
'            rs.CursorLocation = adUseClient
'            rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
'         End If
'
'         With rs
'             If .RecordCount > 0 And .RecordCount <> 0 Then
'                  '此審定號為多個
'                  If .RecordCount > 1 Then
'                     If OpenFileC = False Then
'                           cc = FreeFile
'                           If cc > 0 Then Close #cc
'                           cc = FreeFile
'                           Open App.path & TextPath & TempFileNameC For Output As cc
'                           'Added by Lydia 2016/10/19 加報表抬頭
'                           Print #cc, TempFileNameC
'                           Print #cc, ""
'                           'end 2016/10/19
'                           Print #cc, "檔案名稱"
'                           Print #cc, "============================="
'                           tmpNext = "C開檔中..."
'                           OpenFileC = True
'                     End If
'                     tmpNext = "C寫檔..."
'                     Print #cc, tempPicFName & " "
'
'                  Else
'                        tm01 = CheckStr(.Fields("TM01").Value)
'                        tm02 = CheckStr(.Fields("TM02").Value)
'                        tm03 = CheckStr(.Fields("TM03").Value)
'                        tm04 = CheckStr(.Fields("TM04").Value)
'
'                        '檢查是否有重覆
'                        strSql = "SELECT * " & _
'                                       " FROM ImgByteFile " & _
'                                       " WHERE IBF01='" & tm01 & "' " & _
'                                            " AND IBF02='" & tm02 & "' " & _
'                                            " AND IBF03='" & tm03 & "' " & _
'                                            " AND IBF04='" & tm04 & "' "
'                        Set Rs2 = New ADODB.Recordset
'                        Rs2.CursorLocation = adUseClient
'                        'Rs2.Open strSQL, cnnConnection, adOpenStatic, adLockReadOnly
'                        Rs2.Open strSql, cnnConnection, adOpenStatic, adLockOptimistic
'
'                        With Rs2
'                            If Rs2.RecordCount > 0 And Rs2.RecordCount <> 0 Then
'                                 '商標圖重覆
'                                 If OpenFileB = False Then
'                                       bb = FreeFile
'                                       If bb > 0 Then Close #bb
'                                       bb = FreeFile
'                                       Open App.path & TextPath & TempFileNameB For Output As bb
'                                       'Added by Lydia 2016/10/19 加報表抬頭
'                                       Print #bb, Space(5) & TempFileNameB
'                                       Print #bb, ""
'                                       'end 2016/10/19
'                                       Print #bb, "本所案號         檔案名稱                "
'                                       Print #bb, "==============   =============="
'                                       tmpNext = "B開檔中..."
'                                       OpenFileB = True
'                                 End If
'                                 tmpNext = "B寫檔..."
'                                 Print #bb, tm01 & "-" & tm02 & "-" & tm03 & "-" & tm04 & "    " & tempPicFName & " "
'                            Else
'                                 '存檔
'                                 If SavePic(tm01, tm02, tm03, tm04, tempPicFName, intDir, tmpNext) = False Then
'                                    '不正確的圖片
'                                    If OpenFileD = False Then
'                                          dd = FreeFile
'                                          If dd > 0 Then Close #dd
'                                          dd = FreeFile
'                                          Open App.path & TextPath & TempFileNameD For Output As dd
'                                          'Added by Lydia 2016/10/19 加報表抬頭
'                                          Print #dd, Space(5) & TempFileNameD
'                                          Print #dd, ""
'                                          'end 2016/10/19
'                                          Print #dd, "本所案號         檔案名稱                "
'                                          Print #dd, "==============   =============="
'                                          OpenFileD = True
'                                    End If
'                                    Print #dd, tm01 & "-" & tm02 & "-" & tm03 & "-" & tm04 & "    " & tmpNext & " "
'                                 End If
'                            End If
'                        End With
'                  End If
'             Else
'                  '找不到商標圖案件資料
'                  If OpenFileA = False Then
'                        aa = FreeFile
'                        If aa > 0 Then Close #aa
'                        aa = FreeFile
'                        Open App.path & TextPath & TempFileNameA For Output As aa
'                        'Added by Lydia 2016/10/19 加報表抬頭
'                        Print #aa, TempFileNameA
'                        Print #aa, ""
'                        'end 2016/10/19
'                        Print #aa, "檔案名稱"
'                        Print #aa, "============================="
'                        tmpNext = "A開檔中..."
'                        OpenFileA = True
'                  End If
'                  tmpNext = "A寫檔..."
'                  Print #aa, tempPicFName & " "
'             End If
'         End With
'      Next iCount
'   Next intDir
'
'   If LongCnt > 0 Then
'      SendFileName = ""
'      If OpenFileA = True Then
'         Close aa
'         tmpNext = "A關檔..."
'         SendFileName = App.path & TextPath & TempFileNameA
'      End If
'      If OpenFileB = True Then
'         Close bb
'         tmpNext = "B關檔..."
'         If SendFileName = "" Then
'            SendFileName = App.path & TextPath & TempFileNameB
'         Else
'            SendFileName = SendFileName & ";" & App.path & TextPath & TempFileNameB
'         End If
'      End If
'      If OpenFileC = True Then
'         Close cc
'         tmpNext = "C關檔..."
'         If SendFileName = "" Then
'            SendFileName = App.path & TextPath & TempFileNameC
'         Else
'            SendFileName = SendFileName & ";" & App.path & TextPath & TempFileNameC
'         End If
'      End If
'      If OpenFileD = True Then
'         Close dd
'         tmpNext = "D關檔..."
'         If SendFileName = "" Then
'            SendFileName = App.path & TextPath & TempFileNameD
'         Else
'            SendFileName = SendFileName & ";" & App.path & TextPath & TempFileNameD
'         End If
'      End If
'
'      '發 mail
'      If OpenFileA = True Or OpenFileB = True Or OpenFileC = True Or OpenFileD = True Then
'         'Modified by Lydia 2016/10/19 改發為林經理，並同時副本通知葉特助。
'         'SendMAPIMail "67002", "商標圖檔匯入有誤，請盡速處理！", "Dear Sirs," & vbCrLf & "          商標圖檔匯入有誤  資料如附件，請盡速處理！" & vbCrLf & vbCrLf & vbCrLf & vbCrLf & "          請直印！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", SendFileName
'         SendMAPIMail "69008", "商標圖檔匯入有誤，請盡速處理！", "Dear Sirs," & vbCrLf & "          商標圖檔匯入有誤  資料如附件，請盡速處理！" & vbCrLf & vbCrLf & vbCrLf & vbCrLf & "          請直印！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", SendFileName, , , "67002"
''      Else
''         SendMAPIMail "67002", "商標圖檔匯入無誤！", "Dear Sirs," & vbCrLf & "          商標圖檔匯入無誤！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", ""
'      End If
'   End If
'
'   Set rs = Nothing
'   Set Rs2 = Nothing
''   Set cnnConnection = Nothing
'   Exit Sub
'
'DebugErr:
'      WLog tmpNext & " " & Err.Description
'      'Modify By Sindy 2011/2/18
'      If Err.Description <> "找不到路徑" Then
'      '2011/2/18 End
'         Resume Next
'      End If
End Sub

'Add By Sindy 98/04/02
Private Function SavePic(tm01 As String, tm02 As String, tm03 As String, tm04 As String, FileName As String, ibf06 As Integer, tmpnext As String) As Boolean
Dim PathFileName As String
Dim file_num As Integer
Dim strFtpPath As String
   
On Error GoTo DebugErr
   
   SavePic = False
   PathFileName = File1.path & "\" & FileName
   G_SeekPicColor.Picture = LoadPicture(PathFileName)
   
   DoEvents
   
   'Modify By Sindy 2009/06/04
   'If Dir("C:\NowPic.jpg") <> "" Then Kill "C:\NowPic.jpg"
   'If Dir("C:\NowPic.bmp") <> "" Then Kill "C:\NowPic.bmp"
   'SavePicture G_SeekPicColor.Picture, "C:\NowPic.bmp"
   'Call Sleep(2000) 'Add By Sindy 98/04/07 暫停2秒
   'If PicToObj("C:\NowPic.bmp", tmpnext) = False Then
   '   tmpnext = tmpnext & " " & PathFileName
   '   Exit Function
   'End If
   If Dir(App.path & TextPath & "NowPic.jpg") <> "" Then Kill App.path & TextPath & "NowPic.jpg"
   If Dir(App.path & TextPath & "NowPic.bmp") <> "" Then Kill App.path & TextPath & "NowPic.bmp"
   SavePicture G_SeekPicColor.Picture, App.path & TextPath & "NowPic.bmp"
   Call Sleep(2000) 'Add By Sindy 98/04/07 暫停2秒
   If PicToObj(App.path & TextPath & "NowPic.bmp", tmpnext) = False Then
      tmpnext = tmpnext & " " & PathFileName
      Exit Function
   End If
   '2009/06/04 End
   
   
   file_num = FreeFile
   
   'Modify By Sindy 2009/06/04
   'Open "C:\NowPic.jpg" For Binary Access Read As #file_num
   Open App.path & TextPath & "NowPic.jpg" For Binary Access Read As #file_num
   '2009/06/04 End
   
   ReDim bytes(LOF(file_num))
   '超過 300K 秀錯誤
'   If LOF(file_num) > 307200 Then
''     If Pub_StrUserSt03 = "M51" Then
''         If MsgBox("檔案太大！" & vbCrLf & "請去除不必要的陰影及複雜線條，或縮小檔案！" & vbCrLf & "是否還是要存入??", vbCritical + vbYesNo, "發生錯誤！") = vbNo Then
''             Screen.MousePointer = vbDefault
''             Close #file_num
''             Exit Sub
''         End If
''     Else
'         MsgBox "檔案太大！" & vbCrLf & "請去除不必要的陰影及複雜線條，或縮小檔案！", vbCritical, "發生錯誤！"
'         Screen.MousePointer = vbDefault
'         Close #file_num
'         Exit Function
''     End If
'   End If
   
   Get #file_num, , bytes()
   Rs2.AddNew
   Rs2.Fields("ibf07").Value = ""
   Rs2.Fields("ibf08").Value = Val(Format(Date, "yyyymmdd"))
   Rs2.Fields("ibf09").Value = Val(Format(Time, "HHMM"))
   Rs2.Fields("ibf01").Value = Trim(tm01)
   Rs2.Fields("ibf02").Value = Trim(tm02)
   Rs2.Fields("ibf03").Value = Trim(tm03)
   Rs2.Fields("ibf04").Value = Trim(tm04)
   Rs2.Fields("ibf05").Value = "1"
   Rs2.Fields("ibf06").Value = CStr(ibf06) '"1"
   Rs2.Fields("ibf13").Value = Trim(LOF(file_num))
'   Rs2.Fields("ibf14").Value = Null
'   Rs2.Fields("ibf14").AppendChunk bytes()
   Close #file_num
   
   'Modify By Sindy 2017/8/10
   '檔案改放FTP
   PUB_PutFtpFile App.path & TextPath & "NowPic.jpg", tm01 & "-" & tm02 & "-" & tm03 & "-" & tm04 & "-1", tm01 & "-" & tm02 & "-" & tm03 & "-" & tm04 & "-1", strFtpPath, UCase("imgbytefile")
   If strFtpPath <> "" Then
      Rs2.Fields("ibf15") = strFtpPath
   End If
   '2017/8/10 END
   
   Rs2.UPDATE
   
   '刪除檔案
   If strFtpPath <> "" Then 'Add By Sindy 2017/8/10 + if
      If Dir(PathFileName) <> "" Then
        Kill PathFileName
      End If
   End If
   
   Rs2.Requery
   
   'MsgBox "存檔完成！", vbInformation, "恭喜！"
   SavePic = True
   Exit Function
   
DebugErr:
   tmpnext = PathFileName & " " & Err.Description
   SavePic = False
   Exit Function
End Function

'Add By Sindy 98/04/02
Sub InitAll()
    Set tmpPic.Picture = LoadPicture()
    Set tmpImg.Picture = LoadPicture()
    Set G_SeekPicColor.Picture = LoadPicture()
    Set pic1.Picture = LoadPicture()
End Sub

'Add By Sindy 98/04/02
Function PicToObj(oFileNameAndPath As String, tmpnext As String) As Boolean
    Dim objImg As StdPicture
    Dim nSrcWidth, nSrcHeight, nWidth, nHeight
    Dim tBI      As BITMAP
    
    InitAll
    On Error GoTo BE
    
    If UCase(pvGetExt(oFileNameAndPath)) = "WMF" Or UCase(pvGetExt(oFileNameAndPath)) = "EMF" Then
        'Modify By Sindy 2009/06/04
        'Set G_SeekPicColor.Picture = LoadPicture("C:\NowPic.wmf")
        Set G_SeekPicColor.Picture = LoadPicture(App.path & TextPath & "NowPic.wmf")
        '2009/06/04 End
        'tmpImg.BackColor = &H80000009
    Else
        'tmpPic.BackColor = &H8000000A
        Set objImg = pvGetStdPicture(oFileNameAndPath)
        Set m_Image = New cImage
        Set m_Jpeg = New cJpeg
        Set G_SeekPicColor.Picture = objImg
        If G_SeekPicColor.Picture <> 0 Then
            Call GetObject(objImg.handle, Len(tBI), tBI)
            If tBI.bmWidth = 0 Or tBI.bmHeight = 0 Then
                tmpnext = tmpnext & "發生錯誤！圖檔格式錯誤"
                'MsgBox "發生錯誤！", vbExclamation, "圖檔格式錯誤"
                'edit by nickc 2007/11/19
                If oRtPic = False Then
                    'StrMenu
                End If
                PicToObj = False
                Exit Function
            End If
            If tBI.bmWidth > 2000 Or tBI.bmHeight > 2000 Then
                nSrcWidth = tBI.bmWidth
                nSrcHeight = tBI.bmHeight
                If nSrcWidth > nSrcHeight Then
                    nWidth = 1200
                    nHeight = nSrcHeight / (nSrcWidth / nWidth)
                ElseIf nSrcWidth < nSrcHeight Then
                    nHeight = 1200
                    nWidth = nSrcWidth / (nSrcHeight / nHeight)
                Else
                    nHeight = 1200
                    nWidth = 1200
                End If
                pic1.Width = nWidth
                pic1.Height = nHeight
                pic1.BackColor = &H8000000A
                '重新定義大小
                pic1.Scale (0, 0)-(nWidth, nHeight)
                '縮小
                pic1.PaintPicture objImg, 0, 0, nWidth, nHeight, , , , , vbSrcCopy
                '存檔
                'Modify By Sindy 2009/06/04
                'SavePicture pic1.Image, "C:\NowPic.bmp"
                'Call Sleep(2000) 'Add By Sindy 98/04/07 暫停2秒
                'Set objImg = pvGetStdPicture("C:\NowPic.bmp")
                'Call Sleep(2000) 'Add By Sindy 98/04/07 暫停2秒
                SavePicture pic1.Image, App.path & TextPath & "NowPic.bmp"
                Call Sleep(2000) 'Add By Sindy 98/04/07 暫停2秒
                Set objImg = pvGetStdPicture(App.path & TextPath & "NowPic.bmp")
                Call Sleep(2000) 'Add By Sindy 98/04/07 暫停2秒
                '2009/06/04 End
            End If
            m_Image.CopyStdPicture objImg
            m_Jpeg.SetSamplingFrequencies 1, 1, 0, 0, 0, 0
            m_Jpeg.Quality = 75
            m_Jpeg.SampleHDC m_Image.hDC, m_Image.Width, m_Image.Height
            'Modify By Sindy 2009/06/04
            'RidFile "C:\NowPic.jpg"
            'm_Jpeg.SaveFile "C:\NowPic.jpg"
            'Call Sleep(2000) 'Add By Sindy 98/04/07 暫停2秒
            'm_Image.CopyStdPicture pvGetStdPicture("C:\NowPic.jpg")
            'Call Sleep(2000) 'Add By Sindy 98/04/07 暫停2秒
            'Set G_SeekPicColor.Picture = LoadPicture("C:\NowPic.jpg")
            'Call Sleep(2000) 'Add By Sindy 98/04/07 暫停2秒
            RidFile App.path & TextPath & "NowPic.jpg"
            m_Jpeg.SaveFile App.path & TextPath & "NowPic.jpg"
            Call Sleep(2000) 'Add By Sindy 98/04/07 暫停2秒
            m_Image.CopyStdPicture pvGetStdPicture(App.path & TextPath & "NowPic.jpg")
            Call Sleep(2000) 'Add By Sindy 98/04/07 暫停2秒
            Set G_SeekPicColor.Picture = LoadPicture(App.path & TextPath & "NowPic.jpg")
            Call Sleep(2000) 'Add By Sindy 98/04/07 暫停2秒
            '2009/06/04 End
        End If
    End If
    Dim t_hd As Double
    Dim t_wd As Double
    t_hd = G_SeekPicColor.ScaleHeight / tmpPic.ScaleHeight
    t_wd = G_SeekPicColor.ScaleWidth / tmpPic.ScaleWidth
    If t_hd > t_wd Then
        t_wd = G_SeekPicColor.ScaleWidth / t_hd
        t_hd = G_SeekPicColor.ScaleHeight / t_hd
    Else
        t_hd = G_SeekPicColor.ScaleHeight / t_wd
        t_wd = G_SeekPicColor.ScaleWidth / t_wd
    End If
    tmpImg.Width = t_wd
    tmpImg.Height = t_hd
    tmpImg.Move (tmpPic.ScaleWidth - tmpImg.Width) / 2, (tmpPic.ScaleHeight - tmpImg.Height) / 2, t_wd, t_hd
    
    Set tmpImg.Picture = G_SeekPicColor.Picture
    Set objImg = Nothing
    
    PicToObj = True
    Exit Function
BE:
    Resume Next
End Function

'Add by Morgan 2009/6/18
Private Sub StrMenu14()
   
On Error GoTo ErrHand
   
'   If cnnConnection.State = adStateClosed Then
'      cnnConnection.ConnectionString = CnStr
'      cnnConnection.Open
'   End If
   
   cnnConnection.Execute "UPDATESALARYDATA"
   
ErrHand:
   If Err.Number <> 0 Then
      WLog Err.Description
   End If
'   If cnnConnection.State = adStateOpen Then cnnConnection.Close
End Sub

'Add By Sindy 2009/08/18 FCT延展案於期滿六個月前一個工作天發mail提醒承辦人
Sub StrMenu18()
On Error GoTo DebugErr
Dim ff As Integer
Dim i As Integer
Dim A01 As String
Dim A02 As String
Dim A03 As String
Dim A04 As String
Dim A05 As String
Dim A06 As String
Dim A07 As String
Dim iCount As Long
Dim TempFileName As String
Dim TempFileNameSeek As String
Dim ThisFileName As Variant

Dim StrSQL6 As String
Dim T_Date As String
Dim tmpnext As String
Dim RsQ As New ADODB.Recordset, rsA As New ADODB.Recordset, intQ As Integer, strTmp(3) As String 'Add by Amy 2021/07/30

'tmpnext = "準備連資料庫..."
'Set cnnConnection = New ADODB.Connection
'cnnConnection.ConnectionString = CnStr
'cnnConnection.Open
TempFileName = ""

   T_Date = CompWorkDay(2, Format(Now, "YYYYMMDD"), 0)           '後一個工作天
   
   CheckOC
   'Modified by Lydia 2016/09/14 (cp27 is null) and (cp57 is null) => CP158=0 AND CP159=0
   'Modified by Lydia 2017/06/01 延展期滿日期改用模組控制
   'strSql = "SELECT nvl(CP14,'68005') as C14,cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) as sortA,TM15,TM05,TM09,Cu04,ST02,(cp07-19110000) as cp" & _
                  " FROM CaseProgress,Customer,Staff,TradeMark " & _
                  " WHERE cp01='FCT' and  CP10='102'  and  cp07 > 20000000 and CP158=0 AND CP159=0 and (TM29 is null) and TO_CHAR(ADD_MONTHS(TO_date(cp07,'YYYYMMDD'),-6),'YYYYMMDD') < " & T_Date & _
                  " and cp05<=TO_CHAR(ADD_MONTHS(TO_date(cp07,'YYYYMMDD'),-6),'YYYYMMDD') and cp13=st01(+) and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+) and substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+)  order by nvl(CP14,'68005'),sortA "
   'Modified by Lydia 2017/06/15 可辦期限前一個工作天日通知 " & PUB_Get102DeadLine("1", "CP07") & " => workdayadd(-2," & PUB_Get102DeadLine("1", "CP07") & ")
'*** Modify by Amy 2021/07/30 寫入暫存檔 ***
'   strSql = "SELECT nvl(CP14,'68005') as C14,cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) as sortA,TM15,TM05,TM09,Cu04,ST02,(cp07-19110000) as cp" & _
'                  " FROM CaseProgress,Customer,Staff,TradeMark " & _
'                  " WHERE cp01='FCT' and CP10='102' and cp07 > 20000000 and CP158=0 AND CP159=0 and (TM29 is null) and workdayadd(-2," & PUB_Get102DeadLine("1", "CP07") & ") < " & T_Date & _
'                  " and cp05<=workdayadd(-2," & PUB_Get102DeadLine("1", "CP07") & ") and cp13=st01(+) and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+) and substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+)  order by nvl(CP14,'68005'),sortA "
   '刪除暫存檔(與 AutoBatch-StrMenu3共用)
    strSql = "Delete RAB3 Where State='2' "
    cnnConnection.Execute strSql
   '寫入暫存檔
   strSql = "Insert Into RAB3 (State,R010,R009,R008,R001,R002,R003,R004) " & _
               "Select '2',Nvl(CP14,'68005') as C14,cp13,cp07,cp01,cp02,cp03,cp04 From CaseProgress,TradeMark " & _
               "Where cp01='FCT' And CP10='102' And cp07 > 20000000 And CP158=0 And CP159=0 And (TM29 is null) And WorkDayAdd(-2," & PUB_Get102DeadLine("1", "CP07") & ") < " & T_Date & _
               " And cp05<=WorkDayAdd(-2," & PUB_Get102DeadLine("1", "CP07") & ") And cp01=tm01(+) And cp02=tm02(+) And cp03=tm03(+) And cp04=tm04(+) "
   cnnConnection.Execute strSql
   'R010=68005(陳鳳英經理)則以本所案號呼叫PUB_GetFCTSalesNo抓出負責的人，再抓該員的NVL(NVL(ST54,ST53),ST52)，再將清單MAIL給抓出的主管
   strSql = "Select Distinct R001 as cp01,R002 as cp02,R003 as cp03,R004 as cp04 From RAB3 Where State='2' And R010='68005' "
   intI = 1
   Set RsQ = ClsLawReadRstMsg(intI, strSql)
   If intI = 1 Then
        RsQ.MoveFirst
        Do While RsQ.EOF = False
            strTmp(0) = PUB_GetFCTSalesNo(RsQ.Fields("cp01"), RsQ.Fields("cp02"), RsQ.Fields("cp03"), RsQ.Fields("cp04"))
            If strTmp(0) <> MsgText(601) Then
                strTmp(1) = "Select Nvl(Nvl(ST54,ST53),ST52) as MailTo From Staff Where st01='" & strTmp(0) & "' "
                intQ = 1
                Set rsA = ClsLawReadRstMsg(intQ, strTmp(1))
                If intQ = 1 Then
                    strTmp(2) = "" & rsA.Fields("MailTo")
                     If strTmp(2) <> MsgText(601) Then
                        'Modified by Lydia 2022/05/27 MailTo=>R010
                        strTmp(3) = "Update RAB3 Set R010='" & strTmp(2) & "' Where State='2' " & _
                                            "And R001='" & RsQ.Fields("cp01") & "' And R002='" & RsQ.Fields("cp02") & "' " & _
                                            "And R003='" & RsQ.Fields("cp03") & "' And R004='" & RsQ.Fields("cp04") & "' "
                        cnnConnection.Execute strTmp(3)
                     End If
                End If
            End If
            RsQ.MoveNext
        Loop
   End If
   '抓取資料
   strSql = "Select R010 as C14,R001||'-'||R002||Decode(R003||R004,'000','','-'||R003||'-'||R004) as sortA,TM15,TM05,TM09,Cu04,ST02,(R008-19110000) as cp " & _
                "From RAB3,Customer,Staff,TradeMark " & _
                "Where State='2' And R009=st01(+) And R001=tm01(+) And R002=tm02(+) And R003=tm03(+) And R004=tm04(+) " & _
                "And SubStr(tm23,1,8)=cu01(+) And SubStr(tm23,9,1)=cu02(+)  Order by R010,sortA "
'*** End Modify by Amy 2021/07/30 寫入暫存檔 ***
   
Set Rs = New ADODB.Recordset
Rs.CursorLocation = adUseClient
Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
tmpnext = "已取得資料..."
TempFileNameSeek = ""

With Rs
    TempFileName = ""
    If .RecordCount > 0 Then
        .MoveFirst
        ff = FreeFile
        Do While Not .EOF
            If InStr(1, TempFileNameSeek, CheckStr(.Fields("C14"))) = 0 Then
                TempFileName = CheckStr(.Fields("C14"))
                TempFileNameSeek = TempFileNameSeek & "," & CheckStr(.Fields("C14"))
                If ff > 0 Then Close #ff
                ff = FreeFile
                'Modify By Sindy 2009/06/04
                'Open "c:\" & TempFileName & ".txt" For Output As ff
                Open App.path & TextPath & TempFileName & ".txt" For Output As ff
                '2009/06/04 End
                'Add By Sindy 2009/07/20
                Print #ff, "　　　　　　　　　　　　　　　　　　　　　延展案期滿前六個月可辦案件明細(已收文)"
                Print #ff, ""
                'Modified by Lydia 2017/06/15 加註
                Print #ff, "　　　　　　　　　　　　　　　　　　　　　        可辦期限前一工作天通知"
                Print #ff, ""
                'end 2017/06/15
                '2009/07/20 End
                Print #ff, "本所案號        註冊號                商標名稱             類別                 客戶名稱             智權人員     法定期限    "
                Print #ff, "=============== ===================== ==================== ==================== ==================== ============ ========"
            End If
            tmpnext = "開檔中..."
            A01 = "" & convForm(CheckStr(.Fields(1).Value), 15)
            A02 = "" & convForm(CheckStr(.Fields(2).Value), 20)
            A03 = "" & convForm(CheckStr(.Fields(3).Value), 20)
            A04 = "" & convForm(CheckStr(.Fields(4).Value), 20)
            A05 = "" & convForm(CheckStr(.Fields(5).Value), 20)
            A06 = "" & convForm(CheckStr(.Fields(6).Value), 12)
            A07 = "" & convForm(CheckStr(.Fields(7).Value), 8)
            tmpnext = "寫檔..."
            
            Print #ff, A01 & " " & A02 & " " & " " & A03 & " " & A04 & " " & A05 & " " & A06 & " " & A07 & " "
            .MoveNext
        Loop
    End If
End With
Close ff
tmpnext = "關檔..."

If TempFileNameSeek <> "" Then
   ThisFileName = Split(TempFileNameSeek, ",")
   For iCount = 0 To UBound(ThisFileName)
        If ThisFileName(iCount) <> "" Then
            TempFileName = ThisFileName(iCount)
            '發 mail
            'Modify By Sindy 2009/06/04
            'SendMAPIMail TempFileName, "延展案期滿六個月，案件明細", "Dear Sirs," & vbCrLf & "          逾承辦期限有完稿日無會稿日 資料如附件！" & vbCrLf & vbCrLf & vbCrLf & vbCrLf & "          請橫印！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", "c:\" & TempFileName & ".txt"
            'Modify By Sindy 2009/07/20
            'SendMAPIMail TempFileName, "延展案期滿六個月，案件明細", "Dear Sirs," & vbCrLf & "          逾承辦期限有完稿日無會稿日 資料如附件！" & vbCrLf & vbCrLf & vbCrLf & vbCrLf & "          請橫印！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", App.Path & TextPath & TempFileName & ".txt"
            'Modified by Lydia 2017/06/15 加註"可辦期限前一工作天通知"
            SendMAPIMail TempFileName, "延展案期滿前六個月可辦案件明細(已收文)-可辦期限前一工作天通知", "Dear Sirs," & vbCrLf & "          延展案期滿前六個月可辦案件明細(已收文) 資料如附件！" & vbCrLf & vbCrLf & vbCrLf & vbCrLf & "          請橫印！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", App.path & TextPath & TempFileName & ".txt"
            '2009/06/04 End
        End If
   Next iCount
'edit by nickc 2006/03/20 因為 taient4 的服務預設關閉
'   Shell "net send /domain:taient4 '每日自動郵件資料已送出，請清除郵件備份' ", vbNormalNoFocus
End If
Set Rs = Nothing
'Set cnnConnection = Nothing
Exit Sub
DebugErr:
        'MsgBox tmpnext & " " & Err.Description
        WLog tmpnext & " " & Err.Description
End Sub


'Add by Sindy 2010/4/28
'批次更新暫不列印收據註記(Y=>NULL)
Private Sub StrMenu17()
   
On Error GoTo ErrHand
   
'   If cnnConnection.State = adStateClosed Then
'      cnnConnection.ConnectionString = CnStr
'      cnnConnection.Open
'   End If
   
   cnnConnection.Execute "Update acc0k0 Set a0k32 = Null where a0k32='Y' and a0k19 >0"
   
ErrHand:
   If Err.Number <> 0 Then
      WLog Err.Description
   End If
'   If cnnConnection.State = adStateOpen Then cnnConnection.Close
   
End Sub

'Add by Morgan 2009/11/19
'台灣案主張國內優先權發文日起滿15個月，被主張的先申請案自動上閉卷
'Modified by Morgan 2023/4/24 規則有錯應調整如下
'主張之國內優先權先申請案自其申請日起滿15個月視為撤回並不予公開 , 並得於先申請案視為撤回後退還實體審查申請費--玲玲(公文上的敘述)
Private Sub StrMenu16()
   Dim bolUpdStar As Boolean 'Added by Morgan 2023/4/24
   
On Error GoTo ErrHand
   
'   If cnnConnection.State = adStateClosed Then
'      cnnConnection.ConnectionString = CnStr
'      cnnConnection.Open
'   End If
   'Modified by Lydia 2016/09/14 cp57 is null=>CP159=0
   'Modified by Morgan 2023/4/24 修正規則並增加代辦退費收文及EMail，改逐筆上閉卷
   'strSql = "update patent set pa57='Y',pa58=to_char(sysdate,'yyyymmdd'),pa59='88'" & _
      " where (pa01,pa02,pa03,pa04) in (select p2.pa01,p2.pa02,p2.pa03,p2.pa04" & _
      " from caseprogress,patent p1,pridate p,patent p2" & _
      " where cp27<to_char(add_months(sysdate,-15),'YYYYMMDD')" & _
      " AND CP159=0 and cp10='121' and cp01||''='P'" & _
      " and p1.pa01(+)=cp01 and p1.pa02(+)=cp02 and p1.pa03(+)=cp03 and p1.pa04(+)=cp04 and p1.pa09='000'" & _
      " and pd01(+)=cp01 and pd02(+)=cp02 and pd03(+)=cp03 and pd04(+)=cp04 and pd07=p1.pa09" & _
      " and p2.pa11(+)=decode(substr(pd06,1,1),'0',substr(pd06,2),pd06) and p2.pa09=pd07" & _
      " and p2.pa57 is null)"
   'cnnConnection.Execute strSql
   '可能被多案主張國內優先權(Ex:一案兩請主張相同國內案)
   strSql = "select distinct t2.pa01,t2.pa02,t2.pa03,t2.pa04,t2.pa10" & _
      " from caseprogress,patent t1,pridate p,patent t2" & _
      " where cp27>=to_char(add_months(sysdate,-15),'YYYYMMDD')" & _
      " AND CP159=0 and cp10='121' and cp01='P'" & _
      " and t1.pa01(+)=cp01 and t1.pa02(+)=cp02 and t1.pa03(+)=cp03 and t1.pa04(+)=cp04 and t1.pa09='000'" & _
      " and pd01(+)=cp01 and pd02(+)=cp02 and pd03(+)=cp03 and pd04(+)=cp04 and pd07=t1.pa09" & _
      " and t2.pa11(+)=pd06 and t2.pa09(+)=pd07 and t2.pa57 is null" & _
      " and t2.pa10<=to_char(add_months(sysdate,-15),'YYYYMMDD')"
   intI = 1
   Set RsTemp = ClsLawReadRstMsg(intI, strSql)
   If intI = 1 Then
      With RsTemp
      Do While Not .EOF
         cnnConnection.BeginTrans: bolUpdStar = True
         
         strSql = "update patent set pa57='Y',pa58=to_char(sysdate,'yyyymmdd'),pa59='88'" & _
            " where pa01='" & .Fields("pa01") & "' and pa02='" & .Fields("pa02") & "'" & _
            " and pa03='" & .Fields("pa03") & "' and pa04='" & .Fields("pa04") & "'"
         cnnConnection.Execute strSql, intI
         
         '已提實審，未收到審查意見，未辦理自請撤回
         strSql = "select pa01||'-'||pa02||decode(pa03||pa04,'000','','-'||pa03||'-'||pa04) CaseNo,pa01,pa02,pa03,pa04,cp09" & _
            " from patent,caseprogress a where pa01='" & .Fields("pa01") & "' and pa02='" & .Fields("pa02") & "'" & _
            " and pa03='" & .Fields("pa03") & "' and pa04='" & .Fields("pa04") & "'" & _
            " and cp01(+)=pa01 and cp02(+)=pa02 and cp03(+)=pa03 and cp04(+)=pa04 and cp10(+)='908'and CP159(+)=0 and cp158(+)=0" & _
            " and exists(select * from caseprogress b where cp01=pa01 and cp02=pa02 and cp03=pa03 and cp04=pa04 and cp10='416' and cp27>0)" & _
            " and not exists(select * from caseprogress b where cp01=pa01 and cp02=pa02 and cp03=pa03 and cp04=pa04 and cp10='1202')" & _
            " and not exists(select * from caseprogress b where cp01=pa01 and cp02=pa02 and cp03=pa03 and cp04=pa04 and cp10='413' and cp159=0)"
         intI = 1
         Set adoRecordset = ClsLawReadRstMsg(intI, strSql)
         If intI = 1 Then
            strExc(1) = Pub_GetSpecMan("A1") '承辦台灣案年費的程序人員
            With adoRecordset
            strExc(2) = .Fields("CaseNo") & "案被主張國內優先權已被視為撤回，請聯繫智權同仁辦理退費！"
            strSql = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08)" & _
               " values('" & strUserNum & "','" & strExc(1) & "',to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss')" & _
               ",'" & strExc(2) & "','如旨')"
            cnnConnection.Execute strSql, intI
            
            If IsNull(.Fields("cp09")) Then
               strExc(0) = AutoNo("B", 6) 'B類總收文號
               strExc(3) = PUB_GetAKindSalesNo(.Fields("pa01"), .Fields("pa02"), .Fields("pa03"), .Fields("pa04"))
               strExc(4) = GetSalesArea(strExc(3))
               strSql = "insert into caseprogress (cp01,cp02,cp03,cp04,cp05,cp09,cp10,cp12,cp13,cp14,cp20,cp26,cp32,cp64) values " & _
                  " ('" & .Fields("pa01") & "','" & .Fields("pa02") & "','" & .Fields("pa03") & "','" & .Fields("pa04") & "'," & strSrvDate(1) & _
                  ",'" & strExc(0) & "','908','" & strExc(4) & "','" & strExc(3) & "','" & strExc(1) & "','N','N','N','被主張國內優先權自申請日起滿15個月後可退實體審查費;')"
               cnnConnection.Execute strSql, intI
            End If
            End With
         End If
         cnnConnection.CommitTrans: bolUpdStar = False
         .MoveNext
      Loop
      End With
   End If
   Call PUB_SendMailCache(True)
   'end 2023/4/24
   
ErrHand:
   If Err.Number <> 0 Then
      If bolUpdStar = True Then cnnConnection.RollbackTrans 'Added by Morgan 2023/4/24
      WLog Err.Description
   End If
'   If cnnConnection.State = adStateOpen Then cnnConnection.Close
   
End Sub

Private Function GetMimeHead(stSamplePath As String, Optional stOutBoundryTag As String) As String
      
   Dim ts As TextStream
   Dim strLine As String
   Dim bStart As Boolean
   Dim stMime As String
   Dim iPos As Integer
   
   stMime = ""
   stOutBoundryTag = ""
   If fso.FileExists(stSamplePath) Then
      Set ts = fso.OpenTextFile(stSamplePath)
      bStart = False
      Do While Not ts.AtEndOfStream
         strLine = ts.ReadLine
         If bStart = False Then
            '開始
            If InStr(UCase(strLine), UCase("MIME-Version: 1.0")) > 0 Then
               bStart = True
            End If
         End If
         
         If stOutBoundryTag = "" Then
            iPos = InStr(UCase(strLine), UCase("boundary="))
            If iPos > 0 Then
               '扣除前後的雙引號
               stOutBoundryTag = Mid(strLine, iPos + 10)
               stOutBoundryTag = Left(stOutBoundryTag, Len(stOutBoundryTag) - 1)
            End If
         End If
         
         If bStart = True Then
            '結束
            If InStr(UCase(strLine), UCase("Content-Disposition: attachment;")) > 0 Then
               stMime = stMime & strLine & vbCrLf
               Exit Do
            Else
               stMime = stMime & strLine & vbCrLf
            End If
         End If
      Loop
      ts.Close
   End If
   GetMimeHead = stMime
End Function
'
'Private Function SendXMail(FromName$, FromMail$, ToName$, ToMail$, Subj$, strMime$, Optional iErrCode As Integer) As Boolean
'
'
'   Dim strData(0 To 9) As String
'   Dim DateNow As String
'   Dim SMTP As String
'   Dim iRetry As Integer
'   Dim stBas64 As String
'
''測試
''   SendXMail = True
''   Exit Function
''   ToMail = "morganljh@hotmail.com"
'
'   Call Sleep(2000)  '等2秒
'
'On Error GoTo ErrHnd
'
'
'   iErrCode = 0
'   Result = ""
'   DoEvents
'
'
'
'   If InStr(ToMail, "@") = 0 Then
'      ToMail = ToMail & "@taie.com.tw"
'   End If
'
''Modified by Morgan 2012/9/28 統一寄往 192.168.1.15
''   SMTP = "192.168.1.10"
''   'Added by Morgan 2012/9/5 外部信箱改寄往 192.168.1.15
''   If InStr(LCase(ToMail), "@taie.com.tw") = 0 Then
''      SMTP = "192.168.1.15"
''   End If
''   'end 2012/9/5
'   SMTP = "192.168.1.15"
''end 2012/9/28
'
'   strData(1) = "mail from:" + Chr(32) + FromMail + vbCrLf
'   strData(2) = "rcpt to:" + Chr(32) + ToMail + vbCrLf
'
'   stBas64 = ConvertToBase64(FromName, False, False)
'   strData(3) = "From: =?Big5?B?" & stBas64 & "?= <" & FromMail & ">" & vbCrLf
'
'   stBas64 = ConvertToBase64(ToName, False, False)
'   strData(4) = "To: =?Big5?B?" & stBas64 & "?= <" & ToMail & ">" & vbCrLf
'
'   stBas64 = ConvertToBase64(Subj, False, False)
'   strData(5) = "Subject: =?Big5?B?" & stBas64 & "?=" & vbCrLf
'
'   DateNow = Format(Date, "Ddd") & ", " & Format(Date, "dd Mmm YYYY") & " " & Format(Time, "hh:mm:ss") & "" & " +0800"
'
'   stBas64 = ConvertToBase64(FromName, False, False)
'
'   'strData(6) = "Date:" + Chr(32) + DateNow + vbCrLf & _
'      "Importance: high" & vbCrLf & _
'      "X-Priority: 1" & vbCrLf & _
'      "Return-Receipt-To: =?Big5?B?" & stBas64 & "?= <" & FromMail & ">" & vbCrLf
'
'   strData(6) = "Date:" + Chr(32) + DateNow + vbCrLf
'
'   strData(0) = strData(3) + strData(4) + strData(5) + strData(6)
'
'   strData(9) = strMime
'   If strData(9) = "" Then
'      strData(7) = "MIME-Version: 1.0" & vbCrLf & _
'                   "Content-Type: text/plain;" + vbCrLf & _
'                   "   charset=""big5""" + vbCrLf
'      strData(8) = "testing..." + vbCrLf
'      strData(9) = strData(7) & strData(8)
'   End If
'
'   strData(0) = strData(0) + strData(9)
'
'RetryPoint:
'
'   If Winsock1.State <> sckClosed Then Winsock1.Close
'
'   Winsock1.LocalPort = 0
'   Winsock1.Protocol = sckTCPProtocol
'   Winsock1.RemoteHost = SMTP
'   Winsock1.RemotePort = 25
'   DoEvents
'
'   Winsock1.Connect
'   If Not Response("220") Then
'      Winsock1.Close
'      iErrCode = 1
'      If SMTP <> Server Then SMTP = Server '若連線失敗改連另一台 Added by Morgan 2012/9/28
'      GoTo ERRORMail
'   End If
'
'   DoEvents
'   Winsock1.SendData ("HELO msa.hinet.net" + vbCrLf)
'   If Not Response("250") Then
'      iErrCode = 2
'      GoTo ERRORMail
'   End If
'
'   DoEvents
'   Winsock1.SendData (strData(1))
'   If Not Response("250") Then
'      iErrCode = 3
'      GoTo ERRORMail
'   End If
'
'   DoEvents
'   Winsock1.SendData (strData(2))
'   If Not Response("250") Then
'      iErrCode = 4
'      GoTo ERRORMail
'   End If
'
'   DoEvents
'   Winsock1.SendData ("data" + vbCrLf)
'   If Not Response("354") Then
'      iErrCode = 5
'      GoTo ERRORMail
'   End If
'
'   DoEvents
'   Winsock1.SendData (strData(0) & vbCrLf & "." & vbCrLf)
'   If Not Response("250") Then
'      iErrCode = 6
'      GoTo ERRORMail
'   End If
'
'   DoEvents
'   Winsock1.SendData ("quit" + vbCrLf)
'   If Not Response("221") Then
'      iErrCode = 7
'      GoTo ERRORMail
'   End If
'   Winsock1.Close
'   SendXMail = True
'   Exit Function
'
'ERRORMail:
'   iRetry = iRetry + 1
'   If iRetry < 3 Then
'      GoTo RetryPoint
'   End If
'
'ErrHnd:
'
'End Function

Private Function GetAttMime(stAttPath As String, stBoundryTag As String) As String
   Dim stMime As String, sFil64 As String
   Dim ff As Integer, stLine As String
   
   stMime = ""
   If LCase(Right(stAttPath, 4)) = ".txt" Then
      'stMIME = stMIME & _
         "Content-Type: text/plain;" & vbCrLf & _
         "  name=""explanation.txt""" & vbCrLf & _
         "Content-Disposition: attachment;" & vbCrLf & _
         "  filename=""explanation.txt""" & vbCrLf
      
      stMime = stMime & "  filename=""Cases for Refund.txt""" & vbCrLf
      ff = FreeFile()
      sFil64 = ""
      Open stAttPath For Input As ff
      Do While Not EOF(ff)
         Line Input #ff, stLine
         sFil64 = sFil64 & stLine & vbCrLf
      Loop
      If ff > 0 Then Close #ff
      stMime = stMime & sFil64 & vbCrLf & vbCrLf & cDASH2 & stBoundryTag & cDASH2 & vbCrLf & vbCrLf
   Else
      stMime = stMime & _
         "Content-Type: application/octet-stream;" & vbCrLf & _
         "  name=""explanation.pdf""" & vbCrLf & _
         "Content-Transfer-Encoding: base64" & vbCrLf & _
         "Content-Disposition: attachment;" & vbCrLf & _
         "  filename=""explanation.pdf""" & vbCrLf
      sFil64 = ConvertToBase64(stAttPath, True, True)
      stMime = stMime & sFil64 & vbCrLf & vbCrLf & cDASH2 & stBoundryTag & cDASH2 & vbCrLf & vbCrLf
   End If
   GetAttMime = stMime
End Function

'Add by Morgan 2010/1/25
'順稿期限管制表
'Modified by Morgan 2014/11/10 +bolIsOurFMP:是否FMP寰華案件
Private Function CreateFile13(ByVal p_Sys As String, ByVal p_RptDate As String, ByRef p_FileName As String, Optional bolIsOurFMP As Boolean, Optional p_PS As String) As Boolean
   
   Dim stSQL As String
   Dim ff As Integer
   Dim strContent As String
   Dim tmpnext As String
   Dim lngRecs As Long
   Dim stFileName As String
   Dim stCon As String
   'Added by Lydia 2017/02/16 設定欄位
   Dim strTitle As String    '欄位抬頭名稱
   Dim strTitleLine As String '欄位抬頭底線
   Dim strText As String, strFMPPID As String, strFMPPName As String, strFMPPSup As String 'Added by Morgan 2023/6/16
   'Added by Morgan 2025/1/7
   Dim strRptTitle As String
   Dim stVTB0 As String
   Dim rsQuery As ADODB.Recordset
   Dim mSeqNo As String, stPID As String, strPIDName As String, stMailList As String
   Dim bolPNewRule As Boolean
   'end 2025/1/7
   
   p_FileName = ""
   lngRecs = 0
   stCon = ""
   
   'Added by Morgan 2025/1/8
   If p_Sys = "P" And bolIsOurFMP = False And strSrvDate(1) >= P業務區劃分啟用日 Then
      bolPNewRule = True
   Else
      bolPNewRule = False
   End If
   'end 2025/1/8
               
   'Added by Morgan 2014/11/10
   If p_Sys = "P" Then
      If bolIsOurFMP Then
         stCon = stCon & " and exists"
      Else
         stCon = stCon & " and not exists"
      End If
      'Modified by Morgan 2015/10/26
      'FMP寰華加判斷發文人員為外專程序
      'Modified by Morgan 2018/8/28 修正發文人原部門判斷(原程式抓到承辦人)
      stCon = stCon & "(select * from caseprogress b,staff c where b.cp01=np02 and b.cp02=np03 and b.cp03=np04 and b.cp04=np05 and b.cp31='Y' and b.cp44='Y53374000' and b.cp12 like 'F%' and c.st01(+)=b.cp83 and (b.cp83 is null or c.st03='F22'))"
      'end 2015/10/26
   End If
   'end 2014/11/10
   
On Error GoTo ErrHandle
   'Modified by Lydia 2016/09/14 CP27=>CP158 ; CP57 IS NULL =>CP159=0
   'Modified by Lydia 2017/02/16 抓FMP管制人
   'stSQL = "SELECT ST02 C01" & _
      ",CP158-19110000 C02, NP08-19110000 C03, CP09 C04,CP01||'-'||CP02||'-'||CP03||'-'||CP04 C05" & _
      ",NVL(PA05,NVL(PA06,PA07)) C06,PTM03 C07,NA03 C08" & _
      ",DECODE(PA09,'000',CPM03,CPM04) C09" & _
      ",DECODE(SK03,0,(NVL(FA04,DECODE(FA05,NULL,FA06,FA05||' '||FA63||' '||FA64||' '||FA65)))" & _
      ",(NVL(FA04,DECODE(FA05,NULL,FA06,FA05||' '||FA63||' '||FA64||' '||FA65)))) C10" & _
      " FROM NEXTPROGRESS,CASEPROGRESS,PATENT,STAFF,SYSTEMKIND,CASEPROPERTYMAP,NATION,FAGENT,PATENTTRADEMARKMAP" & _
      " WHERE NP02='" & p_Sys & "' AND NP06 IS NULL AND NP07='994'" & stCon & _
      " AND TO_DATE(NP08,'YYYYMMDD')<=TRUNC(TO_DATE(" & strSrvDate(1) & ",'YYYYMMDD'))" & _
      " AND CP09(+)=NP01 AND CP158>0 AND CP24 IS NULL AND CP47 IS NULL AND CP159=0" & _
      " AND PA01(+)=CP01 AND PA02(+)=CP02 AND PA03(+)=CP03 AND PA04(+)=CP04 AND PA57||PA108 IS NULL" & _
      " AND ST01(+)=CP14 AND SK01(+)=CP01 AND NA01(+)=PA09" & _
      " AND CPM01(+)=CP01 AND CPM02(+)=CP10" & _
      " AND PTM01(+)='1' AND PTM02(+)=PA08" & _
      " AND FA01(+)=SUBSTR(CP44,1,8) AND FA02(+)=SUBSTR(CP44,9,1) ORDER BY 1,2,3,4"
   stSQL = "SELECT ST02 C01" & _
      ",CP158-19110000 C02, NP08-19110000 C03, CP09 C04,CP01||'-'||CP02||'-'||CP03||'-'||CP04 C05" & _
      ",NVL(PA05,NVL(PA06,PA07)) C06,PTM03 C07,NA03 C08" & _
      ",DECODE(PA09,'000',CPM03,CPM04) C09" & _
      ",DECODE(SK03,0,(NVL(F1.FA04,DECODE(F1.FA05,NULL,F1.FA06,F1.FA05||' '||F1.FA63||' '||F1.FA64||' '||F1.FA65)))" & _
      ",(NVL(F1.FA04,DECODE(F1.FA05,NULL,F1.FA06,F1.FA05||' '||F1.FA63||' '||F1.FA64||' '||F1.FA65)))) C10,NVL(F2.FA10,C1.CU10) FA10" & _
      " FROM NEXTPROGRESS,CASEPROGRESS,PATENT,STAFF,SYSTEMKIND,CASEPROPERTYMAP,NATION,FAGENT F1,PATENTTRADEMARKMAP,CUSTOMER C1,FAGENT F2" & _
      " WHERE NP02='" & p_Sys & "' AND NP06 IS NULL AND NP07='994'" & stCon & _
      " AND TO_DATE(NP08,'YYYYMMDD')<=TRUNC(TO_DATE(" & strSrvDate(1) & ",'YYYYMMDD'))" & _
      " AND CP09(+)=NP01 AND CP158>0 AND CP24 IS NULL AND CP47 IS NULL AND CP159=0" & _
      " AND PA01(+)=CP01 AND PA02(+)=CP02 AND PA03(+)=CP03 AND PA04(+)=CP04 AND PA57||PA108 IS NULL" & _
      " AND ST01(+)=CP14 AND SK01(+)=CP01 AND NA01(+)=PA09" & _
      " AND CPM01(+)=CP01 AND CPM02(+)=CP10" & _
      " AND PTM01(+)='1' AND PTM02(+)=PA08" & _
      " AND F1.FA01(+)=SUBSTR(CP44,1,8) AND F1.FA02(+)=SUBSTR(CP44,9,1)" & _
      " AND SUBSTR(PA75,1,8)=F2.FA01(+) AND SUBSTR(PA75,9,1)=F2.FA02(+) AND SUBSTR(PA26,1,8)=C1.CU01(+) AND SUBSTR(PA26,9,1)=C1.CU02(+)"
    
   'Modified by Morgan 2025/1/8 +PID
   stSQL = "SELECT  C01,C02,C03,C04,C05,C06,C07,C08,C09,C10,NVL(NA79,NA16) FMP,NVL(ST02,' ') FMPMAN,'' PID FROM (" & stSQL & "),NATION,STAFF WHERE FA10=NA01(+) AND NVL(NA79,NA16)=ST01(+)"
   If bolIsOurFMP Then
      stSQL = stSQL & " ORDER BY FMP,1,2,3,4"
   Else
      stSQL = stSQL & " ORDER BY 1,2,3,4"
   End If
   'end 2017/02/16
   
   If Rs.State <> adStateClosed Then Rs.Close
   Rs.CursorLocation = adUseClient
   Rs.Open stSQL, cnnConnection, adOpenForwardOnly, adLockReadOnly
   If Rs.RecordCount > 0 Then
   
      'Added by Morgan 2025/1/8
      If bolPNewRule Then
         Set rsQuery = PUB_CreateRecordset(Rs, , , 300, Me.Name, mSeqNo)
         With rsQuery
            .MoveFirst
            Do While Not .EOF
               .Fields("PID") = PUB_GetPHandler(.Fields("C05"))
               .MoveNext
            Loop
            .UpdateBatch
            stVTB0 = "select R001 as " & .Fields(0).Name
            For intI = 2 To .Fields.Count
               stVTB0 = stVTB0 & ", R" & Format(intI, "000") & " as " & .Fields(intI - 1).Name
            Next
            stVTB0 = stVTB0 & " from Rdatafactory Where Id='" & strUserNum & "' And Formname='" & Me.Name & "'  And Seqno='" & mSeqNo & "'"
         End With
         stSQL = "Select X.* From (" & stVTB0 & ") X order by PID,1,2,3,4"
         intI = 1
         Set Rs = ClsLawReadRstMsg(intI, stSQL)
      End If
      'end 2025/1/8
   
      With Rs
         .MoveFirst
         
         'Added by Morgan 2014/11/10
         If bolIsOurFMP Then
            
            'Modified by Morgan 2023/6/16 FMP寰華案改寄管制程序及其主管
            'stFileName = App.path & TextPath & "FMP寰華案件順稿期限管制表.txt"
            strFMPPID = "" & .Fields("FMP")
            strFMPPName = "" & .Fields("FMPMAN")
            'Modified by Morgan 2025/1/8
            'stFileName = App.path & TextPath & "FMP寰華案件順稿期限管制表(" & strFMPPName & ").txt"
            strRptTitle = "FMP寰華案件順稿期限管制表(" & strFMPPName & ")"
            stFileName = App.path & TextPath & strRptTitle & ".txt"
            'end 2025/1/8
            'end 2023/6/16
            
            'Added by Lydia 2017/02/16 設定欄位
                strTitle = "管制人 承辦人 發文日    順稿期限  收文號    本所案號        案件名稱                 種類   申請國家 案件性質   代理人    "
            strTitleLine = "------ ------ --------- --------- --------- --------------- ------------------------ ------ -------- ---------- ----------"
            'end 2017/02/16
         Else
         'end 2014/11/10
            
            'Modified by Morgan 2025/1/8
            'stFileName = App.path & TextPath & p_Sys & "順稿期限管制表.txt"
            strRptTitle = p_Sys & "順稿期限管制表"
            If bolPNewRule Then
               stPID = "" & .Fields("pid")
               strPIDName = GetPIDName(stPID)
               strRptTitle = strRptTitle & "(" & strPIDName & ")"
            End If
            stFileName = App.path & TextPath & strRptTitle & ".txt"
            'end 2025/1/8
            
            'Added by Lydia 2017/02/16 設定欄位
                strTitle = "承辦人 發文日    順稿期限  收文號    本所案號        案件名稱                 種類   申請國家 案件性質   代理人    "
            strTitleLine = "------ --------- --------- --------- --------------- ------------------------ ------ -------- ---------- ----------"
            'end 2017/02/16
         End If 'Added by Morgan 2014/11/10
         
         
         If ff > 0 Then Close #ff
         ff = FreeFile
         Open stFileName For Output As ff
         'Added by Lydia 2016/10/19 加報表抬頭
         'Modified by Morgan 2025/1/8
         'Print #ff, Space(40) & IIf(bolIsOurFMP = True, "FMP寰華案件順稿期限管制表", p_Sys & "順稿期限管制表")
         Print #ff, Space(40) & strRptTitle
         'end 2025/1/8
         'end 2016/10/19
         Print #ff, ""
         Print #ff, "日期：" & p_RptDate
         Print #ff, ""
         'Modified by Lydia 2017/02/16 設定欄位
         'Print #ff, "承辦人 發文日    順稿期限  收文號    本所案號        案件名稱                 種類   申請國家 案件性質   代理人    "
         'Print #ff, "------ --------- --------- --------- --------------- ------------------------ ------ -------- ---------- ----------"
         Print #ff, strTitle
         Print #ff, strTitleLine
         'end 2017/02/16
         
         tmpnext = "開檔中..."
         Do While Not .EOF
            'Added by Morgan 2023/6/16 FMP寰華案改寄管制程序及其主管
            If bolIsOurFMP Then
               If strFMPPID <> "" & .Fields("FMP") Then
                  Print #ff, strTitleLine
                  Print #ff, "共" & lngRecs & "筆"
                  Close ff
                  
                  strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & _
                     "FMP寰華案件順稿期限管制表(" & p_RptDate & ")(" & strFMPPName & ") 資料如附件！" & _
                     vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & p_PS
                     
                  strFMPPSup = PUB_GetFCPProSup(strFMPPID)
                  SendMAPIMail strFMPPID, "FMP寰華案件順稿期限管制表(" & p_RptDate & ")(" & strFMPPName & ")", strText, stFileName, , , strFMPPSup
                  
                  lngRecs = 0
                  strFMPPID = "" & .Fields("FMP")
                  strFMPPName = "" & .Fields("FMPMAN")
                  stFileName = App.path & TextPath & "FMP寰華案件順稿期限管制表(" & strFMPPName & ").txt"
                  
                  ff = FreeFile
                  Open stFileName For Output As ff
                  Print #ff, Space(40) & IIf(bolIsOurFMP = True, "FMP寰華案件順稿期限管制表", p_Sys & "順稿期限管制表")
                  Print #ff, ""
                  Print #ff, "日期：" & p_RptDate
                  Print #ff, ""
                  Print #ff, strTitle
                  Print #ff, strTitleLine
               End If
            End If
            'end 2023/6/16
            
            'Added by Morgan 2025/1/8
            If bolPNewRule Then
               If stPID <> "" & .Fields("pid") Then
                  Print #ff, strTitleLine
                  Print #ff, "共" & lngRecs & "筆"
                  Close ff
                  
                  strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & _
                     p_Sys & "順稿期限管制表(" & p_RptDate & ")(" & strPIDName & ") 資料如附件！" & _
                     vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & p_Sys
               
                  SendMAPIMail stPID, p_Sys & "順稿期限管制表(" & p_RptDate & ")(" & strPIDName & ")", strText, stFileName
                  
                  lngRecs = 0
                  stPID = "" & .Fields("pid")
                  strPIDName = GetPIDName(stPID)
                  strRptTitle = p_Sys & "順稿期限管制表(" & strPIDName & ")"
                  stFileName = App.path & TextPath & strRptTitle & ".txt"
               
                  ff = FreeFile
                  Open stFileName For Output As ff
                  Print #ff, Space(40) & strRptTitle
                  Print #ff, ""
                  Print #ff, "日期：" & p_RptDate
                  Print #ff, ""
                  Print #ff, strTitle
                  Print #ff, strTitleLine
               End If
            End If
            'end 2025/1/8
            
            
            lngRecs = lngRecs + 1
            strContent = ""
            'Added by Lydia 2017/02/16 +管制人
            If bolIsOurFMP Then
               strContent = convForm("" & .Fields("FMPMAN"), 6) & " " & strContent '管制人
            End If
            'end 2017/02/16
            strContent = strContent & convForm("" & .Fields("C01"), 6) '承辦人
            strContent = strContent & " " & Format(.Fields("C02"), "@@@/@@/@@") '發文日
            strContent = strContent & " " & Format(.Fields("C03"), "@@@/@@/@@") '順稿期限
            strContent = strContent & " " & convForm(.Fields("C04"), 9) '收文號
            strContent = strContent & " " & convForm(.Fields("C05"), 15) '本所案號
            strContent = strContent & " " & convForm(.Fields("C06"), 24) '案件名稱
            strContent = strContent & " " & convForm(.Fields("C07"), 6) '種類
            strContent = strContent & " " & convForm(.Fields("C08"), 8) '申請國家
            strContent = strContent & " " & convForm(.Fields("C09"), 10) '案件性質
            strContent = strContent & " " & convForm(.Fields("C10"), 10) '代理人
            tmpnext = "寫檔..."
            Print #ff, strContent
            .MoveNext
         Loop
         'Modified by Lydia 2017/02/16 設定欄位
         'Print #ff, "------ --------- --------- --------- --------------- ------------------------ ------ -------- ---------- ----------"
         Print #ff, strTitleLine
         'end 2017/02/16
         Print #ff, "共" & lngRecs & "筆"
         Close ff
         'Added by Morgan 2023/6/16 FMP寰華案改寄管制程序及其主管
         If bolIsOurFMP Then
            strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & _
               "FMP寰華案件順稿期限管制表(" & p_RptDate & ")(" & strFMPPName & ") 資料如附件！" & _
               vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & p_PS
            strFMPPSup = PUB_GetFCPProSup(strFMPPID)
            SendMAPIMail strFMPPID, "FMP寰華案件順稿期限管制表(" & p_RptDate & ")(" & strFMPPName & ")", strText, stFileName, , , strFMPPSup
         End If
         'end 2023/6/13
         
         'Added by Morgan 2025/1/8
         'Added by Morgan 2025/1/8
         If bolPNewRule Then
            strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & _
               p_Sys & "順稿期限管制表(" & p_RptDate & ")(" & strPIDName & ") 資料如附件！" & _
               vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & p_Sys
         
            SendMAPIMail stPID, p_Sys & "順稿期限管制表(" & p_RptDate & ")(" & strPIDName & ")", strText, stFileName
         End If
                  
         
         p_FileName = p_FileName & stFileName
      End With
   End If
   CreateFile13 = True
   Exit Function
   
ErrHandle:
   WLog tmpnext & " " & Err.Description

End Function
'Add by Morgan 2010/9/15
'設定承辦期限,預定會稿日
Private Sub StrMenu19()
   Dim stSQL As String
   Dim stlstEngid As String '工程師編號
   Dim dblC As Double '當日可辦量
   Dim dblP As Double '個人工作目標
   Dim dblW As Double '合理可辦量
   Dim dblN As Double '基本工作天
   Dim dblA As Double
   Dim dblB As Double
   Dim iDayP As Integer 'P案工作天數
   Dim iDayCFP As Integer 'CFP案工作天數
   Const cntT As String = "21.6" '工作目標基礎值
   Const cntD As String = "7" '工作天基礎值
   Dim stCP48 As String, stEP28 As String
   Dim stCP48max As String, stEP28max As String, iMinDay1 As Integer, iMinDay2 As Integer
   
   '已齊備無承辦期限案件(未完稿,未發文)
   'Modified by Lydia 2016/09/14 cp57 is null=>CP159=0
   stSQL = "select ep05,ep02,ep06,cp01,cp10,cp06,to_char(add_months(to_date(st13,'yyyymmdd'),12),'yyyymmdd') dt" & _
      " From engineerprogress,caseprogress,staff" & _
      " where ep06>to_char(sysdate-365,'yyyymmdd') and ep09||ep10 is null" & _
      " and cp09(+)=ep02 and cp48 is null and CP159=0" & _
      " and cp01 in ('P','CFP') and st01(+)=cp14 order by 1,2"
   
   If Rs.State <> adStateClosed Then Rs.Close
   With Rs
   .CursorLocation = adUseClient
   .Open stSQL, cnnConnection, adOpenForwardOnly, adLockReadOnly
   If .RecordCount > 0 Then
      .MoveFirst
      stlstEngid = ""
      Do While Not .EOF
         If stlstEngid <> .Fields("ep05") Then
            stlstEngid = .Fields("ep05")
            dblP = GetP(stlstEngid)
            '工作目標基礎值(T)/個人工作目標=A
            If dblP > 0 Then
               dblA = Val(cntT) / dblP
               If dblA <= 1 Then
                  dblN = Val(cntD)
               Else
                  dblN = Val(cntD) * dblA
               End If
               dblW = dblP / 21 * 7
               dblC = GetC(stlstEngid)
               '當日可辦量/合理可辦量(W)=B
               dblB = dblC / dblW
               If dblB <= 1 Then
                  iDayP = Round(dblN)
                  iDayCFP = Round(2 * dblN)
               Else
                  iDayP = Round(dblN * dblB)
                  iDayCFP = Round(2 * dblN * dblB)
               End If
               
               'Add by Morgan 2010/11/1 未滿1年且目標小於18的 P案承辦天數<=12,CFP案承辦天數<=25
               If dblP < 18 And Val(strSrvDate(1)) < Val("" & .Fields("dt")) Then
                  If iDayP > 12 Then iDayP = 12
                  If iDayCFP > 25 Then iDayCFP = 25
               'Add by Morgan 2010/11/16 P案上限=20,CFP案上限=40 柄佑請作單
               Else
                  If iDayP > 20 Then iDayP = 20
                  If iDayCFP > 40 Then iDayCFP = 40
               End If
            'Add by Morgan 2010/11/3 外翻都用15個工作天
            ElseIf Left(stlstEngid, 1) = "F" Then
               iDayP = 15
               iDayCFP = 15
            '沒有目標的
            Else
               'P案承辦天數<=12,CFP案承辦天數<=25
               iDayP = 12
               iDayCFP = 25
            End If
         End If
         
         'Add by Morgan 2010/11/1 案件性質 901,902,1002,1006,1201,1205,1206,1209 承辦天數固定7個工作天
         If InStr(",901,902,1002,1006,1201,1205,1206,1209,", "," & .Fields("cp10") & ",") > 0 Then
            stCP48 = CompWorkDay(7, .Fields("ep06"))
            stEP28 = CompWorkDay(3, stCP48) '承辦期限+2個工作天(不含當日)
            iMinDay1 = 3 'P案承辦期限最遲為所限前3個工作天
            iMinDay2 = 1 'P案預定會稿日最遲為所限前1個工作天
         
         'CFP的103,105,1002,1006,1205,1206,1209比照P案
         ElseIf .Fields("cp01") = "P" Or InStr(",103,105,1002,1006,1205,1206,1209,", "," & .Fields("cp10") & ",") > 0 Then
            stCP48 = CompWorkDay(iDayP, .Fields("ep06"))
            stEP28 = CompWorkDay(3, stCP48) '承辦期限+2個工作天(不含當日)
            iMinDay1 = 3 'P案承辦期限最遲為所限前3個工作天
            iMinDay2 = 1 'P案預定會稿日最遲為所限前1個工作天
         Else
            stCP48 = CompWorkDay(iDayCFP, .Fields("ep06"))
            stEP28 = CompWorkDay(5, stCP48) '承辦期限+4個工作天(不含當日)
            iMinDay1 = 6 'CFP案承辦期限最遲為所限前6個工作天
            iMinDay2 = 2 'CFP案預定會稿日最遲為所限前2個工作天
         End If
         
         If Not IsNull(.Fields("cp06")) Then
            stCP48max = CompWorkDay(iMinDay1, CompDate(2, -1, .Fields("cp06")), 1)
            If stCP48 > stCP48max Then
               stCP48 = stCP48max
            End If
            
            stEP28max = CompWorkDay(iMinDay2, CompDate(2, -1, .Fields("cp06")), 1)
            If stEP28 > stEP28max Then
               stEP28 = stEP28max
            End If
         End If
         '承辦期限不可早於齊備日
         If stCP48 < .Fields("ep06") Then
            stCP48 = .Fields("ep06")
         End If
         '預定會稿日不可早於齊備日
         If stEP28 < .Fields("ep06") Then
            stEP28 = .Fields("ep06")
         End If
         
         stSQL = "update caseprogress set cp48=" & stCP48 & " where cp09='" & .Fields("ep02") & "'"
         cnnConnection.Execute stSQL
         stSQL = "update engineerprogress set ep28=" & stEP28 & " where ep02='" & .Fields("ep02") & "'"
         cnnConnection.Execute stSQL
         
         
         If (.Fields("cp01") = "P" And InStr("," & CaseMapIn & ",301,302,303,304,305,306,307,803,", "," & .Fields("cp10") & ",") > 0) Or _
            (.Fields("cp01") = "CFP" And InStr("," & CaseMapOut & ",301,302,303,304,305,306,307,803,", "," & .Fields("cp10") & ",") > 0) Then
            Mail2Sales .Fields("ep02")
         End If
         .MoveNext
      Loop
   End If
   End With
End Sub
'Added by Morgan 2012/7/18
'齊備日異動通知
Private Sub StrMenu33()
   Dim stSQL As String
   'Modified by Lydia 2016/09/14 cp27||cp57 is null => CP158=0 AND CP159=0
   stSQL = "select dl05" & _
      " From dml_log, caseprogress, engineerprogress" & _
      " where dl01='P' and dl07=to_char(sysdate-1,'yyyymmdd') and instr(dl09,'齊備日異動：')>0" & _
      " and cp09(+)=dl05 and cp10 in (" & CaseMapIn & ",301,302,303,304,305,306,307,803" & ")" & _
      " and CP158=0 AND CP159=0 and substr(cp12,1,1)<>'F'" & _
      " and ep02(+)=cp09 and ep06>0 and ep09||ep10 is null" & _
      " union select dl05" & _
      " From dml_log, caseprogress, engineerprogress" & _
      " where dl01='CFP' and dl07=to_char(sysdate-1,'yyyymmdd') and instr(dl09,'齊備日異動：')>0" & _
      " and cp09(+)=dl05 and cp10 in (" & CaseMapOut & ",301,302,303,304,305,306,307,803" & ")" & _
      " and CP158=0 AND CP159=0" & _
      " and ep02(+)=cp09 and ep06>0 and ep09||ep10 is null"
   
   If Rs.State <> adStateClosed Then Rs.Close
   With Rs
   .CursorLocation = adUseClient
   .Open stSQL, cnnConnection, adOpenForwardOnly, adLockReadOnly
   If .RecordCount > 0 Then
      .MoveFirst
      Do While Not .EOF
         Mail2Sales .Fields("dl05")
         .MoveNext
      Loop
   End If
   End With
End Sub
'齊備日通知
Private Function Mail2Sales(p_CP09 As String) As Boolean
   Dim stSQL As String
   Dim rs1 As New ADODB.Recordset
   Dim stSubject As String, stContent As String
   
   '前日齊備日異動
   'Modified by Lydia 2018/06/05 修改顯示案件性質 '020',CPM04,CPM03 => '000',CPM03,CPM04
   stSQL = "select cp14,s2.st02,cp13,decode(instr(dl09,'齊備日異動：==>'),0,'E','A') Flg" & _
      ",sqldatet(ep06) Dt1,sqldatet(ep28) Dt2" & _
      ",cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) CaseNo" & _
      ",cp09,decode(pa09,'000',CPM03,CPM04) Pty" & _
      ",NVL(PA05,NVL(PA06,PA07)) CaseName" & _
      ",nvl(cu04,nvl(rtrim(cu05||' '||cu88||' '||cu89||' '||cu90),cu06)) CustName,dl06,s1.st02 dl06n" & _
      " from caseprogress,engineerprogress,patent,casepropertymap,customer,dml_log,staff s1,staff s2" & _
      " where cp09='" & p_CP09 & "' and ep02(+)=cp09" & _
      " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04" & _
      " and cpm01(+)=cp01 and cpm02(+)=cp10" & _
      " and cu01(+)=substr(pa26,1,8) and cu02(+)=substr(pa26,9)" & _
      " and dl05(+)=cp09 and dl07=to_char(sysdate-1,'yyyymmdd')" & _
      " and instr(dl09,'齊備日異動：')>0 and s1.st01(+)=dl06 and s2.st01(+)=cp14 order by dl08 desc"
   With rs1
   .CursorLocation = adUseClient
   .Open stSQL, cnnConnection, adOpenForwardOnly, adLockReadOnly
   If .RecordCount > 0 Then
      stContent = stContent & vbCrLf & "此訊息是凌晨系統自動代發！" & vbCrLf
      stContent = stContent & vbCrLf & "客戶名稱：" & .Fields("CustName")
      stContent = stContent & vbCrLf & "本所案號：" & .Fields("CaseNo")
      stContent = stContent & vbCrLf & "案件名稱： " & .Fields("CaseName")
      stContent = stContent & vbCrLf & "案件性質： " & .Fields("Pty")
      stContent = stContent & vbCrLf & "承  辦  人：" & .Fields("cp14") & .Fields("st02")
      stContent = stContent & vbCrLf & "齊  備  日：" & .Fields("Dt1")
      'Remove by Morgan 2010/11/16 --柄佑請作單
      'stContent = stContent & vbCrLf & "預定會稿日：" & .Fields("Dt2")
            
      'Modify By Sindy 2014/1/16
      'stSubject = "◎系統代發◎[通知] " & .Fields("CaseNo") & "/" & .Fields("cp09") & .Fields("Pty")
      stSubject = "◎[通知] " & .Fields("CaseNo") & "/" & .Fields("cp09") & .Fields("Pty")
      '2014/1/16 END
      stSubject = stSubject & "/" & .Fields("CaseName") & "/" & .Fields("CustName")
      If .Fields("Flg") = "A" Then
         stSubject = stSubject & " 工程師已齊備！"
         stContent = stContent & vbCrLf & vbCrLf & " 工程師已齊備！"
      Else
         stSubject = stSubject & " 齊備日已修改！"
         stContent = stContent & vbCrLf & vbCrLf & " 齊備日已修改！"
      End If
      'SendMail Server$, CheckStr("" & .Fields("dl06n")), ChkMailId("" & .Fields("dl06")), "", "" & .Fields("cp13"), stSubject, stContent
      'Modify By Sindy 2011/10/28 SendMail 改Call SendMAPIMail
      SendMAPIMail "" & .Fields("cp13"), stSubject, stContent
   End If
   End With
   Set rs1 = Nothing

End Function
'個人工作目標
Private Function GetP(p_EngId As String) As Double
   Dim stSQL As String
   Dim rs1 As New ADODB.Recordset
   
   '工作目標(基數)
   stSQL = "select nvl(er03,0) from engradix where er01=to_char(sysdate,'yyyymm') and er02='" & p_EngId & "'"
   With rs1
   .CursorLocation = adUseClient
   .Open stSQL, cnnConnection, adOpenForwardOnly, adLockReadOnly
   If .RecordCount > 0 Then
      GetP = .Fields(0)
   End If
   End With
   Set rs1 = Nothing
End Function
'當日可辦量
Private Function GetC(p_EngId As String) As Double
   Dim stSQL As String
   Dim rs1 As New ADODB.Recordset
   
   '當日可辦量=已齊備未完稿(未發文)
   'Modified by Lydia 2016/09/14 cp57 is null=>CP159=0
   stSQL = "select nvl(sum(cp97*cp98),0)" & _
      " From engineerprogress, caseprogress" & _
      " where ep05='" & p_EngId & "' and ep06>to_char(sysdate-365,'yyyymmdd') and ep09 is null and ep10 is null" & _
      " and cp09(+)=ep02 and CP159=0 and cp01 in ('P','CFP')"
      
   With rs1
   .CursorLocation = adUseClient
   .Open stSQL, cnnConnection, adOpenForwardOnly, adLockReadOnly
   If .RecordCount > 0 Then
      GetC = .Fields(0)
   End If
   End With
   Set rs1 = Nothing
End Function

'Removed by Morgan 2021/11/9 108考核已取消會稿加乘
''Add by Morgan 2010/9/16
''計算會稿加乘
'Private Sub StrMenu20()
'   Dim stSQL As String, iRec As Integer
'   Dim stDate1 As String, stDate2 As String
'   Dim stCP111 As String
'
'   'Modified by Morgan 2019/3/18 108考核(取消會稿加乘,判斷會稿日小於啟用日)
'   stSQL = "select ep02,ep04,ep05,ep06,ep07,cp01,cp48,cp27" & _
'      " From engineerprogress, caseprogress" & _
'      " where ep07>to_char(add_months(sysdate,-1),'yyyymm')||'01' and ep07<" & PUB_108RuleDate & " and ep06>0" & _
'      " and cp09(+)=ep02 and cp112='Y'" & _
'      " and cp01 in ('P','CFP') and cp10 in ('101','102') order by 1"
'
'   If rs.State <> adStateClosed Then rs.Close
'   With rs
'   .CursorLocation = adUseClient
'   .Open stSQL, cnnConnection, adOpenForwardOnly, adLockReadOnly
'   If .RecordCount > 0 Then
'      .MoveFirst
'      Do While Not .EOF
'         'Modified by Morgan 2012/8/1
'         'If .Fields("cp01") = "P" Then
'         '   stDate1 = CompWorkDay(7, .Fields("ep06"))
'         '   stDate2 = CompWorkDay(10, .Fields("ep06"))
'         'Else
'         '   stDate1 = CompWorkDay(14, .Fields("ep06"))
'         '   stDate2 = CompWorkDay(20, .Fields("ep06"))
'         'End If
'         'stCP111 = 1
'         'If .Fields("ep07") <= stDate1 Then
'         '   If IsNull(.Fields("ep04")) Or .Fields("ep04") = .Fields("ep05") Then
'         '      stCP111 = 1.2
'         '   Else
'         '      stCP111 = 1.4
'         '   End If
'         'ElseIf .Fields("ep07") <= stDate2 Then
'         '   stCP111 = 1.2
'         'End If
'
'         'Modified by Morgan 2016/6/22
'         '105/7/1 以後發文的改用新規則
'         '1. P的發明新型的新申請案(101、102)在自齊備日起5個工作天內(即會稿日≦齊備日+4個工作天)會稿者，設定「會稿加乘」為1.2。
'         '2. CFP的發明新型的新申請案(101、102)在自齊備日起10個工作天內(即會稿日≦齊備日+9個工作天)會稿者，設定「會稿加乘」為1.2。
'         If (IsNull(.Fields("cp27")) And strSrvDate(1) >= "20160701") Or .Fields("cp27") >= 20160701 Then
'            If .Fields("cp01") = "P" Then
'               stDate1 = CompWorkDay(5, .Fields("ep06"))
'            Else
'               stDate1 = CompWorkDay(10, .Fields("ep06"))
'            End If
'            stCP111 = 1
'            If .Fields("ep07") <= stDate1 Then
'               stCP111 = 1.2
'            End If
'         Else
'         'end 2016/6/22
'            If .Fields("ep07") <= .Fields("cp48") Then
'               stCP111 = 1.2
'            Else
'               stCP111 = 1
'            End If
'         End If 'Added by Morgan 2016/6/22
'         'end 2012/8/1
'
'         stSQL = "update caseprogress set cp111=" & stCP111 & " where cp09='" & .Fields("ep02") & "'"
'         cnnConnection.Execute stSQL, iRec
'         .MoveNext
'      Loop
'   End If
'   End With
'End Sub
'end 2021/11/9

'Add by Sindy 2010/10/25 臨時版本 , 更新salescontroldate資料
Private Sub StrMenu21()
Dim stSQL As String, iRec As Integer
Dim strSC05 As String
   
   '刪除無CP的資料
   cnnConnection.Execute "DELETE SALESCONTROLDATE WHERE SC01 IN (SELECT SC01 FROM SALESCONTROLDATE,CASEPROGRESS WHERE SC01=CP09(+) AND CP01 IS NULL)", iRec
   '刪除系統產生的3且無期限的資料
   cnnConnection.Execute "DELETE SALESCONTROLDATE WHERE SC04='M0100' AND SC05 IS NULL AND SC07='3'", iRec
   '刪除非新申請程序的待齊備,待會稿期限
   cnnConnection.Execute "DELETE SALESCONTROLDATE WHERE SC04='M0100' AND SC01 IN (" & _
                         " SELECT SC01 FROM SALESCONTROLDATE,CASEPROGRESS WHERE SC04='M0100' AND SC01=CP09(+)" & _
                         " AND CP10 NOT IN (101,102,103,104,105,109,110,112,113,114,115,118,120,122,307))", iRec
   
   '以程式更新未發文未取消收文的待會稿管制期限
   'Modified by Lydia 2016/09/14 cp27 is null and cp57 is null=> CP158=0 AND CP159=0
   stSQL = "select * from salescontroldate,engineerprogress,caseprogress where sc04='M0100' and sc07='2' and sc08 is null and CP158=0 AND CP159=0 and sc01=ep02(+) and sc01=cp09(+)"
   If Rs.State <> adStateClosed Then Rs.Close
   With Rs
   .CursorLocation = adUseClient
   .Open stSQL, cnnConnection, adOpenForwardOnly, adLockReadOnly
   If .RecordCount > 0 Then
      .MoveFirst
      Do While Not .EOF
         'P新申請案以齊備日+10個工作天管制待會稿
         'CFP新申請案以齊備日+23個工作天管制待會稿
         If (.Fields("cp01") = "P" Or .Fields("cp01") = "CFP") And _
            Not IsNull(.Fields("ep06")) And _
            Trim(.Fields("ep06")) <> "" Then
            If .Fields("cp01") = "P" Then
               strSC05 = CompWorkDay(10, .Fields("ep06"), 0)
            ElseIf .Fields("cp01") = "CFP" Then
               strSC05 = CompWorkDay(23, .Fields("ep06"), 0)
            End If
            stSQL = "update salescontroldate" & _
                                 " set SC05 = " & strSC05 & _
                            " where sc01='" & .Fields("sc01") & "'" & _
                                " and sc02=" & .Fields("sc02") & _
                                " and sc03=" & .Fields("sc03")
         Else
            stSQL = "delete from salescontroldate" & _
                         " where sc01='" & .Fields("sc01") & "'" & _
                             " and sc02=" & .Fields("sc02") & _
                             " and sc03=" & .Fields("sc03")
         End If
         cnnConnection.Execute stSQL, iRec
         .MoveNext
      Loop
   End If
   End With
End Sub
'Add by Morgan 2011/5/18
'會議室預約通知
Private Sub StrMenu22()
   Dim stSQL As String
   Dim stSubject As String, stContent As String, stTemp As String
   
On Error GoTo ErrHandle

'   Set cnnConnection = New ADODB.Connection
'   cnnConnection.ConnectionString = CnStr
'   cnnConnection.Open
   'Modified by Morgan 2015/8/18 +公務車9
   'Modified by Morgan 2015/8/24 +公務車改前一工作天通知(原用前一日曆天時星期一會在期日通知)
   'Modified by Lydia 2018/08/16 SUBSTRB=>SUBSTR
   'Modified by Morgan 2022/1/4 +mr06='Y'(可預約才通知)
   stSQL = "select mr02 C1,SUBSTR(sqldatet(rr02),1,10) C2,rr03,rr04,rr07,rr08,nvl(st14,rr07) RCP,st02,rr01,mr04" & _
      " from RoomReservation,MeetingRoom,staff" & _
      " where rr01<>9 and rr02=to_char(sysdate,'yyyymmdd') and rr05='N' and rr09 is null and rr18=0 and mr01(+)=rr01 and mr06='Y' and st01(+)=rr07" & _
      " Union" & _
      " select mr02 C1,SUBSTR(sqldatet(rr02),1,10) C2,rr03,rr04,rr07,rr08,nvl(st14,rr07) RCP,st02,rr01,mr04" & _
      " from RoomReservation,MeetingRoom,staff" & _
      " where rr01=9 and rr02>to_char(sysdate,'yyyymmdd') and workdayadd(-1,rr02-1)=to_char(sysdate,'yyyymmdd') and rr05='N' and rr09 is null and rr18=0 and mr01(+)=rr01 and mr06='Y' and st01(+)=rr07" & _
      " Union" & _
      " select mr02 C1,SUBSTR(sqldatet(rr02),1,10) C2,rr03,rr04,rr07,rr08,nvl(st14,rr07) RCP,st02,rr01,mr04" & _
      " from RoomResDetail,RoomReservation,MeetingRoom,staff" & _
      " where rd04=to_char(sysdate,'yyyymmdd')" & _
      " and rd05 is null and rr01(+)=rd01 and rr02(+)=rd02" & _
      " and rr03(+)=rd03 and rr09 is null and rr18=0 and mr01(+)=rr01 and mr06='Y' and st01(+)=rr07" & _
      " order by rr03"
   If Rs.State <> adStateClosed Then Rs.Close
   With Rs
   .CursorLocation = adUseClient
   .Open stSQL, cnnConnection, adOpenForwardOnly, adLockReadOnly
   If .RecordCount > 0 Then
      .MoveFirst
      Do While Not .EOF
         
         stTemp = "" & .Fields("rr08")
         If GetTextLength(stTemp) > 50 Then
            stTemp = PUB_StrToStr(stTemp, 47) & "..."
         End If
         'Modified by Morgan 2015/8/18
         If Val("" & .Fields("rr04")) = "1" Then
            stSubject = "使用通知"
            stContent = "會議室：" & .Fields("C1")
         Else
            stSubject = .Fields("C1") & "使用通知"
            stContent = ""
         End If
         stContent = stContent & vbCrLf & "日　期：" & .Fields("C2")
         stContent = stContent & vbCrLf & "時　間：" & Format(.Fields("rr03"), "00:00") & "-" & Format(.Fields("rr04"), "00:00")
         If Not IsNull(.Fields("st02")) Then
            stContent = stContent & vbCrLf & "預約人：" & .Fields("st02")
         End If
         stContent = stContent & vbCrLf & "使用單位(內容)：" & stTemp
         
         If Val("" & .Fields("rr01")) = 9 Then
            stContent = stContent & vbCrLf & vbCrLf & "附註： 若有變動請提早取消／變更預約，以免影響當週借車次數（前一天取消預約，不計次數）。"
         Else
            stContent = stContent & vbCrLf & vbCrLf & "附註： 若有變動請至會議室預約作業內進行異動。"
         End If
         'end 2015/8/18
         
         If Not IsNull(.Fields("RCP")) Then
            SendMAPIMail "" & .Fields("RCP"), stSubject, stContent, , "" & .Fields("st02")
         End If
         .MoveNext
      Loop
   End If
   End With
   
ErrHandle:
   If Err.Number <> 0 Then
      WLog "會議室預約提醒:" & Err.Description
   End If
   Set Rs = Nothing
'   Set cnnConnection = Nothing
   
End Sub

'Add by Morgan 2010/12/17
'代理人案件收達管制表(P601,605)
'Modified by Morgan 2019/1/29 +bolIsOurFMP
Private Function CreateFile14(ByVal p_RptDate As String, ByRef p_MailContent As String, Optional bolIsOurFMP As Boolean = False) As Boolean
   
   Dim stSQL As String
   Dim ff As Integer
   Dim strContent As String
   Dim tmpnext As String
   Dim stPID As String
   Dim lngRecs As Long
   Dim stFileName As String
   Dim iDays As Integer
   'Added by Morgan 2025/1/23
   Dim rsQuery As ADODB.Recordset
   Dim stVTB0 As String, mSeqNo As String, strPIDName As String, stMailList As String, strTitle As String
   Dim bolPNewRule As Boolean '非寰華案是否用新管制人規則
   'end 2025/1/23
   
   lngRecs = 0
   
On Error GoTo ErrHandle
   
   'Modified by Morgan 2019/1/29
   'stPID = Pub_GetSpecMan("A111") 'Added by Morgan 2018/4/10 改抓特殊設定--郭
   'Modified by Moran 2025/1/23
   'stPID = Pub_GetSpecMan(IIf(bolIsOurFMP, "寰華案外專程序窗口", "A111"))
   bolPNewRule = False
   If bolIsOurFMP Then
      strTitle = "FMP寰華案領證年費代理人收達管制表"
   Else
      strTitle = "P案領證年費代理人收達管制表"
      If strSrvDate(1) >= P業務區劃分啟用日 Then
         stPID = ""
         bolPNewRule = True
      Else
         stPID = Pub_GetSpecMan("A111")
      End If
   End If
   'end 2025/1/23
   'end 2019/1/29
   
   '到收達所限或進度檔法限前1個工作天
   'Modified by Lydia 2016/09/14 CP27=> CP158; CP57 IS NULL => CP159=0
   'Modified by Morgan 2019/1/29 外專FMP案獨立報表
   'Modified by Morgan 2024/3/21 寰華案改EMail給管制人--敏莉
   'Modifies by Lydia 2025/05/06 NA16改成NA79(FMP案管制人)
   stSQL = "SELECT ST02 C01" & _
      ",CP158-19110000 C02, CP05-19110000 C03, CP09 C04,CP01||'-'||CP02||'-'||CP03||'-'||CP04 C05" & _
      ",NVL(PA05,NVL(PA06,PA07)) C06,PTM03 C07,n1.NA03 C08" & _
      ",DECODE(PA09,'000',CPM03,CPM04) C09" & _
      ",DECODE(SK03,0,(NVL(f1.FA04,DECODE(f1.FA05,NULL,f1.FA06,f1.FA05||' '||f1.FA63||' '||f1.FA64||' '||f1.FA65)))" & _
      ",(NVL(f1.FA04,DECODE(f1.FA05,NULL,f1.FA06,f1.FA05||' '||f1.FA63||' '||f1.FA64||' '||f1.FA65)))) C10" & _
      "," & IIf(bolIsOurFMP, "n2.NA79", "'" & stPID & "'") & " PID" & _
      " FROM (select WORKDAYADD(2," & strSrvDate(1) & ") dd from dual),NEXTPROGRESS,CASEPROGRESS,PATENT,STAFF,SYSTEMKIND,CASEPROPERTYMAP,NATION n1,FAGENT f1,PATENTTRADEMARKMAP,fagent f2,nation n2" & _
      " WHERE NP02='P' AND NP06 IS NULL AND NP07='997'" & _
      " AND (NP08<=" & strSrvDate(1) & " or CP07<=dd)" & _
      " AND CP09(+)=NP01 AND CP10 IN ('601','605') AND CP158>0 AND CP24 IS NULL AND CP46 IS NULL AND CP47 IS NULL AND CP159=0" & _
      " AND PA01(+)=CP01 AND PA02(+)=CP02 AND PA03(+)=CP03 AND PA04(+)=CP04 AND PA57||PA108 IS NULL" & _
      " AND ST01(+)=CP14 AND SK01(+)=CP01 AND n1.NA01(+)=PA09" & IIf(bolIsOurFMP, " and ST03='F22'", " and ST03<>'F22'") & _
      " AND CPM01(+)=CP01 AND CPM02(+)=CP10" & _
      " AND PTM01(+)='1' AND PTM02(+)=PA08" & _
      " AND f1.FA01(+)=SUBSTR(CP44,1,8) AND f1.FA02(+)=SUBSTR(CP44,9,1) and f2.fa01(+)=substr(pa75,1,8) and f2.fa02(+)=substr(pa75,9) and n2.na01(+)=f2.fa10" & _
      " ORDER BY PID,1,2,3,4"
      
   If Rs.State <> adStateClosed Then Rs.Close
   Rs.CursorLocation = adUseClient
   Rs.Open stSQL, cnnConnection, adOpenForwardOnly, adLockReadOnly
   
   'Added by Morgan 2025/1/23
   If bolPNewRule Then
      If Rs.RecordCount > 0 Then
         Set rsQuery = PUB_CreateRecordset(Rs, , , 300, Me.Name, mSeqNo)
         With rsQuery
            .MoveFirst
            Do While Not .EOF
               .Fields("PID") = PUB_GetPHandler(.Fields("C05"))
               .MoveNext
            Loop
            .UpdateBatch
            
            stVTB0 = "select R001 as " & .Fields(0).Name
            For intI = 2 To .Fields.Count
               stVTB0 = stVTB0 & ", R" & Format(intI, "000") & " as " & .Fields(intI - 1).Name
            Next
            stVTB0 = stVTB0 & " from Rdatafactory Where Id='" & strUserNum & "' And Formname='" & Me.Name & "'  And Seqno='" & mSeqNo & "'"
         End With
         stSQL = "Select X.* From (" & stVTB0 & ") X ORDER BY PID,1,2,3,4"
         intI = 1
         Set Rs = ClsLawReadRstMsg(intI, stSQL)
      End If
   End If
   'end 2025/1/23
   
   With Rs
      If .RecordCount > 0 Then
         .MoveFirst
         'stPID = "" & .Fields("pid") 'Removed by Morgan 2018/4/10 改抓特殊設定--郭
         'Modified by Morgan 2025/1/23
         'If bolIsOurFMP Then stPID = "" & .Fields("pid") 'Added by Morgan 2024/3/21 寰華案改EMail給管制人
         stPID = "" & .Fields("pid")
         strPIDName = GetPIDName(stPID)
         stFileName = App.path & TextPath & strTitle & "(" & strPIDName & ").txt"
         'end 2025/1/23
         If ff > 0 Then Close #ff
         ff = FreeFile
         
         'Modified by Morgan 2019/1/29
         'stFileName = App.path & TextPath & "P案領證年費代理人收達管制表(" & stPID & ").txt"
         'stFileName = App.path & TextPath & IIf(bolIsOurFMP, "FMP寰華", "P") & "案領證年費代理人收達管制表(" & stPID & ").txt" 'Removed by Morgan 2025/1/23 改在上面設定
         'end 2019/1/29
         
         Open stFileName For Output As ff
         'Added by Lydia 2016/10/19 加報表抬頭
         'Modified by Morgan 2019/1/29
         'Print #ff, Space(40) & "P案領證年費代理人收達管制表(" & stPID & ")"
         'Modified by Morgan 2025/1/23
         'Print #ff, Space(40) & IIf(bolIsOurFMP, "FMP寰華", "P") & "案領證年費代理人收達管制表(" & stPID & ")"
         Print #ff, Space(40) & strTitle & "(" & strPIDName & ")"
         'end 2025/1/23
         'end 2019/1/29
         'end 2016/10/19
         Print #ff, ""
         Print #ff, "日期：" & p_RptDate
         Print #ff, ""
         Print #ff, "承辦人 發文日    收文日    收文號    本所案號        案件名稱                 種類   申請國家 案件性質   代理人    "
         Print #ff, "------ --------- --------- --------- --------------- ------------------------ ------ -------- ---------- ----------"
         tmpnext = "開檔中..."
         Do While Not .EOF
'Removed by Morgan 2018/4/10 改抓特殊設定--郭
            'Added by Morgan 2024/3/21
            'Modified by Morgan 2025/1/23
            'If bolIsOurFMP And stPID <> "" & .Fields("pid") Then
            If stPID <> "" & .Fields("pid") Then
            'end 2025/1/23
               Print #ff, "------ --------- --------- --------- --------------- ------------------------ ------ -------- ---------- ----------"
               Print #ff, "共" & lngRecs & "筆"
               Close ff
               
               'Modified by Morgan 2025/1/23
               'SendMAPIMail stPID, IIf(bolIsOurFMP, "FMP寰華", "P") & "案領證年費代理人收達管制表(" & p_RptDate & ")", p_MailContent, stFileName
               SendMAPIMail stPID, strTitle & "(" & p_RptDate & ")(" & strPIDName & ")", p_MailContent, stFileName
               'end 2025/1/23

               lngRecs = 0
               stPID = "" & .Fields("pid")
               'Modified by Morgan 2025/1/23
               'stFileName = App.path & TextPath & "FMP寰領證年費代理人收達管制表(" & stPID & ").txt"
               strPIDName = GetPIDName(stPID)
               stFileName = App.path & TextPath & strTitle & "(" & strPIDName & ").txt"
               'end 2025/1/23
               
               If ff > 0 Then Close #ff
               ff = FreeFile
               Open stFileName For Output As ff
                'Added by Lydia 2016/10/19 加報表抬頭
                'Modified by Morgan 2025/1/23
                'Print #ff, Space(40) & "FMP寰領證年費代理人收達管制表(" & stPID & ")"
                Print #ff, Space(40) & strTitle & "(" & strPIDName & ")"
                'end 2025/1/23
                'end 2016/10/19
               Print #ff, ""
               Print #ff, "日期：" & p_RptDate
               Print #ff, ""
               Print #ff, "承辦人 發文日    收文日    收文號    本所案號        案件名稱                 種類   申請國家 案件性質   代理人    "
               Print #ff, "------ --------- --------- --------- --------------- ------------------------ ------ -------- ---------- ----------"
            End If
            lngRecs = lngRecs + 1
            strContent = ""
            strContent = strContent & convForm("" & .Fields("C01"), 6) '承辦人
            strContent = strContent & " " & Format(.Fields("C02"), "@@@/@@/@@") '發文日
            strContent = strContent & " " & Format(.Fields("C03"), "@@@/@@/@@") '收文日
            strContent = strContent & " " & convForm(.Fields("C04"), 9) '收文號
            strContent = strContent & " " & convForm(.Fields("C05"), 15) '本所案號
            strContent = strContent & " " & convForm(.Fields("C06"), 24) '案件名稱
            strContent = strContent & " " & convForm(.Fields("C07"), 6) '種類
            strContent = strContent & " " & convForm(.Fields("C08"), 8) '申請國家
            strContent = strContent & " " & convForm(.Fields("C09"), 10) '案件性質
            strContent = strContent & " " & convForm(.Fields("C10"), 10) '代理人
            tmpnext = "寫檔..."
            Print #ff, strContent
            .MoveNext
         Loop
         Print #ff, "------ --------- --------- --------- --------------- ------------------------ ------ -------- ---------- ----------"
         Print #ff, "共" & lngRecs & "筆"
         Close ff
         'Modified by Morgan 2019/1/29
         'SendMAPIMail stPID, "P案領證年費代理人收達管制表(" & p_RptDate & ")", p_MailContent, stFileName
         'Modified by Morgan 2025/1/23
         'SendMAPIMail stPID, IIf(bolIsOurFMP, "FMP寰華", "P") & "案領證年費代理人收達管制表(" & p_RptDate & ")", p_MailContent, stFileName
         SendMAPIMail stPID, strTitle & "(" & p_RptDate & ")(" & strPIDName & ")", p_MailContent, stFileName
         'end 2025/1/23
         'end 2019/1/29
         
      End If
   End With
   CreateFile14 = True
   Set rsQuery = Nothing 'Added by Morgan 2025/1/23
   Exit Function
   
ErrHandle:
   WLog tmpnext & " " & Err.Description
   Set rsQuery = Nothing 'Added by Morgan 2025/1/23
End Function

'Add by Morgan 2011/4/25
'配合開庭尚未與法務案建立關聯案件清單
Private Function CreateFile15(ByVal p_RptDate As String, ByRef p_FileName As String) As Boolean
   
   Dim stSQL As String
   Dim ff As Integer
   Dim strContent As String
   Dim tmpnext As String
   Dim lngRecs As Long
   Dim stFileName As String
   
   p_FileName = ""
   lngRecs = 0
   
On Error GoTo ErrHandle

   'Modify by Morgan2011/5/17 +225(提供書狀意見)也要
   'Modified by Morgan 2018/10/16 收文日改抓3年內(原2年) P115775超過兩年未能處理需延長--游
   stSQL = "select cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) C1,cp09 C2,cu04 C3,sqldatet(cp05) C4,cpm03 C5" & _
      " From caseprogress, patent, customer,staff,casepropertymap where cp05>to_char(sysdate,'YYYYMMDD')-30000" & _
      " and cp01='P' and cp10 in ('225','226') and cp09<'B'" & _
      " and cp20||cp57 is null and nvl(cp16,0)=0 and not exists(select * from acc0n0 where a0n02=cp09)" & _
      " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04" & _
      " and cu01(+)=substr(pa26,1,8) and cu02(+)=substr(pa26,9)" & _
      " and st01(+)=cp13 and to_date(cp05,'yyyymmdd')<=sysdate-decode(st06,1,0,1)" & _
      " and cpm01(+)=cp01 and cpm02(+)=cp10 order by 1,2"
      
   If Rs.State <> adStateClosed Then Rs.Close
   With Rs
      .CursorLocation = adUseClient
      .Open stSQL, cnnConnection, adOpenForwardOnly, adLockReadOnly
      If .RecordCount > 0 Then
         .MoveFirst
         If ff > 0 Then Close #ff
         ff = FreeFile
         stFileName = App.path & TextPath & "配合開庭尚未與法務案建立關聯案件清單.txt"
         Open stFileName For Output As ff
         'Added by Lydia 2016/10/19 加報表抬頭
         Print #ff, Space(10) & "配合開庭尚未與法務案建立關聯案件清單"
         'end 2016/10/19
         Print #ff, ""
         Print #ff, "日期：" & p_RptDate
         Print #ff, ""
         Print #ff, "本所案號        收文日     收文號     案件性質     申請人                  "
         Print #ff, "--------------- ---------- ---------- ------------ ------------------------"
         
         tmpnext = "開檔中..."
         Do While Not .EOF
            lngRecs = lngRecs + 1
            strContent = ""
            strContent = strContent & convForm(.Fields("C1"), 15) '本所案號
            strContent = strContent & " " & convForm(.Fields("C4"), 10) '本所案號
            strContent = strContent & " " & convForm(.Fields("C2"), 10)  '收文號
            strContent = strContent & " " & convForm(.Fields("C5"), 12)  '收文號
            strContent = strContent & " " & convForm(.Fields("C3"), 24) '申請人
            tmpnext = "寫檔..."
            Print #ff, strContent
            .MoveNext
         Loop
         Print #ff, "--------------- ---------- ---------- ------------ ------------------------"
         Print #ff, "共" & lngRecs & "筆"
         Print #ff, ""
         Print #ff, "若有收文號無需提醒可請程序或電腦中心人員設定該筆進度之 [是否向客戶請款] 欄位為 [N]。"
         
         Close ff
         p_FileName = stFileName
      End If
   End With
   CreateFile15 = True
   Exit Function
   
ErrHandle:
   WLog tmpnext & " " & Err.Description

End Function

'Removed by Morgan 2014/12/10 不再使用
''Add by Morgan 2012/3/21
''CFP答辯提申管制表
'Private Function CreateFile16(ByVal p_RptDate As String, ByRef p_FileName As String) As Boolean
'
'   Dim stSQL As String
'   Dim stVTB As String
'   Dim stPID As String
'   Dim ff As Integer
'   Dim strContent As String
'   Dim tmpnext As String
'   Dim lngRecs As Long
'   Dim stFileName As String
'
'   p_FileName = ""
'   lngRecs = 0
'
'On Error GoTo ErrHandle
'
'  '已發文無結果未提申法限前3個工作天
'  stVTB = "select * from caseprogress a,patent" & _
'      " Where cp07>to_char(sysdate-180,'yyyymmdd') And cp07 <= WORKDAYADD(4," & strSrvDate(1) & ")" & _
'      " and cp01||cp10='CFP107' and cp27>0 and cp24||cp47||cp57 is null" & _
'      " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04" & _
'      " and pa57 is null"
'
'   stSQL = "SELECT ST02 C01,SQLDATET2(CP27) C02,SQLDATET2(CP07) C03" & _
'      ",CP09 C04,CP01||'-'||CP02||decode(CP03||CP04,'000','','-'||CP03||'-'||CP04) C05" & _
'      ",NVL(PA05,NVL(PA06,PA07)) C06,PTM03 C07,NA03 C08,DECODE(PA09,'000',CPM03,CPM04) C09" & _
'      ",DECODE(SK03,0,(NVL(FA04,DECODE(FA05,NULL,FA06,FA05||' '||FA63||' '||FA64||' '||FA65)))" & _
'      ",(NVL(FA04,DECODE(FA05,NULL,FA06,FA05||' '||FA63||' '||FA64||' '||FA65)))) C10" & _
'      ",sqldatet2(CP46) C11," & GetCaseIdSQL() & " PID" & _
'      " FROM (" & stVTB & ") X,nation,STAFF,SYSTEMKIND,CASEPROPERTYMAP,FAGENT,PATENTTRADEMARKMAP,NATION" & _
'      " Where na01(+)=pa09 and ST01(+)=CP14 AND SK01(+)=CP01 AND CPM01(+)=CP01" & _
'      " AND CPM02(+)=CP10 AND PTM01(+)='1' AND PTM02(+)=PA08" & _
'      " AND FA01(+)=SUBSTR(CP44,1,8) AND FA02(+)=SUBSTR(CP44,9,1) AND NA01(+)=PA09 ORDER BY PID,1,2,3,4"
'
'   If rs.State <> adStateClosed Then rs.Close
'   With rs
'      .CursorLocation = adUseClient
'      .Open stSQL, cnnConnection, adOpenForwardOnly, adLockReadOnly
'      If .RecordCount > 0 Then
'         .MoveFirst
'         stPID = "" & .Fields("pid")
'         If ff > 0 Then Close #ff
'         ff = FreeFile
'         stFileName = App.path & TextPath & "CFP答辯提申管制表(" & GetPIDName(stPID) & ").txt"
'         Open stFileName For Output As ff
'         Print #ff, ""
'         Print #ff, "日期：" & p_RptDate
'         Print #ff, ""
'         Print #ff, "承辦人 發文日    法定期限  收文號    本所案號        案件名稱       種類   申請國家 案件性質   代理人     收達日   "
'         Print #ff, "------ --------- --------- --------- --------------- -------------- ------ -------- ---------- ---------- ---------"
'
'         tmpnext = "開檔中..."
'
'         Do While Not .EOF
'            If stPID <> "" & .Fields("pid") Then
'               Print #ff, "------ --------- --------- --------- --------------- -------------- ------ -------- ---------- ---------- ---------"
'               Print #ff, "共" & lngRecs & "筆"
'               Close ff
'               p_FileName = p_FileName & stFileName & ";"
'
'               lngRecs = 0
'               stPID = "" & .Fields("pid")
'               If ff > 0 Then Close #ff
'               ff = FreeFile
'               stFileName = App.path & TextPath & "CFP答辯提申管制表(" & GetPIDName(stPID) & ").txt"
'               Open stFileName For Output As ff
'               Print #ff, ""
'               Print #ff, "日期：" & p_RptDate
'               Print #ff, ""
'               Print #ff, "承辦人 發文日    法定期限  收文號    本所案號        案件名稱       種類   申請國家 案件性質   代理人     收達日   "
'               Print #ff, "------ --------- --------- --------- --------------- -------------- ------ -------- ---------- ---------- ---------"
'            End If
'            lngRecs = lngRecs + 1
'            strContent = convForm("" & .Fields("C01"), 6)  '承辦人
'            strContent = strContent & " " & convForm("" & .Fields("C02"), 9) '發文日
'            strContent = strContent & " " & convForm("" & .Fields("C03"), 9) '法定期限
'            strContent = strContent & " " & convForm("" & .Fields("C04"), 9) '收文號
'            strContent = strContent & " " & convForm("" & .Fields("C05"), 15) '本所案號
'            strContent = strContent & " " & convForm("" & .Fields("C06"), 14) '案件名稱
'            strContent = strContent & " " & convForm("" & .Fields("C07"), 6) '種類
'            strContent = strContent & " " & convForm("" & .Fields("C08"), 8) '申請國家
'            strContent = strContent & " " & convForm("" & .Fields("C09"), 10) '案件性質
'            strContent = strContent & " " & convForm("" & .Fields("C10"), 10) '代理人
'            strContent = strContent & " " & convForm("" & .Fields("C11"), 9) '收達日
'            tmpnext = "寫檔..."
'            Print #ff, strContent
'            .MoveNext
'         Loop
'         Print #ff, "------ --------- --------- --------- --------------- -------------- ------ -------- ---------- ---------- ---------"
'         Print #ff, "共" & lngRecs & "筆"
'         Close ff
'         p_FileName = p_FileName & stFileName
'      End If
'   End With
'   CreateFile16 = True
'   Exit Function
'
'ErrHandle:
'   WLog tmpnext & " " & Err.Description
'End Function

'Added by Morgan 2012/3/21
'EPC檢索報告來函管制表,每6個月(180天)跑一次
'Modified by Morgan 2024/12/4 +管制EPC檢索報告公開1238,每1個月(30天)跑一次
Private Function CreateFile17(ByVal p_RptDate As String, ByRef p_FileName As String, Optional p_PS As String) As Boolean
   
   Dim stSQL As String
   Dim ff As Integer
   Dim strContent As String
   Dim tmpnext As String
   Dim lngRecs As Long
   Dim stFileName As String
   Dim stCFPMailList As String, strText As String, stPID As String, strPIDName As String 'Added by Morgan 2017/10/31
   Dim rsQuery As ADODB.Recordset 'Added by Morgan 2020/2/21
   Dim mSeqNo As String 'Added by Lydia 2021/07/09
   
   p_FileName = ""
   lngRecs = 0
   
On Error GoTo ErrHandle
   'Modified by Lydia 2016/09/14 CP27=>CP158 ; CP57 IS NULL => CP159=0
   'Modified by Lydia 2018/08/16 SUBSTRB=>SUBSTR
   'Modified by Morgan 2024/12/4 +NP07
   stSQL = "SELECT SUBSTR(LPAD(SQLDATET(NP08),9,' '),1,9) C01" & _
      ",SUBSTR(LPAD(SQLDATET(CP158),9,' '),1,9) C02" & _
      ",cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) C03" & _
      ",SUBSTR(NVL(PA05,NVL(PA06,PA07)),1,20) C04" & _
      ",SUBSTR(PTM03,1,6) C05" & _
      ",SUBSTR(DECODE(PA09,'000',CPM03,CPM04),1,10) C06" & _
      ",SUBSTR(NA03,1,10) C07" & _
      ",SUBSTR(DECODE(SK03,0,(NVL(FA04,DECODE(FA05,NULL,FA06,FA05||' '||FA63||' '||FA64||' '||FA65)))" & _
      ",(NVL(FA04,DECODE(FA05,NULL,FA06,FA05||' '||FA63||' '||FA64||' '||FA65)))),1,20) C08" & _
      ",SUBSTR(ST02,1,6) C09,decode(mod(pa02,2),1,na73,na74) PID,NP07" & _
      " From (SELECT NP07,NP08,CP01,CP02,CP03,CP04,CP10,CP14,CP158,CP44 FROM NEXTPROGRESS,CASEPROGRESS,PATENT" & _
      " WHERE NP02='CFP' AND NP07='1209' AND NP06 IS NULL AND CP09(+)=NP01 AND CP158>0 AND CP159=0" & _
      " AND PA01(+)=CP01 AND PA02(+)=CP02 AND PA03(+)=CP03 AND PA04(+)=CP04 AND PA09='221' AND PA57||PA108 IS NULL" & _
      " AND NP08<=" & strSrvDate(1) & " AND MOD(TO_DATE(" & strSrvDate(1) & ",'YYYYMMDD')-TO_DATE(NP08,'YYYYMMDD'),180)=0" & _
      " union SELECT NP07,NP08,CP01,CP02,CP03,CP04,CP10,CP14,CP158,CP44 FROM NEXTPROGRESS,CASEPROGRESS,PATENT" & _
      " WHERE NP02='CFP' AND NP07='1238' AND NP06 IS NULL AND CP09(+)=NP01 AND CP159=0" & _
      " AND PA01(+)=CP01 AND PA02(+)=CP02 AND PA03(+)=CP03 AND PA04(+)=CP04 AND PA09='221' AND PA57||PA108 IS NULL" & _
      " AND NP08<=" & strSrvDate(1) & " AND MOD(TO_DATE(" & strSrvDate(1) & ",'YYYYMMDD')-TO_DATE(NP08,'YYYYMMDD'),30)=0" & _
      ") X,PATENT,CASEPROPERTYMAP,NATION,SYSTEMKIND,FAGENT,STAFF,PATENTTRADEMARKMAP" & _
      " WHERE PA01(+)=CP01 AND PA02(+)=CP02 AND PA03(+)=CP03 AND PA04(+)=CP04 AND PA57 IS NULL AND PA108 IS NULL" & _
      " AND CPM01(+)=CP01 AND CPM02(+)=CP10 AND NA01(+)=PA09 AND SK01(+)=CP01" & _
      " AND FA01(+)=SUBSTR(CP44,1,8) AND FA02(+)=SUBSTR(CP44,9,1) AND ST01(+)=CP14" & _
      " AND PTM01(+)='1' AND PTM02(+)=PA08 ORDER BY PID,1,2,3,5"

   'Modified by Morgan 2020/2/21 CFP管制人 109/4/1以後改業務區劃分
   'If rs.State <> adStateClosed Then rs.Close
   'With rs
   '   .CursorLocation = adUseClient
   '   .Open stSQL, cnnConnection, adOpenForwardOnly, adLockReadOnly
   intI = 1
   Set Rs = ClsLawReadRstMsg(intI, stSQL)
   If strSrvDate(1) >= 20200401 Then
      If intI = 1 Then
         'Modified by Lydia 2021/07/09 取得序號mSeqNo
         Set rsQuery = PUB_CreateRecordset(Rs, , , 300, Me.Name, mSeqNo)
         With rsQuery
         .MoveFirst
         Do While Not .EOF
            .Fields("PID") = PUB_GetCFPHandler(.Fields("C03"))
            .MoveNext
         Loop
         .UpdateBatch 'Added by Lydia 2021/07/09
         '.Sort = "PID,C01,C02,C03,C05"  'Remove by Lydia 2021/07/09
         End With
         'Added by Lydia 2021/07/09 重新查詢; 因為出現錯誤「無法在其定義長度是不明或過長的資料行執行 Relate、Compute By、及 Sort 操作。」
         strSql = "Select R001 As C01,R002 As C02, R003 As C03, R004 As C04,R005 As C05,R006 As C06, R007 As C07, R008 As C08, R009 As C09, R010 AS PID, R011 AS NP07 " & _
                     "From Rdatafactory Where Id='" & strUserNum & "' And Formname='" & Me.Name & "'  And Seqno='" & mSeqNo & "' " & _
                     "ORDER BY PID,C01,C02,C03,C05 "
         intI = 1
         Set rsQuery = ClsLawReadRstMsg(intI, strSql)
         'end 2021/07/09
      Else
         Set rsQuery = Rs
      End If
   Else
      Set rsQuery = Rs
   End If
   With rsQuery
   'end 2020/2/21
      If .RecordCount > 0 Then
         .MoveFirst
         stPID = "" & .Fields("pid") 'Added by Morgan 2017/10/31
         strPIDName = GetPIDName(stPID) 'Added by Morgan 2017/10/31
         If ff > 0 Then Close #ff
         ff = FreeFile
         stFileName = App.path & TextPath & "EPC檢索報告來函管制表(" & strPIDName & ").txt"
         Open stFileName For Output As ff
         'Added by Lydia 2016/10/19 加報表抬頭
         Print #ff, Space(35) & "EPC檢索報告/檢索報告公開來函管制表"
         'end 2016/10/19
         Print #ff, ""
         Print #ff, "日期：" & p_RptDate & "   (檢索報告每隔 180 天循環管制，檢索報告公開每隔 30 天循環管制)"
         Print #ff, ""
         'Modified by Morgan 2024/12/4
         'Print #ff, "管制期限  發文日    承辦人 本所案號        案件名稱             種類   案件性質   申請國家   代理人"
         'Print #ff, "--------- --------- ------ --------------- -------------------- ------ ---------- ---------- --------------------"
         Print #ff, "管制期限  管制性質     發文日    承辦人 本所案號        案件名稱             種類   案件性質   申請國家   代理人"
         Print #ff, "--------- ------------ --------- ------ --------------- -------------------- ------ ---------- ---------- --------------------"
         'end 2024/12/4
         
         tmpnext = "開檔中..."
         
         .MoveFirst
         Do While Not .EOF
            'Added by Morgan 2017/11/1
            If stPID <> "" & .Fields("pid") Then
               'Modified by Morgan 2024/12/4
               'Print #ff, "--------- --------- ------ --------------- -------------------- ------ ---------- ---------- --------------------"
               Print #ff, "--------- ------------ --------- ------ --------------- -------------------- ------ ---------- ---------- --------------------"
               'end 2024/12/4
               Print #ff, "共" & lngRecs & "筆"
               Close ff
               p_FileName = p_FileName & stFileName & ";"
               
               strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & _
                  "EPC檢索報告來函管制表(" & p_RptDate & ")(" & strPIDName & ") 資料如附件！" & _
                  vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & p_PS
               SendMAPIMail stPID, "EPC檢索報告來函管制表(" & p_RptDate & ")(" & strPIDName & ")", strText, stFileName
               stCFPMailList = stCFPMailList & stPID & ";"
               
               lngRecs = 0
               stPID = "" & .Fields("pid")
               strPIDName = GetPIDName(stPID)
               If ff > 0 Then Close #ff
               ff = FreeFile
               stFileName = App.path & TextPath & "EPC檢索報告來函管制表(" & strPIDName & ").txt"
               Open stFileName For Output As ff
               Print #ff, Space(35) & "EPC檢索報告/檢索報告公開來函管制表"
               Print #ff, ""
               Print #ff, "日期：" & p_RptDate & "   (檢索報告每隔 180 天循環管制，檢索報告公開每隔 30 天循環管制)"
               Print #ff, ""
               
               'Modified by Morgan 2024/12/4
               'Print #ff, "管制期限  發文日    承辦人 本所案號        案件名稱             種類   案件性質   申請國家   代理人"
               'Print #ff, "--------- --------- ------ --------------- -------------------- ------ ---------- ---------- --------------------"
               Print #ff, "管制期限  管制性質     發文日    承辦人 本所案號        案件名稱             種類   案件性質   申請國家   代理人"
               Print #ff, "--------- ------------ --------- ------ --------------- -------------------- ------ ---------- ---------- --------------------"
               'end 2024/12/4
         
               tmpnext = "開檔中..."
            End If
            'end 2017/11/1
            
            lngRecs = lngRecs + 1
            strContent = Empty
            strContent = strContent & convForm("" & .Fields("C01"), 9) '催審期限
            'Added by Morgan 2024/12/4 '管制性質
            If .Fields("NP07") = "1209" Then
               strContent = strContent & " 檢索報告    "
            Else
               strContent = strContent & " 檢索報告公開"
            End If
            'end 2024/12/4
            strContent = strContent & " " & convForm("" & .Fields("C02"), 9) '發文日
            strContent = strContent & " " & convForm("" & .Fields("C09"), 6) '承辦人
            strContent = strContent & " " & convForm("" & .Fields("C03"), 15) '本所案號
            strContent = strContent & " " & convForm("" & .Fields("C04"), 20) '案件名稱
            strContent = strContent & " " & convForm("" & .Fields("C05"), 6) '種類
            strContent = strContent & " " & convForm("" & .Fields("C06"), 10) '案件性質
            strContent = strContent & " " & convForm("" & .Fields("C07"), 10) '申請國家
            strContent = strContent & " " & convForm("" & .Fields("C08"), 20) '代理人
            
            tmpnext = "寫檔..."
            Print #ff, strContent
            .MoveNext
         Loop
         'Modified by Morgan 2024/12/4
         'Print #ff, "--------- --------- ------ --------------- -------------------- ------ ---------- ---------- --------------------"
         Print #ff, "--------- ------------ --------- ------ --------------- -------------------- ------ ---------- ---------- --------------------"
         'end 2024/12/4
         Print #ff, "共" & lngRecs & "筆"
         Close ff
         p_FileName = p_FileName & stFileName
         
         strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & _
            "EPC檢索報告/檢索報告公開來函管制表(" & p_RptDate & ")(" & strPIDName & ") 資料如附件！" & _
            vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & p_PS
         SendMAPIMail stPID, "EPC檢索報告/檢索報告公開來函管制表(" & p_RptDate & ")(" & strPIDName & ")", strText, stFileName
         stCFPMailList = stCFPMailList & stPID & ";"
      End If
   End With
   
   'Added by Morgan 2017/11/1
   stSQL = "select na73 from nation where na01='221' union select na74 from nation where na01='221' order by 1"
   'Added by Morgan 2020/2/21
   If strSrvDate(1) >= 20200401 Then
      stSQL = "select distinct a0916 from acc090 order by 1"
   End If
   'end 2020/2/21
   If Rs.State <> adStateClosed Then Rs.Close
   With Rs
   .CursorLocation = adUseClient
   .Open stSQL, cnnConnection, adOpenForwardOnly, adLockReadOnly
   If .RecordCount > 0 Then
      Do While Not .EOF
         If Not IsNull(.Fields(0)) Then
            stPID = .Fields(0)
            If InStr(stCFPMailList, stPID) = 0 Then
               strPIDName = GetPIDName(stPID)
               strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & _
                  "EPC檢索報告/檢索報告公開來函管制表(" & p_RptDate & ")(" & strPIDName & ") 無需管制資料！" & _
                  vbCrLf & vbCrLf & String(25, "　") & "電腦中心"
               SendMAPIMail stPID, "EPC檢索報告/檢索報告公開來函管制表(" & p_RptDate & ")(" & strPIDName & ")", strText
            End If
         End If
         .MoveNext
      Loop
   End If
   End With
   'end 2017/11/1
   
   CreateFile17 = True
   Set rsQuery = Nothing 'Added by Morgan 2020/2/21
   Exit Function
   
ErrHandle:
   WLog tmpnext & " " & Err.Description
   Set rsQuery = Nothing 'Added by Morgan 2020/2/21
End Function

'Added by Morgan 2012/3/21
'TW-SUPA每月期限報表
'Modified by Morgan 2013/5/28 案件性質改抓 434 TW-SUPA(原抓431)
Private Function CreateFile18(ByVal p_RptDate As String, ByRef p_FileName As String) As Boolean
   
   Dim stSQL As String, stVTB As String, strCpCon As String
   Dim stYrMn As String
   Dim ff As Integer
   Dim strContent As String
   Dim tmpnext As String
   Dim lngRecs As Long
   Dim stFileName As String
   
   p_FileName = ""
   lngRecs = 0
   
On Error GoTo ErrHandle

   stYrMn = Left(CompDate(1, -1, strSrvDate(1)), 6)
   'Modified by Morgan 2022/4/19 美國案改抓提申日6個月內都列，但非本所台灣案件則維持不變 --玲玲
   'strCPCon = " and cp27>=" & stYrMn & "01 and cp27<=" & stYrMn & "31"
   strCpCon = " and cp47>" & CompDate(1, -6, strSrvDate(1))
   'end 2022/4/19
   
   '本所申請台灣案
   'Modified by Lydia 2018/08/16 SUBSTRB=>SUBSTR
   'Modified by Morgan 2019/7/5 排除美國案或台灣案已閉卷
   'Modified by Morgan 2021/5/12 +日本案--玲玲
   'Modified by Morgan 2022/4/19 +排除1.已通知過TW-SPUA的案件 2.有被主張國內優先權者 Ex:P-124871 --陳玲玲
   'Modified by Morgan 2022/9/6 台灣案不能有主張國際優先權(有收文或有優先權資料都算) Ex:P128982 --郭
   'Modified by Morgan 2025/7/10 +法國--玲玲
   stVTB = " select 1 SRC,pd01,pd02,pd03,pd04,pd06,p1.pa26,p1.pa10,cp13,cp27" & _
      ",p2.pa01||'-'||p2.pa02||DECODE(p2.pa03||p2.pa04,'000','',p2.pa03||p2.pa04) TWNO,p1.pa09" & _
      " from caseprogress,patent p1,pridate,patent p2" & _
      " where cp01='CFP' and cp10='101'" & strCpCon & _
      " and p1.pa01(+)=cp01 and p1.pa02(+)=cp02 and p1.pa03(+)=cp03 and p1.pa04(+)=cp04 and p1.pa09 in ('101','011','203') and p1.pa57||p1.pa108 is null" & _
      " and pd01(+)=cp01 and pd02(+)=cp02 and pd03(+)=cp03 and pd04(+)=cp04 and pd07='000'" & _
      " and substr(pd06,1,1)<>'P'  AND SUBSTR(PD06,4,1)='1'" & _
      " and p2.pa11(+)=pd06 and p2.pa16 is null and p2.pa11 is not null and p2.pa57||p2.pa108 is null" & _
      " AND NOT EXISTS(SELECT * FROM CASEPROGRESS C2 WHERE C2.CP01=P2.PA01 AND C2.CP02=P2.PA02" & _
      " AND C2.CP03=P2.PA03 AND C2.CP04=P2.PA04 AND C2.CP10 IN ('434','106') AND C2.CP57 IS NULL)" & _
      " AND NOT EXISTS(SELECT * FROM CASEPROGRESS C2 WHERE C2.CP01=P2.PA01 AND C2.CP02=P2.PA02" & _
      " AND C2.CP03=P2.PA03 AND C2.CP04=P2.PA04 AND C2.CP10 in ('1202','1915'))" & _
      " and EXISTS(SELECT * FROM CASEPROGRESS C2 WHERE C2.CP01=P2.PA01 AND C2.CP02=P2.PA02" & _
      " AND C2.CP03=P2.PA03 AND C2.CP04=P2.PA04 AND C2.CP10='1204')" & _
      " AND NOT EXISTS(SELECT * FROM PRIDATE WHERE PD01=P2.PA01 AND PD02=P2.PA02 AND PD03=P2.PA03 AND PD04=P2.PA04 AND PD07<>'000')"
   '中間接來台灣案
   'Modified by Lydia 2018/08/16 SUBSTRB=>SUBSTR
   stVTB = stVTB & " Union " & _
      " select 2 SRC,pd01,pd02,pd03,pd04,pd06,p1.pa26,p1.pa10,cp13,cp27" & _
      ",p2.pa01||'-'||p2.pa02||DECODE(p2.pa03||p2.pa04,'000','',p2.pa03||p2.pa04) TWNO,p1.pa09" & _
      " from caseprogress,patent p1,pridate,patent p2" & _
      " where cp01='CFP' and cp10='101'" & strCpCon & _
      " and p1.pa01(+)=cp01 and p1.pa02(+)=cp02 and p1.pa03(+)=cp03 and p1.pa04(+)=cp04 and p1.pa09 in ('101','011','203') and p1.pa57||p1.pa108 is null" & _
      " and pd01(+)=cp01 and pd02(+)=cp02 and pd03(+)=cp03 and pd04(+)=cp04 and pd07='000'" & _
      " and substr(pd06,1,1)<>'P'  AND SUBSTR(PD06,4,1)='1'" & _
      " and p2.pa11(+)=pd06 and p2.pa16 is null and p2.pa11 is not null and p2.pa57||p2.pa108 is null" & _
      " AND NOT EXISTS(SELECT * FROM CASEPROGRESS C2 WHERE C2.CP01=P2.PA01 AND C2.CP02=P2.PA02" & _
      " AND C2.CP03=P2.PA03 AND C2.CP04=P2.PA04 AND C2.CP10 IN ('434','106') AND C2.CP57 IS NULL)" & _
      " AND NOT EXISTS(SELECT * FROM CASEPROGRESS C2 WHERE C2.CP01=P2.PA01 AND C2.CP02=P2.PA02" & _
      " AND C2.CP03=P2.PA03 AND C2.CP04=P2.PA04 AND C2.CP10 in ('1202','1915'))" & _
      " and NOT EXISTS(SELECT * FROM CASEPROGRESS C2 WHERE C2.CP01=P2.PA01 AND C2.CP02=P2.PA02" & _
      " AND C2.CP03=P2.PA03 AND C2.CP04=P2.PA04 AND C2.CP10='1204')" & _
      " and not exists (select * from caseprogress c2 where c2.cp01=p2.pa01 and c2.cp02=p2.pa02" & _
      " and c2.cp03=p2.pa03 and c2.cp04=p2.pa04 and c2.cp10='101' and cp09<'B')" & _
      " AND NOT EXISTS(SELECT * FROM PRIDATE WHERE PD01=P2.PA01 AND PD02=P2.PA02 AND PD03=P2.PA03 AND PD04=P2.PA04 AND PD07<>'000')"
   '非本所台灣案
   'Modified by Lydia 2018/08/16 SUBSTRB=>SUBSTR
   stVTB = stVTB & " Union " & _
      " select 3 SRC,pd01,pd02,pd03,pd04,pd06,pa26,pa10,cp13,cp27" & _
      ",'' TWNO,p1.pa09" & _
      " from caseprogress,patent p1,pridate" & _
      " where cp01='CFP' and cp27>=" & stYrMn & "01 and cp27<=" & stYrMn & "31 and cp10='101'" & _
      " and p1.pa01(+)=cp01 and p1.pa02(+)=cp02 and p1.pa03(+)=cp03 and p1.pa04(+)=cp04 and p1.pa09 in ('101','011','203')" & _
      " and pd01(+)=cp01 and pd02(+)=cp02 and pd03(+)=cp03 and pd04(+)=cp04 and pd07='000'" & _
      " and substr(pd06,1,1)<>'P'  AND SUBSTR(PD06,4,1)='1'" & _
      " and not exists(select * from patent p2 where p2.pa11=pd06)"
   'Modified by Lydia 2018/08/16 SUBSTRB=>SUBSTR
   'Modified by Morgan 2022/4/19 +排除1.已通知過TW-SPUA的案件 2.有被主張國內優先權者 Ex:P-124871 --陳玲玲
   stSQL = "select Decode(SRC,1,'本所申請',2,'中間來所',3,'非本所') 台灣案" & _
      ",PD01||'-'||PD02||DECODE(PD03||PD04,'000','',PD03||PD04) CFP案號" & _
      ",TWNO 台灣案號" & _
      ",PD06 優先權號" & _
      ",CU04 申請人" & _
      ",SUBSTR(SQLDATET(PA10),1,10) 美日申請日" & _
      ",ST02 智權人員" & _
      ",substr(sqldatet(cp27),1,10) 美日發文日,na03 申請國家" & _
      " from (" & stVTB & ") x,CUSTOMER,STAFF,nation" & _
      " where CU01(+)=SUBSTR(PA26,1,8) AND CU02(+)=SUBSTR(PA26,9)" & _
      " AND ST01(+)=CP13 and na01(+)=pa09" & _
      " and not exists(select * From pridate a,patent b where pd06=x.pd06" & _
      " and pa01(+)=pd01 and pa02(+)=pd02 and pa03(+)=pd03 and pa04(+)=pd04 and pa09='000')" & _
      " order by src,st15,cp13,pd01,pd02,pd03,pd04"
      
   If Rs.State <> adStateClosed Then Rs.Close
   With Rs
      .CursorLocation = adUseClient
      .Open stSQL, cnnConnection, adOpenForwardOnly, adLockReadOnly
      If .RecordCount > 0 Then
         .MoveFirst
         If ff > 0 Then Close #ff
         ff = FreeFile
         stFileName = App.path & TextPath & "TW-SUPA每月期限報表.txt"
         Open stFileName For Output As ff
         'Added by Lydia 2016/10/19 加報表抬頭
         Print #ff, Space(35) & "TW-SUPA每月期限報表"
         'end 2016/10/19
         Print #ff, ""
         Print #ff, "日期：" & p_RptDate & "   (每月 5 號執行一次)"
         Print #ff, ""
         Print #ff, "台灣案   CFP案號         申請國家 台灣案號        優先權號     申請人               CFP申請日  智權人員 CFP發文日"
         Print #ff, "-------- --------------- -------- --------------- ------------ -------------------- ---------- -------- ----------"
         
         tmpnext = "開檔中..."
         
         .MoveFirst
         Do While Not .EOF
            lngRecs = lngRecs + 1
            strContent = Empty
            strContent = strContent & convForm("" & .Fields(0), 8) '台灣案
            strContent = strContent & " " & convForm("" & .Fields(1), 15) 'CFP案號
            strContent = strContent & " " & convForm("" & .Fields(8), 8)  '申請國家
            strContent = strContent & " " & convForm("" & .Fields(2), 15) '台灣案號
            strContent = strContent & " " & convForm("" & .Fields(3), 12) '優先權號
            strContent = strContent & " " & convForm("" & .Fields(4), 20) '申請人
            strContent = strContent & " " & convForm("" & .Fields(5), 10) '美專申請日
            strContent = strContent & " " & convForm("" & .Fields(6), 8)  '智權人員
            strContent = strContent & " " & convForm("" & .Fields(7), 10) '美專發文日
            
            tmpnext = "寫檔..."
            Print #ff, strContent
            .MoveNext
         Loop
         Print #ff, "-------- --------------- -------- --------------- ------------ -------------------- ---------- -------- ----------"
         Print #ff, "共" & lngRecs & "筆"
         Print #ff, ""
         Print #ff, "PS.台灣案欄位分別有三種態樣：1.本所申請,2.中間來所,3.非本所。"
         Close ff
         p_FileName = p_FileName & stFileName
      End If
   End With
   CreateFile18 = True
   Exit Function
   
ErrHandle:
   WLog tmpnext & " " & Err.Description
End Function

'Add By Sindy 2011/9/6 檢查每月出缺勤統計是否有未確認的資料
'出缺勤統計3個工作天後開始檢查...
Sub StrMenu24()
Dim ff As Integer
Dim A01 As String
Dim A02 As String
Dim A03 As String
Dim A04 As String
Dim iCount As Integer
Dim TempFileName As String
Dim TempSendMailSeek As String
Dim tmpnext As String
Dim ChkDate As String, strToM21 As String, strYM As String
Dim intB1303Seqno As Integer, strB1303 As String
Dim bolUpdStar As Boolean
Dim SendMailTo As Variant

On Error GoTo DebugErr

'   tmpnext = "準備連資料庫..."
'   Set cnnConnection = New ADODB.Connection
'   cnnConnection.ConnectionString = CnStr
'   cnnConnection.Open
   TempFileName = ""
   bolUpdStar = False

   ChkDate = CompWorkDay(4, strSrvDate(1), 1) '3個工作天後

   '人事室出缺勤電子簽核收E-Mail人員
   strToM21 = Pub_GetSpecMan("人事室出缺勤電子簽核")
   'Added by Lydia 2023/12/22
   If ChkDate >= 新部門啟用日 Then
      strSql = "select B1301,B1314,NVL(ST93,ST03) ST03,NVL(A0922,A0902) A0902,B1302,ST02,B1303 " & _
               "from ABS013,Staff,ACC090, ACC090NEW " & _
               "where B1301='04' and B1302=ST01(+) and ST03=A0901(+) AND ST93=A0921(+) " & _
               "and B1309<=" & ChkDate & _
               " order by ST03,ST01 "
   Else
   'end 2023/12/22
      strSql = "select B1301,B1314,ST03,A0902,B1302,ST02,B1303 " & _
               "from ABS013,Staff,ACC090 " & _
               "where B1301='04' and B1302=ST01(+) and ST03=A0901(+) " & _
               "and B1309<=" & ChkDate & _
               " order by ST03,ST01 "
   End If

CheckOC
Set Rs = New ADODB.Recordset
Rs.CursorLocation = adUseClient
Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
tmpnext = "已取得資料..."
TempSendMailSeek = ""
'Add By Sindy 2020/8/31
If Dir(App.path & TextPath & "*月出缺勤統計尚未確認的資料清單*.txt") <> "" Then
   Kill App.path & TextPath & "*月出缺勤統計尚未確認的資料清單*.txt"
End If
'2020/8/31 END
With Rs
   If .RecordCount > 0 Then
      .MoveFirst
      ff = FreeFile
      strYM = CStr(CDbl(.Fields("B1314")) - 191100)
      TempFileName = Left(strYM, Len(strYM) - 2) & "年" & Right(strYM, 2) & "月出缺勤統計尚未確認的資料清單"

      cnnConnection.BeginTrans: bolUpdStar = True
      Do While Not .EOF
         '檢查此筆表單當事人是否離職,若是,則直接刪除此筆資料
         If ChkStaffST04(.Fields("B1302"), False) = True Then
            strSql = "DELETE FROM ABS013 WHERE B1301='" & .Fields("B1301") & "' and B1302='" & .Fields("B1302") & "' "
            cnnConnection.Execute strSql
         Else
            strB1303 = .Fields("B1303")
            If .Fields("B1302") <> strB1303 Then '待簽核中
               '檢查下一處理人員是否離職,若是,則移轉下一處理人員
               Do While strB1303 <> "" And ChkStaffST04(strB1303, False) = True
                  '審核主管確認
                  intB1303Seqno = GetCurrB1303Seqno(.Fields("B1301"), .Fields("B1302"), strB1303)
                  If intB1303Seqno = 1 Then
                     strSql = "Update ABS013 set B1304='Y' WHERE B1301='" & .Fields("B1301") & "' and B1302='" & .Fields("B1302") & "' "
                     cnnConnection.Execute strSql
                  ElseIf intB1303Seqno = 2 Then
                     strSql = "Update ABS013 set B1305='Y' WHERE B1301='" & .Fields("B1301") & "' and B1302='" & .Fields("B1302") & "' "
                     cnnConnection.Execute strSql
                  ElseIf intB1303Seqno = 3 Then
                     strSql = "Update ABS013 set B1306='Y' WHERE B1301='" & .Fields("B1301") & "' and B1302='" & .Fields("B1302") & "' "
                     cnnConnection.Execute strSql
                  ElseIf intB1303Seqno = 4 Then
                     strSql = "Update ABS013 set B1307='Y' WHERE B1301='" & .Fields("B1301") & "' and B1302='" & .Fields("B1302") & "' "
                     cnnConnection.Execute strSql
                  End If
                  '讀取下一處理人員
                  strB1303 = GetNextB1303(.Fields("B1301"), .Fields("B1302"))
               Loop
            End If
            If strB1303 = "" Then
               '已無下一處理人員時,代表已確認完畢即可刪除該筆資料
               strSql = "DELETE FROM ABS013 WHERE B1301='" & .Fields("B1301") & "' and B1302='" & .Fields("B1302") & "' "
               cnnConnection.Execute strSql
            Else
               If strB1303 <> .Fields("B1303") Then
                  '送至下一處理人員
                  strSql = "Update ABS013 set B1303='" & strB1303 & "' WHERE B1301='" & .Fields("B1301") & "' and B1302='" & .Fields("B1302") & "' "
                  cnnConnection.Execute strSql
               End If
               '欲給人事室的資料清單
               If TempSendMailSeek = "" Then
                  If ff > 0 Then Close #ff
                  ff = FreeFile
                  Open App.path & TextPath & TempFileName & ".txt" For Output As ff
                  'Added by Lydia 2016/10/19 加報表抬頭
                  Print #ff, Space(10) & TempFileName
                  Print #ff, ""
                  'end 2016/10/19
                  Print #ff, "統計年月 部門別            員工姓名        目前處理人員"
                  Print #ff, "======== ================= =============== ==============="
               End If
               'E-Mail通知下一處理人員做資料確認
               If InStr(1, TempSendMailSeek, strB1303) = 0 Then
                  TempSendMailSeek = TempSendMailSeek & "," & strB1303
               End If
               tmpnext = "開檔中..."
               A01 = "" & convForm(Left(strYM, Len(strYM) - 2) & "/" & Right(strYM, 2), 8)
               A02 = "" & convForm(CheckStr(.Fields("ST03").Value) & " " & CheckStr(.Fields("A0902").Value), 17)
               A03 = "" & convForm(CheckStr(.Fields("B1302").Value) & " " & CheckStr(.Fields("ST02").Value), 15)
               A04 = "" & convForm(strB1303 & " " & GetPrjSalesNM(strB1303), 15)
               tmpnext = "寫檔..."
               Print #ff, A01 & " " & A02 & " " & A03 & " " & A04
            End If
         End If
         .MoveNext
      Loop
      cnnConnection.CommitTrans
   End If
End With
Close ff
tmpnext = "關檔..."
If TempFileName <> "" Then
   '發 mail 通知下一處理人員
   SendMailTo = Split(TempSendMailSeek, ",")
   For iCount = 0 To UBound(SendMailTo)
      If SendMailTo(iCount) <> "" Then
         SendMAPIMail CStr(SendMailTo(iCount)), "每月出缺勤統計待確認通知", "Dear Sirs," & vbCrLf & "          請至案件管理系統，進行每月出缺勤統計確認。" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", , , True
      End If
   Next iCount
   '發 mail 給人事室
   SendMAPIMail strToM21, "每月出缺勤統計尚未確認的資料清單", "Dear Sirs," & vbCrLf & "          每月出缺勤統計尚未確認的資料清單 如附件！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", App.path & TextPath & TempFileName & ".txt"
End If

Set Rs = Nothing
'Set cnnConnection = Nothing
Exit Sub

DebugErr:
   If bolUpdStar = True Then
      cnnConnection.RollbackTrans
'      MsgBox "更新失敗！" & vbCrLf & Err.Description
   End If
   WLog tmpnext & " " & Err.Description
End Sub

'Add By Sindy 2011/9/6 檢查員工個人資料明細是否有未確認的資料
'個人資料明細5個工作天後開始檢查...
Sub StrMenu25()
Dim ff As Integer
Dim A01 As String
Dim A02 As String
Dim iCount As Integer
Dim TempFileName As String
Dim TempSendMailSeek As String
Dim tmpnext As String
Dim ChkDate As String, strToM21 As String
Dim bolUpdStar As Boolean
Dim SendMailTo As Variant

On Error GoTo DebugErr

'   tmpnext = "準備連資料庫..."
'   Set cnnConnection = New ADODB.Connection
'   cnnConnection.ConnectionString = CnStr
'   cnnConnection.Open
   TempFileName = ""
   bolUpdStar = False

   ChkDate = CompWorkDay(6, strSrvDate(1), 1) '往前推5個工作天

   '人事室出缺勤電子簽核收E-Mail人員
   strToM21 = Pub_GetSpecMan("人事室出缺勤電子簽核")
   'Added by Lydia 2023/12/22
   If ChkDate >= 新部門啟用日 Then
      strSql = " SELECT B1301,B1314,NVL(ST93,ST03) ST03,NVL(A0922,A0902) A0902,B1302,ST02,B1303" & _
               " From ABS013, STAFF, ACC090, ACC090NEW" & _
               " WHERE B1301='05' AND B1302=ST01(+) AND ST03=A0901(+) AND ST93=A0921(+)" & _
               " AND B1309<=" & ChkDate & _
               " ORDER BY ST03,ST01"
   Else
   'end 2023/12/22
      strSql = "select B1301,B1314,ST03,A0902,B1302,ST02,B1303 " & _
               "from ABS013,Staff,ACC090 " & _
               "where B1301='05' and B1302=ST01(+) and ST03=A0901(+) " & _
               "and B1309<=" & ChkDate & _
               " order by ST03,ST01 "
   End If
CheckOC
Set Rs = New ADODB.Recordset
Rs.CursorLocation = adUseClient
Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
tmpnext = "已取得資料..."
TempSendMailSeek = ""
With Rs
   If .RecordCount > 0 Then
      .MoveFirst
      ff = FreeFile
      TempFileName = "員工個人資料明細尚未確認的資料清單"
      'Add By Sindy 2020/8/31
      If Dir(App.path & TextPath & "*" & TempFileName & "*.txt") <> "" Then
         Kill App.path & TextPath & "*" & TempFileName & "*.txt"
      End If
      '2020/8/31 END
      cnnConnection.BeginTrans: bolUpdStar = True
      Do While Not .EOF
         '檢查此筆表單當事人是否離職,若是,則直接刪除此筆資料
         If ChkStaffST04(.Fields("B1302"), False) = True Then
            strSql = "DELETE FROM ABS013 WHERE B1301='" & .Fields("B1301") & "' and B1302='" & .Fields("B1302") & "' "
            cnnConnection.Execute strSql
         Else
            '欲給人事室的資料清單
            If TempSendMailSeek = "" Then
               If ff > 0 Then Close #ff
               ff = FreeFile
               Open App.path & TextPath & TempFileName & ".txt" For Output As ff
                'Added by Lydia 2016/10/19 加報表抬頭
                Print #ff, TempFileName
                Print #ff, ""
                'end 2016/10/19
               Print #ff, "部門別            員工姓名"
               Print #ff, "================= ==============="
            End If
            'E-Mail通知下一處理人員做資料確認
            If InStr(1, TempSendMailSeek, .Fields("B1303")) = 0 Then
               TempSendMailSeek = TempSendMailSeek & "," & .Fields("B1303")
            End If
            tmpnext = "開檔中..."
            A01 = "" & convForm(CheckStr(.Fields("ST03").Value) & " " & CheckStr(.Fields("A0902").Value), 17)
            A02 = "" & convForm(CheckStr(.Fields("B1302").Value) & " " & CheckStr(.Fields("ST02").Value), 15)
            tmpnext = "寫檔..."
            Print #ff, A01 & " " & A02
         End If
         .MoveNext
      Loop
      cnnConnection.CommitTrans
   End If
End With
Close ff
tmpnext = "關檔..."
If TempFileName <> "" Then
   '發 mail 通知下一處理人員
   SendMailTo = Split(TempSendMailSeek, ",")
   For iCount = 0 To UBound(SendMailTo)
      If SendMailTo(iCount) <> "" Then
         'Modify By Sindy 2025/4/23 加員工姓名:"員工(" & GetPrjSalesNM(CStr(SendMailTo(iCount))) & ")個人資料明細待確認通知"
         SendMAPIMail CStr(SendMailTo(iCount)), "員工(" & GetPrjSalesNM(CStr(SendMailTo(iCount))) & ")個人資料明細待確認通知", "Dear Sirs," & vbCrLf & "          請至案件管理系統，進行員工個人資料明細確認。" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", , , True
      End If
   Next iCount
   '發 mail 給人事室
   SendMAPIMail strToM21, "員工個人資料明細尚未確認的資料清單", "Dear Sirs," & vbCrLf & "          員工個人資料明細尚未確認的資料清單 如附件！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", App.path & TextPath & TempFileName & ".txt"
End If

Set Rs = Nothing
'Set cnnConnection = Nothing
Exit Sub

DebugErr:
   If bolUpdStar = True Then
      cnnConnection.RollbackTrans
'      MsgBox "更新失敗！" & vbCrLf & Err.Description
   End If
   WLog tmpnext & " " & Err.Description
End Sub

'Add By Sindy 2011/9/7 檢查職務代理人已離職通知
Sub StrMenu26()
Dim ff As Integer
Dim A01 As String
Dim A02 As String
Dim A03 As String
Dim A04 As String
Dim A05 As String
Dim A06 As String
Dim A07 As String
Dim A08 As String
Dim A09 As String
Dim A10 As String
Dim A11 As String
Dim A12 As String
Dim A13 As String
Dim A14 As String
Dim A15 As String
Dim A16 As String
Dim TempFileName As String
Dim tmpnext As String
Dim strTo As String
Dim ChkDate As String, ChkDate30 As String
Dim strText As String
   
On Error GoTo DebugErr
   
'   tmpnext = "準備連資料庫..."
'   Set cnnConnection = New ADODB.Connection
'   cnnConnection.ConnectionString = CnStr
'   cnnConnection.Open
   
   ChkDate = CompWorkDay(4, strSrvDate(1), 1) '往前推3個工作天
   ChkDate30 = CompWorkDay(34, strSrvDate(1), 1) '往前推30個工作天
   
   '檢查請假特殊規則簽核設定檔,最後簽核人員是否已離職,若是,則通知電腦中心
   '排除人事異動的最後一筆是否為04.留職停薪
   strSql = "SELECT distinct ST01,ST02 FROM ABS003,Staff" & _
            " WHERE B0304 is not null" & _
            " and B0304=ST01(+) and ST04<>'1' and ST51<=" & ChkDate & " and ST51>=" & ChkDate30 & _
            " and 04 not in(select sc03 from staff_change where sc01=B0304 and sc02=(select max(sc02) from staff_change where sc01=B0304))"
   CheckOC
   Set Rs = New ADODB.Recordset
   Rs.CursorLocation = adUseClient
   Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   tmpnext = "已取得資料..."
   With Rs
      If .RecordCount > 0 Then
         .MoveFirst
         ff = FreeFile
         TempFileName = "請假特殊規則簽核設定檔已離職人員資料清單"
         'Add By Sindy 2020/8/31
         If Dir(App.path & TextPath & "*" & TempFileName & "*.txt") <> "" Then
            Kill App.path & TextPath & "*" & TempFileName & "*.txt"
         End If
         '2020/8/31 END
         
         'Modify By Sindy 2024/3/18 改抓 程式管理人員
         strTo = Pub_GetSpecMan("程式管理人員")
         
         If ff > 0 Then Close #ff
         ff = FreeFile
         Open App.path & TextPath & TempFileName & ".txt" For Output As ff
        'Added by Lydia 2016/10/19 加報表抬頭
        Print #ff, TempFileName
        Print #ff, ""
        'end 2016/10/19
         Print #ff, "離職人員"
         Print #ff, "==============="
         
         Do While Not .EOF
            tmpnext = "開檔中..."
            A01 = "" & convForm(CheckStr(.Fields("ST01").Value) & " " & CheckStr(.Fields("ST02").Value), 15)
            tmpnext = "寫檔..."
            Print #ff, A01
            .MoveNext
         Loop
         
         Close ff
         tmpnext = "關檔..."
         '發 mail
         SendMAPIMail strTo, TempFileName, "Dear Sirs," & vbCrLf & "          " & TempFileName & " 如附件！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", App.path & TextPath & TempFileName & ".txt"
      End If
   End With
   
   'Add By Sindy 2020/8/31
   If Dir(App.path & TextPath & "*職務代理人資料表*.txt") <> "" Then
      Kill App.path & TextPath & "*職務代理人資料表*.txt"
   End If
   '2020/8/31 END
   
   '檢查職務代理人是否有人員離職
   '排除人事異動的最後一筆是否為04.留職停薪
   'Modify By Sindy 2023/6/15 增加檢查 B0124,B0128,B0129
   strSql = "SELECT ST01,ST02 from (SELECT ST01,ST02 FROM ABS002,Staff WHERE B0202 is not null and B0202=ST01(+) and ST04<>'1' and ST51<=" & ChkDate & " and ST51>=" & ChkDate30 & " and 04 not in(select sc03 from staff_change where sc01=B0202 and sc02=(select max(sc02) from staff_change where sc01=B0202)) " & _
      "Union SELECT ST01,ST02 FROM ABS002,Staff WHERE B0203 is not null and B0203=ST01(+) and ST04<>'1' and ST51<=" & ChkDate & " and ST51>=" & ChkDate30 & " and 04 not in(select sc03 from staff_change where sc01=B0203 and sc02=(select max(sc02) from staff_change where sc01=B0203)) " & _
      "Union SELECT ST01,ST02 FROM ABS002,Staff WHERE B0204 is not null and B0204=ST01(+) and ST04<>'1' and ST51<=" & ChkDate & " and ST51>=" & ChkDate30 & " and 04 not in(select sc03 from staff_change where sc01=B0204 and sc02=(select max(sc02) from staff_change where sc01=B0204)) " & _
      "Union SELECT ST01,ST02 FROM ABS002,Staff WHERE B0205 is not null and B0205=ST01(+) and ST04<>'1' and ST51<=" & ChkDate & " and ST51>=" & ChkDate30 & " and 04 not in(select sc03 from staff_change where sc01=B0205 and sc02=(select max(sc02) from staff_change where sc01=B0205)) " & _
      "Union SELECT ST01,ST02 FROM ABS002,Staff WHERE B0206 is not null and B0206=ST01(+) and ST04<>'1' and ST51<=" & ChkDate & " and ST51>=" & ChkDate30 & " and 04 not in(select sc03 from staff_change where sc01=B0206 and sc02=(select max(sc02) from staff_change where sc01=B0206)) " & _
      "Union SELECT ST01,ST02 FROM ABS002,Staff WHERE B0207 is not null and B0207=ST01(+) and ST04<>'1' and ST51<=" & ChkDate & " and ST51>=" & ChkDate30 & " and 04 not in(select sc03 from staff_change where sc01=B0207 and sc02=(select max(sc02) from staff_change where sc01=B0207)) " & _
      "Union SELECT ST01,ST02 FROM ABS001,Staff WHERE B0102 is not null and B0102=ST01(+) and ST04<>'1' and ST51<=" & ChkDate & " and ST51>=" & ChkDate30 & " and 04 not in(select sc03 from staff_change where sc01=B0102 and sc02=(select max(sc02) from staff_change where sc01=B0102)) " & _
      "Union SELECT ST01,ST02 FROM ABS001,Staff WHERE B0103 is not null and B0103=ST01(+) and ST04<>'1' and ST51<=" & ChkDate & " and ST51>=" & ChkDate30 & " and 04 not in(select sc03 from staff_change where sc01=B0103 and sc02=(select max(sc02) from staff_change where sc01=B0103)) " & _
      "Union SELECT ST01,ST02 FROM ABS001,Staff WHERE B0104 is not null and B0104=ST01(+) and ST04<>'1' and ST51<=" & ChkDate & " and ST51>=" & ChkDate30 & " and 04 not in(select sc03 from staff_change where sc01=B0104 and sc02=(select max(sc02) from staff_change where sc01=B0104)) " & _
      "Union SELECT ST01,ST02 FROM ABS001,Staff WHERE B0105 is not null and B0105=ST01(+) and ST04<>'1' and ST51<=" & ChkDate & " and ST51>=" & ChkDate30 & " and 04 not in(select sc03 from staff_change where sc01=B0105 and sc02=(select max(sc02) from staff_change where sc01=B0105)) " & _
      "Union SELECT ST01,ST02 FROM ABS001,Staff WHERE B0106 is not null and B0106=ST01(+) and ST04<>'1' and ST51<=" & ChkDate & " and ST51>=" & ChkDate30 & " and 04 not in(select sc03 from staff_change where sc01=B0106 and sc02=(select max(sc02) from staff_change where sc01=B0106)) " & _
      "Union SELECT ST01,ST02 FROM ABS001,Staff WHERE B0107 is not null and B0107=ST01(+) and ST04<>'1' and ST51<=" & ChkDate & " and ST51>=" & ChkDate30 & " and 04 not in(select sc03 from staff_change where sc01=B0107 and sc02=(select max(sc02) from staff_change where sc01=B0107)) " & _
      "Union SELECT ST01,ST02 FROM ABS001,Staff WHERE B0108 is not null and B0108=ST01(+) and ST04<>'1' and ST51<=" & ChkDate & " and ST51>=" & ChkDate30 & " and 04 not in(select sc03 from staff_change where sc01=B0108 and sc02=(select max(sc02) from staff_change where sc01=B0108)) " & _
      "Union SELECT ST01,ST02 FROM ABS001,Staff WHERE B0109 is not null and B0109=ST01(+) and ST04<>'1' and ST51<=" & ChkDate & " and ST51>=" & ChkDate30 & " and 04 not in(select sc03 from staff_change where sc01=B0109 and sc02=(select max(sc02) from staff_change where sc01=B0109)) " & _
      "Union SELECT ST01,ST02 FROM ABS001,Staff WHERE B0110 is not null and B0110=ST01(+) and ST04<>'1' and ST51<=" & ChkDate & " and ST51>=" & ChkDate30 & " and 04 not in(select sc03 from staff_change where sc01=B0110 and sc02=(select max(sc02) from staff_change where sc01=B0110)) " & _
      "Union SELECT ST01,ST02 FROM ABS001,Staff WHERE B0111 is not null and B0111=ST01(+) and ST04<>'1' and ST51<=" & ChkDate & " and ST51>=" & ChkDate30 & " and 04 not in(select sc03 from staff_change where sc01=B0111 and sc02=(select max(sc02) from staff_change where sc01=B0111)) " & _
      "Union SELECT ST01,ST02 FROM ABS001,Staff WHERE B0117 is not null and B0117=ST01(+) and ST04<>'1' and ST51<=" & ChkDate & " and ST51>=" & ChkDate30 & " and 04 not in(select sc03 from staff_change where sc01=B0117 and sc02=(select max(sc02) from staff_change where sc01=B0117)) " & _
      "Union SELECT ST01,ST02 FROM ABS001,Staff WHERE B0119 is not null and B0119=ST01(+) and ST04<>'1' and ST51<=" & ChkDate & " and ST51>=" & ChkDate30 & " and 04 not in(select sc03 from staff_change where sc01=B0119 and sc02=(select max(sc02) from staff_change where sc01=B0119)) " & _
      "Union SELECT ST01,ST02 FROM ABS001,Staff WHERE B0121 is not null and B0121=ST01(+) and ST04<>'1' and ST51<=" & ChkDate & " and ST51>=" & ChkDate30 & " and 04 not in(select sc03 from staff_change where sc01=B0121 and sc02=(select max(sc02) from staff_change where sc01=B0121)) " & _
      "Union SELECT ST01,ST02 FROM ABS001,Staff WHERE B0123 is not null and B0123=ST01(+) and ST04<>'1' and ST51<=" & ChkDate & " and ST51>=" & ChkDate30 & " and 04 not in(select sc03 from staff_change where sc01=B0123 and sc02=(select max(sc02) from staff_change where sc01=B0123)) " & _
      "Union SELECT ST01,ST02 FROM ABS001,Staff WHERE B0124 is not null and instr(B0124,ST01)>0 and ST04<>'1' and ST51<=" & ChkDate & " and ST51>=" & ChkDate30 & " " & _
      "Union SELECT ST01,ST02 FROM ABS001,Staff WHERE B0128 is not null and B0128=ST01(+) and ST04<>'1' and ST51<=" & ChkDate & " and ST51>=" & ChkDate30 & " and 04 not in(select sc03 from staff_change where sc01=B0128 and sc02=(select max(sc02) from staff_change where sc01=B0128)) " & _
      "Union SELECT ST01,ST02 FROM ABS001,Staff WHERE B0129 is not null and B0129=ST01(+) and ST04<>'1' and ST51<=" & ChkDate & " and ST51>=" & ChkDate30 & " and 04 not in(select sc03 from staff_change where sc01=B0129 and sc02=(select max(sc02) from staff_change where sc01=B0129)) " & _
      ") group by ST01,ST02 order by ST01 asc "
   CheckOC
   Set Rs = New ADODB.Recordset
   Rs.CursorLocation = adUseClient
   Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   tmpnext = "已取得資料..."
   If Rs.RecordCount > 0 And Rs.RecordCount <> 0 Then
      Rs.MoveFirst
      Do While Not Rs.EOF
         TempFileName = ""
         
         '讀取職代檔資料
         'Modify By Sindy 2012/3/15 + and s1.st04='1'
         'Modify By Sindy 2023/6/15 + and (s1.ST14<>'99997' or s1.ST14 is null)
         'Modify By Sindy 2023/6/15 增加檢查 B0124,B0128,B0129
         'Added by Lydia 2023/12/22
         strSql = "select NVL(A0922,A0902) AS A0902,s1.ST02,s2.ST02,s3.ST02,s4.ST02,s5.ST02,s6.ST02,s7.ST02 " & _
                  ",s17.ST02||decode(nvl(B0116,''),'','','('||B0116||')'),s19.ST02||decode(nvl(B0118,''),'','','('||B0118||')') " & _
                  ",s21.ST02||decode(nvl(B0120,''),'','','('||B0120||')'),s23.ST02||decode(nvl(B0122,''),'','','('||B0122||')') " & _
                  ",s8.ST02||decode(nvl(B0112,''),'','','('||B0112||')'),s9.ST02||decode(nvl(B0113,''),'','','('||B0113||')') " & _
                  ",s10.ST02||decode(nvl(B0114,''),'','','('||B0114||')'),s11.ST02||decode(nvl(B0115,''),'','','('||B0115||')') " & _
                  ",GETSTAFFNAMELIST(replace(B0124,';',',')) as B0124Name,GETSTAFFNAMELIST(B0128) as B0128Name,GETSTAFFNAMELIST(B0129) as B0129Name " & _
                  "from ABS001,ACC090,ACC090NEW,Staff s1,Staff s2,Staff s3,Staff s4,Staff s5,Staff s6,Staff s7 " & _
                  ",Staff s8,Staff s9,Staff s10,Staff s11 " & _
                  ",Staff s17,Staff s19,Staff s21,Staff s23 " & _
                  "where B0101=s1.ST01(+) AND S1.ST03=A0901 AND S1.ST93=A0921(+) " & _
                  "and B0102=s2.ST01(+) and B0103=s3.ST01(+) and B0104=s4.ST01(+) and B0105=s5.ST01(+) and B0106=s6.ST01(+) and B0107=s7.ST01(+) " & _
                  "and B0108=s8.ST01(+) and B0109=s9.ST01(+) and B0110=s10.ST01(+) and B0111=s11.ST01(+) " & _
                  "and B0117=s17.ST01(+) and B0119=s19.ST01(+) and B0121=s21.ST01(+) and B0123=s23.ST01(+) " & _
                  "and (B0102='" & Rs.Fields(0) & "' or B0103='" & Rs.Fields(0) & "' or B0104='" & Rs.Fields(0) & "' or B0105='" & Rs.Fields(0) & "' or B0106='" & Rs.Fields(0) & "' or B0107='" & Rs.Fields(0) & "' or B0108='" & Rs.Fields(0) & "' or B0109='" & Rs.Fields(0) & "' or B0110='" & Rs.Fields(0) & "' or B0111='" & Rs.Fields(0) & "' or B0117='" & Rs.Fields(0) & "' or B0119='" & Rs.Fields(0) & "' or B0121='" & Rs.Fields(0) & "' or B0123='" & Rs.Fields(0) & "' or instr(B0124,'" & Rs.Fields(0) & "')>0 or B0128='" & Rs.Fields(0) & "' or B0129='" & Rs.Fields(0) & "') " & _
                  "and s1.st04='1' and (s1.ST14<>'99997' or s1.ST14 is null) " & _
                  "ORDER BY NVL(S1.ST93,S1.ST03),B0101 "
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strSql)
         If intI = 1 Then
            'Modify By Sindy 2020/8/31
            If TempFileName = "" Then
               ff = FreeFile
               If ff > 0 Then Close #ff
               ff = FreeFile
               TempFileName = Rs.Fields(0) & Rs.Fields(1) & "職務代理人資料表"
               Open App.path & TextPath & TempFileName & ".txt" For Output As ff
               tmpnext = "開檔中..."
               Print #ff, Rs.Fields(0) & Rs.Fields(1) & "離職，請調整職務代理人資料，並通知人事室修改。"
               Print #ff, ""
            End If
            '2020/8/31 END
            RsTemp.MoveFirst
            Print #ff, "[一般身份職代]"
            Print #ff, ""
            A01 = convForm("部門別", 11)
            A02 = convForm("員工姓名", 11)
            A03 = convForm("職代(1-1)", 11)
            A04 = convForm("職代(1-2)", 11)
            A05 = convForm("職代(2-1)", 11)
            A06 = convForm("職代(2-2)", 11)
            A07 = convForm("職代(3-1)", 11)
            A08 = convForm("職代(3-2)", 11)
            A09 = convForm("案職代(1-1)", 11)
            Print #ff, A01 & " " & A02 & " " & A03 & " " & A04 & " " & A05 & " " & A06 & " " & A07 & " " & A08 & " " & A09
            tmpnext = "寫檔..."
            A01 = convForm("", 11)
            A02 = convForm("", 11)
            A10 = convForm("案職代(1-2)", 11)
            A11 = convForm("案職代(2-1)", 11)
            A12 = convForm("案職代(2-2)", 11)
            A13 = convForm("主管1", 11)
            A14 = convForm("主管2", 11)
            A15 = convForm("主管3", 11)
            A16 = convForm("主管4", 11)
            Print #ff, A01 & " " & A02 & " " & A10 & " " & A11 & " " & A12 & " " & A13 & " " & A14 & " " & A15 & " " & A16
            Print #ff, "=========== =========== =========== =========== =========== =========== =========== =========== ==========="
            Do While Not RsTemp.EOF
               A01 = "" & convForm(Left(CheckStr(RsTemp.Fields(0)), 5), 11)
               A02 = "" & convForm(CheckStr(RsTemp.Fields(1)), 11)
               A03 = "" & convForm(CheckStr(RsTemp.Fields(2)), 11)
               A04 = "" & convForm(CheckStr(RsTemp.Fields(3)), 11)
               A05 = "" & convForm(CheckStr(RsTemp.Fields(4)), 11)
               A06 = "" & convForm(CheckStr(RsTemp.Fields(5)), 11)
               A07 = "" & convForm(CheckStr(RsTemp.Fields(6)), 11)
               A08 = "" & convForm(CheckStr(RsTemp.Fields(7)), 11)
               A09 = "" & convForm(CheckStr(RsTemp.Fields(8)), 11)
               Print #ff, A01 & " " & A02 & " " & A03 & " " & A04 & " " & A05 & " " & A06 & " " & A07 & " " & A08 & " " & A09
               A01 = convForm("", 11)
               A02 = convForm("", 11)
               A10 = "" & convForm(CheckStr(RsTemp.Fields(9)), 11)
               A11 = "" & convForm(CheckStr(RsTemp.Fields(10)), 11)
               A12 = "" & convForm(CheckStr(RsTemp.Fields(11)), 11)
               A13 = "" & convForm(CheckStr(RsTemp.Fields(12)), 11)
               A14 = "" & convForm(CheckStr(RsTemp.Fields(13)), 11)
               A15 = "" & convForm(CheckStr(RsTemp.Fields(14)), 11)
               A16 = "" & convForm(CheckStr(RsTemp.Fields(15)), 11)
               Print #ff, A01 & " " & A02 & " " & A10 & " " & A11 & " " & A12 & " " & A13 & " " & A14 & " " & A15 & " " & A16
               'Add By Sindy 2024/2/22
               If "" & RsTemp.Fields("B0124Name") <> "" Then
                  Print #ff, "　請假、出差核准後通知人員編號：" & RsTemp.Fields("B0124Name")
               End If
               If "" & RsTemp.Fields("B0128Name") <> "" Then
                  Print #ff, "　居家職代(1)：" & RsTemp.Fields("B0128Name")
               End If
               If "" & RsTemp.Fields("B0129Name") <> "" Then
                  Print #ff, "　居家職代(2)：" & RsTemp.Fields("B0129Name")
               End If
               '2024/2/22 END
               Print #ff, "-----------------------------------------------------------------------------------------------------------"
               
               RsTemp.MoveNext
            Loop
         End If
         
         '讀取特殊身份職代檔資料
         'Modify By Sindy 2012/3/15 +and s1.st04='1'
         'Modify By Sindy 2023/6/15 + and (s1.ST14<>'99997' or s1.ST14 is null)
         'Added by Lydia 2023/12/22
         strSql = "select NVL(A0922,A0902) AS A0902,s1.ST02,s2.ST02,s3.ST02,s4.ST02,s5.ST02,s6.ST02,s7.ST02,B0208 " & _
                  "from ABS002,ACC090,ACC090NEW,Staff s1,Staff s2,Staff s3,Staff s4,Staff s5,Staff s6,Staff s7 " & _
                  "where B0201=s1.ST01(+) and s1.ST03=A0901 AND S1.ST03=A0901 AND S1.ST93=A0921(+) " & _
                  "and B0202=s2.ST01(+) and B0203=s3.ST01(+) and B0204=s4.ST01(+) and B0205=s5.ST01(+) and B0206=s6.ST01(+) and B0207=s7.ST01(+) " & _
                  "and (B0202='" & Rs.Fields(0) & "' or B0203='" & Rs.Fields(0) & "' or B0204='" & Rs.Fields(0) & "' or B0205='" & Rs.Fields(0) & "' or B0206='" & Rs.Fields(0) & "' or B0207='" & Rs.Fields(0) & "') " & _
                  "and s1.st04='1' and (s1.ST14<>'99997' or s1.ST14 is null) " & _
                  "ORDER BY NVL(S1.ST93,S1.ST03),B0201 "
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strSql)
         If intI = 1 Then
            'Modify By Sindy 2020/8/31
            If TempFileName = "" Then
               ff = FreeFile
               If ff > 0 Then Close #ff
               ff = FreeFile
               TempFileName = Rs.Fields(0) & Rs.Fields(1) & "職務代理人資料表"
               Open App.path & TextPath & TempFileName & ".txt" For Output As ff
               tmpnext = "開檔中..."
               Print #ff, Rs.Fields(0) & Rs.Fields(1) & "離職，請調整職務代理人資料，並通知人事室修改。"
               Print #ff, ""
            End If
            '2020/8/31 END
            RsTemp.MoveFirst
            Print #ff, ""
            Print #ff, "[特殊身份職代]"
            Print #ff, ""
            A01 = convForm("部門別", 11)
            A02 = convForm("員工姓名", 11)
            A03 = convForm("特殊部門或員工", 14)
            A04 = convForm("職代(1-1)", 11)
            A05 = convForm("職代(1-2)", 11)
            A06 = convForm("職代(2-1)", 11)
            A07 = convForm("職代(2-2)", 11)
            A08 = convForm("職代(3-1)", 11)
            A09 = convForm("職代(3-2)", 11)
            Print #ff, A01 & " " & A02 & " " & A03 & " " & A04 & " " & A05 & " " & A06 & " " & A07 & " " & A08 & " " & A09
            tmpnext = "寫檔..."
            Print #ff, "=========== =========== ============== =========== =========== =========== =========== =========== ==========="
            Do While Not RsTemp.EOF
               A01 = "" & convForm(Left(CheckStr(RsTemp.Fields(0)), 5), 11)
               A02 = "" & convForm(CheckStr(RsTemp.Fields(1)), 11)
               A03 = "" & convForm(CheckStr(RsTemp.Fields(2)), 11)
               A04 = "" & convForm(CheckStr(RsTemp.Fields(3)), 11)
               A05 = "" & convForm(CheckStr(RsTemp.Fields(4)), 11)
               A06 = "" & convForm(CheckStr(RsTemp.Fields(5)), 11)
               A07 = "" & convForm(CheckStr(RsTemp.Fields(6)), 11)
               A08 = "" & convForm(CheckStr(RsTemp.Fields(7)), 11)
               strText = ""
               strText = GetStaffName(RsTemp.Fields(8), True)
               If strText = "" Then
                  strText = GetDepartmentName(RsTemp.Fields(8))
               End If
               A09 = "" & convForm(strText, 14)
               Print #ff, A01 & " " & A02 & " " & A09 & " " & A03 & " " & A04 & " " & A05 & " " & A06 & " " & A07 & " " & A08
               
               RsTemp.MoveNext
            Loop
         End If
         If TempFileName <> "" Then 'Modify By Sindy 2020/8/31
            Close ff
            tmpnext = "關檔..."
            '預設值為人事室出缺勤電子簽核收E-Mail人員
            strTo = Pub_GetSpecMan("人事室出缺勤電子簽核")
            '通知離職員工的最高審核主管
   '         strSql = "SELECT 1,B0108 FROM ABS001 WHERE B0108 is not null and B0101='" & rs.Fields(0) & "' " & _
   '                  "union SELECT 2,B0109 FROM ABS001 WHERE B0109 is not null and B0101='" & rs.Fields(0) & "' " & _
   '                  "union SELECT 3,B0110 FROM ABS001 WHERE B0110 is not null and B0101='" & rs.Fields(0) & "' " & _
   '                  "union SELECT 4,B0111 FROM ABS001 WHERE B0111 is not null and B0101='" & rs.Fields(0) & "' " & _
   '                  "order by 1 desc "
            'Modify By Sindy 2011/10/7 通知A0908主管
            'Modify By Sindy 2022/12/12 a0908 改抓 NVL(a0912,a0908)
            'Added by Lydia 2023/12/22
            strSql = "SELECT NVL(A0926,NVL(A0924,NVL(a0912,a0908))) a0908 FROM staff,acc090,ACC090NEW WHERE st01='" & Rs.Fields(0) & "' and st03=a0901(+) AND ST93=A0921(+) "
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strSql)
            If intI = 1 Then
               With RsTemp
                  RsTemp.MoveFirst
                  If "" & RsTemp.Fields("a0908") <> "" Then
                     strTo = RsTemp.Fields("a0908")
'                  If ChkStaffST04(RsTemp.Fields("a0908"), False) = False Then
'                     strTo = RsTemp.Fields("a0908")
'                     'Modify By Sindy 2022/12/12
'                     If PUB_GetStaffST15(RsTemp.Fields("a0908"), "1") = "P21" Then 'P21.商標處承辦
'                        strTo = strTo & ";86048" '+承慧
'                     End If
'                     '2022/12/12 END
                  End If
               End With
            End If
            TempFileName = App.path & TextPath & TempFileName & ".txt"
            '發 MAIL
            SendMAPIMail strTo, Rs.Fields(0) & Rs.Fields(1) & "離職，請調整職務代理人資料，並通知人事室修改", "Dear Sirs," & vbCrLf & "          職務代理人資料表, 如附件！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", TempFileName
         End If
         
         Rs.MoveNext
      Loop
   End If
   
   '檢查新進人員是否已有職代檔資料
   'Modify By Sindy 2012/4/2 王副總提議增加判斷必須試用期滿隔日再發
   'Modify By Sindy 2013/6/26 +ST03,ST16
   'Modify By Sindy 2020/5/11 +84002.廖玉凌
   'Modify By Sindy 2022/12/12 a0908 改抓 NVL(a0912,a0908)
   'Added by Lydia 2023/12/22
   strSql = "SELECT ST01,ST02,ST14,ST04,ST13,NVL(A0926,NVL(A0924,NVL(a0912,a0908))) A0908,ST03,ST16 " & _
            "From Staff, ACC090, ACC090NEW " & _
            "WHERE ST03=A0901(+) AND ST93=A0921(+) and ST04='1' and ST13<=" & ChkDate & " " & _
            "and ST01 not in (select B0101 from ABS001 where B0101=ST01) " & _
            "and substr(st01,4,1)<>'9' " & _
            "and substr(st01,1,1) in (" & ST01CodeNum1 & ") " & _
            "and st01 not in('60000','96029','96030','86026','67004','68007','63001','84002') " & _
            "and (st14 is null or st14='') " & _
            "and (st29 is null or st29<" & strSrvDate(1) & ")"
   CheckOC
   Set Rs = New ADODB.Recordset
   Rs.CursorLocation = adUseClient
   Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   tmpnext = "已取得資料..."
   With Rs
      If .RecordCount > 0 Then
         .MoveFirst
         Do While Not Rs.EOF
            strText = Rs.Fields("ST01") & Rs.Fields("ST02") & "尚未建立職代及審核主管資料，請主管通知人事室建檔！"
            
            '預設值為人事室出缺勤電子簽核收E-Mail人員
            strTo = Pub_GetSpecMan("人事室出缺勤電子簽核")
            '通知A0908主管
            If Not IsNull(Rs.Fields("A0908")) Then
               If Rs.Fields("A0908") <> "" Then
                  strTo = Rs.Fields("A0908")
'                  'Modify By Sindy 2022/12/12
'                  If PUB_GetStaffST15(rs.Fields("ST01"), "1") = "P21" Then 'P21.商標處承辦
'                     strTo = strTo & ";86048" '+承慧
'                  End If
'                  '2022/12/12 END
               End If
               'Add By Sindy 2013/6/26 F21.外專工程師有另外分組別
               If "" & Rs.Fields("ST03") = "F21" Then
                  If "" & Rs.Fields("ST16") = "1" Then '電機
                     strTo = Pub_GetSpecMan("T")
                  ElseIf "" & Rs.Fields("ST16") = "2" Then '化學
                     strTo = Pub_GetSpecMan("R")
                  ElseIf "" & Rs.Fields("ST16") = "3" Then '日文
                     strTo = Pub_GetSpecMan("S")
                  ElseIf "" & Rs.Fields("ST16") = "4" Then '機械
                     strTo = Pub_GetSpecMan("T1")
                  End If
               End If
               '2013/6/26 END
            End If
            
            '發 mail
            SendMAPIMail strTo, strText, "Dear Sirs," & vbCrLf & "          " & strText & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心"
            
            Rs.MoveNext
         Loop
      End If
   End With
   
   If ChkWorkDay(strSrvDate(1)) = True Then    '2013/8/19 add by sonia 非工作天不通知
      'Add By Sindy 2012/4/2 期滿未設定密碼的員工,發信給當事者及83002
      'Modify By Sindy 2012/8/1 增加判斷SalaryData的編制為R(正)
      'modify by sonia 2014/4/21 因改新員工預設密碼規則為員工編號前二碼+末二碼,但要剔除外專承辦組
      'strSql = "SELECT a0902 部門,SP01 編號,ST02 姓名,decode(st06,'1','北所','2','中所','3','南所','4','高所','5','其他',st06) 所別,st29 試用期滿日 " & _
               "From STAFF_PWD, STAFF, acc090, SalaryData " & _
               "WHERE GETPWD(SP01)=SP01 AND SP01=ST01(+) AND ST04='1' and substr(st03,1,1)<>'R' and substr(st01,1,1)<>'F' " & _
               "and st05 is not null and (st29 is null or st29<TO_CHAR(SYSDATE,'YYYYMMDD')) " & _
               "and st01 not in ('63002','68002','PGM','QPGMR','84002','P1001','P1002','99999') " & _
               "and st03=a0901(+) and st01=sd01(+) and sd02='R' " & _
               "ORDER BY st03,sp01 "
      'modify by sonia 2014/11/10 副本通知其第二級主管或人事大部門主管
      'strSql = "SELECT a0902 部門,SP01 編號,ST02 姓名,decode(st06,'1','北所','2','中所','3','南所','4','高所','5','其他',st06) 所別,st29 試用期滿日 " & _
               "From STAFF_PWD, STAFF, acc090, SalaryData " & _
               "WHERE GETPWD(SP01)=SUBSTR(SP01,1,2)||SUBSTR(SP01,4,2) AND ST03<>'F23' AND SP01=ST01(+) AND ST04='1' and substr(st03,1,1)<>'R' and substr(st01,1,1)<>'F' " & _
               "and st05 is not null and (st29 is null or st29<TO_CHAR(SYSDATE,'YYYYMMDD')) " & _
               "and st01 not in ('63002','68002','PGM','QPGMR','84002','P1001','P1002','99999') " & _
               "and st03=a0901(+) and st01=sd01(+) and sd02='R' " & _
               "ORDER BY st03,sp01 "
      'Modify By Sindy 2016/5/5 取消判斷 and sd02='R' + ,s1.st14
      'Modified by Lydia 2023/06/07 增加判斷and s1.st05<>'AS'
      'Added by Lydia 2023/12/22
      strSql = "SELECT nvl(c1.a0923,a1.a0902) as 部門,SP01 編號,S1.ST02 姓名,decode(S1.st06,'1','北所','2','中所','3','南所','4','高所','5','其他',S1.st06) 所別,S1.st29 試用期滿日,NVL(S1.ST52,NVL(C1.A0924,A2.A0908)) MGR,s1.st14 st14 " & _
               "From STAFF_PWD, STAFF S1, acc090 A1, ACC090NEW C1, SalaryData,ACC090 A2,STAFF S2 " & _
               "WHERE GETPWD(SP01)=SUBSTR(SP01,1,2)||SUBSTR(SP01,4,2) AND S1.ST03<>'F23' AND SP01=S1.ST01(+) AND S1.ST04='1' and substr(S1.st03,1,1)<>'R' and substr(S1.st01,1,1)<>'F' " & _
               "and S1.st05 is not null and s1.st05<>'AS' and (S1.st29 is null or S1.st29<TO_CHAR(SYSDATE,'YYYYMMDD')) " & _
               "and S1.st01 not in ('63002','68002','PGM','QPGMR','84002','P1001','P1002','99999') " & _
               "and S1.st03=A1.a0901(+) AND S1.ST93=A0921(+) and S1.st01=sd01(+) AND S1.ST52=S2.ST01(+) AND A1.A0911=A2.A0901(+) " & _
               "ORDER BY NVL(S1.ST93,S1.st03),sp01 "
      CheckOC
      Set Rs = New ADODB.Recordset
      Rs.CursorLocation = adUseClient
      Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      tmpnext = "已取得資料..."
      With Rs
         If .RecordCount > 0 Then
            .MoveFirst
            Do While Not Rs.EOF
               'modify by sonia 2017/3/21 加內容,否則同仁收到都沒反應
               strText = "部　　門：" & Rs.Fields(0) & vbCrLf & _
                         "員工編號：" & Rs.Fields(1) & vbCrLf & _
                         "姓　　名：" & Rs.Fields(2) & vbCrLf & _
                         "所　　別：" & Rs.Fields(3) & vbCrLf & _
                         "試用期滿日：" & Rs.Fields(4) & vbCrLf & vbCrLf & _
                         "您的試用期已期滿，不可再使用系統預設的密碼，" & vbCrLf & _
                         "請儘速通知電腦中心重新設定密碼，謝謝 !"
               'Add By Sindy 2019/4/15
               strText = strText & vbCrLf & vbCrLf & vbCrLf & _
               "密碼規則：" & vbCrLf & _
               "10碼以內，英數字都可，大小寫不同，" & vbCrLf & _
               "不可以和薪資密碼相同。"
               '2019/4/15 END
               
               '發 mail
               'modify by sonia 2014/11/10 改為一次發,副本給主管及83002
               'SendMAPIMail rs.Fields(1), "請儘速通知電腦中心設定密碼, 謝謝 !", strText
               'SendMAPIMail "83002", "請儘速通知電腦中心設定密碼, 謝謝 !", strText
               'Modify By Sindy 2016/5/5 若為不寄信者,改通知秀玲
               'Modify By Sindy 2024/3/18 改抓 程式管理人員
               SendMAPIMail IIf("" & Rs.Fields("st14") = "99997", Pub_GetSpecMan("程式管理人員"), Rs.Fields(1)), "請儘速通知電腦中心重新設定密碼, 謝謝 !", strText, , , True, Pub_GetSpecMan("程式管理人員") & ";" & "" & Rs.Fields("MGR")
               'end 2014/11/10
               
               Rs.MoveNext
            Loop
         End If
      End With
   End If
      
   Set Rs = Nothing
   'Set cnnConnection = Nothing
   Exit Sub

DebugErr:
   WLog tmpnext & " " & Err.Description
End Sub

'Add By Sindy 2011/9/15 檢查尚未簽核完畢的表單下一處理人員是否離職或休假
Sub StrMenu27()
Dim tmpnext As String
Dim bolUpdStar As Boolean
Dim strOldB1017 As String, m_B1017 As String
Dim strUpdDate As String, strUpdTime As String, strB1207 As String
Dim strSubject As String, strContent As String
Dim strText As String
Dim strB1001 As String, strB1002 As String, strB1003 As String
Dim strB1004 As String, strB1005 As String
Dim strB1006 As String, strB1007 As String
Dim strB1008 As String, strB1009 As String, strB1010 As String
Dim strB1030 As String, strB101213 As String
Dim strB1014 As String, strB1015 As String
Dim strB1028 As String, strB1029 As String
Dim strTo As String
   
On Error GoTo DebugErr
   
   'Add By Sindy 2023/3/24 檢查接洽單簽核主管尚有待簽核資料，再次發通知信
   'Modify By Sindy 2023/9/11 + and f0309<>'" & Flow_退回 & "'
   strSql = "select f0308 from flow002,flow003 where f0202 in('A1','A2') and nvl(f0205,0)=0" & _
            " and f0201=f0301 and f0308 is not null and f0309 is not null and f0309<>'" & Flow_退回 & "'" & _
            " group by f0308"
   Set Rs = New ADODB.Recordset
   Rs.CursorLocation = adUseClient
   Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   With Rs
      If .RecordCount > 0 Then
         .MoveFirst
         strSubject = "提醒！尚有未簽核之電子接洽單"
         Do While Not .EOF
            strContent = strSubject & vbCrLf & vbCrLf & _
                         "請至案件管理系統的 一般作業->案件表單查詢及簽核->簽核作業 項目中，進行表單簽核處理。"
            SendMAPIMail .Fields("f0308"), strSubject, strContent
            .MoveNext
         Loop
      End If
   End With
   Rs.Close
   '2023/3/24 END
   
'   tmpnext = "準備連資料庫..."
'   Set cnnConnection = New ADODB.Connection
'   cnnConnection.ConnectionString = CnStr
'   cnnConnection.Open
   bolUpdStar = False
   
   '讀取尚未送至人事室的表單
   strSql = "select ABS010.*,ST02 from ABS010,Staff " & _
            "where B1003=ST01 and B1019 is null and B1017 is not null and B1017<>'M21' and B1003<>B1017 "

Set Rs = New ADODB.Recordset
Rs.CursorLocation = adUseClient
Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
tmpnext = "已取得資料..."
With Rs
   If .RecordCount > 0 Then
      .MoveFirst
      
      strUpdDate = strSrvDate(1)
      strUpdTime = Format(Time, "hhmmss")
      
      Do While Not .EOF
         cnnConnection.BeginTrans: bolUpdStar = True
         tmpnext = "表單人員(" & Rs.Fields("B1003") & Rs.Fields("ST02") & ")表單編號(" & Rs.Fields("B1001") & ")"
         strOldB1017 = "" & Rs.Fields("B1017")
         m_B1017 = "" & Rs.Fields("B1017")
         
         '讀取下一處理人員
         If GetNextProPerson(Trim(Rs.Fields("B1001")), Trim(Rs.Fields("B1003")), m_B1017, "M51", True) = False Then GoTo DebugErr
         
         'Modify By Sindy 2012/1/3 人事室不簽收,系統自動簽收進人事系統
         If m_B1017 = "M21" Then
            strB1001 = "" & Rs.Fields("B1001")
            strB1002 = "" & Rs.Fields("B1002")
            strB1003 = "" & Rs.Fields("B1003")
            strB1004 = "" & Rs.Fields("B1004")
            strB1005 = "" & Rs.Fields("B1005")
            strB1006 = "" & Rs.Fields("B1006")
            strB1007 = "" & Rs.Fields("B1007")
            strB1008 = "" & Rs.Fields("B1008")
            strB1009 = "" & Rs.Fields("B1009")
            strB1010 = "" & Rs.Fields("B1010")
            'Modify By Sindy 2017/7/10
            strB1030 = "" & Rs.Fields("B1030")
            If Val("" & Rs.Fields("B1012")) > 0 Then
               strB101213 = "" & Rs.Fields("B1012")
            Else
               strB101213 = "" & Rs.Fields("B1013")
            End If
            '2017/7/10 END
            strB1014 = "" & Rs.Fields("B1014")
            strB1015 = "" & Rs.Fields("B1015")
            strB1028 = "" & Rs.Fields("B1028")
            strB1029 = "" & Rs.Fields("B1029")
            If PUB_AutoM21Receive("M51", strUpdDate, strUpdTime, strB1001, strB1002, strB1003, strB1004, strB1005, strB1006, strB1007, strB1008, strB1009, strB1010, strB1030, strB101213, strB1014, strB1015, strB1028, strB1029, strSubject, strContent, False, True) = False Then
               WLog tmpnext & "，系統自動簽收表單進人事系統失敗！" & Err.Description
'            Else
'               '發E-Mail通知當事人
'               SendMAPIMail strB1003, strSubject, strContent, , , True
'
'               'Add By Sindy 2011/11/11 74018.杜燕文請假及出差核准後,知會68006.杜副總
'               If strB1003 = "74018" And _
'                  (strB1002 = 表單類別_請假 Or strB1002 = 表單類別_出差) Then
'                  SendMAPIMail "68006", strSubject, strContent, , , True
'               End If
'               'Add By Sindy 2012/2/10 專利處P10-P14人員當日臨時請假核准後,必須E-Mail通知71011王副總
'               'Modify By Sindy 2012/3/2 請假起迄日小於等於系統日請假核准者,均要通知王副總
'               If strB1003 <> "71011" And InStr(GetBossB1107_2_1(strB1001), "71011") = 0 And _
'                  (strB1002 = 表單類別_請假 Or strB1002 = 表單類別_出差) And _
'                  (GetStaffDepartment(strB1003) >= "P10" And GetStaffDepartment(strB1003) <= "P14") And _
'                  (strB1004 <= strSrvDate(1) And strB1006 <= strSrvDate(1)) Then
'                  SendMAPIMail "71011", strSubject, strContent, , , True
'               End If
'               '國外大陸出差的假單在人事室簽收時，一併要發Mail通知劉經理（增加系統特殊設定：國外大陸出差通知人員）
'               If strB1002 = 表單類別_出差 And (strB1014 = "3" Or strB1014 = "4") Then
'                  '取得國外大陸出差通知人員
'                  strTo = Pub_GetSpecMan("國外大陸出差通知人員")
'                  'Add By Sindy 2014/9/24 桂所長及閻副所長國外出差時(含大陸出差),在核准後知會人事時,一併通知林總經理
'                  If InStr(GetBossB1107_2_1(strB1001), "94007") = 0 Then
'                     strTo = strTo & ";94007"
'                  End If
'                  '2014/9/24 END
'                  If strTo <> "" Then
'                     strContent = GetEMailContent(strB1001, strSubject, , , True)
'                     strSubject = strContent & IIf(strB1014 = "3", " 大陸", " 國外") & "出差"
'                     SendMAPIMail strTo, strSubject, strSubject, , , True
'                  End If
'               End If
            End If
            GoTo ReadNext_StrMenu27
         '2012/1/3 End
         '發E-Mail通知下一處理人員
         ElseIf strOldB1017 <> m_B1017 Then
            If ChkStaffST04(strOldB1017, False) = True Then
               strText = "人員離職，"
            Else
               strText = "人員休假，"
            End If
            
            '記錄10.重送訊息
            strB1207 = strText & "更改簽核人員" & GetPrjSalesNM(strOldB1017) & "->" & GetPrjSalesNM(m_B1017)
            strSql = GetInsertABS012Sql(Trim(Rs.Fields("B1001")), "M51", strUpdDate, strUpdTime, "07", strB1207)
            cnnConnection.Execute strSql
            
            '有異動下一處理人員時,發E-Mail通知下一處理人員及原下一處理人員
            If m_B1017 <> "" Then
               strContent = GetEMailContent(Rs.Fields("B1001"), strSubject)
               SendMAPIMail m_B1017, strSubject, strContent, , , True
            End If
            If strOldB1017 <> "" Then
               strContent = GetEMailContent(Rs.Fields("B1001"), strSubject, 重送更改通知, "，" & strText & "更改簽核人員為" & GetPrjSalesNM(m_B1017))
               SendMAPIMail strOldB1017, strSubject, strContent, , , True
            End If
         End If
         cnnConnection.CommitTrans
         
ReadNext_StrMenu27:
         .MoveNext
      Loop
   End If
End With
tmpnext = "關檔..."

Set Rs = Nothing
'Set cnnConnection = Nothing
Exit Sub

DebugErr:
   If bolUpdStar = True Then
      cnnConnection.RollbackTrans
      WLog tmpnext & "，更新失敗！" & Err.Description
'      MsgBox "更新失敗！" & vbCrLf & Err.Description
   End If
   WLog tmpnext & " " & Err.Description
End Sub

'Add By Sindy 2011/10/24 更新9001通知開庭者且法定期限<系統日的發文日
Private Sub StrMenu28()
   
On Error GoTo ErrHand
   'Modified by Lydia 2016/09/14 cp27 is null=>CP158=0
   strSql = "update caseprogress " & _
            "set cp27=" & strSrvDate(1) & " " & _
            "where cp01 in ('L','CFL','FCL') " & _
            "and cp10='9001' " & _
            "and CP158=0 " & _
            "and cp07<" & strSrvDate(1)
   cnnConnection.Execute strSql
   Exit Sub
   
ErrHand:
   If Err.Number <> 0 Then
      WLog Err.Description
   End If
End Sub

'Add By Sindy 2011/10/26 試用期滿通知
Sub StrMenu29()
Dim ff As Integer
Dim A01 As String
Dim A02 As String
Dim A03 As String
Dim A04 As String
Dim A05 As String
Dim A06 As String 'Add By Sindy 2023/8/17
Dim TempFileName As String
Dim tmpnext As String
Dim oMailCount As String
'Add By Sindy 2017/1/4
Dim Rs2 As New ADODB.Recordset
Dim strCompDate As String, strIs0229 As String
Dim bolConn As Boolean
Dim strDay As String
Dim strData As String
'2017/1/4 END
Dim strFormulation As String, m_Type As String
Dim strNote As String, m_Year As String
Dim strTemp As String
Dim strTempFile As String, strContent
   
On Error GoTo DebugErr
   
   'Add By Sindy 2022/8/3
   strTempFile = App.path & "\$同仁資料刊登網頁表.docx"
   Call PUB_ReadDB2File(strTempFile, 3, "M21")
   '2022/8/3 END
   
   TempFileName = ""
   '試用期滿通知
   'oMailCount = Pub_GetSpecMan("試用期滿通知")
   
   'Add By Sindy 2020/8/31
   If Dir(App.path & TextPath & "*試用期滿通知*.txt") <> "" Then
      Kill App.path & TextPath & "*試用期滿通知*.txt"
   End If
   '2020/8/31 END
   
   'modify by sonia 2015/5/20 加入L02法務部,因為P31,F31併入L02
   'Modify By Sindy 2015/12/25 取消 and (st03 in ('F21','P11','L01','L02','P31','F31') or substr(st03,1,2)='F1' or substr(st03,1,2)='P2')
   '                           改讀取a0912
   'Modify By Sindy 2021/7/28 + and substr(st01,4,1)<>'9'
   'Modify By Sindy 2023/8/17 + staff_specialty
   'Added by Lydia 2023/12/22
   If strSrvDate(1) >= 新部門啟用日 Then
      strSql = "select NVL(A0922,A0902) AS A0902,st02,ac03,st38,st39,nvl(a0926,a0912) AS A0912,ss04,nvl(a0923,a0902) as RepTitle" & _
               " From staff, acc090,acc090new, allcode,staff_specialty" & _
               " where st03=a0901(+) and st93=a0921(+) and ac01='03' and st37=ac02(+)" & _
               " and a0912 is not null" & _
               " and st04='1' and substr(st01,4,1)<>'9'" & _
               " and to_char(to_date(st29,'YYYYMMDD')+1,'YYYYMMDD')=" & strSrvDate(1) & _
               " and st01=ss01(+)" & _
               " order by nvl(a0926,a0912) asc,NVL(ST93,st03) asc,st01 asc"
   Else
   'end 2023/12/22
      'Modified by Lydia 2023/12/22 +
      strSql = "select a0902,st02,ac03,st38,st39,a0912,ss04,a0902 as RepTitle" & _
               " From staff, acc090, allcode,staff_specialty" & _
               " where st03=a0901(+) and ac01='03' and st37=ac02(+)" & _
               " and a0912 is not null" & _
               " and st04='1' and substr(st01,4,1)<>'9'" & _
               " and to_char(to_date(st29,'YYYYMMDD')+1,'YYYYMMDD')=" & strSrvDate(1) & _
               " and st01=ss01(+)" & _
               " order by a0912 asc,st03 asc,st01 asc"
   End If
   CheckOC
   Set Rs = New ADODB.Recordset
   Rs.CursorLocation = adUseClient
   Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   tmpnext = "已取得資料..."
   With Rs
      If .RecordCount > 0 Then
         'Add By Sindy 2022/8/3
         If Dir(strTempFile) = "" Then
            PUB_SendMail strUserNum, "97038", "", "同仁資料刊登網頁表.docx下載失敗！", "同仁資料刊登網頁表.docx下載失敗！" & vbCrLf & _
                                     "請處理每日批次作業(StrMenu29 - 僅試用期滿通知), 因為此錯誤而未執行到, 請手動處理~"
            GoTo RunNext
         Else
            'Modify By Sindy 2023/11/28 填寫完成後請通知上架同仁（夏慧珠）刊登 >= 改 陳麗(Text73035.Text)
            'Modify By Sindy 2025/1/13 因官網改版，更新通知函中的網址連結
            'Modify By Sindy 2025/7/17（楊雯芳、陳增廣）改為（bd@taie.com.tw）
            '同仁（陳麗" & Text73035.Text & "）刊登 改為 同仁（" & GetPrjSalesNM("73035") & "）刊登
            strContent = "Dear Sirs," & vbCrLf & _
                         vbCrLf & _
                         "試用期滿通知, 如附件!" & vbCrLf & _
                         vbCrLf & _
                         "如貴部同意將附件同仁的資料刊登於台一官網，敬請填寫附件「同仁資料刊登網頁表」，中文及英文資料為必填。" & vbCrLf & _
                         vbCrLf & _
                         "1. 填寫完成後請通知上架同仁（" & GetPrjSalesNM("73035") & "）刊登" & vbCrLf & _
                         "2. 副知業務拓展部（bd@taie.com.tw）以及日文網頁負責者（專利：簡偉倫、商標：葉易雲、法律：江郁仁）" & vbCrLf & _
                         vbCrLf & _
                         "同仁資料會刊登於台一官網的專業團隊，以下連結供參。" & vbCrLf & _
                         "https://www.taie.com.tw/ip-team.php?cid=4#anchor1" & vbCrLf & _
                         "https://www.taie.com.tw/en/team.php" & vbCrLf & _
                         "https://www.taie.com.tw/jp/team.php" & vbCrLf & vbCrLf & _
                         "                                                        電腦中心"
         End If
         '2022/8/3 END
         
         .MoveFirst
         Do While Not .EOF
            'Modify By Sindy 2015/12/25
            If oMailCount <> "" And oMailCount <> .Fields("a0912") Then
               Close ff
               tmpnext = "關檔..."
               'Modify By Sindy 2022/9/1 + 副本:Pub_GetSpecMan("試用期滿通知")
               SendMAPIMail oMailCount, ChangeWStringToTDateString(strSrvDate(1)) & "試用期滿通知，請提供相關資料以利刊登台一官網", strContent, App.path & TextPath & TempFileName & ".txt;" & strTempFile, , True, Pub_GetSpecMan("試用期滿通知")
               'Add By Sindy 2021/3/16
               SendMAPIMail Pub_GetSpecMan("試用期滿追蹤薪資人員"), ChangeWStringToTDateString(strSrvDate(1)) & "試用期滿通知，請自行追蹤附件同仁的調薪資料。", "Dear Sirs," & vbCrLf & "          試用期滿通知　如附件！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", App.path & TextPath & TempFileName & ".txt", , True
               '2021/3/16 END
               TempFileName = ""
            End If
            If TempFileName = "" Then
               'Modified by Lydia 2023/12/22 改成報表用"部門名稱-報表用" ; .Fields(0)=>.Fields("RepTitle")
               TempFileName = strSrvDate(2) & "-試用期滿通知-" & .Fields("RepTitle")
               ff = FreeFile
               If ff > 0 Then Close #ff
               Open App.path & TextPath & TempFileName & ".txt" For Output As ff
               'Added by Lydia 2016/10/19 加報表抬頭
               Print #ff, Space(10) & TempFileName
               Print #ff, ""
               'end 2016/10/19
               'Modify By Sindy 2023/8/17 + 智財專業證照
               Print #ff, "部門別       姓名         最高學歷     畢業學校     科系            智財專業證照                  "
               Print #ff, "============ ============ ============ ============ =============== =============================="
              tmpnext = "開檔中..."
            End If
            A01 = "" & convForm(CheckStr(.Fields(0).Value), 12)
            A02 = "" & convForm(CheckStr(.Fields(1).Value), 12)
            A03 = "" & convForm(CheckStr(.Fields(2).Value), 12)
            A04 = "" & convForm(CheckStr(.Fields(3).Value), 12)
            A05 = "" & convForm(CheckStr(.Fields(4).Value), 12)
            A06 = "" & CheckStr(.Fields("ss04").Value) 'Add By Sindy 2023/8/17
            tmpnext = "寫檔..."
            'Modify By Sindy 2023/8/17 + A06
            Print #ff, A01 & " " & A02 & " " & A03 & " " & A04 & " " & A05 & " " & A06
            
            oMailCount = .Fields("a0912")
            '2015/12/25 END
            .MoveNext
         Loop
      End If
   End With
   Close ff
   tmpnext = "關檔..."
   'If TempFileName <> "" Then
   If oMailCount <> "" And TempFileName <> "" Then
      'Modify By Sindy 2022/9/1 + 副本:Pub_GetSpecMan("試用期滿通知")
      SendMAPIMail oMailCount, ChangeWStringToTDateString(strSrvDate(1)) & "試用期滿通知，請提供相關資料以利刊登台一官網", strContent, App.path & TextPath & TempFileName & ".txt;" & strTempFile, , True, Pub_GetSpecMan("試用期滿通知")
      'Add By Sindy 2021/3/16
      SendMAPIMail Pub_GetSpecMan("試用期滿追蹤薪資人員"), ChangeWStringToTDateString(strSrvDate(1)) & "試用期滿通知，請自行追蹤附件同仁的調薪資料。", "Dear Sirs," & vbCrLf & "          試用期滿通知　如附件！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", App.path & TextPath & TempFileName & ".txt", , True
      '2021/3/16 END
   End If
   
RunNext:
   '***************************************************************************************************
   '***************************************************************************************************
   'Add By Sindy 2017/1/4 增加檢查員工到職滿半年及滿一年,給其特別假
   'Modify By Sindy 2017/10/13 劉經理通知職滿當日給假, ex:106/4/1來,106/10/1當日給假
'st13       to_char(add_months(to_date(st13,'YYYYMMDD'),6),'YYYYMMDD')
'---------- ----------------------------------------------------------
'20170401   20171001
   'strCompDate = CompDate(2, -1, strSrvDate(1)) '前一日
   strCompDate = strSrvDate(1) '當日
   '2017/10/13 END
   '檢查是否有0228問題
   strIs0229 = ""
   If Right(strCompDate, 4) = "0228" Then
      If IsDate(ChangeWStringToWDateString(Left(strCompDate, 4) - 1 & "0229")) = True Then
         strIs0229 = Left(strCompDate, 4) - 1 & "0229"
      End If
   End If
   '滿半年者
   'Modify By Sindy 2021/7/28 + and substr(st01,4,1)<>'9'
   strSql = "select st01,st02,st13,st40,st72,'1' as st_Type" & _
            " From staff,SalaryData" & _
            " where st04='1' and substr(st01,4,1)<>'9'" & _
            " and st13 is not null" & _
            " and ST01=SD01 and (sd02 not in('P','F') or sd02 is null)"
   If strIs0229 <> "" Then
      strSql = strSql & " and (to_char(add_months(to_date(st13,'YYYYMMDD'),6),'YYYYMMDD')='" & strCompDate & "'" & _
                          " or to_char(add_months(to_date(st13,'YYYYMMDD'),6),'YYYYMMDD')='" & strIs0229 & "')"
   Else
      strSql = strSql & " and to_char(add_months(to_date(st13,'YYYYMMDD'),6),'YYYYMMDD')='" & strCompDate & "'"
   End If
   'Add By Sindy 2019/8/12 有留職停薪
   'Modify By Sindy 2021/7/28 + and substr(st01,4,1)<>'9'
   strSql = strSql & " union " & _
            "select st01,st02,st13,st40,st72,'2' as st_Type" & _
            " From staff,SalaryData" & _
            " where st04='1' and substr(st01,4,1)<>'9'" & _
            " and st72>0" & _
            " and ST01=SD01 and (sd02 not in('P','F') or sd02 is null)"
   If strIs0229 <> "" Then
      strSql = strSql & " and (decode(st72,0,0,to_char(add_months(to_date(st72,'YYYYMMDD'),6),'YYYYMMDD'))='" & strCompDate & "'" & _
                        " or decode(st72,0,0,to_char(add_months(to_date(st72,'YYYYMMDD'),6),'YYYYMMDD'))='" & strIs0229 & "')"
   Else
      strSql = strSql & " and decode(st72,0,0,to_char(add_months(to_date(st72,'YYYYMMDD'),6),'YYYYMMDD'))='" & strCompDate & "'"
   End If
   '2019/8/12 END
   strSql = strSql & " order by st13,st01"
   CheckOC
   Set Rs = New ADODB.Recordset
   Rs.CursorLocation = adUseClient
   Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   tmpnext = "已取得滿半年資料..."
   With Rs
      If .RecordCount > 0 Then
         .MoveFirst
         Do While Not .EOF
            tmpnext = "寫檔..."
            
            'Add By Sindy 2019/8/12
            '檢查是否有留職停薪特休起算日
            If Val("" & Rs.Fields("st72")) > 0 Then
               If "" & Rs.Fields("st_Type") = "2" Then
                  '計算年資
                  m_Year = Trim(CalYear(Rs.Fields("st01"), strSrvDate(1)))
                  If m_Year < 1 Then
                     strData = Pub_BackTaieToDate(Rs.Fields("st01"), "", strNote)
                  Else
                     GoTo ReadNext6M '滿半年,才要往下Run
                  End If
               Else
                  GoTo ReadNext6M
               End If
            End If
            '2019/8/12 END
            
            strData = Rs.Fields("st01") & Rs.Fields("st02") & "年資已滿半年,到職日" & ChangeWStringToWDateString(Rs.Fields("st13"))
            'Modify By Sindy 2024/1/12 + ,yv03
            strSql = "select yv01,yv03,yv04 from YearVacation where yv01='" & Left(strCompDate, 4) & "' and yv02='" & .Fields("st01") & "'"
            intI = 1
            Set Rs2 = ClsLawReadRstMsg(intI, strSql)
            If intI = 1 Then 'Add By Sindy 2024/8/7
               'Add By Sindy 2024/1/12 已記錄滿半年者,跳過
               If Rs2.Fields("yv03") = 0.5 Then GoTo ReadNext6M
               '2024/1/12 END
            End If
            
            cnnConnection.BeginTrans
            bolConn = True
            If intI = 0 Then
               'Modify By Sindy 2019/1/28
               'cnnConnection.Execute "insert into YearVacation (yv01,yv02,yv03,yv04) values ('" & Left(strCompDate, 4) & "','" & .Fields("st01") & "','0.5','3')"
               'Modify By Sindy 2021/2/18 + yv11=strSrvDate(1)
               strSql = "INSERT INTO YearVacation (yv01,yv02,yv03,yv04,yv11) VALUES ('" & Left(strCompDate, 4) & "','" & .Fields("st01") & "','0.5','3'," & strSrvDate(1) & ")"
               Pub_SeekTbLog strSql
               cnnConnection.Execute strSql
            Else
               'Modify By Sindy 2019/1/28
               'cnnConnection.Execute "update YearVacation set yv03='0.5',yv04='3' where yv01='" & Left(strCompDate, 4) & "' and yv02='" & .Fields("st01") & "'"
               'Modify By Sindy 2021/2/18 + yv11=strSrvDate(1)
               strSql = "begin user_data.user_enabled:=1; UPDATE YearVacation SET yv03='0.5',yv04='3',yv11=" & strSrvDate(1) & " WHERE yv01='" & Left(strCompDate, 4) & "' and yv02='" & .Fields("st01") & "'; end;"
               Pub_SeekTbLog "UPDATE YearVacation SET yv03='0.5',yv04='3' WHERE yv01='" & Left(strCompDate, 4) & "' and yv02='" & .Fields("st01") & "'"
               cnnConnection.Execute strSql
            End If
            'Modify By Sindy 2019/1/28
            'cnnConnection.Execute "update staff set st40='3' where st01='" & .Fields("st01") & "'"
            strSql = "UPDATE staff SET st40='3' WHERE st01='" & .Fields("st01") & "'"
            Pub_SeekTbLog strSql
            cnnConnection.Execute strSql
            cnnConnection.CommitTrans: bolConn = False
            
            'Add By Sindy 2019/7/17
            'Modify By Sindy 2019/8/12
            strTemp = .Fields("st02") & "同仁，您好：" & vbCrLf & vbCrLf & _
                     "　　　　通知您 " & Left(strSrvDate(2), 3) & " 年度特別休假日數如下:" & vbCrLf & vbCrLf & _
                     "　　　　到職日為 " & Val(Left(.Fields("st13"), 4)) - 1911 & " 年 " & Mid(.Fields("st13"), 5, 2) & " 月 " & Mid(.Fields("st13"), 7, 2) & " 日，年資 0.5 年" & vbCrLf & vbCrLf
            If Val("" & Rs.Fields("st72")) > 0 Then
               strTemp = strTemp & strNote
               strTemp = strTemp & "　　　　留職停薪後的起算日為 " & Val(Left(Rs.Fields("st72"), 4)) - 1911 & " 年 " & Mid(Rs.Fields("st72"), 5, 2) & " 月 " & Mid(Rs.Fields("st72"), 7, 2) & " 日" & vbCrLf & vbCrLf
            End If
            strTemp = strTemp & "　　　　特別休假日數 3 日" & vbCrLf & vbCrLf
            strTemp = strTemp & vbCrLf & "　　　　　　人事處啟" & vbCrLf
            '2019/8/12 END
            
            'Add By Sindy 2024/1/30
            If ChkStaffST14(.Fields("st01"), False) = True Then
               'Modify By Sindy 2024/3/11 副本改用 國外大陸出差通知人員
               SendMAPIMail Pub_GetSpecMan("人事室出缺勤電子簽核"), "[無信箱,請人工通知]" & Left(strSrvDate(2), 3) & "年度特別休假通知函", _
                        strTemp, , , True, Pub_GetSpecMan("國外大陸出差通知人員")
            Else
            '2024/1/30 END
               'Modify By Sindy 2024/3/11 副本改用 國外大陸出差通知人員
               SendMAPIMail .Fields("st01"), Left(strSrvDate(2), 3) & "年度特別休假通知函", _
                        strTemp, , , True, Pub_GetSpecMan("國外大陸出差通知人員")
            End If
ReadNext6M:
            .MoveNext
         Loop
      End If
   End With
   '滿1年者
   'Modify By Sindy 2021/7/28 + and substr(st01,4,1)<>'9'
   strSql = "select st01,st02,st13,st40,st72,'1' as st_Type" & _
            " From staff,SalaryData" & _
            " where st04='1' and substr(st01,4,1)<>'9'" & _
            " and st13 is not null" & _
            " and ST01=SD01 and (sd02 not in('P','F') or sd02 is null)"
   If strIs0229 <> "" Then
      strSql = strSql & " and (to_char(add_months(to_date(st13,'YYYYMMDD'),12),'YYYYMMDD')='" & strCompDate & "'" & _
                          " or to_char(add_months(to_date(st13,'YYYYMMDD'),12),'YYYYMMDD')='" & strIs0229 & "')"
   Else
      strSql = strSql & " and to_char(add_months(to_date(st13,'YYYYMMDD'),12),'YYYYMMDD')='" & strCompDate & "'"
   End If
   'Add By Sindy 2019/8/12 有留職停薪
   'Modify By Sindy 2021/7/28 + and substr(st01,4,1)<>'9'
   strSql = strSql & " union select st01,st02,st13,st40,st72,'2' as st_Type" & _
            " From staff,SalaryData" & _
            " where st04='1' and substr(st01,4,1)<>'9'" & _
            " and st72>0" & _
            " and ST01=SD01 and (sd02 not in('P','F') or sd02 is null)"
   If strIs0229 <> "" Then
      strSql = strSql & " and (decode(st72,0,0,to_char(add_months(to_date(st72,'YYYYMMDD'),12),'YYYYMMDD'))='" & strCompDate & "'" & _
                            " or decode(st72,0,0,to_char(add_months(to_date(st72,'YYYYMMDD'),12),'YYYYMMDD'))='" & strIs0229 & "')"
   Else
      strSql = strSql & " and decode(st72,0,0,to_char(add_months(to_date(st72,'YYYYMMDD'),12),'YYYYMMDD'))='" & strCompDate & "'"
   End If
   '2019/8/12 END
   strSql = strSql & " order by st13,st01"
   CheckOC
   Set Rs = New ADODB.Recordset
   Rs.CursorLocation = adUseClient
   Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   tmpnext = "已取得滿1年資料..."
   With Rs
      If .RecordCount > 0 Then
         .MoveFirst
         Do While Not .EOF
            tmpnext = "寫檔..."

            'Add By Sindy 2019/8/12
            '檢查是否有留職停薪特休起算日
            strData = Rs.Fields("st13")
            If Val("" & Rs.Fields("st72")) > 0 Then
               If "" & Rs.Fields("st_Type") = "2" Then
                  strData = Rs.Fields("st72")
                  '計算年資
                  m_Year = Trim(CalYear(Rs.Fields("st01"), strSrvDate(1)))
                  If m_Year = 1 Then
                     strData = Pub_BackTaieToDate(Rs.Fields("st01"), "", strNote)
                  Else
                     GoTo ReadNext12M '滿1年,才要往下Run
                  End If
               Else
                  GoTo ReadNext12M
               End If
            End If
            '2019/8/12 END
            
            'strData = rs.Fields("st01") & rs.Fields("st02") & "年資已滿1年,到職日" & ChangeWStringToWDateString(rs.Fields("st13"))

'            '檢查到職日是否為當月工作的第1天,若是該月則足月計算,否則不列入該月統計
'            For ii = 1 To 31
'               strMonthWorkDate = Left(.Fields("st13"), 6) & Format(ii, "00")
'               If IsDate(ChangeWStringToWDateString(strMonthWorkDate)) = True _
'                  And ChkWorkDay(strMonthWorkDate) = True Then
'                  Exit For
'               End If
'            Next ii
'            If .Fields("st13") <= strMonthWorkDate Then
'               intMonth = 12 - Val(Mid(.Fields("st13"), 5, 2)) + 1
'            Else
'               intMonth = 12 - Val(Mid(.Fields("st13"), 5, 2))
'            End If
'            strDay = (0.5 * intMonth) + 1
'            strDay = strDay + .Fields("st40")
'            '***** END
            
            'Modify By Sindy 2020/10/14 + bolAutoBatch = True
            strDay = CountRestDay(strData, .Fields("st40"), Left(strSrvDate(1), 4), strFormulation, m_Type, True)
            'Modify By Sindy 2024/1/12 + ,yv03
            strSql = "select yv01,yv03,yv04 from YearVacation where yv01='" & Left(strCompDate, 4) & "' and yv02='" & .Fields("st01") & "'"
            intI = 1
            Set Rs2 = ClsLawReadRstMsg(intI, strSql)
            If intI = 1 Then 'Add By Sindy 2024/8/7
               'Add By Sindy 2024/1/12 已記錄滿一年者,跳過
               If Rs2.Fields("yv03") = 1 Then GoTo ReadNext12M
               '2024/1/12 END
            End If
            
            cnnConnection.BeginTrans
            bolConn = True
            If intI = 0 Then
               'Modify By Sindy 2019/1/28
               'cnnConnection.Execute "insert into YearVacation (yv01,yv02,yv03,yv04) values ('" & Left(strCompDate, 4) & "','" & .Fields("st01") & "','1','" & strDay & "')"
               'Modify By Sindy 2019/7/17 + ,yv12,yv13
               'Modify By Sindy 2021/2/18 + yv11=strSrvDate(1)
               strSql = "INSERT INTO YearVacation (yv01,yv02,yv03,yv04,yv11,yv12,yv13) VALUES ('" & Left(strCompDate, 4) & "','" & .Fields("st01") & "','1','" & strDay & "'," & strSrvDate(1) & ",'" & m_Type & "','" & strFormulation & "')"
               Pub_SeekTbLog strSql
               cnnConnection.Execute strSql
            Else
               'Modify By Sindy 2019/1/28
               'cnnConnection.Execute "update YearVacation set yv03='1',yv04='" & strDay & "' where yv01='" & Left(strCompDate, 4) & "' and yv02='" & .Fields("st01") & "'"
               'Modify By Sindy 2019/7/17 + ,yv12,yv13
               'Modify By Sindy 2021/2/18 + yv11=strSrvDate(1)
               strSql = "begin user_data.user_enabled:=1; UPDATE YearVacation SET yv03='1',yv04='" & strDay & "',yv11=" & strSrvDate(1) & ",yv12='" & m_Type & "',yv13='" & strFormulation & "' WHERE yv01='" & Left(strCompDate, 4) & "' and yv02='" & .Fields("st01") & "'; end;"
               Pub_SeekTbLog "UPDATE YearVacation SET yv03='1',yv04='" & strDay & "',yv11=" & strSrvDate(1) & ",yv12='" & m_Type & "',yv13='" & strFormulation & "' WHERE yv01='" & Left(strCompDate, 4) & "' and yv02='" & .Fields("st01") & "'"
               cnnConnection.Execute strSql
            End If
            'Modify By Sindy 2019/1/28
            'cnnConnection.Execute "update staff set st40='" & strDay & "' where st01='" & .Fields("st01") & "'"
            strSql = "UPDATE staff SET st40='" & strDay & "' WHERE st01='" & .Fields("st01") & "'"
            Pub_SeekTbLog strSql
            cnnConnection.Execute strSql
            cnnConnection.CommitTrans: bolConn = False
            
            'Add By Sindy 2019/7/17
            'Modify By Sindy 2019/8/12
            strTemp = .Fields("st02") & "同仁，您好：" & vbCrLf & vbCrLf & _
                     "　　　　通知您 " & Left(strSrvDate(2), 3) & " 年度特別休假日數如下:" & vbCrLf & vbCrLf & _
                     "　　　　到職日為 " & Val(Left(.Fields("st13"), 4)) - 1911 & " 年 " & Mid(.Fields("st13"), 5, 2) & " 月 " & Mid(.Fields("st13"), 7, 2) & " 日，年資 1 年" & vbCrLf & vbCrLf
            If Val("" & Rs.Fields("st72")) > 0 Then
               strTemp = strTemp & strNote
               strTemp = strTemp & "　　　　留職停薪後的起算日為 " & Val(Left(Rs.Fields("st72"), 4)) - 1911 & " 年 " & Mid(Rs.Fields("st72"), 5, 2) & " 月 " & Mid(Rs.Fields("st72"), 7, 2) & " 日" & vbCrLf & vbCrLf
            End If
            strTemp = strTemp & "　　　　特別休假日數 " & strDay & " 日" & vbCrLf & vbCrLf & _
                                IIf(strFormulation <> "", "　　　　" & strFormulation & vbCrLf & vbCrLf, "") & _
                                vbCrLf & "　　　　　　人事處啟" & vbCrLf
            '2019/8/12 END
            'SendMAPIMail .Fields("st01"), "【補通知】" & Left(strSrvDate(2), 3) & "年度特別休假通知函",
            'Add By Sindy 2024/1/30
            If ChkStaffST14(.Fields("st01"), False) = True Then
               'Modify By Sindy 2024/3/11 副本改用 國外大陸出差通知人員
               SendMAPIMail Pub_GetSpecMan("人事室出缺勤電子簽核"), "[無信箱,請人工通知]" & Left(strSrvDate(2), 3) & "年度特別休假通知函", _
                        strTemp, , , True, Pub_GetSpecMan("國外大陸出差通知人員")
            Else
            '2024/1/30 END
               'Modify By Sindy 2024/3/11 副本改用 國外大陸出差通知人員
               SendMAPIMail .Fields("st01"), Left(strSrvDate(2), 3) & "年度特別休假通知函", _
                        strTemp, , , True, Pub_GetSpecMan("國外大陸出差通知人員")
            End If
ReadNext12M:
            .MoveNext
         Loop
      End If
   End With
   '2017/1/4 END
   '***************************************************************************************************
   '***************************************************************************************************
   
   Set Rs = Nothing
   Exit Sub
   
DebugErr:
   If bolConn = True Then cnnConnection.RollbackTrans
   WLog tmpnext & " " & Err.Description
End Sub

'Add By Sindy 2012/4/3 非台灣專利案工程師分案通知(2012/4/9改全部發)
Sub StrMenu30()
Dim ff As Integer
Dim A01 As String
Dim A02 As String
Dim A03 As String
Dim A04 As String
Dim A05 As String
Dim A06 As String
Dim A07 As String
Dim TempFileName As String
Dim tmpnext As String
Dim ChkDate1 As String
'Dim ChkDate2 As String
Dim strTemp As String
Dim strTemp2 As String
Dim strCP157 As String
Dim strSubject As String, strContent As String

On Error GoTo DebugErr
   
   'Modify By Sindy 2017/10/27
   '原通知條件為北所前一個工作天及分所前二個工作天收文的非台灣案,
   '改為北所分案日cp157的隔日通知
'   ChkDate1 = CompWorkDay(2, strSrvDate(1), 1) '北所前一個工作天
'   ChkDate2 = CompWorkDay(3, strSrvDate(1), 1) '分所前二個工作天
   ChkDate1 = CompWorkDay(2, strSrvDate(1), 1) '前一個工作天
   
   'Added by Lydia 2023/12/22
   If ChkDate1 >= 新部門啟用日 Then
      strSql = "select cp13,sp08,decode(cu04,null,decode(cu05,null,cu06,cu05||' '||cu88||' '||cu89||' '||cu90),cu04),cp14,s1.st02 as CP14n,cp01||'-'||cp02||'-'||cp03||'-'||cp04,sp05||sp06||sp07,sp09,na03,cp10,decode(sp09,'000',cpm03,cpm04),CP157,s2.st06,s1.st02 as CP13n,NVL(A0922,A0902) AS A0902 " & _
               "from caseprogress,staff s1,staff s2,servicepractice,customer,nation,casepropertymap,ACC090, ACC090new " & _
               "Where cp157=" & ChkDate1 & " and substr(cp09,1,1)='A' and cp01 in('PS','CPS') and CP159=0 " & _
               "and cp01=sp01(+) and cp02=sp02(+) and cp03=sp03(+) and cp04=sp04(+) and sp09<>'000' " & _
               "and substr(cp12,1,1)<>'F' " & _
               "and cp14=s1.st01(+) and s1.ST03=A0901 AND S1.ST93=A0921(+) and not (s1.st03='P12' and cp158>0) " & _
               "and cp13=s2.st01(+) and s2.st06='1' " & _
               "and substr(sp08,1,8)=cu01(+) and substr(sp08,9,1)=cu02(+) " & _
               "and sp09=na01(+) " & _
               "and cp01=cpm01(+) and cp10=cpm02(+) "
      strSql = strSql & "Union select cp13,pa26,decode(cu04,null,decode(cu05,null,cu06,cu05||' '||cu88||' '||cu89||' '||cu90),cu04),cp14,s1.st02 as CP14n,cp01||'-'||cp02||'-'||cp03||'-'||cp04,pa05||pa06||pa07,pa09,na03,cp10,decode(pa09,'000',cpm03,cpm04),CP157,s2.st06,s1.st02 as CP13n,NVL(A0922,A0902) AS A0902 " & _
               "from caseprogress,staff s1,staff s2,patent,customer,nation,casepropertymap,ACC090, ACC090new " & _
               "Where cp157=" & ChkDate1 & " and substr(cp09,1,1)='A' and cp01 in('P','CFP') and CP159=0 " & _
               "and cp01=pa01(+) and cp02=pa02(+) and cp03=pa03(+) and cp04=pa04(+) and pa09<>'000' " & _
               "and substr(cp12,1,1)<>'F' " & _
               "and cp14=s1.st01(+) and s1.ST03=A0901 AND S1.ST93=A0921(+) and not (s1.st03='P12' and cp158>0) " & _
               "and cp13=s2.st01(+) and s2.st06='1' " & _
               "and substr(pa26,1,8)=cu01(+) and substr(pa26,9,1)=cu02(+) " & _
               "and pa09=na01(+) " & _
               "and cp01=cpm01(+) and cp10=cpm02(+) "
      strSql = strSql & "Union select cp13,sp08,decode(cu04,null,decode(cu05,null,cu06,cu05||' '||cu88||' '||cu89||' '||cu90),cu04),cp14,s1.st02 as CP14n,cp01||'-'||cp02||'-'||cp03||'-'||cp04,sp05||sp06||sp07,sp09,na03,cp10,decode(sp09,'000',cpm03,cpm04),CP157,s2.st06,s1.st02 as CP13n,NVL(A0922,A0902) AS A0902 " & _
               "from caseprogress,staff s1,staff s2,servicepractice,customer,nation,casepropertymap,ACC090, ACC090new " & _
               "Where cp157=" & ChkDate1 & " and substr(cp09,1,1)='A' and cp01 in('PS','CPS') and CP159=0 " & _
               "and cp01=sp01(+) and cp02=sp02(+) and cp03=sp03(+) and cp04=sp04(+) and sp09<>'000' " & _
               "and substr(cp12,1,1)<>'F' " & _
               "and cp14=s1.st01(+) and s1.ST03=A0901 AND S1.ST93=A0921(+) and not (s1.st03='P12' and cp158>0) " & _
               "and cp13=s2.st01(+) and s2.st06<>'1' " & _
               "and substr(sp08,1,8)=cu01(+) and substr(sp08,9,1)=cu02(+) " & _
               "and sp09=na01(+) " & _
               "and cp01=cpm01(+) and cp10=cpm02(+) "
      strSql = strSql & "Union select cp13,pa26,decode(cu04,null,decode(cu05,null,cu06,cu05||' '||cu88||' '||cu89||' '||cu90),cu04),cp14,s1.st02 as CP14n,cp01||'-'||cp02||'-'||cp03||'-'||cp04,pa05||pa06||pa07,pa09,na03,cp10,decode(pa09,'000',cpm03,cpm04),CP157,s2.st06,s1.st02 as CP13n,NVL(A0922,A0902) AS A0902 " & _
               "from caseprogress,staff s1,staff s2,patent,customer,nation,casepropertymap,ACC090, ACC090new " & _
               "Where cp157=" & ChkDate1 & " and substr(cp09,1,1)='A' and cp01 in('P','CFP') and CP159=0 " & _
               "and cp01=pa01(+) and cp02=pa02(+) and cp03=pa03(+) and cp04=pa04(+) and pa09<>'000' " & _
               "and substr(cp12,1,1)<>'F' " & _
               "and cp14=s1.st01(+) and s1.ST03=A0901 AND S1.ST93=A0921(+) and not (s1.st03='P12' and cp158>0) " & _
               "and cp13=s2.st01(+) and s2.st06<>'1' " & _
               "and substr(pa26,1,8)=cu01(+) and substr(pa26,9,1)=cu02(+) " & _
               "and pa09=na01(+) " & _
               "and cp01=cpm01(+) and cp10=cpm02(+) "
   Else
   'end 2023/12/22
      'Modify By Sindy 2012/4/5 且承辦人為P10或P11(刪除101/4/9) ==> and s1.st03 in('P10','P11')
      'Modified by Lydia 2016/09/14 CP57 is null=>CP159=0
      'Modified by Lydia 2017/03/20 取消P案承辦人員為程序(P12)且已發文的分案通知 + and not (s1.st03='P12' and cp158>0)
      'Modified by Lydia 2018/06/05 修改顯示案件性質 '020',CPM04,CPM03 => '000',CPM03,CPM04
      strSql = "select cp13,sp08,decode(cu04,null,decode(cu05,null,cu06,cu05||' '||cu88||' '||cu89||' '||cu90),cu04),cp14,s1.st02,cp01||'-'||cp02||'-'||cp03||'-'||cp04,sp05||sp06||sp07,sp09,na03,cp10,decode(sp09,'000',cpm03,cpm04),CP157,s2.st06,s2.st02,A0902 " & _
               "from caseprogress,staff s1,staff s2,servicepractice,customer,nation,casepropertymap,ACC090 " & _
               "Where cp157=" & ChkDate1 & " and substr(cp09,1,1)='A' and cp01 in('PS','CPS') and CP159=0 " & _
               "and cp01=sp01(+) and cp02=sp02(+) and cp03=sp03(+) and cp04=sp04(+) and sp09<>'000' " & _
               "and substr(cp12,1,1)<>'F' " & _
               "and cp14=s1.st01(+) and s1.ST03=A0901 and not (s1.st03='P12' and cp158>0) " & _
               "and cp13=s2.st01(+) and s2.st06='1' " & _
               "and substr(sp08,1,8)=cu01(+) and substr(sp08,9,1)=cu02(+) " & _
               "and sp09=na01(+) " & _
               "and cp01=cpm01(+) and cp10=cpm02(+) "
      'Modified by Lydia 2017/03/20 取消P案承辦人員為程序(P12)且已發文的分案通知 + and not (s1.st03='P12' and cp158>0)
      'Modified by Lydia 2018/06/05 修改顯示案件性質 '020',CPM04,CPM03 => '000',CPM03,CPM04
      strSql = strSql & "Union select cp13,pa26,decode(cu04,null,decode(cu05,null,cu06,cu05||' '||cu88||' '||cu89||' '||cu90),cu04),cp14,s1.st02,cp01||'-'||cp02||'-'||cp03||'-'||cp04,pa05||pa06||pa07,pa09,na03,cp10,decode(pa09,'000',cpm03,cpm04),CP157,s2.st06,s2.st02,A0902 " & _
               "from caseprogress,staff s1,staff s2,patent,customer,nation,casepropertymap,ACC090 " & _
               "Where cp157=" & ChkDate1 & " and substr(cp09,1,1)='A' and cp01 in('P','CFP') and CP159=0 " & _
               "and cp01=pa01(+) and cp02=pa02(+) and cp03=pa03(+) and cp04=pa04(+) and pa09<>'000' " & _
               "and substr(cp12,1,1)<>'F' " & _
               "and cp14=s1.st01(+) and s1.ST03=A0901 and not (s1.st03='P12' and cp158>0) " & _
               "and cp13=s2.st01(+) and s2.st06='1' " & _
               "and substr(pa26,1,8)=cu01(+) and substr(pa26,9,1)=cu02(+) " & _
               "and pa09=na01(+) " & _
               "and cp01=cpm01(+) and cp10=cpm02(+) "
      'Modified by Lydia 2017/03/20 取消P案承辦人員為程序(P12)且已發文的分案通知 + and not (s1.st03='P12' and cp158>0)
      'Modified by Lydia 2018/06/05 修改顯示案件性質 '020',CPM04,CPM03 => '000',CPM03,CPM04
      strSql = strSql & "Union select cp13,sp08,decode(cu04,null,decode(cu05,null,cu06,cu05||' '||cu88||' '||cu89||' '||cu90),cu04),cp14,s1.st02,cp01||'-'||cp02||'-'||cp03||'-'||cp04,sp05||sp06||sp07,sp09,na03,cp10,decode(sp09,'000',cpm03,cpm04),CP157,s2.st06,s2.st02,A0902 " & _
               "from caseprogress,staff s1,staff s2,servicepractice,customer,nation,casepropertymap,ACC090 " & _
               "Where cp157=" & ChkDate1 & " and substr(cp09,1,1)='A' and cp01 in('PS','CPS') and CP159=0 " & _
               "and cp01=sp01(+) and cp02=sp02(+) and cp03=sp03(+) and cp04=sp04(+) and sp09<>'000' " & _
               "and substr(cp12,1,1)<>'F' " & _
               "and cp14=s1.st01(+) and s1.ST03=A0901 and not (s1.st03='P12' and cp158>0) " & _
               "and cp13=s2.st01(+) and s2.st06<>'1' " & _
               "and substr(sp08,1,8)=cu01(+) and substr(sp08,9,1)=cu02(+) " & _
               "and sp09=na01(+) " & _
               "and cp01=cpm01(+) and cp10=cpm02(+) "
      'Modified by Lydia 2017/03/20 取消P案承辦人員為程序(P12)且已發文的分案通知 +and not (s1.st03='P12' and cp158>0)
      'Modified by Lydia 2018/06/05 修改顯示案件性質 '020',CPM04,CPM03 => '000',CPM03,CPM04
      strSql = strSql & "Union select cp13,pa26,decode(cu04,null,decode(cu05,null,cu06,cu05||' '||cu88||' '||cu89||' '||cu90),cu04),cp14,s1.st02,cp01||'-'||cp02||'-'||cp03||'-'||cp04,pa05||pa06||pa07,pa09,na03,cp10,decode(pa09,'000',cpm03,cpm04),CP157,s2.st06,s2.st02,A0902 " & _
               "from caseprogress,staff s1,staff s2,patent,customer,nation,casepropertymap,ACC090 " & _
               "Where cp157=" & ChkDate1 & " and substr(cp09,1,1)='A' and cp01 in('P','CFP') and CP159=0 " & _
               "and cp01=pa01(+) and cp02=pa02(+) and cp03=pa03(+) and cp04=pa04(+) and pa09<>'000' " & _
               "and substr(cp12,1,1)<>'F' " & _
               "and cp14=s1.st01(+) and s1.ST03=A0901 and not (s1.st03='P12' and cp158>0) " & _
               "and cp13=s2.st01(+) and s2.st06<>'1' " & _
               "and substr(pa26,1,8)=cu01(+) and substr(pa26,9,1)=cu02(+) " & _
               "and pa09=na01(+) " & _
               "and cp01=cpm01(+) and cp10=cpm02(+) "
   End If 'Added by Lydia 2023/12/22
   strSql = strSql & "order by cp13,2,cp14,6 " '依申請人+承辦人+本所案號排序
   CheckOC
   Set Rs = New ADODB.Recordset
   Rs.CursorLocation = adUseClient
   Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   tmpnext = "已取得資料..."
   TempFileName = "": strTemp = "": strTemp2 = ""
   With Rs
      If .RecordCount > 0 Then
         .MoveFirst
         Do While Not .EOF
            If .Fields(0) <> strTemp Then
               If strTemp <> "" Then
                  Close ff
                  tmpnext = strTemp & "關檔..."
                  strTemp2 = ""
                  SendMAPIMail strTemp, strSubject, strContent, App.path & TextPath & TempFileName & ".txt"
               End If
               strCP157 = ChangeWStringToTDateString(.Fields("CP157"))
               TempFileName = Val(.Fields("CP157")) - 19110000 & "北所分案之非台灣專利案分案通知"
               strSubject = strCP157 & "北所分案之非台灣專利案分案通知"
               strContent = "Dear Sirs," & vbCrLf & "　　" & strSubject & "　如附件！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心"
               
               ff = FreeFile
               If ff > 0 Then Close #ff
               Open App.path & TextPath & TempFileName & ".txt" For Output As ff
               Print #ff, "                                                 非台灣專利案分案通知"
               Print #ff, ""
               Print #ff, "北所分案日：" & strCP157 & "                                                                              智權員：" & .Fields(13)
               Print #ff, ""
               Print #ff, "申請人               承辦人部門 承辦人   本所案號        案件名稱                                 申請國家　　 案件性質        "
               Print #ff, "==================== ========== ======== =============== ======================================== ============ ================"
               tmpnext = .Fields(0) & "開檔中..."
            End If
            
            A01 = convForm("" & CheckStr(.Fields(2).Value), 20)
            A02 = convForm("" & CheckStr(.Fields(4).Value), 8)
            A03 = convForm("" & CheckStr(.Fields(5).Value), 15)
            A04 = convForm("" & CheckStr(.Fields(6).Value), 40)
            A05 = convForm("" & CheckStr(.Fields(8).Value), 12)
            A06 = convForm("" & CheckStr(.Fields(10).Value), 16)
            A07 = convForm("" & CheckStr(.Fields("a0902").Value), 10)
            tmpnext = "寫檔..."
            If strTemp2 <> "" And strTemp2 <> .Fields(1) & .Fields("cp14") Then
               Print #ff, ""
            ElseIf strTemp2 <> "" And strTemp2 = .Fields(1) & .Fields("cp14") Then
               A01 = convForm("" & CheckStr(" "), 20)
               A02 = convForm("" & CheckStr(" "), 8)
               A07 = convForm("" & CheckStr(" "), 10)
            End If
            Print #ff, A01 & " " & A07 & " " & A02 & " " & A03 & " " & A04 & " " & A05 & " " & A06
            
            strTemp = .Fields(0)
            strTemp2 = .Fields(1) & .Fields("cp14")
            .MoveNext
         Loop
      End If
   End With
   Close ff
   tmpnext = "關檔..."
   If TempFileName <> "" Then
      SendMAPIMail strTemp, strSubject, strContent, App.path & TextPath & TempFileName & ".txt"
   End If
   
   Set Rs = Nothing
   Exit Sub
   
DebugErr:
   WLog tmpnext & " " & Err.Description
End Sub


'Add By Sindy 2012/5/15 台灣商標爭議案未發文未取消收文且未上齊備日案件，通知收文智權人員
Sub StrMenu31()
Dim ff As Integer
Dim A01 As String, A02 As String, A03 As String, A04 As String, A05 As String
Dim A06 As String, A07 As String, A08 As String, A09 As String, A10 As String
Dim A11 As String, A12 As String, A13 As String, A14 As String, A15 As String
Dim A16 As String, A17 As String, A18 As String
Dim TempFileName As String
Dim tmpnext As String
Dim strTemp As String
Dim strSubject As String, strContent As String

On Error GoTo DebugErr
   
   '台灣商標爭議案(含T，FCT案)未發文未取消收文且未上齊備日的案件，若智權人員之ST15非SXX部門且不存在於非智權人但有收文的員工檔NSBHC內，則列出案件明細E-MAIL給收文智權人員
   'Modify By Sindy 2012/6/11 +有承辦人時,業務區第一碼不為F
   'Modify By Sindy 2012/11/27 取消6/11所寫程式and (C1.cp14 is null or (C1.cp14 is not null and substr(C1.cp12,1,1)<>'F'))
   'Modify By Sindy 2012/11/28 排除有分案且承辦人是外商的資料"and (C1.cp14 is null or (C1.cp14 is not null and substr(s2.st03,1,1)<>'F')) "
   'Modified by Lydia 2016/09/14 cp27 is null and cp57 is null=>CP158=0 AND CP159=0
   'Modify By Sindy 2025/7/30 FCT案727分析不屬於爭議案 + FCT_NotTMdebate
   strSql = "select C1.cp13,sqldatet(C1.cp05) as 收文日,C1.cp01||'-'||C1.cp02||'-'||C1.cp03||'-'||C1.cp04 as 本所案號,cpm03 as 案件性質,tm05 as 案件名稱,s1.st02 as 智權人員,s2.st02 as 承辦人,sqldatet(C1.cp06) as 本所期限,sqldatet(C1.cp07) as 法定期限,sqldatet(ep06) as 齊備日,sqldatet(C1.cp48) as 承辦期限,sqldatet(ep28) as 指定會稿日,ep34 as 是否會稿,sqldatet(ep07) as 會稿日,sqldatet(C1.cp27) as 發文日,C1.cp16 As 費用, C1.cp18 As 點數, C1.cp64 As 進度備註, C1.cp09 As 總收文號 " & _
            "from (select * from caseprogress " & _
            "where cp01 in('T','FCT') " & _
            "and cp10 in (" & TMdebate & ") And Not (cp01 = 'FCT' And InStr(" & FCT_NotTMdebate & ", cp10) > 0) and cp05>=" & TMdebateStarDT & " " & _
            "and CP158=0 AND CP159=0) C1,trademark,engineerprogress,casepropertymap,staff s1,staff s2 " & _
            "where C1.cp01=tm01(+) and C1.cp02=tm02(+) and C1.cp03=tm03(+) and C1.cp04=tm04(+) " & _
            "and tm10='000' " & _
            "and C1.cp09=ep02(+) " & _
            "and (ep06 is null or ep06=0) " & _
            "and C1.cp01=cpm01(+) and C1.cp10=cpm02(+) " & _
            "and C1.cp13=s1.st01(+) " & _
            "and C1.cp14=s2.st01(+) " & _
            "and (C1.cp14 is null or (C1.cp14 is not null and substr(s2.st03,1,1)<>'F')) " & _
            "and substr(s1.st15,1,1)<>'S' and C1.cp13 not in(select ns01 from nsbhc) " & _
            "and tm29 is null and tm57 is null "
   'Modified by Lydia 2018/12/10 排序放最後
   '         "order by C1.cp13 asc,收文日 asc,本所案號 asc "
   'Added by Lydia 2018/12/10 +T台灣案非爭議案
   If strSrvDate(1) >= T案收文齊備啟用日 Then
        strSql = strSql & "Union select C2.cp13,sqldatet(C2.cp05) as 收文日,C2.cp01||'-'||C2.cp02||'-'||C2.cp03||'-'||C2.cp04 as 本所案號,cpm03 as 案件性質,tm05 as 案件名稱,s1.st02 as 智權人員,s2.st02 as 承辦人,sqldatet(C2.cp06) as 本所期限,sqldatet(C2.cp07) as 法定期限,sqldatet(ep06) as 齊備日,sqldatet(C2.cp48) as 承辦期限,sqldatet(ep28) as 指定會稿日,ep34 as 是否會稿,sqldatet(ep07) as 會稿日,sqldatet(C2.cp27) as 發文日,C2.cp16 As 費用, C2.cp18 As 點數, C2.cp64 As 進度備註, C2.cp09 As 總收文號 " & _
                 "from (select * from caseprogress " & _
                 "where cp01 ='T' and cp10 not in (" & TMdebate & "," & T案收文齊備排除 & ") and cp05>=" & T案收文齊備啟用日 & " and cp09 like 'A%' " & _
                 "and CP158=0 AND CP159=0) C2,trademark,engineerprogress,casepropertymap,staff s1,staff s2 " & _
                 "where C2.cp01=tm01(+) and C2.cp02=tm02(+) and C2.cp03=tm03(+) and C2.cp04=tm04(+) " & _
                 "and tm10='000' " & _
                 "and C2.cp09=ep02(+) " & _
                 "and (ep06 is null or ep06=0) " & _
                 "and C2.cp01=cpm01(+) and C2.cp10=cpm02(+) " & _
                 "and C2.cp13=s1.st01(+) " & _
                 "and C2.cp14=s2.st01(+) " & _
                 "and (C2.cp14 is null or (C2.cp14 is not null and substr(s2.st03,1,1)<>'F')) " & _
                 "and substr(s1.st15,1,1)<>'S' and C2.cp13 not in(select ns01 from nsbhc) " & _
                 "and tm29 is null and tm57 is null "
   End If
   'Added by Lydia 2022/07/15 TC案之文件齊備日管控: TC台灣案與台灣T案一致，每日批次通知智權人員，並與台灣T案列在同份清單
   strSql = strSql & "Union select C3.cp13,sqldatet(C3.cp05) as 收文日,C3.cp01||'-'||C3.cp02||'-'||C3.cp03||'-'||C3.cp04 as 本所案號,cpm03 as 案件性質,sp05 as 案件名稱,s1.st02 as 智權人員,s2.st02 as 承辦人,sqldatet(C3.cp06) as 本所期限,sqldatet(C3.cp07) as 法定期限,sqldatet(ep06) as 齊備日,sqldatet(C3.cp48) as 承辦期限,sqldatet(ep28) as 指定會稿日,ep34 as 是否會稿,sqldatet(ep07) as 會稿日,sqldatet(C3.cp27) as 發文日,C3.cp16 As 費用, C3.cp18 As 點數, C3.cp64 As 進度備註, C3.cp09 As 總收文號 " & _
           "from (select * from caseprogress " & _
           "where cp01 ='TC' and cp05>=" & T案收文齊備啟用日 & " and cp09 like 'A%' " & _
           "and CP158=0 AND CP159=0) C3,servicepractice,engineerprogress,casepropertymap,staff s1,staff s2 " & _
           "where C3.cp01=sp01(+) and C3.cp02=sp02(+) and C3.cp03=sp03(+) and C3.cp04=sp04(+) " & _
           "and sp09='000' " & _
           "and C3.cp09=ep02(+) " & _
           "and (ep06 is null or ep06=0) " & _
           "and C3.cp01=cpm01(+) and C3.cp10=cpm02(+) " & _
           "and C3.cp13=s1.st01(+) " & _
           "and C3.cp14=s2.st01(+) " & _
           "and (C3.cp14 is null or (C3.cp14 is not null and substr(s2.st03,1,1)<>'F')) " & _
           "and substr(s1.st15,1,1)<>'S' and C3.cp13 not in(select ns01 from nsbhc) " & _
           "and sp15 is null and sp61 is null "
   'end 2022/07/15
   strSql = strSql & "order by 1 asc,收文日 asc,本所案號 asc "
   'end 2018/12/10
   CheckOC
   Set Rs = New ADODB.Recordset
   Rs.CursorLocation = adUseClient
   Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   tmpnext = "已取得資料..."
   TempFileName = "": strTemp = ""
   With Rs
      If .RecordCount > 0 Then
         .MoveFirst
         Do While Not .EOF
            If .Fields(0) <> strTemp Then
               If strTemp <> "" Then
                  Close ff
                  tmpnext = strTemp & "關檔..."
                  SendMAPIMail strTemp, strSubject, strContent, App.path & TextPath & TempFileName & ".txt"
               End If
               'Modified by Lydia 2019/04/10 台灣商標爭議案=> 台灣商標案
               'Modified by Lydia 2022/07/15 台灣商標案 => 台灣商標著作權案
               TempFileName = "台灣商標著作權案未發文未取消收文且未上齊備日的案件明細"
               strSubject = "台灣商標著作權案未發文未取消收文且未上齊備日的案件明細"
               'end 2019/04/10
               strContent = "Dear Sirs," & vbCrLf & "　　" & strSubject & "　如附件！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心"
               
               ff = FreeFile
               If ff > 0 Then Close #ff
               Open App.path & TextPath & TempFileName & ".txt" For Output As ff
               'Modified by Lydia 2019/04/10 台灣商標爭議案=> 台灣商標案
               'Modified by Lydia 2022/07/15 台灣商標案 => 台灣商標著作權案
               Print #ff, "                                                                 台灣商標著作權案未發文未取消收文且未上齊備日的案件明細"
               Print #ff, ""
               Print #ff, "列印日：" & ChangeWStringToTDateString(strSrvDate(1)) & "                                                                                                                                      智權人員：" & .Fields("智權人員")
               Print #ff, ""
               Print #ff, "收文日    本所案號        案件性質             案件名稱             承辦人   本所期限  法定期限  承辦期限  指定會稿日 是否會稿 會稿日    費用     點數   進度備註             總收文號 "
               Print #ff, "========= =============== ==================== ==================== ======== ========= ========= ========= ========== ======== ========= ======== ====== ==================== =========="
               tmpnext = .Fields(0) & "開檔中..."
            End If
            A01 = convForm("" & CheckStr(.Fields("收文日").Value), 9)
            A02 = convForm("" & CheckStr(.Fields("本所案號").Value), 15)
            A03 = convForm("" & CheckStr(.Fields("案件性質").Value), 20)
            A04 = convForm("" & CheckStr(.Fields("案件名稱").Value), 20)
            A05 = convForm("" & CheckStr(.Fields("智權人員").Value), 8)
            A06 = convForm("" & CheckStr(.Fields("承辦人").Value), 8)
            A07 = convForm("" & CheckStr(.Fields("本所期限").Value), 9)
            A08 = convForm("" & CheckStr(.Fields("法定期限").Value), 9)
            A09 = convForm("" & CheckStr(.Fields("齊備日").Value), 9)
            A10 = convForm("" & CheckStr(.Fields("承辦期限").Value), 9)
            A11 = convForm("" & CheckStr(.Fields("指定會稿日").Value), 10)
            A12 = convForm("" & CheckStr(.Fields("是否會稿").Value), 8)
            A13 = convForm("" & CheckStr(.Fields("會稿日").Value), 9)
            A14 = convForm("" & CheckStr(.Fields("發文日").Value), 9)
            A15 = convForm("" & CheckStr(.Fields("費用").Value), 8)
            A16 = convForm("" & CheckStr(.Fields("點數").Value), 6)
            A17 = convForm("" & CheckStr(.Fields("進度備註").Value), 20)
            A18 = convForm("" & CheckStr(.Fields("總收文號").Value), 10)
            
            tmpnext = "寫檔..."
            Print #ff, A01 & " " & A02 & " " & A03 & " " & A04 & " " & A06 & " " & A07 & " " & A08 & " " & A10 & " " & A11 & " " & A12 & " " & A13 & " " & A15 & " " & A16 & " " & A17 & " " & A18
            
            strTemp = .Fields(0)
            .MoveNext
         Loop
      End If
   End With
   Close ff
   tmpnext = "關檔..."
   If TempFileName <> "" And strTemp <> "" Then
      SendMAPIMail strTemp, strSubject, strContent, App.path & TextPath & TempFileName & ".txt"
   End If
   
   Set Rs = Nothing
   Exit Sub
   
DebugErr:
   WLog tmpnext & " " & Err.Description
End Sub

'Add By Sindy 2012/5/15 台灣商標爭議案未發文未取消收文且逾承辦期限且要會稿但未輸入會稿日案件，通知內商主管(ST05=91,92)
Sub StrMenu32()
Dim ff As Integer
Dim A01 As String, A02 As String, A03 As String, A04 As String, A05 As String
Dim A06 As String, A07 As String, A08 As String, A09 As String, A10 As String
Dim A11 As String, A12 As String, A13 As String, A14 As String, A15 As String
Dim A16 As String, A17 As String, A18 As String
Dim TempFileName As String
Dim tmpnext As String
Dim strTemp As String
Dim strSubject As String, strContent As String

On Error GoTo DebugErr
   
   'Modified by Lydia 2022/05/30 改江協理(江郁仁)、林承慧、林嘉雯
'   strSql = "select st01,st02 from staff where st05 in('91','92')"
'   intI = 1
'   strTemp = ""
'   Set RsTemp = ClsLawReadRstMsg(intI, strSql)
'   If intI = 1 Then
'      With RsTemp
'         RsTemp.MoveFirst
'         Do While Not RsTemp.EOF
'            If ChkStaffST04(RsTemp.Fields(0), False) = False Then
'               strTemp = strTemp & RsTemp.Fields(0) & ";"
'            End If
'            RsTemp.MoveNext
'         Loop
'         If strTemp <> "" Then strTemp = Left(strTemp, Len(strTemp) - 1)
'      End With
'   End If
   strTemp = "98020;84027;86048"
   'end 2022/05/30
   
   '台灣商標爭議案(含T，FCT案)未發文未取消收文且逾承辦期限且要會稿但未輸入會稿日的案件，列出案件明細E-MAIL給葉經理及林副理(ST05='91' or '92')
   'Modify By Sindy 2012/6/11 +有承辦人時,業務區第一碼不為F
   'Modify By Sindy 2012/11/27 取消6/11所寫程式and (C1.cp14 is null or (C1.cp14 is not null and substr(C1.cp12,1,1)<>'F'))
   'Modify By Sindy 2012/11/28 排除有分案且承辦人是外商的資料"and (C1.cp14 is null or (C1.cp14 is not null and substr(s2.st03,1,1)<>'F')) "
   'Modified by Lydia 2016/09/14 cp27 is null and cp57 is null=>CP158=0 AND CP159=0
   'Modify By Sindy 2025/7/30 FCT案727分析不屬於爭議案 + FCT_NotTMdebate
   strSql = "select C1.cp13,C1.cp14,sqldatet(C1.cp05) as 收文日,C1.cp01||'-'||C1.cp02||'-'||C1.cp03||'-'||C1.cp04 as 本所案號,cpm03 as 案件性質,tm05 as 案件名稱,s1.st02 as 智權人員,s2.st02 as 承辦人,sqldatet(C1.cp06) as 本所期限,sqldatet(C1.cp07) as 法定期限,sqldatet(ep06) as 齊備日,sqldatet(C1.cp48) as 承辦期限,sqldatet(ep28) as 指定會稿日,ep34 as 是否會稿,sqldatet(ep07) as 會稿日,sqldatet(C1.cp27) as 發文日,C1.cp16 As 費用, C1.cp18 As 點數, C1.cp64 As 進度備註, C1.cp09 As 總收文號 " & _
            "from (select * from caseprogress " & _
            "where cp01 in('T','FCT') " & _
            "and cp10 in (" & TMdebate & ") And Not (cp01 = 'FCT' And InStr(" & FCT_NotTMdebate & ", cp10) > 0) and cp05>=" & TMdebateStarDT & " " & _
            "and CP158=0 AND CP159=0 and cp48<" & strSrvDate(1) & " and cp48 is not null) C1,trademark,engineerprogress,casepropertymap,staff s1,staff s2 " & _
            "where C1.cp01=tm01(+) and C1.cp02=tm02(+) and C1.cp03=tm03(+) and C1.cp04=tm04(+) " & _
            "and tm10='000' " & _
            "and C1.cp09=ep02(+) " & _
            "and ep34='Y' and ep07 is null " & _
            "and C1.cp01=cpm01(+) and C1.cp10=cpm02(+) " & _
            "and C1.cp13=s1.st01(+) " & _
            "and C1.cp14=s2.st01(+) " & _
            "and (C1.cp14 is null or (C1.cp14 is not null and substr(s2.st03,1,1)<>'F')) " & _
            "and tm29 is null and tm57 is null "
   'Modified by Lydia 2018/12/10 排序放最後
   '         "order by C1.cp14 asc,C1.cp13 asc,收文日 asc,本所案號 asc "
   'Added by Lydia 2018/12/10 +T台灣案非爭議案
   If strSrvDate(1) >= T案收文齊備啟用日 Then
        strSql = strSql & "Union select C2.cp13,C2.cp14,sqldatet(C2.cp05) as 收文日,C2.cp01||'-'||C2.cp02||'-'||C2.cp03||'-'||C2.cp04 as 本所案號,cpm03 as 案件性質,tm05 as 案件名稱,s1.st02 as 智權人員,s2.st02 as 承辦人,sqldatet(C2.cp06) as 本所期限,sqldatet(C2.cp07) as 法定期限,sqldatet(ep06) as 齊備日,sqldatet(C2.cp48) as 承辦期限,sqldatet(ep28) as 指定會稿日,ep34 as 是否會稿,sqldatet(ep07) as 會稿日,sqldatet(C2.cp27) as 發文日,C2.cp16 As 費用, C2.cp18 As 點數, C2.cp64 As 進度備註, C2.cp09 As 總收文號 " & _
                 "from (select * from caseprogress " & _
                 "where cp01 ='T' and cp10 not in (" & TMdebate & "," & T案收文齊備排除 & ") and cp05>=" & T案收文齊備啟用日 & " and cp09 like 'A%' " & _
                 "and CP158=0 AND CP159=0 and cp48<" & strSrvDate(1) & " and cp48 is not null) C2,trademark,engineerprogress,casepropertymap,staff s1,staff s2 " & _
                 "where C2.cp01=tm01(+) and C2.cp02=tm02(+) and C2.cp03=tm03(+) and C2.cp04=tm04(+) " & _
                 "and tm10='000' " & _
                 "and C2.cp09=ep02(+) " & _
                 "and ep34='Y' and ep07 is null " & _
                 "and C2.cp01=cpm01(+) and C2.cp10=cpm02(+) " & _
                 "and C2.cp13=s1.st01(+) " & _
                 "and C2.cp14=s2.st01(+) " & _
                 "and (C2.cp14 is null or (C2.cp14 is not null and substr(s2.st03,1,1)<>'F')) " & _
                 "and tm29 is null and tm57 is null "
   End If
   'Added by Lydia 2022/07/15 TC案之文件齊備日管控:  台灣TC案不會稿但是和台灣T案一樣通知內商主管，清單列在同一份即可
   'Modified by Lydia 2024/08/14 debug：參考T台灣案，nvl(ep06,0) > 0=> ep34='Y' and ep07 is null
   strSql = strSql & "Union select C3.cp13,C3.cp14,sqldatet(C3.cp05) as 收文日,C3.cp01||'-'||C3.cp02||'-'||C3.cp03||'-'||C3.cp04 as 本所案號,cpm03 as 案件性質,sp05 as 案件名稱,s1.st02 as 智權人員,s2.st02 as 承辦人,sqldatet(C3.cp06) as 本所期限,sqldatet(C3.cp07) as 法定期限,sqldatet(ep06) as 齊備日,sqldatet(C3.cp48) as 承辦期限,sqldatet(ep28) as 指定會稿日,ep34 as 是否會稿,sqldatet(ep07) as 會稿日,sqldatet(C3.cp27) as 發文日,C3.cp16 As 費用, C3.cp18 As 點數, C3.cp64 As 進度備註, C3.cp09 As 總收文號 " & _
           "from (select * from caseprogress " & _
           "where cp01 ='TC' and cp05>=" & T案收文齊備啟用日 & " and cp09 like 'A%' " & _
           "and CP158=0 AND CP159=0 and cp48<" & strSrvDate(1) & " and cp48 is not null) C3, servicepractice ,engineerprogress,casepropertymap,staff s1,staff s2 " & _
           "where C3.cp01=sp01(+) and C3.cp02=sp02(+) and C3.cp03=sp03(+) and C3.cp04=sp04(+) " & _
           "and sp09='000' " & _
           "and C3.cp09=ep02(+) " & _
           "and ep34='Y' and ep07 is null " & _
           "and C3.cp01=cpm01(+) and C3.cp10=cpm02(+) " & _
           "and C3.cp13=s1.st01(+) " & _
           "and C3.cp14=s2.st01(+) " & _
           "and (C3.cp14 is null or (C3.cp14 is not null and substr(s2.st03,1,1)<>'F')) " & _
           "and sp15 is null and sp61 is null "
   'end 2022/07/15
   strSql = strSql & "order by 2 asc,1 asc,收文日 asc,本所案號 asc "
   'end 2018/12/10
   CheckOC
   Set Rs = New ADODB.Recordset
   Rs.CursorLocation = adUseClient
   Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   tmpnext = "已取得資料..."
   TempFileName = ""
   With Rs
      If .RecordCount > 0 Then
         .MoveFirst
         'Modified by Lydia 2018/12/10 台灣商標爭議案=> 台灣商標案
         TempFileName = "台灣商標案未發文未取消收文且逾承辦期限且要會稿但未輸入會稿日的案件明細"
         strSubject = "台灣商標案未發文未取消收文且逾承辦期限且要會稿但未輸入會稿日的案件明細"
         'end 2018/12/10
         strContent = "Dear Sirs," & vbCrLf & "　　" & strSubject & "　如附件！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心"
         
         ff = FreeFile
         If ff > 0 Then Close #ff
         Open App.path & TextPath & TempFileName & ".txt" For Output As ff
         'Modified by Lydia 2018/12/10 台灣商標爭議案=> 台灣商標案
         Print #ff, "                                                    台灣商標案未發文未取消收文且逾承辦期限且要會稿但未輸入會稿日的案件明細"
         Print #ff, ""
         Print #ff, "列印日：" & ChangeWStringToTDateString(strSrvDate(1))
         Print #ff, ""
         Print #ff, "承辦人   智權人員 收文日    本所案號        案件性質             案件名稱             本所期限  法定期限  齊備日    承辦期限  指定會稿日 費用     點數   進度備註             總收文號 "
         Print #ff, "======== ======== ========= =============== ==================== ==================== ========= ========= ========= ========= ========== ======== ====== ==================== =========="
         tmpnext = .Fields(0) & "開檔中..."
         
         Do While Not .EOF
            A01 = convForm("" & CheckStr(.Fields("收文日").Value), 9)
            A02 = convForm("" & CheckStr(.Fields("本所案號").Value), 15)
            A03 = convForm("" & CheckStr(.Fields("案件性質").Value), 20)
            A04 = convForm("" & CheckStr(.Fields("案件名稱").Value), 20)
            A05 = convForm("" & CheckStr(.Fields("智權人員").Value), 8)
            A06 = convForm("" & CheckStr(.Fields("承辦人").Value), 8)
            A07 = convForm("" & CheckStr(.Fields("本所期限").Value), 9)
            A08 = convForm("" & CheckStr(.Fields("法定期限").Value), 9)
            A09 = convForm("" & CheckStr(.Fields("齊備日").Value), 9)
            A10 = convForm("" & CheckStr(.Fields("承辦期限").Value), 9)
            A11 = convForm("" & CheckStr(.Fields("指定會稿日").Value), 10)
            A12 = convForm("" & CheckStr(.Fields("是否會稿").Value), 8)
            A13 = convForm("" & CheckStr(.Fields("會稿日").Value), 9)
            A14 = convForm("" & CheckStr(.Fields("發文日").Value), 9)
            A15 = convForm("" & CheckStr(.Fields("費用").Value), 8)
            A16 = convForm("" & CheckStr(.Fields("點數").Value), 6)
            A17 = convForm("" & CheckStr(.Fields("進度備註").Value), 20)
            A18 = convForm("" & CheckStr(.Fields("總收文號").Value), 10)
            
            tmpnext = "寫檔..."
            Print #ff, A06 & " " & A05 & " " & A01 & " " & A02 & " " & A03 & " " & A04 & " " & A07 & " " & A08 & " " & A09 & " " & A10 & " " & A11 & " " & A15 & " " & A16 & " " & A17 & " " & A18
            
            .MoveNext
         Loop
      End If
   End With
   Close ff
   tmpnext = "關檔..."
   If TempFileName <> "" And strTemp <> "" Then
      SendMAPIMail strTemp, strSubject, strContent, App.path & TextPath & TempFileName & ".txt"
   End If
   
   Set Rs = Nothing
   Exit Sub
   
DebugErr:
   WLog tmpnext & " " & Err.Description
End Sub

'Added by Morgan 2012/7/2
Private Function GetCaseIdSQL() As String
   'Modified by Morgan 2013/7/1 程序國家更改( 3.美洲,大洋洲,非洲(本所案號單號)=>慧汶; 4.美洲,大洋洲,非洲(本所案號雙號)=>玫音; 5.歐洲=>甄妮; 6.亞洲=>禧佩 )
   'GetCaseIdSQL = "decode(pa01,'P',decode(pa09,'000','1','2')" & _
   ",decode(sign(instr('101,011,231',pa09)),1,decode(mod(Pa02,2),1,'3','4')" & _
   ",decode(sign(instr('221,239',pa09)),1,'5')))"
   'Modified by Morgan 2014/8/26 +CFP案該改抓國家檔設定
   'GetCaseIdSQL = "decode(pa01,'P',decode(pa09,'000','1','2')" & _
   ",decode(NA02,'C20','5','C00','6'" & _
   ",decode(mod(pa02,2),1,'3','4')))"
   'Memo by Morgan 2020/2/21 CFP管制人 109/4/1以後改業務區劃分(此處不用改,呼叫的程式要逐筆重抓)
   'Modified by Lydia 2021/07/09 + substr
   'GetCaseIdSQL = "decode(pa01,'P',decode(pa09,'000','1','2'),decode(mod(pa02,2),1,na73,na74))"
   GetCaseIdSQL = "substr(decode(pa01,'P',decode(pa09,'000','1','2'),decode(mod(pa02,2),1,na73,na74)),1,6)"
End Function

'Add by Morgan 2012/9/17
'FCP年費暫不繳納
Private Sub StrMenu34()
   Dim stSQL As String
   Dim stSubject As String, stContent As String, stTemp As String
   Dim stDate As String
   
On Error GoTo ErrHandle

   stDate = CompWorkDay(3, strSrvDate(1))
   'Modified by Lydia 2016/09/14 cp01||cp27||cp57='FCP' =>cp01='FCP' AND CP158=0 AND CP159=0
   'Modify By Sindy 2024/5/28 "暫不繳納" 改用獨立欄位存放 => and cp176='Y'
   'Modified by Morgan 2025/7/23 改回 and cp141='4'(此設定是控制不重複繳納並非不送件)--Winfrey
   stSQL = "select cp01||'-'||cp02 CNo,cp13,cp14 ,lastyear(pa72) LT,cp06,cp07,cp142" & _
      " From caseprogress,patent where cp05>" & (strSrvDate(1) - 10000) & " and cp10='605' and cp01='FCP' AND CP158=0 AND CP159=0" & _
      " and cp141='4' and (cp06<" & stDate & " or cp142<" & stDate & ") and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04"
      
   If Rs.State <> adStateClosed Then Rs.Close
   With Rs
   .CursorLocation = adUseClient
   .Open stSQL, cnnConnection, adOpenForwardOnly, adLockReadOnly
   If .RecordCount > 0 Then
      .MoveFirst
      Do While Not .EOF
         
         stSubject = .Fields("CNo") & " 之第 " & (Val("" & .Fields("LT")) + 1) & " 年年費於 " & ChangeWStringToTDateString(.Fields("cp06")) & " 到期但目前設定為暫不送，是否可繳納？"
         If .Fields("cp06") > 0 And .Fields("cp06") < stDate Then
            stSubject = stSubject & "(本所期限:" & ChangeWStringToTDateString(.Fields("cp06")) & ")"
         ElseIf .Fields("cp142") > 0 And .Fields("cp142") < stDate Then
            stSubject = stSubject & "(指定日期:" & ChangeWStringToTDateString(.Fields("cp142")) & ")"
         End If
         stContent = "如旨"
         
         SendMAPIMail .Fields("cp13") & ";" & .Fields("cp14"), stSubject, stContent
         
         .MoveNext
      Loop
   End If
   End With
   
ErrHandle:
   If Err.Number <> 0 Then
      WLog "FCP年費暫不繳納提醒:" & Err.Description
   End If
   Set Rs = Nothing
'   Set cnnConnection = Nothing
End Sub

'Add By Sindy 2012/10/1 客戶平台下次更新日期將至其前7日開始,E-Mail通知系統設定之管理人員
Sub StrMenu35()
Dim ff As Integer
Dim A01 As String
Dim A02 As String
Dim A03 As String
Dim A04 As String
Dim A05 As String
Dim TempFileName As String
Dim tmpnext As String
Dim strTo As String
Dim ChkDate As String
   
On Error GoTo DebugErr
   
   ChkDate = Format(DateAdd("D", 7, DateSerial(Left(strSrvDate(1), 4), Mid(strSrvDate(1), 5, 2), Right(strSrvDate(1), 2))), "YYYYMMDD") '前7天開始
   
   'Modify By Sindy 2015/12/18 下次更新日期=19221111，代表不提醒
   strSql = "SELECT * FROM custwebid,custweb " & _
            "WHERE cw01=cd01 " & _
            "and cd07<=" & ChkDate & " and cd07<>19221111 " & _
            "order by cd07 asc,cw01 asc "
   CheckOC
   Set Rs = New ADODB.Recordset
   Rs.CursorLocation = adUseClient
   Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   tmpnext = "已取得資料..."
   With Rs
      If .RecordCount > 0 Then
         .MoveFirst
         ff = FreeFile
         TempFileName = "客戶平台下次更新日期將到期通知"
         
         If ff > 0 Then Close #ff
         ff = FreeFile
         Open App.path & TextPath & TempFileName & ".txt" For Output As ff
        'Added by Lydia 2016/10/19 加報表抬頭
        Print #ff, Space(10) & TempFileName
        Print #ff, ""
        'end 2016/10/19
         Print #ff, "平台編號  平台名稱             平台類別   帳號                 下次更新日期"
         Print #ff, "========= ==================== ========== ==================== ============"
         Do While Not .EOF
            tmpnext = "開檔中..."
            A01 = convForm(CheckStr(.Fields("cw01").Value), 9)
            A02 = convForm(CheckStr(.Fields("cw12").Value), 20)
            'Modified by Morgan 2017/10/24
            'If .Fields("cw03").Value = "1" Then
            '   A03 = convForm("IP管理", 10)
            'ElseIf .Fields("cw03").Value = "2" Then
            '   A03 = convForm("檔案存取", 10)
            'ElseIf .Fields("cw03").Value = "3" Then
            '   A03 = convForm("電子帳單", 10)
            'Else
            '   A03 = convForm("憑證", 10)
            'End If
            A03 = convForm(PUB_GetCW03Name("" & .Fields("cw03")), 10)
            'end 2017/10/24
            A04 = convForm(CheckStr(.Fields("cd03").Value), 20)
            A05 = convForm(ChangeWStringToTDateString(CheckStr(.Fields("cd07").Value)), 12)
            tmpnext = "寫檔..."
            Print #ff, A01 & " " & A02 & " " & A03 & " " & A04 & " " & A05
            .MoveNext
         Loop
         Close ff
         tmpnext = "關檔..."
         
         '發 mail
         'Modify By Sindy 2024/3/18 改回抓 客戶平台系統設定之管理人員
         strTo = Pub_GetSpecMan("客戶平台系統設定之管理人員") 'Modify By Sindy 2015/6/29 改寄薛經理
         SendMAPIMail strTo, TempFileName, "Dear Sirs," & vbCrLf & "          " & TempFileName & " 如附件！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", App.path & TextPath & TempFileName & ".txt"
      End If
   End With
   
Set Rs = Nothing
Exit Sub

DebugErr:
   WLog tmpnext & " " & Err.Description
End Sub

'Add By Sindy 2012/10/1 客戶平台擁有者已離職時,E-Mail通知系統設定之管理人員
Sub StrMenu36()
Dim ff As Integer
Dim A01 As String
Dim A02 As String
Dim A03 As String
Dim A04 As String
Dim A05 As String
Dim TempFileName As String
Dim tmpnext As String
Dim strTo As String
Dim MyArr As Variant, j As Integer
   
On Error GoTo DebugErr
   
   strSql = "SELECT cw01,cw12,cw03,cd03,cd06,cd07 FROM custwebid,custweb,staff " & _
            "WHERE cw01=cd01 " & _
            "and length(cd06)=5 " & _
            "and cd06=st01(+) and st04='2' union " & _
            "SELECT cw01,cw12,cw03,cd03,cd06,cd07 FROM custwebid,custweb " & _
            "WHERE cw01=cd01 " & _
            "and length(cd06)>5 " & _
            "order by cd06 asc,cw01 asc "
   CheckOC
   Set Rs = New ADODB.Recordset
   Rs.CursorLocation = adUseClient
   Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   tmpnext = "已取得資料..."
   With Rs
      If .RecordCount > 0 Then
         .MoveFirst
         TempFileName = ""
         Do While Not .EOF
            tmpnext = "開檔中..."
            MyArr = Split(.Fields("cd06").Value, ",")
            For j = 0 To UBound(MyArr)
               If ChkStaffST04(CStr(MyArr(j)), False) = True Then
                  If TempFileName = "" Then
                     ff = FreeFile
                     TempFileName = "客戶平台擁有者已離職通知"
                     If ff > 0 Then Close #ff
                     ff = FreeFile
                     Open App.path & TextPath & TempFileName & ".txt" For Output As ff
                    'Added by Lydia 2016/10/19 加報表抬頭
                    Print #ff, Space(10) & TempFileName
                    Print #ff, ""
                    'end 2016/10/19
                     Print #ff, "平台編號  平台名稱             平台類別   帳號                 擁有者已離職"
                     Print #ff, "========= ==================== ========== ==================== ============"
                  End If
                  A01 = convForm(CheckStr(.Fields("cw01").Value), 9)
                  A02 = convForm(CheckStr(.Fields("cw12").Value), 20)
                  If .Fields("cw03").Value = "1" Then
                     A03 = convForm("IP管理", 10)
                  ElseIf .Fields("cw03").Value = "2" Then
                     A03 = convForm("檔案存取", 10)
                  ElseIf .Fields("cw03").Value = "3" Then
                     A03 = convForm("電子帳單", 10)
                  Else
                     A03 = convForm("憑證", 10)
                  End If
                  A04 = convForm(CheckStr(.Fields("cd03").Value), 20)
                  A05 = convForm(GetPrjSalesNM(CStr(MyArr(j))), 12)
                  tmpnext = "寫檔..."
                  Print #ff, A01 & " " & A02 & " " & A03 & " " & A04 & " " & A05
               End If
            Next j
            .MoveNext
         Loop
         Close ff
         tmpnext = "關檔..."
         
         '發 mail
         If TempFileName <> "" Then
            'Modify By Sindy 2024/3/18 改回抓 客戶平台系統設定之管理人員
            strTo = Pub_GetSpecMan("客戶平台系統設定之管理人員") 'Modify By Sindy 2015/6/29 改寄薛經理
            SendMAPIMail strTo, TempFileName, "Dear Sirs," & vbCrLf & "          " & TempFileName & " 如附件！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", App.path & TextPath & TempFileName & ".txt"
         End If
      End If
   End With
   
Set Rs = Nothing
Exit Sub

DebugErr:
   WLog tmpnext & " " & Err.Description
End Sub

'Add By Sindy 2012/11/13
'[暫不列印收據]當程序於送件日三個月後自動列印收據
Private Sub StrMenu37()
   Dim stSQL As String
   
On Error GoTo ErrHand
   
   'and cp61 is null=>代表無代理人
   'Modified by Lydia 2016/09/14 cp27 is not null=>CP158 > 0
   stSQL = "update acc0k0 set a0k32='Y' " & _
           "where a0k01 in( " & _
           "select a0k01 from acc0k0,acc0j0,caseprogress " & _
           "where a0k32='N' and a0k01=a0j13 and a0j01=cp09 " & _
           "and CP158>0 and cp61 is null " & _
           "and to_char(add_months(to_date(cp27,'yyyymmdd'),3),'yyyymmdd')<" & strSrvDate(1) & _
           " )"
   cnnConnection.Execute stSQL
   
ErrHand:
   If Err.Number <> 0 Then
      WLog Err.Description
   End If
End Sub

'2013/04/30 Add By Amy 請作單附件寫入ImgByteFile (卷和代表圖檔)中
Sub StrMenu38()
Dim i As Integer, ErrCount As Integer
Dim SaveYN(2) As Boolean
Dim strErr As String, strSubject As String, strContent As String
Dim strTestPath As String 'Add by Amy 2024/07/16

Mail_file = App.path & "\" & "請作單錯誤資料檢核表.txt"
'Modify by Amy 2024/01/18 改抓系統特殊設定
File2.path = "\\" & Pub_GetSpecMan("分信主機名稱") & "\c$\Transfer" 'Modify by Amy 2018/06/20

'*** 測式用 'Add by Amy 2024/07/16 ***
'strTestPath = PUB_Getdesktop & "\Transfer"
'If Dir(strTestPath, vbDirectory) = MsgText(601) Then
'   MkDir strTestPath
'End If
'File2.path = strTestPath
'*** end 測式用 ***
File2.Refresh

If File2.ListCount = 0 Then
    Exit Sub
Else
    Dim strName As String, m_ibf01 As String, m_ibf02 As String, m_bu01 As String, m_bu02 As String
    Dim PgmRs As New ADODB.Recordset
    Dim PdfRs As New ADODB.Recordset
    Dim strNameOrg As String 'Add by Amy 2024/07/16
    
    Txt_Head = False
     ErrCount = 0
    For i = 0 To File2.ListCount - 1
        strName = "": m_ibf01 = "": m_ibf02 = "": m_bu01 = "": m_bu02 = "": strErr = ""
        'Modify by Amy 2024/07/16
        strNameOrg = Left(File2.List(i), Len(File2.List(i)) - 4)
        strName = Replace(strNameOrg, "-", "")
        FileFullPath = File2.path & "\" & strNameOrg & ".pdf"
        'end 2024/07/16
        m_ibf02 = Right(strName, 6)
        m_bu02 = Right(strName, 2)
        
        'Modify by Amy 2024/07/02 可允許使用-
'        'Added by Lydia 2024/01/10 檢查檔名是否有符號-
'        If Replace(Pub_RplStr(Pub_RepFileName(strName)), "-", "") <> strName Then
'            ErrCount = ErrCount + 1
'            ReadTxt1 strName, "該檔案名稱有誤"
'        Else
'        'end 2024/01/10
            If Len(strName) = 10 Then
                '西元年月日
                m_ibf01 = Left(strName, 4) - 1911
                m_bu01 = Left(strName, 8)
            ElseIf Len(strName) = 9 Then
                '民國3碼月日
                m_ibf01 = Left(strName, 3)
                m_bu01 = Left(strName, 7) + 19110000
            ElseIf Len(strName) = 8 Then
                '民國2碼月日
                m_ibf01 = Left(strName, 2)
                m_bu01 = Left(strName, 6) + 19110000
            Else
                '檔名有誤
                ErrCount = ErrCount + 1
                ReadTxt1 strNameOrg, "該檔案名稱有誤" 'Modify by Amy 2024/07/16
            End If
                      
             '判斷記錄是否已存在於PGMBulletin
             PgmRs.CursorLocation = adUseClient
             PgmRs.Open "Select * From PGMBulletin Where  BU01='" & m_bu01 & "' And BU02='" & m_bu02 & "'", cnnConnection, adOpenStatic, adLockOptimistic
             If PgmRs.RecordCount > 0 Then
                SaveYN(0) = True
             Else
                SaveYN(0) = False
                ErrCount = ErrCount + 1
                ReadTxt1 strNameOrg, "找不到對應資料" 'Modify by Amy 2024/07/16
             End If
             PgmRs.Close
             
             '判斷記錄是否存在ImgByteFile
             PdfRs.CursorLocation = adUseClient
             PdfRs.Open "Select * From ImgByteFile Where IBF01='" & m_ibf01 & "' And IBF02='" & m_ibf02 & "' And IBF03='0' And IBF04='00'", cnnConnection, adOpenStatic, adLockOptimistic
             If PdfRs.RecordCount > 0 Then
                SaveYN(1) = False
                ErrCount = ErrCount + 1
                ReadTxt1 strNameOrg, "該筆記錄已存在於ImgByteFile" 'Modify by Amy 2024/07/16
             Else
                SaveYN(1) = True
             End If
             
            If SaveYN(0) = True And SaveYN(1) = True Then
                If SavePGMBulletinFile(m_ibf01, m_ibf02, strNameOrg, strErr, PdfRs) = False Then
                    ErrCount = ErrCount + 1
                    ReadTxt1 strNameOrg, strErr 'Modify by Amy 2024/07/16
                End If
            End If
            PdfRs.Close
'        End If   'Added by Lydia 2024/01/10 檢查檔名是否有符號-
    Next i
 
    If Txt_Head = True Then
        Close ff1
    End If
    
    '有錯誤發mail 給 74001及83002
    If ErrCount > 0 Then
        strSubject = "請作單批次作業失敗內容------" & Format(Now, "YYYY/MM/DD")
        strContent = "Dear Sirs," & vbCrLf & "       附件為請作單批次作業失敗內容，請確認！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心"
        'Modify By Sindy 2024/3/18 改只抓 程式管理人員
        SendMAPIMail Pub_GetSpecMan("程式管理人員"), strSubject, strContent, Mail_file
        
        '測式用 Add by Amy 2024/07/16
        'SendMAPIMail "A2004", strSubject, strContent, Mail_file
        
        If Dir(Mail_file) <> "" Then Kill Mail_file
    End If
End If

End Sub
'Added by Morgan 2013/5/15
'電子送件待確認更新:分案三個工作天(含當日)後更新為電子送件並-600規費
Private Sub StrMenu39()
   Dim strCP149 As String, stSQL As String, iR As Integer
   
On Error GoTo ErrHand

   strCP149 = CompWorkDay(3, strSrvDate(1), 1)
   stSQL = "update caseprogress set cp16=cp16-600,cp17=cp17-600,cp118='Y' where cp118='W' and cp01='P' and cp27||cp60 is null and cp149<=" & strCP149
   cnnConnection.Execute stSQL, iR

ErrHand:
   If Err.Number <> 0 Then
      WLog Err.Description
   End If
   
End Sub

''Added by Morgan 2013/5/21
''分所智財局送件提醒-->分所出納
'Private Sub StrMenu40()
'   Dim stSQL As String, iQ As Integer, rsQuery As ADODB.Recordset
'   Dim stDate As String
'
'   stDate = PUB_GetWorkDay1(strSrvDate(1) - 1, True) '前一個工作天
'   stSQL = "select st01 from staff,(SELECT distinct st06 x1" & _
'      " FROM CASEPROGRESS C,STAFF,RecAppList Where CP27=" & stDate & " And CP84>0" & _
'      " AND ST01(+)=CP83 AND ST06<>'1' AND RAL05(+)=CP09 AND RAL05 IS NULL) x1" & _
'      " where st04='1' and st05 in ('C1','KM','NM') and x1(+)=st06 and x1 is not null"
'   iQ = 1
'   Set rsQuery = ClsLawReadRstMsg(iQ, stSQL)
'   If iQ = 1 Then
'      Do While Not rsQuery.EOF
'         SendMAPIMail rsQuery(0), "【 請印送件清單紙本傳真台北作帳 】", "如旨"
'         rsQuery.MoveNext
'      Loop
'   End If
'   Set rsQuery = Nothing
'
'End Sub
''Added by Morgan 2013/5/21
''分所智財局送件提醒-->北所財務 71005
'Private Sub StrMenu41()
'   Dim stSQL As String, iQ As Integer, rsQuery As ADODB.Recordset
'   Dim stDate As String, stZone As String
'
'   stDate = PUB_GetWorkDay1(strSrvDate(1) - 1, True) '前一個工作天
'   stSQL = "SELECT DISTINCT ST06" & _
'      " FROM CASEPROGRESS C,STAFF Where CP27=" & stDate & " And CP84>0" & _
'      " AND ST01(+)=CP83 AND ST06<>'1' ORDER BY 1"
'   iQ = 1
'   Set rsQuery = ClsLawReadRstMsg(iQ, stSQL)
'   If iQ = 1 Then
'      Do While Not rsQuery.EOF
'         If rsQuery(0) = "2" Then
'            stZone = stZone & "台中 "
'         ElseIf rsQuery(0) = "2" Then
'            stZone = stZone & "台南 "
'         ElseIf rsQuery(0) = "3" Then
'            stZone = stZone & "高雄 "
'         Else
'            stZone = stZone & "其他 "
'         End If
'         rsQuery.MoveNext
'      Loop
'      SendMAPIMail Pub_GetSpecMan("財務處出納人員"), "【 請注意收信※" & Trim(stZone) & "送件明細 】", "如旨"
'   End If
'   Set rsQuery = Nothing
'
'End Sub

'Modify by Amy +stOrgFileN
Private Function SavePGMBulletinFile(ByVal m_ibf01 As String, ByVal m_ibf02 As String, ByVal stOrgFileN, ByRef strErr As String, ByRef PdfRs As ADODB.Recordset) As Boolean
Dim bytes() As Byte
Dim strSql As String
Dim file_num As Integer
Dim strFtpPath As String
   
   On Error GoTo CheckingErr
   
   SavePGMBulletinFile = True
   
   file_num = FreeFile
   Open FileFullPath For Binary Access Read As #file_num
   ReDim bytes(LOF(file_num))
   Get #file_num, , bytes()
   PdfRs.AddNew
   PdfRs.Fields("ibf01").Value = m_ibf01
   PdfRs.Fields("ibf02").Value = m_ibf02
   PdfRs.Fields("ibf03").Value = "0"
   PdfRs.Fields("ibf04").Value = "00"
   PdfRs.Fields("ibf05").Value = "5" '種類
   PdfRs.Fields("ibf06").Value = "5" '格式
   PdfRs.Fields("ibf08").Value = Val(strSrvDate(1))
   PdfRs.Fields("ibf09").Value = Val(Format(Time, "HHMM"))
   PdfRs.Fields("ibf13").Value = Trim(LOF(file_num))
'   PdfRs.Fields("ibf14").Value = Null
'   PdfRs.Fields("ibf14").AppendChunk bytes()
   Close #file_num
   
   'Modify By Sindy 2017/8/10
   '檔案改放FTP
   'Add by Amy 2024/07/16 檔名可使用-
    If stOrgFileN <> MsgText(601) Then
      strFtpPath = stOrgFileN
   End If
   'end 2024/07/16
   PUB_PutFtpFile FileFullPath, m_ibf01 & "-" & m_ibf02 & "-0-00-5", m_ibf01 & "-" & m_ibf02 & "-0-00-5", strFtpPath, UCase("imgbytefile")
   If strFtpPath <> "" Then
      PdfRs.Fields("ibf15") = strFtpPath
   End If
   '2017/8/10 END
   
   PdfRs.UPDATE
   
   If strFtpPath <> "" Then 'Add By Sindy 2017/8/10 + if
      If Dir(FileFullPath) <> "" Then Kill FileFullPath
   End If
   
   Exit Function
   
CheckingErr:
   PdfRs.CancelUpdate
   strErr = Err.Description
   WLog "請作單匯入失敗：" & FileFullPath & " " & Err.Number & ":" & strErr 'Add By Sindy 2017/8/16
   SavePGMBulletinFile = False
End Function

'Add By Amy 2013/04/30失敗記錄檢核表
Private Sub ReadTxt1(strFileName As String, ByVal strMsg As String)
    Dim strTemp(2) As String
    strTemp(1) = "": strTemp(2) = ""
    If Txt_Head = False Then '第一次進入印抬頭
        Txt_Head = True
            If ff1 > 0 Then Close #ff1
                ff1 = FreeFile
                
                Open Mail_file For Output As ff1
                'Added by Lydia 2016/10/19 加報表抬頭
                Print #ff1, Space(10) & "失敗記錄檢核表"
                Print #ff1, ""
                'end 2016/10/19
                Print #ff1, "檔案名稱(.pdf) 錯誤訊息"
                Print #ff1, "============== ===================================================="
     End If
     strTemp(1) = convForm(CheckStr(strFileName), 14)
     strTemp(2) = convForm(CheckStr(strMsg), 50)
     Print #ff1, strTemp(1) & " " & strTemp(2)
End Sub

'Add By Sindy 2013/8/23 合併卷宗區PDF檔案
Sub StrMenu42()
Dim tmpnext As String
Dim strSql As String
Dim strData As String
Dim Rs As New ADODB.Recordset
'Dim ChkDate As String
'Dim errFile As String
'Dim iFiles As Integer
   
'On Error GoTo DebugErr
   
   '備份P及CFP案的案件文件原始檔至Server存放區
'   '系統日的前1天
'   ChkDate = Format(DateAdd("D", -1, DateSerial(Left(strSrvDate(1), 4), Mid(strSrvDate(1), 5, 2), Right(strSrvDate(1), 2))), "YYYYMMDD")
'
'   strSql = " and cp27=" & ChkDate
'
'   errFile = ""
'   iFiles = 0
'   If PUB_CopyCasePaperFileToServer(strSql, App.Path & TextPath, errFile, iFiles, tmpnext) = True Then
'      '寄E-Mail電子檔重覆清單給游經理
'      If iFiles > 0 Then
'         SendMAPIMail "97038", "PAT1自動備份檔案核對通知: 共有 " & iFiles & " 個檔案無法處理!!", _
'                      "Dear Sirs," & vbCrLf & vbCrLf & "　　無法處理檔案如附件！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", errFile
'      End If
'   End If
   

   'Modify By Sindy 2014/9/18
'   'Add By Sindy 2014/6/27
'   strDate = DBDATE(DateAdd("d", -1, Format(strSrvDate(1), "####/##/##")))
'   '1.若為電子送件的程序,卷宗區不需要存放.dwg.pdf
'   strSql = "select cp09,cpp02,cp01,cp02,cp03,cp04,cp118" & _
'            " From caseprogress,casepaperpdf" & _
'            " Where cp27=" & strDate & _
'            " and cp01='P' and cp118 is not null" & _
'            " and cp09=cpp01(+)" & _
'            " and instr(upper(cpp02),upper('.dwg.pdf'))>0"
'   Set rs = New ADODB.Recordset
'   rs.CursorLocation = adUseClient
'   rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
'   tmpnext = "已取得資料 SQL..."
'   With rs
'      If .RecordCount > 0 Then
'         tmpnext = "刪除資料 SQL..."
'         strSql = "delete from casepaperpdf where cpp01='" & rs.Fields("cp09") & "' and cpp02='" & ChgSQL(rs.Fields("cpp02")) & "'"
'         cnnConnection.Execute strSql, intI
'         SendMAPIMail "97038", "為電子送件的程序,刪除卷宗區.dwg.pdf", _
'                               "本所案號：" & .Fields("cp01") & "-" & .Fields("cp02") & "-" & .Fields("cp03") & "-" & .Fields("cp04") & vbCrLf & _
'                               "總收文號：" & .Fields("cp09") & vbCrLf & _
'                               "檔　　名：" & .Fields("cpp02") & vbCrLf & _
'                               "電子送件狀態：" & .Fields("cp118"), , , True
'      End If
'   End With
'   Set rs = Nothing
   
   Call PDFMergeFile_Batch(True)
   
   'Add By Sindy 2015/2/26 檢查是否有待合併的電子檔
   strData = ""
   'Modify By Sindy 2019/1/28 + ,cpp03
   'Modify by Sindy 2019/7/9
'   strSql = "select distinct cp01,cp02,cp03,cp04,cpp01,cpp02,cpp03 from caseprogress,casepaperpdf where cpp10='X' and cpp01=cp09(+) and upper(substr(cpp02,-4))=upper('.PDF')" & _
'            " order by cp01,cp02,cp03,cp04,cpp01 asc"
   strSql = "select distinct cp01,cp02,cp03,cp04,cpp01,cpp02,cpp03 from caseprogress,casepaperpdf" & _
            " where cp01||cp02||cp03||cp04 in(" & _
            " select cp01||cp02||cp03||cp04" & _
            " From caseprogress,casepaperpdf" & _
            " where cpp10='X' and cpp01=cp09(+) and upper(substr(cpp02,-4))=upper('.PDF')" & _
            " group by cp01,cp02,cp03,cp04" & _
            " having count(*)>0" & _
            ")" & _
            " and cpp10='X' and cpp01=cp09(+) and upper(substr(cpp02,-4))=upper('.PDF')" & _
            " order by cp01,cp02,cp03,cp04,cpp01 asc"
   '2019/7/9 END
   If Rs.State <> adStateClosed Then Rs.Close
   Set Rs = New ADODB.Recordset
   Rs.CursorLocation = adUseClient
   Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   With Rs
      If .RecordCount > 0 Then
         .MoveFirst
         Do While Not .EOF
            'Modify By Sindy 2019/1/28 + & " (" & .Fields("cpp03") & " KB)"
            strData = strData & .Fields("cp01") & "-" & .Fields("cp02") & "-" & .Fields("cp03") & "-" & .Fields("cp04") & " " & .Fields("cpp01") & " " & .Fields("cpp02") & " (" & Round(.Fields("cpp03") / 1024, 2) & " KB)" & vbCrLf & vbCrLf
            .MoveNext
         Loop
         'Add By Sindy 2020/5/25 讀取沒有對應到總收文號的資料
         strSql = "select distinct cp01,cp02,cp03,cp04,cpp01,cpp02,cpp03 from caseprogress,casepaperpdf" & _
                  " where  cpp10='X' and cpp01=cp09(+) and upper(substr(cpp02,-4))=upper('.PDF')" & _
                  " and cp01 is null" & _
                  " order by cp01,cp02,cp03,cp04,cpp01 asc"
         If Rs.State <> adStateClosed Then Rs.Close
         Set Rs = New ADODB.Recordset
         Rs.CursorLocation = adUseClient
         Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
         With Rs
            If .RecordCount > 0 Then
               .MoveFirst
               Do While Not .EOF
                  strData = strData & .Fields("cp01") & "-" & .Fields("cp02") & "-" & .Fields("cp03") & "-" & .Fields("cp04") & " " & .Fields("cpp01") & " " & .Fields("cpp02") & " (" & Round(.Fields("cpp03") / 1024, 2) & " KB)" & vbCrLf & vbCrLf
                  .MoveNext
               Loop
            End If
         End With
         '2020/5/25 END
         If strData <> "" Then
            If bolWorkDay = True Then
               'Modify By Sindy 2024/10/1 修改郵件內容
               SendMAPIMail "97038", "[電子檔為 (已保護) 要煩請解開]〔卷宗區〕尚有未合併成功的電子檔", _
                                     "XX, 早安" & vbCrLf & vbCrLf & _
                                     "下列電子檔為 (已保護) 要煩請解開, 後續人員在使用卷宗區查詢電子檔時," & vbCrLf & _
                                     "才能使用多檔合併預覽!!" & vbCrLf & vbCrLf & _
                                     "謝謝您!!" & vbCrLf & vbCrLf & strData
            End If
         End If
      End If
   End With
   Rs.Close
   
   Set Rs = Nothing
   Exit Sub
   
DebugErr:
'   Set rs = Nothing
   'Modify By Sindy 2019/10/17
   WLog tmpnext & " " & Err.Number & ":" & Err.Description & "(StrMenu42)"
End Sub


'Add by Amy 2013/07/09 發文時未於系統貼指定代表圖,一直發MAIL給繪圖及工程師直到補齊
Private Sub StrMenu43()
Dim rsP As ADODB.Recordset
Dim strSqlp As String
Dim intP As Integer
Dim strTo As String 'Add by Amy 2022/07/27

On Error GoTo ErrHand

'發文時未於系統貼指定代表圖,一直發MAIL給繪圖
'Modify by Amy 2018/07/24 +彩色代表圖 原: and ibf05='1'
strSqlp = "Select '1' Sort1,cp29 stNo,cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) 本所案號  From caseprogress Where cp01='P' and cp27>=to_char(sysdate-30,'yyyymmdd') And cp29<>'99999' And cp31='Y'  And substr(cp12,1,1)<>'F' " & _
              "and instr('" & CaseMapIn & "',cp10)>0  And not exists(Select * From Imgbytefile where ibf01=cp01 and ibf02=cp02 and ibf03=cp03 and ibf04=cp04 and ibf05 in('1','2')) "
            
'發文時未於系統貼指定代表圖,一直發MAIL給工程師
strSqlp = strSqlp & " Union " & _
              "Select '2' Sort1,cp14 stNo,cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) 本所案號  From caseprogress Where cp01='P' and cp27>=to_char(sysdate-30,'yyyymmdd') And cp29 is null And cp31='Y'  And substr(cp12,1,1)<>'F' " & _
              "and instr('" & CaseMapIn & "',cp10)>0  And not exists(Select * From Imgbytefile where ibf01=cp01 and ibf02=cp02 and ibf03=cp03 and ibf04=cp04 and ibf05 in('1','2'))  Order by Sort1,stNo,本所案號"
'end 2018/07/24
 intP = 1
Set rsP = ClsLawReadRstMsg(intP, strSqlp)
If intP = 1 Then
    Do While Not rsP.EOF
        'Modify by Amy 2022/07/27 +無收件人時發給「程式管理人員」
         strTo = "" & rsP(1)
         If strTo = MsgText(601) Then
            strTo = Pub_GetSpecMan("程式管理人員")
         End If
        SendMAPIMail strTo, "【 " & rsP(2) & " 】已發文但尚缺代表圖！", "如旨"
        'end 2022/07/27
        rsP.MoveNext
    Loop
End If
   
ErrHand:
   If Err.Number <> 0 Then
      WLog Err.Description
   End If
Set rsP = Nothing

End Sub
'end 2013/07/09

'Add By Sindy 2013/7/31 通知刷卡異常未確認資料
Sub StrMenu44()
Dim ff As Integer
Dim A01 As String
Dim A02 As String
Dim A03 As String
Dim A04 As String
Dim TempFileName As String
Dim tmpnext As String
Dim strTo As String
Dim MyArr As Variant, j As Integer
Dim strDate As String
Dim strST59 As String
   
On Error GoTo DebugErr
   
   strDate = DBDATE(Left(ChangeWStringToTString(DBDATE(DateAdd("m", -1, Format(strSrvDate(1), "####/##/##")))), 5) & "01")
   '無個人確認且無處理結果者
   '81040.副所長排除
   'Modify By Sindy 2013/12/16 +ST14
   'Modify By Sindy 2022/6/27 + and b1402<=" & CompWorkDay(3, strSrvDate(1), 1) => 排除前一個工作天,因前1日的下班異常還沒出來
   strSql = "select b1401,b1402,b1403,b1404,st02,st03,st14 from abs014,staff" & _
            " where b1402>=" & strDate & _
            " and b1401=st01(+)" & _
            " and b1405 is null" & _
            " and b1411 is null" & _
            " and b1401 not in('81040')" & _
            " and b1402<=" & CompWorkDay(3, strSrvDate(1), 1) & _
            " order by b1401,b1402,b1403"
   CheckOC
   Set Rs = New ADODB.Recordset
   Rs.CursorLocation = adUseClient
   Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   tmpnext = "已取得資料..."
   With Rs
      If .RecordCount > 0 Then
         .MoveFirst
         TempFileName = ""
         strTo = ""
         tmpnext = "開檔中..."
         Do While Not .EOF
            If strTo <> .Fields("b1401") Then
               If strTo <> "" Then
                  Close ff
                  '發 mail
                  If strTo <> "99997" Then 'Add By Sindy 2013/12/16 +if
                     'Modified by Morgan 2014/1/6 +不發職代
                     SendMAPIMail strTo, TempFileName, "Dear Sirs," & vbCrLf & "          " & TempFileName & " 如附件！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", App.path & TextPath & TempFileName & ".txt", , True
                  End If
               End If
               'TempFileName = .Fields("b1401") & "刷卡異常未確認資料"
               TempFileName = "刷卡異常未確認資料"
               ff = FreeFile
               If ff > 0 Then Close #ff
               ff = FreeFile
               Open App.path & TextPath & TempFileName & ".txt" For Output As ff
               'Added by Lydia 2016/10/19 加報表抬頭
               Print #ff, Space(10) & TempFileName
               Print #ff, ""
               'end 2016/10/19
               Print #ff, "姓　　名   日　　期   打卡類別   打卡時間 "
               Print #ff, "========== ========== ========== =========="
            End If
            A01 = convForm(CheckStr(.Fields("st02").Value), 10)
            A02 = convForm(CheckStr(ChangeWStringToTDateString(.Fields("b1402").Value)), 10)
            A03 = convForm(CheckStr(IIf(.Fields("b1403").Value = "A", "上班", "下班")), 10)
            A04 = convForm(CheckStr(IIf("" & .Fields("b1404").Value = "", "未打卡", Format(.Fields("b1404").Value, "##:##:##"))), 10)
            strTo = .Fields("b1401").Value
            'Add By Sindy 2013/12/16
            strST59 = ""
            strST59 = PUB_GetST59(strTo)
            If Not IsNull(strST59) And strST59 <> "" Then
               strTo = strST59
            End If
            '2013/12/16 END
            tmpnext = "寫檔..."
            Print #ff, A01 & " " & A02 & " " & A03 & " " & A04
            .MoveNext
         Loop
         Close ff
         tmpnext = "關檔..."
         
         '發 mail
         If strTo <> "" Then
            If strTo <> "99997" Then 'Add By Sindy 2013/12/16 +if
               'Modified by Morgan 2014/1/6 +不發職代
               SendMAPIMail strTo, TempFileName, "Dear Sirs," & vbCrLf & "          " & TempFileName & " 如附件！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", App.path & TextPath & TempFileName & ".txt", , True
            End If
         End If
      End If
   End With
   
Set Rs = Nothing
Exit Sub

DebugErr:
   WLog tmpnext & " " & Err.Description
End Sub

'Modify by Amy 2013/08/30 原只發cp27=to_char(sysdate-1,'yyyymmdd') 改抓系統日前五日工作天~系統前一日工作天
'Add by Amy 2013/08/23 電子送件未稽核 mail 給發文人員的二級主管
Private Sub StrMenu45()
Dim intR As Integer
Dim strDate1 As String, StrDate2 As String
Dim strTo As String 'Add by Amy 2017/11/16

On Error GoTo ErrHand

   strDate1 = PUB_GetWorkDayAfterSysDate(CDbl(strSrvDate(1)), -5) + 19110000
   StrDate2 = PUB_GetWorkDayAfterSysDate(CDbl(strSrvDate(1)), -1) + 19110000
   'Modify by Amy 2017/09/21 +Nvl(CP64,''),CP64可能沒輸
   'modify by sonia 2018/12/7 FCP四個程序主管,二二稽核但不設ST52(不看對方期限)故先寫固定
   'strSql = "Select cp01,cp02,cp03,cp04,cp83,cp27,cpm03,st52 From CaseProgress,CasePropertyMap,staff " & _
             "Where  cp01 in ('FCP','FCT') and cp01||cp10<>'FCP605' And instr(Nvl(cp64,''),'電子送件已稽核')=0 " & _
             "And cp118 is not null And cp27>= " & strDate1 & " And cp27<= " & strDate2 & " And CP01=CPM01(+) And CP10=CPM02(+) " & _
             "And cp83=st01(+) And substr(st03,1,1)='F' "
   'Modify by Amy 2019/01/31 增加單獨年費送件的稽核(排除整批送件)-敏莉
   'Modified by Morgan 2020/1/2 86013已為FCP程序主管改都抓st52，另FCP加已繳費稽核--何淑華
   'strSql = "Select cp01,cp02,cp03,cp04,cp83,cp27,cpm03,decode(cp83,'86024','86013','86013','86024','82045','85033','85033','82045',st52) st52 From CaseProgress,CasePropertyMap,staff " & _
             "Where  cp01 in ('FCP','FCT') And Instr(Cp64,'智慧局收文文號')>0 And instr(Nvl(cp64,''),'電子送件已稽核')=0 " & _
             "And cp118 is not null And cp27>= " & strDate1 & " And cp27<= " & strDate2 & " And CP01=CPM01(+) And CP10=CPM02(+) " & _
             "And cp83=st01(+) And substr(st03,1,1)='F'"
   'Modify by Amy 2020/08/28 取消FCT電子送件稽核通知 原:cp01 in ('FCP','FCT')
   strSql = "Select cp01,cp02,cp03,cp04,cp83,cp27,cpm03,st52,1 flg From CaseProgress,CasePropertyMap,staff " & _
             "Where  cp01='FCP' And Instr(Cp64,'智慧局收文文號')>0 And instr(cp64,'電子送件已稽核')=0 " & _
             "And cp118 is not null And cp27>= " & strDate1 & " And cp27<= " & StrDate2 & " And CP01=CPM01(+) And CP10=CPM02(+) " & _
             "And cp83=st01(+) And substr(st03,1,1)='F'"
   strSql = strSql & " union Select cp01,cp02,cp03,cp04,cp83,cp27,cpm03,st52,2 flg From CaseProgress,CasePropertyMap,staff " & _
             "Where  cp01='FCP' And Instr(Cp64,'智慧局收文文號')>0 And instr(cp64,'已繳費;')=0 and cp84>0 and cp118='A' " & _
             "And cp118 is not null And cp27>= " & strDate1 & " And cp27<= " & StrDate2 & " And CP01=CPM01(+) And CP10=CPM02(+) " & _
             "And cp83=st01(+) And substr(st03,1,1)='F'"
   'end 2020/08/28
   
   intR = 1
   Set Rs = ClsLawReadRstMsg(intR, strSql)
   If intR = 1 Then
      Do While Not Rs.EOF
         'Modify by Amy 2017/11/16 st52無資料,發給秀玲
         strTo = "" & Rs.Fields("st52")
         'Modified by Lydia 2022/05/27 每月、每日批次發通知無收受者時改發「程式管理人員」，以利查覺異常情形，才能儘早修改系統設定
         If strTo = MsgText(601) Then
            strTo = Pub_GetSpecMan("程式管理人員")
         End If
         'end 2022/05/27
         'Added by Morgan 2020/1/2
         If Rs.Fields("flg") = "2" Then
            SendMAPIMail strTo, "【 " & Rs.Fields("cp01") & Rs.Fields("cp02") & " 案件性質 " & Rs.Fields("cpm03") & " 】""已繳費""未稽核！", "如旨"
         Else
         'end 2017/11/16
            
            SendMAPIMail strTo, "【 " & Rs.Fields("cp01") & Rs.Fields("cp02") & " 案件性質 " & Rs.Fields("cpm03") & " 】電子送件未稽核！", "如旨"
            
         End If 'Added by Morgan 2020/1/2
         Rs.MoveNext
      Loop
   End If
   
ErrHand:
   If Err.Number <> 0 Then
      WLog Err.Description
   End If
Set Rs = Nothing

End Sub

'Add By Sindy 2013/11/18 已發文或已取消收文的專利案,刪除歷程附件檔及原始檔暫存區
Sub StrMenu46()
Dim tmpnext As String
Dim bolDelFile As Boolean
Dim rsA As New ADODB.Recordset
Dim rsA2 As New ADODB.Recordset 'Add By Sindy 2016/8/30
Dim intEEFCnt As Integer
Dim intPDFCnt As Integer
Dim strWriteText As String
Dim TempFileName As String
Dim ff As Integer
Dim strDate3mday As String
Dim strDatePdwg As String 'Add By Sindy 2016/7/5
Dim dblCnt As Double 'Add By Sindy 2024/4/12
   
On Error GoTo DebugErr
   
   'Modify By Sindy 2016/7/5 調整發文後一個月才刪歷程
   'strDate = DBDATE(DateAdd("d", -1, Format(strSrvDate(1), "####/##/##")))
   strDate = DBDATE(DateAdd("m", -1, Format(strSrvDate(1), "####/##/##")))
   '2016/7/5 END
   'strDatePdwg = DBDATE(DateAdd("d", -1, Format(strSrvDate(1), "####/##/##")))
   strDatePdwg = DBDATE(DateAdd("m", -1, Format(strSrvDate(1), "####/##/##")))
   '取消收文日:刪系統日推算回去前3個月(當天)的資料
   strDate3mday = DBDATE(DateAdd("m", -3, Format(strSrvDate(1), "####/##/##")))
   
   '有發文日且有承辦單電子檔或已取消收文時,則要刪除歷程附件檔
   '第一次先清之前的資料,之後則每天Run
'   and cp27<20131101
'   --and cp27=20131102 --系統日-1天
'   --and eep04 in('" & EMP_判發 & "','" & EMP_退件重送 & "') --EMP_判發
   'Modify By Sindy 2025/7/30 郭經理跟薛經理反應要取消刪除"已取消收文"的歷程電子檔
   strSql = "select distinct eep01,cp01,cp02,cp03,cp04,cp27,cp57,'S' as QType" & _
            " From empelectronprocess, caseprogress, empelectronfile" & _
            " where eep01=cp09(+) and cp27 is not null" & _
            " and eep01=eef01(+) and eep02=eef02(+)" & _
            " and eef03 is not null" & _
            " and cp27<=" & strDate & " and cp27>=20130801" & _
            " and (instr(eef03,'." & EMP_承辦單 & ".')>0 or instr(eef03,'." & EMP_多案承辦單 & ".')>0)" & _
            " and eep04 <>'" & EMP_會修 & "' and not (eep04 in('" & EMP_會完 & "') and instr(eep11,'沿用附件')=0)" '& _
            " Union" & _
            " select distinct eep01,cp01,cp02,cp03,cp04,cp27,cp57,'D' as QType" & _
            " From empelectronprocess, caseprogress, empelectronfile" & _
            " where eep01=cp09(+) and cp57 is not null" & _
            " and eep01=eef01(+) and eep02=eef02(+)" & _
            " and eef03 is not null" & _
            " and cp57=" & strDate3mday & _
            " and eep04 <>'" & EMP_會修 & "' and not (eep04 in('" & EMP_會完 & "') and instr(eep11,'沿用附件')=0)"
                            'Modify By Sindy 2024/4/12 and cp57<=" & strDate3mday 改 and cp57=" & strDate3mday
   strSql = strSql & " Union" & _
            " select distinct eep01,cp01,cp02,cp03,cp04,cp27,cp57,'D' as QType" & _
            " From empelectronprocess, caseprogress, empelectronfile" & _
            " where eep01=cp09(+) and cp27 is not null" & _
            " and eep01=eef01(+) and eep02=eef02(+)" & _
            " and eef03 is not null" & _
            " and cp27=19221111 and cp05<=" & strDate3mday & _
            " and eep04 <>'" & EMP_會修 & "' and not (eep04 in('" & EMP_會完 & "') and instr(eep11,'沿用附件')=0)"
                                             'strDate 'Modify By Sindy 2019/6/27
                                             'Modify By Sindy 2024/4/12 and cp05<=" & strDate3mday 改 and cp05=" & strDate3mday
   'Add By Sindy 2024/4/12 增加發文歸檔的判斷
   strSql = strSql & " Union" & _
            " select distinct eep01,cp01,cp02,cp03,cp04,cp27,cp57,'S' as QType" & _
            " From empelectronprocess, caseprogress, empelectronfile, casepaperpdf" & _
            " where eep01=cp09(+) and cp27 is not null" & _
            " and eep01=eef01(+) and eep02=eef02(+)" & _
            " and eef03 is not null" & _
            " and cp27<=" & strDate & " and cp27>=20130801" & _
            " and cpp01(+)=eep01" & _
            " and (instr(cpp02,'." & EMP_承辦單 & ".')>0 or instr(cpp02,'." & EMP_多案承辦單 & ".')>0)" & _
            " and exists(select * from empelectronprocess e2 where e2.eep01=cp09 and e2.eep04='" & EMP_發文歸檔 & "')" & _
            " and eep04 <>'" & EMP_會修 & "' and not (eep04 in('" & EMP_會完 & "') and instr(eep11,'沿用附件')=0)"
   '2024/4/12 END
   strSql = strSql & " order by eep01"
   Set Rs = New ADODB.Recordset
   Rs.CursorLocation = adUseClient
   Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   tmpnext = "已取得資料..."
   With Rs
      If .RecordCount > 0 Then
         .MoveFirst
         dblCnt = 0 'Add By Sindy 2024/4/12
         Do While Not .EOF
            dblCnt = dblCnt + 1 'Add By Sindy 2024/4/12
            tmpnext = "執行中,總收文號(" & .Fields("eep01") & ")..."
            strWriteText = ""
            bolDelFile = False '預設值
            
            If Val("" & .Fields("cp27")) > 0 Then
               '檢查是否有待合併的PDF,若有,不可刪除檔案
               strExc(0) = "select cpp02,cpp10 from casepaperpdf where cpp01='" & .Fields("eep01") & "' and (cpp10 is null or cpp10='X')"
               intI = 1
               Set rsA = ClsLawReadRstMsg(intI, strExc(0))
               If intI = 1 Then
                  If rsA.RecordCount = 0 Then
                     bolDelFile = True
                  Else
                     strWriteText = strWriteText & "有待合併資料,"
                  End If
               Else
                  bolDelFile = True
               End If
               'Modify By Sindy 2014/12/23 Mark.程式已上一年,不檢查此條件;且因有其他的電子化流程如分析發文時,會將卷宗區的資料搬走,已打破此規則
'               If bolDelFile = True Then
'                  intEEFCnt = 0
'                  intPDFCnt = 0
'                  '檢查歷程的檔案數是否有大於原始檔+卷宗區,若有,不可刪檔
'                  strExc(0) = "select eef02,eef03 from EmpElectronFile" & _
'                              " where eef01='" & .Fields("eep01") & "'" & _
'                              " and (eef02 in(select max(eep02) from EmpElectronProcess" & _
'                              " where eep01='" & .Fields("eep01") & "'" & _
'                              " and eep04 in('" & EMP_判發 & "','" & EMP_退件重送 & "')) or eef02=0) order by eef02 asc"
'                  intI = 1
'                  Set rsA = ClsLawReadRstMsg(intI, strExc(0))
'                  If intI = 1 Then
'                     intEEFCnt = rsA.RecordCount
'                  End If
'                  strExc(0) = "select cpp02 from casepaperpdf where cpp01='" & .Fields("eep01") & "'" & _
'                              " Union all select cpf02 from casepaperfile where cpf01='" & .Fields("eep01") & "'"
'                  intI = 1
'                  Set rsA = ClsLawReadRstMsg(intI, strExc(0))
'                  If intI = 1 Then
'                     intPDFCnt = rsA.RecordCount
'                  End If
'                  If intEEFCnt > intPDFCnt Then
'                     strWriteText = strWriteText & "歷程檔案數(" & intEEFCnt & ")大於原始檔+卷宗區檔案數(" & intPDFCnt & "),"
'                     bolDelFile = False
'                  End If
'               End If
            ElseIf Val("" & .Fields("cp57")) > 0 Then
               bolDelFile = True
            End If
            If strWriteText <> "" Then
               strWriteText = .Fields("eep01") & " " & .Fields("cp01") & "-" & .Fields("cp02") & "-" & .Fields("cp03") & "-" & .Fields("cp04") & " " & Left(strWriteText, Len(strWriteText) - 1)
               If TempFileName = "" Then
                  TempFileName = ChangeWStringToTString(strDate) & " 或 " & ChangeWStringToTString(strDate3mday) & " 尚未刪除歷程附件的資料清單"
                  ff = FreeFile
                  If ff > 0 Then Close #ff
                  ff = FreeFile
                  Open App.path & TextPath & TempFileName & ".txt" For Output As ff
                    'Added by Lydia 2016/10/19 加報表抬頭
                    Print #ff, Space(10) & TempFileName
                    Print #ff, ""
                    'end 2016/10/19
               End If
               Print #ff, strWriteText
            End If
            
            '要刪除歷程附件檔
            If bolDelFile = True Then
               cnnConnection.BeginTrans
               
               If .Fields("QType") = "S" Then
                  PUB_DelFtpFile2 .Fields("eep01"), " and eef02=0", "EMPELECTRONFILE" 'Added by Morgan 2015/4/27 檔案改放 FTP,必須在DB資料刪除前執行
                  '存卷資料要刪除
                  strSql = "DELETE FROM empelectronfile where eef01='" & .Fields("eep01") & "' and eef02=0"
                  cnnConnection.Execute strSql, intI
               'Modify By Sindy 2019/6/27 存卷資料沒歸卷不要刪除
               Else
                  strExc(0) = "select cpp02,cpp10 from casepaperpdf where cpp01='" & .Fields("eep01") & "' and cpp12='S'"
                  intI = 1
                  Set rsA = ClsLawReadRstMsg(intI, strExc(0))
                  '有歸卷動作才刪除
                  If intI = 1 Then
                     PUB_DelFtpFile2 .Fields("eep01"), " and eef02=0", "EMPELECTRONFILE" 'Added by Morgan 2015/4/27 檔案改放 FTP,必須在DB資料刪除前執行
                     '存卷資料要刪除
                     strSql = "DELETE FROM empelectronfile where eef01='" & .Fields("eep01") & "' and eef02=0"
                     cnnConnection.Execute strSql, intI
                  End If
               End If
               '2019/6/27 END
               
               'Modify By Sindy 2014/10/2 Mark,因為聯絡附件也要全部刪除
'               '聯絡流程中,部份檔案要刪除(繪圖檔)
'               strSql = "DELETE FROM empelectronfile" & _
'                        " where eef01='" & .Fields("eep01") & "'" & _
'                        " and eef02 in(select eep02 from empelectronprocess where eep01=eef01 and eep04='" & EMP_聯絡 & "')" & _
'                        " and (substr(upper(eef03),-4)='.X-T' or substr(upper(eef03),-4)='.X_T'" & _
'                              " or substr(upper(eef03),-4)='.STP'" & _
'                              " or substr(upper(eef03),-5)='.STEP'" & _
'                              " or substr(upper(eef03),-4)='.SAT'" & _
'                              " or substr(upper(eef03),-4)='.IGS'" & _
'                              " or substr(upper(eef03),-4)='.DWG'" & _
'                              " or substr(upper(eef03),-7)='DWG.ZIP'" & _
'                              " or substr(upper(eef03),-7)='DWG.PDF')"
'               cnnConnection.Execute strSql, intI
               '部份流程的附件要刪除
               'Modify By Sindy 2013/12/25 只留聯絡,會修,會完的歷程附件
               'Modify By Sindy 2014/10/2 聯絡附件也要全部刪除
'               strSql = "DELETE FROM empelectronfile" & _
'                        " where eef01='" & .Fields("eep01") & "'" & _
'                        " and eef02 in(select eep02 from empelectronprocess where eep01=eef01" & _
'                                        " and eep04 in('" & EMP_墨完 & "','" & EMP_繪圖判發 & "','" & EMP_送判 & "','" & EMP_退回 & "','" & EMP_判發 & "','" & EMP_退件 & "','" & EMP_退件重送 & "')" & _
'                        ")"
               
               PUB_DelFtpFile2 .Fields("eep01"), " and eef02 in(select eep02 from empelectronprocess where eep01=eef01 and eep04 not in('" & EMP_會修 & "','" & EMP_會完 & "'))", "EMPELECTRONFILE" 'Added by Morgan 2015/4/27 檔案改放 FTP,必須在DB資料刪除前執行
               strSql = "DELETE FROM empelectronfile" & _
                        " where eef01='" & .Fields("eep01") & "'" & _
                        " and eef02 in(select eep02 from empelectronprocess where eep01=eef01" & _
                                        " and eep04 not in('" & EMP_會修 & "','" & EMP_會完 & "')" & _
                        ")"
               cnnConnection.Execute strSql, intI
               
               PUB_DelFtpFile2 .Fields("eep01"), " and eef02 in(select eep02 from empelectronprocess where eep01=eef01 and eep04 in('" & EMP_會完 & "') and instr(eep11,'沿用附件')>0)", "EMPELECTRONFILE" 'Added by Morgan 2015/4/27 檔案改放 FTP,必須在DB資料刪除前執行
               'Add By Sindy 2014/9/19
               '會完流程若是沿用上一道流程附件時,也要刪除
               strSql = "DELETE FROM empelectronfile" & _
                        " where eef01='" & .Fields("eep01") & "'" & _
                        " and eef02 in(select eep02 from empelectronprocess where eep01=eef01" & _
                                        " and eep04 in('" & EMP_會完 & "') and instr(eep11,'沿用附件')>0" & _
                        ")"
               cnnConnection.Execute strSql, intI
               '2014/9/19 END
               
               cnnConnection.CommitTrans
            End If
            .MoveNext
            
'            'Add By Sindy 2024/4/12
'            If dblCnt = 1000 Then
'               Exit Do
'            End If
'            '2024/4/12 END
         Loop
      End If
   End With
   Close ff
   '發 mail
   If TempFileName <> "" Then
      If bolWorkDay = True Then
         SendMAPIMail "97038", TempFileName, "Dear Sirs," & vbCrLf & "          " & TempFileName & " 如附件！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", App.path & TextPath & TempFileName & ".txt"
      End If
   End If
   
   'Modify By Sindy 2014/7/7 從 strMenu42 Move至此
   '1.P大陸新案若有.dwg.pdf時,檢查是否有國內案,若有,則P大陸新案的.dwg.pdf刪除
   strSql = "select cp09,cpp02,cp01,cp02,cp03,cp04,cp118,pa09,cm01,cm02,cm03,cm04,cm05,cm06,cm07,cm08,cm10,cp10,cp27,cp158,cp159" & _
            " From caseprogress, casepaperpdf, patent, casemap" & _
            " Where cp27<" & strDatePdwg & " and cp158>0 and cp159=0" & _
            " and cp01='P' and cp10 in(" & NewCasePtyList & ")" & _
            " and cp01=pa01(+) and cp02=pa02(+) and cp03=pa03(+) and cp04=pa04(+) and pa09='020'" & _
            " and cp09=cpp01(+) and instr(upper(cpp02),upper('.dwg.pdf'))>0" & _
            " and pa01=cm01(+) and pa02=cm02(+) and pa03=cm03(+) and pa04=cm04(+) and cm10='0'"
   Set Rs = New ADODB.Recordset
   Rs.CursorLocation = adUseClient
   Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   tmpnext = "已取得資料 SQL(1)..."
   With Rs
      If .RecordCount > 0 Then
         tmpnext = "刪除資料 SQL(1)...P大陸新案若有.dwg.pdf時,檢查是否有國內案,若有,則P大陸新案的.dwg.pdf刪除"
         .MoveFirst
         Do While Not .EOF
            PUB_DelFtpFile2 Rs.Fields("cp09"), " and cpp02='" & ChgSQL(Rs.Fields("cpp02")) & "'" 'Added by Morgan 2015/4/15 檔案改放 FTP,必須在DB資料刪除前執行
            
            strSql = "delete from casepaperpdf where cpp01='" & Rs.Fields("cp09") & "' and cpp02='" & ChgSQL(Rs.Fields("cpp02")) & "'"
            cnnConnection.Execute strSql, intI
            
   '         SendMAPIMail "97038", "因P大陸新案有.dwg.pdf檔且檢查有國內案,因此將P大陸新案的.dwg.pdf刪除", _
   '                               "本所案號：" & .Fields("cp01") & "-" & .Fields("cp02") & "-" & .Fields("cp03") & "-" & .Fields("cp04") & vbCrLf & _
   '                               "總收文號：" & .Fields("cp09") & vbCrLf & _
   '                               "案件性質：" & .Fields("cp10") & vbCrLf & _
   '                               "檔　　名：" & .Fields("cpp02") & vbCrLf & _
   '                               "相關案號：" & .Fields("cm05") & "-" & .Fields("cm06") & "-" & .Fields("cm07") & "-" & .Fields("cm08"), , , True
            .MoveNext
         Loop
      End If
   End With
   
   
   'Add By Sindy 2019/1/30
   strDatePdwg = DBDATE(DateAdd("m", -6, Format(strSrvDate(1), "####/##/##")))
   '2.P台灣電子送件新案若有.dwg.pdf時, 當新申請案發文後六個月刪除dwg.pdf檔
   strSql = "select pa01,pa02,pa03,pa04,pa09,cp09,cp10,cp118,cpp02,cpp03,cp27,cp158,cp159" & _
            " From caseprogress, casepaperpdf, patent" & _
            " Where cp27<" & strDatePdwg & " and cp158>0 and cp159=0" & _
            " and cp01='P' and cp10 in(" & NewCasePtyList & ")" & _
            " and cp01=pa01(+) and cp02=pa02(+) and cp03=pa03(+) and cp04=pa04(+) and pa09='000'" & _
            " and cp09=cpp01(+) and instr(upper(cpp02),upper('.dwg.pdf'))>0" & _
            " and cp118 is not null" & _
            " order by cp27,pa01,pa02,pa03,pa04"
   Set Rs = New ADODB.Recordset
   Rs.CursorLocation = adUseClient
   Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   tmpnext = "已取得資料 SQL(2)..."
   With Rs
      If .RecordCount > 0 Then
         tmpnext = "刪除資料 SQL(2)...P台灣電子送件新案若有.dwg.pdf時, 當新申請案發文後六個月刪除dwg.pdf檔"
         .MoveFirst
         Do While Not .EOF
            PUB_DelFtpFile2 Rs.Fields("cp09"), " and cpp02='" & ChgSQL(Rs.Fields("cpp02")) & "'" 'Added by Morgan 2015/4/15 檔案改放 FTP,必須在DB資料刪除前執行
            
            strSql = "delete from casepaperpdf where cpp01='" & Rs.Fields("cp09") & "' and cpp02='" & ChgSQL(Rs.Fields("cpp02")) & "'"
            cnnConnection.Execute strSql, intI
            
            .MoveNext
         Loop
      End If
   End With
   
'   'Add By Sindy 2016/8/9 檢查每天的歷程EEP13是否更新正常
'   'Modify By Sindy 2017/6/29 Mark 判發,退件重送
'   strSql = "select eep01,eep02,eep13 From empelectronprocess" & _
'            " where eep01||eep02 in(select eep01||max(eep02) From empelectronprocess where eep06=" & strDatePdwg & " group by eep01)" & _
'            " and eep04 not in('" & EMP_不自動更新會完日 & "','" & EMP_附加流程 & "','" & EMP_不自動更新齊備日 & "')" & _
'            " and eep04 in('" & EMP_核修 & "','" & EMP_核完 & "','" & EMP_會修 & "','" & _
'            EMP_會完 & "','" & EMP_繪圖判發 & "','" & _
'            EMP_退回 & "','" & EMP_退件 & "','" & EMP_圖修 & "','" & _
'            EMP_圖完 & "','" & EMP_退回 & "','" & EMP_草修 & "','" & _
'            EMP_草核完 & "','" & EMP_送會 & "','" & EMP_會圖 & "','" & _
'            EMP_送英核 & "','" & EMP_送核 & "','" & EMP_送判 & "','" & _
'            EMP_轉回 & "','" & EMP_墨完 & "','" & EMP_草核 & "')" & _
'            " and eep13 is null"
'   Set rs = New ADODB.Recordset
'   rs.CursorLocation = adUseClient
'   rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
'   tmpNext = "檢查每天的歷程EEP13是否更新正常..."
'   With rs
'      If .RecordCount > 0 Then
'         .MoveFirst
'         strExc(0) = ""
'         Do While Not .EOF
'            'Add By Sindy 2016/8/30
'            '檢查是否目前文號最大流水號
'            strSql = "select max(eep02) from empelectronprocess where eep01='" & rs.Fields("eep01") & "'"
'            intI = 1
'            Set rsA2 = ClsLawReadRstMsg(intI, strSql)
'            If intI = 1 Then
'               If rsA2.Fields(0) = rs.Fields("eep02") Then
'                  strExc(0) = strExc(0) & rs.Fields("eep01") & " - " & rs.Fields("eep02") & " - " & "EEP13=" & rs.Fields("eep13") & vbCrLf
'                  cnnConnection.Execute "update empelectronprocess set eep13='Y' where eep01='" & rs.Fields("eep01") & "' and eep02=" & rs.Fields("eep02")
'               End If
'            End If
'            '2016/8/30 END
'            .MoveNext
'         Loop
'         If strExc(0) <> "" Then
'            SendMAPIMail "97038", strDatePdwg & "歷程EEP13有異常,未更新為Y", strExc(0)
'         End If
'      End If
'   End With
'   '2016/8/9 END
   
   'Add By Sindy 2017/8/30 2個工作天後非最後一道的聯絡不顯示
'--檢查用
'select cp01,cp02,cp03,cp04,eep01,a.eep02,a.eep04,a.eep13
'--update empelectronprocess set eep13=null
'--where eep01||eep02 in(
'select a.eep01||a.eep02
'from empelectronprocess a,caseprogress
'where a.eep04='00' and a.eep13='Y'
'and a.eep06<20170829
'and exists(select * from empelectronprocess b
'where b.eep01=a.eep01 and b.eep04='00' and b.eep02>a.eep02)
'and a.eep01=cp09(+)
'--)
   strExc(0) = "update empelectronprocess set eep13=null" & _
               " where eep01||eep02 in(" & _
               " select a.eep01||a.eep02" & _
               " from empelectronprocess a" & _
               " where a.eep04='00' and a.eep13='Y'" & _
               " and a.eep06<" & CompWorkDay(3, strSrvDate(1), 1) & _
               " and exists(select * from empelectronprocess b" & _
               " where b.eep01=a.eep01 and b.eep04='00' and b.eep02>a.eep02)" & _
               ")"
   cnnConnection.Execute strExc(0)
   '2017/8/30 END
   
   'Add By Sindy 2020/3/17
   '有發文或已取消收文一個月後,則要刪除原始檔暫存區(Z)
   strSql = "select cpf01,cpf02" & _
            " From caseprogress, casepaperfile" & _
            " where cp09=cpf01(+)" & _
            " and ((cp27=19221111 and cp05<=" & strDate & ")" & _
              " or (cp57<=" & strDate & " and cp159>0)" & _
              " or (cp27<=" & strDate & " and cp158>0))" & _
            " and cpf02 is not null and cpf11='Z'"
   strSql = strSql & " order by cpf01"
   Set Rs = New ADODB.Recordset
   Rs.CursorLocation = adUseClient
   Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   tmpnext = "已取得資料..."
   With Rs
      If .RecordCount > 0 Then
         .MoveFirst
         Do While Not .EOF
            tmpnext = "執行中,總收文號(" & .Fields("cpf01") & ")..."
            
            cnnConnection.BeginTrans
            
            PUB_DelFtpFile2 .Fields("cpf01"), " and cpf02='" & .Fields("cpf02") & "' and cpf11='Z'", "CASEPAPERFILE"
            '原始檔暫存區要刪除
            strSql = "DELETE FROM CASEPAPERFILE where cpf01='" & .Fields("cpf01") & "'" & _
                     " and cpf02='" & .Fields("cpf02") & "' and cpf11='Z'"
            cnnConnection.Execute strSql, intI
            
            cnnConnection.CommitTrans
            
            .MoveNext
         Loop
      End If
   End With
   Rs.Close
   '2020/3/17 END
   
   Set Rs = Nothing
   Set rsA = Nothing
   Set rsA2 = Nothing 'Add By Sindy 2016/8/30
   Exit Sub

DebugErr:
   Close ff
   Set Rs = Nothing
   Set rsA = Nothing
   Set rsA2 = Nothing 'Add By Sindy 2016/8/30
   If bolDelFile = True Then
      cnnConnection.RollbackTrans
'      MsgBox "更新失敗！" & vbCrLf & Err.Description
   End If
   WLog tmpnext & " " & Err.Description
End Sub

'Add By Amy 2013/12/11 PCT申請案進入國家階段期限到期時自動上可結餘日
Sub StrMenu47()
    Dim intR As Integer
    
On Error GoTo ErrHand

    strSql = "Select np02,np03,np04,np05 From NextProgress Where np02 In('P','CFP') And np07='119' And np09=to_char(sysdate,'yyyymmdd') "
      
    intR = 1
    Set Rs = ClsLawReadRstMsg(intR, strSql)
    If intR = 1 Then
        Do While Not Rs.EOF
            bolEndModCash = True
            Pub_UpdateEndModCash Rs.Fields("np02"), Rs.Fields("np03"), Rs.Fields("np04"), Rs.Fields("np05")
            Rs.MoveNext
        Loop
    End If
   
ErrHand:
   If Err.Number <> 0 Then
      WLog Err.Description
   End If
End Sub

'20140213START ADD By eric P,CFP新申請案有主張優先權的案件分案  原管控優先權資料為輸入時無法分案 改為可分案;並每周發MAIL通知承辦人該件未輸入優先權資料
Sub StrMenu48()
' On Error GoTo DebugErr
Dim i As Integer
Dim iCount As Long
Dim oCPNo  As String
Dim sPecM As String
Dim StrSQL6 As String
Dim tmpnext As String

   CheckOC
   'Query 有主張國際優先權的CFP & P 案件且優先權資料對照檔無記錄的資料
   'Modified by Lydia 2016/09/14 (c.cp57=0 or c.cp57 is NULL) => C.CP159=0 ; (c.cp27=0 or c.cp27 is NULL) => C.CP158=0
   'Modified by Morgan 2022/10/28 +,c.cp02,c.cp03,c.cp04
   strSql = "select c.cp01,c.cp02,c.cp03,c.cp04,c.cp01||c.cp02||c.cp03||c.cp04 cp#,c.cp05,c.cp13,c.cp14,c.cp27,to_char(sysdate,'yyyymmdd') dt,(to_number(to_char(sysdate,'yyyymmdd'))-10000) LstYr, p.pa05, m.cu04, t.ptm03, DECODE(P.PA09,'000',R.CPM03,R.CPM04) " & _
           " from caseprogress c,patent p,customer m,patenttrademarkmap t, CASEPROPERTYMAP R " & _
           " where c.cp149<=to_number(to_char(sysdate-7,'yyyymmdd')) and c.cp05>=(to_number(to_char(sysdate,'yyyymmdd'))-10000) " & _
           " and to_char(to_date(c.cp149,'YYYYMMDD'),'D') = to_char(SYSDATE,'D') " & _
           " and C.CP159=0 " & _
           " and c.cp10='106' and c.cp01||''='CFP' " & _
           " and C.CP158=0 " & _
           " and substr(p.pa26,1,8)=m.cu01(+) " & _
           " and substr(p.pa26,9,9)=m.cu02(+) " & _
           " and c.cp01=p.pa01(+) and c.cp02=p.pa02(+) and c.cp03=p.pa03(+) and c.cp04=p.pa04(+) and (p.pa57<>'Y' or p.pa57 is null) " & _
           " and t.ptm01='1' and t.ptm02=p.pa08 AND CPM01(+)=CP01 AND CPM02(+)=CP10 " & _
           " and not exists (SELECT 1 FROM PRIDATE WHERE c.cp01=PD01 AND c.cp02=PD02 AND c.cp03=PD03 and c.cp04=PD04)" & _
           " Union " & _
           " select c.cp01,c.cp02,c.cp03,c.cp04,c.cp01||c.cp02||c.cp03||c.cp04 cp#,c.cp05,c.cp13,c.cp14,c.cp27,to_char(sysdate,'yyyymmdd') dt,(to_number(to_char(sysdate,'yyyymmdd'))-10000) LstYr, p.pa05, m.cu04, t.ptm03, DECODE(P.PA09,'000',R.CPM03,R.CPM04) " & _
           " from caseprogress c,patent p,customer m,patenttrademarkmap t, CASEPROPERTYMAP R " & _
           " where c.cp149<=to_number(to_char(sysdate,'yyyymmdd')) and c.cp05>=(to_number(to_char(sysdate,'yyyymmdd'))-10000) " & _
           " and to_char(to_date(c.cp149,'YYYYMMDD'),'D') = to_char(SYSDATE,'D') " & _
           " and C.CP159=0 " & _
           " and c.cp10='106' and c.cp01||''='P' " & _
           " and C.CP158=0 " & _
           " and substr(p.pa26,1,8)=m.cu01(+) " & _
           " and substr(p.pa26,9,9)=m.cu02(+) " & _
           " and c.cp01=p.pa01(+) and c.cp02=p.pa02(+) and c.cp03=p.pa03(+) and c.cp04=p.pa04(+) and (p.pa57<>'Y' or p.pa57 is null) " & _
           " and t.ptm01='1' and t.ptm02=p.pa08 AND CPM01(+)=CP01 AND CPM02(+)=CP10 " & _
           " and not exists (SELECT PD01 FROM PRIDATE WHERE C.CP01=PD01 AND C.CP02=PD02 AND C.CP03=PD03 AND C.CP04=PD04)"
   
   Set Rs = New ADODB.Recordset
   Rs.CursorLocation = adUseClient
   Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   tmpnext = "取得資料"
   With Rs
       If .RecordCount > 0 And .RecordCount <> 0 Then
           .MoveFirst
           Do While Not .EOF
              oCPNo = .Fields("cp01")   'CFP 案或P 案
              tmpnext = .Fields("cp01") & "-" & .Fields("cp02") & IIf(.Fields("cp03") & .Fields("cp04") = "000", "", "-" & .Fields("cp03") & "-" & .Fields("cp04")) 'Added by Morgan 2022/10/28
              If oCPNo = "CFP" Then
                 '發MAIL 給 業務(CP13) & 承辦人(CP14)
                 'Modified by Morgan 2022/10/28 +副本給程序人員
                 'SendMAPIMail .Fields("cp13"), "請提供 (" & CheckStr(.Fields("cp#")) & ") P案優先權資料！", "此訊息是系統自動代發！" & vbCrLf & vbCrLf & "申請人    ：　" & CheckStr(.Fields("cu04")) & vbCrLf & "案件名稱 ：  " & CheckStr(.Fields("pa05")) & vbCrLf & "專利種類 ：  " & CheckStr(.Fields("ptm03")) & vbCrLf & "收文日    ：　" & CheckStr(Format(.Fields("cp05") - 19110000, "@@@/@@/@@")) & vbCrLf & vbCrLf & "                                                        電腦中心", "", "", True, .Fields("cp14")
                 sPecM = PUB_GetCFPHandler(.Fields("cp#"))
                 SendMAPIMail .Fields("cp13"), "請提供 " & tmpnext & " 案優先權資料！", "此訊息是系統自動代發！" & vbCrLf & vbCrLf & "申請人    ：　" & CheckStr(.Fields("cu04")) & vbCrLf & "案件名稱 ：  " & CheckStr(.Fields("pa05")) & vbCrLf & "專利種類 ：  " & CheckStr(.Fields("ptm03")) & vbCrLf & "收文日    ：　" & CheckStr(Format(.Fields("cp05") - 19110000, "@@@/@@/@@")) & vbCrLf & vbCrLf & "                                                        電腦中心", "", "", True, .Fields("cp14") & ";" & sPecM
                 
              End If
              If oCPNo = "P" Then
                 sPecM = Pub_GetSpecMan("A1")   'P案承辦人
                 '發MAIL 給 業務(CP13) & 承辦人(sPecM)
                 ''Modified by Morgan 2022/10/28
                 'SendMAPIMail .Fields("cp13"), "請提供 (" & CheckStr(.Fields("cp#")) & ") 案優先權資料！", "此訊息是系統自動代發！" & vbCrLf & vbCrLf & "申請人    ：　" & CheckStr(.Fields("cu04")) & vbCrLf & "案件名稱 ：  " & CheckStr(.Fields("pa05")) & vbCrLf & "專利種類 ：  " & CheckStr(.Fields("ptm03")) & vbCrLf & "收文日    ：　" & CheckStr(Format(.Fields("cp05") - 19110000, "@@@/@@/@@")) & vbCrLf & vbCrLf & "                                                        電腦中心", "", "", True, sPecM
                 SendMAPIMail .Fields("cp13"), "請提供 " & tmpnext & " 案優先權資料！", "此訊息是系統自動代發！" & vbCrLf & vbCrLf & "申請人    ：　" & CheckStr(.Fields("cu04")) & vbCrLf & "案件名稱 ：  " & CheckStr(.Fields("pa05")) & vbCrLf & "專利種類 ：  " & CheckStr(.Fields("ptm03")) & vbCrLf & "收文日    ：　" & CheckStr(Format(.Fields("cp05") - 19110000, "@@@/@@/@@")) & vbCrLf & vbCrLf & "                                                        電腦中心", "", "", True, sPecM
              End If
                   
              .MoveNext
           Loop
       End If
   End With

End Sub
'20140213END

'Add By Sindy 2014/3/25 FC案件收文應收帳款提醒
Sub StrMenu49()
Dim tmpnext As String
Dim Rs As New ADODB.Recordset
Dim rsAcc As New ADODB.Recordset
Dim rsB As New ADODB.Recordset
Dim strCaseNo As String
Dim strDeadline As String, strDizhang As String
Dim dblTolAmt As Double
Dim strA1k03 As String, strA1K28 As String
Dim bolRemind As Boolean
Dim strSubject As String, strContent As String
Dim intRemindCnt As Integer, strRemindDate As String
Dim ii As Integer, intRow As Integer
Dim strCaseApp_NO(1 To 10) As String
Dim strCaseApp_Name(1 To 10) As String
Dim strCaseApp_NotPayAmt(1 To 10) As Double
Dim strCaseApp_Status(1 To 10) As String
Dim strCaseApp_Date(1 To 10) As String 'Add By Sindy 2014/5/12
Dim strPmoney_NO(1 To 10) As String
Dim strPmoney_Name(1 To 10) As String
Dim strPmoney_NotPayAmt(1 To 10) As Double
Dim strPmoney_Status(1 To 10) As String
Dim strPmoney_Date(1 To 10) As String 'Add By Sindy 2014/5/12
Dim bolCaseApp11 As Boolean, bolPmoney11 As Boolean
Dim strST52 As String
Dim intTotNotPayCnt As Integer, strNewPayDate As String
Dim strOldPayDate As String 'Add By Sindy 2014/5/12
   
On Error GoTo DebugErr
   
   strDate = DBDATE(DateAdd("d", -1, Format(strSrvDate(1), "####/##/##")))
   
   '讀取前一天收文的FC案件
   strSql = "select cp05,cp01,cp02,cp03,cp04,cp13,cp06,substr(cp12,1,2) as cp12" & _
            " From caseprogress" & _
            " Where cp05=" & strDate & _
            " and substr(cp12,1,2)='F1'" & _
            " and (substr(cp09,1,1)='A' or (substr(cp09,1,1)='B' and cp10 in('303','703','704')) or (substr(cp09,1,1)='C' and cp10 in('1003','1004')))" & _
            " Union All" & _
            " select cp05,cp01,cp02,cp03,cp04,cp13,cp07,substr(cp12,1,2) as cp12" & _
            " From caseprogress" & _
            " Where cp05=" & strDate & _
            " and substr(cp12,1,2)='F2'" & _
            " and (substr(cp09,1,1)='A' or (substr(cp09,1,1)='B' and cp10 in('907','913')))" & _
            " order by cp12,cp01,cp02,cp03,cp04,cp06 asc"
   CheckOC
   Set Rs = New ADODB.Recordset
   Rs.CursorLocation = adUseClient
   Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   tmpnext = "已取得資料..."
   With Rs
      If .RecordCount > 0 Then
         .MoveFirst
         Do While Not .EOF
            '同一案號只跑1次,且讀取最早的期限
            If strCaseNo <> .Fields("cp01") & .Fields("cp02") & .Fields("cp03") & .Fields("cp04") Then
               tmpnext = "執行中,本所案號(" & .Fields("cp01") & .Fields("cp02") & .Fields("cp03") & .Fields("cp04") & ")..."
               strExc(0) = "select A1k01,A1k02,A1k03,nvl(a1k11-nvl(a1k06,0)-nvl(a1k30,0),0) as amt,A1k28 from acc1k0" & _
                           " where a1k13='" & .Fields("cp01") & "' and a1k14='" & .Fields("cp02") & "' and a1k15='" & .Fields("cp03") & "' and a1k16='" & .Fields("cp04") & "'" & _
                           " and a1k29 is null" & _
                           " and a1k12 is null and a1k25 is null and a1k17 is null" & _
                           " order by A1k02 desc"
               intI = 1
               Set rsAcc = ClsLawReadRstMsg(intI, strExc(0))
               '有未結清帳款
               If intI = 1 Then
                  'Add By Sindy 2014/5/12
                  rsAcc.MoveLast
                  strOldPayDate = DBDATE("" & rsAcc.Fields("A1k02")) '最早請款日期
                  rsAcc.MoveFirst
                  '2014/5/12 END
                  strDeadline = "" & .Fields("cp06") '期限
                  intTotNotPayCnt = rsAcc.RecordCount '未付款筆數
                  strNewPayDate = DBDATE("" & rsAcc.Fields("A1k02")) '最新請款日期
                  '累計未付款總額
                  dblTolAmt = 0
                  rsAcc.MoveFirst
                  Do While Not rsAcc.EOF
                     dblTolAmt = dblTolAmt + Val("" & rsAcc.Fields("amt"))
                     rsAcc.MoveNext
                  Loop
                  '檢查是否有符合帳款提醒的條件
                  bolRemind = False
                  rsAcc.MoveFirst
                  Do While Not rsAcc.EOF
                     strA1k03 = "" & rsAcc.Fields("A1k03") '案件代理人
                     strA1K28 = "" & rsAcc.Fields("A1k28") '請款對象
                     If .Fields("cp12") = "F1" Then
                        '外商F1
                        '該案未付帳款提醒之條件:
                        'a. 該案帳款日期超過9個月以上，不限金額, 或
                        'c. 該案Y編號或請款對象已積欠總金額NT$100,000以上
                        If DBDATE(DateAdd("m", 9, Format(Val("" & rsAcc.Fields("A1k02")) + 19110000, "####/##/##"))) < strSrvDate(1) Then
                           bolRemind = True
                           Exit Do
                        Else
                           If GetCuFAAccNotPayAmt(strA1k03, 0) > 100000 Then
                              bolRemind = True
                              Exit Do
                           ElseIf GetCuFAAccNotPayAmt(strA1K28, 1) > 100000 Then
                              bolRemind = True
                              Exit Do
                           End If
                        End If
                     Else
                        '外專F2
                        '該案未付帳款提醒之條件:
                        'a. 該案帳款日期超過12個月以上，不限金額, 或
                        'c. 該案Y編號或請款對象已積欠總金額NT$300,000以上
                        If DBDATE(DateAdd("m", 12, Format(Val("" & rsAcc.Fields("A1k02")) + 19110000, "####/##/##"))) < strSrvDate(1) Then
                           bolRemind = True
                           Exit Do
                        Else
                           If GetCuFAAccNotPayAmt(strA1k03, 0) > 300000 Then
                              bolRemind = True
                              Exit Do
                           ElseIf GetCuFAAccNotPayAmt(strA1K28, 1) > 300000 Then
                              bolRemind = True
                              Exit Do
                           End If
                        End If
                     End If
                     rsAcc.MoveNext
                  Loop
                  If bolRemind = False Then
                     'b. 該案積欠金額累計超過NT$30,000以上且帳款日期皆超過6個月以上,或
                     If dblTolAmt > 30000 Then
                        bolRemind = True
                        rsAcc.MoveFirst
                        Do While Not rsAcc.EOF
                           If DBDATE(DateAdd("m", 6, Format(Val("" & rsAcc.Fields("A1k02")) + 19110000, "####/##/##"))) >= strSrvDate(1) Then
                              bolRemind = False
                              Exit Do
                           End If
                           rsAcc.MoveNext
                        Loop
                     End If
                  End If
                  
                  '要提醒
                  If bolRemind = True Then
                     For ii = 1 To 10
                        strCaseApp_NO(ii) = ""
                        strCaseApp_Name(ii) = ""
                        strCaseApp_NotPayAmt(ii) = 0
                        strCaseApp_Status(ii) = ""
                        strCaseApp_Date(ii) = "" 'Add By Sindy 2014/5/12
                        bolCaseApp11 = False
                        strPmoney_NO(ii) = ""
                        strPmoney_Name(ii) = ""
                        strPmoney_NotPayAmt(ii) = 0
                        strPmoney_Status(ii) = ""
                        strPmoney_Date(ii) = "" 'Add By Sindy 2014/5/12
                        bolPmoney11 = False
                     Next ii
                     '讀取案件代理人、請款對象的名稱/未付款帳單之總金額/財務處協商狀態(同意抵帳中、帳款處理中、宣告破產、永久設定不催款)
                     rsAcc.MoveFirst
                     Do While Not rsAcc.EOF
                        strA1k03 = "" & rsAcc.Fields("A1k03") '案件代理人
                        strA1K28 = "" & rsAcc.Fields("A1k28") '請款對象
                        'CaseApp.案件代理人
                        intRow = 0
                        For ii = 1 To 11
                           If ii = 11 Then '代表資料已超過陣列10組資料了
                              bolCaseApp11 = True
                              GoTo RunExit_A1k03
                           Else
                              If strCaseApp_NO(ii) = "" Then
                                 intRow = ii
                                 Exit For
                              ElseIf strCaseApp_NO(ii) = strA1k03 Then
                                 GoTo RunExit_A1k03
                              End If
                           End If
                        Next ii
                        strCaseApp_NotPayAmt(intRow) = GetCuFAAccNotPayAmt(strA1k03, 0, strCaseApp_Name(intRow), strCaseApp_Status(intRow), strCaseApp_Date(intRow))
                        If strCaseApp_NotPayAmt(intRow) > 0 Then
                           strCaseApp_NO(intRow) = strA1k03
                           strDizhang = GetDizhang(strA1k03, "", False, 2)
                           If strDizhang <> "" Then
                              If strCaseApp_Status(intRow) <> "" Then
                                 strCaseApp_Status(intRow) = strDizhang & "、" & strCaseApp_Status(intRow)
                              Else
                                 strCaseApp_Status(intRow) = strDizhang
                              End If
                           End If
                        End If
RunExit_A1k03:
                        'Pmoney.請款對象
                        intRow = 0
                        For ii = 1 To 11
                           If ii = 11 Then '代表資料已超過陣列10組資料了
                              bolPmoney11 = True
                              GoTo RunExit_A1k28
                           Else
                              If strPmoney_NO(ii) = "" Then
                                 intRow = ii
                                 Exit For
                              ElseIf strPmoney_NO(ii) = strA1K28 Then
                                 GoTo RunExit_A1k28
                              End If
                           End If
                        Next ii
                        strPmoney_NotPayAmt(intRow) = GetCuFAAccNotPayAmt(strA1K28, 1, strPmoney_Name(intRow), strPmoney_Status(intRow), strPmoney_Date(intRow))
                        If strPmoney_NotPayAmt(intRow) > 0 Then
                           strPmoney_NO(intRow) = strA1K28
                           strDizhang = GetDizhang(strA1K28, "", False, 2)
                           If strDizhang <> "" Then
                              If strPmoney_Status(intRow) <> "" Then
                                 strPmoney_Status(intRow) = strDizhang & "、" & strPmoney_Status(intRow)
                              Else
                                 strPmoney_Status(intRow) = strDizhang
                              End If
                           End If
                        End If
RunExit_A1k28:
                        rsAcc.MoveNext
                     Loop
                     
                     intRemindCnt = 0: strRemindDate = ""
                     strExc(0) = "select count(*) from AccReceivableRemind" & _
                                 " where ARR01='" & .Fields("cp01") & "' and ARR02='" & .Fields("cp02") & "' and ARR03='" & .Fields("cp03") & "' and ARR04='" & .Fields("cp04") & "'"
                     intI = 1
                     Set rsB = ClsLawReadRstMsg(intI, strExc(0))
                     '提醒次數
                     If intI = 1 Then
                        intRemindCnt = "" & rsB.Fields(0)
                     End If
                     If intRemindCnt > 0 Then
                        strExc(0) = "select max(ARR05) from AccReceivableRemind" & _
                                    " where ARR01='" & .Fields("cp01") & "' and ARR02='" & .Fields("cp02") & "' and ARR03='" & .Fields("cp03") & "' and ARR04='" & .Fields("cp04") & "'"
                        intI = 1
                        Set rsB = ClsLawReadRstMsg(intI, strExc(0))
                        '最近提醒日期
                        If intI = 1 Then
                           strRemindDate = "" & rsB.Fields(0)
                        End If
                     End If
                     '檢查當日尚無該案提醒記錄時,新增一筆並且寄Mail通知智權同仁
                     strExc(0) = "select * from AccReceivableRemind" & _
                                 " where ARR01='" & .Fields("cp01") & "' and ARR02='" & .Fields("cp02") & "' and ARR03='" & .Fields("cp03") & "' and ARR04='" & .Fields("cp04") & "'" & _
                                 " and ARR05=" & strSrvDate(1)
                     intI = 1
                     Set rsB = ClsLawReadRstMsg(intI, strExc(0))
                     If intI = 0 Then
                        strSql = "insert into AccReceivableRemind(ARR01,ARR02,ARR03,ARR04,ARR05)" & _
                                 " values(" & _
                                 "'" & .Fields("cp01") & "'," & _
                                 "'" & .Fields("cp02") & "'," & _
                                 "'" & .Fields("cp03") & "'," & _
                                 "'" & .Fields("cp04") & "'," & _
                                 strSrvDate(1) & ")"
                        cnnConnection.Execute strSql
                        strSubject = .Fields("cp01") & "-" & .Fields("cp02") & "-" & .Fields("cp03") & "-" & .Fields("cp04") & " 本所期限：" & IIf(strDeadline = "", "(無)", ChangeWStringToTDateString(strDeadline)) & " 未付款帳單之總金額：NTD" & Format(dblTolAmt, "#,##0")
                        'Modify By Sindy 2014/5/12 +最早請款日期
                        strContent = "本所案號：" & .Fields("cp01") & "-" & .Fields("cp02") & "-" & .Fields("cp03") & "-" & .Fields("cp04") & vbCrLf & _
                                     "本所期限：" & IIf(strDeadline = "", "", ChangeWStringToTDateString(strDeadline)) & vbCrLf & _
                                     "未付款帳單之總金額：NTD" & Format(dblTolAmt, "#,##0") & "　筆數：" & intTotNotPayCnt & "　最新請款日期：" & ChangeWStringToTDateString(strNewPayDate) & "　最早請款日期：" & ChangeWStringToTDateString(strOldPayDate) & vbCrLf & _
                                     "本案提醒次數：" & intRemindCnt & vbCrLf & _
                                     "最近提醒日期：" & IIf(strRemindDate = "", "", ChangeWStringToTDateString(strRemindDate)) & vbCrLf & _
                                     "案件代理人：" & vbCrLf
                        For ii = 1 To 10
                           If strCaseApp_NO(ii) = "" Then
                              Exit For
                           Else
                              strContent = strContent & "　　編號：" & strCaseApp_NO(ii) & vbCrLf
                              strContent = strContent & "　　名稱：" & strCaseApp_Name(ii) & vbCrLf
                              'Modify By Sindy 2014/5/12 +最早請款日期
                              strContent = strContent & "　　未付款帳單之總金額：NTD" & Format(strCaseApp_NotPayAmt(ii), "#,##0") & "　最早請款日期：" & IIf(strCaseApp_Date(ii) = "", "", ChangeWStringToTDateString(DBDATE(strCaseApp_Date(ii)))) & vbCrLf
                              strContent = strContent & "　　財務處協商狀態：" & strCaseApp_Status(ii) & vbCrLf
                           End If
                        Next ii
                        If bolCaseApp11 = True Then
                           strContent = strContent & "...etc."
                        End If
                        strContent = strContent & "請款對象：" & vbCrLf
                        For ii = 1 To 10
                           If strPmoney_NO(ii) = "" Then
                              Exit For
                           Else
                              strContent = strContent & "　　編號：" & strPmoney_NO(ii) & vbCrLf
                              strContent = strContent & "　　名稱：" & strPmoney_Name(ii) & vbCrLf
                              'Modify By Sindy 2014/5/12 +最早請款日期
                              strContent = strContent & "　　未付款帳單之總金額：NTD" & Format(strPmoney_NotPayAmt(ii), "#,##0") & "　最早請款日期：" & IIf(strPmoney_Date(ii) = "", "", ChangeWStringToTDateString(DBDATE(strPmoney_Date(ii)))) & vbCrLf
                              strContent = strContent & "　　財務處協商狀態：" & strPmoney_Status(ii) & vbCrLf
                           End If
                        Next ii
                        If bolPmoney11 = True Then
                           strContent = strContent & "...etc."
                        End If
                        'Modify By Sindy 2016/7/20
                        '原控制副本發給簽核主管1,改發智權人員之st52,st52若為空白則不發副本
'                        '簽核主管
'                        strB0108 = ""
'                        strExc(0) = "select b0108 from abs001 where b0101='" & "" & .Fields("cp13") & "'"
'                        intI = 1
'                        Set rsB = ClsLawReadRstMsg(intI, strExc(0))
'                        If intI = 1 Then
'                           strB0108 = rsB.Fields(0)
'                        End If
                        '智權人員之st52
                        strST52 = ""
                        strExc(0) = "select ST52 from staff where ST01='" & "" & .Fields("cp13") & "' and ST52 is not null"
                        intI = 1
                        Set rsB = ClsLawReadRstMsg(intI, strExc(0))
                        If intI = 1 Then
                           strST52 = "" & rsB.Fields(0)
                        End If
                        '2016/7/20 END
                        '寄給智權同仁
                        'SendMAPIMail "" & .Fields("cp13"), strSubject, strContent, , , , strB0108
                        SendMAPIMail "" & .Fields("cp13"), strSubject, strContent, , , , strST52
                     End If
                  End If
               End If
            End If
            strCaseNo = .Fields("cp01") & .Fields("cp02") & .Fields("cp03") & .Fields("cp04")
            .MoveNext
         Loop
      End If
   End With
   
   Set Rs = Nothing
   Set rsAcc = Nothing
   Set rsB = Nothing
   
   Exit Sub

DebugErr:
   Set Rs = Nothing
   Set rsAcc = Nothing
   Set rsB = Nothing
   WLog tmpnext & " " & Err.Description
End Sub

'Added by Morgan 2014/5/8 智權前日直寄待確認案件數通知
'Modified by Morgan 2019/10/24 原CP13條件改為LP06(當客戶換業務時方便批次改確認人員)
Private Sub StrMenu50()
   Dim stSQL As String, tmpnext As String, stSubject As String
   
On Error GoTo ErrHandle
   'Modified by Morgan 2014/5/28 主旨加收件人(目前有來函掛虛建業務而信會寄給帶人主管 Ex.P-096542)
   'Modified by Morgan 2014/6/4 +非直寄也要通知--經理
   'stSQL = "SELECT CP13,COUNT(*) Qty From LETTERPROGRESS, CASEPROGRESS" & _
      " WHERE LP07=0 AND LP10='Y' AND LP11='Y' AND LP15='Y' AND CP09(+)=LP01 GROUP BY CP13"
   'Modified by Morgan 2018/10/24 +cp27>19221111(CFP案期限通知報價轉定稿後才會上發文日)
   stSQL = "select * from (SELECT lp06,max(st02) name,sum(decode(lp11||lp15,'YY',1,0)) Qty1" & _
      ",sum(decode(lp11,'Y',0,decode(lp15,'Y',1,decode(instr('234',st06),0,1)))) Qty2" & _
      " From LETTERPROGRESS, CASEPROGRESS, STAFF WHERE LP07=0 AND LP10='Y' and lp05>0" & _
      " AND CP09(+)=LP01 AND CP27>19221111 AND ST01(+)=lp06 GROUP BY lp06" & _
      ") where qty1>0 or qty2>0"
   If Rs.State <> adStateClosed Then Rs.Close
   With Rs
   .CursorLocation = adUseClient
   .Open stSQL, cnnConnection, adOpenForwardOnly, adLockReadOnly
   If .RecordCount > 0 Then
      .MoveFirst
      Do While Not .EOF
         tmpnext = "" & .Fields("lp06")
         stSubject = ""
         If .Fields("qty1") > 0 Then
            stSubject = .Fields("qty1") & " 筆已直寄待確認"
         End If
         If .Fields("qty2") > 0 Then
            If .Fields("qty1") > 0 Then
               stSubject = stSubject & "及 " & .Fields("qty2") & " 筆親送寄送"
            Else
               stSubject = .Fields("qty2") & " 筆親送寄送"
            End If
         End If
         
         'modify by sonia 2014/8/7 加姓名
         'stSubject = "您目前有 " & stSubject & "資料！請於 承辦人系統->智權部->日常作業->文件寄送確認 項目內進行確認。( " & tmpnext & " )"
         'Modified by Morgan 2015/5/28
         'stSubject = "您目前有 " & stSubject & "資料！請於 承辦人系統->智權部->日常作業->文件寄送確認 項目內進行確認。( " & tmpnext & " " & .Fields("name") & " )"
         'SendMAPIMail tmpnext, stSubject, "如旨"
         'Modified by Lydia 2019/08/08 改路徑
         'stSubject = "( " & tmpNext & " " & .Fields("name") & " ) 您目前有 " & stSubject & "資料！請於 承辦人系統->智權部->日常作業->文件寄送確認 項目內進行確認。"
         stSubject = "( " & tmpnext & " " & .Fields("name") & " ) 您目前有 " & stSubject & "資料！請於 承辦人系統->智權部->程序作業->寄發文件 項目內進行確認。"
         SendMAPIMail tmpnext, stSubject, stSubject
         'end 2015/5/28
         .MoveNext
      Loop
   End If
   End With
   Exit Sub
   
ErrHandle:
   WLog tmpnext & " " & Err.Description

End Sub

'Add by Amy 2014/04/25 刪除暫存Table 避免資料太分散影響抓資料速度
Sub StrMenuDelTempTB()
    Dim F1 As Integer
    Dim IsNeedUpdate As Boolean
    Dim SqlDel As String
    Dim intR As Integer 'Added by Morgan 2022/5/30
    
On Error GoTo ErrHeand
    '檢查檔案
    If Dir(App.path & "\execDelSql.sql") <> "" Then
        F1 = FreeFile
        Open App.path & "\execDelSql.sql" For Input As F1
        
        Do While Not EOF(F1)
            Line Input #F1, SqlDel
            If Trim(SqlDel) <> "" Then
                IsNeedUpdate = False
                If Val(Mid(Trim(SqlDel), 1, 6)) = 0 Then
                    IsNeedUpdate = True
                Else
                    If Mid(Trim(SqlDel), 1, 8) <= strSrvDate(1) Then
                        IsNeedUpdate = True
                        SqlDel = Mid(Trim(SqlDel), 9)
                    Else
                        IsNeedUpdate = False
                    End If
                End If
                If IsNeedUpdate = True Then
                    WLog "語法：" & SqlDel
                    cnnConnection.Execute SqlDel, intR
                    If Err = 0 Then
                        WLog "成功：" & intR & " 筆"
                    Else
                        WLog "失敗：" & Err.Description
                        Err.Clear
                    End If
                End If
            End If
        Loop
        Close #F1
    End If
    Exit Sub
    
ErrHeand:
    Resume Next
End Sub

'Mark by Amy 2015/08/26 辜決定取消不做
''Add by Amy 2014/05/13 客戶匯款4天發未繳款通知書給區主管;7天給杜副總
'Private Sub StrMenu51()
'    Dim StrSQLa As String, strDate1 As String, intA As Integer, ii As Integer
'    Dim strFilePath As String, strContent As String, strReceiver As String, sReceiver() As String, strArea As String, sArea() As String
'    Dim oldA0902 As String, oldA0908 As String
'
'On Error GoTo ErrHand
'    strFilePath = App.path & TextPath
'
'    strContent = "主管您好:" & Chr(10) & Chr(10) & _
'                  "        客戶匯入款及寄來所支票未繳款已逾 4個工作天" & Chr(10) & _
'                  "        明細如附件。" & Chr(10) & Chr(10)
'
'
'    '客戶匯款4天發未繳款通知書給區主管
'    strDate1 = PUB_GetWorkDayAfterSysDate(CDbl(strSrvDate(1)), -4) + 19110000
'    StrSQLa = "Select a0902,a0908,st02,a2304,Nvl(cu04,Decode(cu05,null,cu06,cu05||' '||cu88||' '||cu89||' '||cu90)) as CusName," & _
'                      "to_char(a2324,'yyyymmdd')-19110000 as SendEmail,a2306+a2317+a2318+a2319+a2320+a2307 as Amount " & _
'                   "From Acc230,Staff,Acc090,Customer " & _
'                   "Where to_char(a2324,'yyyymmdd') <='" & strDate1 & "' And a2321 is null " & _
'                       "And a2303=st01(+) And SubStr(st15,1,1)='S' And st15=a0901(+) And cu01=SubStr(a2304,1,8) and cu02=SubStr(a2304,9,1) " & _
'                   "Order by st15,a2303,a2304,a2324"
'
'    intA = 1: Txt_Head = False
'    Set rs = ClsLawReadRstMsg(intA, StrSQLa)
'    If intA = 1 Then
'        Do While Not rs.EOF
'            If rs.BOF Or oldA0902 <> rs.Fields("a0902") Then Txt_Head = False
'            If rs.BOF Or oldA0908 <> rs.Fields("a0908") Then
'                strArea = strArea & ";" & rs.Fields("a0902")
'                strReceiver = strReceiver & ";" & rs.Fields("a0908")
'            End If
'            ReadTxt2 strFilePath & rs.Fields("a0902") & "-客戶匯款尚未繳款通知書.txt", rs.Fields("st02"), rs.Fields("a2304") & "  " & Left(rs.Fields("CusName"), 6), rs.Fields("SendEmail"), Format(rs.Fields("Amount"), "#,##0")
'            oldA0902 = rs.Fields("a0902")
'            oldA0908 = rs.Fields("a0908")
'            rs.MoveNext
'        Loop
'        If FF2 > 0 Then Close #FF2
'
'        If strReceiver <> "" Then
'            sArea = Split(Right(strArea, Len(strArea) - 1), ";")
'            sReceiver = Split(Right(strReceiver, Len(strReceiver) - 1), ";")
'            For ii = 0 To UBound(sReceiver)
'                SendMAPIMail sReceiver(ii), "客戶匯款及寄來所支票未繳款知悉", strContent, strFilePath & sArea(ii) & "-客戶匯款尚未繳款通知書.txt"
'            Next
'        End If
'    End If
'
'    '客戶匯款7天發未繳款通知書給杜副總68006
'    strContent = "主管您好:" & Chr(10) & Chr(10) & _
'                  "        客戶匯入款及寄來所支票未繳款已逾 7個工作天" & Chr(10) & _
'                  "        明細如附件。" & Chr(10) & Chr(10)
'
'    strDate1 = PUB_GetWorkDayAfterSysDate(CDbl(strSrvDate(1)), -7) + 19110000
'    StrSQLa = "Select a0902,a0908,st02,a2304,Nvl(cu04,Decode(cu05,null,cu06,cu05||' '||cu88||' '||cu89||' '||cu90)) as CusName," & _
'                      "to_char(a2324,'yyyymmdd')-19110000 as SendEmail,a2306+a2317+a2318+a2319+a2320+a2307 as Amount " & _
'                   "From Acc230,Staff,Acc090,Customer " & _
'                   "Where to_char(a2324,'yyyymmdd') <='" & strDate1 & "' And a2321 is null " & _
'                       "And a2303=st01(+) And SubStr(st15,1,1)='S' And st15=a0901(+) And cu01=SubStr(a2304,1,8) and cu02=SubStr(a2304,9,1) " & _
'                   "Order by st15,a2303,a2304,a2324"
'
'    intA = 1: Txt_Head = False
'    Set rs = ClsLawReadRstMsg(intA, StrSQLa)
'    If intA = 1 Then
'        Do While Not rs.EOF
'            ReadTxt2 strFilePath & "客戶匯款尚未繳款通知書.txt", rs.Fields("st02"), rs.Fields("a2304") & "  " & Left(rs.Fields("CusName"), 6), rs.Fields("SendEmail"), Format(rs.Fields("Amount"), "#,##0")
'            rs.MoveNext
'        Loop
'        If FF2 > 0 Then Close #FF2
'
'        'Modify By Sindy 2015/7/29 杜副總改林總,且也必須寄一份給何主秘
'        'SendMAPIMail "68006", "客戶匯款及寄來所支票未繳款知悉", strContent, strFilePath & "客戶匯款尚未繳款通知書.txt"
'        SendMAPIMail "94007;68009", "客戶匯款及寄來所支票未繳款知悉", strContent, strFilePath & "客戶匯款尚未繳款通知書.txt"
'        '2015/7/29 END
'    End If
'    Exit Sub
'
'ErrHand:
'   If Err.Number <> 0 Then
'      WLog Err.Description
'   End If
'   If FF2 > 0 Then Close #FF2
'    Resume Next
'End Sub

'For 客戶匯款未繳款通知書
Private Sub ReadTxt2(strFileName As String, ByVal strSales As String, ByVal strCus As String, ByVal strSendTime As String, ByVal Amount As String)
    Dim strTemp(1 To 4) As String

    If Txt_Head = False Then '第一次進入印抬頭
        Txt_Head = True
        If FF2 > 0 Then Close #FF2
        FF2 = FreeFile
                
        Open strFileName For Output As FF2
        'Added by Lydia 2016/10/19 加報表抬頭
        Print #FF2, Space(10) & strFileName
        Print #FF2, ""
        'end 2016/10/19
        Print #FF2, "智權人員   客戶名稱                 Email發送日期  金額"
        Print #FF2, "========== ======================== ============== ================"
     End If
     strTemp(1) = convForm(CheckStr(strSales), 10)
     strTemp(2) = convForm(CheckStr(strCus), 24)
     strTemp(3) = convForm(CheckStr(Format(strSendTime, "@@@/@@/@@")), 14)
     strTemp(4) = convForm(Space(16 - GetTextLength(Amount)) & CheckStr(Amount), 16)
     Print #FF2, strTemp(1) & " " & strTemp(2) & " " & strTemp(3) & " " & strTemp(4)
End Sub
'end 2014/05/13

'Add By Sindy 2014/6/23 將自行管制且未完成的資料, 到期時以清單方式發E-mail通知管制人
'未發文案件自行管制期限到期通知
Sub StrMenu52()
Dim ff As Integer
Dim A01 As String
Dim A02 As String
Dim A03 As String
Dim A04 As String
Dim A05 As String
Dim A06 As String
Dim A07 As String
Dim A08 As String
Dim A09 As String
Dim A10 As String
Dim A11 As String
Dim A12 As String
Dim A13 As String
Dim A14 As String
Dim TempFileName As String
Dim tmpnext As String
Dim strTo As String
Dim MyArr As Variant, j As Integer
   
On Error GoTo DebugErr
   'Modified by Lydia 2016/09/14 cp27 is null and cp57 is null => CP158=0 AND CP159=0
   'Modified by Lydia 2018/08/16 SUBSTRB=>SUBSTR
   strSql = "select SUBSTR(' '||sqldatet(cp05),-9) as 收文日,cp01||'-'||cp02||'-'||cp03||'-'||cp04 as 本所案號,NVL(DECODE(TM10,'000',CPM03,CPM04),cp10) as 案件性質,nvl(tm05,'')||nvl(tm06,'')||nvl(tm07,'') 案件名稱,na03 申請國家,s1.ST02 as 智權人員,s2.ST02 as 承辦人,decode(sc08,'Y','',SUBSTR(' '||sqldatet(sc05),-9)) as 管制期限,decode(SC07,'3','自','') 自,SUBSTR(' '||sqldatet(cp06),-9) as 本所期限,SUBSTR(' '||sqldatet(cp07),-9) as 法定期限,SUBSTR(' '||sqldatet(ep28),-9) as 預定會稿日,decode(sc08,'Y','',sc06) as 備註,cp09 as 總收文號,cp12,cp13,sc05,cp09" & _
             " from caseprogress,staff s1,staff s2,casepropertymap,trademark,salescontroldate,nation,engineerprogress" & _
            " where SC05<=" & strSrvDate(1) & " AND SC07='3' AND SC08 IS NULL and sc01=cp09(+) and CP158=0 AND CP159=0 and cp13=s1.st01(+) and cp14=s2.st01(+) and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+) and cp01=cpm01(+) and cp10=cpm02(+) and sc01=ep02(+) and TM10=na01(+)" & _
            " union " & _
            "select SUBSTR(' '||sqldatet(cp05),-9) as 收文日,cp01||'-'||cp02||'-'||cp03||'-'||cp04 as 本所案號,NVL(DECODE(PA09,'000',CPM03,CPM04),cp10) as 案件性質,nvl(pa05,'')||nvl(pa06,'')||nvl(pa07,'') 案件名稱,na03 申請國家,s1.ST02 as 智權人員,s2.ST02 as 承辦人,decode(sc08,'Y','',SUBSTR(' '||sqldatet(sc05),-9)) as 管制期限,decode(SC07,'3','自','') 自,SUBSTR(' '||sqldatet(cp06),-9) as 本所期限,SUBSTR(' '||sqldatet(cp07),-9) as 法定期限,SUBSTR(' '||sqldatet(ep28),-9) as 預定會稿日,decode(sc08,'Y','',sc06) as 備註,cp09 as 總收文號,cp12,cp13,sc05,cp09" & _
             " from caseprogress,staff s1,staff s2,casepropertymap,patent,salescontroldate,nation,engineerprogress" & _
            " where SC05<=" & strSrvDate(1) & " AND SC07='3' AND SC08 IS NULL and sc01=cp09(+) and CP158=0 AND CP159=0 and cp13=s1.st01(+) and cp14=s2.st01(+) and cp01=pa01(+) and cp02=pa02(+) and cp03=pa03(+) and cp04=pa04(+) and cp01=cpm01(+) and cp10=cpm02(+) and sc01=ep02(+) and PA09=na01(+)" & _
            " union " & _
            "select SUBSTR(' '||sqldatet(cp05),-9) as 收文日,cp01||'-'||cp02||'-'||cp03||'-'||cp04 as 本所案號,NVL(DECODE(SP09,'000',CPM03,CPM04),cp10) as 案件性質,nvl(sp05,'')||nvl(sp06,'')||nvl(sp07,'') 案件名稱,na03 申請國家,s1.ST02 as 智權人員,s2.ST02 as 承辦人,decode(sc08,'Y','',SUBSTR(' '||sqldatet(sc05),-9)) as 管制期限,decode(SC07,'3','自','') 自,SUBSTR(' '||sqldatet(cp06),-9) as 本所期限,SUBSTR(' '||sqldatet(cp07),-9) as 法定期限,SUBSTR(' '||sqldatet(ep28),-9) as 預定會稿日,decode(sc08,'Y','',sc06) as 備註,cp09 as 總收文號,cp12,cp13,sc05,cp09" & _
             " from caseprogress,staff s1,staff s2,casepropertymap,servicepractice,salescontroldate,nation,engineerprogress" & _
            " where SC05<=" & strSrvDate(1) & " AND SC07='3' AND SC08 IS NULL and sc01=cp09(+) and CP158=0 AND CP159=0 and cp13=s1.st01(+) and cp14=s2.st01(+) and cp01=sp01(+) and cp02=sp02(+) and cp03=sp03(+) and cp04=sp04(+) and cp01=cpm01(+) and cp10=cpm02(+) and sc01=ep02(+) and SP09=na01(+)" & _
            " union " & _
            "select SUBSTR(' '||sqldatet(cp05),-9) as 收文日,cp01||'-'||cp02||'-'||cp03||'-'||cp04 as 本所案號,NVL(CPM03,cp10) as 案件性質,hc06 案件名稱,'' 申請國家,s1.ST02 as 智權人員,s2.ST02 as 承辦人,decode(sc08,'Y','',SUBSTR(' '||sqldatet(sc05),-9)) as 管制期限,decode(SC07,'3','自','') 自,SUBSTR(' '||sqldatet(cp06),-9) as 本所期限,SUBSTR(' '||sqldatet(cp07),-9) as 法定期限,SUBSTR(' '||sqldatet(ep28),-9) as 預定會稿日,decode(sc08,'Y','',sc06) as 備註,cp09 as 總收文號,cp12,cp13,sc05,cp09" & _
             " from caseprogress,staff s1,staff s2,casepropertymap,hirecase,salescontroldate,engineerprogress" & _
            " where SC05<=" & strSrvDate(1) & " AND SC07='3' AND SC08 IS NULL and sc01=cp09(+) and CP158=0 AND CP159=0 and cp13=s1.st01(+) and cp14=s2.st01(+) and cp01=hc01(+) and cp02=hc02(+) and cp03=hc03(+) and cp04=hc04(+) and cp01=cpm01(+) and cp10=cpm02(+) and sc01=ep02(+)" & _
            " union " & _
            "select SUBSTR(' '||sqldatet(cp05),-9) as 收文日,cp01||'-'||cp02||'-'||cp03||'-'||cp04 as 本所案號,NVL(DECODE(lc15,'000',CPM03,CPM04),cp10) as 案件性質,nvl(lc05,'')||nvl(lc06,'')||nvl(lc07,'') 案件名稱,na03 申請國家,s1.ST02 as 智權人員,s2.ST02 as 承辦人,decode(sc08,'Y','',SUBSTR(' '||sqldatet(sc05),-9)) as 管制期限,decode(SC07,'3','自','') 自,SUBSTR(' '||sqldatet(cp06),-9) as 本所期限,SUBSTR(' '||sqldatet(cp07),-9) as 法定期限,SUBSTR(' '||sqldatet(ep28),-9) as 預定會稿日,decode(sc08,'Y','',sc06) as 備註,cp09 as 總收文號,cp12,cp13,sc05,cp09" & _
             " from caseprogress,staff s1,staff s2,casepropertymap,lawcase,salescontroldate,nation,engineerprogress" & _
            " where SC05<=" & strSrvDate(1) & " AND SC07='3' AND SC08 IS NULL and sc01=cp09(+) and CP158=0 AND CP159=0 and cp13=s1.st01(+) and cp14=s2.st01(+) and cp01=lc01(+) and cp02=lc02(+) and cp03=lc03(+) and cp04=lc04(+) and cp01=cpm01(+) and cp10=cpm02(+) and sc01=ep02(+) and LC15=na01(+)" & _
            " order by cp12 asc,cp13 asc,sc05 asc,cp09 asc"
   CheckOC
   Set Rs = New ADODB.Recordset
   Rs.CursorLocation = adUseClient
   Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   tmpnext = "已取得資料..."
   With Rs
      If .RecordCount > 0 Then
         .MoveFirst
         TempFileName = ""
         strTo = ""
         tmpnext = "開檔中..."
         Do While Not .EOF
            If strTo <> .Fields("cp13") Then
               If strTo <> "" Then
                  Close ff
                  '發 mail
                  'Modified by Lydia 2019/08/08
                  'SendMAPIMail strTo, TempFileName, "Dear Sirs," & vbCrLf & "　　" & TempFileName & " 如附件！" & vbCrLf & vbCrLf & "　　請參考附件內容， 至 智權部->日常作業->智權部自行管制未發文案件作業，" & vbCrLf & "做 [管制完成] 或 [管制新期限] 的處理, 謝謝 !" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", App.path & TextPath & TempFileName & ".txt"
                  SendMAPIMail strTo, TempFileName, "Dear Sirs," & vbCrLf & "　　" & TempFileName & " 如附件！" & vbCrLf & vbCrLf & "　　請參考附件內容， 至 智權部->查詢資料->未發文案件管制，" & vbCrLf & "做 [管制完成] 或 [管制新期限] 的處理, 謝謝 !" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", App.path & TextPath & TempFileName & ".txt"
               End If
               TempFileName = "未發文案件自行管制期限到期通知"
               ff = FreeFile
               If ff > 0 Then Close #ff
               ff = FreeFile
               Open App.path & TextPath & TempFileName & ".txt" For Output As ff
               'Added by Lydia 2016/10/19 加報表抬頭
               Print #ff, Space(45) & TempFileName
               Print #ff, ""
               'end 2016/10/19
               Print #ff, "收文日    本所案號        案件性質   案件名稱   申請國家   智權人員   承辦人     管制期限  自  本所期限  法定期限  預定會稿日 備註                 總收文號"
               Print #ff, "========= =============== ========== ========== ========== ========== ========== ========= === ========= ========= ========== ==================== ========="
            End If
            A01 = convForm(CheckStr("" & .Fields("收文日").Value), 9)
            A02 = convForm(CheckStr("" & .Fields("本所案號").Value), 15)
            A03 = convForm(CheckStr("" & .Fields("案件性質").Value), 10)
            A04 = convForm(CheckStr("" & .Fields("案件名稱").Value), 10)
            A05 = convForm(CheckStr("" & .Fields("申請國家").Value), 10)
            A06 = convForm(CheckStr("" & .Fields("智權人員").Value), 10)
            A07 = convForm(CheckStr("" & .Fields("承辦人").Value), 10)
            A08 = convForm(CheckStr("" & .Fields("管制期限").Value), 9)
            A09 = convForm(CheckStr("" & .Fields("自").Value), 3)
            A10 = convForm(CheckStr("" & .Fields("本所期限").Value), 9)
            A11 = convForm(CheckStr("" & .Fields("法定期限").Value), 9)
            A12 = convForm(CheckStr("" & .Fields("預定會稿日").Value), 10)
            A13 = convForm(CheckStr("" & .Fields("備註").Value), 20)
            A14 = convForm(CheckStr("" & .Fields("總收文號").Value), 9)
            strTo = "" & .Fields("cp13").Value
            tmpnext = "寫檔..."
            Print #ff, A01 & " " & A02 & " " & A03 & " " & A04 & " " & A05 & " " & A06 & " " & A07 & " " & A08 & " " & A09 & " " & A10 & " " & A11 & " " & A12 & " " & A13 & " " & A14
            .MoveNext
         Loop
         Close ff
         tmpnext = "關檔..."
         '發 mail
         If strTo <> "" Then
            'Modified by Lydia 2019/08/08
            'SendMAPIMail strTo, TempFileName, "Dear Sirs," & vbCrLf & "　　" & TempFileName & " 如附件！" & vbCrLf & vbCrLf & "　　請參考附件內容， 至 智權部->日常作業->智權部自行管制未發文案件作業，" & vbCrLf & "做 [管制完成] 或 [管制新期限] 的處理, 謝謝 !" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", App.path & TextPath & TempFileName & ".txt"
            SendMAPIMail strTo, TempFileName, "Dear Sirs," & vbCrLf & "　　" & TempFileName & " 如附件！" & vbCrLf & vbCrLf & "　　請參考附件內容， 至 智權部->查詢資料->未發文案件管制，" & vbCrLf & "做 [管制完成] 或 [管制新期限] 的處理, 謝謝 !" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", App.path & TextPath & TempFileName & ".txt"
         End If
      End If
   End With
   
Set Rs = Nothing
Exit Sub

DebugErr:
   WLog tmpnext & " " & Err.Description
End Sub

''Add By Sindy 2014/10/31 103年11月調整本所期限,檢核其資料
'Sub StrMenu53()
'Dim ff As Integer
'Dim A01 As String
'Dim A02 As String
'Dim A03 As String
'Dim A04 As String
'Dim A05 As String
'Dim A06 As String
'Dim A07 As String
'Dim A08 As String
'Dim A09 As String
'Dim TempFileName As String
'Dim tmpnext As String
'Dim ii As Integer
'Dim strCP01 As String
'Dim strCP02 As String
'Dim strCP03 As String
'Dim strCP04 As String
'
'On Error GoTo DebugErr
'
'   TempFileName = ""
'   For ii = 2 To 9
'
'      'and cp06+0>=20141101
'      'and np08+0>=20141101
'      'Modify By Sindy 2014/11/7
'      '本所期限小於等於系統日的資料,不用列出來
'      '新案件期限是自已輸入,不用列出來
'      If ii = 1 Then
''         strSql = "select 'CP',CP01||'-'||CP02||'-'||CP03||'-'||CP04,sqldatet(CP05),CP09,CP10,sqldatet(CP06),sqldatet(CP07),cp31,0 from caseprogress,patent" & _
''                  " where cp07>=20141105 and cp06+0>" & strSrvDate(1) & " and cp01||cp27||cp57='FCP' and not cp10 in ('101','103','924','926','927') and cp31 is null" & _
''                  " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04 and pa09='000' and pa57||pa108 is null" & _
''                  " and cp06<>workdayadd(-2,to_char(to_date(cp07,'yyyymmdd')-1,'yyyymmdd'))"
'      ElseIf ii = 2 Then
'         strSql = "select 'CP',CP01||'-'||CP02||'-'||CP03||'-'||CP04,sqldatet(CP05),CP09,CP10,sqldatet(CP06),sqldatet(CP07),cp31,0 from caseprogress,patent" & _
'                  " where cp07>=20141105 and cp06+0>" & strSrvDate(1) & " and cp01||cp27||cp57='P' and cp10<>'411' and cp31 is null" & _
'                  " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04 and pa09='000' and pa57||pa108 is null" & _
'                  " and cp06<>workdayadd(-2,to_char(to_date(cp07,'yyyymmdd')-1,'yyyymmdd'))"
'      ElseIf ii = 3 Then
'         'in ('FCP','P')
'         strSql = "select 'NP',NP02||'-'||NP03||'-'||NP04||'-'||NP05,'',NP01,NP07,sqldatet(NP08),sqldatet(NP09),'',NP22 from nextprogress,patent" & _
'                  " where np09>=20141105 and np08+0>" & strSrvDate(1) & " and np06 is null and np02||'' in ('P') and not np07 in ('411','1503','1204')" & _
'                  " and pa01(+)=np02 and pa02(+)=np03 and pa03(+)=np04 and pa04(+)=np05 and pa09='000' and pa57||pa108 is null" & _
'                  " and np08<>workdayadd(-2,to_char(to_date(np09,'yyyymmdd')-1,'yyyymmdd'))"
'      ElseIf ii = 4 Then
'         'in ('PS','FG')
'         strSql = "select 'CP',CP01||'-'||CP02||'-'||CP03||'-'||CP04,sqldatet(CP05),CP09,CP10,sqldatet(CP06),sqldatet(CP07),cp31,0 from caseprogress,servicepractice" & _
'                  " where cp07>=20141105 and cp06+0>" & strSrvDate(1) & " and cp27||cp57 is null and cp01||'' in ('PS') and cp31 is null" & _
'                  " and sp01(+)=cp01 and sp02(+)=cp02 and sp03(+)=cp03 and sp04(+)=cp04 and sp09='000' and sp16||sp61 is null" & _
'                  " and cp06<>workdayadd(-2,to_char(to_date(cp07,'yyyymmdd')-1,'yyyymmdd'))"
'      ElseIf ii = 5 Then
'         'in ('PS','FG')
'         strSql = "select 'NP',NP02||'-'||NP03||'-'||NP04||'-'||NP05,'',NP01,NP07,sqldatet(NP08),sqldatet(NP09),'',NP22 from nextprogress,servicepractice" & _
'                  " where np09>=20141105 and np08+0>" & strSrvDate(1) & " and np06 is null and np02||'' in ('PS')" & _
'                  " and sp01(+)=np02 and sp02(+)=np03 and sp03(+)=np04 and sp04(+)=np05 and sp09='000' and sp16||sp61 is null" & _
'                  " and np08<>workdayadd(-2,to_char(to_date(np09,'yyyymmdd')-1,'yyyymmdd'))"
'      ElseIf ii = 6 Then
'         strSql = "select 'CP',CP01||'-'||CP02||'-'||CP03||'-'||CP04,sqldatet(CP05),CP09,CP10,sqldatet(CP06),sqldatet(CP07),cp31,0 from caseprogress,TradeMark" & _
'                  " where cp07>=20141105 and cp06+0>" & strSrvDate(1) & " and cp27||cp57 is null and cp01||'' in ('T','FCT') and cp10<>'208' and cp10<>'305' and cp10<>'1719' and cp31 is null" & _
'                  " and tm01(+)=cp01 and tm02(+)=cp02 and tm03(+)=cp03 and tm04(+)=cp04 and tm10='000' and tm29||tm57 is null" & _
'                  " and cp06<>workdayadd(-2,to_char(to_date(cp07,'yyyymmdd')-1,'yyyymmdd'))"
'      ElseIf ii = 7 Then
'         strSql = "select 'NP',NP02||'-'||NP03||'-'||NP04||'-'||NP05,'',NP01,NP07,sqldatet(NP08),sqldatet(NP09),'',NP22 from nextprogress,TradeMark" & _
'                  " where np09>=20141105 and np08+0>" & strSrvDate(1) & " and np06 is null and np02||'' in ('T','FCT') and not np07 in ('208','305','723')" & _
'                  " and tm01(+)=np02 and tm02(+)=np03 and tm03(+)=np04 and tm04(+)=np05 and tm10='000' and tm29||tm57 is null" & _
'                  " and np08<>workdayadd(-2,to_char(to_date(np09,'yyyymmdd')-1,'yyyymmdd'))"
'      ElseIf ii = 8 Then
'         strSql = "select 'CP',CP01||'-'||CP02||'-'||CP03||'-'||CP04,sqldatet(CP05),CP09,CP10,sqldatet(CP06),sqldatet(CP07),cp31,0 from caseprogress,servicepractice" & _
'                  " where cp07>=20141105 and cp06+0>" & strSrvDate(1) & " and cp27||cp57 is null and (cp01||''='S' or substr(cp01,1,1)='T') and cp10<>'208' and cp10<>'305' and cp10<>'1719' and cp31 is null" & _
'                  " and sp01(+)=cp01 and sp02(+)=cp02 and sp03(+)=cp03 and sp04(+)=cp04 and sp09='000' and sp16||sp61 is null" & _
'                  " and cp06<>workdayadd(-2,to_char(to_date(cp07,'yyyymmdd')-1,'yyyymmdd'))"
'      ElseIf ii = 9 Then
'         strSql = "select 'NP',NP02||'-'||NP03||'-'||NP04||'-'||NP05,'',NP01,NP07,sqldatet(NP08),sqldatet(NP09),'',NP22 from nextprogress,servicepractice" & _
'                  " where np09>=20141105 and np08+0>" & strSrvDate(1) & " and np06 is null and (np02||''='S' or substr(np02,1,1)='T')" & _
'                  " and sp01(+)=np02 and sp02(+)=np03 and sp03(+)=np04 and sp04(+)=np05 and sp09='000' and sp16||sp61 is null" & _
'                  " and np08<>workdayadd(-2,to_char(to_date(np09,'yyyymmdd')-1,'yyyymmdd'))"
'      End If
'      CheckOC
'      Set rs = New ADODB.Recordset
'      rs.CursorLocation = adUseClient
'      rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
'      tmpnext = ii & "已取得資料..."
'      With rs
'         If .RecordCount > 0 Then
'            .MoveFirst
'            tmpnext = ii & "開檔中..."
'            Do While Not .EOF
'               If TempFileName = "" Then
'                  TempFileName = "103年11月調整本所期限-有問題的案件資料"
'                  ff = FreeFile
'                  If ff > 0 Then Close #ff
'                  ff = FreeFile
'                  Open App.path & TextPath & TempFileName & ".txt" For Output As ff
'                  Print #ff, "種類  本所案號        收文日期   總收文號   案件性質   本所期限   法定期限   是否新案件 NP22"
'                  Print #ff, "===== =============== ========== ========== ========== ========== ========== ========== =========="
'               End If
'               strCP01 = SystemNumber(.Fields(1).Value, 1)
'               strCP02 = SystemNumber(.Fields(1).Value, 2)
'               strCP03 = SystemNumber(.Fields(1).Value, 3)
'               strCP04 = SystemNumber(.Fields(1).Value, 4)
'               '排除已核對過的資料
'               If .Fields(0).Value = "CP" Then
'                  strExc(0) = "SELECT * FROM TmpAutoChkCP09 WHERE upper(kind)='CP' and cp09='" & .Fields(3).Value & "'"
'                  intI = 1
'                  Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
'                  If intI = 1 Then
'                     GoTo Menu53_ReadNext
'                  End If
'                  'Add By Sindy 2014/11/13 若同一天收文有新案件,不用列出來
'                  strExc(0) = "SELECT CP09 FROM caseprogress WHERE cp01='" & strCP01 & "' and cp02='" & strCP02 & "' and cp03='" & strCP03 & "' and cp04='" & strCP04 & "'" & _
'                              " and cp05=" & DBDATE(.Fields(2).Value) & " and cp31='Y'"
'                  intI = 1
'                  Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
'                  If intI = 1 Then
'                     If RsTemp.RecordCount > 0 Then
'                        GoTo Menu53_ReadNext
'                     End If
'                  End If
'                  'Add By Sindy 2014/11/14 針對案件性質做延期
'                  If strCP01 = "T" Or strCP01 = "FCT" Then
'                     strExc(0) = "SELECT c1.CP09 FROM caseprogress c1,caseprogress c2 WHERE c1.CP09='" & .Fields(3).Value & "' and c1.CP09=c2.CP43(+)" & _
'                                 " and c2.CP10='303'"
'                     intI = 1
'                     Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
'                     If intI = 1 Then
'                        If RsTemp.RecordCount > 0 Then
'                           GoTo Menu53_ReadNext
'                        End If
'                     End If
'                  End If
'                  'Add By Sindy 2014/11/14 通知申請案號的補正,不用列出來
'                  If strCP01 = "FCT" And .Fields(4).Value = "201" Then
'                     strExc(0) = "SELECT c1.CP09 FROM caseprogress c1,caseprogress c2 WHERE c1.CP09='" & .Fields(3).Value & "' and c1.CP43=c2.CP09(+)" & _
'                                 " and c2.CP10='1101'"
'                     intI = 1
'                     Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
'                     If intI = 1 Then
'                        If RsTemp.RecordCount > 0 Then
'                           GoTo Menu53_ReadNext
'                        End If
'                     End If
'                  End If
'               'NP
'               Else
'                  strExc(0) = "SELECT * FROM TmpAutoChkCP09 WHERE upper(kind)='NP' and cp09='" & .Fields(3).Value & "'" & _
'                              " and np07='" & .Fields(4).Value & "' and NP22='" & .Fields(8).Value & "'"
'                  intI = 1
'                  Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
'                  If intI = 1 Then
'                     GoTo Menu53_ReadNext
'                  End If
'                  'Add By Sindy 2014/11/13 下一程序延期,不用列出來
'                  If strCP01 = "T" Or strCP01 = "FCT" Then
'                     strExc(0) = "SELECT CP09 FROM nextprogress,caseprogress WHERE np01='" & .Fields(3).Value & "' and np01=cp43" & _
'                                 " and cp10='303'"
'                     intI = 1
'                     Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
'                     If intI = 1 Then
'                        If RsTemp.RecordCount > 0 Then
'                           GoTo Menu53_ReadNext
'                        End If
'                     End If
'                  End If
'                  'Add By Sindy 2014/11/13 通知申請案號的下一程序補正,不用列出來
'                  If strCP01 = "FCT" And .Fields(4).Value = "201" Then
'                     strExc(0) = "SELECT CP09 FROM nextprogress,caseprogress WHERE np01='" & .Fields(3).Value & "' and np01=cp09" & _
'                                 " and cp10='1101'"
'                     intI = 1
'                     Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
'                     If intI = 1 Then
'                        If RsTemp.RecordCount > 0 Then
'                           GoTo Menu53_ReadNext
'                        End If
'                     End If
'                  End If
'                  '305催審,不用列出來
'                  If InStr(strCP01, "T") > 0 And .Fields(4).Value = "305" Then GoTo Menu53_ReadNext
'               End If
'               A01 = convForm(CheckStr(.Fields(0).Value), 5)  '種類
'               A02 = convForm(CheckStr(.Fields(1).Value), 15) '本所案號
'               A03 = convForm(CheckStr(.Fields(2).Value), 10) '收文日期
'               A04 = convForm(CheckStr(.Fields(3).Value), 10) '總收文號
'               A05 = convForm(CheckStr(.Fields(4).Value), 10) '案件性質
'               A06 = convForm(CheckStr(.Fields(5).Value), 10) '本所期限
'               A07 = convForm(CheckStr(.Fields(6).Value), 10) '法定期限
'               A08 = convForm(CheckStr(.Fields(7).Value), 10) '是否新案件
'               A09 = convForm(CheckStr(.Fields(8).Value), 10) 'NP22
'               tmpnext = ii & "寫檔..."
'               Print #ff, A01 & " " & A02 & " " & A03 & " " & A04 & " " & A05 & " " & A06 & " " & A07 & " " & A08 & " " & A09
'Menu53_ReadNext:
'               .MoveNext
'            Loop
'            tmpnext = ii & "關檔..."
'         End If
'      End With
'   Next ii
'   '發 mail
'   If TempFileName <> "" Then
'      Close ff
'      SendMAPIMail "92012;97038", TempFileName, "Dear Sirs," & vbCrLf & "　　" & TempFileName & " 如附件！" & vbCrLf & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", App.path & TextPath & TempFileName & ".txt"
'   End If
'
'Set rs = Nothing
'Exit Sub
'
'DebugErr:
'   WLog tmpnext & " " & Err.Description
'End Sub
'
''Add By Sindy 2014/11/21 專利發明人60~69轉檔,及檢查是否還有存入舊欄位的資料
'Sub StrMenu54()
'Memo by Lydia 2021/08/17 刪除舊程式碼
'End Sub

'Add By Amy 2015/01/22 北所分案日有值且自第二個工作日起
Sub StrMenu55()
    Dim strDate As String, strStartDate As String
    Dim ff As Integer
    Dim TempFileName As String, strTemp(7) As String
    Dim strTo As String
    Dim ii As Integer, strSysKind As String
    Dim strSpec As String 'Add by Amy 2015/02/06
    Dim StrDate2 As String 'Add by Amy 2015/03/04
    
On Error GoTo DebugErr
    
    '北所分案日有值且自第二個工作日起,檢查P、CFP、PS、CPS案之承辦人的部門為P10或P11時,
    'Modify by Amy 2015/02/04 若無工程師收卷日(null)時,列P、PS清單(txt檔)發mail給系統特殊設定人員A12
    'CFP、CPS發mail給系統特殊設定人員A11
    
    strStartDate = "20150201"
    strDate = PUB_GetWorkDayAfterSysDate(CDbl(strSrvDate(1)), -2) + 19110000
    'Add by Amy 2015/03/04
    StrDate2 = PUB_GetWorkDayAfterSysDate(CDbl(strSrvDate(1)), -4) + 19110000
    'Modify by Amy 2015/02/06 +排除已發文、取消收文、非A類
    strSpec = " And b.cp09 <'B' "
    
    For ii = 0 To 1
       'Modify by Amy 2015/03/04 CFP及CPS改為第四個工作天起通知,即星期一分案者,CFP案星期五早上通知
       'Modified by Lydia 2016/09/14 nvl(cp27,0)=0 And nvl(cp57,0)=0 => CP158=0 AND CP159=0
       'Modify by Amy 2016/09/29 原只控制 承辦人的部門為P10或P11,再加入98012陳品薇
       'Modified by Morgan 2025/1/22 P程序人員工作改依智權區域分配，取消98012判斷，改抓P12及新申請案程序--郭
        strSql = "Select s1.st02 as 承辦人,sqldatet(cp05) as 收文日,cp01||'-'||cp02||'-'||cp03||'-'||cp04 as 本所案號,b.cp09 as 總收文號,Nvl(Decode(Pa09,'000',cpm03,cpm04),cp10) AS 案件性質,Nvl(pa05,Nvl(pa06,pa07)) AS 案件名稱,Nvl(s2.st02,cp13) AS 智權人員,sqldatet(cp157) as 北所分案日 " & _
                    "From Patent,CaseProgress b,Staff s1,staff s2,CasePropertyMap,EngineerProgress,(Select cp09 from CaseProgress Where cp157>" & strStartDate & " And cp157<=" & IIf(ii = 0, strDate, StrDate2) & ") a " & _
                    "Where cp01 =" & IIf(ii = 0, "'P'", "'CFP'") & " And ep27 is null And (s1.st03 in ('P10','P11') or (s1.st03='P12' and cp10 in (" & NewCasePtyList & "))) And CP158=0 AND CP159=0 " & strSpec & _
                    "And cp14=s1.st01(+) and cp13=s2.st01(+) And cp01=pa01(+) And cp02=pa02(+) And cp03=pa03(+) And cp04=pa04(+) And cp01=cpm01(+) And cp10=cpm02(+) And b.cp09=ep02(+) And a.cp09=b.cp09 "
         strSql = strSql & "Union " & _
                   "Select s1.st02 as 承辦人,sqldatet(cp05) as 收文日,cp01||'-'||cp02||'-'||cp03||'-'||cp04 as 本所案號,b.cp09 as 總收文號,Nvl(Decode(Sp09,'000',cpm03,cpm04),cp10) AS 案件性質,Nvl(sp05,Nvl(sp06,sp07)) AS 案件名稱,Nvl(s2.st02,cp13) AS 智權人員,sqldatet(cp157) as 北所分案日 " & _
                    "From ServicePractice,CaseProgress b,Staff s1,staff s2,CasePropertyMap,EngineerProgress,(Select cp09 from CaseProgress Where cp157>" & strStartDate & " And cp157<=" & IIf(ii = 0, strDate, StrDate2) & ") a " & _
                    "Where cp01 =" & IIf(ii = 0, "'PS'", "'CPS'") & " And ep27 is null And s1.st03 in ('P10','P11') And CP158=0 AND CP159=0 " & strSpec & _
                    "And cp14=s1.st01(+) and cp13=s2.st01(+) And cp01=sp01(+) And cp02=sp02(+) And cp03=sp03(+) And cp04=sp04(+) And cp01=cpm01(+) And cp10=cpm02(+) And b.cp09=ep02(+) And a.cp09=b.cp09 "
         'end 2015/02/06
         strSql = "Select * From (" & strSql & ") Order by 承辦人,收文日,總收文號"
    
        Set Rs = New ADODB.Recordset
        Rs.CursorLocation = adUseClient
        Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
        With Rs
            If .RecordCount > 0 Then
                .MoveFirst
                Do While Not .EOF
                    If TempFileName = "" Then
                        TempFileName = "工程師未收卷清單"
                        ff = FreeFile
                        If ff > 0 Then Close #ff
                        ff = FreeFile
                        Open App.path & TextPath & TempFileName & ".txt" For Output As ff
                        'Added by Lydia 2016/10/19 加報表抬頭
                        Print #ff, Space(35) & TempFileName
                        Print #ff, ""
                        'end 2016/10/19
                        Print #ff, "承辦人     收文日     本所案號        總收文號   案件性質     案件名稱             智權人員   北所分案日"
                        Print #ff, "========== ========== =============== ========== ============ ==================== ========== =========="
                    End If
                    strTemp(0) = convForm(CheckStr("" & .Fields("承辦人")), 10)
                    strTemp(1) = convForm(CheckStr("" & .Fields("收文日")), 10)
                    strTemp(2) = convForm(CheckStr("" & .Fields("本所案號")), 15)
                    strTemp(3) = convForm(CheckStr("" & .Fields("總收文號")), 10)
                    strTemp(4) = convForm(CheckStr("" & .Fields("案件性質")), 12)
                    strTemp(5) = convForm(CheckStr("" & .Fields("案件名稱")), 20)
                    strTemp(6) = convForm(CheckStr("" & .Fields("智權人員")), 10)
                    strTemp(7) = convForm(CheckStr("" & .Fields("北所分案日")), 10)
                    
                    Print #ff, strTemp(0) & " " & strTemp(1) & " " & strTemp(2) & " " & strTemp(3) & " " & strTemp(4) & " " & strTemp(5) & " " & strTemp(6) & " " & strTemp(7)
                    
                    .MoveNext
                Loop
            End If
            If TempFileName <> "" Then
                Close ff
                If ii = 0 Then
                    strTo = Pub_GetSpecMan("A12")
                Else
                    strTo = Pub_GetSpecMan("A11")
                End If
                If strTo <> "" Then
                    SendMAPIMail strTo, TempFileName, "Dear Sirs," & vbCrLf & "　　" & TempFileName & " 如附件！" & vbCrLf & vbCrLf & "電腦中心", App.path & TextPath & TempFileName & ".txt"
                End If
            End If
        End With
        TempFileName = ""
    Next ii
    'end 2015/02/04
    Set Rs = Nothing
    Exit Sub
    
DebugErr:
    WLog "北所分案日檢查失敗" & " " & Err.Description
End Sub

'Add by Lydia 2015/02/11
'CF結匯金額異常通知
Private Sub StrMenu56()
   Dim stSQL As String, stDate As String
   Dim ff As Integer
   Dim TempFileName As String, strTemp(4) As String
   Dim strTo As String
On Error GoTo ErrHandle

   stDate = ChangeWStringToTString(CompWorkDay(1, CompDate(2, -1, strSrvDate(1))))
   'add by sonia 2016/5/25 加入閉卷程序改判斷該案件是否計算過結餘105/2/3結匯CFP-021511之閉卷
   'stSQL = "select (substr(a1p04,1,instr(a1p04,'Y')-1)||a1p17) R00,a0205 R01,substr(a1p04,1,instr(a1p04,'Y')-1) R02,a1p17 R03,cp59 R04,a240015 R05 " & _
           "from acc020,acc1p0,caseprogress,acc240 where a0206>=" & stDate & " and a0206<" & strSrvDate(2) & _
           "and a0201=a1p01(+) and a0202=a1p22(+) and a1p02='I' and length(a1p23)>0 and substr(a1p23,10,9)=cp09(+) " & _
           "and length(cp59)>0 and cp59=a240002(+) and A240015 > 0 order by 1 "
   stSQL = "select (substr(a1p04,1,instr(a1p04,'Y')-1)||a1p17) R00,a0205 R01,substr(a1p04,1,instr(a1p04,'Y')-1) R02,a1p17 R03,cp59 R04,a240015 R05 " & _
           "from acc020,acc1p0,caseprogress,acc240 where a0206>=" & stDate & " and a0206<" & strSrvDate(2) & _
           "and a0201=a1p01(+) and a0202=a1p22(+) and a1p02='I' and length(a1p23)>0 and substr(a1p23,10,9)=cp09(+) " & _
           "and length(cp59)>0 and cp59=a240002(+) and A240015 > 0 "
   'Modified by Lydia 2016/06/07 debug
   stSQL = stSQL & "union select distinct (substr(a1p04,1,instr(a1p04,'Y')-1)||a1p17) R00,a0205 R01,substr(a1p04,1,instr(a1p04,'Y')-1) R02,a1p17 R03,c2.cp59 R04,a240015 R05 " & _
           "from acc020,acc1p0,acc240,caseprogress c1,caseprogress c2,casepropertymap where a0206>=" & stDate & " and a0206<" & strSrvDate(2) & _
           "and a0201=a1p01(+) and a0202=a1p22(+) and a1p02='I' and length(a1p23)>0 " & _
           "and substr(a1p23,10,9)=c1.cp09(+) and c1.cp01=cpm01(+) and c1.cp10=cpm02(+) and cpm03='閉卷' " & _
           "and substr(a1p17, 1, length(a1p17) - 9)=c2.cp01(+) AND substr(a1p17, length(a1p17) - 8, 6)=c2.cp02(+) AND substr(a1p17, length(a1p17) - 2, 1)=c2.cp03(+) AND substr(a1p17, length(a1p17) - 1, 2)=c2.cp04(+) " & _
           "and length(c2.cp59)>0 and c2.cp59=a240002(+) and A240015 > 0 "
   stSQL = stSQL & "order by 1 "
   'end 2016/5/25
   
   If Rs.State <> adStateClosed Then Rs.Close
  
    Set Rs = New ADODB.Recordset
    Rs.CursorLocation = adUseClient
    Rs.Open stSQL, cnnConnection, adOpenStatic, adLockReadOnly
    With Rs
        If .RecordCount > 0 Then
            .MoveFirst
            Do While Not .EOF
                If TempFileName = "" Then
                    TempFileName = "結匯案件已結餘但又產生規費"
                   ' ff = FreeFile
                    If ff > 0 Then Close #ff
                    ff = FreeFile
                    Open App.path & TextPath & TempFileName & ".txt" For Output As ff
                    strExc(0) = convForm(" ", 25)
                    strExc(1) = convForm(" ", 70)
                    Print #ff, strExc(0) & TempFileName
                    Print #ff, strExc(1) & "列印日期：" & ChangeWStringToTString(strSrvDate(1))
                    Print #ff, "結匯日期   匯票號碼             本所案號        結餘單號   結算日期  "
                    Print #ff, "========== ==================== =============== ========== =========="
                End If
                strTemp(0) = convForm(CheckStr("" & .Fields("R01")), 10)
                strTemp(1) = convForm(CheckStr("" & .Fields("R02")), 20)
                strTemp(2) = convForm(CheckStr("" & .Fields("R03")), 15)
                strTemp(3) = convForm(CheckStr("" & .Fields("R04")), 10)
                strTemp(4) = convForm(CheckStr("" & .Fields("R05")), 10)
               
                Print #ff, strTemp(0) & " " & strTemp(1) & " " & strTemp(2) & " " & strTemp(3) & " " & strTemp(4)
                
                .MoveNext
            Loop
        End If
        If TempFileName <> "" Then
            Close ff
            strTo = Pub_GetSpecMan("財務處總帳人員")
            
            If strTo <> "" Then
                SendMAPIMail strTo, "本日有結匯案件已結餘但又產生規費，清單格式(依匯票號碼+本所案號排序)：", "見附件", App.path & TextPath & TempFileName & ".txt"
            End If
        End If
    End With
    TempFileName = ""
    
ErrHandle:
   If Err.Number <> 0 Then
      WLog "CF結匯金額異常通知:" & Err.Description
   End If
   Set Rs = Nothing
'   Set cnnConnection = Nothing
End Sub

'Add by Sindy 2015/2/25 大陸商標代理收達後管制提申(每星期一通知)
'Modify By Sindy 2016/9/5 原為每週一通知, 改為每週一及週四通知
Private Sub StrMenu57()
   Dim stSQL As String, stDate As String
   Dim ff As Integer
   Dim TempFileName As String, strTemp(6) As String
   Dim strTo As String
   Dim strNPsql As String 'Added by Lydia 2016/09/12
On Error GoTo ErrHandle
   
   'stDate = PUB_GetWorkDayAfterSysDate(CDbl(strSrvDate(1)), -10) + 19110000
   'Modify By Sindy 2016/9/5 原為10個工作天, 改為7個工作天
   stDate = PUB_GetWorkDayAfterSysDate(CDbl(strSrvDate(1)), -7) + 19110000
   
   'Added by Lydia 2016/09/12 每週一抓大陸案註冊証
   If Weekday(Format(strSrvDate(1), "####-##-##")) = 2 Then
      'Modified by Lydia 2020/02/05 下一程序NP10記錄當時的承辦人
      'strNPsql = " union all select cp14,substr(n1.st02,1,3) 承辦人,substr(n2.st02,1,3) 程序,tm05 商標名稱,substr(fa04,1,6) 代理人,substr(sqldatet(cp46),1,10) 收達日," & _
                 " cp01||'-'||cp02||'-'||cp03||'-'||cp04 本所案號,substr(cpm04,1,6) 案件性質,cp44,cp46,cp02 from nextprogress,caseprogress,fagent,staff n1,staff n2,casepropertymap,trademark" & _
                 " where NP02='T' AND NP07='1701' AND NVL(NP06,'0')='0' AND NP08<" & stDate & " AND NP01=CP09(+) AND CP159=0 " & _
                 " and np02=cpm01(+) and np07=cpm02(+) and substr(cp44,1,8)=fa01(+) and substr(cp44,9,1)=fa02(+) and cp14=n1.st01(+) and cp83=n2.st01(+) and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+)" & _
                 " and cp04=tm04(+) and tm29 is null"
      'Modified by Lydia 2022/11/28 抓NP10請改為decode(np10,'P2001',decode(tm10,'000','84027','86048'),NP10)
      strNPsql = " union all select decode(np10,'P2001',decode(tm10,'000','84027','86048'),NP10) np10,substr(n1.st02,1,3) 承辦人,substr(n2.st02,1,3) 程序,tm05 商標名稱,substr(fa04,1,6) 代理人,substr(sqldatet(cp46),1,10) 收達日," & _
                 " cp01||'-'||cp02||'-'||cp03||'-'||cp04 本所案號,substr(cpm04,1,6) 案件性質,cp44,cp46,cp02 from nextprogress,caseprogress,fagent,staff n1,staff n2,casepropertymap,trademark" & _
                 " where NP02='T' AND NP07='1701' AND NVL(NP06,'0')='0' AND NP08<" & stDate & " AND NP01=CP09(+) AND CP159=0 " & _
                 " and np02=cpm01(+) and np07=cpm02(+) and substr(cp44,1,8)=fa01(+) and substr(cp44,9,1)=fa02(+) and np10=n1.st01(+) and cp83=n2.st01(+) and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+)" & _
                 " and cp04=tm04(+) and tm29 is null"
   End If
   'end 2016/09/12
   
   '收達日1030101以後才管制
   '通知承辦人:
   'Modify By Sindy 2015/3/20 cp44 編號==>tm05 商標名稱
   '                          案件性質"308分割","701領証"排除掉(因代理人不會通知)
   'Modified by Lydia 2016/09/12 nvl(cp57,0)=0= >CP159=0  ; +strNPsql; + ,cp44,cp46,cp02
   'modify by sonia 2019/11/7 +CP158>0的控制,廢止案要管制期限前不可發文,管制期限先存CP46,發文時再清除
   'Modified by Lydia 2022/11/28 抓CP14請改為decode(s1.st04,'2','86048',cp14)
   stSQL = "select decode(s1.st04,'2','86048',cp14) cp14,substr(s1.st02,1,3) 承辦人,substr(s2.st02,1,3) 程序,tm05 商標名稱,substr(fa04,1,6) 代理人,substr(sqldatet(cp46),1,10) 收達日,cp01||'-'||cp02||'-'||cp03||'-'||cp04 本所案號,substr(cpm04,1,6) 案件性質" & _
           ",cp44,cp46,cp02 from caseprogress,fagent,staff s1,staff s2,casepropertymap,trademark" & _
           " where cp01='T'" & _
           " and CP159=0 and CP158>0" & _
           " and cp46>=20140101 and cp46<" & stDate & _
           " and nvl(cp47,0)=0" & _
           " and cp24 is null" & _
           " and cp01=cpm01(+) and cp10=cpm02(+)" & _
           " and cp10 not in ('001','108','201','203','206','302','612','706','711','714','308','701')" & _
           " and substr(cp44,1,8)=fa01(+) and substr(cp44,9,1)=fa02(+)" & _
           " and cp14=s1.st01(+) and cp83=s2.st01(+)" & _
           " and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+)" & _
           " and tm29 is null" & strNPsql & _
           " order by cp14,cp44,cp46,cp02"
   If Rs.State <> adStateClosed Then Rs.Close
   Set Rs = New ADODB.Recordset
   Rs.CursorLocation = adUseClient
   Rs.Open stSQL, cnnConnection, adOpenStatic, adLockReadOnly
   With Rs
      If .RecordCount > 0 Then
         .MoveFirst
         Do While Not .EOF
            If TempFileName = "" Or strTo <> "" & .Fields(0) Then
               If strTo <> "" And TempFileName <> "" Then
                  Close ff
                  SendMAPIMail strTo, TempFileName, "Dear Sirs," & vbCrLf & "　　" & TempFileName & " 如附件！" & vbCrLf & vbCrLf & "電腦中心", App.path & TextPath & TempFileName & ".txt"
               End If
               'Modified by Lydia 2016/11/02 因為承辦人和cp83有可能一樣,所以改標題
               'TempFileName = "大陸商標代理收達後管制提申"
               TempFileName = "大陸商標代理收達後管制提申-承辦"
               ff = FreeFile
               If ff > 0 Then Close #ff
               ff = FreeFile
               Open App.path & TextPath & TempFileName & ".txt" For Output As ff
               'Added by Lydia 2016/10/19 加報表抬頭
               'Modified by Lydia 2016/11/02 +"-承辦"
               Print #ff, Space(25) & TempFileName + "-承辦"
               Print #ff, ""
               'end 2016/10/19
               Print #ff, "承辦人   程序     商標名稱           代理人           收達日    本所案號     案件性質"
               Print #ff, "======== ======== ================== ================ ========= ============ ============"
            End If
            strTemp(0) = convForm(CheckStr("" & .Fields(1)), 8)
            strTemp(1) = convForm(CheckStr("" & .Fields(2)), 8)
            strTemp(2) = convForm(CheckStr("" & .Fields(3)), 18)
            strTemp(3) = convForm(CheckStr("" & .Fields(4)), 16)
            strTemp(4) = convForm(CheckStr("" & .Fields(5)), 9)
            strTemp(5) = convForm(CheckStr("" & .Fields(6)), 12)
            strTemp(6) = convForm(CheckStr("" & .Fields(7)), 12)
            strTo = "" & .Fields(0)
            Print #ff, strTemp(0) & " " & strTemp(1) & " " & strTemp(2) & " " & strTemp(3) & " " & strTemp(4) & " " & strTemp(5) & " " & strTemp(6)
            .MoveNext
         Loop
      End If
      If strTo <> "" And TempFileName <> "" Then
         Close ff
         SendMAPIMail strTo, TempFileName, "Dear Sirs," & vbCrLf & "　　" & TempFileName & " 如附件！" & vbCrLf & vbCrLf & "電腦中心", App.path & TextPath & TempFileName & ".txt"
      End If
   End With
   Rs.Close
   
   TempFileName = "": strTo = ""
   '通知程序人員:
   'Modify By Sindy 2015/3/20 cp44 編號==>tm05 商標名稱
   '                          案件性質"308分割","701領証"排除掉(因代理人不會通知)
   'Modified by Lydia 2016/09/12 nvl(cp57,0)=0= >CP159=0  ; +strNPsql; + ,cp44,cp46,cp02
   'modify by sonia 2019/11/7 +CP158>0的控制,廢止案要管制期限前不可發文,管制期限先存CP46,發文時再清除
   'Modified by Lydia 2020/02/05 Replace(strNPsql, "union all select cp14", "union all select cp83") => Replace(strNPsql, "union all select np10", "union all select cp83")
   'Modified by Lydia 2022/11/28 抓NP10請改為decode(np10,'P2001',decode(tm10,'000','84027','86048'),NP10)
   stSQL = "select cp83,substr(s1.st02,1,3) 承辦人,substr(s2.st02,1,3) 程序,tm05 商標名稱,substr(fa04,1,6) 代理人,substr(sqldatet(cp46),1,10) 收達日,cp01||'-'||cp02||'-'||cp03||'-'||cp04 本所案號,substr(cpm04,1,6) 案件性質" & _
           ",cp44,cp46,cp02 from caseprogress,fagent,staff s1,staff s2,casepropertymap,trademark" & _
           " where cp01='T'" & _
           " and CP159=0 and CP158>0" & _
           " and cp46>=20140101 and cp46<" & stDate & _
           " and nvl(cp47,0)=0" & _
           " and cp24 is null" & _
           " and cp01=cpm01(+) and cp10=cpm02(+)" & _
           " and cp10 not in ('001','108','201','203','206','302','612','706','711','714','308','701')" & _
           " and substr(cp44,1,8)=fa01(+) and substr(cp44,9,1)=fa02(+)" & _
           " and cp14=s1.st01(+) and cp83=s2.st01(+)" & _
           " and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+)" & _
           " and tm29 is null" & Replace(strNPsql, "union all select decode(np10,'P2001',decode(tm10,'000','84027','86048'),NP10) np10", "union all select cp83") & _
           " order by cp83,cp44,cp46,cp02"
   If Rs.State <> adStateClosed Then Rs.Close
   Set Rs = New ADODB.Recordset
   Rs.CursorLocation = adUseClient
   Rs.Open stSQL, cnnConnection, adOpenStatic, adLockReadOnly
   With Rs
      If .RecordCount > 0 Then
         .MoveFirst
         Do While Not .EOF
            If TempFileName = "" Or strTo <> "" & .Fields(0) Then
               If strTo <> "" And TempFileName <> "" Then
                  Close ff
                  SendMAPIMail strTo, TempFileName, "Dear Sirs," & vbCrLf & "　　" & TempFileName & " 如附件！" & vbCrLf & vbCrLf & "電腦中心", App.path & TextPath & TempFileName & ".txt"
               End If
               'Modified by Lydia 2016/11/02 因為承辦人和cp83有可能一樣,所以改標題
               'TempFileName = "大陸商標代理收達後管制提申"
               TempFileName = "大陸商標代理收達後管制提申-程序"
               ff = FreeFile
               If ff > 0 Then Close #ff
               ff = FreeFile
               Open App.path & TextPath & TempFileName & ".txt" For Output As ff
               'Added by Lydia 2016/10/19 加報表抬頭
               'Modified by Lydia 2016/11/02 +"-程序"
               Print #ff, Space(25) & TempFileName & "-程序"
               Print #ff, ""
               'end 2016/10/19
               Print #ff, "承辦人   程序     商標名稱           代理人           收達日    本所案號     案件性質"
               Print #ff, "======== ======== ================== ================ ========= ============ ============"
            End If
            strTemp(0) = convForm(CheckStr("" & .Fields(1)), 8)
            strTemp(1) = convForm(CheckStr("" & .Fields(2)), 8)
            strTemp(2) = convForm(CheckStr("" & .Fields(3)), 18)
            strTemp(3) = convForm(CheckStr("" & .Fields(4)), 16)
            strTemp(4) = convForm(CheckStr("" & .Fields(5)), 9)
            strTemp(5) = convForm(CheckStr("" & .Fields(6)), 12)
            strTemp(6) = convForm(CheckStr("" & .Fields(7)), 12)
            strTo = "" & .Fields(0)
            Print #ff, strTemp(0) & " " & strTemp(1) & " " & strTemp(2) & " " & strTemp(3) & " " & strTemp(4) & " " & strTemp(5) & " " & strTemp(6)
            .MoveNext
         Loop
      End If
      If strTo <> "" And TempFileName <> "" Then
         Close ff
         SendMAPIMail strTo, TempFileName, "Dear Sirs," & vbCrLf & "　　" & TempFileName & " 如附件！" & vbCrLf & vbCrLf & "電腦中心", App.path & TextPath & TempFileName & ".txt"
      End If
   End With
   Rs.Close
   TempFileName = "": strTo = ""
   Exit Sub
   
ErrHandle:
   If Err.Number <> 0 Then
      WLog "大陸商標代理收達後管制提申:" & Err.Description
   End If
   Set Rs = Nothing
End Sub

'Add By Sindy 2015/3/31 每週五固定要的資料-新舊客戶案件統計資料
Private Sub StrMenu58()
   Dim strSql As String, strDate_S As String, strDate_E As String
   Dim ff As Integer
   Dim TempFileName1 As String, TempFileName2 As String, strTemp(6) As String
   Dim strToFCP As String, strToFCT As String 'Added by Lydia 2020/03/04 若有外專F2x／外商資料F1x，則增加通知王協理(外專)和江協理(外商)
   
On Error GoTo ErrHandle
   
   strDate_S = DBDATE(DateAdd("d", -7, Format(strSrvDate(1), "####/##/##"))) '上週五
   strDate_E = DBDATE(DateAdd("d", -1, Format(strSrvDate(1), "####/##/##"))) '本週四
   
   '上週五至本週四新客戶名單(開發日期在此區間)
   'Modify By Sindy 2015/5/18 +性質
   'Modified by Lydia 2016/09/14 NVL(cp57,0)=0 => CP159=0
   strSql = "select NA01||SUBSTR(na03,1,6) 國籍,cu01 編號,SUBSTR(decode(cu04,null,decode(cu05,null,cu06,cu05||' '||cu88||' '||cu89||' '||cu90),cu04),1,14) 申請人名稱,count(*) 新案號件數,st02 智權人員,decode(fa76,'A','代理人委辦','B','客戶直接委辦') 性質,CU03,CU12,CU10" & _
            " from staff,nation,CUSTOMER,(" & _
            "SELECT CP09,CP01,CP02,CP03,CP04,CP10,CP05,PA26 cuid from customer,patent,caseprogress" & _
            " Where cu14>=" & strDate_S & " And cu14<=" & strDate_E & " And CU01 = SUBSTR(pa26, 1, 8) And cu02 = SUBSTR(pa26, 9)" & _
            " and pa01=cp01(+) and pa02=cp02(+) and pa03=cp03(+) and pa04=cp04(+) AND CP09<'B' AND CP31='Y' and cp05>=" & strDate_S & " and cp05<=" & strDate_E & " and CP159=0" & _
            " Union SELECT CP09,CP01,CP02,CP03,CP04,CP10,CP05,TM23 cuid from customer,trademark,caseprogress" & _
            " Where cu14>=" & strDate_S & " And cu14<=" & strDate_E & " And CU01 = SUBSTR(tm23, 1, 8) And cu02 = SUBSTR(tm23, 9)" & _
            " and tm01=cp01(+) and tm02=cp02(+) and tm03=cp03(+) and tm04=cp04(+) AND CP09<'B' AND CP31='Y' and cp05>=" & strDate_S & " and cp05<=" & strDate_E & " and CP159=0" & _
            " Union SELECT CP09,CP01,CP02,CP03,CP04,CP10,CP05,SP08 cuid from customer,servicepractice,caseprogress" & _
            " Where cu14>=" & strDate_S & " And cu14<=" & strDate_E & " And CU01 = SUBSTR(sp08, 1, 8) And cu02 = SUBSTR(sp08, 9)" & _
            " and sp01=cp01(+) and sp02=cp02(+) and sp03=cp03(+) and sp04=cp04(+) AND CP09<'B' and cp31='Y' and cp05>=" & strDate_S & " and cp05<=" & strDate_E & " and CP159=0" & _
            " Union SELECT CP09,CP01,CP02,CP03,CP04,CP10,CP05,LC11 cuid from customer,lawcase,caseprogress" & _
            " Where cu14>=" & strDate_S & " And cu14<=" & strDate_E & " And CU01 = SUBSTR(lc11, 1, 8) And cu02 = SUBSTR(lc11, 9)" & _
            " and lc01=cp01(+) and lc02=cp02(+) and lc03=cp03(+) and lc04=cp04(+) AND CP09<'B' and cp31='Y' and cp05>=" & strDate_S & " and cp05<=" & strDate_E & " and CP159=0" & _
            " Union SELECT CP09,CP01,CP02,CP03,CP04,CP10,CP05,HC05 cuid from customer,hirecase,caseprogress,staff,nation" & _
            " Where cu14>=" & strDate_S & " And cu14<=" & strDate_E & " And CU01 = SUBSTR(hc05, 1, 8) And cu02 = SUBSTR(hc05, 9)" & _
            " and hc01=cp01(+) and hc02=cp02(+) and hc03=cp03(+) and hc04=cp04(+) AND CP09<'B' and cp31='Y' and cp05>=" & strDate_S & " and cp05<=" & strDate_E & " and CP159=0" & _
            "),fagent WHERE SUBSTR(cuid,1,8)=CU01(+) AND '0'=CU02(+) AND cu13=st01(+) and substr(cu10,1,3)=na01(+) and substr(cu03,1,8)=fa01(+) and fa02(+)='0'" & _
            " group by NA01||SUBSTR(na03,1,6),cu01,decode(cu04,null,decode(cu05,null,cu06,cu05||' '||cu88||' '||cu89||' '||cu90),cu04),st02,fa76,CU03,CU12,CU10" & _
            " order by NA01||SUBSTR(na03,1,6),cu01"
   If Rs.State <> adStateClosed Then Rs.Close
   Set Rs = New ADODB.Recordset
   Rs.CursorLocation = adUseClient
   Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   With Rs
      If .RecordCount > 0 Then
         .MoveFirst
         Do While Not .EOF
            If TempFileName1 = "" Then
               TempFileName1 = "上週五至本週四新客戶名單(開發日期在此區間)"
               ff = FreeFile
               If ff > 0 Then Close #ff
               ff = FreeFile
               Open App.path & TextPath & TempFileName1 & ".txt" For Output As ff
               'Added by Lydia 2016/10/19 加報表抬頭
               Print #ff, Space(10) & TempFileName1
               Print #ff, ""
               'end 2016/10/19
               Print #ff, "國籍         編號       申請人名稱                新案號件數 智權人員   性質"
               Print #ff, "============ ========== ========================= ========== ========== ================"
            End If
            strTemp(0) = convForm(CheckStr("" & .Fields(0)), 12)
            strTemp(1) = convForm(CheckStr("" & .Fields(1)), 10)
            strTemp(2) = convForm(CheckStr("" & .Fields(2)), 25)
            strTemp(3) = convForm(CheckStr("" & .Fields(3)), 10)
            strTemp(4) = convForm(CheckStr("" & .Fields(4)), 10)
            'Add By Sindy 2015/5/18
'            CU12為 Fxx 者, 無CU03者為'代理人委辦'
'                           有CU03者則抓FA76判斷
'                為 Sxx 者, 性質欄空白
'                其他, CU10>="010"者, 同 Fxx 判斷
'                      CU10< "010"者, 性質欄空白
            If Left(Trim("" & .Fields("cu12")), 1) = "F" Or _
               (Left(Trim("" & .Fields("cu12")), 1) <> "S" And Left(Trim("" & .Fields("cu10")), 3) >= "010") Then
               If "" & .Fields("cu03") = "" Then
                  strTemp(5) = convForm("代理人委辦", 16)
               Else
                  strTemp(5) = convForm(CheckStr("" & .Fields(5)), 16)
               End If
            Else
               strTemp(5) = convForm("", 16)
            End If
            '2015/5/18 END
            Print #ff, strTemp(0) & " " & strTemp(1) & " " & strTemp(2) & " " & strTemp(3) & " " & strTemp(4) & " " & strTemp(5)
            
            'Added by Lydia 2020/03/04 若有外專F2x／外商資料F1x，則增加通知王協理(外專)和江協理(外商)
            If Left(Trim("" & .Fields("cu12")), 2) = "F2" And strToFCP = "" Then
               'Added by Lydia 2022/11/24 專利日本部王協理2022/12/01即將退休，改為同時發系統特殊設定R、S、T、T1的人員。
               If strSrvDate(1) >= "20221130" Then
                  strExc(1) = "select Oman from setSpecMan where ocode in ('R','S','T','T1') order by ocode"
                  intI = 1
                  Set RsTemp = ClsLawReadRstMsg(intI, strExc(1))
                  If intI = 1 Then
                      strToFCP = ";" & RsTemp.GetString(adClipString, , , ";")
                      strToFCP = Mid(strToFCP, 1, Len(strToFCP) - 1)
                  End If
               Else
               'end 2022/11/24
                  strToFCP = ";88003" '王協理(王文安)
               End If 'Added by Lydia 2022/11/24
            End If
            If Left(Trim("" & .Fields("cu12")), 2) = "F1" And strToFCT = "" Then
               strToFCT = ";98020" '江協理(江郁仁)
            End If
            'end 2020/03/04
            .MoveNext
         Loop
         Print #ff, "共 " & .RecordCount & " 筆"
      End If
      If TempFileName1 <> "" Then Close ff
   End With
   Rs.Close
   
   '上週五至本週四舊客戶回辦新申請案件數(開發日期不在此區間)
   '剔除無申請人案件,客戶編號前八碼相同者合併計算
   '先不抓智權人員,因為可能不同人收文
   'Modify By Sindy 2015/5/18 +性質
   'Modified by Lydia 2016/09/14 NVL(cp57,0)=0 => CP159=0
   strSql = "select NA01||SUBSTR(na03,1,6) 國籍,cu01 編號,SUBSTR(decode(cu04,null,decode(cu05,null,cu06,cu05||' '||cu88||' '||cu89||' '||cu90),cu04),1,14) 申請人名稱,count(*) 新案號件數,substr(sqldatet(cu14),1,10) 客戶開發日期,decode(fa76,'A','代理人委辦','B','客戶直接委辦') 性質,CU03,CU12,CU10" & _
            " FROM customer,staff,nation,(" & _
            "SELECT CP09,CP01,CP02,CP03,CP04,CP10,CP05,CP13,PA26 cuid from patent,caseprogress" & _
            " where cp01 in('P','CFP','FCP') and cp05>=" & strDate_S & " and cp05<=" & strDate_E & " AND CP09<'B' AND CP31='Y' and CP159=0" & _
            " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04" & _
            " Union SELECT CP09,CP01,CP02,CP03,CP04,CP10,CP05,CP13,TM23 cuid from trademark,caseprogress" & _
            " where cp01 in('T','CFT','FCT','TF') and cp05>=" & strDate_S & " and cp05<=" & strDate_E & " AND CP09<'B' AND CP31='Y' and CP159=0" & _
            " and tm01(+)=cp01 and tm02(+)=cp02 and tm03(+)=cp03 and tm04(+)=cp04" & _
            " Union SELECT CP09,CP01,CP02,CP03,CP04,CP10,CP05,CP13,SP08 cuid from servicepractice,caseprogress" & _
            " where cp01 not in('LA','CFL','FCL','L','LIN','ACS','T','CFT','FCT','TF','P','CFP','FCP') and cp05>=" & strDate_S & " and cp05<=" & strDate_E & " AND CP09<'B' AND CP31='Y' and CP159=0" & _
            " and sp01(+)=cp01 and sp02(+)=cp02 and sp03(+)=cp03 and sp04(+)=cp04" & _
            " Union SELECT CP09,CP01,CP02,CP03,CP04,CP10,CP05,CP13,LC11 cuid from lawcase,caseprogress" & _
            " where cp01 in('CFL','FCL','L','LIN','ACS') and cp05>=" & strDate_S & " and cp05<=" & strDate_E & " AND CP09<'B' AND CP31='Y' and CP159=0" & _
            " and lc01(+)=cp01 and lc02(+)=cp02 and lc03(+)=cp03 and lc04(+)=cp04" & _
            " Union SELECT CP09,CP01,CP02,CP03,CP04,CP10,CP05,CP13,HC05 cuid from hirecase,caseprogress" & _
            " where cp01='LA' and cp05>=" & strDate_S & " and cp05<=" & strDate_E & " AND CP09<'B' AND CP31='Y' and CP159=0" & _
            " and hc01(+)=cp01 and hc02(+)=cp02 and hc03(+)=cp03 and hc04(+)=cp04" & _
            "),fagent WHERE cuid is not null and SUBSTR(cuid,1,8)=CU01(+) and cu02='0' and nvl(cu14,0)<" & strDate_S & " and substr(cu10,1,3)=na01(+) AND CP13=st01(+) and substr(cu03,1,8)=fa01(+) and fa02(+)='0'" & _
            " group by NA01||SUBSTR(na03,1,6),cu01,decode(cu04,null,decode(cu05,null,cu06,cu05||' '||cu88||' '||cu89||' '||cu90),cu04),cu14,fa76,CU03,CU12,CU10" & _
            " order by NA01||SUBSTR(na03,1,6),cu01"
   If Rs.State <> adStateClosed Then Rs.Close
   Set Rs = New ADODB.Recordset
   Rs.CursorLocation = adUseClient
   Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   With Rs
      If .RecordCount > 0 Then
         .MoveFirst
         Do While Not .EOF
            If TempFileName2 = "" Then
               TempFileName2 = "上週五至本週四舊客戶回辦新申請案件數(開發日期不在此區間)"
               ff = FreeFile
               If ff > 0 Then Close #ff
               ff = FreeFile
               Open App.path & TextPath & TempFileName2 & ".txt" For Output As ff
               'Added by Lydia 2016/10/19 加報表抬頭
               Print #ff, Space(10) & TempFileName2
               Print #ff, ""
               'end 2016/10/19
               Print #ff, "國籍         編號       申請人名稱                新案號件數 客戶開發日期 性質"
               Print #ff, "============ ========== ========================= ========== ============ ================"
            End If
            strTemp(0) = convForm(CheckStr("" & .Fields(0)), 12)
            strTemp(1) = convForm(CheckStr("" & .Fields(1)), 10)
            strTemp(2) = convForm(CheckStr("" & .Fields(2)), 25)
            strTemp(3) = convForm(CheckStr("" & .Fields(3)), 10)
            strTemp(4) = convForm(CheckStr("" & .Fields(4)), 12)
            'Add By Sindy 2015/5/18
'            CU12為 Fxx 者, 無CU03者為'代理人委辦'
'                           有CU03者則抓FA76判斷
'                為 Sxx 者, 性質欄空白
'                其他, CU10>="010"者, 同 Fxx 判斷
'                      CU10< "010"者, 性質欄空白
            If Left(Trim("" & .Fields("cu12")), 1) = "F" Or _
               (Left(Trim("" & .Fields("cu12")), 1) <> "S" And Left(Trim("" & .Fields("cu10")), 3) >= "010") Then
               If "" & .Fields("cu03") = "" Then
                  strTemp(5) = convForm("代理人委辦", 16)
               Else
                  strTemp(5) = convForm(CheckStr("" & .Fields(5)), 16)
               End If
            Else
               strTemp(5) = convForm("", 16)
            End If
            '2015/5/18 END
            Print #ff, strTemp(0) & " " & strTemp(1) & " " & strTemp(2) & " " & strTemp(3) & " " & strTemp(4) & " " & strTemp(5)
            
            'Added by Lydia 2020/03/04 若有外專F2x／外商資料F1x，則增加通知王協理(外專)和江協理(外商)
            If Left(Trim("" & .Fields("cu12")), 2) = "F2" And strToFCP = "" Then
               'Added by Lydia 2022/11/24 專利日本部王協理2022/12/01即將退休，改為同時發系統特殊設定R、S、T、T1的人員。
               If strSrvDate(1) >= "20221130" Then
                  strExc(1) = "select Oman from setSpecMan where ocode in ('R','S','T','T1') order by ocode"
                  intI = 1
                  Set RsTemp = ClsLawReadRstMsg(intI, strExc(1))
                  If intI = 1 Then
                      strToFCP = ";" & RsTemp.GetString(adClipString, , , ";")
                      strToFCP = Mid(strToFCP, 1, Len(strToFCP) - 1)
                  End If
               Else
               'end 2022/11/24
                  strToFCP = ";88003" '王協理(王文安)
               End If 'Added by Lydia 2022/11/24
            End If
            If Left(Trim("" & .Fields("cu12")), 2) = "F1" And strToFCT = "" Then
               strToFCT = ";98020" '江協理(江郁仁)
            End If
            'end 2020/03/04
            .MoveNext
         Loop
         Print #ff, "共 " & .RecordCount & " 筆"
      End If
      If TempFileName2 <> "" Then Close ff
   End With
   Rs.Close
   
   If TempFileName1 <> "" Or TempFileName2 <> "" Then
      '67001.蘇主秘
      'modify by sonia 2019/9/3 改林總94007及杜副總68006
      'modify by sonia 2020/3/4 68006退休改69005,99033
      'Modified by Lydia 2020/03/04  若有外專F2x／外商資料F1x，則增加通知王協理(外專)和江協理(外商) => & strToFCP & strToFCT
      'Modified by Lydia 2022/05/03 簡協理69005改為抓系統特殊設定「全所智權部主管」
      'SendMAPIMail "94007;69005;99033" & strToFCP & strToFCT, strDate_S & "~" & strDate_E & "新舊客戶案件統計資料", "Dear Sirs," & vbCrLf & "　　" & strDate_S & "~" & strDate_E & "新舊客戶案件統計資料" & " 如附件！" & vbCrLf & vbCrLf & "電腦中心", Mid(IIf(TempFileName1 <> "", "," & App.path & TextPath & TempFileName1 & ".txt", "") & IIf(TempFileName2 <> "", ";" & App.path & TextPath & TempFileName2 & ".txt", ""), 2)
      SendMAPIMail "94007;" & Pub_GetSpecMan("全所智權部主管") & ";99033" & strToFCP & strToFCT, strDate_S & "~" & strDate_E & "新舊客戶案件統計資料", "Dear Sirs," & vbCrLf & "　　" & strDate_S & "~" & strDate_E & "新舊客戶案件統計資料" & " 如附件！" & vbCrLf & vbCrLf & "電腦中心", Mid(IIf(TempFileName1 <> "", "," & App.path & TextPath & TempFileName1 & ".txt", "") & IIf(TempFileName2 <> "", ";" & App.path & TextPath & TempFileName2 & ".txt", ""), 2)
   End If
   
   Exit Sub
   
ErrHandle:
   If Err.Number <> 0 Then
      WLog "新舊客戶案件統計資料:" & Err.Description
   End If
   Set Rs = Nothing
End Sub

'Added by Moran 2017/8/14
'刪除電子公文原始檔(合併前的pdf): 保留1個月(可考慮縮短或公文輸入後直接刪除)
Private Sub StrMenu88()
   Dim stSQL As String, intR As Integer, stErr As String
   Dim rsQuery As ADODB.Recordset
   
On Error GoTo ErrHnd

   intR = 1
   stSQL = "select distinct cpp01,cpp02 from edocument,caseprogress,casepaperpdf" & _
      " where ed13>" & CompDate(1, -2, strSrvDate(1)) & " and ed13<" & CompDate(1, -1, strSrvDate(1)) & " and ed20 is null and cp09(+)=ed11 and cpp01(+)=cp09 and cpp02 like '$'||ed01||'.%' and cpp10='D'"
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      With rsQuery
      Debug.Print .RecordCount
      Do While Not .EOF
         intR = 0
         stErr = "(" & .Fields(0) & "," & .Fields(1) & ")"
         If PUB_DelFtpFile2(.Fields("cpp01"), " AND CPP02='" & .Fields("cpp02") & "' and cpp10='D'") = True Then
            cnnConnection.Execute "delete casepaperpdf where cpp01='" & .Fields("cpp01") & "' and cpp02='" & .Fields("cpp02") & "' and cpp10='D'", intR
            Debug.Print Now & " -> " & .AbsolutePosition & "," & .Fields(0) & "," & .Fields(1)
            DoEvents
         Else
            Err.Raise 9999
         End If
         .MoveNext
      Loop
      End With
   End If
   
ErrHnd:
   If Err.Number <> 0 Then
      WLog Now & "-->卷宗區電子公文原始檔刪除失敗！" & stErr
   End If
   Set rsQuery = Nothing
End Sub

'Added by Morgan 2015/4/22 更正FTP檔案路徑
'Modified by Morgan 2015/4/30 +casepaperfile, empelectronfile
'Modified by Morgan 2015/6/23 刪除註記的先做否則檔名會重複
Private Sub StrMenu59()
 
   Dim stSQL As String, intR As Integer
   Dim rsQuery As ADODB.Recordset
   Dim stTable As String
   Dim ii As Integer
   Dim stTableDir As String
   Dim stFtpIP As String 'Added by Morgan 2025/3/27
   
On Error GoTo ErrHnd
   
   stTable = "CASEPAPERPDF"
   'Added by Morgan 2018/4/17 刪除註記超過1個月的做真刪除
   'Modified by Morgan 2022/5/17 改用cpp06判斷(已刪除的檔案不必更正路徑)
   intR = 1
   stSQL = "select cpp14,cpp01,cpp02,cpp19 from casepaperpdf where cpp10='D' and decode(cpp06,0,0,sysdate-to_date(cpp06,'yyyymmdd'))>30"
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      'stTableDir = PUB_GetFtpTableDir(stTable) 'Removed by Morgan 2025/3/27
      With rsQuery
      Do While Not .EOF
         'Modified by Morgan 2025/3/27
         'If PUB_FtpDelFile2(stTableDir & "/" & .Fields("cpp14")) Then
         stTableDir = PUB_GetFtpTableDir(stTable, stFtpIP, "" & .Fields("cpp19") <> "")
         If PUB_FtpDelFile2(stTableDir & "/" & .Fields("cpp14"), , , stFtpIP) Then
         'end 2025/3/27
            stSQL = "delete from casepaperpdf where cpp01='" & .Fields("cpp01") & "' and cpp02='" & ChgSQL(.Fields("cpp02")) & "'"
            cnnConnection.Execute stSQL, intR
         End If
         .MoveNext
      Loop
      End With
   End If
   'end 2018/4/17
   
   'Added by Morgan 2025/3/27 封存區的檔案要先移出來(封存區檔案沒有每天備份故只能刪除不能增修以確保備份區的完整)
   stSQL = "select cpp01,cpp02,cpp10,cpp14 from casepaperpdf where cpp13=0 and cpp19='Y' and cpp10<>'D'"
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      With rsQuery
      Do While Not .EOF
         stTableDir = PUB_GetFtpTableDir(stTable, stFtpIP, True)
         If PUB_MoveFromArchive(.Fields("cpp14"), stTable) Then
            stSQL = "update casepaperpdf set cpp19=null where cpp01='" & .Fields("cpp01") & "' and cpp02='" & ChgSQL(.Fields("cpp02")) & "'"
            cnnConnection.Execute stSQL, intR
            If intR > 0 Then
               PUB_FtpDelFile2 stTableDir & "/" & .Fields("cpp14"), , , stFtpIP
            End If
         End If
         .MoveNext
      Loop
      End With
   End If
   'end 2025/3/27
      
   'Modified by Morgan 2021/10/4 改只需跑1次(主要是更正資料夾,檔名不再要求一樣)
   'For ii = 1 To 2 'Added by Morgan 2015/8/25 若有檔名重複時,第1次先更名,第2才正名
      'Modified by Morgan 2021/8/10 排除已刪除檔案，因常有問題且時間到也要刪除
      'Modified by Morgan 2021/9/13 已刪除檔案改在迴圈內判斷並直接上cpp13否則後續不會真刪除
      'Modified by Morgan 2022/5/17 真刪除改判斷cpp06,已刪除可排除
      'Modified by Morgan 2025/3/27 + and cpp19 is null (排除封存區的檔案,正常會在上面程式先移回來)
      stSQL = "select cpp01,cpp02,cpp10,cpp14 from casepaperpdf where cpp13=0 and cpp14 is not null and cpp19 is null and cpp10<>'D'"
      intR = 1
      Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         With rsQuery
         Do While Not .EOF
            PUB_UpdateFtpPath .Fields("cpp01"), " and cpp02='" & ChgSQL(.Fields("cpp02")) & "'", stTable, True
            .MoveNext
         Loop
         End With
      End If
   'Next
   
   stTable = "CASEPAPERFILE"
   'Added by Morgan 2022/5/18 刪除註記超過1個月的做真刪除
   intR = 1
   stSQL = "select CPF13,cpf01,cpf02 from casepaperfile where cpf10='D' and decode(CPF06,0,0,sysdate-to_date(CPF06,'yyyymmdd'))>30"
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      stTableDir = PUB_GetFtpTableDir(stTable)
      With rsQuery
      Do While Not .EOF
         If PUB_FtpDelFile2(stTableDir & "/" & .Fields("CPF13")) Then
            stSQL = "delete from casepaperfile where cpf01='" & .Fields("cpf01") & "' and cpf02='" & ChgSQL(.Fields("cpf02")) & "'"
            cnnConnection.Execute stSQL, intR
         End If
         .MoveNext
      Loop
      End With
   End If
   'end 2022/5/18
   
   intR = 1
   'Modified by Morgan 2021/8/10 排除已刪除檔案
   stSQL = "select cpf01,cpf02 from casepaperfile where cpf12=0 and cpf13 is not null and cpf10<>'D'"
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      With rsQuery
      Do While Not .EOF
         PUB_UpdateFtpPath .Fields("cpf01"), " and cpf02='" & ChgSQL(.Fields("cpf02")) & "'", stTable, True
         .MoveNext
      Loop
      End With
   End If
   
   stTable = "EMPELECTRONFILE"
   intR = 1
   stSQL = "select eef01,eef02,eef03 from empelectronfile where eef11=0 and eef12 is not null"
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      With rsQuery
      Do While Not .EOF
         PUB_UpdateFtpPath .Fields("eef01"), " and eef02=" & .Fields("eef02") & " and eef03='" & ChgSQL(.Fields("eef03")) & "'", stTable, True
         .MoveNext
      Loop
      End With
   End If
   
   'Add By Sindy 2019/11/25
   stTable = "CONTACTFILE"
   intR = 1
   stSQL = "select CF01,CF02 from CONTACTFILE where CF08=0 and CF06 is not null"
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      With rsQuery
      Do While Not .EOF
         PUB_UpdateFtpPath .Fields("CF01"), " and CF02='" & ChgSQL(.Fields("CF02")) & "'", stTable, True
         .MoveNext
      Loop
      End With
   End If
   '2019/11/25 END
   
   'Added by Lydia 2016/06/23 已收文的查名單從卷宗區搬到查名單區
'Removed by Morgn 2025/2/27 已完成不會再使用
'   If strSrvDate(1) = TMQFileFTP Then
'        stTable = "TMQFILE"
'        intR = 1
'        stSQL = "select cpp01,cpp02,cpp14 from CASEPAPERPDF where instr(cpp02,'TS.PDF') > 0 and substr(cpp14,1,1) <> 'H' order by cpp01,cpp02 "
'        Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
'        If intR = 1 Then
'           With rsQuery
'           Do While Not .EOF
'               PUB_UpdateFtpPath .Fields("cpp01"), .Fields("cpp02"), stTable, False, .Fields("cpp14")
'              .MoveNext
'           Loop
'           End With
'        End If
'        '未收文的查名單和查名內容的附件
'        stTable = "TMQFILE00"
'        intR = 1
'        stSQL = "select tqf01||tqf02||tqf03||tqf04 pKey,tqf05 from TMQFILE where tqf12 is null order by tqf01,tqf02 "
'        Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
'        If intR = 1 Then
'           With rsQuery
'           Do While Not .EOF
'              PUB_UpdateFtpPath .Fields("pKey"), "", stTable, False
'              .MoveNext
'           Loop
'           End With
'        End If
'   End If
'end 2025/3/27

   '刪除未送件的附件
   If strSrvDate(1) >= TMQFileFTP Then
        stTable = "TMQFILE00"
        intR = 1
        stSQL = "select tqf01,tqf02,tqf03,tqf04,tqf05 from TMQFILE where TQF02='0' and TQF04='00' and TQF13 is null "
        Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
        If intR = 1 Then
           With rsQuery
           Do While Not .EOF
              If PUB_TMQAFileDel(.Fields("tqf01"), .Fields("tqf02"), .Fields("tqf03"), .Fields("tqf04")) Then
              End If
              .MoveNext
           Loop
           End With
        End If
   End If
   'end 2016/06/23
   
   
ErrHnd:
   If Err.Number <> 0 Then
      WLog Now & "-->" & stTable & ",#" & Err.Number & "," & Err.Description
   End If
   Set rsQuery = Nothing
End Sub

'Add by Lydia 2015/04/28
'寰華案信函管理異常通知
Private Sub StrMenu60()
   Dim rsA As New ADODB.Recordset
   Dim stSQL As String, stDate As String
   Dim ff6 As Integer
   Dim TempFileName As String, strTemp(6) As String, strTFName As String
   Dim strTo As String, strApatch As String, strCC As String
On Error GoTo ErrHandle

   
   '抓系統前推3個工作天
   stDate = TransDate(PUB_GetWorkDayAfterSysDate(Val(strSrvDate(1)), -3), 2)
   
   strTFName = "寰華案信函管理異常通知"
   'Modified by Lydia 2017/02/13 +FMP管制人
   If strSrvDate(1) < FMP管制人啟用日 Then
    stSQL = "select nvl(n1.na16,n2.na16) NA16,SUBSTR(' '||sqldatet(FM01),-9) AS FM01,FM03||'-'||FM04||'-'||FM05||'-'||FM06 as ANO," & _
            "substr(n3.na03,1,4) PA09N,substr(PA05,1,26) pname,substr(CU04,1,10) cname,PA11,nvl(s1.st02,s2.st02) NA16N " & _
            "from FagentMail ,CaseProgress,Patent ,Fagent,Customer, nation n1,nation n2,nation n3,staff s1,staff s2,staff s3 " & _
            "where FM01<='" & stDate & "' AND FM13 is null AND FM03='P' and FM01=CP119(+) and FM03=CP01(+) and FM04=CP02(+) and FM05=CP03(+) and FM06=CP04(+) " & _
            "and CP09 is null and FM03=PA01(+) and FM04=PA02(+) and FM05=PA03(+) and FM06=PA04(+) " & _
            "AND FA01(+)=SUBSTR(PA75,1,8) AND FA02(+)=SUBSTR(PA75,9) AND n1.NA01(+)=FA10 and n1.na16=s1.st01(+) and s1.st04='1' " & _
            "and CU01(+)=SUBSTR(PA26,1,8) AND CU02(+)=SUBSTR(PA26,9,1) AND n2.NA01(+)=CU10 and n2.na16=s2.st01(+) and s2.st04='1' " & _
            "and pa09=n3.na01(+) and FM07=s3.ST01(+) AND substr(s3.ST03,1,1)='F' " & _
            "order by 1,2,3 "
   Else
    stSQL = "select nvl(nvl(n1.na79,n1.na16),nvl(n1.na79,n2.na16)) NA16,SUBSTR(' '||sqldatet(FM01),-9) AS FM01,FM03||'-'||FM04||'-'||FM05||'-'||FM06 as ANO," & _
            "substr(n3.na03,1,4) PA09N,substr(PA05,1,26) pname,substr(CU04,1,10) cname,PA11,nvl(s1.st02,s2.st02) NA16N " & _
            "from FagentMail ,CaseProgress,Patent ,Fagent,Customer, nation n1,nation n2,nation n3,staff s1,staff s2,staff s3 " & _
            "where FM01<='" & stDate & "' AND FM13 is null AND FM03='P' and FM01=CP119(+) and FM03=CP01(+) and FM04=CP02(+) and FM05=CP03(+) and FM06=CP04(+) " & _
            "and CP09 is null and FM03=PA01(+) and FM04=PA02(+) and FM05=PA03(+) and FM06=PA04(+) " & _
            "AND FA01(+)=SUBSTR(PA75,1,8) AND FA02(+)=SUBSTR(PA75,9) AND n1.NA01(+)=FA10 and nvl(n1.na79,n1.na16)=s1.st01(+) and s1.st04='1' " & _
            "and CU01(+)=SUBSTR(PA26,1,8) AND CU02(+)=SUBSTR(PA26,9,1) AND n2.NA01(+)=CU10 and nvl(n2.na79,n2.na16)=s2.st01(+) and s2.st04='1' " & _
            "and pa09=n3.na01(+) and FM07=s3.ST01(+) AND substr(s3.ST03,1,1)='F' " & _
            "order by 1,2,3 "
   End If
   'end 2017/02/13
   
   If rsA.State <> adStateClosed Then rsA.Close

    Set rsA = New ADODB.Recordset
    rsA.CursorLocation = adUseClient
    rsA.Open stSQL, cnnConnection, adOpenStatic, adLockReadOnly
    With rsA
        If .RecordCount > 0 Then
            'modify by sonia 2016/7/5 改葉敏莉86024,原Pub_GetSpecMan("M")=73023張靜芳
            'strCC = Pub_GetSpecMan("M")
            strCC = Pub_GetSpecMan("寰華案外專程序窗口")
            .MoveFirst
            Do While Not .EOF
            
            If TempFileName = "" Or strTo <> "" & .Fields(0) Then
               If strTo <> "" And TempFileName <> "" Then
                  Close ff6
                  SendMAPIMail strTo, TempFileName, vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, App.path & TextPath & TempFileName & ".txt", , , strCC
               End If
               TempFileName = strTFName
               If ff6 > 0 Then Close #ff6
               ff6 = FreeFile
               Open App.path & TextPath & TempFileName & ".txt" For Output As ff6
               'Added by Lydia 2016/10/19 加報表抬頭
               Print #ff6, Space(35) & TempFileName
               Print #ff6, ""
               'end 2016/10/19
               Print #ff6, "列印日期：" & ChangeWStringToTString(stDate)
               Print #ff6, vbCrLf
               Print #ff6, "收信日期   本所案號        申請國家 案件名稱                       申請人               申請案號"
               Print #ff6, "========== =============== ======== ============================== ==================== ===================="
            End If
             
             strTo = "" & .Fields("NA16")
             strTemp(0) = convForm("" & .Fields("FM01"), 10)
             strTemp(1) = convForm("" & .Fields("ANO"), 15)
             strTemp(2) = convForm("" & .Fields("PA09N"), 8)
             strTemp(3) = convForm(PUB_StrToStr(Trim("" & .Fields("PNAME")), 30), 30)
             strTemp(4) = convForm(PUB_StrToStr(Trim("" & .Fields("CNAME")), 20), 20)
             strTemp(5) = convForm("" & .Fields("PA11"), 20)
             strTemp(6) = "" & .Fields("NA16N")
             Print #ff6, strTemp(0) & " " & strTemp(1) & " " & strTemp(2) & " " & strTemp(3) & " " & strTemp(4) & " " & strTemp(5)
             .MoveNext
            Loop
        End If
        If TempFileName <> "" And strTo <> "" Then
            Close ff6
          '  strTo = "" & .Fields("NA16") '最後一筆記錄的收信人
            'strApatch = App.path & TextPath & TempFileName & ".txt"
            SendMAPIMail strTo, TempFileName, vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, App.path & TextPath & TempFileName & ".txt", , , strCC
        End If
    End With
    
    TempFileName = ""
    Set rsA = Nothing
ErrHandle:
   If Err.Number <> 0 Then
      WLog "寰華案信函管理異常通知:" & Err.Description
   End If
   Set rsA = Nothing
End Sub

'Add By Sindy 2015/5/11 外商程序組之系統自動提醒期限
Private Sub StrMenu61()
   Dim strSql As String
   Dim ff As Integer
   Dim TempFileName As String, strTemp(10) As String
   Dim strEmp As String
   Dim intRow As Integer 'Add By Sindy 2017/10/31
   
On Error GoTo ErrHandle
   'Modified by Lydia 2016/09/14
'   strSql = "SELECT sqldatet(cp06),sqldatet(cp07),sqldatet(cp48),cp14,s1.st02,cp13,s2.st02,cp01,cp02,cp03,cp04,decode(tm10,'000',cpm03,cpm04),CP64,NVL(TM05,NVL(TM06,TM07)),tm10" & _
'            " From CASEPROGRESS,TradeMark,staff s1,staff s2,casepropertymap" & _
'            " WHERE CP01||CP27||CP57='FCT' AND CP48>=" & strSrvDate(1) & " AND CP48<=" & strSrvDate(1) & _
'            " AND TM01(+)=CP01 AND TM02(+)=CP02 AND TM03(+)=CP03 AND TM04(+)=CP04 AND TM29 IS NULL" & _
'            " and cp14=s1.st01(+) and s1.st03='F12'" & _
'            " and cp13=s2.st01(+) and cp01=cpm01(+) and cp10=cpm02(+)"
'   strSql = strSql & " Union SELECT sqldatet(cp06),sqldatet(cp07),sqldatet(cp48),cp14,s1.st02,cp13,s2.st02,cp01,cp02,cp03,cp04,decode(sp09,'000',cpm03,cpm04),CP64,NVL(SP05,NVL(SP06,SP07)),sp09" & _
'            " From CASEPROGRESS,SERVICEPRACTICE,staff s1,staff s2,casepropertymap" & _
'            " WHERE CP01||CP27||CP57='S' AND CP48>=" & strSrvDate(1) & " AND CP48<=" & strSrvDate(1) & _
'            " AND SP01(+)=CP01 AND SP02(+)=CP02 AND SP03(+)=CP03 AND SP04(+)=CP04 AND SP15 IS NULL" & _
'            " AND SP09='000'" & _
'            " and cp14=s1.st01(+) and s1.st03='F12'" & _
'            " and cp13=s2.st01(+) and cp01=cpm01(+) and cp10=cpm02(+)"
'   strSql = strSql & " Union SELECT sqldatet(cp06),sqldatet(cp07),sqldatet(cp48),cp14,s1.st02,cp13,s2.st02,cp01,cp02,cp03,cp04,decode(tm10,'000',cpm03,cpm04),CP64,NVL(TM05,NVL(TM06,TM07)),tm10" & _
'            " From CASEPROGRESS,TradeMark,staff s1,staff s2,casepropertymap" & _
'            " WHERE CP01||CP27||CP57 in('FCT','CFT','T','TF') AND CP07>=" & strSrvDate(1) & " AND CP07<=" & strSrvDate(1) & _
'            " AND TM01(+)=CP01 AND TM02(+)=CP02 AND TM03(+)=CP03 AND TM04(+)=CP04 AND TM29 IS NULL" & _
'            " and cp14=s1.st01(+) and s1.st03='F12'" & _
'            " and cp13=s2.st01(+) and cp01=cpm01(+) and cp10=cpm02(+)"
'   strSql = strSql & " Union SELECT sqldatet(cp06),sqldatet(cp07),sqldatet(cp48),cp14,s1.st02,cp13,s2.st02,cp01,cp02,cp03,cp04,decode(sp09,'000',cpm03,cpm04),CP64,NVL(SP05,NVL(SP06,SP07)),sp09" & _
'            " From CASEPROGRESS,SERVICEPRACTICE,staff s1,staff s2,casepropertymap" & _
'            " WHERE CP01||CP27||CP57 in('S','CFC') AND CP07>=" & strSrvDate(1) & " AND CP07<=" & strSrvDate(1) & _
'            " AND SP01(+)=CP01 AND SP02(+)=CP02 AND SP03(+)=CP03 AND SP04(+)=CP04 AND SP15 IS NULL" & _
'            " and cp14=s1.st01(+) and s1.st03='F12'" & _
'            " and cp13=s2.st01(+) and cp01=cpm01(+) and cp10=cpm02(+)"
   strSql = "SELECT sqldatet(cp06),sqldatet(cp07),sqldatet(cp48),cp14,s1.st02,cp13,s2.st02,cp01,cp02,cp03,cp04,decode(tm10,'000',cpm03,cpm04),CP64,NVL(TM05,NVL(TM06,TM07)),tm10" & _
            " From CASEPROGRESS,TradeMark,staff s1,staff s2,casepropertymap" & _
            " WHERE CP01='FCT' AND CP48>=" & strSrvDate(1) & " AND CP48<=" & strSrvDate(1) & _
            " AND CP158=0 AND CP159=0 AND TM01(+)=CP01 AND TM02(+)=CP02 AND TM03(+)=CP03 AND TM04(+)=CP04 AND TM29 IS NULL" & _
            " and cp14=s1.st01(+) and s1.st03='F12'" & _
            " and cp13=s2.st01(+) and cp01=cpm01(+) and cp10=cpm02(+)"
   strSql = strSql & " Union SELECT sqldatet(cp06),sqldatet(cp07),sqldatet(cp48),cp14,s1.st02,cp13,s2.st02,cp01,cp02,cp03,cp04,decode(sp09,'000',cpm03,cpm04),CP64,NVL(SP05,NVL(SP06,SP07)),sp09" & _
            " From CASEPROGRESS,SERVICEPRACTICE,staff s1,staff s2,casepropertymap" & _
            " WHERE CP01='S' AND CP48>=" & strSrvDate(1) & " AND CP48<=" & strSrvDate(1) & _
            " AND CP158=0 AND CP159=0 AND SP01(+)=CP01 AND SP02(+)=CP02 AND SP03(+)=CP03 AND SP04(+)=CP04 AND SP15 IS NULL" & _
            " AND SP09='000'" & _
            " and cp14=s1.st01(+) and s1.st03='F12'" & _
            " and cp13=s2.st01(+) and cp01=cpm01(+) and cp10=cpm02(+)"
   strSql = strSql & " Union SELECT sqldatet(cp06),sqldatet(cp07),sqldatet(cp48),cp14,s1.st02,cp13,s2.st02,cp01,cp02,cp03,cp04,decode(tm10,'000',cpm03,cpm04),CP64,NVL(TM05,NVL(TM06,TM07)),tm10" & _
            " From CASEPROGRESS,TradeMark,staff s1,staff s2,casepropertymap" & _
            " WHERE CP01 in('FCT','CFT','T','TF') AND CP07>=" & strSrvDate(1) & " AND CP07<=" & strSrvDate(1) & _
            " AND CP158=0 AND CP159=0 AND TM01(+)=CP01 AND TM02(+)=CP02 AND TM03(+)=CP03 AND TM04(+)=CP04 AND TM29 IS NULL" & _
            " and cp14=s1.st01(+) and s1.st03='F12'" & _
            " and cp13=s2.st01(+) and cp01=cpm01(+) and cp10=cpm02(+)"
   strSql = strSql & " Union SELECT sqldatet(cp06),sqldatet(cp07),sqldatet(cp48),cp14,s1.st02,cp13,s2.st02,cp01,cp02,cp03,cp04,decode(sp09,'000',cpm03,cpm04),CP64,NVL(SP05,NVL(SP06,SP07)),sp09" & _
            " From CASEPROGRESS,SERVICEPRACTICE,staff s1,staff s2,casepropertymap" & _
            " WHERE CP01 in('S','CFC') AND CP07>=" & strSrvDate(1) & " AND CP07<=" & strSrvDate(1) & _
            " AND CP158=0 AND CP159=0 AND SP01(+)=CP01 AND SP02(+)=CP02 AND SP03(+)=CP03 AND SP04(+)=CP04 AND SP15 IS NULL" & _
            " and cp14=s1.st01(+) and s1.st03='F12'" & _
            " and cp13=s2.st01(+) and cp01=cpm01(+) and cp10=cpm02(+)"
   strSql = strSql & " order by cp14,cp01,cp02,cp03,cp04"
   If Rs.State <> adStateClosed Then Rs.Close
   Set Rs = New ADODB.Recordset
   Rs.CursorLocation = adUseClient
   Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   intRow = 0 'Add By Sindy 2017/10/31 記錄筆數
   With Rs
      If .RecordCount > 0 Then
         .MoveFirst
         Do While Not .EOF
            If TempFileName <> "" And strEmp <> .Fields("cp14") Then
               'Modify By Sindy 2017/10/31
               Print #ff, "共 " & intRow & " 筆"
               intRow = 0
               '2017/10/31 END
               Close ff
               SendMAPIMail strEmp, TempFileName, "Dear Sirs," & vbCrLf & "　　" & TempFileName & " 如附件！" & vbCrLf & vbCrLf & "電腦中心", App.path & TextPath & TempFileName & ".txt"
               TempFileName = ""
            End If
            If TempFileName = "" Then
               'Modified by Lydia 2022/03/29 員工名稱有Unicode => +PUB_UniToBIG5
               TempFileName = PUB_UniToBIG5("外商程序組-" & .Fields(4) & "之系統自動提醒期限", "F")
               ff = FreeFile
               If ff > 0 Then Close #ff
               ff = FreeFile
              Open App.path & TextPath & TempFileName & ".txt" For Output As ff
               'Added by Lydia 2016/10/19 加報表抬頭
               Print #ff, Space(40) & TempFileName
               Print #ff, ""
               'end 2016/10/19
               Print #ff, "本所期限  法定期限  承辦期限  承辦人     智權人員   事件　     本所案號　　    案件性質   備註　　　　         案件名稱"
               Print #ff, "========= ========= ========= ========== ========== ========== =============== ========== ==================== ===================="
            End If
            strTemp(0) = convForm(CheckStr("" & .Fields(0)), 9)
            strTemp(1) = convForm(CheckStr("" & .Fields(1)), 9)
            strTemp(2) = convForm(CheckStr("" & .Fields(2)), 9)
            strTemp(3) = convForm(CheckStr("" & .Fields(4)), 10)
            strTemp(4) = convForm(CheckStr("" & .Fields(6)), 10)
            If Val(DBDATE(strTemp(2))) = Val(strSrvDate(1)) And _
               (.Fields("cp01") = "FCT" Or (.Fields("cp01") = "S" And .Fields(14) = "000")) Then '承辦期限=系統日:今送件
              strTemp(5) = convForm(CheckStr("今送件"), 10) '事件
            Else
               strTemp(5) = convForm(CheckStr("當日法定"), 10) '事件
            End If
            strTemp(6) = convForm(CheckStr(.Fields("CP01") & "-" & .Fields("CP02") & "-" & .Fields("CP03") & "-" & .Fields("CP04")), 15)
            strTemp(7) = convForm(CheckStr("" & .Fields(11)), 10)
            strTemp(8) = convForm(CheckStr("" & .Fields("CP64")), 20)
            strTemp(9) = convForm(CheckStr("" & .Fields(13)), 20)
            strEmp = .Fields("cp14")
            Print #ff, strTemp(0) & " " & strTemp(1) & " " & strTemp(2) & " " & strTemp(3) & " " & strTemp(4) & " " & strTemp(5) & " " & strTemp(6) & " " & strTemp(7) & " " & strTemp(8) & " " & strTemp(9)
            intRow = intRow + 1 'Add By Sindy 2017/10/31 記錄筆數
            .MoveNext
         Loop
      End If
      If TempFileName <> "" Then
         'Modify By Sindy 2017/10/31
         Print #ff, "共 " & intRow & " 筆"
         intRow = 0
         '2017/10/31 END
         Close ff
      End If
   End With
   Rs.Close
   If TempFileName <> "" Then
      SendMAPIMail strEmp, TempFileName, "Dear Sirs," & vbCrLf & "　　" & TempFileName & " 如附件！" & vbCrLf & vbCrLf & "電腦中心", App.path & TextPath & TempFileName & ".txt"
   End If
   
   Exit Sub
   
ErrHandle:
   If Err.Number <> 0 Then
      WLog "外商程序組之系統自動提醒期限:" & Err.Description
   End If
   Set Rs = Nothing
End Sub

'Added by Lydia 2015/05/25
'商標查名單量統計和排序
Private Sub StrMenu62()
Dim rsA As New ADODB.Recordset
Dim strA1 As String, strA2 As String
Dim sDate1 As String
Dim intN As Integer, intNum(0 To 4) As Integer
Dim strQuser As String 'Added by Lydia 2017/01/20
Dim rsB As New ADODB.Recordset, strB1 As String 'Added by Lydia 2020/04/14
   
On Error GoTo ErrHandle


cnnConnection.BeginTrans

   '清空前次統計
    cnnConnection.Execute "delete from TMQSumR"
    cnnConnection.Execute "insert into tmqsumr(TMQSR01,TMQSR02,TMQSR03,TMQSR04,TMQSR05,TMQSR06,TMQSR07,TMQSR08,TMQSR09,TMQSR10,TMQSR11,TMQSR12,TMQSR13,TMQSR14,TMQSR15,TMQSR16,TMQSR18) " & _
                          "select TMQM01,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,decode(tmqm01,tmqm02,'1','2') from TMQMEMBER " & _
                          "UNION select TMQM02,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,'1' from TMQMEMBER where tmqm01<>tmqm02 "
'   1.  TMQSR07~TMQSR11 每日順序由系統隨機分配。直接用取得亂數1~99來排班
   strA1 = "select TMQSR01 from tmqsumr group by TMQSR01"
   If rsA.State <> adStateClosed Then rsA.Close
     Set rsA = New ADODB.Recordset
     rsA.CursorLocation = adUseClient
     rsA.Open strA1, cnnConnection, adOpenStatic, adLockReadOnly
     With rsA
       If rsA.RecordCount > 0 Then
         rsA.MoveFirst
         Do While Not rsA.EOF
            For intN = 0 To 4
                Randomize Timer
                intNum(intN) = (Fix(Rnd() * 99) + 1) Mod 100
            Next intN
            strA2 = "update TMQSumR set TMQSR07=" & intNum(0) & ",TMQSR08=" & intNum(1) & _
                    ",TMQSR09=" & intNum(2) & ",TMQSR10=" & intNum(3) & ",TMQSR11=" & intNum(4) & " where TMQSR01=" & CNULL(rsA.Fields(0))
            cnnConnection.Execute strA2
            rsA.MoveNext
         Loop
       End If
     End With
     
    'Added by Lydia 2018/05/09 控制人員離職前,先不拿單(ex. 69004要5/15離職,5/10開始不拿單)
    strA1 = "select * from addressa4list where aal01='TSdel' and aal02<=" & CNULL(strSrvDate(1))
    If rsA.State <> adStateClosed Then rsA.Close
      Set rsA = New ADODB.Recordset
      rsA.CursorLocation = adUseClient
      rsA.Open strA1, cnnConnection, adOpenStatic, adLockReadOnly
      With rsA
        If rsA.RecordCount > 0 Then
          rsA.MoveFirst
          Do While Not rsA.EOF
                strA2 = "update TMQSumR set TMQSR17='N' where TMQSR01=" & CNULL(rsA.Fields("AAL04"))
                cnnConnection.Execute strA2, intI
                If intI = 0 Then '如果查名人員檔已刪除,刪除控制記錄
                    strA2 = "delete from tmqmember where tmqm01=" & CNULL(rsA.Fields("AAL04"))
                    cnnConnection.Execute strA2, intI
                End If
                rsA.MoveNext
          Loop
        End If
      End With
    'end 2018/05/09
    
'   2.  統計各類別前2日工作量BY每人
   sDate1 = CompWorkDay(3, strSrvDate(1), 1) '前2個工作天(起)
   'Modified by Lydia 2017/01/20 排除未分發查名人
    'strA1 = "select tmq10,tmq01,nvl(tmq07,0) tmq07,nvl(tmq08,0) tmq08,nvl(tmq09,0) tmq09,tmq03,tmqc02 " & _
           "from trademarkquery,tmqmember,tmqclass " & _
           "where tmq05>=" & CNULL(sDate1, True) & " and tmq05<" & CNULL(strSrvDate(1), True) & " and tmq10=tmqm01(+) and tmq03=tmqc01(+)"
    strA1 = "select tmq10,tmq01,nvl(tmq07,0) tmq07,nvl(tmq08,0) tmq08,nvl(tmq09,0) tmq09,tmq03,tmqc02 " & _
           "from trademarkquery,tmqmember,tmqclass " & _
           "where nvl(tmq10,'N')<>'N' and tmq05>=" & CNULL(sDate1, True) & " and tmq05<" & CNULL(strSrvDate(1), True) & " and tmq10=tmqm01(+) and tmq03=tmqc01(+)"
   '2.1 文字A類(單張查名單筆數>6)
    strA2 = "select '02' OR1,x1.tmq10,count(tmq01) cnt from (" & strA1 & ") X1 where" & Replace(PUB_GetTMQClass("1-2"), "tmq", "x1.tmq") & " group by x1.tmq10"
   '2.2 文字B類(單張查名單筆數<=6)
    strA2 = strA2 & " union all select '03' OR1,x1.tmq10,count(tmq01) cnt from (" & strA1 & ") X1 where" & Replace(PUB_GetTMQClass("1-3"), "tmq", "x1.tmq") & " group by x1.tmq10"
   '2.3 圖形A類(tmqc02>=14,tmqc02<50)
    strA2 = strA2 & " union all select '04' OR1,x1.tmq10,count(tmq01) cnt from (" & strA1 & ") X1 where" & Replace(PUB_GetTMQClass("1-4"), "tmq", "x1.tmq") & " group by x1.tmq10"
   '2.4 圖形B類(tmqc02<14)
    strA2 = strA2 & " union all select '05' OR1,x1.tmq10,count(tmq01) cnt from (" & strA1 & ") X1 where" & Replace(PUB_GetTMQClass("1-5"), "tmq", "x1.tmq") & "group by x1.tmq10"
   '2.5 圖形C類(tmqc02>=50)
    strA2 = strA2 & " union all select '06' OR1,x1.tmq10,count(tmq01) cnt from (" & strA1 & ") X1 where" & Replace(PUB_GetTMQClass("1-6"), "tmq", "x1.tmq") & "group by x1.tmq10"
    strA2 = strA2 & " order by 1,2"
        If rsA.State <> adStateClosed Then rsA.Close
          Set rsA = New ADODB.Recordset
          rsA.CursorLocation = adUseClient
          rsA.Open strA2, cnnConnection, adOpenStatic, adLockReadOnly
            If rsA.RecordCount > 0 Then
              rsA.MoveFirst
              Do While Not rsA.EOF
                 strA2 = "update TMQSumR set TMQSR" & Trim(rsA.Fields("OR1")) & "=" & rsA.Fields("cnt") & " where TMQSR01=" & CNULL(rsA.Fields("tmq10"))
                 cnnConnection.Execute strA2
                 rsA.MoveNext
              Loop
            End If
    '統計人員合計
    strA1 = "select TMQM02,sum(TMQSR02) s2,sum(TMQSR03) s3,sum(TMQSR04) s4,sum(TMQSR05) s5,sum(TMQSR06) s6 from tmqsumr,tmqmember where tmqsr01=tmqm01(+) and tmqm01<>tmqm02 group by TMQM02"
    If rsA.State <> adStateClosed Then rsA.Close
      Set rsA = New ADODB.Recordset
      rsA.CursorLocation = adUseClient
      rsA.Open strA1, cnnConnection, adOpenStatic, adLockReadOnly
      With rsA
        If rsA.RecordCount > 0 Then
          rsA.MoveFirst
          Do While Not rsA.EOF
             strA2 = "update TMQSumR set TMQSR02=" & rsA.Fields("s2") & ",TMQSR03=" & rsA.Fields("s3") & ",TMQSR04=" & rsA.Fields("s4") & _
             ",TMQSR05=" & rsA.Fields("s5") & ",TMQSR06=" & rsA.Fields("s6") & " where TMQSR01=" & CNULL(rsA.Fields(0))
             cnnConnection.Execute strA2
             rsA.MoveNext
          Loop
        End If
      End With
     
   '3 將請整天假的查名人員狀態上不可分派查名單
   'Modified by Lydia 2015/07/23  查名人請假=請假前一天和請假當天的狀態為N
 '  strA1 = "select tmqsr01,tmqsr17,count(tmqm01) cnt from tmqsumr a, abs010 b,tmqmember c " & _
           "where tmqm01=b1003(+) and tmqsr01=tmqm01(+) and " & CNULL(strSrvDate(1), True) & ">=B1004 and " & CNULL(strSrvDate(1), True) & "<=B1006 and b1009>0 and B1018<>'06' " & _
           "group by tmqsr01,tmqsr17"
    sDate1 = CompWorkDay(2, strSrvDate(1), 0) '系統日+1天
    Dim bol1Days As Boolean 'Added by Lydia 2022/10/25 判斷是否整天請假
    'Modified by Lydia 2015/09/23 和請假公佈欄一致,Staff_Absence和Staff_Busi_Trip為主管簽核過後產生的記錄
                            '如果原本假單請長假,後來銷假上班Staff_Absence的日期會有所變動,所以ABS010要判斷這兩個table
'    strA1 = "select tmqsr01,tmqsr17,count(tmqm01) cnt from tmqsumr a, abs010 b,tmqmember c " & _
'           "where tmqm01=b1003(+) and tmqsr01=tmqm01(+) and ((" & strSrvDate(1) & ">=B1004 and " & strSrvDate(1) & "<=B1006) or (" & sDate1 & ">=B1004 and " & sDate1 & "<=B1006)) and b1009>0 and B1018<>'06' " & _
'           "group by tmqsr01,tmqsr17"
    'Memo by Lydia 2019/01/28 1-員工請假資料 Staff_Absence, 2-員工出差資料 Staff_Busi_Trip, 3-ABS010 出缺勤電子簽核主檔
    'Modified by Lydia 2019/01/28 查名單分發規則調整如下：
    '1.特休(請)假整日者，前一天不發查名單，
    '2.特休(請)假非整日者，如僅半日或不及半日（小時）之非整日特休（請）假，前一天仍正常發給查名單
    '3.特休(請)假整日者，特休(請)假當日不發查名單
    '4.特休(請)假非整日者，以查名單分發當時段是否上班為原則發給查名單，例：上午請半日特休假，下午上班者，則下午正常發給查名單
    '程式修改第2點和第4點,非整日改由當日判斷是否出缺勤
    'Memo by Lydia 2020/03/05 若有修改規則，請檢視是否一併修改frm160005 ( 人事系統：若銷假人員為查名，自動發email通知「查名人狀態」)
    'strA1 = "select '1' or1,st01 From Staff_Absence,Staff Where SA01 = ST01 and ((" & strSrvDate(1) & " between SA02 and SA04) or (" & sDate1 & " between SA02 and SA04)) " & _
            "and st01 in (select tmqm01 from tmqmember) " & _
            "union select '2' or1,st01 From Staff_Busi_Trip,Staff Where SB01 = ST01 and ((" & strSrvDate(1) & " between SB02 and SB04) or (" & sDate1 & " between SB02 and SB04)) " & _
            "and st01 in (select tmqm01 from tmqmember) " & _
            "union select  '3' or1,st01 From abs010,Staff Where B1003 = ST01 and ((" & strSrvDate(1) & " between B1004 and B1006) or (" & sDate1 & " between B1004 and B1006)) and B1018<>'06' " & _
            "and not exists (select * from Staff_Absence where sa09=b1001) and not exists (select * from Staff_Busi_Trip where sb10=b1001) " & _
            "and st01 in (select tmqm01 from tmqmember) "
    'Modified by Lydia 2020/04/15 +請假類別mKind
    strA1 = "select '1' or1,st01,SA02 as mDate1,SA03 as mTime1,SA04 as mDate2,SA05 as mTime2,SA07 as mDays,SA08 as mHours,'01' as mKind " & _
                "From Staff_Absence,Staff Where SA01 = ST01 and ((" & strSrvDate(1) & " between SA02 and SA04) or (" & sDate1 & " between SA02 and SA04)) " & _
                "and st01 in (select tmqm01 from tmqmember) "
    strA1 = strA1 & "union select '2' or1,st01,SB02 as mDate1,SB03 as mTime1,SB04 as mDate2,SB05 as mTime2,SB06 as mDays,SB07 as mHours,'01' as mKind " & _
                "From Staff_Busi_Trip,Staff Where SB01 = ST01 and ((" & strSrvDate(1) & " between SB02 and SB04) or (" & sDate1 & " between SB02 and SB04)) " & _
                "and st01 in (select tmqm01 from tmqmember) "
    'Modified by Lydia 2020/04/15+排除加班 and b1002<>'02'
    strA1 = strA1 & "union select  '3' or1,st01,B1004 as mDate1,B1005 as mTime1,B1006 as mDate2,B1007 as mTime2,B1009 as mDays,B1010 as mHours,B1002 as mKind " & _
               "From abs010,Staff Where B1003 = ST01 and ((" & strSrvDate(1) & " between B1004 and B1006) or (" & sDate1 & " between B1004 and B1006)) and B1018<>'06' " & _
               "and not exists (select * from Staff_Absence where sa09=b1001) and not exists (select * from Staff_Busi_Trip where sb10=b1001) " & _
               "and st01 in (select tmqm01 from tmqmember) and b1002<>'02' "
   Dim strGrp As String 'Added by Lydia 2022/10/18
   If rsA.State <> adStateClosed Then rsA.Close
     Set rsA = New ADODB.Recordset
     rsA.CursorLocation = adUseClient
     rsA.Open strA1, cnnConnection, adOpenStatic, adLockReadOnly
     With rsA
       If rsA.RecordCount > 0 Then
         rsA.MoveFirst
         Do While Not rsA.EOF
            'Modified by Lydia 2015/09/23
            'If rsA.Fields("cnt") >= 1 Then
            '  strA2 = "update TMQSumR set TMQSR17='N' where TMQSR01=" & CNULL(rsA.Fields(0))
            'End If
            'Added by Lydia 2019/01/28 判斷請假為整日,就不拿單
            strA1 = ""
            If Val("" & rsA.Fields("mDays")) > 0 Then
                strA1 = CompWorkDay(Val("" & rsA.Fields("mDays")), "" & rsA.Fields("mDate1"))
            'Added by Lydia 2022/10/25 判斷是否整天請假; 改用模組
            ElseIf Val("" & rsA.Fields("mHours")) > 0 Then
                 If CheckIsPersonRest("" & rsA.Fields("st01"), "" & rsA.Fields("mDate1"), Format("" & rsA.Fields("mTime1"), "00:00"), , bol1Days) = True Then
                     If bol1Days = True Then
                        strA1 = CompWorkDay(1, "" & rsA.Fields("mDate1"))
                     End If
                 End If
            'end 2022/10/25
            End If
            'Added by Lydia 2022/10/18 判斷時數7.5H=1天; ex.上午公假下午補休
            'Mark by Lydia 2022/10/25 改用模組
'            If strGrp <> "" & rsA.Fields("st01") & rsA.Fields("mDate1") Then
'               strExc(9) = Val("" & rsA.Fields("mHours"))
'               strGrp = "" & rsA.Fields("st01") & rsA.Fields("mDate1")
'            Else
'               strExc(9) = Val(strExc(9)) + Val("" & rsA.Fields("mHours"))
'            End If
'            If strA1 = "" And Val(strExc(9)) >= 7.5 Then
'                strA1 = CompWorkDay(1, "" & rsA.Fields("mDate1"))
'            End If
            'end 2022/10/18
            'end 2022/10/25
            If strSrvDate(1) <= strA1 And strA1 <> "" Then
            'end 2019/01/28
               'Added by Lydia 2020/04/15 檢查出差人員是否異地上班
               If "" & rsA.Fields("mKind") = "03" Then
                    strB1 = "select sp01,sp02,sp03 from staff_workplace where sp01='" & strSrvDate(1) & "' and sp02=" & CNULL(rsA.Fields("st01"))
                    intI = 1
                    Set rsB = ClsLawReadRstMsg(intI, strB1)
                    If intI = 0 Then
                        strA2 = "update TMQSumR set TMQSR17='N' where TMQSR01=" & CNULL(rsA.Fields("st01"))
                        cnnConnection.Execute strA2
                    End If
               Else
               'end 2020/04/15
                    strA2 = "update TMQSumR set TMQSR17='N' where TMQSR01=" & CNULL(rsA.Fields("st01"))
                    cnnConnection.Execute strA2
               End If 'Added by Lydia 2020/04/15
               
            End If 'Added by Lydia 2019/01/28
            rsA.MoveNext
         Loop
       End If
     End With
     
      '3.1 判斷統計人員是否一起放假
        strA1 = "select tmqm02,nvl(tmqm03,'N') tmqm03,count(*) r1,count(tmqsr17) r2 from tmqmember,tmqsumr where tmqm01<>tmqm02 and tmqm01=tmqsr01(+) group by tmqm02,nvl(tmqm03,'N')"
                
        If rsA.State <> adStateClosed Then rsA.Close
          Set rsA = New ADODB.Recordset
          rsA.CursorLocation = adUseClient
          rsA.Open strA1, cnnConnection, adOpenStatic, adLockReadOnly
          With rsA
            If rsA.RecordCount > 0 Then
              rsA.MoveFirst
              Do While Not rsA.EOF
                 strA2 = ""
                 '是的話有一位請假，這個代號今天請假,否的話有一位上班，這個代號今天可排單
                 If (rsA.Fields("tmqm03") = "Y" And rsA.Fields("r2") >= 1) Or _
                    (rsA.Fields("tmqm03") <> "Y" And rsA.Fields("r1") = rsA.Fields("r2")) Then
                    strA2 = "update TMQSumR set TMQSR17='N' where TMQSR01=" & CNULL(rsA.Fields(0))
                    cnnConnection.Execute strA2
                 End If
                 rsA.MoveNext
              Loop
            End If
          End With
          'Added by Lydia 2022/07/05 因為查名中心人員請假過半，為了公平採用全部人員都分發查名單，但是期限+2天
          'Modified by Lydia 2023/07/06 因7月7日(Fri.)及10日(Mon.)有多數查名同仁請假半，為了公平採用全部人員都分發查名單，但是期限+2天
          'If strSrvDate(1) >= "20220707" And strSrvDate(1) <= "20220711" Then
          'Modified by Lydia 2023/07/07 (7/7發現漏掉,改成模組)
          'If strSrvDate(1) >= "20230707" And strSrvDate(1) <= "20230710" Then
          If Pub_GetTmqAllDate(strSrvDate(1)) = True Then
              'Modified by Lydia 2025/07/24 排除暫不拿單
              'strA2 = "update TMQSumR set TMQSR17=null "
              strA2 = "update TMQSumR set TMQSR17=null where tmqsr01 not in (SELECT aal04 FROM addressa4list WHERE aal01='TSdel' AND aal02<=to_char(SYSDATE,'yyyymmdd'))"
              cnnConnection.Execute strA2
          End If
          'end 2022/07/05
          
     'Added by Lydia 2024/11/01 查名單(網中)：平行測試，先補商標查詢(查名單)統計量排班TMQAppSumR
     If strSrvDate(1) < 查名單網中系統啟用日 Then
        cnnConnection.Execute "delete from tmqappsumr"
        cnnConnection.Execute "insert into tmqappsumr select tmqsr01,tmqsr02+tmqsr04 as b1,tmqsr03+tmqsr05 as b2,tmqsr06 as b3,tmqsr09,tmqsr10,tmqsr11,0 as t1, 0 as t2, 0 as t3,tmqsr17,tmqsr18 from tmqsumr "
     End If
     'end 2024/11/01
     
cnnConnection.CommitTrans

   'Added by Lydia 2017/01/20
   '4. 若查名單是在下午六點以後輸入，系統不分發，即不顯示查名人。俟系統在凌晨根據查名人員出缺勤狀況，再分發查名單，即此時可顯示查名人。
   'Added by Lydia 2018/05/25 增加狀態控制
   strA1 = Pub_GetSpecMan("內商查名單分單狀態")
   If UCase(strA1) <> "N" Then
   'end 2018/05/25
        'Modified by Lydia 2018/05/25 排除已撤回的單據
        'strA1 = "select * from trademarkquery where nvl(tmq10,'N')='N' "
        strA1 = "select * from trademarkquery where nvl(tmq10,'N')='N' and tmq11 is null "
        If rsA.State <> adStateClosed Then rsA.Close
        Set rsA = New ADODB.Recordset
        rsA.CursorLocation = adUseClient
        rsA.Open strA1, cnnConnection, adOpenStatic, adLockReadOnly
        If rsA.RecordCount > 0 Then
           rsA.MoveFirst
           cnnConnection.BeginTrans 'Added by Lydia 2017/06/23
           Do While Not rsA.EOF
              strQuser = PUB_GetTMQUserPos(True, "1", Val("" & rsA.Fields("TMQ07")), Val("" & rsA.Fields("TMQ08")), Val("" & rsA.Fields("TMQ09")), "" & rsA.Fields("TMQ03"))
              If strQuser <> "" Then
                '收件日期變更為分發查名人的工作日
                strA2 = "update trademarkquery set tmq10=" & CNULL(strQuser) & ",tmq05=" & strSrvDate(1) & " where tmq01=" & CNULL(rsA.Fields("tmq01"))
                cnnConnection.Execute strA2
                '更新當日拿單量
                'Modified by Lydia 2017/06/23 +不包Transcaction
                'Call PUB_TMQtake(1, strQuser, Val("" & rsA.Fields("TMQ07")), Val("" & rsA.Fields("TMQ08")), Val("" & rsA.Fields("TMQ09")), "" & rsA.Fields("TMQ03"))
                Call PUB_TMQtake(1, strQuser, Val("" & rsA.Fields("TMQ07")), Val("" & rsA.Fields("TMQ08")), Val("" & rsA.Fields("TMQ09")), "" & rsA.Fields("TMQ03"), , False)
                'Added by Lydia 2024/11/12 查名單網中系統：在正式上線前，新舊查名單同時進行商標查名作業
                If strSrvDate(1) >= 查名單網中系統平行測試 Then
                   strA2 = "Update TMQAPPFORM set TMA10=" & CNULL(strQuser) & ",TMA09=" & strSrvDate(1) & " where TMA71=" & CNULL(rsA.Fields("tmq01"))
                   cnnConnection.Execute strA2, intI
                   If intI > 0 Then
                      '並行作業沒有處理團體標章查名，所以只要計算送出期限
                      strExc(1) = PUB_GetNewTMADate(IIf(Val("" & rsA.Fields("tmq09")) > 0, "2", "1"), "" & rsA.Fields("tmq04"), "" & rsA.Fields("tmq14"), "Y")
                      strA2 = "Update TMQAPPFORM set TMA12=" & strExc(1) & " where TMA71=" & CNULL(rsA.Fields("tmq01"))
                      cnnConnection.Execute strA2
                      Call PUB_TMAtoTake("1", strQuser, IIf(Val("" & rsA.Fields("tmq09")) > 0, "2", "1"), "1", False)
                   End If
                End If
                'end 2024/11/12
              End If
              rsA.MoveNext
           Loop
           cnnConnection.CommitTrans 'Added by Lydia 2017/06/23
        End If
  End If 'end 2018/05/25
  
ErrHandle:
   If Err.Number <> 0 Then
      WLog "商標查名單量統計和排序:" & Err.Description
      cnnConnection.RollbackTrans 'Added by Lydia 2017/06/23
   End If
   Set rsA = Nothing
   Set rsB = Nothing 'Added by Lydia 2020/04/14
   
End Sub

'Added by Lydia 2015/07/27
'P大陸發明案公開期限之控管
'一般大陸發明案自申請日或優先權日起算18個月,PCT進中國之發明案自提交日3個月仍未公開之案件,跑清單讓程序人員查詢。
'Modified by Lydia 2015/08/27 P大陸發明案公開期限之控管,改到每月第一個工作天執行
Private Sub StrMenu63()
   Dim RsQ As New ADODB.Recordset
   Dim strQ1 As String, strQ2 As String, strU3 As String
   Dim ff63 As Integer, TFName As String
   'Modified by Lydia 2016/07/01
   'Dim strTemp(0 To 3) As String
   Dim strTemp(0 To 9) As String
   Dim iR As Integer
   Dim bolFMP As Boolean, bolNP As Boolean
   Dim pa(4) As String 'Added by Morgan 2020/1/15
   Dim strPID As String, strPIDName As String 'Added by Morgan 2023/6/16 FMP寰華案管制程序
   Dim strAttName As String, strAttNameFMP As String, strAttNameNP As String 'Added by Morgan 2025/2/5
   
   TFName = "P大陸發明案公開期限之控管"
   Call PUB_KillTempFile(Mid(TextPath & TFName & "*.*", 2))    'Added by Lydia 2020/08/19 清除舊檔
   
On Error GoTo ErrHandle63

   'Modified by Lydia 2015/10/26 寰華案定義改為:新案發文人員為外專程序者
'   strQ1 = "select pa01,pa02,pa03,pa04,pa10,cp44,nvl(fa04,nvl(fa05,nvl(fa06,''))) faname,decode(cp31||substr(cp12,1,1)||cp44,'YFY53374000','Y','N') bFMP " & _
           "from patent,caseprogress,fagent where pa01='P' and pa09='020' and pa08='1' and pa23='1' and pa16 is null and pa57 is null and pa12 is null and pa21 is null and pa108 is null and pa136 is null " & _
           "and pa01=cp01(+) and pa02=cp02(+) and pa03=cp03(+) and pa04=cp04(+) and cp10 in (" & NewCasePtyList & ") " & _
           "and substr(cp44,1,8)=fa01(+) and substr(cp44,9,1) = fa02(+) order by bFMP,pa10 "
    'Modified by Lydia 2016/07/01 +程序管制人
   'strQ1 = "select pa01,pa02,pa03,pa04,pa10,cp44,nvl(fa04,nvl(fa05,nvl(fa06,''))) faname,decode(cp31||substr(cp12,1,1)||cp44||st03,'YFY53374000','Y','YFY53374000F22','Y','N') bFMP " & _
           "from patent,caseprogress,fagent,staff where pa01='P' and pa09='020' and pa08='1' and pa23='1' and pa16 is null and pa57 is null and pa12 is null and pa21 is null and pa108 is null and pa136 is null " & _
           "and pa01=cp01(+) and pa02=cp02(+) and pa03=cp03(+) and pa04=cp04(+) and cp83=st01(+) and cp10 in (" & NewCasePtyList & ") " & _
           "and substr(cp44,1,8)=fa01(+) and substr(cp44,9,1) = fa02(+) order by bFMP,pa10 "
   'Modified by Lydia 2017/02/13 +FMP管制人
   If strSrvDate(1) < FMP管制人啟用日 Then
    'Modified by Lydia 2019/06/11 因為外專於4/30匯入整批新案(案件轉至本所935) , 所以發明收文不判斷cp31 ; ex.P-122635
    'strQ1 = "select pa01,pa02,pa03,pa04,pa10,cp44,nvl(f1.fa04,nvl(f1.fa05,nvl(f1.fa06,''))) faname,decode(cp31||substr(cp12,1,1)||cp44||s1.st03,'YFY53374000','Y','YFY53374000F22','Y','N') bFMP " & _
            ",nvl(n1.na16,'') na16,nvl(s2.st02,'') na16n from patent,caseprogress,fagent f1,staff s1,fagent f2,nation n1,staff s2 " & _
            "where pa01='P' and pa09='020' and pa08='1' and pa23='1' and pa16 is null and pa57 is null and pa12 is null and pa21 is null and pa108 is null and pa136 is null " & _
            "and pa01=cp01(+) and pa02=cp02(+) and pa03=cp03(+) and pa04=cp04(+) and cp83=s1.st01(+) and cp10 in (" & NewCasePtyList & ") " & _
            "and substr(cp44,1,8)=f1.fa01(+) and substr(cp44,9,1) = f1.fa02(+) AND f2.fa01(+)=SUBSTR(PA75,1,8) AND f2.fa02(+)=SUBSTR(PA75,9) AND n1.NA01(+)=f2.fa10 and n1.na16=s2.st01(+) order by bFMP,pa10 "
    strQ1 = "select pa01,pa02,pa03,pa04,pa10,cp44,nvl(f1.fa04,nvl(f1.fa05,nvl(f1.fa06,''))) faname,decode(substr(cp12,1,1)||cp44||s1.st03,'FY53374000','Y','FY53374000F22','Y','N') bFMP " & _
            ",nvl(n1.na16,'') na16,nvl(s2.st02,'') na16n from patent,caseprogress,fagent f1,staff s1,fagent f2,nation n1,staff s2 " & _
            "where pa01='P' and pa09='020' and pa08='1' and pa23='1' and pa16 is null and pa57 is null and pa12 is null and pa21 is null and pa108 is null and pa136 is null " & _
            "and pa01=cp01(+) and pa02=cp02(+) and pa03=cp03(+) and pa04=cp04(+) and cp83=s1.st01(+) and cp10 in (" & NewCasePtyList & ") " & _
            "and substr(cp44,1,8)=f1.fa01(+) and substr(cp44,9,1) = f1.fa02(+) AND f2.fa01(+)=SUBSTR(PA75,1,8) AND f2.fa02(+)=SUBSTR(PA75,9) AND n1.NA01(+)=f2.fa10 and n1.na16=s2.st01(+) order by bFMP,pa10 "
   Else
    'Modified by Lydia 2019/06/11 因為外專於4/30匯入整批新案(案件轉至本所935) , 所以發明收文不判斷cp31 ; ex.P-122635
    'strQ1 = "select pa01,pa02,pa03,pa04,pa10,cp44,nvl(f1.fa04,nvl(f1.fa05,nvl(f1.fa06,''))) faname,decode(cp31||substr(cp12,1,1)||cp44||s1.st03,'YFY53374000','Y','YFY53374000F22','Y','N') bFMP " & _
            ",nvl(n1.na79,n1.na16) na16,nvl(s2.st02,'') na16n from patent,caseprogress,fagent f1,staff s1,fagent f2,nation n1,staff s2 " & _
            "where pa01='P' and pa09='020' and pa08='1' and pa23='1' and pa16 is null and pa57 is null and pa12 is null and pa21 is null and pa108 is null and pa136 is null " & _
            "and pa01=cp01(+) and pa02=cp02(+) and pa03=cp03(+) and pa04=cp04(+) and cp83=s1.st01(+) and cp10 in (" & NewCasePtyList & ") " & _
            "and substr(cp44,1,8)=f1.fa01(+) and substr(cp44,9,1) = f1.fa02(+) AND f2.fa01(+)=SUBSTR(PA75,1,8) AND f2.fa02(+)=SUBSTR(PA75,9) AND n1.NA01(+)=f2.fa10 and nvl(n1.na79,n1.na16)=s2.st01(+) order by bFMP,pa10 "
    strQ1 = "select pa01,pa02,pa03,pa04,pa10,cp44,nvl(f1.fa04,nvl(f1.fa05,nvl(f1.fa06,''))) faname,decode(substr(cp12,1,1)||cp44||s1.st03,'FY53374000','Y','FY53374000F22','Y','N') bFMP " & _
            ",nvl(n1.na79,n1.na16) na16,nvl(s2.st02,'') na16n from patent,caseprogress,fagent f1,staff s1,fagent f2,nation n1,staff s2 " & _
            "where pa01='P' and pa09='020' and pa08='1' and pa23='1' and pa16 is null and pa57 is null and pa12 is null and pa21 is null and pa108 is null and pa136 is null " & _
            "and pa01=cp01(+) and pa02=cp02(+) and pa03=cp03(+) and pa04=cp04(+) and cp83=s1.st01(+) and cp10 in (" & NewCasePtyList & ") " & _
            "and substr(cp44,1,8)=f1.fa01(+) and substr(cp44,9,1) = f1.fa02(+) AND f2.fa01(+)=SUBSTR(PA75,1,8) AND f2.fa02(+)=SUBSTR(PA75,9) AND n1.NA01(+)=f2.fa10 and nvl(n1.na79,n1.na16)=s2.st01(+) order by bFMP,pa10 "
   End If
   'end 2017/02/13
   
   If RsQ.State <> adStateClosed Then RsQ.Close

    Set RsQ = New ADODB.Recordset
    RsQ.CursorLocation = adUseClient
    RsQ.Open strQ1, cnnConnection, adOpenStatic, adLockReadOnly
    With RsQ
        If .RecordCount > 0 Then
           cnnConnection.BeginTrans
              strU3 = "delete from RDataFactory Where FormName='StrMenu63' And ID='QPGMR' "
              cnnConnection.Execute strU3, intI
            .MoveFirst
            Do While Not .EOF
               If PUB_GetOpenLimit020(.Fields("pa01"), .Fields("pa02"), .Fields("pa03"), .Fields("pa04"), strQ1, strQ2) Then
                  ' 暫存DB
                  If Len(strQ1) > 0 And strQ1 <= strSrvDate(1) Then
                    strTemp(0) = .Fields("pa01") & "-" & .Fields("pa02") & "-" & .Fields("pa03") & "-" & .Fields("pa04")
                    strTemp(1) = ChangeWStringToWDateString(strQ1)
                    strTemp(2) = Trim("" & .Fields("cp44") & " " & .Fields("faname"))
                    'Added by Lydia 2017/06/02 有可能是中途轉本所,所以抓最後的CF代理人
                    If strTemp(2) = "" Then
                        PUB_GetCP44 .Fields("pa01"), .Fields("pa02"), .Fields("pa03"), .Fields("pa04"), strExc(1), "", "", strExc(2)
                        strTemp(2) = strExc(1) & " " & strExc(2)
                    End If
                    'end 2017/06/02
                    strTemp(3) = strQ2
                    strExc(5) = .Fields("bFMP")
                    
                    'Added by Morgan 2020/1/15
                    strExc(6) = ""
                    If strExc(5) = "Y" Then
                        pa(1) = .Fields("pa01"): pa(2) = .Fields("pa02"): pa(3) = .Fields("pa03"): pa(4) = .Fields("pa04")
                        If PUB_ChkCPExist(pa, "1213") = True Then
                           strExc(6) = "Y"
                        End If
                    End If
                    'end 2020/1/15
                    
                    'Modified by Lydia 2016/07/01 +程序管制人
                    'strU3 = "insert into RDataFactory(FormName,ID,SEQNO,R001,R002,R003,R004,R005) values ('StrMenu63','QPGMR'," & .AbsolutePosition & ",'" & strTemp(0) & "','" & strTemp(1) & "','" & strTemp(2) & "','" & strTemp(3) & "','" & strExc(5) & "')"
                    'Modified by Morgan 2020/1/15 +R008
                    'strU3 = "insert into RDataFactory(FormName,ID,SEQNO,R001,R002,R003,R004,R005,R006,R007) values ('StrMenu63','QPGMR'," & .AbsolutePosition & ",'" & strTemp(0) & "','" & strTemp(1) & "','" & strTemp(2) & "','" & strTemp(3) & "','" & strExc(5) & "','" & "" & .Fields("na16") & "' ,'" & "" & .Fields("na16n") & "')"
                    'Modified by Morgan 2025/2/5
                    'strU3 = "insert into RDataFactory(FormName,ID,SEQNO,R001,R002,R003,R004,R005,R006,R007,R008) values ('StrMenu63','QPGMR'," & .AbsolutePosition & ",'" & strTemp(0) & "','" & strTemp(1) & "','" & strTemp(2) & "','" & strTemp(3) & "','" & strExc(5) & "','" & "" & .Fields("na16") & "' ,'" & "" & .Fields("na16n") & "','" & strExc(6) & "')"
                    If strExc(5) <> "Y" And strSrvDate(1) >= P業務區劃分啟用日 Then
                        strPID = PUB_GetPHandler(.Fields("pa01") & .Fields("pa02") & .Fields("pa03") & .Fields("pa04"))
                        strPIDName = GetPIDName(strPID)
                    Else
                        strPID = "" & .Fields("na16")
                        strPIDName = "" & .Fields("na16n")
                    End If
                    strU3 = "insert into RDataFactory(FormName,ID,SEQNO,R001,R002,R003,R004,R005,R006,R007,R008) values ('StrMenu63','QPGMR'," & .AbsolutePosition & ",'" & strTemp(0) & "','" & strTemp(1) & "','" & strTemp(2) & "','" & strTemp(3) & "','" & strExc(5) & "','" & strPID & "' ,'" & strPIDName & "','" & strExc(6) & "')"
                    'end 2025/2/5
                    cnnConnection.Execute strU3, intI
                  End If
               End If
              .MoveNext
            Loop
           cnnConnection.CommitTrans
        End If
    End With

   '依公開期限排序
    'Modified by Lydia 2016/07/01 +程序管制人R006,R007
    'Modified by Morgan 2020/1/15 +是否收到初步審查合格通知書 R008 (Y=有)
    'Modified by Morgan 2023/6/16 排序+R006
    strQ1 = "select R001,R002,R003,R004,R005,R006,R007,R008 from RDataFactory where FormName='StrMenu63' and ID='QPGMR' order by R005,R006,R002"

   If RsQ.State <> adStateClosed Then RsQ.Close
    Set RsQ = New ADODB.Recordset
    RsQ.CursorLocation = adUseClient
    RsQ.Open strQ1, cnnConnection, adOpenStatic, adLockReadOnly
    With RsQ
        If .RecordCount > 0 Then
            .MoveFirst
            strTemp(0) = "" 'Added by Morgan 2023/6/16
            strPID = "" 'Added by Morgan 2025/2/5
            Do While Not .EOF
               'Modified by Morgan 2023/6/16
               'If strTemp(0) <> "" & .Fields("R005") Then
               If strTemp(0) <> "" & .Fields("R005") Or strPID <> "" & .Fields("R006") Then
               'end 2023/6/16
                    If ff63 > 0 Then
                       'Modified by Lydia 2016/07/01
                       'Print #ff63, String(108, "=")
                       Print #ff63, String(Len(strU3), "=")
                       Print #ff63, "共 " & iR & " 筆"
                       Close #ff63
                       
                       'Added by Morgan 2023/6/16 FMP寰華案改寄管制程序及其主管
                       If strTemp(0) = "Y" Then
                           strQ2 = PUB_GetFCPProSup(strPID)
                       'Modified by Morgan 2025/25
                       '    SendMAPIMail strPID, TFName & "_寰華案", "請在催公開前先確認已收到""初步審查合格通知書""後再催，謝謝。" & vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, App.path & TextPath & TFName & "_寰華案(" & strPIDName & ").txt", , , strQ2
                           SendMAPIMail strPID, TFName & "_寰華案", "請在催公開前先確認已收到""初步審查合格通知書""後再催，謝謝。" & vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, strAttNameFMP, , , strQ2
                       ElseIf strSrvDate(1) >= P業務區劃分啟用日 Then
                           SendMAPIMail strPID, TFName, vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, strAttNameNP
                       'end 2025/2/5
                       End If
                       'end 2023/6/17
                       
                    End If
                    ff63 = FreeFile
                    iR = 0
                    If .Fields("R005") = "Y" Then
                        bolFMP = True
                        'Modified by Morgan 2023/6/16 FMP寰華案改寄管制程序及其主管
                        'strExc(1) = "_寰華案"
                        strPID = "" & .Fields("R006")
                        strPIDName = "" & .Fields("R007")
                        strExc(1) = "_寰華案(" & strPIDName & ")"
                        'end 2023/6/16
                    Else
                        bolNP = True
                        strExc(1) = ""
                        'Added by Morgan 2025/2/5
                        If strSrvDate(1) >= P業務區劃分啟用日 Then
                           strPID = "" & .Fields("R006")
                           strPIDName = "" & .Fields("R007")
                           strExc(1) = "(" & strPIDName & ")"
                        End If
                        'end 2025/2/5
                    End If
                    
                    'Modified by Morgan 2025/2/5
                    ''Added by Lydia 2020/08/26
                    'If Dir(App.path & TextPath & TFName & strExc(1) & ".txt") <> "" Then
                    '   Kill App.path & TextPath & TFName & strExc(1) & ".txt"
                    'End If
                    ''end 2020/08/26
                    'Open App.path & TextPath & TFName & strExc(1) & ".txt" For Output As ff63
                    strAttName = App.path & TextPath & TFName & strExc(1) & ".txt"
                    If .Fields("R005") = "Y" Then
                        strAttNameFMP = strAttName
                    Else
                        strAttNameNP = strAttName
                    End If
                    If Dir(strAttName) <> "" Then
                        Kill strAttName
                    End If
                    Open strAttName For Output As ff63
                    'end 2025/2/5
                    
                    'Added by Lydia 2016/10/19 加報表抬頭
                    Print #ff63, Space(25) & TFName & strExc(1)
                    Print #ff63, ""
                    'end 2016/10/19
                    Print #ff63, "列印日期：" & ChangeWStringToTString(strSrvDate(1))
                    Print #ff63, vbCrLf
                    'Modified by Lydia 2016/07/01 寰華案+程序管制人
                    'Print #ff63, "本所案號        公開期限   代理人名稱                               期限類別                                "
                    'Print #ff63, "=============== ========== ======================================== ========================================"
                    If Trim("" & .Fields("R005")) = "N" Then
                       Print #ff63, "本所案號        公開期限   代理人名稱                               期限類別                                "
                            strU3 = "=============== ========== ======================================== ========================================"
                    ElseIf Trim("" & .Fields("R005")) = "Y" Then
                       'Modified by Morgan 2020/1/15
                       'Print #ff63, "本所案號        公開期限   代理人名稱                               期限類別                                 程序管制人"
                       '     strU3 = "=============== ========== ======================================== ======================================== =========="
                       Print #ff63, "本所案號                                      公開期限   代理人名稱                               期限類別                                 程序管制人"
                            strU3 = "============================================= ========== ======================================== ======================================== =========="
                    End If
                    Print #ff63, strU3
                    
               End If
               
               'Modified by Lydia 2017/06/02 + ""
               strTemp(0) = convForm("" & .Fields("R001"), 15)
               strTemp(1) = convForm("" & .Fields("R002"), 10)
               strTemp(2) = convForm("" & .Fields("R003"), 40)
               strTemp(3) = convForm("" & .Fields("R004"), 40)
               strTemp(4) = convForm("" & .Fields("R007"), 10) 'Added by Lydia 2016/07/01
               'end 2017/06/02
               'Modified by Lydia 2016/07/01 寰華案+程序管制人
               If Trim("" & .Fields("R005")) = "N" Then
                  Print #ff63, strTemp(0) & " " & strTemp(1) & " " & strTemp(2) & " " & strTemp(3)
               ElseIf Trim("" & .Fields("R005")) = "Y" Then
                  'Modified by Morgan 2020/1/15
                  'Print #ff63, strTemp(0) & " " & strTemp(1) & " " & strTemp(2) & " " & strTemp(3) & " " & strTemp(4)
                  If .Fields("R008") = "Y" Then
                     strTemp(0) = strTemp(0) & String(30, " ")
                     Print #ff63, strTemp(0) & " " & strTemp(1) & " " & strTemp(2) & " " & strTemp(3) & " " & strTemp(4)
                  Else
                     strTemp(0) = strTemp(0) & "（尚未收到初步審查合格通知書）"
                     Print #ff63, strTemp(0) & " " & strTemp(1) & " " & strTemp(2) & " " & strTemp(3) & " " & strTemp(4)
                  End If
                  'end 2020/1/14
               End If
               'end 2016/07/01
               strTemp(0) = "" & .Fields("R005")
               strTemp(1) = "" & .Fields("R007") 'Added by Morgan 2023/6/16
               iR = iR + 1

              .MoveNext
            Loop
            'Modified by Lydia 2016/07/01
            'Print #ff63, String(108, "=")
            Print #ff63, String(Len(strU3), "=")
            Print #ff63, "共 " & iR & " 筆"
            'Added by Morgan 2019/7/11
            If bolFMP = True Then
               Print #ff63, ""
               'Modified by Morgan 2020/1/15--陳亭妙
               'Print #ff63, "※請在催公開前先確認已收到""初步審查合格通知書""後再催，謝謝。"
               Print #ff63, "※尚未收到初步審查合格通知書案件不能催公開，請程序確認尚未收到初步審查合格通知書原因後回覆主管。"
            End If
            'end 2019/7/11
        End If
    End With
''Memo by Lydia 2015/08/11 P大陸發明案公開期限之控管(下一程序999),暫不上線
'    strQ1 = "select pa01||'-'||pa02||'-'||pa03||'-'||pa04 as CasNo,np09,nvl(fa04,nvl(fa05,nvl(fa06,''))) faname,np15,decode(cp31||substr(cp12,1,1)||cp44,'YFY53374000','Y','N') bFMP " & _
'          "from patent,caseprogress,fagent,nextprogress where pa01='P' and pa09='020' and pa08='1' and pa23='1' and pa16||pa57||pa12||pa21||pa108||pa136 is null " & _
'          "and pa01=cp01(+) and pa02=cp02(+) and pa03=cp03(+) and pa04=cp04(+) and cp10 in (" & NewCasePtyList & ") " & _
'          "and substr(cp44,1,8)=fa01(+) and substr(cp44,9,1)=fa02(+) and cp09=np01(+) and np02='P' and np07='999' and np06 is null and np09<=" & strSrvDate(1)
'    strQ1 = strQ1 & " order by bFMP,2,1"
'    If RsQ.State <> adStateClosed Then RsQ.Close
'
'    Set RsQ = New ADODB.Recordset
'    RsQ.CursorLocation = adUseClient
'    RsQ.Open strQ1, cnnConnection, adOpenStatic, adLockReadOnly
'    With RsQ
'        If .RecordCount > 0 Then
'            .MoveFirst
'            Do While Not .EOF
'               If strTemp(0) <> "" & .Fields("bFMP") Then
'                    If ff63 > 0 Then
'                       Print #ff63, String(108, "=")
'                       Print #ff63, "共 " & iR & " 筆"
'                       Close #ff63
'                    End If
'                    ff63 = FreeFile
'                    iR = 0
'                    If .Fields("bFMP") = "Y" Then
'                        bolFMP = True
'                        strExc(1) = "_寰華案"
'                    Else
'                        bolNP = True
'                        strExc(1) = ""
'                    End If
'                    Open App.path & TextPath & TFName & strExc(1) & ".txt" For Output As ff63
'                    Print #ff63, "列印日期：" & ChangeWStringToTString(strSrvDate(1))
'                    Print #ff63, vbCrLf
'                    Print #ff63, "本所案號        公開期限   代理人名稱                               期限類別                                "
'                    Print #ff63, "=============== ========== ======================================== ========================================"
'               End If
'               strTemp(0) = convForm(.Fields("CasNo"), 15)
'               strTemp(1) = convForm(.Fields("np09"), 10)
'               strTemp(2) = convForm(.Fields("faname"), 40)
'               strTemp(3) = convForm(.Fields("np15"), 40)
'               Print #ff63, strTemp(0) & " " & strTemp(1) & " " & strTemp(2) & " " & strTemp(3)
'
'               strTemp(0) = .Fields("bFMP")
'               iR = iR + 1
'              .MoveNext
'            Loop
'
'            Print #ff63, String(108, "=")
'            Print #ff63, "共 " & iR & " 筆"
'        End If
'    End With
    If ff63 > 0 Then
       Close ff63
       '寰華案
       If bolFMP = True Then
          'modify by sonia 2016/7/5 改葉敏莉86024,原Pub_GetSpecMan("M")=73023張靜芳
          'strQ2 = Pub_GetSpecMan("M")
          'strQ2 = Pub_GetSpecMan("寰華案外專程序窗口") 'Removed by Morgan 2023/6/16 FMP寰華案改寄管制程序及其主管
          'Modified by Morgan 2019/7/11
          'SendMAPIMail strQ2, TFName & "_寰華案", vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, App.path & TextPath & TFName & "_寰華案" & ".txt"
          'Modified by Morgan 2023/6/16 FMP寰華案改寄管制程序及其主管
          'SendMAPIMail strQ2, TFName & "_寰華案", "請在催公開前先確認已收到""初步審查合格通知書""後再催，謝謝。" & vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, App.path & TextPath & TFName & "_寰華案" & ".txt"
          strQ2 = PUB_GetFCPProSup(strPID)
          'Modified by Morgan 2025/2/5
          'SendMAPIMail strPID, TFName & "_寰華案", "請在催公開前先確認已收到""初步審查合格通知書""後再催，謝謝。" & vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, App.path & TextPath & TFName & "_寰華案(" & strPIDName & ").txt", , , strQ2
          SendMAPIMail strPID, TFName & "_寰華案", "請在催公開前先確認已收到""初步審查合格通知書""後再催，謝謝。" & vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, strAttNameFMP, , , strQ2
          'end 2025/2/5
          'end 2023/6/16
          'end 2019/7/11
       End If
       '非寰華案
       If bolNP = True Then
          'Modified by Morgan 2025/2/5
          ''Modified by Morgan 2015/10/13
          ''strQ2 = Pub_GetSpecMan("A1")  'P案分案人員
          'strQ2 = Pub_GetSpecMan("A112")  'P大陸案催公開
          ''end 2015/10/13
          'SendMAPIMail strQ2, TFName, vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, App.path & TextPath & TFName & ".txt"
          If strSrvDate(1) >= P業務區劃分啟用日 Then
            If strAttNameNP = strAttName Then
              SendMAPIMail strPID, TFName, vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, strAttNameNP
            End If
          Else
            strQ2 = Pub_GetSpecMan("A112")  'P大陸案催公開
            SendMAPIMail strQ2, TFName, vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, strAttNameNP
          End If
          'end 2025/2/5
       End If
    End If
ErrHandle63:
   If Err.Number <> 0 Then
      WLog TFName & ":" & Err.Description
   End If
   Set RsQ = Nothing
End Sub

'Added by Lydia 2015/07/29 智權部業務目標及達成通知 (參考Promoter\frm210107)
Private Sub StrMenu64()
Dim stDate0 As String, stDDate As String
Dim stVTable1 As String, stVTable2 As String, stVTable3 As String, stVTable4 As String, stVTable5 As String
Dim stWorkDays As String, stWorkDay As String
Dim stF4100Amt As Variant
Dim tCloseDate As String
Dim stWDate As String, stTDate As String, stWYM As String, stTYM As String
Dim strA1  As String
Dim AdoR As New ADODB.Recordset
Dim iR As Integer, m_Si As Integer
Dim ff64 As Integer, TFName As String
'Modified by Lydia 2022/06/02 strTemp(0 To 4) => strTemp(0 To 5)
'Modified by Lydia 2023/06/07 strTemp(0 To 5) => strTemp(0 To 8)
Dim strTemp(0 To 8) As String, strGrp As String, strGrpN As String
Dim mColNum As Integer, tmpCol As Integer '記錄明細欄數
Dim mRowNum As Integer '記錄明細列數
Dim m_Subject() As String  '表格內容
Dim m_Head() As String '智權部總計
Dim strBC As String 'Added by Lydia 2015/08/03 密件副本收件人
'Added by Lydia 2017/02/21 增加去年度同期間業績
Dim strStartD As String   '指定統計日期
Dim iCall As Integer
'Added by Lydia 2017/09/19
Dim bolAgain As Boolean '判斷系統日的日期若<=5時，再跑一份至前一個月月底的資料，寄出的E-MAIL主旨要註明是前一個月份的資料。
Dim stCon As String 'Added by Lydia 2018/08/23
Dim iCurCol As Integer 'Added by Morgan 2023/7/19

On Error GoTo ErrHnd64 'Move by Lydia 2017/09/19 移到上方

Call PUB_KillTempFile(Mid(TextPath & "決策會工作報告-*.*", 2))     'Added by Lydia 2020/08/19 清除舊檔
   
'Added by Lydia 2017/09/19
JumpRunAgain:

   If bolAgain = True Then
      TFName = "決策會工作報告-上月智權部目標及達成統計"
   Else
'end 2017/09/19
      TFName = "決策會工作報告-智權部目標及達成統計"
   End If 'end 2017/09/19
   
   'Modified by Lydia 2015/08/10 判斷系統日是否為工作天的前一個工作天
   'tCloseDate = CompWorkDay(2, strSrvDate(1), 1) '前1個工作天
   'Modified by Lydia 2017/02/21 指定統計日期
'   If bolWorkDay = True Then
'      tCloseDate = CompWorkDay(2, strSrvDate(1), 1)
'   Else
'      tCloseDate = CompWorkDay(1, strSrvDate(1), 1)
'   End If
   'end 2015/08/10
  
For iCall = 1 To 2  'Added by Lydia 2017/02/21 增加去年度同期間業績
   'Modified by Lydia 2017/02/21 指定統計日期
   'Added by Lydia 2017/09/19 再跑一份至前一個月月底的資料
   If bolAgain = True Then
      strExc(1) = GetLastDay(CompDate(1, -1, strSrvDate(1)))
      If iCall = 1 Then '當期
         strStartD = strExc(1)
      Else              '去年同期
         strStartD = CompDate(0, -1, strExc(1))
      End If
   Else
   'end 2017/09/19
      If iCall = 1 Then '當期
         strStartD = strSrvDate(1)
      Else              '去年同期
         strStartD = CompDate(0, -1, strSrvDate(1))
      End If
   End If 'end 2017/09/19
      
      
   If ChkWorkDay(strStartD) = True Then
      'Added by Lydia 2017/09/19 再跑一份至前一個月月底的資料,不用倒推工作天
      If bolAgain = True Then
         tCloseDate = strStartD
      Else
      'end 2017/09/19
         tCloseDate = CompWorkDay(2, strStartD, 1)
      End If 'end 2017/09/19
   Else
      tCloseDate = CompWorkDay(1, strStartD, 1)
   End If
   'end 2017/02/21
   'Modified by Lydia 2023/12/28 增加S10台北所;上一行列為六個區別，下一行列為五個區別，並請協助台北所列第一個
   'mColNum = 6
   mColNum = 7

   'Added by Lydia 2023/06/07 改版面：當期
   If iCall = 1 Then
      'Modified by Lydia 2022/06/02 4=>5
      mRowNum = 8
   Else
   'end 2023/06/06
      'Modified by Lydia 2022/06/02 4=>5
      mRowNum = 5
   End If 'Added by Lydia 2023/06/07
   
   '統計日
   stDDate = TransDate(tCloseDate, 1)
   '統計月份
   'Modified by Lydia 2022/08/02 日00=>01
   stDate0 = Val(stDDate) \ 100 & "01"
   
   'Added by Lydia 2018/08/23 比照每日業績點數輸入(frm210103),排除特定員工代號(ex.中所20011,20021,20031)
   'Modified by Lydia 2022/08/02 不必限制人員CP13<'6'，只要(substr(cp12,1,1)='S' OR CP13='W1001')都抓
   'stCon = " AND ST01>'60000' "
   ''Added by Lydia 2018/08/23 判斷離職前一天的月份要顯示(離職日為1號則當月不用)
   'stCon = stCon & " AND (st04='1' OR substr( decode(ST51,null,'',to_char(to_date(st51,'yyyymmdd')-1,'yyyymmdd')) ,1,6)>= " & Left(TransDate(stDate0, 2), 6) & ") "
   'Modified by Lydia 2023/12/28 ST15不可能有W1001的資料
   'stCon = " AND (substr(st15,1,1)='S' OR st15='W1001') "
   stCon = " AND SUBSTR(ST15,1,1)='S' "
   
   stWDate = TransDate(tCloseDate, 2)
   stTDate = Format(stWDate - 19110000)
   stWYM = Left(stWDate, 6)
   stTYM = Format(stWYM - 191100)

   strExc(0) = " SELECT COUNT(*) TDAYS,SUM(DECODE(SIGN(WD01-" & tCloseDate & "),1,0,1)) DAYS FROM WORKDAY WHERE WD01>" & stWYM & "00 AND WD01<" & stWYM & "99"
   iR = 1
   Set AdoR = ClsLawReadRstMsg(iR, strExc(0))
   If iR = 1 Then
      stWorkDays = "" & AdoR.Fields(0)
      stWorkDay = "" & AdoR.Fields(1)
   End If
   
If stWorkDays > 0 And stWorkDay > 0 Then
   '已入帳資料
   'Modified by Lydia 2018/08/23  +判斷離職人員
   'stVTable1 = "select ax209 V1C0,sum(decode(a0205," & stDDate & ", ax207)) V1C1" & _
      ",sum(ax207) V1C2" & _
      " From acc020, acc021" & _
      " Where a0205 > " & stDate0 & " And a0205 <= " & stDDate & _
      " and ax201(+) = a0201  and ax202(+) = a0202" & _
      " and ax209 Is Not Null and (substr(ax205, 1, 2) = '41' Or ax205 = '7121')" & _
      " and ax207>0 and not( ax205='4191' or ax205='4192' or ax205='4194' or instr(ax213||' ','結餘')>0)" & _
      " group by ax209"
   'Modified by Lydia 2022/06/06 增加創新業務組用收入 420101 原:substr(ax205, 1, 2) = '41'  ; 參考frm210107
   'stVTable1 = "select ax209 V1C0,sum(decode(a0205," & stDDate & ", ax207)) V1C1" & _
      ",sum(ax207) V1C2" & _
      " From acc020, acc021,STAFF" & _
      " Where a0205 > " & stDate0 & " And a0205 <= " & stDDate & _
      " and ax201(+) = a0201  and ax202(+) = a0202" & _
      " and ax209 Is Not Null and (substr(ax205, 1, 2) = '41' Or ax205 = '7121')" & _
      " and ax207>0 and not( ax205='4191' or ax205='4192' or ax205='4194' or instr(ax213||' ','結餘')>0) AND ST01(+)=AX209" & stCon & _
      " group by ax209"
   'Modified by Lydia 2022/08/29 debug : 因為stDate0從00=>01 , 所以>" & stDate0 改成>=" & stDate0
   stVTable1 = "select ax209 V1C0,sum(decode(a0205," & stDDate & ", ax207)) V1C1" & _
      ",sum(ax207) V1C2" & _
      " From acc020, acc021,STAFF" & _
      " Where a0205 >= " & stDate0 & " And a0205 <= " & stDDate & _
      " and ax201(+) = a0201  and ax202(+) = a0202" & _
      " and ax209 Is Not Null and (substr(ax205, 1, 1) = '4' Or ax205 = '7121')" & _
      " and ax207>0 and not( ax205='4191' or ax205='4192' or ax205='4194' or instr(ax213||' ','結餘')>0) AND ST01(+)=AX209" & stCon & _
      " group by ax209"
      
   '已收款資料
   'Modified by Lydia 2018/08/23  +判斷離職人員
   'stVTable2 = "select df01 V2C0,sum(decode(df02," & stDDate & ",0,df03)) V2C1" & _
      ",sum(decode(df02," & stDDate & ",df03,0)) V2C2" & _
      ",decode(Max(df02)," & stDDate & ",'*',null) V2C3 From DailyFeat" & _
      " Where DF02>" & stDate0 & " AND df02 <= " & stDDate & " group by df01"
   'Modified by Lydia 2022/08/29 debug : 因為stDate0從00=>01 , 所以>" & stDate0 改成>= " & stDate0
   stVTable2 = "select df01 V2C0,sum(decode(df02," & stDDate & ",0,df03)) V2C1" & _
      ",sum(decode(df02," & stDDate & ",df03,0)) V2C2" & _
      ",decode(Max(df02)," & stDDate & ",'*',null) V2C3 From DailyFeat,STAFF" & _
      " Where  DF01(+)=ST01 AND DF02>=" & stDate0 & " AND df02 <= " & stDDate & stCon & " group by df01"
   
   'Add By Sindy 2020/10/6 + 已收文點數
   stVTable3 = "select cp13 V3C0,sum(cp18a) V3C1 from" & _
               "(SELECT CP01,CP02,CP03,CP04,CP05,CP09,CP10,cp12,cp13,cp158,cp159,CP16,CP17,CP18,A1U07,A1U09,(CP16-NVL(A1U07,0)-NVL(A1U09,0)) CP16A," & _
               "TO_CHAR(((CP16-NVL(A1U07,0)-NVL(A1U09,0))-(NVL(CP17,0)-NVL(A1U09,0)))/1000,'99999D9') CP18A FROM CASEPROGRESS,"
              '每一收文號之銷退資料
   'Modified by Lydia 2022/08/29 debug : 因為stDate0從00=>01 , 所以>" & stDate0 改成>=" & stDate0
   stVTable3 = stVTable3 & _
                  "(select a1u03,sum(a1u07) a1u07,sum(a1u09) a1u09 from acc1u0 where nvl(a1u07,0)+nvl(a1u09,0)>0 and a1u03 in" & _
                     "(SELECT CP09 FROM CASEPROGRESS WHERE cp05>=" & Val(stDate0) + 19110000 & " and cp05<=" & DBDATE(stDDate) & " and (cp158>19221111 or cp158=0))" & _
                     " group by a1u03" & _
                  ") WHERE cp05>=" & Val(stDate0) + 19110000 & " and cp05<=" & DBDATE(stDDate) & " and (cp158>19221111 or cp158=0)" & _
               "and cp09=a1u03(+)" & _
               "),staff where cp18A<>0 and cp13=st01(+) " & stCon & " group by cp13"
   '已簽約資料
   'Modified by Lydia 2018/08/23  +判斷離職人員stCon
'   stVTable3 = "select df01 V3C0,sum(decode(df02," & stDDate & ",0,NVL(df04,0)-NVL(DF03,0))) V3C1" & _
'      ",sum(decode(df02," & stDDate & ",df04,0)) V3C2" & _
'      ",decode(Max(df02)," & stDDate & ",'*',null) V3C3 From STAFF,DailyFeat" & _
'      " Where DF01(+)=ST01 AND df02 <= " & stDDate & stCon & " group by df01"
   
   '先不抓銷帳及扣點數資料
   '銷帳資料 94/6以後才要
   'Modified by Lydia 2018/08/23  +判斷離職人員
   'stVTable4 = "SELECT A0K20 V4C0,SUM(DECODE(A0S03," & stDDate & ",0,A1U07)) V4C1" & _
      ",SUM(DECODE(A0S03," & stDDate & ",A1U07,0)) V4C2" & _
      " From ACC0S0, ACC0K0, ACC1U0 WHERE A0S04='1' AND A0S03>=940601 AND A0S03 <= " & stDDate & _
      " AND A0K01(+)=A0S02 AND A0K20 IS NOT NULL AND A1U01(+)=A0S01 GROUP BY A0K20"
   stVTable4 = "SELECT A0K20 V4C0,SUM(DECODE(A0S03," & stDDate & ",0,A1U07)) V4C1" & _
      ",SUM(DECODE(A0S03," & stDDate & ",A1U07,0)) V4C2" & _
      " From ACC0S0, ACC0K0, ACC1U0,STAFF WHERE A0S04='1' AND A0S03>=940601 AND A0S03 <= " & stDDate & _
      " AND A0K01(+)=A0S02 AND A0K20 IS NOT NULL AND A1U01(+)=A0S01 AND ST01(+)=A0K20 " & stCon & " GROUP BY A0K20"
      
   '扣點數資料 94/6以後才要
   'Modified by Lydia 2018/08/23  +判斷離職人員
   'stVTable5 = "select ax209 V5C0,sum(DECODE(A0205," & stDDate & ",0,ax206)) V5C1" & _
      ",sum(DECODE(A0205," & stDDate & ",ax206,0)) V5C2" & _
      " from acc020, acc021 where ax201(+) = a0201  and ax202(+) = a0202" & _
      " AND A0205>=940601 AND A0205>" & stDate0 & " AND A0205<=" & stDDate & _
      " and ax209 is not null and ax206>0 and (substr(ax205, 1, 2) = '41' Or ax205 = '7121')" & _
      " and not (ax205='4191' or ax205='4192' or ax205='4194' or instr(ax213||' ','結餘')>0) " & _
      " group by ax209"
   'Modified by Lydia 2022/06/06 增加創新業務組用收入 420101 原:substr(ax205, 1, 2) = '41'  ; 參考frm210107
   'stVTable5 = "select ax209 V5C0,sum(DECODE(A0205," & stDDate & ",0,ax206)) V5C1" & _
      ",sum(DECODE(A0205," & stDDate & ",ax206,0)) V5C2" & _
      " from acc020, acc021,STAFF where ax201(+) = a0201  and ax202(+) = a0202" & _
      " AND A0205>=940601 AND A0205>" & stDate0 & " AND A0205<=" & stDDate & _
      " and ax209 is not null and ax206>0 and (substr(ax205, 1, 2) = '41' Or ax205 = '7121')" & _
      " and not (ax205='4191' or ax205='4192' or ax205='4194' or instr(ax213||' ','結餘')>0) AND ST01(+)=AX209" & stCon & _
      " group by ax209"
'Modified by Lydia 2022/08/29 debug : 因為stDate0從00=>01 , 所以>" & stDate0 改成>=" & stDate0
stVTable5 = "select ax209 V5C0,sum(DECODE(A0205," & stDDate & ",0,ax206)) V5C1" & _
      ",sum(DECODE(A0205," & stDDate & ",ax206,0)) V5C2" & _
      " from acc020, acc021,STAFF where ax201(+) = a0201  and ax202(+) = a0202" & _
      " AND A0205>=940601 AND A0205>=" & stDate0 & " AND A0205<=" & stDDate & _
      " and ax209 is not null and ax206>0 and (substr(ax205, 1, 1) = '4' Or ax205 = '7121')" & _
      " and not (ax205='4191' or ax205='4192' or ax205='4194' or instr(ax213||' ','結餘')>0) AND ST01(+)=AX209" & stCon & _
      " group by ax209"
      
On Error GoTo ErrHnd64 'Move by Lydia 2017/02/21

   '**** 小真說江副所長指示：國外部：實收=財務入帳,為日報,月報統一故改跑日報時先更新每日業績點數輸入,資料自2014/6/1起   *****
   '但因仍有尾數差異,日報表之實收仍於SetExceptCell改為財務入帳數字
   'Mark by Amy 2018/12/10 改至日報表更新-秀玲
'   cnnConnection.BeginTrans
'
'   strExc(0) = "SELECT TO_CHAR(ROUND(SUM(NVL(V1C1,0))/1000,3),'9999999.000') 本日入帳 from STAFF," & _
'               "(" & stVTable1 & ") VT1 WHERE SUBSTR(ST15,1,1)='F' AND V1C0(+)=ST01 "
'   iR = 1: stF4100Amt = 0
'   Set AdoR = ClsLawReadRstMsg(iR, strExc(0))
'   If iR = 1 Then
'      stF4100Amt = Val("" & AdoR(0))
'   End If
'   strExc(0) = "SELECT * from DailyFeat WHERE DF01='F4100' AND DF02=" & stDDate
'   iR = 1
'   Set AdoR = ClsLawReadRstMsg(iR, strExc(0))
'   If iR = 1 Then
'      strA1 = "UPDATE DailyFeat SET DF03=" & stF4100Amt & ",DF04=" & stF4100Amt & " WHERE DF01='F4100' AND DF02=" & stDDate
'   Else
'      strA1 = "insert into DailyFeat (df01,df02,df03,df04) values('F4100'," & stDDate & "," & stF4100Amt & "," & stF4100Amt & ")"
'   End If
'   cnnConnection.Execute strA1
'
'   cnnConnection.CommitTrans 'Move by Lydia 2017/02/21
   'end 2018/12/10
   
   '限智權部S~S99
   'Modified by Lydia 2016/02/15 因為中區組織變動(取消S22加入S24),改成公用常數與業務目標及達成通知日報表(frm210107)共用
   'strA1 = "SELECT ST15,MAX(DECODE(ST15,'W','其他','X','巨京','Z','國外部',A0902)) 項目" & _
      ",TO_CHAR(NVL(SUM(PE04),0),'9999999.00') 本月目標" & _
      ",TO_CHAR(ROUND(NVL(SUM(PE04),0)/" & stWorkDays & ",2),'9999999.00') 每日應收" & _
      ",TO_CHAR(ROUND(NVL(SUM(PE04),0)*" & stWorkDay & "/" & stWorkDays & ",2),'9999999.00') 合計應收" & _
      ",TO_CHAR(ROUND(NVL(SUM(NVL(V1C1,0)-NVL(V5C2,0)),0)/1000,2),'9999999.00') 本日入帳" & _
      ",TO_CHAR(ROUND(NVL(SUM(NVL(V1C2,0)-NVL(V5C1,0)-NVL(V5C2,0)),0)/1000,2),'9999999.00') 本月入帳" & _
      ",TO_CHAR(NVL(SUM(V2C2),0)-ROUND(NVL(SUM(V5C2),0)/1000,2),'9999999.00') 本日實收" & _
      ",TO_CHAR(NVL(SUM(V2C1),0)-ROUND(NVL(SUM(V5C1),0)/1000,2)+NVL(SUM(V2C2),0)-ROUND(NVL(SUM(V5C2),0)/1000,2),'9999999.00') 本月實收" & _
      ",TO_CHAR(NVL(SUM(V3C1),0)-ROUND(NVL(SUM(V4C1),0)/1000,2)+NVL(SUM(V3C2),0)-NVL(SUM(V2C2),0)-ROUND(NVL(SUM(V4C2),0)/1000,2),'9999999.00') 已簽約" & _
      " FROM ( SELECT ST01,DECODE(SUBSTR(ST15,1,1),'F','Z',DECODE(ST15,'P29','X',DECODE(INSTR('S11,S13,S14,S15,S21,S22,S23,S29,S31,S41',ST15),0,'W',ST15))) ST15" & _
      " FROM STAFF WHERE ST15 IS NOT NULL) STAFF,ACC090,PERFORMANCE" & _
      ",(" & stVTable1 & ") VT1,(" & stVTable2 & ") VT2,(" & stVTable3 & ") VT3" & _
      ",(" & stVTable4 & ") VT4,(" & stVTable5 & ") VT5" & _
      " WHERE A0901(+)=ST15 and st15>='S' and st15<='S99' AND PE01(+)=ST01 AND PE02(+)='TOT' AND PE03(+)=" & stWYM & _
      " AND V1C0(+)=ST01 AND V2C0(+)=ST01 and V3C0(+)=ST01 AND V4C0(+)=ST01 and V5C0(+)=ST01" & _
      " GROUP BY ST15"
    'Modified by Lydia 2018/08/23 判斷離職前一天的月份要顯示(離職日為1號則當月不用)
    'strA1 = "SELECT ST15,MAX(DECODE(ST15,'W','其他','X','巨京','Z','國外部',A0902)) 項目" & _
      ",TO_CHAR(NVL(SUM(PE04),0),'9999999.00') 本月目標" & _
      ",TO_CHAR(ROUND(NVL(SUM(PE04),0)/" & stWorkDays & ",2),'9999999.00') 每日應收" & _
      ",TO_CHAR(ROUND(NVL(SUM(PE04),0)*" & stWorkDay & "/" & stWorkDays & ",2),'9999999.00') 合計應收" & _
      ",TO_CHAR(ROUND(NVL(SUM(NVL(V1C1,0)-NVL(V5C2,0)),0)/1000,2),'9999999.00') 本日入帳" & _
      ",TO_CHAR(ROUND(NVL(SUM(NVL(V1C2,0)-NVL(V5C1,0)-NVL(V5C2,0)),0)/1000,2),'9999999.00') 本月入帳" & _
      ",TO_CHAR(NVL(SUM(V2C2),0)-ROUND(NVL(SUM(V5C2),0)/1000,2),'9999999.00') 本日實收" & _
      ",TO_CHAR(NVL(SUM(V2C1),0)-ROUND(NVL(SUM(V5C1),0)/1000,2)+NVL(SUM(V2C2),0)-ROUND(NVL(SUM(V5C2),0)/1000,2),'9999999.00') 本月實收" & _
      ",TO_CHAR(NVL(SUM(V3C1),0)-ROUND(NVL(SUM(V4C1),0)/1000,2)+NVL(SUM(V3C2),0)-NVL(SUM(V2C2),0)-ROUND(NVL(SUM(V4C2),0)/1000,2),'9999999.00') 已簽約" & _
      " FROM ( SELECT ST01," & AutoBatchSalesArea & ") ST15" & _
      " FROM STAFF WHERE ST15 IS NOT NULL) STAFF,ACC090,PERFORMANCE" & _
      ",(" & stVTable1 & ") VT1,(" & stVTable2 & ") VT2,(" & stVTable3 & ") VT3" & _
      ",(" & stVTable4 & ") VT4,(" & stVTable5 & ") VT5" & _
      " WHERE A0901(+)=ST15 and st15>='S' and st15<='S99' AND PE01(+)=ST01 AND PE02(+)='TOT' AND PE03(+)=" & stWYM & _
      " AND V1C0(+)=ST01 AND V2C0(+)=ST01 and V3C0(+)=ST01 AND V4C0(+)=ST01 and V5C0(+)=ST01" & _
      " GROUP BY ST15"
    
    'Add By Sindy 2020/10/6 + 已收文點數
    ',TO_CHAR(NVL(SUM(V3C1),0)-ROUND(NVL(SUM(V4C1),0)/1000,2)+NVL(SUM(V3C2),0)-NVL(SUM(V2C2),0)-ROUND(NVL(SUM(V4C2),0)/1000,2),'9999999.00') 已簽約
    ' => ,TO_CHAR(ROUND(NVL(SUM(V3C1),0),2),'9999999.00') 本月累計收文
    'Modified by Lydia 2025/01/20 改成全部智權部，有資料就列出
    'strA1 = "SELECT ST15,MAX(DECODE(ST15,'W','其他','X','巨京','Z','國外部',A0902)) 項目" & _
      ",TO_CHAR(NVL(SUM(PE04),0),'9999999.00') 本月目標" & _
      ",TO_CHAR(ROUND(NVL(SUM(PE04),0)/" & stWorkDays & ",2),'9999999.00') 每日應收" & _
      ",TO_CHAR(ROUND(NVL(SUM(PE04),0)*" & stWorkDay & "/" & stWorkDays & ",2),'9999999.00') 合計應收" & _
      ",TO_CHAR(ROUND(NVL(SUM(NVL(V1C1,0)-NVL(V5C2,0)),0)/1000,2),'9999999.00') 本日入帳" & _
      ",TO_CHAR(ROUND(NVL(SUM(NVL(V1C2,0)-NVL(V5C1,0)-NVL(V5C2,0)),0)/1000,2),'9999999.00') 本月入帳" & _
      ",TO_CHAR(NVL(SUM(V2C2),0)-ROUND(NVL(SUM(V5C2),0)/1000,2),'9999999.00') 本日實收" & _
      ",TO_CHAR(NVL(SUM(V2C1),0)-ROUND(NVL(SUM(V5C1),0)/1000,2)+NVL(SUM(V2C2),0)-ROUND(NVL(SUM(V5C2),0)/1000,2),'9999999.00') 本月實收" & _
      ",TO_CHAR(ROUND(NVL(SUM(V3C1),0),2),'9999999.00') 本月累計收文" & _
      " FROM ( SELECT ST01," & AutoBatchSalesArea & ") ST15" & _
      " FROM STAFF WHERE ST15 IS NOT NULL " & stCon & " ) STAFF," & _
      " ACC090,PERFORMANCE,(" & stVTable1 & ") VT1,(" & stVTable2 & ") VT2,(" & stVTable3 & ") VT3,(" & stVTable4 & ") VT4,(" & stVTable5 & ") VT5" & _
      " WHERE A0901(+)=ST15 and st15>='S' and st15<='S99' AND PE01(+)=ST01 AND PE02(+)='TOT' AND PE03(+)=" & stWYM & _
      " AND V1C0(+)=ST01 AND V2C0(+)=ST01 and V3C0(+)=ST01 AND V4C0(+)=ST01 and V5C0(+)=ST01" & _
      " GROUP BY ST15"
    strA1 = "SELECT * FROM (SELECT ST15,MAX(DECODE(ST15,'W','其他','X','巨京','Z','國外部',A0902)) 項目" & _
      ",TO_CHAR(NVL(SUM(PE04),0),'9999999.00') 本月目標" & _
      ",TO_CHAR(ROUND(NVL(SUM(PE04),0)/" & stWorkDays & ",2),'9999999.00') 每日應收" & _
      ",TO_CHAR(ROUND(NVL(SUM(PE04),0)*" & stWorkDay & "/" & stWorkDays & ",2),'9999999.00') 合計應收" & _
      ",TO_CHAR(ROUND(NVL(SUM(NVL(V1C1,0)-NVL(V5C2,0)),0)/1000,2),'9999999.00') 本日入帳" & _
      ",TO_CHAR(ROUND(NVL(SUM(NVL(V1C2,0)-NVL(V5C1,0)-NVL(V5C2,0)),0)/1000,2),'9999999.00') 本月入帳" & _
      ",TO_CHAR(NVL(SUM(V2C2),0)-ROUND(NVL(SUM(V5C2),0)/1000,2),'9999999.00') 本日實收" & _
      ",TO_CHAR(NVL(SUM(V2C1),0)-ROUND(NVL(SUM(V5C1),0)/1000,2)+NVL(SUM(V2C2),0)-ROUND(NVL(SUM(V5C2),0)/1000,2),'9999999.00') 本月實收" & _
      ",TO_CHAR(ROUND(NVL(SUM(V3C1),0),2),'9999999.00') 本月累計收文" & _
      " FROM ( SELECT ST01, ST15" & _
      " FROM STAFF WHERE ST15 IS NOT NULL " & stCon & " ) STAFF," & _
      " ACC090,PERFORMANCE,(" & stVTable1 & ") VT1,(" & stVTable2 & ") VT2,(" & stVTable3 & ") VT3,(" & stVTable4 & ") VT4,(" & stVTable5 & ") VT5" & _
      " WHERE A0901(+)=ST15 and st15>='S' and st15<='S99' AND PE01(+)=ST01 AND PE02(+)='TOT' AND PE03(+)=" & stWYM & _
      " AND V1C0(+)=ST01 AND V2C0(+)=ST01 and V3C0(+)=ST01 AND V4C0(+)=ST01 and V5C0(+)=ST01" & _
      " GROUP BY ST15 ) WHERE NVL(本月目標,0)<> 0 OR NVL(每日應收,0)<>0 OR NVL(合計應收,0)<>0" & _
      " OR NVL(本日入帳,0)<>0 OR NVL(本月入帳,0)<>0 OR NVL(本日實收,0)<>0 OR NVL(本月實收,0)<>0 OR NVL(本月累計收文,0)<>0"
    If AdoR.State <> adStateClosed Then AdoR.Close
      Set AdoR = New ADODB.Recordset
      AdoR.CursorLocation = adUseClient
      AdoR.Open strA1, cnnConnection, adOpenStatic, adLockReadOnly
      If AdoR.RecordCount > 0 Then
         Erase m_Subject: Erase m_Head
         ReDim m_Subject(AdoR.RecordCount + 4, mRowNum) '保留4欄,存區域別
         'Modified by Lydia 2016/08/18 +簽收合計
         'ReDim m_Head(1 To mRowNum)
         'Added by Lydia 2023/06/07 改版面：當期(增加:未收款、不含ACS收文、ACS收文)
         If iCall = 1 Then
            ReDim m_Head(1 To 7)
         Else
         'end 2023/06/07
            'Modified by Lydia 2022/06/02 改成統計:1應　收,2入　帳,3收　款,4本月累計收文(Memo by Lydia 2023/06/07 改「總收文」)
            'ReDim m_Head(1 To 5)
            ReDim m_Head(1 To 4)
         End If 'Added by Lydia 2023/06/07
         m_Si = 1
         With AdoR
            .MoveFirst
            Do While Not .EOF
                'Modified by Lydia 2017/10/12 因為106/10/1以後S22成立,所以第一列為北所+S21 (後面統一名稱為業務區)
                'If Left(.Fields("ST15"), 2) = "S1" Then
                'Modified by Lydia 2025/01/20 以區別數來分
                'If Left(.Fields("ST15"), 2) = "S1" Or .Fields("ST15") = "S21" Then
                '   strGrpN = "北所"
                'Else
                '   strGrpN = "分所"
                'End If
                strGrpN = (.AbsolutePosition \ 6) + (IIf(.AbsolutePosition Mod 6 > 0, 1, 0))
                'end 2025/01/06
                
                If strGrp <> strGrpN Then
JumpNewArea: '部門超過指定欄位數,換行
                    tmpCol = 1
                    'Modified by Lydia 2025/01/20
                    'strTemp(0) = IIf(strGrpN = "北所", "1", "2")
                    strTemp(0) = strGrpN
                    strTemp(1) = strTemp(0)
                    strTemp(2) = "應　收"
                    strTemp(3) = "入　帳" 'Modified by Lydia 2022/06/02 "實　收"=>"入　帳"
                    strTemp(4) = "收　款" 'Added by Lydia 2022/06/02 後面Index自動加
                    'Modified by Lydia 2023/06/07 改版面
                    'strTemp(5) = "本月" & vbCrLf & "累計收文" 'Modify By Sindy 2020/10/5 "已簽約"
                    If iCall = 1 Then '當期
                       strTemp(5) = "未收款"
                       strTemp(6) = "總收文"
                       strTemp(7) = "不含ACS" & vbCrLf & "收文"
                       strTemp(8) = "ACS收文"
                    Else  '上一期
                       strTemp(5) = "總收文"
                       strTemp(6) = ""
                       strTemp(7) = ""
                       strTemp(8) = ""
                    End If
                    '2023/06/07
                    strGrp = strGrpN
                Else
                    'Modified by Lydia 2016/05/16
                    'If tmpCol > mColNum Then GoTo JumpNewArea
                    If tmpCol >= mColNum Then
                       GoTo JumpNewArea
                    End If
                    strTemp(0) = .Fields(0)
                    strTemp(1) = .Fields(1)
                    strTemp(2) = Format(Val(.Fields(4)), "##0.00")
                    'Modified by Lydia 2022/06/02
                    'strTemp(3) = Format(Val(.Fields(8)), "##0.00")
                    'strTemp(4) = Format(Val(.Fields(9)), "##0.00")
                    strTemp(3) = Format(Val(.Fields(6)), "##0.00")
                    strTemp(4) = Format(Val(.Fields(8)), "##0.00")
                    'Modified by Lydia 2023/06/07 改版面
                    'strTemp(5) = Format(Val(.Fields(9)), "##0.00")
                    ''end 2022/06/02
                    ''Added by Lydia 2022/08/02 改成和frm210104的累計收文一樣
                    'strA1 = Format(PUB_CountCP18(0, TransDate(stDate0, 1), TransDate(stDDate, 1), strTemp(0), strTemp(0), , , , , 1), "##0.00")
                    'strTemp(5) = strA1
                    ''end 2022/08/02
                    If iCall = 1 Then '當期
                       '未收款(含ACS)
                       strTemp(5) = Format(PUB_CountCP18(1, "", "", strTemp(0), strTemp(0), , , , , 0), "##0.00")
                       '總收文
                       strTemp(6) = Format(PUB_CountCP18(0, TransDate(stDate0, 1), TransDate(stDDate, 1), strTemp(0), strTemp(0), , , , , 0), "##0.00")
                       '不含ACS收文
                       strTemp(7) = Format(PUB_CountCP18(0, TransDate(stDate0, 1), TransDate(stDDate, 1), strTemp(0), strTemp(0), , , , , 1), "##0.00")
                       'ACS收文
                       strTemp(8) = Format(PUB_CountCP18(0, TransDate(stDate0, 1), TransDate(stDDate, 1), strTemp(0), strTemp(0), , , , , 2), "##0.00")
                    Else '上一期
                       '總收文
                       strTemp(5) = Format(PUB_CountCP18(0, TransDate(stDate0, 1), TransDate(stDDate, 1), strTemp(0), strTemp(0), , , , , 0), "##0.00")
                       strTemp(6) = "0.00": strTemp(7) = "0.00": strTemp(8) = "0.00"
                    End If
                    'end 2023/06/07
                End If
                '儲存WordArray
                For iR = 1 To mRowNum
                    m_Subject(m_Si, iR) = strTemp(iR)
                    'Modified by Lydia 2025/01/20 先加上,3,4
                    If iR > 1 And InStr("1,2,3,4", strTemp(0)) = 0 Then
                       m_Head(iR - 1) = Format(Val(m_Head(iR - 1)) + Val(strTemp(iR)), "#####0.00")
                    End If
                Next iR
                m_Si = m_Si + 1
                'Modified by Lydia 2025/01/20 先加上,3,4
                If InStr("1,2,3,4", strTemp(0)) = 0 Then
                   .MoveNext
                   tmpCol = tmpCol + 1
                End If
            Loop
         End With
      End If 'AdoR
      'Added by Lydia 2016/08/18 簽收合計=實收+已簽約
      'm_Head(5) = Format(Val(m_Head(2)) + Val(m_Head(3)), "#####0.00") 'Mark by Lydia 2022/06/02
'-------------Run Word
      If iCall = 1 Then 'Added by Lydia 2017/02/21 判斷當期-開Word檔
          If TypeName(g_WordAp) <> "Application" Then Set g_WordAp = New Word.Application
    
          g_WordAp.Documents.add
          g_WordAp.Visible = True
          g_WordAp.WindowState = wdWindowStateMaximize
          g_WordAp.WindowState = wdWindowStateNormal
          If g_WordAp.WindowState = wdWindowStateNormal Then
             g_WordAp.Move Screen.Width / 20, Screen.Height / 20
          End If
          g_WordAp.ActiveWindow.ActivePane.View.Zoom.Percentage = 100
      End If 'Added by Lydia 2017/02/21 判斷當期
      
      With g_WordAp.Application
          If iCall = 1 Then 'Added by Lydia 2017/02/21 判斷當期
            '版面設定
            .Selection.PageSetup.Orientation = wdOrientPortrait '直印 'wdOrientLandscape  '橫印
            .Selection.PageSetup.LeftMargin = .CentimetersToPoints(2)
            .Selection.PageSetup.RightMargin = .CentimetersToPoints(2)
            'Modified by Lydia 2022/06/02 上下邊界從2公分改成1.5公分
            .Selection.PageSetup.TopMargin = .CentimetersToPoints(1.5)
            .Selection.PageSetup.BottomMargin = .CentimetersToPoints(1.5)
            .Selection.PageSetup.FooterDistance = .CentimetersToPoints(1.5)
            'end 2022/06/02
            .Selection.Orientation = wdTextOrientationHorizontal
            .Selection.Font.Size = 12
            .Selection.Font.Name = "標楷體"
            '行距
            With .Selection.ParagraphFormat
              .SpaceBefore = 0
              .SpaceAfter = 0
              .LineSpacingRule = wdLineSpaceSingle
              .DisableLineHeightGrid = True
            End With
          
            '新增表格(1*N)
            .Selection.Tables.add Range:=.Selection.Range, NumRows:=1, NumColumns:=3
             With .Selection.Tables(1) '清除格線
               .Borders(wdBorderLeft).LineStyle = wdLineStyleNone
               .Borders(wdBorderRight).LineStyle = wdLineStyleNone
               .Borders(wdBorderTop).LineStyle = wdLineStyleNone
               .Borders(wdBorderBottom).LineStyle = wdLineStyleNone
               .Borders(wdBorderVertical).LineStyle = wdLineStyleNone
               .Borders(wdBorderDiagonalDown).LineStyle = wdLineStyleNone
               .Borders(wdBorderDiagonalUp).LineStyle = wdLineStyleNone
               .Borders(wdBorderHorizontal).LineStyle = wdLineStyleNone 'Added by Lydia 2017/02/21
               .Borders.Shadow = False
             End With
                      
          '接續-上期資料
          Else
             '.Selection.MoveRight Unit:=wdCell, Count:=1 'Mark by Lydia 2022/06/02
             'Added by Lydia 2020/02/18 清除最後一格的格線
             .Selection.Borders(wdBorderLeft).LineStyle = wdLineStyleNone
             .Selection.Borders(wdBorderRight).LineStyle = wdLineStyleNone
             'end 2020/02/18
             .Selection.Borders(wdBorderBottom).LineStyle = wdLineStyleNone  'Added by Lydia 2022/06/02
             .Selection.MoveRight Unit:=wdCharacter, Count:=2
             .Selection.InsertRows
             '清除格線
             .Selection.Borders(wdBorderLeft).LineStyle = wdLineStyleNone
             .Selection.Borders(wdBorderRight).LineStyle = wdLineStyleNone
             .Selection.Borders(wdBorderTop).LineStyle = wdLineStyleNone
             .Selection.Borders(wdBorderBottom).LineStyle = wdLineStyleNone
             .Selection.Borders(wdBorderVertical).LineStyle = wdLineStyleNone
             .Selection.Borders(wdBorderDiagonalDown).LineStyle = wdLineStyleNone
             .Selection.Borders(wdBorderDiagonalUp).LineStyle = wdLineStyleNone
             .Selection.Borders(wdBorderHorizontal).LineStyle = wdLineStyleNone
             'Modifiedb Lyd 2020/02/18 改版面，間隔一行
             '.Selection.InsertRows (2)
             '.Selection.Collapse Direction:=wdCollapseEnd
             '.Selection.MoveRight Unit:=wdCharacter, Count:=2
             '.Selection.InsertRows
             '.Selection.Cells.Split NumRows:=1, NumColumns:=3, MergeBeforeSplit:=False
             '.Selection.Collapse Direction:=wdCollapseStart
             .Selection.InsertRows
             .Selection.SelectRow
             .Selection.Cells.Merge
             .Selection.Cells.Split NumRows:=1, NumColumns:=3, MergeBeforeSplit:=False
             .Selection.Collapse Direction:=wdCollapseStart
             'end 2020/02/18
          End If
          'end 2017/02/21  判斷當期
          
          '設定表格高度欄寬
          .Selection.SelectRow
          .Selection.Cells(1).SetWidth ColumnWidth:=.CentimetersToPoints(5), RulerStyle:=wdAdjustProportional
          .Selection.Cells.VerticalAlignment = wdAlignVerticalCenter
          
'          'Modified by Lydia 2020/02/18 統計分成兩行顯示
'          '.Selection.InsertRows UBound(m_Head) + 1
          If iCall = 1 Then .Selection.InsertRows 4

          .Selection.Collapse Direction:=wdCollapseStart
          .Selection.Cells(1).SetHeight RowHeight:=36, HeightRule:=wdRowHeightAtLeast
          .Selection.Font.Size = 14
          .Selection.TypeText Text:="智權部點數(總點數)"
          .Selection.MoveRight Unit:=wdCharacter, Count:=1
          .Selection.Font.Size = 14
          .Selection.TypeText Text:="統計日期:" & stDDate
          .Selection.MoveRight Unit:=wdCharacter, Count:=3
          .Selection.Font.Size = 12
          'Added by Lydia 2020/02/18 統計分成兩行顯示
          If iCall = 2 Then
              .Selection.InsertRows 4
              .Selection.Collapse Direction:=wdCollapseStart
          End If
          
          'Modified by Lydia 2020/02/18 統計分成兩行顯示
'          For iR = 1 To UBound(m_Head)
'           .Selection.SelectRow
'           .Selection.Cells(1).SetWidth ColumnWidth:=.CentimetersToPoints(2.5), RulerStyle:=wdAdjustProportional
'           .Selection.Cells(2).SetWidth ColumnWidth:=.CentimetersToPoints(2), RulerStyle:=wdAdjustProportional
'            Select Case iR
'                 Case 1: strA1 = "應　收:"
'                 Case 2: strA1 = "實　收:"
'                 Case 3: strA1 = "實收／應收:"
'                 'Modified by Lydia 2016/08/18
'                 'Case 4: strA1 = "已簽收:"
'                 Case 4: strA1 = "已簽約:"
'                 Case 5: strA1 = "簽收合計:" 'Added by Lydia 2016/08/18
'            End Select
'
'            If iR <> 3 Then
'               .Selection.Font.Bold = False
'            Else
'               .Selection.Font.Bold = True
'            End If
'            .Selection.TypeText text:=strA1
'            .Selection.MoveRight Unit:=wdCharacter, Count:=1
'            .Selection.ParagraphFormat.Alignment = wdAlignParagraphRight
'             'Modified by lydia 2016/08/18 +簽收合計
'             'If iR < 3 Then
'             If iR < 3 Or iR > 4 Then
'                .Selection.TypeText text:=Format(m_Head(iR), "##0.00")
'             Else
'                Select Case iR
'                    Case 3
'                        'Added by Lydia 2016/04/06 除以零
'                        If Val(m_Head(1)) = 0 Then
'                           .Selection.TypeText text:=Format(0, "###0.00%")
'                        Else
'                        'end 2016/04/6
'                           .Selection.TypeText text:=Format(Val(m_Head(2)) / Val(m_Head(1)), "###0.00%")
'                        End If
'                    Case 4
'                        .Selection.TypeText text:=Format(m_Head(iR - 1), "##0.00")
'                End Select
'             End If
'             .Selection.MoveRight Unit:=wdCharacter, Count:=3
'          Next iR
'---------------------------------
          'Modified by Lydia 2023/06/07 改版面
          'For iR = 1 To 3
          For iR = 1 To IIf(iCall = 1, 5, 4)
               .Selection.SelectRow
               .Selection.Cells.Merge
               'Modofied by Lydia 2022/06/02 改用5欄,左邊是單項合計,右邊是統計比率
               '.Selection.Cells.Split NumRows:=1, NumColumns:=6, MergeBeforeSplit:=False
               'Modified by Lydia 2023/06/07 改版面
               '.Selection.Cells.Split NumRows:=1, NumColumns:=5, MergeBeforeSplit:=False
               '.Selection.Cells(3).SetWidth ColumnWidth:=.CentimetersToPoints(2), RulerStyle:=wdAdjustProportional
               'end 2022/06/02
               If iCall = 1 Or (iCall = 2 And iR > 1) Then
                  .Selection.Cells.Split NumRows:=1, NumColumns:=5, MergeBeforeSplit:=False
                  .Selection.Cells(1).SetWidth ColumnWidth:=.CentimetersToPoints(5), RulerStyle:=wdAdjustProportional
                  .Selection.Cells(2).SetWidth ColumnWidth:=.CentimetersToPoints(3), RulerStyle:=wdAdjustProportional
                  .Selection.Cells(3).SetWidth ColumnWidth:=.CentimetersToPoints(2), RulerStyle:=wdAdjustProportional
                  .Selection.Cells(4).SetWidth ColumnWidth:=.CentimetersToPoints(4), RulerStyle:=wdAdjustProportional
                  .Selection.Cells(5).SetWidth ColumnWidth:=.CentimetersToPoints(3), RulerStyle:=wdAdjustProportional
               Else
                  .Selection.Cells.Split NumRows:=1, NumColumns:=4, MergeBeforeSplit:=False
                  .Selection.Cells(1).SetWidth ColumnWidth:=.CentimetersToPoints(5), RulerStyle:=wdAdjustProportional
                  .Selection.Cells(2).SetWidth ColumnWidth:=.CentimetersToPoints(3), RulerStyle:=wdAdjustProportional
                  .Selection.Cells(3).SetWidth ColumnWidth:=.CentimetersToPoints(2), RulerStyle:=wdAdjustProportional
               End If
               'end 2023/06/07 tion:=wdCollapseStart
               
               '第一列
               If iR = 1 Then
                    .Selection.ParagraphFormat.Alignment = wdAlignParagraphLeft
                    .Selection.TypeText Text:="應　收:"
                    .Selection.MoveRight Unit:=wdCell, Count:=1
                    .Selection.ParagraphFormat.Alignment = wdAlignParagraphRight
                    .Selection.TypeText Text:=Format(m_Head(1), "##0.00") 'If iR < 3 Or iR > 4 Then .Selection.TypeText text:=Format(m_Head(iR), "##0.00")
                    'Modified by Lydia 2022/06/02 Count:=3=> Count:=2
                     .Selection.MoveRight Unit:=wdCell, Count:=2
                    'Modify By Sindy 2020/9/4 不顯示已簽約
                    'Modify By Sindy 2020/10/6 +本月累計收文:
                    'Modified by Lydia 2023/06/07 改版面
                    '.Selection.TypeText Text:="本月累計收文:" '"已簽約:"
                    '.Selection.MoveRight Unit:=wdCell, Count:=1
                    '.Selection.ParagraphFormat.Alignment = wdAlignParagraphRight
                    ''Modify By Sindy 2020/9/4 不顯示已簽約
                    ''Modify By Sindy 2020/10/6 +本月累計收文
                    ''Modified by Lydia 2022/06/02 m_Head(3)=>m_Head(4)
                    '.Selection.TypeText Text:=Format(m_Head(4), "##0.00") 'Format(m_Head(iR - 1), "##0.00")
                    '.Selection.MoveRight Unit:=wdCell, Count:=1
                    If iCall = 1 Then '當期
                       .Selection.TypeText Text:="未收款合計: "
                       .Selection.MoveRight Unit:=wdCell, Count:=1
                       .Selection.ParagraphFormat.Alignment = wdAlignParagraphRight
                       .Selection.TypeText Text:=Format(m_Head(4), "##0.00")
                       .Selection.MoveRight Unit:=wdCell, Count:=1
                    Else  '上一期
                       '.Selection.SelectColumn 1
                       '.Selection.Cells.Merge
                       .Selection.TypeText Text:="未收款為滾動資訊無法呈現"
                       .Selection.MoveRight Unit:=wdCell, Count:=1
                    End If
                    'end 2023/06/07
               '第二列
               'Modified by Lydia 2023/06/07 改版面
               'ElseIf iR = 2 Then
               '     .Selection.ParagraphFormat.Alignment = wdAlignParagraphLeft 'Added by Lydia 2022/06/02
                '    .Selection.TypeText Text:="入　帳:"  'Modified by Lydia 2022/06/02 "實　收"=>"入　帳"
               '     .Selection.MoveRight Unit:=wdCell, Count:=1
               '     .Selection.ParagraphFormat.Alignment = wdAlignParagraphRight
               '     .Selection.TypeText Text:=Format(m_Head(2), "##0.00")  'If iR < 3 Or iR > 4 Then .Selection.TypeText text:=Format(m_Head(iR), "##0.00")
                '    'Modified by Lydia 2022/06/02 入帳／應收:
               '     '.Selection.MoveRight Unit:=wdCell, Count:=3
               '     ''Modify By Sindy 2020/9/4 不顯示簽收合計
               '     '.Selection.TypeText Text:="" '"簽收合計:"
               '     '.Selection.MoveRight Unit:=wdCell, Count:=1
               '     '.Selection.ParagraphFormat.Alignment = wdAlignParagraphRight
               '     ''Modify By Sindy 2020/9/4 不顯示簽收合計
               '     '.Selection.TypeText Text:="" 'Format(m_Head(5), "##0.00") ' If iR < 3 Or iR > 4 Then .Selection.TypeText text:=Format(m_Head(iR), "##0.00")
               '     '.Selection.MoveRight Unit:=wdCell, Count:=1
               '     .Selection.MoveRight Unit:=wdCell, Count:=2
               '     .Selection.ParagraphFormat.Alignment = wdAlignParagraphLeft
               '     .Selection.Font.Bold = True
               '     .Selection.TypeText Text:="入帳／應收:"
               '     .Selection.MoveRight Unit:=wdCell, Count:=1
               '     .Selection.ParagraphFormat.Alignment = wdAlignParagraphRight
               '     .Selection.TypeText Text:=Format(Val(m_Head(2)) / Val(m_Head(1)), "###0.00%")
               '     .Selection.MoveRight Unit:=wdCell, Count:=1
               '     'end 2022/06/02
               ''第三列
               'ElseIf iR = 3 Then
               '     '.Selection.Font.Bold = True 'Mark by Lydia 2022/06/02
               '     'Modified by Lydia 2022/06/02
               '     '.Selection.TypeText Text:="實　收:"
               '     .Selection.ParagraphFormat.Alignment = wdAlignParagraphLeft
               '     .Selection.TypeText Text:="收　款:"
               '     .Selection.MoveRight Unit:=wdCell, Count:=1
               '     .Selection.ParagraphFormat.Alignment = wdAlignParagraphRight
               '     'Modified by Lydia 2022/06/02
               '     ' '除以零
               '     ' If Val(m_Head(1)) = 0 Then
               '     '    .Selection.TypeText Text:=Format(0, "###0.00%")
               '     ' Else
               '     '    .Selection.TypeText Text:=Format(Val(m_Head(2)) / Val(m_Head(1)), "###0.00%")
               '     ' End If
               '     '.Selection.MoveRight Unit:=wdCell, Count:=5 '跳離統計範圍
               '     .Selection.TypeText Text:=Format(m_Head(3), "##0.00")
               '     .Selection.MoveRight Unit:=wdCell, Count:=2
               '     .Selection.Font.Bold = True
               '     .Selection.ParagraphFormat.Alignment = wdAlignParagraphLeft
               '     .Selection.TypeText Text:="收款／應收:"
               '     .Selection.MoveRight Unit:=wdCell, Count:=1
               '     .Selection.ParagraphFormat.Alignment = wdAlignParagraphRight
               '     .Selection.TypeText Text:=Format(Val(m_Head(3)) / Val(m_Head(1)), "###0.00%")
               '     .Selection.MoveRight Unit:=wdCell, Count:=1
               '     'end 2022/06/02
               ElseIf iR = 2 Then '第二列
                    .Selection.ParagraphFormat.Alignment = wdAlignParagraphLeft
                    .Selection.TypeText Text:="本月總收文: "
                    .Selection.MoveRight Unit:=wdCell, Count:=1
                    .Selection.ParagraphFormat.Alignment = wdAlignParagraphRight
                    If iCall = 1 Then
                       .Selection.TypeText Text:=Format(m_Head(5), "##0.00")
                    Else
                       .Selection.TypeText Text:=Format(m_Head(4), "##0.00")
                    End If
                    .Selection.MoveRight Unit:=wdCell, Count:=2
                    .Selection.ParagraphFormat.Alignment = wdAlignParagraphLeft
                    .Selection.Font.Bold = True
                    .Selection.TypeText Text:="總收文／應收: "
                    .Selection.MoveRight Unit:=wdCell, Count:=1
                    .Selection.ParagraphFormat.Alignment = wdAlignParagraphRight
                    'Added by Lydia 2024/04/09 月目標尚未建立，直接帶出0 (4/6)
                    If Val(m_Head(1)) = 0 Then
                        .Selection.TypeText Text:="0"
                    Else
                    'end 2024/04/09
                       If iCall = 1 Then
                         .Selection.TypeText Text:=Format(Val(m_Head(5)) / Val(m_Head(1)), "###0.00%")
                       Else
                         .Selection.TypeText Text:=Format(Val(m_Head(4)) / Val(m_Head(1)), "###0.00%")
                       End If
                    End If
                    .Selection.MoveRight Unit:=wdCell, Count:=1
               '第三列
               ElseIf iR = 3 Then
                  If iCall = 1 Then '當期
                     .Selection.ParagraphFormat.Alignment = wdAlignParagraphLeft
                     .Selection.TypeText Text:="本月不含ACS累計收文: "
                     .Selection.MoveRight Unit:=wdCell, Count:=1
                     .Selection.ParagraphFormat.Alignment = wdAlignParagraphRight
                     .Selection.TypeText Text:=Format(m_Head(6), "##0.00")
                     .Selection.MoveRight Unit:=wdCell, Count:=2
                     .Selection.ParagraphFormat.Alignment = wdAlignParagraphLeft
                     .Selection.TypeText Text:="本月ACS累計收文: "
                     .Selection.MoveRight Unit:=wdCell, Count:=1
                     .Selection.ParagraphFormat.Alignment = wdAlignParagraphRight
                     .Selection.TypeText Text:=Format(m_Head(7), "##0.00")
                     .Selection.MoveRight Unit:=wdCell, Count:=1
                  Else
                     .Selection.ParagraphFormat.Alignment = wdAlignParagraphLeft
                     .Selection.TypeText Text:="入　帳:"
                     .Selection.MoveRight Unit:=wdCell, Count:=1
                     .Selection.ParagraphFormat.Alignment = wdAlignParagraphRight
                     .Selection.TypeText Text:=Format(m_Head(2), "##0.00")
                     .Selection.MoveRight Unit:=wdCell, Count:=2
                     .Selection.ParagraphFormat.Alignment = wdAlignParagraphLeft
                     .Selection.Font.Bold = True
                     .Selection.TypeText Text:="入帳／應收:"
                     .Selection.MoveRight Unit:=wdCell, Count:=1
                     .Selection.ParagraphFormat.Alignment = wdAlignParagraphRight
                     'Added by Lydia 2024/04/09 月目標尚未建立，直接帶出0 (4/6)
                     If Val(m_Head(1)) = 0 Then
                        .Selection.TypeText Text:="0"
                     Else
                     'end 2024/04/09
                        .Selection.TypeText Text:=Format(Val(m_Head(2)) / Val(m_Head(1)), "###0.00%")
                     End If
                     .Selection.MoveRight Unit:=wdCell, Count:=1
                  End If
               '第四列
               ElseIf iR = 4 Then
                  If iCall = 1 Then '當期
                     .Selection.ParagraphFormat.Alignment = wdAlignParagraphLeft
                     .Selection.TypeText Text:="入　帳:"
                     .Selection.MoveRight Unit:=wdCell, Count:=1
                     .Selection.ParagraphFormat.Alignment = wdAlignParagraphRight
                     .Selection.TypeText Text:=Format(m_Head(2), "##0.00")
                     .Selection.MoveRight Unit:=wdCell, Count:=2
                     .Selection.ParagraphFormat.Alignment = wdAlignParagraphLeft
                     .Selection.Font.Bold = True
                     .Selection.TypeText Text:="入帳／應收:"
                     .Selection.MoveRight Unit:=wdCell, Count:=1
                     .Selection.ParagraphFormat.Alignment = wdAlignParagraphRight
                     'Added by Lydia 2024/04/09 月目標尚未建立，直接帶出0 (4/6)
                     If Val(m_Head(1)) = 0 Then
                        .Selection.TypeText Text:="0"
                     Else
                     'end 2024/04/09
                        .Selection.TypeText Text:=Format(Val(m_Head(2)) / Val(m_Head(1)), "###0.00%")
                     End If
                     .Selection.MoveRight Unit:=wdCell, Count:=1
                  Else
                     .Selection.ParagraphFormat.Alignment = wdAlignParagraphLeft
                     .Selection.TypeText Text:="收　款:"
                     .Selection.MoveRight Unit:=wdCell, Count:=1
                     .Selection.ParagraphFormat.Alignment = wdAlignParagraphRight
                     .Selection.TypeText Text:=Format(m_Head(3), "##0.00")
                     .Selection.MoveRight Unit:=wdCell, Count:=2
                     .Selection.Font.Bold = True
                     .Selection.ParagraphFormat.Alignment = wdAlignParagraphLeft
                     .Selection.TypeText Text:="收款／應收:"
                     .Selection.MoveRight Unit:=wdCell, Count:=1
                     .Selection.ParagraphFormat.Alignment = wdAlignParagraphRight
                     'Added by Lydia 2024/04/09 月目標尚未建立，直接帶出0 (4/6)
                     If Val(m_Head(1)) = 0 Then
                        .Selection.TypeText Text:="0"
                     Else
                     'end 2024/04/09
                        .Selection.TypeText Text:=Format(Val(m_Head(3)) / Val(m_Head(1)), "###0.00%")
                     End If
                     .Selection.MoveRight Unit:=wdCell, Count:=1
                  End If
               '第五列
               ElseIf iR = 5 Then '當期比上一期多一列
                     .Selection.ParagraphFormat.Alignment = wdAlignParagraphLeft
                     .Selection.TypeText Text:="收　款:"
                     .Selection.MoveRight Unit:=wdCell, Count:=1
                     .Selection.ParagraphFormat.Alignment = wdAlignParagraphRight
                     .Selection.TypeText Text:=Format(m_Head(3), "##0.00")
                     .Selection.MoveRight Unit:=wdCell, Count:=2
                     .Selection.Font.Bold = True
                     .Selection.ParagraphFormat.Alignment = wdAlignParagraphLeft
                     .Selection.TypeText Text:="收款／應收:"
                     .Selection.MoveRight Unit:=wdCell, Count:=1
                     .Selection.ParagraphFormat.Alignment = wdAlignParagraphRight
                     'Added by Lydia 2024/04/09 月目標尚未建立，直接帶出0 (4/6)
                     If Val(m_Head(1)) = 0 Then
                        .Selection.TypeText Text:="0"
                     Else
                     'end 2024/04/09
                        .Selection.TypeText Text:=Format(Val(m_Head(3)) / Val(m_Head(1)), "###0.00%")
                     End If
                     .Selection.MoveRight Unit:=wdCell, Count:=1
               'end 2023/06/07
               End If
          Next iR
'---------------------------------
          .Selection.InsertRows 'Added by Lydia 2020/02/15
          .Selection.MoveDown Unit:=wdLine, Count:=1
          .Selection.SelectRow
          .Selection.Cells.Merge
          'Modified by Lydia 2016/08/18 顯示每月工作天和今天為第x天
          '.Selection.InsertRows 2
          '.Selection.Collapse Direction:=wdCollapseEnd
          'Modified by Lydia 2020/02/18
          '.Selection.InsertRows 3
          .Selection.InsertRows
          strA1 = "本月工作天 " & stWorkDays & " 天" & String(15, "　") & "今天為第 " & stWorkDay & " 工作天"
          'Remove by Lydia 2020/02/18
          '.Selection.Collapse Direction:=wdCollapseStart
          '.Selection.MoveDown Unit:=wdLine, Count:=1
          'end 2020/02/18
          .Selection.TypeText Text:=strA1
          .Selection.MoveDown Unit:=wdLine, Count:=1
          'end 2016/08/18
          
          .Selection.Font.Bold = False
          '設定格線
            With .Selection.Cells(1)
               With .Borders(wdBorderLeft)
                    .LineStyle = wdLineStyleSingle
                    .LineWidth = wdLineWidth100pt
                    .ColorIndex = wdAuto
                End With
                With .Borders(wdBorderRight)
                    .LineStyle = wdLineStyleSingle
                    .LineWidth = wdLineWidth100pt
                    .ColorIndex = wdAuto
                End With
                With .Borders(wdBorderTop)
                    .LineStyle = wdLineStyleSingle
                    .LineWidth = wdLineWidth100pt
                    .ColorIndex = wdAuto
                End With
                With .Borders(wdBorderBottom)
                    .LineStyle = wdLineStyleSingle
                    .LineWidth = wdLineWidth100pt
                    .ColorIndex = wdAuto
                End With
            End With
          
          .Selection.Cells.Split NumRows:=1, NumColumns:=mColNum, MergeBeforeSplit:=False
          'Modified by Lydia 2023/12/28 上一行列為六個區別，下一行列為五個區別，並請協助台北所列第一個
          '.Selection.Cells(1).SetWidth ColumnWidth:=.CentimetersToPoints(2), RulerStyle:=wdAdjustProportional
          '.Selection.Cells(2).SetWidth ColumnWidth:=.CentimetersToPoints(3), RulerStyle:=wdAdjustProportional
          '.Selection.Cells(3).SetWidth ColumnWidth:=.CentimetersToPoints(3), RulerStyle:=wdAdjustProportional
          '.Selection.Cells(4).SetWidth ColumnWidth:=.CentimetersToPoints(3), RulerStyle:=wdAdjustProportional
          '.Selection.Cells(5).SetWidth ColumnWidth:=.CentimetersToPoints(3), RulerStyle:=wdAdjustProportional
          '.Selection.Cells(6).SetWidth ColumnWidth:=.CentimetersToPoints(3), RulerStyle:=wdAdjustProportional
          .Selection.Cells(1).SetWidth ColumnWidth:=.CentimetersToPoints(2), RulerStyle:=wdAdjustProportional
          .Selection.Cells(2).SetWidth ColumnWidth:=.CentimetersToPoints(2.5), RulerStyle:=wdAdjustProportional
          .Selection.Cells(3).SetWidth ColumnWidth:=.CentimetersToPoints(2.5), RulerStyle:=wdAdjustProportional
          .Selection.Cells(4).SetWidth ColumnWidth:=.CentimetersToPoints(2.5), RulerStyle:=wdAdjustProportional
          .Selection.Cells(5).SetWidth ColumnWidth:=.CentimetersToPoints(2.5), RulerStyle:=wdAdjustProportional
          .Selection.Cells(6).SetWidth ColumnWidth:=.CentimetersToPoints(2.5), RulerStyle:=wdAdjustProportional
          .Selection.Cells(7).SetWidth ColumnWidth:=.CentimetersToPoints(2.5), RulerStyle:=wdAdjustProportional
          'end 2023/12/28
   
          .Selection.SelectRow
          .Selection.Cells.VerticalAlignment = wdAlignVerticalCenter
          .Selection.Font.Size = 11 'Added by Lydia 2023/12/28
            '讀明細資料
            For iR = 1 To UBound(m_Subject, 1)
                '分成北所和分所
                'Modified by Lydia 2025/01/20 先加上,3,4
                If InStr("1,2,3,4", m_Subject(iR, 1)) > 0 And Len(m_Subject(iR, 1)) > 0 Then
                  .Selection.MoveRight Unit:=wdCell, Count:=mColNum - 1
                   If m_Subject(iR, 1) > "1" Then
                      .Selection.SelectRow
                      .Selection.InsertRows
                      .Selection.Cells.Merge
                      .Selection.MoveRight Unit:=wdCell, Count:=1
                   End If
                  .Selection.InsertRows mRowNum
                  .Selection.Collapse Direction:=wdCollapseStart
                  iCurCol = 1 'Added by Morgan 2023/7/19

                Else
                   '無點數或無資料,不顯示資料
                   'Modified by Lydia 2022/06/07
                   'If Val(m_Subject(iR, 2)) + Val(m_Subject(iR, 3)) + Val(m_Subject(iR, 4)) =0 Then
                   'Modified by Lydia 2023/06/07 + 6~8
                   'If Val(m_Subject(iR, 2)) + Val(m_Subject(iR, 3)) + Val(m_Subject(iR, 4)) + Val(m_Subject(iR, 5)) = 0 Then
                   If iCall = 1 Then
                      strExc(0) = Val(m_Subject(iR, 2)) + Val(m_Subject(iR, 3)) + Val(m_Subject(iR, 4)) + Val(m_Subject(iR, 5)) + Val(m_Subject(iR, 6)) + Val(m_Subject(iR, 7)) + Val(m_Subject(iR, 8))
                   Else
                      strExc(0) = Val(m_Subject(iR, 2)) + Val(m_Subject(iR, 3)) + Val(m_Subject(iR, 4)) + Val(m_Subject(iR, 5))
                   End If
                   If Val(strExc(0)) = 0 Then
                   'end 2023/06/07
                       GoTo SkipWrite
                   Else
                       '移到下一欄
                      .Selection.MoveRight Unit:=wdCell, Count:=1
                      .Selection.MoveUp Unit:=wdLine, Count:=mRowNum - 1
                      
                      'Modified by Morgan 2023/7/17 word2010會跳錯行,增加選擇指定行
                      iCurCol = iCurCol + 1
                      .Selection.SelectRow
                     .Selection.Cells(iCurCol).Select
                      'end 2023/7/17
                   End If
                End If
                
                'Modified by Lydia 2025/01/20 先加上,3,4
                If InStr("1,2,3,4", m_Subject(iR, 1)) > 0 Then
                    .Selection.ParagraphFormat.Alignment = wdAlignParagraphCenter
                    'Modified by Lydia 2017/10/12 統一名稱為業務區
                    '.Selection.TypeText text:=IIf(m_Subject(iR, 1) = "1", "北所", "分所")
                    .Selection.TypeText Text:="業務區"
                    .Selection.MoveDown Unit:=wdLine, Count:=1
                    .Selection.ParagraphFormat.Alignment = wdAlignParagraphCenter
                    .Selection.TypeText Text:=m_Subject(iR, 2) '應收
                    .Selection.MoveDown Unit:=wdLine, Count:=1
                    .Selection.ParagraphFormat.Alignment = wdAlignParagraphCenter
                    .Selection.TypeText Text:=m_Subject(iR, 3) 'Memo by Lydia 2022/06/02 改「入帳」 '實收
                    'Modify By Sindy 2020/9/4 不顯示已簽約
                    'Modify By Sindy 2020/10/5 +本月累計收文
                    .Selection.MoveDown Unit:=wdLine, Count:=1
                    .Selection.ParagraphFormat.Alignment = wdAlignParagraphCenter
                    .Selection.TypeText Text:=m_Subject(iR, 4)  'Memo by Lydia 2022/06/02 改「收款」 '本月累計收文
                    'Added b yLydia 2022/06/02 本月累計收文 'Memo by Lydia 2023/06/07 當期改「未收款」，上一期改「總收文」
                    .Selection.MoveDown Unit:=wdLine, Count:=1
                    .Selection.ParagraphFormat.Alignment = wdAlignParagraphCenter
                    .Selection.TypeText Text:=m_Subject(iR, 5)
                    'end 2022/06/02
                    'Added by Lydia 2023/06/07 改版面：當期
                    If iCall = 1 Then
                       '總收文
                       .Selection.MoveDown Unit:=wdLine, Count:=1
                       .Selection.ParagraphFormat.Alignment = wdAlignParagraphCenter
                       .Selection.TypeText Text:=m_Subject(iR, 6)
                       '不含ACS收文
                       .Selection.MoveDown Unit:=wdLine, Count:=1
                       .Selection.ParagraphFormat.Alignment = wdAlignParagraphCenter
                       .Selection.TypeText Text:=m_Subject(iR, 7)
                       'ACS收文
                       .Selection.MoveDown Unit:=wdLine, Count:=1
                       .Selection.ParagraphFormat.Alignment = wdAlignParagraphCenter
                       .Selection.TypeText Text:=m_Subject(iR, 8)
                    End If
                    'end 2023/06/07
                Else
                    .Selection.ParagraphFormat.Alignment = wdAlignParagraphCenter
                    .Selection.TypeText Text:=m_Subject(iR, 1) '部門代號
                    .Selection.MoveRight Unit:=wdCell, Count:=mColNum
                    .Selection.ParagraphFormat.Alignment = wdAlignParagraphRight
                    .Selection.TypeText Text:=m_Subject(iR, 2) '應收
                    .Selection.MoveRight Unit:=wdCell, Count:=mColNum
                    .Selection.ParagraphFormat.Alignment = wdAlignParagraphRight
                    .Selection.TypeText Text:=m_Subject(iR, 3) 'Memo by Lydia 2022/06/02 改「入帳」 '實收
                    'Modify By Sindy 2020/9/4 不顯示已簽約
                    'Modify By Sindy 2020/10/5 +本月累計收文
                    .Selection.MoveRight Unit:=wdCell, Count:=mColNum
                    .Selection.ParagraphFormat.Alignment = wdAlignParagraphRight
                    .Selection.TypeText Text:=m_Subject(iR, 4) 'Memo by Lydia 2022/06/02 改「收款」 '本月累計收文
                    'Added b yLydia 2022/06/02 本月累計收文 'Memo by Lydia 2023/06/07 當期改「未收款」，上一期改「總收文」
                    .Selection.MoveRight Unit:=wdCell, Count:=mColNum
                    .Selection.ParagraphFormat.Alignment = wdAlignParagraphRight
                    .Selection.TypeText Text:=m_Subject(iR, 5)
                    'end 2022/06/02
                    'Added by Lydia 2023/06/07 改版面：當期
                    If iCall = 1 Then
                       '總收文
                       .Selection.MoveRight Unit:=wdCell, Count:=mColNum
                       .Selection.ParagraphFormat.Alignment = wdAlignParagraphRight
                       .Selection.TypeText Text:=m_Subject(iR, 6)
                       '不含ACS收文
                       .Selection.MoveRight Unit:=wdCell, Count:=mColNum
                       .Selection.ParagraphFormat.Alignment = wdAlignParagraphRight
                       .Selection.TypeText Text:=m_Subject(iR, 7)
                       'ACS收文
                       .Selection.MoveRight Unit:=wdCell, Count:=mColNum
                       .Selection.ParagraphFormat.Alignment = wdAlignParagraphRight
                       .Selection.TypeText Text:=m_Subject(iR, 8)
                    End If
                    'end 2023/06/07
                End If
SkipWrite:
            Next iR
            .Selection.MoveRight Unit:=wdCell, Count:=mColNum - 1
            .Selection.SelectRow
            .Selection.Cells.Merge
            '.Selection.Cells.Delete 'Added by Lydia 2020/02/18 刪除明細表最下方空白格，要注意部門數量
            
            'Modified by Lydia 2017/02/21 上期輸入完後,才存檔
            '.ActiveDocument.SaveAs App.path & TextPath & TFName & ".doc"
            If iCall = 2 Then
                'Added by Lydia 2020/02/18
                .Selection.Cells.Delete '刪除明細表最下方空白格，要注意部門數量
                .Selection.TypeParagraph
                .Selection.TypeText Text:="工作報告"
                .Selection.TypeParagraph
                .Selection.TypeParagraph
                .Selection.ParagraphFormat.Alignment = wdAlignParagraphRight
                'Modified by Lydia 2022/05/23 改成變數取得
                '.Selection.TypeText Text:="簡金泉"
                .Selection.TypeText Text:=PUB_ReadUserData(Pub_GetSpecMan("全所智權部主管"))
                'end 2020/02/18
                .ActiveDocument.SaveAs App.path & TextPath & TFName & ".doc"
            End If
      End With
      'Modified by Lydia 2017/02/21
      'g_WordAp.Quit
      If iCall = 2 Then g_WordAp.Quit
      
      'cnnConnection.CommitTrans 'Move by Lydia 2017/02/21 移到上面
      'Modified by Lydia 2015/08/03 九月以前密件副本給Lydia核對資料是否一致
      'SendMAPIMail "77027;94007", TFName, vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, App.path & TextPath & TFName & ".doc"

      'If strSrvDate(1) < "20150901" Then strBC = "A3034" 'Mark by Lydia 2017/09/19
      'Added by Lydia 2015/08/17 加發69010蘇玉峰,一樣是正本收件者
      'Modified by Lydia 2015/08/31 不發給案件代理人
      'SendMAPIMail "77027;94007;69010", TFName, vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, App.path & TextPath & TFName & ".doc", , , , strBC
      'Modified by Lydia 2017/02/21
      'SendMAPIMail "77027;94007;69010", TFName, vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, App.path & TextPath & TFName & ".doc", , True, , strBC
      'Modified by Lydia 2019/07/11 秀玲: 先不用通知蘇特助69010
      'If iCall = 2 Then SendMAPIMail "77027;94007;69010", TFName, vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, App.path & TextPath & TFName & ".doc", , True, , strBC
      'Modified by Lydia 2019/12/05 秀玲:加入69005簡金泉
      'Modified by Lydia 2022/05/03 簡協理69005改為抓系統特殊設定「全所智權部主管」
      'If iCall = 2 Then SendMAPIMail "77027;94007;69005", TFName, vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, App.path & TextPath & TFName & ".doc", , True, , strBC
      If iCall = 2 Then SendMAPIMail "77027;94007;" & Pub_GetSpecMan("全所智權部主管"), TFName, vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, App.path & TextPath & TFName & ".doc", , True, , strBC
            
End If 'stWorkday
Next iCall 'Added by Lydia 2017/02/21

   'Added by Lydia 2017/09/19 判斷系統日的日期若<=5時，再跑一份至前一個月月底的資料。
   If Val(Right(strSrvDate(1), 2)) <= 5 And bolAgain = False Then
      bolAgain = True
      GoTo JumpRunAgain
   End If
   'end 2017/09/19
   
   Exit Sub
   
ErrHnd64:
   If Err.Number <> 0 Then
     'Modified by Lydia 2015/08/10
     ' MsgBox Err.Description, vbCritical
     'Added by Lydia 2020/01/13 先存檔
     If TypeName(g_WordAp) = "Application" Then
         g_WordAp.ActiveDocument.SaveAs App.path & TextPath & TFName & ".doc"
         g_WordAp.Quit
     End If
        
     WLog "決策會工作報告-智權部目標及達成統計:" & Err.Description
      'cnnConnection.RollbackTrans 'Remove by Lydia 2020/01/13 已無Update Table
   End If
End Sub

''Remove by Lydia 2015/09/15 已正式執行,保留程式碼供日後查詢
''Added by Lydia 2015/08/11
''P大陸發明案公開期限之控管 ,新增下一程序999,有關聯之香港案的標準記錄請求期限也要更新
'Private Sub StrMenu63Insert()
'   Dim rsQ As New ADODB.Recordset
'   Dim strQ1 As String, strQ2 As String, strU3 As String
'   Dim ff63 As Integer, TFName As String
'   Dim strTemp(0 To 3) As String
'   Dim tmpCp06 As String
'   Dim aP(1 To 4) As String 'Added by Lydia 2015/09/15
'   Dim bolCan As Boolean
'
'   TFName = "P大陸發明案公開期限之控管"
'On Error GoTo ErrHandle63
'
'    strQ1 = "select pa01,pa02,pa03,pa04,pa10 " & _
'            "from patent,caseprogress where pa01='P' and pa09='020' and pa08='1' and pa23='1' and pa16||pa57||pa12||pa21||pa108||pa136 is null " & _
'            "and pa01=cp01(+) and pa02=cp02(+) and pa03=cp03(+) and pa04=cp04(+) and cp10 in (" & NewCasePtyList & ") "
'    strQ1 = strQ1 & " order by pa10"
'    If rsQ.State <> adStateClosed Then rsQ.Close
'
'        Set rsQ = New ADODB.Recordset
'        rsQ.CursorLocation = adUseClient
'        rsQ.Open strQ1, cnnConnection, adOpenStatic, adLockReadOnly
'        With rsQ
'            If .RecordCount > 0 Then
'               cnnConnection.BeginTrans
'                 strSql = " delete from nextprogress where np01 in (select od01 from openldate) and np07='999'"
'                 cnnConnection.Execute strSql, intI
'
'                 strSql = " delete from openldate "
'                 cnnConnection.Execute strSql, intI
'                .MoveFirst
'                Do While Not .EOF
'                   If PUB_GetOpenLimit020(.Fields("pa01"), .Fields("pa02"), .Fields("pa03"), .Fields("pa04"), strQ1, strQ2) Then
'                      'Added by Lydia 2015/09/15
'                      aP(1) = .Fields("pa01"): aP(2) = .Fields("pa02")
'                      aP(3) = .Fields("pa03"): aP(4) = .Fields("pa04")
'                      If Len(strQ1) > 0 Then
'                         strExc(1) = "select max(c2.cp05) mdate,c2.cp65 muser,c1.cp05,c1.cp09,c1.cp10,c1.cp12,np01,np07,cm01,cm02,cm03,cm04 " & _
'                                     "from caseprogress c1,nextprogress,casemap,caseprogress c2 " & _
'                                     "where c1.cp01='" & .Fields("pa01") & "' and c1.cp02='" & .Fields("pa02") & "' and c1.cp03='" & .Fields("pa03") & "' and c1.cp04='" & .Fields("pa04") & "' " & _
'                                     "and c1.cp57 is null and c1.cp01=np02(+) and c1.cp02=np03(+) and c1.cp03=np04(+) and c1.cp04=np05(+) and c1.cp10 in (" & NewCasePtyList & ") and c1.cp09=np01(+) and np07(+)='999' " & _
'                                     "and c1.cp01=cm05(+) and c1.cp02=cm06(+) and c1.cp03=cm07(+) and c1.cp04=cm08(+) and cm10(+)='4' " & _
'                                     "and c1.cp01=c2.cp01(+) and c1.cp02=c2.cp02(+) and c1.cp03=c2.cp03(+) and c1.cp04=c2.cp04(+) and c2.cp10='1101' " & _
'                                     "group by c2.cp65,c1.cp05,c1.cp09,c1.cp10,c1.cp12,np01,np07,cm01,cm02,cm03,cm04 "
'                         intI = 1
'                         Set RsTemp = ClsLawReadRstMsg(intI, strExc(1))
'                         If intI = 1 Then
'                            'Modified by Lydia 2015/08/27 所限(工作天)=法限
'                            tmpCp06 = PUB_GetWorkDay1(strQ1, True)
'                            bolCan = PUB_ChkNPExist(aP, "999", 1) 'Added by Lydia 2015/09/15
'                            '新增下一程序999
'                            'Modified by Lydia 2015/09/15 是否有下一程序999
'                            If IsNull(RsTemp.Fields("np01")) And bolCan = False Then
'                               strSql = "INSERT INTO NEXTPROGRESS(NP01,NP02,NP03,NP04,NP05,NP07,NP08,NP09,NP10,NP15,NP22)" & _
'                                  " SELECT '" & RsTemp.Fields("cp09") & "','" & .Fields("pa01") & "','" & .Fields("pa02") & "','" & .Fields("pa03") & "','" & .Fields("pa04") & "'" & _
'                                  ",'999'," & tmpCp06 & "," & strQ1 & ",'" & RsTemp.Fields("muser") & "'" & _
'                                  ",'" & strQ2 & "',NP22 FROM (SELECT MAX(NP22)+1 NP22 FROM NEXTPROGRESS) X"
'                               cnnConnection.Execute strSql, intI
'
'                               strSql = "insert into openldate(OD01,OD02,OD03,OD04,OD05) values('" & RsTemp.Fields("cp09") & "','" & tmpCp06 & "','" & strQ1 & "','" & strQ2 & "','" & RsTemp.Fields("muser") & "') "
'                               cnnConnection.Execute strSql, intI
'
'                                 '更新大陸案之公開期限至香港案之標準記錄請求的法定期限;
'                                 If "" & RsTemp("cm01") <> "" Then
''                                    'Modified by Lydia 2015/08/27 本所期限=法定期限－1個月又5天
''                                    tmpCp06 = PUB_GetWorkDay1(CompDate(2, -5, CompDate(1, -1, strQ1)), True)
''                                    'FMP期限抓設定
''                                    strExc(2) = "":
''                                    If Left(RsTemp.Fields("cp12"), 1) = "F" Then
''                                      strExc(2) = PUB_GetDeadLine(RsTemp.Fields("cp05"), strQ1, 2)
''                                      If strExc(2) = "" Then strExc(2) = strQ1
''                                      tmpCp06 = strExc(2)
''                                    End If
''                                    strSql = "UPDATE caseprogress SET CP06=" & tmpCp06 & ",CP07=" & strQ1 & " WHERE cp10='110' " & _
''                                             "AND CP01='" & RsTemp("cm01") & "' AND CP02='" & RsTemp("cm02") & "' AND CP03='" & RsTemp("cm03") & "' AND CP04='" & RsTemp("cm04") & "' "
''                                    cnnConnection.Execute strSql, intI
'                                     'Modified by Lydia 2015/09/15 用共用模組更新香港案的法定期限
'                                     If Left(RsTemp.Fields("cp12"), 1) = "F" Then
'                                        Call PUB_UpdCP07by020(aP, True, "4")
'                                     Else
'                                        Call PUB_UpdCP07by020(aP, False, "4")
'                                     End If
'                                 End If
'                            End If
'                         End If
'                      End If
'                   End If
'                  .MoveNext
'                Loop
'               cnnConnection.CommitTrans
'            End If
'        End With
'
'ErrHandle63:
'   If Err.Number <> 0 Then
'      WLog TFName & "新增下一程序999:" & Err.Description
'   End If
'   Set rsQ = Nothing
'End Sub

'Add By Sindy 2015/8/3 FCT審查報告已逾承辦期限
Private Sub StrMenu65()
   Dim strSql As String
   Dim ff As Integer
   Dim TempFileName As String, strTemp(10) As String
   Dim strEmp As String, strToCC As String
   Dim strDate As String
   
On Error GoTo ErrHandle
   
   strDate = CompWorkDay(2, strSrvDate(1), 1) '前1個工作天
   'Modified by Lydia 2016/09/14 CP57 is null AND CP27 is null => CP158=0 AND CP159=0
   strSql = "SELECT cp01||'-'||cp02||'-'||cp03||'-'||cp04,sqldatet(cp05),sqldatet(cp48),sqldatet(cp06),sqldatet(cp07),cp64,cp14,st02,st52,st53" & _
            " From CASEPROGRESS, TradeMark, staff" & _
            " WHERE CP01='FCT' AND CP10='1201'" & _
            " AND CP158=0 AND CP159=0" & _
            " AND TM01(+)=CP01 AND TM02(+)=CP02 AND TM03(+)=CP03 AND TM04(+)=CP04 AND TM29 IS NULL" & _
            " AND CP48=" & strDate & " AND CP14=ST01(+)" & _
            " order by cp14,cp01,cp02,cp03,cp04 asc"
   If Rs.State <> adStateClosed Then Rs.Close
   Set Rs = New ADODB.Recordset
   Rs.CursorLocation = adUseClient
   Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   With Rs
      If .RecordCount > 0 Then
         .MoveFirst
         Do While Not .EOF
            If TempFileName <> "" And strEmp <> .Fields("cp14") Then
               Close ff
               SendMAPIMail strEmp, "審查報告已逾承辦期限，請儘速處理。", "Dear Sirs," & vbCrLf & "　　審查報告已逾承辦期限，請儘速處理。 如附件！" & vbCrLf & vbCrLf & "電腦中心", App.path & TextPath & TempFileName & ".txt", , , strToCC
               TempFileName = ""
            End If
            If TempFileName = "" Then
               'Modified by Lydia 2022/03/29 員工名稱有Unicode => + PUB_UniToBIG5
               TempFileName = PUB_UniToBIG5(.Fields("st02"), "F") & "-FCT案審查報告已逾承辦期限"
               ff = FreeFile
               If ff > 0 Then Close #ff
               ff = FreeFile
               Open App.path & TextPath & TempFileName & ".txt" For Output As ff
               'Added by Lydia 2016/10/19 加報表抬頭
               Print #ff, Space(30) & TempFileName
               Print #ff, ""
               'end 2016/10/19
               Print #ff, "本所案號        來函日    承辦期限  本所期限  法定期限  備註"
               Print #ff, "=============== ========= ========= ========= ========= ============================================================"
            End If
            strTemp(0) = convForm(CheckStr("" & .Fields(0)), 15)
            strTemp(1) = convForm(CheckStr("" & .Fields(1)), 9)
            strTemp(2) = convForm(CheckStr("" & .Fields(2)), 9)
            strTemp(3) = convForm(CheckStr("" & .Fields(3)), 9)
            strTemp(4) = convForm(CheckStr("" & .Fields(4)), 9)
            strTemp(5) = CheckStr("" & .Fields(5))
            strEmp = .Fields("cp14")
            strToCC = IIf("" & .Fields("st52") <> "" And "" & .Fields("st52") <> "68005", .Fields("st52") & ";", "") & IIf("" & .Fields("st53") <> "" And "" & .Fields("st53") <> "68005", .Fields("st53") & ";", "")
            Print #ff, strTemp(0) & " " & strTemp(1) & " " & strTemp(2) & " " & strTemp(3) & " " & strTemp(4) & " " & strTemp(5)
            .MoveNext
         Loop
      End If
      If TempFileName <> "" Then Close ff
   End With
   Rs.Close
   If TempFileName <> "" Then
      SendMAPIMail strEmp, "審查報告已逾承辦期限，請儘速處理。", "Dear Sirs," & vbCrLf & "　　審查報告已逾承辦期限，請儘速處理。 如附件！" & vbCrLf & vbCrLf & "電腦中心", App.path & TextPath & TempFileName & ".txt", , , strToCC
   End If
   
   Exit Sub
   
ErrHandle:
   If Err.Number <> 0 Then
      WLog "外商程序組之系統自動提醒期限:" & Err.Description
   End If
   Set Rs = Nothing
End Sub

'Add by Amy 2015/08/10 '由AutoBatch搬過來
'FCT,T,TB,TC,TD,TF,TM,TR,TS,TT 原每月自動發催審表給承辦人,改每月1日發催審期限<=當月15日的資料,16日發催審期限<=當月月底的資料
Private Sub StrMenu66()
    Dim RsQ As New ADODB.Recordset
    Dim strQ As String, strQ1 As String
    Dim ff14 As Integer
    'Modified by Lydia 2016/05/23 strTemp(11)->12
    Dim strFileN As String, strTemp(12) As String, strDate(1) As String
    Dim Is1705or310 As Boolean
    Dim Txt_Head As Boolean
    Dim strTo As String, strApatch As String
    Dim ii As Integer
    
On Error GoTo ErrHand
    strFileN = Val(Left(strSrvDate(1), 6)) - 191100 & "催審表"
    strApatch = App.path & TextPath & strFileN & ".txt"
    
    If Right(strSrvDate(1), 2) = "01" Then
        strDate(0) = Left(strSrvDate(1), 6) & "01"
        strDate(1) = Left(strSrvDate(1), 6) & "15"
    Else
        strDate(0) = Left(strSrvDate(1), 6) & "16"
        strDate(1) = Left(strSrvDate(1), 6) & "31"
    End If
    'Modified by Lydia 2016/05/23 +備註NP15
    'Modify by Amy 2023/12/04 1201、1202輸來函時會延後原催審期限8個月,不再限制剔除有1201、1202來函之案件,也不再剔除有201、203、301、302未發文的案件,故只抓下一程序有催審期限就發
'    strQ = "Select np01,sqldatet(np08) NP08,NP10,tm01 TM01,tm02 TM02,tm03 TM03,tm04 TM04,tm10 TM10,Nvl(tm15,tm12) TM15,tm23 TM23,Nvl(tm05,Nvl(tm06,tm07)) CaseN,np15 NP15 " & _
'            "From NextProgress,TradeMark Where NP02 in ('TF','T','FCT',' ') And NP02=TM01(+) AND NP03=TM02(+) AND NP04=TM03(+) AND NP05=TM04(+) " & _
'            "And tm29 IS NULL And NP08>=" & strDate(0) & " And NP08<=" & strDate(1) & " And NP07=305 And NP06 Is Null And Not Exists" & _
'            "(Select CP01 From CaseProgress Where CP01=TM01 And CP02=TM02 And CP03=TM03 And CP04=TM04 And (CP10='1202' or cp10='1201') And CP09>'C') "
'    strQ = strQ & " Union All " & _
'            "Select np01,sqldatet(np08) NP0,NP10,sp01 TM01,sp02 TM02,sp03 TM03,sp04 TM04,sp09 TM10,sp11 TM15,sp08 TM23,Nvl(sp05,Nvl(sp06,sp07)) CaseN,np15 NP15 " & _
'            "From NextProgress,ServicePractice Where NP02 in ('TT','TS','TR','TM','TD','TC','TB',' ') And NP02=SP01(+) AND NP03=SP02(+) AND NP04=SP03(+) AND NP05=SP04(+) " & _
'            "And SP29 IS NULL And NP08>=" & strDate(0) & " And NP08<=" & strDate(1) & " And NP07=305 And NP06 Is Null And Not Exists" & _
'            "(Select CP01 From CaseProgress Where CP01=SP01 And CP02=SP02 And CP03=SP03 And CP04=SP04 And (CP10='1202' or cp10='1201') And CP09>'C') "
'    'Modified by Lydia 2016/09/14 (CP27='' OR CP27 Is Null) => CP158=0
'    strQ = strQ & " Union All " & _
'            "Select np01,sqldatet(np08) NP0,NP10,tm01 TM01,tm02 TM02,tm03 TM03,tm04 TM04,tm10 TM10,Nvl(tm15,tm12) TM15,tm23 TM23,Nvl(tm05,Nvl(tm06,tm07)) CaseN,np15 NP15 " & _
'            "From NextProgress,TradeMark Where NP02 in ('TF','T','FCT',' ') And NP02=TM01(+) AND NP03=TM02(+) AND NP04=TM03(+) AND NP05=TM04(+) " & _
'            "And tm29 IS NULL And NP08>=" & strDate(0) & " And NP08<=" & strDate(1) & " And NP07=305 And NP06 Is Null " & _
'            "And Exists(Select CP01 From CaseProgress Where CP01=TM01 And CP02=TM02 And CP03=TM03 And CP04=TM04 And (CP10='1202' or cp10='1201') And CP09>'C') " & _
'            "And Exists(Select CP01 From CaseProgress Where CP01=TM01 And CP02=TM02 And CP03=TM03 And CP04=TM04 And (CP10='203' or cp10='201' or cp10='301' or cp10='302') And CP09<'C' And CP158=0 )"
'    strQ = strQ & " Union All " & _
'            "Select np01,sqldatet(np08) NP0,NP10,sp01 TM01,sp02 TM02,sp03 TM03,sp04 TM04,sp09 TM10,sp11 TM15,sp08 TM23,Nvl(sp05,Nvl(sp06,sp07)) CaseN,np15 NP15 " & _
'            "From NextProgress,ServicePractice Where NP02 in ('TT','TS','TR','TM','TD','TC','TB',' ') And NP02=SP01(+) AND NP03=SP02(+) AND NP04=SP03(+) AND NP05=SP04(+) " & _
'            "And SP29 IS NULL And NP08>=" & strDate(0) & " And NP08<=" & strDate(1) & " And NP07=305 And NP06 Is Null " & _
'            "And Exists(Select CP01 From CaseProgress Where CP01=SP01 And CP02=SP02 And CP03=SP03 And CP04=SP04 And (CP10='1202' or cp10='1201') And CP09>'C') " & _
'            "And Exists(Select CP01 From CaseProgress Where CP01=SP01 And CP02=SP02 And CP03=SP03 And CP04=SP04 And (CP10='203' or cp10='201' or cp10='301' or cp10='302') And CP09<'C' And CP158=0 )"
'
'    strQ = "Select np10,sqldatet(cp27) CP27,NP08,TM15, TM01||'-'||TM02||'-'||TM03||'-'||TM04 CaseNo,CaseN,Nvl(Decode(TM10,'000',cpm03,cpm04),cp10),Nvl(cu04,Nvl(cu05||cu88||cu89||cu90,cu06)),S1.st02,S3.st02," & _
'            "Decode(TM10,'000',cp22,fa04) CP44,Nvl(na03,na04) NationN,NP15,np01 From (" & strQ & "),CaseProgress,Staff S1,Staff S2,Staff S3,CaseProPertyMap,Customer,Nation,Fagent " & _
'            "Where NP01=CP09(+) And CP14=S1.ST01(+) And NP10=S2.ST01(+) And SubStr(S2.ST03,1,2)='P2' And CP13=S3.ST01(+) And CP01=CPM01(+) And CP10=CPM02(+) And TM10=NA01(+) " & _
'            "And SubStr(TM23,1,8)=CU01(+) And Decode(SubStr(TM23,9,1),'','0',SubStr(TM23,9,1))=CU02(+) And SubStr(CP44,1,8)=FA01(+) And Decode(SubStr(CP44,9,1),'','0',SubStr(CP44,9,1))=FA02(+) Order by NP10,CP27,CP10"
   strQ = "Select np01,sqldatet(np08) NP08,NP10,tm01 TM01,tm02 TM02,tm03 TM03,tm04 TM04,tm10 TM10,Nvl(tm15,tm12) TM15,tm23 TM23,Nvl(tm05,Nvl(tm06,tm07)) CaseN,np15 NP15 " & _
            "From NextProgress,TradeMark Where NP02 in ('TF','T','FCT',' ') And NP02=TM01(+) AND NP03=TM02(+) AND NP04=TM03(+) AND NP05=TM04(+) " & _
            "And tm29 IS NULL And NP08>=" & strDate(0) & " And NP08<=" & strDate(1) & " And NP07=305 And NP06 Is Null "
    strQ = strQ & " Union All " & _
            "Select np01,sqldatet(np08) NP0,NP10,sp01 TM01,sp02 TM02,sp03 TM03,sp04 TM04,sp09 TM10,sp11 TM15,sp08 TM23,Nvl(sp05,Nvl(sp06,sp07)) CaseN,np15 NP15 " & _
            "From NextProgress,ServicePractice Where NP02 in ('TT','TS','TR','TM','TD','TC','TB',' ') And NP02=SP01(+) AND NP03=SP02(+) AND NP04=SP03(+) AND NP05=SP04(+) " & _
            "And SP29 IS NULL And NP08>=" & strDate(0) & " And NP08<=" & strDate(1) & " And NP07=305 And NP06 Is Null "
    strQ = "Select np10,sqldatet(cp27) CP27,NP08,TM15, TM01||'-'||TM02||'-'||TM03||'-'||TM04 CaseNo,CaseN,Nvl(Decode(TM10,'000',cpm03,cpm04),cp10),Nvl(cu04,Nvl(cu05||cu88||cu89||cu90,cu06)),S1.st02,S3.st02," & _
            "Decode(TM10,'000',cp22,fa04) CP44,Nvl(na03,na04) NationN,NP15,np01 From (" & strQ & "),CaseProgress,Staff S1,Staff S2,Staff S3,CaseProPertyMap,Customer,Nation,Fagent " & _
            "Where NP01=CP09(+) And CP14=S1.ST01(+) And NP10=S2.ST01(+) And SubStr(S2.ST03,1,2)='P2' And CP13=S3.ST01(+) And CP01=CPM01(+) And CP10=CPM02(+) And TM10=NA01(+) " & _
            "And SubStr(TM23,1,8)=CU01(+) And Decode(SubStr(TM23,9,1),'','0',SubStr(TM23,9,1))=CU02(+) And SubStr(CP44,1,8)=FA01(+) And Decode(SubStr(CP44,9,1),'','0',SubStr(CP44,9,1))=FA02(+) Order by NP10,CP27,CP10"
    RsQ.CursorLocation = adUseClient
    RsQ.Open strQ, cnnConnection, adOpenStatic, adLockReadOnly
    With RsQ
        If .RecordCount > 0 Then
            .MoveFirst
            Do While Not .EOF
                
                If strTemp(0) <> .Fields("np10") Then
                    If strTemp(0) <> "" Then
                        strTo = strTemp(0) '前一筆記錄的收信人
                        If ff14 > 0 Then Close #ff14
                        SendMAPIMail strTo, strFileN, vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, strApatch
                    End If
                    Txt_Head = False
                End If
                If Txt_Head = False Then
                    ff14 = FreeFile
                    Open strApatch For Output As ff14
                    Print #ff14, "                                                                     內商催審函/催審表"
                    Print #ff14, "列印日期：" & ChangeWStringToTString(strSrvDate(1))
                    'Modified by Lydia 2016/05/23 改抬頭
                    'Print #ff14, "發文日     催審期限   申請案號/審定號  本所案號          案件名稱             案件性質 申請人               承辦人   智權人員 是否出名/代理人  申請國家 "
                    'Print #ff14, "========== ========== ================ ================= ==================== ======== ==================== ======== ======== ================ ========== "
                    Print #ff14, "發文日     催審期限   申請案號/審定號  本所案號          案件名稱             案件性質 申請人       承辦人   智權人員 是否出名 申請國家   備註 "
                    Print #ff14, convForm(" ", 118) & "／代理人"
                    Print #ff14, "========== ========== ================ ================= ==================== ======== ============ ======== ======== ======== ========== ===================="
                    Txt_Head = True
                End If
             
                Is1705or310 = False
                'Modified by Lydia 2016/05/23
                'For ii = 1 To 11
                For ii = 1 To 12
                    If ii = 4 Then
                        '本所案號欄位-檢查有無暫緩或取消催審,有顯示△
                        strQ1 = "Select * From CaseProgress Where CP43='" & CheckStr(.Fields("np01")) & "' and cp10 in ('1705','310') "
                        CheckOC2
                        adoRecordset1.CursorLocation = adUseClient
                        adoRecordset1.Open strQ1, cnnConnection, adOpenStatic, adLockReadOnly
                        If adoRecordset1.RecordCount <> 0 And adoRecordset1.RecordCount > 0 Then
                            Is1705or310 = True
                        End If
                        strTemp(ii) = IIf(Is1705or310 = True, "△" & "" & .Fields(ii), "" & .Fields(ii))
                    Else
                        strTemp(ii) = "" & .Fields(ii)
                    End If
                Next ii
                
                strTemp(1) = convForm(CheckStr(strTemp(1)), 10) '發文日
                strTemp(2) = convForm(CheckStr(strTemp(2)), 10) '催審期限
                strTemp(3) = convForm(CheckStr(strTemp(3)), 16) '申請案號/審定號
                strTemp(4) = convForm(CheckStr(strTemp(4)), 17) '本所案號
                strTemp(5) = convForm(CheckStr(strTemp(5)), 20) '案件名稱
                
                strTemp(6) = convForm(CheckStr(strTemp(6)), 8) '案件性質
                'Modified by Lydia 2016/05/23
                'strTemp(7) = convForm(CheckStr(strTemp(7)), 20) '申請人
                strTemp(7) = convForm(CheckStr(strTemp(7)), 12)
                strTemp(8) = convForm(CheckStr(strTemp(8)), 8) '承辦人
                strTemp(9) = convForm(CheckStr(strTemp(9)), 8) '智權人員
                'Modified by Lydia 2016/05/23
                'strTemp(10) = convForm(CheckStr(strTemp(10)), 16) '是否出名/代理人
                strTemp(10) = convForm(CheckStr(strTemp(10)), 8)
                strTemp(11) = convForm(CheckStr(strTemp(11)), 10) '申請國家
                strTemp(12) = CheckStr(strTemp(12)) 'Added by Lydia 2016/05/23 備註
                
                'Modified by Lydia 2016/05/23 + NP15
                Print #ff14, strTemp(1) & " " & strTemp(2) & " " & strTemp(3) & " " & strTemp(4) & " " & strTemp(5) & _
                          " " & strTemp(6) & " " & strTemp(7) & " " & strTemp(8) & " " & strTemp(9) & " " & strTemp(10) & _
                          " " & strTemp(11) & " " & strTemp(12)

                strTemp(0) = .Fields("np10")
                .MoveNext
            Loop
            
            If ff14 > 0 Then
                Close ff14
                strTo = strTemp(0) '最後一筆記錄的收信人
                'Modify by Amy 2022/07/27 +無收件人時發給「程式管理人員」
                If strTo = MsgText(601) Then strTo = Pub_GetSpecMan("程式管理人員")
                SendMAPIMail strTo, strFileN, vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, strApatch
            End If
        End If
    End With
    RsQ.Close
    Exit Sub

ErrHand:
    If Err.Number <> 0 Then
        WLog "每月自動發催審表給承辦人:" & Err.Description
    End If
    Set RsQ = Nothing
End Sub

'Add by Amy 2015/09/15 收文逾三個月未發文商標案件-專業部通知
'每月第1個工作天執行
Private Sub StrMenu67()
    Dim RsQ As New ADODB.Recordset
    Dim strQ As String
    Dim strFileN As String, strApatch As String
    Dim oldCP14 As String, oldSt03 As String, strTo As String
    Dim strSubject1 As String, strSubject2 As String, strContent1 As String, strContent2 As String
    Dim Txt_Head1 As Boolean, Txt_Head2 As Boolean
    Dim F1 As Integer, F2 As Integer
    Dim strTemp(10) As String, strDate(2) As String
    Dim ii As Integer
    Dim strA As String 'Add by Amy 2020/09/15
    
On Error GoTo ErrHand
    strFileN = Val(Left(strSrvDate(1), 6)) - 191100 & "收文逾三個月未發文通知"
    strApatch = App.path & TextPath
    'Add by Amy 2020/08/11 刪除暫存檔
    'Modify by Amy 2020/09/15 沒檔案會錯 原:\.
    If Dir(strApatch & "\*收文逾三個月未發文通知*.txt") <> "" Then
        Kill strApatch & "\*收文逾三個月未發文通知*.txt"
    End If
    '承辦人
    strSubject1 = "收文逾三個月未發文通知，請至系統填寫未發文原因。"
    strContent1 = "請至 承辦人系統->商標處->承辦人作業->未發文案件原因註記 項目中填寫未發文原因！"
    '主管
    strSubject2 = "收文逾三個月未發文之主管通知！"
    strContent2 = "可至 承辦人系統->商標處->承辦人作業->未發文案件原因註記 項目中查看個別資料！"
    
    '刪除當月未發文案件資料
    cnnConnection.Execute "Delete From NotComplete Where nc02=" & Val(Left(strSrvDate(1), 6))
    
    strDate(0) = "19960101"
    strDate(1) = ChangeWDateStringToWString(DateAdd("m", -3, ChangeWStringToWDateString(DBDATE(Left(strSrvDate(1), 6) & "01"))))
    strDate(2) = ChangeWDateStringToWString(DateAdd("m", -1, ChangeWStringToWDateString(DBDATE(Left(strSrvDate(1), 6) & "01")))) 'for 抓前個月資料
    
    'Modify by Amy 2020/09/15 改承辦人為商標處且 無齊備日且無完稿日 或 有會稿日無會完日,其中有一個成立就排除 不寄 mail->寫暫存過濾
    'Modify by Amy 2015/11/02 改left join NotComplete
    'Modified by Lydia 2016/09/14 cp27 is null And cp57 is null => CP158=0 AND CP159=0
    'Modified by Lydia 2017/05/23 排除收款寄證1728
'    strQ = "Select P.st02 as CP14N,S.st02 as CP13N, nvl(cu04,nvl(cu05,cu06)) as Apply,CP01||'-'||CP02||'-'||CP03||'-'||CP04 as CaseNo,SQLDATET2(cp05) as CP05,na03 as Country," & _
'            "CaseName,Nvl(Decode(tm10,'000',CPM03,CPM04),cp10) as CasePropertyName, nc03,nc07,cp14,P.st03,cp09 From Staff P,Staff S,Customer,Nation, CasePropertyMap," & _
'            "(Select cp01,cp02,cp03,cp04,cp05,cp09,cp10,cp12,cp13,cp14, Decode(tm05,null,Decode(sp05,null,Decode( sp06, null,sp07,sp06),sp05),tm05) as CaseName ,nvl(tm10,sp09) as tm10,nvl(tm23,sp08) as tm23,nc03,nc07 " & _
'            "From CaseProgress,TradeMark ,ServicePractice, SystemKind,NotComplete Where CP158=0 AND CP159=0 And (cp108<" & strSrvDate(1) & " Or cp108 is null) And (cp06<" & strSrvDate(1) & " Or cp06 is null) " & _
'            "And cp05+0>=" & strDate(0) & " And cp05+0<=" & strDate(1) & " And Not(cp10 in ('715','716','717','204','205','1728') And (cp06='' Or cp06 is null)) " & _
'            "And cp01=tm01(+) And cp02=tm02(+) And cp03=tm03(+) And cp04=tm04(+) And tm29 is null And tm57 is null And cp01=sp01(+) And cp02=sp02(+) And cp03=sp03(+) And cp04=sp04(+) And sp15 is null And sp61 is null " & _
'            "And cp01=sk01(+) And (sk02=2 or sk02=6) And cp09=nc01(+) And " & Left(strDate(2), 6) & "=nc02(+) ) " & _
'            "Where cp14=P.st01(+) And cp13=S.st01(+) And SubStr(tm23,1,8)=cu01(+) And SubStr(tm23,9,1)=cu02(+) And tm10=na01(+) And cp01=CPM01(+) And cp10=CPM02(+) " & _
'            "Order by P.st03,cp14,cp12,cp13,tm23,cp01,cp02,cp03,cp04,cp05,cp09"
    strA = " From CaseProgress,TradeMark ,ServicePractice, SystemKind,NotComplete " & _
              "Where CP158=0 AND CP159=0 And (cp108<" & strSrvDate(1) & " Or cp108 is null) And (cp06<" & strSrvDate(1) & " Or cp06 is null) " & _
              "And cp05+0>=" & strDate(0) & " And cp05+0<=" & strDate(1) & " And Not(cp10 in ('715','716','717','204','205','1728') And (cp06='' Or cp06 is null)) " & _
              "And cp01=tm01(+) And cp02=tm02(+) And cp03=tm03(+) And cp04=tm04(+) And tm29 is null And tm57 is null And cp01=sp01(+) And cp02=sp02(+) And cp03=sp03(+) And cp04=sp04(+) And sp15 is null And sp61 is null " & _
              "And cp01=sk01(+) And (sk02=2 or sk02=6) And cp09=nc01(+) And " & Left(strDate(2), 6) & "=nc02(+)"
    '新增當月未發文案件資料
    strQ = "Insert Into NotComplete (NC01,NC02) " & _
              "Select cp09," & Val(Left(strSrvDate(1), 6)) & strA
    cnnConnection.Execute strQ
    '寫入暫存檔
    cnnConnection.Execute "Delete From RABD6769 "
    strQ = "Insert Into RABD6769 (R001,R002,R003,R004,R005,R006,R007,R008,R009,R010,R011) " & _
            "Select cp09,Nvl(ep06,0) as ep06,Nvl(ep09,0) as ep09,Nvl(ep07,0) as ep07,Nvl(ep08,0) as ep08, tm23,tm10,SubStr(CaseName,1,20),SubStr(nc03,1,30),SubStr(nc07,1,30),St03 " & _
            "From EngineerProgress,Staff,(" & _
            "Select cp09,cp14,Nvl(tm23,sp08) tm23,Nvl(tm10,sp09) tm10,Decode(tm05,null,Decode(sp05,null,Decode( sp06, null,sp07,sp06),sp05),tm05) as CaseName,nc03,nc07 " & strA & _
            ") Where cp09=ep02(+) And cp14=st01(+) "
    cnnConnection.Execute strQ
    '刪除 承辦人為商標處 無齊備日且無完稿日
    strQ = "Delete From RABD6769 Where SubStr(R011,1,2)='P2' And R002=0 And R003=0 "
    cnnConnection.Execute strQ
    '刪除 承辦人為商標處 有會稿日無會完日
    strQ = "Delete From RABD6769 Where SubStr(R011,1,2)='P2' And R004>0 And R005=0 "
    cnnConnection.Execute strQ
               
    strQ = "Select P.st02 as CP14N,S.st02 as CP13N, nvl(cu04,nvl(cu05,cu06)) as Apply,CP01||'-'||CP02||'-'||CP03||'-'||CP04 as CaseNo,SQLDATET2(cp05) as CP05,na03 as Country," & _
              "R008,Nvl(Decode(R007,'000',CPM03,CPM04),cp10) as CasePropertyName, R009,R010,cp14,P.st03,R001 " & _
            "From RABD6769,CaseProgress,Staff P,Staff S,Customer,Nation, CasePropertyMap " & _
            "Where R001=cp09(+) And cp14=P.st01(+) And cp13=S.st01(+) And SubStr(R006,1,8)=cu01(+) And SubStr(R006,9,1)=cu02(+) And R007=na01(+) And cp01=CPM01(+) And cp10=CPM02(+) " & _
            "Order by P.st03,cp14,cp12,cp13,R006,cp01,cp02,cp03,cp04,cp05,R001"

    RsQ.CursorLocation = adUseClient
    RsQ.Open strQ, cnnConnection, adOpenStatic, adLockReadOnly
    With RsQ
         If .RecordCount > 0 Then
             .MoveFirst
            Do While Not .EOF
                'Mark by Amy 2020/09/15 搬至上面先做
                '新增當月未發文案件資料
                'cnnConnection.Execute "Insert into NotComplete (NC01,NC02) Values('" & .Fields("cp09") & "'," & Val(Left(strSrvDate(1), 6)) & ")"
                
                '產生資料寄信
                If oldCP14 <> "" & .Fields("cp14") Then
                    If oldCP14 <> MsgText(601) Then
                        If F1 > 0 Then Close #F1
                        'Modify by Amy 2016/01/06 檔名+承辦人員編
                        SendMAPIMail oldCP14, strSubject1, vbCrLf & vbCrLf & strContent1 & vbCrLf & vbCrLf, strApatch & strFileN & oldCP14 & ".txt"
                    End If
                    Txt_Head1 = False
                End If
                If Txt_Head1 = False Then
                    F1 = FreeFile
                    Open strApatch & strFileN & "" & .Fields("cp14") & ".txt" For Output As F1
                    Print #F1, "                                                                 收文逾三個月未發文商標案件清單"
                    'Add by Amy 2016/01/06 +承辦人
                    Print #F1, "承辦人：" & GetStaffName("" & .Fields("cp14"), True)
                    Print #F1, "列印日期：" & ChangeWStringToTString(strSrvDate(1))
                    Print #F1, "智權人員 申請人     本所案號         收文日     申請國家   案件名稱         案件性質         上個月專業部原因           上個月智權部原因 "
                    Print #F1, "======== ========== ================ ========== ========== ================ ================ ========================== ========================== "
                    Txt_Head1 = True
                End If
                If Left(oldSt03, 2) <> Left("" & .Fields("st03"), 2) Then
                    If oldSt03 <> MsgText(601) Then
                        If F2 > 0 Then Close #F2
                        If Left(oldSt03, 2) = "F1" Then
                            strTo = Pub_GetSpecMan("V")
                        ElseIf Left(oldSt03, 2) = "P2" Then
                            strTo = Pub_GetSpecMan("V2") 'Modify by Amy 2021/10/12 原:69008
                        Else
                            'Modify By Sindy 2024/3/18 改抓 程式管理人員
                            strTo = Pub_GetSpecMan("程式管理人員")
                        End If
                        SendMAPIMail strTo, strSubject2, vbCrLf & vbCrLf & strContent2 & vbCrLf & vbCrLf, strApatch & strFileN & "清單.txt"
                    End If
                    Txt_Head2 = False
                End If
                If Txt_Head2 = False Then
                    F2 = FreeFile
                    Open strApatch & strFileN & "清單.txt" For Output As F2
                    Print #F2, "                                                                   收文逾三個月未發文商標案件清單"
                    Print #F2, "列印日期：" & ChangeWStringToTString(strSrvDate(1))
                    Print #F2, "承辦人   智權人員 申請人     本所案號         收文日     申請國家   案件名稱         案件性質         上個月專業部原因           上個月智權部原因 "
                    Print #F2, "======== ======== ========== ================ ========== ========== ================ ================ ========================== ========================== "
                    Txt_Head2 = True
                End If
                
                For ii = 0 To 9
                    strTemp(ii) = "" & .Fields(ii)
                Next ii
                               
                strTemp(0) = convForm(CheckStr(strTemp(0)), 8)   '承辦人
                strTemp(1) = convForm(CheckStr(strTemp(1)), 8)   '智權人員
                strTemp(2) = convForm(CheckStr(strTemp(2)), 10) '申請人
                strTemp(3) = convForm(CheckStr(strTemp(3)), 16) '本所案號
                strTemp(4) = convForm(CheckStr(strTemp(4)), 10) '收文日
                
                strTemp(5) = convForm(CheckStr(strTemp(5)), 10) '申請國家
                strTemp(6) = convForm(CheckStr(strTemp(6)), 16) '案件名稱
                strTemp(7) = convForm(CheckStr(strTemp(7)), 16) '案件性質
                strTemp(8) = convForm(CheckStr(strTemp(8)), 26) '上次專業部原因
                strTemp(9) = convForm(CheckStr(strTemp(9)), 26) '上次智權部原因
                
                Print #F1, strTemp(1) & " " & strTemp(2) & " " & strTemp(3) & " " & strTemp(4) & " " & strTemp(5) & _
                          " " & strTemp(6) & " " & strTemp(7) & " " & strTemp(8) & " " & strTemp(9)
                          
                Print #F2, strTemp(0) & " " & strTemp(1) & " " & strTemp(2) & " " & strTemp(3) & " " & strTemp(4) & " " & strTemp(5) & _
                         " " & strTemp(6) & " " & strTemp(7) & " " & strTemp(8) & " " & strTemp(9)
                         
                oldCP14 = "" & .Fields("cp14")
                oldSt03 = "" & .Fields("st03")
                .MoveNext
            Loop
            
            If F1 > 0 Then
                If F1 > 0 Then Close F1
                'Add by Amy 2015/11/02 無承辦人寄件會錯
                If oldCP14 <> MsgText(601) Then
                    SendMAPIMail oldCP14, strSubject1, vbCrLf & vbCrLf & strContent1 & vbCrLf & vbCrLf, strApatch & strFileN & oldCP14 & ".txt"
                End If
            End If
            If F2 > 0 Then
                If F2 > 0 Then Close #F2
                If Left(oldSt03, 2) = "F1" Then
                    strTo = Pub_GetSpecMan("V")
                ElseIf Left(oldSt03, 2) = "P2" Then
                    strTo = Pub_GetSpecMan("V2") 'Modify by Amy 2021/10/12 原:69008
                Else
                    'Modify By Sindy 2024/3/18 改抓 程式管理人員
                    strTo = Pub_GetSpecMan("程式管理人員")
                End If
                SendMAPIMail strTo, strSubject2, vbCrLf & vbCrLf & strContent2 & vbCrLf & vbCrLf, strApatch & strFileN & "清單.txt"
            End If
            If F1 > 0 Then Close #F1
            If F2 > 0 Then Close #F2
         End If
    End With
    
    Exit Sub
    
ErrHand:
    If Err.Number <> 0 Then
        WLog "收文逾三個月未發文商標案件-每月第1個工作天專業部通知:" & Err.Description
    End If
    Set RsQ = Nothing
End Sub

'每月第1個工作天後第7個日曆天執行-當月未發文原因檔仍在管制中的資料,再發mail通知承辦
Private Sub StrMenu69()
    Dim RsQ As New ADODB.Recordset
    Dim strQ As String
    Dim strFileN As String, strApatch As String
    Dim strSubject As String, strContent As String, oldCP14 As String
    Dim Txt_Head1 As Boolean
    Dim F1 As Integer
    Dim strTemp(8) As String, strDate(1) As String
    Dim Txt_Head As Boolean
    Dim ii As Integer
    
On Error GoTo ErrHand
    strFileN = Val(Left(strSrvDate(1), 6)) - 191100 & "收文逾三個月未發文通知"
    strApatch = App.path & TextPath
    
    'Add by Amy 2020/08/11 刪除暫存檔
    'Modify by Amy 2020/09/15 沒檔案會錯 原:\.
    If Dir(strApatch & "\*收文逾三個月未發文通知*.txt") <> "" Then
        Kill strApatch & "\*收文逾三個月未發文通知*.txt"
    End If
    
    '承辦人
    strSubject = "(再次提醒)收文逾三個月未發文通知，請至系統填寫未發文原因。"
    strContent = "請至 承辦人系統->商標處->承辦人作業->未發文案件原因註記 項目中填寫未發文原因！"
    
    strDate(0) = Left(strSrvDate(1), 6) & "01"
    strDate(1) = ChangeWDateStringToWString(DateAdd("m", -1, ChangeWStringToWDateString(DBDATE(strDate(0))))) 'for 抓前個月資料
    'Modify by Amy 2020/09/15 改承辦人為商標處且 無齊備日且無完稿日 或 有會稿日無會完日,其中有一個成立就排除 不寄 mail->寫暫存過濾
    'Modified by Lydia 2017/05/23 排除收款寄證1728 (+ and cp10<>'1728')
    'strQ = "Select S.st02 as CP13N, nvl(cu04,nvl(cu05,cu06)) as Apply,CP01||'-'||CP02||'-'||CP03||'-'||CP04 as CaseNo,SQLDATET2(cp05) as CP05,na03 as Country, " & _
            "CaseName, Nvl(Decode(tm10,'000',CPM03,CPM04),cp10) as CasePropertyName,Pre.nc03,Pre.nc07,cp14 From " & _
            "(Select nc03,cp01,cp02,cp03,cp04,cp05,cp09,cp10,cp12,cp13,cp14, Decode(tm05,null,Decode(sp05,null,Decode( sp06, null,sp07,sp06),sp05),tm05) as CaseName ,nvl(tm10,sp09) as tm10,nvl(tm23,sp08) as tm23 " & _
            "From NotComplete,CaseProgress,TradeMark ,ServicePractice " & _
            "Where nc02=" & Val(Left(strDate(0), 6)) & " And (nc11<>'N' Or nc11 is null ) And nc01=cp09(+) and cp10<>'1728' And cp01=tm01(+) And cp02=tm02(+) And cp03=tm03(+) And cp04=tm04(+) And cp01=sp01(+) And cp02=sp02(+) And cp03=sp03(+) And cp04=sp04(+)) N," & _
            "Staff P,Staff S,Customer,Nation, CasePropertyMap, (Select NC03,NC07,NC01 From NotComplete Where nc02=" & Val(Left(strDate(1), 6)) & ") Pre " & _
            "Where (n.nc03 is null Or n.nc03='') And cp09=Pre.nc01(+) And cp14=P.st01(+) And cp13=S.st01(+) And SubStr(tm23,1,8)=cu01(+) And SubStr(tm23,9,1)=cu02(+) And tm10=na01(+) And cp01=CPM01(+) And cp10=CPM02(+) " & _
            "Order by P.st03,cp14,cp12,cp13,tm23,cp01,cp02,cp03,cp04,cp05,cp09"
    '寫入暫存檔
    cnnConnection.Execute "Delete From RABD6769 "
    strQ = "Insert Into RABD6769 (R001,R002,R003,R004,R005,R006,R007,R008,R009,R010,R011) " & _
            "Select cp09,Nvl(ep06,0) as ep06,Nvl(ep09,0) as ep09,Nvl(ep07,0) as ep07,Nvl(ep08,0) as ep08,Nvl(tm23,sp08) tm23,Nvl(tm10,sp09) tm10," & _
                "SubStr(Decode(tm05,null,Decode(sp05,null,Decode( sp06, null,sp07,sp06),sp05),tm05) ,1,20),SubStr(Pre.nc03,1,30),SubStr(Pre.nc07,1,30),st03 " & _
            " From NotComplete N,CaseProgress,TradeMark,ServicePractice,EngineerProgress,Staff" & _
            "    ,(Select NC03,NC07,NC01 From NotComplete Where nc02=" & Val(Left(strDate(0), 6)) & " ) Pre " & _
            " Where N.nc02=" & Val(Left(strDate(0), 6)) & " And N.nc01=cp09(+) And N.NC01=PRE.NC01(+) And N.nc01=ep02(+) And cp10<>'1728' " & _
            " And cp14=st01(+) And (n.nc03 is null Or n.nc03='') And (nc11<>'N' Or nc11 is null ) " & _
            " And cp01=tm01(+) And cp02=tm02(+) And cp03=tm03(+) And cp04=tm04(+) And cp01=sp01(+) And cp02=sp02(+) And cp03=sp03(+) And cp04=sp04(+)"
    cnnConnection.Execute strQ
    '刪除 承辦人為商標處 無齊備日且無完稿日
    strQ = "Delete From RABD6769 Where SubStr(R011,1,2)='P2' And R002=0 And R003=0 "
    cnnConnection.Execute strQ
    '刪除 承辦人為商標處 有會稿日無會完日
    strQ = "Delete From RABD6769 Where SubStr(R011,1,2)='P2' And R004>0 And R005=0 "
    cnnConnection.Execute strQ
    
     strQ = "Select S.st02 as CP13N, nvl(cu04,nvl(cu05,cu06)) as Apply,CP01||'-'||CP02||'-'||CP03||'-'||CP04 as CaseNo,SQLDATET2(cp05) as CP05,na03 as Country, " & _
                  "R008 as CaseName, Nvl(Decode(R007,'000',CPM03,CPM04),cp10) as CasePropertyName,R009 as nc03,R010 as nc07,cp14 " & _
            "From RABD6769,CaseProgress,Staff P,Staff S,Customer,Nation, CasePropertyMap " & _
            "Where R001=cp09(+) And cp14=P.st01(+) And cp13=S.st01(+) And SubStr(R006,1,8)=cu01(+) And SubStr(R006,9,1)=cu02(+) " & _
            "And R007=na01(+) And cp01=CPM01(+) And cp10=CPM02(+) " & _
            "Order by P.st03,cp14,cp12,cp13,R006,cp01,cp02,cp03,cp04,cp05,cp09"
    RsQ.CursorLocation = adUseClient
    RsQ.Open strQ, cnnConnection, adOpenStatic, adLockReadOnly
    With RsQ
         If .RecordCount > 0 Then
             .MoveFirst
            Do While Not .EOF
                If oldCP14 <> .Fields("cp14") Then
                    If oldCP14 <> MsgText(601) Then
                        If F1 > 0 Then Close #F1
                        'Modify by Amy 2020/09/08 檔名+員編
                        SendMAPIMail oldCP14, strSubject, vbCrLf & vbCrLf & strContent & vbCrLf & vbCrLf, strApatch & strFileN & oldCP14 & ".txt"
                    End If
                    Txt_Head1 = False
                End If
                If Txt_Head1 = False Then
                    F1 = FreeFile
                    Open strApatch & strFileN & .Fields("cp14") & ".txt" For Output As F1
                    Print #F1, "                                                                 收文逾三個月未發文商標案件清單"
                    Print #F1, "列印日期：" & ChangeWStringToTString(strSrvDate(1))
                    Print #F1, "智權人員 申請人     本所案號         收文日     申請國家   案件名稱         案件性質         上個月專業部原因           上個月智權部原因 "
                    Print #F1, "======== ========== ================ ========== ========== ================ ================ ========================== ========================== "
                    Txt_Head1 = True
                End If
                
                For ii = 0 To 8
                    strTemp(ii) = "" & .Fields(ii)
                Next ii
               
                strTemp(0) = convForm(CheckStr(strTemp(0)), 8)   '智權人員
                strTemp(1) = convForm(CheckStr(strTemp(1)), 10) '申請人
                strTemp(2) = convForm(CheckStr(strTemp(2)), 16) '本所案號
                strTemp(3) = convForm(CheckStr(strTemp(3)), 10) '收文日
                strTemp(4) = convForm(CheckStr(strTemp(4)), 10)   '申請國家
                
                strTemp(5) = convForm(CheckStr(strTemp(5)), 16) '案件名稱
                strTemp(6) = convForm(CheckStr(strTemp(6)), 16) '案件性質
                strTemp(7) = convForm(CheckStr(strTemp(7)), 26) '上次專業部原因
                strTemp(8) = convForm(CheckStr(strTemp(8)), 26) '上次智權部原因
                
                Print #F1, strTemp(0) & " " & strTemp(1) & " " & strTemp(2) & " " & strTemp(3) & " " & strTemp(4) & _
                          " " & strTemp(5) & " " & strTemp(6) & " " & strTemp(7) & " " & strTemp(8)
                          
                oldCP14 = "" & .Fields("cp14")
                .MoveNext
            Loop
            If F1 > 0 Then
                Close #F1
                'Modify by Amy 2020/09/08 檔名+員編
                'Add by Amy 2021/02/09 若承辦人為空發給秀玲 ex:FCT-043806
                'Modified by Lydia 2022/05/27 每月、每日批次發通知無收受者時改發「程式管理人員」，以利查覺異常情形，才能儘早修改系統設定
                If oldCP14 = MsgText(601) Then
                    oldCP14 = Pub_GetSpecMan("程式管理人員")
                End If
                'end 2022/05/27
                SendMAPIMail oldCP14, strSubject, vbCrLf & vbCrLf & strContent & vbCrLf & vbCrLf, strApatch & strFileN & oldCP14 & ".txt"
            End If
            If F1 > 0 Then Close #F1
        End If
    End With
    
    Exit Sub
    
ErrHand:
    If Err.Number <> 0 Then
        WLog "收文逾三個月未發文商標案件-專業部通知(再提醒):" & Err.Description
    End If
    Set RsQ = Nothing
End Sub
'end 2015/09/15

'Added by Lydia 2016/01/06 商標處大陸案催審輪值通知
'T,TB,TC,TD,TF,TM,TR,TS,TT 每月1,16日後的第四個工作天若該區間(1~15日或16~月底)仍有商標大陸案要催審的資料，由系統發MAIL通知輪值人員
Private Sub StrMenu70()
    Dim RsQ As New ADODB.Recordset
    Dim strQ As String, strQuser As String
    Dim strTo As String
    Dim ii As Integer
    Dim strDate(0 To 1) As String
    Dim bolUpd As Boolean 'Added by Lydia 2016/05/20
    
On Error GoTo ErrHand

    If strSrvDate(1) = CompWorkDay(4, Left(strSrvDate(1), 6) & "01") Then
        strDate(0) = Left(strSrvDate(1), 6) & "01"
        strDate(1) = Left(strSrvDate(1), 6) & "15"
    Else
        strDate(0) = Left(strSrvDate(1), 6) & "16"
        strDate(1) = Left(strSrvDate(1), 6) & "31"
    End If
    'Modified by Lydia 2016/04/01 因為是大陸案, 所以不會有 FCT, 但可能會有TF
    'Modified by Lydia 2016/09/14 (CP27='' OR CP27 Is Null) => CP158=0
    strQ = "Select np01,NP08,NP10,tm01 TM01,tm02 TM02,tm03 TM03,tm04 TM04,tm10 TM10,Nvl(tm15,tm12) TM15,tm23 TM23,Nvl(tm05,Nvl(tm06,tm07)) CaseN " & _
            "From NextProgress,TradeMark Where NP02 in ('TF','T',' ') And NP02=TM01(+) AND NP03=TM02(+) AND NP04=TM03(+) AND NP05=TM04(+) " & _
            "and tm10 <> '000' And tm29 IS NULL And NP08>=" & strDate(0) & " And NP08<=" & strDate(1) & " And NP07=305 And NP06 Is Null And Not Exists" & _
            "(Select CP01 From CaseProgress Where CP01=TM01 And CP02=TM02 And CP03=TM03 And CP04=TM04 And (CP10='1202' or cp10='1201') And CP09>'C') "
    strQ = strQ & " Union All " & _
            "Select np01,NP08,NP10,sp01 TM01,sp02 TM02,sp03 TM03,sp04 TM04,sp09 TM10,sp11 TM15,sp08 TM23,Nvl(sp05,Nvl(sp06,sp07)) CaseN " & _
            "From NextProgress,ServicePractice Where NP02 in ('TT','TS','TR','TM','TD','TC','TB',' ') And NP02=SP01(+) AND NP03=SP02(+) AND NP04=SP03(+) AND NP05=SP04(+) " & _
            "and sp09 <> '000' And SP29 IS NULL And NP08>=" & strDate(0) & " And NP08<=" & strDate(1) & " And NP07=305 And NP06 Is Null And Not Exists" & _
            "(Select CP01 From CaseProgress Where CP01=SP01 And CP02=SP02 And CP03=SP03 And CP04=SP04 And (CP10='1202' or cp10='1201') And CP09>'C') "
    strQ = strQ & " Union All " & _
            "Select np01,NP08,NP10,tm01 TM01,tm02 TM02,tm03 TM03,tm04 TM04,tm10 TM10,Nvl(tm15,tm12) TM15,tm23 TM23,Nvl(tm05,Nvl(tm06,tm07)) CaseN " & _
            "From NextProgress,TradeMark Where NP02 in ('TF','T',' ') And NP02=TM01(+) AND NP03=TM02(+) AND NP04=TM03(+) AND NP05=TM04(+) " & _
            "and tm10 <> '000' And tm29 IS NULL And NP08>=" & strDate(0) & " And NP08<=" & strDate(1) & " And NP07=305 And NP06 Is Null " & _
            "And Exists(Select CP01 From CaseProgress Where CP01=TM01 And CP02=TM02 And CP03=TM03 And CP04=TM04 And (CP10='1202' or cp10='1201') And CP09>'C') " & _
            "And Exists(Select CP01 From CaseProgress Where CP01=TM01 And CP02=TM02 And CP03=TM03 And CP04=TM04 And (CP10='203' or cp10='201' or cp10='301' or cp10='302') And CP09<'C' And CP158=0)"
    strQ = strQ & " Union All " & _
            "Select np01,NP08,NP10,sp01 TM01,sp02 TM02,sp03 TM03,sp04 TM04,sp09 TM10,sp11 TM15,sp08 TM23,Nvl(sp05,Nvl(sp06,sp07)) CaseN " & _
            "From NextProgress,ServicePractice Where NP02 in ('TT','TS','TR','TM','TD','TC','TB',' ') And NP02=SP01(+) AND NP03=SP02(+) AND NP04=SP03(+) AND NP05=SP04(+) " & _
            "and sp09 <> '000' And SP29 IS NULL And NP08>=" & strDate(0) & " And NP08<=" & strDate(1) & " And NP07=305 And NP06 Is Null " & _
            "And Exists(Select CP01 From CaseProgress Where CP01=SP01 And CP02=SP02 And CP03=SP03 And CP04=SP04 And (CP10='1202' or cp10='1201') And CP09>'C') " & _
            "And Exists(Select CP01 From CaseProgress Where CP01=SP01 And CP02=SP02 And CP03=SP03 And CP04=SP04 And (CP10='203' or cp10='201' or cp10='301' or cp10='302') And CP09<'C' And CP158=0)"
            
    '本所發文日 申請/註冊號  本所案號    代號  案件名稱            案件性質   申請人            進度說明
    strQ = "Select sqldatew(cp27) CP27,TM15, TM01||'-'||TM02||'-'||TM03||'-'||TM04 CaseNo,S1.ST17,CaseN,Nvl(Decode(TM10,'000',cpm03,cpm04),cp10),Nvl(cu04,Nvl(cu05||cu88||cu89||cu90,cu06)) " & _
            "From (" & strQ & "),CaseProgress,Staff S1,CaseProPertyMap,Customer " & _
            "Where NP01=CP09(+) And CP14=S1.ST01(+) And CP01=CPM01(+) And CP10=CPM02(+) " & _
            "And SubStr(TM23,1,8)=CU01(+) And Decode(SubStr(TM23,9,1),'','0',SubStr(TM23,9,1))=CU02(+)  Order by CP27 "
    RsQ.CursorLocation = adUseClient
    RsQ.Open strQ, cnnConnection, adOpenStatic, adLockReadOnly
    'Modified by Lydia 2016/05/20 若無資料,仍通知人員,但是不跳過
    If RsQ.RecordCount > 0 Then
       bolUpd = True
    End If
       strQuser = Pub_GetSpecMan("商標處大陸案催審輪值表")
       strTo = Pub_GetSpecMan("商標處大陸案上次催審人員")
       If strQuser <> "" Then
          '最後一位->從頭輪
          'Modified by Lydia 2021/04/19 上次催審人員離職若要維持原輪值表,則要改成新員工編號,不改編號會從頭輪
          'If strTo <> "" And Len(strQuser) - InStr(strQuser, strTo) <= 6 Then
          If strTo <> "" And ((Len(strQuser) - InStr(strQuser, strTo) <= 6 And InStr(strQuser, strTo) > 0) Or InStr(strQuser, strTo) = 0) Then
             strTo = ""
          End If
          If strTo = "" Then
               strTo = Mid(strQuser, 1, InStr(strQuser, ";") - 1)
          Else
               strExc(1) = Mid(strQuser, InStr(InStr(strQuser, strTo), strQuser, ";") + 1, 6)
               If InStr(strExc(1), ";") > 0 Then
                  strTo = Mid(strExc(1), 1, InStr(strExc(1), ";") - 1)
               Else
                  strTo = strExc(1)
               End If
          End If

          If strTo <> "" Then
             'Added by Lydia 2016/05/20 加判斷bolUpd
             If bolUpd Then
                strExc(0) = "update SetSpecMan set OMAN='" & strTo & "' where OCODE='商標處大陸案上次催審人員'"
                cnnConnection.BeginTrans
                   cnnConnection.Execute strExc(0), intI
                cnnConnection.CommitTrans
                'Modified by Lydia 2021/11/12  CC:69008 => 86048;79041
                SendMAPIMail strTo, "通知您今日輪值做大陸案之催審工作！", vbCrLf & "請至承辦人作業->案件催審作業 點選大陸案產生清單頁籤操作，" & vbCrLf & "產生大陸案之催審清單後再自行E-MAIL。", , , , IIf(strTo = "86048", "79041", "86048;79041")
             Else
                'Modified by Lydia 2021/11/12  CC:69008 => 86048;79041
                SendMAPIMail strTo, "通知您今日輪值做大陸案之催審工作，本次無催審資料，下次輪值人員依舊是您！", vbCrLf & "您收到信後，不需進行任何作業，下次輪值人員依舊是您。", , , , IIf(strTo = "86048", "79041", "86048;79041")
             End If
          End If
       End If
    'End If
    'end 2016/05/20
    
    RsQ.Close
    Exit Sub

ErrHand:
    If Err.Number <> 0 Then
        WLog "商標處大陸案催審輪值通知:" & Err.Description
    End If
    Set RsQ = Nothing
End Sub
'end 2016/01/06

'add by sonia 2016/1/11 薪資及年終獎金入帳通知,互助會得標通知
Private Sub StrMenu71()
Dim RsQ As New ADODB.Recordset, rsA As New ADODB.Recordset
Dim strQ As String, strSubject As String, strFileName As String, strApatch As String
Dim ii As Integer, F1 As Integer, Txt_Head1 As Boolean
Dim strTemp(5) As String
Dim oldCM01 As String, oldCM03 As String, oldST02 As String, oldCM05 As String
Dim dblCount As Double, dblAmount As Double
Dim oldST14 As String   'add by sonia 2016/10/5

On Error GoTo ErrHand
   '薪資及年終獎金入帳通知(taie_alluser@taie.com.tw台一全體人員)
   strQ = "select br01 From bookrecord where br02=" & strSrvDate(1) & " and substr(br01,5)<=13 order by br01"
   RsQ.CursorLocation = adUseClient
   RsQ.Open strQ, cnnConnection, adOpenStatic, adLockReadOnly
   With RsQ
      If .RecordCount > 0 Then
         .MoveFirst
         Do While Not .EOF
            If Val(Right(RsQ.Fields("br01"), 2)) <= 12 Then
               '月薪資入帳通知
               'modify by sonia 2019/4/8 不發職代
               SendMAPIMail "taie_alluser@taie.com.tw", Val(Left(RsQ.Fields("br01"), 4)) - 1911 & "年" & Val(Right(RsQ.Fields("br01"), 2)) & "月薪資已完成作業，請至一般作業->薪資查詢系統 查詢相關資料！", vbCrLf & "各位同仁大家好，" & vbCrLf & vbCrLf & "薪資將於今日轉入您的銀行帳戶，請查收！" & vbCrLf & vbCrLf & "＊薪資為個人機密，請您尊重自己，也尊重別人的權益＊" & vbCrLf & vbCrLf & "　　　　　　　　　　　　　　　　財務處  敬上", , , True
               
               '互助會得標通知
               oldCM01 = "": oldCM03 = "": oldST02 = "": oldCM05 = "": oldST14 = ""
               dblCount = 0: dblAmount = 0
               strSubject = Val(Left(RsQ.Fields("br01"), 4)) - 1911 & "年" & Val(Right(RsQ.Fields("br01"), 2)) & "月互助會得標明細通知！"
               strApatch = App.path & TextPath
               'modify by sonia 2016/4/6 員工編號60000台一互助會不發通知
               'modify by sonia 2016/10/5 99997改寄給辜71005,故加d.st14欄
               strQ = "select decode(wfa03,'60000','1','2') as sort1,a.cm01 as acm01,a.cm04 as acm04,a.cm03 as acm03,a.cm05 as acm05,b.cm02 as bcm02,c.ST02 as cST02,decode(wfa03,'60000',decode(nvl(b.cm05,0),0,co02,co02+b.cm05),wfa04) as wfa04,d.ST02 as dST02,d.ST14 as dST14 " & _
                      "from CooperationMember a,WfAmount,CooperationMember b,Staff c,Staff d,Cooperation " & _
                      "where a.cm04(+)=wfa01 and wfa05='2' and wfa02=a.cm01(+) and a.cm01=co01(+) and a.cm03<>'60000' " & _
                      "and b.cm01(+)=wfa02 and b.cm03(+)=wfa03 and c.ST01(+)=wfa03 and d.ST01(+)=a.cm03 and substr(a.cm04,1,6)='" & Val(RsQ.Fields("br01")) & "' " & _
                      "order by a.cm01,sort1,b.cm02 "
               rsA.CursorLocation = adUseClient
               rsA.Open strQ, cnnConnection, adOpenStatic, adLockReadOnly
               With rsA
                  If .RecordCount > 0 Then
                     .MoveFirst
                     Do While Not .EOF
                        If oldCM01 = "" Then
                           oldCM01 = "" & .Fields("acm01"): oldCM03 = "" & .Fields("acm03")
                           oldST02 = "" & .Fields("dST02"): oldCM05 = "" & .Fields("acm05")
                           oldST14 = "" & .Fields("dST14")  'add by sonia 2016/10/5
                        End If
                        If oldCM01 <> .Fields("acm01") Or oldCM03 <> .Fields("acm03") Then
                           If oldCM03 <> MsgText(601) Then
                              Print #F1, "================================================================="
                              Print #F1, "                           合　計：" & dblCount & "人       " & Format(dblAmount, "#,###,##0")
                              If F1 > 0 Then Close #F1
                              'modify by sonia 2016/10/5 修改86021之99997改發辜
                              'SendMAPIMail oldCM03, strSubject, vbCrLf & vbCrLf & vbCrLf & vbCrLf, strApatch & strFileName & ".txt"
                              If oldST14 = "99997" Then
                                 'modify by sonia 2019/4/8 不發職代
                                 'Modified by Morgan 2024/3/7 收信人改抓設定
                                 'SendMAPIMail "71005", strSubject & "得標人:" & oldST02, vbCrLf & vbCrLf & vbCrLf & vbCrLf, strApatch & strFileName & ".txt", , True
                                 SendMAPIMail Pub_GetSpecMan("試用期滿追蹤薪資人員"), strSubject & "得標人:" & oldST02, vbCrLf & vbCrLf & vbCrLf & vbCrLf, strApatch & strFileName & ".txt", , True
                              Else
                                 'modify by sonia 2019/4/8 不發職代
                                 SendMAPIMail oldCM03, strSubject, vbCrLf & vbCrLf & vbCrLf & vbCrLf, strApatch & strFileName & ".txt", , True
                              End If
                              'end 2016/10/5
                           End If
                           Txt_Head1 = False
                        End If
                        If Txt_Head1 = False Then
                           oldCM01 = .Fields("acm01"): oldCM03 = .Fields("acm03")
                           oldST02 = .Fields("dST02"): oldCM05 = .Fields("acm05")
                           oldST14 = "" & .Fields("dST14")  'add by sonia 2016/10/5
                           strFileName = "互助會 " & oldCM01 & " 會號 " & Val(Left(RsQ.Fields("br01"), 4)) - 1911 & " 年 " & Val(Right(RsQ.Fields("br01"), 2)) & " 月得標明細"
                           F1 = FreeFile
                           Open strApatch & strFileName & ".txt" For Output As F1
                           Print #F1, "　　　　　　　　　　　　　互助會得標明細"
                           Print #F1, "通知日期：" & Format(strSrvDate(2), "###/##/##")
                           Print #F1, "會　  號：" & oldCM01 & " 　　　　　　　　　　　　　　得標月份：" & Val(Left(RsQ.Fields("br01"), 4)) - 1911 & " 年 " & Val(Right(RsQ.Fields("br01"), 2)) & " 月"
                           Print #F1, "得標人  ：" & oldST02 & "　　　　　　　　　　　　　得標金額：" & oldCM05
                           Print #F1, ""
                           Print #F1, "　　　　　　　　編號　　　　姓　名　　　　　　會　款"
                           Print #F1, "================================================================="
                           Txt_Head1 = True
                           '取得會號之投標金額
                           dblAmount = 0
                           strQ = "SELECT * FROM Cooperation WHERE CO01='" & oldCM01 & "' "
                           intI = 1
                           Set RsTemp = ClsLawReadRstMsg(intI, strQ)
                           If intI = 1 Then
                              dblAmount = Val(RsTemp("CO02"))
                           End If
                           '新增一筆會首資料
                           dblCount = 1
                           strTemp(0) = convForm(CheckStr("00"), 2)    '編號
                           strTemp(1) = convForm(CheckStr("台一"), 10)   '姓名
                           strTemp(2) = convForm(CheckStr(Val(dblAmount)), 7)  '會款
                           Print #F1, "                 " & strTemp(0) & "　  　　" & strTemp(1) & "　　　　  " & Format(strTemp(2), "#,###,##0")
                        End If

                        strTemp(0) = convForm(CheckStr("" & .Fields("bcm02")), 2)    '編號
                        strTemp(1) = convForm(CheckStr("" & .Fields("cST02")), 10)   '姓名
                        strTemp(2) = convForm(CheckStr("" & .Fields("wfa04")), 7)    '會款
                        Print #F1, "                 " & strTemp(0) & "　  　　" & strTemp(1) & "　　　　  " & Format(strTemp(2), "#,###,##0")

                        dblCount = dblCount + 1: dblAmount = dblAmount + Val(.Fields("wfa04"))
                        
                        .MoveNext
                     Loop
                     If F1 > 0 Then
                        Print #F1, "================================================================="
                        Print #F1, "                           合　計：" & dblCount & "人       " & Format(dblAmount, "#,###,##0")
                        Close #F1
                        'modify by sonia 2016/10/5 修改86021之99997改發辜
                        'SendMAPIMail oldCM03, strSubject, vbCrLf & vbCrLf & vbCrLf & vbCrLf, strApatch & strFileName & ".txt"
                        If oldST14 = "99997" Then
                           'modify by sonia 2019/4/8 不發職代
                           'Modified by Morgan 2024/3/7 收信人改抓設定
                           'SendMAPIMail "71005", strSubject & "得標人:" & oldST02, vbCrLf & vbCrLf & vbCrLf & vbCrLf, strApatch & strFileName & ".txt", , True
                           SendMAPIMail Pub_GetSpecMan("試用期滿追蹤薪資人員"), strSubject & "得標人:" & oldST02, vbCrLf & vbCrLf & vbCrLf & vbCrLf, strApatch & strFileName & ".txt", , True
                        Else
                           'modify by sonia 2019/4/8 不發職代
                           SendMAPIMail oldCM03, strSubject, vbCrLf & vbCrLf & vbCrLf & vbCrLf, strApatch & strFileName & ".txt", , True
                        End If
                        'end 2016/10/5
                     End If
                     If F1 > 0 Then Close #F1
                  End If
               End With
               rsA.Close
               
            '年終獎金入帳通知
            ElseIf Val(Right(RsQ.Fields("br01"), 2)) = 13 Then
               'modify by sonia 2019/4/8 不發職代
               SendMAPIMail "taie_alluser@taie.com.tw", Val(Left(RsQ.Fields("br01"), 4)) - 1912 & "年度年終獎金已完成作業，請至一般作業->薪資查詢系統 查詢相關資料！", vbCrLf & "各位同仁大家好，" & vbCrLf & vbCrLf & "年終獎金將於今日轉入您的銀行帳戶，請查收！" & vbCrLf & vbCrLf & "＊薪資為個人機密，請您尊重自己，也尊重別人的權益＊" & vbCrLf & vbCrLf & "　　　　　　　　　　　　　　　　財務處  敬上", , , True
            End If
           .MoveNext
         Loop
      End If
   End With
   RsQ.Close
   
   Exit Sub

ErrHand:
    If Err.Number <> 0 Then
      WLog "薪資及年終獎金入帳通知,互助會得標通知錯誤 !" & Err.Description
    End If
    Set RsQ = Nothing
End Sub
'end 2016/01/11

'add by sonia 2016/1/19 扣繳憑單資料開放查詢通知
Private Sub StrMenu72()
Dim RsQ As New ADODB.Recordset
Dim strQ As String
   
   strQ = "select id14 From IncomeData where id14=" & Val(Left(strSrvDate(1), 4)) - 1 & " and rownum<2"
   RsQ.CursorLocation = adUseClient
   RsQ.Open strQ, cnnConnection, adOpenStatic, adLockReadOnly
   If RsQ.RecordCount > 0 Then
      'modify by sonia 2019/4/8 不發職代
      SendMAPIMail "taie_alluser@taie.com.tw", Val(Left(strSrvDate(1), 4)) - 1912 & "年度扣繳憑單資料已可查詢，請至一般作業->薪資查詢系統 查詢相關資料！", vbCrLf & "各位同仁大家好，" & vbCrLf & vbCrLf & Val(Left(strSrvDate(1), 4)) - 1912 & "年度扣繳憑單資料已可查詢，請至一般作業->薪資查詢系統 查詢相關資料！" & vbCrLf & vbCrLf & "＊薪資為個人機密，請您尊重自己，也尊重別人的權益＊" & vbCrLf & vbCrLf & "　　　　　　　　　　　　　　　　財務處  敬上", , , True
   Else
      'Modify By Sindy 2024/3/18 改抓 程式管理人員
      SendMAPIMail Pub_GetSpecMan("程式管理人員"), "查無 " & Val(Left(strSrvDate(1), 4)) - 1912 & "年度扣繳憑單資料！", vbCrLf & "語法查無資料, 請儘速確認！" & vbCrLf & vbCrLf & "select id14 From IncomeData where id14=" & Val(Left(strSrvDate(1), 4)) - 1912 & " and rownum<2 "
   End If
   RsQ.Close
End Sub
'end 2016/01/19

'Add By Sindy 2016/2/4 定期清除國外部/專利處/商標處郵件實體檔
Sub StrMenu73()
Dim tmpnext As String
Dim rsA As New ADODB.Recordset
Dim strWriteText As String
Dim strDate1mday As String
Dim bolConnect As Boolean
   
On Error GoTo DebugErr
   
   '清除一個月前的資料
   strDate1mday = DBDATE(DateAdd("m", -1, Format(strSrvDate(1), "####/##/##")))
   
   '讀取可刪除信件
   '*** 國外部郵件 ***
   strSql = "select * from ipdeptinput" & _
            " where ii16>0 and ii14 is not null and ii16<" & strDate1mday & " and ii08>0"
   Set rsA = New ADODB.Recordset
   rsA.CursorLocation = adUseClient
   rsA.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   tmpnext = "已取得資料..."
   strWriteText = ""
   With rsA
      If .RecordCount > 0 Then
         .MoveFirst
         Do While Not .EOF
            tmpnext = "執行中,信件(" & .Fields("ii01") & " " & .Fields("ii02") & " " & .Fields("ii03") & ")"
            
            cnnConnection.BeginTrans
            bolConnect = True
            '直接刪除File Server Msg檔案
            If PUB_DelFtpFile2(.Fields("ii01"), " and ii02=" & .Fields("ii02") & " and upper(ii03)='" & ChgSQL(UCase(.Fields("ii03"))) & "'", "ipdeptinput") = True Then
               strExc(0) = "update IPDeptInput set " & _
                           " ii14=null" & _
                           " where ii01=" & .Fields("ii01") & _
                             " and ii02=" & .Fields("ii02") & _
                             " and upper(ii03)='" & ChgSQL(UCase(.Fields("ii03"))) & "'"
               cnnConnection.Execute strExc(0)
            Else
               strWriteText = strWriteText & .Fields("ii01") & " " & .Fields("ii02") & " " & .Fields("ii03") & vbCrLf & vbCrLf
            End If
            
            cnnConnection.CommitTrans
            bolConnect = False
            .MoveNext
         Loop
      End If
   End With
   '發 mail
   If strWriteText <> "" Then
      SendMAPIMail "97038", "國外部郵件清除失敗", strWriteText
   End If
   
   '*** 專利處郵件 ***
   strSql = "select * from patentinput" & _
            " where pi16>0 and pi14 is not null and pi16<" & strDate1mday & " and pi08>0"
   Set rsA = New ADODB.Recordset
   rsA.CursorLocation = adUseClient
   rsA.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   tmpnext = "已取得資料..."
   strWriteText = ""
   With rsA
      If .RecordCount > 0 Then
         .MoveFirst
         Do While Not .EOF
            tmpnext = "執行中,信件(" & .Fields("pi01") & " " & .Fields("pi02") & " " & .Fields("pi03") & ")"
            
            cnnConnection.BeginTrans
            bolConnect = True
            '直接刪除File Server Msg檔案
            If PUB_DelFtpFile2(.Fields("pi01"), " and pi02=" & .Fields("pi02") & " and upper(pi03)='" & ChgSQL(UCase(.Fields("pi03"))) & "'", "patentinput") = True Then
               strExc(0) = "update PatentInput set " & _
                           " pi14=null" & _
                           " where pi01=" & .Fields("pi01") & _
                             " and pi02=" & .Fields("pi02") & _
                             " and upper(pi03)='" & ChgSQL(UCase(.Fields("pi03"))) & "'"
               cnnConnection.Execute strExc(0)
            Else
               strWriteText = strWriteText & .Fields("pi01") & " " & .Fields("pi02") & " " & .Fields("pi03") & vbCrLf & vbCrLf
            End If
            
            cnnConnection.CommitTrans
            bolConnect = False
            .MoveNext
         Loop
      End If
   End With
   '發 mail
   If strWriteText <> "" Then
      SendMAPIMail "97038", "專利處郵件清除失敗", strWriteText
   End If
   
   '*** 商標處郵件 ***
   strSql = "select * from TMinput" & _
            " where Ti16>0 and Ti14 is not null and Ti16<" & strDate1mday & " and Ti08>0"
   Set rsA = New ADODB.Recordset
   rsA.CursorLocation = adUseClient
   rsA.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   tmpnext = "已取得資料..."
   strWriteText = ""
   With rsA
      If .RecordCount > 0 Then
         .MoveFirst
         Do While Not .EOF
            tmpnext = "執行中,信件(" & .Fields("Ti01") & " " & .Fields("Ti02") & " " & .Fields("Ti03") & ")"
            
            cnnConnection.BeginTrans
            bolConnect = True
            '直接刪除File Server Msg檔案
            If PUB_DelFtpFile2(.Fields("Ti01"), " and Ti02=" & .Fields("Ti02") & " and upper(Ti03)='" & ChgSQL(UCase(.Fields("Ti03"))) & "'", "TMinput") = True Then
               strExc(0) = "update TMinput set " & _
                           " Ti14=null" & _
                           " where Ti01=" & .Fields("Ti01") & _
                             " and Ti02=" & .Fields("Ti02") & _
                             " and upper(Ti03)='" & ChgSQL(UCase(.Fields("Ti03"))) & "'"
               cnnConnection.Execute strExc(0)
            Else
               strWriteText = strWriteText & .Fields("Ti01") & " " & .Fields("Ti02") & " " & .Fields("Ti03") & vbCrLf & vbCrLf
            End If
            
            cnnConnection.CommitTrans
            bolConnect = False
            .MoveNext
         Loop
      End If
   End With
   '發 mail
   If strWriteText <> "" Then
      SendMAPIMail "97038", "商標處郵件清除失敗", strWriteText
   End If
   
   Set rsA = Nothing
   Exit Sub

DebugErr:
   Set rsA = Nothing
   If bolConnect = True Then
      cnnConnection.RollbackTrans
   End If
   WLog tmpnext & " " & Err.Description
End Sub

'Add By Sindy 2016/3/16 專利處未會(圖/文)完畢超過3個工作天清除齊備日，並發信通知工程師及智權人員
Sub StrMenu74()
Dim System_2 As String
Dim rsA As New ADODB.Recordset
Dim tmpnext As String
   
On Error GoTo DebugErr
   
   '系統日減3個工作天
   System_2 = CompWorkDay(3, strSrvDate(1), 1)
   
   strSql = "select ep02,ep05,ep06,cp01,cp02,cp03,cp04,cp13 from engineerprogress,caseprogress" & _
            " where ep02 in(select eep01 from empelectronprocess where eep04='" & EMP_會圖 & "' and eep09='Y' and eep06<" & System_2 & ")" & _
            " and ep06 is not null and ep02=cp09(+)"
   Set rsA = New ADODB.Recordset
   rsA.CursorLocation = adUseClient
   rsA.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   tmpnext = "已取得資料..."
   With rsA
      If .RecordCount > 0 Then
         .MoveFirst
         Do While Not .EOF
            tmpnext = "執行中,文號(" & .Fields("ep02") & ") 案號(" & .Fields("cp01") & "-" & .Fields("cp02") & "-" & .Fields("cp03") & "-" & .Fields("cp04") & ")"
            
            '未會圖完畢超過3個工作天
            strExc(0) = "update engineerprogress set ep06=null,ep12='原齊備日='||ep06||';'||ep12 where ep02='" & .Fields("ep02") & "'"
            cnnConnection.Execute strExc(0)
            
            '發 mail
            'Modify By Sindy 2022/10/11 字樣: 會圖==>會(圖/文)
            SendMAPIMail .Fields("ep05") & ";" & .Fields("cp13"), Replace(.Fields("cp01") & "-" & .Fields("cp02") & "-" & .Fields("cp03") & "-" & .Fields("cp04"), "-0-00", "") & " 未會(圖/文)完畢，超過3個工作天清除齊備日", "本案因為會(圖/文)時間超過3個工作天，為避免影響其他案件的排程進度，暫將齊備日刪除"
            
            .MoveNext
         Loop
      End If
   End With
   
   Set rsA = Nothing
   Exit Sub

DebugErr:
   Set rsA = Nothing
   WLog Err.Description
End Sub

'Modify by Amy  2019/09/27 非電腦中心變更申請地址提醒CFT承辦人及智權人員
Sub StrMenu75()
    Dim strQ As String, strA As String, strCmd As String
    Dim RsQ As New ADODB.Recordset, rsA As New ADODB.Recordset
    Dim strApatch As String, strFileN As String, strAttnF As String
    Dim stDate(1) As String, strTemp(6) As String
    Dim OldCU13 As String, oldCP14 As String, OldCU01 As String, OldCusN As String, OldM13 As String
    Dim stDeptMan As String '部門主管
    Dim strTo As String, strContent As String, strMailC(1) As String
    Dim Txt_Head As Boolean
    Dim F1 As Integer, F2 As Integer, ii As Integer, intA As Integer
    Dim bolData As Boolean, bolIsFirst As Boolean '是否有收文未發文資料/是否為第一筆
    Dim bolIns As Boolean
    
On Error GoTo ErrHand
    strApatch = App.path & TextPath
    strFileN = "案件.txt"
    stDate(0) = PUB_GetWorkDayAfterSysDate(CDbl(strSrvDate(1)), -1) + 19110000 '系統前一個工作日
    stDeptMan = GetDeptMan("F10")
    
    '刪除暫存檔
    strCmd = "Delete From RABD75"
    cnnConnection.Execute strCmd
    
    '新增工作日前一日至非工作前一日有非電腦中心修改客戶檔之客戶編號至暫存檔中,地址由無到有不通知
    strCmd = "Insert into rabd75 (R001,R002,R013,R014) " & _
                "Select Distinct SubStr(DL09,(InStr(UPPER(DL09),'CU01')+6),8) CU1,SubStr(DL09,(InStr(UPPER(DL09),'CU02')+6),1) CU2,DL07,'C' From DML_LOG,Staff " & _
                "Where DL07>=" & stDate(0) & " And DL07<To_Char(SYSDATE,'YYYYMMDD') And UPPER(DL10)='CUSTOMER' And SubStr(DL09,2,2)='修改' And DL06=st01(+) And st03<>'M51' " & _
                "And ((InStr(DL09,'CU23')>0 And InStr(DL09,'CU23[=>')=0) Or (InStr(DL09,'CU24')>0 And InStr(DL09,'CU24[=>')=0) Or (InStr(DL09,'CU25')>0 And InStr(DL09,'CU25[=>')=0) " & _
                          "Or (InStr(DL09,'CU26')>0 And InStr(DL09,'CU26[=>')=0 ) Or (InStr(DL09,'CU27')>0 And InStr(DL09,'CU27[=>')=0 ) Or (InStr(DL09,'CU28')>0 And InStr(DL09,'CU28[=>')=0) " & _
                          "Or (InStr(DL09,'CU29')>0 And InStr(DL09,'CU29[=>')=0 ) Or (InStr(DL09,'CU102')>0 And InStr(DL09,'CU102[=>')=0) ) "
    cnnConnection.Execute strCmd
    
    '抓取商標基本檔未閉卷未銷卷且卷宗性質為申請(tm28=1)之CFT案,比對客戶地與案件地址是否有修改 ex:X8138900 英文地址一樣但大小寫不同(不發mail)
    strQ = ",tm01,tm02,tm03,tm04,tm05,tm09,tm10,tm11,tm22"
    strQ = "Select SubStr(Apply,1,8),SubStr(Apply,9,1)" & strQ & ",GetNA69(tm01,tm02,tm03,tm04,'','') as NA69,cp05,cp09,cp14,cp27,cp57,cu23,cu24,cu25,cu26,cu27,cu28,cu102,cu29,tm10,AC,AE,AJ " & _
              "From Customer,CaseProgress,(" & _
                    "Select tm23 Apply" & strQ & ",tm24 AC,tm25 AE,tm26 AJ From TradeMark Where tm01='CFT' And tm29 is null And tm57 is null And tm28='1' And tm23 in (Select R001||R002 From RABD75 Where R014='C') " & _
         "Union Select tm78 Apply" & strQ & ",tm82 AC,tm86 AE,tm90 AJ From TradeMark Where tm01='CFT' And tm29 is null And tm57 is null And tm28='1' And tm78 in (Select R001||R002 From RABD75 Where R014='C') " & _
         "Union Select tm79 Apply" & strQ & ",tm83 AC,tm87 AE,tm91 AJ From TradeMark Where tm01='CFT' And tm29 is null And tm57 is null And tm28='1' And tm79 in (Select R001||R002 From RABD75 Where R014='C') " & _
         "Union Select tm80 Apply" & strQ & ",tm84 AC,tm88 AE,tm92 AJ From TradeMark Where tm01='CFT' And tm29 is null And tm57 is null And tm28='1' And tm80 in (Select R001||R002 From RABD75 Where R014='C') " & _
         "Union Select tm81 Apply" & strQ & ",tm85 AC,tm89 AE,tm93 AJ From TradeMark Where tm01='CFT' And tm29 is null And tm57 is null And tm28='1' And tm81 in (Select R001||R002 From RABD75 Where R014='C') " & _
              ")TM Where SubStr(Apply,1,8)=cu01(+) And SubStr(Apply,9,1)=cu02(+) And tm01=cp01(+) And tm02=cp02(+) And tm03=cp03(+) And tm04=cp04(+) And cp31='Y' "
    If RsQ.State <> adStateClosed Then RsQ.Close
    RsQ.CursorLocation = adUseClient
    RsQ.Open strQ, cnnConnection, adOpenStatic, adLockReadOnly
    With RsQ
        If .RecordCount > 0 Then
            .MoveFirst
            Do While .EOF = False
                bolIns = False
                '案件中文地址
                strTemp(0) = ReplaceTWNo(AddrToZipAddr("" & .Fields("AC")))
                '客戶中文地址
                strTemp(1) = ReplaceTWNo("" & .Fields("cu23"))
                If strTemp(0) = strTemp(1) Then
                    '案件英文地址
                    strTemp(0) = RTrim(UCase("" & .Fields("AE")))
                    '客戶英文地址
                    strTemp(1) = RTrim("" & .Fields("cu24"))
                    If "" & .Fields("cu25") <> MsgText(601) Then strTemp(1) = RTrim(strTemp(1)) & " " & .Fields("cu25")
                    If "" & .Fields("cu26") <> MsgText(601) Then strTemp(1) = RTrim(strTemp(1)) & " " & .Fields("cu26")
                    If "" & .Fields("cu27") <> MsgText(601) Then strTemp(1) = RTrim(strTemp(1)) & " " & .Fields("cu27")
                    If "" & .Fields("cu28") <> MsgText(601) Then strTemp(1) = RTrim(strTemp(1)) & " " & .Fields("cu28")
                    If "" & .Fields("cu102") <> MsgText(601) Then strTemp(1) = RTrim(strTemp(1)) & " " & .Fields("cu102")
                    'Modify by Amy 2019/10/05 +案件英、日地址為空不需發
                    If strTemp(0) = strTemp(1) Then
                        '日文地址不同
                        If "" & .Fields("AJ") <> "" & .Fields("cu29") And Trim("" & .Fields("AJ")) <> MsgText(601) Then
                            bolIns = True
                        End If
                    'end 2019/10/05
                    '英文地址不同
                    ElseIf Trim(strTemp(0)) <> MsgText(601) Then
                        bolIns = True
                    End If
                '中文地址不同
                Else
                    bolIns = True
                End If
                If bolIns = True Then
                    strCmd = ""
                    For ii = 0 To 16 'cp57
                        strCmd = strCmd & "," & CNULL(ChgSQL("" & .Fields(ii)))
                    Next ii
                    '全部所有CFT案件(R014='Y'),承辦人以GetNP69抓
                    strCmd = "Insert Into RABD75 (R001,R002,R004,R005,R006,R007,R008,R009,R010,R011,R012,R003,R016,R017,R018,R019,R013,R014) Values" & _
                                    "(" & Mid(strCmd, 2) & ",'Y')"
                    cnnConnection.Execute strCmd
                End If
                RsQ.MoveNext
            Loop
        End If
        
    End With
    RsQ.Close
  
    '有收文未發文未取消收文,抓收文日最新收文號最小進度之承辦人,此道無承辦人設陳經理(68005)
    'Modify by Amy 2019/11/21 bug-應加入案號
    strQ = "Select Distinct R001,R004,R005,R006,R007 From  RABD75 Where R014='Y' And R016 is not null And R019 is null And R013 Is null "
    If RsQ.State <> adStateClosed Then RsQ.Close
    RsQ.CursorLocation = adUseClient
    RsQ.Open strQ, cnnConnection, adOpenStatic, adLockReadOnly
    With RsQ
        If .RecordCount > 0 Then
            .MoveFirst 'Modify by Amy 2019/11/22
            Do While .EOF = False
                'Modify by Amy 2019/11/21 bug-應加入案號
                strA = "And R016 is not null And R019 is null And R013 Is null And R001='" & RsQ.Fields("R001") & "' " & _
                          "And R004='" & RsQ.Fields("R004") & "' And R005='" & RsQ.Fields("R005") & "' And R006='" & RsQ.Fields("R006") & "' And R007='" & RsQ.Fields("R007") & "' "
                strA = "Select NVL(R018, '68005') From RABD75 Where R014='Y' " & strA & _
                            " And R016||R017=(Select Max(R016)||Min(R017) From RABD75 Where R014='Y' " & strA & _
                                                            " And R016=(Select Max(R016) From RABD75 Where R014='Y' " & strA & ")" & _
                                                         ")"
                If rsA.State <> adStateClosed Then rsA.Close
                rsA.CursorLocation = adUseClient
                rsA.Open strA, cnnConnection, adOpenStatic, adLockReadOnly
                If rsA.RecordCount > 0 Then
                    rsA.MoveFirst
                    Do While rsA.EOF = False
                        'Modify by Amy 2021/06/30 68005退休改抓CFT組別主管
                        strTemp(0) = "" & rsA.Fields(0)
                        If strTemp(0) = "68005" Then
                            strTemp(0) = GetCFTSt16Manager(RsQ.Fields("R004"), RsQ.Fields("R005"), RsQ.Fields("R006"), RsQ.Fields("R007"))
                        End If
                        'Modify by Amy 2019/11/21 bug-應加入案號
                        strCmd = "Update RABD75  Set R003='" & strTemp(0) & "',R015='Y' Where R014='Y' And R001='" & RsQ.Fields("R001") & "' " & _
                                        "And R004='" & RsQ.Fields("R004") & "' And R005='" & RsQ.Fields("R005") & "' And R006='" & RsQ.Fields("R006") & "' And R007='" & RsQ.Fields("R007") & "' "
                        'end 2021/06/30
                        cnnConnection.Execute strCmd
                        rsA.MoveNext
                    Loop
                End If
                .MoveNext
            Loop
        End If
    End With
    RsQ.Close
    
    'Add by Amy 2025/10/30 智權為國外部(st15=F開頭)者,改抓CFT收文日最大且為A類的智權,若其人員離職發給其主管(有st93的主管,沒st93發電腦中心-程式管理人員)
    ' 因1141016 81011(林宜儒)修改 X4538900 地址 1141017 發給 A8013(莊瑄凡)
    strCmd = "Update RABD75  Set (R020,R021)=(Select cu13,st15 From Customer,Staff Where R014='Y' And R001=cu01 And R002=cu02 And cu13=st01 ) "
    cnnConnection.Execute strCmd
     
    strTemp(0) = "": strTemp(1) = ""
    '讀取CFT且客戶智權人員為F部門
    strQ = "Select Distinct R001,R004,R005,R006,R007 From  RABD75 Where R014='Y' And R004='CFT' And SubStr(R021,1,1)='F' "
    If RsQ.State <> adStateClosed Then RsQ.Close
    RsQ.CursorLocation = adUseClient
    RsQ.Open strQ, cnnConnection, adOpenStatic, adLockReadOnly
    With RsQ
      If .RecordCount > 0 Then
         .MoveFirst
         Do While .EOF = False
            '抓CFT收文日最大且為A類的智權
            strA = "And CP01='" & RsQ.Fields("R004") & "' And CP02='" & RsQ.Fields("R005") & "' And CP03='" & RsQ.Fields("R006") & "' And CP04='" & RsQ.Fields("R007") & "' " & _
                        "And CP09<'B' "
            strA = "Select cp13,st15 From CaseProgress,Staff Where cp13=st01(+) " & strA & _
                        "And cp05||cp09=(Select Max(cp05)||Min(cp09) From CaseProgress Where 1=1 " & strA & _
                                                            " And cp05=(Select Max(cp05) From CaseProgress Where 1=1 " & strA & ")" & _
                                                            ")"
            If rsA.State <> adStateClosed Then rsA.Close
            rsA.CursorLocation = adUseClient
            rsA.Open strA, cnnConnection, adOpenStatic, adLockReadOnly
            If rsA.RecordCount > 0 Then
               rsA.MoveFirst
               Do While rsA.EOF = False
                  strTemp(0) = "" & rsA.Fields("cp13")
                  strTemp(1) = "" & rsA.Fields("st15")
                  '更新案號之智權人員及部門
                  strCmd = "And R004='" & RsQ.Fields("R004") & "' And R005='" & RsQ.Fields("R005") & "' And R006='" & RsQ.Fields("R006") & "' And R007='" & RsQ.Fields("R007") & "' "
                  strCmd = "Update RABD75  Set R020='" & strTemp(0) & "',R021='" & strTemp(1) & "' Where R014='Y' " & strCmd
                  cnnConnection.Execute strCmd
                  rsA.MoveNext
               Loop
            End If
            .MoveNext
         Loop
      End If
    End With
    
    '人員離職發給其主管(有st93的主管,沒st93發電腦中心-程式管理人員)
    strTemp(0) = ""
    strTemp(1) = Pub_GetSpecMan("程式管理人員")
    strQ = "Select Distinct R020,a0924 From  RABD75,Staff,Acc090New Where R014='Y' And R020=st01(+) And st04='2' And st93=a0921(+) "
    If RsQ.State <> adStateClosed Then RsQ.Close
    RsQ.CursorLocation = adUseClient
    RsQ.Open strQ, cnnConnection, adOpenStatic, adLockReadOnly
    With RsQ
      If RsQ.RecordCount > 0 Then
         .MoveFirst
         Do While .EOF = False
            strTemp(0) = "" & RsQ.Fields("A0924")
            If strTemp(0) = "" Then strTemp(0) = strTemp(1)
            'Memo 未回寫R021,因後面用不到
            strCmd = "Update RABD75  Set R020='" & strTemp(0) & "' Where R014='Y' And R020='" & RsQ.Fields("R020") & "' "
            cnnConnection.Execute strCmd
            .MoveNext
         Loop
      End If
    End With
    'end 2025/10/30
     
    '*** 抓取資料寄信給智權人員cu13 ***
    strMailC(0) = "上述客戶有CFT案件明細如附件，經查該客戶於民國"
    strMailC(1) = "修改地址，" & vbCrLf & "請與承辦人聯繫，討論是否辦理變更地址！" & vbCrLf & vbCrLf & "謹提醒如上。" & vbCrLf & vbCrLf & _
                          "附件資料需列印，請橫印！" & vbCrLf & vbCrLf
    'Modify by Amy 2025/10/30 智權為國外部(st15=F開頭)者,改抓CFT收文日最大且為A類的智權,若其人員離職發給其主管(有st93的主管,沒st93發電腦中心-程式管理人員)
'    strQ = "Select W.st02,na03,R004||'-'||R005||'-'||R006||'-'||R007 as CaseNo,R008 as CaseName,R009 as PClass,R011 as ApplyD,R012 as EndD" & _
'                ",cu13||S.st02 as CU13,R001 as CU01,Nvl(CU04,Nvl(cu05||' '||cu88||' '||cu89||' '||cu90,CU06)) as CusN,M13 as ModD " & _
'                "From RABD75 O,Customer,Nation,Staff W,(Select R001 as M01,R002 as  M02,R013 as M13 From RABD75 Where R014='C'),Staff S " & _
'                "Where R014='Y' And R001=cu01(+) And R002=cu02(+) And R010=na01(+) And R003=W.st01(+) And R001=M01(+) And R002=M02(+) And CU13=S.st01(+) " & _
'                "Order by ModD,cu13||S.st02,R001,R003,R010,R004,R005,R006,R007"
    strQ = "Select W.st02,na03,R004||'-'||R005||'-'||R006||'-'||R007 as CaseNo,R008 as CaseName,R009 as PClass,R011 as ApplyD,R012 as EndD" & _
                ",R020||S.st02 as CU13,R001 as CU01,Nvl(CU04,Nvl(cu05||' '||cu88||' '||cu89||' '||cu90,CU06)) as CusN,M13 as ModD " & _
                "From RABD75 O,Customer,Nation,Staff W,(Select R001 as M01,R002 as  M02,R013 as M13 From RABD75 Where R014='C'),Staff S " & _
                "Where R014='Y' And R001=cu01(+) And R002=cu02(+) And R010=na01(+) And R003=W.st01(+) And R001=M01(+) And R002=M02(+) And R020=S.st01(+) " & _
                "Order by R020||S.st02,ModD,R001,R003,R010,R004,R005,R006,R007"
                
    If RsQ.State <> adStateClosed Then RsQ.Close
    RsQ.CursorLocation = adUseClient
    RsQ.Open strQ, cnnConnection, adOpenStatic, adLockReadOnly
    With RsQ
         If .RecordCount > 0 Then
            .MoveFirst
            Do While .EOF = False
                '產生資料寄信
                'Modified by Lydia 2022/03/29 員工名稱有Unicode
                'If OldCU13 <> "" & .Fields("cu13") Or OldCU01 <> "" & .Fields("CU01") Then
                If OldCU13 <> PUB_UniToBIG5("" & .Fields("cu13"), "F") Or OldCU01 <> "" & .Fields("CU01") Then
                    If OldCU13 <> MsgText(601) Or OldCU01 <> MsgText(601) Then
                        If F1 > 0 Then Close #F1
                        strContent = "Dear Sirs," & vbCrLf & vbCrLf & _
                                             strMailC(0) & OldM13 & strMailC(1)
                        strAttnF = strApatch & OldCU13 & "-" & OldCU01 & strFileN
                        strTo = Left(OldCU13, 5)
                        SendMAPIMail strTo, OldCU01 & OldCusN & "地址變更提醒！", strContent, strAttnF
                    End If
                    Txt_Head = False
                End If
                If Txt_Head = False Then
                    F1 = FreeFile
                    'Modified by Lydia 2022/03/29 員工名稱有Unicode
                    'Open strApatch & "" & .Fields("cu13") & "-" & .Fields("CU01") & strFileN For Output As F1
                    Open strApatch & PUB_UniToBIG5("" & .Fields("cu13"), "F") & "-" & .Fields("CU01") & strFileN For Output As F1
                    Print #F1, "                                             " & "" & .Fields("CU01") & .Fields("CusN") & "地址變更案件明細"
                    Print #F1, "列印日期：" & ChangeWStringToTString(strSrvDate(1))
                    Print #F1, "承辦人員 申請國家   本所案號         案件名稱                       商品類別                          申請日     專用期止日 "
                    Print #F1, "======== ========== ================ ============================== ================================= ========== ========== "
                    Txt_Head = True
                    bolData = False
                End If
                
                For ii = 0 To UBound(strTemp)
                    strTemp(ii) = "" & .Fields(ii)
                Next ii
                
                strTemp(0) = convForm(CheckStr(strTemp(0)), 8)   '承辦人
                strTemp(1) = convForm(CheckStr(strTemp(1)), 10) '申請國家
                strTemp(2) = convForm(CheckStr(strTemp(2)), 16) '本所案號
                strTemp(3) = convForm(CheckStr(strTemp(3)), 30) '案件名稱
                strTemp(4) = convForm(CheckStr(strTemp(4) & IIf(Len(strTemp(4)) > 30, "...", "")), 33) '商品類別
                strTemp(5) = convForm(CheckStr(ChangeWStringToWDateString(strTemp(5))), 10) '申請日
                strTemp(6) = convForm(CheckStr(ChangeWStringToWDateString(strTemp(6))), 10) '專用期止日
                
                Print #F1, strTemp(0) & " " & strTemp(1) & " " & strTemp(2) & " " & strTemp(3) & " " & strTemp(4) & _
                          " " & strTemp(5) & " " & strTemp(6)
               
                'Modified by Lydia 2022/03/29 員工名稱有Unicode
                'OldCU13 = "" & .Fields("cu13")
                OldCU13 = PUB_UniToBIG5("" & .Fields("cu13"), "F")
                OldCU01 = "" & .Fields("CU01")
                OldCusN = "" & .Fields("CusN")
                OldM13 = Left("" & .Fields("ModD"), 4) - 1911 & "年" & Mid("" & .Fields("ModD"), 5, 2) & "月" & Mid("" & .Fields("ModD"), 7, 2) & "日"
                .MoveNext
            Loop
        End If
    End With
    If F1 > 0 Then
        Close F1
        If OldCU13 <> MsgText(601) Then
            strContent = "Dear Sirs," & vbCrLf & vbCrLf & _
                                strMailC(0) & OldM13 & strMailC(1)
            strAttnF = strApatch & OldCU13 & "-" & OldCU01 & strFileN
            strTo = Left(OldCU13, 5)
            SendMAPIMail strTo, OldCU01 & OldCusN & "地址變更提醒！", strContent, strAttnF
        End If
    End If
    RsQ.Close
    
    '*** 抓取CFT所有案件(含收文未發文案件)2份清單,寄信給承辦人cp14(承辦人null寄給F10部門主管)或NA69 ***
    Erase strTemp
    OldCU13 = "": OldCU01 = "": OldCU01 = "": OldM13 = "": strAttnF = "": strAttnF = "": Txt_Head = False: bolData = False: bolIsFirst = True
    strMailC(0) = "，請參考案件明細與智權人員"
    strMailC(1) = "，討論是否辦理變更地址！" & vbCrLf & vbCrLf & "請橫印！" & vbCrLf & vbCrLf
    'Modify by Amy 2025/10/30 改排序 原:ModD,R003,R001,cu13,R010,R004,R005,R006,R007且原抓cu13改抓R020 避免同一人收不止一個檔
'    strQ = "Select na03,R004||'-'||R005||'-'||R006||'-'||R007 as CaseNo,R008 as CaseName,R009 as PClass,R011 as ApplyD,R012 as EndD" & _
'                ",S.st02,R003||W.st02 as cp14,R001 as CU01,Nvl(CU04,Nvl(cu05||' '||cu88||' '||cu89||' '||cu90,CU06)) as CusN,M13 as ModD,R015 " & _
'                "From RABD75 O,Customer,Nation,Staff S,(Select R001 as M01,R002 as  M02,R013 as M13 From RABD75 Where R014='C'),Staff W " & _
'                "Where R014='Y' And R001=cu01(+) And R002=cu02(+) And R010=na01(+) And cu13=S.st01(+) And R001=M01(+) And R002=M02(+) And R003=W.st01(+) " & _
'                "Order by ModD,R003,R001,cu13,R010,R004,R005,R006,R007"
    strQ = "Select na03,R004||'-'||R005||'-'||R006||'-'||R007 as CaseNo,R008 as CaseName,R009 as PClass,R011 as ApplyD,R012 as EndD" & _
                ",S.st02,R003||W.st02 as cp14,R001 as CU01,Nvl(CU04,Nvl(cu05||' '||cu88||' '||cu89||' '||cu90,CU06)) as CusN,M13 as ModD,R015 " & _
                "From RABD75 O,Customer,Nation,Staff S,(Select R001 as M01,R002 as  M02,R013 as M13 From RABD75 Where R014='C'),Staff W " & _
                "Where R014='Y' And R001=cu01(+) And R002=cu02(+) And R010=na01(+) And R020=S.st01(+) And R001=M01(+) And R002=M02(+) And R003=W.st01(+) " & _
                "Order by R003,ModD,R001,R020,R010,R004,R005,R006,R007"
    If RsQ.State <> adStateClosed Then RsQ.Close
    RsQ.CursorLocation = adUseClient
    RsQ.Open strQ, cnnConnection, adOpenStatic, adLockReadOnly
    With RsQ
        If .RecordCount > 0 Then
            .MoveFirst
            Do While .EOF = False
                '產生資料寄信
                'Modified by Lydia 2022/03/29 員工名稱有Unicode
                'If bolIsFirst = False And (oldCP14 <> "" & .Fields("cp14") Or OldCU01 <> "" & .Fields("CU01")) Then
                If bolIsFirst = False And (oldCP14 <> PUB_UniToBIG5("" & .Fields("cp14"), "F") Or OldCU01 <> "" & .Fields("CU01")) Then
                    strTo = "": strAttnF = ""
                    If oldCP14 = MsgText(601) Then
                        strTo = stDeptMan '承辦人為空寄給F10主管
                    Else
                        strTo = Left(oldCP14, 5)
                    End If
                    If F1 > 0 Then Close #F1
                    strAttnF = strApatch & oldCP14 & "-" & OldCU01 & "-全部" & strFileN
                    If F2 > 0 Then Close #F2
                    If bolData = True Then strAttnF = strAttnF & ";" & strApatch & oldCP14 & "-" & OldCU01 & "-收文未發文" & strFileN
                    strContent = "Dear Sirs," & vbCrLf & vbCrLf & _
                                        "此客戶於民國" & OldM13 & strMailC(0) & "(" & OldCU13 & ")" & strMailC(1)
                    SendMAPIMail strTo, OldCU01 & OldCusN & "地址變更提醒！", strContent, strAttnF
                    
                    bolData = False
                    Txt_Head = False
                End If
                If Txt_Head = False Then
                    F1 = FreeFile
                    'Modified by Lydia 2022/03/29 員工名稱有Unicode
                    'Open strApatch & "" & .Fields("cp14") & "-" & .Fields("CU01") & "-全部" & strFileN For Output As F1
                    Open strApatch & PUB_UniToBIG5("" & .Fields("cp14")) & "-" & .Fields("CU01") & "-全部" & strFileN For Output As F1
                    Print #F1, "                                             " & "" & .Fields("CU01") & .Fields("CusN") & "地址變更案件明細"
                    Print #F1, "列印日期：" & ChangeWStringToTString(strSrvDate(1))
                    Print #F1, "申請國家   本所案號         案件名稱                       商品類別                          申請日     專用期止日 "
                    Print #F1, "========== ================ ============================== ================================= ========== ========== "
                    
                    F2 = FreeFile
                    'Modified by Lydia 2022/03/29 員工名稱有Unicode
                    'Open strApatch & "" & .Fields("cp14") & "-" & .Fields("CU01") & "-收文未發文" & strFileN For Output As F2
                    Open strApatch & PUB_UniToBIG5("" & .Fields("cp14"), "F") & "-" & .Fields("CU01") & "-收文未發文" & strFileN For Output As F2
                    Print #F2, "                                   " & "" & .Fields("CU01") & .Fields("CusN") & "地址變更案件明細(收文未發文)"
                    Print #F2, "列印日期：" & ChangeWStringToTString(strSrvDate(1))
                    Print #F2, "申請國家   本所案號         案件名稱                       商品類別                          申請日     專用期止日 "
                    Print #F2, "========== ================ ============================== ================================= ========== ========== "
                    Txt_Head = True
                End If
                
                For ii = 0 To UBound(strTemp) - 1
                    strTemp(ii) = "" & .Fields(ii)
                Next ii
                
                strTemp(0) = convForm(CheckStr(strTemp(0)), 10) '申請國家
                strTemp(1) = convForm(CheckStr(strTemp(1)), 16) '本所案號
                strTemp(2) = convForm(CheckStr(strTemp(2)), 30) '案件名稱
                strTemp(3) = convForm(CheckStr(strTemp(3) & IIf(Len(strTemp(4)) > 30, "...", "")), 33) '商品類別
                strTemp(4) = convForm(CheckStr(ChangeWStringToWDateString(strTemp(4))), 10) '申請日
                strTemp(5) = convForm(CheckStr(ChangeWStringToWDateString(strTemp(5))), 10) '專用期止日
                
                Print #F1, strTemp(0) & " " & strTemp(1) & " " & strTemp(2) & " " & strTemp(3) & " " & strTemp(4) & _
                          " " & strTemp(5)
            
                If "" & .Fields("R015") = "Y" Then
                    If bolData = False Then bolData = True '是否為收文未發文資料,有資料同時寄此檔
                    Print #F2, strTemp(0) & " " & strTemp(1) & " " & strTemp(2) & " " & strTemp(3) & " " & strTemp(4) & _
                          " " & strTemp(5)
                End If
                 
                'Modifie by Lydia 2022/03/29 員工名稱有Unicode
                'oldCP14 = "" & .Fields("cp14")
                'OldCU13 = "" & .Fields("st02")
                oldCP14 = PUB_UniToBIG5("" & .Fields("cp14"))
                OldCU13 = PUB_UniToBIG5("" & .Fields("st02"), "F")
                'end 2022/03/29
                OldCU01 = "" & .Fields("CU01")
                OldCusN = "" & .Fields("CusN")
                OldM13 = Left("" & .Fields("ModD"), 4) - 1911 & "年" & Mid("" & .Fields("ModD"), 5, 2) & "月" & Mid("" & .Fields("ModD"), 7, 2) & "日修改地址"
                bolIsFirst = False
                .MoveNext
            Loop
            If F1 > 0 Then
                Close F1
                Close F2
                strAttnF = "": strTo = ""
                If oldCP14 = MsgText(601) Then
                    strTo = stDeptMan '承辦人為空寄給F10主管
                Else
                    strTo = Left(oldCP14, 5)
                End If
                strAttnF = strApatch & oldCP14 & "-" & OldCU01 & "-全部" & strFileN
                If bolData = True Then strAttnF = strAttnF & ";" & strApatch & oldCP14 & "-" & OldCU01 & "-收文未發文" & strFileN
                strContent = "Dear Sirs," & vbCrLf & vbCrLf & _
                                    "此客戶於民國" & OldM13 & strMailC(0) & "(" & OldCU13 & ")" & strMailC(1)
                SendMAPIMail strTo, OldCU01 & OldCusN & "地址變更提醒！", strContent, strAttnF
            End If
        End If
    End With
    RsQ.Close
    
    Set RsQ = Nothing
    Exit Sub
    
ErrHand:
    Set RsQ = Nothing
    Set rsA = Nothing
    If F1 > 0 Then Close F1
    If F2 > 0 Then Close F2
    WLog Err.Description
End Sub

'Add by Amy 2016/05/13 每週四發下週一至週日預約會議室部門列表給夏慧珠
Sub StrMenu76()
    Dim RsQ As New ADODB.Recordset
    Dim strQ As String
    Dim i As Integer, intRow As Integer
    Dim stStartD As String, stEndD As String
    Dim stTmp, intWidth
    Dim stTO As String 'Add by Amy 2021/01/11
    
On Error GoTo ErrHand
    stStartD = DBDATE(DateAdd("d", 4, Format(strSrvDate(1), "####/##/##")))
    stEndD = DBDATE(DateAdd("d", 6, Format(stStartD, "####/##/##")))
    
    '抓取RoomReservatio(非週期性資料)
    strQ = "Select rr01,rr02 as UseD,rr03,rr04,rr05,rr08,rr07 From RoomReservation Where rr02>=" & Val(stStartD) & " And rr02<=" & Val(stEndD) & " And rr18=0 "
    'Union RoomResDetail明細(週期性資料)
    strQ = strQ & "Union Select rr01,rd04 as UseD,rr03,rr04,rr05,rr08,rr07 From RoomResDetail,RoomReservation " & _
                          "Where rd04>= " & Val(stStartD) & " And rd04<=" & Val(stEndD) & " And rd05 is null And rr18=0 And rr01(+)=rd01 And rr02(+)=rd02 And rr03(+)=rd03 "
    '依日期、時間早至晚排序
    'Modified by Morgan 2021/5/27 改判斷有開放登記的會議室都要
    'strQ = "Select UseD,rr03 as UseT1,rr04 as UseT2,'' as Dept,rr08||' '||st02 as Content,MR03 as RoomN From Staff,MeetingRoom,(" & strQ & ") Where mr01<3 And rr01=MR01(+) And rr07=st01(+) Order by UseD,rr03,rr01"
    strQ = "Select UseD,rr03 as UseT1,rr04 as UseT2,'' as Dept,rr08||' '||st02 as Content,MR03||'-'||MR02 as RoomN From Staff,MeetingRoom,(" & strQ & ") Where mr04='1' and mr06='Y' And rr01=MR01(+) And rr07=st01(+) Order by UseD,rr03,rr01"
    RsQ.CursorLocation = adUseClient
    RsQ.Open strQ, cnnConnection, adOpenStatic, adLockReadOnly
    If RsQ.RecordCount > 0 Then
        intRow = 1
        stTmp = Array("日期", "時間", "部門", "訓練內容", "地點")
        intWidth = Array(2.3, 3.5, 3, 5.5, 3) 'Modify by Amy 2021/01/11 日期 原:2
        'Run Word
        If TypeName(g_WordAp) <> "Application" Then Set g_WordAp = New Word.Application
        g_WordAp.Documents.add
        g_WordAp.Visible = True
        g_WordAp.ActiveWindow.ActivePane.View.Zoom.Percentage = 100
        
        With g_WordAp.Application
            '版面設定
            .Selection.PageSetup.Orientation = wdOrientPortrait '直印 'wdOrientLandscape  '橫印
            .Selection.PageSetup.LeftMargin = .CentimetersToPoints(2)
            .Selection.PageSetup.RightMargin = .CentimetersToPoints(2)
            .Selection.PageSetup.TopMargin = .CentimetersToPoints(2)
            .Selection.PageSetup.BottomMargin = .CentimetersToPoints(2)
            .Selection.PageSetup.FooterDistance = .CentimetersToPoints(2)
            .Selection.Orientation = wdTextOrientationHorizontal
            .Selection.Font.Size = 12
            .Selection.Font.Name = "標楷體"
        
            '第一行顯示未來一週起迄日
            .Selection.TypeText Text:=ChangeWStringToTDateString(stStartD) & " ~ " & ChangeWStringToTDateString(stEndD)
            '新增表格(1*N)
            .Selection.Tables.add Range:=.Selection.Range, NumRows:=RsQ.RecordCount, NumColumns:=5
            '設定表格欄寬
            For i = LBound(intWidth) To UBound(intWidth)
                .Selection.TypeText Text:=stTmp(i)
                .Selection.SelectColumn
                .Selection.Cells.SetWidth ColumnWidth:=CentimetersToPoints(intWidth(i)), RulerStyle:=wdAdjustNone
                .Selection.Rows.SpaceBetweenColumns = CentimetersToPoints(0.1)
                .Selection.MoveRight Unit:=wdCell
                 'Add by Amy 2018/01/09 +格線
                With .Selection.Cells(1)
                    With .Borders(wdBorderLeft)
                        .LineStyle = wdLineStyleSingle
                        .LineWidth = wdLineWidth100pt
                        .ColorIndex = wdAuto
                    End With
                    With .Borders(wdBorderRight)
                        .LineStyle = wdLineStyleSingle
                        .LineWidth = wdLineWidth100pt
                        .ColorIndex = wdAuto
                    End With
                    With .Borders(wdBorderTop)
                        .LineStyle = wdLineStyleSingle
                        .LineWidth = wdLineWidth100pt
                        .ColorIndex = wdAuto
                    End With
                    With .Borders(wdBorderBottom)
                        .LineStyle = wdLineStyleSingle
                        .LineWidth = wdLineWidth100pt
                        .ColorIndex = wdAuto
                    End With
                End With
                'end 2018/01/09
                .Selection.MoveRight Unit:=wdCell
                'Add by Amy 2018/01/09 +格線
                With .Selection.Cells(1)
                    With .Borders(wdBorderLeft)
                        .LineStyle = wdLineStyleSingle
                        .LineWidth = wdLineWidth100pt
                        .ColorIndex = wdAuto
                    End With
                    With .Borders(wdBorderRight)
                        .LineStyle = wdLineStyleSingle
                        .LineWidth = wdLineWidth100pt
                        .ColorIndex = wdAuto
                    End With
                    With .Borders(wdBorderTop)
                        .LineStyle = wdLineStyleSingle
                        .LineWidth = wdLineWidth100pt
                        .ColorIndex = wdAuto
                    End With
                    With .Borders(wdBorderBottom)
                        .LineStyle = wdLineStyleSingle
                        .LineWidth = wdLineWidth100pt
                        .ColorIndex = wdAuto
                    End With
                End With
                'end 2018/01/09
            Next i
            
            RsQ.MoveFirst
            Do While Not RsQ.EOF
                For i = LBound(intWidth) To UBound(intWidth)
                    stTmp(i) = ""
                    Select Case i
                        Case 0 '日期
                            stTmp(i) = Mid(ChangeWStringToTDateString("" & RsQ.Fields("UseD")), 5)
                            'Modify by Amy 2021/01/11 +星期
                            'Modify by Amy 2024/12/26 2024/12/26 跑有2025年資料時,星期帶錯
                            stTmp(i) = stTmp(i) & "(" & Replace(GetWeekDay(CDate(Format(DBDATE("" & RsQ.Fields("UseD")), "####/##/##"))), "星期", "") & ")"
                        Case 1 '時間
                            stTmp(i) = Format(RsQ.Fields("UseT1"), "##:##") & " ~ " & "" & Format(RsQ.Fields("UseT2"), "##:##")
                        Case 2 '部門
                            stTmp(i) = "" & RsQ.Fields("Content")
                        Case 3 '訓練內容-User自行填寫
                        Case 4 '地點
                            stTmp(i) = "" & RsQ.Fields("RoomN")
                    End Select
                    .Selection.TypeText Text:=stTmp(i)
                    '控制避免多一列
                    If Not (RsQ.RecordCount = intRow And i = UBound(intWidth)) Then
                        .Selection.MoveRight Unit:=wdCell
                         'Add by Amy 2018/01/09 +格線
                         With .Selection.Cells(1)
                           With .Borders(wdBorderLeft)
                                .LineStyle = wdLineStyleSingle
                                .LineWidth = wdLineWidth100pt
                                .ColorIndex = wdAuto
                            End With
                            With .Borders(wdBorderRight)
                                .LineStyle = wdLineStyleSingle
                                .LineWidth = wdLineWidth100pt
                                .ColorIndex = wdAuto
                            End With
                            With .Borders(wdBorderTop)
                                .LineStyle = wdLineStyleSingle
                                .LineWidth = wdLineWidth100pt
                                .ColorIndex = wdAuto
                            End With
                            With .Borders(wdBorderBottom)
                                .LineStyle = wdLineStyleSingle
                                .LineWidth = wdLineWidth100pt
                                .ColorIndex = wdAuto
                            End With
                        End With
                        'end 2018/01/09
                    End If
                Next i
                intRow = intRow + 1
                RsQ.MoveNext
            Loop
            .ActiveDocument.SaveAs App.path & TextPath & Val(stStartD) - 19110000 & " ~" & Val(stEndD) - 19110000 & "會議室預約明細.doc"
            .Quit
            'SendMAPIMail "A2004", Val(stStartD) - 19110000 & " ~" & Val(stEndD) - 19110000 & "會議室預約明細", vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, App.path & TextPath & Val(stStartD) - 19110000 & " ~" & Val(stEndD) - 19110000 & "會議室預約明細.doc"
            'Modify By Sindy 2020/9/9 改發收件人 + ;74028;M15@taie.com.tw;M14@taie.com.tw
            'SendMAPIMail "75033", Val(stStartD) - 19110000 & " ~" & Val(stEndD) - 19110000 & "會議室預約明細", vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, App.path & TextPath & Val(stStartD) - 19110000 & " ~" & Val(stEndD) - 19110000 & "會議室預約明細.doc"
            'Modify by Amy 2021/01/11 改為變數
            If strSrvDate(1) <= "20200911" Then
                stTO = "75033;74028;M15@taie.com.tw;M14@taie.com.tw"
            Else
                'modify by sonia 2021/3/24 74028退休再改M11取消M15
                'stTO = "74028;M15@taie.com.tw;M14@taie.com.tw"
                stTO = "M11@taie.com.tw;M14@taie.com.tw"
            End If
            SendMAPIMail stTO, Val(stStartD) - 19110000 & " ~" & Val(stEndD) - 19110000 & "會議室預約明細", vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, App.path & TextPath & Val(stStartD) - 19110000 & " ~" & Val(stEndD) - 19110000 & "會議室預約明細.doc"
            'end 2021/01/11
            '2020/9/9 END
        End With
    End If
    
    Set RsQ = Nothing
    Exit Sub
    
ErrHand:
    Set RsQ = Nothing
    If TypeName(g_WordAp) = "Application" Then
        g_WordAp.ActiveDocument.SaveAs App.path & TextPath & Val(stStartD) - 19110000 & " ~" & Val(stEndD) - 19110000 & "會議室預約明細.doc"
        g_WordAp.Quit
    End If
    WLog Err.Description
End Sub

'Added By Lydia 2016/07/01 T案之國外收款及抵帳通知程序(原本在Frmacc2460-FC收據列印)
Sub StrMenu77()
Dim strDate As String
Dim rsA As New ADODB.Recordset
Dim f77 As Integer
Dim TFName As String
Dim iX As Integer
Dim strTemp(0 To 9) As String
Dim strTo As String
Dim strTLine As String
Dim SQLDate As String 'Added by Lydia 2016/10/19
Dim StrDate2 As String 'Added by Lydia 2017/06/06
Dim strNo(1 To 4) As String 'Added by Lydia 2018/01/05

'1.每個工作日執行
'2.以系統日之前一個工作日去抓ACC1P0(轉傳票分錄資料)的A1P18(入帳日期)且A1P02(分錄別)為'F'及'K',
'  (對沖代號(本所案號))且SUBSTR(A1P17, 1, Length(A1P17) - 9)='T'
'  (單據編號=匯票號碼+代理人號)且SUBSTR(A1P04,1,1) IN ('M','Z') 的資料,抓出 DISTINCT A1P04.
'3.A1P04若為'M'時, 以A1P04抓ACC0Z0國外收款資料(交易檔)之A0Z01收款單號,抓出每筆A0Z02請款編號再去串A1K01
'  且A1K13='T'(本所案號)且A1K29='Y'(是否結清)的資料.
'  A1P04若為 'Z'時, 以A1P04抓ACC1K0之A1K17(CF/FC抵帳編號)且A1K13='T'且A1K29='Y'的資料.
'4.再參考FC收據列印Frmacc2460通知程序的方式寄出.

On Error GoTo DebugErr
   
   'Modified by Lydia 2016/10/19 因為月初會做上月底的抵帳,可能會抓不到資料,所以每月第一個工作天不跑報表,次日抓系統日之前一~二個工作日的抵帳單
   'strDate = TransDate(CompWorkDay(2, strSrvDate(1), 1), 1)
   'Modified by Lydia 2017/01/10 改判斷更新日期,若傳票有修改會重複通知
'   strExc(2) = CompWorkDay(2, Mid(strSrvDate(1), 1, 6) & "01")  '每月第二個工作天
'   If strSrvDate(1) < strExc(2) Then '每月第一個工作天
'      GoTo JumpFirstDay
'   ElseIf strSrvDate(1) = strExc(2) Then '每月第二個工作天
'       strDate = TransDate(CompWorkDay(3, strSrvDate(1), 1), 1) & "-" & TransDate(CompWorkDay(2, strSrvDate(1), 1), 1) '系統日之前一~二個工作日
'       SQLDate = "A1P18 >=" & TransDate(CompWorkDay(3, strSrvDate(1), 1), 1) & " AND A1P18<=" & TransDate(CompWorkDay(2, strSrvDate(1), 1), 1)
'   Else
'       strDate = TransDate(CompWorkDay(2, strSrvDate(1), 1), 1) '系統日之前一個工作日
'       SQLDate = "A1P18=" & strDate
'   End If
'   'end 2016/10/19
   'Modified by Lydia 2017/02/15
   'SQLDate = "A1P28=" & TransDate(CompWorkDay(2, strSrvDate(1), 1), 1)
   strDate = TransDate(CompWorkDay(2, strSrvDate(1), 1), 1)
   StrDate2 = TransDate(CompDate(2, 1, DBDATE(strDate)), 1) 'Added by Lydia 2017/06/06 系統日之前一個工作日的次日
   'Modified by Lydia 2017/06/02 如果今日與前一日工作天非連續,則抓兩個日期之間的資料(ex.T204952因勞動節智慧局有上班,相關單位也有人配合上班)
   If Val(StrDate2) <> Val(strSrvDate(2)) Then
      StrDate2 = TransDate(CompDate(2, -1, strSrvDate(1)), 1)
      SQLDate = "A1P28>=" & strDate & " AND A1P28<=" & StrDate2
   Else
      SQLDate = "A1P28=" & strDate
   End If
   'end 2017/02/15
   'end 2017/06/06
   
   TFName = "T案之國外收款及抵帳通知"
   'Added by Lydia 2020/08/19 清除舊檔
   If Dir(App.path & TextPath & TFName & ".txt") <> "" Then
       Kill App.path & TextPath & TFName & ".txt"
   End If
   'end 2020/08/19

   'Added by Lydia 2020/08/18
   '國外收款
   'Modified by Lydia 2016/10/19 A1P18=" & strDate & "  => sqlDate
   'Modified by Lydia 2017/02/15 抓最近核准日或註冊證來函日
   'strSql = "SELECT A0Z01 PAYNO,A1K01,A1K03,DECODE(FA01,NULL,NVL(CU04,NVL(CU05,CU06)),NVL(FA04,NVL(FA05,FA06))) A1K03N,A1K13||'-'||A1K14||'-'||A1K15||'-'||A1K16 CASENO,TM05,TM10,NA03 " & _
            "From ACC0Z0, ACC1K0, TRADEMARK, NATION, FAGENT, CUSTOMER " & _
            "WHERE A0Z01 IN (SELECT DISTINCT A1P04 FROM ACC1P0 WHERE " & SQLDate & " AND A1P02='F' AND SUBSTR(A1P17, 1, LENGTH(A1P17) - 9)='T' AND SUBSTR(A1P04,1,1) IN ('M')) " & _
            "AND A0Z02=A1K01(+) AND A1K13='T' AND A1K29='Y' AND A1K13=TM01(+) AND A1K14=TM02(+) AND A1K15=TM03(+) AND A1K16=TM04(+) AND TM10=NA01(+) " & _
            "AND SUBSTR(A1K03,1,8)=FA01(+) AND SUBSTR(A1K03,9,1)=FA02(+) AND SUBSTR(A1K03,1,8)=CU01(+) AND SUBSTR(A1K03,9,1)=CU02(+) "
   'Modified by Lydia 2018/01/08 抓申請人1
   'strSql = "SELECT NVL(MCP05,0) MCP05,A0Z01 PAYNO,A1K01,A1K03,DECODE(FA01,NULL,NVL(CU04,NVL(CU05,CU06)),NVL(FA04,NVL(FA05,FA06))) A1K03N,A1K13||'-'||A1K14||'-'||A1K15||'-'||A1K16 CASENO,TM05,TM10,NA03 " & _
            "From ACC0Z0, ACC1K0, TRADEMARK, NATION, FAGENT, CUSTOMER,(SELECT CP01,CP02,CP03,CP04,MAX(CP05) MCP05 FROM CASEPROGRESS WHERE CP10 IN ('1001','1701') AND CP159=0 GROUP BY CP01,CP02,CP03,CP04) X " & _
            "WHERE A0Z01 IN (SELECT DISTINCT A1P04 FROM ACC1P0 WHERE " & SQLDate & " AND A1P02='F' AND SUBSTR(A1P17, 1, LENGTH(A1P17) - 9)='T' AND SUBSTR(A1P04,1,1) IN ('M')) " & _
            "AND A0Z02=A1K01(+) AND A1K13='T' AND A1K29='Y' AND A1K13=TM01(+) AND A1K14=TM02(+) AND A1K15=TM03(+) AND A1K16=TM04(+) AND TM10=NA01(+) " & _
            "AND SUBSTR(A1K03,1,8)=FA01(+) AND SUBSTR(A1K03,9,1)=FA02(+) AND SUBSTR(A1K03,1,8)=CU01(+) AND SUBSTR(A1K03,9,1)=CU02(+) AND CP01(+)=TM01 AND CP02(+)=TM02 AND CP03(+)=TM03 AND CP04(+)=TM04 "
   'Modify By Sindy 2020/12/11 + ,fa119
   strSql = "SELECT NVL(MCP05,0) MCP05,A0Z01 PAYNO,A1K01,A1K03,DECODE(FA01,NULL,NVL(C1.CU04,NVL(C1.CU05,C1.CU06)),NVL(FA04,NVL(FA05,FA06))) A1K03N,A1K13||'-'||A1K14||'-'||A1K15||'-'||A1K16 CASENO,TM05,TM10,NA03,NVL(C2.CU04,NVL(C2.CU05,C2.CU06)) TM23N,fa119 " & _
            "From ACC0Z0, ACC1K0, TRADEMARK, NATION, FAGENT, CUSTOMER C1,CUSTOMER C2,(SELECT CP01,CP02,CP03,CP04,MAX(CP05) MCP05 FROM CASEPROGRESS WHERE CP10 IN ('1001','1701') AND CP159=0 GROUP BY CP01,CP02,CP03,CP04) X " & _
            "WHERE A0Z01 IN (SELECT DISTINCT A1P04 FROM ACC1P0 WHERE " & SQLDate & " AND A1P02='F' AND SUBSTR(A1P17, 1, LENGTH(A1P17) - 9)='T' AND SUBSTR(A1P04,1,1) IN ('M')) " & _
            "AND A0Z02=A1K01(+) AND A1K13='T' AND A1K29='Y' AND A1K13=TM01(+) AND A1K14=TM02(+) AND A1K15=TM03(+) AND A1K16=TM04(+) AND TM10=NA01(+) " & _
            "AND SUBSTR(TM23,1,8)=C2.CU01(+) AND SUBSTR(TM23,9,1)=C2.CU02(+) " & _
            "AND SUBSTR(A1K03,1,8)=FA01(+) AND SUBSTR(A1K03,9,1)=FA02(+) AND SUBSTR(A1K03,1,8)=C1.CU01(+) AND SUBSTR(A1K03,9,1)=C1.CU02(+) AND CP01(+)=TM01 AND CP02(+)=TM02 AND CP03(+)=TM03 AND CP04(+)=TM04 "
            
   '抵帳
   'Modified by Lydia 2016/10/19 A1P18=" & strDate & "  => sqlDate
   'Modified by Lydia 2017/02/15 抓最近核准日或註冊證來函日
   'strSql = strSql & "Union SELECT A1K17, A1K01,A1K03,DECODE(FA01,NULL,NVL(CU04,NVL(CU05,CU06)),NVL(FA04,NVL(FA05,FA06))) A1K03N,A1K13||'-'||A1K14||'-'||A1K15||'-'||A1K16 CASENO,TM05,TM10,NA03 " & _
            "From ACC1K0, TRADEMARK, NATION, FAGENT, CUSTOMER " & _
            "WHERE A1K17 IN (SELECT DISTINCT A1P04 FROM ACC1P0 WHERE " & SQLDate & " AND A1P02='K' AND SUBSTR(A1P17, 1, LENGTH(A1P17) - 9)='T' AND SUBSTR(A1P04,1,1) IN ('Z')) " & _
            "AND A1K13='T' AND A1K29='Y' AND A1K13=TM01(+) AND A1K14=TM02(+) AND A1K15=TM03(+) AND A1K16=TM04(+) AND TM10=NA01(+) " & _
            "AND SUBSTR(A1K03,1,8)=FA01(+) AND SUBSTR(A1K03,9,1)=FA02(+) AND SUBSTR(A1K03,1,8)=CU01(+) AND SUBSTR(A1K03,9,1)=CU02(+) "
   'Modified by Lydia 2018/01/08 抓申請人1
   'strSql = strSql & "Union SELECT NVL(MCP05,0) MCP05,A1K17, A1K01,A1K03,DECODE(FA01,NULL,NVL(CU04,NVL(CU05,CU06)),NVL(FA04,NVL(FA05,FA06))) A1K03N,A1K13||'-'||A1K14||'-'||A1K15||'-'||A1K16 CASENO,TM05,TM10,NA03 " & _
            "From ACC1K0, TRADEMARK, NATION, FAGENT, CUSTOMER,(SELECT CP01,CP02,CP03,CP04,MAX(CP05) MCP05 FROM CASEPROGRESS WHERE CP10 IN ('1001','1701') AND CP159=0 GROUP BY CP01,CP02,CP03,CP04) X " & _
            "WHERE A1K17 IN (SELECT DISTINCT A1P04 FROM ACC1P0 WHERE " & SQLDate & " AND A1P02='K' AND SUBSTR(A1P17, 1, LENGTH(A1P17) - 9)='T' AND SUBSTR(A1P04,1,1) IN ('Z')) " & _
            "AND A1K13='T' AND A1K29='Y' AND A1K13=TM01(+) AND A1K14=TM02(+) AND A1K15=TM03(+) AND A1K16=TM04(+) AND TM10=NA01(+) " & _
            "AND SUBSTR(A1K03,1,8)=FA01(+) AND SUBSTR(A1K03,9,1)=FA02(+) AND SUBSTR(A1K03,1,8)=CU01(+) AND SUBSTR(A1K03,9,1)=CU02(+) AND CP01(+)=TM01 AND CP02(+)=TM02 AND CP03(+)=TM03 AND CP04(+)=TM04 "
   'Modify By Sindy 2020/12/11 + ,fa119
   strSql = strSql & "Union SELECT NVL(MCP05,0) MCP05,A1K17, A1K01,A1K03,DECODE(FA01,NULL,NVL(C1.CU04,NVL(C1.CU05,C1.CU06)),NVL(FA04,NVL(FA05,FA06))) A1K03N,A1K13||'-'||A1K14||'-'||A1K15||'-'||A1K16 CASENO,TM05,TM10,NA03,NVL(C2.CU04,NVL(C2.CU05,C2.CU06)) TM23N,fa119 " & _
            "From ACC1K0, TRADEMARK, NATION, FAGENT, CUSTOMER C1,CUSTOMER C2,(SELECT CP01,CP02,CP03,CP04,MAX(CP05) MCP05 FROM CASEPROGRESS WHERE CP10 IN ('1001','1701') AND CP159=0 GROUP BY CP01,CP02,CP03,CP04) X " & _
            " WHERE A1K17 IN (SELECT DISTINCT A1P04 FROM ACC1P0 WHERE " & SQLDate & " AND A1P02='K' AND SUBSTR(A1P17, 1, LENGTH(A1P17) - 9)='T' AND SUBSTR(A1P04,1,1) IN ('Z')) " & _
            "AND A1K13='T' AND A1K29='Y' AND A1K13=TM01(+) AND A1K14=TM02(+) AND A1K15=TM03(+) AND A1K16=TM04(+) AND TM10=NA01(+) " & _
            "AND SUBSTR(TM23,1,8)=C2.CU01(+) AND SUBSTR(TM23,9,1)=C2.CU02(+) " & _
            "AND SUBSTR(A1K03,1,8)=FA01(+) AND SUBSTR(A1K03,9,1)=FA02(+) AND SUBSTR(A1K03,1,8)=C1.CU01(+) AND SUBSTR(A1K03,9,1)=C1.CU02(+) AND CP01(+)=TM01 AND CP02(+)=TM02 AND CP03(+)=TM03 AND CP04(+)=TM04 "
            
   'Modified by Lydia 2017/02/15 依核准日或註冊證來函日排序
   'strSql = strSql & "ORDER BY 3,5" '依代理人+本所案號排序
   strSql = strSql & "ORDER BY MCP05,CASENO"
   
   CheckOC
   Set rsA = New ADODB.Recordset
   rsA.CursorLocation = adUseClient
   rsA.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   With rsA
      If .RecordCount > 0 Then
         .MoveFirst
         Do While Not .EOF
            'Added by Lydia 2017/10/12 配合收款寄證控制，增加檢查：若目前案件有未發文的收款寄證D類進度才發通知信，減少多餘資料。
            strExc(0) = Replace("" & .Fields("caseno"), "-", "")
            'Modified by Lydia 2018/01/05 有1003-1004(勝訴或敗訴)也要通知by桂英
            'ChgCaseNo strExc(0), strExc
            'strExc(0) = "select count(*) cnt from caseprogress where cp01='" & strExc(1) & "' and cp02='" & strExc(2) & "' and cp03='" & strExc(3) & "' and cp04='" & strExc(4) & "' and substr(cp09,1,1)='D' and cp158=0 and cp159 =0 "
            'Memo by Lydia 2019/03/14 因為申請人拆編號(Y31435000)所以異動Acc1p0資料(ex.M10104072),造成誤通知
            ChgCaseNo strExc(0), strNo
            strExc(0) = "select count(*) cnt from caseprogress where cp01='" & strNo(1) & "' and cp02='" & strNo(2) & "' and cp03='" & strNo(3) & "' and cp04='" & strNo(4) & "' " & _
                              "and ((substr(cp09,1,1)='D' and cp158=0 and cp159 =0) or (cp10 ='1003' or cp10='1004')) "
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               If Val("" & RsTemp.Fields("cnt")) = 0 Then
                  GoTo JumpNextRec
               End If
            End If
            'end 2017/10/12
            
            If iX = 0 Then
                f77 = FreeFile
                iX = 0
                Open App.path & TextPath & TFName & ".txt" For Output As f77
                'Added by Lydia 2016/10/19 加報表抬頭
                Print #f77, Space(40) & TFName
                Print #f77, ""
                'end 2016/10/19
                
                'Modified by Lydia 2016/10/19
                'Print #f77, "入帳日期：" & strDate & Space(80) & "列印日期：" & ChangeWStringToTString(strSrvDate(1))
                'Modified by Lydia 2017/06/06 入帳日期改為期間
                'Print #f77, "入帳日期：" & strDate & IIf(Len(strDate) < 10, Space(80), Space(72)) & "列印日期：" & ChangeWStringToTString(strSrvDate(1))
                Print #f77, "入帳日期：" & IIf(InStr(UCase(SQLDate), "AND") > 0, strDate & "-" & StrDate2, strDate) & IIf(Len(strDate) < 10, Space(80), Space(72)) & "列印日期：" & ChangeWStringToTString(strSrvDate(1))
                Print #f77, vbCrLf
                'Modified by Lydia 2017/02/15
                'Print #f77, "收款/抵帳單號   請款編號        代理人編號 代理人名稱                     本所案號        案件名稱                       申請國家"
                ' strTLine = "=============== =============== ========== ============================== =============== ============================== =========="
                'Modified by Lydia 2018/01/05 刪除"請款編號","代理人編號",增加"申請人名稱,"
                'Print #f77, "核准日/註冊證來函日   請款編號        代理人編號 代理人名稱                     本所案號        案件名稱                       申請國家"
                ' strTLine = "=================== =============== ========== ============================== =============== ============================== =========="
                Print #f77, convForm("核准日/註冊證來函日", 20) & convForm("申請人名稱", 31) & convForm("代理人名稱", 31) & convForm("本所案號", 16) & convForm("案件名稱", 31) & convForm("申請國家", 10)
                strTLine = String(19, "=") & " " & String(30, "=") & " " & String(30, "=") & " " & String(15, "=") & " " & String(30, "=") & " " & String(10, "=")
                'end 2018/01/05
                Print #f77, strTLine
            End If
            'Modified by Lydia 2017/02/15
            'strTemp(0) = convForm("" & .Fields("PAYNO"), 15)
            If "" & .Fields("MCP05") = "0" Then
                strTemp(0) = convForm("", 19)
            Else
                strTemp(0) = convForm(TransDate("" & .Fields("MCP05"), 1), 19)
            End If
            'end 2017/02/15
            
             'Modified by Lydia 2018/01/05 刪除"請款編號","代理人編號",增加"申請人名稱," by 芸如
'            strTemp(1) = convForm("" & .Fields("A1K01"), 15)
'            strTemp(2) = convForm("" & .Fields("A1K03"), 10)
'            strTemp(3) = convForm("" & .Fields("A1K03N"), 30)
'            strTemp(4) = convForm("" & .Fields("CASENO"), 15)
'            strTemp(5) = convForm("" & .Fields("TM05"), 30)
'            strTemp(6) = convForm("" & .Fields("NA03"), 10)
'            Print #f77, strTemp(0) & " " & strTemp(1) & " " & strTemp(2) & " " & strTemp(3) & " " & strTemp(4) & " " & strTemp(5) & " " & strTemp(6)
            strTemp(1) = convForm("" & .Fields("TM23N"), 30)
            strTemp(2) = convForm("" & .Fields("A1K03N"), 30)
            strTemp(3) = convForm("" & .Fields("CASENO"), 15)
            strTemp(4) = convForm("" & .Fields("TM05"), 30)
            strTemp(5) = convForm("" & .Fields("NA03"), 10)
            Print #f77, strTemp(0) & " " & strTemp(1) & " " & strTemp(2) & " " & strTemp(3) & " " & strTemp(4) & " " & strTemp(5)
            Print #f77, "陸代定稿加註:" & .Fields("fa119") 'Add By Sindy 2020/12/11 陸代定稿加註
            'end 2018/01/05
            iX = iX + 1
JumpNextRec: 'Added by Lydia 2017/10/12
            .MoveNext
         Loop
         
         If f77 > 0 Then 'Added by Lydia 2017/10/12
            Print #f77, String(Len(strTLine), "=")
            Print #f77, "共 " & iX & " 筆"
         End If 'end 2017/10/12
      End If
   End With
   
   If f77 > 0 Then
       Close f77
       strTo = Pub_GetSpecMan("P")   '收件人
       SendMAPIMail strTo, TFName, vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, App.path & TextPath & TFName & ".txt"
   End If
   
   Set rsA = Nothing
'Added by Lydia 2016/10/19
JumpFirstDay:
   Exit Sub
    
DebugErr:
   Set rsA = Nothing
   WLog Err.Description
End Sub

'Added by Lydia 2016/08/23 DHL提單號碼使用狀況提醒
Private Sub StrMenu78()
Dim strTemp As String
Dim MaxNo As String
Dim rsRD As New ADODB.Recordset
Dim intX As Integer
Dim LimitDate As String 'Added by Lydia 2018/07/18

   
On Error GoTo DebugErr  'Added by Lydia 2018/07/18
    
    'Modified by Lydia 2018/07/18 +使用期限DSN07
    strTemp = "select DSN01,DSN02,DSN05,DSN07 from dhlshipmentno where dsn03 is null order by dsn05 "
    intX = 1
    Set rsRD = ClsLawReadRstMsg(intX, strTemp)
    If intX = 0 Then
       SendMAPIMail "A3034", "DHL提單號碼使用狀況提醒", vbCrLf & "無可使用的DHL提單號碼!"
    ElseIf rsRD.RecordCount = 1 Then '只有一組號碼時
        MaxNo = "" & rsRD(1)
        LimitDate = "" & rsRD.Fields("DSN07") 'Added by Lydia 2018/07/18 使用期限
        strTemp = "select nvl(max(dun01),'1') mno from dhluseno where dun01>='" & rsRD(0) & "' and dun01<='" & rsRD(1) & "' "
        intX = 1
        Set RsTemp = ClsLawReadRstMsg(intX, strTemp)
        'Added by Lydia 2018/07/18 判斷使用期限剩14天也發通知
        'Modified by Lydia 2019/04/17 改成－３個工作日
        'If LimitDate <> "" And CompDate(2, -14, LimitDate) <= strSrvDate(1) Then GoTo JumpEmail
        If LimitDate <> "" And CompWorkDay(4, LimitDate, 1) <= strSrvDate(1) Then GoTo JumpEmail
        
        If Trim(RsTemp.Fields("MNO")) <> "1" Then
           'Modified by Lydia 2017/03/20 判斷低於100個號碼,就發mail
           'Modified by Lydia 2018/07/18 和DHL要到新的提單號碼使用期限到10/31；所以調整當可用提單號碼為低於30個，才發mail通知。
           If Val(Mid(MaxNo, 1, Len(MaxNo) - 1)) - Val(Mid(RsTemp.Fields("MNO"), 1, Len(RsTemp.Fields("MNO")) - 1)) < 30 Then
              'Modified by Lydia 2018/07/18 +使用期限LimitDate
JumpEmail: 'Added by Lydia 2018/07/18
              strTemp = vbCrLf & "使用期限:" & ChangeWStringToWDateString(LimitDate) & _
                              vbCrLf & "目前號碼:" & RsTemp.Fields("MNO") & _
                              vbCrLf & "最大號碼:" & MaxNo & _
                              vbCrLf & "剩餘號碼:" & Val(Mid(MaxNo, 1, Len(MaxNo) - 1)) - Val(Mid(RsTemp.Fields("MNO"), 1, Len(RsTemp.Fields("MNO")) - 1)) & _
                              vbCrLf & "請儘快聯絡DHL的資訊部門，取得新號碼!" & _
                              vbCrLf & vbCrLf & "聯絡單位：資訊部門"
              'Modified by Lydia 2022/04/20 換email
              'strTemp = strTemp & vbCrLf & "Mail : ecom.tw@dhl.com"
              strTemp = strTemp & vbCrLf & "Mail : twesshd@dhl.com"
              strTemp = strTemp & vbCrLf & "Tel :02-2182-6838"
              strTemp = strTemp & vbCrLf & String(40, "-") & vbCrLf & "Step 1 :聯絡DHL，要到新的提單號碼要檢查提單號碼的最後一碼是否為檢查碼(0~6)。"
              strTemp = strTemp & "(注意!!DHL來信的寄件者有多加東西，可能會被防火牆隔離。)" 'Added by Morgan 2017/7/6
              'Modified by Lydia 2018/07/18 +使用期限DSN07
              strTemp = strTemp & vbCrLf & vbCrLf & "Step 2 :新增DHLShipmentNo記錄:" & vbCrLf & "INSERT INTO DHLSHIPMENTNO(DSN01,DSN02,DSN03,DSN04,DSN05,DSN06,DSN07) VALUES ('起始號碼','終止號碼',NULL,strUserNo,ServerDate,ServerTime,使用期限);"
              SendMAPIMail "A3034", "DHL提單號碼使用狀況提醒", strTemp
           End If
        End If
    End If
    
'Added by Lydia 2018/07/18
   Set rsRD = Nothing
   Exit Sub
   
DebugErr:
   Set rsRD = Nothing
   WLog Err.Description
End Sub

'Added by Lydia 2016/10/26 查名單歷史資料刪除(商標每月1、16號公告約在三天後拿到註冊證)
'Memo by Lydia 2018/03/22 只刪除查名附件(TS.PDF),保留委查單(TradeMarkQuery,TMQDetail),用TMQ20判斷是否已刪除明細
'Memo by Lydia 2018/03/23 先暫停 (嘉雯: 反應找不到T211730的委查單HA6090926)
'Memo by Lydia 2018/03/28 恢復執行 (資料已補,並且修正問題)
'                                          修改-保留完整委查單記錄檔(TMQApp,TradeMarkQuery,TMQDetail,TMQFile.TQF02='0'的輸入附件)
Private Sub StrMenu79()
Dim rsQuery As New ADODB.Recordset
Dim rsChk As New ADODB.Recordset
Dim strQ1 As String, strA1 As String
Dim strDate As String
Dim inX As Integer, intCnt As Integer
Dim listTQA01 As String '有刪除資料的查名單申請編號
Dim m_strMemo As String, intP As Integer 'Added by Lydia 2023/05/15

'刪除歷史檔的原則
'1.T案,領註冊證(TM20)起算六個月後刪除;不准,則閉卷後刪除
'2.TS案轉T案,刪除時點同T案
'3.TS案,查覆時間起算一年後刪除
'4.其他未申請的查名單(6個月以前)
  listTQA01 = ","
  
'cnnConnection.BeginTrans 'Mark by Lydia 2023/09/20
  '清除超過一個月未收文的對照檔
  'Mark by Lydia 2023/09/20
  '  strA1 = "delete from tmqcasemap where tqc05<=TO_CHAR(ADD_MONTHS(sysdate,-1),'YYYYMMDD') and tqc02 is null "
  '  cnnConnection.Execute strA1, intI
  'end 'Mark by Lydia 2023/09/20
  '修正未回寫的TMQ21
    strQ1 = "select tmq01,tmq18,tmq19,tmq20,tmq21,tqc02 from trademarkquery,tmqcasemap where tmq18>'H' and tmq21 is null and tmq01=tqc03 and tqc02>'A' order by 1,2,tqc02 "
    inX = 1
    Set rsQuery = ClsLawReadRstMsg(inX, strQ1)
    If inX = 1 Then
       cnnConnection.BeginTrans 'Added by Lydia 2023/09/20
       rsQuery.MoveFirst
       Do While Not rsQuery.EOF
          'Modified by Lydia 2018/03/27 debug
          'strA1 = "update trademarkquery set tmq21='" & rsQuery.Fields("tmq01") & "' where tmq01='" & rsQuery.Fields("tqc02") & "' and tmq21 is null"
          strA1 = "update trademarkquery set tmq21='" & rsQuery.Fields("tqc02") & "' where tmq01='" & rsQuery.Fields("tmq01") & "' and tmq21 is null"
          cnnConnection.Execute strA1, intI
          rsQuery.MoveNext
       Loop
       cnnConnection.CommitTrans 'Added by Lydia 2023/09/20
    End If
    
    'Added by Lydia 2024/11/12
    If strSrvDate(1) >= 查名單網中系統啟用日 Then
       strQ1 = "select tma01,tqc02 from tmqappform, tmqcasemap where nvl(tma34,'N')='N' and tma01=tqc03 and tqc02>'A' order by 2,1"
       inX = 1
       Set rsQuery = ClsLawReadRstMsg(inX, strQ1)
       If inX = 1 Then
          cnnConnection.BeginTrans
          rsQuery.MoveFirst
          Do While Not rsQuery.EOF
             strA1 = "update tmqappform set tma34='" & rsQuery.Fields("tqc02") & "' where tma01='" & rsQuery.Fields("tma01") & "' and nvl(tma34,'N')='N' "
             cnnConnection.Execute strA1, intI
             rsQuery.MoveNext
          Loop
          cnnConnection.CommitTrans
       End If
    End If
    Set rsQuery = Nothing
    'end 2024/11/12
    'Exit Sub 'Added by Lydia 2023/09/20 關於查名刪除的時點,商標部會再討論及修改; 所以請從即日起，先暫停執行所有刪除作業。 'Mark by Lydia 2024/12/19 來電通知恢復刪除附件作業，恢復後第1次執行在12/20
    Exit Sub 'Added by Lydia 2025/05/27 網中要求重新匯出圖形查名，所以先中斷刪除附件，直到確定不用為止--嘉雯
'-------------------------------------------------------------
  For intCnt = 1 To 2
    If intCnt = 1 Then
       strDate = CompDate(1, -6, strSrvDate(1))
       '1.T案,領註冊證(TM20)起算六個月後刪除;不准,則閉卷後刪除;2.TS案轉T案,刪除時點同T案
       'Modified by Lydia 2018/03/20 用TMQ20判斷是否已刪除明細(+And nvl(tmq20,'N') = 'N')
       'Modified by Lydia 2020/11/04 判斷「覆核已核可」TQD09
       'strQ1 = "select tqc03,tqc02,cp01,cp02,cp03,cp04,tmq01,tmq18,tmq21 from tmqcasemap,caseprogress,trademark,trademarkquery " & _
                "where tqc02=cp09(+) and cp01='T' and cp158>0 and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+) and tqc03=tmq01(+)" & _
                "and ((nvl(tm20,0)>0 AND TM20<=" & strDate & ") or (TM16='2' AND TM29='Y')) " & _
                "And nvl(tmq20,'N') = 'N' order by tqc02,tqc03 "
       strQ1 = "select tqc03,tqc02,cp01,cp02,cp03,cp04,tmq01,tmq18,tmq21,sum(decode(tqd09,'1',1,0)) cnt " & _
                "from tmqcasemap,caseprogress,trademark,trademarkquery,tmqdetail " & _
                "where tqc02=cp09(+) and cp01='T' and cp158>0 and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+) and tqc03=tmq01(+) " & _
                "and ((nvl(tm20,0)>0 AND TM20<=" & strDate & ") or (TM16='2' AND TM29='Y')) " & _
                "And nvl(tmq20,'N') = 'N' and tmq01=tqd02(+) group by tqc03,tqc02,cp01,cp02,cp03,cp04,tmq01,tmq18,tmq21 order by tqc02,tqc03 "
    Else
        'TS案,查覆時間起算一年後刪除
        'strDate = CompDate(0, -1, strSrvDate(1))
        'Modified by Lydia 2018/03/20 用TMQ20判斷是否已刪除明細(+And nvl(tmq20,'N') = 'N')
        'Modified by Lydia 2020/11/04 判斷「覆核已核可」TQD09
        'strQ1 = "select tqc03,tqc02,cp01,cp02,cp03,cp04,tmq01,tmq18,tmq21 from tmqcasemap,caseprogress,trademarkquery " & _
                "where tqc02=cp09(+) and cp01='TS' and tqc03=tmq01(+) " & _
                "And nvl(tmq20,'N') = 'N' AND TMQ11<=" & strDate & " order by tqc02,tqc03 "
        strQ1 = "select tqc03,tqc02,cp01,cp02,cp03,cp04,tmq01,tmq18,tmq21,sum(decode(tqd09,'1',1,0)) cnt " & _
                "from tmqcasemap,caseprogress,trademarkquery,tmqdetail " & _
                "where tqc02=cp09(+) and cp01='TS' and tqc03=tmq01(+) And nvl(tmq20,'N') = 'N' AND TMQ11<=" & strDate & " and tmq01=tqd02(+) " & _
                "group by tqc03,tqc02,cp01,cp02,cp03,cp04,tmq01,tmq18,tmq21 order by tqc02,tqc03 "
    End If
    inX = 1
    Set rsQuery = ClsLawReadRstMsg(inX, strQ1)
    If inX = 1 Then
       With rsQuery
          cnnConnection.BeginTrans 'Added by Lydia 2024/12/20
          .MoveFirst
          Do While Not .EOF
             'Added by Lydia 2023/05/15
             If intCnt = 1 Then
                m_strMemo = ChangeTStringToTDateString(strSrvDate(2)) & " T案領註冊證:"
             Else
                m_strMemo = ChangeTStringToTDateString(strSrvDate(2)) & " TS案:"
             End If
             'end 2023/05/15
             strQ1 = "select tqc02 from tmqcasemap where tqc03='" & .Fields("tqc03") & "' and tqc02 <> '" & .Fields("tqc02") & "' and tqc02 >'A' order by 1"
             inX = 1
             Set rsChk = ClsLawReadRstMsg(inX, strQ1)
             '多次申請
             If inX = 1 Then
                'TMQ21改成最早的收文號
                If "" & rsChk(0) < .Fields("tqc02") Then 'Added by Lydia 2024/12/20 要判斷收文號大小; ex.HB2030889從AB2011446變成AB2011448
                    strA1 = "update trademarkquery set tmq21='" & rsChk(0) & "' where tmq01='" & .Fields("tqc03") & "' "
                    cnnConnection.Execute strA1, intI
                    m_strMemo = m_strMemo & "原收文(" & "" & .Fields("tqc02") & ");" 'Added by Lydia 2023/05/15
                End If
             '只申請一次
             Else
                If Val("" & .Fields("cnt")) = 0 Then   'Added by Lydia 2020/11/04 判斷「覆核已核可」：保留附件
                    'Modified by Lydia 2023/05/15 判斷同一批申請的查名單有不同案件收文,就不刪除附件
                    'strQ1 = "select tqf01,tqf02,tqf03,tqf04 from tmqfile where tqf01='" & .Fields("tmq18") & "' order by 1,2,3,4 "
                    'Memo by Lydia 2024/12/20 同一批申請的查名單一併刪除,所以輪到第2筆以後就沒法註記「整批刪除查名附件X件」
                    strQ1 = "select tqf01,tqf02,tqf03,tqf04,nvl(cnt,0) cnt from tmqfile," & _
                                " (select tmq18,count(*) cnt from tmqcasemap,trademarkquery where tqc03=tmq01(+) and tmq18='" & .Fields("tmq18") & "' and tqc02 is not null and tqc02<>'" & .Fields("tqc02") & "' group by tmq18)" & _
                                " where tqf01='" & .Fields("tmq18") & "' and tqf01=tmq18(+) "
                    inX = 1
                    Set rsChk = ClsLawReadRstMsg(inX, strQ1)
                    If inX = 1 Then
                       rsChk.MoveFirst
                       'Added by Lydia 2023/05/15 判斷同一批申請的查名單有不同案件收文,就不刪除附件
                       intP = 0
                       If Val("" & rsChk.Fields("cnt")) > 0 Then
                           m_strMemo = m_strMemo & "有它案保留附件;"
                       Else
                       'end 2023/05/15
                           Do While Not rsChk.EOF
                              'Added by Lydia 2018/03/27 保留輸入附件(ex.查名的圖形)
                              If "" & rsChk.Fields("tqf02") <> TMQ_附件F02 And "" & rsChk.Fields("tqf04") <> TMQ_附件F04 Then
                                  If PUB_TMQAFileDel(rsChk.Fields("tqf01"), rsChk.Fields("tqf02"), rsChk.Fields("tqf03"), rsChk.Fields("tqf04")) Then
                                     intP = intP + 1 'Added by Lydai 2023/05/15
                                  End If
                              End If 'end 2018/03/27
                              rsChk.MoveNext
                           Loop
                       'Added by Lydia 2023/05/15
                           'Modified by Lydia 2023/05/22 +整批
                           m_strMemo = m_strMemo & "整批刪除查名附件" & intP & "件;"
                       End If
                       'end 2023/05/15
                    End If
                'Added by Lydia 2023/05/15
                Else
                    m_strMemo = m_strMemo & "核可案保留附件;"
                'end 2023/05/15
                End If 'Added by Lydia 2020/11/04

                '刪除查名單分單
                'Modified by Lydia 2018/03/20 用TMQ20判斷是否已刪除明細
                'strA1 = "delete from trademarkquery where tmq01='" & .Fields("tqc03") & "' "
                'cnnConnection.Execute strA1, intI
                'strA1 = "delete from tmqdetail where tqd02='" & .Fields("tqc03") & "' "
                'cnnConnection.Execute strA1, intI
                'Modifiedb Lydia 2023/05/15 TMQ20改為「每日批次處理備註」
                'strA1 = "Update trademarkquery set tmq20='Y' where tmq01='" & .Fields("tqc03") & "' "
                'Modified by Lydia 2025/01/13 其他查名單沒有加註筆數 +and tmq20 is null ;ex.HMB2110217
                strA1 = "Update trademarkquery set tmq20='" & ChgSQL(m_strMemo) & "' where tmq01='" & .Fields("tqc03") & "' and tmq20 is null "
                cnnConnection.Execute strA1, intI
                'end 2018/03/20
                'Added by Lydia 2023/05/22 整批備註
                'Modified by Lydia 2025/01/13 其他查名單沒有加註筆數+.Fields("tqc03") ;ex.HMB2110217
                strA1 = "Update trademarkquery set tmq20='" & ChgSQL(m_strMemo & .Fields("tqc03")) & "' where tmq18='" & .Fields("tmq18") & "' and tmq20 is null"
                cnnConnection.Execute strA1, intI
                'end 2023/05/22
                                
             End If
             
             If Val("" & .Fields("cnt")) = 0 Then  ''Added by Lydia 2020/11/04 判斷「覆核已核可」：保留卷宗區
                '刪除卷宗區的menu
                strA1 = "delete from casepaperpdf where cpp01='" & .Fields("tqc02") & "' and instr(cpp02,'" & .Fields("tqc03") & "." & TMQ_查名作業 & ".menu" & "') > 0 "
                cnnConnection.Execute strA1, intI
             End If 'Added by Lydia 2020/11/04
             '刪除收文對照檔
             strA1 = "delete from tmqcasemap where tqc03='" & .Fields("tqc03") & "' and tqc02 = '" & .Fields("tqc02") & "' "
             cnnConnection.Execute strA1, intI
            
             listTQA01 = IIf(InStr(listTQA01, .Fields("tmq18")) > 0, listTQA01, listTQA01 & "'" & .Fields("tmq18") & "',")
             .MoveNext
          Loop
          cnnConnection.CommitTrans 'Added by Lydia 2024/12/20
       End With
    End If
  Next intCnt

  '4.其他未申請的查名單(6個月以前)
    strDate = CompDate(1, -6, strSrvDate(1))
    'Modified by Lydia 2018/03/20 用TMQ20判斷是否已刪除明細(+And nvl(tmq20,'N') = 'N')
    'Modified by Lydia 2018/03/27 +判斷對照檔
    'strQ1 = "select tmq01,tmq18,tmq21 from trademarkquery,tmqapp where tmq11<=" & strDate & " and tmq21 is null and tmq18>'H' And nvl(tmq20,'N') = 'N' and tmq18=tqa01(+) "
    strQ1 = "select tmq01,tmq18,tmq21 from trademarkquery,tmqapp,tmqcasemap " & _
                "where tmq11<=" & strDate & " and tmq21 is null and tmq18>'H' " & _
                "And nvl(tmq20,'N') = 'N' and tmq18=tqa01(+) and tmq01=tqc03(+) and tqc01 is null "
    inX = 1
    Set rsQuery = ClsLawReadRstMsg(inX, strQ1)
    If inX = 1 Then
       With rsQuery
          cnnConnection.BeginTrans 'Added by Lydia 2024/12/20
          .MoveFirst
          Do While Not .EOF
             'Modified by Lydia 2023/05/15 判斷同一批申請的查名單有不同案件收文,就不刪除附件;
                                         'ex.T-241461的HB1100424因為HB1100425沒有申請所以過期整張刪除, (嘉雯)指示同一批有申請就整批不刪除
             'strQ1 = "select tqf01,tqf02,tqf03,tqf04 from tmqfile where tqf01='" & .Fields("tmq18") & "' order by 1,2,3,4 "
             m_strMemo = ChangeTStringToTDateString(strSrvDate(2)) & " 6個月未申請:"
             strQ1 = "select tqf01,tqf02,tqf03,tqf04,nvl(cnt,0) cnt from tmqfile," & _
                         " (select tmq18,count(*) cnt from tmqcasemap,trademarkquery where tqc03=tmq01(+) and tmq18='" & .Fields("tmq18") & "' and tqc02 is not null group by tmq18)" & _
                         " where tqf01='" & .Fields("tmq18") & "' and tqf01=tmq18(+) "
             'end 2023/05/15
             inX = 1
             Set rsChk = ClsLawReadRstMsg(inX, strQ1)
             If inX = 1 Then
                rsChk.MoveFirst
                'Added by Lydia 2023/05/15 判斷同一批申請的查名單有不同案件收文,就不刪除附件
                intP = 0
                If Val("" & rsChk.Fields("cnt")) > 0 Then
                    m_strMemo = m_strMemo & "有它案保留附件;"
                Else
                'end 2023/05/15
                     Do While Not rsChk.EOF
                         'Added by Lydia 2018/03/27 保留輸入附件(ex.查名的圖形)
                        If "" & rsChk.Fields("tqf02") <> TMQ_附件F02 And "" & rsChk.Fields("tqf04") <> TMQ_附件F04 Then
                           If PUB_TMQAFileDel(rsChk.Fields("tqf01"), rsChk.Fields("tqf02"), rsChk.Fields("tqf03"), rsChk.Fields("tqf04")) Then
                               intP = intP + 1 'Added by Lydia 2023/05/15
                           End If
                        End If 'end 2018/03/27
                        rsChk.MoveNext
                     Loop
                'Added by Lydia 2023/05/15
                     m_strMemo = m_strMemo & "刪除查名附件" & intP & "件;"
                End If
                'end 2023/05/15
             End If
             
             'Modified by Lydia 2018/03/20 用TMQ20判斷是否已刪除明細
             'strA1 = "delete from trademarkquery where tmq01='" & .Fields("tmq01") & "' "
             'cnnConnection.Execute strA1, intI
             'strA1 = "delete from tmqdetail where tqd02='" & .Fields("tmq01") & "' "
             'cnnConnection.Execute strA1, intI
             'Modifiedb Lydia 2023/05/15 TMQ20改為「每日批次處理備註」
             'strA1 = "Update trademarkquery set tmq20='Y' where tmq01='" & .Fields("tmq01") & "' "
             'Modified by Lydia 2025/01/13 其他查名單沒有加註筆數 +and tmq20 is null ;ex.HMB2110217
             strA1 = "Update trademarkquery set tmq20='" & ChgSQL(m_strMemo) & "'||tmq20 where tmq01='" & .Fields("tmq01") & "' and tmq20 is null "
             cnnConnection.Execute strA1, intI
             'end 2018/03/20
             'Remove by Lydia 2018/03/27 已判斷
             'strA1 = "delete from tmqcasemap where tqc03='" & .Fields("tmq01") & "' "
             'cnnConnection.Execute strA1, intI
             
             listTQA01 = IIf(InStr(listTQA01, .Fields("tmq18")) > 0, listTQA01, listTQA01 & "'" & .Fields("tmq18") & "',")
             .MoveNext
          Loop
          cnnConnection.CommitTrans 'Added by Lydia 2024/12/20
       End With
    End If
    
    '檢查有刪除資料的查名單申請編號,若無分單則刪除
    'Remove by Lydia 2018/03/27 取消刪除查名單輸入檔
    'If listTQA01 <> "," Then
    '   'Modified by Lydia 2018/03/20 用TMQ20判斷是否已刪除(+And nvl(tmq20,'N') = 'N')
   '    strA1 = "delete from tmqapp where tqa01 in (" & Mid(listTQA01, 2, Len(Mid(listTQA01, 2)) - 1) & ") and tqa01 not in (select tmq18 from trademarkquery where tmq18 >'H' And nvl(tmq20,'N') = 'N') "
   '    cnnConnection.Execute strA1, intI
    'End If
    'end 2018/03/27
'-------------------------------------
'cnnConnection.CommitTrans 'Mark by Lydia 2024/12/20

    Set rsQuery = Nothing
    Set rsChk = Nothing
    Exit Sub
    
DebugHandle:
    Set rsQuery = Nothing
    Set rsChk = Nothing
    If strA1 <> "" Then cnnConnection.RollbackTrans
    WLog Err.Description
End Sub

'Add by Amy 2016/11/11 借閱期限將至前三個工作日發mail 通知借閱人
Private Sub StrMenu80()
    Dim RsQ As New ADODB.Recordset
    Dim strQ As String, stDate As String
    Dim ii As Integer, F1 As Integer
    Dim Txt_Head As Boolean
    Dim strApatch As String
    Dim OldLR08 As String, strTmp(3) As String
    Dim strContent As String
    
On Error GoTo ErrHand

    strApatch = App.path & TextPath & "圖書借閱期限到期清單.txt"
    strContent = "圖書借閱期限到期清單" & vbCrLf & vbCrLf & "***詳情請見附件***"
    
    stDate = PUB_GetWorkDayAfterSysDate(CDbl(strSrvDate(1)), 3) + 19110000 '系統前三個工作日

    strQ = "Select Distinct LR03,sqldatet(LR04) as LR04,sqldatet(LR05) as LR05,Decode(BK05,null,BK04,BK04||'('||BK05||')') as BKName,LR08,LR01 " & _
                "From (Select * From LoanRecord a Where  LR05<=" & stDate & _
                " And LR01=(Select Max(LR01) as LR01 From LoanRecord Where a.LR03=LR03) " & _
                " And Not Exists(Select * From LoanRecord b Where a.LR03= LR03(+) and LR01=(Select Max(LR01) as LR01 From LoanRecord Where b.LR03=LR03) And LR02>='X' )" & _
                "), BooksData Where BK01=LR03(+) And LR03 is not null Order by LR08,LR01"
    RsQ.CursorLocation = adUseClient
    RsQ.Open strQ, cnnConnection, adOpenStatic, adLockReadOnly
    With RsQ
        If .RecordCount > 0 Then
            .MoveFirst
            Do While .EOF = False
                If OldLR08 <> MsgText(601) And OldLR08 <> "" & .Fields("LR08") Then
                    If F1 > 0 Then Close #F1
                    SendMAPIMail OldLR08, "圖書借閱期限到期清單！", strContent, strApatch
                    Txt_Head = False
                End If
                If Txt_Head = False Then
                    F1 = FreeFile
                    Open strApatch For Output As F1
                    Print #F1, "                           圖書借閱期限到期清單"
                    Print #F1, "列印日期：" & Format(strSrvDate(2), "###/##/##")
                    Print #F1, "圖書編號   借閱日    應還日    書　名"
                    Print #F1, "======== ========== ========== ================================"
                    
                    Txt_Head = True
                End If
                For ii = 0 To UBound(strTmp)
                    strTmp(ii) = "" & .Fields(ii)
                Next ii
                
                strTmp(0) = convForm(CheckStr(strTmp(0)), 8)   '圖書編號
                strTmp(1) = convForm(CheckStr(strTmp(1)), 10)   '借閱日
                strTmp(2) = convForm(CheckStr(strTmp(2)), 10)   '應還日
                strTmp(3) = convForm(CheckStr(strTmp(3) & String(50, " ")), 30) '書名
                Print #F1, strTmp(0) & " " & strTmp(1) & " " & strTmp(2) & " " & strTmp(3)
                
                OldLR08 = "" & .Fields("LR08")
                .MoveNext
            Loop
        End If
    End With
    If F1 > 0 Then
        Close F1
        If OldLR08 <> MsgText(601) Then
            SendMAPIMail OldLR08, "圖書借閱期限到期清單！", strContent, strApatch
        End If
    End If
    RsQ.Close
    
    Set RsQ = Nothing
    Exit Sub
    
ErrHand:
    Set RsQ = Nothing
    WLog Err.Description
End Sub

'Added by Lydia 2016/11/08 國外固定寄催款單給代理人
Private Sub StrMenu81()
Dim strNextDay As String '更新下一次寄發日期
Dim rsRD As New ADODB.Recordset
Dim ff81 As Integer
Dim intR As Integer
Dim strTemp(0 To 10) As String
Dim TFName As String, strTLine As String

On Error GoTo ErrorHand

   TFName = "國外固定寄催款單給代理人"
   'Added by Lydia 2020/08/19 清除舊檔
   If Dir(App.path & TextPath & TFName & ".txt") <> "" Then
       Kill App.path & TextPath & TFName & ".txt"
   End If
   'end 2020/08/19
   
   '國外固定寄催款單代理人維護先上線,在程式未全部撰寫完前先發通知給70004財務吳經理
   strExc(0) = "select a.*,cu01||cu02 no,cu04 name1,cu05||cu88||cu89||cu90 name2,cu06 name3,cu10 na01,na03 " & _
               "from acc225 a,customer ,nation where a2259 = " & strSrvDate(2) & " and a2251=cu01(+) and cu02='0' and cu10=na01(+) "
   strExc(0) = strExc(0) & "union all select a.*,fa01||fa02 no,fa04 name1,fa05||fa63||fa64||fa65 name2,fa06 name3,fa10 na01,na03 " & _
              "from acc225 a,fagent,nation where a2259 = " & strSrvDate(2) & " and a2251=fa01(+) and fa02='0' and fa10=na01(+) "
   strExc(0) = strExc(0) & " order by 1 "
   intR = 1
   Set rsRD = ClsLawReadRstMsg(intR, strExc(0))
   If intR = 1 Then
      If rsRD.RecordCount > 0 Then
         With rsRD
            .MoveFirst
            ff81 = FreeFile
            Open App.path & TextPath & TFName & ".txt" For Output As ff81
            Print #ff81, Space(80) & TFName
            Print #ff81, ""
            Print #ff81, "寄發日期：" & strSrvDate(2)
            Print #ff81, vbCrLf
            Print #ff81, "代理人編號 代理人名稱           國    籍 催款週期 每次固定日 下次寄發日期 附請款單 合併寄 指定信箱                                 副本信箱                                 指定主旨"
              strTLine = "========== ==================== ======== ======== ========== ============ ======== ====== ======================================== ======================================== ========================================"
            Print #ff81, strTLine
            Do While Not .EOF
               strNextDay = "": strExc(1) = ""
               If .Fields("A2252") = "1" Then
                  '提前到工作日,可能會造成月份不一致
                  strNextDay = TransDate(CompDate(1, 1, Mid(TransDate(.Fields("A2259"), 2), 1, 6) & Format(.Fields("A2253"), "00")), 1)
                  strExc(1) = "每月"
               ElseIf .Fields("A2252") = "2" Then
                  strNextDay = TransDate(CompDate(1, 4, Mid(TransDate(.Fields("A2259"), 2), 1, 6) & Format(.Fields("A2253"), "00")), 1)
                  strExc(1) = "每季"
               End If
               
               strTemp(0) = convForm("" & .Fields("A2251"), 10)
               strTemp(1) = convForm(IIf("" & .Fields("name1") = "", IIf("" & .Fields("name2") = "", .Fields("name3"), .Fields("name2")), .Fields("name1")), 20)
               strTemp(2) = convForm("" & .Fields("na03"), 8)
               strTemp(3) = convForm(strExc(1), 8)
               strTemp(4) = convForm(Format("" & .Fields("A2253"), "00"), 10)
               strTemp(5) = convForm(IIf(strNextDay = "", "", strNextDay), 12)
               strTemp(6) = convForm("" & .Fields("A2254"), 8)
               strTemp(7) = convForm("" & .Fields("A2257"), 6)
               strTemp(8) = convForm("" & .Fields("A2255"), 40)
               strTemp(9) = convForm("" & .Fields("A2256"), 40)
               strTemp(10) = convForm("" & .Fields("A2258"), 40)
               
               Print #ff81, strTemp(0) & " " & strTemp(1) & " " & strTemp(2) & " " & strTemp(3) & " " & strTemp(4) & " " & strTemp(5) & " " & strTemp(6) & " " & strTemp(7) & " " & strTemp(8) & " " & strTemp(9) & " " & strTemp(10)
               
               If strNextDay <> "" Then
                  cnnConnection.Execute "Update Acc225 set a2259=" & strNextDay & " where a2251='" & .Fields("a2251") & "' "
               End If
               
               .MoveNext
            Loop
            
         End With
         
         If ff81 > 0 Then
            Print #ff81, String(Len(strTLine), "=")
            Print #ff81, "共 " & rsRD.RecordCount & " 筆"
            Close ff81
            'Remove by Lydia 2017/01/10 秀玲已與財務協商,不執行自動批次發函,改由人工發函,並且取消發清單
            'SendMAPIMail "70004", TFName, vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, App.path & TextPath & TFName & ".txt"
         End If
      End If
   End If
   
   Set rsRD = Nothing
   Exit Sub
   
ErrorHand:
   Set rsRD = Nothing
End Sub

'Add By Sindy 2016/12/14 P,CFP分析及核駁分析之會稿完成時間設定
Private Sub StrMenu82()
Dim ChkDate As String
Dim bolGetCnn As Boolean
Dim intUpdEP08okCnt As Integer
Dim tmpnext As String
Dim intMaxEEP02 As Integer

On Error GoTo DebugErr
   
   ChkDate = CompWorkDay(4, strSrvDate(1), 1) '前三個工作天
   
   '送會中
   'Modify By Sindy 2017/9/20 + 1006.最終核駁
   strSql = "select * From empelectronprocess,caseprogress" & _
            " where eep04 in('" & EMP_送會 & "') and eep09='Y'" & _
            " and eep06<=" & ChkDate & _
            " and eep01=cp09(+)" & _
            " and cp01 in('P','CFP')" & _
            " and cp10 in('1002','1202','1205','1206','1209','941','1006')" & _
            " and cp27 is null and cp57 is null"
   CheckOC
   Set Rs = New ADODB.Recordset
   Rs.CursorLocation = adUseClient
   Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   tmpnext = "已取得資料..."
   With Rs
      If .RecordCount > 0 Then
         .MoveFirst
         Do While Not .EOF
            tmpnext = "更新文號" & .Fields("eep01") & "-->" & strSrvDate(1)
            cnnConnection.BeginTrans
            bolGetCnn = True
            
            '取得最大序號
            intMaxEEP02 = 0
            strSql = "select eep02 From empelectronprocess where eep01='" & .Fields("eep01") & "' order by eep02 desc"
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strSql)
            If intI = 1 Then
               RsTemp.MoveFirst
               If RsTemp.RecordCount > 0 Then
                  intMaxEEP02 = RsTemp.Fields(0)
               End If
            End If
            '系統自動會完
            strSql = "insert into empelectronprocess(eep01,eep02,eep03,eep04,eep05,eep06,eep07,eep08) values(" & _
                     CNULL(.Fields("eep01")) & "," & (intMaxEEP02 + 1) & "," & CNULL(strUserNum) & "," & _
                     CNULL(EMP_會完) & "," & CNULL(.Fields("cp14")) & "," & DBDATE(strSrvDate(1)) & "," & _
                     Right("000000" & ServerTime, 6) & "," & CNULL("系統自動會完") & ")"
            cnnConnection.Execute strSql
            '取消送會中
            strSql = "update empelectronprocess set eep09=null where eep01=" & CNULL(.Fields("eep01")) & " and eep02=" & .Fields("eep02")
            cnnConnection.Execute strSql
            
            UpdateEp08 .Fields("eep01"), strSrvDate(1) '更新相關會稿完成日資料
            cnnConnection.CommitTrans
            WLog "更新文號" & .Fields("eep01") & "-->" & strSrvDate(1)
            bolGetCnn = False
            Call PUB_SendMailCache(True) '發郵件 (相關會稿完成日的郵件)
            intUpdEP08okCnt = intUpdEP08okCnt + 1
            .MoveNext
         Loop
      End If
   End With
   If intUpdEP08okCnt > 0 Then
      WLog "系統自動上會稿完成日結束！更新筆數：" & intUpdEP08okCnt & " 筆"
   End If
   
   Set Rs = Nothing
   Exit Sub
   
DebugErr:
   If bolGetCnn = True Then
      cnnConnection.RollbackTrans
   End If
   WLog tmpnext & " " & Err.Description
End Sub

'Add by Amy 2017/01/24 MCTF控制更新資料
Private Sub StrRunOnlyOne()
    Dim i As Integer
    Dim RsQ As New ADODB.Recordset, rsC As New ADODB.Recordset, RsN As New ADODB.Recordset
    Dim strQ As String, strUpd As String
    Dim strCU(1) As String, strTmp(2) As String, strMsg As String
    Dim bolData As Boolean
    Dim bolUpdCus As Boolean 'Add by Amy 2017/03/16
    
On Error GoTo ErrHand
    
    '林經理所附的EXCEL資料
    strQ = "Select * From AmyTmp Order by R01"
    
    If RsQ.State <> adStateClosed Then RsQ.Close
    RsQ.CursorLocation = adUseClient
    RsQ.Open strQ, cnnConnection, adOpenStatic, adLockReadOnly
    If RsQ.RecordCount > 0 Then
        RsQ.MoveFirst
        cnnConnection.BeginTrans
        Do While RsQ.EOF = False
            With RsQ
                strMsg = "代理人檔-" & .Fields("R01")
                'FA120更新為MCTF0X
                'strUpd = "Update Fagent Set FA120='" & .Fields("R02") & "',FA29='" & strSrvDate(2) & "更新控管智權人員;'||FA29 " & _
                            "Where FA01='" & Mid(.Fields("R01"), 1, 8) & "' And FA02='" & Mid(.Fields("R01"), 9, 1) & "' "
                strUpd = "Update Fagent Set FA29='" & strSrvDate(2) & "補更新控管智權人員;'||FA29 " & _
                            "Where FA01='" & Mid(.Fields("R01"), 1, 8) & "' And FA02='" & Mid(.Fields("R01"), 9, 1) & "' "
                cnnConnection.Execute strUpd
                '抓商標基本檔及服務業務基本檔之FC代理人(T字頭案件且申請國家為台灣)
                'Modify by Amy 2017/03/22 拿掉申請國家為台灣條件
                strQ = "Select Distinct TM01 as C1,TM02 as C2,TM03 as C3,TM04 as C4,TM23 as A1,TM78 as A2,TM79 as A3,TM80 as A4,TM81 as A5,CP55 as P1,CP93 as P2,CP94 as P3,CP95 as P4,CP96 as P5 " & _
                            "From TradeMark,CaseProgress Where TM44='" & .Fields("R01") & "' And TM44 is not Null And SubStr(TM01,1,1)='T' And TM01=CP01(+) And TM02=CP02(+) And TM03=CP03(+) And TM04=CP04(+) " & _
                " Union Select Distinct SP01 as C1,SP02 as C2,SP03 as C3,SP04 as C4,SP08 as A1,SP58 as A2,SP59 as A3,SP65 as A4,SP66 as A5,CP55 as P1,CP93 as P2,CP94 as P3,CP95 as P4,CP96 as P5 " & _
                            "From ServicePractice,CaseProgress Where SP26='" & .Fields("R01") & "' And SP26 is not Null And SubStr(SP01,1,1)='T' And SP08 is not null And SP01=CP01(+) And SP02=CP02(+) And SP03=CP03(+) And SP04=CP04(+) "
                If rsC.State <> adStateClosed Then rsC.Close
                rsC.CursorLocation = adUseClient
                rsC.Open strQ, cnnConnection, adOpenStatic, adLockReadOnly
                If rsC.RecordCount > 0 Then
                    bolUpdCus = False
                    strTmp(0) = PUB_GetST03(.Fields("R02"))
                    Do While rsC.EOF = False
                        '申請人客戶檔更新
                        For i = 0 To 4
                            If IsNull(rsC.Fields("A" & i + 1)) Then
                                Exit For
                            '未更新才需更新
                            Else
                                'Modify by Amy 2017/03/08 巨京/客戶智權部門非P2不更新
                                bolData = GetCusORFagentData(rsC.Fields("A" & i + 1), "CU12,CU13", strCU())
                                If Left(strCU(0), 2) = "P2" And Left(strCU(1), 4) <> "MCTF" And strCU(1) <> "96030" And strCU(1) <> "96029" Then
                                'end 2017/03/08
                                    strUpd = "": strTmp(2) = ""
                                    strTmp(1) = PUB_GetST03(strCU(1))
                                    If strTmp(0) <> strTmp(1) Then
                                        strTmp(2) = "/部門:" & strTmp(1)
                                        strUpd = ",CU12='" & strTmp(0) & "'"
                                    End If
                                    strMsg = "客戶檔-" & rsC.Fields("A" & i + 1)
                                    '更新客戶檔智權人員及部門並寫備註(舊名稱資料也要改)
                                    strUpd = "Update Customer Set " & "CU13='" & .Fields("R02") & "'" & strUpd & _
                                                   ",CU79='" & strSrvDate(2) & "修改智權人員(原人員:" & strCU(1) & strTmp(2) & ");'||CU79 " & _
                                                   "Where CU01='" & Mid(rsC.Fields("A" & i + 1), 1, 8) & "' "
                                    cnnConnection.Execute strUpd
                                    bolUpdCus = True 'Add byAmy 2017/03/16
                                End If
                            End If
                        Next i
                        '移轉人/讓與人客戶檔更新
                        For i = 5 To 9
                            If IsNull(rsC.Fields("P" & i - 4)) Then
                                Exit For
                            '未更新才需更新
                            Else
                                'Modify by Amy 2017/03/08 巨京/客戶智權部門非P2不更新
                                bolData = GetCusORFagentData(rsC.Fields("P" & i - 4), "CU12,CU13", strCU())
                                If Left(strCU(0), 2) = "P2" And Left(strCU(1), 4) <> "MCTF" And strCU(1) <> "96030" And strCU(1) <> "96029" Then
                                'end 2017/03/08
                                    strUpd = "": strTmp(2) = ""
                                    strTmp(1) = PUB_GetST03(strCU(1))
                                    If strTmp(0) <> strTmp(1) Then
                                        strTmp(2) = "/部門:" & strTmp(1)
                                        strUpd = ",CU12='" & strTmp(0) & "'"
                                    End If
                                    strMsg = "客戶檔-" & rsC.Fields("P" & i - 4)
                                    '更新客戶檔智權人員及部門並寫備註(舊名稱資料也要改)
                                    strUpd = "Update Customer Set " & "CU13='" & .Fields("R02") & "'" & strUpd & _
                                                   ",CU79='" & strSrvDate(2) & "修改智權人員(原人員:" & strCU(1) & strTmp(2) & ");'||CU79 " & _
                                                   "Where CU01='" & Mid(rsC.Fields("P" & i - 4), 1, 8) & "' "
                                    cnnConnection.Execute strUpd
                                    bolUpdCus = True 'Add byAmy 2017/03/16
                                End If
                            End If
                        Next i
                        'Modify by Amy 2017/03/16 +if
                        If bolUpdCus = True Then
                            '抓案件下一程序未續辦,更新智權人員(strNpSqlOfNoSalesDuty)及管制期限(未更新才需更新)-秀玲:取消未到期NP09>=系統日的條件
                            strQ = "Select  NP01,NP07, NP10,NP22 From NextProgress Where NP06 Is Null And SubStr(NP10,1,4)<>'MCTF' " & _
                                    "And NP02='" & rsC.Fields("C1") & "' And NP03='" & rsC.Fields("C2") & "' And NP04='" & rsC.Fields("C3") & "' And NP05='" & rsC.Fields("C4") & "' "
                            If RsN.State <> adStateClosed Then RsN.Close
                            RsN.CursorLocation = adUseClient
                            RsN.Open strQ, cnnConnection, adOpenStatic, adLockReadOnly
                            If RsN.RecordCount > 0 Then
                                Do While RsN.EOF = False
                                    strMsg = "下一程序檔-總收文號:" & RsN.Fields("NP01")
                                    strUpd = "Update Nextprogress Set NP10='" & .Fields("R02") & "' Where NP01='" & RsN.Fields("NP01") & "' And NP07='" & RsN.Fields("NP07") & "' And NP22=" & RsN.Fields("NP22") & strNpSqlOfNoSalesDuty
                                    cnnConnection.Execute "begin user_data.user_notrigger:=1; end;" '控制來函期限通知的 Trigger 不被觸發
                                    cnnConnection.Execute strUpd
                                    cnnConnection.Execute "begin user_data.user_notrigger:=0; end;"
                                    RsN.MoveNext
                                Loop
                            End If
                        End If
                        rsC.MoveNext
                    Loop
                End If
                .MoveNext
            End With
        Loop
        cnnConnection.CommitTrans
    End If
    
    Set RsQ = Nothing
    Exit Sub
    
ErrHand:
    cnnConnection.RollbackTrans
    WLog strMsg & "資料更新失敗" & " " & Err.Description
End Sub

'Added by Lydia 2017/02/09 單月的第三個工作天-抓前二個月專利修正無收費案件
Private Sub StrMenu83()
Dim m_rs As New ADODB.Recordset
Dim strVol1_S As String, strVol1_E As String '日期範圍
Dim xlsPoint As New Excel.Application
Dim wksA83 As New Worksheet
Dim xRows As Integer '目前列位置
Dim strPath As String, strTempFile As String
Dim strTitle As Variant, strTitleL As Variant, strTitleW As Variant
Dim inJ As Integer
Dim tmpnext As String 'Added by Lydia 2017/03/03 記錄步驟

On Error GoTo DebugErr 'Added by Lydia 2017/03/03

strTitle = Empty: strTitleL = Empty: strTitleW = Empty
strTitle = Split("部門,承辦人,申請國家,收文日,本所案號,種類,申請案號,案件性質,智權人員,發文日,申請人,進度備註,承辦人備註", ",")
strTitleL = Split("A,B,C,D,E,F,G,H,I,J,K,L,M", ",")
strTitleW = Split("11,12,10,9,15,9,16,12,8,9,20,20,20", ",")

'日期範圍:前2個月
strVol1_S = Mid(CompDate(1, -2, strSrvDate(1)), 1, 6) & "01"
strVol1_E = CompDate(2, -1, Mid(strSrvDate(1), 1, 6) & "01")
   
strTempFile = TransDate(strVol1_S, 1) & "至" & TransDate(strVol1_E, 1) & "專利修正無收費案件"
strPath = App.path & TextPath & strTempFile & ".xls"
Call PUB_KillTempFile(Mid(TextPath & "*專利修正無收費案件.*", 2))     'Added by Lydia 2020/08/19 清除舊檔

tmpnext = "Start......" 'Added by Lydia 2017/03/03
    
    'Added by Lydia 2023/12/22
    If strVol1_E >= 新部門啟用日 Then
       strSql = "select nvl(a0922,substr(a0902,1,5)) 部門,s1.st02 承辦人,substr(na03,1,6) 申請國家,substr(sqldatet(cp05),1,10) 收文日,cp01||'-'||cp02||'-'||cp03||'-'||cp04 本所案號," & _
                "substr(decode(pa09,'000',ptm03,ptm04),1,4) 種類,pa11 申請案號,substr(decode(pa09,'000',cpm03,cpm04),1,4) 案件性質,s2.st02 智權人員,substr(sqldatet(cp27),1,10) 發文日,decode(pa01,'FCP',fa05,cu04) 申請人," & _
                "decode(cp118,'Y',substr(cp64,22),cp64) 進度備註,ep12 承辦人備註 from patent,staff s1,staff s2,nation,customer,fagent,casepropertymap,acc090,acc090new,patenttrademarkmap,engineerprogress,"
    Else
    'end 2023/12/22
       strSql = "select substr(a0902,1,5) 部門,s1.st02 承辦人,substr(na03,1,6) 申請國家,substr(sqldatet(cp05),1,10) 收文日,cp01||'-'||cp02||'-'||cp03||'-'||cp04 本所案號," & _
                "substr(decode(pa09,'000',ptm03,ptm04),1,4) 種類,pa11 申請案號,substr(decode(pa09,'000',cpm03,cpm04),1,4) 案件性質,s2.st02 智權人員,substr(sqldatet(cp27),1,10) 發文日,decode(pa01,'FCP',fa05,cu04) 申請人," & _
                "decode(cp118,'Y',substr(cp64,22),cp64) 進度備註,ep12 承辦人備註 from patent,staff s1,staff s2,nation,customer,fagent,casepropertymap,acc090,patenttrademarkmap,engineerprogress,"
    End If
    'P,CFP以收文日計算
    strSql = strSql & " (select a.cp14 cp14,a.cp05 cp05,a.cp01 cp01,a.cp02 cp02,a.cp03 cp03,a.cp04 cp04,a.cp10 cp10,a.cp09 cp09,a.cp13 cp13,a.cp27 cp27,a.cp118 cp118,a.cp64 cp64 from caseprogress a,staff " & _
             "where a.cp05>=" & strVol1_S & " and a.cp05<=" & strVol1_E & " and a.cp01 in ('P','CFP','FCP') and a.cp10 in ('203','204') and nvl(a.cp16,0)=0 and a.cp159=0 and a.cp04='00' and a.cp14=st01(+) and st03 like 'P1%'"
    '郭雅娟說要剔除有同日發文之A類申復案件
    strSql = strSql & " and not exists(select * from caseprogress b where b.cp01=a.cp01 and b.cp02=a.cp02 and b.cp03=a.cp03 and b.cp04=a.cp04 and b.cp10='205' and b.cp27=a.cp27 and b.cp09<'B')"
    'FCP以發文日計算
    strSql = strSql & " Union select cp14,cp05,cp01,cp02,cp03,cp04,cp10,cp09,cp13,cp27,cp118,cp64 from caseprogress,staff " & _
             "where cp27>=" & strVol1_S & " and cp27<=" & strVol1_E & " and cp01 in ('P','CFP','FCP') and cp10 in ('203','204') and cp159=0 and cp04='00' and cp20||''='N' and cp14=st01(+) and st03 like 'F2%' "
    'Added by Lydia 2023/12/22
    If strVol1_E >= 新部門啟用日 Then
       strSql = strSql & ") where cp14=s1.st01(+) and cp13=s2.st01(+) and cp01=cpm01(+) and cp10=cpm02(+) and s1.st03=a0901(+) and s1.st93=a0921(+) and cp09=ep02(+) " & _
                "and cp01=pa01(+) and cp02=pa02(+) and cp03=pa03(+) and cp04=pa04(+) and pa09=na01(+) and '1'=ptm01(+) and pa08=ptm02(+) " & _
                "and substr(pa26,1,8)=cu01(+) and substr(pa26,9,1)=cu02(+) and substr(pa75,1,8)=fa01(+) and substr(pa75,9,1)=fa02(+) " & _
                "order by s1.st03,cp14,pa01,pa09,cp05 "
    Else
    'end 2023/12/22
       strSql = strSql & ") where cp14=s1.st01(+) and cp13=s2.st01(+) and cp01=cpm01(+) and cp10=cpm02(+) and s1.st03=a0901(+) and cp09=ep02(+) " & _
                "and cp01=pa01(+) and cp02=pa02(+) and cp03=pa03(+) and cp04=pa04(+) and pa09=na01(+) and '1'=ptm01(+) and pa08=ptm02(+) " & _
                "and substr(pa26,1,8)=cu01(+) and substr(pa26,9,1)=cu02(+) and substr(pa75,1,8)=fa01(+) and substr(pa75,9,1)=fa02(+) " & _
                "order by s1.st03,cp14,pa01,pa09,cp05 "
    End If
    Set m_rs = New ADODB.Recordset
    m_rs.CursorLocation = adUseClient
    tmpnext = "準備資料讀取......" 'Added by Lydia 2017/03/03
    m_rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
    If m_rs.RecordCount > 0 Then
    
        If Dir(strPath) <> "" Then
           Kill strPath
        End If
        
        tmpnext = "準備建立XLS檔......" 'Added by Lydia 2017/03/03
        xlsPoint.SheetsInNewWorkbook = 1 'Added by Lydia 2019/03/12 預設工作表數目
        xlsPoint.Workbooks.add
        Set wksA83 = xlsPoint.Worksheets(1)
        wksA83.PageSetup.Orientation = xlPortrait '直印 'Remove by Lydia 2017/03/03 執行檔會出錯  'Modified by Lydia 2017/03/16 執行的電腦需有安裝印表機
        '抬頭
        xRows = 2
        For inJ = 0 To UBound(strTitle)
           wksA83.Range(Trim(strTitleL(inJ)) & xRows).Value = Trim(strTitle(inJ)) '欄位名稱
           wksA83.Columns(Trim(strTitleL(inJ)) & ":" & Trim(strTitleL(inJ))).ColumnWidth = Val(strTitleW(inJ))     '欄寬
           wksA83.Columns(Trim(strTitleL(inJ)) & ":" & Trim(strTitleL(inJ))).NumberFormatLocal = "@"   '欄位設定為文字型態
        Next inJ
        strExc(0) = "P,CFP案抓" & TransDate(strVol1_S, 1) & "~" & TransDate(strVol1_E, 1) & "收文資料"
        strExc(0) = strExc(0) & "，FCP案抓" & TransDate(strVol1_S, 1) & "~" & TransDate(strVol1_E, 1) & "發文資料"
        wksA83.Range("a1").Value = strExc(0) '註解
        wksA83.Range("a1").Font.Color = &HFF&
        With wksA83.Range("a1:h1")
         .WrapText = False
         .MergeCells = True
         .HorizontalAlignment = xlCenter
         .VerticalAlignment = xlBottom
        End With
       
        tmpnext = "資料寫入XLS檔......" 'Added by Lydia 2017/03/03
        With m_rs
           .MoveFirst
           Do While Not .EOF
              xRows = xRows + 1
              For inJ = 0 To UBound(strTitle)
                  wksA83.Range(Trim(strTitleL(inJ)) & xRows).Value = Trim("" & .Fields(inJ)) '欄位內容
              Next inJ
              .MoveNext
           Loop
        End With
        
        tmpnext = "XLS檔存檔......" 'Added by Lydia 2017/03/03
        '判斷若版本2007以上改變存檔格式
        If Val(xlsPoint.Version) < 12 Then
          xlsPoint.Workbooks(1).SaveAs FileName:=strPath, FileFormat:=-4143
        Else
          xlsPoint.Workbooks(1).SaveAs FileName:=strPath, FileFormat:=56
        End If
        xlsPoint.Workbooks.Close
        xlsPoint.Quit
        'Added by Lydia 2017/03/16
        Set xlsPoint = Nothing
        Set wksA83 = Nothing
        'end 2017/03/16
        
        strExc(0) = vbCrLf & "Dear Sir:" & vbCrLf & vbCrLf & strTempFile & "，詳情請參閱附件。"
        '寄給A5024(王E娟)
        SendMAPIMail "A5024", strTempFile, strExc(0), strPath
    End If
    
'Added by Lydia 2017/03/03
    Exit Sub
    
DebugErr:
   WLog tmpnext & " " & Err.Description
'end 2017/03/03
End Sub

'Added by Lydia 2017/02/09 前半個月之專利及商標審查意見通知件數統計(每月03,18日自動執行)
Private Sub StrMenu84()
Dim m_rs As New ADODB.Recordset
Dim strVol1_S As String, strVol1_E As String '日期範圍
Dim strVol2_S As String, strVol2_E As String '前一年日期範圍
Dim xlsPoint As New Excel.Application
Dim wksA84 As New Worksheet
Dim xRows As Integer '目前列位置
Dim strPath As String, strTempFile As String
Dim strAllPath As String
Dim strAllFile As String
Dim strGrp As String '區分工作表
Dim strGrpL As String '不同系統跳行
Dim strTitle1 As String
Dim strTmpA1 As Variant
Dim inJ As Integer
Dim iPage As Integer

'日期範圍:每個月03日跑起日為前一個月16,迄日為前一個月最後一天;每個月18日跑起日為當月01,迄日為當月15
If Val(Right(strSrvDate(1), 2)) < 15 Then
   strVol1_S = Mid(CompDate(1, -1, strSrvDate(1)), 1, 6) & "16"
   strVol1_E = GetLastDay(strVol1_S)
   strVol2_S = CompDate(0, -1, strVol1_S)
   strVol2_E = GetLastDay(strVol2_S)
Else
   strVol1_S = Mid(strSrvDate(1), 1, 6) & "01"
   strVol1_E = Mid(strSrvDate(1), 1, 6) & "15"
   strVol2_S = CompDate(0, -1, strVol1_S)
   strVol2_E = CompDate(0, -1, strVol1_E)
End If

Call PUB_KillTempFile(Mid(TextPath & "*商標審查意見通知件數統計.*", 2))     'Added by Lydia 2020/08/19 清除舊檔
 
On Error GoTo DebugErr 'Added by Lydia 2020/01/20

    '----商標
    strSql = "SELECT TYPE 案件,DECODE(ST16,'2','英文組','4','日文組',ST16) 組別,ST02 承辦人,SUM(商標五) 去年同期,SUM(商標六) 當期,NVL(ST03,DECODE(CP01,'FCT','F1','CFT','F1','P2')) 部門,CP14 FROM STAFF, " & _
             "(SELECT CP01,CP09,TYPE,DECODE(CP14,NULL,CP01||CP02||CP03||CP04,CP14) CP14,DECODE(YEAR||PA08,'" & Mid(TransDate(strVol2_S, 1), 1, 3) & "',1,0) 商標五,DECODE(YEAR||PA08,'" & Mid(TransDate(strVol1_S, 1), 1, 3) & "',1,0) 商標六 " & _
                "FROM (" & _
                "SELECT CP01,CP02,CP03,CP04,CP09,DECODE(CP01,'T',DECODE(TM10,'000','台灣','020','大陸',TM10),CP01) TYPE,CP14,SUBSTR(CP05,1,4)-1911 YEAR,'' PA08 FROM CASEPROGRESS,TRADEMARK " & _
                "WHERE CP01 IN ('T','TF','FCT','CFT') AND CP10 IN ('1201','1202') AND CP05>=" & strVol1_S & " AND CP05<=" & strVol1_E & _
                " AND CP01=TM01(+) AND CP02=TM02(+) AND CP03=TM03(+) AND CP04=TM04(+) " & _
                "UNION SELECT CP01,CP02,CP03,CP04,CP09,DECODE(CP01,'T',DECODE(TM10,'000','台灣','020','大陸',TM10),CP01) TYPE,CP14,SUBSTR(CP05,1,4)-1911 YEAR,'' PA08 FROM CASEPROGRESS,TRADEMARK " & _
                "WHERE CP01 IN ('T','TF','FCT','CFT') AND CP10 IN ('1201','1202') AND CP05>=" & strVol2_S & " AND CP05<=" & strVol2_E & _
                " AND CP01=TM01(+) AND CP02=TM02(+) AND CP03=TM03(+) AND CP04=TM04(+) " & _
                ") " & _
             ") WHERE CP14=ST01(+) GROUP BY NVL(ST03,DECODE(CP01,'FCT','F1','CFT','F1','P2')),TYPE,DECODE(ST16,'2','英文組','4','日文組',ST16),CP14,ST02 " & _
             "ORDER BY 部門,案件,組別,CP14"

    If m_rs.State <> adStateClosed Then m_rs.Close
    Set m_rs = Nothing
    m_rs.CursorLocation = adUseClient
    m_rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
    If m_rs.RecordCount > 0 Then
        strTempFile = TransDate(strVol1_S, 1) & "至" & TransDate(strVol1_E, 1) & "商標審查意見通知件數統計"
        
        strPath = App.path & TextPath & strTempFile & ".xls"
        If Dir(strPath) <> "" Then
           Kill strPath
        End If
        strAllPath = strAllPath & IIf(strAllPath <> "", "*", "") & strPath
        strAllFile = strAllFile & IIf(strAllFile <> "", vbCrLf, "") & strTempFile
        xlsPoint.SheetsInNewWorkbook = 2 'Added by Lydia 2019/03/12 預設工作表數目
        xlsPoint.Workbooks.add
        
        With m_rs
           .MoveFirst
           Do While Not .EOF
              If strGrp <> Mid("" & .Fields("部門"), 1, 1) And "" & .Fields("部門") <> "" Then
                 If strGrp = "" Then
                    iPage = 1
                    '外商-欄位抬頭
                    strTmpA1 = Empty
                    strTitle1 = "案件,組別,承辦人,去年同期,當期"
                    strTmpA1 = Split(strTitle1, ",")
                 Else
                    iPage = 2
                    '內商-欄位抬頭
                    strTmpA1 = Empty
                    strTitle1 = "案件,承辦人,去年同期,當期"
                    strTmpA1 = Split(strTitle1, ",")
                 End If
                 '設定頁面與表頭
                 
                 Set wksA84 = xlsPoint.Worksheets(iPage)
                 xlsPoint.Worksheets(iPage).Name = IIf(Mid("" & .Fields("部門"), 1, 2) = "F1", "外商", "內商")
                 wksA84.PageSetup.Orientation = xlPortrait '直印
                 xRows = 2
                 For inJ = 0 To UBound(strTmpA1)
                    If Trim(strTmpA1(inJ)) <> "" Then
                       If (iPage = 1 And inJ > 2) Or (iPage = 2 And inJ > 1) Then
                          wksA84.Columns(Chr(Asc("a") + inJ) & ":" & Chr(Asc("a") + inJ)).ColumnWidth = 15
                          wksA84.Columns(Chr(Asc("a") + inJ) & ":" & Chr(Asc("a") + inJ)).HorizontalAlignment = xlRight
                          wksA84.Columns(Chr(Asc("a") + inJ) & ":" & Chr(Asc("a") + inJ)).NumberFormatLocal = "##0"
                       Else
                          wksA84.Range(Chr(Asc("a") + inJ) & xRows).Value = Trim(strTmpA1(inJ)) '欄位名稱
                          wksA84.Columns(Chr(Asc("a") + inJ) & ":" & Chr(Asc("a") + inJ)).ColumnWidth = 10
                          wksA84.Columns(Chr(Asc("a") + inJ) & ":" & Chr(Asc("a") + inJ)).NumberFormatLocal = "@"   '欄位設定為文字型態
                       End If
                    End If
                 Next inJ
                 
                 '抬頭
                 wksA84.Range("a1").Value = "(只計算審查報告1201及核駁前先行通知1202之來函資料)" '註解
                 wksA84.Range("a1").Font.Color = &HFF&
                 With wksA84.Range("a1:e1")
                   .WrapText = False
                   .MergeCells = True
                   .HorizontalAlignment = xlCenter
                   .VerticalAlignment = xlBottom
                 End With
                 
                 wksA84.Range(IIf(iPage = 1, "d", "c") & "2").Value = TransDate(strVol2_S, 1) & "~" & TransDate(strVol2_E, 1)
                 wksA84.Range(IIf(iPage = 1, "e", "d") & "2").Value = TransDate(strVol1_S, 1) & "~" & TransDate(strVol1_E, 1)
                

              ElseIf strGrpL <> "" & .Fields("案件") Then
                 xRows = xRows + 1
              End If
              xRows = xRows + 1
              For inJ = 0 To UBound(strTmpA1)
                  If Trim(strTmpA1(inJ)) <> "" Then
                     strExc(1) = ""
                     Select Case Trim(strTmpA1(inJ))
                         Case "案件": strExc(1) = Trim("" & .Fields("案件"))
                         Case "組別": strExc(1) = Trim("" & .Fields("組別"))
                         Case "承辦人"
                             If Trim("" & .Fields("承辦人")) = "" Then
                                strExc(1) = Trim("" & .Fields("CP14")) '未分派承辦人,改顯示案號
                             Else
                                strExc(1) = Trim("" & .Fields("承辦人"))
                             End If
                         Case "去年同期": strExc(1) = Trim("" & .Fields("去年同期"))
                         Case "當期": strExc(1) = Trim("" & .Fields("當期"))
                     End Select
                     wksA84.Range(Chr(Asc("a") + inJ) & xRows).Value = strExc(1) '欄位內容
                  End If
              Next inJ
              strGrp = Mid("" & .Fields("部門"), 1, 1)
              strGrpL = "" & .Fields("案件")
              .MoveNext
           Loop
        End With

        '判斷若版本2007以上改變存檔格式
        If Val(xlsPoint.Version) < 12 Then
           xlsPoint.Workbooks(1).SaveAs FileName:=strPath, FileFormat:=-4143
        Else
           xlsPoint.Workbooks(1).SaveAs FileName:=strPath, FileFormat:=56
        End If
        xlsPoint.Workbooks.Close
        xlsPoint.Quit
        Set xlsPoint = Nothing
        Set wksA84 = Nothing
    End If

    '----專利
   strSql = "SELECT TYPE 案件,DECODE(ST16,'P',NULL,'CFP',NULL,'1','1電子電機','2','2化學','3','3日文','4','4機械設計',ST16) 組別,ST02 承辦人," & _
            "SUM(發明五) 發明去年同期,SUM(新型五) 新型去年同期,SUM(設計五) 設計去年同期,SUM(發明六) 發明當期,SUM(新型六) 新型當期,SUM(設計六) 設計當期,NVL(SUBSTR(ST03,1,2),DEPTNO) 部門,CP14 FROM STAFF, " & _
               "(SELECT DEPTNO,CP01,CP09,TYPE,DECODE(CP14,NULL,CP01||CP02||CP03||CP04,CP14) CP14," & _
                   "DECODE(YEAR||PA08,'" & Mid(TransDate(strVol2_S, 1), 1, 3) & "1',1,0) 發明五,DECODE(YEAR||PA08,'" & Mid(TransDate(strVol2_S, 1), 1, 3) & "2',1,0) 新型五,DECODE(YEAR||PA08,'" & Mid(TransDate(strVol2_S, 1), 1, 3) & "3',1,0) 設計五," & _
                   "DECODE(YEAR||PA08,'" & Mid(TransDate(strVol1_S, 1), 1, 3) & "1',1,0) 發明六,DECODE(YEAR||PA08,'" & Mid(TransDate(strVol1_S, 1), 1, 3) & "2',1,0) 新型六,DECODE(YEAR||PA08,'" & Mid(TransDate(strVol1_S, 1), 1, 3) & "3',1,0) 設計六 " & _
                   "FROM ( " & _
                      "SELECT 'F2' DEPTNO,CP01,CP02,CP03,CP04,CP09,DECODE(CP01,'P',DECODE(PA09,'000','台灣','非台灣'),CP01) TYPE,CP14,SUBSTR(CP05,1,4)-1911 YEAR,PA08 FROM CASEPROGRESS,PATENT WHERE CP01 IN ('P','FCP') AND CP10 IN ('1201','1202') AND CP05>=" & strVol1_S & " AND CP05<=" & strVol1_E & " AND SUBSTR(CP12,1,1)='F' AND CP01=PA01(+) AND CP02=PA02(+) AND CP03=PA03(+) AND CP04=PA04(+) " & _
                      "UNION SELECT 'F2' DEPTNO,CP01,CP02,CP03,CP04,CP09,DECODE(CP01,'P',DECODE(PA09,'000','台灣','非台灣'),CP01) TYPE,CP14,SUBSTR(CP05,1,4)-1911 YEAR,PA08 FROM CASEPROGRESS,PATENT WHERE CP01 IN ('P','FCP') AND CP10 IN ('1201','1202') AND CP05>=" & strVol2_S & " AND CP05<=" & strVol2_E & " AND SUBSTR(CP12,1,1)='F' AND CP01=PA01(+) AND CP02=PA02(+) AND CP03=PA03(+) AND CP04=PA04(+) " & _
                      "UNION SELECT 'P1' DEPTNO,C1.CP01,C1.CP02,C1.CP03,C1.CP04,C1.CP09,DECODE(C1.CP01,'P',DECODE(PA09,'000','台灣','非台灣'),'FCP',DECODE(PA09,'000','台灣','非台灣'),C1.CP01) TYPE,C2.CP14,SUBSTR(C1.CP05,1,4)-1911 YEAR,PA08 FROM CASEPROGRESS C1,CASEPROGRESS C2,PATENT WHERE C1.CP01 IN ('P','FCP') AND C1.CP10 IN ('1201','1202') AND C1.CP05>=" & strVol1_S & " AND C1.CP05<=" & strVol1_E & " AND SUBSTR(C1.CP12,1,1)<>'F' AND C1.CP43=C2.CP09(+) AND C1.CP01=PA01(+) AND C1.CP02=PA02(+) AND C1.CP03=PA03(+) AND C1.CP04=PA04(+) " & _
                      "UNION SELECT 'P1' DEPTNO,C1.CP01,C1.CP02,C1.CP03,C1.CP04,C1.CP09,DECODE(C1.CP01,'P',DECODE(PA09,'000','台灣','非台灣'),'FCP',DECODE(PA09,'000','台灣','非台灣'),C1.CP01) TYPE,C2.CP14,SUBSTR(C1.CP05,1,4)-1911 YEAR,PA08 FROM CASEPROGRESS C1,CASEPROGRESS C2,PATENT WHERE C1.CP01 IN ('P','FCP') AND C1.CP10 IN ('1201','1202') AND C1.CP05>=" & strVol2_S & " AND C1.CP05<=" & strVol2_E & " AND SUBSTR(C1.CP12,1,1)<>'F' AND C1.CP43=C2.CP09(+) AND C1.CP01=PA01(+) AND C1.CP02=PA02(+) AND C1.CP03=PA03(+) AND C1.CP04=PA04(+) " & _
                      "UNION SELECT 'P1' DEPTNO,CP01,CP02,CP03,CP04,CP09,CP01 TYPE,CP14,SUBSTR(CP05,1,4)-1911 YEAR,PA08 FROM CASEPROGRESS,PATENT,STAFF WHERE CP01='CFP' AND CP14=ST01(+) AND ST03 IN ('P10','P11') AND CP05>=" & strVol1_S & " AND CP05<=" & strVol1_E & " AND CP01=PA01(+) AND CP02=PA02(+) AND CP03=PA03(+) AND CP04=PA04(+) " & _
                      "UNION SELECT 'P1' DEPTNO,CP01,CP02,CP03,CP04,CP09,CP01 TYPE,CP14,SUBSTR(CP05,1,4)-1911 YEAR,PA08 FROM CASEPROGRESS,PATENT,STAFF WHERE CP01='CFP' AND CP14=ST01(+) AND ST03 IN ('P10','P11') AND CP05>=" & strVol2_S & " AND CP05<=" & strVol2_E & " AND CP01=PA01(+) AND CP02=PA02(+) AND CP03=PA03(+) AND CP04=PA04(+) " & _
               ") ) WHERE CP14=ST01(+) " & _
               "GROUP BY NVL(SUBSTR(ST03,1,2),DEPTNO),TYPE,DECODE(ST16,'P',NULL,'CFP',NULL,'1','1電子電機','2','2化學','3','3日文','4','4機械設計',ST16),CP14,ST02 " & _
               "ORDER BY 部門,案件,組別,CP14"

    If m_rs.State <> adStateClosed Then m_rs.Close
    Set m_rs = Nothing
    m_rs.CursorLocation = adUseClient
    m_rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
    If m_rs.RecordCount > 0 Then
        strTempFile = TransDate(strVol1_S, 1) & "至" & TransDate(strVol1_E, 1) & "專利審查意見通知件數統計"
        strPath = App.path & TextPath & strTempFile & ".xls"
        If Dir(strPath) <> "" Then
           Kill strPath
        End If
        strAllPath = strAllPath & IIf(strAllPath <> "", "*", "") & strPath
        strAllFile = strAllFile & IIf(strAllFile <> "", vbCrLf, "") & strTempFile
        strGrp = "": strGrpL = ""
        xlsPoint.SheetsInNewWorkbook = 2 'Added by Lydia 2019/03/12 預設工作表數目
        xlsPoint.Workbooks.add
        
        With m_rs
           .MoveFirst
           Do While Not .EOF
              If strGrp <> Mid("" & .Fields("部門"), 1, 1) And "" & .Fields("部門") <> "" Then
                 If strGrp = "" Then
                    iPage = 1
                    '外專-欄位抬頭
                    strTmpA1 = Empty
                    strTitle1 = "案件,組別,承辦人,發明去年同期,新型去年同期,設計去年同期,發明當期,新型當期,設計當期"
                    strTmpA1 = Split(strTitle1, ",")
                 Else
                    iPage = 2
                    '內專-欄位抬頭
                    strTmpA1 = Empty
                    strTitle1 = "案件,承辦人,發明去年同期,新型去年同期,設計去年同期,發明當期,新型當期,設計當期"
                    strTmpA1 = Split(strTitle1, ",")
                 End If
                 '設定頁面與表頭
                 
                 Set wksA84 = xlsPoint.Worksheets(iPage)
                 xlsPoint.Worksheets(iPage).Name = IIf(Mid("" & .Fields("部門"), 1, 2) = "F2", "外專", "內專")
                 wksA84.PageSetup.Orientation = xlPortrait '直印
                 xRows = 3
                 For inJ = 0 To UBound(strTmpA1)
                    If Trim(strTmpA1(inJ)) <> "" Then
                       If (iPage = 1 And inJ > 2) Or (iPage = 2 And inJ > 1) Then
                          wksA84.Range(Chr(Asc("a") + inJ) & xRows).Value = Mid(Trim(strTmpA1(inJ)), 1, 2) '欄位名稱
                          wksA84.Columns(Chr(Asc("a") + inJ) & ":" & Chr(Asc("a") + inJ)).ColumnWidth = 8
                          wksA84.Columns(Chr(Asc("a") + inJ) & ":" & Chr(Asc("a") + inJ)).HorizontalAlignment = xlRight
                          wksA84.Columns(Chr(Asc("a") + inJ) & ":" & Chr(Asc("a") + inJ)).NumberFormatLocal = "##0"
                       Else
                          wksA84.Range(Chr(Asc("a") + inJ) & xRows).Value = Trim(strTmpA1(inJ)) '欄位名稱
                          wksA84.Columns(Chr(Asc("a") + inJ) & ":" & Chr(Asc("a") + inJ)).ColumnWidth = 10
                          wksA84.Columns(Chr(Asc("a") + inJ) & ":" & Chr(Asc("a") + inJ)).NumberFormatLocal = "@"   '欄位設定為文字型態
                       End If
                    End If
                 Next inJ
                 
                 '抬頭
                 If iPage = 1 Then
                    wksA84.Range("d2").Value = TransDate(strVol2_S, 1) & "~" & TransDate(strVol2_E, 1)
                    With wksA84.Range("d2:f2")
                      .WrapText = False
                      .MergeCells = True
                      .HorizontalAlignment = xlCenter
                      .VerticalAlignment = xlBottom
                    End With
                    wksA84.Range("g2").Value = TransDate(strVol1_S, 1) & "~" & TransDate(strVol1_E, 1)
                    With wksA84.Range("g2:i2")
                      .WrapText = False
                      .MergeCells = True
                      .HorizontalAlignment = xlCenter
                      .VerticalAlignment = xlBottom
                    End With
                    strExc(1) = "(FCP案只計算通知修正1201及審查意見通知函1202之來函資料)"
                 Else
                    wksA84.Range("c2").Value = TransDate(strVol2_S, 1) & "~" & TransDate(strVol2_E, 1)
                    With wksA84.Range("c2:e2")
                      .WrapText = False
                      .MergeCells = True
                      .HorizontalAlignment = xlCenter
                      .VerticalAlignment = xlBottom
                    End With
                    wksA84.Range("f2").Value = TransDate(strVol1_S, 1) & "~" & TransDate(strVol1_E, 1)
                    With wksA84.Range("f2:h2")
                      .WrapText = False
                      .MergeCells = True
                      .HorizontalAlignment = xlCenter
                      .VerticalAlignment = xlBottom
                    End With
                    strExc(1) = "(P案只計算通知修正1201及審查意見通知函1202之來函資料;CFP案計算承辦人為工程師的所有來函資料)"
                 End If
                 wksA84.Range("a1").Value = strExc(1) '註解
                 wksA84.Range("a1").Font.Color = &HFF&
                 With wksA84.Range("a1:j1")
                   .WrapText = False
                   .MergeCells = True
                   .HorizontalAlignment = xlCenter
                   .VerticalAlignment = xlBottom
                 End With
                 
              ElseIf strGrpL <> "" & .Fields("案件") Then
                 xRows = xRows + 1
              End If
              xRows = xRows + 1
              For inJ = 0 To UBound(strTmpA1)
                  If Trim(strTmpA1(inJ)) <> "" Then
                     strExc(1) = ""
                     Select Case Trim(strTmpA1(inJ))
                         Case "案件": strExc(1) = Trim("" & .Fields("案件"))
                         Case "組別": strExc(1) = Trim("" & .Fields("組別"))
                         Case "承辦人"
                             If Trim("" & .Fields("承辦人")) = "" Then
                                strExc(1) = Trim("" & .Fields("CP14")) '未分派承辦人,改顯示案號
                             Else
                                strExc(1) = Trim("" & .Fields("承辦人"))
                             End If
                         Case "發明去年同期": strExc(1) = Trim("" & .Fields("發明去年同期"))
                         Case "新型去年同期": strExc(1) = Trim("" & .Fields("新型去年同期"))
                         Case "設計去年同期": strExc(1) = Trim("" & .Fields("設計去年同期"))
                         Case "發明當期": strExc(1) = Trim("" & .Fields("發明當期"))
                         Case "新型當期": strExc(1) = Trim("" & .Fields("新型當期"))
                         Case "設計當期": strExc(1) = Trim("" & .Fields("設計當期"))
                     End Select
                     wksA84.Range(Chr(Asc("a") + inJ) & xRows).Value = strExc(1) '欄位內容
                  End If
              Next inJ
              strGrp = Mid("" & .Fields("部門"), 1, 1)
              strGrpL = "" & .Fields("案件")
              .MoveNext
           Loop
        End With

        '判斷若版本2007以上改變存檔格式
        If Val(xlsPoint.Version) < 12 Then
           xlsPoint.Workbooks(1).SaveAs FileName:=strPath, FileFormat:=-4143
        Else
           xlsPoint.Workbooks(1).SaveAs FileName:=strPath, FileFormat:=56
        End If
        xlsPoint.Workbooks.Close
        xlsPoint.Quit
        Set xlsPoint = Nothing
        Set wksA84 = Nothing
    End If
    If strAllPath <> "" Then
        strExc(0) = vbCrLf & "Dear Sir:" & vbCrLf & vbCrLf & strAllFile & vbCrLf & "，詳情請參閱附件。"
        '寄給A5024(王[娟)
        SendMAPIMail "A5024", TransDate(strVol1_S, 1) & "~" & TransDate(strVol1_E, 1) & "專利及商標審查意見通知件數統計", strExc(0), strAllPath
    End If
    Exit Sub
    
DebugErr:
   WLog Err.Description
   
End Sub

'Added by Lydia 2017/05/23 T收款寄證催款提醒
Private Sub StrMenu85()
Dim rsRD As New ADODB.Recordset
Dim strGrp As String
Dim ff85 As Integer
Dim intR As Integer
Dim strTemp(0 To 6) As String
Dim TFName As String
Dim strTLine As String, strTLine2 As String

TFName = "T收款寄證催款提醒"
If Dir(App.path & TextPath & TFName & ".txt") <> "" Then
   Kill App.path & TextPath & TFName & ".txt"
End If

 strTLine = "本所案號        案件名稱         申請人名稱       代理人    代理人名稱       收文日    本所期限 "
strTLine2 = "=============== ================ ================ ========= ================ ========= ========="
           
    strSql = "SELECT NVL(CU04,NVL(CU05,CU06)) CUSTNAME,NVL(TM05,NVL(TM06,TM07)) CASENAME,TM44 FNO,NVL(FA04,NVL(FA05,FA06)) FNAME,CP01,CP02,CP03,CP04,SQLDATET(CP05) CP05T,SQLDATET(CP06) CP06T,CP07,CP09,CP13,CP14 " & _
             "FROM CASEPROGRESS,TRADEMARK,CUSTOMER,FAGENT " & _
             "WHERE CP01=TM01(+) AND CP02=TM02(+) AND CP03=TM03(+) AND CP04=TM04(+) AND SUBSTR(TM23,1,8)=CU01(+) AND SUBSTR(TM23,9,1)=CU02(+) " & _
             "AND SUBSTR(TM44,1,8)=FA01(+) AND SUBSTR(TM44,9,1)=FA02(+) AND CP01='T' AND CP10='1728' AND CP158=0 AND CP159=0 AND CP06<=" & strSrvDate(1) & _
             " ORDER BY CP14,CP06,CP09"
    Set rsRD = New ADODB.Recordset
    rsRD.CursorLocation = adUseClient
    rsRD.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
        
On Error GoTo ErrHand

    If rsRD.RecordCount > 0 Then
       With rsRD
          .MoveFirst
          cnnConnection.BeginTrans
          Do While Not rsRD.EOF
             If strGrp <> "" & .Fields("CP14") Then
                If ff85 > 0 Then
                   Print #ff85, String(Len(strTLine2), "=")
                   Print #ff85, "共 " & intR & " 筆"
                   Close #ff85
                   SendMAPIMail strGrp, strSrvDate(2) & "_" & TFName, vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, App.path & TextPath & TFName & ".txt"
                End If
                ff85 = FreeFile
                intR = 0
                Open App.path & TextPath & TFName & ".txt" For Output As ff85
                Print #ff85, Space(40) & TFName
                Print #ff85, ""
                Print #ff85, "列印日期：" & ChangeTStringToTDateString(strSrvDate(2))
                Print #ff85, ""
                Print #ff85, strTLine
                Print #ff85, strTLine2
             End If
             strTemp(0) = convForm(.Fields("CP01") & "-" & .Fields("CP02") & "-" & .Fields("CP03") & "-" & .Fields("CP04"), 15)
             strTemp(1) = convForm(.Fields("CASENAME"), 16)
             strTemp(2) = convForm(.Fields("CUSTNAME"), 16)
             strTemp(3) = convForm(.Fields("FNO"), 9)
             strTemp(4) = convForm(.Fields("FNAME"), 16)
             strTemp(5) = convForm(.Fields("CP05T"), 9)
             strTemp(6) = convForm(.Fields("CP06T"), 9)
             Print #ff85, strTemp(0) & " " & strTemp(1) & " " & strTemp(2) & " " & strTemp(3) & " " & strTemp(4) & " " & strTemp(5) & " " & strTemp(6)
             
             '寄發通知後再將本所期限及法定期限延後為系統日+1個月,若為假日則抓下一個工作日
             strExc(1) = CompWorkDay(1, CompDate(1, 1, strSrvDate(1)), 0)

             strSql = "UPDATE CASEPROGRESS SET CP06=" & strExc(1) & " , CP07=" & strExc(1) & " WHERE CP09='" & .Fields("CP09") & "' "
             cnnConnection.Execute strSql
             
             strGrp = "" & .Fields("CP14")
             intR = intR + 1
             .MoveNext
          Loop
        cnnConnection.CommitTrans
       End With
       
       If ff85 > 0 Then
          Print #ff85, String(Len(strTLine2), "=")
          Print #ff85, "共 " & intR & " 筆"
          Close ff85
          SendMAPIMail strGrp, strSrvDate(2) & "_" & TFName, vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, App.path & TextPath & TFName & ".txt"
       End If
    End If
    
    Set rsRD = Nothing
    Exit Sub

ErrHand:
    cnnConnection.RollbackTrans
    WLog "資料更新失敗" & " " & Err.Description
    
End Sub

'Added by Lydia 2017/06/08 台灣商標延展案可辦日前預先通知智權人員
Sub StrMenu86(ByVal pKind As String)
'pKind=1 (北中所-前10個工作天) ; pKind=2 (南高所-前一個月)
On Error GoTo DebugErr
Dim f86 As Integer
Dim i As Integer
Dim strTemp(0 To 10) As String
Dim iCount As Long
Dim TempFileName As String
Dim strGrp As String
Dim strTitle As String
Dim strTitleLine As String
Dim T_Date As String
   
   If pKind = "1" Then
      TempFileName = "台灣商標延展案可辦日前10個工作天預先通知"
   Else
      TempFileName = "台灣商標延展案可辦日前一個月預先通知"
   End If
   If Dir(App.path & TextPath & TempFileName & ".txt") <> "" Then
       Kill App.path & TextPath & TempFileName & ".txt"
   End If
   
    strTitle = "申請人名稱           本所案號      審定號   收文日    法定期限  可辦日期  案件名稱             費用   電話                                      "
strTitleLine = "==================== ============= ======== ========= ========= ========= ==================== ====== =========================================="

   T_Date = strSrvDate(1)
   
   If pKind = "1" Then
      '北中所+其他:前10個工作天通知
      'Modified by Lydia 2017/07/03  PUB_Get102DeadLine("1", => PUB_Get102DeadLine("4"
      'Modified by Lydia 2020/05/18 費用要扣銷帳金額, ex.T-226542
      'strSql = "SELECT cp13,st02,st06,cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) caseno," & _
               "tm15,nvl(tm05,nvl(tm06,tm07)) casename,tm23,nvl(cu04,nvl(cu05,cu06)) cname,sqldatet(cp07) cp07,cp16 as fee,cp18 as degree," & _
               "cu16||';'||cu17 tel,cu18||';'||cu19 fax,sqldatet(" & PUB_Get102DeadLine("4", "CP07", 1, 0) & ") ddate,cp09,sqldatet(cp05) cp05 " & _
               "From CaseProgress, Customer, TradeMark, staff " & _
               "WHERE substr(cp01,1,1)='T' and cp01<>'TF' and CP10='102' and cp07 > 20000000 and CP158=0 AND CP159=0 and (TM29 is null) and cp145 is null " & _
               " and workdayadd(-11," & PUB_Get102DeadLine("4", "CP07", 1, 0) & ") <= " & T_Date & _
               " and cp05<=" & PUB_Get102DeadLine("4", "CP07", 1, 0) & _
               " and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+) and substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+)" & _
               " and tm10<>'020' and cp13=st01(+) and st06<>'3' and st06<>'4' order by cp13,cp07,tm23,caseno "
      strSql = "SELECT cp13,st02,st06,cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) caseno," & _
               "tm15,nvl(tm05,nvl(tm06,tm07)) casename,tm23,nvl(cu04,nvl(cu05,cu06)) cname,sqldatet(cp07) cp07,cp16-nvl(a1u07,0)-nvl(a1u09,0) as fee,((cp16-nvl(a1u07,0)-nvl(a1u09,0))-(nvl(cp17,0)-nvl(a1u09,0)))/1000 as degree," & _
               "cu16||';'||cu17 tel,cu18||';'||cu19 fax,sqldatet(" & PUB_Get102DeadLine("4", "CP07", 1, 0) & ") ddate,cp09,sqldatet(cp05) cp05 " & _
               "From CaseProgress, Customer, TradeMark, staff,(select a1u03,sum(a1u07) a1u07,sum(a1u09) a1u09 from acc1u0 group by a1u03) x1 " & _
               "WHERE substr(cp01,1,1)='T' and cp01<>'TF' and CP10='102' and cp07 > 20000000 and CP158=0 AND CP159=0 and (TM29 is null) and cp145 is null " & _
               " and workdayadd(-11," & PUB_Get102DeadLine("4", "CP07", 1, 0) & ") <= " & T_Date & _
               " and cp05<=" & PUB_Get102DeadLine("4", "CP07", 1, 0) & _
               " and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+) and substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+)" & _
               " and tm10<>'020' and cp13=st01(+) and st06<>'3' and st06<>'4' and cp09=a1u03(+) order by cp13,cp07,tm23,caseno "
   Else
      '南高所:前一個月通知
      'Modified by Lydia 2017/07/03  PUB_Get102DeadLine("1", => PUB_Get102DeadLine("4"
      'Modified by Lydia 2020/05/18 費用要扣銷帳金額, ex.T-226542
      'strSql = "SELECT cp13,st02,st06,cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) caseno," & _
               "tm15,nvl(tm05,nvl(tm06,tm07)) casename,tm23,nvl(cu04,nvl(cu05,cu06)) cname,sqldatet(cp07) cp07,cp16 as fee,cp18 as degree," & _
               "cu16||';'||cu17 tel,cu18||';'||cu19 fax,sqldatet(" & PUB_Get102DeadLine("4", "CP07", 1, 0) & ") ddate,cp09,sqldatet(cp05) cp05 " & _
               "From CaseProgress, Customer, TradeMark, staff " & _
               "WHERE substr(cp01,1,1)='T' and cp01<>'TF' and CP10='102' and cp07 > 20000000 and CP158=0 AND CP159=0 and (TM29 is null) and cp145 is null " & _
               " and " & PUB_Get102DeadLine("4", "CP07", 1, 1) & " <= " & T_Date & _
               " and cp05<=" & PUB_Get102DeadLine("4", "CP07", 1, 1) & _
               " and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+) and substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+)" & _
               " and tm10<>'020' and cp13=st01(+) and (st06='3' or st06='4') order by cp13,cp07,tm23,caseno "
      strSql = "SELECT cp13,st02,st06,cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) caseno," & _
               "tm15,nvl(tm05,nvl(tm06,tm07)) casename,tm23,nvl(cu04,nvl(cu05,cu06)) cname,sqldatet(cp07) cp07,cp16-nvl(a1u07,0)-nvl(a1u09,0) as fee,((cp16-nvl(a1u07,0)-nvl(a1u09,0))-(nvl(cp17,0)-nvl(a1u09,0)))/1000 as degree," & _
               "cu16||';'||cu17 tel,cu18||';'||cu19 fax,sqldatet(" & PUB_Get102DeadLine("4", "CP07", 1, 0) & ") ddate,cp09,sqldatet(cp05) cp05 " & _
               "From CaseProgress, Customer, TradeMark, staff,(select a1u03,sum(a1u07) a1u07,sum(a1u09) a1u09 from acc1u0 group by a1u03) x1 " & _
               "WHERE substr(cp01,1,1)='T' and cp01<>'TF' and CP10='102' and cp07 > 20000000 and CP158=0 AND CP159=0 and (TM29 is null) and cp145 is null " & _
               " and " & PUB_Get102DeadLine("4", "CP07", 1, 1) & " <= " & T_Date & _
               " and cp05<=" & PUB_Get102DeadLine("4", "CP07", 1, 1) & _
               " and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+) and substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+)" & _
               " and tm10<>'020' and cp13=st01(+) and (st06='3' or st06='4') and cp09=a1u03(+) order by cp13,cp07,tm23,caseno "
   End If
   Set Rs = New ADODB.Recordset
   Rs.CursorLocation = adUseClient
   Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   With Rs
       If .RecordCount > 0 And .RecordCount <> 0 Then
           .MoveFirst
           cnnConnection.BeginTrans
           Do While Not .EOF
               If strGrp <> "" & .Fields("cp13") Then
                   If f86 > 0 Then
                      Print #f86, String(Len(strTitleLine), "=")
                      Print #f86, "共 " & iCount & " 筆"
                      Close #f86
                      SendMAPIMail strGrp, "台灣商標延展案前已收文，將要可以辦理，請與申請人再確認！", vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, App.path & TextPath & TempFileName & ".txt"
                   End If
                   'Added by Lydia 2020/08/26
                    If Dir(App.path & TextPath & TempFileName & ".txt") <> "" Then
                        Kill App.path & TextPath & TempFileName & ".txt"
                    End If
                   'end 2020/08/26
                   f86 = FreeFile
                   iCount = 0
                   Open App.path & TextPath & TempFileName & ".txt" For Output As f86
                   Print #f86, String(50, " ") & "台灣商標延展案於可辦期限前已收文明細"
                   Print #f86, ""
                   Print #f86, "智權人員：" & .Fields("st02")
                   Print #f86, ""
                   Print #f86, strTitle
                   Print #f86, strTitleLine
               End If
                              
               strTemp(0) = "" & convForm(CheckStr(.Fields("cname").Value), 20)
               strTemp(1) = "" & convForm(CheckStr(.Fields("caseno").Value), 13)
               strTemp(2) = "" & convForm(CheckStr(.Fields("tm15").Value), 8)
               strTemp(3) = "" & convForm(CheckStr(.Fields("cp05").Value), 9)
               strTemp(4) = "" & convForm(CheckStr(.Fields("cp07").Value), 9)  '法限
               strTemp(5) = "" & convForm(CheckStr(.Fields("ddate").Value), 9) '可辦期限
               strTemp(6) = "" & convForm(CheckStr(.Fields("casename").Value), 20)
               strTemp(7) = "" & PUB_StrToStr(CheckStr(Format(.Fields("fee").Value, "#,##0")), 6, True, True)
               strTemp(8) = "" & convForm(IIf("" & .Fields("tel").Value = ";", "", "" & .Fields("tel").Value), 42)
              
               Print #f86, strTemp(0) & " " & strTemp(1) & " " & strTemp(2) & " " & strTemp(3) & " " & strTemp(4) & " " & strTemp(5) & " " & strTemp(6) & " " & strTemp(7) & " " & strTemp(8)
               iCount = iCount + 1
               strGrp = "" & .Fields("cp13")
               '通知後CP145='Y'
               strSql = "update caseprogress set cp145='Y' where cp09='" & .Fields("cp09") & "' "
               cnnConnection.Execute strSql
               .MoveNext
           Loop
           cnnConnection.CommitTrans
       End If
   End With
   
   If f86 > 0 Then
       Print #f86, String(Len(strTitleLine), "=")
       Print #f86, "共 " & iCount & " 筆"
       Close #f86
       SendMAPIMail strGrp, "台灣商標延展案前已收文，將要可以辦理，請與申請人再確認！", vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, App.path & TextPath & TempFileName & ".txt"
   End If
   
   Exit Sub
   
DebugErr:
    cnnConnection.RollbackTrans
    WLog "資料更新失敗" & " " & Err.Description
End Sub

'Added by Lydia 2017/06/21 台灣商標案勝訴滿3個月提醒承辦人
Sub StrMenu87()
On Error GoTo DebugErr
Dim f87 As Integer
Dim rsAD As ADODB.Recordset
Dim i As Integer
'Modified by Lydia 2018/05/02
'Dim strTemp(0 To 5) As String
Dim strTemp(0 To 6) As String
Dim iCount As Long
Dim TempFileName As String
Dim strGrp As String
Dim strTitle As String
Dim strTitleLine As String
Dim stCon As String

'Modified by Lydia 2018/05/02 +申請國家
'   TempFileName = "台灣商標案勝訴滿3個月明細表"
'    strTitle = "本所案號        案件名稱             案件性質 勝訴日    申請人名稱           智權人員"
'strTitleLine = "=============== ==================== ======== ========= ==================== ========"
    TempFileName = "商標案勝訴滿3個月明細表"
    strTitle = "申請國家 本所案號        案件名稱             案件性質 勝訴日    申請人名稱           智權人員"
strTitleLine = "======== =============== ==================== ======== ========= ==================== ========"
'end 2018/05/02
    If Dir(App.path & TextPath & TempFileName & ".txt") <> "" Then
       Kill App.path & TextPath & TempFileName & ".txt"
    End If
    
   strExc(1) = CompDate(1, -3, strSrvDate(1)) '3個月前的日期
   strExc(2) = GetLastDay(strExc(1))          '3個月前的月底
  
   stCon = " AND C1.CP05=" & strExc(1) & " "
   
   '系統日當天若為月底,抓3個月前的日期到該月月底
   If Val(strSrvDate(1)) = Val(GetLastDay(strSrvDate(1))) And strExc(1) < strExc(2) Then
       stCon = " AND C1.CP05>=" & strExc(1) & " AND C1.CP05<=" & strExc(2) & " "
   End If
   'Modified by Lydia 2018/05/02 不限台灣案,並且+申請國家
   'strSql = " select c1.cp14 ,s2.st02 cp14n,c1.cp01,c1.cp02,c1.cp03,c1.cp04,nvl(tm05,nvl(tm06,tm07)) casename," & _
            " sqldatet(c1.cp05) cp05,c2.cp10,c2.cp09,cpm03,tm23 cuno1,nvl(cu04,nvl(cu05,cu06)) cunam1,c1.cp13,s1.st02 cp13n" & _
            " from caseprogress c1,caseprogress c2,trademark,staff s1,staff s2,customer,casepropertymap" & _
            " where c1.cp01 in ('T','FCT') and  c1.cp10='1003' " & stCon & _
            " and c1.cp01=tm01(+) and c1.cp02=tm02(+) and c1.cp03=tm03(+) and c1.cp04=tm04(+) and tm10='000'" & _
            " and c1.cp43=c2.cp09(+) and c2.cp10 in ('601','603','605') and c1.cp13=s1.st01(+) and c1.cp14=s2.st01(+)" & _
            " and substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+) and c2.cp01=cpm01(+) and c2.cp10=cpm02(+)" & _
            " order by c1.cp14,c1.cp01,c1.cp05 ,c1.cp02,c1.cp03,c1.cp04"
   strSql = " select c1.cp14 ,s2.st02 cp14n,c1.cp01,c1.cp02,c1.cp03,c1.cp04,nvl(tm05,nvl(tm06,tm07)) casename," & _
            " sqldatet(c1.cp05) cp05,c2.cp10,c2.cp09,cpm03,tm23 cuno1,nvl(cu04,nvl(cu05,cu06)) cunam1,c1.cp13,s1.st02 cp13n, na03 " & _
            " from caseprogress c1,caseprogress c2,trademark,staff s1,staff s2,customer,casepropertymap,nation" & _
            " where c1.cp01 in ('T','FCT') and  c1.cp10='1003' " & stCon & _
            " and c1.cp01=tm01(+) and c1.cp02=tm02(+) and c1.cp03=tm03(+) and c1.cp04=tm04(+) " & _
            " and c1.cp43=c2.cp09(+) and c2.cp10 in ('601','603','605') and c1.cp13=s1.st01(+) and c1.cp14=s2.st01(+)" & _
            " and substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+) and c2.cp01=cpm01(+) and c2.cp10=cpm02(+)" & _
            " and tm10=na01(+) order by c1.cp14,tm10,c1.cp01,c1.cp05 ,c1.cp02,c1.cp03,c1.cp04"
   Set rsAD = New ADODB.Recordset
   rsAD.CursorLocation = adUseClient
   rsAD.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   With rsAD
       If .RecordCount > 0 And .RecordCount <> 0 Then
           .MoveFirst
           Do While Not .EOF
               If strGrp <> "" & .Fields("cp14") Then
                   If f87 > 0 Then
                      Print #f87, String(Len(strTitleLine), "=")
                      Print #f87, "共 " & iCount & " 筆"
                      Close #f87
                      SendMAPIMail strGrp, "爭議案勝訴已滿3個月，請查詢是否已確定。", vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, App.path & TextPath & TempFileName & ".txt"
                   End If
                   'Added by Lydia 2020/08/26
                    If Dir(App.path & TextPath & TempFileName & ".txt") <> "" Then
                       Kill App.path & TextPath & TempFileName & ".txt"
                    End If
                   'end 2020/08/26
                   f87 = FreeFile
                   iCount = 0
                   Open App.path & TextPath & TempFileName & ".txt" For Output As f87
                   Print #f87, String(30, " ") & TempFileName
                   Print #f87, ""
                   Print #f87, "承辦人員：" & .Fields("cp14n")
                   Print #f87, ""
                   Print #f87, strTitle
                   Print #f87, strTitleLine
               End If

               strTemp(0) = "" & convForm(CheckStr(.Fields("cp01").Value & "-" & .Fields("cp02").Value & "-" & .Fields("cp03").Value & "-" & .Fields("cp04").Value), 15)
               strTemp(1) = "" & convForm(CheckStr(.Fields("casename").Value), 20)
               strTemp(2) = "" & convForm(CheckStr(.Fields("cpm03").Value), 8)
               strTemp(3) = "" & convForm(CheckStr(.Fields("cp05").Value), 9)
               strTemp(4) = "" & convForm(CheckStr(.Fields("cunam1").Value), 20)
               strTemp(5) = "" & convForm(CheckStr(.Fields("cp13n").Value), 8)
               strTemp(6) = "" & convForm(CheckStr(.Fields("na03").Value), 8) 'Added by Lydia 2018/05/02  +申請國家
               
               'Modified by Lydia 2018/05/02  +申請國家
               'Print #f87, strTemp(0) & " " & strTemp(1) & " " & strTemp(2) & " " & strTemp(3) & " " & strTemp(4) & " " & strTemp(5)
               Print #f87, strTemp(6) & " " & strTemp(0) & " " & strTemp(1) & " " & strTemp(2) & " " & strTemp(3) & " " & strTemp(4) & " " & strTemp(5)
               iCount = iCount + 1
               strGrp = "" & .Fields("cp14")
               .MoveNext
           Loop
       End If
   End With
   
   If f87 > 0 Then
       Print #f87, String(Len(strTitleLine), "=")
       Print #f87, "共 " & iCount & " 筆"
       Close #f87
       SendMAPIMail strGrp, "爭議案勝訴已滿3個月，請查詢是否已確定。", vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, App.path & TextPath & TempFileName & ".txt"
   End If
   Set rsAD = Nothing
   Exit Sub
   
DebugErr:
   If Err.Number <> 0 Then
      Set rsAD = Nothing
      WLog "台灣商標案勝訴滿3個月提醒承辦人:" & Err.Description
   End If
End Sub

'Add by Amy 2018/01/31 每日發前一個工作日新建客戶明細給葉特助
Sub StrMenu89()
    Dim xlsAgentPoint As New Excel.Application
    Dim wksrpt As New Worksheet
    Dim RsQ As New ADODB.Recordset
    Dim strQ As String, xlsFileName As String
    Dim i As Integer, intCounter As Integer, intTitle As Integer
    Dim stDate As String, stVal As String
    Dim stTmp, intWidth
    
On Error GoTo ErrHand
    stDate = PUB_GetWorkDayAfterSysDate(CDbl(strSrvDate(1)), -1) + 19110000 '系統前一個工作日
        
    strQ = "Select CP01,Nvl(Nvl(Nvl(Nvl(PA26,TM23),SP08),LC11),HC05) PA26 From CaseProgress,Patent,TradeMark,LawCase,HireCase,ServicePractice " & _
               "Where CP66=" & Val(stDate) & " And CP09<'B' And CP01=PA01(+) And CP02=PA02(+) And CP03=PA03(+) And CP04=PA04(+) " & _
                    "And CP01=TM01(+) And CP02=TM02(+) And CP03=TM03(+) And CP04=TM04(+) And CP01=SP01(+) And CP02=SP02(+) And CP03=SP03(+) And CP04=SP04(+) " & _
                    "And CP01=LC01(+) And CP02=LC02(+) And CP03=LC03(+) And CP04=LC04(+) And CP01=HC01(+) And CP02=HC02(+) And CP03=HC03(+) And CP04=HC04(+) " & _
     "Union Select CP01,Nvl(Nvl(Nvl(Nvl(PA27,TM78),SP58),LC43),HC24) PA26 From CaseProgress,Patent,TradeMark,LawCase,HireCase,ServicePractice " & _
                "Where CP66=" & Val(stDate) & " And CP09<'B' And CP01=PA01(+) And CP02=PA02(+) And CP03=PA03(+) And CP04=PA04(+) " & _
                    "And CP01=TM01(+) And CP02=TM02(+) And CP03=TM03(+) And CP04=TM04(+) And CP01=SP01(+) And CP02=SP02(+) And CP03=SP03(+) And CP04=SP04(+) " & _
                    "And CP01=LC01(+) And CP02=LC02(+) And CP03=LC03(+) And CP04=LC04(+) And CP01=HC01(+) And CP02=HC02(+) And CP03=HC03(+) And CP04=HC04(+) " & _
     "Union Select CP01,Nvl(Nvl(Nvl(Nvl(PA28,TM79),SP59),LC44),HC25) PA26 From CaseProgress,Patent,TradeMark,LawCase,HireCase,ServicePractice " & _
                "Where CP66=" & Val(stDate) & " And CP09<'B' And CP01=PA01(+) And CP02=PA02(+) And CP03=PA03(+) And CP04=PA04(+) " & _
                    "And CP01=TM01(+) And CP02=TM02(+) And CP03=TM03(+) And CP04=TM04(+) And CP01=SP01(+) And CP02=SP02(+) And CP03=SP03(+) And CP04=SP04(+) " & _
                    "And CP01=LC01(+) And CP02=LC02(+) And CP03=LC03(+) And CP04=LC04(+) And CP01=HC01(+) And CP02=HC02(+) And CP03=HC03(+) And CP04=HC04(+) " & _
     "Union Select CP01,Nvl(Nvl(Nvl(Nvl(PA29,TM80),SP65),LC45),HC26) PA26 From CaseProgress,Patent,TradeMark,LawCase,HireCase,ServicePractice " & _
                "Where CP66=" & Val(stDate) & " And CP09<'B' And CP01=PA01(+) And CP02=PA02(+) And CP03=PA03(+) And CP04=PA04(+) " & _
                    "And CP01=TM01(+) And CP02=TM02(+) And CP03=TM03(+) And CP04=TM04(+) And CP01=SP01(+) And CP02=SP02(+) And CP03=SP03(+) And CP04=SP04(+) " & _
                    "And CP01=LC01(+) And CP02=LC02(+) And CP03=LC03(+) And CP04=LC04(+) And CP01=HC01(+) And CP02=HC02(+) And CP03=HC03(+) And CP04=HC04(+) " & _
     "Union Select CP01,Nvl(Nvl(Nvl(Nvl(PA30,TM81),SP66),LC46),HC27) PA26 From CaseProgress,Patent,TradeMark,LawCase,HireCase,ServicePractice " & _
                "Where CP66=" & Val(stDate) & " And CP09<'B' And CP01=PA01(+) And CP02=PA02(+) And CP03=PA03(+) And CP04=PA04(+) " & _
                    "And CP01=TM01(+) And CP02=TM02(+) And CP03=TM03(+) And CP04=TM04(+) And CP01=SP01(+) And CP02=SP02(+) And CP03=SP03(+) And CP04=SP04(+) " & _
                    "And CP01=LC01(+) And CP02=LC02(+) And CP03=LC03(+) And CP04=LC04(+) And CP01=HC01(+) And CP02=HC02(+) And CP03=HC03(+) And CP04=HC04(+) "

    strQ = "Select CU01||CU02 客戶編號,Nvl(Nvl(CU04,CU05),CU06) 名稱,'' as 關係企業,A0902 業務區,ST02 智權人員,CP01 系統別 " & _
              "From CUSTOMER,ACC090,STAFF, " & _
              "(Select DISTINCT CP01,PA26 From (" & strQ & ") Where PA26 IS NOT NULL ) " & _
              "Where CU02='0' And CU14=" & Val(stDate) & " And CU12=A0901(+) And CU13=ST01(+) And CU01||CU02=PA26(+) " & _
              "Order by CU82,CU83"
                  
    RsQ.CursorLocation = adUseClient
    RsQ.Open strQ, cnnConnection, adOpenStatic, adLockReadOnly
    If RsQ.RecordCount > 0 Then
        intCounter = 1
        stTmp = Array("客戶編號", "名稱", "　", "業務區", "智權人員", "系統別")
        intWidth = Array(10, 38, 10, 12, 10, 9)
        'Run Excel
        xlsFileName = stDate & "新建客戶明細" & MsgText(43)
        If Dir(App.path & TextPath & xlsFileName) <> MsgText(601) Then
             Kill App.path & TextPath & xlsFileName
        End If
        
        xlsAgentPoint.SheetsInNewWorkbook = 1 'Added by Lydia 2019/03/12 預設工作表數目
        xlsAgentPoint.Workbooks.add
        xlsAgentPoint.Application.WindowState = xlMinimized
        Set wksrpt = xlsAgentPoint.Worksheets(1)
        
        '設定欄位名稱及欄寬
        For i = LBound(stTmp) To UBound(stTmp)
            wksrpt.Range(Chr(i + 65) & intCounter).Value = stTmp(i)
            wksrpt.Columns(Chr(i + 65) & ":" & Chr(i + 65)).ColumnWidth = intWidth(i)
            wksrpt.Range(Chr(i + 65) & intCounter).HorizontalAlignment = xlCenter
        Next i
        intTitle = intCounter
        intCounter = intCounter + 1
        
        '資料
        Do While RsQ.EOF = False
            For i = LBound(stTmp) To UBound(stTmp)
                If i = 2 Then
                    stVal = "=IF(RIGHT(A" & intCounter & ",2)<>""00"",""關係企業"","""")"
                Else
                    stVal = "" & RsQ.Fields(i)
                End If
                wksrpt.Range(Chr(i + 65) & intCounter).Value = stVal
            Next i
            
            RsQ.MoveNext
            intCounter = intCounter + 1
        Loop
        If Val(xlsAgentPoint.Version) < 12 Then
           xlsAgentPoint.Workbooks(1).SaveAs FileName:=App.path & TextPath & xlsFileName, FileFormat:=-4143
        Else
           xlsAgentPoint.Workbooks(1).SaveAs FileName:=App.path & TextPath & xlsFileName, FileFormat:=56
        End If
        xlsAgentPoint.Workbooks.Close
        xlsAgentPoint.Quit
        'SendMAPIMail "A2004", Val(stDate) & "新建客戶明細", vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, App.path & TextPath & xlsFileName
        'Modify by Amy 2020/05/05 改文雄
        'SendMAPIMail "67002", Val(stDate) & "新建客戶明細", vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, App.path & TextPath & xlsFileName
        SendMAPIMail "A4023", Val(stDate) & "新建客戶明細", vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, App.path & TextPath & xlsFileName
    End If
    
    Set RsQ = Nothing
    Exit Sub
    
ErrHand:
    WLog Err.Description
    'Mark by Amy 2020/01/10 避免程式不能往下run 拿掉
'    If Val(xlsAgentPoint.Version) < 12 Then
'        xlsAgentPoint.Workbooks(1).SaveAs FileName:=strExcelPath & xlsFileName, FileFormat:=-4143
'    Else
'        xlsAgentPoint.Workbooks(1).SaveAs FileName:=strExcelPath & xlsFileName, FileFormat:=56
'    End If
'    xlsAgentPoint.Workbooks.Close
'    xlsAgentPoint.Quit
'    Set xlsAgentPoint = Nothing
'    Set RsQ = Nothing
End Sub

'Added by Morgan 2018/2/2
'專利處已齊備未會稿案件清單
Private Sub StrMenu90()
    Dim xlsAgentPoint As New Excel.Application
    Dim wksrpt As New Worksheet
    Dim RsQ As ADODB.Recordset
    Dim strQ As String, xlsFileName As String, xlsFileNames As String
    Dim i As Integer, intCounter As Integer
    Dim stDate As String, stVal As String, stSys As String
    Dim stTmp, intWidth
    
On Error GoTo ErrHand
      
    'Modified by Morgan 2018/9/10 "非 98012" 的條件改為承辦人非程序
    strQ = "select cp14||' '||s1.st02 承辦人" & _
      ",cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) 本所案號" & _
      ",sqldatet(ep06) 齊備日" & _
      ",WorkDayDiff(ep06-1,to_char(sysdate-1,'yyyymmdd')) 已過工作天數" & _
      ",pa05 案件名稱" & _
      ",decode(pa158,'1','機械','2','電子電機','3','化學生醫') 案件屬性" & _
      ",cp13||' '||s2.st02 智權人員,cp01" & _
      " from engineerprogress,caseprogress,staff s1,staff s2,patent" & _
      " Where ep06 > 20170000 And ep07 Is Null" & _
      " and cp09(+)=ep02 and cp04='00' and cp159=0 and cp09<'B'" & _
      " and cp01 in ('P','CFP') and cp10 in ('101','102')  and cp98>=1" & _
      " and substr(cp12,1,1)<>'F' and cp14<'F'" & _
      " and ((cp01='CFP' and WorkDayDiff(ep06-1,to_char(sysdate-1,'yyyymmdd'))>21)" & _
      " or (cp01='P' and WorkDayDiff(ep06-1,to_char(sysdate-1,'yyyymmdd'))>10))" & _
      " and s1.st01(+)=cp14 and s1.st03<>'P12' and s2.st01(+)=cp13 and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04" & _
      " order by cp01 desc,1 asc"
                  
    intI = 1
    Set RsQ = ClsLawReadRstMsg(intI, strQ)
    If intI = 1 Then
        stTmp = Array("承辦人", "本所案號", "齊備日", "已過工作天數", "案件名稱", "案件屬性", "智權人員")
        intWidth = Array(0, 0, 0, 0, 12, 0, 0)
        'Run Excel
        
        xlsFileName = App.path & TextPath & "已齊備未會稿" & RsQ("cp01") & "案" & strSrvDate(2) & ".xls"
        If Dir(xlsFileName) <> "" Then Kill xlsFileName
        xlsFileNames = xlsFileName
        stSys = RsQ("cp01")
        
        xlsAgentPoint.SheetsInNewWorkbook = 1 'Added by Lydia 2019/03/12 預設工作表數目
        xlsAgentPoint.Workbooks.add
        xlsAgentPoint.Application.WindowState = xlMinimized
        Set wksrpt = xlsAgentPoint.Worksheets(1)
        intCounter = 2
        '資料
        Do While RsQ.EOF = False
            If stSys <> RsQ("cp01") Then
               '設定欄位名稱及欄寬
               wksrpt.Rows("1:1").Select
               xlsAgentPoint.Selection.Font.Bold = True
               For i = LBound(stTmp) To UBound(stTmp)
                   wksrpt.Range(Chr(i + 65) & "1").Value = stTmp(i)
                   If intWidth(i) > 0 Then
                      wksrpt.Columns(Chr(i + 65) & ":" & Chr(i + 65)).ColumnWidth = intWidth(i)
                   Else
                      wksrpt.Columns(Chr(i + 65) & ":" & Chr(i + 65)).EntireColumn.AutoFit
                   End If
               Next i
               If Val(xlsAgentPoint.Version) < 12 Then
                  xlsAgentPoint.Workbooks(1).SaveAs FileName:=xlsFileName, FileFormat:=-4143
               Else
                  xlsAgentPoint.Workbooks(1).SaveAs FileName:=xlsFileName, FileFormat:=56
               End If
               xlsAgentPoint.Workbooks.Close
               
               xlsFileName = App.path & TextPath & "已齊備未會稿" & RsQ("cp01") & "案" & strSrvDate(2) & ".xls"
               If Dir(xlsFileName) <> "" Then Kill xlsFileName
               xlsFileNames = xlsFileNames & ";" & xlsFileName
               stSys = RsQ("cp01")
               xlsAgentPoint.SheetsInNewWorkbook = 1 'Added by Lydia 2019/03/12 預設工作表數目
               xlsAgentPoint.Workbooks.add
               Set wksrpt = xlsAgentPoint.Worksheets(1)
               intCounter = 2
            End If
            For i = LBound(stTmp) To UBound(stTmp)
               wksrpt.Range(Chr(i + 65) & intCounter).Value = "" & RsQ.Fields(i)
            Next i
            RsQ.MoveNext
            intCounter = intCounter + 1
        Loop
        
        '設定欄位名稱及欄寬
        wksrpt.Rows("1:1").Select
        xlsAgentPoint.Selection.Font.Bold = True
        For i = LBound(stTmp) To UBound(stTmp)
            wksrpt.Range(Chr(i + 65) & "1").Value = stTmp(i)
            If intWidth(i) > 0 Then
               wksrpt.Columns(Chr(i + 65) & ":" & Chr(i + 65)).ColumnWidth = intWidth(i)
            Else
               wksrpt.Columns(Chr(i + 65) & ":" & Chr(i + 65)).EntireColumn.AutoFit
            End If
        Next i
        
        If Val(xlsAgentPoint.Version) < 12 Then
           xlsAgentPoint.Workbooks(1).SaveAs FileName:=xlsFileName, FileFormat:=-4143
        Else
           xlsAgentPoint.Workbooks(1).SaveAs FileName:=xlsFileName, FileFormat:=56
        End If
        xlsAgentPoint.Workbooks.Close
        xlsAgentPoint.Quit
        SendMAPIMail "A4023", "已齊備未會稿案件清單" & strSrvDate(2), vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, xlsFileNames
    End If
    
    Set RsQ = Nothing
    Exit Sub
    
ErrHand:
    WLog Err.Description
    'Mark by Amy 2020/01/10 避免程式不能往下run 拿掉
'    If Val(xlsAgentPoint.Version) < 12 Then
'       xlsAgentPoint.Workbooks(1).SaveAs FileName:=xlsFileName, FileFormat:=-4143
'    Else
'       xlsAgentPoint.Workbooks(1).SaveAs FileName:=xlsFileName, FileFormat:=56
'    End If
'    xlsAgentPoint.Workbooks.Close
'    xlsAgentPoint.Quit
'    Set xlsAgentPoint = Nothing
'    Set RsQ = Nothing
End Sub

'Added by Lydia 2018/03/09 FCP中說進度發文批次刪除案號資料夾的.msg檔
Private Sub StrMenu91()
Dim intA As Integer
Dim rsAD As New ADODB.Recordset
Dim strList As String
Dim strToPath As String
Dim stFtpIP  As String
Dim strToDir As String
Dim f91 As Integer
Dim TFName As String
Dim intC As Integer
Dim strDate As String
Dim strMsg As String 'Added by Lydia 2020/03/23

On Error GoTo ErrHandler

   TFName = "FCP中說發文批次處理案號資料夾"
 
   '轉FTP
   stFtpIP = Pub_GetSpecMan("FTP_TYPING2")
   If stFtpIP = "" Then Exit Sub
   '要處理的發文日(前一工作天)
   strDate = CompWorkDay(2, strSrvDate(1), 1)
   
   '刪檔的部份僅針對3/5後收文之新案即可，之前的案件保留原本的形式。
   'Modified by Lydia 2018/05/10 增加FMP案,新案性質+125,110
   'strExc(0) = "select cp01,cp02,cp03,cp04,cp05,cp09,cp10,cp158 from caseprogress " & _
                     "where cp01='FCP' and cp05>=20180305 and cp158=" & strDate & " and cp159=0 and cp10 in (201,209,210,235) " & _
                     "and exists (select * from caseprogress where cp01='FCP' and cp10 in (101,102,103) and cp05>=20180305) " & _
                     "order by cp05,cp09 "
   strExc(0) = "select cp01,cp02,cp03,cp04,cp05,cp09,cp10,cp158 from caseprogress " & _
                     "where (cp01='P' or cp01='FCP') and cp05>=20180305 and cp158=" & strDate & " and cp159=0 and cp10 in (201,209,210,235) " & _
                     "and exists (select * from caseprogress where (cp01='P' or cp01='FCP') and cp10 in (101,102,103,110,125) and substr(cp12,1,1)='F' and  cp05>=20180305) " & _
                     "order by cp05,cp09 "
    intA = 1
    Set rsAD = ClsLawReadRstMsg(intA, strExc(0))
    If intA = 1 Then
         With rsAD
               cnnConnection.BeginTrans 'Added by Lydia 2018/09/21
              .MoveFirst
              'Remove by Lydia 2018/04/20 不用觀察了
              'f91 = FreeFile
              'Open App.path & TextPath & "\" & TFName & ".txt" For Output As f91
             ' Print #f91, Space(40) & strSrvDate(2) & "_" & TFName
              'Print #f91, ""
              'Print #f91, convForm("本所案號", 15) & " " & "處理記錄"
              'Print #f91, String(15, "=") & " " & String(124, "=")
              'end 2018/04/20
              Do While Not .EOF
                   'Added by Lydia 2018/09/21 刪除認翻譯人員檔
                   strSql = "delete from transfeeassign where tfa01='" & .Fields("cp09") & "' "
                   cnnConnection.Execute strSql
                   'end 2018/09/21
                   strList = ""
                   'Modified by Lydia 2018/05/10 +系統別
                   'Remove by Lydia 2021/12/06 (109/4/6)已將\\Typing2的"English_Vers"和"專利案件"的案件資料夾，全部搬到原始檔區
                   'strExc(1) = Replace(Pub_GetFCPcaseFilePath("" & .Fields("cp02"), , "" & .Fields("cp01")), "\", "/")
                   'strToDir = "//" & Mid(strExc(1), InStr(3, strExc(1), "/") + 1)
                   'If PUB_ChkFtpDirectory(stFtpIP, strToDir, "D", ".msg", strList) Then
                   '     'Modified by Lydia 2018/05/10 +系統別
                   '     strList = Pub_GetFCPcaseFilePath("" & .Fields("cp02"), , "" & .Fields("cp01")) & "資料夾存在，刪除：" & strList
                   'Else
                   '     'Modified by Lydia 2018/05/10 +系統別
                   '     strList = Pub_GetFCPcaseFilePath("" & .Fields("cp02"), , "" & .Fields("cp01")) & "資料夾不存在"
                   'End If
                   'end 2021/12/06
                   'Remove by Lydia 2018/04/20 不用觀察了
                   'Print #f91, convForm("" & .Fields("cp01") & "-" & .Fields("cp02") & "-" & .Fields("cp03") & "-" & .Fields("cp04"), 15) & " " & Replace(strList, "&", " ；")
                      
                   'Added by Lydia 2020/03/23 刪除原始檔區的English_vers之Msg檔
                   strExc(1) = "SELECT CP01||'-'||CP02||'-'||CP03||'-'||CP04 AS CASENO,CPF01,CPF02 FROM CASEPROGRESS,CASEPAPERFILE " & _
                                    "WHERE CP01='" & .Fields("CP01") & "' AND CP02='" & .Fields("CP02") & "'  AND CP03='" & .Fields("CP03") & "' AND CP04='" & .Fields("CP04") & "' " & _
                                    "AND SUBSTR(CP09,1,1)='D' AND CP10='" & cntEnglish_Vers & "' AND CP09=CPF01(+) AND UPPER(CPF02) LIKE '%.MSG'"
                   intI = 1
                   Set RsTemp = ClsLawReadRstMsg(intI, strExc(1))
                   If intI = 1 Then
                       RsTemp.MoveFirst
                       Do While Not RsTemp.EOF
                             If "" & RsTemp.Fields("CPF01") <> "" And "" & RsTemp.Fields("CPF02") <> "" Then
                                strMsg = "N"
                                If DelAttFile_File("" & RsTemp.Fields("CaseNo"), RsTemp.Fields("CPF01"), RsTemp.Fields("CPF02"), , True, strMsg) = False Then
                                   GoTo ErrHandler
                                End If
                                strMsg = ""
                             End If
                             RsTemp.MoveNext
                       Loop
                   End If
                   'end 2020/03/23
                   
                   'Added by Lydia 2018/11/19 刪除相似比對結果(.RES.)和翻譯用參考本(.SEP.) =>本所案號.xxxx
                   'Modified by Lydia 2024/12/31 改資料夾
                   'strToDir = "//FCP_workflow/SIMILAR_RESULT"
                   If strToDir = "" Then
                       strToDir = Mid(Replace(Pub_GetSpecMan("FCP相似比對結果暫存"), "\", "/"), 3)
                       strToDir = "//" & Mid(strToDir, InStr(strToDir, "/") + 1)
                   End If
                   'end 2024/12/31
                   If PUB_ChkFtpDirectory(stFtpIP, strToDir, "D", .Fields("cp01") & .Fields("cp02") & ".", strList) Then
                   End If
                   If PUB_ChkFtpDirectory(stFtpIP, strToDir, "D", .Fields("cp01") & Val("" & .Fields("cp02")) & ".", strList) Then
                   End If
                   'end 2018/11/19
                   intC = intC + 1
                   .MoveNext
              Loop
              cnnConnection.CommitTrans 'Added by Lydia 2018/09/21
         End With
         'Remove by Lydia 2018/04/20 不用觀察了
         'Print #f91, String(140, "=")
         'Print #f91, "共" & intC & "筆"
    End If
    'Remove by Lydia 2018/04/20 不用觀察了
    'If f91 > 0 Then
    '    Close f91
    '    SendMAPIMail "A3034", strSrvDate(2) & "_" & TFName, vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, App.path & TextPath & "\" & TFName & ".txt"
    'End If

    Set rsAD = Nothing
    Exit Sub
    
ErrHandler:
    'Modified by Lydia 2020/03/23
    'If Err.Number <> 0 Then
    If Err.Number <> 0 Or (strMsg <> "" And strMsg <> "N") Then
      Set rsAD = Nothing
      'Modified by Lydia 2020/03/23
      'WLog "FCP中說進度發文批次刪除案號資料夾的.msg檔:" & Err.Description
      WLog "FCP中說進度發文批次刪除案號資料夾的.msg檔:" & Err.Description & IIf(strMsg <> "", vbCrLf, "") & strMsg
      cnnConnection.RollbackTrans 'Added by Lydia 2018/09/21
    End If
End Sub

'Added by Morgan 2018/4/17 內專待審核帳單檢查
Private Function CreateFile20() As Boolean
   Dim stSQL As String, stSubject As String
   
On Error GoTo ErrHandle
   
   stSQL = "select a1501" & _
      " from acc150,staff,acc151" & _
      " where a1507||a1512 is null and a1502>920000 and length(a1501)=9" & _
      " and nvl(a1520,0)=0 and a1521<>'Y'" & _
      " and st01(+)=a1516 and substr(st15,1,1)<>'F' and axf01(+)=a1501" & _
      " and exists(select * from caseprogress where cp09=axf02 and cp01 in ('P','PS'))"
   If Rs.State <> adStateClosed Then Rs.Close
   With Rs
   .CursorLocation = adUseClient
   .Open stSQL, cnnConnection, adOpenForwardOnly, adLockReadOnly
   If .RecordCount > 0 Then
      stSubject = "您目前有 " & .RecordCount & " 筆內專帳單待審核！"
      SendMAPIMail "79075", stSubject, "如旨"
   End If
   End With
   
   'Add By Sindy 2021/1/21
   stSQL = "select a1501" & _
      " from acc150,staff,acc151" & _
      " where a1507||a1512 is null and a1502>920000 and length(a1501)=9" & _
      " and nvl(a1520,0)=0 and a1521<>'Y'" & _
      " and st01(+)=a1516 and substr(st15,1,1)<>'F' and axf01(+)=a1501" & _
      " and exists(select * from caseprogress where cp09=axf02 and substr(cp01,1,1)='T')"
   If Rs.State <> adStateClosed Then Rs.Close
   With Rs
   .CursorLocation = adUseClient
   .Open stSQL, cnnConnection, adOpenForwardOnly, adLockReadOnly
   If .RecordCount > 0 Then
      stSubject = "您目前有 " & .RecordCount & " 筆內商帳單待審核！"
      'Added by Morgan 2021/11/11
      '林經理2021/11/15退休以後改發林承慧 86048
      If strSrvDate(1) >= "20211115" Then
         SendMAPIMail "86048", stSubject, "如旨"
      Else
         SendMAPIMail "69008", stSubject, "如旨" '通知林純貞經理
      End If
   End If
   End With
   '2021/1/21 END
   
   CreateFile20 = True
   Exit Function
   
ErrHandle:
   WLog Err.Description

End Function
'Added by Morgan 2020/8/18
'CFP年費已提申無收據管制報表
Private Function CreateFile21(ByVal p_RptDate As String, Optional ByRef p_FileName As String, Optional p_PS As String) As Boolean
   Dim stSQL As String
   Dim ff As Integer
   Dim strContent As String
   Dim tmpnext As String
   Dim stCon As String, stRptFileName As String
   Dim stPID As String
   Dim lngRecs As Long
   Dim stFileName As String
   Dim stVTB As String
   Dim strTitle As String    '欄位抬頭名稱
   Dim strTitleLine As String '欄位抬頭底線
   Dim stCFPMailList As String, strText As String, strPIDName As String, strHeadPS As String
   Dim rsQuery As ADODB.Recordset
   Dim mSeqNo As String 'Added by Lydia 2021/07/09
   
   p_FileName = ""
   lngRecs = 0
   stCon = ""
   
   
On Error GoTo ErrHandle
      
   stRptFileName = "CFP年費已提申無收據管制表"
   strHeadPS = "提醒時間點：年費提申日+1個月(第一次)，第一次提醒後該案每一週提醒1次，年費提申日+3個月開始每天提醒。"
   stVTB = "SELECT * FROM CASEPROGRESS" & _
      " WHERE cp01='CFP' and cp10 in ('605','606','607') and cp47>0 and cp145 is null" & _
      " and to_date(" & strSrvDate(1) & ",'yyyymmdd')>add_months(to_date(cp47,'yyyymmdd'),1)" & _
      " and (add_months(to_date(cp47,'yyyymmdd'),1)=TO_DATE(" & strSrvDate(1) & ",'yyyymmdd')" & _
      " or mod(to_date(" & strSrvDate(1) & ",'yyyymmdd')-add_months(to_date(cp47,'yyyymmdd'),1),7)=0" & _
      " or to_date(" & strSrvDate(1) & ",'yyyymmdd')>=add_months(to_date(cp47,'yyyymmdd'),3))"
  
   stSQL = "SELECT ST02 C01" & _
      ",CP47-19110000 C02, CP27-19110000 C03, CP09 C04,CP01||'-'||CP02||'-'||CP03||'-'||CP04 C05" & _
      ",NVL(PA05,NVL(PA06,PA07)) C06,PTM03 C07,NA03 C08" & _
      ",DECODE(PA09,'000',CPM03,CPM04) C09" & _
      ",CP44||' '||NVL(F1.FA04,DECODE(F1.FA05,NULL,F1.FA06,F1.FA05||' '||F1.FA63||' '||F1.FA64||' '||F1.FA65)) C10" & _
      ",'' PID,CP44" & _
      " FROM (" & stVTB & ") X,PATENT,STAFF,SYSTEMKIND,CASEPROPERTYMAP,NATION,FAGENT F1,PATENTTRADEMARKMAP" & _
      " WHERE PA01(+)=CP01 AND PA02(+)=CP02 AND PA03(+)=CP03 AND PA04(+)=CP04" & _
      " AND ST01(+)=CP14 AND SK01(+)=CP01 AND NA01(+)=PA09" & _
      " AND CPM01(+)=CP01 AND CPM02(+)=CP10" & _
      " AND PTM01(+)='1' AND PTM02(+)=PA08" & _
      " AND F1.FA01(+)=SUBSTR(CP44,1,8) AND F1.FA02(+)=SUBSTR(CP44,9,1)"
      
   stSQL = stSQL & " ORDER BY PID,1,2,3,4"
   intI = 1
   Set Rs = ClsLawReadRstMsg(intI, stSQL)
   If intI = 1 Then
      'Modified by Lydia 2021/07/09 取得序號mSeqNo
      Set rsQuery = PUB_CreateRecordset(Rs, , , 300, Me.Name, mSeqNo)
      With rsQuery
      .MoveFirst
      Do While Not .EOF
         .Fields("PID") = PUB_GetCFPHandler(.Fields("C05"))
         .MoveNext
      Loop
      .UpdateBatch 'Added by Lydia 2021/07/09
      '.Sort = "PID,CP44,C01,C02,C03,C04"  'Remove by Lydia 2021/07/09
      End With
      'Added by Lydia 2021/07/09 重新查詢; 因為出現錯誤「無法在其定義長度是不明或過長的資料行執行 Relate、Compute By、及 Sort 操作。」
      strSql = "Select R001 As C01,R002 As C02, R003 As C03, R004 As C04,R005 As C05,R006 As C06, R007 As C07, R008 As C08, R009 As C09," & _
                  "R010 As C10, R011 As PID, R012 As CP44 " & _
                  "From Rdatafactory Where Id='" & strUserNum & "' And Formname='" & Me.Name & "'  And Seqno='" & mSeqNo & "' " & _
                  "ORDER BY PID,CP44,C01,C02,C03,C04 "
      intI = 1
      Set rsQuery = ClsLawReadRstMsg(intI, strSql)
      'end 2021/07/09
   Else
      Set rsQuery = Rs
   End If
   
   With rsQuery
      If .RecordCount > 0 Then
         .MoveFirst
         stPID = "" & .Fields("pid")
         strPIDName = GetPIDName(stPID)
         If ff > 0 Then Close #ff
         ff = FreeFile
         
         stFileName = App.path & TextPath & stRptFileName & "(" & strPIDName & ").txt"
             strTitle = "承辦人 提申日    發文日    收文號    本所案號        案件名稱                 種類   申請國家 案件性質   代理人              "
         strTitleLine = "------ --------- --------- --------- --------------- ------------------------ ------ -------- ---------- --------------------"
         
         Open stFileName For Output As ff
         
         Print #ff, Space(35) & stRptFileName & "(" & strPIDName & ")"
         Print #ff, "日期：" & p_RptDate & "          " & strHeadPS
         Print #ff, ""
         Print #ff, strTitle
         Print #ff, strTitleLine
         
         tmpnext = "開檔中..."
         
         .MoveFirst
         Do While Not .EOF
            If stPID <> "" & .Fields("pid") Then
               Print #ff, strTitleLine
               Print #ff, "共" & lngRecs & "筆"
               Close ff
               p_FileName = p_FileName & stFileName & ";"
               
               strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & _
                  stRptFileName & "(" & p_RptDate & ")(" & strPIDName & ") 資料如附件！" & _
                  vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & p_PS
               SendMAPIMail stPID, stRptFileName & "(" & p_RptDate & ")(" & strPIDName & ")", strText, stFileName
               stCFPMailList = stCFPMailList & stPID & ";"
               
               lngRecs = 0
               stPID = "" & .Fields("pid")
               strPIDName = GetPIDName(stPID)
               If ff > 0 Then Close #ff
               ff = FreeFile
               stFileName = App.path & TextPath & stRptFileName & "(" & strPIDName & ").txt"
               
               Open stFileName For Output As ff
               Print #ff, Space(35) & stRptFileName & "(" & strPIDName & ")"
               Print #ff, ""
               Print #ff, "日期：" & p_RptDate & "          " & strHeadPS
               Print #ff, ""
               Print #ff, strTitle
               Print #ff, strTitleLine
            End If
            lngRecs = lngRecs + 1
            strContent = Empty
            
            strContent = strContent & convForm("" & .Fields("C01"), 6) '承辦人
            strContent = strContent & " " & Format(.Fields("C02"), "@@@/@@/@@") '提申日
            strContent = strContent & " " & Format(.Fields("C03"), "@@@/@@/@@") '發文日
            strContent = strContent & " " & convForm(.Fields("C04"), 9) '收文號
            strContent = strContent & " " & convForm(.Fields("C05"), 15) '本所案號
            strContent = strContent & " " & convForm(.Fields("C06"), 24) '案件名稱
            strContent = strContent & " " & convForm(.Fields("C07"), 6) '種類
            strContent = strContent & " " & convForm(.Fields("C08"), 8) '申請國家
            strContent = strContent & " " & convForm(.Fields("C09"), 10) '案件性質
            strContent = strContent & " " & convForm(.Fields("C10"), 20) '代理人
            
            tmpnext = "寫檔..."
            Print #ff, strContent
            
            .MoveNext
         Loop
         Print #ff, strTitleLine
         Print #ff, "共" & lngRecs & "筆"
         Close ff
         p_FileName = p_FileName & stFileName

         strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & _
            stRptFileName & "(" & p_RptDate & ")(" & strPIDName & ") 資料如附件！" & _
            vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & p_PS
         SendMAPIMail stPID, stRptFileName & "(" & p_RptDate & ")(" & strPIDName & ")", strText, stFileName
         stCFPMailList = stCFPMailList & stPID & ";"
      End If
   End With
   
   'CFP程序管制人A0916
   stSQL = "select distinct a0916 from acc090 order by 1"
   If Rs.State <> adStateClosed Then Rs.Close
   With Rs
   .CursorLocation = adUseClient
   .Open stSQL, cnnConnection, adOpenForwardOnly, adLockReadOnly
   If .RecordCount > 0 Then
      Do While Not .EOF
         If Not IsNull(.Fields(0)) Then
            stPID = .Fields(0)
            If InStr(stCFPMailList, stPID) = 0 Then
               strPIDName = GetPIDName(stPID)
               strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & _
                  stRptFileName & "(" & p_RptDate & ")(" & strPIDName & ") 無需管制資料！" & _
                  vbCrLf & vbCrLf & String(25, "　") & "電腦中心"
               SendMAPIMail stPID, stRptFileName & "(" & p_RptDate & ")(" & strPIDName & ")", strText
            End If
         End If
         .MoveNext
      Loop
   End If
   End With
   
   CreateFile21 = True
   Set rsQuery = Nothing
   Exit Function
   
ErrHandle:
   WLog tmpnext & " " & Err.Description
   Set rsQuery = Nothing
   
End Function

'Added by Morgan 2024/6/26
'卷宗區無客戶函清單
Private Function CreateFile22(ByVal p_RptDate As String, Optional ByRef p_FileName As String, Optional p_PS As String) As Boolean
   Dim stSQL As String
   Dim ff As Integer
   Dim strContent As String, strText As String
   Dim tmpnext As String
   Dim stRptFileName As String
   Dim stPID As String
   Dim lngRecs As Long
   Dim stFileName As String
   Dim strTitle As String    '欄位抬頭名稱
   Dim strTitleLine As String '欄位抬頭底線
   Dim rsQuery As ADODB.Recordset
   
   p_FileName = ""
   lngRecs = 0
   
On Error GoTo ErrHandle
      
   stRptFileName = "卷宗區無客戶函清單"
   'Modified by Morgan 2024/7/31 因轉檔程式有時會卡住，增加判斷判發日<系統日-1天的條件
   'Modified by Morgan 2024/8/5 案件名稱可能沒有中文 ex:TD-000145
   'Modified by Morgan 2024/9/16 排除外商收文的案件--桂英 Ex:TD-000146
   stSQL = "select s1.st02 發文人員,sqldatet(cp27) 發文日,cp09 收文號,cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) 本所案號" & _
      ",nvl(nvl(pa05,pa06),nvl(tm05,nvl(sp05,sp06))) 案件名稱,na03 申請國家,decode(pa09||tm10||sp09,'020',cpm04,cpm03) 案件性質,a0902||' '||s2.st02 智權人員,cp83 pid" & _
      " from letterprogress c,caseprogress,staff s1,staff s2,patent,trademark,ServicePractice,casepropertymap,acc090,nation" & _
      " where lp10='Y' and lp05>0 and lp05<to_char(sysdate-1,'yyyymmdd') and lp07=0 and cp09(+)=lp01 and cp27>19221111 and substr(cp12,1,2)<>'F1'" & _
      " and not exists(select * from casepaperpdf where  cpp01=lp01 and substr(lower(cpp02),-8)='.cus.pdf')" & _
      " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04" & _
      " and tm01(+)=cp01 and tm02(+)=cp02 and tm03(+)=cp03 and tm04(+)=cp04" & _
      " and sp01(+)=cp01 and sp02(+)=cp02 and sp03(+)=cp03 and sp04(+)=cp04" & _
      " and s1.st01(+)=cp83 and s2.st01(+)=lp06 and cpm01(+)=cp01 and cpm02(+)=cp10" & _
      " and a0901(+)=s2.st15 and na01(+)=pa09||tm10||sp09" & _
      " order by pid,2,3"
   intI = 1
   Set rsQuery = ClsLawReadRstMsg(intI, stSQL)
   If intI = 1 Then
      With rsQuery
         stPID = "" & .Fields("pid")
         If ff > 0 Then Close #ff
         ff = FreeFile
         
         stFileName = App.path & TextPath & stRptFileName & "(" & stPID & ").txt"
             strTitle = "發文人員 發文日    收文號    本所案號        案件名稱                 申請國家 案件性質   智權人員            "
         strTitleLine = "-------- --------- --------- --------------- ------------------------ -------- ---------- --------------------"
         
         Open stFileName For Output As ff
         
         Print #ff, Space(35) & stRptFileName & "(" & stPID & ")"
         Print #ff, "日期：" & p_RptDate
         Print #ff, ""
         Print #ff, strTitle
         Print #ff, strTitleLine
         
         tmpnext = "開檔中..."
         
         .MoveFirst
         Do While Not .EOF
            If stPID <> "" & .Fields("pid") Then
               Print #ff, strTitleLine
               Print #ff, "共" & lngRecs & "筆"
               Close ff
               p_FileName = p_FileName & stFileName & ";"
               
               strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & _
                  stRptFileName & "(" & stPID & ") 資料如附件！" & _
                  vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & p_PS
               SendMAPIMail stPID, stRptFileName & "(" & stPID & ")", strText, stFileName
                              
               lngRecs = 0
               stPID = "" & .Fields("pid")
               If ff > 0 Then Close #ff
               ff = FreeFile
               stFileName = App.path & TextPath & stRptFileName & "(" & stPID & ").txt"
               
               Open stFileName For Output As ff
               Print #ff, Space(35) & stRptFileName & "(" & stPID & ")"
               Print #ff, ""
               Print #ff, "日期：" & p_RptDate
               Print #ff, ""
               Print #ff, strTitle
               Print #ff, strTitleLine
            End If
            lngRecs = lngRecs + 1
            strContent = Empty
            
            strContent = strContent & convForm("" & .Fields("發文人員"), 8)
            strContent = strContent & " " & convForm("" & .Fields("發文日"), 9)
            strContent = strContent & " " & convForm(.Fields("收文號"), 9)
            strContent = strContent & " " & convForm(.Fields("本所案號"), 15)
            strContent = strContent & " " & convForm("" & .Fields("案件名稱"), 24)
            strContent = strContent & " " & convForm(.Fields("申請國家"), 8)
            strContent = strContent & " " & convForm(.Fields("案件性質"), 10)
            strContent = strContent & " " & convForm(.Fields("智權人員"), 20)
            
            tmpnext = "寫檔..."
            Print #ff, strContent
            
            .MoveNext
         Loop
         Print #ff, strTitleLine
         Print #ff, "共" & lngRecs & "筆"
         Close ff
         p_FileName = p_FileName & stFileName

         strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & _
            stRptFileName & "(" & stPID & ") 資料如附件！" & _
            vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & p_PS
         SendMAPIMail stPID, stRptFileName & "(" & stPID & ")", strText, stFileName
      End With
   End If
   
   
   
   CreateFile22 = True
   Set rsQuery = Nothing
   Exit Function
   
ErrHandle:
   WLog tmpnext & " " & Err.Description
   Set rsQuery = Nothing
   
End Function

'Added by Morgan 2025/11/18
'CFP外翻給案已達完稿期限尚未完稿通知
Private Function StrMenu144() As Boolean
   Dim stSQL As String, intQ As Integer
   Dim ff As Integer
   Dim strContent As String, strText As String
   Dim tmpnext As String
   Dim stRptFileName As String
   Dim stPID As String
   Dim lngRecs As Long
   Dim stFileName As String
   Dim strTitle As String    '欄位抬頭名稱
   Dim strTitleLine As String '欄位抬頭底線
   Dim rsQuery As ADODB.Recordset
   Dim stSubj As String
   
   stFileName = ""
   lngRecs = 0
   
On Error GoTo ErrHandle
   
   stPID = Pub_GetSpecMan("H")
   stRptFileName = "CFP外翻給案已達完稿期限"
   
   stSQL = "SELECT CP01||'-'||CP02||DECODE(CP03||CP04,'000','',CP03||CP04) 本所案號, NVL(CPM03,CP10) 案件性質, CP14||' '||S1.ST02 外翻人員, SQLDATET(CP157) 給案日" & _
      ",SQLDATET(TF26) 完稿期限, SQLDATET(CP06) 本所期限, SQLDATET(TF32) 收達日, TF36 備註" & _
      " FROM CASEPROGRESS,PATENT, ENGINEERPROGRESS, CASEPROPERTYMAP, STAFF S1,TRANSFEE" & _
      " WHERE cp01='CFP' and cp12 not like 'F%' and cp14 like 'F%' and cp10 in (" & CaseMapOut & ",927) and cp158=0 and cp159=0" & _
      " AND EP02(+)=CP09 and ep09 is null AND TF01(+)=CP09 and tf26<=" & strSrvDate(1) & _
      " AND PA01(+)=CP01 AND PA02(+)=CP02 AND PA03(+)=CP03 AND PA04(+)=CP04 and pa09 in ('011','231')" & _
      " AND CPM01(+)=CP01 AND CPM02(+)=CP10 AND S1.ST01(+)=CP14" & _
      " ORDER By TF26, 1"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      With rsQuery
         If ff > 0 Then Close #ff
         ff = FreeFile
         
         stFileName = App.path & TextPath & stRptFileName & ".txt"
             strTitle = "本所案號        案件性質   外翻人員     給案日    完稿期限  本所期限  收達日    備註"
         strTitleLine = "--------------- ---------- ------------ --------- --------- --------- --------- --------------------"
         
         Open stFileName For Output As ff
         
         Print #ff, Space(35) & stRptFileName
         Print #ff, "日期：" & Format(strSrvDate(2), "@@@/@@/@@")
         Print #ff, ""
         Print #ff, strTitle
         Print #ff, strTitleLine
         
         tmpnext = "開檔中..."
         
         .MoveFirst
         If .RecordCount = 1 Then
            stSubj = .Fields("本所案號") & "尚未完稿，請提醒外翻人員！"
         Else
            stSubj = stRptFileName
         End If
         Do While Not .EOF
            lngRecs = lngRecs + 1
            strContent = Empty
            strContent = strContent & convForm(.Fields("本所案號"), 15)
            strContent = strContent & " " & convForm(.Fields("案件性質"), 10)
            strContent = strContent & " " & convForm(.Fields("外翻人員"), 12)
            strContent = strContent & " " & convForm("" & .Fields("給案日"), 9)
            strContent = strContent & " " & convForm(.Fields("完稿期限"), 9)
            strContent = strContent & " " & convForm("" & .Fields("本所期限"), 9)
            strContent = strContent & " " & convForm("" & .Fields("收達日"), 9)
            strContent = strContent & " " & .Fields("備註")
            
            tmpnext = "寫檔..."
            Print #ff, strContent
            
            .MoveNext
         Loop
         Print #ff, strTitleLine
         Print #ff, "共" & lngRecs & "筆"
         Close ff

         strText = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & _
            stRptFileName & " 資料如附件！" & _
            vbCrLf & vbCrLf & String(25, "　") & "電腦中心" & m_stRptPS
         SendMAPIMail stPID, stSubj, strText, stFileName
      End With
   End If
   
   StrMenu144 = True
   Set rsQuery = Nothing
   Exit Function
   
ErrHandle:
   WLog tmpnext & " " & Err.Description
   Set rsQuery = Nothing
   
End Function

'Added by Lydia 2018/05/16 國外部新增客戶及代理人清單
'Memo by Lydia 2020/02/15 更名「國外部新增客戶及代理人清單」=>「新增客戶及代理人清單」
'Modify by Amy 2025/11/18 +bolYear '產生前一年資料
Sub StrMenu92(ByVal bolYear As Boolean)
On Error GoTo DebugErr
Dim f92 As Integer
Dim rsAD As ADODB.Recordset
Dim i As Integer
'Modified by Lydia 2018/05/24
'Dim strTemp(0 To 7) As String
'Modified by Lydia 2020/10/27
'Dim strTemp(0 To 8) As String
'Modified by Lydia 2023/01/10
'Dim strTemp(0 To 10) As String
Dim strTemp(0 To 13) As String 'Modify by Amy 2025/11/15 原:strTemp(0 To 11)
Dim iCount As Integer
Dim TempFileName As String
'Modified by Lydia 2018/06/11  改成excel
'Dim strTitle As String
'Dim strTitleLine As String
Dim strTitle As Variant, strTitleL As Variant, strTitleW As Variant
'end 2018/06/11
Dim stDate1 As String
Dim tmpArr As Variant 'Added by Lydia 2018/05/24
'Added by Lydia 2018/06/11 改成excel
Dim xRows As Integer '目前列位置
Dim xlsPoint As New Excel.Application
Dim wksA92 As New Worksheet
Dim inJ As Integer
Dim strPath As String
Dim strSpec As String 'Added by Lydia 2021/10/20 是否另外設定顏色
Dim stDate2 As String, strSourceNo As String, strSourceName As String, strMemo As String, strXYS01 As String 'Add by Amy 2025/11/18

On Error GoTo DebugErr
    
    'Modified by Lydia 2020/02/15 更名「國外部新增客戶及代理人清單」=>「新增客戶及代理人清單」
    'Modify by Amy 2025/11/18 +if 年初產生前一年所有資料
    If bolYear = True Then
      TempFileName = "新增客戶及代理人年度清單"
    Else
      TempFileName = "新增客戶及代理人清單"
    End If
    strPath = App.path & TextPath & TempFileName & ".xls"
    If Dir(strPath) <> "" Then
       Kill strPath
    End If
    
    'Modified by Lydia 2018/05/24 +新增部門
'       strTitle = "新增編號  新增日期  國籍     英文名稱                       中文名稱                       原R編號   開發日期  開發人員"
'strTitleLine = "========= ========= ======== ============================== ============================== ========= ========= ==================="
'Modified by Lydia 2018/06/11 改成excel
'       strTitle = "新增編號  新增日期  建立部門       國籍     英文名稱                       中文名稱                       原R編號   開發日期  開發人員"
'strTitleLine = "========= ========= ============== ======== ============================== ============================== ========= ========= ==================="
'end 2018/05/24
'Modified by Lydia 2020/10/28 新增欄位「備註/客源/性質」寬度13；「狀態」、欄位寬度10
'Modified by Lydia 2023/01/10 新增欄位L「來所原因」寬度15
'Modify by Amy 2025/11/18 備註/客源/性質 改為「客源/性質」;增加「來所原因其他說明」「R編號備註」
'strTitle = Split("新增編號,新增日期,建立部門,國籍,英文名稱,中文名稱,狀態,原R編號,開發日期,開發人員,備註/客源/性質,來所原因", ",")
strTitle = Split("新增編號,新增日期,建立部門,國籍,英文名稱,中文名稱,狀態,原R編號,開發日期,開發人員,客源/性質,來所原因,來所原因" & vbCrLf & "其他說明,R編號備註", ",")
strTitleL = Split("A,B,C,D,E,F,G,H,I,J,K,L,M,N", ",")
strTitleW = Split("10,9.5,9.5,9.5,28,28,10,9.5,9.5,9.5,13,15,13,13", ",")
'end 2025/11/18
'end 2018/06/11
   'Modify by Amy 2025/11/18 +if 年初產生前一年所有資料
   If bolYear = True Then
      stDate1 = Val(Mid(strSrvDate(1), 1, 4)) - 1 & "0101"
      stDate2 = Val(Mid(strSrvDate(1), 1, 4)) - 1 & "1231"
   Else
      stDate1 = CompWorkDay(2, strSrvDate(1), 1)
      stDate2 = strSrvDate(1)
   End If
   
   '客戶檔
   'Modified by Lydia 2018/05/24 +cu12
   'Modified by Lydia 2020/02/15 'F' as atype,
   'Modified by Lydia 2020/10/28 +來源,狀態cu80
   'strSql = "select 'F' as atype, cu01||cu02 as cno,cu82 as cdate,na01,na03,cu05||' '||cu88||' '||cu89||' '||cu90 as ename," & _
                "cu04 As cname, cu79 As cmemo, cu129 As ano, cu14 As adate, cu12 as cdept " & _
                "from customer b1,nation,staff where cu13=st01(+) and cu10=na01(+) and substr(cu12,1,1)='F' and cu02='0' and cu82>=" & stDate1 & " and cu82<" & strSrvDate(1) & _
                " and not exists (select * from customer b2 where b1.cu01=b2.cu01(+) and b2.cu02<>'0') "
   'Modified by Lydia 2023/01/10 + 來所原因' ' as sno,' ' as smemo
   'Modify by Amy 2025/11/18 strSrvDate(1) 改 stDate2
   strSql = "select 'F' as atype, cu01||cu02 as cno,cu82 as cdate,na01,na03,cu05||' '||cu88||' '||cu89||' '||cu90 as ename," & _
                "cu04 As cname, cu79 As cmemo, cu129 As ano, cu14 As adate, cu12 as cdept,csm02 as Remark, cu80 as ctype,' ' as sno,' ' as smemo " & _
                "from customer b1,nation,staff,casesourcemap where cu13=st01(+) and cu10=na01(+) and substr(cu12,1,1)='F' and cu02='0' and cu82>=" & stDate1 & " and cu82<" & stDate2 & _
                " and not exists (select * from customer b2 where b1.cu01=b2.cu01(+) and b2.cu02<>'0') and cu09=csm01(+) "
   '代理人檔
   'Modified by Lydia 2018/05/24 + st03
   'Modified by Lydia 2020/02/15 + 'F' as atype
   'Modified by Lydia 2020/10/28 + 性質 => decode(FA76,'A','律師事務所','B','公司直接委辦','C','其他',FA76) as Remark,  fa69 as ctype
   'Modified by Lydia 2023/01/10 + 來所原因
   'strSql = strSql & " Union All select 'F' as atype, fa01||fa02 as cno,fa47 as cdate,na01,na03,fa05||' '||fa63||' '||fa64||' '||fa65 as ename," & _
                "fa04 As cname, fa29 As cmemo, fa94 As ano, fa11 As adate, st03 as cdept, decode(FA76,'A','律師事務所','B','公司直接委辦','C','其他',FA76) as Remark, fa69 as ctype " & _
                "from fagent b1,nation,staff where fa46=st01(+) and fa10=na01(+) and substr(st03,1,1)='F' and fa02='0' and fa47>=" & stDate1 & " and fa47<" & strSrvDate(1) & _
                " and not exists (select * from fagent b2 where b1.fa01=b2.fa01(+) and b2.fa02<>'0') "
   'Modify by Amy 2025/11/18 strSrvDate(1) 改 stDate2
   strSql = strSql & " Union All select 'F' as atype, fa01||fa02 as cno,fa47 as cdate,na01,na03,fa05||' '||fa63||' '||fa64||' '||fa65 as ename," & _
                "fa04 As cname, fa29 As cmemo, fa94 As ano, fa11 As adate, st03 as cdept, decode(FA76,'A','律師事務所','B','公司直接委辦','C','其他',FA76) as Remark, fa69 as ctype,ac02 as sno ,ac03 as smemo " & _
                "from fagent b1,nation,staff,allcode where fa46=st01(+) and fa10=na01(+) and substr(st03,1,1)='F' and fa02='0' and fa47>=" & stDate1 & " and fa47<" & stDate2 & _
                " and not exists (select * from fagent b2 where b1.fa01=b2.fa01(+) and b2.fa02<>'0') and fa127=ac02(+) and '13'=ac01(+) "
   '潛在客戶檔
   'Modified by Lydia 2018/05/24 +cdept
   'Modified by Lydia 2020/02/15 'F' as atype,
   'Modified by Lydia 2020/10/28 + '' as Remark, pcu39 as ctype
   'Modified by Lydia 2023/01/10 + 來所原因' ' as sno,' ' as smemo
   'Modify by Amy 2025/11/18 來所原因=pcu55 串allCode;strSrvDate(1) 改 stDate2
'   strSql = strSql & " Union All select 'F' as atype, pcu01||pcu02 as cno,pcu42 as cdate,na01,na03,pcu03||' '||pcu04||' '||pcu05||' '||pcu06 as ename," & _
'                "pcu08 as cname,pcu40 as cmemo,pcu38 as ano,pcu37 as adate, '' as cdept, '' as Remark, pcu39 as ctype,'' as sno,' ' as smemo " & _
'                "from potcustomer b1,nation where pcu09=na01(+) and pcu02='0' and pcu42>=" & stDate1 & " and pcu42<" & strSrvDate(1) & _
'                " and not exists (select * from potcustomer b2 where b1.pcu01=b2.pcu01(+) and b2.pcu02<>'0') "
   strSql = strSql & " Union All select 'F' as atype, pcu01||pcu02 as cno,pcu42 as cdate,na01,na03,pcu03||' '||pcu04||' '||pcu05||' '||pcu06 as ename," & _
                "pcu08 as cname,pcu40 as cmemo,pcu38 as ano,pcu37 as adate, '' as cdept, '' as Remark, pcu39 as ctype,ac02 as sno ,ac03 as smemo " & _
                "from potcustomer b1,nation,allcode where pcu09=na01(+) and pcu02='0' and pcu42>=" & stDate1 & " and pcu42<" & stDate2 & _
                " and not exists (select * from potcustomer b2 where b1.pcu01=b2.pcu01(+) and b2.pcu02<>'0') and PCU55=ac02(+) and '13'=ac01(+) "
   'Added by Lydia 2020/02/15 增加非國外部新增之X、Y、R編號
   '客戶檔
   'Modified by Lydia 2020/08/25 包含潛在客戶轉入X編號,未輸入智權人員 substr(cu12,1,1)=> substr(nvl(cu12,'N'),1,1) ; 8/19 R1742800轉為X8307900, 8/20 才輸入智權人員
   'Modified by Lydia 2020/10/28 +來源,狀態cu80
   'strSql = strSql & "Union All select 'S' as atype, cu01||cu02 as cno,cu82 as cdate,na01,na03,cu05||' '||cu88||' '||cu89||' '||cu90 as ename," & _
                "cu04 As cname, cu79 As cmemo, cu129 As ano, cu14 As adate, a0902 as cdept " & _
                "from customer b1,nation,staff,acc090 where cu13=st01(+) and cu10=na01(+) and substr(nvl(cu12,'N'),1,1)<>'F' and cu02='0' and cu82>=" & stDate1 & " and cu82<" & strSrvDate(1) & _
                " and not exists (select * from customer b2 where b1.cu01=b2.cu01(+) and b2.cu02<>'0') and cu12=a0901(+) "
   'Modified by Lydia 2023/01/10 + 來所原因' ' as sno,' ' as smemo
   'Modify by Amy 2025/11/18 strSrvDate(1) 改 stDate2
   strSql = strSql & "Union All select 'S' as atype, cu01||cu02 as cno,cu82 as cdate,na01,na03,cu05||' '||cu88||' '||cu89||' '||cu90 as ename," & _
                "cu04 As cname, cu79 As cmemo, cu129 As ano, cu14 As adate, a0902 as cdept,csm02 as Remark, cu80 as ctype,' ' as sno,' ' as smemo " & _
                "from customer b1,nation,staff,acc090,casesourcemap where cu13=st01(+) and cu10=na01(+) and substr(nvl(cu12,'N'),1,1)<>'F' and cu02='0' and cu82>=" & stDate1 & " and cu82<" & stDate2 & _
                " and not exists (select * from customer b2 where b1.cu01=b2.cu01(+) and b2.cu02<>'0') and cu12=a0901(+) and cu09=csm01(+) "
   '代理人檔
   'Modified by Lydia 2020/10/28 +性質 => decode(FA76,'A','律師事務所','B','公司直接委辦','C','其他',FA76) as Remark,  fa69 as ctype
   'Modified by Lydia 2023/01/10 + 來所原因
   'strSql = strSql & " Union All select 'S' as atype, fa01||fa02 as cno,fa47 as cdate,na01,na03,fa05||' '||fa63||' '||fa64||' '||fa65 as ename," & _
                "fa04 As cname, fa29 As cmemo, fa94 As ano, fa11 As adate, a0902 as cdept, decode(FA76,'A','律師事務所','B','公司直接委辦','C','其他',FA76) as Remark,  fa69 as ctype " & _
                "from fagent b1,nation,staff,acc090 where fa46=st01(+) and fa10=na01(+) and substr(st03,1,1)<>'F' and fa02='0' and fa47>=" & stDate1 & " and fa47<" & strSrvDate(1) & _
                " and not exists (select * from fagent b2 where b1.fa01=b2.fa01(+) and b2.fa02<>'0') and st03=a0901(+) "
   'Added by Lydia 2023/12/22
   'Modify by Amy 2025/11/18 strSrvDate(1) 改 stDate2
   If stDate1 >= 新部門啟用日 Then
      strSql = strSql & " Union All select 'S' as atype, fa01||fa02 as cno,fa47 as cdate,na01,na03,fa05||' '||fa63||' '||fa64||' '||fa65 as ename," & _
                   "fa04 As cname, fa29 As cmemo, fa94 As ano, fa11 As adate, nvl(a0922,a0902) as cdept, decode(FA76,'A','律師事務所','B','公司直接委辦','C','其他',FA76) as Remark,  fa69 as ctype,ac02 as sno,ac03 as smemo " & _
                   "from fagent b1,nation,staff,acc090,acc090new,allcode where fa46=st01(+) and fa10=na01(+) and substr(st03,1,1)<>'F' and fa02='0' and fa47>=" & stDate1 & " and fa47<" & stDate2 & _
                   " and not exists (select * from fagent b2 where b1.fa01=b2.fa01(+) and b2.fa02<>'0') and st03=a0901(+) and st93=a0921(+) and fa127=ac02(+) and '13'=ac01(+) "
   Else
   'end 2023/12/22
      strSql = strSql & " Union All select 'S' as atype, fa01||fa02 as cno,fa47 as cdate,na01,na03,fa05||' '||fa63||' '||fa64||' '||fa65 as ename," & _
                   "fa04 As cname, fa29 As cmemo, fa94 As ano, fa11 As adate, a0902 as cdept, decode(FA76,'A','律師事務所','B','公司直接委辦','C','其他',FA76) as Remark,  fa69 as ctype,ac02 as sno,ac03 as smemo " & _
                   "from fagent b1,nation,staff,acc090,allcode where fa46=st01(+) and fa10=na01(+) and substr(st03,1,1)<>'F' and fa02='0' and fa47>=" & stDate1 & " and fa47<" & stDate2 & _
                   " and not exists (select * from fagent b2 where b1.fa01=b2.fa01(+) and b2.fa02<>'0') and st03=a0901(+) and fa127=ac02(+) and '13'=ac01(+) "
   End If
   '國內潛在客戶檔
   'Modified by Lydia 2020/10/28 + '' as Remark, poc14 as ctype
   'Modified by Lydia 2023/01/10 + 來所原因' ' as sno,' ' as smemo
   strSql = strSql & " Union All Select 'S' As Atype,Poc01||Poc02 As Cno,Poc18 As Cdate,Na01,Na03,Poc23||' '||Poc24||' '||Poc25||' '||Poc26||' '||Poc27 As Ename," & _
                            " Nvl(Poc03,Poc28) As Cname,Poc15 As Cmemo,Poc13 As Ano,Poc12 As Adate,a0902 As Cdept, '' as Remark, poc14 as ctype,' ' as sno,' ' as smemo " & _
                            " From Potcustomer1 B1,Nation,Staff,Acc090 Where Poc04=Na01(+) And Poc02='0' And Poc18>=" & stDate1 & " and poc18<" & stDate2 & _
                            " And Not Exists (Select * From Potcustomer1 B2 Where B1.Poc01=B2.Poc01(+) And B2.Poc02<>'0') and poc13=st01(+) and st15=a0901(+) "
   'end 2025/11/18
   'end 2020/02/15
   strSql = strSql & "  order by cno,na01"
   Set rsAD = New ADODB.Recordset
   rsAD.CursorLocation = adUseClient
   rsAD.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   With rsAD
       If .RecordCount > 0 And .RecordCount <> 0 Then
           .MoveFirst
           Do While Not .EOF
               '檢查是否為國外部人員開發
               'Modified by Lydia 2020/02/15 +判斷國外部
               'If Right("" & .Fields("cno"), 1) = "R" Then
               If "" & .Fields("aType") = "F" And Right("" & .Fields("cno"), 1) = "R" Then
                    If "" & .Fields("ano") = "" Then GoTo JumpNextRec
                    strSql = "select count(*) cnt from staff where st01 in (" & GetAddStr("" & .Fields("ano")) & ") and substr(st03,1,1)='F' "
                    intI = 1
                    Set RsTemp = ClsLawReadRstMsg(intI, strSql)
                    If intI = 1 Then
                        If Val("" & RsTemp.Fields("cnt")) = 0 Then
                            GoTo JumpNextRec
                        End If
                    End If
               End If
               If iCount = 0 Then
                   'Modified by Lydia 2018/06/11  改成excel
'                   f92 = FreeFile
'                   If Dir(App.path & TextPath & TempFileName & ".txt") <> "" Then
'                      Kill App.path & TextPath & TempFileName & ".txt"
'                   End If
'                   Open App.path & TextPath & TempFileName & ".txt" For Output As f92
'                   Print #f92, String(40, " ") & TempFileName
'                   Print #f92, ""
'                   Print #f92, "列印日期：" & ChangeTStringToTDateString(strSrvDate(2))
'                   Print #f92, ""
'                   Print #f92, strTitle
'                   Print #f92, strTitleLine
                    xlsPoint.SheetsInNewWorkbook = 1 'Added by Lydia 2019/03/12 預設工作表數目
                    xlsPoint.Workbooks.add
                    Set wksA92 = xlsPoint.Worksheets(1)
                    wksA92.PageSetup.Orientation = xlLandscape '橫印
                    'Modify by Amy 2025/11/18 加2欄後非在中間
                    'wksA92.Range("E1").Value = TempFileName
                    wksA92.Range("A1").Value = TempFileName
                    wksA92.Range("A1:" & Chr((UBound(strTitle)) + 65) & "1").Select
                    With xlsPoint.Selection
                        .HorizontalAlignment = xlCenter
                        .VerticalAlignment = xlBottom
                        .WrapText = False
                        .Orientation = 0
                        .AddIndent = False
                        .ShrinkToFit = False
                        .MergeCells = True
                    End With
                    'end 2025/11/18
                    wksA92.Range("A2").Value = "列印日期："
                    wksA92.Range("B2").Value = ChangeTStringToTDateString(strSrvDate(2))
                    'Added by Lydia 2021/10/20 加註
                    wksA92.Range("E2").Value = "PS：紅色資料為台灣籍事務所，若確認為國內同業，請通知電腦中心設定狀態並取消EMAIL"
                    wksA92.Range("E2").Font.Color = vbRed
                    
                    '抬頭
                    xRows = 4
                    For inJ = 0 To UBound(strTitle)
                       wksA92.Range(Trim(strTitleL(inJ)) & xRows).Value = Trim(strTitle(inJ)) '欄位名稱
                       wksA92.Columns(Trim(strTitleL(inJ)) & ":" & Trim(strTitleL(inJ))).ColumnWidth = Val(strTitleW(inJ))     '欄寬
                       wksA92.Columns(Trim(strTitleL(inJ)) & ":" & Trim(strTitleL(inJ))).NumberFormatLocal = "@"   '欄位設定為文字型態
                    Next inJ
                    xRows = 5
                    'end 2018/06/11
               End If
               
               'Added by Lydia 2021/10/20 是否另外設定顏色
               strSpec = ""
               If "" & .Fields("na01") < "010" And InStr("," & .Fields("cname"), "事務所") > 0 Then
                   strSpec = "R"   '若國籍<'010'且中文名稱有「事務所」字樣的資料，請以紅色標註整行。
               End If
               'end 2021/10/20
               strTemp(0) = "" & convForm("" & .Fields("cno"), 9)
               strTemp(1) = "" & convForm(ChangeTStringToTDateString(TransDate("" & .Fields("cdate"), 1)), 9)
               strTemp(2) = "" & convForm("" & .Fields("na03"), 8)
               'Modified by Lydia 2018/07/12 不限長度
               'strTemp(3) = "" & convForm("" & .Fields("ename"), 30)
               'strTemp(4) = "" & convForm("" & .Fields("cname"), 30)
               strTemp(3) = Trim("" & .Fields("ename")) 'Modified by Lydia 2021/03/31 +Trim去掉空白
               strTemp(4) = Trim("" & .Fields("cname")) 'Modified by Lydia 2021/03/31 +Trim去掉空白
               'end 2018/07/12
               'Modify by Amy 2025/11/18 R轉X/Y編號時,原R編號資料寫入前後會加「^」
'               If "" & .Fields("cmemo") <> "" And InStr("" & .Fields("cmemo"), ";原潛在客戶編號:") > 0 Then
'                    strExc(1) = Mid("" & .Fields("cmemo"), InStr("" & .Fields("cmemo"), ";原潛在客戶編號:") + 1)
'                    strExc(1) = Mid(strExc(1), Len(";原潛在客戶編號:"), 9)
'                    strTemp(5) = "" & convForm(strExc(1), 9)
'               Else
'                    strTemp(5) = String(9, " ")
'               End If
               strTemp(5) = "": strTemp(13) = "": strSourceName = ""
               strMemo = "" & .Fields("cmemo")
               If strMemo <> "" And InStr(strMemo, "^原潛在客戶編號:") > 0 Then
                    strExc(1) = Mid("" & .Fields("cmemo"), InStr("" & .Fields("cmemo"), "^原潛在客戶編號:") + 1)
                    strExc(1) = Mid(strExc(1), Len("^原潛在客戶編號:"), 9)
                    strTemp(5) = strExc(1)
               End If
               If strTemp(5) <> "" And InStr(strMemo, "^") > 0 Then
                  strMemo = Mid(strMemo, InStr(strMemo, "^原潛在客戶編號:"))
                  strMemo = Mid(strMemo, 2) '去掉第1個^
                  '抓結束^(若不小心被拿掉,則不取 來所原因=L 欄/R編號備註=N 欄)
                  If InStr(strMemo, "^") > 0 Then
                     strMemo = Mid(strMemo, 1, InStr(strMemo, "^") - 1)
                     strMemo = Mid(strMemo, Len("原潛在客戶編號:" & strTemp(5)) + 1)
                     If InStr(strMemo, ";來所原因:") > 0 Then
                        strSourceName = Mid(strMemo, Len(";來所原因:") + 1)
                     End If
                     '備註可能為空
                     If InStr(strMemo, ";備註:") > 0 Then
                        strTemp(13) = Mid(strMemo, InStr(strMemo, ";備註:"))
                        strTemp(13) = Mid(strTemp(13), Len(";備註:") + 1)
                     End If
                     '來所原因 後有備註要拿掉
                     If strSourceName <> "" And strTemp(13) <> "" Then
                        strSourceName = Mid(strSourceName, 1, InStr(strSourceName, ";備註:" & strTemp(13)) - 1)
                     End If
                  End If
               End If
               'end 2025/11/18

               strTemp(8) = "" & .Fields("cdept") 'Added by Lydia 2018/05/24 建立部門
               'Added by Lydia 2020/10/28 備註/客源/性質; R編號/X編號/Y編號
               strTemp(9) = "" & .Fields("Remark")
               'Mark by Amy 2025/11/18 R編號備註 改至 N欄
'               If Left(strTemp(0), 1) = "R" Then
'                   strTemp(9) = "" & .Fields("cmemo")
'               End If
               strTemp(10) = "" & .Fields("ctype") '狀態
               'end 2020/10/28
               
               '開發日期
               strTemp(6) = "" & convForm(ChangeTStringToTDateString(TransDate("" & .Fields("adate"), 1)), 9)
               '開發人員(複數)
               If "" & .Fields("ano") = "" Then
                    strTemp(7) = ""
               Else
                    strExc(2) = ""
                    'Modified by Lydia 2018/05/24 +st03
                    strSql = "select st02,st03 from staff where st01 in (" & GetAddStr("" & .Fields("ano")) & ") order by st01 "
                    intI = 1
                    Set RsTemp = ClsLawReadRstMsg(intI, strSql)
                    If intI = 1 Then
                          RsTemp.MoveFirst
                          Do While Not RsTemp.EOF
                               strExc(2) = strExc(2) & RsTemp.Fields("st02") & ","
                               strTemp(8) = strTemp(8) & IIf(InStr(strTemp(8), "" & RsTemp.Fields("st03")) = 0, RsTemp.Fields("st03") & ",", "")  'Added by Lydia 2018/05/24 建立部門
                               RsTemp.MoveNext
                          Loop
                    End If
                    strTemp(7) = strExc(2)
               End If
               
               'Added by Lydia 2018/05/24 顯示"建立部門"
               strExc(2) = ""
               'Added by Lydia 2019/10/15 潛在客戶沒有建立部門,UBound(tmpArr)=-1造成For迴圈錯誤
               If strTemp(8) = "" Then
                   strTemp(8) = String(14, " ")
               'Added by Lydia 2020/02/15 非國外部：直接帶出部門
               ElseIf "" & .Fields("aType") <> "F" Then
                   strTemp(8) = convForm("" & .Fields("cdept"), 14)
               Else
               'end 2019/10/15
                    tmpArr = Split(strTemp(8), ",")
                    For intI = 0 To UBound(tmpArr)
                         If Trim(tmpArr(intI)) <> "" Then
                            Select Case Left(tmpArr(intI), 2)
                                 Case "F1": strExc(2) = strExc(2) & "外商,"
                                 Case "F2": strExc(2) = strExc(2) & "外專,"
                                 'modiby by sonia 2019/7/17 區分F3,F4
                                 'Case "F3", "F4": strExc(2) = strExc(2) & "法務,"
                                 Case "F3": strExc(2) = strExc(2) & "法務,"
                                 Case "F4": strExc(2) = strExc(2) & "業拓,"
                                 'end 2019/7/17
                                 Case Else: strExc(2) = strExc(2) & "其他,"
                            End Select
                         End If
                    Next
                    strTemp(8) = convForm(Mid(strExc(2), 1, Len(strExc(2)) - 1), 14)
               End If
               'end 2018/05/24
               'Added by Lydia 2023/01/10 來所原因
               strTemp(11) = "" & .Fields("smemo")
               'Add by Amy 2025/11/18
               strTemp(12) = ""
               strSourceNo = "" & .Fields("sno")
               '由R轉X編號者,解析備註中的「來所原因」編號抓資料
               If Left("" & .Fields("cno"), 1) = "X" And strSourceName <> "" Then
                  strSourceNo = Left(strSourceName, 2)
               End If
               'If InStr("04,05,11", "" & .Fields("sno")) > 0 Then
               If InStr("04,05,11,", Format(Val(strSourceNo), "00") & ",") > 0 Then
               'end 2025/11/18
                   strSql = "select decode(xys02,null,'',xys02||' '||decode(fa01,null,nvl(cu05,nvl(cu04,cu06)),nvl(fa05,nvl(fa04,fa06)))) xysname, xys03  from xynosource,fagent,customer " & _
                               "where xys01='" & Left(.Fields("cno"), 8) & "' and xys02=fa01(+) and '0'=fa02(+) and xys02=cu01(+) and '0'=cu02(+) "
                   intI = 1
                   Set RsTemp = ClsLawReadRstMsg(intI, strSql)
                   If intI = 1 Then
                      If "" & RsTemp.Fields("xysname") <> "" Then
                         strTemp(11) = strTemp(11) & "：" & RsTemp.Fields("xysname")
                         strSourceName = strSourceName & "：" & RsTemp.Fields("xysname") 'Add by Amy 2025/11/18
                      Else
                        'Modify by Amy 2025/11/18 來所原因其他說明(xys03) 改至 M欄
                        'strTemp(11) = strTemp(11) & "：" & RsTemp.Fields("xys03")
                        strTemp(12) = "" & RsTemp.Fields("xys03")
                      End If
                   End If
               End If
               'Add by Amy 2025/11/18 由R轉X編號者,解析備註中的「來所原因」顯示(避免AllCode 有更動,對應不同的名稱)
               If Left("" & .Fields("cno"), 1) = "X" And strSourceName <> "" Then strTemp(11) = strSourceName
               'end 2023/01/10
               
               'Modified by Lydia 2018/05/24 +strtemp(8)
               'Modified by Lydia 2018/06/11  改成excel
               'Print #f92, strTemp(0) & " " & strTemp(1) & " " & strTemp(8) & " " & strTemp(2) & " " & strTemp(3) & " " & strTemp(4) & " " & strTemp(5) & " " & strTemp(6) & " " & strTemp(7)
               wksA92.Range("A" & xRows).Value = strTemp(0)
               wksA92.Range("B" & xRows).Value = strTemp(1)
               wksA92.Range("C" & xRows).Value = strTemp(8)
               wksA92.Range("D" & xRows).Value = strTemp(2)
               wksA92.Range("E" & xRows).Value = strTemp(3)
               wksA92.Range("F" & xRows).Value = strTemp(4)
               wksA92.Range("G" & xRows).Value = strTemp(10) 'Added by Lydia 2020/10/28 狀態
               wksA92.Range("H" & xRows).Value = strTemp(5)
               wksA92.Range("I" & xRows).Value = strTemp(6)
               wksA92.Range("J" & xRows).Value = strTemp(7)
               'Modify by Amy 2025/11/18 改為顯示「客源/性質」
               wksA92.Range("K" & xRows).Value = strTemp(9) 'Added by Lydia 2020/10/28 備註/客源/性質
               wksA92.Range("L" & xRows).Value = strTemp(11) 'Added by Lydia 2023/01/10 來所原因
               'Add by Amy 2025/11/18 加2欄
               wksA92.Range("M" & xRows).Value = strTemp(12) '來所原因其他說明
               wksA92.Range("N" & xRows).Value = strTemp(13) 'R編號備註
               'end 2025/11/18
               'Added by Lydia 2021/10/20 是否另外設定顏色
               If strSpec = "R" Then   '若國籍<'010'且中文名稱有「事務所」字樣的資料，請以紅色標註整行。
                   'Modified by Lydia 2023/01/10
                   'wksA92.Range("A" & xRows & ":" & "K" & xRows).Font.Color = vbRed
                   'Modify by Amy 2025/11/18 增加2欄
                   'wksA92.Range("A" & xRows & ":" & "L" & xRows).Font.Color = vbRed
                   wksA92.Range("A" & xRows & ":" & strTitleL(UBound(strTitleL)) & xRows).Font.Color = vbRed
               End If
               'end 2021/10/20
               xRows = xRows + 1
               'end 2018/06/12
               
               iCount = iCount + 1
               
JumpNextRec:
               .MoveNext
           Loop
       End If
   End With
   
   'Modified by Lydia 2018/06/11  改成excel
   'If f92 > 0 Then
   '    Print #f92, String(Len(strTitleLine), "=")
   '    Print #f92, "共 " & iCount & " 筆"
   '    Close #f92
   If iCount > 0 Then
        '判斷若版本2007以上改變存檔格式
        If Val(xlsPoint.Version) < 12 Then
          xlsPoint.Workbooks(1).SaveAs FileName:=strPath, FileFormat:=-4143
        Else
          xlsPoint.Workbooks(1).SaveAs FileName:=strPath, FileFormat:=56
        End If
        xlsPoint.Workbooks.Close
        xlsPoint.Quit
        Set xlsPoint = Nothing
        Set wksA92 = Nothing
   'end 2018/06/11
       '通知人員-兼職業務拓展處人員與業務拓展處F41所有人員
       strExc(2) = Pub_GetSpecMan("兼職業務拓展處人員")
       strSql = "select st01 from staff where st03='F41' and st04='1' and substr(st01,4,1)<>'9' and substr(st01,1,1) <> 'F' order by st01 "
       intI = 1
       Set RsTemp = ClsLawReadRstMsg(intI, strSql)
       If intI = 1 Then
             RsTemp.MoveFirst
             Do While Not RsTemp.EOF
                  strExc(2) = strExc(2) & ";" & RsTemp.Fields("st01")
                  RsTemp.MoveNext
             Loop
       End If
       If Right(strExc(2), 1) = ";" Then strExc(2) = Mid(strExc(2), 2)
       
       'Modified by Lydia 2018/06/11
       'SendMAPIMail strExc(2), strSrvDate(2) & "_" & TempFileName, vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, App.path & TextPath & TempFileName & ".xls"
       SendMAPIMail strExc(2), strSrvDate(2) & "_" & TempFileName, vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, strPath
   End If
   Set rsAD = Nothing
   Exit Sub
   
DebugErr:
   If Err.Number <> 0 Then
      Set rsAD = Nothing
      'Modified by Lydia 2020/02/15 更名「國外部新增客戶及代理人清單」=>「新增客戶及代理人清單」
      WLog "新增客戶及代理人清單:" & Err.Description
   End If
End Sub

'Added by Lydia 2018/06/21 互惠名單委案通知
'Modified by Lydia 2018/06/26 委案=>往來
'Modified by Lydia 2018/09/18 分成上下兩個表格,分別提供專利、商標的當期統計;代理人名稱欄位有帶出名稱，用來區別實際有互惠名單的項目。
'Sub StrMenu93()
'On Error GoTo DebugErr
'Dim f93 As Integer
'Dim rsAD As ADODB.Recordset
'Dim TempFileName As String
'Dim strTitle As Variant, strTitleL As Variant, strTitleW As Variant
'Dim strTemp(0 To 4) As String
'Dim stDate1 As String
'Dim tmpArr As Variant
'Dim xRows As Integer '目前列位置
'Dim xlsPoint As New Excel.Application
'Dim wksA93 As New Worksheet
'Dim inJ As Integer
'Dim strPath As String
'Dim strGrp As String '代理人
'Dim strSysNo As String  '專利或商標系統別
'Dim strCaseDetail As String '新案列表: 新案案號, 新案名稱, 申請人英文名稱,申請人編號
''Modified by Lydia 2021/09/11
''Dim strToA As String, strToP As String, strToT As String ' 國外部主管,專利案主管,商標案主管
'Dim strToA As String '國外部主管+業拓
'Dim strToP As String, strToP_J '外專通知人員: 英文組、日文組
'Dim strToT As String '外商通知人員
'Dim strGrpNa01 As String '代理人/客戶國籍
''end 2021/09/11
'Dim strToP1 As String '內專主管
'Dim strToP1cc As String 'Added by Lydia 2023/06/05 內專主管CC
'Dim mYY As String, mKind As String '年度, 期間(1-上半年,2-下半年)
'Dim stVTB1 As String, stVTB2 As String
'Dim iRound As Integer
'Dim iCntP As Integer, iCntT As Integer 'Memo by Lydia 2019/02/01 原始新案數
'Dim mStiu As String '是否不以互惠名單為條件
''Added by Lydia 2019/02/01
'Dim iCntP2 As Integer, iCntT2 As Integer '非原始新案數
'Dim cNewP As String, cNewT As String '原始新案之性質
'
'On Error GoTo DebugErr
'
'    'Modified by Lydia 2018/06/26 委案=>往來
'    TempFileName = "互惠名單往來通知"
'    strPath = App.path & TextPath & TempFileName & ".xls"
'    'Move by Lydia 2020/08/21 從下面迴圈搬上來
'    If Dir(strPath) <> "" Then
'       Kill strPath
'    End If
'    'end 2020/08/21
'    'Added by Lydia 2019/02/01
'    cNewP = "101,102,103"
'    cNewT = "101,"
'
''Modified by Lydia 2018/09/18  強迫換行
''strTitle = Split("代理人名稱,代理人編號,當年度1-6月FC收案量,當年度1-6月CF給案量,當年度1-6月收給差,當年度7-12月FC收案量,當年度7-12月CF給案量,當年度7-12月收給差,該半年度建議CF給案量,新案數,備註", ",")
''Modified by Lydia 2019/02/15 改抬頭, ex."當年度1-6月FCT 原始新案收案量"
''strTitle = Split("代理人名稱,代理人編號,當年度" & vbCrLf & "1-6月FC" & vbCrLf & "收案量,當年度" & vbCrLf & "1-6月CF" & vbCrLf & "給案量,當年度" & vbCrLf & "1-6月" & vbCrLf & "收給差,當年度" & vbCrLf & "7-12月FC" & vbCrLf & "收案量,當年度" & vbCrLf & "7-12月CF" & vbCrLf & "給案量,當年度" & vbCrLf & "7-12月" & vbCrLf & "收給差,該半年度" & vbCrLf & "建議CF" & vbCrLf & "給案量,新案數,備註", ",")
'strTitle = Split("代理人名稱,代理人編號,當年度1-6月FC" & vbCrLf & "原始新案收案量,當年度1-6月CF" & vbCrLf & "原始新案給案量,當年度1-6月" & vbCrLf & "原始新案收給差,當年度7-12月FC" & vbCrLf & "原始新案收案量,當年度7-12月CF" & vbCrLf & "原始新案給案量,當年度7-12月" & vbCrLf & "原始新案收給差,該半年度" & vbCrLf & "建議CF" & vbCrLf & "原始新案給案量,前一工作日之" & vbCrLf & "原始新案數" & vbCrLf & "/新案數,備註", ",")
'strTitleL = Split("A,B,C,D,E,F,G,H,I,J,K", ",")
''Modified by Lydia 2018/09/18
''strTitleW = Split("25,12,7,7,7,7,7,7,7,7,7", ",")
''Modified by Lydia 2019/02/01 代理人名稱25=>60
''Modified by Lydia 2019/02/15
''strTitleW = Split("60,12,9,9,9,10,10,9,10,9,9", ",")
'strTitleW = Split("60,12,17,17,17,17,17,17,17,17,17", ",")
'
'   stDate1 = CompWorkDay(2, strSrvDate(1), 1)
'
'   mYY = Val(Mid(stDate1, 1, 4)) - 1911
'   '期間(1-6月上半年,7-12月下半年)
'   If Val(Mid(stDate1, 5, 2)) > 6 Then
'       mKind = "2"
'   Else
'       mKind = "1"
'   End If
'
'   '專利案
'   strExc(1) = ", decode(pa09,'000',nvl(pa06,nvl(pa05,pa07)),nvl(pa05,nvl(pa06,pa07))) as casename, decode(pa09,'000'," & _
'                                "decode(cu05,null,nvl(cu04,cu06),cu05||' '||cu88||' '||cu89||' '||cu90), " & _
'                                    "nvl(cu04,decode(cu05,null,cu06,cu05||' '||cu88||' '||cu89||' '||cu90))) as custname, "
'   '商標案
'   strExc(2) = ", tm05 as casename, decode(tm10,'000'," & _
'                                "decode(cu05,null,nvl(cu04,cu06),cu05||' '||cu88||' '||cu89||' '||cu90), " & _
'                                    "nvl(cu04,decode(cu05,null,cu06,cu05||' '||cu88||' '||cu89||' '||cu90))) as custname, "
'
'   'Modified by Lydia 2019/02/01 +CP10
'   'Modified by Lydia 2021/09/11 抓代理人國籍
'   'strSql = "select '1' as ord1, cp01,cp02,cp03,cp04,fc01 " & strExc(1) & " pa26 as custno,CP10 " & _
'               "From (SELECT DISTINCT FC01,'' FC03 FROM FAGENTCONFIG Where FC06='CFP' AND FC04=" & mYY & " And FC05=" & mKind & " ) VTB1,caseprogress,patent,customer " & _
'               "WHERE CP44=FC01||'0' and cp01||cp04='CFP00' and cp57 is null and cp27=" & stDate1 & " and cp31='Y' " & _
'               "and cp01=pa01(+) and cp02=pa02(+) and cp03=pa03(+) and cp04=pa04(+) " & _
'               "and substr(pa26,1,8)=cu01(+) and substr(pa26,9,1)=cu02(+) "
'   strSql = "select '1' as ord1, cp01,cp02,cp03,cp04,fc01 " & strExc(1) & " pa26 as custno,CP10,na01 " & _
'               "From (SELECT DISTINCT FC01,'' FC03, substr(fa10,1,3) na01 FROM FAGENTCONFIG,fagent Where FC06='CFP' AND FC04=" & mYY & " And FC05=" & mKind & " and fc01=fa01(+) and fc02=fa02(+) ) VTB1,caseprogress,patent,customer " & _
'               "WHERE CP44=FC01||'0' and cp01||cp04='CFP00' and cp57 is null and cp27=" & stDate1 & " and cp31='Y' " & _
'               "and cp01=pa01(+) and cp02=pa02(+) and cp03=pa03(+) and cp04=pa04(+) " & _
'               "and substr(pa26,1,8)=cu01(+) and substr(pa26,9,1)=cu02(+) "
'   'Modified by Lydia 2019/02/01 +CP10
'   'Modified by Lydia 2021/09/11 抓代理人國籍
'   'strSql = strSql & "union select '1' as ord1, cp01,cp02,cp03,cp04,fc01 " & strExc(1) & " pa26 as custno,CP10 " & _
'               "from (select DISTINCT FC01,'' FC03 from FAGENTCONFIG where FC06='CFP' AND FC04=" & mYY & " And FC05=" & mKind & " ) VTB2,patent,caseprogress,customer " & _
'               "where pa75=FC01||'0' AND pa01||''='FCP' and cp57 is null and cp05=" & stDate1 & " and cp31='Y' " & _
'               "and cp01(+)=pa01 and cp02(+)=pa02 and cp03(+)=pa03 and cp04(+)=pa04 " & _
'               "and substr(pa26,1,8)=cu01(+) and substr(pa26,9,1)=cu02(+) "
'   strSql = strSql & "union select '1' as ord1, cp01,cp02,cp03,cp04,fc01 " & strExc(1) & " pa26 as custno,CP10,na01 " & _
'               "from (select DISTINCT FC01,'' FC03, substr(fa10,1,3) na01 from FAGENTCONFIG,fagent where FC06='CFP' AND FC04=" & mYY & " And FC05=" & mKind & " and fc01=fa01(+) and fc02=fa02(+) ) VTB2,patent,caseprogress,customer " & _
'               "where pa75=FC01||'0' AND pa01||''='FCP' and cp57 is null and cp05=" & stDate1 & " and cp31='Y' " & _
'               "and cp01(+)=pa01 and cp02(+)=pa02 and cp03(+)=pa03 and cp04(+)=pa04 " & _
'               "and substr(pa26,1,8)=cu01(+) and substr(pa26,9,1)=cu02(+) "
'   'Modified by Lydia 2019/02/01 +CP10
'   'Modified by Lydia 2021/09/11 + substr(CU10,1,3) as na01
'   'Modified by Lydia 2021/09/11 抓代理人國籍
'   'strSql = strSql & "union select '2' as ord1, cp01,cp02,cp03,cp04,fc01 " & strExc(2) & " tm23 as custno,CP10,substr(CU10,1,3) as na01 " & _
'               "From (SELECT DISTINCT FC01,'' FC03 FROM FAGENTCONFIG Where FC06='CFT' AND FC04=" & mYY & " And FC05=" & mKind & " ) VTB1,caseprogress,trademark,customer " & _
'               "WHERE CP44=FC01||'0' and cp01||cp04='CFT00' and cp57 is null and cp27=" & stDate1 & " and cp31='Y' " & _
'               "and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+) " & _
'               "and substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+) "
'   strSql = strSql & "union select '2' as ord1, cp01,cp02,cp03,cp04,fc01 " & strExc(2) & " tm23 as custno,CP10,na01 " & _
'               "From (SELECT DISTINCT FC01,'' FC03, substr(fa10,1,3) na01 FROM FAGENTCONFIG,fagent Where FC06='CFT' AND FC04=" & mYY & " And FC05=" & mKind & " and fc01=fa01(+) and fc02=fa02(+) ) VTB1,caseprogress,trademark,customer " & _
'               "WHERE CP44=FC01||'0' and cp01||cp04='CFT00' and cp57 is null and cp27=" & stDate1 & " and cp31='Y' " & _
'               "and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+) " & _
'               "and substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+) "
'   'Modified by Lydia 2019/02/01 +CP10
'   'Modified by Lydia 2021/09/11 抓代理人國籍
'   'strSql = strSql & "union select '2' as ord1, cp01,cp02,cp03,cp04,fc01 " & strExc(2) & " tm23 as custno,CP10 " & _
'               "from (select DISTINCT FC01,'' FC03 from FAGENTCONFIG where FC06='CFT' AND FC04=" & mYY & " And FC05=" & mKind & " ) VTB2,caseprogress,trademark,customer " & _
'               "where tm44=FC01||'0' AND tm01||''='FCT' and cp57 is null and cp05=" & stDate1 & " and cp31='Y' " & _
'               "and cp01(+)=tm01 and cp02(+)=tm02 and cp03(+)=tm03 and cp04(+)=tm04 " & _
'               "and substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+) "
'   strSql = strSql & "union select '2' as ord1, cp01,cp02,cp03,cp04,fc01 " & strExc(2) & " tm23 as custno,CP10,na01 " & _
'               "from (select DISTINCT FC01,'' FC03, substr(fa10,1,3) na01  from FAGENTCONFIG,fagent where FC06='CFT' AND FC04=" & mYY & " And FC05=" & mKind & " and fc01=fa01(+) and fc02=fa02(+) ) VTB2,caseprogress,trademark,customer " & _
'               "where tm44=FC01||'0' AND tm01||''='FCT' and cp57 is null and cp05=" & stDate1 & " and cp31='Y' " & _
'               "and cp01(+)=tm01 and cp02(+)=tm02 and cp03(+)=tm03 and cp04(+)=tm04 " & _
'               "and substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+) "
'   '依代理人排序
'   strSql = strSql & "order by fc01,ord1,cp01,cp02 "
'   Set rsAD = New ADODB.Recordset
'   rsAD.CursorLocation = adUseClient
'   rsAD.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
'   With rsAD
'       If .RecordCount > 0 And .RecordCount <> 0 Then
'            '國外部主管=(1)國外部主管(目前為何主秘兼任)=特殊"O"+外業主管(目前為Elvan=F41部門之A0908)
'            'Memo by Lydia 2021/09/11 國外部主管+業拓
'            'Mark by Lydia 2022/12/06 先暫時取消國外部主管=O
'            'strSql = "select Oman from setSpecMan where ocode ='O' "
''            'Modified by Lydia 2021/09/11 改抓系統特殊設定
''            strSql = strSql & "union select A0908 from acc090 where a0901='F41' "
''            'Added by Lydia 2018/06/26 增加通知Widen;若開拓部門人員再增加,才考慮是否抓部門人員
''            'Modified by Lydia 2018/09/25 +Elvan(Widen反應8/20開始Elvan沒有收到,因為已不是主管)
''            'strSql = strSql & "union select st01 from staff where st01='A4024' and st04='1' "
''            strSql = strSql & "union select st01 from staff where st01 in ('A4024','99033') and st04='1' "
'            'Modified by Lydia 2022/12/06 先暫時取消國外部主管=O
'            'strSql = strSql & "union select st01 from setspecman, staff where ocode='國外互惠新案收文通知名單' and instr(oman, st01) > 0  and st04='1' "
'            strSql = "select st01 from setspecman, staff where ocode='國外互惠新案收文通知名單' and instr(oman, st01) > 0  and st04='1' "
'            strSql = strSql & " order by 1 "
'            'end 2021/09/11
'            intI = 1
'            Set RsTemp = ClsLawReadRstMsg(intI, strSql)
'            If intI = 1 Then strToA = RsTemp.GetString(adClipString, , , ",")
'            strToA = Replace(Replace(strToA, ",,", ","), ",", ";")
'
'            '專利主管=外專各組工程師主管("R","S","T","T1")+外專承辦主管(F23部門之A0908)+為CFP/FCP案(專利案)，加送內專主管(目前為王副總,P10部門之A0908)
'            'Modified by Lydia 2021/09/11 區分外專通知人員: 英文組、日文組
''            strSql = "select Oman from setSpecMan where ocode in ('R','S','T','T1') "
''            'Modified by Lydia 2018/09/18 P10主管拿掉
''            strSql = strSql & "union select A0908 from acc090 where a0901 ='F23' "
'            strSql = "Select St01 From Setspecman, Staff Where Ocode='外專互惠新案收文通知名單F21' And Instr(Oman, St01) > 0  And St04='1' And St16 <> '3' "
'            strSql = strSql & "union select st01 from setspecman, staff where ocode='外專互惠新案收文通知名單F23' and instr(oman, st01) > 0  and st04='1' and st16 <> '2' "
'            strSql = strSql & " order by st01 "
'            'end 2021/09/11
'            intI = 1
'            Set RsTemp = ClsLawReadRstMsg(intI, strSql)
'            If intI = 1 Then strToP = RsTemp.GetString(adClipString, , , ",")
'            strToP = Replace(Replace(strToP, ",,", ","), ",", ";")
'            'Added by Lydia 2021/09/11 外專通知人員: 日文組
'            strSql = "Select St01 From Setspecman, Staff Where Ocode='外專互惠新案收文通知名單F21' And Instr(Oman, St01) > 0  And St04='1' And St16 = '3' "
'            strSql = strSql & "union select st01 from setspecman, staff where ocode='外專互惠新案收文通知名單F23' and instr(oman, st01) > 0  and st04='1' and st16 = '2' "
'            strSql = strSql & " order by st01 "
'            intI = 1
'            Set RsTemp = ClsLawReadRstMsg(intI, strSql)
'            If intI = 1 Then strToP_J = RsTemp.GetString(adClipString, , , ",")
'            strToP_J = Replace(Replace(strToP_J, ",,", ","), ",", ";")
'            'end 2021/09/11
'
'            '商標主管=外商主管(目前為陳經理,F11部門之A0908)
''            'Modified by Lydia 2021/09/11 改抓系統特殊設定
''            strSql = "select A0908 from acc090 where a0901='F11' "
'            strSql = "Select St01 From Setspecman, Staff Where Ocode='外商互惠新案收文通知名單F11' And Instr(Oman, St01) > 0  And St04='1' order by st01 "
'            'end 2021/09/11
'            intI = 1
'            Set RsTemp = ClsLawReadRstMsg(intI, strSql)
'            If intI = 1 Then strToT = RsTemp.GetString(adClipString, , , ",")
'            strToT = Replace(Replace(strToT, ",,", ","), ",", ";")
'
'            'Added by Lydia 2018/09/18 新案為CFP/FCP案(專利案)，加送內專主管(目前為王副總,P10部門之A0908)
'            'Modified by Lydia 2023/06/05 內專主管(原抓P10之A0908)改發79075,副本73022
'            'strSql = "select A0908 from acc090 where a0901='P10' "
'            'intI = 1
'            'Set RsTemp = ClsLawReadRstMsg(intI, strSql)
'            'If intI = 1 Then strToP1 = RsTemp.GetString(adClipString, , , ",")
'            'strToP1 = Replace(Replace(strToP1, ",,", ","), ",", ";")
'            strToP1 = "79075"
'            strToP1cc = "73022"
'            'end 2023/06/05
'
'           .MoveFirst
'           Do While Not .EOF
'               '依代理人
'               If strGrp <> "" & rsAD.Fields("FC01") Then
'                    '----------excel存檔，並且email
'                    If strGrp <> "" Then
'                        '新案數=前一日新的本所案號
'                        'Modified by Lydia 2019/02/01 改成原始新案數(非原始)
'                        'wksA93.Range("J5").Value = iCntP
'                        'wksA93.Range("J8").Value = iCntT
'                        'Modified by Lydia 2019/02/15 改"1/0"
'                        'wksA93.Range("J5").Value = iCntP & "(" & iCntP2 & ")"
'                        'wksA93.Range("J8").Value = iCntT & "(" & iCntT2 & ")"
'                        wksA93.Range("J5").NumberFormatLocal = "@"
'                        wksA93.Range("J5").Value = iCntP & "/" & iCntP2
'                        wksA93.Range("J8").NumberFormatLocal = "@"
'                        wksA93.Range("J8").Value = iCntT & "/" & iCntT2
'                        'end 2019/02/15
'                        'Added by Lydia 2019/02/01 增加備註-原始新案數
'                        'Modified by Lydia 2019/02/15 改備註
'                        'wksA93.Range("A10").Value = "Note 1: 給案量／收案量之定義為原始新案：專利101-103；商標101"
'                        'wksA93.Range("A10").Interior.ColorIndex = 6
'                        'wksA93.Range("A11").Value = "Note 2: 新案數之定義為前一工作日之FCP/FCT給案量，如為原始新案以外之案件性質則另以( )呈現。例如專利收2件新案，1件為101-103、另一件101-103以外之案件性質，則以""1(1)""呈現以茲區別。"
'                        'wksA93.Range("A11").Interior.ColorIndex = 6
'                        'wksA93.Range("A11").WrapText = True
'                        'end 2019/02/01
'                        wksA93.Range("A10").Value = "Note : 原始新案定義為專利101-103、商標101"
'                        wksA93.Range("A10").Interior.ColorIndex = 6
'                        'end 2019/02/15
'
'                        '判斷若版本2007以上改變存檔格式
'                        If Val(xlsPoint.Version) < 12 Then
'                          xlsPoint.Workbooks(1).SaveAs FileName:=strPath, FileFormat:=-4143
'                        Else
'                          xlsPoint.Workbooks(1).SaveAs FileName:=strPath, FileFormat:=56
'                        End If
'                        xlsPoint.Workbooks.Close
'                        xlsPoint.Quit
'                        Set xlsPoint = Nothing
'                        Set wksA93 = Nothing
'                        Sleep 100
'                        '收件人：國外部主管+專利/商標案主管
'                        'Added by Lydia 2021/09/11 外專通知人員區分日本區
'                        If strGrpNa01 = "011" Then
'                            strExc(1) = strToA & strToP_J & strToT & IIf(InStr(strCaseDetail, "CFP") > 0 Or InStr(strCaseDetail, "FCP") > 0, strToP1, "")
'                        Else
'                        'end 2021/09/11
'                            strExc(1) = strToA & strToP & strToT & IIf(InStr(strCaseDetail, "CFP") > 0 Or InStr(strCaseDetail, "FCP") > 0, strToP1, "")
'                        End If 'Added by Lydia 2021/09/11
'                        'Added by Lydia 2023/06/05 內專主管加發副本
'                        strExc(6) = ""
'                        If InStr(strCaseDetail, "CFP") > 0 Or InStr(strCaseDetail, "FCP") > 0 Then
'                           strExc(6) = strExc(6) & ";" & strToP1cc
'                        End If
'                        'end 2023/06/05
'
'                        strExc(2) = vbCrLf & "請參考附件，新增案號資料如下列：" & vbCrLf & vbCrLf & _
'                                          convForm("本所案號", 16) & convForm("客戶名稱", 31) & convForm("客戶編號", 9) & vbCrLf
'                        tmpArr = Empty
'                        tmpArr = Split(strCaseDetail, ";")
'                        For intI = 0 To UBound(tmpArr)
'                             If Trim(tmpArr(intI)) <> "" Then
'                                 strExc(2) = strExc(2) & tmpArr(intI) & vbCrLf  '內文：列出新案
'                             End If
'                        Next
'                        'Modified by Lydia 2021/09/11 CC江協理(外商主管)
'                        'SendMAPIMail Mid(strExc(1), 1, Len(strExc(1)) - 1), strSrvDate(2) & "_" & TempFileName & "_" & strGrp & " " & strExc(5), strExc(2), strPath
'                        'Modified by Lydia 2023/06/05 內專主管加發副本strexc(6)
'                        'Modified by Lydia 2023/06/09 判斷收件者的清單尾端
'                        'SendMAPIMail Mid(strExc(1), 1, Len(strExc(1)) - 1), strSrvDate(2) & "_" & TempFileName & "_" & strGrp & " " & strExc(5), strExc(2), strPath, , , "98020" & strExc(6)
'                        If Right(strExc(1), 1) = ";" Then strExc(1) = Mid(strExc(1), 1, Len(strExc(1)) - 1)
'                        SendMAPIMail strExc(1), strSrvDate(2) & "_" & TempFileName & "_" & strGrp & " " & strExc(5), strExc(2), strPath, , , "98020" & strExc(6)
'                        xRows = 0
'                    End If
'                    '----------excel存檔，並且email
'                    strCaseDetail = ""
'                    iCntT = 0
'                    iCntP = 0
'                    iCntT2 = 0: iCntP2 = 0 'Added by Lydia 2019/02/01
'                    'Added by Lydia 2020/08/26
'                    If Dir(strPath) <> "" Then
'                       Kill strPath
'                    End If
'                    'end 2020/08/26
'                    xlsPoint.SheetsInNewWorkbook = 1 'Added by Lydia 2019/03/12 預設工作表數目
'                    xlsPoint.Workbooks.add
'                    Set wksA93 = xlsPoint.Worksheets(1)
'                    wksA93.PageSetup.Orientation = xlLandscape '橫印
'                    wksA93.Range("E1").Value = TempFileName
'                    wksA93.Range("A2").Value = "列印日期："
'                    wksA93.Range("B2").Value = ChangeTStringToTDateString(strSrvDate(2))
'                    xRows = 4
'                   'Modified by Lydia 2018/09/18 若代理人只有在當期專利、商標互惠名單其中一種，在往來通知時一併提供另一項的當期統計
'                   For iRound = 1 To 2
'                        mStiu = "1"
'                        If iRound = 1 Then
'                             strSysNo = "CFP"
'                        Else
'                             strSysNo = "CFT"
'                             xRows = xRows + 2
'                        End If
'                        '抬頭
'                        For inJ = 0 To UBound(strTitle)
'                            '欄位名稱
'                           strExc(1) = Replace(Replace(Trim(strTitle(inJ)), "CF", "CF" & IIf(iRound = 1, "P", "T")), "FC", "FC" & IIf(iRound = 1, "P", "T"))
'                           wksA93.Range(Trim(strTitleL(inJ)) & xRows).Value = strExc(1)
'                           wksA93.Columns(Trim(strTitleL(inJ)) & ":" & Trim(strTitleL(inJ))).ColumnWidth = Val(strTitleW(inJ))     '欄寬
'                           wksA93.Range(Trim(strTitleL(inJ)) & xRows).WrapText = True '自動換列
'                            wksA93.Rows(xRows & ":" & xRows).RowHeight = 70 '列高 'Added by Lydia 2019/02/15
'                        Next inJ
'                        'If iRound = 1 Then wksA93.Rows(xRows & ":" & xRows).RowHeight = 70 '列高  'Remove by Lydia 2019/02/15
'
'                        'Added by Lydia 2019/02/01 設欄位為粗體
'                        wksA93.Range("E4:E8").Font.Bold = True
'                        wksA93.Range("H4:J8").Font.Bold = True
'                        'end 2019/02/01
'                        xRows = xRows + 1
'
'    '------------------------------抓當期統計量
'                        'CF案件統計
'JumpReSum:
'                        stVTB1 = "select FC01||FC03 A2,count(*) CF_TOT" & _
'                                ",sum(decode(substr(cp27,1,4)," & (mYY + 1911) & "-2,1)) CF_L2" & _
'                                ",sum(decode(substr(cp27,1,4)," & (mYY + 1911) & "-1,1)) CF_L1" & _
'                                ",sum(decode(substr(cp27,1,4)," & (mYY + 1911) & ",decode(sign(substr(cp27,5,2)-6),1,0,1))) CF_C1" & _
'                                ",sum(decode(substr(cp27,1,4)," & (mYY + 1911) & ",decode(sign(substr(cp27,5,2)-6),1,1,0))) CF_C2"
'                        If mStiu = "1" Then   '依互惠名單
'                             stVTB1 = stVTB1 & " From (SELECT DISTINCT FC01,'' FC03 FROM FAGENTCONFIG" & _
'                                     " Where FC06='" & strSysNo & "' AND FC04 = " & mYY & " And FC05 = " & mKind & " And FC01||FC02='" & .Fields("FC01") & "0' ) VTB1"
'                        ElseIf mStiu = "2" Then
'                             stVTB1 = stVTB1 & " From (SELECT fa01 as FC01,'' FC03 FROM FAGENT" & _
'                                     " Where Fa01||Fa02='" & .Fields("FC01") & "0' ) VTB1"
'                        End If
'                        If iRound = 1 Then '專利
'                           'Modified by Lydia 2023/08/21 專利原始新案定義統一為101-103(原本NewCasePtyList) ;
'                           stVTB1 = stVTB1 & ", caseprogress WHERE CP44=FC01||'0'" & _
'                                    " and cp01||cp04='CFP00' and cp27+0>19221111 and cp57 is null and cp27+0<=" & strSrvDate(1) & _
'                                    " and instr('101,102,103',cp10)>0 and cp09<'B'" & _
'                                    " group by FC01,FC03"
'                        ElseIf iRound = 2 Then '商標
'                           stVTB1 = stVTB1 & ", caseprogress WHERE CP44=FC01||'0'" & _
'                                    " and cp01||cp04='CFT00' and cp27+0>19221111 and cp57 is null and cp27+0<=" & strSrvDate(1) & _
'                                    " and instr('101',cp10)>0 and cp09<'B'" & _
'                                    " group by FC01,FC03"
'                        End If
'
'                        'FC案件統計
'                        stVTB2 = "select FC01||FC03 B2,count(*) FC_TOT" & _
'                           ",sum(decode(substr(cp05,1,4)," & (mYY + 1911) & "-2,1)) FC_L2" & _
'                           ",sum(decode(substr(cp05,1,4)," & (mYY + 1911) & "-1,1)) FC_L1" & _
'                           ",sum(decode(substr(cp05,1,4)," & (mYY + 1911) & ",decode(sign(substr(cp05,5,2)-6),1,0,1))) FC_C1" & _
'                           ",sum(decode(substr(cp05,1,4)," & (mYY + 1911) & ",decode(sign(substr(cp05,5,2)-6),1,1,0))) FC_C2"
'                        If mStiu = "1" Then   '依互惠名單
'                             stVTB2 = stVTB2 & " From (SELECT DISTINCT FC01,'' FC03 FROM FAGENTCONFIG" & _
'                                     " Where FC06='" & strSysNo & "' AND FC04 = " & mYY & " And FC05 = " & mKind & " And FC01||FC02='" & .Fields("FC01") & "0' ) VTB2"
'                        ElseIf mStiu = "2" Then
'                             stVTB2 = stVTB2 & " From (SELECT fa01 as FC01,'' FC03 FROM FAGENT" & _
'                                     " Where Fa01||Fa02='" & .Fields("FC01") & "0' ) VTB2"
'                        End If
'                        If iRound = 1 Then   '專利
'                           'Modified by Lydia 2023/08/21 專利原始新案定義統一為101-103(原本NewCasePtyList) ;
'                           stVTB2 = stVTB2 & ", patent, caseprogress" & _
'                                    " where pa75=FC01||'0' AND pa01||''='FCP'" & _
'                                    " and cp01(+)=pa01 and cp02(+)=pa02 and cp03(+)=pa03 and cp04(+)=pa04 and cp09<'B'" & _
'                                    " and instr('101,102,103',cp10)>0 and cp57 is null and cp05+0<=" & strSrvDate(1) & _
'                                    " group by FC01,FC03"
'                        ElseIf iRound = 2 Then   '商標
'                           stVTB2 = stVTB2 & ", trademark, caseprogress" & _
'                                    " where tm44=FC01||'0' AND tm01||''='FCT'" & _
'                                    " and cp01(+)=tm01 and cp02(+)=tm02 and cp03(+)=tm03 and cp04(+)=tm04 and cp09<'B'" & _
'                                    " and instr('101',cp10)>0 and cp57 is null and cp05+0<=" & strSrvDate(1) & _
'                                    " group by FC01,FC03"
'                        End If
'
'                        '合併
'                        'C1代理人名稱,C2代理人編號,C3聯絡人資訊,FC_TOT總收案量,CF_TOT總收案量,FC_L2前年度FC收案量,CF_L2前年度CF給案量
'                        'FC_L1去年度FC收案量,CF_L1去年度CF給案量,FC_C1當年度1-6月FC收案量,CF_C1當年度1-6月CF給案量,DIFF_C1當年度1-6月收給差
'                        'FC_C2當年度7-12月FC收案量,CF_C2當年度7-12月CF給案量,DIFF_C2當年度7-12月收給差,FC07該半年度建議CF給案量,FC08備註
'                        strExc(0) = "select NVL(FA05,NVL(FA06,FA04)) C1,FC01||DECODE(FC03,NULL,'','-'||FC03) C2" & _
'                           ",NVL(PCC03,NVL(PCC04,PCC05)) C3,NA03,nvl(FC_TOT,0) as FC_TOT,nvl(CF_TOT,0) as CF_TOT,nvl(FC_L2,0) as FC_L2,nvl(CF_L2,0) CF_L2" & _
'                           ",nvl(FC_L1,0) as FC_L1,nvl(CF_L1,0) as CF_L1,nvl(FC_C1,0) as FC_C1,nvl(CF_C1,0) as CF_C1,nvl(FC_C1,0)-nvl(CF_C1,0) as DIFF_C1,nvl(FC_C2,0) as FC_C2" & _
'                           ",nvl(CF_C2,0) as CF_C2,nvl(FC_C2,0)-nvl(CF_C2,0) as DIFF_C2,FC07,FC08,NA01"
'                        If mStiu = "1" Then '依互惠名單
'                            strExc(1) = strExc(0) & " from (SELECT FC01,'' FC03,'' PCC03,'' PCC04,'' PCC05,SUM(FC07) FC07,MIN(FC08) FC08" & _
'                                  " FROM FAGENTCONFIG where FC06='" & strSysNo & "' AND FC04=" & mYY & " AND FC05=" & mKind & " And FC01||FC02='" & .Fields("FC01") & "0'" & _
'                                  " GROUP BY FC01) X,(" & stVTB1 & ") A,(" & stVTB2 & ") B,FAGENT,NATION where A2(+)=FC01||FC03" & _
'                                  " and B2(+)=FC01||FC03 AND FA01(+)=FC01 AND FA02(+)='0' AND NA01(+)=SUBSTR(FA10,1,3)"
'                        ElseIf mStiu = "2" Then
'                            strExc(1) = strExc(0) & " from (SELECT fa01 as FC01,'' FC03,'' PCC03,'' PCC04,'' PCC05,0 FC07,0 FC08" & _
'                                  " FROM FAGENT where Fa01||Fa02='" & .Fields("FC01") & "0'" & _
'                                  " GROUP BY Fa01) X,(" & stVTB1 & ") A,(" & stVTB2 & ") B,FAGENT,NATION where A2(+)=FC01||FC03" & _
'                                  " and B2(+)=FC01||FC03 AND FA01(+)=FC01 AND FA02(+)='0' AND NA01(+)=SUBSTR(FA10,1,3)"
'                        End If
'                        intI = 1
'                        Set RsTemp = ClsLawReadRstMsg(intI, strExc(1))
'                        If intI = 0 Then
'                              If mStiu = "1" Then
'                                  mStiu = "2" '改成以代理人檔為基準
'                                  GoTo JumpReSum
'                              Else '無資料補0
'                                  wksA93.Range("C" & xRows).Value = "0"
'                                  wksA93.Range("D" & xRows).Value = "0"
'                                  wksA93.Range("E" & xRows).Value = "0"
'                                  wksA93.Range("F" & xRows).Value = "0"
'                                  wksA93.Range("G" & xRows).Value = "0"
'                                  wksA93.Range("H" & xRows).Value = "0"
'                                  wksA93.Range("I" & xRows).Value = "0"
'                                  'wksA93.Range("J" & xRows).Value = "0" '備註空白
'                              End If
'                        Else
'                              RsTemp.MoveFirst
'                              'excel(互惠代理人案件統計表frm050408)
'                              Do While Not RsTemp.EOF
'                                    '代理人名稱(有互惠名單才顯示)
'                                    If mStiu = "1" Then
'                                        wksA93.Range("A" & xRows).Value = "" & RsTemp.Fields("C1")
'                                        strExc(5) = "" & RsTemp.Fields("C1")
'                                    End If
'                                    '代理人編號
'                                    If mStiu = "1" Then
'                                        wksA93.Range("B" & xRows).Value = "" & RsTemp.Fields("C2")
'                                    End If
'                                    '當年度1-6月FC收案量
'                                    wksA93.Range("C" & xRows).Value = "" & RsTemp.Fields("FC_C1")
'                                    '當年度1-6月CF給案量
'                                    wksA93.Range("D" & xRows).Value = "" & RsTemp.Fields("CF_C1")
'                                    '當年度1-6月收給差
'                                    wksA93.Range("E" & xRows).Value = "" & RsTemp.Fields("DIFF_C1")
'                                    '當年度7-12月FC收案量
'                                    wksA93.Range("F" & xRows).Value = "" & RsTemp.Fields("FC_C2")
'                                    '當年度7-12月CF給案量
'                                    wksA93.Range("G" & xRows).Value = "" & RsTemp.Fields("CF_C2")
'                                    '當年度7-12月收給差
'                                    wksA93.Range("H" & xRows).Value = "" & RsTemp.Fields("DIFF_C2")
'                                    '該半年度建議CF給案量
'                                    wksA93.Range("I" & xRows).Value = "" & RsTemp.Fields("FC07")
'                                    '新案數=前一日新的本所案號
'                                    If iRound = 1 Then
'                                        'Modified by Lydia 2019/02/01 改成原始新案數(非原始)
'                                        'wksA93.Range("J5").Value = iCntP
'                                        'Modified by Lydia 2019/02/15 改"1/0"
'                                        'wksA93.Range("J5").Value = iCntP & "(" & iCntP2 & ")"
'                                        wksA93.Range("J5").NumberFormatLocal = "@"
'                                        wksA93.Range("J5").Value = iCntP & "/" & iCntP2
'                                    Else
'                                        'Modified by Lydia 2019/02/01 改成原始新案數(非原始)
'                                        'wksA93.Range("J8").Value = iCntT
'                                        'Modified by Lydia 2019/02/15 改"1/0"
'                                        'wksA93.Range("J8").Value = iCntT & "(" & iCntT2 & ")"
'                                        wksA93.Range("J8").NumberFormatLocal = "@"
'                                        wksA93.Range("J8").Value = iCntT & "/" & iCntT2
'                                    End If
'                                    '備註
'                                    If "" & RsTemp.Fields("FC08") <> "" And "" & RsTemp.Fields("FC08") <> "0" Then
'                                         wksA93.Range("K" & xRows).Value = "" & RsTemp.Fields("FC08")
'                                    End If
'                                    RsTemp.MoveNext
'                              Loop
'                        End If
'    '------------------------------抓當期統計量
'                   Next iRound
'               End If
'
'
'               '新案(email內文)
'               strTemp(0) = "" & convForm(.Fields("cp01") & "-" & .Fields("cp02") & "-" & .Fields("cp03") & "-" & .Fields("cp04"), 15)
'               strTemp(1) = "" & convForm("" & .Fields("fc01"), 8)
'               strTemp(2) = "" & convForm("" & .Fields("casename"), 30)
'               strTemp(3) = "" & convForm("" & .Fields("custname"), 30)
'               strTemp(4) = "" & convForm("" & .Fields("custno"), 9)
'               strCaseDetail = strCaseDetail & strTemp(0) & " " & strTemp(3) & " " & strTemp(4) & ";"
'               If Right("" & .Fields("cp01"), 1) = "T" Then
'                    'Modified by Lydia 2019/02/01 判斷原始新案之性質
'                    'iCntT = iCntT + 1
'                    If InStr(cNewT, "" & .Fields("cp10")) > 0 Then
'                        iCntT = iCntT + 1
'                    Else
'                        iCntT2 = iCntT2 + 1
'                    End If
'                    'end 2019/02/01
'               Else
'                    'Modified by Lydia 2019/02/01 判斷原始新案之性質
'                    'iCntP = iCntP + 1
'                    If InStr(cNewP, "" & .Fields("cp10")) > 0 Then
'                        iCntP = iCntP + 1
'                    Else
'                        iCntP2 = iCntP2 + 1
'                    End If
'                    'end 2019/02/01
'               End If
'               '依代理人
'               strGrp = "" & .Fields("FC01")
'               strGrpNa01 = "" & .Fields("na01") 'Added by Lydia 2021/09/11
'               .MoveNext
'           Loop
'       End If
'   End With
'
'   'Modified by Lydia 2019/02/01 改成原始新案數(非原始)
'   'If iCntP > 0 Or iCntT > 0 Then
'   '    新案數=前一日新的本所案號
'   '     wksA93.Range("J5").Value = iCntP
'   '     wksA93.Range("J8").Value = iCntT
'   If iCntP > 0 Or iCntT > 0 Or iCntP2 > 0 Or iCntT2 > 0 Then
'        '新案數=前一日新的本所案號
'        'Modified by Lydia 2019/02/15 改"1/0"
'        'wksA93.Range("J5").Value = iCntP & "(" & iCntP2 & ")"
'        'wksA93.Range("J8").Value = iCntT & "(" & iCntT2 & ")"
'        wksA93.Range("J5").NumberFormatLocal = "@"
'        wksA93.Range("J5").Value = iCntP & "/" & iCntP2
'        wksA93.Range("J8").NumberFormatLocal = "@"
'        wksA93.Range("J8").Value = iCntT & "/" & iCntT2
'        'end 2019/02/15
'        'Added by Lydia 2019/02/01 增加備註-原始新案數
'        'Modified by Lydia 2019/02/15 改備註
'        'wksA93.Range("A10").Value = "Note 1: 給案量／收案量之定義為原始新案：專利101-103；商標101"
'        'wksA93.Range("A10").Interior.ColorIndex = 6
'        'wksA93.Range("A11").Value = "Note 2: 新案數之定義為前一工作日之FCP/FCT給案量，如為原始新案以外之案件性質則另以( )呈現。例如專利收2件新案，1件為101-103、另一件101-103以外之案件性質，則以""1(1)""呈現以茲區別。"
'        'wksA93.Range("A11").Interior.ColorIndex = 6
'        'wksA93.Range("A11").WrapText = True
'   'end 2019/02/01
'        wksA93.Range("A10").Value = "Note : 原始新案定義為專利101-103、商標101"
'        wksA93.Range("A10").Interior.ColorIndex = 6
'
'
'        '判斷若版本2007以上改變存檔格式
'        If Val(xlsPoint.Version) < 12 Then
'          xlsPoint.Workbooks(1).SaveAs FileName:=strPath, FileFormat:=-4143
'        Else
'          xlsPoint.Workbooks(1).SaveAs FileName:=strPath, FileFormat:=56
'        End If
'        xlsPoint.Workbooks.Close
'        xlsPoint.Quit
'        Set xlsPoint = Nothing
'        Set wksA93 = Nothing
'        Sleep 100
'        '收件人：國外部主管+專利/商標案主管
'        'Added by Lydia 2021/09/11 外專通知人員區分日本區
'        If strGrpNa01 = "011" Then
'             strExc(1) = strToA & strToP_J & strToT & IIf(InStr(strCaseDetail, "CFP") > 0 Or InStr(strCaseDetail, "FCP") > 0, strToP1, "")
'        Else
'        'end 2021/09/11
'             strExc(1) = strToA & strToP & strToT & IIf(InStr(strCaseDetail, "CFP") > 0 Or InStr(strCaseDetail, "FCP") > 0, strToP1, "")
'        End If 'Added by Lydia 2021/09/11
'        'Added by Lydia 2023/06/05 內專主管加發副本
'        strExc(6) = ""
'        If InStr(strCaseDetail, "CFP") > 0 Or InStr(strCaseDetail, "FCP") > 0 Then
'           strExc(6) = strExc(6) & ";" & strToP1cc
'        End If
'        'end 2023/06/05
'        strExc(2) = vbCrLf & "請參考附件，新增案號資料如下列：" & vbCrLf & vbCrLf & _
'                          convForm("本所案號", 16) & convForm("客戶名稱", 31) & convForm("客戶編號", 9) & vbCrLf
'        tmpArr = Empty
'        tmpArr = Split(strCaseDetail, ";")
'        For intI = 0 To UBound(tmpArr)
'             If Trim(tmpArr(intI)) <> "" Then
'                 strExc(2) = strExc(2) & tmpArr(intI) & vbCrLf  '內文：列出新案
'             End If
'        Next
'        'Modified by Lydia 2021/09/11 CC江協理(外商主管)
'        'SendMAPIMail Mid(strExc(1), 1, Len(strExc(1)) - 1), strSrvDate(2) & "_" & TempFileName & "_" & strGrp & " " & strExc(5), strExc(2), strPath
'        'Modified by Lydia 2023/06/05 內專主管加發副本strexc(6)
'        'Modified by Lydia 2023/06/09 判斷收件者的清單尾端
'        'SendMAPIMail Mid(strExc(1), 1, Len(strExc(1)) - 1), strSrvDate(2) & "_" & TempFileName & "_" & strGrp & " " & strExc(5), strExc(2), strPath, , , "98020" & strExc(6)
'        If Right(strExc(1), 1) = ";" Then strExc(1) = Mid(strExc(1), 1, Len(strExc(1)) - 1)
'        SendMAPIMail strExc(1), strSrvDate(2) & "_" & TempFileName & "_" & strGrp & " " & strExc(5), strExc(2), strPath, , , "98020" & strExc(6)
'   End If
'   Set rsAD = Nothing
'   Exit Sub
'
'DebugErr:
'   If Err.Number <> 0 Then
'      Set rsAD = Nothing
'      WLog "互惠名單往來通知:" & Err.Description
'   End If
'End Sub
''end 2018/09/18

'Added by Lydia 2018/06/21 互惠名單委案通知=>2023/09/12 調整表格,另外SQL與frm050408共用模組取得
Sub StrMenu93()
Dim rsAD As ADODB.Recordset
Dim rsRD As ADODB.Recordset
Dim TempFileName As String, strTitle() As String
Dim tmpArr1 As Variant, stDate1 As String
Dim MaxCols As Integer '最大行(欄)位置
Dim xRows As Integer '目前列位置
Dim xlsPoint As New Excel.Application
Dim wksA93 As New Worksheet
Dim intJ As Integer, iRow As Integer
Dim strPath As String
Dim strGrp As String '代理人
Dim strCaseDetail As String '新案列表: 新案案號, 新案名稱, 申請人英文名稱,申請人編號
Dim strToA As String '國外部主管+業拓
Dim strToP As String, strToP_J As String  '外專通知人員: 英文組、日文組
Dim strToT As String '外商通知人員
Dim strGrpNa01 As String '代理人/客戶國籍
Dim strToP1 As String, strToP1cc As String '內專主管、內專主管CC
Dim mYY As String, mKind As String '年度, 期間(1-上半年,2-下半年)
Dim stVTB1 As String, stVTB2 As String
Dim strSumP(1 To 4) As String  '專利新案數統計: 1-FCP狹義,2-FCP廣義; 3-CFP狹義,4-CFP廣義
Dim strSumT(1 To 4) As String  '商標新案數統計: 1-FCT狹義,2-FCT廣義; 3-CFT狹義,4-CFT廣義
Dim cNewP As String, cNewT As String '狹義新案之性質
Dim strORD1 As String 'Added by Lydia 2023/12/14 代理人互惠設定: 1-專利, 2-商標
Dim strConPA As String, strConTM As String 'Added by Lydia 2024/06/04 專利/商標的廣義新案性質
On Error GoTo DebugErr
    
    TempFileName = "互惠名單往來通知"
    strPath = App.path & TextPath & TempFileName & ".xls"
    If Dir(strPath) <> "" Then
       Kill strPath
    End If
    cNewP = "101,102,103"
    cNewT = "101,"
    
    '設定抬頭為3行 ; (專利)B1=FCP,B2=CFP,B3=FCP-CFP ; C1~C2 (若B1=專利,C1~C3為商標)
    MaxCols = 12
    ReDim strTitle(1 To MaxCols) As String
    '(位置改用index計算)第1行~第3行|欄寬
    strTitle(1) = "空白|代理人名稱|空白|32"
    strTitle(2) = "空白|代理人編號|空白|12"
    strTitle(3) = "當年度1-6月|B1|C1|17"
    strTitle(4) = "當年度1-6月|B2|C2|17"
    strTitle(5) = "當年度1-6月|B3|C3|17"
    strTitle(6) = "當年度7-12月|B1|C1|17"
    strTitle(7) = "當年度7-12月|B2|C2|17"
    strTitle(8) = "當年度7-12月|B3|C3|17"
    strTitle(9) = "該半年度建議|B2|空白|17"
    strTitle(10) = "前一工作日之|B1狹義/廣義新案數|C1狹義/廣義新案數|23"
    strTitle(11) = "前一工作日之|B2狹義/廣義新案數|C2狹義/廣義新案數|23"
    strTitle(12) = "空白|備註|空白|17"

   stDate1 = CompWorkDay(2, strSrvDate(1), 1)
   
   mYY = Val(Mid(stDate1, 1, 4)) - 1911
   '期間(1-6月上半年,7-12月下半年)
   If Val(Mid(stDate1, 5, 2)) > 6 Then
       mKind = "2"
   Else
       mKind = "1"
   End If
    
   '專利案
   strExc(1) = ", decode(pa09,'000',nvl(pa06,nvl(pa05,pa07)),nvl(pa05,nvl(pa06,pa07))) as casename, decode(pa09,'000'," & _
                                "decode(cu05,null,nvl(cu04,cu06),cu05||' '||cu88||' '||cu89||' '||cu90), " & _
                                    "nvl(cu04,decode(cu05,null,cu06,cu05||' '||cu88||' '||cu89||' '||cu90))) as custname, "
   '商標案
   strExc(2) = ", tm05 as casename, decode(tm10,'000'," & _
                                "decode(cu05,null,nvl(cu04,cu06),cu05||' '||cu88||' '||cu89||' '||cu90), " & _
                                    "nvl(cu04,decode(cu05,null,cu06,cu05||' '||cu88||' '||cu89||' '||cu90))) as custname, "
   'Modified by Lydia 2024/02/06 (1/31)專利案加抓P案，商標加抓T案
   'Modified by Lydia 2024/02/06 增加「關聯編號的案件往來須做電郵通知」的設定
'   strSql = "select '1' as ord1, cp01,cp02,cp03,cp04,fc01 " & strExc(1) & " pa26 as custno,CP10,na01 " & _
'               "From (SELECT DISTINCT FC01,'' FC03, substr(fa10,1,3) na01 FROM FAGENTCONFIG,fagent Where FC06='CFP' AND FC04=" & mYY & " And FC05=" & mKind & " and fc01=fa01(+) and fc02=fa02(+) ) VTB1,caseprogress,patent,customer " & _
'               "WHERE CP44=FC01||'0' and cp01||cp04='CFP00' and cp57 is null and cp27=" & stDate1 & " and cp31='Y' " & _
'               "and cp01=pa01(+) and cp02=pa02(+) and cp03=pa03(+) and cp04=pa04(+) " & _
'               "and substr(pa26,1,8)=cu01(+) and substr(pa26,9,1)=cu02(+) "
'   strSql = strSql & "union select '1' as ord1, cp01,cp02,cp03,cp04,fc01 " & strExc(1) & " pa26 as custno,CP10,na01 " & _
'               "from (select DISTINCT FC01,'' FC03, substr(fa10,1,3) na01 from FAGENTCONFIG,fagent where FC06='CFP' AND FC04=" & mYY & " And FC05=" & mKind & " and fc01=fa01(+) and fc02=fa02(+) ) VTB2,patent,caseprogress,customer " & _
'               "where pa75=FC01||'0' AND pa01||''='FCP' and cp57 is null and cp05=" & stDate1 & " and cp31='Y' " & _
'               "and cp01(+)=pa01 and cp02(+)=pa02 and cp03(+)=pa03 and cp04(+)=pa04 " & _
'               "and substr(pa26,1,8)=cu01(+) and substr(pa26,9,1)=cu02(+) "
'   strSql = strSql & "union select '2' as ord1, cp01,cp02,cp03,cp04,fc01 " & strExc(2) & " tm23 as custno,CP10,na01 " & _
'               "From (SELECT DISTINCT FC01,'' FC03, substr(fa10,1,3) na01 FROM FAGENTCONFIG,fagent Where FC06='CFT' AND FC04=" & mYY & " And FC05=" & mKind & " and fc01=fa01(+) and fc02=fa02(+) ) VTB1,caseprogress,trademark,customer " & _
'               "WHERE CP44=FC01||'0' and cp01||cp04='CFT00' and cp57 is null and cp27=" & stDate1 & " and cp31='Y' " & _
'               "and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+) " & _
'               "and substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+) "
'   strSql = strSql & "union select '2' as ord1, cp01,cp02,cp03,cp04,fc01 " & strExc(2) & " tm23 as custno,CP10,na01 " & _
'               "from (select DISTINCT FC01,'' FC03, substr(fa10,1,3) na01  from FAGENTCONFIG,fagent where FC06='CFT' AND FC04=" & mYY & " And FC05=" & mKind & " and fc01=fa01(+) and fc02=fa02(+) ) VTB2,caseprogress,trademark,customer " & _
'               "where tm44=FC01||'0' AND tm01||''='FCT' and cp57 is null and cp05=" & stDate1 & " and cp31='Y' " & _
'               "and cp01(+)=tm01 and cp02(+)=tm02 and cp03(+)=tm03 and cp04(+)=tm04 " & _
'               "and substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+) "
   'Modified by Lydia 2024/06/04 配合Excel內容若新案收文性質不在廣義新案範圍內就不用自動通知。=> and (instr('" & NewCasePtyList & "', cp10) > 0 or cp10 like '3%') and cp09<'B'
   'Modified by Lydia 2024/08/09  P案的台灣案判斷PA75+收文日，非台灣案判斷CP44+發文日; and cp01||cp04='CFP00'=>  and (cp01||cp04='CFP00' or (cp01='P' and pa09<>'000'))
   strSql = "select '1' as ord1, cp01,cp02,cp03,cp04,fc01,cp44 as dm01 " & strExc(1) & " pa26 as custno,CP10,na01 " & _
               "From (SELECT DISTINCT FC01,'' FC03, substr(fa10,1,3) na01,decode(fc18,'Y',substr(fc01,1,6),null) as fc01d FROM FAGENTCONFIG,fagent Where FC06='CFP' AND FC04=" & mYY & " And FC05=" & mKind & " and fc01=fa01(+) and fc02=fa02(+) ) VTB1,caseprogress,patent,customer " & _
               "WHERE substr(CP44,9,1)='0' and (cp01||cp04='CFP00' or (cp01='P' and pa09<>'000')) and (cp44=fc01||'0' or (fc01d is not null and substr(cp44,1,6)=fc01d)) and cp57 is null and cp27=" & stDate1 & " and cp31='Y' " & _
               "and cp01=pa01(+) and cp02=pa02(+) and cp03=pa03(+) and cp04=pa04(+) and (instr('" & NewCasePtyList & "', cp10) > 0 or cp10 like '3%') and cp09<'B' " & _
               "and substr(pa26,1,8)=cu01(+) and substr(pa26,9,1)=cu02(+) "
   'Modified by Lydia 2024/06/04 配合Excel內容若新案收文性質不在廣義新案範圍內就不用自動通知。=>and (instr('" & NewCasePtyList & "', cp10) > 0 or cp10 like '3%') and cp09<'B'
   'Modified by Lydia 2024/08/09  P案的台灣案判斷PA75+收文日，非台灣案判斷CP44+發文日;AND (pa01||''='FCP' or pa01||''='P')=>
   strSql = strSql & "union select '1' as ord1, cp01,cp02,cp03,cp04,fc01,pa75 as dm01 " & strExc(1) & " pa26 as custno,CP10,na01 " & _
               "from (select DISTINCT FC01,'' FC03, substr(fa10,1,3) na01,decode(fc18,'Y',substr(fc01,1,6),null) as fc01d from FAGENTCONFIG,fagent where FC06='CFP' AND FC04=" & mYY & " And FC05=" & mKind & " and fc01=fa01(+) and fc02=fa02(+) ) VTB2,patent,caseprogress,customer " & _
               "where substr(pa75,9,1)='0' AND (pa01||''='FCP' or (pa01='P' and pa09='000')) and (pa75=fc01||'0' or (fc01d is not null and substr(pa75,1,6)=fc01d)) and cp57 is null and cp05=" & stDate1 & " and cp31='Y' " & _
               "and cp01(+)=pa01 and cp02(+)=pa02 and cp03(+)=pa03 and cp04(+)=pa04 and (instr('" & NewCasePtyList & "', cp10) > 0 or cp10 like '3%') and cp09<'B' " & _
               "and substr(pa26,1,8)=cu01(+) and substr(pa26,9,1)=cu02(+) "
   'Modified by Lydia 2024/06/04 配合Excel內容若新案收文性質不在廣義新案範圍內就不用自動通知。=>and instr('101', cp10) > 0 and cp09<'B'
   strSql = strSql & "union select '2' as ord1, cp01,cp02,cp03,cp04,fc01,cp44 as dm01 " & strExc(2) & " tm23 as custno,CP10,na01 " & _
               "From (SELECT DISTINCT FC01,'' FC03, substr(fa10,1,3) na01,decode(fc18,'Y',substr(fc01,1,6),null) as fc01d FROM FAGENTCONFIG,fagent Where FC06='CFT' AND FC04=" & mYY & " And FC05=" & mKind & " and fc01=fa01(+) and fc02=fa02(+) ) VTB1,caseprogress,trademark,customer " & _
               "WHERE substr(CP44,9,1)='0' and cp01||cp04='CFT00' and (cp44=fc01||'0' or (fc01d is not null and substr(cp44,1,6)=fc01d)) and cp57 is null and cp27=" & stDate1 & " and cp31='Y' " & _
               "and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+) and instr('101', cp10) > 0 and cp09<'B' " & _
               "and substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+) "
   'Modified by Lydia 2024/06/04 配合Excel內容若新案收文性質不在廣義新案範圍內就不用自動通知。=>and instr('101', cp10) > 0 and cp09<'B'
   strSql = strSql & "union select '2' as ord1, cp01,cp02,cp03,cp04,fc01,tm44 as dm01 " & strExc(2) & " tm23 as custno,CP10,na01 " & _
               "from (select DISTINCT FC01,'' FC03, substr(fa10,1,3) na01,decode(fc18,'Y',substr(fc01,1,6),null) as fc01d  from FAGENTCONFIG,fagent where FC06='CFT' AND FC04=" & mYY & " And FC05=" & mKind & " and fc01=fa01(+) and fc02=fa02(+) ) VTB2,caseprogress,trademark,customer " & _
               "where substr(tm44,9,1)='0' AND (tm01||''='FCT' or tm01||''='T') and (tm44=fc01||'0' or (fc01d is not null and substr(tm44,1,6)=fc01d)) and cp57 is null and cp05=" & stDate1 & " and cp31='Y' " & _
               "and cp01(+)=tm01 and cp02(+)=tm02 and cp03(+)=tm03 and cp04(+)=tm04 and instr('101', cp10) > 0 and cp09<'B' " & _
               "and substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+) "
'end 2024/02/06
   '依代理人排序
   strSql = strSql & "order by fc01,ord1,cp01,cp02 "
   intI = 1
   Set rsAD = ClsLawReadRstMsg(intI, strSql)
   If intI = 1 Then
   '******各單位主管******
      '國外互惠新案收文通知名單(業拓), (2022/12/06) 先暫時取消國外部主管=O
      'Modified by Lydia 2025/08/07 因為114/4/16改成共用信箱而非人員編號
      'strSql = "select st01 from setspecman, staff where ocode='國外互惠新案收文通知名單' and instr(oman, st01) > 0  and st04='1' "
      'strSql = strSql & " order by 1 "
      'intI = 1
      'Set RsTemp = ClsLawReadRstMsg(intI, strSql)
      'If intI = 1 Then strToA = RsTemp.GetString(adClipString, , , ",")
      'strToA = Replace(Replace(strToA, ",,", ","), ",", ";")
      strToA = Pub_GetSpecMan("國外互惠新案收文通知名單") & ";"
      'end 2025/08/07
      
      
      '專利主管=外專互惠新案收文通知名單F21("R","S","T","T1")+外專互惠新案收文通知名單F23(F23部門之A0908)+為CFP/FCP案(專利案)
      strSql = "Select St01 From Setspecman, Staff Where Ocode='外專互惠新案收文通知名單F21' And Instr(Oman, St01) > 0  And St04='1' And St16 <> '3' "
      strSql = strSql & "union select st01 from setspecman, staff where ocode='外專互惠新案收文通知名單F23' and instr(oman, st01) > 0  and st04='1' and st16 <> '2' "
      strSql = strSql & " order by st01 "
      intI = 1
      Set RsTemp = ClsLawReadRstMsg(intI, strSql)
      If intI = 1 Then strToP = RsTemp.GetString(adClipString, , , ",")
      strToP = Replace(Replace(strToP, ",,", ","), ",", ";")
      
      '外專通知人員: 日文組
      strSql = "Select St01 From Setspecman, Staff Where Ocode='外專互惠新案收文通知名單F21' And Instr(Oman, St01) > 0  And St04='1' And St16 = '3' "
      strSql = strSql & "union select st01 from setspecman, staff where ocode='外專互惠新案收文通知名單F23' and instr(oman, st01) > 0  and st04='1' and st16 = '2' "
      strSql = strSql & " order by st01 "
      intI = 1
      Set RsTemp = ClsLawReadRstMsg(intI, strSql)
      If intI = 1 Then strToP_J = RsTemp.GetString(adClipString, , , ",")
      strToP_J = Replace(Replace(strToP_J, ",,", ","), ",", ";")

      '外商互惠新案收文通知名單F11(外商主管)
      strSql = "Select St01 From Setspecman, Staff Where Ocode='外商互惠新案收文通知名單F11' And Instr(Oman, St01) > 0  And St04='1' order by st01 "
      intI = 1
      Set RsTemp = ClsLawReadRstMsg(intI, strSql)
      If intI = 1 Then strToT = RsTemp.GetString(adClipString, , , ",")
      strToT = Replace(Replace(strToT, ",,", ","), ",", ";")

      '新案為CFP/FCP案(專利案)，加送內專主管(2023/06/05原抓P10之A0908)改發79075,副本73022)
      strToP1 = "79075"
      strToP1cc = pub_PMan 'Modified by Morgan 2025/2/20 73022->pub_PMan
   '******各單位主管******
      rsAD.MoveFirst
      Do While Not rsAD.EOF
         '依代理人
         If strGrp <> "" & rsAD.Fields("FC01") Then
            '----------excel存檔，並且email
            If strGrp <> "" Then
               'Modified by Lydia 2023/12/14 +strORD1
               Call StrMenu93_XlsEnd(xlsPoint, wksA93, xRows, TempFileName, strPath, strORD1, strCaseDetail, strGrpNa01, strSumP, strSumT, strToA, strToP, strToP_J, strToT, strToP1, strToP1cc)
            End If
            '----------excel存檔，並且email
            strGrp = "" & rsAD.Fields("FC01")
            strORD1 = "" & rsAD.Fields("ORD1")  'Added by Lydia 2023/12/14
            xRows = 0
            strCaseDetail = ""
            For intI = 1 To UBound(strSumP)
               strSumP(intI) = "0"
               strSumT(intI) = "0"
            Next intI
            If Dir(strPath) <> "" Then
              Kill strPath
            End If
            xlsPoint.SheetsInNewWorkbook = 1 '預設工作表數目
            xlsPoint.Workbooks.add
            Set wksA93 = xlsPoint.Worksheets(1)
            xlsPoint.ActiveWindow.Zoom = 80 '顯示縮小到80%
            wksA93.PageSetup.Orientation = xlLandscape '橫印
            wksA93.Range("E1").Value = TempFileName
            wksA93.Range("A2").Value = "列印日期："
            wksA93.Range("B2").Value = ChangeTStringToTDateString(strSrvDate(2))
            xRows = 3
            wksA93.Range("A5:L5").Interior.ColorIndex = 15  '表頭中間欄位底色:灰
            '欄位抬頭
            For intI = 1 To MaxCols
               strExc(4) = Replace(strTitle(intI), "@", vbCrLf)
               If "" & rsAD.Fields("ORD1") = "1" Then '專利為主
                  strExc(4) = Replace(Replace(Replace(strExc(4), "B1", "FCP"), "B2", "CFP"), "B3", "FCP-CFP")
                  strExc(4) = Replace(Replace(Replace(Replace(strExc(4), "C1", "FCT"), "C2", "CFT"), "C3", "FCT-CFT"), "B2", "CFP")
               ElseIf "" & rsAD.Fields("ORD1") = "2" Then '商標為主
                  strExc(4) = Replace(Replace(Replace(strExc(4), "B1", "FCT"), "B2", "CFT"), "B3", "FCT-CFT")
                  strExc(4) = Replace(Replace(Replace(Replace(strExc(4), "C1", "FCP"), "C2", "CFP"), "C3", "FCP-CFP"), "B2", "CFT")
               End If
               tmpArr1 = Empty
               tmpArr1 = Split(strExc(4), "|")
               strExc(3) = Pub_NumberToSystem26(intI)  '(位置改用index計算)
               iRow = xRows
               For intJ = 0 To UBound(tmpArr1)
                 If intJ < 3 Then
                    If intJ = 0 Then
                       wksA93.Range(strExc(3) & ":" & strExc(3)).Font.Name = "微軟正黑體"
                    End If
                    iRow = iRow + 1
                    strCon1 = Trim(Replace(tmpArr1(intJ), "空白", ""))
                    wksA93.Range(strExc(3) & iRow).Value = IIf(strCon1 = "M", "", strCon1)
                 ElseIf intJ = 3 Then '欄寬
                    wksA93.Range(strExc(3) & ":" & strExc(3)).ColumnWidth = Val("" & tmpArr1(intJ))
                    '置中
                    xlsPoint.Range(strExc(3) & iRow - 2 & ":" & strExc(3) & iRow).Select
                    With xlsPoint.Selection
                       .HorizontalAlignment = xlCenter
                       .VerticalAlignment = xlCenter
                    End With
                 End If
               Next intJ
            Next intI
            wksA93.Range(Pub_NumberToSystem26(MaxCols) & ":" & Pub_NumberToSystem26(MaxCols)).WrapText = False   '備註不自動換列
            
            xRows = 7
            strSql = "delete from R050408_2023 where id='QPGMR' "
            cnnConnection.Execute strSql
            '抓互惠代理人統計量
            Call Pub_GetFCfrm050408("QPGMR", "" & rsAD.Fields("ORD1"), "0", mYY, mKind, True, "" & rsAD.Fields("FC01"))
            Call Pub_GetSqlfrm050408("QPGMR", "" & rsAD.Fields("ORD1"), "0", mYY, mKind, True, stVTB1, stVTB2, stDate1)
            '互惠案件類別(專利/商標)
            strExc(2) = "INSERT INTO R050408_2023 (ID,KIND,AN1,AN2,NA01,C1,C2,C3,NA03,FC_TOT,CF_TOT,FC_L2,CF_L2,FC_L1,CF_L1,FC_C1,CF_C1,DIFF01,FC_C2,CF_C2,DIFF02,FC07,FC08,FC16,FC17DEPT,FC17NAME) "
            strExc(1) = Mid(stVTB1, 1, InStr(UCase(stVTB1), "ORDER") - 1)
            strSql = strExc(2) & Replace(strExc(1), "SELECT NVL(FA05,NVL(FA06,FA04))", "SELECT 'QPGMR','" & IIf("" & rsAD.Fields("ORD1") = "1", "CFP", "CFT") & "','0', ROWSEQ, SUBSTR(NA01,1,3) NA01, NVL(FA05,NVL(FA06,FA04))")
            cnnConnection.Execute strSql, intI
            '2.另一種案件類別(商標/專利)
            strExc(1) = Mid(stVTB2, 1, InStr(UCase(stVTB2), "ORDER") - 1)
            strSql = strExc(2) & Replace(strExc(1), "SELECT NVL(FA05,NVL(FA06,FA04))", "SELECT 'QPGMR','" & IIf("" & rsAD.Fields("ORD1") = "1", "CFT", "CFP") & "','0', ROWSEQ, SUBSTR(NA01,1,3) NA01, NVL(FA05,NVL(FA06,FA04))")
            cnnConnection.Execute strSql, intI
            '---關聯企業
            Call Pub_GetFCfrm050408("QPGMR", "" & rsAD.Fields("ORD1"), "1", mYY, mKind, True, "" & rsAD.Fields("FC01"))
            Call Pub_GetSqlfrm050408("QPGMR", "" & rsAD.Fields("ORD1"), "1", mYY, mKind, True, stVTB1, stVTB2, stDate1)
            strExc(1) = Mid(stVTB1, 1, InStr(UCase(stVTB1), "ORDER") - 1)
            strSql = strExc(2) & Replace(strExc(1), "SELECT NVL(FA05,NVL(FA06,FA04))", "SELECT 'QPGMR','" & IIf("" & rsAD.Fields("ORD1") = "1", "CFP", "CFT") & "','1', ROWSEQ, SUBSTR(NA01,1,3) NA01, NVL(FA05,NVL(FA06,FA04))")
            cnnConnection.Execute strSql, intI
            strExc(1) = Mid(stVTB2, 1, InStr(UCase(stVTB2), "ORDER") - 1)
            strSql = strExc(2) & Replace(strExc(1), "SELECT NVL(FA05,NVL(FA06,FA04))", "SELECT 'QPGMR','" & IIf("" & rsAD.Fields("ORD1") = "1", "CFT", "CFP") & "','1', ROWSEQ, SUBSTR(NA01,1,3) NA01, NVL(FA05,NVL(FA06,FA04))")
            cnnConnection.Execute strSql, intI
                
            strExc(0) = "SELECT C1,C2,FC_C1,CF_C1,DIFF01,FC_C2,CF_C2,DIFF02,FC07,FC08,KIND,AN2,NA01 " & _
                        "FROM R050408_2023 WHERE ID='QPGMR' ORDER BY TO_NUMBER(AN1) ASC ,TO_NUMBER(AN2) ASC,C2 ASC,DECODE(KIND," & CNULL(IIf("" & rsAD.Fields("ORD1") = "1", "CFP", "CFT")) & ",'1','2') ASC"
            intI = 1
            Set rsRD = ClsLawReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               ReDim tmpArr1(1 To MaxCols)
               strExc(3) = Pub_NumberToSystem26(MaxCols)
               rsRD.MoveFirst
               Do While Not rsRD.EOF
                  iRow = 0
                  For intJ = 1 To MaxCols
                     If xRows Mod 2 = 0 And InStr("01,02,12", Format(intJ, "00")) > 0 Then    '基本資料只在第一行(奇數)顯示
                         tmpArr1(intJ) = ""
                         iRow = iRow + 1
                     ElseIf InStr("10,11", Format(intJ, "00")) > 0 Then '排除另外計算欄位
                         tmpArr1(intJ) = ""
                     ElseIf intJ >= 3 And intJ <= 9 Then '數值
                         tmpArr1(intJ) = Val("" & rsRD.Fields(iRow))
                         iRow = iRow + 1
                     Else
                         tmpArr1(intJ) = "" & rsRD.Fields(iRow)
                         iRow = iRow + 1
                     End If
                     If xRows = 7 Then '互惠第一行(奇數)資料底色設為灰色
                         wksA93.Range("A" & xRows & ":" & strExc(3) & xRows).Interior.ColorIndex = 15    '底色:灰
                     ElseIf xRows Mod 2 = 1 Then  '關聯企業
                         wksA93.Range("A" & xRows & ":" & strExc(3) & xRows).Interior.ColorIndex = 35    '底色:綠色
                     End If
                  Next intJ
                  wksA93.Range("A" & xRows & ":" & strExc(3) & xRows).Value = tmpArr1
                  '當儲存格格式為通用格式，選取儲存格的值再代入到選取的儲存格=>自動化為數值欄位
                  wksA93.Range("C" & xRows & ":" & strExc(3) & xRows).Value = wksA93.Range("C" & xRows & ":" & strExc(3) & xRows).Value
                  wksA93.Range("B" & xRows & ":" & Pub_NumberToSystem26(MaxCols - 1) & xRows).HorizontalAlignment = xlCenter '代理人編號+數值置中
                  '前一日狹義/廣義新案數
                  If (xRows Mod 2 = 1 And "" & rsAD.Fields("ORD1") = "1") Or (xRows Mod 2 = 0 And "" & rsAD.Fields("ORD1") = "2") Then    '專利
                     'FC案
                     'Modified by Lydia 2024/08/09  P案的台灣案判斷PA75+收文日，非台灣案判斷CP44+發文日; and cp01='FCP'=> and (cp01='FCP' or (cp01='P' and pa09='000'))
                     strExc(5) = "select sum(decode(instr('" & cNewP & "',cp10),0,0,1)) tot1, count(*) tot2 from caseprogress,patent " & _
                                 "WHERE pa75='" & ChangeCustomerL(rsRD.Fields("C2")) & "' and (cp01='FCP' or (cp01='P' and pa09='000')) and cp57 is null and cp05=" & stDate1 & " and cp31='Y' " & _
                                 "and (instr('" & NewCasePtyList & "', cp10) > 0 or cp10 like '3%') and cp09<'B' " & _
                                 "and cp01=pa01(+) and cp02=pa02(+) and cp03=pa03(+) and cp04=pa04(+) "
                     intJ = 1
                     Set RsTemp = ClsLawReadRstMsg(intJ, strExc(5))
                     If intJ = 1 Then
                        strSumP(1) = Val(strSumP(1)) + Val("" & RsTemp.Fields("tot1"))
                        strSumP(2) = Val(strSumP(2)) + Val("" & RsTemp.Fields("tot2"))
                        wksA93.Range(Pub_NumberToSystem26(10) & xRows).NumberFormat = "@"
                        wksA93.Range(Pub_NumberToSystem26(10) & xRows).Value = Val("" & RsTemp.Fields("tot1")) & "/" & Val("" & RsTemp.Fields("tot2"))
                     End If
                     'CF案
                      'Modified by Lydia 2024/08/09  P案的台灣案判斷PA75+收文日，非台灣案判斷CP44+發文日; and cp01||cp04='CFP00=> and (cp01||cp04='CFP00' or (cp01='P' and pa09<>'000'))
                     strExc(5) = "select sum(decode(instr('" & cNewP & "',cp10),0,0,1)) tot1, count(*) tot2 from caseprogress,patent " & _
                                 "WHERE cp44='" & ChangeCustomerL(rsRD.Fields("C2")) & "' and (cp01||cp04='CFP00' or (cp01='P' and pa09<>'000')) and cp57 is null and cp27=" & stDate1 & " and cp31='Y' " & _
                                 "and (instr('" & NewCasePtyList & "', cp10) > 0 or cp10 like '3%') and cp09<'B' " & _
                                 "and cp01=pa01(+) and cp02=pa02(+) and cp03=pa03(+) and cp04=pa04(+) "
                     intJ = 1
                     Set RsTemp = ClsLawReadRstMsg(intJ, strExc(5))
                     If intJ = 1 Then
                        strSumP(3) = Val(strSumP(3)) + Val("" & RsTemp.Fields("tot1"))
                        strSumP(4) = Val(strSumP(4)) + Val("" & RsTemp.Fields("tot2"))
                        wksA93.Range(Pub_NumberToSystem26(11) & xRows).NumberFormat = "@"
                        wksA93.Range(Pub_NumberToSystem26(11) & xRows).Value = Val("" & RsTemp.Fields("tot1")) & "/" & Val("" & RsTemp.Fields("tot2"))
                     End If
                  Else   '商標
                     'FC案
                     strExc(5) = "select sum(decode(instr('" & cNewT & "',cp10),0,0,1)) tot1, count(*) tot2 from caseprogress,trademark " & _
                                 "WHERE tm44='" & ChangeCustomerL(rsRD.Fields("C2")) & "' and cp01='FCT' and cp57 is null and cp05=" & stDate1 & " and cp31='Y' " & _
                                 "and instr('101', cp10) > 0 and cp09<'B' " & _
                                 "and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+) "
                     intJ = 1
                     Set RsTemp = ClsLawReadRstMsg(intJ, strExc(5))
                     If intJ = 1 Then
                        strSumT(1) = Val(strSumT(1)) + Val("" & RsTemp.Fields("tot1"))
                        strSumT(2) = Val(strSumT(2)) + Val("" & RsTemp.Fields("tot2"))
                        wksA93.Range(Pub_NumberToSystem26(10) & xRows).NumberFormat = "@"
                        wksA93.Range(Pub_NumberToSystem26(10) & xRows).Value = Val("" & RsTemp.Fields("tot1")) & "/" & Val("" & RsTemp.Fields("tot2"))
                     End If
                     'CF案
                     strExc(5) = "select sum(decode(instr('" & cNewT & "',cp10),0,0,1)) tot1, count(*) tot2 from caseprogress,trademark " & _
                                 "WHERE cp44='" & ChangeCustomerL(rsRD.Fields("C2")) & "' and cp01||cp04='CFT00' and cp57 is null and cp27=" & stDate1 & " and cp31='Y' " & _
                                 "and instr('101', cp10) > 0 and cp09<'B' " & _
                                 "and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+) "
                     intJ = 1
                     Set RsTemp = ClsLawReadRstMsg(intJ, strExc(5))
                     If intJ = 1 Then
                        strSumT(3) = Val(strSumT(3)) + Val("" & RsTemp.Fields("tot1"))
                        strSumT(4) = Val(strSumT(4)) + Val("" & RsTemp.Fields("tot2"))
                        wksA93.Range(Pub_NumberToSystem26(11) & xRows).NumberFormat = "@"
                        wksA93.Range(Pub_NumberToSystem26(11) & xRows).Value = Val("" & RsTemp.Fields("tot1")) & "/" & Val("" & RsTemp.Fields("tot2"))
                     End If
                  End If
                  xRows = xRows + 1
                  rsRD.MoveNext
               Loop  '---rsRd
            End If
         End If
         
         '新案(email內文)
         strExc(0) = "" & convForm(rsAD.Fields("cp01") & "-" & rsAD.Fields("cp02") & "-" & rsAD.Fields("cp03") & "-" & rsAD.Fields("cp04"), 15)
         strExc(2) = "" & convForm("" & rsAD.Fields("casename"), 30)
         strExc(3) = "" & convForm("" & rsAD.Fields("custname"), 30)
         'Modified by Lydia 2024/02/06 9=>12
         strExc(4) = "" & convForm("" & rsAD.Fields("custno"), 12)
         'Modified by Lydia 2024/02/06 +互惠代理人或關聯企業
         'strCaseDetail = strCaseDetail & strExc(0) & " " & strExc(3) & " " & strExc(4) & ";"
         strExc(1) = "" & convForm("" & rsAD.Fields("dm01"), 12)
         strCaseDetail = strCaseDetail & strExc(0) & " " & strExc(3) & " " & strExc(4) & " " & strExc(1) & ";"
         'end 2024/02/06
         strGrp = "" & rsAD.Fields("FC01")
         strGrpNa01 = "" & rsAD.Fields("na01")
         rsAD.MoveNext
      Loop  '----rsAD
   End If

   If Val(strSumP(2)) > 0 Or Val(strSumP(4)) Or Val(strSumT(2)) > 0 Or Val(strSumT(4)) > 0 Then
      'Modified by Lydia 2023/12/14 +strORD1
      Call StrMenu93_XlsEnd(xlsPoint, wksA93, xRows, TempFileName, strPath, strORD1, strCaseDetail, strGrpNa01, strSumP, strSumT, strToA, strToP, strToP_J, strToT, strToP1, strToP1cc)
   End If
   Set rsRD = Nothing
   Set rsAD = Nothing
   Exit Sub
   
DebugErr:
   If Err.Number <> 0 Then
      Set rsRD = Nothing
      Set rsAD = Nothing
      WLog "互惠名單往來通知:" & Err.Description
   End If
End Sub
'end 2023/09/12

'Added by Lydia 2023/09/06 互惠名單委案通知: 處理表格和表尾,並直接email給主管
'Modified by Lydia 2023/12/14 +pORD1
Sub StrMenu93_XlsEnd(ByRef pXls As Excel.Application, ByRef pWksNow As Worksheet, ByRef pRows As Integer, _
      ByVal pFileName As String, ByVal pFilePath As String, ByVal pORD1 As String, ByVal pCaseDetail As String, ByVal pNA01 As String, _
      ByRef pSumP() As String, ByRef pSumT() As String, ByVal pToA As String, ByVal pTop As String, ByVal pToP_J As String, _
      ByVal pToT As String, ByVal pToP1 As String, ByVal pToP1cc As String)
   
Dim intA As Integer, intB As Integer
Dim strTmp(0 To 3) As String
Dim tmpArr1 As Variant
       
   If pRows > 9 Then '有關聯企業=>增加"全部"
      For intA = 3 To 9 '小計C~I欄
         strTmp(0) = Pub_NumberToSystem26(intA)
         strTmp(1) = "": strTmp(2) = ""
         For intB = 7 To pRows - 1
            If intB Mod 2 = 1 Then
               strTmp(1) = strTmp(1) & "+" & strTmp(0) & intB
            Else
               strTmp(2) = strTmp(2) & "+" & strTmp(0) & intB
            End If
         Next intB
         pWksNow.Range(strTmp(0) & pRows).Formula = "=" & Mid(strTmp(1), 2)
         pWksNow.Range(strTmp(0) & pRows + 1).Formula = "=" & Mid(strTmp(2), 2)
      Next intA
      pWksNow.Range("A" & pRows).Value = pWksNow.Range("A7").Value
      pWksNow.Range("B" & pRows).Value = "全部"
      pWksNow.Range("A" & pRows & ":L" & pRows).Interior.ColorIndex = 40      '底色:淡橘色
      pWksNow.Range("J" & pRows).NumberFormat = "@"
      'Modified by Lydia 2023/12/14 區別「代理人互惠設定:1-專利,2-商標」
      'pWksNow.Range("J" & pRows).Value = Val(pSumP(1)) & "/" & Val(pSumP(2))  'FCP狹義/廣義
      pWksNow.Range("J" & pRows).Value = IIf(pORD1 = "1", Val(pSumP(1)) & "/" & Val(pSumP(2)), Val(pSumT(1)) & "/" & Val(pSumT(2))) 'FC狹義/廣義
      pWksNow.Range("K" & pRows).NumberFormat = "@"
      'Modified by Lydia 2023/12/14 區別「代理人互惠設定:1-專利,2-商標」
      'pWksNow.Range("K" & pRows).Value = Val(pSumP(3)) & "/" & Val(pSumP(4))  'CFP狹義/廣義
      pWksNow.Range("K" & pRows).Value = IIf(pORD1 = "1", Val(pSumP(3)) & "/" & Val(pSumP(4)), Val(pSumT(3)) & "/" & Val(pSumT(4)))  'CF狹義/廣義
      pWksNow.Range("J" & pRows + 1).NumberFormat = "@"
      'Modified by Lydia 2023/12/14 區別「代理人互惠設定:1-專利,2-商標」
      'pWksNow.Range("J" & pRows + 1).Value = Val(pSumT(1)) & "/" & Val(pSumT(2)) 'FCT狹義/廣義
      pWksNow.Range("J" & pRows + 1).Value = IIf(pORD1 = "1", Val(pSumT(1)) & "/" & Val(pSumT(2)), Val(pSumP(1)) & "/" & Val(pSumP(2)))   'FC狹義/廣義
      pWksNow.Range("K" & pRows + 1).NumberFormat = "@"
      'Modified by Lydia 2023/12/14 區別「代理人互惠設定:1-專利,2-商標」
      'pWksNow.Range("K" & pRows + 1).Value = Val(pSumT(3)) & "/" & Val(pSumT(4))  'CFT狹義/廣義
      pWksNow.Range("K" & pRows + 1).Value = IIf(pORD1 = "1", Val(pSumT(3)) & "/" & Val(pSumT(4)), Val(pSumP(3)) & "/" & Val(pSumP(4)))  'CF狹義/廣義
      pWksNow.Range("B" & pRows & ":K" & pRows).HorizontalAlignment = xlCenter '代理人編號+數值置中
      pWksNow.Range("B" & pRows + 1 & ":K" & pRows + 1).HorizontalAlignment = xlCenter
      pRows = pRows + 2
   End If
   strTmp(3) = pWksNow.Range("B7").Value & " " & pWksNow.Range("A7").Value
   '調整為能使文字全部顯示之欄寬: 代理人名稱、代理人編號、聯絡人資訊、國籍、該半年度建議
    pWksNow.Range("L:L").WrapText = False
   '畫框線
   For intA = 1 To 2 '1-表頭; 2-明細
      For intB = 1 To 8  '有框線的欄位
         Select Case intB
            Case 3:  strTmp(1) = "C":  strTmp(2) = "E"  '當年度1-6月
            Case 4:  strTmp(1) = "F":  strTmp(2) = "H"  '當年度7-12月
            Case Else  '其餘皆每欄畫框線
               If intB > 4 Then
                  strTmp(1) = Pub_NumberToSystem26(intB + 4): strTmp(2) = Pub_NumberToSystem26(intB + 4)
               Else
                  strTmp(1) = Pub_NumberToSystem26(intB): strTmp(2) = Pub_NumberToSystem26(intB)
               End If
         End Select
         If intA = 1 Then
            strTmp(0) = strTmp(1) & "4:" & strTmp(2) & "6"
         Else
            strTmp(0) = strTmp(1) & "7:" & strTmp(2) & pRows - 1
         End If
         With pWksNow.Range(strTmp(0))
            .Borders(xlEdgeTop).LineStyle = xlContinuous
            .Borders(xlEdgeTop).Weight = xlMedium
            .Borders(xlEdgeBottom).LineStyle = xlContinuous
            .Borders(xlEdgeBottom).Weight = xlMedium
            .Borders(xlEdgeLeft).LineStyle = xlContinuous
            .Borders(xlEdgeLeft).Weight = xlMedium
            .Borders(xlEdgeRight).LineStyle = xlContinuous
            .Borders(xlEdgeRight).Weight = xlMedium
         End With
      Next intB
   Next intA
   
   pRows = pRows + 2
   pWksNow.Range("A" & pRows).Value = "當年度FCP、FCT採用廣義新案數定義"
   pWksNow.Range("A" & pRows).Font.Bold = True
   pRows = pRows + 2
   
   tmpArr1 = Array("定義", "", "專利", "", "商標")
   pWksNow.Range("A" & pRows & ":E" & pRows).Value = tmpArr1
   tmpArr1 = Array("狹義新案數", "101", "發明申請", "101", "申請")
   pWksNow.Range("A" & pRows + 1 & ":E" & pRows + 1).Value = tmpArr1
   tmpArr1 = Array("", "102", "新型申請", "", "")
   pWksNow.Range("A" & pRows + 2 & ":E" & pRows + 2).Value = tmpArr1
   tmpArr1 = Array("", "103", "設計申請", "", "")
   pWksNow.Range("A" & pRows + 3 & ":E" & pRows + 3).Value = tmpArr1
   tmpArr1 = Array("廣義新案數", "101", "發明申請", "101", "申請")
   pWksNow.Range("A" & pRows + 4 & ":E" & pRows + 4).Value = tmpArr1
   tmpArr1 = Array("", "102", "新型申請", "", "")
   pWksNow.Range("A" & pRows + 5 & ":E" & pRows + 5).Value = tmpArr1
   tmpArr1 = Array("", "103", "設計申請", "", "")
   pWksNow.Range("A" & pRows + 6 & ":E" & pRows + 6).Value = tmpArr1
   tmpArr1 = Array("", "125", "衍生設計申請", "", "")
   pWksNow.Range("A" & pRows + 7 & ":E" & pRows + 7).Value = tmpArr1
   tmpArr1 = Array("", "301~306", "改請", "", "")
   pWksNow.Range("A" & pRows + 8 & ":E" & pRows + 8).Value = tmpArr1
   tmpArr1 = Array("", "307", "分割", "", "")
   pWksNow.Range("A" & pRows + 9 & ":E" & pRows + 9).Value = tmpArr1

   For intA = 1 To 5
      strTmp(0) = Pub_NumberToSystem26(intA)
      Select Case intA
         Case 1
            '狹義新案數
            pXls.Range(strTmp(0) & pRows + 1 & ":" & strTmp(0) & pRows + 3).Select
            With pXls.Selection
                .HorizontalAlignment = xlLeft
                .VerticalAlignment = xlTop
                .WrapText = True
                .Orientation = 0
                .AddIndent = False
                .ShrinkToFit = False
                .MergeCells = True
                .Font.Bold = True
            End With
            '廣義新案數
            pXls.Range(strTmp(0) & pRows + 4 & ":" & strTmp(0) & pRows + 9).Select
            With pXls.Selection
               .HorizontalAlignment = xlLeft
               .VerticalAlignment = xlTop
               .WrapText = True
               .Orientation = 0
               .AddIndent = False
               .ShrinkToFit = False
               .MergeCells = True
               .Font.Bold = True
            End With
            pWksNow.Range(strTmp(0) & pRows & ":" & strTmp(0) & pRows + 9).Borders.LineStyle = xlContinuous
            pWksNow.Range(strTmp(0) & pRows & ":" & strTmp(0) & pRows + 9).Borders.Weight = xlThin
            pWksNow.Range(strTmp(0) & pRows & ":" & strTmp(0) & pRows + 9).HorizontalAlignment = xlRight
         Case 2, 4 '案件性質CP10
            pWksNow.Range(strTmp(0) & pRows & ":" & strTmp(0) & pRows + 9).HorizontalAlignment = xlRight
         Case 3, 5 '案件性質名稱
            pWksNow.Range(strTmp(0) & pRows & ":" & strTmp(0) & pRows + 9).HorizontalAlignment = xlRight
            pXls.Range(Pub_NumberToSystem26(intA - 1) & pRows & ":" & strTmp(0) & pRows).Select
            With pXls.Selection
               .HorizontalAlignment = xlLeft
               .VerticalAlignment = xlTop
               .WrapText = True
               .Orientation = 0
               .AddIndent = False
               .ShrinkToFit = False
               .MergeCells = True
               .Font.Bold = True
               .HorizontalAlignment = xlRight
            End With
            pWksNow.Range(Pub_NumberToSystem26(intA - 1) & pRows & ":" & strTmp(0) & pRows).Borders.LineStyle = xlContinuous
            pWksNow.Range(Pub_NumberToSystem26(intA - 1) & pRows & ":" & strTmp(0) & pRows).Borders.Weight = xlThin
            With pWksNow.Range(Pub_NumberToSystem26(intA - 1) & pRows + 1 & ":" & strTmp(0) & pRows + 3)
               .Borders(xlEdgeTop).LineStyle = xlContinuous
               .Borders(xlEdgeTop).Weight = xlThin '細線
               .Borders(xlEdgeBottom).LineStyle = xlContinuous
               .Borders(xlEdgeBottom).Weight = xlThin
               .Borders(xlEdgeLeft).LineStyle = xlContinuous
               .Borders(xlEdgeLeft).Weight = xlThin
               .Borders(xlEdgeRight).LineStyle = xlContinuous
               .Borders(xlEdgeRight).Weight = xlThin
            End With
            With pWksNow.Range(Pub_NumberToSystem26(intA - 1) & pRows + 4 & ":" & strTmp(0) & pRows + 9)
               .Borders(xlEdgeTop).LineStyle = xlContinuous
               .Borders(xlEdgeTop).Weight = xlThin '細線
               .Borders(xlEdgeBottom).LineStyle = xlContinuous
               .Borders(xlEdgeBottom).Weight = xlThin
               .Borders(xlEdgeLeft).LineStyle = xlContinuous
               .Borders(xlEdgeLeft).Weight = xlThin
               .Borders(xlEdgeRight).LineStyle = xlContinuous
               .Borders(xlEdgeRight).Weight = xlThin
            End With
      End Select
   Next intA
   pWksNow.Range("A1").Select
   
   '判斷若版本2007以上改變存檔格式
   If Val(pXls.Version) < 12 Then
      pXls.Workbooks(1).SaveAs FileName:=pFilePath, FileFormat:=-4143
   Else
      pXls.Workbooks(1).SaveAs FileName:=pFilePath, FileFormat:=56
   End If
   pXls.Workbooks.Close
   pXls.Quit
   Set pXls = Nothing
   Set pWksNow = Nothing
   
   '收件人：國外部主管+專利/商標案主管; 外專通知人員區分日本區
   strTmp(0) = pToA & IIf(pNA01 = "011", pToP_J, pTop) & pToT & IIf(InStr(pCaseDetail, "CFP") > 0 Or InStr(pCaseDetail, "FCP") > 0, pToP1, "")
   '內專主管加發副本
   strTmp(1) = ""
   If InStr(pCaseDetail, "CFP") > 0 Or InStr(pCaseDetail, "FCP") > 0 Then
      strTmp(1) = strTmp(1) & ";" & pToP1cc
   End If
   '內文
   'Modfied by Lydia 2024/02/06 +convForm("代理人編號", 12)
   strTmp(2) = vbCrLf & "請參考附件，新增案號資料如下列：" & vbCrLf & vbCrLf & _
                          convForm("本所案號", 16) & convForm("客戶名稱", 31) & convForm("客戶編號", 12) & convForm("代理人編號", 12) & vbCrLf
   tmpArr1 = Empty
   tmpArr1 = Split(pCaseDetail, ";")
   For intA = 0 To UBound(tmpArr1)
        If Trim(tmpArr1(intA)) <> "" Then
            strTmp(2) = strTmp(2) & tmpArr1(intA) & vbCrLf  '內文：列出新案
        End If
   Next
   'CC江協理(外商主管)
   If Right(strTmp(0), 1) = ";" Then strTmp(0) = Mid(strTmp(0), 1, Len(strTmp(0)) - 1)
   SendMAPIMail strTmp(0), strSrvDate(2) & "_" & pFileName & "_" & strTmp(3), strTmp(2), pFilePath, , , "98020" & strTmp(1)
   
End Sub

'Add By Sindy 2019/1/31 上月收款之可扣繳收據，收據抬頭不存在！請確認後修改資料
Sub StrMenu94()
Dim ff As Integer
Dim A01 As String
Dim A02 As String
Dim A03 As String
Dim A04 As String
Dim A05 As String
Dim A06 As String
Dim TempFileName As String
Dim tmpnext As String
Dim stTO As String 'Add by Amy 2024/05/13
   
On Error GoTo DebugErr
   
   TempFileName = ""
   
   'modify by sonia 2025/5/22 a1v06 已扣繳金額改為st02智權人員故加staff
   strSql = "select a0l02 收款日期,a0k01 收據號碼,a0k02 收據日期,a0k03 客戶編號,ST02 智權人員,a0k04 收據抬頭" & _
            " from acc0k0,acc0l0,acc0m0,acc1v0,acc420,customer,staff" & _
            " where substr(a0l02+19110000,1,6)= to_char(add_months(sysdate,-1),'yyyymm') and a0l01=a0m01(+) and a0m02=a0k01(+)" & _
            " and a0k05='2' and a0k04=cu04(+) and a0k04=a4201(+) and cu04||a4201 is null and a0k01=a1v02(+) and a0k20=st01(+)" & _
            " order by a0k04,a0k03"
   CheckOC
   Set Rs = New ADODB.Recordset
   Rs.CursorLocation = adUseClient
   Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   tmpnext = "已取得資料..."
   With Rs
      If .RecordCount > 0 Then
         .MoveFirst
         Do While Not .EOF
            If TempFileName = "" Then
               TempFileName = strSrvDate(2) & "-上月收款之可扣繳收據但收據抬頭不存在"
               ff = FreeFile
               If ff > 0 Then Close #ff
               Open App.path & TextPath & TempFileName & ".txt" For Output As ff
               Print #ff, Space(10) & TempFileName
               Print #ff, ""
               'modify by sonia 2025/5/22 a1v06 已扣繳金額改為st02智權人員
               'Print #ff, "收款日期    收據號碼    收據日期    客戶編號    已扣繳金    收據抬頭"
               'Print #ff, "=========== =========== =========== =========== =========== ======================"
               Print #ff, "收款日期    收據號碼    收據日期    客戶編號    智權人員    收據抬頭"     'modify by sonia 2025/5/22 a1v06 已扣繳金額改為st02智權人員
               Print #ff, "=========== =========== =========== =========== =========== ======================"
               'end 2025/5/22
               tmpnext = "開檔中..."
            End If
            A01 = "" & convForm(CheckStr(ChangeTStringToTDateString(.Fields(0).Value)), 11)
            A02 = "" & convForm(CheckStr(.Fields(1).Value), 11)
            A03 = "" & convForm(CheckStr(ChangeTStringToTDateString(.Fields(2).Value)), 11)
            A04 = "" & convForm(CheckStr(.Fields(3).Value), 11)
            'modify by sonia 2025/5/22 a1v06 已扣繳金額改為st02智權人員
            'A05 = "" & convForm(CheckStr(Format(.Fields(4).Value, DDollar2)), 11)
            A05 = "" & convForm(CheckStr(.Fields(4).Value), 11)
            A06 = "" & CheckStr(.Fields(5).Value)
            tmpnext = "寫檔..."
            Print #ff, A01 & " " & A02 & " " & A03 & " " & A04 & " " & A05 & " " & A06
            
            .MoveNext
         Loop
      End If
   End With
   Close ff
   tmpnext = "關檔..."
   If TempFileName <> "" Then
      'Modify by Amy 2024/05/13 財務拆成總帳、出納、國內應收
      stTO = Pub_GetSpecMan("財務處總帳人員")
      If Val(strSrvDate(1)) >= Val(財務拆總帳出納國內應收啟用日) Then
         stTO = Pub_GetSpecMan("財務處應收處理人員")
      End If
      SendMAPIMail stTO, ChangeWStringToTDateString(strSrvDate(1)) & "上月收款之可扣繳收據但收據抬頭不存在！請確認後修改資料！", "Dear Sirs," & vbCrLf & "          資料　如附件！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", App.path & TextPath & TempFileName & ".txt"
      'end 2024/05/13
   End If
   
   Set Rs = Nothing
   Exit Sub
   
DebugErr:
   WLog tmpnext & " " & Err.Description
End Sub

'Added by Morgan 2019/3/18 程序太大改寫函數(超過64K)
'算得分
Private Sub SetPoint()
Dim StrSQLa As String
StrSQLa = "select  * from  assessrate where ar01 in (select max(ar01) from assessrate where ar01<=" & Val(Trim(str(Val(CalYM) + 191100)) & "01") & ") "
CheckOC
adoRecordset.CursorLocation = adUseClient
adoRecordset.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
'Modified by Morgan 2019/3/21 修正達成率少除以100問題(實際上月考核或季考核都會重新計算)
If adoRecordset.RecordCount <> 0 Then
   'Added by Morgan 2019/3/18 108考核(得分取消(達成率)^2的計算方式)
   If Val(Trim(str(Val(CalYM) + 191100)) & "01") >= Val(PUB_108RuleDate) Then
      cnnConnection.Execute "update monthassess set ma39=round(ma38/100 * 0.8 * " & Val(CheckStr(adoRecordset.Fields("ar09").Value)) & ",2) where ma02=" & Trim(str(Val(CalYM) + 191100))
      cnnConnection.Execute "update monthassess set ma42=round(ma41/100 * 0.8 * " & Val(CheckStr(adoRecordset.Fields("ar10").Value)) & ",2) where ma02=" & Trim(str(Val(CalYM) + 191100))
      cnnConnection.Execute "update monthassess set ma45=round(ma44/100 * 0.8 * " & Val(CheckStr(adoRecordset.Fields("ar11").Value)) & ",2) where ma02=" & Trim(str(Val(CalYM) + 191100))
      'Added by Morgan 2019/3/21 ma57發文實績點數得分
      cnnConnection.Execute "update monthassess set ma57=round(ma56 /100 * 0.8 * " & Val(CheckStr(adoRecordset.Fields("ar27").Value)) & ",2) where ma02=" & Trim(str(Val(CalYM) + 191100))
      '高於所佔比重的 150% 以 150 % 為上限只有點數
      cnnConnection.Execute "update monthassess set ma57=" & str(Val(CheckStr(adoRecordset.Fields("ar10").Value)) * 1.5) & " where ma02=" & Trim(str(Val(CalYM) + 191100)) & " and ma57>" & str(Val(CheckStr(adoRecordset.Fields("ar27").Value)) * 1.5) & " "
   Else
   'end 2019/3/18
   
      '高於 100%
      cnnConnection.Execute "update monthassess set ma39=round(ma38/100 * 0.8 * " & Val(CheckStr(adoRecordset.Fields("ar09").Value)) & ",2) where ma02=" & Trim(str(Val(CalYM) + 191100)) & " and ma38>1 "
      cnnConnection.Execute "update monthassess set ma42=round(ma41/100 * 0.8 * " & Val(CheckStr(adoRecordset.Fields("ar10").Value)) & ",2) where ma02=" & Trim(str(Val(CalYM) + 191100)) & " and ma41>1 "
      cnnConnection.Execute "update monthassess set ma45=round(ma44/100 * 0.8 * " & Val(CheckStr(adoRecordset.Fields("ar11").Value)) & ",2) where ma02=" & Trim(str(Val(CalYM) + 191100)) & " and ma44>1 "
      '低於 100%
      cnnConnection.Execute "update monthassess set ma39=round(power(ma38/100,2) * 0.8 * " & Val(CheckStr(adoRecordset.Fields("ar09").Value)) & ",2) where ma02=" & Trim(str(Val(CalYM) + 191100)) & " and ma38<=1 "
      cnnConnection.Execute "update monthassess set ma42=round(power(ma41/100,2) * 0.8 * " & Val(CheckStr(adoRecordset.Fields("ar10").Value)) & ",2) where ma02=" & Trim(str(Val(CalYM) + 191100)) & " and ma41<=1 "
      cnnConnection.Execute "update monthassess set ma45=round(power(ma44/100,2) * 0.8 * " & Val(CheckStr(adoRecordset.Fields("ar11").Value)) & ",2) where ma02=" & Trim(str(Val(CalYM) + 191100)) & " and ma44<=1 "
      
   End If 'Added by Morgan 2019/3/18
   
   '高於所佔比重的 150% 以 150 % 為上限只有點數
   cnnConnection.Execute "update monthassess set ma42=" & str(Val(CheckStr(adoRecordset.Fields("ar10").Value)) * 1.5) & " where ma02=" & Trim(str(Val(CalYM) + 191100)) & " and ma42>" & str(Val(CheckStr(adoRecordset.Fields("ar10").Value)) * 1.5) & " "
End If
End Sub

'Added by Lydia 2019/03/21 大陸商標延展案可辦日前預先通知智權人員
Sub StrMenu95(ByVal pKind As String)
'pKind=1 (北中所-前10個工作天) ; pKind=2 (南高所-前一個月)
On Error GoTo DebugErr
Dim f95 As Integer
Dim i As Integer
Dim strTemp(0 To 10) As String
Dim iCount As Long
Dim TempFileName As String
Dim strGrp As String
Dim strTitle As String
Dim strTitleLine As String
Dim T_Date As String
   
   If pKind = "1" Then
      TempFileName = "大陸商標延展案可辦日前10個工作天預先通知"
   Else
      TempFileName = "大陸商標延展案可辦日前一個月預先通知"
   End If
   If Dir(App.path & TextPath & TempFileName & ".txt") <> "" Then
      Kill App.path & TextPath & TempFileName & ".txt"
   End If
   
    strTitle = "申請人名稱           本所案號      審定號   收文日    法定期限  可辦日期  案件名稱             費用   電話                                      "
strTitleLine = "==================== ============= ======== ========= ========= ========= ==================== ====== =========================================="

   T_Date = strSrvDate(1)
   
   If pKind = "1" Then
      '北中所+其他:前10個工作天通知
      strSql = "SELECT cp13,st02,st06,cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) caseno," & _
               "tm15,nvl(tm05,nvl(tm06,tm07)) casename,tm23,nvl(cu04,nvl(cu05,cu06)) cname,sqldatet(cp07) cp07,cp16 as fee,cp18 as degree," & _
               "cu16||';'||cu17 tel,cu18||';'||cu19 fax,sqldatet(" & PUB_Get102DeadLine("5", "CP07", 1, 0) & ") ddate,cp09,sqldatet(cp05) cp05 " & _
               "From CaseProgress, Customer, TradeMark, staff " & _
               "WHERE substr(cp01,1,1)='T' and cp01<>'TF' and CP10='102' and cp07 > 20000000 and CP158=0 AND CP159=0 and (TM29 is null) and cp145 is null " & _
               " and workdayadd(-11," & PUB_Get102DeadLine("5", "CP07", 1, 0) & ") <= " & T_Date & _
               " and cp05<=" & PUB_Get102DeadLine("5", "CP07", 1, 0) & _
               " and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+) and substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+)" & _
               " and tm10='020' and cp13=st01(+) and st06<>'3' and st06<>'4' order by cp13,cp07,tm23,caseno "
   Else
      '南高所:前一個月通知
      strSql = "SELECT cp13,st02,st06,cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) caseno," & _
               "tm15,nvl(tm05,nvl(tm06,tm07)) casename,tm23,nvl(cu04,nvl(cu05,cu06)) cname,sqldatet(cp07) cp07,cp16 as fee,cp18 as degree," & _
               "cu16||';'||cu17 tel,cu18||';'||cu19 fax,sqldatet(" & PUB_Get102DeadLine("5", "CP07", 1, 0) & ") ddate,cp09,sqldatet(cp05) cp05 " & _
               "From CaseProgress, Customer, TradeMark, staff " & _
               "WHERE substr(cp01,1,1)='T' and cp01<>'TF' and CP10='102' and cp07 > 20000000 and CP158=0 AND CP159=0 and (TM29 is null) and cp145 is null " & _
               " and " & PUB_Get102DeadLine("5", "CP07", 1, 1) & " <= " & T_Date & _
               " and cp05<=" & PUB_Get102DeadLine("5", "CP07", 1, 1) & _
               " and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+) and substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+)" & _
               " and tm10='020' and cp13=st01(+) and (st06='3' or st06='4') order by cp13,cp07,tm23,caseno "
   End If
   Set Rs = New ADODB.Recordset
   Rs.CursorLocation = adUseClient
   Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   With Rs
       If .RecordCount > 0 And .RecordCount <> 0 Then
           .MoveFirst
           cnnConnection.BeginTrans
           Do While Not .EOF
               If strGrp <> "" & .Fields("cp13") Then
                   If f95 > 0 Then
                      Print #f95, String(Len(strTitleLine), "=")
                      Print #f95, "共 " & iCount & " 筆"
                      Close #f95
                      SendMAPIMail strGrp, "大陸商標延展案前已收文，將要可以辦理，請與申請人再確認！", vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, App.path & TextPath & TempFileName & ".txt"
                   End If
                   'Added by Lydia 2020/08/26
                    If Dir(App.path & TextPath & TempFileName & ".txt") <> "" Then
                       Kill App.path & TextPath & TempFileName & ".txt"
                    End If
                   'end 2020/08/26
                   f95 = FreeFile
                   iCount = 0
                   Open App.path & TextPath & TempFileName & ".txt" For Output As f95
                   Print #f95, String(50, " ") & "大陸商標延展案於可辦期限前已收文明細"
                   Print #f95, ""
                   Print #f95, "智權人員：" & .Fields("st02")
                   Print #f95, ""
                   Print #f95, strTitle
                   Print #f95, strTitleLine
               End If
                              
               strTemp(0) = "" & convForm(CheckStr(.Fields("cname").Value), 20)
               strTemp(1) = "" & convForm(CheckStr(.Fields("caseno").Value), 13)
               strTemp(2) = "" & convForm(CheckStr(.Fields("tm15").Value), 8)
               strTemp(3) = "" & convForm(CheckStr(.Fields("cp05").Value), 9)
               strTemp(4) = "" & convForm(CheckStr(.Fields("cp07").Value), 9)  '法限
               strTemp(5) = "" & convForm(CheckStr(.Fields("ddate").Value), 9) '可辦期限
               strTemp(6) = "" & convForm(CheckStr(.Fields("casename").Value), 20)
               strTemp(7) = "" & PUB_StrToStr(CheckStr(Format(.Fields("fee").Value, "#,##0")), 6, True, True)
               strTemp(8) = "" & convForm(IIf("" & .Fields("tel").Value = ";", "", "" & .Fields("tel").Value), 42)
              
               Print #f95, strTemp(0) & " " & strTemp(1) & " " & strTemp(2) & " " & strTemp(3) & " " & strTemp(4) & " " & strTemp(5) & " " & strTemp(6) & " " & strTemp(7) & " " & strTemp(8)
               iCount = iCount + 1
               strGrp = "" & .Fields("cp13")
               '通知後CP145='Y'
               strSql = "update caseprogress set cp145='Y' where cp09='" & .Fields("cp09") & "' "
               cnnConnection.Execute strSql
               .MoveNext
           Loop
           cnnConnection.CommitTrans
       End If
   End With
   
   If f95 > 0 Then
       Print #f95, String(Len(strTitleLine), "=")
       Print #f95, "共 " & iCount & " 筆"
       Close #f95
       SendMAPIMail strGrp, "大陸商標延展案前已收文，將要可以辦理，請與申請人再確認！", vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, App.path & TextPath & TempFileName & ".txt"
   End If
   
   Exit Sub
   
DebugErr:
    cnnConnection.RollbackTrans
    WLog "資料更新失敗" & " " & Err.Description
End Sub

'Add By Sindy 2019/7/3 大陸商申提申後管制催申請案號(10日,20日,最後一日)
Private Sub StrMenu96()
   Dim stSQL As String, stDate As String
   Dim ff As Integer
   Dim TempFileName As String, strTemp(6) As String
   Dim strTo As String
   Dim strNPsql As String
On Error GoTo ErrHandle
   
   'Add By Sindy 2020/8/31
   If Dir(App.path & TextPath & "*大陸商申提申後管制催申請案號*.txt") <> "" Then
      Kill App.path & TextPath & "*大陸商申提申後管制催申請案號*.txt"
   End If
   '2020/8/31 END

   '通知承辦人:
   stSQL = "select cp14,substr(s1.st02,1,3) 承辦人,substr(s2.st02,1,3) 程序,tm05 商標名稱,substr(fa04,1,6) 代理人,substr(sqldatet(cp46),1,10) 收達日,cp01||'-'||cp02||'-'||cp03||'-'||cp04 本所案號,substr(cpm04,1,6) 案件性質" & _
           ",cp44,cp46,cp02 from caseprogress,fagent,staff s1,staff s2,casepropertymap,trademark,nextprogress" & _
           " where np07='1101' and np06 is null and np08<=" & strSrvDate(1) & _
           " and np01=cp09(+)" & _
           " and cp01=cpm01(+) and cp10=cpm02(+)" & _
           " and substr(cp44,1,8)=fa01(+) and substr(cp44,9,1)=fa02(+)" & _
           " and cp14=s1.st01(+) and cp83=s2.st01(+)" & _
           " and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+)" & _
           " and nvl(tm57,0)=0 and nvl(tm30,0)=0 and tm10='020'" & _
           " order by cp14,cp44,cp46,cp02"
   If Rs.State <> adStateClosed Then Rs.Close
   Set Rs = New ADODB.Recordset
   Rs.CursorLocation = adUseClient
   Rs.Open stSQL, cnnConnection, adOpenStatic, adLockReadOnly
   With Rs
      If .RecordCount > 0 Then
         .MoveFirst
         Do While Not .EOF
            If TempFileName = "" Or strTo <> "" & .Fields(0) Then
               If strTo <> "" And TempFileName <> "" Then
                  Close ff
                  SendMAPIMail strTo, TempFileName, "Dear Sirs," & vbCrLf & "　　" & TempFileName & " 如附件！" & vbCrLf & vbCrLf & "電腦中心", App.path & TextPath & TempFileName & ".txt"
               End If
               TempFileName = "大陸商申提申後管制催申請案號-承辦"
               ff = FreeFile
               If ff > 0 Then Close #ff
               ff = FreeFile
               Open App.path & TextPath & TempFileName & ".txt" For Output As ff
               Print #ff, Space(25) & TempFileName
               Print #ff, ""
               Print #ff, "承辦人   程序     商標名稱           代理人           提申日    本所案號    "
               Print #ff, "======== ======== ================== ================ ========= ============"
            End If
            strTemp(0) = convForm(CheckStr("" & .Fields(1)), 8)
            strTemp(1) = convForm(CheckStr("" & .Fields(2)), 8)
            strTemp(2) = convForm(CheckStr("" & .Fields(3)), 18)
            strTemp(3) = convForm(CheckStr("" & .Fields(4)), 16)
            strTemp(4) = convForm(CheckStr("" & .Fields(5)), 9)
            strTemp(5) = convForm(CheckStr("" & .Fields(6)), 12)
            strTemp(6) = convForm(CheckStr("" & .Fields(7)), 12)
            strTo = "" & .Fields(0)
            Print #ff, strTemp(0) & " " & strTemp(1) & " " & strTemp(2) & " " & strTemp(3) & " " & strTemp(4) & " " & strTemp(5) '& " " & strTemp(6)
            .MoveNext
         Loop
      End If
      If strTo <> "" And TempFileName <> "" Then
         Close ff
         SendMAPIMail strTo, TempFileName, "Dear Sirs," & vbCrLf & "　　" & TempFileName & " 如附件！" & vbCrLf & vbCrLf & "電腦中心", App.path & TextPath & TempFileName & ".txt"
      End If
   End With
   Rs.Close
   TempFileName = "": strTo = ""
   '通知程序人員:
   stSQL = "select cp83,substr(s1.st02,1,3) 承辦人,substr(s2.st02,1,3) 程序,tm05 商標名稱,substr(fa04,1,6) 代理人,substr(sqldatet(cp46),1,10) 收達日,cp01||'-'||cp02||'-'||cp03||'-'||cp04 本所案號,substr(cpm04,1,6) 案件性質" & _
           ",cp44,cp46,cp02 from caseprogress,fagent,staff s1,staff s2,casepropertymap,trademark,nextprogress" & _
           " where np07='1101' and np06 is null and np08<=" & strSrvDate(1) & _
           " and np01=cp09(+)" & _
           " and cp01=cpm01(+) and cp10=cpm02(+)" & _
           " and substr(cp44,1,8)=fa01(+) and substr(cp44,9,1)=fa02(+)" & _
           " and cp14=s1.st01(+) and cp83=s2.st01(+)" & _
           " and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+)" & _
           " and nvl(tm57,0)=0 and nvl(tm30,0)=0 and tm10='020'" & _
           " order by cp83,cp44,cp46,cp02"
   If Rs.State <> adStateClosed Then Rs.Close
   Set Rs = New ADODB.Recordset
   Rs.CursorLocation = adUseClient
   Rs.Open stSQL, cnnConnection, adOpenStatic, adLockReadOnly
   With Rs
      If .RecordCount > 0 Then
         .MoveFirst
         Do While Not .EOF
            If TempFileName = "" Or strTo <> "" & .Fields(0) Then
               If strTo <> "" And TempFileName <> "" Then
                  Close ff
                  SendMAPIMail strTo, TempFileName, "Dear Sirs," & vbCrLf & "　　" & TempFileName & " 如附件！" & vbCrLf & vbCrLf & "電腦中心", App.path & TextPath & TempFileName & ".txt"
               End If
               TempFileName = "大陸商申提申後管制催申請案號-程序"
               ff = FreeFile
               If ff > 0 Then Close #ff
               ff = FreeFile
               Open App.path & TextPath & TempFileName & ".txt" For Output As ff
               Print #ff, Space(25) & TempFileName
               Print #ff, ""
               Print #ff, "承辦人   程序     商標名稱           代理人           提申日    本所案號    "
               Print #ff, "======== ======== ================== ================ ========= ============"
            End If
            strTemp(0) = convForm(CheckStr("" & .Fields(1)), 8)
            strTemp(1) = convForm(CheckStr("" & .Fields(2)), 8)
            strTemp(2) = convForm(CheckStr("" & .Fields(3)), 18)
            strTemp(3) = convForm(CheckStr("" & .Fields(4)), 16)
            strTemp(4) = convForm(CheckStr("" & .Fields(5)), 9)
            strTemp(5) = convForm(CheckStr("" & .Fields(6)), 12)
            strTemp(6) = convForm(CheckStr("" & .Fields(7)), 12)
            strTo = "" & .Fields(0)
            Print #ff, strTemp(0) & " " & strTemp(1) & " " & strTemp(2) & " " & strTemp(3) & " " & strTemp(4) & " " & strTemp(5) '& " " & strTemp(6)
            .MoveNext
         Loop
      End If
      If strTo <> "" And TempFileName <> "" Then
         Close ff
         SendMAPIMail strTo, TempFileName, "Dear Sirs," & vbCrLf & "　　" & TempFileName & " 如附件！" & vbCrLf & vbCrLf & "電腦中心", App.path & TextPath & TempFileName & ".txt"
      End If
   End With
   Rs.Close
   TempFileName = "": strTo = ""
   Exit Sub
   
ErrHandle:
   If Err.Number <> 0 Then
      WLog "大陸商申提申後管制催申請案號:" & Err.Description
   End If
   Set Rs = Nothing
End Sub

'Add By Sindy 2019/8/13 更新顧問過期一個月的未續簽資料
Private Sub StrMenu97()
   
On Error GoTo ErrHandle
   
   'SELECT cp09,cp54,to_char(add_months(to_date(cp54,'YYYYMMDD'),1),'YYYYMMDD')
   ',sqldatet(to_char(add_months(to_date(cp54,'YYYYMMDD'),1),'YYYYMMDD')-19110000) from caseprogress
   strSql = "UPDATE caseprogress SET cp27=to_char(add_months(to_date(cp54,'YYYYMMDD'),1),'YYYYMMDD')" & _
            ",cp64='未續簽日期：'||sqldatet(to_char(add_months(to_date(cp54,'YYYYMMDD'),1),'YYYYMMDD')-19110000)||';'||cp64" & _
            " WHERE cp54 IS NOT NULL AND cp01='LA'" & _
            " AND cp158=0 AND cp159=0" & _
            " AND CP10='0'" & _
            " AND to_char(add_months(to_date(cp54,'YYYYMMDD'),1),'YYYYMMDD')<to_char(sysdate,'yyyymmdd')"
   cnnConnection.Execute strSql
   
   Exit Sub
   
ErrHandle:
   If Err.Number <> 0 Then
      WLog "更新顧問過期一個月的未續簽資料:" & Err.Description
   End If
End Sub

'Added by Lydia 2019/08/15 外專工程師認翻譯案
Private Sub StrMenu98()
Dim f98 As Integer
Dim RsQ As New ADODB.Recordset
Dim strTemp(0 To 5) As String
Dim iCount As Long
Dim TempFileName As String
Dim strGrp As String
Dim strTitle As String
Dim strTitleLine As String
Dim strCon1 As String
Dim strTo As String
Dim m_GrpManList As String

   TempFileName = "外專工程師認翻譯案"
   'Added by Lydia 2020/08/19 清除舊檔
   If Dir(App.path & TextPath & TempFileName & ".txt") <> "" Then
       Kill App.path & TextPath & TempFileName & ".txt"
   End If
   'end 2020/08/19
   
    strTitle = "本所案號        案件名稱"
strTitleLine = String(15, "=") & " " & String(50, "=")

   '英文組
   strCon1 = strCon1 & " and (pa150='1' or pa150='2' or pa150='4') "
   '排除待英文本
   strCon1 = strCon1 & " and nvl(tf30,'N') <> 'Y' "
   '排除主管已確認的認領
   strCon1 = strCon1 & " and tfa06 is null "
   '增加含未提申之案件,將and c2.cp27||tf31||tcn14 is not null抽出
   strCon1 = strCon1 & " and c2.cp27||tf31||tcn14 is not null "
    '各組工程師主管的內翻和外翻編號: 因為P案一開始會先將201承辦人設為各組主管
   m_GrpManList = Pub_GetSt16Man(True)
   'Added by Lydia 2019/08/23 不顯示"待比對TF29,待英文本TF30,暫不翻譯TF34"
   strCon1 = strCon1 & " and TF29 is null and TF34 is null and substr(nvl(TF30,'B'),1,1)='B' "
        
    '排序
   strExc(1) = "decode(tcn14,null, " & _
                                "decode(tf31,null, " & _
                                        "decode(b1.cm01||b2.cm05,null,decode(pa08,'2','13','20'),decode(pa08,'1','12','15')) " & _
                                ",'11') " & _
                      ",'10') ord1, "
    '符號
   strExc(2) = "decode(tcn14,null,'','▲')||decode(tf31,null,'','●')||decode(b1.cm01||b2.cm05,null,'',decode(pa08,'1','◎',''))||decode(pa08,'2','◆','')||"
   
   strSql = "select ' ' V, " & strExc(1) & strExc(2) & _
                "c1.cp01||'-'||c1.cp02||DECODE(c1.cp03||c1.cp04,'000','','-'||c1.cp03||'-'||c1.cp04)||decode(tcn01,null,'','('||tcn01||')') AS caseno,sqldatet(pa10) pa10t,sqldatet(nvl(tf26,c1.cp48)) tf26t,sqldatet(tf32) tf32t" & _
                ",nvl(s2.st02,tfa04n) transman,tf33,decode(pa49||pa50||fa25||fa26||cu36||cu37,null,'','Y') as dcprice,null as fcprice,tf20,decode(tf19,0,null,tf19) tf19" & _
                ",decode(pa150,'1','" & PUB_GetFCPGrpName("1") & "','2','" & PUB_GetFCPGrpName("2") & "','3','" & PUB_GetFCPGrpName("3") & "','4','" & PUB_GetFCPGrpName("4") & "',pa150) grpname" & _
                ",decode(tct25,'1','生醫','2','化學','3','化工','4','材料','5','電子','6','機械','7','電機','8','其他',tct25) tct25n " & _
                ",s1.st02 as tct10n,decode(substr(tf30,1,1),'B','',tf30) tf30t,tf29" & _
                ",nvl(pa05,nvl(pa06,pa07)) casename,pa150,tf01 as c1_cp09,c2.cp09 as c2_cp09,tf26,tct25,tcn15,tcn14,tf30,tf31,tf32,tf34,tfa04,tfa06,c1.cp48 as c1_cp48 " & _
                "from TransFee,CaseProgress c1,CaseProgress c2 ,TransCaseTitle,staff s1,patent" & _
                ",customer,fagent,TrackingCaseName,staff s2" & _
                ",(select tfa01,s3.st02||decode(tfa05,'A','-下班','B','-上班','') as tfa04n,tfa04,tfa06 from transfeeassign,staff s3 where tfa04=s3.st01(+) ) vtb3 " & _
                ", casemap b1 ,casemap b2 " & _
                "where tf01=c1.cp09(+) and c1.cp10 ='201' and c1.cp158=0 and c1.cp159=0 and pa57 is null " & strCon1 & _
                "and (c1.cp01||c1.cp14='FCP' or (c1.cp01='P' and instr('" & m_GrpManList & "',c1.cp14)>0)) " & _
                "and c1.cp01=pa01(+) and c1.cp02=pa02(+) and c1.cp03=pa03(+) and c1.cp04=pa04(+) " & _
                "and c1.cp01=c2.cp01(+) and c1.cp02=c2.cp02(+) and c1.cp03=c2.cp03(+) and c1.cp04=c2.cp04(+) and c2.cp31='Y' " & _
                "and c2.cp09=tct01(+) and tct10=s1.st01(+) " & _
                "and substr(pa26,1,8)=cu01(+) and substr(pa26,9,1)=cu02(+) " & _
                "and substr(pa75,1,8)=fa01(+) and substr(pa75,9,1)=fa02(+) and tf01=tfa01(+) and tf01=tcn14(+) and tcn15=s2.st01(+) " & _
                "and b1.cm01(+)=c1.cp01 and b1.cm02(+)=c1.cp02 and b1.cm03(+)=c1.cp03 and b1.cm04(+)=c1.cp04 and b1.cm10(+)='3' " & _
                "and b2.cm05(+)=c1.cp01 and b2.cm06(+)=c1.cp02 and b2.cm07(+)=c1.cp03 and b2.cm08(+)=c1.cp04 and b2.cm10(+)='3' "
   strSql = strSql & "order by pa150,ord1,pa10t "
   intI = 1
   Set RsQ = ClsLawReadRstMsg(intI, strSql)
   If intI = 1 Then
        With RsQ
            .MoveFirst
            Do While Not .EOF
                If strGrp <> "" & .Fields("pa150") Then
                    If f98 > 0 Then
                       Print #f98, String(Len(strTitleLine), "=")
                       Print #f98, "共 " & iCount & " 筆"
                       Close #f98
                       
                       If strTo <> "" Then
                           PUB_SendMail strUserNum, strTo, "", "欲承接翻譯者，請至系統進行認領。", "清單內案件為已提申尚未分案之案件,將於近日內分案外翻,欲承接翻譯者,請至系統""外專翻譯分案-認翻譯"",進行認領,謝謝!", , App.path & TextPath & TempFileName & ".txt", , , , , , , , True, , , , False
                       End If
                    End If
                    f98 = FreeFile
                    iCount = 0
                    If Dir(App.path & TextPath & TempFileName & ".txt") <> "" Then
                       Kill App.path & TextPath & TempFileName & ".txt"
                    End If
                    Open App.path & TextPath & TempFileName & ".txt" For Output As f98
                    Print #f98, String(20, " ") & strSrvDate(2) & "外專工程師認翻譯案_" & PUB_GetFCPGrpName(.Fields("pa150"))
                    Print #f98, ""
                    Print #f98, strTitle
                    Print #f98, strTitleLine
                    '各組工程師清單
                    strSql = "select st01 from staff where st04='1' and st03='F21' and st16='" & .Fields("pa150") & "' and st01>'6' and st01<'F' "
                    '排除林信昌和第4碼9
                    strSql = strSql & " and st01 not in ('F5162','68007','68092','68091','F5644','F5645') and st01 not like '___9%' "
                    strSql = strSql & " order by st01"
                    
                    intI = 1
                    strTo = ""
                    Set RsTemp = ClsLawReadRstMsg(intI, strSql)
                    If intI = 1 Then
                        strTo = RsTemp.GetString(adClipString, , , ";")
                    End If
                End If
                               
                strTemp(0) = "" & convForm(CheckStr(.Fields("caseno").Value), 15)
                strTemp(1) = "" & convForm(CheckStr(.Fields("casename").Value), 50)
               
                Print #f98, strTemp(0) & " " & strTemp(1) & " "
                iCount = iCount + 1
                strGrp = "" & .Fields("pa150")
                .MoveNext
            Loop

        End With
        
        If f98 > 0 Then
            Print #f98, String(Len(strTitleLine), "=")
            Print #f98, "共 " & iCount & " 筆"
            Close #f98
            If strTo <> "" Then
                 PUB_SendMail strUserNum, strTo, "", "欲承接翻譯者，請至系統進行認領。", "清單內案件為已提申尚未分案之案件,將於近日內分案外翻,欲承接翻譯者,請至系統""外專翻譯分案-認翻譯"",進行認領,謝謝!", , App.path & TextPath & TempFileName & ".txt", , , , , , , , True, , , , False
            End If
        End If
   End If
   Set RsQ = Nothing
   
   Exit Sub
   
End Sub

'Add by Amy 2020/02/18 刪除有會議室預約但無對應之教育訓練資料(可能中途當掉)
Private Sub StrMenu99()
    Dim strQ As String
    
On Error GoTo ErrHandle

    strQ = "Delete From RoomReservation " & _
                "Where RR20 in(Select RR20 From RoomReservation,Seminar " & _
                                          "Where RR20=SN01(+) And RR20 is not null " & _
                                          "And SN01 is null " & _
                ")"
    cnnConnection.Execute strQ
    Exit Sub
    
ErrHandle:
   If Err.Number <> 0 Then
      WLog "刪除有會議室預約但無對應之教育訓練資料有誤:" & Err.Description
   End If
End Sub

'Add By Sindy 2020/5/26 商標處信件處理結果檢核表
Private Sub StrMenu100()
Dim RsQ As New ADODB.Recordset
Dim strTemp(1 To 6) As String
Dim TempFileName As String
Dim strDate1 As String, StrDate2 As String
Dim strTo As String
Dim jj As Integer

Dim strText As String

On Err GoTo ErrHandle
   
   TempFileName = "商標處信件處理結果檢核表-" & strSrvDate(2)
   TempFileName = App.path & TextPath & TempFileName & ".txt"
   If Dir(TempFileName) <> "" Then Kill TempFileName
   
   strDate1 = CompWorkDay(2, strSrvDate(1), 1) '前1個工作天
   '系統日的前1天
   StrDate2 = Format(DateAdd("D", -1, DateSerial(Left(strSrvDate(1), 4), Mid(strSrvDate(1), 5, 2), Right(strSrvDate(1), 2))), "YYYYMMDD")
   
   '處理日期=前1日工作天 ~ 系統日的前1天(中間有放假日)
   '處理狀態=2.不處理 5.已處理
   strSql = "select substr(' '||sqldatet(ti08),-9),ti18||'-'||ti19||'-'||ti20||'-'||ti21," & _
            "ti17,s1.st02 ProcName,ti01||'-'||ti03 letterID,ti01,ti02,ti03,s1.st01 ProcID," & _
            "decode(ir16," & 信件處理狀態 & ",ir16)||'-'||ir20 ir16,ir17,ir20 " & _
            "From inputrecord, TMinput, staff s1, staff s2 " & _
            "where length(ir03)=5 and substr(ir03,1,1)='T' and ir16 in('2','5') " & _
            "and ir08>0 and ir01=ti01(+) and ir03=ti03(+) " & _
            "and ir04=s1.st01(+) and ir19=s2.st01(+) " & _
            "and ir17>=" & strDate1 & " and ir17<=" & StrDate2 & _
            " ORDER BY ir19 asc,ir16 asc,ti01||'-'||ti03 asc"
   intI = 1
   Set RsQ = ClsLawReadRstMsg(intI, strSql)
   If intI = 1 Then
      If RsQ.RecordCount > 0 Then
         With RsQ
            .MoveFirst
            
'            ff1 = FreeFile
'            Open TempFileName For Output As ff1
'            Print #ff1, "備註：改字型Fixedsys標準11號字以橫式上下左右各10MM列印"
'            Print #ff1, "處理人員 處理日期   處理結果                   轉寄日期/時間        主旨"
'            Print #ff1, "======== ========== ========================== ==================== ==================================================================================="
            
                      strText = "備註：改字型Fixedsys標準11號字以橫式上下左右各10MM列印" & vbCrLf
            strText = strText & "處理人員 處理日期   處理結果                   轉寄日期/時間        主旨" & vbCrLf
            strText = strText & "======== ========== ========================== ==================== ===================================================================================" & vbCrLf
            
            Do While Not .EOF
               For jj = 1 To 5
                  strTemp(jj) = ""
               Next jj
               strTemp(1) = Trim(.Fields("ProcName")) '處理人員
               strTemp(2) = ChangeWStringToTDateString(.Fields("ir17")) '處理日期
               strTemp(3) = Trim("" & .Fields("ir16")) '處理結果
               strTemp(4) = ChangeWStringToTDateString(.Fields("ti01")) & " " & Format(.Fields("ti02"), "00:00:00") '轉寄日期/時間
               strTemp(5) = "" & Trim(.Fields("ti17")) '主旨
               
               strTemp(1) = convForm(CheckStr(strTemp(1)), 8)
               strTemp(2) = convForm(CheckStr(strTemp(2)), 10)
               strTemp(3) = convForm(CheckStr(strTemp(3)), 26)
               strTemp(4) = convForm(CheckStr(strTemp(4)), 20)
               strTemp(5) = convForm(CheckStr(strTemp(5)), 100)
               
'               Print #ff1, strTemp(1) & " " & strTemp(2) & " " & strTemp(3) & " " & strTemp(4) & " " & strTemp(5)
               strText = strText & strTemp(1) & " " & strTemp(2) & " " & strTemp(3) & " " & strTemp(4) & " " & "" & Trim(.Fields("ti17")) & vbCrLf
               .MoveNext
            Loop
'            Close ff1
         End With
      End If
      Call PUB_SaveTextAsUTF8(TempFileName, strText)
      If Dir(TempFileName) <> "" Then
         strTo = Pub_GetSpecMan("商標處信件檢核表收受者")
         SendMAPIMail strTo, "商標處信件處理結果檢核表，請檢視！", "Dear Sirs," & vbCrLf & "商標處信件處理結果檢核表，資料如附件，請橫印！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", TempFileName
      End If
   End If
   Set RsQ = Nothing
   
   Exit Sub
   
ErrHandle:
   If Err.Number <> 0 Then
      WLog "商標處信件處理結果檢核表:" & Err.Description
   End If
End Sub

'Add by  Amy 2020/05/27 新Y編號委案後第一道收文之專業發文完成後通知業拓
Private Sub StrMenu101()
    Dim RsQ As New ADODB.Recordset, rsA As New ADODB.Recordset
    Dim strQ As String, strTo As String, strSubject As String, strA As String
    Dim intQ As Integer, intA As Integer
    'Add by Amy 2021/09/29
    Dim intSysKind As Integer, strCC As String, strTmp As String
    Dim strContent As String, strHtmlTag As String '內容/Html表格語法
    Dim strF41P As String, strF41PN As String 'F41(業拓)部門人員/F41(業拓)部門人員姓名
    Dim strTxt(3) As String, strVal(2) As String, bolHasData As Boolean 'Add by Amy 2021/10/21
    Dim strTxt_Show(3) As String, strContent_Show As String 'Add by Amy 2021/11/24
    Dim strWhere As String 'Add by Amy 2022/11/25
    
    'Add by Amy 2021/09/29 +內容/Html表格語法
    'F41(業拓)部門人員
    strA = "Select st01,st02 From Staff Where st03='F41' And st04='1'And st01>'6' And st01<'F' And SubStr(st01,4,1)<>'9' Order by st01"
    intA = 1
    Set rsA = ClsLawReadRstMsg(intA, strA)
    If intA = 1 Then
        rsA.MoveFirst
        Do While Not rsA.EOF
            strF41P = strF41P & ";" & rsA.Fields("st01")
            strF41PN = strF41PN & ";" & rsA.Fields("st02") & "(" & rsA.Fields("st01") & ")"
            rsA.MoveNext
        Loop
        If strF41PN <> MsgText(601) Then strF41PN = Replace(Mid(strF41PN, 2), ";", "及")
    End If
    
    strHtmlTag = "<Table class=NTable border=1 cellspacing=0 cellpadding=0 style='margin-left:27.3pt;border-collapse:collapse;mso-yfti-tbllook:1184; mso-padding-alt:0cm 0cm 0cm 0cm'>" & _
                        "<tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;height:12.75pt'>" & _
                          "<td width=150 valign=top style='width:112.8pt;border:solid windowtext 1.0pt;padding:0cm 5.4pt 0cm 5.4pt;height:12.75pt'>對象(人名)</td>" & _
                          "<td width=332 valign=top style='width:248.65pt;border:solid windowtext 1.0pt;border-left:none;padding:0cm 5.4pt 0cm 5.4pt;height:12.75pt'></td>" & _
                        "</tr>" & _
                        "<tr style='mso-yfti-irow:1;height:12.75pt'>" & _
                          "<td width=150 valign=top style='width:112.8pt;border:solid windowtext 1.0pt;border-top:none;padding:0cm 5.4pt 0cm 5.4pt;height:12.75pt'>Title(Mr./Ms./Dr.)</td>" & _
                          "<td width=332 valign=top style='width:248.65pt;border:solid windowtext 1.0pt;border-left:none;padding:0cm 5.4pt 0cm 5.4pt;height:12.75pt'></td>" & _
                        "</tr>" & _
                        "<tr style='mso-yfti-irow:2;mso-yfti-lastrow:yes;height:12.75pt'>" & _
                          "<td width=150 valign=top style='width:112.8pt;border:solid windowtext 1.0pt;border-top:none;padding:0cm 5.4pt 0cm 5.4pt;height:12.75pt'>Email</td>" & _
                          "<td width=332 valign=top style='width:248.65pt;border:solid windowtext 1.0pt;border-left:none;padding:0cm 5.4pt 0cm 5.4pt;height:12.75pt'></td>" & _
                        "</tr>" & _
                        "</Table>"

    
    strContent = "<DIV dir=ltr style=""MARGIN-RIGHT: 0px"" align=left><FONT face=標楷體>" & _
                        "您好！" & vbCrLf & _
                        "YXXXXXXXX" & vbCrLf & vbCrLf
    'Modify by Amy 2022/12/27 商標內文調整-Widen
'    strContent = "<DIV dir=ltr style=""MARGIN-RIGHT: 0px"" align=left><FONT face=標楷體>" & _
'                        "您好！" & vbCrLf & _
'                        "YXXXXXXXX" & vbCrLf & vbCrLf & _
'                        "敬請承辦單位確認：" & vbCrLf & _
'                        "1.&nbsp;是否知道其來所的原因 (例如聯絡人以前在他所曾與本所案件往來，該聯絡人現在換到此家公司；或是他人介紹等)。" & vbCrLf & vbCrLf & _
'                        "2.&nbsp;如不清楚其來所的原因，業拓擬於近1週邀請填寫問卷。" & vbCrLf & _
'                        "&nbsp;&nbsp;&nbsp;問卷的內容會以讓填寫人感到方便樂意回覆的形式呈現，以了解新客戶是如何得知本所。" & vbCrLf & _
'                        "&nbsp;&nbsp;&nbsp;請確認適合發函的對象及Email。如有其他意見也歡迎提供。" & vbCrLf & _
'                        strHtmlTag & "<br>此封信函為自動寄發，請勿直接回覆。敬請回覆給業務拓展部 " & strF41PN & "。感謝！" & _
'                        "</FNOT></DIV>"
    strContent = "您好！" & vbCrLf & _
                        "YXXXXXXXX" & vbCrLf & vbCrLf
    'end 2021/09/29
    'Add by Amy 2021/10/21 修改顯示內文
    strTxt(0) = "<li>YXXX委案第一道收文已發文。</li><br>"
    'Modify by Amy 2022/12/27 +來所原因
    strTxt(1) = "名稱：＃＃＃<br>" & _
                     "國藉：＊＊＊<br>" & _
                     "收文案件性質：@@@<br>" & _
                     "來所原因：％％％<br>"
                     
    strTxt(2) = "<li>來所原因</li><br>" & _
                     "主旨：＃＃＃<br>" & _
                     "接洽同仁：＊＊＊<br>" & _
                     "內容：@@@<br>"
                     
    strTxt(3) = "<li>發函對象及Email</li><br>" & _
                     "＃＃＃<br>"
    'Add by Amy 2022/11/25 代理人來源欄位開始啟用後,只發來源12.未知的資料
    If strSrvDate(1) >= 代理人來源啟用日 Then
        strWhere = " And fa127='12' "
    End If
    strQ = CompWorkDay(2, strSrvDate(1), 1) '前1個工作天
    'Modify by Amy 2021/09/29 改只判斷cp12為FXX部門的資料,增加顯示系統類別及代理人國籍
    'Modify by Amy 2021/10/21 a.cp139語法加抓B類 T726/P937/L994 及排除編號有cp44且已有發文日者不通知
'    strQ = "Select Distinct cp139,cp01,fa10,Min(cp09) as CP09 From CaseProgress C,Fagent " & _
'              "Where cp27=" & strQ & " And cp09<'B' And SubStr(cp139,-3)='000' And SubStr(cp12,1,1)='F' And SubStr(cp139,1,8)=fa01(+) And SubStr(cp139,9,1)=fa02(+)" & _
'              "And cp139 Not In (Select a.cp139 From CaseProgress A Where A.cp139=cp139 And cp27>19221111 And cp27<" & strQ & " And cp09<'B'  ) "
    'Modify by Amy 2022/11/25 代理人來源欄位開始啟用後,只發來源12.未知的資料
    'Modify by Amy 2022/12/27 +fa127
    'Modify by Amy 2023/01/17 剔除FCP的242案件性質-Widen
    strQ = "Select YNo,Nvl(FA05||FA63||FA64||FA65,Decode(FA05,null,FA06,FA05||' '||FA63||' '||FA64||' '||FA65)) as FName,fa16 , fa80, fa81, fa82,SysKind, fa10,NA03" & _
                        ",cp01, cp02, cp03, cp04, CP10, mcp09,fa127 " & _
              "From CaseProgress,Fagent,Nation," & _
              "(Select Distinct cp139 as YNo,cp01 as SysKind,Min(cp09) as mCP09 From CaseProgress C " & _
              "Where cp27=" & strQ & " And cp09<'B' And SubStr(cp139,-3)='000' And SubStr(cp12,1,1)='F' " & _
              "And cp139 Not In (Select a.cp139 From CaseProgress A Where A.cp139=cp139 And cp27>19221111 And cp27<" & strQ & " And (cp09<'B' or (SUBSTR(a.CP09,1,1)='B' and a.CP01||a.CP10 not in('T726','P937','L994'))) ) " & _
              "And cp139 Not In (Select cp44 From CaseProgress  Where cp44=C.cp139 And CP27>19221111 and CP27<" & strQ & " ) " & _
              "Group by cp139,cp01) " & _
              "Where  mCP09=cp09(+) And fa10=na01(+) And SubStr(YNo,1,8)=fa01(+) And SubStr(YNo,9,1)=fa02(+) And cp01||cp10<>'FCP242' " & strWhere
    intQ = 1
    Set RsQ = ClsLawReadRstMsg(intQ, strQ)
    If intQ = 1 Then
        'Memo by Amy 2021/09/29 原F41(業拓)部門人員搬至上面抓
        RsQ.MoveFirst
        Do While Not RsQ.EOF
            strTmp = Pub_GetField("AllCode", "AC01='13' And AC02='" & RsQ.Fields("fa127") & "' ", "AC02||' '||AC03") 'Add by Amy 2022/12/27 +來所原因
            'Add by Amy 2021/10/21
            'Modify by Amy 2021/11/24 bug 原:strTxt(0) = Replace(strTxt(0), "YXXX", "" & RsQ.Fields("YNo")),多筆資料,資料未取代
            'strTxt_Show(0) = Replace(strTxt(0), "YXXX", "" & RsQ.Fields("YNo"))
            strTxt_Show(1) = Replace(strTxt(1), "＃＃＃", "" & RsQ.Fields("FName"))
            strTxt_Show(1) = Replace(strTxt_Show(1), "＊＊＊", "" & RsQ.Fields("Na03"))
            strTxt_Show(1) = Replace(strTxt_Show(1), "@@@", GetCaseTypeName("" & RsQ.Fields("SysKind"), "" & RsQ.Fields("cp10")))
            strTxt_Show(1) = Replace(strTxt_Show(1), "％％％", strTmp) 'Add by Amy 2022/12/27 +來所原因
            
            '來所原因有資料才顯示
            bolHasData = GetContactRecord(Left("" & RsQ.Fields("YNo"), 8), "cr06,cr08,cr19", strVal())
            If bolHasData = True Then
                strTxt_Show(2) = Replace(strTxt(2), "＃＃＃", strVal(0))
                strTxt_Show(2) = Replace(strTxt_Show(2), "＊＊＊", StaffQuery(strVal(2)))
                strTxt_Show(2) = Replace(strTxt_Show(2), "@@@", strVal(1))
            End If
            
            '發函對象及Email
            strTmp = ";" & GetCaseContectPerson("" & RsQ.Fields("cp01"), "" & RsQ.Fields("cp02"), "" & RsQ.Fields("cp03"), "" & RsQ.Fields("cp04")) & _
                        IIf("" & RsQ.Fields("fa16") <> "", ";" & RsQ.Fields("fa16"), "") & IIf("" & RsQ.Fields("fa80") <> "", ";" & RsQ.Fields("fa80"), "") & _
                        IIf("" & RsQ.Fields("fa81") <> "", ";" & RsQ.Fields("fa81"), "") & IIf("" & RsQ.Fields("fa82") <> "", ";" & RsQ.Fields("fa82"), "")
            strTxt_Show(3) = Replace(Replace(strTxt(3), "＃＃＃", Mid(strTmp, 2)), ";", "<br>")
            'end 2021/10/21
            'end 2021/11/24
            
            strTo = "" 'Modify by Amy 2021/11/01 原:If intA = 1 Then後,目前外專新代首道發文通知名單/副本已為空,若前一筆有資料變數會沒清空,導致發錯
            Call ClsPDGetSystemKind("" & RsQ.Fields("cp01"), intSysKind)
            'Modify by Amy 2022/08/03 +intSysKind=5 ex:FG-001421
            'Modify by Amy 2025/05/28 +intSysKind=6 ex:S-008815
            If intSysKind = 專利 Or intSysKind = 商標 Or intSysKind = 5 Or intSysKind = 6 Then
                If intSysKind = 專利 Or intSysKind = 5 Then
            'end 2022/08/03
                    'Memo 2025/05/28 外專、外商 新代首道發文通知名單/外專、外商 新代首道發文通知名單副本 [都不發],2022/12/27已改為只發業拓
                    strTmp = Pub_GetSpecMan("外專新代首道發文通知名單") 'Memo 2021/11/01 全不發
                    strCC = Pub_GetSpecMan("外專新代首道發文通知名單副本") 'Memo 2021/11/01 全不發
                    If "" & Left(RsQ.Fields("fa10"), 3) = "011" Then
                        strA = " And st16='2' "
                    Else
                        strA = " And st16<>'2' "
                    End If
                Else
                    strTmp = Pub_GetSpecMan("外商新代首道發文通知名單") 'Memo 2022/12/27 特殊設定原人員80030;96003;78011 全不發
                    strCC = Pub_GetSpecMan("外商新代首道發文通知名單副本") 'Memo 2022/12/27 特殊設定原人員98020 全不發
                    If "" & Left(RsQ.Fields("fa10"), 3) = "011" Then
                        strA = " And st16='4' "
                    Else
                        strA = " And st16<>'4' "
                    End If
                End If
                strA = "Select st01 From Staff Where st01 in('" & Replace(strTmp, ";", "','") & "')" & strA
                intA = 1
                Set rsA = ClsLawReadRstMsg(intA, strA)
                If intA = 1 Then
                    rsA.MoveFirst
                    Do While Not rsA.EOF
                        strTo = strTo & ";" & rsA.Fields("st01")
                        rsA.MoveNext
                    Loop
                End If
                strTo = strTo & strF41P
                If Left(strTo, 1) = ";" Then strTo = Mid(strTo, 2)
            Else
                strTo = strF41P
                strCC = ""
            End If
            'Added by Lydia 2022/05/27 每月、每日批次發通知無收受者時改發「程式管理人員」，以利查覺異常情形，才能儘早修改系統設定
            If strTo = "" Then
               strTo = Pub_GetSpecMan("程式管理人員")
            End If
            'end 2022/05/27
            
            'Modify by Amy 2021/10/21
            strSubject = "" & RsQ.Fields("YNo") & " 新事務所/直客委案第一道收文已發文，請於告申日號後另函邀請填寫問卷！"
            'PUB_SendMail strUserNum, strTo, "", strSubject, Replace(strContent, "YXXXXXXXX", "" & RsQ.Fields("cp139")), , , True, , , strCC
            'Modify by Amy 2021/11/24 bug 多筆資料,資料未取代
            If intSysKind = 專利 Then
                strTxt_Show(0) = Replace(strTxt(0), "YXXX", "" & RsQ.Fields("YNo"))
                strContent_Show = strTxt_Show(0) & strTxt_Show(1) & "<br>" & strTxt_Show(2) & "<br>" & strTxt_Show(3)
            Else
                strContent_Show = Replace(strContent, "YXXXXXXXX", "<br>YXXXXXXXX委案第一道收文已發文。<br>" & strTxt_Show(1))
                strContent_Show = Replace(strContent_Show, "YXXXXXXXX", "" & RsQ.Fields("YNo"))
            End If
            'Memo by Amy 2022/12/27 只發給F41(業拓)部門人員-Widen
            PUB_SendMail strUserNum, strTo, "", strSubject, strContent_Show, , , True, , , strCC
            'end 2021/11/24
            WLog "語法新Y編號委案第一道發文後通知業拓-To:" & strTo & " CC:" & strCC
            'end 2021/10/21
            RsQ.MoveNext
        Loop
    End If
    
    Set rsA = Nothing
    Set RsQ = Nothing
    Exit Sub
    
ErrHand:
    If Err.Number <> 0 Then
      WLog "新Y編號委案第一道發文後通知業拓:" & Err.Description
   End If
End Sub

'Add by Amy 2019/09/09 申請地址拆成郵遞區號及地址
Private Function AddrToZipAddr(ByVal strCAddr, Optional ByRef strZip As String) As String
   strZip = ""
   Do While Left(strCAddr, 1) >= "０" And Left(strCAddr, 1) <= "９"
      strZip = strZip & Left(strCAddr, 1)
      strCAddr = Mid(strCAddr, 2)
   Loop
   AddrToZipAddr = strCAddr
End Function

'Mark by Amy 2019/09/27
'Add by Amy  2016/04/29 非電腦中心變更申請地址提醒CFT承辦人及智權人員
Sub StrMenu75_Old()
'    Dim strQ As String, strCmd As String
'    Dim RsQ As New ADODB.Recordset
'    Dim strApatch As String, strFileN As String, strAttnF As String
'    Dim stDate(1) As String, strTemp(6) As String
'    Dim OldCU13 As String, oldCP14 As String, OldCU01 As String, OldCusN As String, OldM13 As String
'    Dim stDeptMan As String '部門主管
'    Dim strTo As String, strContent As String, strMailC(1) As String
'    Dim Txt_Head As Boolean
'    Dim F1 As Integer, F2 As Integer, ii As Integer
'    Dim bolData As Boolean, bolIsFirst As Boolean '是否有收文未發文資料/是否為第一筆
'    Dim bolIns As Boolean 'Add by Amy 2019/09/09
'
'On Error GoTo ErrHand
'    strApatch = App.path & TextPath
'    strFileN = "案件.txt"
'    stDate(0) = PUB_GetWorkDayAfterSysDate(CDbl(strSrvDate(1)), -1) + 19110000 '系統前一個工作日
'    stDeptMan = GetDeptMan("F10")
'
'    '刪除暫存檔
'    strCmd = "Delete From RABD75"
'    cnnConnection.Execute strCmd
'
'    '新增工作日前一日至非工作前一日有非電腦中心修改客戶檔之客戶編號至暫存檔中
'    'Modify by Amy 2019/09/26 +地址由無到有不通知
'    strCmd = "Insert into rabd75 (R001,R002,R013,R014) " & _
'                "Select Distinct SubStr(DL09,(InStr(UPPER(DL09),'CU01')+6),8) CU1,SubStr(DL09,(InStr(UPPER(DL09),'CU02')+6),1) CU2,DL07,'C' From DML_LOG,Staff " & _
'                "Where DL07>=" & stDate(0) & " And DL07<To_Char(SYSDATE,'YYYYMMDD') And UPPER(DL10)='CUSTOMER' And SubStr(DL09,2,2)='修改' And DL06=st01(+) And st03<>'M51' " & _
'                "And ((InStr(DL09,'CU23')>0 And InStr(DL09,'CU23[=>')=0) Or (InStr(DL09,'CU24')>0 And InStr(DL09,'CU24[=>')=0) Or (InStr(DL09,'CU25')>0 And InStr(DL09,'CU25[=>')=0) " & _
'                          "Or (InStr(DL09,'CU26')>0 And InStr(DL09,'CU26[=>')=0 ) Or (InStr(DL09,'CU27')>0 And InStr(DL09,'CU27[=>')=0 ) Or (InStr(DL09,'CU28')>0 And InStr(DL09,'CU28[=>')=0) " & _
'                          "Or (InStr(DL09,'CU29')>0 And InStr(DL09,'CU29[=>')=0 ) Or (InStr(DL09,'CU102')>0 And InStr(DL09,'CU102[=>')=0) ) "
'    cnnConnection.Execute strCmd
'
'    '以客戶編號前8碼抓商標案件之5個申請人有未閉卷未銷卷CFT案件
'    '2016/05/19 目前GetNA69未使用 秀玲:先Mark
''    strCmd = "Insert Into RABD75 (R001,R002,R004,R005,R006,R007,R008,R009,R010,R011,R012,R003,R014) " & _
''        "Select SubStr(tm23,1,8),SubStr(tm23,9,1),tm01,tm02,tm03,tm04,tm05,tm09,tm10,tm11,tm22,GetNA69(tm01,tm02,tm03,tm04,'','') as NA69,'Y' From TradeMark " & _
''                "Where tm01='CFT' And tm29 is null And tm57 is null And SubStr(tm23,1,8) in (Select R001 From RABD75 Where R014='C') " & _
''        "Union Select SubStr(tm78,1,8),SubStr(tm78,9,1),tm01,tm02,tm03,tm04,tm05,tm09,tm10,tm11,tm22,GetNA69(tm01,tm02,tm03,tm04,'','') as NA69,'Y' From TradeMark " & _
''                "Where tm01='CFT' And tm29 is null And tm57 is null And SubStr(tm78,1,8) in (Select R001 From RABD75 Where R014='C') " & _
''        "Union Select SubStr(tm79,1,8),SubStr(tm79,9,1),tm01,tm02,tm03,tm04,tm05,tm09,tm10,tm11,tm22,GetNA69(tm01,tm02,tm03,tm04,'','') as NA69,'Y' From TradeMark " & _
''               "Where tm01='CFT' And tm29 is null And tm57 is null And SubStr(tm79,1,8) in (Select R001 From RABD75 Where R014='C') " & _
''        "Union Select SubStr(tm80,1,8),SubStr(tm80,9,1),tm01,tm02,tm03,tm04,tm05,tm09,tm10,tm11,tm22,GetNA69(tm01,tm02,tm03,tm04,'','') as NA69,'Y' From TradeMark " & _
''               "Where tm01='CFT' And tm29 is null And tm57 is null And SubStr(tm80,1,8) in (Select R001 From RABD75 Where R014='C') " & _
''        "Union Select SubStr(tm81,1,8),SubStr(tm81,9,1),tm01,tm02,tm03,tm04,tm05,tm09,tm10,tm11,tm22,GetNA69(tm01,tm02,tm03,tm04,'','') as NA69,'Y' From TradeMark " & _
''              "Where tm01='CFT' And tm29 is null And tm57 is null And SubStr(tm81,1,8) in (Select R001 From RABD75 Where R014='C') "
'    'Modify by Amy 2018/01/15 原抓客戶前8碼改抓9碼 因1/12 改客戶X66552010 但以客戶8碼抓到CFT-013959 申請人為X66552011應不需出現
'    'Modify by Amy 2019/09/09 改一筆一筆判斷中、英、日欄位有修改才寫進暫存 ex:X8138900
''    strCmd = "Insert Into RABD75 (R001,R002,R004,R005,R006,R007,R008,R009,R010,R011,R012,R003,R014) " & _
''        "Select SubStr(tm23,1,8),SubStr(tm23,9,1),tm01,tm02,tm03,tm04,tm05,tm09,tm10,tm11,tm22,NA69,'Y' From TradeMark,Nation " & _
''                "Where tm01='CFT' And tm29 is null And tm57 is null And tm23 in (Select R001||R002 From RABD75 Where R014='C') And tm10=na01(+) " & _
''        "Union Select SubStr(tm78,1,8),SubStr(tm78,9,1),tm01,tm02,tm03,tm04,tm05,tm09,tm10,tm11,tm22,NA69,'Y' From TradeMark,Nation " & _
''                "Where tm01='CFT' And tm29 is null And tm57 is null And tm78 in (Select R001||R002 From RABD75 Where R014='C') And tm10=na01(+) " & _
''        "Union Select SubStr(tm79,1,8),SubStr(tm79,9,1),tm01,tm02,tm03,tm04,tm05,tm09,tm10,tm11,tm22,NA69,'Y' From TradeMark,Nation " & _
''               "Where tm01='CFT' And tm29 is null And tm57 is null And tm79 in (Select R001||R002 From RABD75 Where R014='C') And tm10=na01(+) " & _
''        "Union Select SubStr(tm80,1,8),SubStr(tm80,9,1),tm01,tm02,tm03,tm04,tm05,tm09,tm10,tm11,tm22,NA69,'Y' From TradeMark,Nation " & _
''               "Where tm01='CFT' And tm29 is null And tm57 is null And tm80 in (Select R001||R002 From RABD75 Where R014='C') And tm10=na01(+) " & _
''        "Union Select SubStr(tm81,1,8),SubStr(tm81,9,1),tm01,tm02,tm03,tm04,tm05,tm09,tm10,tm11,tm22,NA69,'Y' From TradeMark,Nation " & _
''              "Where tm01='CFT' And tm29 is null And tm57 is null And tm81 in (Select R001||R002 From RABD75 Where R014='C') And tm10=na01(+) "
'    strQ = ",tm01,tm02,tm03,tm04,tm05,tm09,tm10,tm11,tm22"
'    'Modify by Amy 2019/09/26 +CP31='Y'
'    strQ = "Select SubStr(Apply,1,8),SubStr(Apply,9,1)" & strQ & ",NA69,cu23,cu24,cu25,cu26,cu27,cu28,cu102,cu29,tm10,AC,AE,AJ From Customer,Nation,CaseProgress,(" & _
'                    "Select tm23 Apply" & strQ & ",tm24 AC,tm25 AE,tm26 AJ From TradeMark Where tm01='CFT' And tm29 is null And tm57 is null And tm23 in (Select R001||R002 From RABD75 Where R014='C') " & _
'         "Union Select tm78 Apply" & strQ & ",tm82 AC,tm86 AE,tm90 AJ From TradeMark Where tm01='CFT' And tm29 is null And tm57 is null And tm78 in (Select R001||R002 From RABD75 Where R014='C') " & _
'         "Union Select tm79 Apply" & strQ & ",tm83 AC,tm87 AE,tm91 AJ From TradeMark Where tm01='CFT' And tm29 is null And tm57 is null And tm79 in (Select R001||R002 From RABD75 Where R014='C') " & _
'         "Union Select tm80 Apply" & strQ & ",tm84 AC,tm88 AE,tm92 AJ From TradeMark Where tm01='CFT' And tm29 is null And tm57 is null And tm80 in (Select R001||R002 From RABD75 Where R014='C') " & _
'         "Union Select tm81 Apply" & strQ & ",tm85 AC,tm89 AE,tm93 AJ From TradeMark Where tm01='CFT' And tm29 is null And tm57 is null And tm81 in (Select R001||R002 From RABD75 Where R014='C') " & _
'              ")TM Where SubStr(Apply,1,8)=cu01(+) And SubStr(Apply,9,1)=cu02(+) And tm10=na01(+) And tm01=cp01(+) And tm02=cp02(+) And tm03=cp03(+) And tm04=cp04(+) And cp31='Y' "
'    RsQ.CursorLocation = adUseClient
'    RsQ.Open strQ, cnnConnection, adOpenStatic, adLockReadOnly
'    With RsQ
'        If .RecordCount > 0 Then
'            .MoveFirst
'            Do While .EOF = False
'                bolIns = False
'                '案件中文地址
'                strTemp(0) = ReplaceTWNo(AddrToZipAddr("" & .Fields("AC")))
'                '客戶中文地址
'                strTemp(1) = ReplaceTWNo("" & .Fields("cu23"))
'                If strTemp(0) = strTemp(1) Then
'                    '案件英文地址
'                    strTemp(0) = RTrim(UCase("" & .Fields("AE")))
'                    '客戶英文地址
'                    strTemp(1) = RTrim("" & .Fields("cu24"))
'                    If "" & .Fields("cu25") <> MsgText(601) Then strTemp(1) = RTrim(strTemp(1)) & " " & .Fields("cu25")
'                    If "" & .Fields("cu26") <> MsgText(601) Then strTemp(1) = RTrim(strTemp(1)) & " " & .Fields("cu26")
'                    If "" & .Fields("cu27") <> MsgText(601) Then strTemp(1) = RTrim(strTemp(1)) & " " & .Fields("cu27")
'                    If "" & .Fields("cu28") <> MsgText(601) Then strTemp(1) = RTrim(strTemp(1)) & " " & .Fields("cu28")
'                    If "" & .Fields("cu102") <> MsgText(601) Then strTemp(1) = RTrim(strTemp(1)) & " " & .Fields("cu102")
'                    If strTemp(0) = strTemp(1) Then
'                        '日文地址不同
'                        If "" & .Fields("AJ") <> "" & .Fields("cu29") Then
'                            bolIns = True
'                        End If
'                    '英文地址不同
'                    Else
'                        bolIns = True
'                    End If
'                '中文地址不同
'                Else
'                    bolIns = True
'                End If
'                If bolIns = True Then
'                    strCmd = ""
'                    For ii = 0 To 11
'                        strCmd = strCmd & "," & CNULL(ChgSQL("" & .Fields(ii)))
'                    Next ii
'                    '全部所有CFT案件(R014='Y')
'                    strCmd = "Insert Into RABD75 (R001,R002,R004,R005,R006,R007,R008,R009,R010,R011,R012,R003,R014) Values" & _
'                                    "(" & Mid(strCmd, 2) & ",'Y')"
'                    cnnConnection.Execute strCmd
'                End If
'                RsQ.MoveNext
'            Loop
'        End If
'
'    End With
'    RsQ.Close
'    'end 2019/09/09
'
'    '有收文未發文未取消收文之收文日最新收文號最小進度之承辦人,此道無承辦人設陳經理(68005)
'    'Modified by Lydia 2016/09/14 and cp05 is not null And cp27 is null And cp57 is null => AND NVL(CP05,0)>0 AND CP158=0 AND CP159=0
'    'Modify by Amy 2019/09/19 CFT-021139 因申請和超項費都沒未發文,查Max(cp05)||Min(cp09) 會抓錯抓到1080917及AA8041474
''    strCmd = "Update RABD75  Set R003=(Select Nvl(cp14, '68005') as CP14 From CaseProgress Where R004=cp01 and R005=cp02 And R006=cp03 And R007=cp04 AND NVL(CP05,0)>0 AND CP158=0 AND CP159=0 " & _
''                    "And cp05||cp09= (Select Max(cp05)||Min(cp09) From Caseprogress Where R004=cp01 and R005=cp02 And R006=cp03 And R007=cp04 AND NVL(CP05,0)>0 AND CP158=0 AND CP159=0)),R015='Y' " & _
''                "Where R014= 'Y' And Exists (Select * From CaseProgress Where R004=cp01(+) And R005=cp02(+) And R006=cp03(+) And R007=cp04(+) And NVL(CP05,0)>0 And CP158=0 And CP159=0) "
'    strCmd = "Select Max(cp05)||Min(cp09) From Caseprogress Where R004=cp01 And R005=cp02 And R006=cp03 And R007=cp04 And NVL(CP05,0)>0 And CP158=0 And CP159=0 " & _
'                    "And cp05=(Select Max(cp05) From Caseprogress Where R004=cp01 And R005=cp02 And R006=cp03 And R007=cp04 And NVL(CP05,0)>0 And CP158=0 And CP159=0)"
'    strCmd = "Update RABD75  Set R003=(Select Nvl(cp14, '68005') as CP14 From CaseProgress Where R004=cp01 And R005=cp02 And R006=cp03 And R007=cp04 And NVL(CP05,0)>0 And CP158=0 And CP159=0 And cp05||cp09= (" & strCmd & "))" & _
'                                                      ",R015='Y' " & _
'                    "Where R014= 'Y' And Exists (Select * From CaseProgress Where R004=cp01(+) And R005=cp02(+) And R006=cp03(+) And R007=cp04(+) And NVL(CP05,0)>0 And CP158=0 And CP159=0) "
'     cnnConnection.Execute strCmd
'
'    '*** 抓取資料寄信給智權人員cu13 ***
'    'Modify by Amy 2019/09/26 修改內文
'    strMailC(0) = "上述客戶有CFT案件明細如附件，經查該客戶於民國"
'    strMailC(1) = "修改地址，" & vbCrLf & "請與承辦人聯繫，討論是否辦理變更地址！" & vbCrLf & vbCrLf & "謹提醒如上。" & vbCrLf & vbCrLf & _
'                          "附件資料需列印，請橫印！" & vbCrLf & vbCrLf
'    'end 2019/09/26
'    strQ = "Select st02,na03,R004||'-'||R005||'-'||R006||'-'||R007 as CaseNo,R008 as CaseName,R009 as PClass,R011 as ApplyD,R012 as EndD" & _
'                ",cu13,R001 as CU01,Nvl(CU04,Nvl(cu05||' '||cu88||' '||cu89||' '||cu90,CU06)) as CusN,M13 as ModD " & _
'                "From RABD75 O,Customer,Nation,Staff,(Select R001 as M01,R002 as  M02,R013 as M13 From RABD75 Where R014='C') " & _
'                "Where R014='Y' And R001=cu01(+) And R002=cu02(+) And R010=na01(+) And R003=st01(+) And R001=M01(+) And R002=M02(+) " & _
'                "Order by cu13,R001,R003,R010,R004,R005,R006,R007"
'    RsQ.CursorLocation = adUseClient
'    RsQ.Open strQ, cnnConnection, adOpenStatic, adLockReadOnly
'    With RsQ
'         If .RecordCount > 0 Then
'            .MoveFirst
'            Do While .EOF = False
'                '產生資料寄信
'                If OldCU13 <> "" & .Fields("cu13") Or OldCU01 <> "" & .Fields("CU01") Then
'                    If OldCU13 <> MsgText(601) Or OldCU01 <> MsgText(601) Then
'                        If F1 > 0 Then Close #F1
'                        'Modify by Amy 2019/09/26 內文修改
'                        strContent = "Dear Sirs," & vbCrLf & vbCrLf & _
'                                             strMailC(0) & OldM13 & strMailC(1)
'                        strAttnF = strApatch & OldCU13 & "-" & OldCU01 & strFileN
'                        strTo = OldCU13
'                        SendMAPIMail strTo, OldCU01 & OldCusN & "地址變更提醒！", strContent, strAttnF
'                    End If
'                    Txt_Head = False
'                End If
'                If Txt_Head = False Then
'                    F1 = FreeFile
'                    Open strApatch & "" & .Fields("cu13") & "-" & .Fields("CU01") & strFileN For Output As F1
'                    Print #F1, "                                             " & "" & .Fields("CU01") & .Fields("CusN") & "地址變更案件明細"
'                    Print #F1, "列印日期：" & ChangeWStringToTString(strSrvDate(1))
'                    Print #F1, "承辦人員 申請國家   本所案號         案件名稱                       商品類別                          申請日     專用期止日 "
'                    Print #F1, "======== ========== ================ ============================== ================================= ========== ========== "
'                    Txt_Head = True
'                    bolData = False
'                End If
'
'                For ii = 0 To UBound(strTemp)
'                    strTemp(ii) = "" & .Fields(ii)
'                Next ii
'
'                strTemp(0) = convForm(CheckStr(strTemp(0)), 8)   '承辦人
'                strTemp(1) = convForm(CheckStr(strTemp(1)), 10) '申請國家
'                strTemp(2) = convForm(CheckStr(strTemp(2)), 16) '本所案號
'                strTemp(3) = convForm(CheckStr(strTemp(3)), 30) '案件名稱
'                strTemp(4) = convForm(CheckStr(strTemp(4) & IIf(Len(strTemp(4)) > 30, "...", "")), 33) '商品類別
'                strTemp(5) = convForm(CheckStr(ChangeWStringToWDateString(strTemp(5))), 10) '申請日
'                strTemp(6) = convForm(CheckStr(ChangeWStringToWDateString(strTemp(6))), 10) '專用期止日
'
'                Print #F1, strTemp(0) & " " & strTemp(1) & " " & strTemp(2) & " " & strTemp(3) & " " & strTemp(4) & _
'                          " " & strTemp(5) & " " & strTemp(6)
'
'                OldCU13 = "" & .Fields("cu13")
'                OldCU01 = "" & .Fields("CU01")
'                OldCusN = "" & .Fields("CusN")
'                OldM13 = Left("" & .Fields("ModD"), 4) - 1911 & "年" & Mid("" & .Fields("ModD"), 5, 2) & "月" & Mid("" & .Fields("ModD"), 7, 2) & "日"
'                .MoveNext
'            Loop
'        End If
'    End With
'    If F1 > 0 Then
'        Close F1
'        If OldCU13 <> MsgText(601) Then
'            'Modify by Amy 2019/09/26 內文修改
'            strContent = "Dear Sirs," & vbCrLf & vbCrLf & _
'                                strMailC(0) & OldM13 & strMailC(1)
'            strAttnF = strApatch & OldCU13 & "-" & OldCU01 & strFileN
'            strTo = OldCU13
'            SendMAPIMail strTo, OldCU01 & OldCusN & "地址變更提醒！", strContent, strAttnF
'        End If
'    End If
'    RsQ.Close
'
'    '*** 抓取CFT所有案件(含收文未發文案件)2份清單,寄信給承辦人cp14(承辦人null寄給F10部門主管)或NA69 ***
'    Erase strTemp
'    OldCU13 = "": OldCU01 = "": OldCU01 = "": OldM13 = "": strAttnF = "": strAttnF = "": Txt_Head = False: bolData = False: bolIsFirst = True
'    strMailC(0) = "，請參考案件明細與智權人員"
'    strMailC(1) = "，討論是否辦理變更地址！" & vbCrLf & vbCrLf & "請橫印！" & vbCrLf & vbCrLf
'
'    strQ = "Select na03,R004||'-'||R005||'-'||R006||'-'||R007 as CaseNo,R008 as CaseName,R009 as PClass,R011 as ApplyD,R012 as EndD" & _
'                ",st02,R003 as cp14,R001 as CU01,Nvl(CU04,Nvl(cu05||' '||cu88||' '||cu89||' '||cu90,CU06)) as CusN,M13 as ModD,R015 " & _
'                "From RABD75 O,Customer,Nation,Staff,(Select R001 as M01,R002 as  M02,R013 as M13 From RABD75 Where R014='C') " & _
'                "Where R014='Y' And R001=cu01(+) And R002=cu02(+) And R010=na01(+) And cu13=st01(+) And R001=M01(+) And R002=M02(+) " & _
'                "Order by R003,R001,cu13,R010,R004,R005,R006,R007"
'    RsQ.CursorLocation = adUseClient
'    RsQ.Open strQ, cnnConnection, adOpenStatic, adLockReadOnly
'    With RsQ
'        If .RecordCount > 0 Then
'            .MoveFirst
'            Do While .EOF = False
'                '產生資料寄信
'                If bolIsFirst = False And (oldCP14 <> "" & .Fields("cp14") Or OldCU01 <> "" & .Fields("CU01")) Then
'                    strTo = oldCP14: strAttnF = ""
'                    If F1 > 0 Then Close #F1
'                    strAttnF = strApatch & oldCP14 & "-" & OldCU01 & "-全部" & strFileN
'                    If F2 > 0 Then Close #F2
'                    If bolData = True Then strAttnF = strAttnF & ";" & strApatch & oldCP14 & "-" & OldCU01 & "-收文未發文" & strFileN
'                    strContent = "Dear Sirs," & vbCrLf & vbCrLf & _
'                                        "此客戶於民國" & OldM13 & strMailC(0) & "(" & OldCU13 & ")" & strMailC(1)
'                    If oldCP14 = MsgText(601) Then strTo = stDeptMan '承辦人為空寄給F10主管
'                    SendMAPIMail strTo, OldCU01 & OldCusN & "地址變更提醒！", strContent, strAttnF
'
'                    bolData = False
'                    Txt_Head = False
'                End If
'                If Txt_Head = False Then
'                    F1 = FreeFile
'                    Open strApatch & "" & .Fields("cp14") & "-" & .Fields("CU01") & "-全部" & strFileN For Output As F1
'                    Print #F1, "                                             " & "" & .Fields("CU01") & .Fields("CusN") & "地址變更案件明細"
'                    Print #F1, "列印日期：" & ChangeWStringToTString(strSrvDate(1))
'                    Print #F1, "申請國家   本所案號         案件名稱                       商品類別                          申請日     專用期止日 "
'                    Print #F1, "========== ================ ============================== ================================= ========== ========== "
'
'                    F2 = FreeFile
'                    Open strApatch & "" & .Fields("cp14") & "-" & .Fields("CU01") & "-收文未發文" & strFileN For Output As F2
'                    Print #F2, "                                   " & "" & .Fields("CU01") & .Fields("CusN") & "地址變更案件明細(收文未發文)"
'                    Print #F2, "列印日期：" & ChangeWStringToTString(strSrvDate(1))
'                    Print #F2, "申請國家   本所案號         案件名稱                       商品類別                          申請日     專用期止日 "
'                    Print #F2, "========== ================ ============================== ================================= ========== ========== "
'                    Txt_Head = True
'                End If
'
'                For ii = 0 To UBound(strTemp) - 1
'                    strTemp(ii) = "" & .Fields(ii)
'                Next ii
'
'                strTemp(0) = convForm(CheckStr(strTemp(0)), 10) '申請國家
'                strTemp(1) = convForm(CheckStr(strTemp(1)), 16) '本所案號
'                strTemp(2) = convForm(CheckStr(strTemp(2)), 30) '案件名稱
'                strTemp(3) = convForm(CheckStr(strTemp(3) & IIf(Len(strTemp(4)) > 30, "...", "")), 33) '商品類別
'                strTemp(4) = convForm(CheckStr(ChangeWStringToWDateString(strTemp(4))), 10) '申請日
'                strTemp(5) = convForm(CheckStr(ChangeWStringToWDateString(strTemp(5))), 10) '專用期止日
'
'                Print #F1, strTemp(0) & " " & strTemp(1) & " " & strTemp(2) & " " & strTemp(3) & " " & strTemp(4) & _
'                          " " & strTemp(5)
'
'                If "" & .Fields("R015") = "Y" Then
'                    If bolData = False Then bolData = True '是否為收文未發文資料,有資料同時寄此檔
'                    Print #F2, strTemp(0) & " " & strTemp(1) & " " & strTemp(2) & " " & strTemp(3) & " " & strTemp(4) & _
'                          " " & strTemp(5)
'                End If
'
'                oldCP14 = "" & .Fields("cp14")
'                OldCU13 = "" & .Fields("st02")
'                OldCU01 = "" & .Fields("CU01")
'                OldCusN = "" & .Fields("CusN")
'                OldM13 = Left("" & .Fields("ModD"), 4) - 1911 & "年" & Mid("" & .Fields("ModD"), 5, 2) & "月" & Mid("" & .Fields("ModD"), 7, 2) & "日修改地址"
'                bolIsFirst = False
'                .MoveNext
'            Loop
'            If F1 > 0 Then
'                Close F1
'                Close F2
'                strAttnF = "": strTo = oldCP14
'                strAttnF = strApatch & oldCP14 & "-" & OldCU01 & "-全部" & strFileN
'                If bolData = True Then strAttnF = strAttnF & ";" & strApatch & oldCP14 & "-" & OldCU01 & "-收文未發文" & strFileN
'                If oldCP14 = MsgText(601) Then strTo = stDeptMan '承辦人為空寄給F10主管
'                strContent = "Dear Sirs," & vbCrLf & vbCrLf & _
'                                    "此客戶於民國" & OldM13 & strMailC(0) & "(" & OldCU13 & ")" & strMailC(1)
'                SendMAPIMail strTo, OldCU01 & OldCusN & "地址變更提醒！", strContent, strAttnF
'            End If
'        End If
'    End With
'    RsQ.Close
'
'    Set RsQ = Nothing
'    Exit Sub
'
'ErrHand:
'    Set RsQ = Nothing
'    If F1 > 0 Then Close F1
'    If F2 > 0 Then Close F2
'    WLog Err.Description
End Sub

'Added by Morgan 2020/7/27
'HP檔案加密壓縮
Private Sub StrMenu102()
   Dim stSQL As String, intQ As Integer, iRound As Integer, stSrc As String, stErr As String
   Dim RsQ As ADODB.Recordset
   Dim stSaveName As String 'Added by Morgan 2022/8/16
   
   Const stTempFolder As String = "C:\ZipConvert"
   
   Dim bolRlt As Boolean, stFNo As String, stFName As String, stDataSrc As String
   Dim stOrgFile As String, stOrgFilePath As String, stZipFile As String, stZipFilePath As String, stZipName As String
   Dim fs, f, s
   
On Error GoTo ErrHnd
   
   If Dir(stTempFolder, vbDirectory) = "" Then
      MkDir stTempFolder
   Else
      PUB_ClearTempFolder stTempFolder
   End If
   
   Set fs = CreateObject("Scripting.FileSystemObject")
   
   For iRound = 1 To 2
      '卷宗區
      If iRound = 1 Then
         stSrc = "卷宗區"
         'Modified by Morgan 2025/3/28 +CPP19
         stSQL = "select cpp01 fNo,cpp02 fName,cpp12 fSrc, cpp14 fPath,cpp19" & _
            " from (select pa01,pa02,pa03,pa04 from patent where pa75='Y48292030'" & _
            " union select sp01,sp02,sp03,sp04 from servicepractice where sp26='Y48292030'" & _
            "),caseprogress,casepaperpdf c" & _
            " where cp01(+)=pa01 and cp02(+)=pa02 and cp03(+)=pa03 and cp04(+)=pa04" & _
            " and cpp01(+)=cp09 and cpp10<>'D' and cpp14 is not null" & _
            " and instr(lower(cpp02),'.encrypted.zip')=0"
      '原始檔
      Else
         stSrc = "原始檔"
         stSQL = "select cpf01 fNo, cpf02 fName,cpf11 fSrc, cpf13 fPath" & _
            " from (select pa01,pa02,pa03,pa04 from patent where pa75='Y48292030'" & _
            " union select sp01,sp02,sp03,sp04 from servicepractice where sp26='Y48292030'" & _
            "),caseprogress,casepaperfile c" & _
            " where cp01(+)=pa01 and cp02(+)=pa02 and cp03(+)=pa03 and cp04(+)=pa04" & _
            " and cpf01(+)=cp09  and cpf10<>'D' and cpf13 is not null" & _
            " and instr(lower(cpf02),'.encrypted.zip')=0"
      
      End If
      
      intQ = 1
      Set RsQ = ClsLawReadRstMsg(intQ, stSQL)
      If intQ = 0 Then
         'WLog stSrc & "無檔案待加密壓縮"
      Else
         With RsQ
         Do While Not .EOF
            stFNo = .Fields("fNo")
            stFName = .Fields("fName")
            stDataSrc = "" & .Fields("fSrc")
            
            '下載
            'Modified by Morgan 2022/8/16 修正檔名重複問題 Ex:FCP052018.991.52018.data.doc
            'stOrgFile = stFName
            stSaveName = GetGoodSaveName(stFName, iRound, stFNo)
            stOrgFile = stSaveName
            'end 2022/8/16
            
            stOrgFilePath = stTempFolder & "\" & stOrgFile
            If Dir(stOrgFilePath) <> "" Then Kill stOrgFilePath
            '卷宗區
            If iRound = 1 Then
               bolRlt = PUB_GetFtpFile(.Fields("fPath"), stOrgFilePath, "CASEPAPERPDF", True, , "" & .Fields("cpp19") <> "")
            '原始檔
            Else
               bolRlt = PUB_GetFtpFile(.Fields("fPath"), stOrgFilePath, "CASEPAPERFILE", True)
            End If
            
            If bolRlt = False Then
               WLog stSrc & ":" & stFName & " 下載失敗!!"
               GoTo ErrHnd
            End If
            
            '加密壓縮
            'Modified by Morgan 2022/8/16 修正檔名重複問題
            'stZipName = stFName & ".encrypted.zip"
            stZipName = stSaveName & ".encrypted.zip"
            'end 2022/8/16
   
            '改用固定檔名，因為有些檔名可能在會在壓縮時導致程式自動結束
            'stZipFile = stZipName
            stZipFile = "SrcFile.zip"
            stZipFilePath = stTempFolder & "\" & stZipFile
            If Dir(stZipFilePath) <> "" Then Kill stZipFilePath
            If PUB_ZipFile(stOrgFilePath, stZipFilePath, cHPZipPwd) = False Then
               WLog stSrc & ":" & stFName & " 壓縮失敗!!"
               GoTo ErrHnd
            End If
            
            '上傳
            Set f = fs.GetFile(stZipFilePath)
            'Modified by Morgan 2022/8/16 +發生錯誤不要彈訊息
            '卷宗區
            If iRound = 1 Then
               bolRlt = SaveAttFile_PDF(stFNo, stZipFilePath, stZipName, Format(f.DateLastModified, "YYYYMMDD"), Format(f.DateLastModified, "HHMMSS"), True, stDataSrc, , , , , , , False)
            '原始檔
            Else
               bolRlt = SaveAttFile_Org(stFNo, stZipFilePath, stZipName, Format(f.DateLastModified, "YYYYMMDD"), Format(f.DateLastModified, "HHMMSS"), stDataSrc, , , False)
            End If
            If bolRlt = False Then
               WLog stSrc & ":" & stFName & " 上傳失敗!!"
               GoTo ErrHnd
            End If
            
            '刪除註記
            If fnDelete(iRound, stFNo, stFName, stErr) = False Then
               WLog stErr & "," & stSrc & ":" & stFName & " 刪除註記失敗!!"
               GoTo ErrHnd
            End If
            WLog stSrc & ":" & stFName & " 加密壓縮成功!!"
            .MoveNext
         Loop
         End With
      End If
   Next
ErrHnd:
   If Err.Number <> 0 Then
      WLog Err.Description & "," & stSrc & ":" & stFName & " 加密壓縮失敗!!"
   End If
   Set RsQ = Nothing
   Set fs = Nothing
   
End Sub
'Added by Morgan 2020/7/27
Private Function fnDelete(pSrc As Integer, pNo As String, pName As String, Optional ByRef pErrMsg As String) As Boolean
   Dim iFlag As Integer
   
On Error GoTo ErrHnd
   cnnConnection.BeginTrans
   iFlag = 1
   '卷宗區
   If pSrc = 1 Then
      strSql = "delete from casepaperfile where cpf01='" & pNo & "' and cpf02='" & ChgSQL(pName) & ".del" & "'"
      cnnConnection.Execute strSql, intI
      strSql = "update casepaperpdf set cpp02=cpp02||'.del',cpp10='D' where cpp01='" & pNo & "' and cpp02='" & ChgSQL(pName) & "'"
      cnnConnection.Execute strSql, intI
   '原始檔
   Else
      strSql = "delete from casepaperfile where cpf01='" & pNo & "' and cpf02='" & ChgSQL(pName) & ".del" & "'"
      cnnConnection.Execute strSql, intI
      strSql = "update casepaperfile set cpf02=cpf02||'.del',cpf10='D' where cpf01='" & pNo & "' and cpf02='" & ChgSQL(pName) & "'"
      cnnConnection.Execute strSql, intI
   End If
   cnnConnection.CommitTrans
   fnDelete = True
   Exit Function
   
ErrHnd:
   pErrMsg = Err.Description
   If iFlag = 1 Then cnnConnection.RollbackTrans
   
End Function

'Added by Lydia 2020/12/03 新進人員試用期滿製作職務用章及名片通知---參考StrMenu29試用期滿通知
'Remove by Lydia 2020/12/07 取消：因為有時主管要延長試用期或者不續用，不見得一定在試用期滿前確定
'Sub StrMenu103()
'Dim ff103 As Integer
'Dim strTemp(0 To 3) As String
'Dim TempFileName As String
'Dim tmpnext As String
'Dim rsAD As New ADODB.Recordset
'Dim intQ As Integer
'Dim strDate1 As String
'
'On Error GoTo DebugErr
'
'   TempFileName = "新進人員試用期滿製作職務用章及名片通知"
'
'   If Dir(App.path & TextPath & "*" & TempFileName & " *.txt") <> "" Then
'      Kill App.path & TextPath & "*" & TempFileName & " *.txt"
'   End If
'
'   strDate1 = strSrvDate(1)
'
'   strSql = "SELECT DECODE(ST06,'1','北所','2','中所','3','南所','4','高所','其他') ST06N,NVL(VT1.D02,A0902) DEPTNAME,ST02,NVL(A1.AC03,A2.AC03) AS PERSON,ST01 " & _
'               "FROM STAFF, ACC090,ALLCODE A1, ALLCODE A2,(SELECT SUBSTR(A0901,1,1) AS D01,A0902 AS D02 FROM ACC090 WHERE A0901 ='F81' OR LENGTH(A0901)=1) VT1 " & _
'               "WHERE ST03=A0901(+) AND '01'=A1.AC01(+) AND ST20=A1.AC02(+) AND '02'=A2.AC01(+) AND ST21=A2.AC02(+) " & _
'               "AND ST04='1' AND ST06 IN ('1','2','3','4') AND SUBSTR(ST03,1,1)=VT1.D01(+) " & _
'               "AND TO_CHAR(TO_DATE(ST29,'YYYYMMDD')+1,'YYYYMMDD')=" & strDate1
'   strSql = strSql & " ORDER BY ST06 ASC,ST01 ASC"
'
'   intQ = 1
'   Set rsAD = ClsLawReadRstMsg(intQ, strSql)
'   If intQ = 1 Then
'       rsAD.MoveFirst
'       Do While Not rsAD.EOF
'            If ff103 = 0 Then
'                TempFileName = TransDate(strDate1, 1) & "-" & TempFileName
'                tmpnext = "開檔..."
'                ff103 = FreeFile
'                If ff103 > 0 Then Close #ff103
'                Open App.path & TextPath & TempFileName & ".txt" For Output As ff103
'                Print #ff103, Space(10) & TempFileName
'                Print #ff103, ""
'                '所別、部門、員工編號+名稱、職稱/職位
'                Print #ff103, convForm("所　別", 9) & convForm("部　　門", 21) & convForm("員工編號 + 名稱", 21) & convForm("職稱 / 職位", 20)
'                Print #ff103, "======== ==================== ==================== ===================="
'            End If
'            strTemp(0) = convForm("" & rsAD.Fields("ST06N"), 8)
'            strTemp(1) = convForm("" & rsAD.Fields("DEPTNAME"), 20)
'            strTemp(2) = convForm("" & rsAD.Fields("ST01") & " " & rsAD.Fields("ST02"), 20)
'            strTemp(3) = convForm("" & rsAD.Fields("PERSON"), 20)
'            Print #ff103, strTemp(0) & " " & strTemp(1) & " " & strTemp(2) & " " & strTemp(3)
'            rsAD.MoveNext
'       Loop
'       Print #ff103, String(GetTextLength(strTemp(0) & " " & strTemp(1) & " " & strTemp(2) & " " & strTemp(3)), "=")
'       Print #ff103, "P.S. 請向人事處確認新進人員的資料"
'   End If
'   If ff103 > 0 Then
'      tmpnext = "關檔..."
'      Close ff103
'      tmpnext = "寄信..."
'      'Email給 邱素蓮74028，CC給M14(因為黃志佑無個人PC，所以使用部門信箱)
'      SendMAPIMail "74028", ChangeWStringToTDateString(strDate1) & "新進人員試用期滿製作職務用章及名片通知", vbCrLf & "請參考附件" & vbCrLf, App.path & TextPath & TempFileName & ".txt", , , "M14"
'   End If
'
'   Set rsAD = Nothing
'   Exit Sub
'
'DebugErr:
'   WLog tmpnext & " " & Err.Description
'End Sub
'end 2020/12/07

'Added by Lydia 2021/01/15 CFP,CFT英國脫歐案自動上傳檔案
'Mark by Lydia 2021/01/28 確認下載完成並且正在進行發通知函作業，停止自動上傳功能。
'Private Sub StrRunUpNa239()
''分別將CFT(路徑為\\Typing2\國外部\UKIPO)、CFP(\\Pat1\cfp_temp\CFP通知英國再註冊設計)之UK案號之檔案，
''於相對應之歐盟案號產生一道C類來函「通知英國再註冊」CFP.1608、CFT.1730並寫入英國註冊號數於CP30及CP64，
''同時將UK檔案放入該筆C類來函之卷宗區有重覆的案號列清單給二單位確認
'Dim intR As Integer, iRound As Integer
'Dim rsQuery As New ADODB.Recordset
'Dim m_TempDir(1 To 2)  As String '下載之UK案號之檔案路徑 1-CFT, 2-CFP
'Dim fs, fso, fl
'Dim strFileName As String
'Dim stReName As String, strFullFileName As String
'Dim ff01 As Integer
'Dim iCount As Integer
'Dim bolConn As Boolean
'Dim strChk As String, pType As String
'
''保留測試資料夾
'  If UCase(pub_DbTerminalName) <> UCase(正式資料庫電腦名稱) Then
'     m_TempDir(1) = "C:\Users\A3034\Desktop\卷宗匯入區\UKIPO" 'CFT
'     m_TempDir(2) = "C:\Users\A3034\Desktop\卷宗匯入區\CFP通知英國再註冊設計" 'CFP
'  Else
'     m_TempDir(1) = "\\TYPING2\國外部\UKIPO" 'CFT
'     m_TempDir(2) = "\\PAT1\CFP_TEMP\CFP通知英國再註冊設計" 'CFP
'  End If
'
'On Error GoTo ErrHandle
'
'Set fs = CreateObject("Scripting.FileSystemObject")
'  For iRound = 1 To 2
'      If Not fs.FolderExists(m_TempDir(iRound)) Then
'           WLog "CFP,CFT英國脫歐案自動上傳檔案:資料夾不存在：" & m_TempDir(iRound)
'           GoTo JumpToNextRead
'      End If
'      If Dir(m_TempDir(iRound) & "\*.PDF") = "" Then
'           strChk = strChk & "," & IIf(iRound = 1, "CFT", "CFP")
'           GoTo JumpToNextRead
'      End If
'
'        '預設建立通知清單
'        If iRound = 2 And ff01 > 0 Then
'            Print #ff01, String(67, "=")
'            Print #ff01, "共" & iCount & "筆"
'            Close ff01
'            If iCount > 0 Then  '有資料才通知
'                SendMAPIMail "78028", strSrvDate(2) & "_CFT英國脫歐案自動上傳檔案", vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, App.path & TextPath & "\英國脫歐案自動上傳檔案.txt"
'            End If
'        End If
'        If Dir(App.path & TextPath & "*英國脫歐案自動上傳檔案.txt") <> "" Then
'            Kill App.path & TextPath & "*英國脫歐案自動上傳檔案.txt"
'        End If
'        pType = IIf(iRound = 1, "CFT", "CFP")
'        ff01 = FreeFile
'        Open App.path & TextPath & "\英國脫歐案自動上傳檔案.txt" For Output As ff01
'        Print #ff01, Space(20) & strSrvDate(2) & "_" & pType & "英國脫歐案自動上傳檔案通知清單"
'        Print #ff01, ""
'        Print #ff01, "檔  案  名  稱  " & " " & "狀          態"
'        Print #ff01, String(16, "=") & " " & String(50, "=")
'        iCount = 0
'
'        Set fso = fs.GetFolder(m_TempDir(iRound))
'
'        For Each fl In fso.files
'               strFileName = UCase(fl.Name)
'               strFullFileName = m_TempDir(iRound) & "\" & strFileName
'               '檔案大小為 0 KB 有誤
'               If fl.Size = 0 Then
'                    Print #ff01, convForm(Mid(strFileName, 1, Len(strFileName) - 4), 16) & " 檔案大小為 0 KB 有誤；"
'                    iCount = iCount + 1
'                    GoTo JumpToFile
'               End If
'               '檢查檔案是否正在使用中
'               If PUB_ChkFileOpening(strFullFileName) = True Then
'                    Print #ff01, convForm(Mid(strFileName, 1, Len(strFileName) - 4), 16) & " 檔案正在使用中（請關閉），方可繼續操作。"
'                    iCount = iCount + 1
'                    GoTo JumpToFile
'               End If
'
'             strFileName = Mid(strFileName, 1, Len(strFileName) - 4)
'             If iRound = 1 Then
'                 strExc(10) = "1730"
'                 'CFT申請號、審定號：UK009+歐盟號數後8碼(拿掉第1碼0)
'                 strSql = "SELECT TM01 AS CP01,TM02 AS CP02,TM03 AS CP03,TM04 AS CP04,NP01,NP22,NP10,decode(np06,'110',1,2) ord1,NP06,NP07,CPM03,A0901,'' AS A0916 " & _
'                              "FROM TRADEMARK, NEXTPROGRESS, CASEPROPERTYMAP,STAFF,ACC090  " & _
'                              "WHERE TM01='CFT' AND TM10='239' AND NVL(TM15,TM12)=" & CNULL("0" & Mid(strFileName, 6)) & _
'                              " AND TM01=NP02(+) AND TM02=NP03(+) AND TM03=NP04(+) AND TM04=NP05(+) AND NP07 IN ('110','710') " & _
'                              "AND NP02=CPM01(+) AND NP07=CPM02(+) AND NP10=ST01(+) AND ST15=A0901(+) "
'                 'Added by Lydia 2021/01/21 CFT 已有英國新案一併上傳
'                 strSql = strSql & "Union SELECT TM01 AS CP01,TM02 AS CP02,TM03 AS CP03,TM04 AS CP04,NP01,NP22,NP10,0 ORD1,NP06,NP07,CPM03,A0901,'' AS A0916 " & _
'                             "FROM TRADEMARK, NEXTPROGRESS, CASEPROPERTYMAP,STAFF,ACC090 WHERE TM01='CFT' AND TM10='201' AND NVL(TM15,TM12) ='" & strFileName & "' " & _
'                             "AND TM01=NP02(+) AND TM02=NP03(+) AND TM03=NP04(+) AND TM04=NP05(+) AND NP07 IN ('102','710') " & _
'                             "AND NP02=CPM01(+) AND NP07=CPM02(+) AND NP10=ST01(+) AND ST15=A0901(+) "
'             Else
'                 strExc(10) = "1608"
'                 'CFP專利號：9+歐盟設計專利號(拿掉-符號)
'                 strSql = "SELECT PA01 AS CP01,PA02 AS CP02,PA03 AS CP03,PA04 AS CP04,NP01,NP22,decode(np06,'613',1,2) ord1,NP10,NP06,NP07,CPM03,A0901,A0916 " & _
'                              "From PATENT, NEXTPROGRESS, CASEPROPERTYMAP,STAFF,ACC090 " & _
'                              "WHERE PA01='CFP' AND PA09='239' AND REPLACE(PA22,'-','')=" & CNULL(Mid(strFileName, 2)) & _
'                              " AND PA01=NP02(+) AND PA02=NP03(+) AND PA03=NP04(+) AND PA04=NP05(+) AND NP07 IN ('613','444') " & _
'                              "AND NP02=CPM01(+) AND NP07=CPM02(+) AND NP10=ST01(+) AND ST15=A0901(+) "
'             End If
'             strSql = strSql & " ORDER BY ord1 "
'             intR = 1
'             Set rsQuery = ClsLawReadRstMsg(intR, strSql)
'             If intR = 0 Then
'                 Print #ff01, convForm(strFileName, 16) & " 查無基本檔資料；"
'                 iCount = iCount + 1
'             Else
'                 rsQuery.MoveFirst
'                 'Modified by Lydia 2021/01/21 CFT 已有英國新案一併上傳
'                 'If "" & rsQuery.Fields("NP06") <> "" Then
'                 If "" & rsQuery.Fields("NP06") <> "" And "" & rsQuery.Fields("ord1") <> "0" Then
'                     Print #ff01, convForm(strFileName, 16) & " " & rsQuery.Fields("CP01") & "-" & rsQuery.Fields("CP02") & "-" & rsQuery.Fields("CP03") & "-" & rsQuery.Fields("CP04") & IIf(rsQuery.Fields("NP06") = "Y", "已收文英國新案；", "已確認不續辦；")
'                     iCount = iCount + 1
'                 Else
'                     strExc(0) = "SELECT CP09 FROM CASEPROGRESS WHERE CP01='" & rsQuery.Fields("CP01") & "' AND CP02='" & rsQuery.Fields("CP02") & "' AND CP03='" & rsQuery.Fields("CP03") & "' AND CP04='" & rsQuery.Fields("CP04") & "' AND CP159=0 AND CP10='" & strExc(10) & "' "
'                     intI = 1
'                     Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
'                     If intI = 1 Then
'                         Print #ff01, convForm(strFileName, 16) & " " & rsQuery.Fields("CP01") & "-" & rsQuery.Fields("CP02") & "-" & rsQuery.Fields("CP03") & "-" & rsQuery.Fields("CP04") & "已有通知英國再註冊進度；"
'                         iCount = iCount + 1
'                     Else
'                         strExc(9) = AutoNo("C", 6)
'                         If iRound = 1 Then  'CFT
'                              Call GetNA69("", "239", "" & rsQuery.Fields("np10"), strExc(4), rsQuery.Fields("cp01"), rsQuery.Fields("cp02"), rsQuery.Fields("cp03"), rsQuery.Fields("cp04"))
'                         Else    'CFP
'                              strExc(4) = "" & rsQuery.Fields("A0916")
'                         End If
'                         'Modified by Lydia 2021/01/19 不上發文日,等到全部齊全並且發通知email給客戶,再人工整批上發文日(by玫音,與葉芳如確認過)
                          'Modified by Lydia 2021/03/17 CFT改用「英國脫歐案審定號數」;DB一併更新
'                         'strSql = "INSERT INTO CASEPROGRESS(cp01,cp02,cp03,cp04,cp05,cp09,cp10,cp12,cp13,cp14,cp20,cp26,cp27,cp30,cp32,cp64) values (" & _
'                                     CNULL(rsQuery.Fields("cp01")) & "," & CNULL(rsQuery.Fields("cp02")) & "," & CNULL(rsQuery.Fields("cp03")) & "," & CNULL(rsQuery.Fields("cp04")) & "," & strSrvDate(1) & "," & CNULL(strExc(9)) & "," & _
'                                     CNULL(strExc(10)) & "," & CNULL(rsQuery.Fields("a0901")) & "," & CNULL(rsQuery.Fields("np10")) & "," & CNULL(strExc(4)) & "," & _
'                                     " 'N', 'N', " & strSrvDate(1) & "," & CNULL(strFileName) & ", 'N'," & CNULL(iif(rsQuery.Fields("cp01") = "CFP", "英國脫歐案專利號數：", "英國脫歐案審定號數：") & strFileName & ";") & ") "
'                        'Modified by Lydia 2021/01/21 英國新案不用輸入英國脫歐案專利號數
'                        'strSql = "INSERT INTO CASEPROGRESS(cp01,cp02,cp03,cp04,cp05,cp09,cp10,cp12,cp13,cp14,cp20,cp26,cp27,cp30,cp32,cp64) values (" & _
'                                     CNULL(rsQuery.Fields("cp01")) & "," & CNULL(rsQuery.Fields("cp02")) & "," & CNULL(rsQuery.Fields("cp03")) & "," & CNULL(rsQuery.Fields("cp04")) & "," & strSrvDate(1) & "," & CNULL(strExc(9)) & "," & _
'                                     CNULL(strExc(10)) & "," & CNULL(rsQuery.Fields("a0901")) & "," & CNULL(rsQuery.Fields("np10")) & "," & CNULL(strExc(4)) & "," & _
'                                     " 'N', 'N', NULL," & CNULL(strFileName) & ", 'N'," & CNULL(iif(rsQuery.Fields("cp01") = "CFP", "英國脫歐案專利號數：", "英國脫歐案審定號數：") & strFileName & ";") & ") "
                           'Modified by Lydia 2021/03/17 CFT改用「英國脫歐案審定號數」;DB一併更新
'                         strSql = "INSERT INTO CASEPROGRESS(cp01,cp02,cp03,cp04,cp05,cp09,cp10,cp12,cp13,cp14,cp20,cp26,cp27,cp30,cp32,cp64) values (" & _
'                                     CNULL(rsQuery.Fields("cp01")) & "," & CNULL(rsQuery.Fields("cp02")) & "," & CNULL(rsQuery.Fields("cp03")) & "," & CNULL(rsQuery.Fields("cp04")) & "," & strSrvDate(1) & "," & CNULL(strExc(9)) & "," & _
'                                     CNULL(strExc(10)) & "," & CNULL(rsQuery.Fields("a0901")) & "," & CNULL(rsQuery.Fields("np10")) & "," & CNULL(strExc(4)) & "," & _
'                                     " 'N', 'N', NULL," & CNULL(IIf("" & rsQuery.Fields("ord1") = "0", "", strFileName)) & ", 'N'," & CNULL(IIf("" & rsQuery.Fields("ord1") = "0", "", IIf(rsQuery.Fields("cp01") = "CFP", "英國脫歐案專利號數：", "英國脫歐案審定號數：") & strFileName & ";")) & ") "
'                         If bolConn = False Then
'                            bolConn = True
'                            cnnConnection.BeginTrans
'                         End If
'                         cnnConnection.Execute strSql
'                         ' 上傳到卷宗區
'                         stReName = PUB_FCPCaseNo2FileName(rsQuery.Fields("CP01"), rsQuery.Fields("CP02"), rsQuery.Fields("CP03"), rsQuery.Fields("CP04")) & "." & strExc(10) & ".ATT.PDF"
'                         If SaveAttFile_PDF(strExc(9), strFullFileName, stReName, Format(fl.DateLastModified, "YYYYMMDD"), Format(fl.DateLastModified, "HHMMSS"), False) = False Then
'                            Print #ff01, convForm(strFileName, 16) & " " & rsQuery.Fields("CP01") & "-" & rsQuery.Fields("CP02") & "-" & rsQuery.Fields("CP03") & "-" & rsQuery.Fields("CP04") & "上傳到卷宗區失敗；"
'                            iCount = iCount + 1
'                            cnnConnection.RollbackTrans
'                            bolConn = False
'                            Sleep 1000
'                            GoTo JumpToFile
'                         Else
'                            cnnConnection.CommitTrans
'                            bolConn = False
'                            Sleep 1000
'                            fs.DeleteFile strFullFileName, True '刪檔
'                         End If
'                     End If
'                 End If  'If "" & rsQuery.Fields("NP06") <> "" Then
'             End If
'JumpToFile:
'        Next 'For Each fl In fso.files
'
'JumpToNextRead:
'  Next iRound
'
'  '寄通知清單
'  iRound = iRound - 1
'  If pType <> "" And ff01 > 0 Then
'      Print #ff01, String(67, "=")
'      Print #ff01, "共" & iCount & "筆"
'      Close ff01
'      If iCount > 0 Then  '有資料才通知; CFT給葉芳如78028，CFP給陳玫音99043
'          SendMAPIMail IIf(pType = "CFT", "78028", "99043"), strSrvDate(2) & "_" & pType & "英國脫歐案自動上傳檔案", vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, App.path & TextPath & "\英國脫歐案自動上傳檔案.txt"
'      End If
'  End If
'  If strChk <> "" Then
'     SendMAPIMail "A3034", strSrvDate(2) & "_英國脫歐案自動上傳檔案：" & Mid(strChk, 2) & "資料夾無PDF檔", vbCrLf & vbCrLf & _
'                 IIf(InStr(strChk, "CFT") > 0, "CFT：" & m_TempDir(1) & vbCrLf, "") & _
'                 IIf(InStr(strChk, "CFP") > 0, "CFT：" & m_TempDir(2) & vbCrLf, "")
'  End If
'
'ErrHandle:
'  If Err.Number <> 0 Then
'      If bolConn = True Then
'          cnnConnection.RollbackTrans
'      End If
'      WLog Err.Description
'  End If
'  Set rsQuery = Nothing
'  Set fs = Nothing
'
'End Sub

'Add by Sindy 2021/4/15 FCP新案翻譯未核完/未完稿期限控管，達本所期限前1個月，系統自動發EMail通知相關人員
Private Sub StrMenu104()
Dim RsQ As New ADODB.Recordset, rsA As New ADODB.Recordset
Dim strQ As String, strTo As String, strSubject As String, strA As String
Dim intQ As Integer, intA As Integer
Dim strCC As String, strContent As String
Dim strChkDate As String, strChkDate0 As String, strConSql As String
   
   strChkDate0 = CompWorkDay(2, strSrvDate(1), 1) '前一個工作天
   strChkDate = DBDATE(DateAdd("m", 1, Format(strSrvDate(1), "####/##/##"))) '系統日+1個月
   'Add By Sindy 2025/1/7 遇假日會有少檢查到的期限
   If strChkDate0 = CompDate(2, -1, strSrvDate(1)) Then '前一個工作天=前1日(日曆天)
      strConSql = " AND cp06=" & strChkDate
   Else
      strConSql = " AND (cp06>" & DBDATE(DateAdd("m", 1, Format(strChkDate0, "####/##/##"))) & " and cp06<=" & strChkDate & ")"
   End If
   '2025/1/7 END
   '未核完案件
   strQ = "SELECT ep02,ep04,cp14,ep08,ep09,ep33,CP158,CP159,CP06,CP01,CP02,CP03,CP04,S1.ST01,S1.ST02,S1.ST16,pa150,TCT10" & _
          " FROM CASEPROGRESS,ENGINEERPROGRESS,PATENT,STAFF S1" & _
          ",(SELECT DISTINCT cp01 TCTcp01,cp02 TCTcp02,cp03 TCTcp03,cp04 TCTcp04,TCT10 FROM TRANSCASETITLE,caseprogress WHERE tct01=cp09(+) and cp09 is not null) TCT" & _
          " WHERE CP10='201' AND substr(CP12,1,1)='F' AND CP158=0 AND CP159=0" & _
          " AND EP02(+)=CP09 AND EP09 >0 AND EP33 IS NULL" & _
          " AND PA01(+)=CP01 AND PA02(+)=CP02 AND PA03(+)=CP03 AND PA04(+)=CP04 AND PA57||PA108 IS NULL AND PA01 IS NOT NULL" & _
          " AND ep04=s1.st01(+)" & _
          " AND TCTcp01(+)=CP01 AND TCTcp02(+)=CP02 AND TCTcp03(+)=CP03 AND TCTcp04(+)=CP04" & _
          strConSql & _
          " ORDER BY ep04,CP01,CP02,CP03,CP04"
   intQ = 1
   Set RsQ = ClsLawReadRstMsg(intQ, strQ)
   If intQ = 1 Then
      RsQ.MoveFirst
      Do While Not RsQ.EOF
         strTo = ""
         'Modify By Sindy 2022/11/24 王協理2022/12/01即將退休，此處程式僅刪除王文安即可
         If strSrvDate(1) >= "20221130" Then
            strCC = ""
         Else
         '2022/11/24 END
            strCC = "88003" '王協理
         End If
         If "" & RsQ.Fields("ep04") <> "" Then
            strTo = RsQ.Fields("ep04") '核稿人
            strCC = IIf(strCC <> "", strCC & ";", "") & PUB_GetFCPEngSup(RsQ.Fields("ep04"), True) '王協理+工程師主管(副理)
         ElseIf "" & RsQ.Fields("TCT10") <> "" Then
            strTo = PUB_GetFCPEngSup(RsQ.Fields("TCT10"), True) '工程師主管(副理)
         End If
         'Add By Sindy 2024/6/17 加發二級主管
         strExc(10) = GetST52SelfList(strTo)
         If InStr(strCC, strExc(10)) = 0 Then
            strCC = strExc(10) & IIf(strCC <> "", ";" & strCC, "")
         End If
         '2024/6/17 END
         
         strSubject = RsQ.Fields("cp01") & "-" & RsQ.Fields("cp02") & _
                      IIf(RsQ.Fields("cp03") + RsQ.Fields("cp04") = "000", "", "-" & RsQ.Fields("cp03") & "-" & RsQ.Fields("cp04")) & _
                      "【中說期限1個月將到期】"
         
         strContent = "本所案號：" & RsQ.Fields("cp01") & "-" & RsQ.Fields("cp02") & _
                      IIf(RsQ.Fields("cp03") + RsQ.Fields("cp04") = "000", "", "-" & RsQ.Fields("cp03") & "-" & RsQ.Fields("cp04")) & vbCrLf
         strContent = strContent & "完  稿  日：" & ChangeWStringToTDateString("" & RsQ.Fields("ep09")) & vbCrLf
         strContent = strContent & "核稿期限：" & ChangeWStringToTDateString("" & RsQ.Fields("ep08")) & vbCrLf
         strContent = strContent & "本所期限：" & ChangeWStringToTDateString("" & RsQ.Fields("cp06")) & vbCrLf & vbCrLf
         strContent = strContent & "中說本所期限1個月後將到期，若非客戶原因不得延期，請確認是否能如期完成核稿送件？" & vbCrLf
         strContent = strContent & "若【否】請更改核稿人員" & vbCrLf & vbCrLf
         strContent = strContent & "※若欲改核稿人請通知程序分案人員（Teresa）" 'Memo by Lydia 2022/05/27 + Teresa=85033
         
         If strTo <> "" Then
            PUB_SendMail strUserNum, strTo, "", strSubject, strContent, , , , , , strCC
         End If
         RsQ.MoveNext
      Loop
   End If
   
   'Add By Sindy 2021/5/6
   'Modify By Sindy 2025/1/7 + strConSql
   '未完稿案件
   strQ = "SELECT ep02,ep04,cp14,ep08,ep09,ep33,CP158,CP159,CP06,CP01,CP02,CP03,CP04,ST01,ST02,ST16,pa150,TCT10,cp48" & _
          " FROM CASEPROGRESS,ENGINEERPROGRESS,PATENT,STAFF" & _
          ",(SELECT DISTINCT cp01 TCTcp01,cp02 TCTcp02,cp03 TCTcp03,cp04 TCTcp04,TCT10 FROM TRANSCASETITLE,caseprogress WHERE tct01=cp09(+) and cp09 is not null) TCT" & _
          " WHERE CP10='201' AND substr(CP12,1,1)='F' AND CP158=0 AND CP159=0" & _
          " AND EP02(+)=CP09 AND EP09||EP33 IS NULL" & _
          " AND PA01(+)=CP01 AND PA02(+)=CP02 AND PA03(+)=CP03 AND PA04(+)=CP04 AND PA57||PA108 IS NULL AND PA01 IS NOT NULL" & _
          " AND cp14 is not null AND cp14=st01(+)" & _
          " AND TCTcp01(+)=CP01 AND TCTcp02(+)=CP02 AND TCTcp03(+)=CP03 AND TCTcp04(+)=CP04" & _
          strConSql & _
          " ORDER BY ep04,CP01,CP02,CP03,CP04"
   intQ = 1
   Set RsQ = ClsLawReadRstMsg(intQ, strQ)
   If intQ = 1 Then
      RsQ.MoveFirst
      Do While Not RsQ.EOF
         strTo = ""
         strCC = Pub_GetSpecMan("M") '國外部專利處翻譯未交稿管制人
         
         '員工
         If Left(RsQ.Fields("cp14"), 1) <> "F" Then
            strTo = RsQ.Fields("cp14")
            strCC = PUB_GetFCPEngSup(RsQ.Fields("cp14"), True) & ";" & strCC '工程師主管(副理)
         Else
            strExc(0) = "SELECT st01,st02,st15,SIM01,SIM02" & _
                        " FROM STAFF_IDMAP,staff" & _
                        " WHERE ST01=SIM02(+) AND st01='" & RsQ.Fields("cp14") & "'"
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               If RsTemp.Fields("st15") = "F51" Then '國外部外翻
                  strTo = Pub_GetSpecMan("M") '國外部專利處翻譯未交稿管制人
                  strCC = ""
               Else
                  If "" & RsTemp.Fields("SIM01") <> "" Then
                     strTo = RsTemp.Fields("SIM01") '所內翻譯
                     strCC = PUB_GetFCPEngSup(RsTemp.Fields("SIM01"), True) & ";" & strCC '工程師主管(副理)
                  End If
               End If
            End If
         End If
         
         strSubject = RsQ.Fields("cp01") & "-" & RsQ.Fields("cp02") & _
                      IIf(RsQ.Fields("cp03") + RsQ.Fields("cp04") = "000", "", "-" & RsQ.Fields("cp03") & "-" & RsQ.Fields("cp04")) & _
                      "【翻譯尚未完稿-中說期限1個月將到期】"
         
         strContent = "本  所  案  號：" & RsQ.Fields("cp01") & "-" & RsQ.Fields("cp02") & _
                      IIf(RsQ.Fields("cp03") + RsQ.Fields("cp04") = "000", "", "-" & RsQ.Fields("cp03") & "-" & RsQ.Fields("cp04")) & vbCrLf
         If strCC = "" Then
            strContent = strContent & "翻譯承辦人：" & RsQ.Fields("ST01") & " " & RsQ.Fields("ST02") & vbCrLf
         End If
         strContent = strContent & "翻譯交稿期限：" & ChangeWStringToTDateString("" & RsQ.Fields("cp48")) & vbCrLf
         strContent = strContent & "本  所  期  限：" & ChangeWStringToTDateString("" & RsQ.Fields("cp06")) & vbCrLf & vbCrLf & vbCrLf
         If strCC <> "" Then
            strContent = strContent & "請您儘速完成交稿，以利後續作業，謝謝。"
         End If

         If strTo <> "" Then
            PUB_SendMail strUserNum, strTo, "", strSubject, strContent, , , , , , strCC
         End If
         RsQ.MoveNext
      Loop
   End If
   
   Set RsQ = Nothing
   Exit Sub
    
ErrHand:
   If Err.Number <> 0 Then
      WLog "FCP新案翻譯未核完/未完稿期限控管:" & Err.Description
   End If
End Sub

'Added by Lydia 2021/05/26 ACS智財顧問案之顧問期間到期通知 (ACS智財顧問專業分配比例管制) ---限制工作天執行
Private Sub StrMenu105()
Dim RsQ As New ADODB.Recordset
Dim strQ As String, intQ As Integer
Dim strChkDate As String
Dim strCP01 As String, strCP02 As String, strCP03 As String, strCP04 As String, strCP09 As String

On Error GoTo ErrHnd
    '到期次一工作天開始計算
    strChkDate = CompWorkDay(2, strSrvDate(1), 1)

    '逐案處理到期案件
    'Modified by Lydia 2022/12/02 不限制未發文and cp158=0 and cp159=0 =>
    strQ = "select cp01,cp02,cp03,cp04,cp05,cp09,cp10,cp12,cp13,cp14,nvl(cp15,0) cp15,cp53,cp54 " & _
              " from caseprogress where  cp01='ACS' and cp10='112' and cp159=0 and cp54=" & strChkDate & _
              " order by cp05 "
    intQ = 1
    Set RsQ = ClsLawReadRstMsg(intQ, strQ)
    If intQ = 1 Then
        RsQ.MoveFirst
        Do While Not RsQ.EOF
            strCP01 = "" & RsQ.Fields("cp01")
            strCP02 = "" & RsQ.Fields("cp02")
            strCP03 = "" & RsQ.Fields("cp03")
            strCP04 = "" & RsQ.Fields("cp04")
            strCP09 = "" & RsQ.Fields("cp09")
            '共用模組：更新專業分配比例檔ACSPFRate檔的實際分配比例, 供每日批次frmAutoBatchDay和智財顧問案重新計算各部門實際比例frm081033
            If PUB_RunStrMenu105(strCP01, strCP02, strCP03, strCP04, strCP09, "QPGMR") = False Then
                WLog "ACS智財顧問案之顧問期間到期通知管制:" & strCP01 & "-" & strCP02 & "-" & strCP03 & "-" & strCP04 & "(" & strCP09 & ")更新失敗"
            End If
            RsQ.MoveNext
        Loop
    End If
    
ErrHnd:
   If Err.Number <> 0 Then
       WLog "ACS智財顧問案之顧問期間到期通知管制:" & strCP01 & "-" & strCP02 & "-" & strCP03 & "-" & strCP04 & "(" & strCP09 & ")更新失敗"
   End If
   Set RsQ = Nothing
End Sub

'Add by Amy 2021/09/22 合約資料正本若於資料建立後,一個月未交回正本,發信通知承辦人及合約資料建立者
Private Sub StrMenu106()
    Dim RsQ As New ADODB.Recordset
    Dim stQ As String, stTmp As String, intQ As Integer
    Dim stSubject_Fix As String, stContent_Fix As String
    Dim stCmpN As String, stCT01 As String, stCT03 As String, stDate As String '公司名稱/契約編號/契約名稱/建檔日
    Dim stSubject As String, stContent As String, stTO As String, stCC As String '內文/主旨/智權人員/建立者

On Error GoTo ErrHnd
    stSubject_Fix = "為提醒取回本所與xx公司所簽訂xx契約之正本事。"
    stContent_Fix = "敬啟者," & vbCrLf & vbCrLf & _
                             "本所與xx公司簽訂xx契約已於xx年月日核可用印，惟正本尚未交回法律所列管上傳，" & vbCrLf & _
                             "敬請儘快取得正本交回法律所承辦人，特此提醒。"

    stQ = " And CT11<=" & DBDATE(DateAdd("m", -1, Format(strSrvDate(1), "####/##/##")))
    stQ = "Select * From ConTract Where CT09 Is Null " & stQ
    
    intQ = 1
    Set RsQ = ClsLawReadRstMsg(intQ, stQ)
    If intQ = 1 Then
        RsQ.MoveFirst
        Do While RsQ.EOF = False
            stCT01 = "" & RsQ.Fields("CT01")
            Call ChkCusAgent("" & RsQ.Fields("CT02"), stCmpN)
            stCT03 = "" & RsQ.Fields("CT03")
            stTO = "" & RsQ.Fields("CT06")
            stCC = "" & RsQ.Fields("CT10")
            stTmp = "" & RsQ.Fields("CT11")
            stDate = Val(Mid(stTmp, 1, 4)) - 1911 & "年" & Mid(stTmp, 5, 2) & "月" & Mid(stTmp, 7) & "日"
            
            '主旨/內文
            stSubject = stSubject_Fix
            stContent = stContent_Fix
            
            stSubject = Replace(stSubject, "xx公司", "「" & stCmpN & "」")
            stContent = Replace(stContent, "xx公司", "「" & stCmpN & "」")
            If InStr(stCT03, "契約") > 0 Then
                stSubject = Replace(stSubject, "xx契約", stCT03)
                stContent = Replace(stContent, "xx契約", stCT03)
            Else
                stSubject = Replace(stSubject, "xx契約", stCT03 & " 契約")
                stContent = Replace(stContent, "xx契約", stCT03 & " 契約")
            End If
            stContent = Replace(stContent, "xx年月日", stDate)
            stContent = stContent & vbCrLf & vbCrLf & "***此信件為系統自動寄出，請勿直接回覆。***"
            
           PUB_SendMail strUserNum, stTO, "", stSubject, stContent, , , , , , stCC, , , , False, , , , False

            RsQ.MoveNext
        Loop
    End If
    
ErrHnd:
    If Err.Number <> 0 Then
        WLog "合約資料正本存檔提醒:合約編號「" & stCT01 & "」有誤"
    End If
    Set RsQ = Nothing
End Sub

'Added by Morgan 2021/9/28
'長庚醫院案件管制
Private Sub StrMenu107()
   Dim stCuVTB As String
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   Dim stDDate As String, stDDate2 As String
   Dim stTO As String, stCC As String, stSubject As String, stContent As String
   
On Error GoTo ErrHnd

   '長庚醫院條件: X69365關係企業且為顧服組W2001客戶者
   'Modified by Morgan 2023/5/10 +P1004
   'Modified by Morgan 2024/8/5 +30015
   stCuVTB = "select * from customer where substr(cu01,1,6)='X69365' and (cu13='W2001' or cu13='P1004' or cu13='30015')"
   
   '新案/後續案(有法限且承辦人非程序)
   '1.送核管制(未完稿EP09):齊備日EP06+20日曆天 -> 通知工程師、核稿主管
   stSQL = "select pa01||'-'||pa02||decode(pa03||pa04,'000','','-'||pa03||'-'||pa04) CaseNo" & _
      ",pa05,sqldatet(cp05) cp05C,cp09,cp10,decode(pa09,'000',cpm03,cpm04) cp10C,cp14,s1.st02 cp14C" & _
      ",ep04,s2.st02 ep04C,sqldatet(ep06) ep06C,sqldatet(to_char(to_date(ep06,'yyyymmdd')+20,'yyyymmdd')) DDate,cu13" & _
      " from (" & stCuVTB & ") X, patent, caseprogress c1, engineerprogress, casepropertymap, staff s1, staff s2" & _
      " where pa26(+)=cu01||cu02 and pa57||pa108 is null" & _
      " and cp01(+)=pa01 and cp02(+)=pa02 and cp03(+)=pa03 and cp04(+)=pa04 and cp158=0 and cp159=0" & _
      " and ep02(+)=cp09 and ep06>0 and ep34='Y' and ep09 is null" & _
      " and sysdate>to_date(ep06,'yyyymmdd')+20" & _
      " and cpm01(+)=cp01 and cpm02(+)=cp10 and s1.st01(+)=cp14 and s2.st01(+)=ep04" & _
      " and cp09<'B' and (cp10 in (" & NewCasePtyList & ") or (cp07>0 and s1.st03<>'P12') )" & _
      " order by ep06,cp05,cp09"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      With rsQuery
      .MoveFirst
      Do While Not .EOF
         stTO = "" & .Fields("cp14")
         stCC = "" & .Fields("ep04")
         stSubject = "【長庚醫院案件管制提醒】" & .Fields("CaseNo") & "案尚" & IIf(IsNull(.Fields("ep04")), "未完稿", "未送核") & "，請儘速處理！"
         stContent = "收文號：" & .Fields("cp09") & vbCrLf & _
            "本所案號：" & .Fields("CaseNo") & vbCrLf & _
            "案件名稱：" & .Fields("pa05") & vbCrLf & _
            "案件性質：" & .Fields("cp10") & " " & .Fields("cp10C") & vbCrLf & _
            "收文日：" & .Fields("cp05C") & vbCrLf & _
            "齊備日：" & .Fields("ep06C") & vbCrLf & _
            "承辦人：" & .Fields("cp14") & " " & .Fields("cp14C") & vbCrLf & _
            "核稿人：" & IIf(IsNull(.Fields("ep04")), "無", .Fields("ep04") & " " & .Fields("ep04C")) & vbCrLf & _
            "管制日期：" & .Fields("DDate")

         'Added by Lydia 2022/05/27 每月、每日批次發通知無收受者時改發「程式管理人員」，以利查覺異常情形，才能儘早修改系統設定
         If stTO = "" Then
             stTO = Pub_GetSpecMan("程式管理人員")
         End If
         'end 2022/05/27
         PUB_SendMail strUserNum, stTO, "", stSubject, stContent, , , , , , stCC, , , , False, , , , False
         .MoveNext
      Loop
      End With
   End If
  
   '2.送會管制(未會稿EP07/未客戶會稿EP37): 齊備日EP06+30日曆天-5工作天: 設本所期限(進度備註管制日期)；通知工程師、業務
   'Modified by Morgan 2022/6/17 ep37 is null-> nvl(ep37,0)=0
   stSQL = "select pa01||'-'||pa02||decode(pa03||pa04,'000','','-'||pa03||'-'||pa04) CaseNo" & _
      ",pa05,sqldatet(cp05) cp05C,cp06,cp07,cp09,cp10,decode(pa09,'000',cpm03,cpm04) cp10C,cp13,s2.st02 cp13C" & _
      ",cp14,s1.st02 cp14C,cp64,ep06,sqldatet(ep06) ep06C,sqldatet(ep07) ep07C,sqldatet(ep09) ep09C,cu13" & _
      " from (" & stCuVTB & ") X, patent, caseprogress, engineerprogress, casepropertymap, staff s1, staff s2" & _
      " where pa26(+)=cu01||cu02 and pa57||pa108 is null" & _
      " and cp01(+)=pa01 and cp02(+)=pa02 and cp03(+)=pa03 and cp04(+)=pa04 and cp158=0 and cp159=0" & _
      " and ep02(+)=cp09 and ep06>0 and ep34='Y' and nvl(ep37,0)=0" & _
      " and cpm01(+)=cp01 and cpm02(+)=cp10 and s1.st01(+)=cp14 and s2.st01(+)=cp13" & _
      " and cp09<'B' and (cp10 in (" & NewCasePtyList & ") or (cp07>0 and s1.st03<>'P12') )" & _
      " order by ep06,cp05,cp09"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      With rsQuery
      .MoveFirst
      Do While Not .EOF
         stDDate = CompDate(2, 30, .Fields("ep06")) '+30日曆天
         stDDate = CompWorkDay(5, stDDate, 1)  '-5工作天
         If strSrvDate(1) >= stDDate Then
            If IsNull(.Fields("EP07C")) Then
               stTO = "" & .Fields("cp14")
               'Modified by Morgan 2024/6/4
               'stCC = "" & .Fields("cp13")
               stCC = "" & .Fields("cu13")
               'end 2024/6/4
               stSubject = "【長庚醫院案件管制提醒】" & .Fields("CaseNo") & "案尚未送會，請儘速處理！"
            Else
               'Modified by Morgan 2024/6/4
               'stTO = "" & .Fields("cp13")
               stTO = "" & .Fields("cu13")
               'end 2024/6/4
               stCC = ""
               stSubject = "【長庚醫院案件管制提醒】" & .Fields("CaseNo") & "案尚未客戶會稿，請儘速處理！"
            End If
            
            stContent = "收文號：" & .Fields("cp09") & vbCrLf & _
               "本所案號：" & .Fields("CaseNo") & vbCrLf & _
               "案件名稱：" & .Fields("pa05") & vbCrLf & _
               "案件性質：" & .Fields("cp10") & " " & .Fields("cp10C") & vbCrLf & _
               "收文日：" & .Fields("cp05C") & vbCrLf & _
               "齊備日：" & .Fields("ep06C") & vbCrLf & _
               "完稿日：" & .Fields("ep09C") & vbCrLf & _
               "送會日：" & .Fields("ep07C") & vbCrLf & _
               "承辦人：" & .Fields("cp14") & " " & .Fields("cp14C") & vbCrLf & _
               "智權人員：" & .Fields("cp13") & " " & .Fields("cp13C") & vbCrLf & _
               "管制日期：" & ChangeWStringToTDateString(stDDate)
            'Added by Lydia 2022/05/27 每月、每日批次發通知無收受者時改發「程式管理人員」，以利查覺異常情形，才能儘早修改系統設定
            If stTO = "" Then
               stTO = Pub_GetSpecMan("程式管理人員")
            End If
           'end 2022/05/27
            PUB_SendMail strUserNum, stTO, "", stSubject, stContent, , , , , , stCC, , , , False, , , , False
         End If
         
         '進度備註管制日期
         If InStr("" & .Fields("cp64"), "長庚醫院案件送會管制日:") = 0 Then
            stSQL = "update caseprogress set cp64='長庚醫院案件送會管制日:" & ChangeWStringToTDateString(stDDate) & "(所限);'||cp64"
            '無所限或所限較晚時更新
            If IsNull(.Fields("cp06")) Or stDDate < .Fields("cp06") Then
               'Modified by Morgan 2022/10/11
               'stSQL = stSQL & ",cp06=" & stDDate
               stSQL = stSQL & ",cp06=" & stDDate & ",cp166='U'"
            End If
            stSQL = stSQL & " where cp09='" & .Fields("cp09") & "'"
            cnnConnection.Execute stSQL, intQ
         End If
         .MoveNext
      Loop
      End With
   End If
   
   'Added by Morgan 2022/9/22 無法限已送會未會完時所限設會稿日+2週--郭
   'Modified by Morgan 2022/10/11 有期限案件,送會後,請恢復原本的本所期限--郭
   'Modified by Morgan 2022/10/11 +CP165
   stSQL = "select pa01||'-'||pa02||decode(pa03||pa04,'000','','-'||pa03||'-'||pa04) CaseNo" & _
      ",pa05,sqldatet(cp05) cp05C,cp06,cp07,cp09,cp10,decode(pa09,'000',cpm03,cpm04) cp10C,cp13,s2.st02 cp13C" & _
      ",cp14,s1.st02 cp14C,cp64,ep37,cp165,cu13" & _
      " from (" & stCuVTB & ") X, patent, caseprogress, engineerprogress, casepropertymap, staff s1, staff s2" & _
      " where pa26(+)=cu01||cu02 and pa57||pa108 is null" & _
      " and cp01(+)=pa01 and cp02(+)=pa02 and cp03(+)=pa03 and cp04(+)=pa04 and cp158=0 and cp159=0" & _
      " and ep02(+)=cp09 and ep06>0 and ep34='Y' and ep37>0 and ep08 is null" & _
      " and cpm01(+)=cp01 and cpm02(+)=cp10 and s1.st01(+)=cp14 and s2.st01(+)=cp13" & _
      " and cp09<'B' and (cp10 in (" & NewCasePtyList & ") or (cp07>0 and s1.st03<>'P12'))" & _
      " order by ep06,cp05,cp09"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      With rsQuery
      .MoveFirst
      Do While Not .EOF
         '進度備註管制日期
         If InStr("" & .Fields("cp64"), "長庚醫院案件會完管制日:") = 0 Then
            'Added by Morgan 2022/10/11
            If .Fields("cp165") > 0 Then '原所限
               stDDate = .Fields("cp165")
               stSQL = "update caseprogress set cp06=" & stDDate & ",cp64='長庚醫院案件會完管制日:" & ChangeWStringToTDateString(stDDate) & "(原所限);'||cp64 where cp09='" & .Fields("cp09") & "'"
               cnnConnection.Execute stSQL, intQ
               
            'end 2022/10/11
            ElseIf IsNull(.Fields("cp07")) Then '無法限
               stDDate = CompDate(2, 14, .Fields("ep37")) '會稿日+2週
               stDDate = PUB_GetWorkDay1(stDDate, True)
               stSQL = "update caseprogress set cp06=" & stDDate & ",cp64='長庚醫院案件會完管制日:" & ChangeWStringToTDateString(stDDate) & "(所限);'||cp64 where cp09='" & .Fields("cp09") & "'"
               cnnConnection.Execute stSQL, intQ
            Else
            '有法限無原鎖線
            End If
         End If
         .MoveNext
      Loop
      End With
   End If
   'end 2022/9/22
   
   '新案送件管制:
   '會完日+15日曆天-4工作天: 所限(進度加備註)
   '會完日+15日曆天: 設法限；未輸通知申請號時通知程序
   stSQL = "select pa01||'-'||pa02||decode(pa03||pa04,'000','','-'||pa03||'-'||pa04) CaseNo" & _
      ",pa05,sqldatet(cp27) cp27C,cp06,cp07,cp09,cp10,decode(pa09,'000',cpm03,cpm04) cp10C" & _
      ",cp64,cp83,cp158,ep08,sqldatet(ep08) ep08C,cu13,pa09" & _
      " from (" & stCuVTB & ") X, patent, caseprogress, engineerprogress, casepropertymap" & _
      " where pa26(+)=cu01||cu02 and pa57||pa108 is null" & _
      " and cp01(+)=pa01 and cp02(+)=pa02 and cp03(+)=pa03 and cp04(+)=pa04 and cp159=0" & _
      " and cp09<'B' and cp10 in (" & NewCasePtyList & ") and (pa158=0 or pa11 is null)" & _
      " and ep02(+)=cp09 and ep08>0 and cpm01(+)=cp01 and cpm02(+)=cp10" & _
      " order by ep08,cp05,cp09"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      With rsQuery
      .MoveFirst
      Do While Not .EOF
         '法限
         stDDate = CompDate(2, 15, .Fields("ep08")) '會完日+15日曆天
         '所限
         stDDate2 = CompWorkDay(4, stDDate, 1)  '法限-4工作天
         
         '未發文更新期限及進度備註管制日期
         If .Fields("cp158") = 0 Then
         
            If InStr("" & .Fields("cp64"), "長庚醫院案件送件管制日:") = 0 Then
               stSQL = "update caseprogress set cp64='長庚醫院案件送件管制日:" & ChangeWStringToTDateString(stDDate) & "(法限)," & ChangeWStringToTDateString(stDDate2) & "(所限);'||cp64"
               
               '法限較晚時才更新
               If IsNull(.Fields("cp07")) Or .Fields("cp07") > stDDate Then
                  stSQL = stSQL & ",cp06=" & stDDate2 & ",cp07=" & stDDate
               End If
               
               stSQL = stSQL & " where cp09='" & .Fields("cp09") & "'"
               cnnConnection.Execute stSQL, intQ
            End If
         
         '已發文未輸通知申請號時通知程序
         ElseIf strSrvDate(1) >= stDDate Then
            'Modified by Morgan 2024/6/4 非台灣案通知分信人員--郭
            'stCC = ""
            'stTO = "" & .Fields("cp83")
            If .Fields("pa09") = "000" Then
               stTO = "" & .Fields("cp83")
            Else
               stTO = Pub_GetSpecMan("專利處轉信非台灣程序2")
            End If
            stCC = "" & .Fields("cu13")
            'end 2024/6/4
            stSubject = "【長庚醫院案件管制提醒】" & .Fields("CaseNo") & "案尚未輸入通知申請案號，請儘速處理！"
            
            stContent = "收文號：" & .Fields("cp09") & vbCrLf & _
               "本所案號：" & .Fields("CaseNo") & vbCrLf & _
               "案件名稱：" & .Fields("pa05") & vbCrLf & _
               "案件性質：" & .Fields("cp10") & " " & .Fields("cp10C") & vbCrLf & _
               "發文日：" & .Fields("cp27C") & vbCrLf & _
               "管制日期：" & ChangeWStringToTDateString(stDDate)
            'Added by Lydia 2022/05/27 每月、每日批次發通知無收受者時改發「程式管理人員」，以利查覺異常情形，才能儘早修改系統設定
            If stTO = "" Then
               stTO = Pub_GetSpecMan("程式管理人員")
            End If
            'end 2022/05/27
            PUB_SendMail strUserNum, stTO, "", stSubject, stContent, , , , , , stCC, , , , False, , , , False
         End If

         .MoveNext
      Loop
      End With
   End If
   
   'OA發文管制:管制日(所限)=通知日+14天-3工作天 Memo by Morgan 2022/3/29 原為+15天
   stSQL = "select pa01||'-'||pa02||decode(pa03||pa04,'000','','-'||pa03||'-'||pa04) CaseNo" & _
      ",pa05,cp05,sqldatet(cp05) cp05C,cp06,sqldatet(cp06) cp06C,cp07,cp09,cp10" & _
      ",decode(pa09,'000',cpm03,cpm04) cp10C,cp13,cp14,cp64,cu13" & _
      " from (" & stCuVTB & ") X, patent, caseprogress, casepropertymap,staff" & _
      " where pa26(+)=cu01||cu02 and pa57||pa108 is null" & _
      " and cp01(+)=pa01 and cp02(+)=pa02 and cp03(+)=pa03 and cp04(+)=pa04 and cp158=0 and cp159=0" & _
      " and cp10 in (" & PatentOAPtyList & ") and cpm01(+)=cp01 and cpm02(+)=cp10 and st01(+)=cp14 and st03<>'P12'" & _
      " order by cp05,cp09"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      With rsQuery
      .MoveFirst
      Do While Not .EOF
         '管制日(所限)=通知日+14天-3工作天 Memo by Morgan 2022/3/29 原為+15天
         stDDate2 = PUB_GetX69365CaseOACP06(.Fields("cp05"))
         '未發文通知承辦工程師及業務人員
         If strSrvDate(1) >= stDDate2 Then
            stTO = "" & .Fields("cp14")
            'Modified by Morgan 2024/6/4
            'stCC = "" & .Fields("cp13")
            stCC = "" & .Fields("cu13")
            'end 2024/6/4
            stSubject = "【長庚醫院案件管制提醒】" & .Fields("CaseNo") & "案的【" & .Fields("cp10C") & "】尚未發文，請儘速處理！"
            
            stContent = "收文號：" & .Fields("cp09") & vbCrLf & _
               "本所案號：" & .Fields("CaseNo") & vbCrLf & _
               "案件名稱：" & .Fields("pa05") & vbCrLf & _
               "案件性質：" & .Fields("cp10") & " " & .Fields("cp10C") & vbCrLf & _
               "收文日：" & .Fields("cp05C") & vbCrLf & _
               "管制日期：" & ChangeWStringToTDateString(stDDate2)
            'Added by Lydia 2022/05/27 每月、每日批次發通知無收受者時改發「程式管理人員」，以利查覺異常情形，才能儘早修改系統設定
            If stTO = "" Then
               stTO = Pub_GetSpecMan("程式管理人員")
            End If
            'end 2022/05/27
            PUB_SendMail strUserNum, stTO, "", stSubject, stContent, , , , , , stCC, , , , False, , , , False
         End If

         .MoveNext
      Loop
      End With
   End If
   
ErrHnd:
   If Err.Number <> 0 Then
      WLog "長庚醫院案件管制:" & Err.Description
   End If
End Sub

'Add By Sindy 2021/10/15 ACS檢查歷程狀況的清單
Private Sub StrMenu108()
Dim RsQ As New ADODB.Recordset
Dim strTemp(1 To 10) As String
Dim TempFileName As String
Dim strType As String, strEEP05 As String
Dim jj As Integer

On Err GoTo ErrHandle

   'A:有已逾時的待核判案件
   strEEP05 = "": TempFileName = ""
   If PUB_ChkEmpElePro("", "A", RsQ) = True Then
      If RsQ.RecordCount > 0 Then
         With RsQ
            .MoveFirst
            Do While Not .EOF
               If strEEP05 = "" Or strEEP05 <> .Fields("c") Then
                  If strEEP05 <> "" Then
                     If Dir(TempFileName) <> "" Then
                        Close ff1
                        SendMAPIMail strEEP05, "ACS已逾時的待核判案件清單，請檢視！", "Dear Sirs," & vbCrLf & "ACS已逾時的待核判案件清單，資料如附件，請橫印！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", TempFileName
                     End If
                  End If
                  
                  TempFileName = "ACS已逾時的待核判案件清單-" & .Fields("c")
                  TempFileName = App.path & TextPath & TempFileName & ".txt"
                  If Dir(TempFileName) <> "" Then Kill TempFileName
                  
                  ff1 = FreeFile
                  Open TempFileName For Output As ff1
                  Print #ff1, "備註：改字型Fixedsys標準11號字以橫式上下左右各10MM列印"
                  Print #ff1, "流程日期        本所案號        案件名稱                       案件性質             本所期限   承辦期限   智權人員   目前流程狀態"
                  Print #ff1, "=============== =============== ============================== ==================== ========== ========== ========== =========="
               End If
               
               strEEP05 = .Fields("c")
               
               For jj = 1 To 8
                  strTemp(jj) = ""
               Next jj
               strTemp(1) = Trim("" & .Fields("流程日期"))
               strTemp(2) = Trim("" & .Fields("本所案號"))
               strTemp(3) = Trim("" & .Fields("案件名稱"))
               strTemp(4) = Trim("" & .Fields("案件性質"))
               strTemp(5) = Trim("" & .Fields("本所期限"))
               strTemp(6) = Trim("" & .Fields("承辦期限"))
               strTemp(7) = Trim("" & .Fields("智權人員"))
               strTemp(8) = Trim("" & .Fields("目前流程狀態"))
               
               strTemp(1) = convForm(CheckStr(strTemp(1)), 15)
               strTemp(2) = convForm(CheckStr(strTemp(2)), 15)
               strTemp(3) = convForm(CheckStr(strTemp(3)), 30)
               strTemp(4) = convForm(CheckStr(strTemp(4)), 20)
               strTemp(5) = convForm(CheckStr(strTemp(5)), 10)
               strTemp(6) = convForm(CheckStr(strTemp(6)), 10)
               strTemp(7) = convForm(CheckStr(strTemp(7)), 10)
               strTemp(8) = convForm(CheckStr(strTemp(8)), 10)
               
               Print #ff1, strTemp(1) & " " & strTemp(2) & " " & strTemp(3) & " " & strTemp(4) & " " & strTemp(5) & " " & strTemp(6) & " " & strTemp(7) & " " & strTemp(8)
               .MoveNext
            Loop
            If strEEP05 <> "" Then
               If Dir(TempFileName) <> "" Then
                  Close ff1
                  SendMAPIMail strEEP05, "ACS已逾時的待核判案件清單，請檢視！", "Dear Sirs," & vbCrLf & "ACS已逾時的待核判案件清單，資料如附件，請橫印！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", TempFileName
               End If
            End If
         End With
      End If
      RsQ.Close
   End If
   
   'B:有之前尚未歸檔欲發文的案件
   strEEP05 = "": TempFileName = ""
   If PUB_ChkEmpElePro("", "B", RsQ) = True Then
      If RsQ.RecordCount > 0 Then
         With RsQ
            .MoveFirst
            Do While Not .EOF
               If strEEP05 = "" Or strEEP05 <> .Fields("c") Then
                  If strEEP05 <> "" Then
                     If Dir(TempFileName) <> "" Then
                        Close ff1
                        SendMAPIMail strEEP05, "ACS有之前尚未歸檔欲發文的案件，請檢視！", "Dear Sirs," & vbCrLf & "ACS有之前尚未歸檔欲發文的案件，資料如附件，請橫印！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", TempFileName
                     End If
                  End If
                  
                  TempFileName = "ACS有之前尚未歸檔欲發文的案件-" & .Fields("c")
                  TempFileName = App.path & TextPath & TempFileName & ".txt"
                  If Dir(TempFileName) <> "" Then Kill TempFileName
                  
                  ff1 = FreeFile
                  Open TempFileName For Output As ff1
                  Print #ff1, "備註：改字型Fixedsys標準11號字以橫式上下左右各10MM列印"
                  Print #ff1, "流程日期        本所案號        案件名稱                       案件性質             本所期限   承辦期限   智權人員   目前流程狀態"
                  Print #ff1, "=============== =============== ============================== ==================== ========== ========== ========== =========="
               End If
               
               strEEP05 = .Fields("c")
               
               For jj = 1 To 8
                  strTemp(jj) = ""
               Next jj
               strTemp(1) = Trim("" & .Fields("流程日期"))
               strTemp(2) = Trim("" & .Fields("本所案號"))
               strTemp(3) = Trim("" & .Fields("案件名稱"))
               strTemp(4) = Trim("" & .Fields("案件性質"))
               strTemp(5) = Trim("" & .Fields("本所期限"))
               strTemp(6) = Trim("" & .Fields("承辦期限"))
               strTemp(7) = Trim("" & .Fields("智權人員"))
               strTemp(8) = Trim("" & .Fields("目前流程狀態"))
               
               strTemp(1) = convForm(CheckStr(strTemp(1)), 15)
               strTemp(2) = convForm(CheckStr(strTemp(2)), 15)
               strTemp(3) = convForm(CheckStr(strTemp(3)), 30)
               strTemp(4) = convForm(CheckStr(strTemp(4)), 20)
               strTemp(5) = convForm(CheckStr(strTemp(5)), 10)
               strTemp(6) = convForm(CheckStr(strTemp(6)), 10)
               strTemp(7) = convForm(CheckStr(strTemp(7)), 10)
               strTemp(8) = convForm(CheckStr(strTemp(8)), 10)
               
               Print #ff1, strTemp(1) & " " & strTemp(2) & " " & strTemp(3) & " " & strTemp(4) & " " & strTemp(5) & " " & strTemp(6) & " " & strTemp(7) & " " & strTemp(8)
               .MoveNext
            Loop
            If strEEP05 <> "" Then
               If Dir(TempFileName) <> "" Then
                  Close ff1
                  SendMAPIMail strEEP05, "ACS有之前尚未歸檔欲發文的案件，請檢視！", "Dear Sirs," & vbCrLf & "ACS有之前尚未歸檔欲發文的案件，資料如附件，請橫印！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", TempFileName
               End If
            End If
         End With
      End If
      RsQ.Close
   End If
   Set RsQ = Nothing
   
   Exit Sub
   
ErrHandle:
   If Err.Number <> 0 Then
      WLog "ACS檢查歷程狀況的清單:" & Err.Description
   End If
End Sub

'Add by Amy 2021/10/21 傳入案號抓取案件聯絡人
Private Function GetCaseContectPerson(ByVal stCaseNo1 As String, ByVal stCaseNo2 As String, ByVal stCaseNo3 As String, ByVal stCaseNo4 As String) As String
    Dim RsQ As New ADODB.Recordset
    Dim strQ As String, intQ As Integer
    
    '英->中->日
    strQ = "Select Nvl(pa52,Decode(pa51,null,pa53,pa51)) as P1,Nvl(pa55,Decode(pa54,null,pa56,pa54)) as P2 " & _
                "From Patent Where pa01='" & stCaseNo1 & "' And pa02='" & stCaseNo2 & "' And pa03='" & stCaseNo3 & "' And pa04='" & stCaseNo4 & "' " & _
    "Union Select Nvl(tm39,Decode(tm38,null,tm40,tm38)) as P1,Nvl(tm42,Decode(tm41,null,tm43,tm41)) as P2 " & _
                "From TradeMark Where tm01='" & stCaseNo1 & "' And tm02='" & stCaseNo2 & "' And tm03='" & stCaseNo3 & "' And tm04='" & stCaseNo4 & "' " & _
    "Union Select Nvl(lc19,Decode(lc18,null,lc20,lc18)) as P1,'' as P2 " & _
                "From LawCase Where lc01='" & stCaseNo1 & "' And lc02='" & stCaseNo2 & "' And lc03='" & stCaseNo3 & "' And lc04='" & stCaseNo4 & "' " & _
    "Union Select sp30 as P1,'' as P2 " & _
                "From ServicePractice Where sp01='" & stCaseNo1 & "' And sp02='" & stCaseNo2 & "' And sp03='" & stCaseNo3 & "' And sp04='" & stCaseNo4 & "' "
    intQ = 1
    Set RsQ = ClsLawReadRstMsg(intQ, strQ)
    If intQ = 1 Then
        GetCaseContectPerson = IIf("" & RsQ.Fields("P1") <> "", ";" & RsQ.Fields("P1"), "") & IIf("" & RsQ.Fields("P2") <> "", ";" & RsQ.Fields("P2"), "")
    End If
    If GetCaseContectPerson <> MsgText(601) Then GetCaseContectPerson = Mid(GetCaseContectPerson, 2)
    
    Set RsQ = Nothing
End Function

'傳入cr03,欄位,回傳其資料
Private Function GetContactRecord(ByVal stNo As String, stField As String, ByRef stVal() As String) As Boolean
    Dim RsQ As New ADODB.Recordset
    Dim strQ As String, i As Integer, intQ As Integer
    
    GetContactRecord = False
    For i = LBound(stVal) To UBound(stVal)
        stVal(i) = ""
    Next i
    
    strQ = "Select " & stField & " From ContactRecord Where SubStr(cr03,1,8)='" & stNo & "' And cr05='A13' "
    intQ = 1
    Set RsQ = ClsLawReadRstMsg(intQ, strQ)
    If intQ = 1 Then
        For i = LBound(stVal) To UBound(stVal)
            stVal(i) = "" & RsQ.Fields(i)
        Next i
        GetContactRecord = True
    End If
    Set RsQ = Nothing
End Function
'Add By Sindy 2021/12/17 FCP請款作業稽核
Private Sub StrMenu109()
Dim RsQ As New ADODB.Recordset
Dim rsTmp As New ADODB.Recordset
Dim bolSendMail As Boolean
Dim stDate As String
Dim strCP43 As String, strText As String, strCP10 As String, strCP10n As String
Dim strCP01 As String, strCP02 As String, strCP03 As String, strCP04 As String 'Add By Sindy 2021/12/24
Dim strCP20 As String 'Add By Sindy 2022/1/18
   
On Err GoTo ErrHandle
   
   'stDate = CompDate(2, -3, strSrvDate(1)) '系統日前3天
   stDate = CompWorkDay(4, Format(Now, "YYYYMMDD"), 1) '前3個工作天
   
   'Modified by Lydia 2023/09/18 排除已刪除的檔案; ex.FCP-070260 => and substr(upper(cpp02),-4)<>upper('.del')
   strSql = "select cp60,cp10,cp43,cp01,cp02,cp03,cp04,cp20 from casepaperpdf,caseprogress" & _
            " where cpp06=" & stDate & " and instr(upper(cpp02),'.INDN.')>0 and substr(upper(cpp02),-4)<>upper('.del')" & _
            " and cpp01=cp09(+) and cp01 in('FCP','FG') and cp60 is null" & _
            " and cp10 not in('907','913')"
   strSql = strSql & " union all " & _
            "select cp60,cp10,cp43,cp01,cp02,cp03,cp04,cp20 from casepaperpdf,caseprogress" & _
            " where cpp06=" & stDate & " and instr(upper(cpp02),'.INDN.')>0 and substr(upper(cpp02),-4)<>upper('.del')" & _
            " and cpp01=cp09(+) and cp01 in('P','PS','CFP','CPS') and SUBSTR(cp12,1,1)='F' and cp60 is null" & _
            " and cp10 not in('907','913')"
   RsQ.CursorLocation = adUseClient
   RsQ.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If RsQ.RecordCount > 0 Then
      RsQ.MoveFirst
      Do While Not RsQ.EOF
         bolSendMail = True
         strCP01 = "" & RsQ.Fields("cp01")
         strCP02 = "" & RsQ.Fields("cp02")
         strCP03 = "" & RsQ.Fields("cp03")
         strCP04 = "" & RsQ.Fields("cp04")
         strCP43 = "" & RsQ.Fields("cp43")
         strCP10 = "" & RsQ.Fields("cp10")
         strCP20 = "" & RsQ.Fields("cp20")
         strCP10n = GetPrjState4(RsQ.Fields("cp01") & "-" & RsQ.Fields("cp02") & "-" & RsQ.Fields("cp03") & "-" & RsQ.Fields("cp04"), strCP10)
         strText = strCP01 & "-" & strCP02 & " " & strCP10n & "有內部請款，尚未有請款單號"
         '1101.通知申請案號要檢查相關總收文號
         'Modify By Sindy 2021/12/24 敏莉:若是235.核對中說格式有內部請款，請去比對新案是否有請款單號(strCP43 <> "" And 取消)
         'Modify By Sindy 2022/1/18 敏莉:若209.檢視中說201.新案翻譯有內部請款，但是否向客戶請款上"N"，才去判斷新案申請是否有請款單號
         'Modify By Sindy 2022/6/6 敏莉:FMP案的 1102.通知申請日若有內部請款(應該只有FMP才會有通知申請日)，則是去判斷新案是否有請款單號，若有，則不發此Mail
         If strCP10 = "1101" Or strCP10 = "1102" Or strCP10 = "235" Or (InStr("209,201", strCP10) > 0 And strCP20 = "N") Then
            '相關總收文號若為新案,有請款編號則不用寄mail
            strSql = "select * from caseprogress where cp01='" & strCP01 & "' and cp02='" & strCP02 & "' and cp03='" & strCP03 & "' and cp04='" & strCP04 & "'" & _
                     " and cp10 in(101,102,103,104,105,109,110,112,113,114,115,118,120,122,125,307) and cp60 is not null"
            rsTmp.CursorLocation = adUseClient
            rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
            If rsTmp.RecordCount > 0 Then
               bolSendMail = False
            End If
            rsTmp.Close
         End If
         If bolSendMail = True Then
            SendMAPIMail "86024", strText, "如旨" '86024.葉敏莉
         End If
         RsQ.MoveNext
      Loop
   End If
   RsQ.Close
   
   Set RsQ = Nothing
   Set rsTmp = Nothing
   
   Exit Sub
   
ErrHandle:
   If Err.Number <> 0 Then
      WLog "FCP請款作業稽核:" & Err.Description
   End If
End Sub

'Added by Morgan 2022/2/8
'E化案件清單通知
Private Sub StrMenu110()
   Dim bolELtr As Boolean, bolYLtr As Boolean, stLP26 As String
   Dim stWDate As String, stLPCon As String
   Dim stVTB1 As String, stVTB2 As String, stVTB3 As String
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   Dim xlsAgentPoint As New Excel.Application
   Dim wksrpt As New Worksheet
   Dim strSubject1 As String, strSubject2 As String
   Dim xlsFileNameA As String, xlsFileName1 As String, xlsFileName2 As String
   Dim intCounter As Integer, ii As Integer
   Dim stTmp, intWidth
   Dim stTO As String, stCC As String, stBCC As String
   
On Error GoTo ErrHnd

   stWDate = CompWorkDay(2, strSrvDate(1), 1)   '上一個工作天
   
   strSubject1 = stWDate & "全E化案件清單通知"
   strSubject2 = stWDate & "案件清單通知"
   xlsFileName1 = strSubject1 & ".xls"
   xlsFileName2 = strSubject2 & ".xls"
   If Dir(App.path & TextPath & xlsFileName1) <> "" Then
        Kill App.path & TextPath & xlsFileName1
   End If
   If Dir(App.path & TextPath & xlsFileName2) <> "" Then
        Kill App.path & TextPath & xlsFileName2
   End If
   
   bolELtr = False '全E
   bolYLtr = False '半E
   
   '掛號直寄,非代理人,E化(全E LP26='E' or 半E LP26='Y' and LP11<>'Y'),系統日>EMail日期>=上一個工作天
   stLPCon = " lp52='Y' and lp31 is null and (lp26='E' or (lp26='Y' and nvl(lp11,'2')<>'Y')) And lp39 >= " & stWDate & " And lp39 < " & strSrvDate(1)
   
   stVTB1 = "select lp26,cp01,cp02,cp03,cp04,cp09,cp10,cp12,cp13,nvl(pa05,pa06) pa05,pa09,pa26" & _
      " from letterprogress,caseprogress,patent" & _
      " where " & stLPCon & " and cp09(+)=lp01" & _
      " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04 and pa01 is not null" & _
      " union select lp26,cp01,cp02,cp03,cp04,cp09,cp10,cp12,cp13,tm05,tm10,tm23" & _
      " from letterprogress,caseprogress,trademark" & _
      " where " & stLPCon & " and cp09(+)=lp01" & _
      " and tm01(+)=cp01 and tm02(+)=cp02 and tm03(+)=cp03 and tm04(+)=cp04 and tm01 is not null" & _
      " union select lp26,cp01,cp02,cp03,cp04,cp09,cp10,cp12,cp13,nvl(sp05,sp06) sp05,sp09,sp08" & _
      " from letterprogress,caseprogress,servicepractice" & _
      " where " & stLPCon & " and cp09(+)=lp01" & _
      " and sp01(+)=cp01 and sp02(+)=cp02 and sp03(+)=cp03 and sp04(+)=cp04 and sp01 is not null"
   
   stVTB2 = "select np01 y1,np02 y2,substr(min(np09||np07),9) y3" & _
      " from letterprogress,caseprogress,nextprogress" & _
      " where " & stLPCon & " and cp09(+)=lp01 and np01(+)=cp09" & _
      " and np02(+)=cp01 and np03(+)=cp02 and np04(+)=cp03 and np05(+)=cp04" & _
      " and length(np07)=3 group by np01,np02"
      
   stVTB3 = "select cp09 z1,np02 z2,np07 z3" & _
      " from letterprogress,caseprogress,nextprogress" & _
      " where " & stLPCon & " and cp09(+)=lp01 and np01(+)=cp43 and np22(+)=cp30 and np01 is not null"
   
   stSQL = "select lp26,cp01,cp09,cu12||' '||a0902 C01" & _
      ",cu13||' '||st02 C02" & _
      ",cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) C03" & _
      ",pa05 C04" & _
      ",decode(pa09,'000',c1.cpm03,c1.cpm04) C05" & _
      ",decode(pa09,'000',nvl(c3.cpm03,c2.cpm03),nvl(c3.cpm04,c2.cpm04)) C06" & _
      ",pa26 C07" & _
      ",cu04 C08" & _
      " from (" & stVTB1 & ") X,(" & stVTB2 & ") Y,(" & stVTB3 & ") Z" & _
      ",customer,acc090,staff,casepropertymap c1,casepropertymap c2,casepropertymap c3" & _
      " Where cu01(+)=substr(pa26,1,8) and cu02(+)=substr(pa26,9) and substr(cu12,1,1) in ('S','M') and a0901(+)=cu12" & _
      " and st01(+)=cu13 and c1.cpm01(+)=cp01 and c1.cpm02(+)=cp10" & _
      " and y1(+)=cp09 and c2.cpm01(+)=y2 and c2.cpm02(+)=y3" & _
      " and z1(+)=cp09 and c3.cpm01(+)=z2 and c3.cpm02(+)=z3" & _
      " order by lp26,C01,C02,C03,cp09"
      
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      intCounter = 1
      stTmp = Array("業務區", "智權人員", "本所案號", "案件名稱", "傳送案件性質", "下一程序", "申請人編號", "申請人名稱")
      intWidth = Array(16, 16, 16, 40, 16, 16, 10, 50)
      xlsAgentPoint.SheetsInNewWorkbook = 1 '預設工作表數目
      xlsAgentPoint.Workbooks.add
      xlsAgentPoint.Application.WindowState = xlMinimized
      'xlsAgentPoint.Application.Visible = True
      Set wksrpt = xlsAgentPoint.Worksheets(1)
      '設定欄位名稱及欄寬
      For ii = LBound(stTmp) To UBound(stTmp)
          wksrpt.Range(Chr(ii + 65) & intCounter).Value = stTmp(ii)
          wksrpt.Columns(Chr(ii + 65) & ":" & Chr(ii + 65)).ColumnWidth = intWidth(ii)
          wksrpt.Range(Chr(ii + 65) & intCounter).HorizontalAlignment = xlCenter
      Next ii
      intCounter = intCounter + 1
        
      With rsQuery
      .MoveFirst
      stLP26 = .Fields("lp26")
      If stLP26 = "E" Then
         bolELtr = True
         xlsFileNameA = xlsFileName1
      ElseIf stLP26 = "Y" Then
         bolYLtr = True
         xlsFileNameA = xlsFileName2
      End If
      Do While Not .EOF
         If stLP26 <> "" & .Fields("lp26") Then
            If Val(xlsAgentPoint.Version) < 12 Then
               xlsAgentPoint.Workbooks(1).SaveAs FileName:=App.path & TextPath & xlsFileNameA, FileFormat:=-4143
            Else
               xlsAgentPoint.Workbooks(1).SaveAs FileName:=App.path & TextPath & xlsFileNameA, FileFormat:=56
            End If
            xlsAgentPoint.Workbooks.Close
            
            stLP26 = .Fields("lp26")
            If stLP26 = "E" Then
               bolELtr = True
               xlsFileNameA = xlsFileName1
            ElseIf stLP26 = "Y" Then
               bolYLtr = True
               xlsFileNameA = xlsFileName2
            End If
            xlsAgentPoint.SheetsInNewWorkbook = 1 '預設工作表數目
            xlsAgentPoint.Workbooks.add
            Set wksrpt = xlsAgentPoint.Worksheets(1)
            intCounter = 1
            '設定欄位名稱及欄寬
            For ii = LBound(stTmp) To UBound(stTmp)
                wksrpt.Range(Chr(ii + 65) & intCounter).Value = stTmp(ii)
                wksrpt.Columns(Chr(ii + 65) & ":" & Chr(ii + 65)).ColumnWidth = intWidth(ii)
                wksrpt.Range(Chr(ii + 65) & intCounter).HorizontalAlignment = xlCenter
            Next ii
            intCounter = intCounter + 1
         End If
         
         wksrpt.Range("A" & intCounter).Value = "" & .Fields("C01")  '業務區
         wksrpt.Range("B" & intCounter).Value = "" & .Fields("C02")  '智權人員
         wksrpt.Range("C" & intCounter).Value = "" & .Fields("C03")  '本所案號
         wksrpt.Range("D" & intCounter).Value = "" & .Fields("C04")  '案件名稱
         wksrpt.Range("E" & intCounter).Value = "" & .Fields("C05") & PUB_GetRelateCasePropertyName(.Fields("CP09"), "1") '傳送案件性質
         wksrpt.Range("F" & intCounter).Value = "" & .Fields("C06")  '下一程序
         wksrpt.Range("G" & intCounter).Value = "" & .Fields("C07")  '申請人編號
         wksrpt.Range("H" & intCounter).Value = "" & .Fields("C08")  '申請人名稱
         If .Fields("cp01") = "CFT" Then
            wksrpt.Range("A" & intCounter & ":" & "H" & intCounter).Interior.Color = vbYellow
         End If
         .MoveNext
         intCounter = intCounter + 1
      Loop
      
      If Val(xlsAgentPoint.Version) < 12 Then
         xlsAgentPoint.Workbooks(1).SaveAs FileName:=App.path & TextPath & xlsFileNameA, FileFormat:=-4143
      Else
         xlsAgentPoint.Workbooks(1).SaveAs FileName:=App.path & TextPath & xlsFileNameA, FileFormat:=56
      End If
      xlsAgentPoint.Workbooks.Close
      xlsAgentPoint.Quit
      End With
   End If
   
   '寄給蘇嫄媛79053及杜燕文74018
   stTO = "79053"
   stCC = "74018"
   
   If bolELtr = True Then
      SendMAPIMail stTO, strSubject1 & "(詳附件)", vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, App.path & TextPath & xlsFileName1, , , stCC, stBCC
   Else
      SendMAPIMail stTO, strSubject1 & "(無案件)", vbCrLf & vbCrLf & "***本日無案件***" & vbCrLf & vbCrLf, , , , stCC, stBCC
   End If
   
   If bolYLtr = True Then
      SendMAPIMail stTO, strSubject2 & "(詳附件)", vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, App.path & TextPath & xlsFileName2, , , stCC, stBCC
   Else
      SendMAPIMail stTO, strSubject2 & "(無案件)", vbCrLf & vbCrLf & "***本日無案件***" & vbCrLf & vbCrLf, , , , stCC, stBCC
   End If
   
   Set rsQuery = Nothing
   Set wksrpt = Nothing
   Set xlsAgentPoint = Nothing
   Exit Sub
   
ErrHnd:
   If Err.Number <> 0 Then
      WLog Err.Description
   End If
End Sub

'Added by Morgan 2022/9/20
'美國維持費未收文案件
Private Sub StrMenu117()
   
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   Dim xlsAgentPoint As New Excel.Application
   Dim wksrpt As New Worksheet
   Dim strSubject1 As String
   Dim xlsFileNameA As String
   Dim intCounter As Integer, ii As Integer
   Dim stTmp, intWidth
   Dim stTO As String, stCC As String, stBCC As String
   
On Error GoTo ErrHnd
   
   strSubject1 = strSrvDate(1) & "美國維持費未收文案件"
   xlsFileNameA = strSubject1 & ".xls"
   
   If Dir(App.path & TextPath & xlsFileNameA) <> "" Then
        Kill App.path & TextPath & xlsFileNameA
   End If
   
   
   stSQL = "select cu12||' '||a0902 C01,cu13||' '||st02 C02,cu04 C03,sqldatet(cp27) C04" & _
      ",cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) C05"
   
   'Added by Morgan 2023/3/29
   If strSrvDate(1) >= PA179啟用日 Then
      stSQL = stSQL & _
      ",decode(pa179,'1','大個體','2','小個體','3','微個體') C06"
   Else
   'end 2023/3/29
   
      stSQL = stSQL & _
      ",decode(pa91,'','',decode(instr(pa91,'大個體'),0,decode(instr(pa91,'微個體'),0,decode(instr(pa91,'小個體'),0,'','小個體'),'微個體'),'大個體')) C06"
      
   End If 'Added by Morgan 2023/3/29
   
   stSQL = stSQL & _
      ",'第'||decode(pa72,'',1,2+length(pa72)-length(replace(pa72,',','')))||'次' C07" & _
      ",cp64 C08 from caseprogress,patent,nextprogress,letterprogress,lettercache l,customer,acc090,staff" & _
      " where cp27>to_char(sysdate,'yyyymmdd')-10000 and cp01='CFP' and cp10='1913'" & _
      " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04 and pa09='101' and pa57 is null" & _
      " and np01(+)=cp43 and np22(+)=cp30 and np07='606' and np06 is null" & _
      " and lp01(+)=cp09 and lc01(+)=cp43 and lc02=cp30" & _
      " and cu01(+)=substr(pa26,1,8) and cu02(+)=substr(pa26,9)" & _
      " and a0901(+)=cu12 and st01(+)=cu13 and substr(cu12,1,1) in ('S','M')" & _
      " order by 1,2,3,4,5"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      intCounter = 1
      stTmp = Array("業務區", "智權人員", "客戶名稱", "催期限日期", "本所案號", "大小個體", "第幾次維持費", "報價(進度備註)")
      intWidth = Array(12, 12, 24, 12, 12, 10, 16, 60)
      xlsAgentPoint.SheetsInNewWorkbook = 1 '預設工作表數目
      xlsAgentPoint.Workbooks.add
      xlsAgentPoint.Application.WindowState = xlMinimized
      'xlsAgentPoint.Application.Visible = True
      Set wksrpt = xlsAgentPoint.Worksheets(1)
      '設定欄位名稱及欄寬
      For ii = LBound(stTmp) To UBound(stTmp)
          wksrpt.Range(Chr(ii + 65) & intCounter).Value = stTmp(ii)
          wksrpt.Columns(Chr(ii + 65) & ":" & Chr(ii + 65)).ColumnWidth = intWidth(ii)
          wksrpt.Range(Chr(ii + 65) & intCounter).HorizontalAlignment = xlCenter
      Next ii
      intCounter = intCounter + 1
        
      With rsQuery
      .MoveFirst
      Do While Not .EOF
         wksrpt.Range("A" & intCounter).Value = "" & .Fields("C01")  '業務區
         wksrpt.Range("B" & intCounter).Value = "" & .Fields("C02")  '智權人員
         wksrpt.Range("C" & intCounter).Value = "" & .Fields("C03")  '客戶名稱
         wksrpt.Range("D" & intCounter).Value = "" & .Fields("C04")  '催期限日期
         wksrpt.Range("E" & intCounter).Value = "" & .Fields("C05")  '本所案號
         wksrpt.Range("F" & intCounter).Value = "" & .Fields("C06")  '大小個體
         wksrpt.Range("G" & intCounter).Value = "" & .Fields("C07")  '第幾次維持費
         wksrpt.Range("H" & intCounter).Value = "" & .Fields("C08")  '報價(進度備註)
         .MoveNext
         intCounter = intCounter + 1
      Loop
      
      If Val(xlsAgentPoint.Version) < 12 Then
         xlsAgentPoint.Workbooks(1).SaveAs FileName:=App.path & TextPath & xlsFileNameA, FileFormat:=-4143
      Else
         xlsAgentPoint.Workbooks(1).SaveAs FileName:=App.path & TextPath & xlsFileNameA, FileFormat:=56
      End If
      xlsAgentPoint.Workbooks.Close
      xlsAgentPoint.Quit
      End With
   End If
   
   '寄給杜燕文74018
   stTO = "74018"
   
   If intQ = 1 Then
      SendMAPIMail stTO, strSubject1 & "(詳附件)", vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, App.path & TextPath & xlsFileNameA, , , stCC, stBCC
   Else
      SendMAPIMail stTO, strSubject1 & "(無案件)", vbCrLf & vbCrLf & "***本次無案件***" & vbCrLf & vbCrLf, , , , stCC, stBCC
   End If
   
   Set rsQuery = Nothing
   Set wksrpt = Nothing
   Set xlsAgentPoint = Nothing
   Exit Sub
   
ErrHnd:
   If Err.Number <> 0 Then
      WLog Err.Description
   End If
End Sub

'Added by Morgan 2024/7/22
'專利處C類來函承辦人非專利處人員案件
Private Sub StrMenu135()
   
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   Dim xlsAgentPoint As New Excel.Application
   Dim wksrpt As New Worksheet
   Dim strSubject1 As String
   Dim xlsFileNameA As String
   Dim intCounter As Integer, ii As Integer
   Dim stTmp, intWidth
   Dim stTO As String, stCC As String
   
On Error GoTo ErrHnd
   
   strSubject1 = strSrvDate(1) & "專利處C類來函承辦人非專利處人員案件"
   xlsFileNameA = strSubject1 & ".xls"
   
   If Dir(App.path & TextPath & xlsFileNameA) <> "" Then
        Kill App.path & TextPath & xlsFileNameA
   End If
   
   stSQL = "select sqldatet(cp05) C01,cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) C02" & _
      ",decode(pa09,'000',cpm03,cpm04) C03,cp14||' '||st02 C04" & _
      " from caseprogress,staff,patent,casepropertymap" & _
      " where cp05>=to_char(sysdate-14,'yyyymmdd') and cp09 like 'C%' and cp12 not like 'F%' and cp158=0 and cp159=0 and cp01 in ('P','CFP')" & _
      " and cp14 is not null and st01(+)=cp14 and st03 not like 'P1%'" & _
      " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04" & _
      " and cpm01(+)=cp01 and cpm02(+)=cp10" & _
      " order by 1,2,3,4"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      intCounter = 1
      stTmp = Array("收文日", "本所案號", "案件性質", "承辦人")
      intWidth = Array(12, 14, 12, 14)
      xlsAgentPoint.SheetsInNewWorkbook = 1 '預設工作表數目
      xlsAgentPoint.Workbooks.add
      xlsAgentPoint.Application.WindowState = xlMinimized
      'xlsAgentPoint.Application.Visible = True
      Set wksrpt = xlsAgentPoint.Worksheets(1)
      '設定欄位名稱及欄寬
      For ii = LBound(stTmp) To UBound(stTmp)
          wksrpt.Range(Chr(ii + 65) & intCounter).Value = stTmp(ii)
          wksrpt.Columns(Chr(ii + 65) & ":" & Chr(ii + 65)).ColumnWidth = intWidth(ii)
          wksrpt.Range(Chr(ii + 65) & intCounter).HorizontalAlignment = xlCenter
      Next ii
      intCounter = intCounter + 1
        
      With rsQuery
      .MoveFirst
      Do While Not .EOF
         wksrpt.Range("A" & intCounter).Value = "" & .Fields("C01")  '收文日
         wksrpt.Range("B" & intCounter).Value = "" & .Fields("C02")  '本所案號
         wksrpt.Range("C" & intCounter).Value = "" & .Fields("C03")  '案件性質
         wksrpt.Range("D" & intCounter).Value = "" & .Fields("C04")  '承辦人
         .MoveNext
         intCounter = intCounter + 1
      Loop
      
      If Val(xlsAgentPoint.Version) < 12 Then
         xlsAgentPoint.Workbooks(1).SaveAs FileName:=App.path & TextPath & xlsFileNameA, FileFormat:=-4143
      Else
         xlsAgentPoint.Workbooks(1).SaveAs FileName:=App.path & TextPath & xlsFileNameA, FileFormat:=56
      End If
      xlsAgentPoint.Workbooks.Close
      xlsAgentPoint.Quit
      End With
      stTO = "99050"
      stCC = Pub_GetSpecMan("程式管理人員")
      SendMAPIMail stTO, strSubject1, "請重新分案附件所列案件！電腦中心會再檢視是否還有程式需修正。" & vbCrLf & vbCrLf, App.path & TextPath & xlsFileNameA, , , stCC
   End If
   
   Set rsQuery = Nothing
   Set wksrpt = Nothing
   Set xlsAgentPoint = Nothing
   Exit Sub
   
ErrHnd:
   If Err.Number <> 0 Then
      WLog Err.Description
   End If
End Sub


'Added by Lydia 2022/02/22 外專紙本公文資料稽核表
Private Sub StrMenu111()
'參考共同程序作業之frm12040121，但只抓來函記錄檔MailRec來函收文日在系統日－1個月~系統日－2個工作天的FCP及FG案件，以案號+來函日檢查案件進度檔，若無資料則MAIL通知程序及其主管。
Dim strWDate1 As String, strWDate2 As String
Dim stSQL As String, intQ As Integer
Dim rsQuery As ADODB.Recordset
Dim xlsPoint111 As New Excel.Application
Dim wksRpt111 As New Worksheet
Dim intRow As Integer, intField As Integer, intTitleR As Integer
Dim strField, intWidth
Dim stTO As String, stCC As String
Dim TFName As String, xlsTFName As String
Dim ii As Integer
Dim strSpecMan As String
Dim strChk As String 'Added by Lydia 2022/03/03

On Error GoTo ErrHnd

    TFName = "外專紙本公文資料稽核表"
    Call PUB_KillTempFile(Mid(TextPath & TFName & "*.*", 2))    '清除舊檔
    
    strWDate1 = CompDate(1, -1, strSrvDate(1))
    'Modified by Morgan 2023/6/14 改稽核到前1個工作天，這樣當天上傳且稽核區間內還有公文時才不會檢查不過 --敏莉,淑華
    'strWDate2 = CompWorkDay(3, strSrvDate(1), 1)
    strWDate2 = CompWorkDay(2, strSrvDate(1), 1)
    'end 2023/6/14
     
    'Added by Lydia 2022/02/24 備註是" 消滅"，則統一發給Gill(消滅函程序人員處理人員)，再CC主管
    strSpecMan = Pub_GetSpecMan("外專程序-專利權消滅")
    If strSpecMan = "" Then
        strSpecMan = "NA16"
    Else
        strSpecMan = CNULL(strSpecMan)
    End If
    'end 2022/02/24
    
    'Modifeid by Lydia 2022/02/24 備註是" 消滅"，則統一發給Gill(消滅函程序人員處理人員)，再CC主管; NA16=> DECODE(SIGN(INSTR(MR09,'消滅')),1," & strSpecMan & " ,NA16)
    stSQL = "SELECT V1.*, FA10,DECODE(SIGN(INSTR(MR09,'消滅')),1," & strSpecMan & " ,NA16) as NA16,NVL(FA04,NVL(FA05,FA06)) PA75NAME,NVL(CU04,NVL(CU05,CU06)) PA26NAME " & _
                  "FROM ( " & _
                  "SELECT X1.*, DECODE(PA01,NULL, NVL(SP05,NVL(SP06,SP07)), NVL(PA05,NVL(PA06,PA07))) CASENAME ,NVL(PA75,SP26) PA75,NVL(PA26,SP08) PA26 " & _
                  "FROM (SELECT MR12,MR13,MR14,MR15,SQLDATET(MR02) MR02,1 AS KEY6,NVL(CP09,MR01) MR01 ,SQLDATET(MR16) MR16,SQLDATET(MR17) MR17,MR09 " & _
                  "FROM (SELECT CP01,CP02,CP03,CP04,CP05,CP06,CP07,CP09,CP64,MR01,MR02,MR09,MR12,MR13,MR14,MR15,MR16,MR17 FROM MAILREC, CASEPROGRESS " & _
                  "WHERE MR12 = CP01(+) AND MR13 = CP02(+) AND MR14 = CP03(+) AND MR15 = CP04(+) AND MR02 = CP05(+) AND (MR12 = 'FCP' OR MR12 = 'FG' " & _
                  ") AND MR02 >= " & strWDate1 & " AND MR02 <= " & strWDate2 & " ) WHERE CP09 IS NULL " & _
                  ") X1, PATENT, SERVICEPRACTICE WHERE MR12=PA01(+) AND MR13=PA02(+) AND MR14=PA03(+) AND MR15=PA04(+) AND MR12=SP01(+) AND MR13=SP02(+) AND MR14=SP03(+) AND MR15=SP04(+) " & _
                  ") V1, FAGENT, NATION,CUSTOMER WHERE SUBSTR(PA75,1,8)=FA01(+) AND SUBSTR(PA75,9,1)=FA02(+) AND FA10=NA01(+) AND SUBSTR(PA26,1,8)=CU01(+) AND SUBSTR(PA26,9,1)=CU02(+) " & _
                 "ORDER BY NA16,MR02,MR12,MR13,MR14,MR15 "
    intQ = 1
    Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
    If intQ = 1 Then
        strField = Array("來函收文日", "收  件  號", "本  所  案  號", "案　件　名　稱", "申　請　人", "本所期限", "法定期限", "備　　　註")
        intWidth = Array(10, 10, 14, 28, 30, 10, 10, 25)
        With rsQuery
            .MoveFirst
            'Modified by Morgan 2023/6/13 歸卷公文須排除已刪除者 + and cpp10<>'D'
            Do While Not .EOF
               'Added by Lydia 2022/03/03 請增加判斷，紙本公文為【讓與】且進度檔有一道【核准-讓與】卷宗區有檔案名稱為FCPxxxxx.odoc.xxx副檔說明為歸卷公文，上傳日期為櫃檯收文日當天或之後，則視為已處理此紙本來函，系統不在發通知，謝謝。
               strChk = "N"
               If InStr("" & .Fields("MR09"), "讓與") > 0 Then
                    strSql = "select c1.cp09,cpp02,cpp06 from caseprogress c1,caseprogress c2,casepaperpdf " & _
                                "where c1.cp01='" & rsQuery.Fields("mr12") & "' and c1.cp02='" & rsQuery.Fields("mr13") & "' and c1.cp03='" & rsQuery.Fields("mr14") & "' and c1.cp04='" & rsQuery.Fields("mr15") & "' and c1.cp10='1001' and c1.cp159=0 " & _
                                "and c1.cp43=c2.cp09(+) and c2.cp10='701' and c1.cp09=cpp01(+) and instr(upper(cpp02),'.ODOC.') > 0 and cpp10<>'D' and cpp06>=" & DBDATE(rsQuery.Fields("mr02"))
                    intI = 1
                    Set RsTemp = ClsLawReadRstMsg(intI, strSql)
                    If intI = 1 Then
                        strChk = "Y"
                    End If
               
               'Added by Morgan 2022/8/12 +變更及其他--Sharon
               '變更
               ElseIf InStr("" & .Fields("MR09"), "變更") > 0 Then
                    strSql = "select c1.cp09,cpp02,cpp06 from caseprogress c1,caseprogress c2,casepaperpdf " & _
                                "where c1.cp01='" & rsQuery.Fields("mr12") & "' and c1.cp02='" & rsQuery.Fields("mr13") & "' and c1.cp03='" & rsQuery.Fields("mr14") & "' and c1.cp04='" & rsQuery.Fields("mr15") & "' and c1.cp10='1001' and c1.cp159=0 " & _
                                "and c1.cp43=c2.cp09(+) and c2.cp10='401' and c1.cp09=cpp01(+) and instr(upper(cpp02),'.ODOC.') > 0 and cpp10<>'D' and cpp06>=" & DBDATE(rsQuery.Fields("mr02"))
                    intI = 1
                    Set RsTemp = ClsLawReadRstMsg(intI, strSql)
                    If intI = 1 Then
                        strChk = "Y"
                    End If
                    
               '其他(未收文數量與歸卷公文檔案數量相同時不列出)
               Else
                    strSql = "select count(*) from caseprogress c1,casepaperpdf " & _
                                "where c1.cp01='" & rsQuery.Fields("mr12") & "' and c1.cp02='" & rsQuery.Fields("mr13") & "' and c1.cp03='" & rsQuery.Fields("mr14") & "' and c1.cp04='" & rsQuery.Fields("mr15") & "' and c1.cp09 like 'C%' and c1.cp159=0 " & _
                                "and c1.cp09=cpp01(+) and instr(upper(cpp02),'.ODOC.') > 0 and cpp10<>'D' and cpp06>=" & DBDATE(rsQuery.Fields("mr02"))
                    intI = 1
                    Set RsTemp = ClsLawReadRstMsg(intI, strSql)
                    If intI = 1 Then
                        If RsTemp(0) > 0 Then
                           intQ = RsTemp(0)
                           intI = 0
                           Set RsTemp = rsQuery.Clone
                           With RsTemp
                           .MoveFirst
                           .Find "mr01='" & rsQuery.Fields("mr01") & "'" 'Added by Morgan 2022/12/26
                           Do While Not .EOF
                              If .Fields("mr12") = rsQuery.Fields("mr12") And .Fields("mr13") = rsQuery.Fields("mr13") And .Fields("mr14") = rsQuery.Fields("mr14") And .Fields("mr15") = rsQuery.Fields("mr15") Then
                                 intI = intI + 1
                              End If
                              .MoveNext
                           Loop
                           End With
                           If intQ = intI Then
                              strChk = "Y"
                           End If
                        End If
                    End If
               'end 2022/8/12
               End If
               
               'Added by Morgan 2025/9/9
               '若櫃台備註有"收據"字樣且卷宗區有櫃台收文日2個工作天內上傳的".RECEIPT."檔案時就算稽核通過--Sharon Ex:FCP-063049
               If strChk = "N" And InStr("" & .Fields("MR09"), "收據") > 0 Then
                    strSql = "select cp09,cpp02,cpp06 from caseprogress,casepaperpdf where cp01='" & rsQuery.Fields("mr12") & "' and cp02='" & rsQuery.Fields("mr13") & "' and cp03='" & rsQuery.Fields("mr14") & "' and cp04='" & rsQuery.Fields("mr15") & "' and cp09<'C'" & _
                     " and cp159=0 and cp158>0 and cpp01(+)=cp09 and instr(upper(cpp02),'.RECEIPT.') > 0 and cpp10<>'D' and cpp06>=" & DBDATE(rsQuery.Fields("mr02")) & " and cpp06<=" & CompWorkDay(2, DBDATE(rsQuery.Fields("mr02")))
                    intI = 1
                    Set RsTemp = ClsLawReadRstMsg(intI, strSql)
                    If intI = 1 Then
                        strChk = "Y"
                    End If
               End If
               'end 2025/9/9
               
               If strChk = "N" Then
               'end 2022/03/03
                    If stTO <> "" & .Fields("na16") Then
                         If stTO <> "" Then
                               xlsTFName = App.path & TextPath & TFName & "_" & stTO & ".xls"
                               wksRpt111.Range("A" & intRow & ":" & Chr(65 + UBound(strField)) & intRow).Borders(xlEdgeTop).LineStyle = xlContinuous
                               wksRpt111.Range("A" & intRow & ":" & Chr(65 + UBound(strField)) & intRow).Borders(xlEdgeTop).Weight = xlThin
                               '列印設定
                               wksRpt111.PageSetup.PaperSize = 9 'A4
                               wksRpt111.PageSetup.CenterFooter = "第 &P 頁，共 &N 頁"
                               wksRpt111.PageSetup.PrintTitleRows = "$1:$" & intTitleR
                               wksRpt111.PageSetup.Orientation = xlLandscape '橫印
                               wksRpt111.PageSetup.LeftMargin = 0.4 '邊界
                               wksRpt111.PageSetup.RightMargin = 0.4
                               wksRpt111.PageSetup.TopMargin = xlsPoint111.InchesToPoints(0.4)
                               wksRpt111.PageSetup.BottomMargin = xlsPoint111.InchesToPoints(0.4)
                               wksRpt111.PageSetup.CenterHorizontally = True '版面設定->邊界->水平置中
                               '----------------------
                               If Val(xlsPoint111.Version) < 12 Then
                                  xlsPoint111.Workbooks(1).SaveAs FileName:=xlsTFName, FileFormat:=-4143
                               Else
                                  xlsPoint111.Workbooks(1).SaveAs FileName:=xlsTFName, FileFormat:=56
                               End If
                               xlsPoint111.Workbooks.Close
                               stCC = PUB_GetFCPProSup(stTO)
                               SendMAPIMail stTO, ChangeTStringToTDateString(strSrvDate(2)) & TFName, vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, xlsTFName, , , stCC
                         End If
                         stTO = .Fields("na16")
                         intTitleR = 5:  intRow = intTitleR
                         xlsPoint111.SheetsInNewWorkbook = 1 '預設工作表數目
                         xlsPoint111.Workbooks.add
                         xlsPoint111.Application.WindowState = xlMinimized
                         Set wksRpt111 = xlsPoint111.Worksheets(1)
                         '設定欄位名稱及欄寬
                         For ii = LBound(strField) To UBound(strField)
                             wksRpt111.Range(Chr(ii + 65) & intRow).Value = strField(ii)
                             wksRpt111.Columns(Chr(ii + 65) & ":" & Chr(ii + 65)).ColumnWidth = intWidth(ii)
                             wksRpt111.Columns(Chr(ii + 65) & ":" & Chr(ii + 65)).HorizontalAlignment = xlLeft
                             wksRpt111.Columns(Chr(ii + 65) & ":" & Chr(ii + 65)).Font.Size = 11
                         Next ii
                         wksRpt111.Range("A" & intRow & ":" & Chr(65 + UBound(strField)) & intRow).Borders(xlEdgeBottom).LineStyle = xlContinuous
                         wksRpt111.Range("A" & intRow & ":" & Chr(65 + UBound(strField)) & intRow).Borders(xlEdgeBottom).Weight = xlThin
                         intRow = 1
                         wksRpt111.Range("A" & intRow).Value = TFName
                         wksRpt111.Range("A" & intRow).Font.Size = 18
                         wksRpt111.Range("A" & intRow).Font.Bold = True
                         wksRpt111.Range("A" & intRow & ":" & Chr(65 + UBound(strField)) & "1").MergeCells = True
                         wksRpt111.Range("A" & intRow & ":" & Chr(65 + UBound(strField)) & "1").HorizontalAlignment = xlCenter
                         wksRpt111.Range("A" & intRow & ":" & Chr(65 + UBound(strField)) & "1").VerticalAlignment = xlCenter
                         intRow = intRow + 2
                         wksRpt111.Range("A" & intRow).Value = "系統別：FCP,FG"
                         wksRpt111.Range("G" & intRow).Value = "程序人員："
                         wksRpt111.Range("H" & intRow).Value = GetStaffName("" & .Fields("NA16"), True)
                         intRow = intRow + 1
                         wksRpt111.Range("A" & intRow).Value = "來函收文日：" & ChangeWStringToTDateString(strWDate1) & " - " & ChangeWStringToTDateString(strWDate2)
                         wksRpt111.Range("G" & intRow).Value = "列印日期："
                         wksRpt111.Range("H" & intRow).Value = ChangeTStringToTDateString(strSrvDate(2))
                         intRow = intRow + 2 '前面已設定抬頭
                    End If
                    
                    wksRpt111.Range("A" & intRow).Value = "" & .Fields("MR02")  '來函收文日
                    wksRpt111.Range("B" & intRow).Value = "" & .Fields("MR01")  '收  件  號
                    wksRpt111.Range("C" & intRow).Value = "" & .Fields("MR12") & "-" & .Fields("MR13") & "-" & .Fields("MR14") & "-" & .Fields("MR15")   '本  所  案  號
                    wksRpt111.Range("D" & intRow).Value = "" & .Fields("CASENAME") '案件名稱
                    wksRpt111.Range("E" & intRow).Value = "" & .Fields("PA26NAME") '申　請　人
                    wksRpt111.Range("F" & intRow).Value = "" & .Fields("MR16")  '本所期限
                    wksRpt111.Range("G" & intRow).Value = "" & .Fields("MR17")  '法定期限
                    wksRpt111.Range("H" & intRow).Value = PUB_StrToStr("" & .Fields("MR09"), 26) '備　　　註
                    intRow = intRow + 1
               End If 'Added by Lydia 2022/03/03
               .MoveNext
            Loop
            If stTO <> "" Then 'Added by Lydia 2022/03/03
                xlsTFName = App.path & TextPath & TFName & "_" & stTO & ".xls"
                wksRpt111.Range("A" & intRow & ":" & Chr(65 + UBound(strField)) & intRow).Borders(xlEdgeTop).LineStyle = xlContinuous
                wksRpt111.Range("A" & intRow & ":" & Chr(65 + UBound(strField)) & intRow).Borders(xlEdgeTop).Weight = xlThin
                '列印設定
                wksRpt111.PageSetup.PaperSize = 9 'A4
                wksRpt111.PageSetup.CenterFooter = "第 &P 頁，共 &N 頁"
                wksRpt111.PageSetup.PrintTitleRows = "$1:$" & intTitleR
                wksRpt111.PageSetup.Orientation = xlLandscape '橫印
                wksRpt111.PageSetup.LeftMargin = 0.4 '邊界
                wksRpt111.PageSetup.RightMargin = 0.4
                wksRpt111.PageSetup.TopMargin = xlsPoint111.InchesToPoints(0.4)
                wksRpt111.PageSetup.BottomMargin = xlsPoint111.InchesToPoints(0.4)
                wksRpt111.PageSetup.CenterHorizontally = True '版面設定->邊界->水平置中
                '----------------------
                If Val(xlsPoint111.Version) < 12 Then
                   xlsPoint111.Workbooks(1).SaveAs FileName:=xlsTFName, FileFormat:=-4143
                Else
                   xlsPoint111.Workbooks(1).SaveAs FileName:=xlsTFName, FileFormat:=56
                End If
                xlsPoint111.Workbooks.Close
                xlsPoint111.Quit
            End If 'Added by Lydia 2022/03/03
        End With
    End If
    If stTO <> "" Then
        stCC = PUB_GetFCPProSup(stTO)
        SendMAPIMail stTO, ChangeTStringToTDateString(strSrvDate(2)) & TFName, vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, xlsTFName, , , stCC
    End If
    
    Set RsTemp = Nothing 'Added by Lydia 2022/03/03
    Set rsQuery = Nothing
    Set wksRpt111 = Nothing
    Set xlsPoint111 = Nothing
    
    Exit Sub
   
ErrHnd:
   If Err.Number <> 0 Then
      WLog Err.Description
   End If
End Sub

'Added by Lydia 2022/02/24 外專申請人異動請檢查個案設定之清單
Private Sub StrMenu112()
'請作單:當個案收文701（讓與）、702（合併）、703（繼承）以及708（專利權讓與）時，請一併比照更換代理人時提供清單給承辦確認個案之相關設定
            '==> 前一工作天有收文701（讓與）、702（合併）、703（繼承）以及708（專利權讓與）時，請一併比照更換代理人時提供清單給承辦確認個案之相關設定
Dim intX As Integer, strX1 As String, stWorkDate1 As String, stWorkDate2 As String
Dim rsAD As New ADODB.Recordset
Dim stCaseList As String

     Call PUB_KillTempFile(Mid(TextPath & "*申請人異動請檢查個案設定之清單.*", 2))     '清除舊檔
     
    stWorkDate1 = CompWorkDay(2, strSrvDate(1), 1)
    stWorkDate2 = strSrvDate(1)

    strX1 = "SELECT CP01||CP02||CP03||CP04 AS CASENO From CASEPROGRESS " & _
               "WHERE CP01='FCP' AND CP05>=" & stWorkDate1 & " AND CP05<=" & stWorkDate2 & " AND CP09<'C' AND CP10 IN ('701','702','703','708') AND CP159=0 "
    intX = 1
    Set rsAD = ClsLawReadRstMsg(intX, strX1)
    If intX = 1 Then
        stCaseList = rsAD.GetString(adClipString, , , ",")
        stCaseList = Mid(stCaseList, 1, Len(stCaseList) - 1)
        strX1 = vbCrLf & stWorkDate1 & "有收文701（讓與）、702（合併）、703（繼承）以及708（專利權讓與），" & vbCrLf & _
                   "詳情請見附件。"
        If PUB_ChgPA75List(stCaseList, "1", App.path & Mid(TextPath, 1, Len(TextPath) - 1), stWorkDate1, strX1) = False Then
            GoTo ErrHandle
        End If
    End If
    Set rsAD = Nothing
    Exit Sub
    
ErrHandle:
    WLog "Email案件清單作業失敗"
End Sub

'Added by Lydia 2022/03/22 整批直接更新造字(共用模組)
Private Sub StrMenu113()
'因為111/3/12 的批次更換造字是在M51-Win7執行exe, 程式直接開啟Excel檔,直接讀取Excel值動丟到String變數,再組合語法,
'然後Unicode呈現?造成大量資料的造字都變成「?」，之後3/14~3/17都在檢查和還原資料。
'發生原因尚未查清楚(ex.在M51-Win7開啟excel的字體看起來正常,excel的字型從明朝體改為細明體)
'現在將步驟改為：匯入DB=>檢查產生的Excel=>確認加入排程=> 每日批次 or (人工啟動)直接更新
'-----------------------------------------------------
    
    Call PUB_KillTempFile(Mid(TextPath, 2) & "*檢查_造字更換表.*")
    strExc(0) = "select count(*) cnt from editeudclog where eel01=9999  "
    intI = 1
    Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
    If intI = 0 Then
        Exit Sub
    Else
        If Val("" & RsTemp.Fields("cnt")) > 0 Then
            If Pub_BatchDay113Proc("3") = True Then
                 Call PUB_BatchDay113Excel("3", TextPath)
                 Exit Sub
            Else
                 WLog "整批直接更新造字失敗；"
            End If
        End If
    End If
    
End Sub

'Added by Morgan 2022/5/30
'X15833160欣興電子期限管控
Private Sub StrMenu114()
   Dim stVTB As String
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   Dim stDDate As String, stDDate2 As String
   Dim stMemo As String, stMemo2 As String
   Dim stUpd As String
   Dim stCP06 As String, stCP07 As String, stCP64 As String
   
On Error GoTo ErrHnd

   '始日不計算
   'A. TW新申請案需在洽案會議後8周內提申；
   'B. TW新申請案需在洽案會議後3周內會第1次初稿；
   stSQL = "select pa09,cp09,cp05,cp06,cp07,cp64,cp165,cp166,ep37,ep08 from patent,caseprogress,engineerprogress" & _
      " where pa26='X15833160' and pa57||pa108 is null and pa09='000'" & _
      " and cp01(+)=pa01 and cp02(+)=pa02 and cp03(+)=pa03 and cp04(+)=pa04 and cp10 in ('101','102')" & _
      " and cp158=0 and cp159=0 and ep02(+)=cp09"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      With rsQuery
      .MoveFirst
      Do While Not .EOF
         stCP06 = "" & .Fields("CP06")
         stCP07 = "" & .Fields("CP07")
         stCP64 = "" & .Fields("CP64")
         stUpd = ""
         stMemo = ""
         stMemo2 = ""
         stDDate2 = ""
         
         'A. TW新申請案需在洽案會議後8周內提申；
         '更新法定期限
         If stCP07 = "" Or InStr(stCP64, "提申法限(客戶):") = 0 Then
            stDDate = CompDate(2, 56, .Fields("cp05")) '設定法限(收文日+56日)
            stDDate = PUB_GetWorkDay1(stDDate, True)
            '早於法限才要更新
            If stCP07 = "" Or stDDate < stCP07 Then
               stUpd = ",cp07=" & stDDate
               stMemo = "提申法限(客戶):" & ChangeWStringToTDateString(stDDate)
               stCP07 = stDDate
            End If
         End If
         
         '會稿完成: 更新為3rd所限(會稿完成日+14日)
         If .Fields("ep08") > 0 Then
            If InStr(stCP64, "提申所限(客戶):") = 0 Then
               stDDate2 = CompDate(2, 14, .Fields("ep08"))
               stMemo2 = "提申所限(客戶):"
            End If
         '已會稿:更新為2nd所限(會稿日+21日)
         ElseIf .Fields("ep37") > 0 Then
            If InStr(stCP64, "會完所限(客戶):") = 0 Then
               stDDate2 = CompDate(2, 21, .Fields("ep37"))
               stMemo2 = "會完所限(客戶):"
            End If
         '未會稿: 設定1st所限(收文日+21日)
         Else
            If InStr(stCP64, "送會所限(客戶):") = 0 Then
               stDDate2 = CompDate(2, 21, .Fields("cp05"))
               stMemo2 = "送會所限(客戶):"
            End If
         End If
         
         If stDDate2 <> "" Then
            '所限不可晚於法限
            If stCP07 <> "" And stDDate2 > stCP07 Then stDDate2 = stCP07
            
            stDDate2 = PUB_GetWorkDay1(stDDate2, True)
            '更新本所期限
            If stDDate2 <> stCP06 Then
               '客戶所限若晚於真實所限則更新回真實所限
               If .Fields("cp165") > 0 And .Fields("cp165") < stDDate2 Then
                  stUpd = ",cp06=" & .Fields("cp165") & stUpd
               Else
                  stUpd = ",cp06=" & stDDate2 & ",cp166='U'" & stUpd
                  stMemo = stMemo & IIf(stMemo <> "", ",", "") & stMemo2 & ChangeWStringToTDateString(stDDate2)
               End If
            End If
         End If
                  
         If stUpd <> "" Then
            If stMemo <> "" Then
               stUpd = "cp64='" & ChangeWStringToTDateString(strSrvDate(1)) & " " & stMemo & ";'||cp64" & stUpd
            Else
               stUpd = Mid(stUpd, 2)
            End If
            stSQL = "update caseprogress set " & stUpd & " where cp09='" & .Fields("cp09") & "'"
            cnnConnection.Execute stSQL, intQ
         End If
         
         .MoveNext
      Loop
      End With
   End If
   
   'C. CN新申請案需在TW定稿後1周內會第1次初稿；
   'D. US新申請案需在TW定稿後4周內會第1次初稿；
   stSQL = "select p1.pa09,c1.cp09,c1.cp06,c1.cp07,c1.cp64,c1.cp165,c1.cp166,e1.ep37,e1.ep08,c2.cp06 cp06tw,e2.ep08 ep08tw,c2.cp07 cp07tw" & _
      " from patent p1,caseprogress c1,engineerprogress e1" & _
      ",casemap,patent p2,caseprogress c2,engineerprogress e2" & _
      " where p1.pa26='X15833160' and p1.pa57||p1.pa108 is null and p1.pa09 in ('020','101')" & _
      " and c1.cp01(+)=p1.pa01 and c1.cp02(+)=p1.pa02 and c1.cp03(+)=p1.pa03 and c1.cp04(+)=p1.pa04" & _
      " and c1.cp10 in ('101','102') and c1.cp158=0 and c1.cp159=0 and e1.ep02(+)=c1.cp09" & _
      " and cm01(+)=c1.cp01 and cm02(+)=c1.cp02 and cm03(+)=c1.cp03 and cm04(+)=c1.cp04 and cm10='0'" & _
      " and p2.pa01(+)=cm05 and p2.pa02(+)=cm06 and p2.pa03(+)=cm07 and p2.pa04(+)=cm08 and p2.pa09='000'" & _
      " and c2.cp01(+)=p2.pa01 and c2.cp02(+)=p2.pa02 and c2.cp03(+)=p2.pa03 and c2.cp04(+)=p2.pa04" & _
      " and c2.cp10 in ('101','102') and e2.ep02(+)=c2.cp09 and e2.ep08>0"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      With rsQuery
      .MoveFirst
      Do While Not .EOF
         stCP06 = "" & .Fields("CP06")
         stCP07 = "" & .Fields("CP07")
         stCP64 = "" & .Fields("CP64")
         stUpd = ""
         stMemo = ""
         stMemo2 = ""
         stDDate2 = ""
         
         '已會稿:
         If .Fields("ep37") > 0 Then
            If InStr(stCP64, "會完所限(客戶):") = 0 Then
               '更新為2nd所限(會稿日+28日)
               If .Fields("pa09") = "101" Then
                  stDDate2 = CompDate(2, 28, .Fields("ep37"))
                  stMemo2 = "會完所限(客戶):"
               
               '更新為2nd所限 (設定為TW所限)
               Else
                  stDDate2 = "" & .Fields("cp06tw")
                  stMemo2 = "提申所限(客戶):"
               End If
            End If
         '未會稿
         Else
            If InStr(stCP64, "送會所限(客戶):") = 0 Then
               'D. US新申請案需在TW定稿後4周內會第1次初稿；
               If .Fields("pa09") = "101" Then
                  stDDate2 = CompDate(2, 28, .Fields("ep08tw"))
                  
               'C. CN新申請案需在TW定稿後1周內會第1次初稿；
               Else
                  stDDate2 = CompDate(2, 7, .Fields("ep08tw"))
               End If
               stMemo2 = "送會所限(客戶):"
            End If
         End If
         
         If stDDate2 <> "" Then
            '所限不可晚於法限
            If stCP07 <> "" And stDDate2 > stCP07 Then stDDate2 = stCP07
            
            stDDate2 = PUB_GetWorkDay1(stDDate2, True)
            '更新本所期限
            If stDDate2 <> stCP06 Then
               '客戶所限若晚於真實所限則更新回真實所限
               If .Fields("cp165") > 0 And .Fields("cp165") < stDDate2 Then
                  stUpd = ",cp06=" & .Fields("cp165") & stUpd
               Else
                  stUpd = ",cp06=" & stDDate2 & ",cp166='U'" & stUpd
                  stMemo = stMemo2 & ChangeWStringToTDateString(stDDate2)
               End If
            End If
         End If
                  
         If stUpd <> "" Then
            If stMemo <> "" Then
               stUpd = "cp64='" & ChangeWStringToTDateString(strSrvDate(1)) & " " & stMemo & ";'||cp64" & stUpd
            Else
               stUpd = Mid(stUpd, 2)
            End If
            stSQL = "update caseprogress set " & stUpd & " where cp09='" & .Fields("cp09") & "'"
            cnnConnection.Execute stSQL, intQ
         End If

         .MoveNext
      Loop
      End With
   End If

   'E. TW申復需在收文後1周內會第1次初稿； 'Modified by Morgan 2022/8/1 +再審(107)--紹仁
   'F. CN陳述意見需在收文後1周內會第1次初稿； 'Modified by Morgan 2022/8/31 +復審(107)--紹仁
   'G. US答辯需在收文後2周內會第1次初稿； 'Modified by Morgan 2022/8/1 +RCE(424)--紹仁, 2023/7/20 +208選取--郭
   stSQL = "select pa09,cp09,cp05,cp06,cp07,cp64,cp165,cp166,ep37,ep34 from patent,caseprogress,engineerprogress" & _
      " where pa26='X15833160' and pa57||pa108 is null and pa09 in ('000','020','101')" & _
      " and cp01(+)=pa01 and cp02(+)=pa02 and cp03(+)=pa03 and cp04(+)=pa04" & _
      " and cp158=0 and cp159=0 and ((pa09='000' and (cp10='205' or cp10='107')) or (pa09='020' and (cp10='205' or cp10='107')) or (pa09='101' and (cp10='107' or cp10='208' or cp10='424')))" & _
      " and ep02(+)=cp09"
      
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      With rsQuery
      .MoveFirst
      Do While Not .EOF
         stCP06 = "" & .Fields("CP06")
         stCP07 = "" & .Fields("CP07")
         stCP64 = "" & .Fields("CP64")
         stUpd = ""
         stMemo = ""
         stMemo2 = ""
         stDDate2 = ""
                           
         '已會稿->還原所限
         If .Fields("ep37") > 0 Then
            If .Fields("cp166") = "Y" And .Fields("cp165") > .Fields("cp06") Then
               stSQL = "update caseprogress set cp06=cp165 where cp09='" & .Fields("cp09") & "'"
               cnnConnection.Execute stSQL, intQ
            End If
         '未會稿/不會稿
         ElseIf InStr(stCP64, "送會所限(客戶):") = 0 Then
         
            'G. US答辯需在收文後2周內會第1次初稿；
            If .Fields("pa09") = "101" Then
               stDDate2 = CompDate(2, 14, .Fields("cp05"))
            
            'E. TW申復需在收文後1周內會第1次初稿；
            'F. CN陳述意見需在收文後1周內會第1次初稿；
            Else
                stDDate2 = CompDate(2, 7, .Fields("cp05"))
            End If
            
            stMemo2 = "送會所限(客戶):"
            stDDate2 = PUB_GetWorkDay1(stDDate2, True)
            
            '所限不可晚於法限
            If stCP07 <> "" And stDDate2 > stCP07 Then stDDate2 = stCP07
            
            '更新本所期限
            If stDDate2 <> stCP06 Then
               '客戶所限若晚於真實所限則更新回真實所限
               If .Fields("cp165") > 0 And .Fields("cp165") < stDDate2 Then
                  stUpd = ",cp06=" & .Fields("cp165") & stUpd
               Else
                  stUpd = ",cp06=" & stDDate2 & ",cp166='U'" & stUpd
                  stMemo = stMemo2 & ChangeWStringToTDateString(stDDate2)
               End If
            End If
            
            If stUpd <> "" Then
               If stMemo <> "" Then
                  stUpd = "cp64='" & ChangeWStringToTDateString(strSrvDate(1)) & " " & stMemo & ";'||cp64" & stUpd
               Else
                  stUpd = Mid(stUpd, 2)
               End If
               stSQL = "update caseprogress set " & stUpd & " where cp09='" & .Fields("cp09") & "'"
               cnnConnection.Execute stSQL, intQ
            End If
         
         End If
         .MoveNext
      Loop
      End With
   End If
ErrHnd:
   If Err.Number <> 0 Then
      WLog "欣興電子期限管控:" & Err.Description
   End If
End Sub

'cancel by sonia 2025/8/27 改在StrMenu141做
''Add by Amy 2022/07/19 P案非台灣案收到專利權消滅函時由系統自動上結餘日期
'Private Sub StrMenu116()
'    Dim RsQ As New ADODB.Recordset, intQ As Integer, strQ As String
'On Error GoTo ErrHnd
'    strQ = "Select Distinct pa01,pa02,pa03,pa04 From Patent,CaseProgress " & _
'               "Where pa01='P' And pa09<>'000' And pa25=" & strSrvDate(1) & " And (CP16>0 Or CP60||CP61 is not null) And Nvl(CP109,0)=0 " & _
'               "And pa01=cp01(+) And pa02=cp02(+) And pa03=cp03(+) And pa04=cp04(+) "
'    intQ = 1
'    Set RsQ = ClsLawReadRstMsg(intQ, strQ)
'    If intQ = 1 Then
'        RsQ.MoveFirst
'        bolEndModCash = True
'        Do While Not RsQ.EOF
'            Pub_UpdateEndModCash RsQ.Fields("pa01"), RsQ.Fields("pa02"), RsQ.Fields("pa03"), RsQ.Fields("pa04")
'            RsQ.MoveNext
'        Loop
'        bolEndModCash = False
'    End If
'    Set RsQ = Nothing
'    Exit Sub
'
'ErrHnd:
'   If Err.Number <> 0 Then
'      WLog Err.Description
'   End If
'End Sub
'end 2025/8/27

'Added by Morgan 2022/8/16
'壓縮檔名重複時加流水號
Private Function GetGoodSaveName(pOrgName As String, pType As Integer, pKeyNo As String) As String
   Dim stZipName As String, stSaveName As String, stMain As String, stSub As String, intNo As Integer
   Dim stSQL As String, intQ As Integer
   
   intQ = InStrRev(pOrgName, ".")
   If intQ > 0 Then
      stMain = Left(pOrgName, intQ - 1)
      stSub = Mid(pOrgName, intQ + 1)
   Else
      stMain = pOrgName
      stSub = ""
   End If
   
   intNo = 0
   stSaveName = pOrgName
   Do
      If intNo > 0 Then
         stSaveName = stMain & "." & intNo & "." & stSub
      End If
      stZipName = stSaveName & ".encrypted.zip"
   
      If pType = 1 Then
         stSQL = "update CASEPAPERPDF set cpp13=cpp13 where cpp01='" & pKeyNo & "' and upper(cpp02)=upper('" & ChgSQL(stZipName) & "')"
      Else
         stSQL = "update CASEPAPERFILE set cpf12=cpf12 where cpf01='" & pKeyNo & "' and upper(cpf02)=upper('" & ChgSQL(stZipName) & "')"
      End If
      cnnConnection.Execute stSQL, intQ
      If intQ = 0 Then
         Exit Do
      End If
      intNo = intNo + 1
   Loop
   GetGoodSaveName = stSaveName
   
End Function

'Add by Amy 2022/09/07 P案非台灣案收到專利權消滅函系統自動上結餘日期-補舊資料
Private Sub StrMenu116_OnlyOne()
    Dim RsQ As New ADODB.Recordset, intQ As Integer, strQ As String
On Error GoTo ErrHnd
    '香港、澳門案,未收到專利權消滅但專利權已屆滿
    strQ = "Select Distinct pa01,pa02,pa03,pa04 From Patent,CaseProgress " & _
               "Where pa01='P' And (pa09='013' Or pa09='044') And pa25<" & strSrvDate(1) & " And (CP16>0 Or CP60||CP61 is not null) And Nvl(CP109,0)=0 " & _
               "And cp59 IS NULL And pa01=cp01(+) And pa02=cp02(+) And pa03=cp03(+) And pa04=cp04(+) "
    'P案非台灣案,已收到專利權消滅函未上結餘日期
    strQ = strQ & " Union " & _
            "Select MCP01,MCP02,MCP03,MCP04 From " & _
            "(Select A.CP01 MCP01,A.CP02 MCP02,A.CP03 MCP03,A.CP04 MCP04 ,max(cp09) as mcp09 From CaseProgress A " & _
              "Where A.CP01='P' And Nvl(A.CP109,0)=0 And A.cp59 IS NULL " & _
              " And Exists (Select * From CaseProgress B Where B.CP01=A.CP01 And B.CP02=A.CP02 And B.CP03=a.CP03 And B.CP04=a.CP04  And B.CP10='1604'  ) " & _
              " And Exists (Select * From Patent  Where pa01=A.CP01 And pa02=A.CP02 And PA03=A.CP03 And PA04=A.CP04 And pa09<>'000' And pa09<>'013' And pa09<>'044') " & _
            " Group by CP01,CP02,CP03,CP04),CaseProgress " & _
            "Where MCP01=CP01(+) And MCP02=CP02(+) And MCP03=CP03(+) And MCP04=CP04(+) And CP10='1604' And MCP09=CP09 "
    intQ = 1
    Set RsQ = ClsLawReadRstMsg(intQ, strQ)
    If intQ = 1 Then
        RsQ.MoveFirst
        bolEndModCash = True
        Do While Not RsQ.EOF
            Pub_UpdateEndModCashX RsQ.Fields("pa01"), RsQ.Fields("pa02"), RsQ.Fields("pa03"), RsQ.Fields("pa04")
            RsQ.MoveNext
        Loop
        bolEndModCash = False
    End If
    Set RsQ = Nothing
    Exit Sub
    
ErrHnd:
   If Err.Number <> 0 Then
      WLog Err.Description
   End If
End Sub

'Copy Pub_UpdateEndModCash修改
Private Sub Pub_UpdateEndModCashX(oCP01 As String, oCP02 As String, oCP03 As String, oCP04 As String)
    Dim StrSQLa As String, IsOldSystem As Boolean, tRS As New ADODB.Recordset
    
    If bolEndModCash = False Then Exit Sub
    '舊案抓規費科目借貸不平衡的才要上可結餘日期 , 新案一律上
    If Judgecase(oCP01, oCP02) = False Then GoTo Nextstep
    
    '若2012年起有A類收文且有收費者也要上可結餘日期CFT -1736
    strSql = "select cp09 from caseprogress where cp01='" & oCP01 & "' and cp02='" & oCP02 & "' and cp03='" & oCP03 & "' and cp04='" & oCP04 & "' and cp05>20120101 and cp09<'B' and nvl(cp16,0)>0"
    Set tRS = New ADODB.Recordset
    tRS.CursorLocation = adUseClient
    tRS.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
    If tRS.RecordCount > 0 Then GoTo Nextstep
    
    '判斷借貸要平衡
    strSql = "select sum(ax206) ax206,sum(ax207) ax207 from " & _
               "(select a.ax202,a.ax203,substr(a.ax205,1,4) ax205,a.ax206,a.ax207 from acc021 a " & _
               "where a.ax214='" & oCP01 & oCP02 & oCP03 & oCP04 & "' and substr(a.ax205,1,4)='2201' union " & _
               "select a1p04,a1p03,substr(a1p05,1,4) a1p05,a1p07,a1p08 from acc1p0,acc021 b " & _
               "where a1p17='" & oCP01 & oCP02 & oCP03 & oCP04 & "' and substr(a1p05,1,4)='2201' and a1p22=b.ax202(+) and a1p03=b.ax203(+) and b.ax202 is null) "
    Set tRS = New ADODB.Recordset
    tRS.CursorLocation = adUseClient
    tRS.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
    If tRS.RecordCount = 0 Then Exit Sub
    If Val("" & tRS.Fields(0)) = Val("" & tRS.Fields(1)) Then Exit Sub    '借貸平衡
    
Nextstep:
     StrSQLa = "update caseprogress set cp109=20220103 " & _
                     " where cp01='" & oCP01 & "' and cp02='" & oCP02 & "' and cp03='" & oCP03 & "' and cp04='" & oCP04 & "' " & _
                     " and cp27 is not null and cp59 is null "
                    
     cnnConnection.Execute StrSQLa
     bolEndModCash = False
End Sub
'end 2022/09/07


'Added by Lydia 2023/02/09 法律顧問及智財顧問服務狀況通知(不含顧問到期日)
Private Sub StrMenu118()
'LA案顧問聘任0和ACS智財顧問112：上述兩種類型的案件，於顧問開始聘任開始，每滿三個月（無須管制當日是否為工作天），系統以逐案方式通知收文的智權人員，該期限已服務之次數或時數，顧問到期日當天不通知。
'例如：111.1.8簽署並收文顧問一年，於111.4.7、111.7.7、111.10.7各發送一次系統通知。
'若收文智權人員已離職則改抓PUB_GetAKindSalesNo。
Dim strDate As String
Dim intQ As Integer, rsQD As New ADODB.Recordset
Dim strContent As String, strTo As String

On Error GoTo ErrHnd

   strDate = strSrvDate(1)

   'ACS案
   'Modified by Lydia 2023/02/14 +增加抓客戶檔的智權人員staff s2
   strSql = "select vtb.*,s1.st04 as cp13st04,nvl(lc05,nvl(lc06,lc07)) as casename,lc11, nvl(cu04,nvl(cu05,cu06)) custname,cu13, s2.st04 as cu13st04,s2.st15 as cu13st15 from ( " & _
               "select cp01,cp02,cp03,cp04,cp05,cp09,cp10,cp13,cp15,cp53,cp54 " & _
               ",months_between(to_date('" & strDate & "','yyyymmdd'),to_date(cp53,'yyyymmdd')) mons " & _
               "from caseprogress where cp01='ACS' and cp10='112' and cp159=0 and cp53 < '" & strDate & "' and cp54 > '" & strDate & "' " & _
               ") vtb,lawcase,customer,staff s1,staff s2 where mod(mons,3)=0 and cp01=lc01(+) and cp02=lc02(+) and cp03=lc03(+) and cp04=lc04(+) " & _
               "and substr(lc11,1,8)=cu01(+) and substr(lc11,9,1)=cu02(+) and cp13=s1.st01(+) and cu13=s2.st01(+) "
   'LA案
   'Modified by Lydia 2023/02/13 排除LA999999
   'Modified by Lydia 2023/02/14 +增加抓客戶檔的智權人員staff s2
   strSql = strSql & "union select vtb.*,s1.st04 as cp13st04,hc06 as casename,hc05, nvl(cu04,nvl(cu05,cu06)) custname,cu13, s2.st04 as cu13st04,s2.st15 as cu13st15 from ( " & _
               "select cp01,cp02,cp03,cp04,cp05,cp09,cp10,cp13,cp15,cp53,cp54 " & _
               ",months_between(to_date('" & strDate & "','yyyymmdd'),to_date(cp53,'yyyymmdd')) mons " & _
               "from caseprogress where cp01='LA' and cp02<>'999999' and cp10='0' and cp159=0 and cp53 < '" & strDate & "' and cp54 > '" & strDate & "' " & _
               ") vtb,hirecase, customer,staff s1,staff s2 where mod(mons,3)=0 and cp01=hc01(+) and cp02=hc02(+) and cp03=hc03(+) and cp04=hc04(+) " & _
               "and substr(hc05,1,8)=cu01(+) and substr(hc05,9,1)=cu02(+) and cp13=s1.st01(+) and cu13=s2.st01(+) " & _
               "order by 1,2,3,4"
   intQ = 1
   Set rsQD = ClsLawReadRstMsg(intQ, strSql)
   If intQ = 1 Then
       rsQD.MoveFirst
       Do While Not rsQD.EOF
           strTo = ""
           strExc(0) = rsQD.Fields("cp01") & "-" & rsQD.Fields("cp02") & IIf(rsQD.Fields("cp03") & rsQD.Fields("cp04") <> "000", "-" & rsQD.Fields("cp03") & "-" & rsQD.Fields("cp04"), "")
           strContent = "本所案號：" & strExc(0) & vbCrLf & _
                             "案件名稱：" & rsQD.Fields("casename") & vbCrLf & _
                             "客戶名稱：" & rsQD.Fields("custname") & vbCrLf & _
                             "顧問期間：" & ChangeWStringToTDateString(rsQD.Fields("cp53")) & "~" & ChangeWStringToTDateString(rsQD.Fields("cp54")) & vbCrLf
           If "" & rsQD.Fields("CP01") = "ACS" Then
               strExc(1) = ACS112STATISTICS("1", rsQD.Fields("cp01"), rsQD.Fields("cp02"), rsQD.Fields("cp03"), rsQD.Fields("cp04"), , strExc(2), strExc(3), strExc(4), strExc(5), strExc(6))
               strContent = strContent & "簽約時數：" & rsQD.Fields("cp15") & vbCrLf & _
                                                     "已服務次數：" & Val(strExc(6)) & vbCrLf & _
                                                     "已服務時數：" & Val(strExc(5)) & vbCrLf
           Else
               'Added by Lydia 2024/04/15 改用模組
               If Val("" & rsQD.Fields("cp15")) > 0 Then
                  If Pub_GetLAforTimes(rsQD.Fields("cp01"), rsQD.Fields("cp02"), rsQD.Fields("cp03"), rsQD.Fields("cp04"), strExc(3), strExc(4), strExc(5), strExc(6), strExc(7)) = True Then
                     strContent = strContent & "簽約時數：" & rsQD.Fields("cp15") & vbCrLf & _
                                               "已服務次數：" & Val(strExc(7)) & vbCrLf & _
                                               "已服務時數：" & Val(strExc(6)) & vbCrLf
                  End If
               Else
               'end 2024/04/15
                  strExc(1) = "select count(*) cnt from caseprogress where cp01='" & rsQD.Fields("cp01") & "' and cp02='" & rsQD.Fields("cp02") & "' and cp03='" & rsQD.Fields("cp03") & "' and cp04='" & rsQD.Fields("cp04") & "' and cp10<>'0' and cp159=0 and cp09<'C' and cp05>=" & rsQD.Fields("cp53") & " and cp05<=" & strDate
                  intI = 1
                  Set RsTemp = ClsLawReadRstMsg(intI, strExc(1))
                  If intI = 1 Then
                     strContent = strContent & "已服務次數：" & RsTemp.Fields("cnt")
                  End If
               End If 'Added by Lydia 2024/04/15
           End If
           If "" & rsQD.Fields("cp13st04") <> "1" Then
               'Modified by Lydia 2023/02/14 收文智權人員或案源介紹人離職，改通知客戶檔現在的智權人員。
               'strTo = PUB_GetAKindSalesNo(rsQD.Fields("cp01"), rsQD.Fields("cp02"), rsQD.Fields("cp03"), rsQD.Fields("cp04"))
               If "" & rsQD.Fields("cu13st04") <> "1" Then
                   strTo = GetDeptA09("" & rsQD.Fields("cu13st15"), "08")
               Else
                   strTo = "" & rsQD.Fields("cu13")
               End If
               'end 2023/02/14
           Else
               strTo = "" & rsQD.Fields("cp13")
           End If
           'Added by Lydia 2023/02/13 增加案源介紹人員
           If "" & rsQD.Fields("CP01") = "LA" Then
              strExc(1) = "select los04 from caseprogress,lawofficesource where cp09='" & rsQD.Fields("cp09") & "' and cp162=los15(+) and los04 is not null "
              intI = 1
              Set RsTemp = ClsLawReadRstMsg(intI, strExc(1))
              If intI = 1 Then
                 'Modified by Lydia 2023/02/14 改用模組判斷介紹人是否在職
                 'strTo = strTo & ";" & Replace(RsTemp.Fields("los04"), ",", ";")
                 strExc(1) = PUB_GetNowStaff("" & RsTemp.Fields("los04"), strExc(2))
                 If strExc(2) <> "" & RsTemp.Fields("los04") Then
                     If "" & rsQD.Fields("cu13st04") = "1" Then
                         strExc(2) = "" & rsQD.Fields("cu13")
                     End If
                 End If
                 strTo = strTo & ";" & strExc(2)
                 'end 2023/02/14
              End If
           End If
           'end 2023/02/13
           If strTo <> "" Then
               SendMAPIMail strTo, strExc(0) & " 顧問服務狀況通知!", strContent
           End If
           rsQD.MoveNext
       Loop

   End If
   Set rsQD = Nothing
   
   Exit Sub
   
ErrHnd:
   If Err.Number <> 0 Then
      WLog Err.Description
   End If
   
End Sub

'Add by Amy 2023/02/09
'每月第3個工作天執行-當月未發文原因檔仍在管制中的資料,發mail通知
Private Sub StrMenu68()
    Dim RsQ As New ADODB.Recordset
    Dim strQ As String, strQ2 As String
    Dim strFileN As String, strApatch As String
    Dim oldCP13 As String, oldA0908 As String, strTo As String
    Dim strSubject1 As String, strSubject2 As String, strContent1 As String, strContent2 As String
    Dim Txt_Head1 As Boolean, Txt_Head2 As Boolean
    Dim F1 As Integer, F2 As Integer, F3 As Integer
    Dim strTemp(3) As String, strDate(1) As String 'Modify by Amy 2023/02/09 原:strTemp(11)
    Dim ii As Integer
    'Add by Amy 2023/02/09
    Dim strPS As String, strAllF As String, strAllW As String, strF1F As String, strF1W As String, strF2F As String, strF2W As String, strF3F As String, strF3W As String, strQ3 As String
    Dim strF1, strF2, strF3, intW1, intW2, intW3
    
On Error GoTo ErrHand
    Txt_Head2 = False
    strFileN = Val(Left(strSrvDate(1), 6)) - 191100 & "商標收文逾三個月未發文通知"
    strApatch = App.path & TextPath
    'Add by Amy 2023/02/09
    strPS = "敬閱者：" & vbCrLf & vbCrLf & String(2, "　") & "商標收文逾三個月未發文通知如附件" & _
         vbCrLf & vbCrLf & vbCrLf & String(2, "　") & "列印注意事項：" & vbCrLf & _
         vbCrLf & String(4, "　") & "1.利用筆記本開啟附件" & _
         vbCrLf & String(4, "　") & "2.將視窗展開到最大" & _
         vbCrLf & String(4, "　") & "3.取消<自動換行>設定" & _
         vbCrLf & String(4, "　") & "4.<字型>設定為<細明體 標準 10>" & _
         vbCrLf & String(4, "　") & "5.左右邊界分別設<10mm 0mm>" & _
         vbCrLf & String(4, "　") & "6.選擇<橫印>"
    
    'mail智權人員
    'Moidfy by Amy 2020/02/05 更變 menu位置
    'Modify by Amy 2023/01/03 原:strSubjectX-收文逾三個月未發文通知.../strContentX-未發文案件原因註記
    strSubject1 = "商標收文逾三個月未發文通知，請至系統填寫未發文原因。"
    strContent1 = "請至 智權部作業->專利商標作業->商標未發文原因註記 項目中填寫未發文原因！"
  
    'mail林總及何主秘
    strSubject2 = "商標收文逾三個月未發文之總通知！"
    strContent2 = "可至 智權部作業->專利商標作業->商標未發文原因註記 項目中查看個別資料！"
    'end 2020/02/05
    
    'Add by Amy 2023/02/09 設定欄位,+本所期限、法定期限、未收金額
    strAllF = "承辦人,申請人,本所案號,收文日,申請國家,案件名稱,案件性質,本所期限,法定期限,未收金額" & _
                   ",本月專業部原因,上個月智權部原因"
    strAllW = "8,10,16,10,10,16,10,10,10,8" & _
                    ",16,16"
    strF1 = Split(strAllF, ",")
    intW1 = Split(strAllW, ",")
    For ii = LBound(strF1) To UBound(strF1)
        strF1F = strF1F & " " & PUB_StrToStr("" & strF1(ii), Val(intW1(ii)), True, False)
        strF1W = strF1W & " " & String(intW1(ii), "=")
    Next ii
    
    strAllF = "業務區,智權人員,承辦人,申請人,本所案號,收文日,申請國家,案件名稱,案件性質,本所期限" & _
                  ",法定期限,未收金額,本月專業部原因,上個月智權部原因"
    strAllW = "12,8,8,10,16,10,10,16,10,10" & _
                    ",10,8,16,16"
    strF2 = Split(strAllF, ",")
    intW2 = Split(strAllW, ",")
    For ii = LBound(strF2) To UBound(strF2)
        strF2F = strF2F & " " & PUB_StrToStr("" & strF2(ii), Val(intW2(ii)), True, False)
        strF2W = strF2W & " " & String(intW2(ii), "=")
    Next ii
    
    strAllF = "業務區,智權人員,承辦人,申請人,本所案號,收文日,申請國家,案件名稱,案件性質,本所期限" & _
                   ",法定期限,未收金額,本月專業部原因,上個月智權部原因"
    strAllW = "12,8,8,10,16,10,10,16,10,10" & _
                    ",10,8,16,16"
    strF3 = Split(strAllF, ",")
    intW3 = Split(strAllW, ",")
    For ii = LBound(strF3) To UBound(strF3)
        strF3F = strF3F & " " & PUB_StrToStr("" & strF3(ii), Val(intW3(ii)), True, False)
        strF3W = strF3W & " " & String(intW3(ii), "=")
    Next ii
    'end 2023/02/09
    
    strDate(0) = Left(strSrvDate(1), 6) & "01"
    strDate(1) = ChangeWDateStringToWString(DateAdd("m", -1, ChangeWStringToWDateString(DBDATE(strDate(0))))) 'for 抓前個月資料
    
    'Modify by Amy 2022/06/07 CP12<>S.ST15的資料,在A0902後面加'(*)',原:And cp12=a0901(+) ->And S.st15=a0901(+)
    'Modify by Amy 2023/02/09 +cp06,cp07,cp79(本所期限、法定期限、未收金額)
    strQ2 = "Select Decode(Cp12,s.st15,A0902,A0902||'(*)') as a0902,S.st02 as CP13N,P.st02 as CP14N, nvl(cu04,nvl(cu05,cu06)) as Apply,CP01||'-'||CP02||'-'||CP03||'-'||CP04 as CaseNo,SQLDATET2(cp05) as CP05,na03 as Country," & _
                "CaseName,Nvl(Decode(tm10,'000',CPM03,CPM04),cp10) as CasePropertyName,nc03,Pre.nc07,cp13,SQLDATET2(cp06) as CP06,SQLDATET2(cp07) as CP07,cp79,a0908 From " & _
                "(Select nc03,cp01,cp02,cp03,cp04,cp05,cp09,cp10,cp12,cp13,cp14, Decode(tm05,null,Decode(sp05,null,Decode( sp06, null,sp07,sp06),sp05),tm05) as CaseName ,nvl(tm10,sp09) as tm10,nvl(tm23,sp08) as tm23,cp06,cp07,cp79 " & _
                "From NotComplete,CaseProgress,TradeMark ,ServicePractice Where nc02=" & Val(Left(strDate(0), 6)) & " And (nc11<>'N' Or nc11 is null ) And nc01=cp09(+) " & _
                "And cp01=tm01(+) And cp02=tm02(+) And cp03=tm03(+) And cp04=tm04(+) And cp01=sp01(+) And cp02=sp02(+) And cp03=sp03(+) And cp04=sp04(+) ) N," & _
                "Staff P,Staff S,Acc090 ,Customer,Nation, CasePropertyMap,(Select NC07,NC01 From NotComplete Where nc02=" & Val(Left(strDate(1), 6)) & ") Pre " & _
                "Where cp09=Pre.nc01(+) And cp14=P.st01(+) And cp13=S.st01(+) And S.st15=a0901(+) And SubStr(tm23,1,8)=cu01(+) And SubStr(tm23,9,1)=cu02(+) And tm10=na01(+) And cp01=CPM01(+) And cp10=CPM02(+) And cp09 is not null "
    
    'Modify by Amy 2022/06/07 張力允有調區前後的不同區資料
    'strQ = strQ2 & "Order by cp12,cp13,tm23,cp01,cp02,cp03,cp04,cp05,cp09"
    strQ = strQ2 & "Order by S.st15,cp13,tm23,cp01,cp02,cp03,cp04,cp05,cp09"
              
    RsQ.CursorLocation = adUseClient
    RsQ.Open strQ, cnnConnection, adOpenStatic, adLockReadOnly
    With RsQ
            .MoveFirst
            Do While Not .EOF
                If oldCP13 <> "" & .Fields("cp13") Then
                    If oldCP13 <> MsgText(601) Then
                        If F1 > 0 Then Close #F1
                        'Modify by Amy 2016/01/06 檔名 +智權人員編
                        SendMAPIMail oldCP13, strSubject1, vbCrLf & vbCrLf & strContent1 & vbCrLf & vbCrLf, strApatch & strFileN & oldCP13 & ".txt"
                    End If
                    Txt_Head1 = False
                End If
                If Txt_Head1 = False Then
                    F1 = FreeFile
                    Open strApatch & strFileN & "" & .Fields("cp13") & ".txt" For Output As F1
                    Print #F1, "                                                                 商標收文逾三個月未發文案件清單"
                    'Add by Amy 2016/01/06 +智權人員
                    Print #F1, "智權人員：" & GetStaffName("" & .Fields("cp13"), True)
                    Print #F1, "列印日期：" & ChangeWStringToTString(strSrvDate(1))
                    'Modify by Amy 2023/02/09 欄名+本所期限、法定期限、未收金額,並改用變數
                    Print #F1, Mid(strF1F, 2)
                    Print #F1, Mid(strF1W, 2)
                    'end 2023/02/09
                    Txt_Head1 = True
                End If
              
                If Txt_Head2 = False Then
                    F2 = FreeFile
                    Open strApatch & strFileN & "總清單.txt" For Output As F2
                    Print #F2, "                                                                   商標收文逾三個月未發文案件清單"
                    Print #F2, "列印日期：" & ChangeWStringToTString(strSrvDate(1))
                    'Modify by Amy 2023/02/09 欄名+本所期限、法定期限、未收金額,並改用變數
                    Print #F2, Mid(strF2F, 2)
                    Print #F2, Mid(strF2W, 2)
                    'end 2023/02/09
                    Txt_Head2 = True
                End If
                
                'Modify by Amy 2023/02/09 原:For ii = 0 To 10,+本所期限、法定期限、未收金額,改用欄位變數抓
                '智權人員-檔案
                For ii = LBound(strF1) To UBound(strF1)
                    strTemp(0) = ""
                    Select Case strF1(ii)
                        Case "智權人員"
                            strTemp(0) = convForm(CheckStr("" & .Fields("cp13N")), intW1(ii))
                        Case "承辦人"
                            strTemp(0) = convForm(CheckStr("" & .Fields("cp14N")), intW1(ii))
                        Case "申請人"
                            strTemp(0) = convForm(CheckStr("" & .Fields("Apply")), intW1(ii))
                        Case "本所案號"
                            strTemp(0) = convForm(CheckStr("" & .Fields("CaseNo")), intW1(ii))
                        Case "收文日"
                            strTemp(0) = convForm(CheckStr("" & .Fields("cp05")), intW1(ii))
                        Case "申請國家"
                            strTemp(0) = convForm(CheckStr("" & .Fields("Country")), intW1(ii))
                        Case "案件名稱"
                            strTemp(0) = convForm(CheckStr("" & .Fields("CaseName")), intW1(ii))
                        Case "案件性質"
                            strTemp(0) = convForm(CheckStr("" & .Fields("CasePropertyName")), intW1(ii))
                        Case "本所期限"
                            strTemp(0) = convForm(CheckStr("" & .Fields("CP06")), intW1(ii))
                        Case "法定期限"
                            strTemp(0) = convForm(CheckStr("" & .Fields("CP07")), intW1(ii))
                        Case "未收金額"
                            strTemp(0) = Val("" & .Fields("cp79"))
                            If strTemp(0) = "0" Then
                                strTemp(0) = PUB_StrToStr(strTemp(0), Val(intW1(ii)), True, True)
                            Else
                                strTemp(0) = PUB_StrToStr(Format(strTemp(0), "#,###"), Val(intW1(ii)), True, True)
                            End If
                        Case "本月專業部原因"
                            strTemp(0) = convForm(CheckStr("" & .Fields("nc03")), intW1(ii))
                        Case "上個月智權部原因"
                            strTemp(0) = convForm(CheckStr("" & .Fields("nc07")), intW1(ii))
                    End Select
                    strTemp(1) = strTemp(1) & " " & strTemp(0)
                Next ii
                Print #F1, Mid(strTemp(1), 2)
                strTemp(1) = ""
                
                '總清單
                For ii = LBound(strF2) To UBound(strF2)
                    strTemp(0) = ""
                    Select Case strF2(ii)
                        Case "業務區"
                            strTemp(0) = convForm(CheckStr("" & .Fields("a0902")), intW2(ii))
                        Case "智權人員"
                            strTemp(0) = convForm(CheckStr("" & .Fields("cp13N")), intW2(ii))
                        Case "承辦人"
                            strTemp(0) = convForm(CheckStr("" & .Fields("cp14N")), intW2(ii))
                        Case "申請人"
                            strTemp(0) = convForm(CheckStr("" & .Fields("Apply")), intW2(ii))
                        Case "本所案號"
                            strTemp(0) = convForm(CheckStr("" & .Fields("CaseNo")), intW2(ii))
                        Case "收文日"
                            strTemp(0) = convForm(CheckStr("" & .Fields("cp05")), intW2(ii))
                        Case "申請國家"
                            strTemp(0) = convForm(CheckStr("" & .Fields("Country")), intW2(ii))
                        Case "案件名稱"
                            strTemp(0) = convForm(CheckStr("" & .Fields("CaseName")), intW2(ii))
                        Case "案件性質"
                            strTemp(0) = convForm(CheckStr("" & .Fields("CasePropertyName")), intW2(ii))
                        Case "本所期限"
                            strTemp(0) = convForm(CheckStr("" & .Fields("CP06")), intW2(ii))
                        Case "法定期限"
                            strTemp(0) = convForm(CheckStr("" & .Fields("CP07")), intW2(ii))
                        Case "未收金額"
                            strTemp(0) = Val("" & .Fields("cp79"))
                            If strTemp(0) = "0" Then
                                strTemp(0) = PUB_StrToStr(strTemp(0), Val(intW2(ii)), True, True)
                            Else
                                strTemp(0) = PUB_StrToStr(Format(strTemp(0), "#,###"), Val(intW2(ii)), True, True)
                            End If
                        Case "本月專業部原因"
                            strTemp(0) = convForm(CheckStr("" & .Fields("nc03")), intW2(ii))
                        Case "上個月智權部原因"
                            strTemp(0) = convForm(CheckStr("" & .Fields("nc07")), intW2(ii))
                    End Select
                    strTemp(2) = strTemp(2) & " " & strTemp(0)
                Next ii
                Print #F2, Mid(strTemp(2), 2)
                strTemp(2) = ""
                'end 2023/02/09
                         
                oldCP13 = "" & .Fields("cp13")
                .MoveNext
            Loop
            If F1 > 0 Then
                Close F1
                'Modify by Amy 2019/02/12 檔名+員編
                SendMAPIMail oldCP13, strSubject1, vbCrLf & vbCrLf & strContent1 & vbCrLf & vbCrLf, strApatch & strFileN & oldCP13 & ".txt"
            End If
            If F2 > 0 Then
                Print #F2, ""
                Print #F2, "PS：業務區若有(*)代表調區前之收文" 'Add by Amy 2022/06/07
                Close #F2
                'Modified by Morgan 2019/9/19
                'strTo = "94007;68009"
                'modify by sonia 2020/1/9 +69005
                'modify by sonia 2020/3/4 -68006退休且已加入69005
                'modify by sonia 2022/1/19 簡協理要求加發82026林柄佑
                'Modified by Lydia 2022/05/03 簡協理69005改為抓系統特殊設定「全所智權部主管」、林協理82026改為抓系統特殊設定「中所智權部主管」
                'strTo = "94007;69005;82026"
                strTo = "94007;" & Pub_GetSpecMan("全所智權部主管") & ";" & Pub_GetSpecMan("中所智權部主管")
                strTo = Replace(strTo, ";;", ";")
                'end 2022/05/03
                'Modif by Amy 2023/02/09 +strPS
                SendMAPIMail strTo, strSubject2, strPS & vbCrLf & vbCrLf & String(2, "　") & strContent2 & vbCrLf & vbCrLf, strApatch & strFileN & "總清單.txt"
            End If
            RsQ.Close
            If F1 > 0 Then Close #F1
            If F2 > 0 Then Close #F2
    End With

    Txt_Head1 = False
    'mail主管
    strSubject1 = "商標收文逾三個月未發文之主管通知！"
    strContent1 = "可至 智權部作業->日常工作->商標未發文原因註記 項目中查看個別資料！"
    
    strQ = strQ2 & "Order by a0908,cp13,tm23,cp01,cp02,cp03,cp04,cp05,cp09" '若以st15排序導致同一個人收到不止一封mail,故以a0908排
    RsQ.CursorLocation = adUseClient
    RsQ.Open strQ, cnnConnection, adOpenStatic, adLockReadOnly
    With RsQ
        .MoveFirst
        Do While Not .EOF
            If oldA0908 <> .Fields("a0908") Then
                If oldA0908 <> MsgText(601) Then
                    'Modify by Amy 2022/06/07 +PS
                    If F3 > 0 Then
                        Print #F3, ""
                        Print #F3, "PS：業務區若有(*)代表調區前之收文"
                        Close #F3
                    End If
                    'Modif by Amy 2023/02/09 +strPS
                    SendMAPIMail oldA0908, strSubject1, strPS & vbCrLf & vbCrLf & String(2, "　") & strContent1 & vbCrLf & vbCrLf, strApatch & strFileN & "清單.txt"
                End If
                Txt_Head1 = False
            End If
            If Txt_Head1 = False Then
                F3 = FreeFile
                Open strApatch & strFileN & "清單.txt" For Output As F3
                Print #F3, "                                                                   商標收文逾三個月未發文案件清單"
                Print #F3, "列印日期：" & ChangeWStringToTString(strSrvDate(1))
                'Modify by Amy 2023/02/09 欄名+本所期限、法定期限、未收金額,並改用變數
                Print #F3, Mid(strF3F, 2)
                Print #F3, Mid(strF3W, 2)
                'end 2023/02/09
                Txt_Head1 = True
            End If
            'Modify by Amy 2023/02/09 原:For ii = 0 To 10,+本所期限、法定期限、未收金額,改照sql語法欄位抓資料
            strAllF = ""
            For ii = LBound(strF3) To UBound(strF3)
                strTemp(0) = ""
                Select Case strF3(ii)
                    Case "業務區"
                        strTemp(0) = convForm(CheckStr("" & .Fields("a0902")), intW3(ii))
                    Case "智權人員"
                        strTemp(0) = convForm(CheckStr("" & .Fields("cp13N")), intW3(ii))
                    Case "承辦人"
                        strTemp(0) = convForm(CheckStr("" & .Fields("cp14N")), intW3(ii))
                    Case "申請人"
                        strTemp(0) = convForm(CheckStr("" & .Fields("Apply")), intW3(ii))
                    Case "本所案號"
                        strTemp(0) = convForm(CheckStr("" & .Fields("CaseNo")), intW3(ii))
                    Case "收文日"
                        strTemp(0) = convForm(CheckStr("" & .Fields("cp05")), intW3(ii))
                    Case "申請國家"
                        strTemp(0) = convForm(CheckStr("" & .Fields("Country")), intW3(ii))
                    Case "案件名稱"
                        strTemp(0) = convForm(CheckStr("" & .Fields("CaseName")), intW3(ii))
                    Case "案件性質"
                        strTemp(0) = convForm(CheckStr("" & .Fields("CasePropertyName")), intW3(ii))
                    Case "本所期限"
                        strTemp(0) = convForm(CheckStr("" & .Fields("CP06")), intW3(ii))
                    Case "法定期限"
                        strTemp(0) = convForm(CheckStr("" & .Fields("CP07")), intW3(ii))
                    Case "未收金額"
                        strTemp(0) = Val("" & .Fields("cp79"))
                        If strTemp(0) = "0" Then
                            strTemp(0) = PUB_StrToStr(strTemp(0), Val(intW3(ii)), True, True)
                        Else
                            strTemp(0) = PUB_StrToStr(Format(strTemp(0), "#,###"), Val(intW3(ii)), True, True)
                        End If
                    Case "本月專業部原因"
                        strTemp(0) = convForm(CheckStr("" & .Fields("nc03")), intW3(ii))
                    Case "上個月智權部原因"
                        strTemp(0) = convForm(CheckStr("" & .Fields("nc07")), intW3(ii))
                End Select
                strTemp(3) = strTemp(3) & " " & strTemp(0)
            Next ii
            Print #F3, Mid(strTemp(3), 2)
            strTemp(3) = ""
            'end 2023/02/09
            
            oldA0908 = .Fields("a0908")
            .MoveNext
        Loop
        If F3 > 0 Then
            Print #F3, ""
            Print #F3, "PS：業務區若有(*)代表調區前之收文" 'Add by Amy 2022/06/07
            Close #F3
            'Modif by Amy 2023/02/09 +strPS
            SendMAPIMail oldA0908, strSubject1, strPS & vbCrLf & vbCrLf & String(2, "　") & strContent1 & vbCrLf & vbCrLf, strApatch & strFileN & "清單.txt"
        End If
        RsQ.Close
        If F3 > 0 Then Close #F3
    End With
    
    Exit Sub
    
ErrHand:
    If Err.Number <> 0 Then
        WLog "收文逾三個月未發文商標案件-智權部通知:" & Err.Description
    End If
    Set RsQ = Nothing
End Sub

'Added by Lydia 2023/03/22 ACS系統-TIPS案件管制期限到期通知--2023/04/14 開始
Private Sub StrMenu119()
Dim stCon1 As String
Dim stSQL As String, intQ As Integer
Dim rsQuery As ADODB.Recordset
Dim xlsAgentPoint As New Excel.Application
Dim wksrpt As New Worksheet
Dim strSubject1 As String, xlsFileName1 As String
Dim stTmp, intWidth
Dim intCounter As Integer, ii As Integer
Dim strGrp As String 'Added by Lydia 2023/10/03
Dim iCall As Integer, strGrpMan As String, strDate1 As String, StrDate2 As String 'Added by Lydia 2024/05/14

On Error GoTo ErrHnd
   
   'Modified by Lydia 2023/12/07
   'strSubject1 = "TIPS案件管制期限到期通知"
   'Modified by Lydai 2025/05/15 「ACS案件管制期限到期通知」更名「ACS案件本所期限通知」
   strSubject1 = "ACS案件本所期限通知"
   Call PUB_KillTempFile(TextPath & "*" & strSubject1 & "*.*")
   strSubject1 = strSrvDate(2) & "_" & strSubject1
   xlsFileName1 = strSubject1 & ".xls"
   
   strDate1 = CompDate(2, 21, strSrvDate(1))   '本所期限前21日通知
   'StrDate2 = CompDate(2, 90, strSrvDate(1))   '本所期限前90日通知 'Mark by Lydia 2025/05/15
   'If Weekday(ChangeWStringToWDateString(strSrvDate(1))) = 2 Then 'Mark by Lydia 2023/07/28
      '只要超過21日或90日則每週一通知一次
   'Modified by Lydia 2023/12/07 清單不限TIPS案之內部收文，新案性質也請一併加入期限通知。(不分是否為TIPS案，只要有所限就加入期限通知)
      'stCon1 = "and ((cp10 in ('208','2091','2092','211','213','215','216','218') and cp06<=" & strdate1 & ") " & _
                    "or (cp10 in ('222') and cp06<=" & strdate2 & "))"
    'Modified by Lydia 2025/05/15 請將(222)智財管理計畫書也調整為「所限前21天通知」，即全部案件性質統一期限管控
    '  stCon1 = "and ((cp09 < 'C' and nvl(cp06,99999999)<=" & strDate1 & ") " & _
                    "or (cp10 in ('222') and cp06<=" & StrDate2 & "))"
      stCon1 = "and cp09 < 'C' and nvl(cp06,99999999)<=" & strDate1
   'Mark by Lydia 2023/07/28 教威:將超過本所期限和本所期限前的前21日或90日通知的系統管制期限通知，全部彙整於每周一通知(即附件3種通知信都彙整於每周一的1封通知信)
   'Else
    '  '本所期限前21日/90日通知
    '  stCon1 = "and ((cp10 in ('208','2091','2092','211','213','215','216','218') and cp06=" & strdate1 & ") " & _
    '                "or (cp10 in ('222') and cp06=" & strdate2 & "))"
   'End If
   'end 2023/07/28
   'Modified by Lydia 2023/10/03 「超過本所期限通知」和「本所期限前的前21日或90日通知」分開不同工作表; +ORD1
   'Modified by Lydia 2023/12/07 +CP07,CP64
   
For iCall = 1 To 2 'Added by Lydia 2024/05/14 1=>依承辦人通知, 2=>總表通知主管
   stSQL = "select decode(sign(cp06-" & strDate1 & "),1,2,1) ord1,cp01,cp02,cp03,cp04,sqldatet(cp05) cp05,sqldatet(cp06) cp06,sqldatet(cp07) cp07,cp09,cp10,cpm03,nvl(lc05,nvl(lc06,lc07)) casename,lc11 cno1,nvl(cu04,nvl(cu05,cu06)) cname1," & _
                "cp13||s1.st02 as cp13n,cp14||s2.st02 as cp14n,cp64,cp14 from caseprogress,lawcase,customer,casepropertymap,staff s1,staff s2 " & _
                "where cp01='ACS' and cp158=0 and cp159=0 " & stCon1 & " and cp01=lc01(+) and cp02=lc02(+) and cp03=lc03(+) and cp04=lc04(+) " & _
                "and substr(lc11,1,8)=cu01(+) and substr(lc11,9,1)=cu02(+) and cp01=cpm01(+) and cp10=cpm02(+) and cp13=s1.st01(+) and cp14=s2.st01(+) "
   'Added by Lydia 2024/05/14
   strGrp = "": strGrpMan = ""
   If iCall = 1 Then
      stSQL = stSQL & "order by cp14,ord1,cp01,cp02,cp03,cp04,cp06"
   Else
   'end 2024/05/14
      stSQL = stSQL & "order by ord1,cp01,cp02,cp03,cp04,cp06"
   End If 'Added by Lydia 2024/05/14
   
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      With rsQuery
         .MoveFirst
         Do While Not .EOF
            'Added by Lydia 2024/05/14
            If (iCall = 1 And strGrpMan <> "" & .Fields("cp14")) Or (iCall = 2 And .AbsolutePosition = 1) Then
               If iCall = 1 And strGrpMan <> "" Then
                  Set wksrpt = xlsAgentPoint.Worksheets(1) '固定在第一頁
                  wksrpt.Range("A1").Select
                  If Val(xlsAgentPoint.Version) < 12 Then
                     xlsAgentPoint.Workbooks(1).SaveAs FileName:=App.path & TextPath & Replace(xlsFileName1, ".xls", "_" & strGrpMan & ".xls"), FileFormat:=-4143
                  Else
                     xlsAgentPoint.Workbooks(1).SaveAs FileName:=App.path & TextPath & Replace(xlsFileName1, ".xls", "_" & strGrpMan & ".xls"), FileFormat:=56
                  End If
                  xlsAgentPoint.Workbooks.Close
                  xlsAgentPoint.Quit
                  SendMAPIMail strGrpMan, strSubject1 & "(詳附件)", vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, App.path & TextPath & Replace(xlsFileName1, ".xls", "_" & strGrpMan & ".xls")
                  strGrp = ""
               End If
               'Move by Lydia 2024/05/14 從Do Loop上方搬下來
               intCounter = 1
               'Modified by Lydia 2023/12/07 +法定期限,進度備註
               stTmp = Array("智權人員", "承辦人員", "本所案號", "案件名稱", "收文號", "案件性質", "收文日", "本所期限", "法定期限", "申請人名稱", "進度備註")
               intWidth = Array(16, 16, 16, 25, 10, 15, 10, 10, 10, 50, 50)
               xlsAgentPoint.SheetsInNewWorkbook = 1 '預設工作表數目 'Modified by Lydia 2023/10/03  預設工作表1=>預設工作表2 'Modified by Lydia 2025/05/15  預設工作表2=>預設工作表1
               xlsAgentPoint.Workbooks.add
               xlsAgentPoint.Application.WindowState = xlMinimized
               Set wksrpt = xlsAgentPoint.Worksheets(1)
               xlsAgentPoint.Sheets(1).Select
               '設定欄位名稱及欄寬
               For ii = LBound(stTmp) To UBound(stTmp)
                   wksrpt.Range(Chr(ii + 65) & intCounter).Value = stTmp(ii)
                   wksrpt.Columns(Chr(ii + 65) & ":" & Chr(ii + 65)).ColumnWidth = intWidth(ii)
                   wksrpt.Range(Chr(ii + 65) & intCounter).HorizontalAlignment = xlCenter
               Next ii
               intCounter = intCounter + 1
               'end -- Move by Lydia 2024/05/14
            End If
            'end 2024/05/14
            'Added by Lydia 2023/10/03 「超過本所期限通知」和「本所期限前的前21日或90日通知」分開不同工作表
            'Modified by Lydia 2025/05/15 全部案件性質統一期限管控
            'If strGrp <> "" & .Fields("ord1") Then
            '   If strGrp <> "" Then
            '      Set wksrpt = xlsAgentPoint.Worksheets(2)
            '      intCounter = 1
             '     '設定欄位名稱及欄寬
            '      For ii = LBound(stTmp) To UBound(stTmp)
            '          wksrpt.Range(Chr(ii + 65) & intCounter).Value = stTmp(ii)
            '          wksrpt.Columns(Chr(ii + 65) & ":" & Chr(ii + 65)).ColumnWidth = intWidth(ii)
            '          wksrpt.Range(Chr(ii + 65) & intCounter).HorizontalAlignment = xlCenter
            '      Next ii
            '      intCounter = intCounter + 1
            '   End If
            '   'Modified by Lydia 2025/05/15即全部案件性質統一期限管控
            '   wksrpt.Name = IIf("" & .Fields("ord1") = "1", "超過本所期限通知", "本所期限前21或90日通知")
            '   strGrp = "" & .Fields("ord1")
            'End If
            'end 2023/10/03
            wksrpt.Name = "本所期限通知"
            'end 2025/05/15
            wksrpt.Range("A" & intCounter).Value = "" & .Fields("cp13n")  '智權人員
            wksrpt.Range("B" & intCounter).Value = "" & .Fields("cp14n")  '承辦人員
            wksrpt.Range("C" & intCounter).Value = "" & .Fields("cp01") & "-" & .Fields("cp02") & IIf("" & .Fields("cp03") & .Fields("cp04") = "000", "", "-" & .Fields("cp03") & "-" & .Fields("cp04")) '本所案號
            wksrpt.Range("D" & intCounter).Value = "" & .Fields("casename")  '案件名稱
            wksrpt.Range("E" & intCounter).Value = "" & .Fields("cp09")  '收文號
            wksrpt.Range("F" & intCounter).Value = "" & .Fields("cp10") & .Fields("cpm03")   '案件性質
            wksrpt.Range("G" & intCounter).Value = "" & .Fields("cp05")  '收文日
            wksrpt.Range("H" & intCounter).Value = "" & .Fields("cp06")  '本所期限
            'Added by Lydia 2025/05/15 超過本所期限用紅色字體
            If DBDATE("" & .Fields("cp06")) < strSrvDate(1) Then
                wksrpt.Range("H" & intCounter).Font.Color = vbRed
            End If
            'end 2025/05/15
            wksrpt.Range("I" & intCounter).Value = "" & .Fields("cp07") 'Added by Lydia 2023/12/07 法定期限
            wksrpt.Range("J" & intCounter).Value = "" & .Fields("cno1") & .Fields("cname1")  '申請人名稱 'Modified by Lydia 2023/12/07 I欄改J欄
            wksrpt.Range("K" & intCounter).Value = "" & .Fields("cp64") 'Added by Lydia 2023/12/07 進度備註
            strGrpMan = "" & .Fields("cp14") 'Added by Lydia 2024/05/14
            .MoveNext
            intCounter = intCounter + 1
         Loop
         
         'Added by Lydia 2023/10/03 固定在第一頁
         Set wksrpt = xlsAgentPoint.Worksheets(1)
         wksrpt.Range("A1").Select
         'end 2023/10/03
         If Val(xlsAgentPoint.Version) < 12 Then
            'Modified by Lydia 2024/05/14
            'xlsAgentPoint.Workbooks(1).SaveAs FileName:=App.path & TextPath & xlsFileName1, FileFormat:=-4143
            xlsAgentPoint.Workbooks(1).SaveAs FileName:=App.path & TextPath & IIf(iCall = 1, Replace(xlsFileName1, ".xls", "_" & strGrpMan & ".xls"), xlsFileName1), FileFormat:=-4143
         Else
            'Modified by Lydia 2024/05/14
            'xlsAgentPoint.Workbooks(1).SaveAs FileName:=App.path & TextPath & xlsFileName1, FileFormat:=56
            xlsAgentPoint.Workbooks(1).SaveAs FileName:=App.path & TextPath & IIf(iCall = 1, Replace(xlsFileName1, ".xls", "_" & strGrpMan & ".xls"), xlsFileName1), FileFormat:=56
         End If
         xlsAgentPoint.Workbooks.Close
         xlsAgentPoint.Quit
      End With
      'Added by Lydia 2024/05/14
      If iCall = 2 Then
         strGrpMan = Pub_GetSpecMan("ACS郵件通知主管")
         If strGrpMan = "" Then
            strGrpMan = Pub_GetSpecMan("程式管理人員")
         End If
      End If
      'Modified by Lydia 2024/05/14
      'SendMAPIMail "ACS01", strSubject1 & "(詳附件)", vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, App.path & TextPath & xlsFileName1
      SendMAPIMail strGrpMan, strSubject1 & "(詳附件)", vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, App.path & TextPath & IIf(iCall = 1, Replace(xlsFileName1, ".xls", "_" & strGrpMan & ".xls"), xlsFileName1)
   End If
Next iCall 'Added by Lydia 2024/05/14 1=>依承辦人通知, 2=>總表通知主管

   Set rsQuery = Nothing
   Set wksrpt = Nothing
   Set xlsAgentPoint = Nothing
   Exit Sub

ErrHnd:
   If Err.Number <> 0 Then
      WLog Err.Description
   End If
End Sub

'Add By Sindy 2023/5/8 外商信件處理結果檢核表
Private Sub StrMenu120()
Dim RsQ As New ADODB.Recordset
Dim strTemp(1 To 6) As String
Dim TempFileName As String
Dim strDate1 As String, StrDate2 As String
Dim strTo As String
Dim jj As Integer

Dim strText As String

On Err GoTo ErrHandle
   
   TempFileName = "外商信件處理結果檢核表-" & strSrvDate(2)
   TempFileName = App.path & TextPath & TempFileName & ".txt"
   If Dir(TempFileName) <> "" Then Kill TempFileName
   
   strDate1 = CompWorkDay(2, strSrvDate(1), 1) '前1個工作天
   '系統日的前1天
   StrDate2 = Format(DateAdd("D", -1, DateSerial(Left(strSrvDate(1), 4), Mid(strSrvDate(1), 5, 2), Right(strSrvDate(1), 2))), "YYYYMMDD")
   
   '處理日期=前1日工作天 ~ 系統日的前1天(中間有放假日)
   '處理狀態=2.不處理 5.已處理
   strSql = "select substr(' '||sqldatet(ii08),-9),ii23||'-'||ii24||'-'||ii25||'-'||ii26," & _
            "ii17,s1.st02 ProcName,ii01||'-'||ii03 letterID,ii01,ii02,ii03,s1.st01 ProcID," & _
            "decode(ir16,'7',decode(ii29," & 外專信件處理結果 & ",ii29),decode(ir16," & 信件處理狀態 & ",ir16))||'-'||ir20 ir16,ir17,ir20 " & _
            "From inputrecord, IPDeptinput, staff s1, staff s2 " & _
            "where length(ir03)=5 and substr(ir03,1,1)='F' and (ir16 in('2','5') or (ir16='7' and ii29 in('8','12'))) " & _
            "and ir08>0 and ir01=ii01(+) and ir03=ii03(+) " & _
            "and ir04=s1.st01(+) and substr(s1.st03,1,2)='F1' and ir19=s2.st01(+) " & _
            "and ir17>=" & strDate1 & " and ir17<=" & StrDate2 & _
            " ORDER BY ir19 asc,ir16 asc,ii01||'-'||ii03 asc"
   intI = 1
   Set RsQ = ClsLawReadRstMsg(intI, strSql)
   If intI = 1 Then
      If RsQ.RecordCount > 0 Then
         With RsQ
            .MoveFirst
                      strText = "備註：改字型Fixedsys標準11號字以橫式上下左右各10MM列印" & vbCrLf
            strText = strText & "處理人員 處理日期   處理結果                   轉寄日期/時間        主旨" & vbCrLf
            strText = strText & "======== ========== ========================== ==================== ===================================================================================" & vbCrLf
            
            Do While Not .EOF
               For jj = 1 To 5
                  strTemp(jj) = ""
               Next jj
               strTemp(1) = Trim(.Fields("ProcName")) '處理人員
               strTemp(2) = ChangeWStringToTDateString(.Fields("ir17")) '處理日期
               strTemp(3) = Trim("" & .Fields("ir16")) '處理結果
               strTemp(4) = ChangeWStringToTDateString(.Fields("ii01")) & " " & Format(.Fields("ii02"), "00:00:00") '轉寄日期/時間
               strTemp(5) = "" & Trim(.Fields("ii17")) '主旨
               
               strTemp(1) = convForm(CheckStr(strTemp(1)), 8)
               strTemp(2) = convForm(CheckStr(strTemp(2)), 10)
               strTemp(3) = convForm(CheckStr(strTemp(3)), 26)
               strTemp(4) = convForm(CheckStr(strTemp(4)), 20)
               strTemp(5) = convForm(CheckStr(strTemp(5)), 100)
               
               strText = strText & strTemp(1) & " " & strTemp(2) & " " & strTemp(3) & " " & strTemp(4) & " " & "" & Trim(.Fields("ii17")) & vbCrLf
               .MoveNext
            Loop
         End With
      End If
      Call PUB_SaveTextAsUTF8(TempFileName, strText)
      If Dir(TempFileName) <> "" Then
         strTo = Pub_GetSpecMan("外商信件檢核表收受者")
         SendMAPIMail strTo, "外商信件處理結果檢核表，請檢視！", "Dear Sirs," & vbCrLf & "外商信件處理結果檢核表，資料如附件，請橫印！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", TempFileName
      End If
   End If
   Set RsQ = Nothing
   
   Exit Sub
   
ErrHandle:
   If Err.Number <> 0 Then
      WLog "外商信件處理結果檢核表:" & Err.Description
   End If
End Sub

'Add by Amy 2023/07/25 CF案件結餘結算作業,借貸不平案件系統通知檢查
Private Sub StrMenu121()
Dim rsQ1 As New ADODB.Recordset, rsQ2 As New ADODB.Recordset, intQ1 As Integer, intQ2 As Integer
Dim strQ1 As String, strQ2 As String, strWhere2 As String, strDate As String, strFieldName As String, strTo As String
Dim j As Integer, strText_Fix As String, strText As String, strTp(1 To 4) As String
   
On Err GoTo ErrHandle
   
   strFieldName = "CF案件結餘結借貸不平案件列表-" & strSrvDate(2)
   strFieldName = App.path & TextPath & strFieldName & ".txt"
   If Dir(strFieldName) <> "" Then Kill strFieldName
   
   strText_Fix = "備註：改字型Fixedsys標準11號字以直式上下左右各10MM列印" & vbCrLf & vbCrLf
   strText_Fix = strText_Fix & "公司別 傳票號碼      本所案號           規費餘額        " & vbCrLf
   strText_Fix = strText_Fix & "====== ============= ================== ========= " & vbCrLf
   
   'Modify by Amy 原:CompWorkDay(2, strSrvDate(1), 1) - 19110000-->前1個工作天(民國),改為
   '                             前2個工作天結算的資料,因ACC1P0的結餘傳票是隔天才傳送到ACC021,所以午夜跑資料時會漏掉ACC1P0的結餘傳票的數字
   strDate = CompWorkDay(3, strSrvDate(1), 1) - 19110000 '前2個工作天(民國)
   
   strQ1 = "Select Distinct a1p01,a1p22,A240005,A240006,A240007,A240008 From Acc240,Acc1p0 " & _
                  "Where A240002=a1p04(+) And A240015=" & strDate & " Order by a1p01||a1p22,A240005,A240006,A240007 "
   intQ1 = 1
   Set rsQ1 = ClsLawReadRstMsg(intQ1, strQ1)
   If intQ1 = 1 Then
      If rsQ1.RecordCount > 0 Then
         rsQ1.MoveFirst
         Do While Not rsQ1.EOF
            For j = LBound(strTp) To UBound(strTp)
               strTp(j) = ""
            Next j
            strTp(3) = "" & rsQ1.Fields("A240005") & "-" & rsQ1.Fields("A240006") & "-" & rsQ1.Fields("A240007") & "-" & rsQ1.Fields("A240008") '本所案號
            '舊系統資料不會有a1p22資料,由財務自行從傳票輸入輸
            If Not IsNull(rsQ1.Fields("a1p22")) Then
               'acc1p0有資料才顯示
               strTp(1) = rsQ1.Fields("a1p01") '傳票公司別
               strTp(2) = rsQ1.Fields("a1p22") '傳票號碼
            End If
            
            If "" & rsQ1.Fields("A240005") = "TF" Then
               strWhere2 = "" & rsQ1.Fields("A240005") & Mid(rsQ1.Fields("A240006"), 1, 5)
            Else
               strWhere2 = "" & rsQ1.Fields("A240005") & rsQ1.Fields("A240006") & rsQ1.Fields("A240007")
            End If
            strWhere2 = " And Ax214 Like '" & strWhere2 & "%' "
               
            strQ2 = "Select ax201,Decode(SubStr(ax214,1,2),'TF',SubStr(Ax214,1,Length(Ax214)-4),SubStr(Ax214,1,Length(Ax214)-2)) as CaseNo,Sum(Ax207)-Sum(Ax206) as Amt " & _
                           "From Acc021 " & _
                           "Where Ax205 Like '2201%' " & strWhere2 & _
                           "Group By ax201,Decode(Substr(ax214,1,2),'TF',Substr(Ax214,1,Length(Ax214)-4),Substr(Ax214,1,Length(Ax214)-2)) " & _
                           "Having Sum(Ax206) <> Sum(Ax207) "
            intQ2 = 1
            Set rsQ2 = ClsLawReadRstMsg(intQ2, strQ2)
            If intQ2 = 1 Then
               rsQ2.MoveFirst
               Do While Not rsQ2.EOF
                  strTp(4) = Val("" & rsQ2.Fields("Amt")) '規費餘額
                  
                  strTp(1) = PUB_StrToStr(strTp(1), 6, True) '傳票公司別
                  strTp(2) = PUB_StrToStr(strTp(2), 13, True) '傳票號碼
                  strTp(3) = PUB_StrToStr(strTp(3), 17, True) '本所案號
                  If strTp(4) = "0" Then
                     strTp(4) = PUB_StrToStr(strTp(4), 10, True, True)
                  Else
                     strTp(4) = PUB_StrToStr(Format(strTp(4), "#,###"), 10, True, True)
                  End If
                  strText = strText & strTp(1) & " " & strTp(2) & " " & strTp(3) & " " & strTp(4) & vbCrLf
                  
                  rsQ2.MoveNext
               Loop
            End If
            
            rsQ1.MoveNext
         Loop
         If strText <> MsgText(6001) Then
            Call PUB_SaveTextAsUTF8(strFieldName, strText_Fix & strText)
            If Dir(strFieldName) <> MsgText(601) Then
               strTo = Pub_GetSpecMan("財務處總帳人員")
               SendMAPIMail strTo, "CF案件結餘結算作業 , 借貸不平案件系統通知檢查，請檢視！", "Dear Sirs," & vbCrLf & "CF案件結餘結算作業，借貸不平案件系統通知檢查，資料如附件，請橫印！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", strFieldName
            End If
         End If
      End If 'RsQ1.RecordCount > 0
   End If
   
   Set rsQ1 = Nothing
   Set rsQ2 = Nothing
   
   Exit Sub
   
ErrHandle:
   If Err.Number <> 0 Then
      WLog "CF案件結餘結算作業,借貸不平案件系統通知檢查:" & Err.Description
   End If
End Sub

'Added by Lydia 2023/07/27 外專-FCP專利連結案管制：由系統每日批次自動檢查當天專利期滿日,自動收文「通知資訊變更961」 (包含已閉卷/銷卷的案件)
Private Sub StrMenu122()
Dim strCase(1 To 4) As String
Dim rsQD As New ADODB.Recordset
Dim intQ As Integer, strQ1 As String, strSDate As String
    
On Err GoTo ErrHandle

   strSDate = strSrvDate(1)

   strQ1 = "select pa01,pa02,pa03,pa04,pa24,pa25,cp09,cp10 From patent, caseprogress " & _
           "where pa01='FCP' and pa177='Y' and pa25=" & strSDate & " and pa01=cp01(+) and pa02=cp02(+) and pa03=cp03(+) and pa04=cp04(+) and cp31='Y' "
   intQ = 1
   Set rsQD = ClsLawReadRstMsg(intQ, strQ1)
   If intQ = 1 Then
      rsQD.MoveFirst
      Do While Not rsQD.EOF
         strCase(1) = rsQD.Fields("pa01")
         strCase(2) = rsQD.Fields("pa02")
         strCase(3) = rsQD.Fields("pa03")
         strCase(4) = rsQD.Fields("pa04")
         If PUB_GetFCPlinkMC("5", strSDate, strCase, "" & rsQD.Fields("cp09"), "1604") = True Then
         End If
         rsQD.MoveNext
      Loop
      
      Call PUB_SendMailCache(True)
   End If
   Set rsQD = Nothing
   
   Exit Sub
   
ErrHandle:
   If Err.Number <> 0 Then
      WLog "FCP專利連結案管制專利權期滿:" & Err.Description
   End If
End Sub

'Added by Lydia 2023/07/28 外專新案建檔待比對管制：新案建檔相似度的待比對打勾一直未取消 , 則在新案發文日起算每3個工作天, 發mail提醒工程師
Private Sub StrMenu123()
Dim strCase(0 To 4) As String
Dim rsQD As New ADODB.Recordset
Dim intQ As Integer, strQ1 As String, strDate1 As String, StrDate2 As String
    
On Err GoTo ErrHandle

   StrDate2 = strSrvDate(1)
   strDate1 = CompDate(1, -4, StrDate2)  'Modified by Lydia 2023/07/31 考量到[非英說案]提申，英文說明書有可能超過1個月才來，請判斷改為4個月內的發文
   
   'Modified by Lydia 2023/07/28 [非英說案]需要確認已收(tcn13=3 or 4)才發通知
   strQ1 = "select c1.cp01,c1.cp02,c1.cp03,c1.cp04,c1.cp158,tf20,tct10 " & _
           "from transfee,caseprogress c1,caseprogress c2,transcasetitle,trackingcasename " & _
           "where tf01=c1.cp09(+) and tf20 is not null and tf29='Y' " & _
           "and c1.cp01=c2.cp01(+) and c1.cp02=c2.cp02(+) and c1.cp03=c2.cp03(+) and c1.cp04=c2.cp04(+) and c2.cp31='Y' and c2.cp09=tct01(+) " & _
           "and c2.cp158>=" & strDate1 & " and mod(workdaydiff(c2.cp158," & StrDate2 & "), 3)=0 " & _
           "and tct01=tcn05(+) and instr('0,3,4',nvl(tcn13,'0'))>0 order by c1.cp158 "
   intQ = 1
   Set rsQD = ClsLawReadRstMsg(intQ, strQ1)
   If intQ = 1 Then
      rsQD.MoveFirst
      Do While Not rsQD.EOF
         strCase(0) = "" & rsQD.Fields("tf20")
         Call ChgCaseNo(strCase(0), strCase)
         If "" & rsQD.Fields("tct10") <> "" And strCase(1) <> "" And strCase(2) <> "" And strCase(3) <> "" And strCase(4) <> "" Then
            strExc(0) = "" & rsQD.Fields("tct10")
            strExc(1) = PUB_GetFCPEngSup(strExc(0))
            strExc(2) = PUB_GetFCPHandler(strCase(1), strCase(2), strCase(3), strCase(4))
            strExc(3) = rsQD.Fields("cp01") & "-" & rsQD.Fields("cp02") & IIf(rsQD.Fields("cp03") & rsQD.Fields("cp04") <> "000", "-" & rsQD.Fields("cp03") & "-" & rsQD.Fields("cp04"), "") & _
                        "和相似案號" & strCase(1) & "-" & strCase(2) & IIf(strCase(3) & strCase(4) <> "000", "-" & strCase(3) & "-" & strCase(4), "") & _
                        "有相似度待比對尚未處理，請儘速處理，謝謝。"
            SendMAPIMail strExc(0), strExc(3), "如旨", , , , strExc(1) & ";" & strExc(2)
         End If
         rsQD.MoveNext
      Loop
   End If
   Set rsQD = Nothing
   
   Exit Sub
   
ErrHandle:
   If Err.Number <> 0 Then
      WLog "外專新案建檔待比對管制:" & Err.Description
   End If
End Sub

'Added by Lydia 2023/08/21 外專舊案收文提醒缺檔(ORDER.MSG)
Private Sub StrMenu124()
Dim rsQD As New ADODB.Recordset
Dim intQ As Integer, strQ1 As String, strDate1 As String
Dim intXlsSheet As Integer, intPage As Integer
Dim xlsAgentPoint As New Excel.Application
Dim wksrpt As New Worksheet
Dim xlsFileName1 As String
Dim stTmp, intWidth
Dim intCounter As Integer, intB As Integer
Dim strCP13 As String, strGrp As String
Dim strSub As String, strCont As String
Dim strCP10List As String

On Err GoTo ErrHandle

   strDate1 = strSrvDate(1)
   strDate1 = CompWorkDay(3, strDate1, 1) '收文日起兩個工作天=>往前推兩個工作天
   
   '附件名稱
   xlsFileName1 = "系統有收文紀錄但卷宗區無收文接洽單，請盡速確認並完成收文.xls"
   'Email主旨, 內文
   strSub = "系統有收文紀錄但卷宗區無收文接洽單，請參附件excel檔案後盡速確認並完成收文。"
   strCont = "有收文紀錄(AAAA) 但卷宗區無收文接洽單，請參附件excel檔案後盡速確認並完成收文。" & vbCrLf & _
             "若所列案件為大批收文，請確認該批第一件案件卷宗區已有接洽單；" & vbCrLf & _
             "若所列案件為同一案同時多個案件性質收文，請確認該案第一個案件性質卷宗區是否已有接洽單。" & vbCrLf
             
   '外專舊案收文其案件收文性質為401變更/403更改/701讓與/702合併/708專利權讓與/935案件轉至本所，若key收文日起兩個工作天內未偵測到卷宗區該道收文有ORDER(接洽單)之副檔名的檔案(.msg)，即發outlook通知提醒給收文的承辦人員並副本其承辦主管。
   'Memo by Lydia 2023/08/24調整如下:
   '1.排除櫃台的收文，僅抓建檔人為外專承辦人員
   '2.以統計的方式用e-mail通知並附上excel清單給承辦，同一案件性質列在同一個頁籤上，附上excel檔案供參考；Email主旨和內文一併調整。
   strQ1 = "SELECT VT1.* FROM (SELECT PA26,NVL(CU05,NVL(CU04,CU06)) AS PA26N,CP01,CP02,CP03,CP04,CP09,CP10,DECODE(CP01,'P',CPM04,CPM03) CPM03,CP13,COUNT(CPP02) CNT " & _
           ",SUM(DECODE(SUBSTR(UPPER(CPP02),-10,10),'.ORDER.MSG',1,0)) CNT2 " & _
           "FROM CASEPROGRESS,CASEPAPERPDF,CASEPROPERTYMAP,STAFF,PATENT,CUSTOMER WHERE CP01 IN ('FCP','P') AND SUBSTR(CP09,1,1)='A' AND CP10 IN ('401','403','701','702','708','935') " & _
           "AND CP05=" & strDate1 & " AND CP09=CPP01(+) AND CP01=CPM01(+) AND CP10=CPM02(+) AND CP31 IS NULL AND CP159=0 AND CP65=ST01(+) AND ST03='F23' " & _
           "AND CP01=PA01(+) AND CP02=PA02(+) AND CP03=PA03(+) AND CP04=PA04(+) AND SUBSTR(PA26,1,8)=CU01(+) AND SUBSTR(PA26,9,1)=CU02(+) " & _
           "GROUP BY PA26,NVL(CU05,NVL(CU04,CU06)),CP01,CP02,CP03,CP04,CP09,CP10,DECODE(CP01,'P',CPM04,CPM03),CP13 " & _
           ") VT1 WHERE CNT2=0 ORDER BY CP13,CP10,CP01,CP02,CP03,CP04 "
   intQ = 1
   Set rsQD = ClsLawReadRstMsg(intQ, strQ1)
   If intQ = 1 Then
      stTmp = Array("本所案號", "申請人編號", "申請人英文名稱")
      intWidth = Array(15, 12, 35)
      rsQD.MoveFirst
      intXlsSheet = 3
      Do While Not rsQD.EOF
         If strCP13 <> "" & rsQD.Fields("CP13") Then
            If strCP13 <> "" Then
               xlsAgentPoint.Sheets(1).Select '選擇工作表
               If Val(xlsAgentPoint.Version) < 12 Then
                  xlsAgentPoint.Workbooks(1).SaveAs FileName:=App.path & TextPath & xlsFileName1, FileFormat:=-4143
               Else
                  xlsAgentPoint.Workbooks(1).SaveAs FileName:=App.path & TextPath & xlsFileName1, FileFormat:=56
               End If
               xlsAgentPoint.Workbooks.Close
               xlsAgentPoint.Quit
               Set xlsAgentPoint = Nothing
               Set wksrpt = Nothing
               strExc(1) = PUB_GetFCPProSup(strCP13)
               SendMAPIMail strCP13, strSub, Replace(strCont, "AAAA", Mid(strCP10List, 2)), App.path & TextPath & xlsFileName1
               strCP10List = ""
               strGrp = ""
            End If
            If Dir(App.path & TextPath & xlsFileName1) <> "" Then
               Kill App.path & TextPath & xlsFileName1
            End If
            intXlsSheet = 3
            intPage = 0
            intCounter = 1
         End If
         If intPage = 0 Or strGrp <> strCP13 & rsQD.Fields("cp10") Then
            If intPage = 0 Then
               xlsAgentPoint.SheetsInNewWorkbook = intXlsSheet '預設工作表數目
               xlsAgentPoint.Workbooks.add
               xlsAgentPoint.Application.WindowState = xlMinimized
               xlsAgentPoint.Application.Visible = False
            Else
               If intPage + 1 > intXlsSheet Then
                  xlsAgentPoint.Worksheets.add After:=wksrpt '插入sheet
               End If
            End If
            intPage = intPage + 1
            Set wksrpt = xlsAgentPoint.Worksheets(intPage)
            wksrpt.Name = "" & rsQD.Fields("cp10") & rsQD.Fields("cpm03")
            intCounter = 1
            '設定欄位名稱及欄寬
            For intB = LBound(stTmp) To UBound(stTmp)
                wksrpt.Range(Chr(intB + 65) & intCounter).Value = stTmp(intB)
                wksrpt.Columns(Chr(intB + 65) & ":" & Chr(intB + 65)).ColumnWidth = intWidth(intB)
                wksrpt.Range(Chr(intB + 65) & intCounter).HorizontalAlignment = xlCenter
            Next intB
            intCounter = 2
         End If
         wksrpt.Range("A" & intCounter).Value = "" & rsQD.Fields("cp01") & "-" & rsQD.Fields("cp02") & IIf("" & rsQD.Fields("cp03") & rsQD.Fields("cp04") = "000", "", "-" & rsQD.Fields("cp03") & "-" & rsQD.Fields("cp04")) '本所案號
         wksrpt.Range("B" & intCounter).Value = "" & rsQD.Fields("pa26")  '申請人
         wksrpt.Range("C" & intCounter).Value = "" & rsQD.Fields("pa26n")  '申請人英文名稱
         
         intCounter = intCounter + 1
         strCP13 = "" & rsQD.Fields("CP13")
         strGrp = strCP13 & rsQD.Fields("cp10")
         If InStr(strCP10List, "/" & rsQD.Fields("cp10") & rsQD.Fields("cpm03")) = 0 Then
            strCP10List = strCP10List & "/" & rsQD.Fields("cp10") & rsQD.Fields("cpm03")
         End If
         rsQD.MoveNext
      Loop
      If strCP13 <> "" Then
         xlsAgentPoint.Sheets(1).Select '選擇工作表
         If Val(xlsAgentPoint.Version) < 12 Then
            xlsAgentPoint.Workbooks(1).SaveAs FileName:=App.path & TextPath & xlsFileName1, FileFormat:=-4143
         Else
            xlsAgentPoint.Workbooks(1).SaveAs FileName:=App.path & TextPath & xlsFileName1, FileFormat:=56
         End If
         xlsAgentPoint.Workbooks.Close
         xlsAgentPoint.Quit
         Set xlsAgentPoint = Nothing
         Set wksrpt = Nothing
         strExc(1) = PUB_GetFCPProSup(strCP13)
         'Modified by Morgan 2024/1/24 補CC主管
         SendMAPIMail strCP13, strSub, Replace(strCont, "AAAA", Mid(strCP10List, 2)), App.path & TextPath & xlsFileName1, , , strExc(1)
      End If
   End If
   Set rsQD = Nothing
   
   Exit Sub
   
ErrHandle:
   If Err.Number <> 0 Then
      WLog "外專舊案收文提醒缺檔(ORDER.MSG):" & Err.Description
   End If
End Sub

'Added by Lydia 2023/10/05 外專寄請款函作業稽核：請款作業後5個工作天，判斷有請款單號且請款單號相同的卷宗區其中未有一個副檔名為REPDN(寄請款函)或DNUPL(請款單上傳)或PAPER(紙本寄出)，則發mail給各區程序人員，CC主管
Private Sub StrMenu125()
Dim rsQD As New ADODB.Recordset
Dim intQ As Integer, strQ1 As String, strDate1 As String
Dim xlsAgentPoint As New Excel.Application
Dim wksrpt As New Worksheet
Dim xlsFileName1 As String
Dim stTmp, intWidth
Dim intCounter As Integer, intB As Integer
Dim strGrp As String
Dim strCon1 As String, strCon2 As String 'Added by Lydia 2025/01/16
    
On Err GoTo ErrHandle

   strDate1 = CompWorkDay(6, strSrvDate(1), 1) '請款作業後5個工作天
   
   strCon1 = PUB_GetFCPforDNsql("1", strCon2) 'Added by Lydia 2025/01/16 改用模組取得SQL
   '附件名稱
   xlsFileName1 = "寄請款函作業稽核.xls"
   
   'FCP、FMP案指定案件質放在AddressA4List
   'Modified by Lydia 2023/10/11 +B.CP158
   'Modified by Lydia 2023/10/12 若核對已准專利（926）和其他案件性質（不限案件性質），若有相同單號，且同單號下卷宗區有寄請款函、請款單上傳、紙本寄出，則不發mail，謝謝
   'strQ1 = "SELECT B.CP01,B.CP02,B.CP03,B.CP04,B.CP09,B.CP10,B.CP60,CPM03,NA16,B.CP158 FROM (" & _
           " SELECT CP01,CP02,CP03,CP04,CP60,SUM(DECODE(SIGN(INSTR(UPPER(CPP02),'.REPDN.')),0,0,1)) R1" & _
           " , SUM(DECODE(SIGN(INSTR(UPPER(CPP02),'.DNUPL.')),0,0,1)) R2, SUM(DECODE(SIGN(INSTR(UPPER(CPP02),'.PAPER.')),0,0,1)) R3" & _
           " FROM CASEPROGRESS,CASEPAPERPDF WHERE CP01='FCP' AND CP60 IN (" & _
           " SELECT A1K01 FROM ACC1K0,STAFF WHERE A1K13='FCP' AND A1K19=" & TransDate(strDate1, 1) & " AND A1K21=ST01(+) AND ST03='F22')" & _
           " AND CP10 IN (SELECT AAL04 FROM ADDRESSA4LIST WHERE AAL01='請款函FCP')" & _
           " AND CP09=CPP01(+) GROUP BY CP01,CP02,CP03,CP04,CP60 " & _
           " ) X,PATENT,FAGENT,NATION,CASEPROGRESS B ,CASEPROPERTYMAP WHERE R1+R2+R3=0 AND X.CP01=PA01(+) AND X.CP02=PA02(+) AND X.CP03=PA03(+) AND X.CP04=PA04(+)" & _
           " AND SUBSTR(PA75,1,8)=FA01(+) AND SUBSTR(PA75,9,1)=FA02(+) AND FA10=NA01(+)" & _
           " AND X.CP01=B.CP01(+) AND X.CP02=B.CP02(+) AND X.CP03=B.CP03(+) AND X.CP04=B.CP04(+)" & _
           " AND X.CP60=B.CP60(+) AND B.CP10 IN (SELECT AAL04 FROM ADDRESSA4LIST WHERE AAL01='請款函FCP') AND B.CP01=CPM01(+) AND B.CP10=CPM02(+)"
      'Modified by Lydia 2025/01/16 改用模組取得SQL
      'strQ1 = "SELECT B.CP01,B.CP02,B.CP03,B.CP04,B.CP09,B.CP10,B.CP60,CPM03,NA16,B.CP158 FROM (" & _
           " SELECT CP01,CP02,CP03,CP04,CP60,SUM(DECODE(SIGN(INSTR(UPPER(CPP02),'.REPDN.')),0,0,1)) R1" & _
           " , SUM(DECODE(SIGN(INSTR(UPPER(CPP02),'.DNUPL.')),0,0,1)) R2, SUM(DECODE(SIGN(INSTR(UPPER(CPP02),'.PAPER.')),0,0,1)) R3" & _
           " FROM CASEPROGRESS,CASEPAPERPDF WHERE CP01='FCP' AND CP60 IN (" & _
           " SELECT A1K01 FROM ACC1K0,STAFF WHERE A1K13='FCP' AND A1K19=" & TransDate(strDate1, 1) & " AND A1K21=ST01(+) AND ST03='F22')" & _
           " AND CP09=CPP01(+) GROUP BY CP01,CP02,CP03,CP04,CP60 " & _
           " ) X,PATENT,FAGENT,NATION,CASEPROGRESS B ,CASEPROPERTYMAP WHERE R1+R2+R3=0 AND X.CP01=PA01(+) AND X.CP02=PA02(+) AND X.CP03=PA03(+) AND X.CP04=PA04(+)" & _
           " AND SUBSTR(PA75,1,8)=FA01(+) AND SUBSTR(PA75,9,1)=FA02(+) AND FA10=NA01(+)" & _
           " AND X.CP01=B.CP01(+) AND X.CP02=B.CP02(+) AND X.CP03=B.CP03(+) AND X.CP04=B.CP04(+)" & _
           " AND X.CP60=B.CP60(+) AND B.CP10 IN (SELECT AAL04 FROM ADDRESSA4LIST WHERE AAL01='請款函FCP') AND B.CP01=CPM01(+) AND B.CP10=CPM02(+)"
      strQ1 = "SELECT B.CP01,B.CP02,B.CP03,B.CP04,B.CP09,B.CP10,B.CP60,CPM03,NA16,B.CP158 FROM (" & _
           " SELECT CP01,CP02,CP03,CP04,CP60 " & strCon1 & _
           " FROM CASEPROGRESS,CASEPAPERPDF WHERE CP01='FCP' AND CP60 IN (" & _
           " SELECT A1K01 FROM ACC1K0,STAFF WHERE A1K13='FCP' AND A1K19=" & TransDate(strDate1, 1) & " AND A1K21=ST01(+) AND ST03='F22')" & _
           " AND CP09=CPP01(+) GROUP BY CP01,CP02,CP03,CP04,CP60 " & _
           " ) X,PATENT,FAGENT,NATION,CASEPROGRESS B ,CASEPROPERTYMAP WHERE X.CP01=PA01(+) AND X.CP02=PA02(+) AND X.CP03=PA03(+) AND X.CP04=PA04(+) " & strCon2 & _
           " AND SUBSTR(PA75,1,8)=FA01(+) AND SUBSTR(PA75,9,1)=FA02(+) AND FA10=NA01(+)" & _
           " AND X.CP01=B.CP01(+) AND X.CP02=B.CP02(+) AND X.CP03=B.CP03(+) AND X.CP04=B.CP04(+)" & _
           " AND X.CP60=B.CP60(+) AND B.CP10 IN (SELECT AAL04 FROM ADDRESSA4LIST WHERE AAL01='請款函FCP') AND B.CP01=CPM01(+) AND B.CP10=CPM02(+)"
   'FMP案
   'Modified by Lydia 2023/10/11 +B.CP158
   'Modified by Lydia 2023/10/12 若核對已准專利（926）和其他案件性質（不限案件性質），若有相同單號，且同單號下卷宗區有寄請款函、請款單上傳、紙本寄出，則不發mail，謝謝
   'strQ1 = strQ1 & " UNION SELECT B.CP01,B.CP02,B.CP03,B.CP04,B.CP09,B.CP10,B.CP60,CPM04,NA79,B.CP158 FROM (" & _
           " SELECT CP01,CP02,CP03,CP04,CP60,SUM(DECODE(SIGN(INSTR(UPPER(CPP02),'.REPDN.')),0,0,1)) R1" & _
           " , SUM(DECODE(SIGN(INSTR(UPPER(CPP02),'.DNUPL.')),0,0,1)) R2, SUM(DECODE(SIGN(INSTR(UPPER(CPP02),'.PAPER.')),0,0,1)) R3" & _
           " FROM CASEPROGRESS,CASEPAPERPDF WHERE CP01='P' AND CP60 IN (" & _
           " SELECT A1K01 FROM ACC1K0,STAFF WHERE A1K13='P' AND A1K19=" & TransDate(strDate1, 1) & " AND A1K21=ST01(+) AND ST03='F22')" & _
           " AND CP10 IN (SELECT AAL04 FROM ADDRESSA4LIST WHERE AAL01='請款函FMP')" & _
           " AND CP09=CPP01(+) GROUP BY CP01,CP02,CP03,CP04,CP60 " & _
           " ) X,PATENT,FAGENT,NATION,CASEPROGRESS B ,CASEPROPERTYMAP WHERE R1+R2+R3=0 AND X.CP01=PA01(+) AND X.CP02=PA02(+) AND X.CP03=PA03(+) AND X.CP04=PA04(+)" & _
           " AND SUBSTR(PA75,1,8)=FA01(+) AND SUBSTR(PA75,9,1)=FA02(+) AND FA10=NA01(+)" & _
           " AND X.CP01=B.CP01(+) AND X.CP02=B.CP02(+) AND X.CP03=B.CP03(+) AND X.CP04=B.CP04(+)" & _
           " AND X.CP60=B.CP60(+) AND B.CP10 IN (SELECT AAL04 FROM ADDRESSA4LIST WHERE AAL01='請款函FMP') AND B.CP01=CPM01(+) AND B.CP10=CPM02(+)"
   'Modified by Lydia 2025/01/16 改用模組取得SQL
   'strQ1 = strQ1 & " UNION SELECT B.CP01,B.CP02,B.CP03,B.CP04,B.CP09,B.CP10,B.CP60,CPM04,NA79,B.CP158 FROM (" & _
           " SELECT CP01,CP02,CP03,CP04,CP60,SUM(DECODE(SIGN(INSTR(UPPER(CPP02),'.REPDN.')),0,0,1)) R1" & _
           " , SUM(DECODE(SIGN(INSTR(UPPER(CPP02),'.DNUPL.')),0,0,1)) R2, SUM(DECODE(SIGN(INSTR(UPPER(CPP02),'.PAPER.')),0,0,1)) R3" & _
           " FROM CASEPROGRESS,CASEPAPERPDF WHERE CP01='P' AND CP60 IN (" & _
           " SELECT A1K01 FROM ACC1K0,STAFF WHERE A1K13='P' AND A1K19=" & TransDate(strDate1, 1) & " AND A1K21=ST01(+) AND ST03='F22')" & _
           " AND CP09=CPP01(+) GROUP BY CP01,CP02,CP03,CP04,CP60 " & _
           " ) X,PATENT,FAGENT,NATION,CASEPROGRESS B ,CASEPROPERTYMAP WHERE R1+R2+R3=0 AND X.CP01=PA01(+) AND X.CP02=PA02(+) AND X.CP03=PA03(+) AND X.CP04=PA04(+)" & _
           " AND SUBSTR(PA75,1,8)=FA01(+) AND SUBSTR(PA75,9,1)=FA02(+) AND FA10=NA01(+)" & _
           " AND X.CP01=B.CP01(+) AND X.CP02=B.CP02(+) AND X.CP03=B.CP03(+) AND X.CP04=B.CP04(+)" & _
           " AND X.CP60=B.CP60(+) AND B.CP10 IN (SELECT AAL04 FROM ADDRESSA4LIST WHERE AAL01='請款函FMP') AND B.CP01=CPM01(+) AND B.CP10=CPM02(+)"
   strQ1 = strQ1 & " UNION SELECT B.CP01,B.CP02,B.CP03,B.CP04,B.CP09,B.CP10,B.CP60,CPM04,NA79,B.CP158 FROM (" & _
           " SELECT CP01,CP02,CP03,CP04,CP60 " & strCon1 & _
           " FROM CASEPROGRESS,CASEPAPERPDF WHERE CP01='P' AND CP60 IN (" & _
           " SELECT A1K01 FROM ACC1K0,STAFF WHERE A1K13='P' AND A1K19=" & TransDate(strDate1, 1) & " AND A1K21=ST01(+) AND ST03='F22')" & _
           " AND CP09=CPP01(+) GROUP BY CP01,CP02,CP03,CP04,CP60 " & _
           " ) X,PATENT,FAGENT,NATION,CASEPROGRESS B ,CASEPROPERTYMAP WHERE X.CP01=PA01(+) AND X.CP02=PA02(+) AND X.CP03=PA03(+) AND X.CP04=PA04(+) " & strCon2 & _
           " AND SUBSTR(PA75,1,8)=FA01(+) AND SUBSTR(PA75,9,1)=FA02(+) AND FA10=NA01(+)" & _
           " AND X.CP01=B.CP01(+) AND X.CP02=B.CP02(+) AND X.CP03=B.CP03(+) AND X.CP04=B.CP04(+)" & _
           " AND X.CP60=B.CP60(+) AND B.CP10 IN (SELECT AAL04 FROM ADDRESSA4LIST WHERE AAL01='請款函FMP') AND B.CP01=CPM01(+) AND B.CP10=CPM02(+)"
   strQ1 = strQ1 & " ORDER BY NA16,1,2,3,4,5,6"

   intQ = 1
   Set rsQD = ClsLawReadRstMsg(intQ, strQ1)
   If intQ = 1 Then
      stTmp = Array("本所案號", "案件性質", "請款單號")
      intWidth = Array(15, 15, 15)
      rsQD.MoveFirst
      Do While Not rsQD.EOF
         'Modified by Lydia 2023/11/09 改成模組
         ''不發mail的例外：若主動修正(203)的請款單號和新案（101,102,103）or 新案翻譯(201)/檢視中說(209) /核對中說格式(235)的請款單號相同，則不發=>和中說一起送，就不是程序E
         'If InStr("203,", "" & rsQD.Fields("cp10")) > 0 Then
         '   strSql = "select cp09,cp60 from caseprogress where cp01='" & rsQD.Fields("cp01") & "' and cp02='" & rsQD.Fields("cp02") & "' and cp03='" & rsQD.Fields("cp03") & "' and cp04='" & rsQD.Fields("cp04") & "' and (cp31='Y' or cp10 in ('201','209','210','235')) and cp60='" & rsQD.Fields("cp60") & "' "
         '   intI = 1
         '   Set RsTemp = ClsLawReadRstMsg(intI, strSql)
         '   If intI = 1 Then
         '      GoTo JumpToNext
         '   End If
         '   'Added by Lydia 2023/10/11 增加主動修正的判斷：若主動修正的發文日和新案翻譯（含檢視中說、核對中說格式、製作中說）同一天，則不發此mail; ex.FCP-069760,FCP-069774
         '   strSql = "select cp09,cp60 from caseprogress where cp01='" & rsQD.Fields("cp01") & "' and cp02='" & rsQD.Fields("cp02") & "' and cp03='" & rsQD.Fields("cp03") & "' and cp04='" & rsQD.Fields("cp04") & "' and cp10 in ('201','209','210','235') and cp158='" & rsQD.Fields("cp158") & "' "
         '   intI = 1
         '   Set RsTemp = ClsLawReadRstMsg(intI, strSql)
         '   If intI = 1 Then
         '      GoTo JumpToNext
         '   End If
         '   'end 2023/10/11
         'End If
         If PUB_ChkFCPtoDNUPLsub("" & rsQD.Fields("cp01"), "" & rsQD.Fields("cp02"), "" & rsQD.Fields("cp03"), "" & rsQD.Fields("cp04"), "" & rsQD.Fields("cp09"), "" & rsQD.Fields("cp10"), "" & rsQD.Fields("cp60"), "" & rsQD.Fields("cp158")) = True Then
            GoTo JumpToNext
         End If
         'end 2023/11/09
         If strGrp <> "" & rsQD.Fields("NA16") Then
            If strGrp <> "" Then
               xlsAgentPoint.Sheets(1).Select '選擇工作表
               If Val(xlsAgentPoint.Version) < 12 Then
                  xlsAgentPoint.Workbooks(1).SaveAs FileName:=App.path & TextPath & xlsFileName1, FileFormat:=-4143
               Else
                  xlsAgentPoint.Workbooks(1).SaveAs FileName:=App.path & TextPath & xlsFileName1, FileFormat:=56
               End If
               xlsAgentPoint.Workbooks.Close
               xlsAgentPoint.Quit
               Set xlsAgentPoint = Nothing
               Set wksrpt = Nothing
               strExc(1) = PUB_GetFCPProSup(strGrp)
               SendMAPIMail strGrp, ChangeTStringToTDateString(strSrvDate(2)) & "寄請款函作業稽核", "附件EXCEL的請款函尚未e-mail給代理人，請儘速作業。", App.path & TextPath & xlsFileName1, , , strExc(1)
            End If
            If Dir(App.path & TextPath & xlsFileName1) <> "" Then
               Kill App.path & TextPath & xlsFileName1
            End If
            intCounter = 1
            xlsAgentPoint.SheetsInNewWorkbook = 1 '預設工作表數目
            xlsAgentPoint.Workbooks.add
            xlsAgentPoint.Application.WindowState = xlMinimized
            xlsAgentPoint.Application.Visible = False
            Set wksrpt = xlsAgentPoint.Worksheets(1)
            '設定欄位名稱及欄寬
            For intB = LBound(stTmp) To UBound(stTmp)
                wksrpt.Range(Chr(intB + 65) & intCounter).Value = stTmp(intB)
                wksrpt.Columns(Chr(intB + 65) & ":" & Chr(intB + 65)).ColumnWidth = intWidth(intB)
                wksrpt.Range(Chr(intB + 65) & intCounter).HorizontalAlignment = xlCenter
            Next intB
            intCounter = 2
         End If
         wksrpt.Range("A" & intCounter).Value = "" & rsQD.Fields("cp01") & "-" & rsQD.Fields("cp02") & IIf("" & rsQD.Fields("cp03") & rsQD.Fields("cp04") = "000", "", "-" & rsQD.Fields("cp03") & "-" & rsQD.Fields("cp04")) '本所案號
         wksrpt.Range("B" & intCounter).Value = "" & rsQD.Fields("cpm03")
         wksrpt.Range("C" & intCounter).Value = "" & rsQD.Fields("cp60")
         
         intCounter = intCounter + 1
         strGrp = "" & rsQD.Fields("NA16")
         
JumpToNext:
         rsQD.MoveNext
      Loop
      If strGrp <> "" Then
         xlsAgentPoint.Sheets(1).Select '選擇工作表
         If Val(xlsAgentPoint.Version) < 12 Then
            xlsAgentPoint.Workbooks(1).SaveAs FileName:=App.path & TextPath & xlsFileName1, FileFormat:=-4143
         Else
            xlsAgentPoint.Workbooks(1).SaveAs FileName:=App.path & TextPath & xlsFileName1, FileFormat:=56
         End If
         xlsAgentPoint.Workbooks.Close
         xlsAgentPoint.Quit
         Set xlsAgentPoint = Nothing
         Set wksrpt = Nothing
         strExc(1) = PUB_GetFCPProSup(strGrp)
         SendMAPIMail strGrp, ChangeTStringToTDateString(strSrvDate(2)) & "寄請款函作業稽核", "附件EXCEL的請款函尚未e-mail給代理人，請儘速作業。", App.path & TextPath & xlsFileName1, , , strExc(1)
      End If
   End If
   Set rsQD = Nothing
   
   Exit Sub
   
ErrHandle:
   If Err.Number <> 0 Then
      WLog "外專寄請款函作業稽核:" & Err.Description
   End If
End Sub

'Add By Sindy 2023/10/24 通知填寫工作評價
Sub StrMenu126()
Dim tmpnext As String
Dim TempFileName As String
Dim strSubject As String
Dim A01 As String, A02 As String
Dim strTo As String
Dim strSql As String
Dim ff As Integer
   
On Error GoTo DebugErr
   
   If Right(strSrvDate(1), 2) = "01" Then
      strSubject = "通知第一階主管填寫工作評價"
      strSql = "select b0101,st02,b0130 as Main from abs001,staff where b0130 is not null and b0101=st01 and st04='1'" & _
               " order by b0130,st03,b0101"
   ElseIf Right(strSrvDate(1), 2) = "06" Then
      strSubject = "通知第二階主管填寫工作評價"
      strSql = "select b0101,st02,b0131 as Main from abs001,staff where b0131 is not null and b0101=st01 and st04='1'" & _
               " order by b0131,st03,b0101"
   ElseIf Right(strSrvDate(1), 2) = "12" Then
      strSubject = "通知第三階主管填寫工作評價"
      strSql = "select b0101,st02,b0132 as Main from abs001,staff where b0132 is not null and b0101=st01 and st04='1'" & _
               " order by b0132,st03,b0101"
   End If
   If strSql <> "" Then
      Set Rs = New ADODB.Recordset
      Rs.CursorLocation = adUseClient
      Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      tmpnext = "已取得資料..."
      With Rs
         If .RecordCount > 0 Then
            .MoveFirst
            Do While Not .EOF
               If strTo <> "" And strTo <> .Fields("Main") Then
                  Close ff
                  tmpnext = "關檔..."
                  SendMAPIMail strTo, strSubject, "Dear Sirs," & vbCrLf & "          " & strSubject & "，請依指定日期前填寫，謝謝！" & vbCrLf & "          人員清單，請參附件！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", App.path & TextPath & TempFileName & ".txt", , True
                  TempFileName = ""
               End If
               If TempFileName = "" Then
                  TempFileName = strSrvDate(2) & strSubject & "_" & .Fields("Main")
                  If Dir(App.path & TextPath & TempFileName & ".txt") <> "" Then
                     Kill App.path & TextPath & TempFileName & ".txt"
                  End If
                  If ff > 0 Then Close #ff
                  ff = FreeFile
                  Open App.path & TextPath & TempFileName & ".txt" For Output As ff
                  Print #ff, Space(10) & TempFileName
                  Print #ff, ""
                  Print #ff, "員工編號     姓名"
                  Print #ff, "============ ============"
                  tmpnext = "開檔中..."
               End If
               A01 = "" & convForm(CheckStr(.Fields(0).Value), 12)
               A02 = "" & convForm(CheckStr(.Fields(1).Value), 12)
               tmpnext = "寫檔..."
               Print #ff, A01 & " " & A02
               
               strTo = .Fields("Main")
               .MoveNext
            Loop
            Close ff
            tmpnext = "關檔..."
            SendMAPIMail strTo, strSubject, "Dear Sirs," & vbCrLf & "          " & strSubject & "　如附件！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", App.path & TextPath & TempFileName & ".txt", , True
         End If
      End With
      Rs.Close
   Else
      SendMAPIMail Pub_GetSpecMan("程式管理人員"), "通知填寫工作評價沒有執行到SQL，請確認程式是否有問題?", "同主旨"
   End If
   
   Set Rs = Nothing

   Exit Sub

DebugErr:
   WLog tmpnext & " " & Err.Description
End Sub

'Modify by Amy 2024/02/01 設定風險檢查對象之潛在客戶已收文列表
Private Sub StrMenu127()
   Dim rsQ1 As New ADODB.Recordset, intQ1 As Integer, stQ1 As String, stWhere1 As String, ii As Integer, jj As Integer, stTmp(2) As String
   Dim rsQ2 As New ADODB.Recordset, intQ2 As Integer, stQ2 As String, stFindTxt As String, tmpnext As String
   Dim stDate As String, stCmd As String
   Dim wkXls As New Excel.Application, wkSheet As New Worksheet, xlsFileName As String, stWkName As String, bolOpenXls As Boolean
   Dim intTitleRow As Integer, intRow As Integer, intField As Integer, stData(1) As String, stAllF As String, stAllW As String
   Dim stTO As String, stSubject As String, arrField() As String, arrWidth() As String
On Error GoTo ErrHand
   
   'Modify by Amy 2025/09/04 建立者->負責同仁 原:負責同仁=建立者,1140728 風險編號001/002 改負責同仁
   'stAllF = "風險檢查編號,要求檢查編號,風險檢查名稱,建立者,建立者部門,案號,申請人編號,FC代理人,對造欄位,案件性質,業務人員,業務部門"
   stAllF = "風險檢查編號,要求檢查編號,風險檢查名稱,負責同仁,負責同仁部門,案號,申請人編號,FC代理人,對造欄位,案件性質,業務人員,業務部門"
   stAllW = "12,12,18, 12, 12,10, 12, 10, 12, 12, 12,12"

   '刪除暫存檔資料
   stCmd = "Delete From RADB127 Where State in('1','2')"
   cnnConnection.Execute stCmd
   
   '抓前一個工作天,收文 A類 且為 風險檢查對象之案件性質
   'stWhere1 = "And CP05>=20240102 And CP05<=" & strSrvDate(1) '測式用
   stDate = CompWorkDay(2, strSrvDate(1), 1) '前一個工作天
   stWhere1 = "And CP05=" & stDate
   stCmd = GetCPForRiskCheckSql("StrMenu127", stWhere1)
   stCmd = Replace(UCase(stCmd), "SELECT CP01,", "SELECT '1',CP01,")
   stCmd = "insert into RADB127 (State,R01,R02,R03,R04,R05,R06,R07,R08,R09,R10,R11,R12,R13,R14,R15,R16,R17,R18,R19) " & stCmd
   tmpnext = "取得前1工作天收文資料寫入暫存檔..."
   cnnConnection.Execute stCmd, intQ1
   
   If intQ1 = 0 Then Exit Sub

   '以暫存檔名稱檢查風險檢查名稱是否已建
   stQ1 = ""
   For ii = 0 To 2
      stTmp(0) = "R" & Format(9 + ii, "00")  '中/英/日-去符號

      If stQ1 <> MsgText(601) Then stQ1 = stQ1 & " Union "
      stQ1 = stQ1 & "Select Distinct " & stTmp(0) & " as FindN From RADB127 Where " & stTmp(0) & " Is not Null "
   Next ii
   stQ1 = stQ1 & " Order by 1 "
   intQ1 = 1
   tmpnext = "讀取暫存檔..."
   Set rsQ1 = ClsLawReadRstMsg(intQ1, stQ1)
   If intQ1 = 1 Then
      rsQ1.MoveFirst
      Do While rsQ1.EOF = False
         '檢查名稱是否存在於 風險檢查對象 資料中
         stFindTxt = rsQ1.Fields("FindN")
         Call ChkRiskData(2, "AutoBatchDay-StrMenu127", , , stFindTxt, stQ2)
         stQ2 = "Select * From (" & stQ2 & ") Order by RCL01 "
         intQ2 = 1
         tmpnext = "判斷存在風險檢查對象語法(名稱:" & Left(ChgSQL(stFindTxt), 5) & ")..."
         Set rsQ2 = ClsLawReadRstMsg(intQ2, stQ2)
         If intQ2 = 1 Then
            stQ1 = ""
            rsQ2.MoveFirst
            Do While rsQ2.EOF = False
               'Memo Excel 以[風險檢查編號]排序,先寫入暫存檔
               '            風險檢查欄位之中/樂/英/日字樣           要求檢查對象                             風險檢查編號                                部門
               stCmd = ",'" & rsQ2.Fields("RCLField") & "','" & rsQ2.Fields("RCL18") & "','" & rsQ2.Fields("RCL01") & "','" & rsQ2.Fields("RCL21") & "'"
               '                                智權人員                                             找到的原始字                                                 找到的字去符號
               stCmd = stCmd & ",'" & rsQ2.Fields("RCL22") & "','" & ChgSQL(rsQ2.Fields("INTTXT")) & "','" & ChgSQL(stFindTxt) & "'"
               stCmd = "insert into RADB127 (State,R03,R05,R20,R07,R08,R09,R10) Values('2'" & stCmd & ")"
               tmpnext = "比對對造名稱相同寫入暫存檔(風險No:" & rsQ2.Fields("RCL01") & ")..."
               cnnConnection.Execute stCmd
               rsQ2.MoveNext
            Loop
         End If
         rsQ1.MoveNext
      Loop
   End If

   '抓要顯示的資料
   stQ1 = "Select R20 as RCL01,R05 as RCL18,R03||'：'||R09 as RCLName,ST02 as RCLSales,A0902 as RCLDept" & _
                  ",R05,R03,R07,R08,R10 as stFixSignTxt From RADB127,Staff,Acc090 " & _
                  "Where State='2' And R08=ST01(+) And R07=A0901(+) Order by R20,Decode(R03,'中',1,'英',2,'日',3,0) "
   intQ1 = 1
   tmpnext = "取得顯示資料..."
   Set rsQ1 = ClsLawReadRstMsg(intQ1, stQ1)
   If intQ1 = 1 Then
      rsQ1.MoveFirst
      Do While rsQ1.EOF = False
         '申請人編號有對到要求檢查對象編號者顯示要求檢查對象
         'stTmp(0) = ",Decode(SubStr(R13,1,8),'申請人編號','要求檢查對象',Decode(SubStr(R14,1,8),'申請人編號','要求檢查對象',Decode(SubStr(R15,1,8),'申請人編號','要求檢查對象',Decode(SubStr(R16,1,8),'申請人編號','要求檢查對象',Decode(SubStr(R17,1,8),'申請人編號','要求檢查對象',''))))) as APPState"
         '顯示5個申請人編號
         stTmp(0) = ",R13||Decode(R14,null,'',';'||R14)||Decode(R15,null,'',';'||R15)||Decode(R16,null,'',';'||R16)||Decode(R17,null,'',';'||R17) as APPState"
         stTmp(0) = Replace(stTmp(0), "'申請人編號'", "'" & rsQ1.Fields("RCL18") & "'")
         stQ2 = "Select R01||'-'||R02||Decode(R03||R04,'000','','-'||R03||'-'||R04) as CaseNo" & stTmp(0) & ",'中' as CPField,Decode(R18,'000',CPM03,CPM04) as CPMN,ST02 as CPSales,A0902 as CPDept " & _
                           ",R08,R07,R01,R02,R03,R04,R06 as CPMNo,R19 as FCAgent  " & _
                        "From RADB127,Staff,Acc090,CasePropertyMap " & _
                        "Where State='1' And R08=ST01(+) And R07=A0901(+) And R09='" & ChgSQL(rsQ1.Fields("stFixSignTxt")) & "' And R01=CPM01(+) And R06=CPM02(+) " & _
                        "Order by R08,R07,R01,R02,R03,R04,R06 "

         intQ2 = 1
         tmpnext = "取得相關資料(名稱:" & Left(ChgSQL(rsQ1.Fields("stFixSignTxt")), 5) & ")..."
         Set rsQ2 = ClsLawReadRstMsg(intQ2, stQ2)
         If intQ2 = 1 Then
            rsQ2.MoveFirst
            Do While rsQ2.EOF = False
               If bolOpenXls = False Then
                  '*** 設定Excel 及 欄位 ***'
                  arrField = Split(stAllF, ",")
                  arrWidth = Split(stAllW, ",")
                  intField = 65: intRow = 1
                  xlsFileName = App.path & TextPath & stDate & "風險檢查對象之潛在客戶已收文列表"
                  If Dir(xlsFileName & ".*") <> MsgText(601) Then
                     Kill xlsFileName & ".*"
                  End If
                  tmpnext = "設定Excel 及 欄位..."
                  wkXls.SheetsInNewWorkbook = 3 '預設工作表數目
                  wkXls.Workbooks.add
                  If stWkName = MsgText(601) Then stWkName = Left(wkXls.Worksheets(1).Name, Len(wkXls.Worksheets(1).Name) - 1)
                     Set wkSheet = wkXls.Worksheets(stWkName & "1")
                     bolOpenXls = True
                     wkSheet.Activate
                     wkSheet.Range(Chr(intField) & intRow).Value = "列印日期：" & CFDate(ACDate(ServerDate)): intRow = intRow + 1
                     For jj = LBound(arrField) To UBound(arrField)
                        wkSheet.Columns(Chr(intField + jj) & ":" & Chr(intField + jj)).ColumnWidth = Val(arrWidth(jj))
                        wkSheet.Range(Chr(intField + jj) & intRow).Value = arrField(jj)
                        wkSheet.Range(Chr(intField + jj) & intRow).HorizontalAlignment = xlCenter
                     Next jj
                     intTitleRow = intRow
                     intRow = intRow + 1
                  '*** End 設定Excel 及 欄位 ***
               End If
               '*** Excel 內容 ***
               tmpnext = "Excel 內容(風險No:" & rsQ1.Fields("RCL01") & ")..."
               For jj = LBound(arrField) To UBound(arrField)
                  stData(0) = "": stData(1) = ""
                  Select Case jj
                     Case GetColVal(arrField, "風險檢查編號", 0)
                        stData(0) = "" & rsQ1.Fields("RCL01")
                        stData(1) = "@"
                     Case GetColVal(arrField, "要求檢查編號", 0)
                        stData(0) = "" & rsQ1.Fields("RCL18")
                     Case GetColVal(arrField, "風險檢查名稱", 0)
                        stData(0) = "" & rsQ1.Fields("RCLName") '風險檢查欄位:名稱
                     Case GetColVal(arrField, "負責同仁", 0)
                        stData(0) = "" & rsQ1.Fields("RCLSales")
                     Case GetColVal(arrField, "負責同仁部門", 0)
                        stData(0) = "" & rsQ1.Fields("RCLDept")
                     Case GetColVal(arrField, "案號", 0)
                        stData(0) = "" & rsQ2.Fields("CaseNo")
                     Case GetColVal(arrField, "申請人編號", 0)
                        stData(0) = "" & rsQ2.Fields("APPState")
                     Case GetColVal(arrField, "FC代理人", 0)
                        stData(0) = "" & rsQ2.Fields("FCAgent")
                     Case GetColVal(arrField, "對造欄位", 0)
                        stData(0) = "" & rsQ2.Fields("CPField")
                     Case GetColVal(arrField, "案件性質", 0)
                        stData(0) = "" & rsQ2.Fields("CPMN")
                     Case GetColVal(arrField, "業務人員", 0)
                        stData(0) = "" & rsQ2.Fields("CPSales")
                     Case GetColVal(arrField, "業務部門", 0)
                        stData(0) = "" & rsQ2.Fields("CPDept")
                  End Select
                  If stData(1) <> MsgText(601) Then
                     wkSheet.Range(Chr(intField + jj) & intRow).NumberFormatLocal = stData(1)
                  End If
                  wkSheet.Range(Chr(intField + jj) & intRow).Value = stData(0)
               Next jj
               '*** End Excel 內容 ***
                  intRow = intRow + 1
                  rsQ2.MoveNext
            Loop
         End If
         rsQ1.MoveNext
      Loop
      'Excel 最後設定
      If bolOpenXls = True Then
         tmpnext = "Excel 最後設定..."
         '抬頭
         With wkSheet.Range(Chr(intField) & intTitleRow & ":" & Chr(UBound(arrField) + intField) & intTitleRow)
            .Font.Name = "標楷體"
            .Font.Size = 12
            .Borders(xlEdgeBottom).LineStyle = xlContinuous
         End With
         '內容 字型大小設定
         With wkSheet.Range(Chr(intField) & intTitleRow + 1 & ":" & Chr(UBound(arrField) + intField) & intRow)
               .Font.Name = "新細明體"
               .Font.Size = 10
         End With
         wkSheet.PageSetup.PaperSize = 9 '設A4
         wkSheet.PageSetup.Orientation = xlLandscape '橫印
         wkSheet.PageSetup.PrintTitleRows = "$1:$" & intTitleRow
         wkSheet.PageSetup.TopMargin = wkXls.InchesToPoints(0.3) '上
         wkSheet.PageSetup.BottomMargin = wkXls.InchesToPoints(0.3) '下
         wkSheet.PageSetup.LeftMargin = wkXls.InchesToPoints(0.5) '左邊界
         wkSheet.PageSetup.RightMargin = wkXls.InchesToPoints(0.5) '右邊界
      End If
   End If
   
ErrHand:
   If bolOpenXls = True Then
      '判斷版本
      If Val(wkXls.Version) < 12 Then
         xlsFileName = xlsFileName & ".xls"
         wkXls.Workbooks(1).SaveAs FileName:=xlsFileName, FileFormat:=-4143  '一般活頁簿.xls
      Else
         xlsFileName = xlsFileName & ".xlsx"
         wkXls.Workbooks(1).SaveAs FileName:=xlsFileName, FileFormat:=51  '51:.xlsx/56:Excel 97-2003 活頁簿
      End If
      wkXls.Workbooks.Close
      wkXls.Quit
      Set wkXls = Nothing
      Set wkSheet = Nothing
      If Err.Number = 0 Then
         Set rsQ1 = Nothing
         Set rsQ2 = Nothing
         stSubject = "設定風險檢查對象之潛在客戶已收文列表"
         '寄信給[風險檢查對象可撤銷人員]
         'Modify by Amy 2025/02/26 當天發mail 給電腦中心 ,因之前測式用所以Mark Pub_GetSpecMan,應該發給文雄
         stTO = Pub_GetSpecMan("風險檢查對象可撤銷人員", False)
         If stTO = MsgText(601) Then stTO = Pub_GetSpecMan("程式管理人員", False) & ";A2004"
         tmpnext = "寄信..."
         SendMAPIMail stTO, stSubject & "(詳附件)", vbCrLf & vbCrLf & "***詳情請見附件***" & vbCrLf & vbCrLf, xlsFileName
         Exit Sub
      End If
   End If
   Set rsQ1 = Nothing
   Set rsQ2 = Nothing
   If Err.Number <> 0 Then
      WLog tmpnext & " " & Err.Description
   End If
   
End Sub

'Added by Morgan 2024/1/5
'P/CFP案指定送件日提醒
Private Sub StrMenu128()
   Dim tmpnext As String, stSubject As String, stTO As String
   Dim stDate1 As String, stDate2 As String
   
On Error GoTo ErrHandle

   '判發前，該案指定送件日的前兩個工作日，請再次發信提醒承辦工程師，若是在會稿中，則一併通知智權同仁。
   stDate1 = CompWorkDay(2, strSrvDate(1))
   stDate2 = CompWorkDay(3, strSrvDate(1))
   
   strSql = "select cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) C01,sqldatet(cp142) C02,cp164,cp09,cp13,cp14,ep07,ep08" & _
      " from caseprogress,engineerprogress where cp158=0 and cp159=0 and cp09<'C' and cp01 in ('P','CFP') and cp14 is not null" & _
      " and cp10 not in ('601','605') and cp12 not like 'F%' and cp141='3' and cp164 in ('1','3')" & _
      " and cp142>" & stDate1 & " and cp142<=" & stDate2 & " and ep02(+)=cp09" & _
      " and not exists(select * from EmpElectronProcess where eep01=cp09 and eep04 in('" & EMP_判發 & "','" & EMP_退件重送 & "') and EEP13='Y')" & _
      " order by cp14,cp09"
   intI = 1
   Set RsTemp = ClsLawReadRstMsg(intI, strSql)
   If intI = 1 Then
      tmpnext = "已取得資料..."
      With RsTemp
      .MoveFirst
      Do While Not .EOF
         'Modified by Morgan 2024/9/27 主旨後面加收文號,否則同案有多道程序時會dup
         stSubject = .Fields("C01") & "指定送件日提醒 「本案需於" & .Fields("C02") & IIf(.Fields("cp164") = "3", "之後", "") & "方可送件」，請留意承辦時間！(" & .Fields("cp09") & ")"
         stTO = .Fields("cp14")
         '會稿中:已會稿未會完
         If .Fields("ep07") > 0 And IsNull(.Fields("ep08")) Then
            stTO = stTO & ";" & .Fields("cp13")
         End If
         tmpnext = .Fields("cp09") & "新增郵件暫存..."
         strSql = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc13)" & _
            " values('" & strUserNum & "','" & stTO & "',to_char(sysdate,'yyyymmdd')" & _
            ",to_char(sysdate,'hh24miss'),'" & stSubject & "','" & .Fields("cp09") & "')"
         cnnConnection.Execute strSql, intI
         .MoveNext
      Loop
      End With
      tmpnext = "批次發信..."
      Call PUB_SendMailCache(True)
   End If
   
   Exit Sub
   
ErrHandle:
   WLog tmpnext & " " & Err.Description

End Sub

'Add by Amy 2024/01/31 風險檢查對象延展日前10個工作天通知負責同仁延展
Private Sub StrMenu129()
   Dim RsQ As New ADODB.Recordset, intQ As Integer, stQ As String, jj As Integer, tmpnext As String
   Dim wkXls As New Excel.Application, wkSheet As New Worksheet, stTPFileN(1) As String, stWkName As String, bolOpenXls As Boolean
   Dim intTitleRow As Integer, intRow As Integer, intField As Integer, stData(1) As String, stAllF As String, stAllW As String, arrField() As String, arrWidth() As String
   Dim stDate As String, stRCL22Old As String, stTO As String, stSubject As String, stContext As String
   Dim stCC As String 'Add by Amy 2025/09/04 副本
   
On Error GoTo ErrHand
   stAllF = "風險檢查編號,風險檢查名稱,要求檢查編號,延展期限,已延展次數"
   stAllW = "14,30, 15, 10,11"
   
   stDate = CompWorkDay(10, strSrvDate(1), 0) '後10個工作天=下次提醒日前10個工作天
   stSubject = "原設定風險檢查對象之管制期限將屆，請為後續處理。"
   stContext = "Dear Sirs," & vbCrLf & _
                           "　　您先前設定風險檢查對象將屆三個月之管制期限，若仍有持續管制必要，" & vbCrLf & _
                           "　　請至系統操作延展管制期限，否則前述風險檢查對象將在管制期限屆滿後自動取消設定。" & vbCrLf & vbCrLf & _
                           "電腦中心"
                           
   stQ = "Select RCL01,RCL02,RCL03,RCL04,RCL05,RCL06,RCL07,RCL18,RCL19,RCL20,RCL22" & _
               " From RiskCheckList" & _
               " Where RCL24 is Null And RCL19 = " & stDate & _
               " Order by  RCL22,RCL01"
   intQ = 1
   Set RsQ = ClsLawReadRstMsg(intQ, stQ)
   tmpnext = "已取得資料..."
   If intQ = 1 Then
      stTPFileN(0) = App.path & TextPath & stDate & "風險檢查對象管制期限將屆"
      stTPFileN(1) = stTPFileN(0)
      If Dir(stTPFileN(1) & "*.*") <> MsgText(601) Then
         Kill stTPFileN(1) & "*.*"
      End If
      arrField = Split(stAllF, ",")
      arrWidth = Split(stAllW, ",")
      intField = 65: intRow = 1
      RsQ.MoveFirst
      Do While Not RsQ.EOF
         If stRCL22Old <> MsgText(601) And stRCL22Old <> "" & RsQ.Fields("RCL22") Then
         '*** 依 負責同仁 不同發信 ***'
            '** Excel 最後設定 **
            '抬頭
            With wkSheet.Range(Chr(intField) & intTitleRow & ":" & Chr(UBound(arrField) + intField) & intTitleRow)
               .Font.Name = "標楷體"
               .Font.Size = 12
               .Borders(xlEdgeBottom).LineStyle = xlContinuous
            End With
            '內容 字型大小設定
            With wkSheet.Range(Chr(intField) & intTitleRow + 1 & ":" & Chr(UBound(arrField) + intField) & intRow)
               .Font.Name = "新細明體"
               .Font.Size = 10
            End With
            wkSheet.PageSetup.PaperSize = 9 '設A4
            wkSheet.PageSetup.Orientation = wdOrientLandscape '直印
            wkSheet.PageSetup.PrintTitleRows = "$1:$" & intTitleRow
            wkSheet.PageSetup.TopMargin = wkXls.InchesToPoints(0.5) '上
            wkSheet.PageSetup.BottomMargin = wkXls.InchesToPoints(0.5) '下
            wkSheet.PageSetup.LeftMargin = wkXls.InchesToPoints(0.5) '左邊界
            wkSheet.PageSetup.RightMargin = wkXls.InchesToPoints(0.5) '右邊界
            '** End Excel 最後設定 **
            stTPFileN(1) = stTPFileN(1) & stRCL22Old
            tmpnext = "Excel 存檔..."
            '判斷版本
            If Val(wkXls.Version) < 12 Then
               stTPFileN(1) = stTPFileN(1) & ".xls"
               wkXls.Workbooks(1).SaveAs FileName:=stTPFileN(1), FileFormat:=-4143  '一般活頁簿.xls
            Else
               stTPFileN(1) = stTPFileN(1) & ".xlsx"
               wkXls.Workbooks(1).SaveAs FileName:=stTPFileN(1), FileFormat:=51  '51:.xlsx/56:Excel 97-2003 活頁簿
            End If
            wkXls.Workbooks.Close
            wkXls.Quit
            intRow = 1: intTitleRow = 1
            bolOpenXls = False
            stTO = stRCL22Old
            'Add by Amy 2025/09/04  副本加發 負責同仁 之主管
            stCC = ""
            If stTO = MsgText(601) Then
               stTO = Pub_GetSpecMan("程式管理人員", False)
            Else
               stCC = GetDeptMan(PUB_GetST93(stTO), 2) '以st93抓部門主管
               If stTO = stCC Then stCC = ""
            End If
            'end 2025/09/04
            
            tmpnext = "發信" & stTO
            'Modify by Amy 2025/07/29 改要發職代
            'SendMAPIMail stTO, stSubject, stContext, stTPFileN(1), , True
            'Modify by Amy 2025/09/04 +stCC 副本加發 負責同仁 之主管
            SendMAPIMail stTO, stSubject, stContext, stTPFileN(1), , False, stCC
            stTPFileN(1) = stTPFileN(0)
         '*** End 依 負責同仁不同發信 ***'
         End If
         If bolOpenXls = False Then
         '*** 設定Excel 及 欄位 ***'
            tmpnext = "設定Excel 及 欄位..."
            wkXls.SheetsInNewWorkbook = 3 '預設工作表數目
            wkXls.Workbooks.add
            If stWkName = MsgText(601) Then stWkName = Left(wkXls.Worksheets(1).Name, Len(wkXls.Worksheets(1).Name) - 1)
            Set wkSheet = wkXls.Worksheets(stWkName & "1")
            bolOpenXls = True
            wkSheet.Activate
            wkSheet.Range(Chr(intField) & intRow).Value = "日期：" & CFDate(ACDate(ServerDate)): intRow = intRow + 1
            For jj = LBound(arrField) To UBound(arrField)
               wkSheet.Columns(Chr(intField + jj) & ":" & Chr(intField + jj)).ColumnWidth = Val(arrWidth(jj))
               wkSheet.Range(Chr(intField + jj) & intRow).Value = arrField(jj)
               wkSheet.Range(Chr(intField + jj) & intRow).HorizontalAlignment = xlCenter
            Next jj
            intTitleRow = intRow
            intRow = intRow + 1
         '*** End 設定Excel 及 欄位 ***'
         End If
         '*** Excel 內容 ***
         tmpnext = "已寫入Excel 內容..."
         For jj = LBound(arrField) To UBound(arrField)
            stData(0) = "": stData(1) = ""
            Select Case jj
               Case GetColVal(arrField, "風險檢查編號", 0)
                  stData(0) = "" & RsQ.Fields("RCL01")
                  stData(1) = "@"
               Case GetColVal(arrField, "風險檢查名稱", 0)
                  '中
                  If Not IsNull(RsQ.Fields("RCL02")) Then
                     stData(0) = stData(0) & ";中-" & RsQ.Fields("RCL02")
                  End If
                  '英
                  If Not IsNull(RsQ.Fields("RCL03")) Then
                     stData(0) = stData(0) & ";英-" & RsQ.Fields("RCL03")
                     If Not IsNull(RsQ.Fields("RCL04")) Then
                        stData(0) = stData(0) & " " & RsQ.Fields("RCL04")
                        If Not IsNull(RsQ.Fields("RCL05")) Then
                           stData(0) = stData(0) & " " & RsQ.Fields("RCL05")
                           If Not IsNull(RsQ.Fields("RCL06")) Then
                              stData(0) = stData(0) & " " & RsQ.Fields("RCL06")
                           End If
                        End If
                     End If
                  End If
                  '日
                  If Not IsNull(RsQ.Fields("RCL07")) Then
                     stData(0) = stData(0) & ";日-" & RsQ.Fields("RCL07")
                  End If
                  If stData(0) <> MsgText(601) Then
                     stData(0) = Mid(stData(0), 2)
                  End If
               Case GetColVal(arrField, "要求檢查編號", 0)
                  stData(0) = "" & RsQ.Fields("RCL18")
               Case GetColVal(arrField, "延展期限", 0)
                  stData(0) = "" & RsQ.Fields("RCL19")
                  If stData(0) <> MsgText(601) Then
                     stData(0) = CFDate(TransDate(stData(0), 1))
                  End If
               Case GetColVal(arrField, "已延展次數", 0)
                  stData(0) = "" & RsQ.Fields("RCL20")
            End Select
            If stData(1) <> MsgText(601) Then
               wkSheet.Range(Chr(intField + jj) & intRow).NumberFormatLocal = stData(1)
            End If
            wkSheet.Range(Chr(intField + jj) & intRow).Value = stData(0)
         Next jj
         '*** End Excel 內容 ***
         intRow = intRow + 1 'Add by Amy 2024/04/18
         stRCL22Old = "" & RsQ.Fields("RCL22")
         RsQ.MoveNext
      Loop
      '最後一筆
      If bolOpenXls = True Then
         '** Excel 最後設定 **
         '抬頭
         With wkSheet.Range(Chr(intField) & intTitleRow & ":" & Chr(UBound(arrField) + intField) & intTitleRow)
            .Font.Name = "標楷體"
            .Font.Size = 12
            .Borders(xlEdgeBottom).LineStyle = xlContinuous
         End With
         '內容 字型大小設定
         With wkSheet.Range(Chr(intField) & intTitleRow + 1 & ":" & Chr(UBound(arrField) + intField) & intRow)
            .Font.Name = "新細明體"
            .Font.Size = 10
         End With
         wkSheet.PageSetup.PaperSize = 9 '設A4
         wkSheet.PageSetup.Orientation = wdOrientLandscape '直印
         wkSheet.PageSetup.PrintTitleRows = "$1:$" & intTitleRow
         wkSheet.PageSetup.TopMargin = wkXls.InchesToPoints(0.5) '上
         wkSheet.PageSetup.BottomMargin = wkXls.InchesToPoints(0.5) '下
         wkSheet.PageSetup.LeftMargin = wkXls.InchesToPoints(0.5) '左邊界
         wkSheet.PageSetup.RightMargin = wkXls.InchesToPoints(0.5) '右邊界
         '** End Excel 最後設定 **
         stTPFileN(1) = stTPFileN(1) & stRCL22Old
         tmpnext = "Excel 存檔..."
         '判斷版本
         If Val(wkXls.Version) < 12 Then
            stTPFileN(1) = stTPFileN(1) & ".xls"
            wkXls.Workbooks(1).SaveAs FileName:=stTPFileN(1), FileFormat:=-4143  '一般活頁簿.xls
         Else
            stTPFileN(1) = stTPFileN(1) & ".xlsx"
            wkXls.Workbooks(1).SaveAs FileName:=stTPFileN(1), FileFormat:=51  '51:.xlsx/56:Excel 97-2003 活頁簿
         End If
         wkXls.Workbooks.Close
         wkXls.Quit
         bolOpenXls = False
         stTO = stRCL22Old
         'Add by Amy 2025/09/04  副本加發 負責同仁 之主管
         stCC = ""
         If stTO = MsgText(601) Then
            stTO = Pub_GetSpecMan("程式管理人員", False)
         Else
            stCC = GetDeptMan(PUB_GetST93(stTO), 2) '以st93抓部門主管
            If stTO = stCC Then stCC = ""
         End If
         'end 2025/09/04
         
          tmpnext = "發信" & stTO
          'Modify by Amy 2025/07/29 改要發職代
          'SendMAPIMail stTO, stSubject, stContext, stTPFileN(1), , True
          'Modify by Amy 2025/09/04 +stCC 副本加發 負責同仁 之主管
          SendMAPIMail stTO, stSubject, stContext, stTPFileN(1), , False, stCC
      End If
   End If
   Set RsQ = Nothing
Exit Sub

ErrHand:
   WLog tmpnext & " " & Err.Description
End Sub

'風險檢查對象三個月屆滿取消設定並發信通知負責同仁
Private Sub StrMenu130()
   Dim rsQ1 As New ADODB.Recordset, intQ1 As Integer, stQ1 As String, jj As Integer, stTmp(2) As String, tmpnext As String
   Dim rsQ2 As New ADODB.Recordset, intQ2 As Integer, stQ2 As String, stWhere2(2) As String, stFindTxt As String, stCmd As String
   Dim wkXls As New Excel.Application, wkSheet As New Worksheet, stTPFileN(1) As String, stWkName As String, bolOpenXls As Boolean
   Dim intTitleRow As Integer, intRow As Integer, intField As Integer, stData(1) As String, stAllF As String, stAllW As String, arrField() As String, arrWidth() As String
   Dim stDate As String, stTO As String, stSubject As String, stContext As String
   Dim stCC As String 'Add by Amy 2025/09/04 副本
   
On Error GoTo ErrHand
   intField = 65
   stAllF = "風險檢查編號,風險檢查名稱,要求檢查編號,延展期限,已延展次數"
   stAllW = "12,30,13,12,10"
   stSubject = "原設定風險檢查對象已取消，請知悉。"
   stContext = "Dear Sirs," & vbCrLf & _
                           "　　您先前設定風險檢查對象已逾三個月之管制期限且未進行延展，" & vbCrLf & _
                           "　　故已自動取消該風險檢查對象設定。" & vbCrLf & vbCrLf & _
                           "電腦中心"
   
   '刪除暫存檔資料
   stCmd = "Delete From RADB127 Where State ='3' "
   cnnConnection.Execute stCmd
   
   stDate = CompWorkDay(2, strSrvDate(1), 1) '前1個工作天
   '前1個工作天延展到期且未撤銷資料且要求檢查編號不是R
   'Memo 國外R編號在收文前會先轉成X或Y,國內會於收文時檢查名稱相同發信給Sindy轉客戶(若當天沒轉客戶R 編號會檢查不到)
   '             但隔天 風險檢查對象可撤銷人員 會收到已收文的信,由 風險檢查對象可撤銷人員 控管是否上撤銷
   stQ1 = "Select RCL01,RCL17,RCL18,RCL21,RCL22,RCL27,RCL28,RCL33,RCL34,RCL35" & _
               " From RiskCheckList Where RCL24 is Null And RCL19 = " & stDate & " And SubStr(RCL18,1,1)<>'R'" & _
               " Order by RCL18 Desc "
   intQ1 = 1
   Set rsQ1 = ClsLawReadRstMsg(intQ1, stQ1)
   tmpnext = "已取得資料..."
   If intQ1 = 1 Then
      '未收文且未取消設定 or 已收文未設對造 (轉不得代理會上撤銷日,故不需判斷)
      rsQ1.MoveFirst
      Do While Not rsQ1.EOF
         stWhere2(1) = ""
         'stWhere2(0) = " And CP05>20240101 " '測式用
         stWhere2(0) = " And CP05>" & rsQ1.Fields("RCL28") & " "
         '統編
         If "" & rsQ1.Fields("RCL17") <> MsgText(601) Then
            stWhere2(0) = stWhere2(0) & " And (Instr('☆'||CP175||'☆','☆" & rsQ1.Fields("RCL17") & "☆')>0 Or CP175 is Null) "
         End If
         If Left(rsQ1.Fields("RCL18"), 1) = 客戶編號 Then
            stWhere2(2) = "And (" & _
               "SubStr(Decode(pa26,null,Decode(tm23,null,Decode(lc11,null,Decode(sp08,null,Decode(hc05,null,pa26,hc05),sp08),lc11),tm23),pa26),1,8) ='XXX' " & _
               "Or SubStr(Decode(pa27,null,Decode(tm78,null,Decode(lc43,null,Decode(sp58,null,Decode(hc24,null,pa27,hc24),sp58),lc43),tm78),pa27),1,8) ='XXX' " & _
               "Or SubStr(Decode(pa28,null,Decode(tm79,null,Decode(lc44,null,Decode(sp59,null,Decode(hc25,null,pa28,hc25),sp59),lc44),tm79),pa28),1,8) ='XXX' " & _
               "Or SubStr(Decode(pa29,null,Decode(tm80,null,Decode(lc45,null,Decode(sp65,null,Decode(hc26,null,pa29,hc26),sp65),lc45),tm80),pa29),1,8) ='XXX' " & _
               "Or SubStr(Decode(pa30,null,Decode(tm81,null,Decode(lc46,null,Decode(sp66,null,Decode(hc27,null,pa30,hc27),sp66),lc46),tm81),pa30),1,8) ='XXX' " & _
            ")"
         ElseIf Left(rsQ1.Fields("RCL18"), 1) = 代理人編號 Then
            stWhere2(2) = "And SubStr(Decode(pa75,null,Decode(tm44,null,Decode(lc22,null,Decode(sp26,null,'',sp26),lc22),tm44),pa75),1,8) ='XXX' "
         End If
         If InStr(stWhere2(2), "'XXX'") > 0 Then
            stWhere2(2) = Replace(stWhere2(2), "'XXX'", "'" & rsQ1.Fields("RCL18") & "'")
         End If
         
         For jj = 1 To 3
            Select Case jj
               Case 1
                  stFindTxt = "" & rsQ1.Fields("RCL33")
               Case 2
                  stFindTxt = "" & rsQ1.Fields("RCL34")
               Case 3
                  stFindTxt = "" & rsQ1.Fields("RCL35")
            End Select
            
            If stFindTxt <> MsgText(601) Then
               stWhere2(1) = stWhere2(1) & "Or Instr('☆'||CP169||'☆'||CP170||'☆'||CP171||'☆','☆" & stFindTxt & "☆')>0 "
            End If
         Next jj
         If stWhere2(1) <> MsgText(601) Then
            stWhere2(1) = "And (" & Mid(stWhere2(1), 3) & ")"
         End If
         stQ2 = GetCPForRiskCheckSql("StrMenu130", stWhere2(0) & stWhere2(1), stWhere2(2))
         intQ2 = 1
         Set rsQ2 = ClsLawReadRstMsg(intQ2, stQ2)
         tmpnext = "確認收文資料(編號:" & rsQ1.Fields("RCL01") & ")..."
         '未收文(風險檢查編號+名稱(+統編)沒收文資料)
         If intQ2 = 0 Then
            'Memo Excel 以[負責同仁]排序發信,先寫入暫存檔
            '                  要求檢查對象                             風險檢查編號                                部門                                                智權人員
            stCmd = ",'" & rsQ1.Fields("RCL18") & "','" & rsQ1.Fields("RCL01") & "','" & rsQ1.Fields("RCL21") & "','" & rsQ1.Fields("RCL22") & "'"
            stCmd = "insert into RADB127 (State,R05,R20,R07,R08) Values('3'" & stCmd & ")"
            tmpnext = "未收文編號寫入暫存檔(風險No:" & rsQ1.Fields("RCL01") & ")..."
            cnnConnection.Execute stCmd
         End If
         rsQ1.MoveNext
      Loop
   End If
   '取得暫存檔資料,因中/英/日都檢查,故抓暫存檔資料後更後風險檢查撤銷欄位及發信給負責同仁
   stQ1 = "Select Distinct R20 as RCL01,R08 as RCL22 From RADB127 Where State='3' Order by R08,R20 "
   intQ1 = 1
   Set rsQ1 = ClsLawReadRstMsg(intQ1, stQ1)
   tmpnext = "取得暫存檔資料..."
   If intQ1 = 1 Then
      stTPFileN(0) = App.path & TextPath & stDate & "風險檢查對象已取消"
      stTPFileN(1) = stTPFileN(0)
      If Dir(stTPFileN(1) & "*.*") <> MsgText(601) Then
         Kill stTPFileN(1) & "*.*"
      End If
      arrField = Split(stAllF, ",")
      arrWidth = Split(stAllW, ",")
      stTmp(0) = "": intRow = 1: intTitleRow = 1
      rsQ1.MoveFirst
      Do While Not rsQ1.EOF
         If stTmp(0) <> MsgText(601) And stTmp(0) <> "" & rsQ1.Fields("RCL22") Then
         '*** 依負責同仁不同發信 ***'
            '** Excel 最後設定 **
            '抬頭
            With wkSheet.Range(Chr(intField) & intTitleRow & ":" & Chr(UBound(arrField) + intField) & intTitleRow)
               .Font.Name = "標楷體"
               .Font.Size = 12
               .Borders(xlEdgeBottom).LineStyle = xlContinuous
            End With
            '內容 字型大小設定
            With wkSheet.Range(Chr(intField) & intTitleRow + 1 & ":" & Chr(UBound(arrField) + intField) & intRow)
               .Font.Name = "新細明體"
               .Font.Size = 10
            End With
            wkSheet.PageSetup.PaperSize = 9 '設A4
            wkSheet.PageSetup.Orientation = wdOrientLandscape '直印
            wkSheet.PageSetup.PrintTitleRows = "$1:$" & intTitleRow
            wkSheet.PageSetup.TopMargin = wkXls.InchesToPoints(0.5) '上
            wkSheet.PageSetup.BottomMargin = wkXls.InchesToPoints(0.5) '下
            wkSheet.PageSetup.LeftMargin = wkXls.InchesToPoints(0.5) '左邊界
            wkSheet.PageSetup.RightMargin = wkXls.InchesToPoints(0.5) '右邊界
            '** End Excel 最後設定 **
            stTPFileN(1) = stTPFileN(1) & stTmp(0)
            tmpnext = "Excel 存檔..."
            '判斷版本
            If Val(wkXls.Version) < 12 Then
               stTPFileN(1) = stTPFileN(1) & ".xls"
               wkXls.Workbooks(1).SaveAs FileName:=stTPFileN(1), FileFormat:=-4143  '一般活頁簿.xls
            Else
               stTPFileN(1) = stTPFileN(1) & ".xlsx"
               wkXls.Workbooks(1).SaveAs FileName:=stTPFileN(1), FileFormat:=51  '51:.xlsx/56:Excel 97-2003 活頁簿
            End If
            wkXls.Workbooks.Close
            wkXls.Quit
            intRow = 1: intTitleRow = 1
            bolOpenXls = False
            stTO = stTmp(0)
            'Add by Amy 2025/09/04  副本加發 負責同仁 之主管
            stCC = ""
            If stTO = MsgText(601) Then
               stTO = Pub_GetSpecMan("程式管理人員", False)
            Else
               stCC = GetDeptMan(PUB_GetST93(stTO), 2) '以st93抓部門主管
               If stTO = stCC Then stCC = ""
            End If
            'end 2025/09/04
            
            tmpnext = "發信" & stTO
            'Modify by Amy 2025/07/29 改要發職代
            'SendMAPIMail stTO, stSubject, stContext, stTPFileN(1), , True
            'Modify by Amy 2025/09/04 +stCC 副本加發 負責同仁 之主管
            SendMAPIMail stTO, stSubject, stContext, stTPFileN(1), , False, stCC
            stTPFileN(1) = stTPFileN(0)
         '*** End 依負責同仁不同發信 ***'
         End If
         If bolOpenXls = False Then
         '*** 設定Excel 及 欄位 ***'
            tmpnext = "設定Excel 及 欄位..."
            wkXls.SheetsInNewWorkbook = 3 '預設工作表數目
            wkXls.Workbooks.add
            If stWkName = MsgText(601) Then stWkName = Left(wkXls.Worksheets(1).Name, Len(wkXls.Worksheets(1).Name) - 1)
            Set wkSheet = wkXls.Worksheets(stWkName & "1")
            bolOpenXls = True
            wkSheet.Activate
            wkSheet.Range(Chr(intField) & intRow).Value = "日期：" & CFDate(ACDate(ServerDate)): intRow = intRow + 1
            For jj = LBound(arrField) To UBound(arrField)
               wkSheet.Columns(Chr(intField + jj) & ":" & Chr(intField + jj)).ColumnWidth = Val(arrWidth(jj))
               wkSheet.Range(Chr(intField + jj) & intRow).Value = arrField(jj)
               wkSheet.Range(Chr(intField + jj) & intRow).HorizontalAlignment = xlCenter
            Next jj
            intTitleRow = intRow
            intRow = intRow + 1
         '*** End 設定Excel 及 欄位 ***'
         End If
         '*** 更新資料 ***
         stCmd = "Update RiskCheckList Set RCL24=" & strSrvDate(1) & ",RCL25='逾管制期限未收文',RCL26='QPGMR' " & _
                           " Where RCL01='" & rsQ1.Fields("RCL01") & "'"
         tmpnext = "更新撤銷欄位(編號:" & rsQ1.Fields("RCL01") & ")..."
         cnnConnection.Execute stCmd
         '*** End 更新資料 ***
         '*** 讀取風險檢查對象資料 ***
         stQ2 = "Select * From RiskCheckList Where RCL01='" & rsQ1.Fields("RCL01") & "' "
         intQ2 = 1
         Set rsQ2 = ClsLawReadRstMsg(intQ2, stQ2)
         If intQ2 > 0 Then
            rsQ2.MoveFirst
            Do While Not rsQ2.EOF
               '*** Excel 內容 ***
               tmpnext = "已寫入Excel 內容..."
               For jj = LBound(arrField) To UBound(arrField)
                  stData(0) = "": stData(1) = ""
                  Select Case jj
                     Case GetColVal(arrField, "風險檢查編號", 0)
                        stData(0) = "" & rsQ2.Fields("RCL01")
                        stData(1) = "@"
                     Case GetColVal(arrField, "風險檢查名稱", 0)
                        '中
                        If Not IsNull(rsQ2.Fields("RCL02")) Then
                           stData(0) = stData(0) & ";中-" & rsQ2.Fields("RCL02")
                        End If
                        '英
                        If Not IsNull(rsQ2.Fields("RCL03")) Then
                           stData(0) = stData(0) & ";英-" & rsQ2.Fields("RCL03")
                           If Not IsNull(rsQ2.Fields("RCL04")) Then
                              stData(0) = stData(0) & " " & rsQ2.Fields("RCL04")
                              If Not IsNull(rsQ2.Fields("RCL05")) Then
                                 stData(0) = stData(0) & " " & rsQ2.Fields("RCL05")
                                 If Not IsNull(rsQ2.Fields("RCL06")) Then
                                    stData(0) = stData(0) & " " & rsQ2.Fields("RCL06")
                                 End If
                              End If
                           End If
                        End If
                        '日
                        If Not IsNull(rsQ2.Fields("RCL07")) Then
                           stData(0) = stData(0) & ";日-" & rsQ2.Fields("RCL07")
                        End If
                        If stData(0) <> MsgText(601) Then
                           stData(0) = Mid(stData(0), 2)
                        End If
                     Case GetColVal(arrField, "要求檢查編號", 0)
                        stData(0) = "" & rsQ2.Fields("RCL18")
                     Case GetColVal(arrField, "延展期限", 0)
                        stData(0) = "" & rsQ2.Fields("RCL19")
                        If stData(0) <> MsgText(601) Then
                           stData(0) = CFDate(TransDate(stData(0), 1))
                        End If
                     Case GetColVal(arrField, "已延展次數", 0)
                        stData(0) = "" & rsQ2.Fields("RCL20")
                  End Select
                  If stData(1) <> MsgText(601) Then
                     wkSheet.Range(Chr(intField + jj) & intRow).NumberFormatLocal = stData(1)
                  End If
                  wkSheet.Range(Chr(intField + jj) & intRow).Value = stData(0)
               Next
               intRow = intRow + 1
               rsQ2.MoveNext
            Loop
         End If
         '*** End 讀取風險檢查對象資料 ***
         
         stTmp(0) = rsQ1.Fields("RCL22")
         rsQ1.MoveNext
      Loop
      '最後一筆
      If bolOpenXls = True Then
         '** Excel 最後設定 **
         '抬頭
         With wkSheet.Range(Chr(intField) & intTitleRow & ":" & Chr(UBound(arrField) + intField) & intTitleRow)
            .Font.Name = "標楷體"
            .Font.Size = 12
            .Borders(xlEdgeBottom).LineStyle = xlContinuous
         End With
         '內容 字型大小設定
         With wkSheet.Range(Chr(intField) & intTitleRow + 1 & ":" & Chr(UBound(arrField) + intField) & intRow)
            .Font.Name = "新細明體"
            .Font.Size = 10
         End With
         wkSheet.PageSetup.PaperSize = 9 '設A4
         wkSheet.PageSetup.Orientation = wdOrientLandscape '直印
         wkSheet.PageSetup.PrintTitleRows = "$1:$" & intTitleRow
         wkSheet.PageSetup.TopMargin = wkXls.InchesToPoints(0.5) '上
         wkSheet.PageSetup.BottomMargin = wkXls.InchesToPoints(0.5) '下
         wkSheet.PageSetup.LeftMargin = wkXls.InchesToPoints(0.5) '左邊界
         wkSheet.PageSetup.RightMargin = wkXls.InchesToPoints(0.5) '右邊界
         '** End Excel 最後設定 **
         stTPFileN(1) = stTPFileN(1) & stTmp(0)
         tmpnext = "Excel 存檔..."
         '判斷版本
         If Val(wkXls.Version) < 12 Then
            stTPFileN(1) = stTPFileN(1) & ".xls"
            wkXls.Workbooks(1).SaveAs FileName:=stTPFileN(1), FileFormat:=-4143  '一般活頁簿.xls
         Else
            stTPFileN(1) = stTPFileN(1) & ".xlsx"
            wkXls.Workbooks(1).SaveAs FileName:=stTPFileN(1), FileFormat:=51  '51:.xlsx/56:Excel 97-2003 活頁簿
         End If
         wkXls.Workbooks.Close
         wkXls.Quit
         bolOpenXls = False
         stTO = stTmp(0)
         'Add by Amy 2025/09/04  副本加發 負責同仁 之主管
         stCC = ""
         If stTO = MsgText(601) Then
            stTO = Pub_GetSpecMan("程式管理人員", False)
         Else
            stCC = GetDeptMan(PUB_GetST93(stTO), 2) '以st93抓部門主管
            If stTO = stCC Then stCC = ""
         End If
         'end 2025/09/04
         
         tmpnext = "發信" & stTO
         'Modify by Amy 2025/07/29 改要發職代
         'SendMAPIMail stTO, stSubject, stContext, stTPFileN(1), , True
         'Modify by Amy 2025/09/04 +stCC 副本加發 負責同仁 之主管
         SendMAPIMail stTO, stSubject, stContext, stTPFileN(1), , False, stCC
      End If
   End If
   
Exit Sub

ErrHand:
   WLog tmpnext & " " & Err.Description
End Sub

'傳入風險檢查資料,取得收文語法
Private Function GetCPForRiskCheckSql(stMenu As String, stCon1 As String, Optional ByVal stCon2 As String = "") As String
   Dim sta As String, stField As String, stDate As String, stWhere(1 To 2) As String, stPCPM As String, stTCPM As String
   
   GetCPForRiskCheckSql = ""
   
   Select Case UCase(stMenu)
      Case UCase("StrMenu127")
         stField = "CP01,CP02,CP03,CP04,CP09,CP10,CP12,CP13,CP169,CP170,CP171,CP175"
      Case UCase("StrMenu130")
        stField = "CP01,CP02,CP03,CP04,CP09,CP10,CP12,CP13,CP40,CP41,CP42,CP175"
   End Select
   If stCon1 <> MsgText(601) Then
      stWhere(1) = stWhere(1) & stCon1
   End If
   If stCon2 <> MsgText(601) Then
      stWhere(2) = stWhere(2) & stCon2
   End If
   
   Call ChkRiskData(1.1, "AutoBatchDay-" & stMenu, "P", , , stPCPM)
   Call ChkRiskData(1.1, "AutoBatchDay-" & stMenu, "T", , , stTCPM)
   
   sta = "Select " & stField & " " & _
                  ",Decode(pa26,null,Decode(tm23,null,Decode(lc11,null,Decode(sp08,null,Decode(hc05,null,pa26,hc05),sp08),lc11),tm23),pa26) as apply1" & _
                  ",Decode(pa27,null,Decode(tm78,null,Decode(lc43,null,Decode(sp58,null,Decode(hc24,null,pa27,hc24),sp58),lc43),tm78),pa27) as apply2" & _
                  ",Decode(pa28,null,Decode(tm79,null,Decode(lc44,null,Decode(sp59,null,Decode(hc25,null,pa28,hc25),sp59),lc44),tm79),pa28) as apply3" & _
                  ",Decode(pa29,null,Decode(tm80,null,Decode(lc45,null,Decode(sp65,null,Decode(hc26,null,pa29,hc26),sp65),lc45),tm80),pa29) as apply4" & _
                  ",Decode(pa30,null,Decode(tm81,null,Decode(lc46,null,Decode(sp66,null,Decode(hc27,null,pa30,hc27),sp66),lc46),tm81),pa30) as Apply5" & _
                  ",Decode(pa26,null,Decode(tm23,null,Decode(lc11,null,sp09,lc15),tm10),pa09) as Nation" & _
                  ",Decode(pa75,null,Decode(tm44,null,Decode(lc22,null,Decode(sp26,null,'',sp26),lc22),tm44),pa75) as FCAgent" & _
            " From Patent,Trademark,LawCase,ServicePractice,HireCase" & _
            ",(Select " & stField & " From CaseProgress " & _
                  " Where CP01||CP10 in('" & Replace(stPCPM & "," & stTCPM, ",", "','") & "') And CP09<'B' And CP40||CP41||CP42 is not null " & stWhere(1) & _
            " ) Where cp01=pa01(+) And cp02=pa02(+) And cp03=pa03(+) And cp04=pa04(+) And cp01=tm01(+) And cp02=tm02(+) And cp03=tm03(+) And cp04=tm04(+) " & _
               " And cp01=lc01(+) And cp02=lc02(+) And cp03=lc03(+) And cp04=lc04(+) And cp01=sp01(+) And cp02=sp02(+) And cp03=sp03(+) And cp04=sp04(+) " & _
               " And cp01=hc01(+) And cp02=hc02(+) And cp03=hc03(+) And cp04=hc04(+) " & stWhere(2)

   GetCPForRiskCheckSql = sta
End Function
     
'Added by Lydia 2024/03/12 外商程序組每月工作報告表:每月第1個工作天執行
Private Sub StrMenu131()
Dim rsQD As New ADODB.Recordset
Dim intQ As Integer, strQ1 As String, strQ2 As String
Dim strCon1 As String, intP As Integer
Dim strDate1 As String, StrDate2 As String, strBDate1 As String, strBDate2 As String
Dim strUserList As String, strUL() As String
Dim strPID As String, strDCol As String, strGrp As String
Dim nRows As Integer
Dim xlsRpt131 As New Excel.Application
Dim WksRpt131 As New Worksheet
Dim xlsFileName1 As String
Dim strSubT As Variant, tmpArray As Variant
Dim strSub As String, strCont As String

On Err GoTo ErrHandle
   
   '附件名稱
   xlsFileName1 = "*外商程序組每月工作報告表.xls"
   If Dir(App.path & TextPath & xlsFileName1) <> "" Then
      Kill App.path & TextPath & xlsFileName1
   End If
   xlsFileName1 = Mid(xlsFileName1, 2)

   '統計本期
   strDate1 = Left(CompDate(1, -1, strSrvDate(1)), 6) & "01"
   StrDate2 = CompDate(2, -1, Left(strSrvDate(1), 6) & "01")
   '前期比較
   strBDate1 = CompDate(1, -1, strDate1)
   strBDate2 = CompDate(2, -1, strDate1)
   
   '程序人員清單
   strUserList = "R02007-79020,R02008-81011,R02009-B0013"
   strUL = Split(strUserList, ",")
   strPID = "QPGMR"
   strDCol = "R02010" '暫存檔的合計欄
   
   cnnConnection.Execute "DELETE FROM R100105 where id='" & strPID & "' "
   cnnConnection.Execute "DELETE FROM R100105_1 where id='" & strPID & "' "

   strCon1 = "insert into r100105 (id,r02001,r02002,r02006) "
   cnnConnection.Execute strCon1 & " select '" & strPID & "' AS ID, '1-00','※向智慧局發文件數','TOT' as cp10 from dual "
   cnnConnection.Execute strCon1 & " select '" & strPID & "' AS ID, '1-01','申請','101' as cp10 from dual "
   cnnConnection.Execute Replace(strCon1, "100105", "100105_1") & " select '" & strPID & "' AS ID, '1-01','申請','101' as cp10 from dual " '另存商品類別
   cnnConnection.Execute strCon1 & " select '" & strPID & "' AS ID, '1-02','主張優先權','108' as cp10 from dual "
   cnnConnection.Execute strCon1 & " select '" & strPID & "' AS ID, '1-03','延展','102' as cp10 from dual "
   cnnConnection.Execute strCon1 & " select '" & strPID & "' AS ID, '1-04','補正','201' as cp10 from dual "
   cnnConnection.Execute strCon1 & " select '" & strPID & "' AS ID, '1-05','申請意見書','202' as cp10 from dual "
   cnnConnection.Execute strCon1 & " select '" & strPID & "' AS ID, '1-06','補優先權證明','208' as cp10 from dual "
   cnnConnection.Execute strCon1 & " select '" & strPID & "' AS ID, '1-07','變更','301' as cp10 from dual "
   cnnConnection.Execute strCon1 & " select '" & strPID & "' AS ID, '1-08','更正','302' as cp10 from dual "
   cnnConnection.Execute strCon1 & " select '" & strPID & "' AS ID, '1-09','延期','303' as cp10 from dual "
   cnnConnection.Execute strCon1 & " select '" & strPID & "' AS ID, '1-10','自請撤回','306' as cp10 from dual "
   cnnConnection.Execute strCon1 & " select '" & strPID & "' AS ID, '1-11','自請拋棄商標權','307' as cp10 from dual "
   cnnConnection.Execute strCon1 & " select '" & strPID & "' AS ID, '1-12','分割','308' as cp10 from dual "
   cnnConnection.Execute strCon1 & " select '" & strPID & "' AS ID, '1-13','移轉','501' as cp10 from dual "
   cnnConnection.Execute strCon1 & " select '" & strPID & "' AS ID, '1-14','註冊費','717' as cp10 from dual "
   cnnConnection.Execute strCon1 & " select '" & strPID & "' AS ID, '1-15','本月合計','TOT' as cp10 from dual "
   cnnConnection.Execute strCon1 & " select '" & strPID & "' AS ID, '1-16','上月合計','TOT' as cp10 from dual "
   Call StrMenu131_Sub1(strPID, "1", strUserList, strUL, strDate1, StrDate2, strBDate1, strBDate2)
   
   '查名件數(FCT+S案的001查名)
   strCon1 = "insert into r100105 (id,r02001,r02002,r02006) "
   cnnConnection.Execute strCon1 & " select '" & strPID & "' AS ID, '2-00','※查名件數','TOT' as cp10 from dual "
   cnnConnection.Execute strCon1 & " select '" & strPID & "' AS ID, '2-01','本月件數(類別數)','001' as cp10 from dual "
   cnnConnection.Execute Replace(strCon1, "100105", "100105_1") & " select '" & strPID & "' AS ID, '2-01','本月件數(類別數)','001' as cp10 from dual "  '另存商品類別
   cnnConnection.Execute strCon1 & " select '" & strPID & "' AS ID, '2-02','上月件數(類別數)','001' as cp10 from dual "
   cnnConnection.Execute Replace(strCon1, "100105", "100105_1") & " select '" & strPID & "' AS ID, '2-02','上月件數(類別數)','001' as cp10 from dual "  '另存商品類別
   Call StrMenu131_Sub1(strPID, "2", strUserList, strUL, strDate1, StrDate2, strBDate1, strBDate2)
   
   '發文點數
   strCon1 = "insert into r100105 (id,r02001,r02002,r02006) "
   cnnConnection.Execute strCon1 & " select '" & strPID & "' AS ID, '3-00','※發文點數','TOT' as cp10 from dual "
   cnnConnection.Execute strCon1 & " select '" & strPID & "' AS ID, '3-01','本月合計','001' as cp10 from dual "
   cnnConnection.Execute strCon1 & " select '" & strPID & "' AS ID, '3-02','上月合計','001' as cp10 from dual "
   Call StrMenu131_Sub1(strPID, "3", strUserList, strUL, strDate1, StrDate2, strBDate1, strBDate2)
   
   '其他 1：C類來函-發文
   strCon1 = "insert into r100105 (id,r02001,r02002,r02006) "
   cnnConnection.Execute strCon1 & " select '" & strPID & "' AS ID, '4-00','※其他','TOT' as cp10 from dual "
   cnnConnection.Execute strCon1 & " select '" & strPID & "' AS ID, '4-01','核准','1001' as cp10 from dual "
   cnnConnection.Execute strCon1 & " select '" & strPID & "' AS ID, '4-02','註冊證','1701' as cp10 from dual "
   cnnConnection.Execute strCon1 & " select '" & strPID & "' AS ID, '4-11','本所通知延展','1717' as cp10 from dual "
   cnnConnection.Execute strCon1 & " select '" & strPID & "' AS ID, '4-12','本所再通知延展','1722' as cp10 from dual "
   cnnConnection.Execute strCon1 & " select '" & strPID & "' AS ID, '4-13','回代收文','720' as cp10 from dual "
   cnnConnection.Execute strCon1 & " select '" & strPID & "' AS ID, '4-14','告代收文','719' as cp10 from dual "
   cnnConnection.Execute strCon1 & " select '" & strPID & "' AS ID, '4-23','本月合計','TOT' as cp10 from dual "
   cnnConnection.Execute strCon1 & " select '" & strPID & "' AS ID, '4-24','上月合計','TOT' as cp10 from dual "
   Call StrMenu131_Sub1(strPID, "4", strUserList, strUL, strDate1, StrDate2, strBDate1, strBDate2)

   'CFT
   strCon1 = "insert into r100105 (id,r02001,r02002,r02006) "
   cnnConnection.Execute strCon1 & " select '" & strPID & "' AS ID, '6-00','※CFT','TOT' as cp10 from dual "
   'Modified by Lydia 2024/05/08 拿掉TOT=>AAA, 列入加總
   'cnnConnection.Execute strCon1 & " select '" & strPID & "' AS ID, '6-01','新案立卷','TOT' as cp10 from dual "
   cnnConnection.Execute strCon1 & " select '" & strPID & "' AS ID, '6-01','新案立卷','AAA' as cp10 from dual "
   cnnConnection.Execute strCon1 & " select '" & strPID & "' AS ID, '6-02','申請英文證明','304' as cp10 from dual "
   cnnConnection.Execute strCon1 & " select '" & strPID & "' AS ID, '6-03','本月合計','TOT' as cp10 from dual "
   cnnConnection.Execute strCon1 & " select '" & strPID & "' AS ID, '6-04','上月合計','TOT' as cp10 from dual "
   '---新案立卷>>直接放在合計欄和標題
   '參考frm100105_2判斷中間新案的條件
   strQ2 = "decode(CP31,'Y',decode(instr('CFT,FCT,T,TF',CP01),0,decode(instr('CFP,FCP,P',CP01),0,'',decode(instr('" & NewCasePtyList & ",801,803',CP10),0,'Y','')),decode(instr('101,308,601,603,605,618',CP10),0,'Y','')),'') "
   strCon1 = "select count(*) cnt from (select cp10,cp09," & strQ2 & " as nyt From caseprogress, trademark " & _
             "where cp01='CFT' and cp05>=BDATE1 and cp05<=BDATE2 and cp159=0 and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+) " & _
             "and tm29||tm57 is null ) where cp10='101' or nyt='Y' "
   strQ1 = Replace(Replace(strCon1, "BDATE1", strDate1), "BDATE2", StrDate2)
   intQ = 1
   Set rsQD = ClsLawReadRstMsg(intQ, strQ1)
   If intQ = 1 Then
      strQ1 = ""
      For intP = 0 To UBound(strUL)
         'Added by Lydia 2024/05/08 新案立卷放在第1欄人員
         If intP = 0 Then
             strQ1 = strQ1 & "," & Left(Trim(strUL(intP)), 6) & "='" & rsQD.Fields("cnt") & "'"
         Else
         'end 2024/05/08
             strQ1 = strQ1 & "," & Left(Trim(strUL(intP)), 6) & "='-'"
         End If
      Next intP
      strSql = "Update R100105 Set " & strDCol & "='" & rsQD.Fields("cnt") & "'" & strQ1 & " where id='" & strPID & "' and r02001='6-01' "
      cnnConnection.Execute strSql
      '本月合計
      'Mark by Lydia 2024/05/08 新案立卷放在第1欄人員>>列入StrMenu131_Sub1合計
      'strSql = "Update R100105 Set " & strDCol & "='" & rsQD.Fields("cnt") & "' where id='" & strPID & "' and r02001 like '6-%' and r02002='本月合計' "
      'cnnConnection.Execute strSql
      'end 2024/05/08
   End If
   Call StrMenu131_Sub1(strPID, "6", strUserList, strUL, strDate1, StrDate2, strBDate1, strBDate2)
   '--上月合計 'Move by Lydida 2024/05/08 從StrMenu131_Sub1上方移過來
   strQ1 = Replace(Replace(strCon1, "BDATE1", strBDate1), "BDATE2", strBDate2)
   intQ = 1
   Set rsQD = ClsLawReadRstMsg(intQ, strQ1)
   If intQ = 1 Then
      'Modified by Lydia 2024/05/08
      'strSql = "Update R100105 Set " & strDCol & "='" & rsQD.Fields("cnt") & "' where id='" & strPID & "' and r02001 like '6-%' and r02002='上月合計' "
      strSql = "Update R100105 Set " & Left(Trim(strUL(0)), 6) & "=nvl(" & Left(Trim(strUL(0)), 6) & ",0)+" & rsQD.Fields("cnt") & " where id='" & strPID & "' and r02001 like '6-%' and r02002='上月合計' "
      cnnConnection.Execute strSql
   End If
   
   
JumpToExcel:
   '清除沒有件數的資料
   strCon1 = ""
   For intQ = 0 To UBound(strUL)
      strCon1 = strCon1 & "," & Left(strUL(intQ), 7) & GetStaffName(Mid(strUL(intQ), 8), True)
   Next intQ
   strCon1 = Mid(strCon1, 2) & "," & strDCol & "-合　計"
   strUL = Split(strCon1, ",") '改成DB欄位+承辦人名稱
   ReDim strSubT(0 To UBound(strUL))  '合計暫存
   ReDim tmpArray(0 To UBound(strUL) + 1)
   strDCol = Chr(66 + UBound(strUL))
   
   strCon1 = "": strQ1 = ""
   For intQ = 0 To UBound(strUL)
      strCon1 = strCon1 & ", sum(nvl(" & Left(strUL(intQ), 6) & ",0)) as " & Left(strUL(intQ), 6)
      strQ1 = strQ1 & "+" & Left(strUL(intQ), 6)
   Next intQ
   strSql = "select * from (select substr(r02001,1,1) t01 " & strCon1 & _
            " from R100105 where id = '" & strPID & "' and r02002 like '%月合計' group by substr(r02001,1,1) " & _
            ") where " & Mid(strQ1, 2) & "=0 "
   intQ = 1
   Set rsQD = ClsLawReadRstMsg(intQ, strSql)
   If intQ = 1 Then
      rsQD.MoveFirst
      Do While Not rsQD.EOF
         cnnConnection.Execute "delete from r100105 where id = '" & strPID & "' and substr(r02001,1,1)='" & rsQD.Fields("t01") & "' "
         cnnConnection.Execute "delete from r100105_1 where id = '" & strPID & "' and substr(r02001,1,1)='" & rsQD.Fields("t01") & "' "
      Loop
   End If
   
   '產生Excel檔
   strCon1 = ""
   For intQ = 0 To UBound(strUL)
      strCon1 = strCon1 & "," & Left(strUL(intQ), 6)
   Next intQ

   strQ1 = "select '1' as ord1,R02001,R02002" & strCon1 & " from R100105 where id ='" & strPID & "' " & _
           "union select '2' as ord1,R02001,R02002" & strCon1 & " from R100105_1 where id ='" & strPID & "' " & _
           "order by R02001, ord1 "
   intQ = 1
   Set rsQD = ClsLawReadRstMsg(intQ, strQ1)
   If intQ = 1 Then
      rsQD.MoveFirst
      Do While Not rsQD.EOF
         If nRows = 0 Then
            xlsRpt131.SheetsInNewWorkbook = 1 '預設工作表數目
            xlsRpt131.Workbooks.add
            xlsRpt131.Application.WindowState = xlMinimized
            xlsRpt131.Application.Visible = True
            nRows = nRows + 1
            Set WksRpt131 = xlsRpt131.Worksheets(1)
            strSub = Mid(strDate1, 1, 4) - 1911 & "年" & Mid(strDate1, 5, 2) & "月" & Mid(xlsFileName1, 1, InStr(xlsFileName1, ".") - 1)
            xlsFileName1 = Mid(strDate1, 1, 4) - 1911 & "年" & Mid(strDate1, 5, 2) & "月" & xlsFileName1
            WksRpt131.Range("A" & nRows).Value = strSub
            nRows = nRows + 1
         End If

         '統計種類
         If Left(strGrp, 1) <> Left("" & rsQD.Fields("r02001"), 1) Then
            If strGrp <> "" Then
               nRows = nRows + 1
            End If
            strCon1 = ""
            If Left("" & rsQD.Fields("r02001"), 1) = "1" Then
               strCon1 = "FCT"
            ElseIf Left("" & rsQD.Fields("r02001"), 1) = "6" Then
               strCon1 = "CFT"
            End If
            If strCon1 <> "" Then
               WksRpt131.Range("A" & nRows).Value = strCon1
               WksRpt131.Range("A" & nRows).Font.Bold = True
               WksRpt131.Range("A" & nRows).Font.Color = vbRed
            End If
            nRows = nRows + 1
         End If
         
         If Right("" & rsQD.Fields(1), 2) = "00" Then '項目抬頭
             If Left("" & rsQD.Fields("r02001"), 1) <> "6" Then 'CFT已有顯示
                WksRpt131.Range("A" & nRows).Value = "" & rsQD.Fields(2)
                nRows = nRows + 1
             End If
             'B欄開始列出承辦人
             For intQ = 0 To UBound(strUL)
                WksRpt131.Range(Chr(66 + intQ) & nRows).Value = "" & Mid(strUL(intQ), 8)
             Next intQ
             nRows = nRows + 1
         ElseIf "" & rsQD.Fields("ord1") = "2" Then '類別數:加註在次數(類別數)
            strQ1 = ""
            For intQ = 1 To UBound(tmpArray)
               If intQ < UBound(tmpArray) Then
                  WksRpt131.Range(Chr(65 + intQ) & nRows - 1).Value = WksRpt131.Range(Chr(65 + intQ) & nRows - 1).Value & IIf(Val("" & rsQD.Fields(intQ + 2)) <> 0, "(" & rsQD.Fields(intQ + 2) & ")", "")
                  strQ1 = Val(strQ1) + Val("" & rsQD.Fields(intQ + 2))
               Else
                  WksRpt131.Range(Chr(65 + intQ) & nRows - 1).Value = WksRpt131.Range(Chr(65 + intQ) & nRows - 1).Value & IIf(Val(strQ1) + Val("" & rsQD.Fields(intQ + 2)) <> 0, "(" & Val(strQ1) + Val("" & rsQD.Fields(intQ + 2)) & ")", Val(strQ1) + Val("" & rsQD.Fields(intQ + 2)))
               End If
            Next intQ
         Else
            tmpArray(0) = "" & rsQD.Fields(2)
            strQ1 = ""
            For intQ = 1 To UBound(tmpArray)
               '排除CFT新案立卷
               If "" & rsQD.Fields("r02001") = "6-01" Then
                  tmpArray(intQ) = "" & rsQD.Fields(intQ + 2)
               Else
                  If intQ < UBound(tmpArray) Then
                     tmpArray(intQ) = Val("" & rsQD.Fields(intQ + 2))
                     strQ1 = Val(strQ1) + Val("" & rsQD.Fields(intQ + 2))
                  Else
                     tmpArray(intQ) = Val(strQ1) + Val("" & rsQD.Fields(intQ + 2))
                  End If
                  strSubT(intQ - 1) = Val(strSubT(intQ - 1)) + tmpArray(intQ)
               End If
            Next intQ
            WksRpt131.Range("A" & nRows & ":" & strDCol & nRows).Value = tmpArray
            nRows = nRows + 1
         End If
         '成長數
         If ((Left("" & rsQD.Fields("r02001"), 1) <> "2" And Left(strGrp, 2) = Left("" & rsQD.Fields("r02001"), 2)) Or (Left("" & rsQD.Fields("r02001"), 1) = "2" And strGrp = "" & rsQD.Fields("r02001"))) _
             And Left("" & rsQD.Fields("r02002"), 2) = "上月" Then
            WksRpt131.Range("A" & nRows).Value = "成長數"
            
            '查名件數(類別數)
            If Left("" & rsQD.Fields("r02001"), 1) = "2" Then
               strQ1 = "": strQ2 = ""
               For intP = 0 To UBound(strUL) - 1
                  strQ1 = strQ1 & ",(nvl(v1." & Left(strUL(intP), 6) & ",0)-nvl(v2." & Left(strUL(intP), 6) & ",0)) as " & Left(strUL(intP), 6)
                  strQ2 = strQ2 & "+(nvl(v1." & Left(strUL(intP), 6) & ",0)-nvl(v2." & Left(strUL(intP), 6) & ",0))"
               Next intP
               strExc(0) = "select " & Mid(strQ1, 2) & ", " & Mid(strQ2, 2) & " as " & Left(strUL(UBound(strUL)), 6) & _
                       " from r100105 v1,r100105 v2  where v1.id= '" & strPID & "' and v1.r02001='2-01' and v1.id=v2.id(+) and v2.r02001='2-02' "
               intI = 1
               Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
               If intI = 1 Then
                  For intQ = 0 To UBound(strUL)
                     '查名件數
                     WksRpt131.Range(Chr(66 + intQ) & nRows).Value = "" & RsTemp.Fields(intQ)
                  Next intQ
               End If
               strExc(0) = Replace(strExc(0), "100105", "100105_1")
               intI = 1
               Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
               If intI = 1 Then
                  For intQ = 0 To UBound(strUL)
                     '查名類別
                     If Val("" & RsTemp.Fields(intQ)) <> 0 Then
                        WksRpt131.Range(Chr(66 + intQ) & nRows).Value = WksRpt131.Range(Chr(66 + intQ) & nRows).Value & "(" & RsTemp.Fields(intQ) & ")"
                     End If
                  Next intQ
               End If
            Else
               For intQ = 0 To UBound(strUL)
                  WksRpt131.Range(Chr(66 + intQ) & nRows).Formula = "=$" & Chr(66 + intQ) & nRows - 2 & "-$" & Chr(66 + intQ) & nRows - 1
               Next intQ
            End If

            WksRpt131.Range("A" & nRows & ":" & strDCol & nRows).Interior.ColorIndex = 6 '底色:黃色
            nRows = nRows + 1
         End If

         strGrp = "" & rsQD.Fields("r02001")
         rsQD.MoveNext
      Loop
      '調整為能使文字全部顯示之欄寬
      WksRpt131.Columns("A" & ":" & strDCol).EntireColumn.AutoFit
      WksRpt131.Range("B" & ":" & strDCol).HorizontalAlignment = xlRight
      xlsRpt131.Range("A1" & ":" & strDCol & "1").Select
      With xlsRpt131.Selection
         .MergeCells = True
         .Font.Bold = True
         .HorizontalAlignment = xlCenter
      End With
      
      xlsRpt131.Sheets(1).Select '選擇工作表
      If Val(xlsRpt131.Version) < 12 Then
         xlsRpt131.Workbooks(1).SaveAs FileName:=App.path & TextPath & xlsFileName1, FileFormat:=-4143
      Else
         xlsRpt131.Workbooks(1).SaveAs FileName:=App.path & TextPath & xlsFileName1, FileFormat:=56
      End If
      xlsRpt131.Workbooks.Close
      xlsRpt131.Quit
      Set xlsRpt131 = Nothing
      Set WksRpt131 = Nothing
      
      strQ1 = Pub_GetSpecMan("D")
      If strQ1 = "" Then strQ1 = Pub_GetSpecMan("程式管理人員")
      SendMAPIMail strQ1, strSub, "請參考附件", App.path & TextPath & xlsFileName1
   End If

   Set rsQD = Nothing
   
   Exit Sub
   
ErrHandle:
   If Err.Number <> 0 Then
      WLog "外商程序組每月工作報告表:" & Err.Description
   End If
End Sub

'Added by Lydia 2024/03/12 外商程序組每月工作報告表：處理查詢明細暫存檔
Private Sub StrMenu131_Sub1(ByRef pSID As String, ByRef pKind As String, ByRef pCList As String, ByRef pCArray As Variant, ByRef pNowD1 As String, ByRef pNowD2 As String, ByRef pPreD1 As String, ByRef pPreD2 As String)
Dim strCon1 As String, strTmpA As String
Dim intA As Integer, intB As Integer
Dim rsAD As New ADODB.Recordset
Dim midSys As String
Dim strJumpMerge As String

   If pKind = "2" Then
      midSys = "FCT,S"
   ElseIf pKind = "3" Then
      midSys = "FCT,S,CFT"
   ElseIf pKind = "6" Then
      midSys = "CFT"
   Else
      midSys = "FCT"
   End If

   strJumpMerge = "2,3"  '直接抓合計的種類

   If pKind = "1" Then
      '向智慧局發文件數
      strTmpA = "select r02001,cp10,cpm03,cp14 as cman,count(*) cnt,sum(grpcnt) grpcnt" & _
              " From r100105, caseprogress, casepropertymap,(select tm01,tm02,tm03,tm04,counting(tm09) grpcnt from trademark) " & _
              " where id='" & pSID & "' and r02001 like '" & pKind & "-%' and r02006 <> 'TOT' and r02006=cp10(+) and cp01 in (" & GetAddStr(midSys) & ") and cp27>=" & pNowD1 & " and cp27<=" & pNowD2 & _
              " and instr('" & pCList & "',cp14) > 0 and cp01=cpm01(+) and cp10=cpm02(+)" & _
              " and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03 and cp04=tm04(+) group by r02001,cp10,cpm03,cp14"
   ElseIf pKind = "2" Then
      '查名件數(FCT+S案的001查名)
      strCon1 = "select cp14 as cman,sum(cnt) cnt ,sum(grpcnt) grpcnt from ( " & _
                "select cp14,1 as cnt, counting(decode(cp01,'S',SP73,TM09)) grpcnt " & _
                "From caseprogress, trademark, servicepractice " & _
                "where cp01 in (" & GetAddStr(midSys) & ") and cp10='001' and cp27>=BDATE1 and cp27<=BDATE2 and instr('" & pCList & "',cp14) > 0 " & _
                "and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+) and cp01=sp01(+) and cp02=sp02(+) and cp03=sp03(+) and cp04=sp04(+) " & _
                ") group by cp14 order by 1 "
   ElseIf pKind = "3" Then
      '發文點數
      strCon1 = "select cp14 as cman,sum(nvl(decode(substr(cp60,1,1),'X',decode(a1k25,null,a1n05,''),cp18),0)) as cnt " & _
             "From caseprogress, acc1k0, acc1n0 " & _
             "where cp01 in (" & GetAddStr(midSys) & ") and cp27>=BDATE1 and cp27<=BDATE2 " & _
             "and instr('" & pCList & "',cp14) > 0 " & _
             "and cp60=a1k01(+) and a1n01(+)=cp60 and a1n02(+)='2' and a1n03(+)=cp09 and a1n04(+)=cp14 group by cp14 order by 1"
   ElseIf pKind = "4" Then
      '其他來函：C類來函-發文
      strCon1 = "select r02001,cp10,cpm03,cp14 as cman,count(*) cnt" & _
              " From r100105, caseprogress, casepropertymap " & _
              " where id='" & pSID & "' and r02001 like '" & pKind & "-0%' and r02006 <> 'TOT' and r02006=cp10(+) and cp01 in ('FCT') and cp27>=BDATE1 and cp27<=BDATE2 " & _
              " and instr('" & pCList & "',cp14) > 0 and cp01=cpm01(+) and cp10=cpm02(+)" & _
              " group by r02001,cp10,cpm03,cp14"
      '其他來函：C類來函-收文;排除CFT案來函
      strCon1 = strCon1 & " Union select r02001,cp10,cpm03,cp65 as cman,count(*) cnt" & _
              " From r100105, caseprogress, casepropertymap " & _
              " where id='" & pSID & "' and r02001 like '" & pKind & "-1%' and r02006 <> 'TOT' and r02006=cp10(+) and cp01 in ('FCT','S','CFT') and cp05>=BDATE1 and cp05<=BDATE2 " & _
              " and instr('" & pCList & "',cp65) > 0 and cp01=cpm01(+) and cp10=cpm02(+)" & _
              " and cp01||cp10<>'CFT1717' and cp01||cp10<>'CFT1722' group by r02001,cp10,cpm03,cp65"
   ElseIf pKind = "6" Then
      'CFT發文
      strCon1 = "select r02001,cp10,cpm03,cp14 as cman,count(*) cnt" & _
              " From r100105, caseprogress, casepropertymap " & _
              " where id='" & pSID & "' and r02001 like '" & pKind & "-%' and r02006 <> 'TOT' and r02006=cp10(+) and cp01 in (" & GetAddStr(midSys) & ") and cp27>=BDATE1 and cp27<=BDATE2 " & _
              " and instr('" & pCList & "',cp14) > 0 and cp01=cpm01(+) and cp10=cpm02(+)" & _
              " group by r02001,cp10,cpm03,cp14"
   End If
   If strCon1 <> "" And InStr(strCon1, "BDATE") > 0 Then
      strTmpA = Replace(Replace(strCon1, "BDATE1", pNowD1), "BDATE2", pNowD2)
   End If
     
   If strTmpA = "" Then Exit Sub
   intA = 1
   Set rsAD = ClsLawReadRstMsg(intA, strTmpA)
   If intA = 1 Then
      rsAD.MoveFirst
      Do While Not rsAD.EOF
         For intB = 0 To UBound(pCArray)
            If Trim("" & pCArray(intB)) <> "" And InStr(Trim("" & pCArray(intB)), "" & rsAD.Fields("cman")) > 0 Then
               If InStr(strJumpMerge, pKind) = 0 Then '逐筆更新收文小計
                  strSql = "Update R100105 set R02002='" & ChgSQL("" & rsAD.Fields("cpm03")) & "', " & Left(pCArray(intB), 6) & "='" & ChgSQL("" & rsAD.Fields("cnt")) & "' " & _
                           "where id='" & pSID & "' and r02001='" & rsAD.Fields("r02001") & "' "
                  cnnConnection.Execute strSql
                  '另存商品類別
                  If pKind = "1" Then
                     If "" & rsAD.Fields("cp10") = "101" Then
                        strSql = "Update R100105_1 set R02002='" & ChgSQL("" & rsAD.Fields("cpm03")) & "', " & Left(pCArray(intB), 6) & "='" & ChgSQL("" & rsAD.Fields("grpcnt")) & "' " & _
                                 "where id='" & pSID & "' and r02001='" & rsAD.Fields("r02001") & "' "
                        cnnConnection.Execute strSql
                     End If
                  End If
               Else  '本月合計
                  strSql = "Update R100105 set " & Left(pCArray(intB), 6) & "='" & ChgSQL("" & rsAD.Fields("cnt")) & "' " & _
                           "where id='" & pSID & "' and r02001 like '" & pKind & "-%' and substr(r02002,1,2)='本月' "
                  cnnConnection.Execute strSql, intI
                  '另存商品類別
                  If pKind = "2" Then
                     strSql = "Update R100105_1 set " & Left(pCArray(intB), 6) & "='" & ChgSQL("" & rsAD.Fields("grpcnt")) & "' " & _
                              "where id='" & pSID & "' and r02001 like '" & pKind & "-%' and substr(r02002,1,2)='本月' "
                  End If
                  cnnConnection.Execute strSql, intI
               End If
            End If
         Next intB
         rsAD.MoveNext
      Loop
   End If
   If InStr(strJumpMerge, pKind) = 0 Then '逐筆更新收文小計>>本月合計
      strTmpA = ""
      For intB = 0 To UBound(pCArray)
         If Trim("" & pCArray(intB)) <> "" Then
           'Modified by Lydia 2024/05/08 CFT新案的空白為-
           'strTmpA = strTmpA & ",sum(nvl(" & Left(pCArray(intB), 6) & ",0)) as " & Left(pCArray(intB), 6)
           strTmpA = strTmpA & ",sum(decode(" & Left(pCArray(intB), 6) & ",'-',0,nvl(" & Left(pCArray(intB), 6) & ",0))) as " & Left(pCArray(intB), 6)
         End If
      Next intB
      strTmpA = "select " & Mid(strTmpA, 2) & " from r100105 where id = '" & pSID & "' and r02001 like '" & pKind & "-%' and r02006 <>'TOT' "
      intA = 1
      Set rsAD = ClsLawReadRstMsg(intA, strTmpA)
      If intA = 1 Then
         strSql = ""
         For intB = 0 To UBound(pCArray)
            If Trim("" & pCArray(intB)) <> "" Then
              strSql = strSql & "," & Left(pCArray(intB), 6) & "=" & CNULL("" & rsAD.Fields(intB))
            End If
         Next intB
         strSql = "Update R100105 set " & Mid(strSql, 2) & " where id = '" & pSID & "' and r02001 like '" & pKind & "-%' and r02002='本月合計' "
         cnnConnection.Execute strSql, intI
      End If
   End If '逐筆更新收文小計>>本月合計
   '上月合計
   If InStr(strJumpMerge, pKind) = 0 Then
      If pKind = "4" Then  'C類來函-發文/收文
         strTmpA = "select '1' ord1,cp14 as cman,count(*) cnt" & _
                 " From r100105, caseprogress, casepropertymap" & _
                 " where id='" & pSID & "' and r02001 like '" & pKind & "-0%' and r02006 <> 'TOT' and r02006=cp10(+) and cp01 in ('FCT') and cp27>=" & pPreD1 & " and cp27<=" & pPreD2 & _
                 " and instr('" & pCList & "',cp14) > 0 and cp01=cpm01(+) and cp10=cpm02(+)" & _
                 " group by cp14"
         strTmpA = strTmpA & " union select '2' ord1,cp65 as cman,count(*) cnt" & _
                 " From r100105, caseprogress, casepropertymap" & _
                 " where id='" & pSID & "' and r02001 like '" & pKind & "-1%' and r02006 <> 'TOT' and r02006=cp10(+) and cp01 in ('FCT','S','CFT') and cp05>=" & pPreD1 & " and cp05<=" & pPreD2 & _
                 " and instr('" & pCList & "',cp65) > 0 and cp01=cpm01(+) and cp10=cpm02(+)" & _
                 "  and cp01||cp10<>'CFT1717' and cp01||cp10<>'CFT1722' group by cp65"
         strTmpA = "select cman,sum(cnt) as cnt from (" & strTmpA & ") group by cman"
      Else   '承辦人-發文
         strTmpA = "select cp14 as cman,count(*) cnt" & _
                 " From r100105, caseprogress, casepropertymap" & _
                 " where id='" & pSID & "' and r02001 like '" & pKind & "-%' and r02006 <> 'TOT' and r02006=cp10(+) and cp01 in (" & GetAddStr(midSys) & ") and cp27>=" & pPreD1 & " and cp27<=" & pPreD2 & _
                 " and instr('" & pCList & "',cp14) > 0 and cp01=cpm01(+) and cp10=cpm02(+)" & _
                 " group by cp14"
      End If
   Else
      strTmpA = Replace(Replace(strCon1, "BDATE1", pPreD1), "BDATE2", pPreD2)
   End If
   intA = 1
   Set rsAD = ClsLawReadRstMsg(intA, strTmpA)
   If intA = 1 Then
      rsAD.MoveFirst
      Do While Not rsAD.EOF
         For intB = 0 To UBound(pCArray)
            If Trim("" & pCArray(intB)) <> "" And InStr(Trim("" & pCArray(intB)), "" & rsAD.Fields("cman")) > 0 Then
               strSql = "Update R100105 set " & Left(pCArray(intB), 6) & "='" & ChgSQL("" & rsAD.Fields("cnt")) & "' " & _
                        "where id='" & pSID & "' and r02001 like '" & pKind & "-%' and substr(r02002,1,2)='上月' "
               cnnConnection.Execute strSql, intI
               If pKind = "2" Then
                  strSql = "Update R100105_1 set " & Left(pCArray(intB), 6) & "='" & ChgSQL("" & rsAD.Fields("grpcnt")) & "' " & _
                           "where id='" & pSID & "' and r02001 like '" & pKind & "-%' and substr(r02002,1,2)='上月' "
                  cnnConnection.Execute strSql, intI
               End If
            End If
         Next intB
         rsAD.MoveNext
      Loop
   End If

   Set rsAD = Nothing
End Sub

'Added by Lydia 2024/07/29 律師出庭費領取通知：系統日=FCL/L案發文日+1,2,3個月，每月10日統一通知，再次Email通知承辦律師確認是否領取出庭費
Private Sub StrMenu132()
Dim rsQD As New ADODB.Recordset
Dim intQ As Integer, strQ1 As String, StrDate2 As String, strDate1 As String
Dim xlsAgentPoint
Dim wksrpt
Dim xlsFileName1 As String
Dim stTmp
Dim nRow As Integer, intB As Integer
Dim strGrp As String, strSub As String, strCont As String
Dim tmpTitle As Variant, tmpArr As Variant
Dim strTitleName As String, strSpecCont As String, strCC As String

On Err GoTo ErrHandle
   
   StrDate2 = strSrvDate(1)
   strDate1 = Left(CompDate(1, -1, StrDate2), 6) & "11"
   
   '附件名稱
   xlsFileName1 = "*律師出庭費領取通知.xls"
   If Dir(App.path & TextPath & xlsFileName1) <> "" Then
      Kill App.path & TextPath & xlsFileName1
   End If
   xlsFileName1 = Mid(xlsFileName1, 2)
   
   'Email主旨, 內文
   strSub = ChangeWStringToTDateString(strDate1) & "~" & ChangeWStringToTDateString(StrDate2) & "尚有出庭費尚未確認領取，請參附件excel檔案後盡速確認。"
   strCont = "請至【法務系統->內法->資料處理->出庭費確認維護】確認開庭費領取事宜；" & vbCrLf
   'Modified by Lydia 2025/03/19 計算通知日期範圍：有CL07就抓最左邊的最後通知日+1個月,若counting(CL07)=1表示只有發文通知所以不用+1個月
   'strQ1 = "select cl01,cl02,st02,cl03,decode(cl07,sqldatet(cp158),1,null,1,counting(cl07)) cnt2,cl07,cl08" & _
           " ,cp09,cp10,cp158,cpm03,cp01||'-'||cp02||'-'||cp03||'-'||cp04 as caseno,nvl(lc05,nvl(lc06,lc07)) as casename" & _
           " ,workdayadd(-1,to_char(add_months(to_date(cp158,'yyyymmdd'),decode(cl07,sqldatet(cp158),1,null,1,counting(cl07))),'yyyymmdd')) as ttdate1" & _
           " From caselawer, caseprogress, casepropertymap, lawcase,staff" & _
           " Where cl04 Is Null and cl07 Is Not Null and cl01=cp09(+) and cp158>0 and cp159=0 and cp01=cpm01(+) and cp10=cpm02(+) and instr('," & CaseLawerPtyList & ",',','||cpm12||',') > 0" & _
           " and cp01=lc01(+) and cp02=lc02(+) and cp03=lc03(+) and cp04=lc04(+) and cl02=st01(+)"
   strQ1 = "select cl01,cl02,st02,cl03,counting(cl07) cnt2,cl07,cl08 ,cp09,cp10,cp158,cpm03," & _
           " cp01||'-'||cp02||'-'||cp03||'-'||cp04 as caseno,nvl(lc05, nvl(lc06, lc07)) As casename," & _
           " workdayadd(-1,to_char(add_months(to_date(decode(cl07,null,cp158,replace(substr(cl07,1,9),'/','')+19110000),'yyyymmdd'),decode(counting(cl07),1,0,0,0,1 )),'yyyymmdd')) as ttdate1" & _
           " from caselawer, caseprogress, casepropertymap, lawcase,staff where cl04 is null and cl07 is not null and cl01=cp09(+) and cp158>0 and cp159=0 " & _
           " and cp01=cpm01(+) and cp10=cpm02(+)  and cp01=lc01(+) and cp02=lc02(+) and cp03=lc03(+) and cp04=lc04(+)" & _
           " and cl02=st01(+) and counting(cl07) < 4 "
 
   strQ1 = "select * from (" & strQ1 & ") where ttdate1>=" & strDate1 & " and ttdate1<=" & StrDate2 & " and cnt2 < 4 order by cl02,cnt2"
   intQ = 1
   Set rsQD = ClsLawReadRstMsg(intQ, strQ1)
   If intQ = 1 Then
      strTitleName = "本所案號,案件名稱,案件性質,發文日,出庭律師,出庭費,通知次數,Email通知記錄,律師確認記錄"
      tmpTitle = Split(strTitleName, ",")
      ReDim tmpArr(0 To UBound(tmpTitle))
      rsQD.MoveFirst
      Do While Not rsQD.EOF
         If strGrp <> "" & rsQD.Fields("cl02") Then
            If strGrp <> "" Then
               For intB = 0 To UBound(tmpTitle) '調整為能使文字全部顯示之欄寬(目前工作表)
                  wksrpt.Columns(Chr(65 + intB) & ":" & Chr(65 + intB)).EntireColumn.AutoFit
               Next
               xlsAgentPoint.ActiveSheet.Range("A2").Select
               xlsAgentPoint.ActiveWindow.FreezePanes = True '凍結窗格

               If Val(xlsAgentPoint.Version) < 12 Then
                  xlsAgentPoint.Workbooks(1).SaveAs FileName:=App.path & TextPath & xlsFileName1, FileFormat:=-4143
               Else
                  xlsAgentPoint.Workbooks(1).SaveAs FileName:=App.path & TextPath & xlsFileName1, FileFormat:=56
               End If
               xlsAgentPoint.Workbooks.Close
               xlsAgentPoint.Quit
               SendMAPIMail strGrp, strSub, strCont & IIf(strSpecCont <> "", vbCrLf, "") & strSpecCont, App.path & TextPath & xlsFileName1, , , IIf(strSpecCont <> "", strCC, "")
            Else
                Set xlsAgentPoint = CreateObject("Excel.Application")
            End If
            If Dir(App.path & TextPath & xlsFileName1) <> "" Then
               Kill App.path & TextPath & xlsFileName1
            End If
            
            nRow = 1
            xlsAgentPoint.SheetsInNewWorkbook = 1 '預設工作表數目
            xlsAgentPoint.Workbooks.add
            xlsAgentPoint.Application.Visible = False
            Set wksrpt = xlsAgentPoint.Worksheets(1)
            xlsAgentPoint.Sheets(1).Select
            wksrpt.Range(Chr(65) & nRow & ":" & Chr(65 + UBound(tmpTitle)) & nRow).Value = tmpTitle
            wksrpt.Range(Chr(65) & nRow & ":" & Chr(65 + UBound(tmpTitle)) & nRow).Font.Bold = True
            strSpecCont = ""
            nRow = nRow + 1
         End If
         tmpArr(0) = "" & rsQD.Fields("caseno") '本所案號
         tmpArr(1) = "" & rsQD.Fields("casename") '案件名稱
         tmpArr(2) = "" & rsQD.Fields("cpm03") '案件性質
         tmpArr(3) = ChangeWStringToTDateString("" & rsQD.Fields("cp158"))  '發文日
         tmpArr(4) = "" & rsQD.Fields("st02") '出庭律師
         tmpArr(5) = Format("" & rsQD.Fields("cl03"), "##,##0") '出庭費
         tmpArr(6) = "" & rsQD.Fields("cnt2") '通知次數
         'Modified by Lydia 2025/03/19 改成系統日strDate1>>strSrvDate(1)
         tmpArr(7) = ChangeWStringToTDateString(strSrvDate(1)) & "," & rsQD.Fields("cl07") 'Email通知記錄+執行日期
         tmpArr(8) = "" & rsQD.Fields("cl08") '律師確認記錄
         wksrpt.Range(Chr(65) & nRow & ":" & Chr(65 + UBound(tmpTitle)) & nRow).Value = tmpArr

         strGrp = "" & rsQD.Fields("cl02")
         If Val("" & rsQD.Fields("cnt2")) >= 3 Then
            strSpecCont = IIf(strSpecCont = "", "下列案件已達3次通知：" & vbCrLf, "") & rsQD.Fields("caseno") & vbCrLf
         End If
         If strSpecCont <> "" And strCC = "" Then
            strCC = Pub_GetSpecMan("出庭費未領取通知副本收受者")
            'Added by Lydia 2024/11/06 每日批次3次不領取之通知，副本加發「財務處總帳人員」
            strSql = Pub_GetSpecMan("財務處總帳人員")
            If strSql <> "" Then strCC = strCC & ";" & strSql
            'end 2024/11/06
         End If
         
         'Modified by Lydia 2025/03/19 改成系統日strDate1>>strSrvDate(1)
         strSql = "Update CaseLawer Set Cl07='" & ChangeWStringToTDateString(strSrvDate(1)) & "'||decode(cl07,null,'',',')||cl07  where cl01='" & rsQD.Fields("cl01") & "' and cl02='" & rsQD.Fields("cl02") & "' "
         cnnConnection.Execute strSql
         nRow = nRow + 1
         rsQD.MoveNext
      Loop
      If strGrp <> "" Then
         For intB = 0 To UBound(tmpTitle) '調整為能使文字全部顯示之欄寬(目前工作表)
            wksrpt.Columns(Chr(65 + intB) & ":" & Chr(65 + intB)).EntireColumn.AutoFit
         Next
         xlsAgentPoint.ActiveSheet.Range("A2").Select
         xlsAgentPoint.ActiveWindow.FreezePanes = True '凍結窗格
         
         If Val(xlsAgentPoint.Version) < 12 Then
            xlsAgentPoint.Workbooks(1).SaveAs FileName:=App.path & TextPath & xlsFileName1, FileFormat:=-4143
         Else
            xlsAgentPoint.Workbooks(1).SaveAs FileName:=App.path & TextPath & xlsFileName1, FileFormat:=56
         End If
         xlsAgentPoint.Workbooks.Close
         xlsAgentPoint.Quit
         Set xlsAgentPoint = Nothing
         Set wksrpt = Nothing
         SendMAPIMail strGrp, strSub, strCont & IIf(strSpecCont <> "", vbCrLf, "") & strSpecCont, App.path & TextPath & xlsFileName1, , , IIf(strSpecCont <> "", strCC, "")
      End If
   End If
   Set rsQD = Nothing
   
   Exit Sub
   
ErrHandle:
   If Err.Number <> 0 Then
      WLog "律師出庭費領取通知:" & Err.Description
   End If
End Sub

'Added by Lydia 2024/07/29 律師出庭費未領取清單：每年第1個工作天寄發excel給(出庭費未領取通知副本收受者), 副本財務處. 由於上線前會清理以前的資料, 所以理論上資料區間是 ___~xxx/12/31. 不同律師產生不同頁籤
Private Sub StrMenu133()
Dim strDate1 As String, StrDate2 As String
Dim strTo As String
Dim xlsFileName1 As String
   
   
On Err GoTo ErrHandle
    
   strDate1 = strSrvDate(1)
   strDate1 = (Val(Left(strDate1, 4)) - 1) & "0101"
   StrDate2 = Left(strDate1, 4) & "1231"
   '附件名稱
   xlsFileName1 = "*律師出庭費未領取清單" & MsgText(43)
   If Dir(App.path & TextPath & xlsFileName1) <> "" Then
      Kill App.path & TextPath & xlsFileName1
   End If
   xlsFileName1 = App.path & TextPath & Mid(xlsFileName1, 2)
   
   Call PUB_GetFrm075013toXls(Me.Name, "", "N", strDate1, StrDate2, xlsFileName1)
   
   If xlsFileName1 <> "" Then
      strTo = Pub_GetSpecMan("出庭費未領取通知副本收受者")
      If strTo <> "" Then
         SendMAPIMail strTo, (Left(strDate1, 4) - 1911) & "年律師出庭費未領取清單", "請參考附件。", xlsFileName1, , , Pub_GetSpecMan("財務處總帳人員")
      End If
   Else
      GoTo ErrHandle
   End If
   
   Exit Sub

ErrHandle:
   If Err.Number <> 0 Then
      WLog "律師出庭費未領取清單:" & Err.Description
   End If
End Sub

'Add By Sindy 2024/5/31 檢查客戶檔ID輸入8碼6,第一次通知智權人員和發文人員
Private Sub StrMenu134()
Dim jj As Integer
Dim strCUID As String
Dim strTemp(1 To 5) As String
Dim RsQ As New ADODB.Recordset
Dim rsC As New ADODB.Recordset
Dim rsD As New ADODB.Recordset
Dim strContent As String, strTo As String, strCC As String
Dim bolUpdStar As Boolean
   
On Err GoTo ErrHandle
   
'   '抓發文時案件為新客戶做檢查
'   strSql = "select cp01,cp02,cp03,cp04,cp05,cp09,cp10,cp83 from caseprogress,consultrecapp" & _
'            " where cp27=" & strDate1 & " and cp159=0 and cp140 is not null" & _
'            " and cra01=cp140 and cra03='Y'"
   '抓客戶檔ID為8碼6且未寄通知信
   strSql = "select * from customer WHERE cu11='66666666' and cu182 is null"
   intI = 1
   Set RsQ = ClsLawReadRstMsg(intI, strSql)
   If intI = 1 Then
      With RsQ
         .MoveFirst
         Do While Not .EOF
            strCUID = .Fields("cu01") & .Fields("cu02")
            '再串案件申請人和進度資料
            strSql = "select cp01,cp02,cp03,cp04,cp05,cp10" & _
                            ",cp27,cp09,cp130" & _
                            ",pa26,pa27,pa28,pa29,pa30,pa09,cp83" & _
                     " from patent,caseprogress" & _
                     " where (pa26='" & strCUID & "' or pa27='" & strCUID & "' or pa28='" & strCUID & "' or pa29='" & strCUID & "' or pa30='" & strCUID & "')" & _
                     " and cp01=pa01 and cp02=pa02 and cp03=pa03 and cp04=pa04 and cp158>0 and cp159=0 and pa01 is not null" & _
                     " and pa57 is null and pa108 is null"
            strSql = strSql & " union " & _
                     "select cp01,cp02,cp03,cp04,cp05,cp10" & _
                            ",cp27,cp09,cp130" & _
                            ",tm23,tm78,tm79,tm80,tm81,tm10,cp83" & _
                     " from trademark,caseprogress" & _
                     " where (tm23='" & strCUID & "' or tm78='" & strCUID & "' or tm79='" & strCUID & "' or tm80='" & strCUID & "' or tm81='" & strCUID & "')" & _
                     " and cp01=tm01 and cp02=tm02 and cp03=tm03 and cp04=tm04 and cp158>0 and cp159=0 and tm01 is not null" & _
                     " and tm30 is null and tm57 is null"
            strSql = strSql & " union " & _
                     "select cp01,cp02,cp03,cp04,cp05,cp10" & _
                            ",cp27,cp09,cp130" & _
                            ",sp08,sp58,sp59,sp65,sp66,sp09,cp83" & _
                     " from servicepractice,caseprogress" & _
                     " where (sp08='" & strCUID & "' or sp58='" & strCUID & "' or sp59='" & strCUID & "' or sp65='" & strCUID & "' or sp66='" & strCUID & "')" & _
                     " and cp01=sp01 and cp02=sp02 and cp03=sp03 and cp04=sp04 and cp158>0 and cp159=0 and sp01 is not null" & _
                     " and sp16 is null and sp61 is null"
            strSql = strSql & " union " & _
                     "select cp01,cp02,cp03,cp04,cp05,cp10" & _
                            ",cp27,cp09,cp130" & _
                            ",lc11,lc43,lc44,lc45,lc46,lc15,cp83" & _
                     " from Lawcase,caseprogress" & _
                     " where (lc11='" & strCUID & "' or lc43='" & strCUID & "' or lc44='" & strCUID & "' or lc45='" & strCUID & "' or lc46='" & strCUID & "')" & _
                     " and cp01=lc01 and cp02=lc02 and cp03=lc03 and cp04=lc04 and cp158>0 and cp159=0 and lc01 is not null" & _
                     " and lc09 is null and lc34 is null"
            strSql = strSql & " union " & _
                     "select cp01,cp02,cp03,cp04,cp05,cp10,cp27,cp09,cp130" & _
                            ",hc05,hc24,hc25,hc26,hc27,'000',cp83" & _
                     " from Hirecase,caseprogress" & _
                     " where (hc05='" & strCUID & "' or hc24='" & strCUID & "' or hc25='" & strCUID & "' or hc26='" & strCUID & "' or hc27='" & strCUID & "')" & _
                     " and cp01=hc01 and cp02=hc02 and cp03=hc03 and cp04=hc04 and cp158>0 and cp159=0 and hc01 is not null" & _
                     " and hc10 is null"
            strSql = strSql & " order by cp01,cp02,cp03,cp04,cp27 desc,cp05 desc"
            intI = 1
            Set rsC = ClsLawReadRstMsg(intI, strSql)
            strTo = "": strCC = "": strContent = ""
            If intI = 1 Then
               cnnConnection.BeginTrans: bolUpdStar = True
               For jj = 1 To 5
                  strTemp(jj) = "" & rsC.Fields(8 + jj)
                  '申請人
                  If strTemp(jj) <> "" Then
                     strSql = "SELECT cu01,cu02,cu04,rtrim(upper(cu05||' '||cu88||' '||cu89||' '||cu90)),cu06,cu11,cu15,cu13" & _
                              " From customer" & _
                              " WHERE cu01='" & Mid(strTemp(jj), 1, 8) & "'" & _
                                " and cu02='" & Mid(strTemp(jj), 9, 1) & "'" & _
                                " and cu11='66666666' and cu182 is null"
                     intI = 1
                     Set rsD = ClsLawReadRstMsg(intI, strSql)
                     If intI = 1 Then
                        If strTo = "" Then strTo = "" & rsD.Fields("cu13")
                        If strCC = "" Then strCC = "" & rsC.Fields("cp83")
                        If strContent <> "" Then strContent = strContent & vbCrLf
                        '若收文的第一個案件要送件時, 鍵入專業發文日時, 同步檢核ID, 若ID仍為66666666
                        '則發送提醒信予智權人員及發文人員
                        strContent = "客戶編號：" & strTemp(jj) & vbCrLf & _
                                     "客戶名稱：" & IIf("" & rsD.Fields("cu04") <> "", "" & rsD.Fields("cu04"), IIf("" & rsD.Fields(3) <> "", "" & rsD.Fields(3), "" & rsD.Fields("cu06"))) & vbCrLf & _
                                     "客戶 ID ：66666666" & vbCrLf & vbCrLf & _
                                     "A.若屬台灣且發文收受者為政府各主管機關之案件，應已有正確之ID，請智權人員提出異動，予檔案室同仁修改。" & vbCrLf & _
                                     "B.若屬非台灣或發文收受者為非政府主管機關之案件，若屬公司客戶，或是客戶已有提供正確之ID，請智權人員提出異動，予檔案室同仁修改。" & vbCrLf & _
                                     "C.若個人客戶不願意提供ID，請智權人員提出異動，以設定此客戶不提供ID。"
'                        If "" & RsC.Fields("pa09") = "000" And Trim("" & RsC.Fields("cp130")) <> "" Then
'                           strContent = strContent & "提醒：屬台灣且發文收受者為政府各主管機關之案件，應已有正確之ID，請智權人員提出異動，予檔案室同仁修改。" & vbCrLf
'                        ElseIf "" & RsD.Fields("cu15") = "0" Then
'                           strContent = strContent & "提醒：若個人客戶不願意提供ID，請智權人員提出異動，以設定此客戶不提供ID。" & vbCrLf
'                        Else
'                           strContent = strContent & "提醒：若屬非台灣或發文收受者為非政府主管機關之案件，若屬公司客戶，或是客戶已有提供正確之ID，請智權人員提出異動，予檔案室同仁修改。" & vbCrLf
'                        End If
                        'W=已寄通知信
                        strSql = "update customer set cu182='W'" & _
                                 " WHERE cu01='" & Mid(strTemp(jj), 1, 8) & "'" & _
                                   " and cu02='" & Mid(strTemp(jj), 9, 1) & "'" & _
                                   " and cu11='66666666' and cu182 is null"
                        cnnConnection.Execute strSql
                     End If
                  Else
                     Exit For
                  End If
               Next jj
               If strContent <> "" Then
                  strSql = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08,mc09)" & _
                           " values( '" & strUserNum & "','" & strTo & "',to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss')" & _
                           ",'請處理無ID客戶','" & strContent & "','" & strCC & "')"
                  cnnConnection.Execute strSql
               End If
               cnnConnection.CommitTrans: bolUpdStar = False
            End If
            .MoveNext
         Loop
      End With
      Call PUB_SendMailCache(True) '批次發信
   End If
   
   Set RsQ = Nothing
   Set rsC = Nothing
   Set rsD = Nothing
   
   Exit Sub
   
ErrHandle:
   If bolUpdStar = True Then cnnConnection.RollbackTrans
   If Err.Number <> 0 Then
      WLog "檢查客戶檔ID輸入8碼6,第一次通知智權人員和發文人員:" & Err.Description
   End If
   Set RsQ = Nothing
   Set rsC = Nothing
   Set rsD = Nothing
End Sub

'Added by Morgan 2024/7/31
'前一日放颱風假的所別當天有同仁請假通知
Private Sub StrMenu136()
   Dim stSQL As String, intQ As Integer, stDate As String
   Dim rsQuery As ADODB.Recordset
   Dim stText As String, stTO As String
   
On Error GoTo ErrHandle
   
   stDate = CompWorkDay(2, strSrvDate(1), 1)
   stSQL = "select '北所' c01,count(*) c02,st06 from workday,Staff_Absence,staff where wd01=" & stDate & " and wd02='Y'" & _
      " and sa02<=wd01 and sa04>=wd01 and st01(+)=sa01 and st06='1' group by st06" & _
      " union select '中所' c01,count(*) c02,st06 from workday,Staff_Absence,staff where wd01=" & stDate & " and wd03='Y'" & _
      " and sa02<=wd01 and sa04>=wd01 and st01(+)=sa01 and st06='2' group by st06" & _
      " union select '南所' c01,count(*) c02,st06 from workday,Staff_Absence,staff where wd01=" & stDate & " and wd04='Y'" & _
      " and sa02<=wd01 and sa04>=wd01 and st01(+)=sa01 and st06='3' group by st06" & _
      " union select '高所' c01,count(*) c02,st06 from workday,Staff_Absence,staff where wd01=" & stDate & " and wd05='Y'" & _
      " and sa02<=wd01 and sa04>=wd01 and st01(+)=sa01 and st06='4' group by st06 order by st06"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      stText = ""
      With rsQuery
      Do While Not .EOF
         stText = stText & .Fields("c01") & ": " & .Fields("c02") & " 位。" & vbCrLf
         .MoveNext
      Loop
      End With
      If stText <> "" Then
         'Modified by Morgan 2024/11/4 新增收件人余佳叡B3028--嘉渝
         'stTO = Pub_GetSpecMan("人事室出缺勤電子簽核")
         stTO = Pub_GetSpecMan("天災相關通知人事人員")
         'end 2024/11/4
         stText = "放颱風假的所別請假人數如下：" & vbCrLf & vbCrLf & stText & vbCrLf & vbCrLf & "明細資料請執行「一般作業 -> 出缺勤作業 -> 查詢 -> 出缺勤查詢」，清單可選擇「列印」輸出。"
         SendMAPIMail stTO, ChangeWStringToTDateString(stDate) & "放颱風假的所別當天有同仁請假，請聯絡後修改或取消假單！", stText
      End If
   End If
   Set rsQuery = Nothing
   Exit Sub
   
ErrHandle:
   If Err.Number <> 0 Then
      WLog Err.Description
   End If

End Sub

'Added by Lydia 2024/11/12 查名單(網中)：查名單量統計和排序
Private Sub StrMenu62_New()
Dim rsA As New ADODB.Recordset
Dim strA1 As String, strA2 As String
Dim sDate1 As String
Dim intN As Integer, intNum(0 To 2) As Integer
Dim strQuser As String
Dim rsB As New ADODB.Recordset, strB1 As String
   
On Error GoTo ErrHandle

cnnConnection.BeginTrans

   '清空前次統計
    cnnConnection.Execute "delete from TMQAppSumR"
    cnnConnection.Execute "insert into TMQAppSumR(TMASR01,TMASR02,TMASR03,TMASR04,TMASR05,TMASR06,TMASR07,TMASR08,TMASR09,TMASR10,TMASR12) " & _
                          "select tmqm01,0,0,0,0,0,0,0,0,0,decode(tmqm01,tmqm02,'1','2') from tmqmember " & _
                          "UNION select TMQM02,0,0,0,0,0,0,0,0,0,'1' from TMQMEMBER where tmqm01<>tmqm02 "
'   1.  TMASR05~TMASR07 每日順序由系統隨機分配。直接用取得亂數1~99來排班
   strA1 = "select TMASR01 from TMQAppSumR group by TMASR01"
   If rsA.State <> adStateClosed Then rsA.Close
    Set rsA = New ADODB.Recordset
    rsA.CursorLocation = adUseClient
    rsA.Open strA1, cnnConnection, adOpenStatic, adLockReadOnly
    With rsA
      If rsA.RecordCount > 0 Then
        rsA.MoveFirst
        Do While Not rsA.EOF
           For intN = 0 To 2
               Randomize Timer
               intNum(intN) = (Fix(Rnd() * 99) + 1) Mod 100
           Next intN
           strA2 = "update TMQAppSumR set TMASR05=" & intNum(0) & ",TMASR06=" & intNum(1) & ",TMASR07=" & intNum(2) & " where TMASR01=" & CNULL(rsA.Fields(0))
           cnnConnection.Execute strA2
           rsA.MoveNext
        Loop
      End If
    End With
    
   '控制人員離職前,先不拿單(ex. 69004要5/15離職,5/10開始不拿單)
   strA1 = "select * from addressa4list where aal01='TSdel' and aal02<=" & CNULL(strSrvDate(1))
   If rsA.State <> adStateClosed Then rsA.Close
     Set rsA = New ADODB.Recordset
     rsA.CursorLocation = adUseClient
     rsA.Open strA1, cnnConnection, adOpenStatic, adLockReadOnly
     With rsA
       If rsA.RecordCount > 0 Then
         rsA.MoveFirst
         Do While Not rsA.EOF
               strA2 = "update TMQAppSumR set TMASR11='N' where TMASR01=" & CNULL(rsA.Fields("AAL04"))
               cnnConnection.Execute strA2, intI
               If intI = 0 Then '如果查名人員檔已刪除,刪除控制記錄
                   strA2 = "delete from tmqmember where tmqm01=" & CNULL(rsA.Fields("AAL04"))
                   cnnConnection.Execute strA2, intI
               End If
               rsA.MoveNext
         Loop
       End If
     End With
   'end 2018/05/09
    
'   2.  統計各類別前2日工作量BY每人
   sDate1 = CompWorkDay(3, strSrvDate(1), 1) '前2個工作天(起)
   'TMA36委查中文筆數 >> TMASR02
   strA2 = " select '02' as ord1,tma10,count(*) cnt from tmqappform,tmqmember " & _
           " where nvl(tma10,'N')<>'N' and to_char(tma04,'yyyymmdd')>=" & CNULL(sDate1, True) & " and to_char(tma04,'yyyymmdd')<" & CNULL(strSrvDate(1), True) & _
           " and tma10=tmqm01(+) and nvl(tma36,0)>0 group by tma10 "
   'TMA37委查英文筆數 >> TMASR03
   strA2 = strA2 & " Union select '03' as ord1,tma10,count(*) cnt from tmqappform,tmqmember " & _
           " where nvl(tma10,'N')<>'N' and to_char(tma04,'yyyymmdd')>=" & CNULL(sDate1, True) & " and to_char(tma04,'yyyymmdd')<" & CNULL(strSrvDate(1), True) & _
           " and tma10=tmqm01(+) and nvl(tma37,0)>0 group by tma10 "
   'TMA38委查圖形筆數 >> TMASR04
   strA2 = strA2 & " Union select '04' as ord1,tma10,count(*) cnt from tmqappform,tmqmember " & _
           " where nvl(tma10,'N')<>'N' and to_char(tma04,'yyyymmdd')>=" & CNULL(sDate1, True) & " and to_char(tma04,'yyyymmdd')<" & CNULL(strSrvDate(1), True) & _
           " and tma10=tmqm01(+) and nvl(tma38,0)>0 group by tma10 "
   strA2 = strA2 & " order by 1,2"
   If rsA.State <> adStateClosed Then rsA.Close
   Set rsA = New ADODB.Recordset
   rsA.CursorLocation = adUseClient
   rsA.Open strA2, cnnConnection, adOpenStatic, adLockReadOnly
   If rsA.RecordCount > 0 Then
      rsA.MoveFirst
      Do While Not rsA.EOF
         strA2 = "update TMQAppSumR set TMASR" & Trim(rsA.Fields("ORD1")) & "=" & rsA.Fields("cnt") & " where TMASR01=" & CNULL(rsA.Fields("TMA10"))
         cnnConnection.Execute strA2
         rsA.MoveNext
      Loop
   End If
       
   '統計人員合計
   strA1 = "select TMQM02,sum(TMASR02) s2,sum(TMASR03) s3,sum(TMASR04) s4 from TMQAppSumR,tmqmember where TMASR01=tmqm01(+) and tmqm01<>tmqm02 group by TMQM02"
   If rsA.State <> adStateClosed Then rsA.Close
   Set rsA = New ADODB.Recordset
   rsA.CursorLocation = adUseClient
   rsA.Open strA1, cnnConnection, adOpenStatic, adLockReadOnly
   With rsA
      If rsA.RecordCount > 0 Then
        rsA.MoveFirst
        Do While Not rsA.EOF
           strA2 = "update TMQAppSumR set TMASR02=" & rsA.Fields("s2") & ",TMASR03=" & rsA.Fields("s3") & ",TMASR04=" & rsA.Fields("s4") & " where TMASR01=" & CNULL(rsA.Fields(0))
           cnnConnection.Execute strA2
           rsA.MoveNext
        Loop
      End If
   End With
     
   '3 將請整天假的查名人員狀態上不可分派查名單
   'Modified by Lydia 2015/07/23  查名人請假=請假前一天和請假當天的狀態為N
    sDate1 = CompWorkDay(2, strSrvDate(1), 0) '系統日+1天
    Dim bol1Days As Boolean 'Added by Lydia 2022/10/25 判斷是否整天請假
    'Modified by Lydia 2019/01/28 查名單分發規則調整如下：
    '1.特休(請)假整日者，前一天不發查名單，
    '2.特休(請)假非整日者，如僅半日或不及半日（小時）之非整日特休（請）假，前一天仍正常發給查名單
    '3.特休(請)假整日者，特休(請)假當日不發查名單
    '4.特休(請)假非整日者，以查名單分發當時段是否上班為原則發給查名單，例：上午請半日特休假，下午上班者，則下午正常發給查名單
    '程式修改第2點和第4點,非整日改由當日判斷是否出缺勤
    'Memo by Lydia 2020/03/05 若有修改規則，請檢視是否一併修改frm160005 ( 人事系統：若銷假人員為查名，自動發email通知「查名人狀態」)
    strA1 = "select '1' or1,st01,SA02 as mDate1,SA03 as mTime1,SA04 as mDate2,SA05 as mTime2,SA07 as mDays,SA08 as mHours,'01' as mKind " & _
                "From Staff_Absence,Staff Where SA01 = ST01 and ((" & strSrvDate(1) & " between SA02 and SA04) or (" & sDate1 & " between SA02 and SA04)) " & _
                "and st01 in (select tmqm01 from tmqmember) "
    strA1 = strA1 & "union select '2' or1,st01,SB02 as mDate1,SB03 as mTime1,SB04 as mDate2,SB05 as mTime2,SB06 as mDays,SB07 as mHours,'01' as mKind " & _
                "From Staff_Busi_Trip,Staff Where SB01 = ST01 and ((" & strSrvDate(1) & " between SB02 and SB04) or (" & sDate1 & " between SB02 and SB04)) " & _
                "and st01 in (select tmqm01 from tmqmember) "
    strA1 = strA1 & "union select  '3' or1,st01,B1004 as mDate1,B1005 as mTime1,B1006 as mDate2,B1007 as mTime2,B1009 as mDays,B1010 as mHours,B1002 as mKind " & _
               "From abs010,Staff Where B1003 = ST01 and ((" & strSrvDate(1) & " between B1004 and B1006) or (" & sDate1 & " between B1004 and B1006)) and B1018<>'06' " & _
               "and not exists (select * from Staff_Absence where sa09=b1001) and not exists (select * from Staff_Busi_Trip where sb10=b1001) " & _
               "and st01 in (select tmqm01 from tmqmember) and b1002<>'02' "
   Dim strGrp As String
   If rsA.State <> adStateClosed Then rsA.Close
     Set rsA = New ADODB.Recordset
     rsA.CursorLocation = adUseClient
     rsA.Open strA1, cnnConnection, adOpenStatic, adLockReadOnly
     With rsA
       If rsA.RecordCount > 0 Then
         rsA.MoveFirst
         Do While Not rsA.EOF
            '判斷請假為整日,就不拿單
            strA1 = ""
            If Val("" & rsA.Fields("mDays")) > 0 Then
                strA1 = CompWorkDay(Val("" & rsA.Fields("mDays")), "" & rsA.Fields("mDate1"))
            '判斷是否整天請假; 改用模組
            ElseIf Val("" & rsA.Fields("mHours")) > 0 Then
                 If CheckIsPersonRest("" & rsA.Fields("st01"), "" & rsA.Fields("mDate1"), Format("" & rsA.Fields("mTime1"), "00:00"), , bol1Days) = True Then
                     If bol1Days = True Then
                        strA1 = CompWorkDay(1, "" & rsA.Fields("mDate1"))
                     End If
                 End If
            End If
            'Added by Lydia 2022/10/18 判斷時數7.5H=1天; ex.上午公假下午補休
            'Mark by Lydia 2022/10/25 改用模組
            If strSrvDate(1) <= strA1 And strA1 <> "" Then
               '檢查出差人員是否異地上班
               If "" & rsA.Fields("mKind") = "03" Then
                    strB1 = "select sp01,sp02,sp03 from staff_workplace where sp01='" & strSrvDate(1) & "' and sp02=" & CNULL(rsA.Fields("st01"))
                    intI = 1
                    Set rsB = ClsLawReadRstMsg(intI, strB1)
                    If intI = 0 Then
                        strA2 = "update TMQAppSumR set TMASR11='N' where TMASR01=" & CNULL(rsA.Fields("st01"))
                        cnnConnection.Execute strA2
                    End If
               Else
                    strA2 = "update TMQAppSumR set TMASR11='N' where TMASR01=" & CNULL(rsA.Fields("st01"))
                    cnnConnection.Execute strA2
               End If
            End If
            rsA.MoveNext
         Loop
       End If
     End With
     
      '3.1 判斷統計人員是否一起放假
      strA1 = "select tmqm02,nvl(tmqm03,'N') tmqm03,count(*) r1,count(TMASR11) r2 from tmqmember,TMQAppSumR where tmqm01<>tmqm02 and tmqm01=TMASR01(+) group by tmqm02,nvl(tmqm03,'N')"
              
      If rsA.State <> adStateClosed Then rsA.Close
      Set rsA = New ADODB.Recordset
      rsA.CursorLocation = adUseClient
      rsA.Open strA1, cnnConnection, adOpenStatic, adLockReadOnly
      With rsA
         If rsA.RecordCount > 0 Then
            rsA.MoveFirst
            Do While Not rsA.EOF
               strA2 = ""
               '是的話有一位請假，這個代號今天請假,否的話有一位上班，這個代號今天可排單
               If (rsA.Fields("tmqm03") = "Y" And rsA.Fields("r2") >= 1) Or _
                  (rsA.Fields("tmqm03") <> "Y" And rsA.Fields("r1") = rsA.Fields("r2")) Then
                  strA2 = "update TMQAppSumR set TMASR11='N' where TMASR01=" & CNULL(rsA.Fields(0))
                  cnnConnection.Execute strA2
               End If
               rsA.MoveNext
            Loop
         End If
      End With
      'Added by Lydia 2022/07/05 因為查名中心人員請假過半，為了公平採用全部人員都分發查名單，但是期限+2天
      'Modified by Lydia 2023/07/06 因7月7日(Fri.)及10日(Mon.)有多數查名同仁請假半，為了公平採用全部人員都分發查名單，但是期限+2天
      If Pub_GetTmqAllDate(strSrvDate(1)) = True Then
          strA2 = "update TMQAppSumR set TMASR11=null "
          cnnConnection.Execute strA2
      End If

cnnConnection.CommitTrans

   'Added by Lydia 2017/01/20
   '4. 若查名單是在下午六點以後輸入，系統不分發，即不顯示查名人。俟系統在凌晨根據查名人員出缺勤狀況，再分發查名單，即此時可顯示查名人。
   strA1 = Pub_GetSpecMan("內商查名單分單狀態")
   If UCase(strA1) <> "N" Then
      '排除已撤回的單據
      strA1 = "select tma01,tma20,tma25,to_char(tma07,'yyyymmdd') as tma07d from TMQAppForm where nvl(TMA10,'N')='N' and TMA14 is null "
      If rsA.State <> adStateClosed Then rsA.Close
      Set rsA = New ADODB.Recordset
      rsA.CursorLocation = adUseClient
      rsA.Open strA1, cnnConnection, adOpenStatic, adLockReadOnly
      If rsA.RecordCount > 0 Then
         rsA.MoveFirst
         cnnConnection.BeginTrans
         Do While Not rsA.EOF
            strQuser = PUB_GetTMAUserPos("" & rsA.Fields("TMA25"))
            If strQuser <> "" Then
               '視情況重新計算期限
               strA1 = "": strExc(2) = "": strExc(3) = ""
               strExc(3) = Left(Format(ServerTime, "000000"), 4)
               '參考frm090126_New：送出期限TMA12/查覆期限TMA11：團體標章和證明標章仍舊由查名人負責，設定為19221111
               If "" & rsA.Fields("tma20") <> "" Then
                  strExc(2) = PUB_GetNewTMADate(IIf("" & rsA.Fields("tma25") = "1", "4", "5"), strSrvDate(1), strExc(3), strExc(1))
                  strA1 = ", TMA12=19221111, TMA11=" & strExc(2)
               Else
                  '只能預設送出期限，查覆期限>>1.TMA07回寫日期Trigger觸發計算 2.遇見不發單時間改成批次
                  strExc(2) = PUB_GetNewTMADate("" & rsA.Fields("tma25"), strSrvDate(1), strExc(3), strExc(1))
                  If "" & rsA.Fields("tma07d") = "" Then   '網中未回寫，只能預設送出期限
                     strA1 = ", TMA12=" & strExc(2) & " "
                  Else    '網中已回寫，重新計算查覆期限
                     strA1 = ", TMA11=" & strExc(2) & " "
                  End If
               End If
              
               '收件日期變更為分發查名人的工作日+重新計算期限
               strA2 = "update TMQAppForm set TMA10=" & CNULL(strQuser) & ",TMA09=" & strSrvDate(1) & strA1 & " where TMA01=" & CNULL(rsA.Fields("TMA01"))
               cnnConnection.Execute strA2
               '更新當日拿單量
               Call PUB_TMAtoTake("2", strQuser, rsA.Fields("TMA25"), "1", False)
            End If
            rsA.MoveNext
         Loop
         cnnConnection.CommitTrans
      End If
  End If
  
ErrHandle:
   If Err.Number <> 0 Then
      WLog "查名單(網中)-查名單量統計和排序:" & Err.Description
      cnnConnection.RollbackTrans
   End If
   Set rsA = Nothing
   Set rsB = Nothing
   
End Sub

'Add By Sindy 2024/11/15 紙本送件掃瞄上傳卷宗區稽核
'為因應11/1開始，FCP新案收文不立卷宗，若有紙本送件後，程序人員應確實掃瞄送件申請書等，上傳卷宗區之控管稽核
'當已發文且是否算發文件數為 Y(表示紙本送件)
'設定發文日起算2個工作天 (含當日), 該道案件性質卷宗區, 未有一道.data(申請書), 則系統自動發email通知該案程序管制人員
Private Sub StrMenu137()
   Dim stSQL As String, intQ As Integer
   Dim stSDate As String, stEDate As String
   Dim rsQuery As ADODB.Recordset
   Dim stText As String, stTO As String, stCC As String
   
On Error GoTo ErrHandle
   
   stSDate = "20241113" '之前的 已清查 1130101~1131113 為紙本送件，未掃瞄上傳卷宗區的清單 給外專程序管制人員
   stEDate = CompWorkDay(3, strSrvDate(1), 1) 'ex:系統日為113/11/15 則抓出 113/11/13
   stSQL = "SELECT DECODE(PA01,'P',DECODE(SUBSTR(ANO,1,1),'Y',NVL(N1.NA79,N1.NA16),NVL(N2.NA79,N2.NA16)),'PS',DECODE(SUBSTR(ANO,1,1),'Y',NVL(N1.NA79,N1.NA16),NVL(N2.NA79,N2.NA16)),NVL(N1.NA16,N2.NA16)) NA16" & _
           ",ANO,SRT,cp01,cp02,cp03,cp04,cp09,cpm03,cp27,cp83,st02,st52,st53,st54" & _
           " From (SELECT PA01,NVL(PA75,PA26) ANO, 91 SRT,cp01,cp02,cp03,cp04,cp09,cp10,cp27,cp83 FROM PATENT,caseprogress" & _
           " WHERE cp01='FCP' and cp27<=" & stEDate & " and cp27>=" & stSDate & " and cp123='Y'" & _
           " and cp01=pa01(+) and cp02=pa02(+) and cp03=pa03(+) and cp04=pa04(+) and pa01 is not null" & _
           " and not exists(select cpp01 from casepaperpdf where cpp01=cp09 and instr(upper(cpp02),upper('.data.'))>0)" & _
           " UNION ALL SELECT SP01,NVL(SP26,SP08) ANO, 92 SRT,cp01,cp02,cp03,cp04,cp09,cp10,cp27,cp83 FROM SERVICEPRACTICE,caseprogress" & _
           " WHERE cp01='FG' and cp27<=" & stEDate & " and cp27>=" & stSDate & " and cp123='Y'" & _
           " and cp01=sp01(+) and cp02=sp02(+) and cp03=sp03(+) and cp04=sp04(+) and sp01 is not null" & _
           " and not exists(select cpp01 from casepaperpdf where cpp01=cp09 and instr(upper(cpp02),upper('.data.'))>0)" & _
           " ) X1,FAGENT,CUSTOMER,NATION N1,NATION N2,staff,casepropertymap" & _
           " WHERE SUBSTR(ANO,1,8)=FA01(+) AND SUBSTR(ANO,9,1)=FA02(+)" & _
           " AND SUBSTR(ANO,1,8)=CU01(+) AND SUBSTR(ANO,9,1)=CU02(+)" & _
           " AND FA10=N1.NA01(+) AND CU10=N2.NA01(+)" & _
           " and DECODE(PA01,'P',DECODE(SUBSTR(ANO,1,1),'Y',NVL(N1.NA79,N1.NA16),NVL(N2.NA79,N2.NA16)),'PS',DECODE(SUBSTR(ANO,1,1),'Y',NVL(N1.NA79,N1.NA16),NVL(N2.NA79,N2.NA16)),NVL(N1.NA16,N2.NA16))=st01(+)" & _
           " and cp01=cpm01(+) and cp10=cpm02(+)" & _
           " order by st01,st27,cp01,cp02,cp03,cp04"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      stText = ""
      With rsQuery
      Do While Not .EOF
         stTO = "" & .Fields("NA16") '該案程序管制人員
         stCC = "" & .Fields("st52") & IIf("" & .Fields("st53") = "", "", ";" & .Fields("st53")) '主管(主任及副理)
         stText = .Fields("cp01") & "-" & .Fields("cp02") & "【" & .Fields("cpm03") & "】為紙本送件，未掃瞄上傳卷宗區，請儘速作業。"
         SendMAPIMail stTO, stText, "同主旨", , , , stCC
         .MoveNext
      Loop
      End With
   End If
   Set rsQuery = Nothing
   Exit Sub
   
ErrHandle:
   If Err.Number <> 0 Then
      WLog Err.Description
   End If

End Sub

'Add By Sindy 2024/12/11 檢查可補休資料
Sub StrMenu138()
Dim rsTmp As New ADODB.Recordset
Dim ff As Integer
Dim A01 As String
Dim A02 As String
Dim A03 As String, A04 As String
Dim iCount As Integer
Dim TempFileName As String
Dim TempSendMailSeek As String
Dim TempSendMailSeek1 As String
Dim tmpnext As String
Dim ChkDate As String
Dim dblTmpHour As Double
Dim SendMailTo As Variant
Dim strSRR01 As String, strSRR02 As String
Dim strSRR05 As String 'Add By Sindy 2025/2/11
Dim strTemp As String, strRefSrr01 As String, dblTotSRR03 As Double
Dim i As Integer
Dim bolConn As Boolean
Dim strText As String

On Error GoTo DebugErr

'**************************************************
'檢查可補休是否已過期
'**************************************************
   '前1日
   ChkDate = CompDate(2, -1, strSrvDate(1))
   
   strSql = "select SRR02,min(SRR01) as SRR01 from Staff_RepayRest,staff" & _
            " where SRR05=" & ChkDate & _
            " and SRR02=ST01(+) and st04='1' and SRR12 is null" & _
            " group by SRR02" & _
            " order by SRR02,SRR01"
   CheckOC
   Set Rs = New ADODB.Recordset
   Rs.CursorLocation = adUseClient
   Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   With Rs
      If .RecordCount > 0 Then
         .MoveFirst
         Do While Not .EOF
            strSRR02 = Rs.Fields("SRR02") '人員
            strSRR01 = Rs.Fields("SRR01") '最早發生日期
            '取得是否有未休天數
            Call GetCurrFor14RestDay(strSRR02, 2, strSRR01, strRefSrr01, dblTotSRR03, dblTmpHour, ChkDate)
            If dblTmpHour > 0 Then
               '郵件內容
               strTemp = GetPrjSalesNM(strSRR02) & "同仁，您好：" & vbCrLf & vbCrLf
               strTemp = strTemp & "　　通知您 可補休已過期的資料，如下：" & vbCrLf & vbCrLf
               '抓出此到期日可補休資料,逐筆檢查
               strSql = "select * from Staff_RepayRest" & _
                        " where SRR01>=" & strRefSrr01 & " and SRR05<=" & ChkDate & _
                        " and SRR02='" & strSRR02 & "'" & _
                        " order by SRR05 desc,SRR01 desc"
               intI = 1
               Set rsTmp = ClsLawReadRstMsg(intI, strSql)
               If intI = 1 Then
                  cnnConnection.BeginTrans: bolConn = True
                  rsTmp.MoveFirst
                  Do While dblTmpHour > 0
                     If strTemp <> "" Then strTemp = strTemp & vbCrLf
                     strTemp = strTemp & "發生日期：" & ChangeWStringToTDateString(rsTmp.Fields("SRR01")) & vbCrLf
                     strTemp = strTemp & "可補休時數：" & rsTmp.Fields("SRR03") & vbCrLf
                     strTemp = strTemp & "事由：" & rsTmp.Fields("SRR04") & vbCrLf
                     strTemp = strTemp & "補休到期日：" & ChangeWStringToTDateString(rsTmp.Fields("SRR05")) & vbCrLf
                     
                     'Modify By Sindy 2025/1/22 人事處決定:半夜系統裡的（補休時數過期提醒信與更新過期時數）先關閉
                     If rsTmp.Fields("SRR03") >= dblTmpHour Then
'                        strSql = "UPDATE Staff_RepayRest SET SRR12='" & dblTmpHour & "'" & _
'                                 " WHERE SRR01='" & rsTmp.Fields("SRR01") & "'" & _
'                                 " and SRR02='" & rsTmp.Fields("SRR02") & "'"
                        strTemp = strTemp & "過期時數：" & dblTmpHour & vbCrLf
                        dblTmpHour = 0
                     Else
'                        strSql = "UPDATE Staff_RepayRest SET SRR12='" & rsTmp.Fields("SRR03") & "'" & _
'                                 " WHERE SRR01='" & rsTmp.Fields("SRR01") & "'" & _
'                                 " and SRR02='" & rsTmp.Fields("SRR02") & "'"
                        strTemp = strTemp & "過期時數：" & rsTmp.Fields("SRR03") & vbCrLf
                        dblTmpHour = dblTmpHour - rsTmp.Fields("SRR03")
                     End If
'                     Pub_SeekTbLog strSql
'                     cnnConnection.Execute strSql
                     
                     rsTmp.MoveNext
                  Loop
                  If dblTmpHour = 0 Then '折抵正常
                     cnnConnection.CommitTrans: bolConn = False
                  Else '折抵有誤,電腦中心需再查看
                     cnnConnection.RollbackTrans: bolConn = False
                  End If
               End If
               '通知郵件
               If dblTmpHour = 0 Then
'                  strTemp = strTemp & vbCrLf & "　　　　　　資料若有疑慮，請洽人事處" & vbCrLf
'                  SendMAPIMail strSRR02, "可補休已過期通知", strTemp, , , True, Pub_GetSpecMan("人事室出缺勤電子簽核"), "97038"
                  'Modify By Sindy 2025/4/8 開放通知人事處,確認資料後更新過期時數
                  SendMAPIMail Pub_GetSpecMan("人事室出缺勤電子簽核"), "有可補休已過期資料發生（請確認資料後更新過期時數）!!", strTemp, , , True, , "97038"
               Else
                  SendMAPIMail "97038", "可補休已過期,在折抵後有問題(dblTmpHour = " & dblTmpHour & ") 需查看!!", strTemp, , , True
               End If
            End If
            
            .MoveNext
         Loop
      End If
   End With
   
'**************************************************
'檢查可補休是否未休完
'**************************************************
   '給人事處的清單,僅一封
   TempFileName = "可補休但尚未休完通知"
   If Dir(App.path & TextPath & "*" & TempFileName & "*.txt") <> "" Then
      Kill App.path & TextPath & "*" & TempFileName & "*.txt"
   End If

   strText = ""
   TempSendMailSeek = "": TempSendMailSeek1 = ""
   For i = 1 To 2
      'i = 1 :1個月前
      'i = 2 :2個月前
      ChkDate = DBDATE(DateAdd("m", i, Format(strSrvDate(1), "####/##/##")))
      
      strSql = "select SRR02,SRR01,SRR05 from Staff_RepayRest,staff" & _
               " where SRR05=" & ChkDate & _
               " and SRR02=ST01(+) and st04='1' order by SRR02,SRR01"
      CheckOC
      Set Rs = New ADODB.Recordset
      Rs.CursorLocation = adUseClient
      Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      tmpnext = "已取得資料..."
      With Rs
         If .RecordCount > 0 Then
            .MoveFirst
'            ff = FreeFile
'            TempFileName = ChkDate & "(" & i & "個月前)" & TempFileName
            
            Do While Not .EOF
               strSRR02 = Rs.Fields("SRR02") '人員
               strSRR01 = Rs.Fields("SRR01") '發生日期
               strSRR05 = Rs.Fields("SRR05") '到期日 Add By Sindy 2025/2/11
               '取得未休天數
               Dim strCanRestSRR01 As String
               Call GetCurrFor14RestDay(strSRR02, 2, strSRR05, , , dblTmpHour, , , strCanRestSRR01)
               If dblTmpHour > 0 And InStr(TempSendMailSeek, strSRR02) = 0 Then
                  If Val(strCanRestSRR01) <= Val(strSRR01) Then
                     '欲給人事室的資料清單
                     If TempSendMailSeek = "" Then
   '                     If ff > 0 Then Close #ff
   '                     ff = FreeFile
   '                     Open App.path & TextPath & TempFileName & ".txt" For Output As ff
                        strText = strText & IIf(strText <> "", vbCrLf, "") & Space(10) & TempFileName & "(" & IIf(i = 1, "1個月前", "2個月前") & ")" & vbCrLf & vbCrLf
   '                     Print #ff, ""
                        strText = strText & "部門別               員工姓名        發生日期     到期日" & vbCrLf
                        strText = strText & "==================== =============== ============ ============" & vbCrLf
                     End If
                     'E-Mail通知下一處理人員做資料確認
                     If InStr(1, TempSendMailSeek, strSRR02) = 0 Then
                        TempSendMailSeek = TempSendMailSeek & "," & strSRR02
                     End If
                     tmpnext = "開檔中..."
                     A01 = "" & convForm(GetDeptNameA0922(strSRR02), 20)
                     A02 = "" & convForm(strSRR02 & " " & GetPrjSalesNM(strSRR02), 15)
                     A03 = "" & convForm(Format(strSRR01, "@@@@/@@/@@"), 12)
                     A04 = "" & convForm(Format(Rs.Fields("SRR05"), "@@@@/@@/@@"), 12)
                     tmpnext = "寫檔..."
                     strText = strText & A01 & " " & A02 & " " & A03 & " " & A04 & vbCrLf
                  End If
               End If
               
               .MoveNext
            Loop
            If i = 1 Then TempSendMailSeek1 = TempSendMailSeek: TempSendMailSeek = "" '記錄下來,後面寄信
         End If
      End With
   Next i
   'Close ff
   tmpnext = "關檔..."
   If strText <> "" Then
      If TempSendMailSeek = "" Then
         TempSendMailSeek = TempSendMailSeek1
      Else
         TempSendMailSeek = TempSendMailSeek & IIf(TempSendMailSeek1 <> "", "," & TempSendMailSeek1, "")
      End If
      If Left(TempSendMailSeek, 1) = "," Then TempSendMailSeek = Mid(TempSendMailSeek, 2)
      Call PUB_CompRepeatReple(TempSendMailSeek, "") '過濾重覆值,傳回值的間隔為;
      '發 mail 通知當事人
      SendMailTo = Split(TempSendMailSeek, ";")
      For iCount = 0 To UBound(SendMailTo)
         If SendMailTo(iCount) <> "" Then
            SendMAPIMail CStr(SendMailTo(iCount)), TempFileName, "Dear Sirs," & vbCrLf & "          可至 共同查詢\員工姓名查詢員工資料 查看可補休資料。" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", , , True
         End If
      Next iCount
      
      Call PUB_SaveTextAsUTF8(App.path & TextPath & TempFileName & ".txt", strText)
      '發 mail 給人事室
      SendMAPIMail Pub_GetSpecMan("人事室出缺勤電子簽核"), TempFileName, "Dear Sirs," & vbCrLf & "          " & TempFileName & "清單 如附件！" & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心", App.path & TextPath & TempFileName & ".txt"
   End If
   
Set Rs = Nothing
Set rsTmp = Nothing
Exit Sub

DebugErr:
   If bolConn = True Then
      cnnConnection.RollbackTrans: bolConn = False
   End If
   WLog tmpnext & " " & Err.Description
End Sub

'Add By Sindy 2025/2/3 稽核有掛相關卷號FCL未分案，於隔日發通知提醒分案人員
Private Sub StrMenu139()
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   
On Error GoTo ErrHandle
   
   'Modify By Sindy 2025/2/11 亭妙說排除C類公文(大部分機關來函，是系統自動抓上一道承辦工程師，因此不會再操作分案。)
   stSQL = "select cp01,cp02,cp03,cp04,cp09 from caseprogress,CASERELATION1 where cp01='FCP' and cp158=0 and cp159=0" & _
           " and cr01(+)=cp01 and cr02(+)=cp02 and cr03(+)=cp03 and cr04(+)=cp04" & _
           " and Cr05='FCL' and cp122 is null" & _
           " and (substr(cp09,1,1)='A' or substr(cp09,1,1)='B')"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      With rsQuery
      .MoveFirst
      Do While Not .EOF
         SendMAPIMail Pub_GetSpecMan("C"), "注意! 尚未分案 " & rsQuery.Fields("cp01") & "-" & rsQuery.Fields("cp02") & _
                      IIf(rsQuery.Fields("cp03") & rsQuery.Fields("cp04") = "000", "", "-" & rsQuery.Fields("cp03") & "-" & rsQuery.Fields("cp04")) _
                      , "", , , , , , , rsQuery.Fields("cp09"), True
         .MoveNext
      Loop
      End With
   End If
   Set rsQuery = Nothing
   Exit Sub
   
ErrHandle:
   If Err.Number <> 0 Then
      WLog Err.Description
   End If
End Sub

'Added by Lydia 2025/04/23 外專工程師寄信稽核作業：承辦人是掛工程師的C類來函(不含核准1001)、告代、回代、會稿，上發文日的隔1工作天請去稽核卷宗區有無"寄OA函(.REPOA.)""報告(.REP.)"，則發mail給各區程序人員，CC主管
Private Sub StrMenu140()
Dim rsQD As New ADODB.Recordset
Dim intQ As Integer, strQ1 As String, strDate1 As String
Dim strCon1 As String
Dim xlsAgentPoint As New Excel.Application
Dim wksrpt As New Worksheet
Dim xlsFileName1 As String
Dim stTmp, intWidth
Dim intCounter As Integer, intB As Integer
Dim strGrp As String, strCC As String
    
On Err GoTo ErrHandle
   
   strDate1 = CompWorkDay(2, strSrvDate(1), 1) '前一個工作天
   
   '附件名稱
   xlsFileName1 = "工程師寄信稽核.xls"
   'FCP案+FMP案：C類來函(不含核准1001)、告代、回代、會稿
   strCon1 = " and ((substr(cp09,1,1)='C' and cp10 not in ('1001')) or cp10 in ('901','902','924')) "
   strQ1 = "select cp83,cp158,decode(pa09,'000',na16,na79) as fcpman,na01,cp01,cp02,cp03,cp04 " & _
           ",cp09 ,decode(pa09,'000',nvl(cpm03,cpm04),nvl(cpm04,cpm03)) as cp10n " & _
           "from (select cp83,cp158,cp01,cp02,cp03,cp04,cp09,cp10,cp14,st02,sum(decode(instr(upper(cpp02),'.REPOA.'),0,0,1)) cnt1,sum(decode(instr(upper(cpp02),'.REP.'),0,0,1)) cnt2 " & _
           "from caseprogress c1, staff,casepaperpdf where (cp01='FCP' or (cp01='P' and cp12 like 'F%')) and cp158=" & strDate1 & " and cp14=st01(+) and st03='F21' " & _
           strCon1 & "and cp09=cpp01(+) and nvl(cpp10,'N') <> 'D' " & _
           "group by cp83,cp158,cp01,cp02,cp03,cp04,cp09,cp10,cp14,st02 ) vtb1,patent,fagent,nation,casepropertymap " & _
           "where cp01=pa01(+) and cp02=pa02(+) and cp03=pa03(+) and cp04=pa04(+) and substr(pa75,1,8)=fa01(+) and substr(pa75,9,1)=fa02(+) " & _
           "and fa10=na01(+) and cp01=cpm01(+) and cp10=cpm02(+) and cnt1+cnt2=0 "
   strQ1 = strQ1 & "order by cp83,cp01,cp02,cp03,cp04,cp09 "
   intQ = 1
   Set rsQD = ClsLawReadRstMsg(intQ, strQ1)
   If intQ = 1 Then
      stTmp = Array("本所案號", "收文號", "案件性質", "發文日期")
      intWidth = Array(15, 15, 15, 15)
      rsQD.MoveFirst
      Do While Not rsQD.EOF
         strExc(0) = "select cpp01,cpp02 from caseprogress,casepaperpdf where cp01='" & rsQD.Fields("cp01") & "' and cp02='" & rsQD.Fields("cp02") & "' and cp03='" & rsQD.Fields("cp03") & "' and cp04='" & rsQD.Fields("cp04") & "' " & _
                     "and cp158='" & strDate1 & "' " & strCon1 & " and cp09=cpp01(+) and nvl(cpp10,'N') <> 'D' and (instr(upper(cpp02),'.REPOA.') > 0 or instr(upper(cpp02),'.REP.') > 0) "
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
             GoTo JumpToNext
         End If
         If strGrp <> "" & rsQD.Fields("CP83") Then
            If strGrp <> "" Then
               xlsAgentPoint.Sheets(1).Select '選擇工作表
               If Val(xlsAgentPoint.Version) < 12 Then
                  xlsAgentPoint.Workbooks(1).SaveAs FileName:=App.path & TextPath & xlsFileName1, FileFormat:=-4143
               Else
                  xlsAgentPoint.Workbooks(1).SaveAs FileName:=App.path & TextPath & xlsFileName1, FileFormat:=56
               End If
               xlsAgentPoint.Workbooks.Close
               xlsAgentPoint.Quit
               Set xlsAgentPoint = Nothing
               Set wksrpt = Nothing
               '清單請寄給key那道性質的發文操作人員，CC給操作人員之主管、程序管制人員（若同發文操作人員，則可不用）
               strExc(1) = PUB_GetFCPProSup(strGrp)
               SendMAPIMail strGrp, ChangeTStringToTDateString(strSrvDate(2)) & "外專工程師寄信稽核作業", "附件EXCEL的工程師報告已上發文日，但卷宗區副檔名說明未有""寄OA函""、""報告""，請確認報告信是否有寄出。", App.path & TextPath & xlsFileName1, , , strExc(1) & IIf(strCC <> "", ";" & strCC, "")
            End If
            If Dir(App.path & TextPath & xlsFileName1) <> "" Then
               Kill App.path & TextPath & xlsFileName1
            End If
            intCounter = 1
            xlsAgentPoint.SheetsInNewWorkbook = 1 '預設工作表數目
            xlsAgentPoint.Workbooks.add
            xlsAgentPoint.Application.WindowState = xlMinimized
            xlsAgentPoint.Application.Visible = False
            Set wksrpt = xlsAgentPoint.Worksheets(1)
            '設定欄位名稱及欄寬
            For intB = LBound(stTmp) To UBound(stTmp)
                wksrpt.Range(Chr(intB + 65) & intCounter).Value = stTmp(intB)
                wksrpt.Columns(Chr(intB + 65) & ":" & Chr(intB + 65)).ColumnWidth = intWidth(intB)
                '全部置中
                wksrpt.Range(Chr(intB + 65) & ":" & Chr(intB + 65)).HorizontalAlignment = xlCenter
            Next intB
            intCounter = 2
         End If
         wksrpt.Range("A" & intCounter).Value = "" & rsQD.Fields("cp01") & "-" & rsQD.Fields("cp02") & IIf("" & rsQD.Fields("cp03") & rsQD.Fields("cp04") = "000", "", "-" & rsQD.Fields("cp03") & "-" & rsQD.Fields("cp04")) '本所案號
         wksrpt.Range("B" & intCounter).Value = "" & rsQD.Fields("cp09")
         wksrpt.Range("C" & intCounter).Value = "" & rsQD.Fields("cp10n")
         wksrpt.Range("D" & intCounter).Value = TransDate("" & rsQD.Fields("cp158"), 1)
         
         intCounter = intCounter + 1
         strGrp = "" & rsQD.Fields("CP83")
         If "" & rsQD.Fields("CP83") = "" & rsQD.Fields("FCPMAN") Then
            strCC = ""
         Else
            strCC = "" & rsQD.Fields("FCPMAN")
         End If
JumpToNext:
         rsQD.MoveNext
      Loop
      If strGrp <> "" Then
         xlsAgentPoint.Sheets(1).Select '選擇工作表
         If Val(xlsAgentPoint.Version) < 12 Then
            xlsAgentPoint.Workbooks(1).SaveAs FileName:=App.path & TextPath & xlsFileName1, FileFormat:=-4143
         Else
            xlsAgentPoint.Workbooks(1).SaveAs FileName:=App.path & TextPath & xlsFileName1, FileFormat:=56
         End If
         xlsAgentPoint.Workbooks.Close
         xlsAgentPoint.Quit
         Set xlsAgentPoint = Nothing
         Set wksrpt = Nothing
         strExc(1) = PUB_GetFCPProSup(strGrp)
         SendMAPIMail strGrp, ChangeTStringToTDateString(strSrvDate(2)) & "外專工程師寄信稽核作業", "附件EXCEL的工程師報告已上發文日，但卷宗區副檔名說明未有""寄OA函""、""報告""，請確認報告信是否有寄出。", App.path & TextPath & xlsFileName1, , , strExc(1)
      End If
   End If
   Set rsQD = Nothing
   
   Exit Sub
   
ErrHandle:
   If Err.Number <> 0 Then
      WLog "外專工程師寄信稽核作業:" & Err.Description
   End If
End Sub

'add by sonia 2025/4/28 專用期過期半年或閉卷半年(抓6~7個月)者補上可結餘日
Private Sub StrMenu141()
Dim intQ2 As Integer, strDate1 As String, StrDate2 As String
Dim rsQ1 As New ADODB.Recordset, rsQ2 As New ADODB.Recordset
Dim strQ1 As String, strQ2 As String, strUpd As String
Dim strMsg As String
    
On Error GoTo ErrHand
    
   StrDate2 = CompDate(1, -6, strSrvDate(1))
   strDate1 = CompDate(1, -7, strSrvDate(1))
   StrDate2 = Val(Left(StrDate2, 6) * 100) + 31
   strDate1 = Val(Left(strDate1, 6) * 100) + 1
   
   strQ1 = "Select distinct pa01,pa02,pa03 From patent where pa09<>'000' and pa04='00' and ((pa25>=" & strDate1 & " and pa25<=" & StrDate2 & ") OR (pa58>=" & strDate1 & " and pa58<=" & StrDate2 & ")) Order by 1,2,3"
   If rsQ1.State <> adStateClosed Then rsQ1.Close
   rsQ1.CursorLocation = adUseClient
   rsQ1.Open strQ1, cnnConnection, adOpenStatic, adLockReadOnly
   If rsQ1.RecordCount > 0 Then
      rsQ1.MoveFirst
      cnnConnection.BeginTrans
      Do While rsQ1.EOF = False
         strQ2 = "Select ax201,Sum(Ax207)-Sum(Ax206) as Amt From Acc021 Where Ax205 Like '2201%' and ax214 like '" & rsQ1.Fields("pa01") & rsQ1.Fields("pa02") & rsQ1.Fields("pa03") & "%' " & _
                 "Group By ax201 Having Sum(Ax206) <> Sum(Ax207) "
         intQ2 = 1
         Set rsQ2 = ClsLawReadRstMsg(intQ2, strQ2)
         If intQ2 > 0 Then
            'modify by sonia 2025/6/6 取消cp27 is not null條件，否則新案未發文即閉卷但規費不平就不會做P-132026
            'modify by sonia 2025/8/4 加入nvl(CP109,0)=0條件，否則會蓋掉原本的可結餘日P-099999
            strUpd = "update caseprogress set cp109=" & strSrvDate(1) & ",cp146=null" & _
                     " where cp01='" & rsQ1.Fields("pa01") & "' and cp02='" & rsQ1.Fields("pa02") & "' and cp03='" & rsQ1.Fields("pa03") & "' and cp60 is not null and cp59 is null and nvl(CP109,0)=0"
            cnnConnection.Execute strUpd
         End If
         rsQ1.MoveNext
      Loop
      cnnConnection.CommitTrans
   End If
   
   Set rsQ1 = Nothing
   Set rsQ2 = Nothing
   Exit Sub
   
ErrHand:
   cnnConnection.RollbackTrans
   WLog strMsg & "專用期過期半年或閉卷半年者補上可結餘日，資料更新失敗" & " " & Err.Description
End Sub

'Added by Lydia 2025/06/05 外專程序大項作業稽核：上發文日的隔1工作天請去稽核卷宗區有「下述案件性質對應的副檔說明」或者有「平台上傳(.UPL)」，二者皆無則發mail給承辦人
Private Sub StrMenu142()
Dim rsQD As New ADODB.Recordset
Dim intQ As Integer, strQ1 As String, strDate1 As String
Dim xlsAgentPoint As New Excel.Application
Dim wksrpt As New Worksheet
Dim xlsFileName1 As String
Dim stTmp, intWidth
Dim intCounter As Integer, intB As Integer
Dim strGrp As String
Dim strCon1 As String, strCon2 As String 'Added by Lydia 2025/01/16
    
On Err GoTo ErrHandle

   strDate1 = CompWorkDay(2, strSrvDate(1), 1) '上發文日的隔1工作天
  
   '附件名稱
   xlsFileName1 = "程序大項作業稽核.xls"
   
   '參考frm060118的語法
   strQ1 = ""
   For intQ = 1 To 7
      
      '稽核卷宗區有「下述案件性質對應的副檔說明」或者有「平台上傳(.UPL)」 'Modified by Lydia 2025/06/16 加上工程師的報告(.REP.)
      strCon1 = ""
      Select Case intQ
         Case 1 '告准函
           strCon1 = "1917"
           strCon2 = "AND (UPPER(CPP02) LIKE '%.ALLW.%' OR UPPER(CPP02) LIKE '%.UPL.%' OR UPPER(CPP02) LIKE '%.REP.%')"
         Case 2 '專利證書
           strCon1 = "1603"
           strCon2 = "AND (UPPER(CPP02) LIKE '%.CRT.%' OR UPPER(CPP02) LIKE '%.UPL.%' OR UPPER(CPP02) LIKE '%.REP.%')"
         Case 3 '公開公報
           strCon1 = "1229"
           strCon2 = "AND (UPPER(CPP02) LIKE '%.PBL.%' OR UPPER(CPP02) LIKE '%.UPL.%' OR UPPER(CPP02) LIKE '%.REP.%')"
         Case 4 '專利權消滅
           strCon1 = "1604"
           strCon2 = "AND (UPPER(CPP02) LIKE '%.TX.%' OR UPPER(CPP02) LIKE '%.UPL.%' OR UPPER(CPP02) LIKE '%.REP.%')"
         Case 5 '通知年費逾期
           strCon1 = "1605"
           strCon2 = "AND (UPPER(CPP02) LIKE '%.TX.%' OR UPPER(CPP02) LIKE '%.UPL.%' OR UPPER(CPP02) LIKE '%.REP.%')"
         Case 6 '期限通知-年費
           strCon1 = "1913-605"
           strCon2 = "AND (UPPER(CPP02) LIKE '%.TX.%' OR UPPER(CPP02) LIKE '%.UPL.%' OR UPPER(CPP02) LIKE '%.REP.%')"
         Case 7 '期限通知-實體審查
           strCon1 = "1913-416"
           strCon2 = "AND (UPPER(CPP02) LIKE '%.TX.%' OR UPPER(CPP02) LIKE '%.UPL.%' OR UPPER(CPP02) LIKE '%.REP.%')"
      End Select
      If strCon1 <> "" Then
         If InStr(strCon1, "-") = 0 Then
            strQ1 = strQ1 & " Union select '" & intQ & "' ord1, cp01,cp02,cp03,cp04,cp05,cp09,cp10,cp14,st02,decode(pa09,'000',nvl(cpm03,cpm04),nvl(cpm04,cpm03)) as cpm03,cnt " & _
                   "from caseprogress ,staff ,patent,casepropertymap " & _
                   ",(select cpp01,count(*) cnt from caseprogress,casepaperpdf where cp01='FCP' and cp10='" & strCon1 & "' and cp158=" & strDate1 & " and cp09=cpp01(+) and nvl(cpp10,'N') <> 'D' " & strCon2 & " group by cpp01) vtb01 " & _
                   "where cp01='FCP' and cp10='" & strCon1 & "' and cp158=" & strDate1 & " and cp01=pa01(+) and cp02=pa02(+) and cp03=pa03(+) and cp04=pa04(+) " & _
                   "and cp14=st01(+) and cp01=cpm01(+) and cp10=cpm02(+) and cp09=cpp01(+) and nvl(cnt,0)=0"
         Else
            strExc(1) = Mid(strCon1, 1, InStr(strCon1, "-") - 1)
            '相關收文號的案件性質
            strExc(2) = Mid(strCon1, InStr(strCon1, "-") + 1)
            strQ1 = strQ1 & " Union select '" & intQ & "' ord1, cp01,cp02,cp03,cp04,cp05,cp09,cp10,cp14,st02,'通知期限-'||decode(pa09,'000',nvl(cpm03,cpm04),nvl(cpm04,cpm03)) as cpm03,cnt " & _
                   "from caseprogress ,staff ,patent,nextprogress,casepropertymap " & _
                   ",(select cpp01,count(*) cnt from caseprogress,casepaperpdf where cp01='FCP' and cp10='" & strExc(1) & "' and cp158=" & strDate1 & " and cp09=cpp01(+) and nvl(cpp10,'N') <> 'D' " & strCon2 & " group by cpp01) vtb01 " & _
                   "where cp01='FCP' and cp10='" & strExc(1) & "' and cp158=" & strDate1 & " and cp43=np01(+) and cp30=np22(+) and np07='" & strExc(2) & "' and cp01=pa01(+) and cp02=pa02(+) and cp03=pa03(+) and cp04=pa04(+) " & _
                   "and cp14=st01(+) and np02=cpm01(+) and np07=cpm02(+) and cp09=cpp01(+) and nvl(cnt,0)=0"
         End If
      End If
   Next intQ
   'Modified by Lydia 2025/07/01 排除非E化案
   'strQ1 = Mid(strQ1, 7) & " order by cp14,cp01,ord1,cp05 "
   strQ1 = "select * from (" & Mid(strQ1, 7) & ") where nvl(getemailflag(cp09),'N')<>'N'"
   strQ1 = strQ1 & " order by cp14,cp01,ord1,cp05"
   'end 2025/07/01
   intQ = 1
   Set rsQD = ClsLawReadRstMsg(intQ, strQ1)
   If intQ = 1 Then
      stTmp = Array("本所案號", "案件性質")
      intWidth = Array(15, 25)
      rsQD.MoveFirst
      Do While Not rsQD.EOF
         If strGrp <> "" & rsQD.Fields("cp14") Then
            If strGrp <> "" Then
               xlsAgentPoint.Sheets(1).Select '選擇工作表
               If Val(xlsAgentPoint.Version) < 12 Then
                  xlsAgentPoint.Workbooks(1).SaveAs FileName:=App.path & TextPath & xlsFileName1, FileFormat:=-4143
               Else
                  xlsAgentPoint.Workbooks(1).SaveAs FileName:=App.path & TextPath & xlsFileName1, FileFormat:=56
               End If
               xlsAgentPoint.Workbooks.Close
               xlsAgentPoint.Quit
               Set xlsAgentPoint = Nothing
               Set wksrpt = Nothing
               'CC: 承辦人(操作者)的主管
               strExc(1) = PUB_GetFCPProSup(strGrp)
               SendMAPIMail strGrp, ChangeTStringToTDateString(strSrvDate(2)) & "程序大項作業稽核", "附件EXCEL的檔案尚未上傳到卷宗區，請儘速作業。", App.path & TextPath & xlsFileName1, , , strExc(1)
            End If
            If Dir(App.path & TextPath & xlsFileName1) <> "" Then
               Kill App.path & TextPath & xlsFileName1
            End If
            intCounter = 1
            xlsAgentPoint.SheetsInNewWorkbook = 1 '預設工作表數目
            xlsAgentPoint.Workbooks.add
            xlsAgentPoint.Application.WindowState = xlMinimized
            xlsAgentPoint.Application.Visible = False
            Set wksrpt = xlsAgentPoint.Worksheets(1)
            '設定欄位名稱及欄寬
            For intB = LBound(stTmp) To UBound(stTmp)
                wksrpt.Range(Chr(intB + 65) & intCounter).Value = stTmp(intB)
                wksrpt.Columns(Chr(intB + 65) & ":" & Chr(intB + 65)).ColumnWidth = intWidth(intB)
                wksrpt.Range(Chr(intB + 65) & intCounter).HorizontalAlignment = xlCenter
            Next intB
            intCounter = 2
         End If
         wksrpt.Range("A" & intCounter).Value = "" & rsQD.Fields("cp01") & "-" & rsQD.Fields("cp02") & IIf("" & rsQD.Fields("cp03") & rsQD.Fields("cp04") = "000", "", "-" & rsQD.Fields("cp03") & "-" & rsQD.Fields("cp04")) '本所案號
         wksrpt.Range("B" & intCounter).Value = "" & rsQD.Fields("cpm03")
         
         intCounter = intCounter + 1
         strGrp = "" & rsQD.Fields("cp14")
         
JumpToNext:
         rsQD.MoveNext
      Loop
      If strGrp <> "" Then
         xlsAgentPoint.Sheets(1).Select '選擇工作表
         If Val(xlsAgentPoint.Version) < 12 Then
            xlsAgentPoint.Workbooks(1).SaveAs FileName:=App.path & TextPath & xlsFileName1, FileFormat:=-4143
         Else
            xlsAgentPoint.Workbooks(1).SaveAs FileName:=App.path & TextPath & xlsFileName1, FileFormat:=56
         End If
         xlsAgentPoint.Workbooks.Close
         xlsAgentPoint.Quit
         Set xlsAgentPoint = Nothing
         Set wksrpt = Nothing
         'CC: 承辦人(操作者)的主管
         strExc(1) = PUB_GetFCPProSup(strGrp)
         SendMAPIMail strGrp, ChangeTStringToTDateString(strSrvDate(2)) & "程序大項作業稽核", "附件EXCEL的檔案尚未上傳到卷宗區，請儘速作業。。", App.path & TextPath & xlsFileName1, , , strExc(1)
      End If
   End If
   Set rsQD = Nothing
   
   Exit Sub
   
ErrHandle:
   If Err.Number <> 0 Then
      WLog "外專程序大項作業稽核:" & Err.Description
   End If
End Sub

'Added by Lydia 2025/07/08 應收帳款逾付款週期管制表; 從每月批次frmAutoBatch.StrMenu21搬過來
Private Sub StrMenu143()
'1. 於每季第一個工作天請發送予該智權人員。
'2. 於每季第三個工作天請發送予區主管及智權主管。
'3. 發送予智權部各人員的應收帳款資訊，應包含介紹予法律所之案源之帳款，應由智權部自行進行確認，而無須再委請法律所通知。案源介紹人要列，法律所也要列。
'4. 依何執行長之建議，請於法律所之報表中，再增加一欄為案源介紹人，以明確區隔為智慧所介紹之案源，或為法律所自行收文之法務案件。法律所的清單上加介紹人。
Dim rsRD As New ADODB.Recordset
Dim inR As Integer, iRow As Integer
Dim dTotAmt As Double
Dim strTemp(0 To 10) As String
Dim arrTMP1 As Variant, arrTmp2 As Variant
Dim TempFileName As String
Dim ff21 As Integer
Dim strGrp As String
Dim strTo As String, strPS As String
Dim strTitle1 As String, strTitle2 As String
Dim intW As Integer
Dim iRound As Integer  '分兩種報表(1-各區,2-全部)
Dim strBDate As String, strFrmName As String
Dim strKind As String '1-於每季第一個工作天請發送予該智權人員, 2-於每季第三個工作天請發送予區主管及智權主管

'判斷每季第一個月通知
If Val(Mid(strSrvDate(1), 5, 2)) Mod 3 <> 1 Then
   Exit Sub
End If

If strSrvDate(1) = CompWorkDay(1, Mid(strSrvDate(1), 1, 6) & "01") Then
   '1. 於每季第一個工作天請發送予該智權人員。
   strKind = "1"
ElseIf strSrvDate(1) = CompWorkDay(3, Mid(strSrvDate(1), 1, 6) & "01") Then
   '2. 於每季第三個工作天請發送予區主管及智權主管。
   strKind = "2"
End If
If strKind = "" Then Exit Sub

strBDate = CompDate(2, -1, Mid(strSrvDate(1), 1, 6) & "01")
strFrmName = "StrMenu143"
cnnConnection.Execute "delete from rdatafactory where formname='" & strFrmName & "' and id = 'QPGMR' "

On Error GoTo ErrHandle

TempFileName = "應收帳款逾付款週期管制表"
If Dir(App.path & TextPath & TempFileName & ".txt") <> "" Then
    Kill App.path & TextPath & TempFileName & ".txt"
End If

strPS = vbCrLf & vbCrLf & vbCrLf & String(2, "　") & "列印注意事項：" & vbCrLf & _
      vbCrLf & String(4, "　") & "1.利用筆記本開啟附件" & _
      vbCrLf & String(4, "　") & "2.將視窗展開到最大" & _
      vbCrLf & String(4, "　") & "3.取消<自動換行>設定" & _
      vbCrLf & String(4, "　") & "4.<字型>設定為<細明體 標準 11>" & _
      vbCrLf & String(4, "　") & "5.左右邊界分別設<10mm 0mm>" & _
      vbCrLf & String(4, "　") & "6.選擇<橫印>   "

'先將符合條件的應收帳款放在暫存檔
   '已發文且已列印收據之國內應收帳款:超過付款週期(若客戶未設定特殊付款週期CU175，則歸到一般付款週期預設2個月)
   'Modified by Lydia 2018/09/25 改抓a0k20的業務員代號和收文部門st15
   'Modified by Lydia 2018/11/05 +增加欄位(sk02,a0k03 as custno)
   'Modified by Lydia 2025/06/10 a0k32 is null 改用函數判斷：geta0k32type(a0k01)='1'
   strExc(0) = " select '" & strFrmName & "' as formname,'QPGMR' as ID,'1' seqno,rownum as rowseq, cp162,cp01,cp02,cp03,cp04,cp05,cp09,cp10,st15 as cp12,a0k20 as cp13,st02 as sname, cp27,nvl(cu04,nvl(cu06,cu07)) custname,a0k01 as billno, a0k02 as billdate, sum(nvl(a0j09,0)+nvl(a0j10,0)-nvl(a1u04,0)-nvl(a1u05,0)-nvl(a1u07,0)-nvl(a1u09,0)+nvl(a1u08,0)+nvl(a1u10,0)) as A1" & _
                    " ,sk02,a0k03 as custno From acc0k0, caseprogress, systemkind, acc0j0,customer,staff," & _
                         " (select a1u02,a1u03,sum(a1u04) a1u04,sum(a1u05) a1u05,sum(a1u07) a1u07,sum(a1u09) a1u09,sum(a1u08) a1u08,sum(a1u10) a1u10 From acc1u0 where a1u03" & _
                         " in ( select distinct a1u03 From acc0k0, caseprogress, acc1u0, acc0j0,customer Where geta0k32type(a0k01)='1' And nvl(a0k09, 0) = 0 And (a0k06 + a0k07) > (nvl(a0k17, 0) + nvl(a0k18, 0))" & _
                               " and substr(a0k03,1,8)=cu01 and substr(a0k03,9,1)=cu02 and cp27<to_char(add_months(to_date('" & strBDate & "','yyyymmdd'),nvl(cu175,2) * -1),'YYYYMMDD')" & _
                               " and a0k01=a0j13(+) and a0j01=cp09(+) and nvl(cp27,0)>0 and cp79>0 and a1u03(+)=cp09" & _
                               " ) group by a1u02,a1u03) X" & _
                    " Where geta0k32type(a0k01)='1' And nvl(a0k09, 0) = 0 And (a0k06 + a0k07) > (nvl(a0k17, 0) + nvl(a0k18, 0)) and substr(a0k03,1,8)=cu01 and substr(a0k03,9,1)=cu02" & _
                    " and cp27<to_char(add_months(to_date('" & strBDate & "','yyyymmdd'),nvl(cu175,2) * -1),'YYYYMMDD') and a0k20=st01(+)" & _
                    " and a0k01=a0j13(+) and a0j01=cp09(+) and nvl(cp27,0)>0 and cp79>0 and X.a1u02(+)=a0j13 and X.a1u03(+)=a0j01 and sk01(+)=cp01" & _
                    " group by '" & strFrmName & "', 'QPGMR', '1',ROWNUM, cp162,cp01,cp02,cp03,cp04,cp05,cp09,cp10,st15,a0k20,st02,cp27,nvl(cu04,nvl(cu06,cu07)),a0k01, a0k02,sk02,a0k03 "
   strSql = "INSERT INTO rdatafactory (formname,ID,seqno,rowseq,r001,r002,r003,r004,r005,r006,r007,r008,r009,r010,r011,r012,r013,r014,r015,r016,r017,r018) " & strExc(0)
   cnnConnection.Execute strSql
 
'strKind區分：1.於每季第一個工作天請發送予該智權人員。2.於每季第三個工作天請發送予區主管及智權主管。
For iRound = 1 To IIf(strKind = "1", 1, 2)
   strGrp = ""
   strTo = ""
   
   strExc(0) = "SELECT r002 AS cp01, r003 AS cp02, r004 AS cp03, r005 AS cp04,r006 AS cp05,r007 AS cp09" & _
               " ,r008 AS cp10 , r009 AS cp12, r010 AS cp13,r011 AS sname, r012 AS cp27,r013 AS custname,r014 As billno, r015 As billdate, r016 As a1, r017 As sk02, r018 As custno" & _
               " ,st01 as los04,st02 as los04name,r001 AS cp162 FROM rdatafactory,lawofficesource,staff WHERE formname='" & strFrmName & "' AND ID='QPGMR' AND r001=los15(+) AND r007=los06(+)" & _
               " AND REPLACE(substr(los04,1,6),',','')=st01(+)"
   If strKind = "1" Then
      '發送予智權部各人員的應收帳款資訊，應包含介紹予法律所之案源之帳款，應由智權部自行進行確認，而無須再委請法律所通知。案源介紹人要列，法律所也要列。
      strExc(0) = strExc(0) & " UNION SELECT r002 AS cp01, r003 AS cp02, r004 AS cp03, r005 AS cp04,r006 AS cp05,r007 AS cp09" & _
               " ,r008 AS cp10 , st15 AS cp12, st01 AS cp13,st02 AS sname, r012 AS cp27,r013 AS custname,r014 As billno, r015 As billdate, r016 As a1, r017 As sk02, r018 As custno" & _
               " ,'' AS los04,'' AS los04name,r001 AS cp162 FROM rdatafactory,lawofficesource,staff WHERE formname='" & strFrmName & "' AND ID='QPGMR' AND r001=los15(+) AND r007=los06(+)" & _
               " AND REPLACE(substr(los04,1,6),',','')=st01(+) and los04 is not null"
   End If
   strSql = " select aa.*,decode(pa01,null,decode(tm01,null,decode(sp01,null,cpm03,decode(sp09,'000',cpm03,cpm04)),decode(tm10,'000',cpm03,cpm04)),decode(pa09,'000',cpm03,cpm04)) as cp10n," & _
               " nvl(pa05,nvl(pa06,pa07))||nvl(tm05,nvl(tm06,tm07))||nvl(sp05,nvl(sp06,sp07))||nvl(lc05,nvl(lc06,lc07))||hc06 as casename,a0902 as deptname,a0908 as deptman" & _
               " from (" & strExc(0) & " ) AA,patent,trademark,servicepractice,lawcase,hirecase ,acc090, casepropertymap c1" & _
               " where pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04" & _
               " and tm01(+)=cp01 and tm02(+)=cp02 and tm03(+)=cp03 and tm04(+)=cp04" & _
               " and sp01(+)=cp01 and sp02(+)=cp02 and sp03(+)=cp03 and sp04(+)=cp04" & _
               " and lc01(+)=cp01 and lc02(+)=cp02 and lc03(+)=cp03 and lc04(+)=cp04" & _
               " and hc01(+)=cp01 and hc02(+)=cp02 and hc03(+)=cp03 and hc04(+)=cp04" & _
               " and a0901(+)=cp12 and cpm01(+)=cp01 and cpm02(+)=cp10"
   strSql = strSql & " order by cp12,cp13,cp27,cp09"
   inR = 1
   Set rsRD = ClsLawReadRstMsg(inR, strSql)
   If inR = 1 Then
        rsRD.MoveFirst
        With rsRD
           Do While Not .EOF
              If (iRound = 1 And strGrp <> IIf(strKind = "1", "" & .Fields("cp13"), "" & .Fields("cp12"))) Or _
                   (iRound = 2 And strGrp = "") Then
                  If strTo <> "" Then
                      '寄給各區主管
                      Print #ff21, String(intW, "=")
                      strExc(1) = "共 " & iRow & " 筆"
                      strExc(2) = "小計：" & PUB_StrToStr(Format("" & dTotAmt, DDollar2), Val(arrTmp2(7)), True, True)
                      Print #ff21, strExc(1) & String(intW - GetTextLength(strExc(1)) - GetTextLength(strExc(2)), " ") & strExc(2)
                      Close ff21
                      SendMAPIMail strTo, TempFileName, strPS, App.path & TextPath & TempFileName & ".txt"
                  End If
                  
                  strTitle1 = ""
                  strTitle2 = ""
                  '----欄位抬頭
                  strExc(1) = "業務區,智權人員,本所案號,案件名稱,客戶名稱,案件性質,收文日,發文日,應收金額,最後收文日" & IIf(iRound = 2 Or InStr("" & .Fields("cp12"), "L") > 0, ",介紹人", "")
                  strExc(2) = "12,8,15,26,26,10,10,10,10,10" & IIf(iRound = 2 Or InStr("" & .Fields("cp12"), "L") > 0, ",10", "")
                  arrTMP1 = Split(strExc(1), ",")
                  arrTmp2 = Split(strExc(2), ",")
                  
                  For inR = IIf(iRound = 1, 1, 0) To UBound(arrTMP1)
                     If Trim(arrTMP1(inR)) <> "" Then
                         strTitle1 = strTitle1 & convForm(arrTMP1(inR), Val(arrTmp2(inR))) & " "
                         strTitle2 = strTitle2 & String(Val(arrTmp2(inR)), "=") & " "
                     End If
                  Next
                  strTitle1 = Mid(strTitle1, 1, Len(strTitle1) - 1)
                  strTitle2 = Mid(strTitle2, 1, Len(strTitle2) - 1)
                  intW = GetTextLength(strTitle1)
                  
                  ff21 = FreeFile
                  Open App.path & TextPath & TempFileName & ".txt" For Output As ff21
                  Print #ff21, String(50, " ") & TempFileName
                  Print #ff21, ""
                  If iRound = 1 Then
                      Print #ff21, "業務區：" & "" & .Fields("deptname") & String(85, " ") & "列印日期：" & ChangeTStringToTDateString(strSrvDate(2))
                  Else
                      Print #ff21, "列印日期：" & ChangeTStringToTDateString(strSrvDate(2))
                  End If
                  Print #ff21, "註1：""最後收文日""指同一客戶編號之最後收文日"
                  Print #ff21, "註2：""最後收文日""顯示""*******""表示同本案收文日"
                  Print #ff21, strTitle1
                  Print #ff21, strTitle2
                  dTotAmt = 0
                  iRow = 0
              End If
              
              '業務區
              strTemp(0) = convForm("" & .Fields("deptname"), Val(arrTmp2(0)))
              '智權人員
              strTemp(1) = convForm("" & .Fields("sname"), Val(arrTmp2(1)))
              '本所案號
              strTemp(2) = convForm(.Fields("cp01") & "-" & .Fields("cp02") & "-" & .Fields("cp03") & "-" & .Fields("cp04"), Val(arrTmp2(2)))
              '案件名稱
              strTemp(3) = convForm(PUB_StringFilter("" & .Fields("casename")), Val(arrTmp2(3)))
              '客戶名稱
              strTemp(4) = convForm("" & .Fields("custname"), Val(arrTmp2(4)))
              '案件性質
              strTemp(5) = convForm("" & .Fields("cp10n"), Val(arrTmp2(5)))
              '收文日
              strTemp(6) = convForm(ChangeTStringToTDateString(TransDate("" & .Fields("cp05"), 1)), Val(arrTmp2(6)))
              '發文日
              strTemp(7) = convForm(ChangeTStringToTDateString(TransDate("" & .Fields("cp27"), 1)), Val(arrTmp2(7)))
              '應收金額
              strTemp(8) = PUB_StrToStr(Format("" & .Fields("a1"), DDollar2), Val(arrTmp2(8)), True, True)
              '最後收文日：抓該案件申請人1之A類最大收文日期,但專利 , 商標, 法務顧問分開處理
              strSql = ""
              Select Case "" & .Fields("sk02")
                   Case "1", "5" '專利
                          strSql = "select pa01 as pno1,pa02 as pno2,pa03 as pno3,pa04 as pno4 from patent,systemkind where pa26='" & .Fields("custno") & "'  and pa01=sk01(+) and sk02='1' " & _
                                      "union select sp01 as pno1,sp02 as pno2,sp03 as pno3,sp04 as pno4 from servicepractice,systemkind where sp08='" & .Fields("custno") & "' and sp01=sk01(+) and sk02='5' "
                   Case "2", "6" '商標
                          strSql = "select tm01 as pno1,tm02 as pno2,tm03 as pno3,tm04 as pno4 from trademark,systemkind where tm23='" & .Fields("custno") & "'  and tm01=sk01(+) and sk02='2' " & _
                                      "union select sp01 as pno1,sp02 as pno2,sp03 as pno3,sp04 as pno4 from servicepractice,systemkind where sp08='" & .Fields("custno") & "' and sp01=sk01(+) and sk02='6' "
                   Case "3", "4", "7", "8" '法務顧問
                          strSql = "select lc01 as pno1,lc02 as pno2,lc03 as pno3,lc04 as pno4 from lawcase,systemkind where lc11='" & .Fields("custno") & "'  and lc01=sk01(+) and sk02 in ('3','4','7','8') " & _
                                      "union select hc01 as pno1,hc02 as pno2,hc03 as pno3,hc04 as pno4 from hirecase,systemkind where hc05='" & .Fields("custno") & "' and hc01=sk01(+) and sk02 in ('3','4','7','8') "
              End Select
              strTemp(9) = convForm("*******", Val(arrTmp2(9))) '預設-表示同本案收文日
              If strSql <> "" Then
                  strSql = "select max(cp05) as mdate from caseprogress where cp05>" & .Fields("cp05") & " and substr(cp09,1,1)='A' and cp159=0 " & _
                               "and (cp01,cp02,cp03,cp04) in (" & strSql & ") "
                  intI = 1
                  Set RsTemp = ClsLawReadRstMsg(intI, strSql)
                  If Val("" & RsTemp.Fields("mdate")) > 0 Then
                      strTemp(9) = convForm(ChangeTStringToTDateString(TransDate("" & RsTemp.Fields("mdate"), 1)), Val(arrTmp2(9)))
                  End If
              End If
              strTemp(10) = convForm("" & .Fields("los04name"), 10)
              
              If iRound = 1 Then   '分區／智權人員
                  Print #ff21, strTemp(1) & " " & strTemp(2) & " " & strTemp(3) & " " & strTemp(4) & " " & strTemp(5) & " " & strTemp(6) & " " & strTemp(7) & " " & strTemp(8) & " " & strTemp(9) & IIf(InStr("" & .Fields("cp12"), "L") > 0, " " & strTemp(10), "")
              Else     '全部-明細列有業務區
                  Print #ff21, strTemp(0) & " "; strTemp(1) & " " & strTemp(2) & " " & strTemp(3) & " " & strTemp(4) & " " & strTemp(5) & " " & strTemp(6) & " " & strTemp(7) & " " & strTemp(8) & " " & strTemp(9) & " " & strTemp(10)
              End If
              
              dTotAmt = dTotAmt + Val("" & .Fields("a1"))
              iRow = iRow + 1
              If iRound = 1 Then '分區／智權人員
                  If strKind = "1" Then
                     strGrp = "" & .Fields("cp13")
                     strTo = "" & .Fields("cp13")
                  Else
                     strGrp = "" & .Fields("cp12")
                     strTo = "" & .Fields("deptman")
                     '每月、每日批次發通知無收受者時改發「程式管理人員」，以利查覺異常情形，才能儘早修改系統設定
                     If strTo = "" Then
                         strTo = Pub_GetSpecMan("程式管理人員")
                     End If
                  End If
              '全部
              Else
                   strGrp = "M01"
              End If
              
              .MoveNext
           Loop
        End With
        Print #ff21, String(intW, "=")
        strExc(1) = "共 " & iRow & " 筆"
        strExc(2) = "小計：" & PUB_StrToStr(Format("" & dTotAmt, DDollar2), Val(arrTmp2(8)), True, True)
        Print #ff21, strExc(1) & String(intW - GetTextLength(strExc(1)) - GetTextLength(strExc(2)), " ") & strExc(2)
        Close ff21
        'Added by Lydia 2018/09/19 增加完整報表通知總經理和何主秘
        If iRound = 2 Then
              strTo = Pub_GetSpecMan("總經理員工編號")
              'Modified by Lydia 2022/05/03 簡協理69005改為抓系統特殊設定「全所智權部主管」
              strTo = strTo & IIf(strTo <> "", ";", "") & Pub_GetSpecMan("全所智權部主管")
        End If
        'end 2018/09/19
        If strTo <> "" Then
            SendMAPIMail strTo, TempFileName, strPS, App.path & TextPath & TempFileName & ".txt"
        End If
   End If
Next iRound

ErrHandle:
   If Err.Number <> 0 Then
      WLog "應收帳款逾付款週期管制表:" & Err.Description
   End If
   Set rsRD = Nothing
End Sub

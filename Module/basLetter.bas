Attribute VB_Name = "basLetter"
'Memo By Sindy 2012/12/5 智權人員欄已修改
'Memo By Sindy 2011/2/15 SQLDate已檢查
'Memo by Morgan2010/12/28 申請案號欄已修改
'Memo By Sindy 2010/8/4 日期欄已修改
'整理 By Morgan 2005/7/13
Option Explicit

'Added by Morgan 2023/4/6
'Modified by Morgan 2025/1/15 從電子公文移來改公用
Public Declare Function OpenPrinter Lib "winspool.drv" Alias "OpenPrinterA" (ByVal pPrinterName As String, phPrinter As Long, pDefault As Any) As Long
Public Declare Function ClosePrinter Lib "winspool.drv" (ByVal hPrinter As Long) As Long
Public Declare Function EnumJobs Lib "winspool.drv" Alias "EnumJobsA" (ByVal hPrinter As Long, ByVal FirstJob As Long, ByVal NoJobs As Long, ByVal Level As Long, pJob As Any, ByVal cdBuf As Long, pcbNeeded As Long, pcReturned As Long) As Long

Public g_LetterDebug As Boolean 'Added by Morgan 2017/9/5

' 原始傳入NowPrint的帳號
Dim m_SrcKey As String
'Modify By Sindy 2020/12/14 + 8 定稿日期
'1-4 本所案號 5 案件性質 6 國家 7 專利年費資料檔之年度 8 定稿日期
Public m_MySt(1 To 8) As String
' 是否顯示
Dim m_Preview As Boolean
'' 橫印 False 直印 True
'1 橫印 2 直印 3 日文
'Dim bolPrint As Boolean

'Modify By Sindy 2012/4/5 strPrint->strPrintType
'Dim strPrint As String
Public strPrintType As String

' 系統別 1.專利 2.商標 4.顧問
Public m_SysKind As Integer
' 列印份數
Dim m_Copys As Integer
' 目前份數
Dim m_CopysCount As Integer
' 判斷是 收文號 0 或 本所案號 & 案件性質 1
Dim m_RefKind As Integer
' 字體大小
Dim m_FontSize As Integer
' 定稿別
Dim m_FinalSty As String
' 使用者
Dim m_User As String
' 收文號
Public m_Rule As String
' 處理狀況
Dim m_Situ As String
' 定義轉換的指令
Public Enum INSTRUCTION
   incADD_VALUE             ' 加上#數值
   incADD_YEAR              ' 加上#年
   incADD_MONTH             ' 加上#月
   incADD_DAY               ' 加上#天
   incSUB_VALUE             ' 減掉#數值
   incSUB_YEAR              ' 減掉#年
   incSUB_MONTH             ' 減掉#月
   incSUB_DAY               ' 減掉#天
   incCNV_CHINESE_MINKO     ' 改為中文民國日期 (民國#年#月#日)
   incCNV_CHINESE_CUN       ' 改為中文西元日期 (西元#年#月#日)
   incCNV_CHINESE_MINKO_CUN ' 改為中文民國(西元年)日期 (民國#(西元年)年#月#日)  add by sonia 2019/11/13
   incCNV_ENGLISH_DATE      ' 改為英文日期
   incCNV_ENGLISH_FREQUENCY ' 轉換成英文的次數
   incGET_SYSDATE           ' 取得系統日期
   intCNV_DATE_FORMAT       ' 日期格式化 ####/##/## Add by Morgan 2004/11/29
   'Add By Cheng 2002/09/11
   incGET_MMDD              '取得月日
   incGET_EYEAR             '取得民國年
   incGET_WYEAR             '取得西元年
   incADD_WorkDAY           ' 加上#工作天 Add By Sindy 2012/4/20
   incSUB_WorkDAY           ' 減掉#工作天 Add By Sindy 2012/4/20
   incCNV_CHINESE_MINKO1    ' 改為中文民國日期 (民國#年#月#日) modify by sonia 2019/11/26 非定稿之程式用
   incCNV_CHINESE_CUN1      ' 改為中文西元日期 (西元#年#月#日) modify by sonia 2019/11/26 非定稿之程式用
End Enum
'Public objWord As New Word.Application
Public Td As Word.Table
Public strLetterDate As String
' 專利基本檔的本所案號
Public PaSt As String
' 商標基本檔的本所案號
Public TmSt As String
' 法務基本檔的本所案號
Public LcSt As String
' 僱問基本檔的本所案號
Public HcSt As String
' 服務業務基本檔的本所案號
Public SpSt As String
' 90.08.22 modify by louis (為了取得繳年費的年度所宣告的Array, 第0個放的是收文號, 其餘為本所案號)
Dim m_CP01 As String
Dim m_CP02 As String
Dim m_CP03 As String
Dim m_CP04 As String
Dim m_CP09 As String
Dim m_CP10 As String
Dim m_CP13 As String 'Add By Sindy 2011/6/28
Dim m_CP14 As String 'Add By Sindy 2011/6/28
Dim m_CP29 As String 'Add By Sindy 2011/7/18
Dim m_CP27 As String 'Add By Sindy 2018/4/23 發文日
' 90.08.22 modify by louis (指出<案件進度檔-業務區別>的位置, 第一份不印, 之後才印)
Dim m_SplitPos As Integer
' 90.08.16 modify by louis
Public g_WordAp As Word.Application

'Add by Morgan 2009/8/20
Public g_LetterDate As String

'Add by Morgan 2004/10/27
Const c_MLSign = 30  '[符號替換的ASCII碼
Const c_MRSign = 31  ']符號替換的ASCII碼

'Add by Morgan 2007/11/29
Const c_FLLSign = 24  '｛符號替換的ASCII碼
Const c_FLRSign = 25  '｝符號替換的ASCII碼
Const c_FMLSign = 26  '〔符號替換的ASCII碼
Const c_FMRSign = 27  '〕符號替換的ASCII碼

'Added by Morgan 2020/5/19
Const c_DMLSign = 16  '[[符號替換的ASCII碼
Const c_DMRSign = 17  ']]符號替換的ASCII碼
Const c_DALSign = 18  '|!符號替換的ASCII碼
Const c_DARSign = 19  '!|符號替換的ASCII碼

'add by nickc 2006/03/28 加入代表圖用
Dim CalVbCrLfStr As String
Dim CalVbCrLfCount As Integer
Const msoBringInFrontOfText = 4
Const msoFalse = 0
Const msoScaleFromTopLeft = 0
Const msoLineSolid = 1
Const msoLineSingle = 1
Const msoTrue = -1
Const msoPictureAutomatic = 1
Const wdCollapseStart = 1
Const wdCollapseEnd = 0
Const wdReplaceOne = 1

'Add by Morgan 2007/11/6 紀錄Word原始格式設定
Dim lSize As Long
Dim lAlignment As Long
Dim lBold As Long
Dim lItalic As Long
Dim lUnderline As Long
'end 2007/11/6

'Modify By Sindy 2012/4/5
'Dim m_bolSave2File As Boolean '是否存電子檔
'Dim m_strFilePath As String '電子檔路徑
Public m_bolSave2File As Boolean '是否存電子檔
Public m_strFilePath As String '電子檔路徑
Public m_bolNewFormat As Boolean '新定稿紙 'Modify By Sindy 2013/11/14 原為Dim改為Public
Dim m_strUserNo As String '原使用者編號

Public g_ExceptFieldData2 As String 'Add By Sindy 2010/01/13
'Added by Morgan 2018/11/21
Dim m_bolECust As Boolean  '是否E化客戶(讀取<指定信箱>,<指定信箱/xx>例外欄位時設定)
Dim m_bolXECust As Boolean 'Added by Morgan 2025/11/11 半E化客戶(定稿要印日期)
Dim m_bolSalesHandle As Boolean 'Added by Morgan 2025/11/11 是否業務自行處理
Public g_bolELtrAddr As Boolean 'E化信函是否印地址
'end 2018/11/21

'MS Windows API Function Prototypes
Public Declare Function GetProfileString Lib "kernel32.dll" Alias "GetProfileStringA" (ByVal lpAppName As String, ByVal lpKeyName As String, ByVal lpDefault As String, ByVal lpReturnedString As String, ByVal nSize As Long) As Long
'Added by Morgan 2022/4/19
Public Declare Function lstrlen Lib "kernel32" Alias "lstrlenA" (ByVal lpString As String) As Long

Public g_LD18 As String '信函進度收文號(發文字號) Added by Morgan 2014/5/9 2018/7/27 改全域變數
Dim m_LP33 As String, m_LP34 As String 'Added by Morgan 2016/11/15

Public TmpFrmAcc2470 As Form 'Added by Lydia 2016/12/22 呼叫FC催款單
Public Const 雙署名POS_1 = 25  'Added by Lydia 2017/05/11　'Modified by Lydia 2017/05/22 改成空白鍵　14.3-> 26
Public Const 雙署名POS_2 = 22 'Added by Lydia 2017/05/11   'Modified by Lydia 2017/05/22 改成空白鍵  12.9-> 18
Public Const TMGoods第2頁行數 = 41 'Added by Lydia 2020/01/09 內商T使用"橫式雙面列印定稿"，背面(偶數頁)的最大行數
Public m_DocSNo As String 'Added by Morgan 2020/11/19 文件序號
Dim 案件回覆單_AddFee As Boolean 'Added by Lydia 2021/01/11 定稿呼叫案件回覆單內容加印費用
Public g_UserNum As String 'Added by Morgan 2021/2/24
Dim bNoPrint As Boolean 'Added by Morgan 2021/3/11
Dim m_LD27 As String    'Added by Morgan 2021/3/19
Public m_AutoStampNameInWord As String 'Added by Morgan 2022/3/22 Word內的自動公司章變數名稱
Public m_ToolBarNobrowse As Boolean 'Added by Morgan 2023/7/27 工具列設定不可上下筆
Dim m_bInTrans As Boolean 'Added by Morgan 2023/10/18
Dim m_990CP09 As String 'Added by Morgan 2023/10/18

'Modified by Lydia 2024/04/12 +131前置自行申請首次驗證,141諮詢再驗證,142諮詢抽驗Ｌ,143諮詢抽驗Ｓ
'Memo by Lydia 2024/04/16 增加案件性質需要查看PUB_ChkACSforTIPS是否要修改
'Modified by Lydia 2025/02/24 增加124,125,126,127
'Modified by Lydia 2025/09/02 增加115教育訓練；(將ACSforLetter改成請款階段設定)
'Modified by Lydia 2025/09/05 增加性質132,133,134,144,145,146,1031,1032,1033,1034,1035
'Public Const ACSforTIPSstep = "'101','1012','1013','1014','131','141','142','143','115','124','125','126','127'" 'Added by Lydia 2024/03/22 (ACS)TIPS案件性質:請款階段 'Move by Lydia 2024/04/16 從bas088搬過來
'Modified by Lydia 2025/09/24 增加性質1022,147
'Moeified by Lydia 2025/10/03 拿掉性質1022,147
'Memo by Lydia 2025/10/03 以下性質的需要輸請款階段+年度+金額，才能在發文同時產生對內和對外通知Email，Email內文和主旨顯示"第X階段"；若該案本身只有一道A類收文才可以拿A類收文輸請款階段，其餘都只能用內部收文或來函輸請款階段
Public Const ACSforTIPSstep = "'101','1012','1013','1014','1031','1032','1033','1034','1035','131','132','133','134','141','142','143','144','145','146','115','124','125','126','127'"
'Modified by Lydia 2025/09/05 已歸入上面
'Public Const ACSforLetter = "'115','124','125','126','127'" 'Added by Lydia 2025/08/20 從ACS發文改成共用;'Added by Lydia 2025/06/03 ACS案針對其他案件性質增加請款發文定稿通知=>【115(教育訓練)、124(營業秘密管理輔導)、125(研發管理輔導)、126(商標管理輔導)、(127)程序管理輔導】
Public Const ACSforLetter = "'BBB'" 'Memo by Lydia 2025/10/03 ACS案發文可以產生對內和對外Email，繳款時自動Email顧服組主管用Email回覆告知財務處「智權業績獎金比例」【不輸請款階段、請款年度、請款金額，但發文同時產生對內和對外通知Email，Email內文和主旨不顯示"第X階段"】
'Added by Lydia 2025/10/03 ACS案依照前面設定的「智權業績獎金比例」進行分潤，但是【不輸請款階段、請款年度、請款金額，但發文同時產生對內和對外通知Email，Email內文和主旨不顯示"第X階段"】
Public Const ACSforTIPSAdd = "'1022','147'"    'Memo by Lydia 2025/10/23 (10/7 Email) 歸入區塊2，但是不用輸入請款階段

''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' 啟始程式時, 需要呼叫此函式來產生一個全域的Word物件
' 並開啟一份空的文件
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Public Sub StartOfficeAp()
On Error GoTo ERRORSECTION
   ' 產生一個Word的物件
   Set g_WordAp = New Word.Application
   ' 設定不顯示Word畫面
   g_WordAp.Visible = False
   ' 新增一個Word文件
   g_WordAp.Documents.add
   Exit Sub
ERRORSECTION:
   MsgBox "錯誤 : " & Err.Description, vbCritical
End Sub

''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' 結束程式時, 需要呼叫此函式來將Word物件釋放掉
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Public Sub EndOfficeAp()
On Error GoTo ERRORSECTION
   'g_WordAp.ActiveDocument.Close wdDoNotSaveChanges
   If Not g_WordAp Is Nothing Then
      'Modify by Morgan 2010/4/28 隱藏狀態才關閉
      'g_WordAp.Visible = False
      'g_WordAp.Quit wdDoNotSaveChanges
      If Not g_WordAp.Visible Then
         g_WordAp.Quit wdDoNotSaveChanges
      End If
      'end 2010/4/28
      Set g_WordAp = Nothing
   End If
   Exit Sub
ERRORSECTION:
'   Debug.Print Err.NUMBER
   Set g_WordAp = Nothing
End Sub

' 輸出資料到Microsoft Word
'Modify by Morgan 2010/12/17 +bolPrintNow=即時列印
'Modify by Morgan 2011/2/11 +iHeaderPageNum=加信頭的頁數
'Modify By Sindy 2012/4/5 Private->Public
'Modified by Morgan 2014/4/1 +bolEditKeepMark
'Modify By Sindy 2014/9/19 +bolUseForHTML
'Modified by Morgan 2014/12/9 +bolAlwaysShowSign
'Modified by Morgan 2016/11/2 +bolEditCopy=是否編輯副本,strDataCopy=副本內容
'Modify by Amy 2018/07/27 +showColorFirst=>是否先抓彩色代表圖
'Modified by Morgan 2018/11/21 +str990CP09
'Private Sub ExportToMsWord(ByVal strData As String, Optional ByVal bolHeader As Boolean,
'Modified by Lydia 2020/12/08 +bolUpdLD16=即時列印是否更新LD16
'Modified by Morgan 2021/7/1 showColorFirst 預設改 Ture(彩圖優先)--經理
'Modified by Sindy 2022/3/30 bolSaveToCPP 是否要存至卷宗區
'                            strCPPFileKind 電子檔副檔名
'Modified by Morgan 2023/4/21 +bolIsCombined 是否為組合定稿
Public Sub ExportToMsWord(ByVal strData As String, Optional ByVal bolHeader As Boolean, _
      Optional bolSave2DB As Boolean, Optional bolPrintNow As Boolean, Optional iHeaderPageNum As Integer, _
      Optional bolPrintReturnSheet As Boolean = False, Optional bolEditKeepMark As Boolean = False, Optional strLetterRecNo As String, _
      Optional bolUseForHTML As Boolean = False, Optional bolAlwaysShowSign As Boolean = False, Optional strDataCopy As String, _
      Optional showColorFirst As Boolean = True, Optional str990CP09 As String, Optional bolUpdLD16 As Boolean = True, _
      Optional bolSaveToCPP As Boolean = False, Optional strCPPFileKind As String = "", Optional bolIsCombined As Boolean = False)
      
   Dim nCount As Integer, i As Integer, stFileName As String, lngLast As Long
   Dim iHeadCount As Integer, bolVisible As Boolean
   'Add by Morgan 2011/6/1
   'Dim bolNewHead As Boolean '是否印新信頭 'Removed by Morgan 2015/8/12
   Dim iPicNo As Integer, iPicNo2 As Integer '圖檔編號
   Dim oShape
   'end 2011/6/1
   'Dim bolChinaOrderLetter As Boolean '是否為大陸指示信 Add by Morgan 2011/7/20 'Removed by Morgan 2015/7/21 取消,列印別已改為6
   Dim longStar As Long, longLen As Long 'Add By Sindy 2012/2/15
   Dim stComp As String 'Added by Morgan 2013/12/30
   Dim strReplText As String 'Add By Sindy 2014/10/9
   Dim strFindText As String
   Dim intCaseKind As Integer 'Add By Sindy 2015/7/16
   Dim bolTwLtr As Boolean 'Added by Morgan 2020/3/26 是否中文對內定稿
   Dim bolFCTJpTrans As Boolean 'Added by Morgan 2023/2/6 是否FCT日譯文
   
On Error GoTo ERRORSECTION1

   '不顯示Word時, 寫資料庫暫存
   'Modify by Morgan 2008/3/24 考慮不編輯,要存檔且也要產生電子檔的狀況
   'If m_Preview = False Then
   'Modify by Morgan 2008/8/25 +編輯模式也要存檔但不放定稿
   'If m_Preview = False And bolSave2DB = True Then
   If bolSave2DB = True Then
      SaveToDB strData, m_Preview, strLetterRecNo, strDataCopy, str990CP09
      'Modify by Morgan 2008/3/20 若沒有要存檔時才跳出
      'Modify by Morgan 2010/12/17
      'If m_bolSave2File = False And m_Preview = False Then
      If m_bolSave2File = False And m_Preview = False And bolPrintNow = False Then
         Exit Sub
      End If
   End If
   
   'Add by Morgan 2008/7/7 配合新的開窗定稿改固定行高
   'Modified by Lydia 2019/05/22 +橫式雙面LD12=8
   'If strPrintType = "1" And InStr(strData, "鈞啟") > 0 Then
   If (strPrintType = "1" Or strPrintType = "8") And InStr(strData, "鈞啟") > 0 Then
      m_bolNewFormat = True
   Else
      m_bolNewFormat = False
   End If
               
   'Add by Morgan 2004/7/7
   'edit by nickc 2006/09/26 改迴圈，因為商品服務會有多次
   'strData = TransText(strData)
   Do While InStr(1, strData, "|?") <> 0
     strData = TransText(strData)
   Loop
   
   strData = PUB_Big5toUnicode(strData) 'Added by Morgan 2020/3/16 造字轉 Unicode
   
On Error GoTo ERRORSECTION2

   'Modify by Morgan 2011/7/13
   'If g_WordAp Is Nothing Then
   If TypeName(g_WordAp) <> "Application" Then
      Set g_WordAp = New Word.Application
   End If
   
   g_WordAp.Documents.add
   'g_WordAp.Selection.Font.Name = "標楷體"
   
   ' 顯示Word程式
   If m_Preview = True Then
      g_WordAp.Visible = True
      g_WordAp.WindowState = wdWindowStateMaximize
   End If
   
   'Add by Morgan 2011/1/14
   bolVisible = g_WordAp.Visible
'   If bolUseForHTML = True Then bolVisible = False 'Add By Sindy 2014/9/23
   'g_WordAp.Visible = False 'Remove by Morgan 2011/1/18 隱藏文件時信頭位置會跑掉
   
   'Modify By Sindy 2016/8/4
   If bolHeader = True Then
      If InStr(strData, "林景郁大陸中文") > 0 And InStr(strData, "自動簽名檔") > 0 Then
         strPrintType = "6"
         'Modify By Sindy 2016/8/11 去掉後面的分所案號,減少多一個空白頁的產生
         strData = Mid(strData, 1, InStr(strData, "自動簽名檔)#|") + 7)
         '2016/8/11 END
      End If
   End If
   '2016/8/4 END
   
   If g_LetterDebug Then g_WordAp.Visible = True 'Added by Morgan 2017/9/5
   
   With g_WordAp.Application
      'Add by Morgan 2011/6/3
      '切換為整頁模式
      If .ActiveWindow.View.SplitSpecial = wdPaneNone Then
         .ActiveWindow.ActivePane.View.Type = wdPageView
      Else
         .ActiveWindow.View.Type = wdPageView
      End If
         
      Select Case strPrintType
         '直式
         Case "2"
            .Selection.Font.Name = "標楷體"
            .Selection.PageSetup.Orientation = wdOrientLandscape
            '直印平躺
            .Selection.Orientation = wdTextOrientationHorizontalRotatedFarEast
            .Selection.Font.Size = 16
         '橫式
         'Modified by Lydia 2019/05/22 +橫式雙面LD12=8
         'Case "1"
         Case "1", "8"
            .Selection.Font.Name = "標楷體"
            .Selection.PageSetup.Orientation = wdOrientPortrait
            .Selection.Orientation = wdTextOrientationHorizontal
            'Add by Morgan 2007/6/26 重新委任通知函改12號字
            If m_CP01 = "P" And m_FinalSty = "02" And (m_Situ = "98" Or m_Situ = "99") Then
               .Selection.Font.Size = 12
            'Added by Morgan 2016/4/8
            'FCP中文定稿(申請書除外)
            ElseIf m_CP01 = "FCP" And m_FinalSty <> "01" Then
               .Selection.Font.Size = 12
            'end 2016/4/8
            Else
            'end 2007/6/26
               .Selection.Font.Size = 14
               'Add by Morgan 2008/7/7 配合新的開窗定稿改固定行高
               If m_bolNewFormat = True Then
                  .Selection.ParagraphFormat.LineSpacingRule = wdLineSpaceExactly
                  .Selection.ParagraphFormat.LineSpacing = 15
               End If
            End If

                  
               'Modify by Morgan 2011/7/4 +CFP,CPS
               'Modify by Morgan 2011/7/20 +P,PS
               'If m_MySt(1) = "CFT" Or m_MySt(1) = "CFC" Or m_MySt(1) = "CFP" Or m_MySt(1) = "CPS" Then
               'Modify by Morgan 2011/8/11 +L,LA
               'Modified by Morgan 2013/12/30 各系統都加J公司
               'Modify by Morgan 2015/2/10 +S(目前沒有)
               'Modified by Lydia 2024/03/01 +ACS
               If m_MySt(1) = "CFT" Or m_MySt(1) = "CFC" Or m_MySt(1) = "CFP" Or m_MySt(1) = "CPS" Or _
                   m_MySt(1) = "P" Or m_MySt(1) = "PS" Or m_MySt(1) = "L" Or m_MySt(1) = "LA" Or m_MySt(1) = "S" Or m_MySt(1) = "ACS" Then
   
                  'bolNewHead = True '用新信頭 'Removed by Morgan 2015/8/12
                  bolHeader = True '一律要印信頭
                  
                  stComp = PUB_GetReceiptComp(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4)) 'Added by Morgan 2013/12/30
                  
                  'Memoed by Morgan 2016/3/1 改和整批列印一致 --郭
                  'Modified by Morgan 2015/2/10 改與信函下款一致
                  'iPicNo = 10
                  If InStr(m_MySt(1), "T") > 0 Or m_MySt(1) = "S" Then
                     iPicNo = 12
                  Else
                     iPicNo = 10
                  End If
                  'end 2015/2/10
                  
                  iPicNo2 = 11
                  'Added by Morgan 2012/8/20
                  '若收據公司別設定為 1 公司時,改用專利商標信頭
                  'Modified by Morgan 2013/12/30
                  If stComp = "T" Then
                     iPicNo = 12
                  ElseIf stComp = "J" Then
                     iPicNo = 28
                     'Modified by Morgan 2015/11/18
                     '統一用10樓的傳真--陳鳳英
                     iPicNo2 = 31 'fax:25011666
                     'end 2015/11/18
                  End If
                     
               'Added by Morgan 2011/10/24
               'Modify By Sindy 2024/4/16 + Or m_MySt(1) = "FCT"
               ElseIf Left(m_MySt(1), 1) = "T" Or m_MySt(1) = "FCT" Then
                  'Add By Sindy 2020/11/13
                  If m_FinalSty <> "90" Then '90.申請書
                  '2020/11/13 END
                     'bolNewHead = True 'Removed by Morgan 2015/8/12
                     bolHeader = True
                  End If
                  
                  iPicNo = 12
                  iPicNo2 = 11
                  'Added by Morgan 2013/12/30
                  stComp = PUB_GetReceiptComp(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4))
                  If stComp = "J" Then
                     iPicNo = 28
                     iPicNo2 = 31
                  End If
                  'end 2013/12/30
                  
               'Added by Morgan 2016/4/8
               'FCP中文定稿
               ElseIf m_MySt(1) = "FCP" And m_FinalSty <> "01" Then
                  bolHeader = True
                  iPicNo = 5
                  iPicNo2 = 9
               'end 2016/4/8
               End If
               'end 2011/6/1
               
            'Added by Morgan 2020/4/1
            If bolHeader = True Then
               If strSrvDate(1) >= 智慧所更名日 Then
                  bolHeader = True
                  stComp = PUB_GetReceiptComp(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), True)
                  PUB_GetLetterPicID stComp, m_MySt(1), iPicNo, iPicNo2, 1, False
                  bolTwLtr = True
               End If
            End If
            'end 2020/4/1
            
         '日文
         Case "3"
            'Modify by Morgan 2006/1/9 改用標楷體--請作單
            '.Selection.Font.Name = "細明體"
            'Modified by Morgan 2014/9/24 改回細明體 --毓芳
            '.Selection.Font.Name = "標楷體"
            'Modified by Morgan 2022/7/13 改 MS Mincho -- 毓芳, May
            '.Selection.Font.Name = "細明體"
            .Selection.Font.Name = "MS Mincho"
            'end 2022/7/13
            'end 2014/9/24
            
            .Selection.PageSetup.Orientation = wdOrientPortrait
            .Selection.Orientation = wdTextOrientationHorizontal
            'Add by Amy 2023/10/13 2019版本需設「固定行高」, FCT 日文 延展核准通知書(定稿別03處理狀況12)定稿 行高過高導致會跳頁 ex:FCT-034731(FCT-050312維持「單行行高」) -宜儒
            'Modify by Amy 2023/10/16 +發文 通知申請案號(日文) ex:FCT-050841
            'Modfiy by Amy 2023/10/26 +核准 延展核准通知書(日文) ex:FCT-035520
            If .Version = 16 And m_MySt(1) = "FCT" Then
               If (m_CP10 = "102" And m_FinalSty = "03" And (m_Situ = "12" Or m_Situ = "19")) Or (m_CP10 = "101" And m_FinalSty = "02" And m_Situ = "08") Then
                  .Selection.ParagraphFormat.LineSpacingRule = wdLineSpaceExactly
                  .Selection.ParagraphFormat.LineSpacing = 15
               End If
            End If
            'Modify by Morgan 2005/7/19 改12號字--春美,易雲
            '.Selection.Font.Size = 13
'Modify By Sindy 2019/3/14 Mark.亭妙反應修改和列印的字體大小不一樣,因列印時這裡又會把字體全部改為12
'自然ChgWordFormat的小字都會又被改回來
'FCP-07-1603-06
'            .Selection.Font.Size = 12
'2019/3/14 END
            
            'Add by Morgan 2011/7/11
            'Modified by Morgan 2020/4/1 +FCT--陳金蓮
            If m_MySt(1) = "FCT" Or m_MySt(1) = "CFP" Or m_MySt(1) = "CFC" Or m_MySt(1) = "FCP" Or m_MySt(1) = "FG" Then
               'Modify By Sindy 2015/7/16
               'If m_MySt(1) = "CFP" Then bolHeader = True '一律要印信頭
               'Modified by Morgan 2020/4/1
               'If ClsPDGetSystemKind(m_MySt(1), intCaseKind) = True Then
               '   If intCaseKind = 專利 Then bolHeader = True
               'End If
               bolHeader = True
               'end 2020/4/1
               '2015/7/16 END
               bolFCTJpTrans = False 'Added by Morgan 2023/2/6
               'Added by Morgan 2020/4/6
               '日文譯文不要信頭
               'Modified by Morgan 2023/4/21 組合定稿定稿除外
               'If m_MySt(1) = "FCT" Then
               If m_MySt(1) = "FCT" And Not bolIsCombined Then
               'end 2023/4/21
                  If ChkJPNoHead(m_MySt(5), m_FinalSty, m_Situ) Then
                     bolHeader = False
                     bolFCTJpTrans = True
                  End If
               End If
               'end 2020/4/6
               
               'Added by Morgan 2020/3/26
               If strSrvDate(1) >= 智慧所更名日 Then
                  stComp = PUB_GetReceiptComp(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), True)
                  PUB_GetLetterPicID stComp, m_MySt(1), iPicNo, iPicNo2, 3, True, Pub_StrUserSt03
               Else
               'end 2020/3/26
                  
                  'bolNewHead = True '用新信頭 'Removed by Morgan 2015/8/12
                  iPicNo = 5
                  iPicNo2 = 9
                  
                  'Added by Morgan 2013/12/30
                  stComp = PUB_GetReceiptComp(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4))
                  '智權公司
                  If stComp = "J" Then
                     iPicNo = 21
                     'patent信箱
                     If m_MySt(1) = "CFP" Then
                        iPicNo2 = 22
                     'ipdept信箱
                     ElseIf m_MySt(1) = "CFT" Then
                        iPicNo2 = 24
                     End If
                  '專利處對國外都用專利法律公司(patent信箱)
                  ElseIf strUserNum <> strFMPNum And (m_MySt(1) = "CFP" Or m_MySt(1) = "P") Then
                     iPicNo2 = 18
                  End If
                  'end 2013/12/30
                  
               End If 'Added by Morgan 2020/3/26
            End If
            
         '英文
         Case "4"
            .Selection.Font.Name = "Times New Roman"
            .Selection.PageSetup.Orientation = wdOrientPortrait
            .Selection.Orientation = wdTextOrientationHorizontal
            .Selection.Font.Size = 12
            
            'Modify by Morgan 2011/7/12
            'bolNewHead = True '用新信頭 'Removed by Morgan 2015/8/12
            
            'Modify By Sindy 2015/7/16
            'If m_MySt(1) = "CFP" Then bolHeader = True '一律要印信頭
            
            'Modified by Morgan 2020/4/1 FCT也要--陳金蓮
            'If ClsPDGetSystemKind(m_MySt(1), intCaseKind, , intI) = True Then
            '   If intCaseKind = 專利 Then bolHeader = True
            '   If intI = 國外_CF And (intCaseKind = 商標 Or intCaseKind = 6) Then bolHeader = True 'Added by Morgan 2107/9/8 +CFT,CFC,S --秀玲
            'End If
            bolHeader = True
            'end 2020/4/1
            '2015/7/16 END
            
            'Added by Morgan 2020/3/26
            If strSrvDate(1) >= 智慧所更名日 Then
               stComp = PUB_GetReceiptComp(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), True)
               PUB_GetLetterPicID stComp, m_MySt(1), iPicNo, iPicNo2, 2, True, Pub_StrUserSt03
            Else
            'end 2020/3/26
            
               iPicNo = 5
               iPicNo2 = 9
               'Added by Morgan 2013/12/30
               stComp = PUB_GetReceiptComp(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4))
               '智權公司
               If stComp = "J" Then
                  'patent信箱
                  If m_MySt(1) = "CFP" Then
                     iPicNo = 21
                     iPicNo2 = 22
                  'ipdept信箱
                  ElseIf m_MySt(1) = "CFT" Then
                     iPicNo = 21
                     iPicNo2 = 24
                  End If
               '專利處對國外都用專利法律公司(patent信箱)
               ElseIf strUserNum <> strFMPNum And (m_MySt(1) = "CFP" Or m_MySt(1) = "P") Then
                  iPicNo2 = 18
               End If
               'end 2013/12/30
               
            End If 'Added by Morgan 2020/3/26
            
         '橫式申請書
         Case "5"
            .Selection.Font.Name = "標楷體"
            .Selection.PageSetup.Orientation = wdOrientPortrait
            .Selection.Orientation = wdTextOrientationHorizontal
            'Modify by Morgan 2004/12/23 只有FCP用16號字
            'Modify by Morgan 2004/12/31 P改回16號字;41200,42100,60114,60115官方申請書列外
            'If m_MySt(1) = "FCP" Then
            'Modify by Morgan 2007/9/21 加第三人申請技術報告80700
            'Modified by Morgan 2013/3/26 +,60116,60117
            'Modified by Morgan 2013/5/21 +,60511,60512
            If m_MySt(1) = "FCP" Or (m_MySt(1) = "P" And (InStr("41200,42100,60114,60115,60116,60117,60511,60512,80700", m_CP10 & m_Situ) = 0)) Then
               .Selection.Font.Size = 16
            ElseIf m_MySt(1) = "FCT" Then
                'Added by Lydia 2016/04/15 催審的申請函,字體14
                If m_FinalSty = "11" Then
                  .Selection.Font.Size = 14
                Else
                'end 2016/04/15
                  .Selection.Font.Size = 12
                End If
            Else
               .Selection.Font.Size = 14
            End If
            
         'Add by Morgan 2011/7/21
         '大陸指示信
         Case "6"
            .Selection.Font.Name = "標楷體"
            .Selection.PageSetup.Orientation = wdOrientPortrait
            .Selection.Orientation = wdTextOrientationHorizontal
            .Selection.Font.Size = 14
            .Selection.ParagraphFormat.LineSpacingRule = wdLineSpaceExactly
            .Selection.ParagraphFormat.LineSpacing = 15
            'bolNewHead = True '用新信頭 'Removed by Morgan 2015/8/12
            bolHeader = True '一律要印信頭
            
            'Added by Morgan 2020/3/26
            If strSrvDate(1) >= 智慧所更名日 Then
               stComp = PUB_GetReceiptComp(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), True)
               PUB_GetLetterPicID stComp, m_MySt(1), iPicNo, iPicNo2, 1, True, Pub_StrUserSt03
            Else
            'end 2020/3/26
            
               iPicNo = 7
               iPicNo2 = 0
               
               'Added by Morgan 2013/12/30
               If m_MySt(1) = "P" Then
                  stComp = PUB_GetReceiptComp(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4))
                  '智權公司(patent信箱)
                  If stComp = "J" Then
                     iPicNo = 21
                     iPicNo2 = 26
                  '非智權公司都用專利法律(patent信箱)
                  Else
                     iPicNo = 19
                  End If
               End If
               'end 2013/12/30
   
            End If 'Added by Morgan 2020/3/26
            
         'Add by Morgan 2011/10/24
         '橫式(不印信頭)
         Case "7"
            .Selection.Font.Name = "標楷體"
            .Selection.PageSetup.Orientation = wdOrientPortrait
            .Selection.Orientation = wdTextOrientationHorizontal
            .Selection.Font.Size = 14
            
            '.Selection.PageSetup.LeftMargin = .CentimetersToPoints(2)
            '.Selection.PageSetup.RightMargin = .CentimetersToPoints(2)
            
            'Add By Sindy 2014/10/2 T大陸指示信不固定行高
            If Not (m_CP01 = "T" And m_FinalSty = "18") Then
            '2014/10/2 END
               .Selection.ParagraphFormat.LineSpacingRule = wdLineSpaceExactly
               .Selection.ParagraphFormat.LineSpacing = 15
               '.Selection.PageSetup.TopMargin = .CentimetersToPoints(3.53)
            End If
            'Add By Sindy 2012/2/15
            '存檔時商標不列印信頭
            If m_bolSave2File = True And m_strFilePath <> "" Then
               If m_MySt(1) = "T" Or m_MySt(1) = "TF" Then
                  bolHeader = False
               End If
            End If
            '2012/2/15 End
            
            'Add By Sindy 2019/11/21
            If ((m_FinalSty = "10" Or m_FinalSty = "15") And Left(m_MySt(1), 1) = "T" And strSrvDate(1) >= T商標電子化啟用日) Or _
               (Left(m_MySt(1), 1) = "T" And strSrvDate(1) >= T商標電子化第2階段啟用日) Then
               bolHeader = True
               
               'Added by Morgan 2020/3/26
               If strSrvDate(1) >= 智慧所更名日 Then
                  stComp = PUB_GetReceiptComp(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), True)
                  PUB_GetLetterPicID stComp, m_MySt(1), iPicNo, iPicNo2, 1, True, Pub_StrUserSt03
               Else
               'end 2020/3/26
                  '大->台
                  iPicNo = 7
                  iPicNo2 = 0
               End If 'Added by Morgan 2020/3/26
            End If
            '2019/11/21 END
      End Select
      
      'Add by Morgan 2011/2/11 FCP承辦的定稿用 12 號字
      If strUserNum = strFMPNum Then .Selection.Font.Size = 12

      'Add by Morgan 2004/11/11 加英文版面
      'Modify by Morgan 2011/6/1 目前只有CFP用,其他維持原版面等用新信紙時再統一(其他系統也會設定成英文但僅限分類用)
      'Modify by Morgan 2011/7/12 英日文都改用新信紙版面
      If (strPrintType = "4" Or strPrintType = "3") Then
         .Selection.PageSetup.LeftMargin = .CentimetersToPoints(3.175)
         'Modif by Morgan 2007/2/14 先調小使落款不會跳行，確認正式格式後再修改
         '.Selection.PageSetup.RightMargin = .CentimetersToPoints(3.175)
         'Modify by Morgan 2011/7/12 改用新信頭
         '.Selection.PageSetup.RightMargin = .CentimetersToPoints(2)
         ''End 2007/2/14
         '.Selection.PageSetup.TopMargin = .CentimetersToPoints(3.53)
         '.Selection.PageSetup.BottomMargin = .CentimetersToPoints(2)
         .Selection.PageSetup.RightMargin = .CentimetersToPoints(3.175)
         '.Selection.PageSetup.TopMargin = .CentimetersToPoints(5)
         'Added by Morgan 2023/2/6 FCT日譯文上邊界設3CM--79020
         If m_MySt(1) = "FCT" And bolFCTJpTrans Then
            .Selection.PageSetup.TopMargin = .CentimetersToPoints(3)
         Else
         'end 2023/2/6
            .Selection.PageSetup.TopMargin = .CentimetersToPoints(4) 'Add By Sindy 2015/7/17 外專要改開窗信封,因此為了看到地址姓名而調整
         End If 'Added by Morgan 2023/2/6
         .Selection.PageSetup.BottomMargin = .CentimetersToPoints(3)
         .Selection.PageSetup.FooterDistance = .CentimetersToPoints(2.5)
         
         'Add by Morgan 2011/7/12 外商日文
         If (m_MySt(1) = "FCT" Or m_MySt(1) = "CFT" Or m_MySt(1) = "CFC" Or m_MySt(1) = "S") Then
            .Selection.Font.Size = 13
         End If
         
      Else
         .Selection.PageSetup.LeftMargin = .CentimetersToPoints(2)
         .Selection.PageSetup.RightMargin = .CentimetersToPoints(2)
         'Add by Morgan 2011/7/21
'         If bolNewHead = True Then 'Removed by Morgan 2015/8/12
         
            If strPrintType = "6" Then
               .Selection.PageSetup.TopMargin = .CentimetersToPoints(5.14)
            'Add By Sindy 2018/4/10 專利處電子送件申請書
            ElseIf (m_FinalSty = "01" And m_MySt(1) = "P" And strPrintType = "7") Then
               .Selection.Font.Size = 12
               .Selection.Font.Name = "新細明體"
               .Selection.PageSetup.TopMargin = .CentimetersToPoints(2.5)
            '2018/4/10 END
            Else
               .Selection.PageSetup.TopMargin = .CentimetersToPoints(4)
            End If
            .Selection.PageSetup.BottomMargin = .CentimetersToPoints(2.5)
            
'Removed by Morgan 2015/8/12
'         Else
'         'end 2011/7/21
'            .Selection.PageSetup.TopMargin = .CentimetersToPoints(3.53)
'            'Add by Morgan 2008/7/7 配合新的開窗定稿下邊界加大
'            If m_bolNewFormat = True Then
'               .Selection.PageSetup.BottomMargin = .CentimetersToPoints(2.5)
'            Else
'               .Selection.PageSetup.BottomMargin = .CentimetersToPoints(2)
'            End If
'         End If 'Add by Morgan 2011/7/21
'end 2015/8/12

      End If
      '2004/11/11
      
      .Selection.ParagraphFormat.FarEastLineBreakControl = False 'Added by Morgan 2013/4/15 不要避頭尾,否則word2000造字會有斷行問題
      .Selection.ParagraphFormat.DisableLineHeightGrid = True
      ' 90.07.25 modify by louis (首列凸排五個字元)
      Select Case m_MySt(1)
         ' 只有P類及FCP類的各式申請書才要首列凸排
       ' Added by Lydia 2016/04/01 +T案的催審函
         Case "P", "FCP", "T"
            'Modify by Morgan 2009/9/18 P催審函是申請書才要凸排
            'If (m_FinalSty = "01") Or (m_MySt(1) = "P" And m_FinalSty = "16") Or (m_MySt(1) = "FCP" And m_FinalSty = "11") Then
            ' Modified by Lydia 2016/04/01 +T案的催審函T,11,000,03
            'Modified by Lydia 2016/04/11 debug
            'If (m_FinalSty = "01") Or (m_MySt(1) = "P" And m_FinalSty = "16" And strPrintType = "5") Or (m_MySt(1) = "FCP" And m_FinalSty = "11") _
                Or (m_MySt(1) = "T" And m_FinalSty = "11" And m_Situ = "03") Then
            If (m_FinalSty = "01" And m_MySt(1) <> "T") Or (m_MySt(1) = "P" And m_FinalSty = "16" And strPrintType = "5") Or (m_MySt(1) = "FCP" And m_FinalSty = "11") _
                Or (m_MySt(1) = "T" And m_FinalSty = "11" And m_Situ = "03") Then
            'If m_FinalSty = "01" Then  MODIFY BY SONIA 90.10.20
               'Added by Lydia 2016/04/01+T案的催審函T,11,000,03
'               If m_MySt(1) = "T" And m_FinalSty = "11" And m_Situ = "03" Then
'                  .Selection.PageSetup.TopMargin = .CentimetersToPoints(3.17)
'                  .Selection.ParagraphFormat.LeftIndent = .CentimetersToPoints(3)
'                  .Selection.ParagraphFormat.RightIndent = .CentimetersToPoints(0)
'                  .Selection.ParagraphFormat.FirstLineIndent = .CentimetersToPoints(-2)
               'Modify by Morgan 2004/12/8 橫印申請書版面
               If strPrintType = "5" Then
'               ElseIf strPrintType = "5" Then
'               'end 2016/04/01
                  .Selection.PageSetup.TopMargin = .CentimetersToPoints(3.17) 'Add by Morgan 2004/12/31
                  .Selection.ParagraphFormat.LeftIndent = .CentimetersToPoints(3)
                  '.Selection.ParagraphFormat.RightIndent = .CentimetersToPoints(1)
                  .Selection.ParagraphFormat.RightIndent = .CentimetersToPoints(0)
                   'Added by Lydia 2016/04/01+T案的催審函T,11,000,03
                   If m_MySt(1) = "T" And m_FinalSty = "11" And m_Situ = "03" Then
                      .Selection.ParagraphFormat.FirstLineIndent = .CentimetersToPoints(-2)
                   Else
                      .Selection.ParagraphFormat.FirstLineIndent = .CentimetersToPoints(-1.7)
                   End If
                   'end 2016/04/01
               'Add By Sindy 2015/12/11 FCP委任狀中譯文
               ElseIf m_MySt(1) = "FCP" And m_FinalSty = "01" And _
                      (m_Situ = "31" Or m_Situ = "32" Or m_Situ = "33" Or m_Situ = "34" Or m_Situ = "35") Then
                  .Selection.ParagraphFormat.LeftIndent = .CentimetersToPoints(0)
                  .Selection.ParagraphFormat.RightIndent = .CentimetersToPoints(0)
                  .Selection.ParagraphFormat.FirstLineIndent = .CentimetersToPoints(0)
               '2015/12/11 END
               'Modify By Sindy 2018/4/10 專利處電子送件申請書
               'Else
               ElseIf Not (m_FinalSty = "01" And m_MySt(1) = "P" And strPrintType = "7") Then
               '2018/4/10 END
                  .Selection.ParagraphFormat.LeftIndent = .CentimetersToPoints(2)
                  .Selection.ParagraphFormat.RightIndent = .CentimetersToPoints(0)
                  .Selection.ParagraphFormat.FirstLineIndent = .CentimetersToPoints(-1.7)
               End If
               
               .Selection.ParagraphFormat.SpaceBefore = 0
               .Selection.ParagraphFormat.SpaceAfter = 0
               .Selection.ParagraphFormat.LineSpacingRule = wdLineSpaceSingle
               .Selection.ParagraphFormat.Alignment = wdAlignParagraphJustify
               .Selection.ParagraphFormat.WidowControl = False
               .Selection.ParagraphFormat.KeepWithNext = False
               .Selection.ParagraphFormat.KeepTogether = False
               .Selection.ParagraphFormat.PageBreakBefore = False
               .Selection.ParagraphFormat.NoLineNumber = False
               .Selection.ParagraphFormat.Hyphenation = True
               
               .Selection.ParagraphFormat.OutlineLevel = wdOutlineLevelBodyText
               .Selection.ParagraphFormat.AutoAdjustRightIndent = True
               'Add By Sindy 2015/12/11 FCP委任狀中譯文 為 段落:單行間距
               If m_MySt(1) = "FCP" And m_FinalSty = "01" And _
                      (m_Situ = "31" Or m_Situ = "32" Or m_Situ = "33" Or m_Situ = "34" Or m_Situ = "35") Then
                  .Selection.ParagraphFormat.DisableLineHeightGrid = False
               Else
               '2015/12/11 END
                  .Selection.ParagraphFormat.DisableLineHeightGrid = True
               End If
               '.Selection.ParagraphFormat.FarEastLineBreakControl = True 'Removed by Morgan 2013/4/15 不要避頭尾,否則word2000造字會有斷行問題
               .Selection.ParagraphFormat.WordWrap = True
               .Selection.ParagraphFormat.HangingPunctuation = True
               .Selection.ParagraphFormat.HalfWidthPunctuationOnTopOfLine = False
               .Selection.ParagraphFormat.AddSpaceBetweenFarEastAndAlpha = True
               .Selection.ParagraphFormat.AddSpaceBetweenFarEastAndDigit = True
               .Selection.ParagraphFormat.BaseLineAlignment = wdBaselineAlignAuto
                 
               'Add By Sindy 2015/12/11 FCP委任狀中譯文
               'Modify By Sindy 2018/4/10 專利處電子送件申請書
               If Not (m_MySt(1) = "FCP" And m_FinalSty = "01" And (m_Situ = "31" Or m_Situ = "32" Or m_Situ = "33" Or m_Situ = "34" Or m_Situ = "35")) And _
                  Not (m_FinalSty = "01" And m_MySt(1) = "P" And strPrintType = "7") Then
               '2015/12/11 END
                  'Add By Cheng 2003/01/13
                  '加三個全形空白, 以與其他頁數的第一列起始位置對齊
                  .Selection.TypeText "　　　"
               End If
            End If
         'add by nick 2004/12/16
         Case "FCT"
            'Modified by Lydia 2016/04/14 +催審函(11)
            If (m_FinalSty = "90" Or m_FinalSty = "11") Then
               If strPrintType = "5" Then
                  .Selection.ParagraphFormat.LeftIndent = .CentimetersToPoints(3)
                  '.Selection.ParagraphFormat.RightIndent = .CentimetersToPoints(1)
                  .Selection.ParagraphFormat.RightIndent = .CentimetersToPoints(0)
               Else
                  'Modify By Sindy 2009/09/08
                  '3F阿蓮要求調整之
                  '.Selection.ParagraphFormat.LeftIndent = .CentimetersToPoints(2)
                  .Selection.ParagraphFormat.LeftIndent = .CentimetersToPoints(1.7)
                  '2009/09/08 End
                  .Selection.ParagraphFormat.RightIndent = .CentimetersToPoints(0)
               End If
               'Modified by Lydia 2016/04/14 催審函調整,首列凸排
               '.Selection.ParagraphFormat.FirstLineIndent = .CentimetersToPoints(-1.7)
               If m_FinalSty = "11" And strPrintType = "5" Then
                   .Selection.PageSetup.TopMargin = .CentimetersToPoints(3.17)
                   .Selection.ParagraphFormat.FirstLineIndent = .CentimetersToPoints(-2)
               Else
                   .Selection.ParagraphFormat.FirstLineIndent = .CentimetersToPoints(-1.7)
               End If
               'end 2016/04/14
 
               .Selection.ParagraphFormat.SpaceBefore = 0
               .Selection.ParagraphFormat.SpaceAfter = 0
               .Selection.ParagraphFormat.LineSpacingRule = wdLineSpaceSingle
               .Selection.ParagraphFormat.WidowControl = False
               .Selection.ParagraphFormat.KeepWithNext = False
               .Selection.ParagraphFormat.KeepTogether = False
               .Selection.ParagraphFormat.PageBreakBefore = False
               .Selection.ParagraphFormat.NoLineNumber = False
               .Selection.ParagraphFormat.Hyphenation = True
               
               .Selection.ParagraphFormat.OutlineLevel = wdOutlineLevelBodyText
               .Selection.ParagraphFormat.AutoAdjustRightIndent = True
               .Selection.ParagraphFormat.DisableLineHeightGrid = True
               '.Selection.ParagraphFormat.FarEastLineBreakControl = True 'Removed by Morgan 2013/4/15 不要避頭尾,否則word2000造字會有斷行問題
               .Selection.ParagraphFormat.WordWrap = True
               .Selection.ParagraphFormat.HangingPunctuation = True
               .Selection.ParagraphFormat.HalfWidthPunctuationOnTopOfLine = False
               .Selection.ParagraphFormat.AddSpaceBetweenFarEastAndAlpha = True
               .Selection.ParagraphFormat.AddSpaceBetweenFarEastAndDigit = True
               .Selection.ParagraphFormat.BaseLineAlignment = wdBaselineAlignAuto
               'Add By Cheng 2003/01/13
               '加三個全形空白, 以與其他頁數的第一列起始位置對齊
               'Modify By Sindy 2014/11/13 Mark:阿蓮說不要空白
               '.Selection.TypeText "　　　"
            End If
         Case Else
      End Select

      'Add By Sindy 2012/2/15
      '存檔時商標定稿為橫式(不印信頭)的不列印智權人員(檢查有關第一份不列印的資料均去除)
      'Modified by Morgan 2015/5/12 台灣專利案電子化後定稿只保留客戶版本 +(g_LD18 <> "" And m_MySt(1) = "P" And m_MySt(6) = "000") Or
      'Modified by Morgan 2016/6/13 內專全面電子化後定稿都只保留客戶版本 + Or 內專全面電子化啟用日 <= Val(strSrvDate(1))
      'Modify By Sindy 2016/8/9 內商大至台定稿若要列印信頭且有總經理的電子簽章只保留客戶版本
      'Modified by Morgan 2017/12/26 +CFP
      'modify by sonia 2020/5/21 為免其他系統別無紙化漏改,僅以g_LD18判斷即可
      'If (g_LD18 <> "" And (m_MySt(1) = "P" Or m_MySt(1) = "CFP")) Or
      'Modified by Morgan 2021/10/27 +m_bolECust E化客戶
      If g_LD18 <> "" Or m_bolECust Or _
         ((m_bolSave2File = True And m_strFilePath <> "") And strPrintType = "7" And (m_MySt(1) = "T" Or m_MySt(1) = "TF")) Or _
         (bolHeader = True And InStr(strData, "林景郁大陸中文") > 0 And InStr(strData, "自動簽名檔") > 0) Then
         Do While (InStr(strData, "|\") > 0 And InStr(strData, "\|") > 0)
            longStar = InStr(strData, "|\")
            longLen = (InStr(strData, "\|") + 2) - longStar
            strData = Replace(strData, Mid(strData, longStar, longLen), "")
         Loop
         Do While (InStr(strData, "|*") > 0 And InStr(strData, "*|") > 0)
            longStar = InStr(strData, "|*")
            longLen = (InStr(strData, "*|") + 2) - longStar
            strData = Replace(strData, Mid(strData, longStar, longLen), "")
         Loop
      End If
      '2012/2/15 End
      
      If (bolEditKeepMark And m_Preview) = False Then 'Added by Morgan 2014/4/1
            strData = Replace(strData, "|\", "")
            strData = Replace(strData, "\|", "")
               'Add By Cheng 2003/01/10
            strData = Replace(strData, "|*", "")
            strData = Replace(strData, "*|", "")
               'Add By Cheng 2003/11/27
            strData = Replace(strData, "|@", "")
            strData = Replace(strData, "@|", "")
            
            'Added by Morgan 2016/2/25
            strData = Replace(strData, "|$", "")
            strData = Replace(strData, "$|", "")
            strData = Replace(strData, "|%", "")
            strData = Replace(strData, "%|", "")
            'end 2016/2/25
            
      End If 'Added by Morgan 2014/4/1

      
      'add by nickc 2006/03/28 加入代表圖   ---start
      CalVbCrLfCount = 0
      If InStr(1, strData, "|#代表圖#|") <> 0 Then
         'Memo by Lydia 2020/05/25 案件回覆單改成自動代表圖
         CalVbCrLfStr = Mid(strData, InStr(1, strData, "案件回覆單"), InStr(1, strData, "|#代表圖#|") - 1 - InStr(1, strData, "案件回覆單") + 1)
         Do While InStr(1, CalVbCrLfStr, vbCrLf) <> 0
             CalVbCrLfCount = CalVbCrLfCount + 1
             CalVbCrLfStr = Mid(CalVbCrLfStr, InStr(1, CalVbCrLfStr, vbCrLf) + 1)
         Loop
         'Modify by Morgan 2009/4/24 商標往上提3 行
         '   CalVbCrLfCount = CalVbCrLfCount + 5
         If m_MySt(1) = "T" Then
            CalVbCrLfCount = CalVbCrLfCount + 2
         Else
            CalVbCrLfCount = CalVbCrLfCount + 5
         End If
      End If
      'add end
      
      'Add By Sindy 2014/9/19
      If bolUseForHTML = True Then
         'Add By Sindy 2014/10/9 特殊的定稿要置換內容
         'Modify By Sindy 2015/6/29 簽名章直接印出來
         If m_MySt(1) = "FCP" And m_FinalSty = "08" And _
            (m_Situ = "02" Or m_Situ = "07") And _
            m_MySt(5) <> "416" Then
            strFindText = "Best regards,                              |#(粗體)Return Message:#|" & vbCrLf & _
                          "                                        |#(粗體)□ Please pay the fee#|" & vbCrLf & _
                          "                                        |#(粗體)□ Paid through other Channel#|" & vbCrLf & _
                          "Tai E International Patent & Law Office        |#(粗體)□ Abandoned/Closed#|"
            strReplText = "                              Best regards," & vbCrLf & vbCrLf & _
                          "                              |#(閰英自動簽名檔)#|" & vbCrLf & _
                          "                              Tai E International Patent & Law Office" & vbCrLf & _
                          "|#(粗體)Return Message:#|" & vbCrLf & _
                          "|#(粗體)□ Please pay the fee#|" & vbCrLf & _
                          "|#(粗體)□ Paid through other Channel#|" & vbCrLf & _
                          "|#(粗體)□ Abandoned/Closed#|"
            If InStr(strData, strFindText) > 0 Then
               strData = Replace(strData, strFindText, strReplText)
            End If
         End If
         '2014/10/9 END
         
'         'Modify By Sindy 2014/10/8
'         '去掉簽名檔後面的折行
'         Dim strData1 As String, strData2 As String
'         If InStr(strData, "簽名檔)#|") > 0 Then
'            strData1 = Left(strData, InStr(strData, "簽名檔)#|") + 5)
'            strData2 = Mid(strData, InStr(strData, "簽名檔)#|") + 6, Len(strData))
'            Do While InStr(strData2, vbCrLf) = 1 Or InStr(strData2, vbLf) = 1
'               strData2 = Mid(strData2, 2)
'            Loop
'            strData = strData1 & strData2
'         End If
'         '2014/10/8 END
         
'***** 發現轉換 vbVerticalTab 會有問題,如後面的VBA有下靠右,會整篇文章靠右 *****
'         Do While InStr(strData, vbCrLf) = 1 Or InStr(strData, vbLf) = 1
'            strData = Mid(strData, 2)
'         Loop
'         strData = Replace(strData, vbCrLf, vbVerticalTab)
'         'Add By Sindy 2014/9/26
''         If InStr(UCase(strData), UCase("Best regards,")) > 0 Then
''            strData = Trim(Left(strData, InStr(UCase(strData), UCase("Best regards,")) - 1))
''         End If
'         '去掉全部文字最後面的折行
'         Do While InStrRev(strData, vbVerticalTab) > 0
'            If Len(Mid(strData, InStrRev(strData, vbVerticalTab))) = 1 Then
'               strData = Left(strData, InStrRev(strData, vbVerticalTab) - 1)
'            Else
'               Exit Do
'            End If
'         Loop
'         strData = strData & vbVerticalTab
'         '2014/9/26 END
'***** 發現轉換 vbVerticalTab END *****
      Else
         'Modified by Morgan 2014/11/12
         'If InStr(strData, "簽名檔)#|") > 0 Then
         'Modified by Morgan 2014/12/9 +bolAlwaysShowSign
         If InStr(strData, "簽名檔)#|") > 0 And InStr(strData, "自動簽名檔)#|") = 0 And bolAlwaysShowSign = False Then
         'end 2014/11/12
            strFindText = Mid(strData, InStrRev(Left(strData, InStr(strData, "簽名檔)#|")), "|#"), ((InStr(strData, "簽名檔)#|") + 5) + 1) - InStrRev(Left(strData, InStr(strData, "簽名檔)#|")), "|#"))
            strData = Replace(strData, strFindText, "")
         End If
      End If
      '2014/9/19 END

     'Added by Lydia 2020/02/17 Word的.Selection.TypeText有長度限制20000字(ex.FCT-45394的定稿:通知申請案號(英譯本)FCT,02,101,11的商品名稱只顯示到第7類)
     If GetTextLength(strData) > 20000 Then
         strReplText = strData
         'Modified by Morgan 2023/10/19
         'For longStar = 1 To GetTextLength(strReplText) Step 20000
         '   strFindText = RTrim(convForm(strReplText, 20000))
         '   .Selection.TypeText strFindText
         '   strReplText = Replace(strReplText, strFindText, "")
         'Next
         Do
            strFindText = RTrim(convForm(strReplText, 20000))
            .Selection.TypeText strFindText
            If strReplText = strFindText Then
               Exit Do
            Else
               strReplText = Mid(strReplText, Len(strFindText) + 1)
            End If
         Loop
         'end 2023/10/19
     Else
     'end 2020/02/17
         .Selection.TypeText strData
     End If 'Added by Lydia 2020/02/17
     
     '.Selection.TypeParagraph 'Remove by Morgan 2008/12/9 定稿內容可能會因此多一頁
     'Add By Cheng 2002/12/27
     .Selection.WholeStory
     'Modify by Morgan 2011/7/14
     
      'Modify by Morgan 2011/7/12 外商日文全部用細明體
      '.Selection.Font.Name = "Times New Roman"
      'Modified by Morgan 2014/9/24 FCP也改全部用細明體 --毓芳
      'If strPrintType = 3 And (m_MySt(1) = "FCT" Or m_MySt(1) = "CFT" Or m_MySt(1) = "CFC" Or m_MySt(1) = "S") Then
     'Add By Sindy 2020/3/11 剔除專利處電子送件申請書
     If Not (m_FinalSty = "01" And m_MySt(1) = "P" And strPrintType = "7") Then
     '2020/3/11 END
         If strPrintType = "3" Then
            '.Selection.Font.Name = "細明體" 'Removed by Morgan 2018/2/23 移到後面，否則折行可能會有問題
         Else
            .Selection.Font.Name = "Times New Roman"
         End If
     End If
     
     'add by nickc 2007/08/06 檢查有無要在 word 裡面轉換的關鍵字，若是有，必須經過轉換
     If InStr(1, strData, "|#(") <> 0 Then
         'Modify by Amy 2018/07/27 +showColorFirst
         ChgWordFormat g_WordAp.Application, strData, showColorFirst
     End If
     
     'Added by Morgan 2018/2/23
     If strPrintType = "3" Then '日文
         .Selection.WholeStory
         'Modify By Sindy 2019/3/14 Mark.亭妙反應修改和列印的字體大小不一樣,因列印時這裡又會把字體全部改為12
'自然ChgWordFormat的小字都會又被改回來
'FCP-07-1603-06
'        'Modify By Sindy 2018/3/29
'        If m_MySt(1) = "FCP" And strUserLevel = "發FC郵件" Then
'            .Selection.Font.NameFarEast = "細明體"
'            .Selection.Font.NameAscii = "Times New Roman"
'            .Selection.Font.NameOther = "Times New Roman"
'        Else
'        '2018/3/29 END
            'Modified by Morgan 2022/7/13 改 MS Mincho -- 毓芳, May
            '.Selection.Font.Name = "細明體"
            .Selection.Font.Name = "MS Mincho"
            'Removed by Morgan 2022/12/20 取消,非英數字(符號、造字...)也會被影響 --經理、May
            '.Selection.Font.Name = "Times New Roman" 'Added by Morgan 2022/12/14 英數字 -- May,毓芳沒意見
            'end 2022/12/20
            'end 2022/7/13
'        End If
         '2019/3/14 END
     'End If
     'end 2018/2/23
     'Modify By Sindy 2019/3/14 調整和列印(PrinterLetterDB)一樣
     Else
         'Add By Sindy 2020/3/11 剔除專利處電子送件申請書
         If Not (m_FinalSty = "01" And m_MySt(1) = "P" And strPrintType = "7") Then
         '2020/3/11 END
            .Selection.Font.Name = "標楷體" 'Added by Morgan 2017/10/20
            .Selection.Font.Name = "Times New Roman"
         End If
     End If
     '2019/3/14 END
     
     'add by nickc 2006/03/28 加入印代表圖
     'Modify by Amy 2018/07/30 +showColorFirst
     If CalVbCrLfCount <> 0 Then
         PUB_AddInPicToWord g_WordAp.Application, CalVbCrLfCount, showColorFirst
     End If
     'add by nickc 2007/08/07 加入新定稿的固定代表圖
     If InStr(1, strData, "|#右代表圖#|") <> 0 Then
         PUB_AddInPicToWordR g_WordAp.Application, showColorFirst
     End If
     'Add By Sindy 2014/3/18 加入新定稿的固定代表圖2
     If InStr(1, strData, "|#右代表圖2#|") <> 0 Then
         PUB_AddInPicToWordR2 g_WordAp.Application, showColorFirst
     End If
     'Modify By Sindy 2014/3/19 加入新定稿的固定代表圖3
     If InStr(1, strData, "|#右代表圖3#|") <> 0 Then
         PUB_AddInPicToWordR3 g_WordAp.Application, showColorFirst
     End If
     'end 2018/07/30
     'Add By Sindy 2023/8/2 加入右代表圖-公報
     If InStr(1, strData, "|#右代表圖-公報#|") <> 0 Then
         strSql = "select tmbulletindata.*,tm01,tm02,tm03,tm04,tm08 from tmbulletindata,trademark " & _
                  "Where tm01='" & m_MySt(1) & "' and tm02='" & m_MySt(2) & "' and tm03='" & m_MySt(3) & "' and tm04='" & m_MySt(4) & "'" & _
                  " and tbd02=tm15 and tbd03=tm08 and tbd16='1' and tbd15='A'" & _
                  " and tm44 is null"
         Set RsTemp = ClsLawReadRstMsg(intI, strSql)
         If intI = 1 Then
            If "" & RsTemp.Fields("TBD12") <> "" Then
               PUB_AddInPicToWordR4 g_WordAp.Application, RsTemp.Fields("TBD12")
            End If
         End If
     End If
     '2023/8/2 END
     
     'Add by Morgan 2008/3/20
      '是否+信頭
      If bolHeader = True Then
         'Add by Morgan 2011/6/1
'         If bolNewHead Then 'Removed by Morgan 2015/8/12

            .Selection.HomeKey Unit:=wdStory, Extend:=wdMove
            Do
               If PUB_ReadDB2File(stFileName, iPicNo) = True Then
                  'Modified by Lydia 2019/05/22 +橫式雙面LD12=8
                  'If strPrintType <> "3" And strPrintType <> "4" Then 'Add by Morgan 2011/7/12 英日文因為第 2 頁以後不要有信頭故改回放在本文
                  If strPrintType <> "3" And strPrintType <> "4" And strPrintType <> "8" Then
                     .ActiveWindow.ActivePane.View.SeekView = wdSeekCurrentPageHeader
                     
                     PUB_AddConfidential .Selection, strData 'Added by Morgan 2025/4/9
                  End If
                  Set oShape = .ActiveDocument.Shapes.AddPicture(Anchor:=.Selection.Range, FileName:=stFileName, LinkToFile:=False, SaveWithDocument:=True)
                  oShape.ZOrder 4
                  oShape.LockAnchor = True
                  oShape.LockAspectRatio = -1
                  oShape.WrapFormat.Type = 5 'Added by Morgan 2025/4/9
                     
                  If iPicNo2 <> 0 Then
                     oShape.RelativeHorizontalPosition = wdRelativeHorizontalPositionPage
                     oShape.RelativeVerticalPosition = wdRelativeVerticalPositionPage
                     
                     'Add by Morgan 2011/7/20
                     'Removed by Morgan 2015/7/21 原指示信沒有信尾,程式多寫
                     'If bolChinaOrderLetter Then
                     '   oShape.Width = 546.5
                     '   oShape.Left = .CentimetersToPoints(1)
                     '   'Modified by Morgan 2015/6/22 配合E化列印EMail信頭向上微調
                     '   'oShape.Top = .CentimetersToPoints(1)
                     '   oShape.Top = .CentimetersToPoints(0.8)
                     'Else
                     'end 2015/7/21
                     
                        oShape.Width = .CentimetersToPoints(21)
                        oShape.Left = .CentimetersToPoints(0)
                        'Added by Morgan 2020/3/26
                        If strSrvDate(1) >= 智慧所更名日 Then
                           oShape.Top = .CentimetersToPoints(0)
                        Else
                        'end 2020/3/26
                        
                           '英文
                           If iPicNo = 5 Then
                              oShape.Top = .CentimetersToPoints(0)
                           '中文
                           Else
                              oShape.Top = .CentimetersToPoints(0.5)
                           End If
                        End If 'Added by Morgan 2020/3/26
                        
                     'End If'Removed by Morgan 2015/7/21
                     'end 2011/7/20
                     
                     '+信尾
                     If PUB_ReadDB2File(stFileName, iPicNo2) = True Then
                        'Modified by Lydia 2019/05/22 +橫式雙面LD12=8
                        'If strPrintType <> "3" And strPrintType <> "4" Then 'Add by Morgan 2011/7/12 英日文因為第 2 頁以後不要有信頭故改回放在本文
                        If strPrintType <> "3" And strPrintType <> "4" And strPrintType <> "8" Then
                           .ActiveWindow.ActivePane.View.SeekView = wdSeekCurrentPageFooter
                        End If
                        Set oShape = .ActiveDocument.Shapes.AddPicture(Anchor:=.Selection.Range, FileName:=stFileName, LinkToFile:=False, SaveWithDocument:=True)
                        oShape.ZOrder 4
                        oShape.LockAnchor = True
                        oShape.LockAspectRatio = -1
                        oShape.Width = .CentimetersToPoints(21)
                        oShape.RelativeHorizontalPosition = wdRelativeHorizontalPositionPage
                        oShape.RelativeVerticalPosition = wdRelativeVerticalPositionPage
                        oShape.Left = .CentimetersToPoints(0)
                        'Added by Morgan 2020/3/26
                        If strSrvDate(1) >= 智慧所更名日 Then
                           If bolTwLtr = True Then '中文對國內定稿
                              oShape.Top = .CentimetersToPoints(27.2)
                           Else
                              oShape.Top = .CentimetersToPoints(27.6)
                           End If
                        Else
                        'end 2020/3/26
                        
                           '英文
                           If iPicNo2 = 9 Then
                              oShape.Top = .CentimetersToPoints(27.6)
                           '中文
                           Else
                              oShape.Top = .CentimetersToPoints(27)
                           End If
                        End If 'Added by Morgan 2020/3/26
                     End If
                  Else
                     oShape.Width = 546.5
                     oShape.RelativeHorizontalPosition = wdRelativeHorizontalPositionPage
                     oShape.RelativeVerticalPosition = wdRelativeVerticalPositionPage
                     oShape.Left = .CentimetersToPoints(1)
                     'Modified by Morgan 2015/6/22 配合E化列印EMail信頭向上微調
                     'oShape.Top = .CentimetersToPoints(1)
                     'Added by Morgan 2020/3/26
                     If strSrvDate(1) >= 智慧所更名日 Then
                        oShape.Top = .CentimetersToPoints(0)
                     Else
                     'end 2020/3/26
                        oShape.Top = .CentimetersToPoints(0.8)
                     End If 'Added by Morgan 2020/3/26
                  End If
                  'Modified by Lydia 2019/05/22 +橫式雙面LD12=8
                  'If strPrintType <> "3" And strPrintType <> "4" Then 'Add by Morgan 2011/7/12 英日文因為第 2 頁以後不要有信頭故改回放在本文
                  If strPrintType <> "3" And strPrintType <> "4" And strPrintType <> "8" Then
                     .ActiveWindow.ActivePane.View.SeekView = wdSeekMainDocument
                     Exit Do
                  End If
                  
                  If lngLast >= 0 Then
                     lngLast = InStr(lngLast + 1, strData, Chr(12))
                  End If
                  iHeadCount = iHeadCount + 1
                  If iHeaderPageNum > 0 And iHeadCount >= iHeaderPageNum Then
                     Exit Do
                  Else
                     'Added by Lydia 2019/05/22 橫式雙面的第2頁不印信頭＋信尾
                     If strPrintType = "8" Then
                        Exit Do
                     End If
                     'end 2019/05/22
                     If lngLast > 0 Then '有跳頁符號
                        .Selection.GoTo what:=wdGoToPage, which:=wdGoToNext, Count:=1
                     Else
                        lngLast = -1
                        .ActiveDocument.Repaginate
                        '沒有跳頁符號但頁數大於已印信頭數
                        If iHeadCount < .ActiveDocument.BuiltInDocumentProperties(wdPropertyPages) Then
                           .Selection.GoTo what:=wdGoToPage, which:=wdGoToNext, Count:=1
                        Else
                           Exit Do
                        End If
                     End If
                  End If
                  'end 2011/7/12
               Else
                  Exit Do
               End If
            Loop
            .Selection.EndKey Unit:=wdStory
            
'Removed by Morgan 2015/8/12
'         Else
'         'end 2011/6/1
'
'             '插入圖片檔案(用跳頁符號判斷頁數)
'             If ReadDB2File(stFileName, m_CP01) = True Then
'                .Selection.HomeKey Unit:=wdStory, Extend:=wdMove
'                Do
'                   'Modify by Morgan 2008/6/12 控制遇特殊定稿則該頁以後不用信頭
'                   'intI = InStr(lngLast + 1, strData, "F A X  返 信 用 紙") - lngLast
'                   'If intI > 0 And intI < 50 Then
'                   '   Exit Do
'                   'End If
'                   'Modified by Morgan 2012/8/16 改用 oShape 操作(原用變數名稱當改信頭文件重複使用時會有錯)
'                   Set oShape = .ActiveDocument.Shapes.AddPicture(Anchor:=.Selection.Range, FileName:=stFileName, LinkToFile:=False, SaveWithDocument:=True)
'                   '.ActiveDocument.Shapes("Picture " & Trim(.ActiveDocument.Shapes.Count + 1)).Select
'
'                   oShape.ZOrder 5
'                   oShape.LockAnchor = True
'                   oShape.LockAspectRatio = -1
'                   oShape.Width = 546.5
'                   oShape.WrapFormat.Type = wdWrapNone
'                   oShape.RelativeHorizontalPosition = wdRelativeHorizontalPositionPage
'                   oShape.RelativeVerticalPosition = wdRelativeVerticalPositionPage
'                   oShape.Left = .CentimetersToPoints(1)
'                   'Modified by Morgan 2015/6/22 配合E化列印EMail信頭向上微調
'                   'oShape.Top = .CentimetersToPoints(1)
'                   oShape.Top = .CentimetersToPoints(0.8)
'                   If lngLast >= 0 Then
'                      lngLast = InStr(lngLast + 1, strData, Chr(12))
'                   End If
'                   iHeadCount = iHeadCount + 1 'Add by Morgan 2010/11/12
'                   'Add by Morgan 2011/2/11
'                   If iHeaderPageNum > 0 And iHeadCount >= iHeaderPageNum Then
'                      Exit Do
'                   Else
'                   'end 2011/2/11
'                      If lngLast > 0 Then '有跳頁符號
'                         .Selection.GoTo what:=wdGoToPage, which:=wdGoToNext, Count:=1
'                      'Modify by Morgan 2010/11/12
'                      'Else
'                      '   Exit Do
'                      'End If
'                      Else
'                         lngLast = -1
'                         .ActiveDocument.Repaginate
'                         '沒有跳頁符號但頁數大於已印信頭數
'                         If iHeadCount < .ActiveDocument.BuiltInDocumentProperties(wdPropertyPages) Then
'                            .Selection.GoTo what:=wdGoToPage, which:=wdGoToNext, Count:=1
'                            .Selection.TypeParagraph
'                            .Selection.TypeParagraph
'                            .Selection.TypeParagraph
'                            .Selection.TypeParagraph
'                         Else
'                            Exit Do
'                         End If
'                      End If
'                      'end 2010/11/12
'                   End If
'                Loop
'                .Selection.EndKey Unit:=wdStory
'             End If
'         End If
'end 2015/8/12

      End If 'Add by Morgan 2011/6/1
     
      '是否存檔
      If m_bolSave2File = True And m_strFilePath <> "" Then
          .ActiveDocument.SaveAs m_strFilePath
      End If
      
      'Modified by Sindy 2022/3/30 bolSaveToCPP 是否要存至卷宗區
'                            strCPPFileKind 電子檔副檔名
      If bolSaveToCPP = True Then
         '若有同檔名暫存檔, 先刪除
         strExc(9) = App.path & "\$$temp_" & strLetterRecNo & ".pdf"
         If Dir(strExc(9)) <> "" Then
            Call PUB_DelPCOrgFile(strExc(9))
         End If
         
         strSql = "select * from caseprogress where cp09='" & strLetterRecNo & "'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strSql)
         Dim strCP01 As String, strCP02 As String, strCP03 As String, strCP04 As String, strCP10 As String
         If intI = 1 Then
            strCP01 = RsTemp.Fields("CP01")
            strCP02 = RsTemp.Fields("CP02")
            strCP03 = RsTemp.Fields("CP03")
            strCP04 = RsTemp.Fields("CP04")
            strCP10 = RsTemp.Fields("CP10")
            '用Word轉Pdf功能
            'Modified by Morgan 2022/11/14
            'frmPDF.Show
            Showfrmpic002 "PDF建立中...請稍候..."
            'end 2022/11/14
            .ActiveDocument.ExportAsFixedFormat OutputFileName:=strExc(9), ExportFormat:=17, OpenAfterExport:=False
            'Modified by Morgan 2022/11/14
            'Unload frmPDF '
            Unload frmpic002
            'end
            strExc(10) = Trim(strCP01) & Format(Val(strCP02), "000000") & _
                         IIf(Trim(strCP03) & Trim(strCP04) <> "" And Trim(strCP03) & Trim(strCP04) <> "000", "-" & strCP03, "") & _
                         IIf(Trim(strCP04) <> "" And Trim(strCP04) <> "00", "-" & Format(strCP04, "00"), "")
            '存檔
            If SaveAttFile_PDF(strLetterRecNo, strExc(9), strExc(10) & "." & strCP10 & "." & strCPPFileKind & ".PDF", CStr(strSrvDate(1)), Right("000000" & ServerTime, 6), False) = False Then
               GoTo ERRORSECTION2
            End If
            Call PUB_DelPCOrgFile(strExc(9)) '一併將PC上的實體檔案刪除
         End If
      End If
      '2022/3/30 END
      
      'Add by Morgan 2010/12/17 即時列印
      If bolPrintNow Then
         .PrintOut Background:=False, Copies:=1, Collate:=True
         .ActiveDocument.Close wdDoNotSaveChanges
         If bolUpdLD16 = True Then 'Added by Lydia 2020/12/08 即時列印是否更新LD16 ; ex.案件回覆單只產生Word檔，並不用更新。
            strSql = "Update LETTERDEMAND a Set LD16='*' " & _
               " WHERE LD01 = '" & strUserNum & "' and ld02=" & strSrvDate(1) & _
               " AND LD03=(select max(b.LD03) from LETTERDEMAND b where b.ld01=a.ld01 and b.ld02=a.ld02)"
            cnnConnection.Execute strSql
         End If 'Added by Lydia 2020/12/08
      End If
      'end 2008/3/20
   End With
   
   'Add by Morgan 2008/11/27
   '不使用就關閉不再隱藏
   If bolVisible = False Then
      g_WordAp.Quit wdDoNotSaveChanges
      Set g_WordAp = Nothing 'Added by Morgan 2017/11/6 Win7+Word2010 跑整批報表可能會觸發"字串空間不足"(14)錯誤, 判斷是 Word2010結束時間長Win7的電腦較快導致 TypeName(g_WordAp) 命令異常
   Else
      g_WordAp.Visible = True
   End If
   
   Exit Sub
   
ERRORSECTION1:
   
   Select Case Err.Number
      Case 91, 462:
         'Debug.Print "ERRORSECTION1:新增一個Word Application物件"
         Set g_WordAp = New Word.Application
         g_WordAp.Documents.add
         Resume Next
        'Add By Cheng 2002/12/20
        '新增LetterDemand若PK重覆時, 再執行一次
        Case -2147217873
            Resume
      Case Else:
         MsgBox "錯誤 : " & Err.Description, vbCritical
         Exit Sub
   End Select
   
ERRORSECTION2:
   
   Select Case Err.Number
      Case 91:
         'Debug.Print "ERRORSECTION2:新增一個Word 頁面"
         g_WordAp.Documents.add
         Resume Next
      Case 462:
         'Debug.Print "ERRORSECTION2:新增一個Word Application物件"
         Set g_WordAp = New Word.Application
         g_WordAp.Documents.add
         Resume Next
      Case Else:
         MsgBox "錯誤 : " & Err.Description, vbCritical
         Exit Sub
   End Select
End Sub

'Added by Morgan 2017/11/3
Public Sub PUB_WriteDebugLog(pText As String)
   If Not g_LetterDebug Then Exit Sub
   Dim ffa As Integer
   ffa = FreeFile
   Open App.path & "\" & App.EXEName & "_Debug.log" For Append As ffa
   Print #ffa, Trim(Now) & " >> " & m_MySt(1) & m_MySt(2) & m_MySt(3) & m_MySt(4) & " >> " & pText
   Close ffa
End Sub


' 提供給外部的介面
' Input : strReceiveNo ==> 總收文號
'         letterSitu ==> 定稿別
'         Situ ==> 處理狀況
'         WordSty ==> Microsoft Word 是否顯示畫面供使用者檢視修改
'         User ==> 使用者
'         strOther ==> 專利年費資料檔之年度(其他欄位)
'Add by Morgan 2004/9/21
'         strAddData ==> 外加定稿內容
'         bolExport ==> 是否只回傳定稿內容
'         strRtnData ==> 接收回傳定稿內容參數
'Add by Morgan 2004/10/5
'         iCopys ==> 指定份數
'Add by Morgan 2007/1/25
'         strCountry ==> 申請國家
'Add by Morgan 2008/3/14
'         bolHeader ==> 是否加信頭
'Add by Morgan 2008/3/20
'         bolSave2File ==> 是否存電子檔
'Add by Morgan 2011/2/11
'         iHeaderPageNum ==> 加信頭的頁數
'Add by Morgan 2014/4/1
'         bolEditKeepMark ==> 編輯時保留列印控制符號 "|\,\|,|*,*|,|@,@|
'Add by Morgan 2014/4/1
'         strLetterRecNo ==> 信函進度收文號
'Add By Sindy 2014/9/19
'         bolUseForHTML ==> 要使用於HTML
'Added by Morgan 2014/12/9
'         bolAlwaysShowSign ==> 一律顯示簽名檔
'Added by Morgan 2016/10/14
'         bolIsCopy ==> 正本或副本: false=正本, true=副本
'Add by Amy 2018/07/27
'         strFormName ==> 表單名稱 for 彩色代表圖使用
'Added by Morgan 2021/12/7
'         bolNoPrint ==> 不列印
Public Sub NowPrint(ByVal strReceiveNo As String, ByVal letterSitu As String, _
   ByVal Situ As String, ByVal bolWord As Boolean, ByVal User As String, Optional strOther As String = "0", _
   Optional ByVal strAddData As String, Optional ByVal bolExport As Boolean = False, _
   Optional ByRef strRtnData As String, Optional ByVal iCopys As Integer, Optional ByVal strCountry As String, _
   Optional ByVal bolHeader As Boolean, Optional ByVal bolSave2File As Boolean, _
   Optional ByVal bolSave2DB As Boolean = True, Optional ByVal bolPrintNow As Boolean = False, _
   Optional ByVal iHeaderPageNum As Integer, Optional bolEditKeepMark As Boolean = False, Optional strLetterRecNo As String, _
   Optional bolUseForHTML As Boolean = False, Optional bolAlwaysShowSign As Boolean = False, _
   Optional bolIsCopy As Boolean = False, Optional strFormName As String = "", Optional bolNoPrint As Boolean = False)
   
On Error GoTo ErrHand

   Dim nCount As Integer
   Dim strData As String
   Dim bolSave As Boolean
   Dim strCaseNo As String
   Dim stCP84 As String
   Dim bPaper As Boolean
   Dim strDataCC As String, str990CP09 As String 'Added by Morgan 2016/11/2
   Dim showColorFirst As Boolean 'Add by Amy 2018/07/27 是否先印彩色代表圖
   
   showColorFirst = True 'Added by Morgan 2021/7/1 showColorFirst 預設改 Ture(彩圖優先)--經理
   
   m_AutoStampNameInWord = "" 'Added by Morgan 2022/3/22
   m_strFilePath = "" 'Add By Sindy 2014/9/19 恢復預設值
   g_LD18 = strLetterRecNo 'Added by Morgan 2014/5/9
   m_bolECust = False 'Added by Morgan 2021/10/27
   m_bolXECust = False 'Added by Morgan 2025/11/11
   
   ' 90.08.22 modify by louis
   m_SplitPos = 0
   
   ' 90.07.27 modify by louis
   m_SrcKey = strReceiveNo
 
   m_Rule = strReceiveNo
   
   m_MySt(7) = strOther
   m_Preview = bolWord
   
   If Left(Situ, 1) < 3 Then
      m_FontSize = 14
   Else
      m_FontSize = 12
   End If
   'Check m_RefKind
   
   ' 若m_Rule內容中有'&'符號時則內容是本所案號及案件性質的結合
   ' 否則m_Rule放的是總收文號
   ' @大陸公報開拓函
   If m_Rule = "@" Then
      m_RefKind = 2
   ElseIf InStr(m_Rule, "&") = 0 Then
      m_RefKind = 0
   Else
      m_RefKind = 1
   End If
   
   ' m_Rule是總收文號, 由總收文號取得本所案號及案件性質
   If m_RefKind = 0 Then
      '取定稿別   letterSitu
      m_FinalSty = letterSitu
      '取使用者名稱
      m_User = User
      '處理狀況   Situ
      m_Situ = Situ
      
      '取案件性質 m_MySt(5)

      '取系統別   m_MySt(1)
      ' 由案件進度檔取得本所案號及案件性質
      strExc(0) = "SELECT CP01,CP02,CP03,CP04,CP10,CP13,CP14,CP29,CP84,CP27 FROM CASEPROGRESS WHERE CP09='" & m_Rule & "'"
      intI = 1
      'edit by nickc 2007/02/05 不用 dll 了
      'Set RsTemp = clslawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
      Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
      If intI = 1 Then
         For nCount = 1 To 5
            m_MySt(nCount) = UCase(RsTemp.Fields(nCount - 1).Value)
         Next
      Else
         MsgBox "無法由案件進度檔內取得資料 !", vbCritical
         Exit Sub
      End If
      
      '90.08.22 modify by louis
      m_CP09 = m_Rule
      m_CP01 = RsTemp.Fields("CP01")
      m_CP02 = RsTemp.Fields("CP02")
      m_CP03 = RsTemp.Fields("CP03")
      m_CP04 = RsTemp.Fields("CP04")
      m_CP10 = RsTemp.Fields("CP10")
      m_CP13 = "" & RsTemp.Fields("CP13") 'Add By Sindy 2011/6/28
      m_CP14 = "" & RsTemp.Fields("CP14") 'Add By Sindy 2011/6/28
      m_CP29 = "" & RsTemp.Fields("CP29") 'Add By Sindy 2011/7/18
      m_CP27 = "" & RsTemp.Fields("CP27") 'Add By Sindy 2018/4/23 發文日
      stCP84 = "" & RsTemp.Fields("CP84") 'Added by Morgan 2015/6/3
      ' 由系統種類對照檔取得系統別(名稱)
      strExc(0) = "SELECT SK02 FROM SYSTEMKIND WHERE SK01='" & m_MySt(1) & "'"
      intI = 1
      'edit by nickc 2007/02/05 不用 dll 了
      'Set RsTemp = clslawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
      Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
      If intI = 1 Then
         m_SysKind = RsTemp.Fields(0).Value
      Else
         MsgBox "無法由系統種類對照檔取得系統別 !", vbCritical
         Exit Sub
      End If
      
      'Add by Morgan 2008/3/13 檢查列印份數的例外狀況(申請書不必)
      'Modified by Lydia 2020/07/16 年證費請款函:Ｅ化和非Ｅ化皆產生電子檔(Typing2),紙本在原程式控制份數減一份
      'If Not (m_CP01 = "FCP" And m_FinalSty = "01") Then
      If Not (m_CP01 = "FCP" And (m_FinalSty = "01" Or m_FinalSty = "10")) Then
         'MODIFY BY SONIA 2014/4/24 把FCP證書函及公告函的控制移至PUB_GetCopySetting
         'PUB_GetCopySetting iCopys, m_CP01, m_CP02, m_CP03, m_CP04, m_CP10
         ''Add by Morgan 2010/7/14 FCP證書函及公告函至少要兩份 --林芳如,葉敏莉
         ''MODIFY BY SONIA 2014/4/24 FCP證書函傳真封面仍維持一份故加入m_Situ<>"98"
         'If m_CP01 = "FCP" And iCopys = 1 And (m_FinalSty = "07" Or m_FinalSty = "05") And m_Situ <> "98" Then
         '   iCopys = 2
         'End If
         PUB_GetCopySetting iCopys, m_CP01, m_CP02, m_CP03, m_CP04, m_CP10, m_FinalSty, m_Situ, strLetterRecNo
         '2014/4/24 END
      End If
      
      'Add by Morgan 2008/3/13 若有指定份數時不必檢查(避免無謂的抓資料動作)
      If iCopys > 0 Then
         m_Copys = iCopys
      Else
      'end 2008/3/13
      
         ' 由員工檔取得列印份數 (北部的員工印2份, 其它地區的員工印3份)
         'Modified by Morgan 2014/5/27 +特殊設定A7所有編號視為北所人員
         'strExc(0) = "SELECT ST06 FROM STAFF WHERE ST01='" & PUB_GetAKindSalesNo(m_CP01, m_CP02, m_CP03, m_CP04) & "' "
         strExc(0) = "SELECT DECODE(instr(';'||replace(oMan,',',';')||';',';'||ST01||';'),0,ST06,'1') FROM STAFF, SetSpecMan WHERE ST01='" & PUB_GetAKindSalesNo(m_CP01, m_CP02, m_CP03, m_CP04) & "' and ocode(+)='A7'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         m_Copys = 3
         If intI = 1 Then
            If RsTemp.Fields(0).Value = "1" Then
               m_Copys = 2
            Else
               m_Copys = 3
            End If
         End If
         'Added by Lydia 2020/08/21 年證費請款函:Ｅ化和非Ｅ化皆產生電子檔(Typing2),紙本預設份數1份
         If m_CP01 = "FCP" And m_FinalSty = "10" Then
             m_Copys = 1
         End If
         '''end 2020/08/21
      End If
      
      'Add By Sindy 2011/6/28 L,LA承辦人及智權人員所別不同時,份數+1
      If m_CP14 = "" Then m_CP14 = m_CP29 'Add By Sindy 2011/7/18
      If m_CP01 = "L" Or m_CP01 = "LA" Then
         '2011/7/6 MODIFY BY SONIA 加入承辦人若為北所則不加印
         If PUB_GetST06(m_CP13) <> PUB_GetST06(m_CP14) And PUB_GetST06(m_CP14) <> "1" Then
            m_Copys = m_Copys + 1
         End If
      End If
      
   ElseIf m_RefKind = 1 Then
      ' 90.07.23 modify by louis
      '取定稿別   letterSitu
      m_FinalSty = letterSitu
      '取使用者名稱
      m_User = User
      '處理狀況   Situ
      m_Situ = Situ
      
      ' m_Rule放的是本所案號及案件性質, 前12碼為本所案號, 後面為案件性質, 中間以'&'相隔
      m_MySt(5) = Mid(m_Rule, InStr(m_Rule, "&") + 1)
      ' 90.07.18 modify by louis
      'm_Rule = Left(m_Rule, Len(m_Rule) - InStr(m_Rule, "&") - 1)
      If InStr(m_Rule, "&") > 0 Then
         m_Rule = Left(m_Rule, InStr(m_Rule, "&") - 1)
      End If
      
      ChgCaseNo m_Rule, m_MySt
      
      '90.08.22 modify by louis
      m_CP09 = Empty
      m_CP01 = m_MySt(1)
      m_CP02 = m_MySt(2)
      m_CP03 = m_MySt(3)
      m_CP04 = m_MySt(4)
      m_CP10 = m_MySt(5)
      
      ' 由系統種類對照檔取得系統別(名稱)
      strExc(0) = "SELECT SK02 FROM SYSTEMKIND WHERE SK01='" & m_MySt(1) & "'"
      intI = 1
      Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
      If intI = 1 Then
         m_SysKind = RsTemp.Fields(0).Value
      Else
         MsgBox "無法由系統種類對照檔取得系統別 !", vbCritical
         Exit Sub
      End If
      
      'MODIFY BY SONIA 2014/4/24 把FCP證書函及公告函的控制移至PUB_GetCopySetting
      ''Add by Morgan 2008/3/13 檢查列印份數的例外狀況
      'PUB_GetCopySetting iCopys, m_CP01, m_CP02, m_CP03, m_CP04, m_CP10
      ''Add by Morgan 2010/7/14 FCP證書函及公告函至少要兩份 --林芳如,葉敏莉
      ''MODIFY BY SONIA 2014/4/24 FCP證書函傳真封面仍維持一份故加入m_Situ<>"98"
      'If m_CP01 = "FCP" And iCopys = 1 And (m_FinalSty = "07" Or m_FinalSty = "05") And m_Situ <> "98" Then
      '   iCopys = 2
      'End If
      PUB_GetCopySetting iCopys, m_CP01, m_CP02, m_CP03, m_CP04, m_CP10, m_FinalSty, m_Situ, strLetterRecNo
      '2014/4/24 END
         
      'Add by Morgan 2007/1/25 若有指定份數時不必檢查(避免無謂的抓資料動作)
      If iCopys > 0 Then
         m_Copys = iCopys
      Else
      'end 2007/1/25
         
         ' 由員工檔取得列印份數 (北部的員工印2份, 其它地區的員工印3份)
         'Modified by Morgan 2014/5/27 +特殊設定A7所有編號視為北所人員
         'strExc(0) = "SELECT ST06 FROM STAFF WHERE ST01='" & PUB_GetAKindSalesNo(m_CP01, m_CP02, m_CP03, m_CP04) & "'"
         strExc(0) = "SELECT DECODE(instr(';'||replace(oMan,',',';')||';',';'||ST01||';'),0,ST06,'1') FROM STAFF, SetSpecMan WHERE ST01='" & PUB_GetAKindSalesNo(m_CP01, m_CP02, m_CP03, m_CP04) & "' and ocode(+)='A7'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         m_Copys = 3
         If intI = 1 Then
            If RsTemp.Fields(0).Value = "1" Then
               m_Copys = 2
            Else
               m_Copys = 3
            End If
         End If
         
      End If
   ElseIf m_RefKind = 2 Then
      '@大陸公報開拓函
      m_MySt(1) = "P"
      m_MySt(5) = "000"
      '取定稿別   letterSitu
      m_FinalSty = letterSitu
      '取使用者名稱
      m_User = User
      '處理狀況   Situ
      m_Situ = Situ
      m_Copys = 1
      
      '90.08.22 modify by louis
      m_CP09 = Empty
      m_CP01 = Empty
      m_CP02 = Empty
      m_CP03 = Empty
      m_CP04 = Empty
      m_CP10 = m_MySt(5)
   End If
   
   'Add by Morgan 2008/3/20
   m_bolSave2File = bolSave2File 'Add by Morgan 2008/3/20
   If m_bolSave2File = True Then
      strCaseNo = m_MySt(1) & m_MySt(2) & IIf(m_MySt(3) & m_MySt(4) <> "000", m_MySt(3) & m_MySt(4), "")
      'Add By Sindy 2014/9/26
      If bolUseForHTML = True Then
         m_strFilePath = App.path & "\$$" & strCaseNo & "_" & ServerTime & ".doc"
         If Dir(m_strFilePath) <> "" Then
            Kill m_strFilePath
         End If
      Else
      '2014/9/26 END
         'Add By Sindy 2012/1/11 內商的word電子檔要放在個人的桌面資料夾中
         If m_MySt(1) = "T" Or m_MySt(1) = "TF" Then
            m_strFilePath = PUB_GetEFilePath(m_MySt(1))
            If Dir(m_strFilePath, vbDirectory) = "" Then
               MkDir m_strFilePath
            End If
         End If
         '2012/1/11 End
         'Modify by Morgan 2011/1/6 上層再加子目錄=系統別+本所號前2碼
         'm_strFilePath = PUB_GetEFilePath(m_MySt(1)) & "\" & strCaseNo
         'Modified by Morgan 2012/4/5 改為 上層目錄=系統別\本所號前3碼\
         'm_strFilePath = PUB_GetEFilePath(m_MySt(1)) & "\" & m_MySt(1) & Left(m_MySt(2), 2)
         m_strFilePath = PUB_GetEFilePath(m_MySt(1)) & "\" & m_MySt(1)
         If Dir(m_strFilePath, vbDirectory) = "" Then
            MkDir m_strFilePath
         End If
         
         'Added by Morgan 2012/4/5
         m_strFilePath = m_strFilePath & "\" & Left(m_MySt(2), 3)
         If Dir(m_strFilePath, vbDirectory) = "" Then
            MkDir m_strFilePath
         End If
         'end 2012/4/5
         
         m_strFilePath = m_strFilePath & "\" & strCaseNo
         'end 2011/1/6
         If Dir(m_strFilePath, vbDirectory) = "" Then
            MkDir m_strFilePath
         End If
         'Modified by Morgan 2020/11/19
         'm_strFilePath = m_strFilePath & "\" & strCaseNo & "_" & strSrvDate(1) & ".doc"
         If m_DocSNo <> "" Then
            m_strFilePath = m_strFilePath & "\" & m_DocSNo & "_" & strCaseNo & "_" & strSrvDate(1) & ".doc"
         Else
            m_strFilePath = m_strFilePath & "\" & strCaseNo & "_" & strSrvDate(1) & ".doc"
         End If
         'end 2020/11/19
      End If
   Else
      m_strFilePath = ""
   End If

   SetLetterSt
   
   '列印份數
   'Modify by Morgan 2004/10/5
   If iCopys > 0 Then
      m_Copys = iCopys
   Else
   '2004/10/5 end
      
      Select Case m_MySt(1)
         Case "P"
            '91.7.12 modify by sonia
            'If m_FinalSty = "01" Then m_Copys = 2
           '定稿別
            Select Case m_FinalSty
               Case "01" '各式申請書
                  'Modify by Morgan 2010/2/4 P申請書除技術報告外不分案件性質份數統一 --玲玲
                  'Modified by Morgan 2013/1/28 +807 --敏惠 P-104393
                  'Modify by Amy 2014/09/16 +601 605 定稿上線
                  If m_MySt(5) = "421" Or m_MySt(5) = "807" Or m_MySt(5) = "601" Or m_MySt(5) = "605" Then
                     m_Copys = 2
                  Else
                     ''Modify by Morgan 2004/9/29
                     ''加延緩公告 412
                     'If m_MySt(5) = "601" Or m_MySt(5) = "605" Or m_MySt(5) = "602" Or m_MySt(5) = "603" Or m_MySt(5) = "919" Or m_MySt(5) = "412" Then
                         m_Copys = 4
                          'Add By Cheng 2002/12/10
                          ' 由員工檔取得列印份數 (北部的員工印3份, 其它地區的員工印4份)
                          'Modify By Cheng 2003/07/03
      '                    strExc(0) = "SELECT ST06,MAX(CP05) FROM CASEPROGRESS,STAFF WHERE CP01='" & m_MySt(1) & "' AND CP02='" & m_MySt(2) & "' AND CP03='" & m_MySt(3) & "' AND CP04='" & m_MySt(4) & "' AND CP13=ST01 GROUP BY ST06"
                          'Modified by Morgan 2014/5/27 +特殊設定A7所有編號視為北所人員
                          'strExc(0) = "SELECT ST06 FROM STAFF WHERE ST01='" & PUB_GetAKindSalesNo(m_CP01, m_CP02, m_CP03, m_CP04) & "' "
                          strExc(0) = "SELECT DECODE(instr(';'||replace(oMan,',',';')||';',';'||ST01||';'),0,ST06,'1') FROM STAFF, SetSpecMan WHERE ST01='" & PUB_GetAKindSalesNo(m_CP01, m_CP02, m_CP03, m_CP04) & "' and ocode(+)='A7'"
                          intI = 1
                          Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
                          If intI = 1 Then
                             '北所
                             If RsTemp.Fields(0).Value = "1" Then
                                m_Copys = 3
                             '其他地區
                             Else
                                m_Copys = 4
                             End If
                          End If
                          
                     '     'Modify by Morgan 2004/9/29
                     '     '加延緩公告 412
                     '     If m_MySt(5) = "919" Or m_MySt(5) = "412" Then m_Copys = m_Copys - 1
                     'Else
                     '   m_Copys = 2
                     '   '2009/4/9 ADD BY SONIA 其他-更正已繳年度,配合發文室多印1份
                     '   If m_MySt(5) = "910" And m_Situ = "09" Then
                     '      m_Copys = m_Copys + 1
                     '   End If
                     '   '2009/4/9 END
                     'End If
                     'end 2010/2/4
                  End If
                  
               '2009/4/9 ADD BY SONIA 催審配合發文室多印1份
               Case "16"
                  m_Copys = m_Copys + 1
               '2009/4/9 END
               '92.3.14 add BY SONIA
               Case "19"
                  m_Copys = 1
               '92.1.11 END
            End Select
            '91.7.12 end
            
'Removed by Morgan 2014/9/17 移到下面改判斷列印方式為大陸指示信,否則新增30以後的定稿時份數會錯
'            '92.1.11 ADD BY SONIA 大陸指示信(處理狀況>='30'), 一律印 2份
'            'Modify by Morgan 2004/7/6
'            '加判斷定稿別
'            If m_Situ > "3" And InStr("01,02,14,15,16", letterSitu) > 0 Then
'               m_Copys = 2
'            End If
'            '92.1.11 END
'end 2014/9/17

         Case "FCP"
            If m_FinalSty = "01" Then
               Select Case m_MySt(5)
                  Case "401", "405", "406", "407", "409", "411", "412", "414", "415", "417", "602", "603", "604", "705", "707"
                     m_Copys = 4
                  Case "413"
                     m_Copys = 3
                  '92.4.10 ADD BY SONIA
                  Case "404"
                     If m_Situ = "02" Then
                        m_Copys = 3
                     Else
                        m_Copys = 2
                     End If
                  '92.4.10 END
                  Case Else
                     m_Copys = 2
               End Select
               
            ElseIf m_FinalSty = "11" Then
               m_Copys = 2

            End If
         '91.7.14 modify by sonia
         Case "CFP"
            'Modify by Morgan 2004/1/9
            '加判斷一般來函輸入,代理人通知修正,代理人其他來函的案件回覆單也固定只印1份
            'If m_FinalSty = "09" Or m_FinalSty = "14" Then m_Copys = 1
            If m_FinalSty = "09" Or m_FinalSty = "14" Or (letterSitu = "03" And Situ = "12") Or (letterSitu = "07" And Situ = "00") Or (letterSitu = "06" And Situ = "01") Then m_Copys = 1
            
         '91.7.14 end
         Case "T"
            If m_FinalSty = "10" Then m_Copys = 1
            'Add By Sindy 2009/08/06
            If m_FinalSty = "04" And m_Situ = "00" Then m_Copys = 1
            '2009/08/06 End
         Case "FCT"
            If m_FinalSty = "10" Then m_Copys = 2
           'Add By Cheng 2003/04/14
           '催延展多件
            If m_FinalSty = "10" And m_Situ = "03" Then m_Copys = 1
            'edit by nick 2004/08/04 加入當 FCT 03 101 06和 07狀況時，只印一份
            'Modify By Sindy 2012/7/13
            'If m_FinalSty = "03" And m_CP10 = "101" And (m_Situ = "06" Or m_Situ = "07") Then m_Copys = 1
            'Modify By Sindy 2017/6/12 阿蓮說取消固定份數
            'If m_FinalSty = "03" And m_CP10 = "101" And (m_Situ = "06" Or m_Situ = "07" Or m_Situ = "17" Or m_Situ = "15") Then m_Copys = 1
            '2017/6/12 END
            '2012/7/13 End
            'add by nick 2004/12/16
            'Modify By Sindy 2009/08/06
            'If m_FinalSty = "90" Then m_Copys = 4
            If m_FinalSty = "90" Then m_Copys = 3
      End Select
   
   End If 'Add by Morgan 2004/10/5
   
   ' m_MySt(6)放的是國家
   
   'Add by Morgan 2007/1/25
   If strCountry <> "" Then
      m_MySt(6) = strCountry
   Else
   'end 2007/1/25
   
      '由本所案號取國家代號 m_MySt(6)，分專利、商標、顧問
      strExc(0) = "" 'Add By Sindy 2011/6/28
      Select Case m_SysKind
         Case "1"
            strExc(0) = "SELECT PA09 FROM PATENT WHERE " & PaSt
         Case "2"
            strExc(0) = "SELECT TM10 FROM TRADEMARK WHERE " & TmSt
         'Remove by Morgan 2003/12/30
   '      Case "4"
   '         strExc(0) = "SELECT SP09 FROM SERVICEPRACTICE WHERE " & SpSt
         Case "5", "6"
            strExc(0) = "SELECT SP09 FROM SERVICEPRACTICE WHERE " & SpSt
      End Select
      
      If strExc(0) <> "" Then
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then m_MySt(6) = RsTemp.Fields(0).Value
      Else
         m_MySt(6) = "000" 'Modify By Sindy 2011/6/28
      End If
   End If
   
      
   '由定稿對照檔取得定稿內容
   'Modify by Morgan 2010/11/12 定稿內容+FTM08
   'Modified by Morgan 2021/3/11 +FTM06
   strExc(0) = "SELECT FTM05,FTM07,FTM08,FTM06 FROM FINALTEXTMAP WHERE FTM01='" & m_MySt(1) & _
      "' AND FTM02='" & m_FinalSty & "' AND FTM03='" & m_MySt(5) & "' AND " & _
      "FTM04='" & m_Situ & "'"
   intI = 1
   Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
   ' 當無資料時則以案件性質為"000"再取一次定稿內容 (預設共用)
   If intI <> 1 Then
      'Modify by Morgan 2010/11/12 定稿內容+FTM08
      'Modified by Morgan 2021/3/11 +FTM06
      strExc(0) = "SELECT FTM05,FTM07,FTM08,FTM06 FROM FINALTEXTMAP WHERE FTM01='" & m_MySt(1) & _
         "' AND FTM02='" & m_FinalSty & "' AND FTM03='000' AND " & _
         "FTM04='" & m_Situ & "'"
         
      'Add by Morgan 2007/1/25
      intI = 1
      Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
      'end 2007/1/25
   End If
      
   ' 轉換文件內容並傳送給Microsoft Word 程式
   If intI = 1 Then
      'Added by Morgan 2014/9/17
      'P案大陸指示信固定2份(從上面程式移下來)
      If m_MySt(1) = "P" And RsTemp("ftm07") = "5" Then
         'Modified by Lydia 2016/03/04 e化後,若未指定份則大陸指示信只需1份
         'm_Copys = 2
        If iCopys = 0 Then
           m_Copys = 1
        End If
        'end 2016/03/04
        'Added by Lydia 2015/07/13 寰華案-實體審查416發文(台->大)指示信,現在email給客戶,印1份留底
        If m_MySt(5) = 實體審查 And PUB_FMPtoCheck(1, 2, "", m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4)) = True Then
           m_Copys = 1
        End If
        'end 2015/07/13
      End If
      'end 2014/9/17
      
      'Add by Amy 2014/08/27 P台灣案申請書份數設為1份 for 電子化
      If P台灣案電子化啟用日 <= Val(strSrvDate(1)) Then
           If m_MySt(1) = "P" And m_MySt(6) = 台灣國家代號 And m_FinalSty = "01" Then
               'Modified by Morgan 2015/6/3 沒有發文規費的要印2份(回執) --玲玲
               'm_Copys = 1
               If iCopys = 0 Then
                  If Val(stCP84) = 0 Then
                     m_Copys = 2
                  Else
                     m_Copys = 1
                  End If
               End If
               'end 2015/6/3
           End If
      End If
      'end 2014/08/27
      
      'Modify By Cheng 2002/12/27
'      strData = rsTemp.Fields(0)

      'Modify by Morgan 2006/10/19 解析組合式定稿
      'strData = "" & rsTemp.Fields(0)
      'Modify by Morgan 2010/11/12 定稿內容+FTM08
      'strData = PreParse("" & RsTemp.Fields(0))
      strData = PreParse("" & RsTemp.Fields(0) & RsTemp.Fields(2))
      'End 2006/10/19
      strPrintType = Val("" & RsTemp.Fields("FTM07").Value) + 1
            
'Removed by Morgan 2024/4/10 對外統一用 Dear Colleagues(直接改定稿範本) --林總
'      'Added by Morgan 2024/3/15
'      If m_MySt(1) = "FCP" Or m_MySt(1) = "P" Then
'         If InStr(strData, "Dear Sirs,") > 0 Then
'            If PUB_GetReceiver(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), m_CP10, m_SysKind) = "Y22327000" Then
'               strData = Replace(strData, "Dear Sirs,", "Dear Colleagues,")
'            End If
'         End If
'      End If
'      'end 2024/3/15
'end 2024/4/10
      
      'Added by Morgan 2021/3/19
      m_LD27 = ""
      If InStr("" & RsTemp("ftm06"), "通知函") > 0 Then
         m_LD27 = "CUS"
      End If
      'end 2021/3/19
      
      'Added by Morgan 2021/3/11
      '檢查是否為寶齡富錦 Y55435 案件客戶函
      bNoPrint = False
      If bolExport = False And (m_MySt(1) = "P" Or m_MySt(1) = "CFP") Then
         'Added by Morgan 2021/3/29 變更核准需人工修改內容
         If InStr("" & RsTemp("ftm06"), "Y55435改") > 0 Then
            m_LD27 = "CUS"
            '控制不列印
            bNoPrint = True
            '控制不轉pdf
            If strLetterRecNo <> "" Then
               strSql = "update letterprogress set lp08='寶齡富錦案件',lp09=" & strSrvDate(1) & " where lp01='" & strLetterRecNo & "' and lp09=0"
               cnnConnection.Execute strSql, intI
            End If
            
            If bolWord = False Then
               MsgBox m_MySt(1) & "-" & m_MySt(2) & "為寶齡富錦案且定稿內容需人工調整，請自行至定稿維護修改內容後上傳(列印)！", vbExclamation
            Else
               MsgBox m_MySt(1) & "-" & m_MySt(2) & "為寶齡富錦案且定稿內容需人工調整！", vbExclamation
            End If
         'end 2021/3/29
         
         'Modified by Morgan 2025/1/16 中文客戶函改用函數判斷(要排除非申請人的通知信)
         'ElseIf RsTemp("ftm07") = "0" And InStr(strData, "致：") > 0 And InStr("" & RsTemp("ftm06"), "Y55435") = 0 Then
         ElseIf RsTemp("ftm07") = "0" And IsAppChLetter(strData) = True And InStr("" & RsTemp("ftm06"), "Y55435") = 0 Then
         '2025/1/16
            'Modified by Morgan 2025/7/24
            strExc(0) = "select 1 from patent where pa01='" & m_MySt(1) & "' and pa02='" & m_MySt(2) & "' and pa03='" & m_MySt(3) & "' and pa04='" & m_MySt(4) & "' and pa75='Y55435000'"
            intI = 1
            Call ClsLawReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               m_LD27 = "CUS"
               '控制不列印
               'Modified by Morgan 2025/7/24 改判斷發文室已發文
               'bNoPrint = True
               strExc(0) = "select 1 from letterprogress where lp01='" & strLetterRecNo & "' and lp15='Y'"
               intI = 1
               Call ClsLawReadRstMsg(intI, strExc(0))
               If intI = 1 Then
                  bNoPrint = True
               End If
               'end 2025/7/24
               
               'Added by Morgan 2021/3/25 非台灣案之發文或催期限,仍出原來的中文定稿
               'Modified by Morgan 2021/3/26 收件人改寶齡富錦
               'Modified by Morgan 2022/9/29 台灣領證年費發文也用中文定稿
               If g_LD18 > "D" Or (m_MySt(6) <> "000" And g_LD18 < "C") Or (m_MySt(6) = "000" And m_FinalSty = "02" And (m_MySt(5) = "601" Or m_MySt(5) = "605")) Then
                  strData = Replace(strData, "<中申開窗地址>", "<中代開窗地址>")
                  'Added by Morgan 2022/9/29
                  strData = Replace(strData, "<指定信箱>", "<電子信箱>")
                  strData = Replace(strData, "<中申開窗郵號>", String(17, "　"))
                  'end 2022/9/29
               Else
               'end 2021/3/25
               
                  '控制不轉pdf
                  If strLetterRecNo <> "" Then
                     strSql = "update letterprogress set lp08='寶齡富錦案件',lp09=" & strSrvDate(1) & " where lp01='" & strLetterRecNo & "' and lp09=0"
                     cnnConnection.Execute strSql, intI
                  End If
                  If bolWord = False Then
                     MsgBox m_MySt(1) & "-" & m_MySt(2) & "為寶齡富錦案且尚無定稿，請自行至定稿維護修改內容後上傳(列印)！", vbExclamation
                  Else
                     MsgBox m_MySt(1) & "-" & m_MySt(2) & "為寶齡富錦案且尚無定稿，將使用通用之模版！", vbExclamation
                     'Added by Morgan 2021/3/18 證書
                     If (m_MySt(1) = "P" And m_FinalSty = "08") Or (m_MySt(1) = "CFP" And m_FinalSty = "05") Then
                        strExc(0) = "SELECT FTM05,FTM07,FTM08,FTM06 FROM FINALTEXTMAP WHERE FTM01='P' and FTM02='90' and FTM03='000' and FTM04='02'"
                     Else
                     'end 2021/3/18
                        strExc(0) = "SELECT FTM05,FTM07,FTM08,FTM06 FROM FINALTEXTMAP WHERE FTM01='P' and FTM02='90' and FTM03='000' and FTM04='01'"
                     End If
                     intI = 1
                     Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
                     If intI = 1 Then
                        strExc(0) = RsTemp.Fields("FTM05") & RsTemp.Fields("FTM08")
                        intI = InStr(strData, "致：")
                        strData = Replace(strExc(0), "<原定稿內容>", Mid(strData, intI))
                        strPrintType = Val("" & RsTemp.Fields("FTM07").Value) + 1
                     End If
                  End If
               End If
            End If
         End If
      End If
      'end 2021/3/11
      
      If bNoPrint = False Then bNoPrint = bolNoPrint 'Added by Morgan 2021/12/7
      
      'Add By Sindy 2019/12/18 T電子化上線後,取消
      If strSrvDate(1) < T商標電子化第2階段啟用日 Then
      '2019/12/18 END
         'Add By Sindy 2016/6/3 巨京定稿,只有第三張需要印程序名字
         If m_CP13 = "96029" Or m_CP13 = "96030" Then
            If InStr(strData, "|\<程序部門>　<程序人員>\|") > 0 Then
               strData = Replace(strData, "|\<程序部門>　<程序人員>\|", "|$<程序部門>　<程序人員>$|")
            End If
         End If
         '2016/6/3 END
      End If
      
      'Added by Morgan 2016/11/2 新增同時要存副本,編輯則只帶出正本或副本
      '新增
      m_LP33 = "": m_LP34 = ""
      If bolSave2DB Then
         '客戶函
         'Modifie by Morgan 2018/11/5 排除收受人非申請的通知函
         'Modified by Morgan 2025/1/16 改用函數
         'If InStr(strData, "<中申開窗") > 0 And InStr(strData, "致：") > 0 _
            And InStr(strData, "<中申開窗郵號/被授權>") = 0 _
            And InStr(strData, "<中申開窗郵號/相關被授權>") = 0 _
            And InStr(strData, "<中申開窗郵號/移轉人>") = 0 _
            And InStr(strData, "<中申開窗郵號/移轉>") = 0 Then
         If IsAppChLetter(strData) = True Then
         'end 2025/1/16
            If PUB_GetCC(m_CP01, m_CP02, m_CP03, m_CP04, m_LP33, m_LP34) = True Then
               If ChkIsEngLetter(strLetterRecNo) = False Then 'Added by Morgan 2024/6/14
                  If PUB_Add990CP(m_CP01, m_CP02, m_CP03, m_CP04, strLetterRecNo, str990CP09, m_LP33, m_LP34) = True Then
                     strDataCC = ChgCCContent(strData)
                     g_LD18 = str990CP09
                     strDataCC = Parser(strDataCC)
                     g_LD18 = strLetterRecNo
                  End If
               End If
            End If
         End If
      '修改
      ElseIf bolIsCopy Then
         strData = ChgCCContent(strData)
      End If
      strData = Replace(strData, "|&", "")
      strData = Replace(strData, "&|", "")
      'end 2016/11/2
      
      strData = Parser(strData)

      'Modify by Morgan 2004/9/21
      'ExportToMsWord strData
      If strAddData <> "" Then
         'Added by Morgan 2018/8/20 CFP電子化還是要存(子案或判發退回要維護定稿用)
         If m_MySt(1) = "CFP" And strLetterRecNo <> "" And bolSave2DB = True Then
            SaveToDB strData, m_Preview, strLetterRecNo, strDataCC, str990CP09
         End If
         'end 2018/8/20
         'Modified by Morgan 2020/7/17 跳頁前先跳行否則若後面定稿第一列的格式會影響到前面定稿的最後一列(Ex:置中)
         'strData = strAddData & Chr(12) & strData
         strData = strAddData & vbCrLf & Chr(12) & strData
         'end 2020/7/17
         bolSave = False '有附加資料時不存檔(因不止一份定稿內容會無法編輯)
      Else
         'Modify by Morgan 2008/8/27
         'bolSave = True
         bolSave = bolSave2DB
         'end 2008/8/27
      End If
      
      'Add by Amy 2018/07/27 +showColorFirst
      'Modify by Amy 2018/09/14 +CFT定稿別15(指示信)
      If (UCase(strFormName) = "FRM030001_1" And strPrintType = 4) Or (UCase(strFormName) = "FRM1105" And m_MySt(1) = "FCT") _
        Or (m_MySt(1) = "CFT" And letterSitu = "15") Then
            showColorFirst = True
      End If
      'end 2018/07/27
      If bolExport = True Then
         strRtnData = strData
         
         'Add by Morgan 2010/12/17
         If bolPrintNow Then
            'Modify By Sindy 2014/9/19 +bolUseForHTML
            'Modify by Amy 2018/07/27 +showColorFirst
            'Modified by Morgan 2023/4/21 +bolIsCombined
            ExportToMsWord strData, bolHeader, bolSave, bolPrintNow, iHeaderPageNum, , , strLetterRecNo, bolUseForHTML, bolAlwaysShowSign, strDataCC, showColorFirst, str990CP09, , , , IIf(strAddData <> "", True, False)
         'Added by Morgan 2018/8/20 CFP電子化還是要存(子案或判發退回要維護定稿用)
         'Modified by Lydia 2024/03/01 ACS案不列印直接上傳PDF到卷宗區
         'ElseIf m_MySt(1) = "CFP" And strLetterRecNo <> "" And bolSave2DB = True Then
         ElseIf (m_MySt(1) = "CFP" And strLetterRecNo <> "" And bolSave2DB = True) Or (m_MySt(1) = "ACS" And bolSave2DB = True) Then
            SaveToDB strData, m_Preview, strLetterRecNo, strDataCC, str990CP09
         'end 2018/8/20
         End If
      'Modify by Morgan 2006/3/16
      '加判斷有資料才做
      ElseIf strData <> "" Then
         'Modify By Sindy 2014/9/19 +bolUseForHTML
         'Modify by Amy 2018/07/27 +showColorFirst
         'Modified by Morgan 2023/4/21 +bolIsCombined
         ExportToMsWord strData, bolHeader, bolSave, bolPrintNow, iHeaderPageNum, , bolEditKeepMark, strLetterRecNo, bolUseForHTML, bolAlwaysShowSign, strDataCC, showColorFirst, str990CP09, , , , IIf(strAddData <> "", True, False)
      End If
      '2004/9/21 end
   End If
            
    'Added by Lydia 2017/07/21 CFT指示信倘為彩色，請不要帶出商標圖並彈訊息，以提醒承辦人另貼商標圖
   If m_MySt(1) & m_FinalSty = "CFT15" Then
      'Modify by Amy 2018/07/25 改function
      'If GetImgByteFile(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), , , , , "2", True) Then
      If ChkImgByteFile(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), , True) = True Then
        MsgBox "商標圖為彩色，請另貼商標圖!", vbCritical
      End If
   End If
    'end 2017/07/21
    
   Exit Sub
ErrHand:
   
   'Add by Morgan 2008/6/19 加判斷主機是否已開
   If Err.Number = 52 Then
      If MsgBox("無法讀取電子檔存放路徑【" & m_strFilePath & "】，請檢查該電腦是否已開機！" & vbCrLf & vbCrLf & "PS.若按取消將存放於桌面!!", vbRetryCancel + vbDefaultButton1, "電子檔問題") = vbCancel Then
         m_strFilePath = PUB_Getdesktop & "\" & strCaseNo
         Resume Next
      Else
         Resume
      End If
   End If
   'end 2008/6/19
      
   MsgBox "錯誤 : " & Err.Description, vbCritical
   On Error GoTo 0
End Sub

Public Function ChkLetterDate(ByVal strTmp As String) As Boolean
   ChkLetterDate = True
   If strTmp <> "" Then
      If Not ChkDate(strTmp) Then
         MsgBox "申請書日期不正確，請重新輸入 !", vbCritical
         ChkLetterDate = False
      Else
         If Val(strTmp) < Val(strSrvDate(2)) Then
            MsgBox "申請書日期不可小於系統日，請重新輸入 !", vbCritical
            ChkLetterDate = False
         End If
      End If
   Else
      MsgBox "申請書日期不可空白 !", vbCritical
      ChkLetterDate = False
   End If
End Function

' 取得例外條件的欄位內容
'Modify By Sindy 2015/1/8 加Optional strCP10 As String = ""
Public Function ExceptFieldData(ByVal strField As String, Optional strCP10 As String = "") As String
Dim strTmp As String, i As Integer, iTmp As String
'Add By Cheng 2003/01/27
Dim strSql As String
Dim rsTmp As ADODB.Recordset
Dim strPA08 As String
Dim strPA09 As String
Dim strPA72 As String
Dim strKey(5) As String
Dim strCaseFee(1 To 2) As String
Dim bFind As Boolean
Dim varPA72 As Variant
Dim varRef As Variant
Dim nPos As Integer
Dim ii As Integer
'Add By Cheng 2003/01/19
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset
'Add By Cheng 2003/01/22
Dim StrSqlB As String
Dim rsB As New ADODB.Recordset
Dim strNP09 As String '法定期限
Dim strNextPayDay  As String '預計以後繳年費日
Dim dblYearDiff As Double
Dim arrTM09 '商品類別陣列
Dim blnTMMerch As Boolean '商品類別屬商品
Dim blnTMSrv As Boolean '商品類別屬服務
'add by nickc 2008/02/27
Dim m_line As Variant
Dim strEmail As String 'Add By Sindy 2016/12/2
   
   If strCP10 <> "" Then m_CP10 = strCP10 'Add By Sindy 2015/1/8 ex.如撰寫信函中有共用信函抬頭/英
   ExceptFieldData = ""
   
   'ADD BY SONIA 2014/4/30 從最後面移上來,當變數名稱相同時,先讀EXCEPTCONDITION,若無資料才抓程式定義的值
   strExc(0) = "SELECT ET06 FROM EXCEPTCONDITION WHERE ET01='" & m_FinalSty & _
      "' AND ET02='" & m_SrcKey & "' AND ET03='" & m_Situ & "' " & _
      "AND ET04='" & m_User & "' AND ET05='" & strField & "'"
   intI = 1
   Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
   If intI = 1 Then
      If IsNull(RsTemp.Fields(0).Value) = False Then ExceptFieldData = RsTemp.Fields(0).Value
      
      'Added by Morgan 2017/3/9
      '跟秀玲討論後改只要有抓到EXCEPTCONDITION,記錄不論是否為空值都應該略過，否則無法刻意將例外欄位設定成Null。Ex:FCP核准函的<寄紙本才印>
      Exit Function
      'end 2017/3/9
   End If
   If ExceptFieldData <> "" Then Exit Function
   '2014/4/30 END
   
   Select Case strField
      'Add by Sindy 2015/7/6
      Case "confirmation"
         'Add By Sindy 2016/12/2
         strEmail = ""
         strExc(0) = "select GetEmailFlag(pa01||pa02||pa03||pa04) eMail from patent where PA01='" & m_MySt(1) & "' and PA02='" & m_MySt(2) & "' and PA03='" & m_MySt(3) & "' and PA04='" & m_MySt(4) & "'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            strEmail = "" & RsTemp.Fields(0)
         End If
         '2016/12/2 END
         
         'Add by Sindy 2015/7/24
         'If m_FinalSty = "10" Then '10.年證費請款函
         'If m_FinalSty <> "07" Then '07.證書函 靜芳說不用蓋confirmation章,因已全部改紙本寄出
         'Modify By Sindy 2016/12/01 陳亭妙:原設定為：當條件為Y4514900 + X4514900 證書信定稿帶出【秘/CONFIDENTIAL】字樣。
         '                                  修改設定條件為：凡只要申請人是 X4514900 NIKON CORPORATION時，證書信定稿即帶出【秘/CONFIDENTIAL】字樣。
         If m_FinalSty = "07" Then '07.證書函
            '申請人=X45149000(尼康)
            strExc(0) = "SELECT pa01 FROM PATENT WHERE pa01='" & m_MySt(1) & "' and pa02='" & m_MySt(2) & "' and pa03='" & m_MySt(3) & "' and pa04='" & m_MySt(4) & "'" & _
                          " AND (pa26='X45149000' or pa27='X45149000' or pa28='X45149000' or pa29='X45149000' or pa30='X45149000')"
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               If Not (strUserLevel = "發FC郵件" Or m_FinalSty = "10") Then
                  ExceptFieldData = "|\　　　　|#(confirmation自動簽名檔)#| \|　　　　|#(秘/Confidential自動簽名檔)#|"
               Else
                  ExceptFieldData = "　　　　　　　　|#(秘/Confidential自動簽名檔)#|"
               End If
            Else
               If Not (strUserLevel = "發FC郵件" Or m_FinalSty = "10") Then
                  ExceptFieldData = "|\　　　　　　　　|#(confirmation自動簽名檔)#| \|"
               End If
            End If
         Else
         '2016/12/01 END
'            '申請人=X45149000(尼康)
'            strExc(0) = "SELECT pa01 FROM PATENT WHERE pa01='" & m_MySt(1) & "' and pa02='" & m_MySt(2) & "' and pa03='" & m_MySt(3) & "' and pa04='" & m_MySt(4) & "'" & _
'                          " AND (pa26='X45149000' or pa27='X45149000' or pa28='X45149000' or pa29='X45149000' or pa30='X45149000')"
'            intI = 1
'            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
'            If intI = 1 Then
'               '代理人
'               strExc(1) = PUB_GetReceiver(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), m_CP10, m_SysKind)
'               If strExc(1) = "Y45149000" Then 'Nikon
'                  ExceptFieldData = "　　　　　　　　|#(秘/Confidential自動簽名檔)#|"
'               End If
'            End If
         'Else
         '2015/7/24 END
            'Add By Sindy 2015/7/9 第二份(含)之後才要印confirmation的章
            'If strUserLevel <> "發FC郵件" Then
            'Modify by Sindy 2015/11/10 江如玉:年證費請款函 不顯示 confirmation章
            'ElseIf strUserLevel <> "發FC郵件" Then
            'Modify By Sindy 2015/12/10 靜芳 : 07.證書函不用蓋confirmation章,因已全部改紙本寄出
            'Modify By Sindy 2016/10/28 07證書函恢復紙本和傳真
            'ElseIf Not (strUserLevel = "發FC郵件" Or m_FinalSty = "10" Or m_FinalSty = "07") Then
            'Modify By Sindy 2017/2/7
            'ElseIf Not (strUserLevel = "發FC郵件" Or m_FinalSty = "10") Then
            If Not (strUserLevel = "發FC郵件" Or m_FinalSty = "10") Then
            '2017/2/7 END
            '2015/11/10 END
            '2015/7/9 END
               If m_FinalSty = "08" Then '08.繳年費通知函
                  'E:e+寄 或傳真要蓋confirmation
                  If strEmail = "E" Then
                     ExceptFieldData = "|\　　　　　　　　|#(confirmation自動簽名檔)#| \|"
                  Else
                     strExc(0) = "SELECT NVL(np08,'') as NP08,NVL(np09,'') as NP09,np15 FROM NEXTPROGRESS WHERE NP02='" & m_MySt(1) & "' AND NP03='" & m_MySt(2) & "' AND NP04='" & m_MySt(3) & "' AND NP05='" & m_MySt(4) & "' AND NP07=" & 年費 & _
                                 " AND NP06 IS NULL ORDER BY NP08,NP09"
                     intI = 1
                     Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
                     If intI = 1 Then
                        RsTemp.MoveFirst
                        If Trim("" & RsTemp.Fields("np15")) <> "" And _
                           (InStr("" & RsTemp.Fields("np15"), "傳真") > 0 Or InStr(UCase("" & RsTemp.Fields("np15")), UCase("fax")) > 0) Then
                           ExceptFieldData = "|\　　　　　　　　|#(confirmation自動簽名檔)#| \|"
                        End If
                     End If
                  End If
               ElseIf m_FinalSty = "04" Then  '04.核准函
                  'E:e+寄,紙本
                  If strEmail = "E" Or "" & strEmail = "" Then
                     ExceptFieldData = "|\　　　　　　　　|#(confirmation自動簽名檔)#| \|"
                  End If
'               ElseIf m_FinalSty = "07" Then '07.證書函
'                  ExceptFieldData = "|\　　　　　　　　|#(confirmation自動簽名檔)#| \|"
'               ElseIf m_FinalSty = "10" Then '10.年證費請款函
'                  '不需要蓋confirmation的章
'                  ExceptFieldData = ""
               Else
                  'E:e+寄 才要蓋
                  If strEmail = "E" Then
                     ExceptFieldData = "|\　　　　　　　　|#(confirmation自動簽名檔)#| \|"
                  End If
                  'Added by Lydia 2018/11/16 針對NGB(Y34210000,Y34210010,Y34210020,Y34210030)公報定稿印出2份,請列印第2份紙本時加上Confirmation
                            'Sharon: 現在已回復寄送紙本,非全面email
                  If m_FinalSty = "05" Then '公告函
                        strExc(0) = "SELECT pa75 FROM PATENT WHERE pa01='" & m_MySt(1) & "' and pa02='" & m_MySt(2) & "' and pa03='" & m_MySt(3) & "' and pa04='" & m_MySt(4) & "'"
                        intI = 1
                        Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
                        If intI = 1 Then
                            If InStr("Y34210000,Y34210010,Y34210020,Y34210030", "" & RsTemp.Fields("pa75")) > 0 And "" & RsTemp.Fields("pa75") <> "" Then
                                ExceptFieldData = "|\　　　　　　　　|#(confirmation自動簽名檔)#| \|"
                            End If
                        End If
                  End If
                  'end 2018/11/16
               End If
            End If
            'Modify By Sindy 2017/2/7
            '申請人=X45149000(尼康)
            strExc(0) = "SELECT pa01 FROM PATENT WHERE pa01='" & m_MySt(1) & "' and pa02='" & m_MySt(2) & "' and pa03='" & m_MySt(3) & "' and pa04='" & m_MySt(4) & "'" & _
                          " AND (pa26='X45149000' or pa27='X45149000' or pa28='X45149000' or pa29='X45149000' or pa30='X45149000')"
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               '代理人
               strExc(1) = PUB_GetReceiver(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), m_CP10, m_SysKind)
               'Modified by Lydia 2020/06/18 +Y4745300 <志賀國際特許事務所>, Y5292200 <立石國際特許事務所>
               'If strExc(1) = "Y45149000" Then 'Nikon
               If InStr("Y4514900,Y4745300,Y5292200", Mid(strExc(1), 1, 8)) > 0 Then 'Nikno +Y編號
                  'Add By Sindy 2017/2/7
                  If ExceptFieldData <> "" Then
                      'Added by Lydia 2019/08/28 與Teresa確認Nikon繳年費通知函(英文)不用蓋confirmation章，所以去掉Confirmation章；並且調整Confidential章的位置避免太靠近Email。
                      If m_FinalSty = "08" And (m_Situ = "02" Or m_Situ = "03") Then
                             ExceptFieldData = "　　　　　　　　　　　　　　　　　　　|#(秘/Confidential自動簽名檔)#|"
                      Else
                      'end 2019/08/28
                             ExceptFieldData = "|\　　　　|#(confirmation自動簽名檔)#| \|　　　　|#(秘/Confidential自動簽名檔)#|"
                      End If
                  Else
                  '2017/2/7 END
                     ExceptFieldData = "　　　　　　　　|#(秘/Confidential自動簽名檔)#|"
                  End If
               End If
            End If
            '2017/2/7 END
         End If
         
      'Add by Sindy 2015/7/23
      Case "InvoiceEnclosed"
         'If m_FinalSty = "10" Then '10.年證費請款函
            '申請人=X27766000(村田製作所)
            strExc(0) = "SELECT pa01 FROM PATENT WHERE pa01='" & m_MySt(1) & "' and pa02='" & m_MySt(2) & "' and pa03='" & m_MySt(3) & "' and pa04='" & m_MySt(4) & "'" & _
                          " AND (pa26='X27766000' or pa27='X27766000' or pa28='X27766000' or pa29='X27766000' or pa30='X27766000')"
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               '代理人
               strExc(1) = PUB_GetReceiver(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), m_CP10, m_SysKind)
               If strExc(1) = "Y27766000" Then 'MURATA
                  'ExceptFieldData = "　　　　　　　　|#(InvoiceEnclosed自動簽名檔)#|"
                  ExceptFieldData = "　　　　　　　|#(InvoiceEnclosed自動簽名檔)#|"
               End If
            End If
         'End If

      Case "有InvoiceEnclosed章"
         '無蓋章要跳行
         ExceptFieldData = "♀"
         '申請人=X27766000(村田製作所)
         strExc(0) = "SELECT pa01 FROM PATENT WHERE pa01='" & m_MySt(1) & "' and pa02='" & m_MySt(2) & "' and pa03='" & m_MySt(3) & "' and pa04='" & m_MySt(4) & "'" & _
                       " AND (pa26='X27766000' or pa27='X27766000' or pa28='X27766000' or pa29='X27766000' or pa30='X27766000')"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            '代理人
            strExc(1) = PUB_GetReceiver(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), m_CP10, m_SysKind)
            If strExc(1) = "Y27766000" Then 'MURATA
               '有蓋章就不跳行
               ExceptFieldData = ""
            End If
         End If
      '2015/7/23 END
      
      'Add by Morgan 2007/2/7
      'Modified by Morgan 2016/6/17 沒有定稿日期才用系統日
      Case "公用備註/中"
         strExc(0) = "select LM05 from lettermemo where LM01='" & m_MySt(1) & "' and LM02='1' and (" & IIf(g_LetterDate <> "", g_LetterDate, strSrvDate(1)) & " between LM03 and LM04)"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData = "" & RsTemp.Fields(0)
         End If
      Case "公用備註/英"
         'Modified by Morgan 2024/2/17 +order by LM03 desc(抓最新的通知)
         strExc(0) = "select LM05 from lettermemo where LM01='" & m_MySt(1) & "' and LM02='2' and (" & IIf(g_LetterDate <> "", g_LetterDate, strSrvDate(1)) & " between LM03 and LM04) order by LM03 desc"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData = "" & RsTemp.Fields(0)
         End If
      Case "公用備註/日"
         strExc(0) = "select LM05 from lettermemo where LM01='" & m_MySt(1) & "' and LM02='3' and (" & IIf(g_LetterDate <> "", g_LetterDate, strSrvDate(1)) & " between LM03 and LM04)"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData = "" & RsTemp.Fields(0)
         End If
      'end 2016/6/17
      'End 2007/2/7
      'Add By Sindy 2014/11/20
      Case "公用備註/純文字"
         strExc(0) = "select LM05 from lettermemo where LM01='" & m_MySt(1) & "' and LM02='4' and (" & IIf(g_LetterDate <> "", g_LetterDate, strSrvDate(1)) & " between LM03 and LM04)"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData = "" & RsTemp.Fields(0)
         End If
      '2014/11/20 END
      'Add by Morgan 2004/12/2
      Case "定位"
         ExceptFieldData = vbTab
      'Add by Morgan 2005/10/25
      Case "跳行"
         ExceptFieldData = vbCrLf
      'Add by Morgan 2006/4/25
      Case "跳頁"
         ExceptFieldData = Chr(12)
      'Add by Morgan 2004/10/1
      Case "專利名稱"
         Select Case m_SysKind
            Case 1 '專利
               strExc(0) = "SELECT NVL(PA07,PA05) FROM PATENT WHERE " & PaSt
               intI = 1
               Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
               If intI = 1 Then
                  If IsNull(RsTemp.Fields(0).Value) Then
                     ExceptFieldData = ""
                  Else
                     ExceptFieldData = "" & RsTemp.Fields(0)
                  End If
               End If
         End Select
      'Add by Morgan 2004/10/6
      Case "專利名稱/日英"
         Select Case m_SysKind
            Case 1 '專利
               strExc(0) = "SELECT NVL(PA07,PA06) FROM PATENT WHERE " & PaSt
               intI = 1
               Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
               If intI = 1 Then
                  If IsNull(RsTemp.Fields(0).Value) Then
                     ExceptFieldData = ""
                  Else
                     ExceptFieldData = "" & RsTemp.Fields(0)
                  End If
               End If
         End Select
      'Add by Morgan 2005/9/22
      Case "專利名稱/英日"
         Select Case m_SysKind
            Case 1 '專利
               strExc(0) = "SELECT NVL(PA06,PA07) FROM PATENT WHERE " & PaSt
               intI = 1
               Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
               If intI = 1 Then
                  If IsNull(RsTemp.Fields(0).Value) Then
                     ExceptFieldData = ""
                  Else
                     ExceptFieldData = "" & RsTemp.Fields(0)
                  End If
               End If
         End Select
      'Add by Morgan 2004/10/6
      Case "專利申請人1/日英", "專利申請人2/日英", "專利申請人3/日英", "專利申請人4/日英", "專利申請人5/日英"
         Select Case m_SysKind
            Case 1 '專利
               'Modified by Morgan 2019/11/25 英文欄位間要補空白
               'strExc(0) = "SELECT NVL(CU06,CU05||CU88||CU89||CU90) FROM PATENT,CUSTOMER WHERE " & PaSt & _
                  " AND CU01(+)=SUBSTR(PA" & 25 + Val(Mid(strField, 6, 1)) & ",1,8)" & _
                  " AND CU02(+)=SUBSTR(PA" & 25 + Val(Mid(strField, 6, 1)) & ",9,1)"
               strExc(0) = "SELECT NVL(CU06,rtrim(CU05||' '||CU88||' '||CU89||' '||CU90)) FROM PATENT,CUSTOMER WHERE " & PaSt & _
                  " AND CU01(+)=SUBSTR(PA" & 25 + Val(Mid(strField, 6, 1)) & ",1,8)" & _
                  " AND CU02(+)=SUBSTR(PA" & 25 + Val(Mid(strField, 6, 1)) & ",9,1)"
               intI = 1
               Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
               If intI = 1 Then
                  If IsNull(RsTemp.Fields(0).Value) Then
                     ExceptFieldData = ""
                  Else
                     ExceptFieldData = "" & RsTemp.Fields(0)
                  End If
               End If
         End Select
      'Add by nick 2004/10/12
      'Modified by Morgan 2025/4/24 +分割母案申請案號N/A
      Case "分割母案申請案號", "分割母案申請案號N/A"
         Select Case m_SysKind
            Case 1 '專利
               strExc(0) = "SELECT PA11 FROM PATENT,divisioncase WHERE dc05=pa01(+) and dc06=pa02(+) and dc07=pa03(+) and dc08=pa04(+) and dc01='" & m_MySt(1) & "' and dc02='" & m_MySt(2) & "' and dc03='" & m_MySt(3) & "' and dc04='" & m_MySt(4) & "' "
            Case 2 '商標
               'edit by nickc 2005/05/20
               'strExc(0) = "SELECT TM12 FROM TRADEMARK,divisioncase WHERE dc05=tm01(+) and dc06=tm02(+) and dc07=tm03(+) and dc08=tm04(+) and dc01='" & m_MySt(1) & "' and dc02='" & m_MySt(2) & "' and dc03='" & m_MySt(3) & "' and dc04='" & m_MySt(4) & "' "
               'Modify By Sindy 2010/11/11
               'Modify By Sindy 2024/5/21 ex:T-245559本身是子案,又再分割出2個子案;調整抓分割母案申請案號的Sql
               strExc(0) = "SELECT nvl(tm15,TM12),2 sort FROM TRADEMARK,divisioncase WHERE dc05=tm01(+) and dc06=tm02(+) and dc07=tm03(+) and dc08=tm04(+) and dc01='" & m_MySt(1) & "' and dc02='" & m_MySt(2) & "' and dc03='" & m_MySt(3) & "' and dc04='" & m_MySt(4) & "' " & _
                           "union " & _
                           "SELECT nvl(tm15,TM12),1 sort FROM TRADEMARK,divisioncase WHERE dc05=tm01(+) and dc06=tm02(+) and dc07=tm03(+) and dc08=tm04(+) and dc05='" & m_MySt(1) & "' and dc06='" & m_MySt(2) & "' and dc07='" & m_MySt(3) & "' and dc08='" & m_MySt(4) & "' " & _
                           "order by sort asc"
         End Select
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData = "" & RsTemp.Fields(0)
         'Added by Morgan 2025/4/24
         ElseIf intI = 0 Then
            If Right(strField, 3) = "N/A" Then
               ExceptFieldData = "N/A"
            End If
         'end 2025/4/24
         End If
      'add by nick 2004/12/23
      Case "分割母案案件名稱"
         Select Case m_SysKind
            Case 1 '專利
               strExc(0) = "SELECT pa05||pa06||pa07 FROM PATENT,divisioncase WHERE dc05=pa01(+) and dc06=pa02(+) and dc07=pa03(+) and dc08=pa04(+) and dc01='" & m_MySt(1) & "' and dc02='" & m_MySt(2) & "' and dc03='" & m_MySt(3) & "' and dc04='" & m_MySt(4) & "' "
            Case 2 '商標
               strExc(0) = "SELECT tm05||tm06||tm07 FROM TRADEMARK,divisioncase WHERE dc05=tm01(+) and dc06=tm02(+) and dc07=tm03(+) and dc08=tm04(+) and dc01='" & m_MySt(1) & "' and dc02='" & m_MySt(2) & "' and dc03='" & m_MySt(3) & "' and dc04='" & m_MySt(4) & "' "
         End Select
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If IsNull(RsTemp.Fields(0).Value) Then
               ExceptFieldData = ""
            Else
               ExceptFieldData = "" & RsTemp.Fields(0)
            End If
         End If
      'add by nick 2004/12/23
      Case "分割母案類別"
         Select Case m_SysKind
            Case 2 '商標
               strExc(0) = "SELECT TM09 FROM TRADEMARK,divisioncase WHERE dc05=tm01(+) and dc06=tm02(+) and dc07=tm03(+) and dc08=tm04(+) and dc01='" & m_MySt(1) & "' and dc02='" & m_MySt(2) & "' and dc03='" & m_MySt(3) & "' and dc04='" & m_MySt(4) & "' "
         End Select
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If IsNull(RsTemp.Fields(0).Value) Then
               ExceptFieldData = ""
            Else
               ExceptFieldData = "" & RsTemp.Fields(0)
            End If
         End If
      'Add by nick 2004/12/30
      Case "分割母案申請人英文名稱"
         Select Case m_SysKind
            Case 1 '專利
               strExc(0) = "SELECT cu05,cu88,cu89,cu90 FROM PATENT,CUSTOMER,divisioncase WHERE dc05=pa01(+) and dc06=pa02(+) and dc07=pa03(+) and dc08=pa04(+) and dc01='" & m_MySt(1) & "' and dc02='" & m_MySt(2) & "' and dc03='" & m_MySt(3) & "' and dc04='" & m_MySt(4) & "' " & _
                " AND SUBSTR(pa26,1,8)=CU01(+) AND SUBSTR(pa26,9,1)=CU02(+)"
            Case 2 '商標
               strExc(0) = "SELECT cu05,cu88,cu89,cu90 FROM TRADEMARK,CUSTOMER,divisioncase WHERE dc05=tm01(+) and dc06=tm02(+) and dc07=tm03(+) and dc08=tm04(+) and dc01='" & m_MySt(1) & "' and dc02='" & m_MySt(2) & "' and dc03='" & m_MySt(3) & "' and dc04='" & m_MySt(4) & "' " & _
                  " AND SUBSTR(TM23,1,8)=CU01(+) AND SUBSTR(TM23,9,1)=CU02(+)"
         End Select
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            For i = 0 To 3
                 If Not IsNull(RsTemp.Fields(i)) Then ExceptFieldData = ExceptFieldData & RsTemp.Fields(i)
                 If i <> 3 Then
                    If Not IsNull(RsTemp.Fields(i + 1)) Then ExceptFieldData = ExceptFieldData & vbCrLf
                 End If
            Next i
         End If
      Case "分割母案本所案號"
         strExc(0) = "SELECT dc05||'-'||dc06||decode(dc07,'0','','-'||dc07)||decode(dc08,'00','','-'||dc08) FROM divisioncase WHERE dc01='" & m_MySt(1) & "' and dc02='" & m_MySt(2) & "' and dc03='" & m_MySt(3) & "' and dc04='" & m_MySt(4) & "' "
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If IsNull(RsTemp.Fields(0).Value) Then
               ExceptFieldData = ""
            Else
               ExceptFieldData = "" & RsTemp.Fields(0)
            End If
         End If
      'add by nickc 2006/06/22
      Case "馬德里母案審定號"
         strExc(0) = "SELECT tm15 FROM TRADEMARK WHERE tm01='" & m_MySt(1) & "' and tm02=substr('" & m_MySt(2) & "',1,5)||'0' and tm03='0' and tm04='00' "
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If IsNull(RsTemp.Fields(0).Value) Then
               ExceptFieldData = ""
            Else
               ExceptFieldData = "" & RsTemp.Fields(0)
            End If
         End If
      Case "馬德里母案本所案號"
         strExc(0) = "SELECT tm01||'-'||tm02||'-'||tm03||'-'||tm04 FROM TRADEMARK WHERE tm01='" & m_MySt(1) & "' and tm02=substr('" & m_MySt(2) & "',1,5)||'0' and tm03='0' and tm04='00' "
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If IsNull(RsTemp.Fields(0).Value) Then
               ExceptFieldData = ""
            Else
               ExceptFieldData = "" & RsTemp.Fields(0)
            End If
         End If
      Case "分割母案彼所案號"
         Select Case m_SysKind
            Case 1 '專利
               strExc(0) = "SELECT pa77 FROM PATENT,divisioncase WHERE dc05=pa01(+) and dc06=pa02(+) and dc07=pa03(+) and dc08=pa04(+) and dc01='" & m_MySt(1) & "' and dc02='" & m_MySt(2) & "' and dc03='" & m_MySt(3) & "' and dc04='" & m_MySt(4) & "' "
            Case 2 '商標
               strExc(0) = "SELECT tm45 FROM TRADEMARK,divisioncase WHERE dc05=tm01(+) and dc06=tm02(+) and dc07=tm03(+) and dc08=tm04(+) and dc01='" & m_MySt(1) & "' and dc02='" & m_MySt(2) & "' and dc03='" & m_MySt(3) & "' and dc04='" & m_MySt(4) & "' "
         End Select
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If IsNull(RsTemp.Fields(0).Value) Then
               ExceptFieldData = ""
            Else
               ExceptFieldData = "" & RsTemp.Fields(0)
            End If
         End If
      'Add by Morgan 2003/12/30
      Case "客戶案件案號/中"
         Select Case m_SysKind
            Case 1 '專利
               strExc(0) = "SELECT PA48 FROM PATENT WHERE " & PaSt
            Case 2 '商標
               strExc(0) = "SELECT TM35 FROM TRADEMARK WHERE " & TmSt
            Case 3 '法務
               strExc(0) = "SELECT LC17 FROM LAWCASE WHERE " & LcSt
            Case 4 '顧問
               strExc(0) = "SELECT NULL FROM HIRECASE WHERE " & HcSt
            Case 5, 6   '服務
               strExc(0) = "SELECT SP29 FROM SERVICEPRACTICE WHERE " & SpSt
         End Select
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If IsNull(RsTemp.Fields(0).Value) Then
               ExceptFieldData = ""
            Else
               ExceptFieldData = "(" & RsTemp.Fields(0) & ")"
            End If
         End If
      Case "申請書日期"
         If Len(strLetterDate) = 6 Then
            ExceptFieldData = "中華民國" & Mid(strLetterDate, 1, 2) & "年" & Mid(strLetterDate, 3, 2) & "月" & Mid(strLetterDate, 5, 2) & "日"
         Else
            ExceptFieldData = "中華民國" & Mid(strLetterDate, 1, 3) & "年" & Mid(strLetterDate, 4, 2) & "月" & Mid(strLetterDate, 6, 2) & "日"
         End If
      Case "申請書日期/簡"
         If Len(strLetterDate) = 6 Then
            ExceptFieldData = Mid(strLetterDate, 1, 2) & "年" & Mid(strLetterDate, 3, 2) & "月" & Mid(strLetterDate, 5, 2) & "日"
         Else
            ExceptFieldData = Mid(strLetterDate, 1, 3) & "年" & Mid(strLetterDate, 4, 2) & "月" & Mid(strLetterDate, 6, 2) & "日"
         End If
      Case "系統日"
         ExceptFieldData = strSrvDate(1)
      Case "系統日/年度"
         If Len(strSrvDate(2)) = 6 Then
            ExceptFieldData = Left(strSrvDate(2), 2)
         Else
            ExceptFieldData = Left(strSrvDate(2), 3)
         End If
      'Add by Morgan 2007/11/5  配合新版領證,年費通知函用
      Case "系統日/中2"
         'Added by Morgan 2021/10/12 指定E化客戶案件要印發文日(此變數在指定信箱設定，只適用客戶函)
         'Modified by Morgan 2025/11/11 +半E化客戶
         If m_bolECust Or m_bolXECust Then
            ExceptFieldData = "中華民國" & Mid(strSrvDate(2), 1, 3) & "(" & Mid(strSrvDate(1), 1, 4) & ")年" & Mid(strSrvDate(2), 4, 2) & "月" & Right(strSrvDate(2), 2) & "日"
         Else
         'end 2021/10/12
         
            'modify by sonia 2019/11/6 改民國(西元)年月日
            'ExceptFieldData = "中華民國" & Mid(strSrvDate(2), 1, 3) & "年 " & Mid(strSrvDate(2), 4, 2) & " 月    日"
            'Modified by Morgan 2020/4/1 改統一都不印月日--郭
            'ExceptFieldData = "中華民國" & Mid(strSrvDate(2), 1, 3) & "(" & Mid(strSrvDate(1), 1, 4) & ")年" & Mid(strSrvDate(2), 4, 2) & "月   日"
            ExceptFieldData = "中華民國" & Mid(strSrvDate(2), 1, 3) & "(" & Mid(strSrvDate(1), 1, 4) & ")年   月   日"
            'end 2020/4/1
            
         End If 'Added by Morgan 2021/10/12
      
      'Add By Sindy 2025/4/24
      Case "定稿日期/中2"
         If Len(m_MySt(8)) = 0 Then Exit Function
         'Modified by Morgan 2025/11/11 +半E化客戶
         If m_bolECust Or m_bolXECust Then
            ExceptFieldData = "中華民國" & Val(Mid(m_MySt(8), 1, 4)) - 1911 & "(" & Mid(m_MySt(8), 1, 4) & ")年" & Mid(m_MySt(8), 5, 2) & "月" & Mid(m_MySt(8), 7, 2) & "日"
         Else
            ExceptFieldData = "中華民國" & Val(Mid(m_MySt(8), 1, 4)) - 1911 & "(" & Mid(m_MySt(8), 1, 4) & ")年   月   日"
         End If
      '2025/4/24 END
      'Add By Sindy 2020/12/14
      Case "定稿日期/中"
         If Len(m_MySt(8)) = 0 Then Exit Function
         ExceptFieldData = "中華民國" & Val(Mid(m_MySt(8), 1, 4)) - 1911 & "(" & Mid(m_MySt(8), 1, 4) & ")年" & Mid(m_MySt(8), 5, 2) & "月" & Mid(m_MySt(8), 7, 2) & "日"
      Case "定稿日期/英"
         If Len(m_MySt(8)) = 0 Then Exit Function
         strTmp = Empty '加註解 當 incCNV_ENGLISH_DATE 發生錯誤時， VB 要重開
         ExceptFieldData = TranslateKeyWord(incCNV_ENGLISH_DATE, m_MySt(8), strTmp)
      Case "定稿日期/中西"
         If Len(m_MySt(8)) = 0 Then Exit Function
         ExceptFieldData = Mid(m_MySt(8), 1, 4) & "年" & Mid(m_MySt(8), 5, 2) & "月" & Mid(m_MySt(8), 7, 2) & "日"
      '2020/12/14 END
         
      Case "系統日/中"
         'Modify by Morgan 2006/5/19 加判斷P,PS,CFP,CPS的日不印
         'modify by sonia 2019/11/6 改民國(西元)年月日
         'ExceptFieldData = "中華民國" & Mid(strSrvDate(2), 1, 3) & "年" & Mid(strSrvDate(2), 4, 2) & "月"
         ExceptFieldData = "中華民國" & Mid(strSrvDate(2), 1, 3) & "(" & Mid(strSrvDate(1), 1, 4) & ")年" & Mid(strSrvDate(2), 4, 2) & "月"
         
         'Added by Morgan 2021/10/12 指定E化客戶案件要印發文日(此變數在指定信箱設定，只適用客戶函)
         'Modified by Morgan 2025/11/11 +半E化客戶
         If m_bolECust Or m_bolXECust Then
            ExceptFieldData = ExceptFieldData & Right(strSrvDate(2), 2) & "日"
         'end 2021/10/12
         'Modify By Sindy 2021/3/10 改判斷T開頭
         ElseIf Left(m_MySt(1), 1) = "T" Then
            'Modified by Sindy 2021/1/14 改統一都不印月日--桂英
            'Modify By Sindy 2021/1/18 整批定稿別(10,15)維持年月日都要帶出來
            If (m_FinalSty = "10" Or m_FinalSty = "15") Then
               ExceptFieldData = ExceptFieldData & Right(strSrvDate(2), 2) & "日"
            Else
            '2021/1/18 END
               ExceptFieldData = "中華民國" & Mid(strSrvDate(2), 1, 3) & "(" & Mid(strSrvDate(1), 1, 4) & ")年   月   日"
            End If
'               'add by nickc 2006/08/18 T 申請國家是台灣的，若發文日比系統日大，以發文日取代系統日出定稿
'               'Modify By Sindy 2020/8/14 限T台灣案之發文(m_FinalSty = "01")及申請案號(m_FinalSty = "02")定稿, 且為電子送件自動扣款案件
'               '                          定稿右上角發文日只印年月, 日期空白由發文室自行填寫
'               strExc(0) = "SELECT * FROM caseprogress,trademark WHERE cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+)" & _
'                           " and cp09='" & m_SrcKey & "' and tm10='000' "
'               Set rsA = New ADODB.Recordset
'               With rsA
'                  If rsA.State = 1 Then rsA.Close
'                  .CursorLocation = adUseClient
'                  .Open strExc(0), cnnConnection, adOpenStatic, adLockReadOnly
'                  If .RecordCount <> 0 Then
'                     'Add By Sindy 2020/8/14
'                     If "" & .Fields("cp118") = "A" And Val(CheckStr(.Fields("cp152"))) > 0 And _
'                        (m_FinalSty = "01" Or m_FinalSty = "02") Then
'                        ExceptFieldData = ExceptFieldData & "   日"
'                     '2020/8/14 END
'                     'Add By Sindy 2021/1/12 註冊證改不印月日 05-發註冊證 (CCT)
'                     ElseIf m_FinalSty = "05" Then
'                        ExceptFieldData = "中華民國" & Mid(strSrvDate(2), 1, 3) & "(" & Mid(strSrvDate(1), 1, 4) & ")年   月   日"
'                     '2021/1/12 END
'                     ElseIf CheckStr(.Fields("cp27")) > strSrvDate(1) Then
'                        'ExceptFieldData = "中華民國" & Val(Mid(CheckStr(.Fields("cp27")), 1, 4)) - 1911 & "年" & Mid(CheckStr(.Fields("cp27")), 5, 2) & "月"
'                        ExceptFieldData = "中華民國" & Val(Mid(CheckStr(.Fields("cp27")), 1, 4)) - 1911 & "(" & Mid(strSrvDate(1), 1, 4) & ")年" & Mid(CheckStr(.Fields("cp27")), 5, 2) & "月"
'                        ExceptFieldData = ExceptFieldData & Right(CheckStr(.Fields("cp27")), 2) & "日"
'                     Else
'                        ExceptFieldData = ExceptFieldData & Right(strSrvDate(2), 2) & "日"
'                     End If
'                  Else
'                     'Add By Sindy 2021/1/12 註冊證改不印月日 05-發註冊證 (CMT)
'                     If m_FinalSty = "05" Then
'                        ExceptFieldData = "中華民國" & Mid(strSrvDate(2), 1, 3) & "(" & Mid(strSrvDate(1), 1, 4) & ")年   月   日"
'                     '2021/1/12 END
'                     Else
'                        ExceptFieldData = ExceptFieldData & Right(strSrvDate(2), 2) & "日"
'                     End If
'                  End If
'                  rsA.Close
'               End With
         Else
            Select Case m_MySt(1)
               Case "P", "PS", "CFP", "CPS"
                  'Modified by Morgan 2020/4/1 改統一都不印月日--郭
                  ''Modify by Morgan 2006/5/23 P的年費逾期補繳通知函要印
                  'If m_MySt(1) = "P" And m_FinalSty = "19" Then
                  '   ExceptFieldData = ExceptFieldData & Right(strSrvDate(2), 2) & "日"
                  'Else
                  '   'Modified by Morgan 2020/4/1
                  '   ExceptFieldData = ExceptFieldData & "   日"
                  'End If
                  ExceptFieldData = "中華民國" & Mid(strSrvDate(2), 1, 3) & "(" & Mid(strSrvDate(1), 1, 4) & ")年   月   日"
                  'end 2020/4/1
                  
'               Case "T"
'                  'Modified by Sindy 2021/1/14 改統一都不印月日--桂英
'                  'Modify By Sindy 2021/1/18 整批定稿別(10,15)維持年月日都要帶出來
'                  If (m_FinalSty = "10" Or m_FinalSty = "15") Then
'                     ExceptFieldData = ExceptFieldData & Right(strSrvDate(2), 2) & "日"
'                  Else
'                  '2021/1/18 END
'                     ExceptFieldData = "中華民國" & Mid(strSrvDate(2), 1, 3) & "(" & Mid(strSrvDate(1), 1, 4) & ")年   月   日"
'                  End If
'   '               'add by nickc 2006/08/18 T 申請國家是台灣的，若發文日比系統日大，以發文日取代系統日出定稿
'   '               'Modify By Sindy 2020/8/14 限T台灣案之發文(m_FinalSty = "01")及申請案號(m_FinalSty = "02")定稿, 且為電子送件自動扣款案件
'   '               '                          定稿右上角發文日只印年月, 日期空白由發文室自行填寫
'   '               strExc(0) = "SELECT * FROM caseprogress,trademark WHERE cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+)" & _
'   '                           " and cp09='" & m_SrcKey & "' and tm10='000' "
'   '               Set rsA = New ADODB.Recordset
'   '               With rsA
'   '                  If rsA.State = 1 Then rsA.Close
'   '                  .CursorLocation = adUseClient
'   '                  .Open strExc(0), cnnConnection, adOpenStatic, adLockReadOnly
'   '                  If .RecordCount <> 0 Then
'   '                     'Add By Sindy 2020/8/14
'   '                     If "" & .Fields("cp118") = "A" And Val(CheckStr(.Fields("cp152"))) > 0 And _
'   '                        (m_FinalSty = "01" Or m_FinalSty = "02") Then
'   '                        ExceptFieldData = ExceptFieldData & "   日"
'   '                     '2020/8/14 END
'   '                     'Add By Sindy 2021/1/12 註冊證改不印月日 05-發註冊證 (CCT)
'   '                     ElseIf m_FinalSty = "05" Then
'   '                        ExceptFieldData = "中華民國" & Mid(strSrvDate(2), 1, 3) & "(" & Mid(strSrvDate(1), 1, 4) & ")年   月   日"
'   '                     '2021/1/12 END
'   '                     ElseIf CheckStr(.Fields("cp27")) > strSrvDate(1) Then
'   '                        'ExceptFieldData = "中華民國" & Val(Mid(CheckStr(.Fields("cp27")), 1, 4)) - 1911 & "年" & Mid(CheckStr(.Fields("cp27")), 5, 2) & "月"
'   '                        ExceptFieldData = "中華民國" & Val(Mid(CheckStr(.Fields("cp27")), 1, 4)) - 1911 & "(" & Mid(strSrvDate(1), 1, 4) & ")年" & Mid(CheckStr(.Fields("cp27")), 5, 2) & "月"
'   '                        ExceptFieldData = ExceptFieldData & Right(CheckStr(.Fields("cp27")), 2) & "日"
'   '                     Else
'   '                        ExceptFieldData = ExceptFieldData & Right(strSrvDate(2), 2) & "日"
'   '                     End If
'   '                  Else
'   '                     'Add By Sindy 2021/1/12 註冊證改不印月日 05-發註冊證 (CMT)
'   '                     If m_FinalSty = "05" Then
'   '                        ExceptFieldData = "中華民國" & Mid(strSrvDate(2), 1, 3) & "(" & Mid(strSrvDate(1), 1, 4) & ")年   月   日"
'   '                     '2021/1/12 END
'   '                     Else
'   '                        ExceptFieldData = ExceptFieldData & Right(strSrvDate(2), 2) & "日"
'   '                     End If
'   '                  End If
'   '                  rsA.Close
'   '               End With
                  
               '2008/11/19 add by sonia 杜副總要求
               Case "CFT", "CFC"
                  ExceptFieldData = ExceptFieldData & "   日"
               '2008/11/19 end
               Case Else
                  ExceptFieldData = ExceptFieldData & Right(strSrvDate(2), 2) & "日"
            End Select
            'END 2006/5/19
         End If
         'Add By Cheng 2003/11/28
         
      Case "系統日/中1"
         If Len(strSrvDate(2)) = 6 Then
            ExceptFieldData = Mid(strSrvDate(2), 1, 2) & "年" & Mid(strSrvDate(2), 3, 2) & "月" & Mid(strSrvDate(2), 5, 2) & "日"
         Else
            ExceptFieldData = Mid(strSrvDate(2), 1, 3) & "年" & Mid(strSrvDate(2), 4, 2) & "月" & Mid(strSrvDate(2), 6, 2) & "日"
         End If
        'End
      Case "系統日/英"
         strTmp = Empty                 'nick 2004/12/17 加註解 當 incCNV_ENGLISH_DATE 發生錯誤時， VB 要重開
         ExceptFieldData = TranslateKeyWord(incCNV_ENGLISH_DATE, strSrvDate(1), strTmp)
      Case "系統日/中西"
         ExceptFieldData = Mid(strSrvDate(1), 1, 4) & "年" & Mid(strSrvDate(1), 5, 2) & "月" & Mid(strSrvDate(1), 7, 2) & "日"
      Case "定稿名稱"
         ExceptFieldData = m_FinalSty & m_Situ
      Case "信函抬頭/中"
         strExc(1) = PUB_GetReceiver(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), m_CP10, m_SysKind)
         If strExc(1) <> "" Then
            strExc(0) = "SELECT FA04, FA17 FROM FAGENT WHERE " & ChgFagent(strExc(1))
            strExc(0) = strExc(0) & " Union SELECT CU04, CU31 FROM CUSTOMER WHERE " & ChgCustomer(strExc(1))
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               With RsTemp
                  If Not IsNull(.Fields(0)) Then ExceptFieldData = ExceptFieldData & .Fields(0) & vbCrLf
                  If Not IsNull(.Fields(1)) Then ExceptFieldData = ExceptFieldData & .Fields(1)
               End With
            End If
         End If
      Case "信函抬頭/日"         '  含名稱地址
         strExc(1) = PUB_GetReceiver(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), m_CP10, m_SysKind)
         If strExc(1) <> "" Then
            strExc(0) = "SELECT FA06, FA23 FROM FAGENT WHERE " & ChgFagent(strExc(1))
            strExc(0) = strExc(0) & " Union SELECT CU06, CU29 FROM CUSTOMER WHERE " & ChgCustomer(strExc(1))
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               With RsTemp
                  If Not IsNull(.Fields(0)) Then ExceptFieldData = ExceptFieldData & .Fields(0) & vbCrLf
                  If Not IsNull(.Fields(1)) Then ExceptFieldData = ExceptFieldData & .Fields(1)
               End With
            End If
         End If
      Case "信函抬頭1/日"            '  含名稱不含地址
         strExc(1) = PUB_GetReceiver(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), m_CP10, m_SysKind)
         If strExc(1) <> "" Then
            '2011/4/6 MODIFY BY SONIA 無日文抓英文 FCT-031527
            'strExc(0) = "SELECT FA06 FROM FAGENT WHERE " & ChgFagent(strExc(1))
            'strExc(0) = strExc(0) & " Union SELECT CU06 FROM CUSTOMER WHERE " & ChgCustomer(strExc(1))
'            strExc(0) = "SELECT DECODE(FA06,NULL,FA05||' '||FA63||' '||FA64||' '||FA65,FA06) FROM FAGENT WHERE " & ChgFagent(strExc(1))
'            strExc(0) = strExc(0) & " Union SELECT DECODE(CU06,NULL,CU05||' '||CU88||' '||CU89||' '||CU90,CU06) FROM CUSTOMER WHERE " & ChgCustomer(strExc(1))
            '2011/4/6 END
            'Modify By Sindy 2017/6/12 阿蓮說若是抓到英文名稱不要串在一起
            strExc(0) = "SELECT FA06,FA05,FA63,FA64,FA65 FROM FAGENT WHERE " & ChgFagent(strExc(1))
            strExc(0) = strExc(0) & " Union SELECT CU06,CU05,CU88,CU89,CU90 FROM CUSTOMER WHERE " & ChgCustomer(strExc(1))
            '2017/6/12 END
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               With RsTemp
                  'Modify By Sindy 2017/6/12
                  'If Not IsNull(.Fields(0)) Then ExceptFieldData = ExceptFieldData & .Fields(0)
                  If Not IsNull(.Fields(0)) Then
                     ExceptFieldData = ExceptFieldData & .Fields(0)
                  Else
                     For i = 1 To 4
                        If Not IsNull(.Fields(i)) Then
                           'Modify By Sindy 2017/7/19 ex:FCT-039655 註冊證-16
                           'ExceptFieldData = ExceptFieldData & .Fields(i) & vbCrLf
                           If i <> 1 Then
                              ExceptFieldData = ExceptFieldData & vbCrLf
                           End If
                           '2017/7/19 END
                           ExceptFieldData = ExceptFieldData & .Fields(i)
                        End If
                     Next
                  End If
                  '2017/6/12 END
               End With
            End If
         End If
      Case "信函抬頭/英"      '  含名稱地址
         '以代理人抓FAGENT檔，若無代理人則以申請人抓客戶檔，列印出英文名稱及POB或地址
         strExc(1) = PUB_GetReceiver(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), m_CP10, m_SysKind)
         If strExc(1) <> "" Then
            'Modify by Morgan 2007/1/23 加 FA70(CU102)
            strExc(0) = "SELECT FA05,FA63,FA64,FA65,FA18,FA19,FA20,FA21,FA22," & _
                           "FA32,FA33,FA34,FA35,FA36,FA70 FROM FAGENT WHERE " & ChgFagent(strExc(1))
            strExc(0) = strExc(0) & " Union SELECT CU05,CU88,CU89,CU90,CU24,CU25,CU26,CU27,CU28||CU102," & _
                           "CU65,CU66,CU67,CU68,CU69,CU102 FROM CUSTOMER WHERE " & ChgCustomer(strExc(1))
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               With RsTemp
                  For i = 0 To 3
                     If Not IsNull(.Fields(i)) Then ExceptFieldData = ExceptFieldData & .Fields(i) & vbCrLf
                  Next
                  If .Fields(9) <> "" Or .Fields(10) <> "" Or .Fields(11) <> "" Or .Fields(12) <> "" Or .Fields(13) <> "" Then
                     For i = 9 To 13
                        If Not IsNull(.Fields(i)) Then ExceptFieldData = ExceptFieldData & .Fields(i) & vbCrLf
                     Next
                  Else
                     For i = 4 To 8
                        If Not IsNull(.Fields(i)) Then ExceptFieldData = ExceptFieldData & .Fields(i) & vbCrLf
                     Next
                     'Add by Morgan 2007/1/23 加地址6
                     i = 14
                     If Not IsNull(.Fields(i)) Then ExceptFieldData = ExceptFieldData & .Fields(i) & vbCrLf
                     'end 2007/1/23
                  End If
                  'Add By Cheng 2003/01/09
                  '拿掉字串後的換行符號
                  If ExceptFieldData <> "" Then
                        ExceptFieldData = LeftB(ExceptFieldData, LenB(ExceptFieldData) - LenB(vbCrLf))
                  End If
               End With
            End If
         End If
      'Add By Cheng 2003/12/26 含名稱不含地址  信函第二頁或 Return Sheet 用
      'Modified by Morgan 2015/12/3 +"信函抬頭名稱/英2"
      Case "信函抬頭名稱/英", "信函抬頭名稱/英2"
         
         '以代理人抓FAGENT檔，若無代理人則以申請人抓客戶檔，列印出英文名稱
         strExc(1) = PUB_GetReceiver(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), m_CP10, m_SysKind)
         If strExc(1) <> "" Then
            strExc(0) = "SELECT FA05,FA63,FA64,FA65,FA18,FA19,FA20,FA21,FA22," & _
                           "FA32,FA33,FA34,FA35,FA36 FROM FAGENT WHERE " & ChgFagent(strExc(1))
            strExc(0) = strExc(0) & " Union SELECT CU05,CU88,CU89,CU90,CU24,CU25,CU26,CU27,CU28||CU102," & _
                           "CU65,CU66,CU67,CU68,CU69 FROM CUSTOMER WHERE " & ChgCustomer(strExc(1))
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               With RsTemp
                  intI = 0
                  For i = 0 To 3
                     If Not IsNull(.Fields(i)) Then
                        'Added by Morgan 2015/12/3 兩兩欄位合併以減少跳行(用於該行寬允許的版面)
                        intI = intI + 1
                        If strField = "信函抬頭名稱/英2" And intI Mod 2 = 1 Then
                           ExceptFieldData = ExceptFieldData & .Fields(i) & " "
                        Else
                        'end 2015/12/3
                           ExceptFieldData = ExceptFieldData & .Fields(i) & vbCrLf
                        End If
                     Else
                     
                     End If
                  Next
                  'Add By Cheng 2003/01/09
                  '拿掉字串後的換行符號
                  If ExceptFieldData <> "" Then
                     'Modified by Morgan 2015/12/3
                     'ExceptFieldData = LeftB(ExceptFieldData, LenB(ExceptFieldData) - LenB(vbCrLf))
                     If Right(ExceptFieldData, Len(vbCrLf)) = vbCrLf Then
                        ExceptFieldData = Left(ExceptFieldData, Len(ExceptFieldData) - Len(vbCrLf))
                     Else
                        ExceptFieldData = RTrim(ExceptFieldData)
                     End If
                     'end 2015/12/3
                  End If
               End With
            End If
         End If
      'add by nickc 2005/03/04 copy 自 信函抬頭名稱/英 因為要加代理人國籍
      Case "信函抬頭名稱和國籍/英"             '  含名稱不含地址  信函第二頁或 Return Sheet 用
         '以代理人抓FAGENT檔，若無代理人則以申請人抓客戶檔，列印出英文名稱
         strExc(1) = PUB_GetReceiver(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), m_CP10, m_SysKind)
         If strExc(1) <> "" Then
            strExc(0) = "SELECT FA05,FA63,FA64,FA65,na04,FA18,FA19,FA20,FA21,FA22," & _
                           "FA32,FA33,FA34,FA35,FA36 FROM FAGENT,nation WHERE " & ChgFagent(strExc(1)) & " and fa10=na01(+) "
            strExc(0) = strExc(0) & " Union SELECT CU05,CU88,CU89,CU90,na04,CU24,CU25,CU26,CU27,CU28||CU102," & _
                           "CU65,CU66,CU67,CU68,CU69 FROM CUSTOMER,nation WHERE " & ChgCustomer(strExc(1)) & " and cu10=na01(+) "
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               With RsTemp
                  For i = 0 To 4
                     If Not IsNull(.Fields(i)) Then ExceptFieldData = ExceptFieldData & .Fields(i) & vbCrLf
                  Next
                  If ExceptFieldData <> "" Then
                        ExceptFieldData = LeftB(ExceptFieldData, LenB(ExceptFieldData) - LenB(vbCrLf))
                  End If
               End With
            End If
         End If
        'End
        'Add By Cheng 2003/02/26
      Case "信函抬頭/日英"
         strExc(1) = PUB_GetReceiver(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), m_CP10, m_SysKind)
         If strExc(1) <> "" Then
            strExc(0) = "SELECT DECODE(CU06,NULL,CU05||' '||CU88||' '||CU89||' '||CU90,CU06),DECODE(CU29,NULL,CU24||' '||CU25||' '||CU26||' '||CU27||' '||CU28||' '||CU102,CU29) FROM CUSTOMER WHERE " & ChgCustomer(strExc(1))
            strExc(0) = strExc(0) & "UNION SELECT DECODE(FA06,NULL,FA05||' '||FA63||' '||FA64||' '||FA65,FA06),DECODE(FA23,NULL,FA18||' '||FA19||' '||FA20||' '||FA21||' '||FA22||' '||FA70,FA23) FROM FAGENT WHERE " & ChgFagent(strExc(1))
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               With RsTemp
                  If Not IsNull(.Fields(0)) Then ExceptFieldData = ExceptFieldData & .Fields(0)
               End With
            End If
         End If
      Case "信函抬頭/代"
         '以案件進度檔代理人抓FAGENT檔，列印出英文名稱及POB或地址
         strExc(0) = "SELECT CP44 FROM CASEPROGRESS WHERE CP09='" & m_Rule & "'"
        intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            'Modify by Morgan 2007/1/23 加FA70
            strExc(0) = "SELECT FA05,FA63,FA64,FA65,FA18,FA19,FA20,FA21,FA22," & _
               "FA32,FA33,FA34,FA35,FA36,FA70 FROM FAGENT WHERE " & ChgFagent("" & RsTemp.Fields(0))
         End If
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               With RsTemp
                  For i = 0 To 3
                     If Not IsNull(.Fields(i)) Then ExceptFieldData = ExceptFieldData & .Fields(i) & vbCrLf
                  Next
                  If .Fields(9) <> "" Or .Fields(10) <> "" Or .Fields(11) <> "" Or .Fields(12) <> "" Or .Fields(13) <> "" Then
                     For i = 9 To 13
                        If Not IsNull(.Fields(i)) Then ExceptFieldData = ExceptFieldData & .Fields(i) & vbCrLf
                     Next
                  Else
                     For i = 4 To 8
                        If Not IsNull(.Fields(i)) Then ExceptFieldData = ExceptFieldData & .Fields(i) & vbCrLf
                     Next
                     'Add by Morgan 2007/1/23 加地址6 FA70
                     i = 14
                     If Not IsNull(.Fields(i)) Then ExceptFieldData = ExceptFieldData & .Fields(i) & vbCrLf
                     'end 2007/1/23
                  End If
                  'Add By Cheng 2003/01/09
                  '拿掉字串後的換行符號
                  If ExceptFieldData <> "" Then
                        ExceptFieldData = LeftB(ExceptFieldData, LenB(ExceptFieldData) - LenB(vbCrLf))
                  End If
               End With
            End If
      Case "委任狀代表人"
         strExc(0) = "SELECT CU15,DECODE(PA79,NULL,'',PA79),DECODE(PA81,NULL,'',PA81) FROM PATENT,CUSTOMER " & _
            "WHERE " & PaSt & " AND SUBSTR(PA26,1,8)=CU01(+) AND SUBSTR(PA26,9,1)=CU02(+)"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            'Modify By Sindy 2012/5/24
            'If RsTemp.Fields(0) = "1" Then ExceptFieldData = "代表人" & RsTemp.Fields(1) & "，" & RsTemp.Fields(2)
            If RsTemp.Fields(0) <> "0" Then ExceptFieldData = "代表人" & RsTemp.Fields(1) & "，" & RsTemp.Fields(2)
         End If
      Case "相關總收文號案件性質/中"
         If m_MySt(6) = "000" Then
            strExc(1) = "CPM03"
         Else
            strExc(1) = "CPM04"
         End If
         strExc(0) = "SELECT " & strExc(1) & " FROM CASEPROPERTYMAP WHERE CPM01='" & m_MySt(1) & "' AND CPM02=(" & _
                     "SELECT CP10 FROM CASEPROGRESS WHERE CP09=" & "(SELECT CP43 FROM CASEPROGRESS WHERE CP09='" & m_Rule & "'))"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then If Not IsNull(RsTemp.Fields(0)) Then ExceptFieldData = RsTemp.Fields(0)
      Case "相關總收文號案件性質/英"
         strExc(0) = "SELECT CPM10 FROM CASEPROPERTYMAP WHERE CPM01='" & m_MySt(1) & "' AND CPM02=(" & _
                     "SELECT CP10 FROM CASEPROGRESS WHERE CP09=" & "(SELECT CP43 FROM CASEPROGRESS WHERE CP09='" & m_Rule & "'))"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then If Not IsNull(RsTemp.Fields(0)) Then ExceptFieldData = RsTemp.Fields(0)
      'Add by Morgan 2006/11/21
      Case "相關總收文號案件性質/日"
         strExc(0) = "SELECT CPM13 FROM CASEPROPERTYMAP WHERE CPM01='" & m_MySt(1) & "' AND CPM02=(" & _
                     "SELECT CP10 FROM CASEPROGRESS WHERE CP09=" & "(SELECT CP43 FROM CASEPROGRESS WHERE CP09='" & m_Rule & "'))"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then If Not IsNull(RsTemp.Fields(0)) Then ExceptFieldData = RTrim(RsTemp.Fields(0))
      Case "相關總收文號收文日"
         strExc(0) = "SELECT CP05 FROM CASEPROGRESS WHERE CP09=" & _
            "(SELECT CP43 FROM CASEPROGRESS WHERE CP09='" & m_Rule & "')"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then If Not IsNull(RsTemp.Fields(0)) Then ExceptFieldData = RsTemp.Fields(0)
'         'modify by sonia 2017/8/18 T-208838
'         If RsTemp.Fields(0) = 19221111 Then
'            MsgBox (m_MySt(1) & "-" & m_MySt(2) & "-" & m_MySt(3) & "-" & m_MySt(4) & " 因相關總收文號之收文日為 11/11/11，請自行修改定稿內容 !")
'         End If
'         'end 2017/8/18
      Case "相關總收文號機關文號"
         strExc(0) = "SELECT CP08 FROM CASEPROGRESS WHERE CP09=" & _
            "(SELECT CP43 FROM CASEPROGRESS WHERE CP09='" & m_Rule & "')"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then If Not IsNull(RsTemp.Fields(0)) Then ExceptFieldData = RsTemp.Fields(0)
      'Add By Sindy 2011/5/24
      Case "相關總收文號授權期間/起"
         strExc(0) = "SELECT CP53 FROM CASEPROGRESS WHERE CP09=" & _
            "(SELECT CP43 FROM CASEPROGRESS WHERE CP09='" & m_Rule & "')"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then If Not IsNull(RsTemp.Fields(0)) Then ExceptFieldData = RsTemp.Fields(0)
      'Add By Sindy 2011/5/24
      Case "相關總收文號授權期間/迄"
         strExc(0) = "SELECT CP54 FROM CASEPROGRESS WHERE CP09=" & _
            "(SELECT CP43 FROM CASEPROGRESS WHERE CP09='" & m_Rule & "')"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then If Not IsNull(RsTemp.Fields(0)) Then ExceptFieldData = RsTemp.Fields(0)
      'Add By Cheng 2002/06/17
      Case "相關總收文號被授權人"
         'Modify by Morgan 2008/7/20 改用CP72抓客戶檔資料
         'strExc(0) = "SELECT CP50||CP51||CP52 FROM CASEPROGRESS WHERE CP09=(SELECT CP43 FROM CASEPROGRESS WHERE CP09='" & m_Rule & "')"
         strExc(0) = "SELECT NVL(NVL(CU104,CU04),CU05||' '||CU88||' '||CU89||' '||CU90) FROM CASEPROGRESS,CUSTOMER" & _
            " WHERE CP09=(SELECT CP43 FROM CASEPROGRESS WHERE CP09='" & m_Rule & "') AND CU01(+)=SUBSTR(CP72,1,8) AND CU02(+)=SUBSTR(CP72,9)"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then If Not IsNull(RsTemp.Fields(0)) Then ExceptFieldData = RsTemp.Fields(0)
      'Add By Cheng 2003/01/02
      Case "相關總收文號主管機關"
         Select Case m_SysKind
         '93.5.24 ADD BY SONIA
         Case "1" '專利
            strExc(0) = "SELECT CF10 FROM CASEFEE,CASEPROGRESS,PATENT WHERE PA01=CP01 AND PA02=CP02 AND PA03=CP03 AND PA04=CP04 AND PA01=CF01 AND PA09=CF02 AND CP10=CF03  AND CP09=" & _
               "(SELECT CP43 FROM CASEPROGRESS WHERE CP09='" & m_Rule & "')"
         Case "2" '商標
            strExc(0) = "SELECT CF10 FROM CASEFEE,CASEPROGRESS,TRADEMARK WHERE TM01=CP01 AND TM02=CP02 AND TM03=CP03 AND TM04=CP04 AND TM01=CF01 AND TM10=CF02 AND CP10=CF03  AND CP09=" & _
               "(SELECT CP43 FROM CASEPROGRESS WHERE CP09='" & m_Rule & "')"
         End Select
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then If Not IsNull(RsTemp.Fields(0)) Then ExceptFieldData = RsTemp.Fields(0)
      Case "母案專利號數"
         '92.1.25 modify by sonia
         'strExc(0) = "SELECT PA22 FROM PATENT WHERE PA01='" & m_MySt(1) & "' AND " & _
         '   "PA02='" & m_MySt(2) & "' AND PA03='0' AND PA04='00'"
         'Modify by Morgan 2010/12/28 申請案號改碼數
         strExc(0) = "SELECT PA22 FROM PATENT WHERE PA01='" & m_MySt(1) & "' AND PA11 = ( " & _
            "SELECT SUBSTR(PA11,1,9) FROM PATENT WHERE PA01='" & m_MySt(1) & "' AND " & _
            "PA02='" & m_MySt(2) & "' AND PA03='" & m_MySt(3) & "' AND PA04='" & m_MySt(4) & "')"
         '92.1.25 end
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then If Not IsNull(RsTemp.Fields(0)) Then ExceptFieldData = RsTemp.Fields(0)
      Case "母案申請案號"
         '92.1.25 modify by sonia
         'strExc(0) = "SELECT PA11 FROM PATENT WHERE PA01='" & m_MySt(1) & "' AND " & _
         '   "PA02='" & m_MySt(2) & "' AND PA03='0' AND PA04='00'"
         'Modify by Morgan 2010/12/28 申請案號改碼數
         strExc(0) = "SELECT PA11 FROM PATENT WHERE PA01='" & m_MySt(1) & "' AND PA11 = ( " & _
            "SELECT SUBSTR(PA11,1,9) FROM PATENT WHERE PA01='" & m_MySt(1) & "' AND " & _
            "PA02='" & m_MySt(2) & "' AND PA03='" & m_MySt(3) & "' AND PA04='" & m_MySt(4) & "')"
         '92.1.25 end
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then If Not IsNull(RsTemp.Fields(0)) Then ExceptFieldData = RsTemp.Fields(0)

      'Modified by Morgan 2018/8/21 +前案專利號數
      Case "前案申請案號", "前案專利號數"
         strExc(0) = "SELECT PA11,PA22 FROM PATENT WHERE PA01='" & m_MySt(1) & "' AND " & _
            "PA02='" & m_MySt(2) & "' AND PA03='0' AND PA04='00'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If strField = "前案專利號數" Then
               ExceptFieldData = "" & RsTemp.Fields("PA22")
            Else
               ExceptFieldData = "" & RsTemp.Fields("PA11")
            End If
         End If
      'add by nickc 2007/07/24
      Case "商彼所案號/客戶案號"
         strExc(0) = "SELECT tm44,tm45,tm23,tm35 FROM TRADEMARK WHERE tm01='" & m_MySt(1) & "' and tm02='" & m_MySt(2) & "' and tm03='" & m_MySt(3) & "' and tm04='" & m_MySt(4) & "' "
         If strExc(0) <> "" Then
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               If Not IsNull(RsTemp.Fields(0)) Then
                  ExceptFieldData = "" & RsTemp.Fields(1).Value
               ElseIf Not IsNull(RsTemp.Fields(2)) Then
                ExceptFieldData = "" & RsTemp.Fields(3).Value
               Else
                  ExceptFieldData = ""
               End If
            End If
         End If
         
        'Add By Cheng 2004/03/10
      Case "彼所案號"
                  
         Select Case m_SysKind
            Case 1 '專利
                '2005/5/3 MODIFY BY SONIA 加入"1605"
                If m_CP10 = "605" Or m_CP10 = "1605" Then
                    '若基本檔有年費代理人時, 彼所案號抓年費彼所案號, 若無年費代理人, 則抓彼所案號
                    strExc(0) = "SELECT Decode(PA76, Null, PA77, PA106) FROM PATENT WHERE " & PaSt
                Else
                    strExc(0) = "SELECT PA77 FROM PATENT WHERE " & PaSt
                End If
            'Add by Morgan 2007/4/10
            Case 2 '商標
               '2009/12/10 MODIFY BY SONIA 延展有延展代理人時,彼所案號抓延展彼所案號, 若無延展代理人, 則抓彼所案號
               'strExc(0) = "SELECT tm45 FROM TRADEMARK WHERE tm01='" & m_MySt(1) & "' and tm02='" & m_MySt(2) & "' and tm03='" & m_MySt(3) & "' and tm04='" & m_MySt(4) & "' "
               If m_CP10 = "102" Then
                  'Modify By Sindy 2010/3/4 延展有延展代理人時,彼所案號抓延展彼所案號, 若無延展代理人, 則抓彼所案號
                  'strExc(0) = "SELECT TM65 FROM TRADEMARK WHERE tm01='" & m_MySt(1) & "' and tm02='" & m_MySt(2) & "' and tm03='" & m_MySt(3) & "' and tm04='" & m_MySt(4) & "' "
                  strExc(0) = "SELECT TM33 FROM TRADEMARK WHERE tm01='" & m_MySt(1) & "' and tm02='" & m_MySt(2) & "' and tm03='" & m_MySt(3) & "' and tm04='" & m_MySt(4) & "' "
                  intI = 1
                  Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
                  If intI = 1 Then
                     If Not IsNull(RsTemp.Fields(0)) Then
                        strExc(0) = "SELECT TM65 FROM TRADEMARK WHERE tm01='" & m_MySt(1) & "' and tm02='" & m_MySt(2) & "' and tm03='" & m_MySt(3) & "' and tm04='" & m_MySt(4) & "' "
                     Else
                        strExc(0) = "SELECT TM45 FROM TRADEMARK WHERE tm01='" & m_MySt(1) & "' and tm02='" & m_MySt(2) & "' and tm03='" & m_MySt(3) & "' and tm04='" & m_MySt(4) & "' "
                     End If
                  End If
                  '2010/3/4 End
               Else
                  strExc(0) = "SELECT tm45 FROM TRADEMARK WHERE tm01='" & m_MySt(1) & "' and tm02='" & m_MySt(2) & "' and tm03='" & m_MySt(3) & "' and tm04='" & m_MySt(4) & "' "
               End If
               '2009/12/10 END
            Case 3
               strExc(0) = "SELECT lc23 FROM lawcase WHERE " & LcSt
            Case Else
               strExc(0) = ""
               ExceptFieldData = ""
         End Select
         If strExc(0) <> "" Then
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               If Not IsNull(RsTemp.Fields(0)) Then
                  ExceptFieldData = "" & RsTemp.Fields(0).Value
               Else
                  ExceptFieldData = ""
               End If
            End If
         End If
        'End
      'Add By Cheng 2003/01/24
      Case "母案彼所案號"
         '92.1.25 modify by sonia
         'strExc(0) = "SELECT PA77 FROM PATENT WHERE PA01='" & m_MySt(1) & "' AND " & _
         '   "PA02='" & m_MySt(2) & "' AND PA03='0' AND PA04='00'"
         'Modify by Morgan 2010/12/28 申請案號改碼數
         strExc(0) = "SELECT PA77 FROM PATENT WHERE PA01='" & m_MySt(1) & "' AND PA11 = ( " & _
            "SELECT SUBSTR(PA11,1,9) FROM PATENT WHERE PA01='" & m_MySt(1) & "' AND " & _
            "PA02='" & m_MySt(2) & "' AND PA03='" & m_MySt(3) & "' AND PA04='" & m_MySt(4) & "')"
         '92.1.25 end
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then If Not IsNull(RsTemp.Fields(0)) Then ExceptFieldData = RsTemp.Fields(0)
      '91.12.29 add by sonia
      Case "母案專用期起日"
         '92.1.25 modify by sonia
         'strExc(0) = "SELECT PA24 FROM PATENT WHERE PA01='" & m_MySt(1) & "' AND " & _
         '   "PA02='" & m_MySt(2) & "' AND PA03='0' AND PA04='00'"
         'Modify by Morgan 2010/12/28 申請案號改碼數
         strExc(0) = "SELECT PA24 FROM PATENT WHERE PA01='" & m_MySt(1) & "' AND PA11 = ( " & _
            "SELECT SUBSTR(PA11,1,9) FROM PATENT WHERE PA01='" & m_MySt(1) & "' AND " & _
            "PA02='" & m_MySt(2) & "' AND PA03='" & m_MySt(3) & "' AND PA04='" & m_MySt(4) & "')"
         '92.1.25 end
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then If Not IsNull(RsTemp.Fields(0)) Then ExceptFieldData = RsTemp.Fields(0)
      Case "母案專用期止日"
         '92.1.25 modify by sonia
         'strExc(0) = "SELECT PA25 FROM PATENT WHERE PA01='" & m_MySt(1) & "' AND " & _
         '   "PA02='" & m_MySt(2) & "' AND PA03='0' AND PA04='00'"
         'Modify by Morgan 2010/12/28 申請案號改碼數
         strExc(0) = "SELECT PA25 FROM PATENT WHERE PA01='" & m_MySt(1) & "' AND PA11 = ( " & _
            "SELECT SUBSTR(PA11,1,9) FROM PATENT WHERE PA01='" & m_MySt(1) & "' AND " & _
            "PA02='" & m_MySt(2) & "' AND PA03='" & m_MySt(3) & "' AND PA04='" & m_MySt(4) & "')"
         '92.1.25 end
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then If Not IsNull(RsTemp.Fields(0)) Then ExceptFieldData = RsTemp.Fields(0)
      '92.1.25 add by sonia
      Case "母案發證日"
         'Modify by Morgan 2010/12/28 申請案號改碼數
         strExc(0) = "SELECT PA21 FROM PATENT WHERE PA01='" & m_MySt(1) & "' AND PA11 = ( " & _
            "SELECT SUBSTR(PA11,1,9) FROM PATENT WHERE PA01='" & m_MySt(1) & "' AND " & _
            "PA02='" & m_MySt(2) & "' AND PA03='" & m_MySt(3) & "' AND PA04='" & m_MySt(4) & "')"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then If Not IsNull(RsTemp.Fields(0)) Then ExceptFieldData = RsTemp.Fields(0)
      '92.1.25 end
      '2009/8/19 ADD BY SONIA 若為母案則抓本身之申請日,若為分割或接續案則抓母案之申請日
      Case "母案申請日"
         If m_MySt(3) <> "0" Then '接續案
            strExc(0) = "SELECT PA10 FROM PATENT WHERE PA01='" & m_MySt(1) & "' AND " & _
               "PA02='" & m_MySt(2) & "' AND PA03='0' AND PA04='" & m_MySt(4) & "'"
         Else
            '先判斷是否為分割案
            strExc(0) = "SELECT DC05,DC06,DC07,DC08 FROM DivisionCase WHERE DC01='" & m_MySt(1) & "' and DC02='" & m_MySt(2) & "' and DC03='" & m_MySt(3) & "' and DC04='" & m_MySt(4) & "' "
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
            If intI = 1 Then  '分割案
               strExc(0) = "SELECT PA10 FROM PATENT WHERE PA01='" & RsTemp.Fields(0) & "' AND " & _
                  "PA02='" & RsTemp.Fields(1) & "' AND PA03='" & RsTemp.Fields(2) & "' AND PA04='" & RsTemp.Fields(3) & "'"
            Else
               strExc(0) = "SELECT PA10 FROM PATENT WHERE PA01='" & m_MySt(1) & "' AND " & _
                  "PA02='" & m_MySt(2) & "' AND PA03='" & m_MySt(3) & "' AND PA04='" & m_MySt(4) & "'"
            End If
         End If
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then If Not IsNull(RsTemp.Fields(0)) Then ExceptFieldData = RsTemp.Fields(0)
      '2009/8/19 END
      'add by nickc 2007/12/21 雙署名
      Case "母案繳費年度"
         'Modify by Morgan 2010/12/28 申請案號改碼數
         strExc(0) = "SELECT PA08,PA09,PA72 FROM PATENT WHERE PA01='" & m_MySt(1) & "' AND PA11 = ( " & _
            "SELECT SUBSTR(PA11,1,9) FROM PATENT WHERE PA01='" & m_MySt(1) & "' AND " & _
            "PA02='" & m_MySt(2) & "' AND PA03='" & m_MySt(3) & "' AND PA04='" & m_MySt(4) & "')"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then

            If IsNull(RsTemp.Fields("PA08")) = False Then strPA08 = RsTemp.Fields("PA08")
            If IsNull(RsTemp.Fields("PA09")) = False Then strPA09 = RsTemp.Fields("PA09")
            If IsNull(RsTemp.Fields("PA72")) = False Then strPA72 = RsTemp.Fields("PA72")
            strKey(0) = ""
            strKey(1) = m_MySt(1)
            strKey(2) = m_MySt(2)
            strKey(3) = m_MySt(3)
            strKey(4) = m_MySt(4)
            bFind = GetMoneyDate(strPA08, strPA09, strKey, strCaseFee(1), strCaseFee(2))
            If bFind Then
                'Modify By Cheng 2003/01/27
                '取消變數定義
'               Dim nPos As Integer
               ' 尋找下次繳年費的位置
               If IsEmptyText(strPA72) = False Then
                  varPA72 = Split(strPA72, ",")
                  For nPos = 0 To UBound(varPA72)
                     If IsEmptyText(varPA72(nPos)) = True Then
                        nPos = nPos - 1
                        Exit For
                     End If
                  Next nPos
                  If IsEmptyText(varPA72(UBound(varPA72))) = False Then
                     nPos = UBound(varPA72)
                  End If
                  If nPos < 0 Then
                     nPos = 0
                  End If
               Else
                  nPos = 0
               End If
               ' 目前所取得的nPos即是下次繳年費的位置
               
               ' 取得正確的年度
               If IsEmptyText(strCaseFee(2)) = False Then
                  varRef = Split(strCaseFee(2), ",")
                  If nPos <= UBound(varRef) Then
                     ExceptFieldData = varRef(nPos)
                  End If
               End If
            End If
         
         End If
      Case "雙署名"
         '2008/10/29 MODIFY BY SONIA 移至PUB_GetCompany
         ExceptFieldData = PUB_GetCompany(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4))
      Case "相關總收文號規費"
         strExc(0) = "SELECT CP17 FROM CASEPROGRESS WHERE CP09=" & _
            "(SELECT CP43 FROM CASEPROGRESS WHERE CP09='" & m_Rule & "')"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then If Not IsNull(RsTemp.Fields(0)) Then ExceptFieldData = RsTemp.Fields(0)
      Case "相關總收文號發文日"
         strExc(0) = "SELECT CP27 FROM CASEPROGRESS WHERE CP09=" & _
            "(SELECT CP43 FROM CASEPROGRESS WHERE CP09='" & m_Rule & "')"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then If Not IsNull(RsTemp.Fields(0)) Then ExceptFieldData = RsTemp.Fields(0)
'         'modify by sonia 2017/8/18 T-208838
'         If RsTemp.Fields(0) = 19221111 Then
'            MsgBox (m_MySt(1) & "-" & m_MySt(2) & "-" & m_MySt(3) & "-" & m_MySt(4) & " 因相關總收文號之發文日為 11/11/11，請自行修改定稿內容 !")
'         End If
'         'end 2017/8/18

      'Add By Sindy 2020/10/21
      Case "承辦人分機"
         strExc(0) = "SELECT cp09,cp10,cp14,cp17,cp110,ed01,cp08 FROM CASEPROGRESS,ExtensionData " & _
                          "WHERE CP09='" & m_Rule & "' and cp14=ed02(+)"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then If Not IsNull(RsTemp.Fields("ed01")) Then ExceptFieldData = RsTemp.Fields("ed01")
         
      'Add By Sindy 2009/09/17
      Case "承辦人專業代號"
         'Modified by Lydia 2019/03/22 FCT向智慧局提出之各式申請書上之分機號碼,請將日本區設定為011國家檔管制人分機
         'strExc(0) = "SELECT ST07 FROM CASEPROGRESS,staff WHERE CP09='" & m_Rule & "' and CP14=ST01(+) "
         strExc(0) = "SELECT ST07,CP01,TM44,FA10 FROM CASEPROGRESS,staff,trademark,fagent " & _
                          "WHERE CP09='" & m_Rule & "' and CP14=ST01(+) and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+) and substr(tm44,1,8)=fa01(+) and substr(tm44,9,1)=fa02(+) "
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then If Not IsNull(RsTemp.Fields(0)) Then ExceptFieldData = RsTemp.Fields(0)
         'Added by Lydia 2019/03/22 FCT向智慧局提出之各式申請書上之分機號碼,請將日本區設定為011國家檔管制人分機
         If RsTemp.Fields("CP01") = "FCT" And Left("" & RsTemp.Fields("FA10"), 3) = "011" Then
              strExc(0) = "select st01,st07 from nation, staff where na01='011' and na55=st01(+) "
              intI = 1
              Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
              If intI = 1 Then
                 If "" & RsTemp.Fields("st07") <> "" Then ExceptFieldData = "" & RsTemp.Fields("st07")
              End If
         End If
         'end 2019/03/22
      '2009/09/17 End
      'Modified by Morgan 2013/7/8
      Case "管制人專業代號", "FCP管制人分機"
         Select Case m_SysKind
            Case 1 '專利
               strExc(0) = "SELECT PA75,PA26 FROM PATENT WHERE " & PaSt
            Case 2 '商標
               strExc(0) = "SELECT TM44,TM23 FROM TRADEMARK WHERE " & TmSt
            'Modify by Morgan 2003/12/30
            'Case 4 '顧問
            Case 5, 6
               strExc(0) = "SELECT SP26,SP08 FROM SERVICEPRACTICE WHERE " & SpSt
         End Select
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If IsNull(RsTemp.Fields(0)) Or RsTemp.Fields(0) = "" Then

'edit by nick 2004/12/17
'               strExc(0) = "SELECT ST07 FROM CUSTOMER,NATION,STAFF WHERE " & ChgCustomer("" & rsTemp.Fields(1)) & " AND " & _
'                  "CU10=NA01 AND NA16=ST01"
                  Select Case m_SysKind
                   Case 1 '專利
                        strExc(0) = "SELECT ST07 FROM CUSTOMER,NATION,STAFF WHERE " & ChgCustomer("" & RsTemp.Fields(1)) & " AND " & _
                           "CU10=NA01 AND NA16=ST01"
                  Case 2 '商標
                        strExc(0) = "SELECT ST07 FROM CUSTOMER,NATION,STAFF WHERE " & ChgCustomer("" & RsTemp.Fields(1)) & " AND " & _
                           "CU10=NA01 AND NA55=ST01"
                  Case 5, 6
                        strExc(0) = "SELECT ST07 FROM CUSTOMER,NATION,STAFF WHERE " & ChgCustomer("" & RsTemp.Fields(1)) & " AND " & _
                           "CU10=NA01 AND NA16=ST01"
                  End Select
            Else

'edit by nick 2004/12/17
'               strExc(0) = "SELECT ST07 FROM FAGENT,NATION,STAFF WHERE " & ChgFagent("" & rsTemp.Fields(0)) & " AND " & _
'                  "FA10=NA01 AND NA16=ST01"
                  Select Case m_SysKind
                   Case 1 '專利
                        strExc(0) = "SELECT ST07 FROM FAGENT,NATION,STAFF WHERE " & ChgFagent("" & RsTemp.Fields(0)) & " AND " & _
                           "FA10=NA01 AND NA16=ST01"
                  Case 2 '商標
                        strExc(0) = "SELECT ST07 FROM FAGENT,NATION,STAFF WHERE " & ChgFagent("" & RsTemp.Fields(0)) & " AND " & _
                           "FA10=NA01 AND NA55=ST01"
                  Case 5, 6
                        strExc(0) = "SELECT ST07 FROM FAGENT,NATION,STAFF WHERE " & ChgFagent("" & RsTemp.Fields(0)) & " AND " & _
                           "FA10=NA01 AND NA16=ST01"
                  End Select
            End If
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
            If intI = 1 Then If Not IsNull(RsTemp.Fields(0)) Then ExceptFieldData = RsTemp.Fields(0).Value
            
            'Added by Morgan 2013/7/8
            If strField = "FCP管制人分機" And ExceptFieldData <> "" Then
               ExceptFieldData = PUB_chgWord2Num(ExceptFieldData)
            End If
         End If
      Case "操作程序專業代號"
         If g_UserNum <> "" Then
            strExc(0) = "SELECT ST07 FROM STAFF WHERE ST01='" & g_UserNum & "'"
         Else
            strExc(0) = "SELECT ST07 FROM STAFF WHERE ST01='" & strUserNum & "'"
         End If
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If IsNull(RsTemp.Fields(0).Value) Then
               ExceptFieldData = "　"
            Else
               'Modify By Sindy 2021/11/11 因為外商林靖傑A6015現在有承辦商標的爭議案，但因他個人在外商的國內專業代號為609(ST07)，
               '在內商的國內專業代號為「商8」，若案件性質為爭議案時改用「商8」的國內專業代號。
               'Modify By Sindy 2025/7/30 FCT案727分析不屬於爭議案 + FCT_NotTMdebate
               If InStr(TMdebate, m_CP10) > 0 And Not (m_MySt(1) = "FCT" And InStr(FCT_NotTMdebate, m_CP10) > 0) And RsTemp.Fields(0).Value = "609" Then
                  ExceptFieldData = "商8"
               Else
               '2021/11/11 END
                  ExceptFieldData = RsTemp.Fields(0).Value
               End If
            End If
         End If
      '2005/8/16 ADD BY SONIA
      'Modified by Morgan 2024/3/28 +專業代號/國外
      Case "操作程序專業代號/國外", "專業代號/國外"
         'Modify by Morgan 2007/1/25 啟動就抓過了不必重抓
         'strExc(0) = "SELECT ST17 FROM STAFF WHERE ST01='" & strUserNum & "'"
         'intI = 1
         'Set rsTemp = clslawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         'If intI = 1 Then
         '   If IsNull(rsTemp.Fields(0).Value) Then
         '      ExceptFieldData = "　"
         '   Else
         '      ExceptFieldData = rsTemp.Fields(0).Value
         '   End If
         'End If
         ExceptFieldData = Pub_StrUserSt17
         'end 2007/1/25
      '2005/8/16 END
      Case "(專利號數/CFP)"
         strExc(0) = "SELECT PA11,PA22 FROM PATENT WHERE " & PaSt
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If Not IsNull(RsTemp.Fields(1)) Then
               ExceptFieldData = "No. " & RsTemp.Fields(1).Value
            ElseIf Not IsNull(RsTemp.Fields(0)) Then
               ExceptFieldData = "Application No. " & RsTemp.Fields(0).Value
            Else
               ExceptFieldData = "Application"
            End If
         End If
        'Add By Cheng 2003/01/30
      Case "(專利號數/FCP)"
         strExc(0) = "SELECT PA11,PA22 FROM PATENT WHERE " & PaSt
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If Not IsNull(RsTemp.Fields(1)) Then
               ExceptFieldData = "Patent No. " & RsTemp.Fields(1).Value
            ElseIf Not IsNull(RsTemp.Fields(0)) Then
               ExceptFieldData = "Application No. " & RsTemp.Fields(0).Value
            Else
               ExceptFieldData = "Application"
            End If
         End If
      Case "(專利號數)"
         strExc(0) = "SELECT PA22 FROM PATENT WHERE " & PaSt & " AND PA22 IS NOT NULL"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then ExceptFieldData = "(專利權第" & RsTemp.Fields(0).Value & "號)"
      Case "(專利號數/英)"
         strExc(0) = "SELECT PA22 FROM PATENT WHERE " & PaSt & " AND PA22 IS NOT NULL"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then ExceptFieldData = "(Patent No. " & RsTemp.Fields(0).Value & ")"
      '91.12.10 ADD BY SONIA
      Case "商標狀況"
            'Modify By Cheng 2003/01/23
            '卷宗性質為1申請時(本所案-->基本檔抓號數), 有發證日為"註冊", 若無但有審定號為"審定"(93/1/7改為註冊,94/6/23再判斷准為"註冊"駁為"核駁"), 若無則為"申請"
            '卷宗性質不為1 時(非本所案-->進度檔抓號數), 卷宗性質2異議為"審定", 卷宗性質3評定或4舉發為"註冊"
'         '有發證日為註冊, 無發證日有審定號為審定, 卷宗性質為評定或廢止時為審定, 其他均為申請
         strExc(0) = "SELECT TM15,TM20,TM28,TM16 FROM TRADEMARK WHERE " & TmSt
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            '卷宗性質為申請
            If "" & RsTemp.Fields(2).Value = "1" Then
                If Not IsNull(RsTemp.Fields(1)) Then
                   ExceptFieldData = "註冊"
                ElseIf Not IsNull(RsTemp.Fields(0)) Then
                    'Modify By Cheng 2004/01/07
                    '將審定改為註冊
'                   ExceptFieldData = "審定"
                    '2005/6/23 MODIFY BY SONIA 加判斷准駁
                    'ExceptFieldData = "註冊"
                    If Not IsNull(RsTemp.Fields(3)) Then
                       If RsTemp.Fields(3) = "1" Then
                          ExceptFieldData = "註冊"
                       Else
                          ExceptFieldData = "核駁"
                       End If
                    Else
                       ExceptFieldData = "申請"
                    End If
                    '2005/6/23 END
                    'End
                Else
                   ExceptFieldData = "申請"
                End If
            '卷宗性質為異議
            ElseIf "" & RsTemp.Fields(2).Value = "2" Then
                'Modify By Cheng 2004/01/07
                '將審定改為註冊
'                ExceptFieldData = "審定"
                ExceptFieldData = "註冊"
                'End
            '卷宗性質為評定, 舉發
            Else
                ExceptFieldData = "註冊"
            End If
         End If
         
      'Add by Morgan 2006/2/13
      Case "商標號數/英"
         '審定號-->申請號
         strExc(0) = "SELECT TM15,TM12 FROM TRADEMARK WHERE " & TmSt
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            '審定號
            If Not IsNull(RsTemp("TM15")) Then
               ExceptFieldData = "Registration No. " & RsTemp("TM15")
            '申請號
            Else
               ExceptFieldData = "Application No. " & RsTemp("TM12")
            End If
         End If
         
      'Add By Cheng 2004/03/17
      Case "(商標號數標題)"
         'modify by sonia 2019/5/15 +TM16以判斷核駁號
         strExc(0) = "SELECT TM12,TM15,TM16 FROM TRADEMARK WHERE " & TmSt
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            'add by sonia 2019/5/15 +TM16以判斷核駁號 T-213068
            If "" & RsTemp.Fields("TM16") = "2" Then
               ExceptFieldData = "核駁號"
            'end 2019/5/15
            ElseIf Not IsNull(RsTemp.Fields(1)) Then
               ExceptFieldData = "註冊號"
            Else
               ExceptFieldData = "申請案號"
            End If
         End If
        'End
      Case "(商標號數)"
         strExc(0) = "SELECT TM12,TM15 FROM TRADEMARK WHERE " & TmSt
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If Not IsNull(RsTemp.Fields(1)) Then
               ExceptFieldData = RsTemp.Fields(1).Value
            ElseIf Not IsNull(RsTemp.Fields(0)) Then
               ExceptFieldData = RsTemp.Fields(0).Value
            End If
         End If
         '91.12.10 END
        'Add By Cheng 2002/12/27
      Case "客戶案件案號"
         Select Case m_SysKind
            Case 1 '專利
               strExc(0) = "SELECT PA48 FROM PATENT WHERE " & PaSt
            'Add by Morgan 2003/12/30
            Case 2 '商標
               strExc(0) = "SELECT TM35,TM23 FROM TRADEMARK WHERE " & TmSt
            Case 3 '法務
               strExc(0) = "SELECT LC17,TM23 FROM LAWCASE WHERE " & LcSt
            Case 4 '顧問
               strExc(0) = "SELECT NULL FROM HIRECASE WHERE " & HcSt
            Case 5, 6   '服務
               strExc(0) = "SELECT SP29 FROM SERVICEPRACTICE WHERE " & SpSt
            'Add end---------
         End Select
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If Not IsNull(RsTemp.Fields(0)) Then
               'Modify by Morgan 2011/6/22
               'ExceptFieldData = "Case No : " & RsTemp.Fields(0).Value
               ExceptFieldData = "Case No: " & RsTemp.Fields(0).Value
            Else
               ExceptFieldData = ""
            End If
         End If
      'Add by Morgan 2006/8/1
      Case "客戶案件案號/日"
         Select Case m_SysKind
            Case 1 '專利
               strExc(0) = "SELECT PA48 FROM PATENT WHERE " & PaSt
            Case 2 '商標
               strExc(0) = "SELECT TM35,TM23 FROM TRADEMARK WHERE " & TmSt
            Case 3 '法務
               strExc(0) = "SELECT LC17,TM23 FROM LAWCASE WHERE " & LcSt
            Case 4 '顧問
               strExc(0) = "SELECT NULL FROM HIRECASE WHERE " & HcSt
            Case 5, 6   '服務
               strExc(0) = "SELECT SP29 FROM SERVICEPRACTICE WHERE " & SpSt
         End Select
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If Not IsNull(RsTemp.Fields(0)) Then
               ExceptFieldData = RsTemp.Fields(0).Value
            Else
               ExceptFieldData = ""
            End If
         End If
         
        'Modify By Cheng 2003/12/22
      '若有聯絡人2英==>聯絡人1英 and 聯絡人2英
      Case "聯絡人1/英"
         Select Case m_SysKind
            Case 1 '專利
                '2005/5/3 MODIFY BY SONIA 加入"1605"
                If m_CP10 = "605" Or m_CP10 = "1605" Then
                  'Modify by Morgan 2006/5/16 年費聯絡人新規則：
'                  '若基本檔有年費代理人時, 聯絡人抓年費聯絡人, 否則抓聯絡人1/英(若有聯絡人2英時==>聯絡人1英||聯絡2英)
'                  strExc(0) = "SELECT Decode(PA76, Null, Decode(PA52, Null, Decode(FA08, Null, Decode(CU59, Null, '', CU59||Decode(CU62, Null, '', ' and '||CU62)),FA08||Decode(FA53, Null, '', ' and '||FA53)), PA52||Decode(PA55, Null, '', ' and '||PA55)), PA135) FROM PATENT, Fagent, Customer WHERE " & PaSt & _
'                     " And substr(PA75,1,8)=FA01(+) And substr(PA75,9,1)=FA02(+) And substr(PA26,1,8)=CU01(+) And substr(PA26,9,1)=CU02(+) "
                  '1.基本檔有年費代理人(PA76)時, 抓年費聯絡人(PA135)
                  '2.客戶檔有年費代理人(CU96)時, 抓年費聯絡人(CU113)
                  '3.參照一般聯絡人規則
'                  strExc(0) = "SELECT Decode(PA76, Null,Decode(CU96,Null, Decode(PA52, Null, Decode(FA08, Null, Decode(CU59, Null, '', CU59||Decode(CU62, Null, '', ' and '||CU62)),FA08||Decode(FA53, Null, '', ' and '||FA53)), PA52||Decode(PA55, Null, '', ' and '||PA55)),CU113), PA135) FROM PATENT, Fagent, Customer WHERE " & PaSt & _
'                     " And substr(PA75,1,8)=FA01(+) And substr(PA75,9,1)=FA02(+) And substr(PA26,1,8)=CU01(+) And substr(PA26,9,1)=CU02(+) "
                  ExceptFieldData = ExceptFieldData("年費聯絡人") 'Add By Sindy 2017/6/22 FCP-032342 一致的抓取
                  Exit Function
                Else
                    'Modify By Cheng 2003/12/22
                    '若有聯絡人1英且有聯絡人2英時==>聯絡人1英 and 聯絡2英
'                    strExc(0) = "SELECT Nvl(PA52, Nvl(FA08, CU59)) FROM PATENT, Fagent, Customer WHERE " & PaSt & _
'                                    " And substr(PA75,1,8)=FA01(+) And substr(PA75,9,1)=FA02(+) And substr(PA26,1,8)=CU01(+) And substr(PA26,9,1)=CU02(+) "
                    strExc(0) = "SELECT Decode(PA52, Null, Decode(FA08, Null, Decode(CU59, Null, '', CU59||Decode(CU62, Null, '', ' and '||CU62)),FA08||Decode(FA53, Null, '', ' and '||FA53)), PA52||Decode(PA55, Null, '', ' and '||PA55)) FROM PATENT, Fagent, Customer WHERE " & PaSt & _
                                    " And substr(PA75,1,8)=FA01(+) And substr(PA75,9,1)=FA02(+) And substr(PA26,1,8)=CU01(+) And substr(PA26,9,1)=CU02(+) "
                    'End
                End If
            Case 2 '商標
                If m_CP10 = "102" Then
                    '若基本檔有延展代理人時, 聯絡人抓年費聯絡人, 否則抓聯絡人1/英
                    'Modify By Cheng 2003/12/22
                    '若有聯絡人1英且有聯絡人2英時==>聯絡人1英 and 聯絡2英
'                    strExc(0) = "SELECT Decode(TM33, Null, Nvl(TM39, Nvl(FA08, CU59)), TM71) FROM Trademark, Fagent, Customer WHERE " & TmSt & _
'                                    " And substr(TM44,1,8)=FA01(+) And substr(TM44,9,1)=FA02(+) And substr(TM23,1,8)=CU01(+) And substr(TM23,9,1)=CU02(+) "
                    strExc(0) = "SELECT Decode(TM33, Null, Decode(TM39, Null, Decode(FA08, Null, Decode(CU59, Null, '', CU59||Decode(CU62, Null, '', ' and '||CU62)),FA08||Decode(FA53, Null, '', ' and '||FA53)), TM39||Decode(TM42, Null, '', ' and '||TM42)), TM71) FROM Trademark, Fagent, Customer WHERE " & TmSt & _
                                    " And substr(TM44,1,8)=FA01(+) And substr(TM44,9,1)=FA02(+) And substr(TM23,1,8)=CU01(+) And substr(TM23,9,1)=CU02(+) "
                    'End
                Else
                    'Modify By Cheng 2003/12/22
                    '若有聯絡人1英且有聯絡人2英時==>聯絡人1英 and 聯絡2英
'                    strExc(0) = "SELECT Nvl(TM39, Nvl(FA08, CU59)) FROM Trademark, Fagent, Customer WHERE " & TmSt & _
'                                    " And substr(TM44,1,8)=FA01(+) And substr(TM44,9,1)=FA02(+) And substr(TM23,1,8)=CU01(+) And substr(TM23,9,1)=CU02(+) "
                    strExc(0) = "SELECT Decode(TM39, Null, Decode(FA08, Null, Decode(CU59, Null, '', CU59||Decode(CU62, Null, '', ' and '||CU62)),FA08||Decode(FA53, Null, '', ' and '||FA53)), TM39||Decode(TM42, Null, '', ' and '||TM42)) FROM Trademark, Fagent, Customer WHERE " & TmSt & _
                                    " And substr(TM44,1,8)=FA01(+) And substr(TM44,9,1)=FA02(+) And substr(TM23,1,8)=CU01(+) And substr(TM23,9,1)=CU02(+) "
                    'End
                End If
         End Select
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If Not IsNull(RsTemp.Fields(0)) Then
               'Modify by Morgan 2011/6/22
               'ExceptFieldData = "Attn : " & RsTemp.Fields(0).Value
               ExceptFieldData = "Attn: " & RsTemp.Fields(0).Value
            Else
               ExceptFieldData = ""
            End If
         End If
        'Add By Cheng 2004/03/23
      Case "聯絡人1/日"
         Select Case m_SysKind
            Case 1 '專利
                '2005/5/3 MODIFY BY SONIA 加入"1605"
                If m_CP10 = "605" Or m_CP10 = "1605" Then
                    'Modify by Morgan 2006/5/16 年費聯絡人新規則：
'                    '若基本檔有年費代理人時, 聯絡人抓年費聯絡人, 否則抓聯絡人1/日及聯絡人2/日
'                    strExc(0) = "SELECT Decode(PA76, Null, Decode(PA53, Null, Decode(FA09, Null, Decode(CU60, Null, '', CU60||Decode(CU63, Null, '', CHR(13)||CU63)),FA09||Decode(FA54, Null, '', CHR(13)||FA54)), PA53||Decode(PA56, Null, '', CHR(13)||PA56)), PA135) FROM PATENT, Fagent, Customer WHERE " & PaSt & _
'                                    " And substr(PA75,1,8)=FA01(+) And substr(PA75,9,1)=FA02(+) And substr(PA26,1,8)=CU01(+) And substr(PA26,9,1)=CU02(+) "
                    '1.基本檔有年費代理人(PA76)時, 抓年費聯絡人(PA135)
                    '2.客戶檔有年費代理人(CU96)時, 抓年費聯絡人(CU113)
                    '3.參照一般聯絡人規則
                    'Modify by Morgan 2006/10/16 加日文聯絡人部門
                    strExc(0) = "SELECT Decode(PA76, Null,Decode(CU96,Null, Decode(PA53, Null, Decode(FA09, Null, Decode(CU60, Null, '', DECODE(CU114,NULL,NULL,CU114||CHR(13))||CU60||Decode(CU63, Null, '', CHR(13)||CU63)),DECODE(FA78,NULL,NULL,FA78||CHR(13))||FA09||Decode(FA54, Null, '', CHR(13)||FA54)), DECODE(PA139,NULL,NULL,PA139||CHR(13))||PA53||Decode(PA56, Null, '', CHR(13)||PA56)),CU113), PA135) FROM PATENT, Fagent, Customer WHERE " & PaSt & _
                                    " And substr(PA75,1,8)=FA01(+) And substr(PA75,9,1)=FA02(+) And substr(PA26,1,8)=CU01(+) And substr(PA26,9,1)=CU02(+) "
                Else
                    'Modify by Morgan 2006/10/16 加日文聯絡人部門
                    strExc(0) = "SELECT Decode(PA53, Null, Decode(FA09, Null, Decode(CU60, Null, '', DECODE(CU114,NULL,NULL,CU114||CHR(13))||CU60||Decode(CU63, Null, '', CHR(13)||CU63)),DECODE(FA78,NULL,NULL,FA78||CHR(13))||FA09||Decode(FA54, Null, '', CHR(13)||FA54)), DECODE(PA139,NULL,NULL,PA139||CHR(13))||PA53||Decode(PA56, Null, '', CHR(13)||PA56)) FROM PATENT, Fagent, Customer WHERE " & PaSt & _
                                    " And substr(PA75,1,8)=FA01(+) And substr(PA75,9,1)=FA02(+) And substr(PA26,1,8)=CU01(+) And substr(PA26,9,1)=CU02(+) "
                End If
            Case 2 '商標
               If m_CP10 = "102" Then
                  '若基本檔有延展代理人時, 聯絡人抓延展聯絡人, 否則抓聯絡人1/日及聯絡人2/日
                  'Modify by Morgan 2006/10/16 加日文聯絡人部門
                  strExc(0) = "SELECT Decode(TM33, Null, Decode(TM40, Null, Decode(FA09, Null, Decode(CU60, Null, '', DECODE(CU114,NULL,NULL,CU114||CHR(13))||CU60||Decode(CU63, Null, '', CHR(13)||CU63)),DECODE(FA78,NULL,NULL,FA78||CHR(13))||FA09||Decode(FA54, Null, '', CHR(13)||FA54)), DECODE(TM76,NULL,NULL,TM76||CHR(13))||TM40||Decode(TM43, Null, '', CHR(13)||TM43)), TM71) FROM Trademark, Fagent, Customer WHERE " & TmSt & _
                                  " And substr(TM44,1,8)=FA01(+) And substr(TM44,9,1)=FA02(+) And substr(TM23,1,8)=CU01(+) And substr(TM23,9,1)=CU02(+) "
               Else
                  'Modify by Morgan 2006/10/16 加日文聯絡人部門
                  strExc(0) = "SELECT Decode(TM40, Null, Decode(FA09, Null, Decode(CU60, Null, '', DECODE(CU114,NULL,NULL,CU114||CHR(13))||CU60||Decode(CU63, Null, '',CHR(13)||CU63)),DECODE(FA78,NULL,NULL,FA78||CHR(13))||FA09||Decode(FA54, Null, '', CHR(13)||FA54)), DECODE(TM76,NULL,NULL,TM76||CHR(13))||TM40||Decode(TM43, Null, '', CHR(13)||TM43)) FROM Trademark, Fagent, Customer WHERE " & TmSt & _
                                  " And substr(TM44,1,8)=FA01(+) And substr(TM44,9,1)=FA02(+) And substr(TM23,1,8)=CU01(+) And substr(TM23,9,1)=CU02(+) "
               End If
         End Select
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If Not IsNull(RsTemp.Fields(0)) Then
               ExceptFieldData = RsTemp.Fields(0).Value
            Else
               ExceptFieldData = ""
            End If
         End If
            'End
        'Add By Cheng 2003/10/13
        'Begin
      Case "年費聯絡人"
         Select Case m_SysKind
            Case 1 '專利
                '若基本檔有年費代理人時, 聯絡人抓年費聯絡人, 否則抓聯絡人1/英
'                strExc(0) = "SELECT Decode(PA76, Null, PA52, PA135) FROM PATENT WHERE " & PaSt
'                strExc(0) = "SELECT Decode(PA76, Null, Nvl(PA52, Decode(PA75, Null, Decode(PA26, Null, '', CU59), FA08)), PA135) FROM PATENT, Fagent, Customer WHERE " & PaSt & _
'                                " And substr(PA75,1,8)=FA01(+) And substr(PA75,9,1)=FA02(+) And substr(PA26,1,8)=CU01(+) And substr(PA26,9,1)=CU02(+) "
                'Modify By Sindy 2015/6/30 PA52==>PA52||Decode(PA55, Null, '', ' and '||PA55)
'                strExc(0) = "SELECT Decode(PA76, Null, Nvl(PA52||Decode(PA55, Null, '', ' and '||PA55), Nvl(FA08, CU59)), PA135) FROM PATENT, Fagent, Customer WHERE " & PaSt & _
'                            " And substr(PA75,1,8)=FA01(+) And substr(PA75,9,1)=FA02(+) And substr(PA26,1,8)=CU01(+) And substr(PA26,9,1)=CU02(+) "
                'Modify By Sindy 2017/6/22 FCP-032342
                strExc(0) = "SELECT Decode(PA76, Null,Decode(CU96,Null, Decode(PA52, Null, Decode(FA08, Null, Decode(CU59, Null, '', CU59||Decode(CU62, Null, '', ' and '||CU62)),FA08||Decode(FA53, Null, '', ' and '||FA53)), PA52||Decode(PA55, Null, '', ' and '||PA55)),CU113), PA135) FROM PATENT, Fagent, Customer WHERE " & PaSt & _
                            " And substr(PA75,1,8)=FA01(+) And substr(PA75,9,1)=FA02(+) And substr(PA26,1,8)=CU01(+) And substr(PA26,9,1)=CU02(+) "
         End Select
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If Not IsNull(RsTemp.Fields(0)) Then
               'Modify by Morgan 2011/6/22
               'ExceptFieldData = "Attn : " & RsTemp.Fields(0).Value
               ExceptFieldData = "Attn: " & RsTemp.Fields(0).Value
            Else
               ExceptFieldData = ""
            End If
         End If
        'End
        
      'Modify by Morgan 2011/5/16 +2~5併入1
      Case "申請人1國籍", "申請人2國籍", "申請人3國籍", "申請人4國籍", "申請人5國籍"
         Select Case m_SysKind
            Case 1 '專利
               strExc(1) = 25 + Val(Mid(strField, 4, 2)) 'Add by Morgan 2011/5/16
               strExc(0) = "SELECT NA03 FROM PATENT,CUSTOMER,NATION WHERE SUBSTR(PA" & strExc(1) & ",1,8)=CU01(+) AND SUBSTR(PA" & strExc(1) & ",9,1)=CU02(+) AND CU10=NA01(+) AND " & PaSt
         End Select
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If Not IsNull(RsTemp.Fields(0)) Then
               ExceptFieldData = "" & RsTemp.Fields(0).Value
            Else
               ExceptFieldData = ""
            End If
         End If
         
      'Modify by Morgan 2011/5/16 +2~5併入1
      Case "申請人1國籍/英", "申請人2國籍/英", "申請人3國籍/英", "申請人4國籍/英", "申請人5國籍/英"
         Select Case m_SysKind
            Case 1 '專利
               strExc(1) = 25 + Val(Mid(strField, 4, 2)) 'Add by Morgan 2011/5/16
               strExc(0) = "SELECT NA04 FROM PATENT,CUSTOMER,NATION WHERE SUBSTR(PA" & strExc(1) & ",1,8)=CU01(+) AND SUBSTR(PA" & strExc(1) & ",9,1)=CU02(+) AND CU10=NA01(+) AND " & PaSt
         End Select
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If Not IsNull(RsTemp.Fields(0)) Then
               ExceptFieldData = "" & RsTemp.Fields(0).Value
            Else
               ExceptFieldData = ""
            End If
         End If
      
      'Add by Morgan 2007/12/28
      '大陸指示信用
      Case "申請人1國籍/大", "申請人2國籍/大", "申請人3國籍/大", "申請人4國籍/大", "申請人5國籍/大"
         strExc(1) = 25 + Val(Mid(strField, 4, 1))
         Select Case m_SysKind
            Case 1 '專利
               strExc(0) = "SELECT decode(substr(NA01,1,2),'00','中華民國',NA03) FROM PATENT,CUSTOMER,NATION WHERE SUBSTR(PA" & strExc(1) & ",1,8)=CU01(+) AND SUBSTR(PA" & strExc(1) & ",9,1)=CU02(+) AND CU10=NA01(+) AND " & PaSt
         End Select
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If Not IsNull(RsTemp.Fields(0)) Then
               ExceptFieldData = "" & RsTemp.Fields(0).Value
            Else
               ExceptFieldData = ""
            End If
         End If
      'Add By Sindy 2014/11/25
      Case "發明人國籍/大"
         Select Case m_SysKind
            Case 1 '專利
               strExc(0) = "SELECT decode(substr(NA01,1,2),'00','中華民國',NA03) FROM PATENTINVENTOR,INVENTOR,NATION WHERE PI01='" & m_MySt(1) & "' AND PI02='" & m_MySt(2) & "' AND PI03='" & m_MySt(3) & "' AND PI04='" & m_MySt(4) & "' AND SUBSTR(PI06,1,8)=IN01(+) AND SUBSTR(PI06,9,2)=IN02(+) AND IN11=NA01(+) ORDER BY PI05 ASC"
         End Select
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         ExceptFieldData = ""
         If intI = 1 Then
            RsTemp.MoveFirst
            Do While Not RsTemp.EOF
               If Not IsNull(RsTemp.Fields(0)) Then
                  If ExceptFieldData = "" Then
                     ExceptFieldData = RsTemp.Fields(0).Value
                  Else
                     ExceptFieldData = ExceptFieldData & vbCrLf & "　　　　　　　　　　　　" & RsTemp.Fields(0).Value
                  End If
               End If
               RsTemp.MoveNext
            Loop
         End If
      
      'Add by Morgan 2008/1/8
      '大陸指示信用
      Case "發明人1國籍/大", "發明人2國籍/大", "發明人3國籍/大", "發明人4國籍/大", "發明人5國籍/大", "發明人6國籍/大", "發明人7國籍/大", "發明人8國籍/大", "發明人9國籍/大", "發明人10國籍/大"
         'Modify By Sindy 2014/11/25 改用 發明人國籍/大
         If strSrvDate(1) >= 專利發明人檔啟用日 Then
            ExceptFieldData = ""
         Else
         '2014/11/25 END
            strExc(1) = 59 + Val(Mid(strField, 4, 2))
            Select Case m_SysKind
               Case 1 '專利
                  'Modify by Morgan 2009/6/17 發明人只存10碼
                  'strExc(0) = "SELECT decode(substr(NA01,1,2),'00','中華民國',NA03) FROM PATENT,INVENTOR,NATION WHERE SUBSTR(PA" & strExc(1) & ",1,8)=IN01(+) AND SUBSTR(PA" & strExc(1) & ",10,2)=IN02(+) AND IN11=NA01(+) AND " & PaSt
                  strExc(0) = "SELECT decode(substr(NA01,1,2),'00','中華民國',NA03) FROM PATENT,INVENTOR,NATION WHERE SUBSTR(PA" & strExc(1) & ",1,8)=IN01(+) AND SUBSTR(PA" & strExc(1) & ",9,2)=IN02(+) AND IN11=NA01(+) AND " & PaSt
            End Select
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               If Not IsNull(RsTemp.Fields(0)) Then
                  ExceptFieldData = "" & RsTemp.Fields(0).Value
               Else
                  ExceptFieldData = ""
               End If
            End If
         End If
         
        'Add By Cheng 2003/02/17
      Case "申請人1地址國籍(英)"
         Select Case m_SysKind
            Case 1 '專利
               strExc(0) = "SELECT NA04 FROM PATENT,CUSTOMER,NATION WHERE SUBSTR(PA26,1,8)=CU01(+) AND SUBSTR(PA26,9,1)=CU02(+) AND CU87=NA01(+) AND " & PaSt
         End Select
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If Not IsNull(RsTemp.Fields(0)) Then
               ExceptFieldData = "" & RsTemp.Fields(0).Value
            Else
               ExceptFieldData = ""
            End If
         End If
      Case "申請人2地址國籍(英)"
         Select Case m_SysKind
            Case 1 '專利
               strExc(0) = "SELECT NA04 FROM PATENT,CUSTOMER,NATION WHERE SUBSTR(PA27,1,8)=CU01(+) AND SUBSTR(PA27,9,1)=CU02(+) AND CU87=NA01(+) AND " & PaSt
         End Select
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If Not IsNull(RsTemp.Fields(0)) Then
               ExceptFieldData = "" & RsTemp.Fields(0).Value
            Else
               ExceptFieldData = ""
            End If
         End If
      Case "申請人3地址國籍(英)"
         Select Case m_SysKind
            Case 1 '專利
               strExc(0) = "SELECT NA04 FROM PATENT,CUSTOMER,NATION WHERE SUBSTR(PA28,1,8)=CU01(+) AND SUBSTR(PA28,9,1)=CU02(+) AND CU87=NA01(+) AND " & PaSt
         End Select
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If Not IsNull(RsTemp.Fields(0)) Then
               ExceptFieldData = "" & RsTemp.Fields(0).Value
            Else
               ExceptFieldData = ""
            End If
         End If
      Case "申請人4地址國籍(英)"
         Select Case m_SysKind
            Case 1 '專利
               strExc(0) = "SELECT NA04 FROM PATENT,CUSTOMER,NATION WHERE SUBSTR(PA29,1,8)=CU01(+) AND SUBSTR(PA29,9,1)=CU02(+) AND CU87=NA01(+) AND " & PaSt
         End Select
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If Not IsNull(RsTemp.Fields(0)) Then
               ExceptFieldData = "" & RsTemp.Fields(0).Value
            Else
               ExceptFieldData = ""
            End If
         End If
      Case "申請人5地址國籍(英)"
         Select Case m_SysKind
            Case 1 '專利
               strExc(0) = "SELECT NA04 FROM PATENT,CUSTOMER,NATION WHERE SUBSTR(PA30,1,8)=CU01(+) AND SUBSTR(PA30,9,1)=CU02(+) AND CU87=NA01(+) AND " & PaSt
         End Select
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If Not IsNull(RsTemp.Fields(0)) Then
               ExceptFieldData = "" & RsTemp.Fields(0).Value
            Else
               ExceptFieldData = ""
            End If
         End If
      Case "追加號多國多類碼", "追加號多國多類碼/集體", "追加號多國多類碼/集體2"
         'Add by Morgan 2007/1/25
         ExceptFieldData = m_MySt(3) & m_MySt(4)
         If ExceptFieldData <> "" Then
            If ExceptFieldData = "000" Then
               'Add by Morgan 2010/5/25
               If strField = "追加號多國多類碼/集體" Then
                  ExceptFieldData = GetMaxPA03(m_MySt(1), m_MySt(2), m_MySt(4))
               'Added by Morgan 2025/7/29
               ElseIf strField = "追加號多國多類碼/集體2" Then
                  ExceptFieldData = GetMaxPA03(m_MySt(1), m_MySt(2), m_MySt(4), True)
               'end 2025/7/29
               Else
               'end 2010/5/25
                  ExceptFieldData = ""
               End If
            Else
                ExceptFieldData = "-" & m_MySt(3) & "-" & m_MySt(4)
            End If
         Else
         'end 2007/1/25
            Select Case m_SysKind
               Case 1 '專利
                  strExc(0) = "SELECT PA03,PA04 FROM PATENT WHERE " & PaSt
               Case 2 '商標
                  strExc(0) = "SELECT TM03,TM04 FROM TRADEMARK WHERE " & TmSt
               Case 3 '法務
                  strExc(0) = "SELECT LC03,LC04 FROM LAWCASE WHERE " & LcSt
               Case 4 '顧問
                  strExc(0) = "SELECT HC03,HC04 FROM HIRECASE WHERE " & HcSt
               Case 5, 6 '服務
                  strExc(0) = "SELECT SP03,SP04 FROM SERVICEPRACTICE WHERE " & SpSt
            End Select
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               ExceptFieldData = "" & RsTemp.Fields(0).Value & RsTemp.Fields(1).Value
               If ExceptFieldData = "000" Or ExceptFieldData = "" Then
                   ExceptFieldData = ""
               Else
                   ExceptFieldData = "-" & RsTemp.Fields(0).Value & "-" & RsTemp.Fields(1).Value
               End If
            End If
         End If
      '91.12.29 add by sonia
      Case "專利種類/英"
        'Modify By Cheng 2003/06/19
'         strExc(0) = "SELECT PA08 FROM PATENT WHERE " & PaSt
         strExc(0) = "SELECT PA08, PA11,PA09 FROM PATENT WHERE " & PaSt
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If IsNull(RsTemp.Fields(0).Value) = True Then
               If m_MySt(3) = "0" Then
                  ExceptFieldData = "Invention"
               Else
                  'Modify by Morgan 2005/1/27 首字母改大寫 --David
                  'ExceptFieldData = "patent-of-Additional"
                  ExceptFieldData = "Patent-of-Additional"
               End If
               
               'Modify by Morgan 2010/3/31 +判斷台灣案
               'If Len("" & RsTemp.Fields(1).Value) > 8 Then
               If RsTemp("pa09") = "000" And Len("" & RsTemp("pa11")) > 9 Then
                  'Modify by Morgan 2005/1/27 首字母改大寫 --David
                  'ExceptFieldData = "patent-of-Additional"
                  ExceptFieldData = "Patent-of-Additional"
               Else
                  ExceptFieldData = "Invention"
               End If
               
            Else
               Select Case RsTemp.Fields(0).Value
                  Case "1":
                     'Remove by Morgan 2010/3/31 沒作用
                     'If m_MySt(3) = "0" Then
                     '   ExceptFieldData = "Invention"
                     'Else
                     '   'Modify by Morgan 2005/1/27 首字母改大寫 --David
                     '   'ExceptFieldData = "patent-of-Additional"
                     '   ExceptFieldData = "Patent-of-Additional"
                     'End If
                     
                     'Modify by Morgan 2010/3/31 +判斷台灣案
                     'If Len("" & RsTemp.Fields(1).Value) > 8 Then
                     If RsTemp("pa09") = "000" And Len("" & RsTemp("pa11")) > 9 Then
                     
                        'Modify by Morgan 2005/1/27 首字母改大寫 --David
                        'ExceptFieldData = "patent-of-Additional"
                        ExceptFieldData = "Patent-of-Additional"
                     Else
                        ExceptFieldData = "Invention"
                     End If
                  Case "2":
                     'Remove by Morgan 2010/3/31 沒作用
                     'If m_MySt(3) = "0" Then
                     '   ExceptFieldData = "Utility Model"
                     'Else
                     '   'Modify by Morgan 2005/1/27 首字母改大寫 --David
                     '   'ExceptFieldData = "patent-of-Additional"
                     '   ExceptFieldData = "Patent-of-Additional"
                     'End If
                     
                     'Modify by Morgan 2010/3/31 +判斷台灣案
                     'If Len("" & RsTemp.Fields(1).Value) > 8 Then
                     If RsTemp("pa09") = "000" And Len("" & RsTemp("pa11")) > 9 Then
                     
                        'Modify by Morgan 2005/1/27 首字母改大寫 --David
                        'ExceptFieldData = "patent-of-Additional"
                        ExceptFieldData = "Patent-of-Additional"
                     Else
                        ExceptFieldData = "Utility Model"
                     End If
                  Case "3":
                     'Remove by Morgan 2010/3/31 沒作用
                     'If m_MySt(3) = "0" Then
                     '   ExceptFieldData = "Design"
                     'Else
                     '   ExceptFieldData = "United Design"
                     'End If
                     
                     'Modify by Morgan 2010/3/31 +判斷台灣案
                     'If Len("" & RsTemp.Fields(1).Value) > 8 Then
                     If RsTemp("pa09") = "000" And Len("" & RsTemp("pa11")) > 9 Then
                        'Modified by Morgan 2012/12/24
                        If Mid(RsTemp("pa11"), 10, 1) = "D" Then
                           ExceptFieldData = "Derivational Design"
                        Else
                        'end 2012/12/24
                           ExceptFieldData = "United Design"
                        End If
                     Else
                        ExceptFieldData = "Design"
                     End If
               End Select
            End If
         End If
      '92.1.7 add by sonia
        'Add By Cheng 2003/01/28
        '母案專利種類/英
      Case "母案專利種類/英"
         strExc(0) = "SELECT PA08 FROM PATENT WHERE " & ChgPatent(m_MySt(1) & m_MySt(2) & "000")
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If IsNull(RsTemp.Fields(0).Value) = True Then
                ExceptFieldData = "Invention"
            Else
               Select Case RsTemp.Fields(0).Value
                  Case "1":
                    ExceptFieldData = "Invention"
                  Case "2":
                    ExceptFieldData = "Utility Model"
                  Case "3":
                    ExceptFieldData = "Design"
               End Select
            End If
         End If
      '92.1.7 END
      'Add By Cheng 2003/01/27
      '加例外處理欄位--下次繳費年度(直接抓設定的下一年度值)
      Case "下次繳費年度"
         'Modify by Morgan 2008/5/30 抽出改寫共用函數以便其他程式能直接呼叫
         '2008/8/22 modify by sonia 019泰國新型第7年年費,通知函改為第7至8年,因第8年不用繳
         'ExceptFieldData = PUB_GetNextYear(m_MySt)
         ExceptFieldData = PUB_GetNextYear(m_MySt, strTmp)
         If strTmp <> "" Then ExceptFieldData = strTmp
         '2008/8/22 end
'end 2008/5/30

      '92.2.7 add by sonia
      '加例外處理欄位--下次繳費次數(直接抓設定的下一次)
      Case "下次繳費次數"
         'Modify by Morgan 2008/12/12 抽出改寫共用函數以便其他程式能直接呼叫
         ExceptFieldData = PUB_GetNextTime(m_MySt, strTmp)
         If strTmp <> "" Then ExceptFieldData = strTmp
         
      '92.2.7 end
      'Add By Cheng 2003/01/30
      '加例外處理欄位--最後繳費年度
      Case "最後繳費年度"
         strExc(0) = "SELECT PA10,PA14,PA08,NA07,NA09,NA11 FROM PATENT,NATION WHERE PA09=NA01(+) AND PA01='" & m_MySt(1) & "' And PA02='" & m_MySt(2) & "' AND PA03='" & m_MySt(3) & "' AND PA04='" & m_MySt(4) & "' And PA10 IS NOT NULL And PA14 IS NOt NULL "
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            'Modify By Cheng 2003/02/21
            For ii = 1 To IIf(RsTemp.Fields(2).Value = "1", RsTemp.Fields(3).Value, IIf(RsTemp.Fields(2).Value = "2", RsTemp.Fields(4).Value, RsTemp.Fields(5).Value))
                If ChangeWDateStringToWString(DateAdd("yyyy", ii, ChangeWStringToWDateString(RsTemp.Fields(1).Value))) >= _
                    ChangeWDateStringToWString(DateAdd("yyyy", IIf(RsTemp.Fields(2).Value = "1", RsTemp.Fields(3).Value, IIf(RsTemp.Fields(2).Value = "2", RsTemp.Fields(4).Value, RsTemp.Fields(5).Value)), ChangeWStringToWDateString(RsTemp.Fields(0).Value))) Then
                    Exit For
                End If
                '公告日為第一年
                ExceptFieldData = ii + 1
            Next ii
         End If
        'Move By Cheng 2003/02/06
        Case "預計繳年費期限列表(英)"
            ExceptFieldData = ""
            StrSQLa = "Select * From Patent Where " & ChgPatent(m_MySt(1) & m_MySt(2) & m_MySt(3) & m_MySt(4)) & " And PA24 IS NOT NULL And PA25 IS NOT NULL "
            rsA.CursorLocation = adUseClient
            rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
            If rsA.RecordCount > 0 Then
                intI = 1 'Add by Morgan 2005/3/15
                'Add By Cheng 2003/01/22
                '取得下次繳費日
                StrSqlB = "Select NP09 From NextProgress Where " & ChgNextProgress(m_MySt(1) & m_MySt(2) & m_MySt(3) & m_MySt(4)) & " And NP07='" & 年費 & "' And NP06 IS NULL And NP07 IS NOT NULL "
                rsB.CursorLocation = adUseClient
                rsB.Open StrSqlB, cnnConnection, adOpenStatic, adLockReadOnly
                If rsB.RecordCount > 0 Then
                    strNP09 = "" & rsB.Fields(0).Value
                Else
                    'Add by Morgan 2005/3/15 若 PA72 有值則抓最後繳費年度
                    If "" & rsA.Fields("PA72") <> "" Then
                        intI = Val(Right(rsA.Fields("PA72"), 2))
                        intI = IIf(intI = 0, Val(Right(rsA.Fields("PA72"), 1)), intI)
                     End If
                    '2005/3/15 END
                    strNP09 = ""
                End If
                If rsB.State <> adStateClosed Then rsB.Close
                Set rsB = Nothing
                ii = 1
               'Modify by Morgan 2005/3/15
               'For ii = 1 To 19
               For ii = intI To 19
                    strNextPayDay = "" & CompDate(2, -1, CompDate(0, ii, rsA("PA24").Value))
                    '預計繳費日期>=下次繳費日且<專用期限止日
                    If strNextPayDay < "" & rsA("PA25").Value And strNextPayDay >= strNP09 Then
                        Select Case ii + 1
                        Case 2
                            ExceptFieldData = ExceptFieldData & Space(20) & "2nd" & Space(2) & "annuity" & Space(10) & ChgEngDate(strNextPayDay) & vbCrLf
                        Case 3
                            ExceptFieldData = ExceptFieldData & Space(20) & "3rd" & Space(2) & "annuity" & Space(10) & ChgEngDate(strNextPayDay) & vbCrLf
                        Case 4, 5, 6, 7, 8, 9
                            ExceptFieldData = ExceptFieldData & Space(20) & (ii + 1) & "th" & Space(2) & "annuity" & Space(10) & ChgEngDate(strNextPayDay) & vbCrLf
                        Case Else
                            ExceptFieldData = ExceptFieldData & Space(19) & (ii + 1) & "th" & Space(2) & "annuity" & Space(10) & ChgEngDate(strNextPayDay) & vbCrLf
                        End Select
                    End If
               Next ii
               'Modify by Morgan 2008/4/15
               'If ii <> 1 Then ExceptFieldData = LeftB(ExceptFieldData, LenB(ExceptFieldData) - LenB(vbCrLf))
               If ExceptFieldData <> "" Then ExceptFieldData = LeftB(ExceptFieldData, LenB(ExceptFieldData) - LenB(vbCrLf))
               
            End If
            If rsA.State <> adStateClosed Then rsA.Close
            Set rsA = Nothing
        Case "預計繳年費期限列表(中)"
            ExceptFieldData = ""
            StrSQLa = "Select * From Patent Where " & ChgPatent(m_MySt(1) & m_MySt(2) & m_MySt(3) & m_MySt(4)) & " And PA24 IS NOT NULL And PA25 IS NOT NULL "
            rsA.CursorLocation = adUseClient
            rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
            If rsA.RecordCount > 0 Then
                'Add By Cheng 2003/01/22
                '取得下次繳費日
                StrSqlB = "Select NP09 From NextProgress Where " & ChgNextProgress(m_MySt(1) & m_MySt(2) & m_MySt(3) & m_MySt(4)) & " And NP07='" & 年費 & "' And NP06 IS NULL And NP07 IS NOT NULL "
                rsB.CursorLocation = adUseClient
                rsB.Open StrSqlB, cnnConnection, adOpenStatic, adLockReadOnly
                If rsB.RecordCount > 0 Then
                    strNP09 = "" & rsB.Fields(0).Value
                Else
                    strNP09 = ""
                End If
                If rsB.State <> adStateClosed Then rsB.Close
                Set rsB = Nothing
                ii = 1
                For ii = 1 To 19
                    strNextPayDay = "" & CompDate(2, -1, CompDate(0, ii, rsA("PA24").Value))
                    '預計繳費日期>=下次繳費日且<專用期限止日
                    If strNextPayDay < "" & rsA("PA25").Value And strNextPayDay >= strNP09 Then
                        If ii + 1 < 10 Then
                            '半形數字轉全形
                            'ExceptFieldData = ExceptFieldData & Space(16) & "　第" & Chr(Asc(ii + 1) - 23937) & "年" & Space(13) & Left(strNextPayDay, 4) - 1911 & "年" & Mid(strNextPayDay, 5, 2) & "月" & Right(strNextPayDay, 2) & "日" & vbCrLf
                            ExceptFieldData = ExceptFieldData & Space(16) & "　第" & Chr(Asc(ii + 1) - 23937) & "年" & Space(13) & Left(strNextPayDay, 4) & "年" & Mid(strNextPayDay, 5, 2) & "月" & Right(strNextPayDay, 2) & "日" & vbCrLf
                        Else
                            '半形數字轉全形
                            'ExceptFieldData = ExceptFieldData & Space(16) & "第" & Chr(Asc(Left(ii + 1, 1)) - 23937) & Chr(Asc(Right(ii + 1, 1)) - 23937) & "年" & Space(13) & Left(strNextPayDay, 4) - 1911 & "年" & Mid(strNextPayDay, 5, 2) & "月" & Right(strNextPayDay, 2) & "日" & vbCrLf
                            ExceptFieldData = ExceptFieldData & Space(16) & "第" & Chr(Asc(Left(ii + 1, 1)) - 23937) & Chr(Asc(Right(ii + 1, 1)) - 23937) & "年" & Space(13) & Left(strNextPayDay, 4) & "年" & Mid(strNextPayDay, 5, 2) & "月" & Right(strNextPayDay, 2) & "日" & vbCrLf
                        End If
                    End If
                Next ii
                If ii <> 1 Then ExceptFieldData = LeftB(ExceptFieldData, LenB(ExceptFieldData) - LenB(vbCrLf))
            End If
            If rsA.State <> adStateClosed Then rsA.Close
            Set rsA = Nothing
        Case "預計繳年費期限列表(日)"
            ExceptFieldData = ""
            strExc(0) = "Select pa24,pa25,pa72 From Patent Where " & ChgPatent(m_MySt(1) & m_MySt(2) & m_MySt(3) & m_MySt(4)) & " And PA24 IS NOT NULL And PA25 IS NOT NULL "
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               i = 1
               '若 PA72 有值則抓最後繳費年度
               strExc(1) = "" & RsTemp.Fields("PA72")
               strExc(2) = "" & RsTemp.Fields("PA24")
               strExc(3) = "" & RsTemp.Fields("PA25")
               If strExc(1) <> "" Then
                  i = Val(Right(strExc(1), 2))
                  i = IIf(i = 0, Val(Right(strExc(1), 1)), i)
               End If
               
               '取得下次繳費日
               strExc(0) = "Select NP09 From NextProgress Where " & ChgNextProgress(m_MySt(1) & m_MySt(2) & m_MySt(3) & m_MySt(4)) & " And NP07='" & 年費 & "' And NP06 IS NULL And NP07 IS NOT NULL "
               intI = 1
               Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
               If intI = 1 Then
                  strNP09 = "" & RsTemp.Fields(0).Value
               End If
                
               For ii = i To 19
                  '預計繳費日期>=下次繳費日且<專用期限止日
                  strNextPayDay = "" & CompDate(2, -1, CompDate(0, ii, strExc(2)))
                  If strNextPayDay < strExc(3) And strNextPayDay >= strNP09 Then
                     ExceptFieldData = ExceptFieldData & String(3, "　") & "第" & toDblFont(ii + 1) & "年度" & IIf(ii < 9, String(7, "　"), String(6, "　")) & toDblFont(Left(strNextPayDay, 4)) & "年" & toDblFont(Mid(strNextPayDay, 5, 2)) & "月" & toDblFont(Right(strNextPayDay, 2)) & "日" & vbCrLf
                  End If
               Next ii
               If ii <> 1 Then ExceptFieldData = LeftB(ExceptFieldData, LenB(ExceptFieldData) - LenB(vbCrLf))
            End If
            
        'Add By Cheng 2003/03/13
        Case "商標專用期間列表(英)"
            ExceptFieldData = ""
            StrSQLa = "Select * From Trademark Where " & ChgTradeMark(m_MySt(1) & m_MySt(2) & m_MySt(3) & m_MySt(4)) & " And TM21 IS NOT NULL And TM22 IS NOT NULL "
            rsA.CursorLocation = adUseClient
            rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
            If rsA.RecordCount > 0 Then
                'Modify By Cheng 2003/06/20
'                dblYearDiff = Val(DateDiff("yyyy", ChangeWStringToWDateString(rsA("TM21").Value), ChangeWStringToWDateString(rsA("TM22").Value)))
                dblYearDiff = 0
                ii = 0
                'Modified by Morgan 2024/1/11 修正日期轉字串會因顯示格式而不同問題
                'Do While (DateAdd("d", 1, DateAdd("yyyy", ii, ChangeWStringToWDateString(rsA("TM22").Value))) > ChangeWStringToWDateString(rsA("TM21").Value))
                Do While DBDATE(DateAdd("d", 1, DateAdd("yyyy", ii, ChangeWStringToWDateString(rsA("TM22").Value)))) > rsA("TM21").Value
                'end 2024/1/11
                    ii = ii - 1
                    dblYearDiff = dblYearDiff + 1
                Loop
                'Add By Cheng 2003/06/26
                If DBDATE(DateAdd("d", 1, DateAdd("yyyy", ii + 1, ChangeWStringToWDateString(rsA("TM22").Value)))) = DBDATE(ChangeWStringToWDateString(rsA("TM21").Value)) Then
                    dblYearDiff = dblYearDiff - 1
                End If
                If dblYearDiff > 0 Then
                    If dblYearDiff Mod 10 <> 0 Then
                        dblYearDiff = Fix(dblYearDiff / 10) + 1
                    Else
                        dblYearDiff = Fix(dblYearDiff / 10)
                    End If
                    For ii = dblYearDiff To 1 Step -1
                        Select Case ii
                        Case 1
                            ExceptFieldData = "Period of Exclusive Use : From " & ChgEngDate("" & rsA("TM21").Value) & " to " & ChgEngDate(CompDate(0, -10 * (dblYearDiff - ii), "" & rsA("TM22").Value)) & vbCrLf & ExceptFieldData
                        Case 2
                            ExceptFieldData = "Renewed Period       : From " & ChgEngDate(CompDate(2, 1, CompDate(0, -10 * (dblYearDiff - (ii - 1)), "" & rsA("TM22").Value))) & " to " & ChgEngDate(CompDate(0, -10 * (dblYearDiff - ii), "" & rsA("TM22").Value)) & vbCrLf & ExceptFieldData
                        Case Else
                            ExceptFieldData = "                    : From " & ChgEngDate(CompDate(2, 1, CompDate(0, -10 * (dblYearDiff - (ii - 1)), "" & rsA("TM22").Value))) & " to " & ChgEngDate(CompDate(0, -10 * (dblYearDiff - ii), "" & rsA("TM22").Value)) & vbCrLf & ExceptFieldData
                        End Select
                    Next ii
                End If
            End If
            If rsA.State <> adStateClosed Then rsA.Close
            Set rsA = Nothing
      
      'Add By Sindy 2015/7/22
      Case "程序人員"
            ExceptFieldData = GetPrjSalesNM(m_User)
      Case "程序部門"
            ExceptFieldData = A0902Query(GetStaffDepartment(m_User))
      '2015/7/22 END
      
      'Add By Cheng 2003/04/11
      Case "業務員"
            strTmp = PUB_GetAKindSalesNo(m_CP01, m_CP02, m_CP03, m_CP04)
            
            'Modified by Morgan 2015/5/19
            'ExceptFieldData = GetStaffName(strTmp)
            ''Added by morgan 2015/3/31
            ''A4004張詠翔的落款加帶葉招進副理
            'If strTmp = "A4004" Then
            '   ExceptFieldData = "葉招進副理、" & ExceptFieldData
            '
            ''Added by Morgan 2015/4/14
            ''A4012江維宬的落款加帶賴皇瑞副理
            'ElseIf strTmp = "A4012" Then
            '   ExceptFieldData = "賴皇瑞副理、" & ExceptFieldData
            ''end 2015/4/14
            'End If
            ''end 2015/3/31
            ExceptFieldData = PUB_GetLetterSalesName(strTmp)
            If ExceptFieldData = "" Then
               ExceptFieldData = GetStaffName(strTmp)
            End If
            'end 2015/5/19
            
            '2011/8/5 add by sonia 68096的客戶若最後收文為在職人員則加印該人員姓名(68096所有定稿交邱素蓮)
            If strTmp = "68096" Then
               strExc(0) = "select st02 from staff,(select max(cp05||cp13) cp13 from ( " & _
                           "      Select cp05,cp13 From patent, caseprogress Where pa26='" & GetPrjPeopleNum1(m_CP01 & "-" & m_CP02 & "-" & m_CP03 & "-" & m_CP04) & "' and pa01=cp01 and pa02=cp02 and pa03=cp03 and pa04=cp04 and cp09<'B' " & _
                           "union Select cp05,cp13 From trademark, caseprogress Where tm23='" & GetPrjPeopleNum1(m_CP01 & "-" & m_CP02 & "-" & m_CP03 & "-" & m_CP04) & "' and tm01=cp01 and tm02=cp02 and tm03=cp03 and tm04=cp04 and cp09<'B' " & _
                           "union Select cp05,cp13 From lawcase, caseprogress Where lc11='" & GetPrjPeopleNum1(m_CP01 & "-" & m_CP02 & "-" & m_CP03 & "-" & m_CP04) & "' and lc01=cp01 and lc02=cp02 and lc03=cp03 and lc04=cp04 and cp09<'B' " & _
                           "union Select cp05,cp13 From servicepractice, caseprogress Where sp08='" & GetPrjPeopleNum1(m_CP01 & "-" & m_CP02 & "-" & m_CP03 & "-" & m_CP04) & "' and sp01=cp01 and sp02=cp02 and sp03=cp03 and sp04=cp04 and cp09<'B' " & _
                           "union Select cp05,cp13 From hirecase, caseprogress Where hc05='" & GetPrjPeopleNum1(m_CP01 & "-" & m_CP02 & "-" & m_CP03 & "-" & m_CP04) & "' and hc01=cp01 and hc02=cp02 and hc03=cp03 and hc04=cp04 and cp09<'B' " & _
                           ")) aa where substr(aa.cp13,9)=st01(+) and st04='1'"
               intI = 1
               Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
               If intI = 1 Then
                   ExceptFieldData = ExceptFieldData & "（" & RsTemp.Fields(0).Value & "）"
               End If
            End If
            '2011/8/5 end
      'Add By Cheng 2003/04/17
      Case "業務區別"
            strTmp = PUB_GetAKindSalesNo(m_CP01, m_CP02, m_CP03, m_CP04)
            
            'Modified by Morgan 2015/5/19
            'ExceptFieldData = PUB_GetStaffST15(strTmp, "2")
            ExceptFieldData = PUB_GetLetterSalesZone(strTmp)
            If ExceptFieldData = "" Then
               'Added by Morgan 2020/3/3
               '專利國內部(P1)要加職稱
               If Left(GetST15(strTmp), 2) = "P1" Then
                  ExceptFieldData = "專利國內部" & Replace(GetStaffST20(strTmp), "代", "", 1, 1)
               Else
               'end 2020/3/3
               
                  ExceptFieldData = PUB_GetStaffST15(strTmp, "2")
               End If 'Added by Morgan 2020/3/3
               
            End If
            'end 2015/5/19
            
            '2011/8/5 add by sonia 68096的客戶若最後收文為在職人員因要加印該人員姓名故不印業務區
            If strTmp = "68096" Then
               strExc(0) = "select st02 from staff,(select max(cp05||cp13) cp13 from ( " & _
                           "      Select cp05,cp13 From patent, caseprogress Where pa26='" & GetPrjPeopleNum1(m_CP01 & "-" & m_CP02 & "-" & m_CP03 & "-" & m_CP04) & "' and pa01=cp01 and pa02=cp02 and pa03=cp03 and pa04=cp04 and cp09<'B' " & _
                           "union Select cp05,cp13 From trademark, caseprogress Where tm23='" & GetPrjPeopleNum1(m_CP01 & "-" & m_CP02 & "-" & m_CP03 & "-" & m_CP04) & "' and tm01=cp01 and tm02=cp02 and tm03=cp03 and tm04=cp04 and cp09<'B' " & _
                           "union Select cp05,cp13 From lawcase, caseprogress Where lc11='" & GetPrjPeopleNum1(m_CP01 & "-" & m_CP02 & "-" & m_CP03 & "-" & m_CP04) & "' and lc01=cp01 and lc02=cp02 and lc03=cp03 and lc04=cp04 and cp09<'B' " & _
                           "union Select cp05,cp13 From servicepractice, caseprogress Where sp08='" & GetPrjPeopleNum1(m_CP01 & "-" & m_CP02 & "-" & m_CP03 & "-" & m_CP04) & "' and sp01=cp01 and sp02=cp02 and sp03=cp03 and sp04=cp04 and cp09<'B' " & _
                           "union Select cp05,cp13 From hirecase, caseprogress Where hc05='" & GetPrjPeopleNum1(m_CP01 & "-" & m_CP02 & "-" & m_CP03 & "-" & m_CP04) & "' and hc01=cp01 and hc02=cp02 and hc03=cp03 and hc04=cp04 and cp09<'B' " & _
                           ")) aa where substr(aa.cp13,9)=st01(+) and st04='1'"
               intI = 1
               Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
               If intI = 1 Then ExceptFieldData = ""
            End If
            '2011/8/5 end
        'Add By Cheng 2003/08/27
      Case "異議舉發"
         strExc(0) = "SELECT Decode(PA23, Null, Null,'1',Null,'2','異議','3','舉發') FROM PATENT WHERE " & ChgPatent(m_MySt(1) & m_MySt(2) & "000")
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData = "" & RsTemp.Fields(0).Value
         End If
        'Add By Cheng 2003/09/18
        'Begin
      Case "分所案號"
         strExc(0) = "SELECT PA47 FROM PATENT WHERE " & PaSt
         strExc(0) = strExc(0) & " Union SELECT TM34 FROM Trademark WHERE " & TmSt
         strExc(0) = strExc(0) & " Union SELECT LC16 FROM Lawcase WHERE " & LcSt
         strExc(0) = strExc(0) & " Union SELECT HC07 FROM Hirecase WHERE " & HcSt
         strExc(0) = strExc(0) & " Union SELECT SP28 FROM Servicepractice WHERE " & SpSt
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If IsNull(RsTemp.Fields(0).Value) = False Then
                ExceptFieldData = "（分所案號：" & RsTemp.Fields(0).Value & "）"
            End If
         End If
        'End
        'Add By Cheng 2003/10/23
      Case "副本聯絡人"
        'Modify by Morgan 2005/7/13 順序:1.PA->FA->CU,2.副本聯絡人->副本收受人(代理人檔->客戶檔),3.英->中->日
        'strExc(0) = "Select '0', PA87, Decode(FA05, Null, CU05||' '||CU88||' '||CU89||' '||CU90, FA05||' '||FA63||' '||FA64||' '||FA65) From Patent, Fagent ,Customer Where substr(PA86,1,8)=FA01(+) And substr(PA86,9,1)=FA02(+) And substr(PA86,1,8)=CU01(+) And substr(PA86,9,1)=CU02(+) And " & PaSt & " And (PA87 Is Not Null Or PA86 Is Not Null) "
        'strExc(0) = strExc(0) & " Union Select '1', F1.FA37, Decode(F2.FA05, Null, C2.CU05||' '||C2.CU88||' '||C2.CU89||' '||C2.CU90, F2.FA05||' '||F2.FA63||' '||F2.FA64||' '||F2.FA65) From Patent, Fagent F1, Fagent F2, Customer C2 Where substr(PA75,1,8)=F1.FA01(+) And substr(PA75,9,1)=F1.FA02(+) And substr(F1.FA38,1,8)=F2.FA01(+) And substr(F1.FA38,9,1)=F2.FA02(+) And substr(F1.FA38,1,8)=C2.CU01(+) And substr(F1.FA38,9,1)=C2.CU02(+) And " & PaSt & " And PA75 Is Not Null "
        'strExc(0) = strExc(0) & " Union Select '2', C1.CU70, Decode(F2.FA05, Null, C2.CU05||' '||C2.CU88||' '||C2.CU89||' '||C2.CU90, F2.FA05||' '||F2.FA63||' '||F2.FA64||' '||F2.FA65) From Patent, Customer C1, Customer C2, Fagent F2 Where substr(PA26,1,8)=C1.CU01(+) And substr(PA26,9,1)=C1.CU02(+) And substr(C1.CU71,1,8)=C2.CU01(+) And substr(C1.CU71,9,1)=C2.CU02(+) And substr(C1.CU71,1,8)=F2.FA01(+) And substr(C1.CU71,9,1)=F2.FA02(+) And " & PaSt & " And (PA75 Is Null And PA26 Is Not Null) "
        'Modified by Morgan 2017/12/19 配合日文定稿新增副本收受人日文欄位 --郭怡瑩 Ex.FCP-56803請款函
        strExc(0) = "Select '0', PA87, Decode(FA05, Null,NVL(NVL(FA04,FA06),NVL(NVL(RTRIM(CU05||' '||CU88||' '||CU89||' '||CU90),CU04),CU06)), FA05||' '||FA63||' '||FA64||' '||FA65),decode(PA86,null,null,NVL(FA06,CU06)) From Patent, Fagent ,Customer Where substr(PA86,1,8)=FA01(+) And substr(PA86,9,1)=FA02(+) And substr(PA86,1,8)=CU01(+) And substr(PA86,9,1)=CU02(+) And " & PaSt & " And (PA87 Is Not Null Or PA86 Is Not Null) "
        strExc(0) = strExc(0) & " Union Select '1', F1.FA37, Decode(F2.FA05, Null,NVL(NVL(F2.FA04,F2.FA06),NVL(NVL(RTRIM(C2.CU05||' '||C2.CU88||' '||C2.CU89||' '||C2.CU90),C2.CU04),C2.CU06)), F2.FA05||' '||F2.FA63||' '||F2.FA64||' '||F2.FA65),decode(F1.FA38,null,null,NVL(F2.FA06,C2.CU06)) From Patent, Fagent F1, Fagent F2, Customer C2 Where substr(PA75,1,8)=F1.FA01(+) And substr(PA75,9,1)=F1.FA02(+) And substr(F1.FA38,1,8)=F2.FA01(+) And substr(F1.FA38,9,1)=F2.FA02(+) And substr(F1.FA38,1,8)=C2.CU01(+) And substr(F1.FA38,9,1)=C2.CU02(+) And " & PaSt & " And PA75 Is Not Null "
        strExc(0) = strExc(0) & " Union Select '2', C1.CU70, Decode(F2.FA05, Null,NVL(NVL(F2.FA04,F2.FA06),NVL(NVL(RTRIM(C2.CU05||' '||C2.CU88||' '||C2.CU89||' '||C2.CU90),C2.CU04),C2.CU06)), F2.FA05||' '||F2.FA63||' '||F2.FA64||' '||F2.FA65),decode(C1.CU71,null,null,NVL(F2.FA06,C2.CU06)) From Patent, Customer C1, Customer C2, Fagent F2 Where substr(PA26,1,8)=C1.CU01(+) And substr(PA26,9,1)=C1.CU02(+) And substr(C1.CU71,1,8)=C2.CU01(+) And substr(C1.CU71,9,1)=C2.CU02(+) And substr(C1.CU71,1,8)=F2.FA01(+) And substr(C1.CU71,9,1)=F2.FA02(+) And " & PaSt & " And (PA75 Is Null And PA26 Is Not Null) "
        strExc(0) = strExc(0) & " Order By 1 "
        intI = 1
        Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
        If intI = 1 Then
            Do While Not RsTemp.EOF
               'Modified by Morgan 2017/12/19
               'If Trim("" & RsTemp.Fields(1).Value) <> "" Then
               If strPrintType = "3" And Not IsNull(RsTemp.Fields(3).Value) Then
                  ExceptFieldData = "C.C." & vbCrLf & RsTemp.Fields(3).Value
                  If Not IsNull(RsTemp.Fields(1).Value) Then
                     ExceptFieldData = ExceptFieldData & vbCrLf & RsTemp.Fields(1).Value
                  End If
                  Exit Do
               ElseIf Trim("" & RsTemp.Fields(1).Value) <> "" Then
               'end 2017/12/19
                  ExceptFieldData = "c.c. " & RsTemp.Fields(1).Value
                  If Trim("" & RsTemp.Fields(2).Value) <> "" Then
                     ExceptFieldData = ExceptFieldData & vbCrLf & "   " & RsTemp.Fields(2).Value
                  End If
                  Exit Do
               ElseIf Trim("" & RsTemp.Fields(2).Value) <> "" Then
                  ExceptFieldData = "c.c. " & RsTemp.Fields(2).Value
                  Exit Do
               End If
               RsTemp.MoveNext
            Loop
        End If
        'Add By Cheng 2003/11/12
      Case "商品類別"
         strExc(0) = "SELECT TM09 FROM Trademark WHERE " & TmSt
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If "" & RsTemp.Fields(0).Value <> "" Then
                arrTM09 = Split("" & RsTemp.Fields(0).Value, ",")
                For ii = LBound(arrTM09) To UBound(arrTM09)
                    'Add By Cheng 2003/12/18
                    '拿掉空白
                    arrTM09(ii) = Trim(arrTM09(ii))
                    'End
                    If ii = LBound(arrTM09) Then
                        ExceptFieldData = "Specification : " & "Class " & arrTM09(ii)
                    Else
                        ExceptFieldData = ExceptFieldData & vbCrLf & "            " & "Class " & arrTM09(ii)
                    End If
                Next ii
            End If
         End If
        'Add By Cheng 2003/11/20
      Case "商品服務"
         strExc(0) = "SELECT TM09 FROM Trademark WHERE " & TmSt
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If "" & RsTemp.Fields(0).Value <> "" Then
                blnTMMerch = False: blnTMSrv = False
                arrTM09 = Split("" & RsTemp.Fields(0).Value, ",")
                For ii = LBound(arrTM09) To UBound(arrTM09)
                    If Val(arrTM09(ii)) >= 1 And Val(arrTM09(ii)) <= 34 Then
                        blnTMMerch = True
                    Else
                        blnTMSrv = True
                    End If
                Next ii
                If blnTMMerch = True And blnTMSrv = True Then
                    ExceptFieldData = "商品、服務"
                ElseIf blnTMMerch = True Then
                    ExceptFieldData = "商品"
                ElseIf blnTMSrv = True Then
                    ExceptFieldData = "服務"
                End If
            End If
         End If
        'Add By Cheng 2003/11/28
      Case "商標種類國內名稱"
         strExc(0) = "SELECT PTM03||Decode(TM58, Null, '', Decode(instr(TM58, '原為聯合商標'), 0, Decode(instr(TM58, '原為服務標章'), 0, Decode(instr(TM58, '原為聯合服務標章'), 0, '', '（原為聯合服務標章）'), '（原為服務標章）'), '（原為聯合商標）') ) " & _
                            " FROM TRADEMARK, PatentTrademarkMap WHERE " & TmSt & " And TM08=PTM02(+) And '2'=PTM01 "
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData = "" & RsTemp.Fields(0).Value
         End If
        'End
        'Add By Cheng 2004/01/15
      Case "CFP代表人3(英)"
         strExc(0) = "SELECT PA110 FROM PATENT WHERE " & PaSt
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If "" & RsTemp.Fields(0).Value <> "" Then ExceptFieldData = "Legal Representative: " & RsTemp.Fields(0).Value & " (??? is the surname)"
         End If
      Case "CFP代表人5(英)"
         strExc(0) = "SELECT PA116 FROM PATENT WHERE " & PaSt
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If "" & RsTemp.Fields(0).Value <> "" Then ExceptFieldData = "Legal Representative: " & RsTemp.Fields(0).Value & " (??? is the surname)"
         End If
      Case "CFP代表人7(英)"
         strExc(0) = "SELECT PA122 FROM PATENT WHERE " & PaSt
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If "" & RsTemp.Fields(0).Value <> "" Then ExceptFieldData = "Legal Representative: " & RsTemp.Fields(0).Value & " (??? is the surname)"
         End If
      Case "CFP代表人9(英)"
         strExc(0) = "SELECT PA128 FROM PATENT WHERE " & PaSt
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If "" & RsTemp.Fields(0).Value <> "" Then ExceptFieldData = "Legal Representative: " & RsTemp.Fields(0).Value & " (??? is the surname)"
         End If
        'End
        'Add By Cheng 2004/02/05
      Case "登記項目"
         'Add By Sindy 2013/1/10
         If m_CP01 = "TC" Then
            strExc(0) = "SELECT NVL(PTM03,NVL(PTM04,NVL(PTM05,PTM06))) FROM COPYRIGHTITEM,PATENTTRADEMARKMAP " & _
                        "WHERE PTM01='3' AND PTM02=CRI02 AND CRI01 IN " & _
                        "(SELECT CP09 FROM CASEPROGRESS WHERE CP01='" & m_CP01 & "' AND " & _
                           "CP02='" & m_CP02 & "' AND CP03='" & m_CP03 & "' AND CP04='" & m_CP04 & "' AND CP09<'C')"
         Else
         '2013/1/10 End
            strExc(0) = "SELECT PTM03 FROM COPYRIGHTITEM,PATENTTRADEMARKMAP " & _
                        "WHERE PTM01='3' AND PTM02=CRI02 AND CRI01='" & m_Rule & "' "
         End If
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
             While Not RsTemp.EOF
                 If "" & RsTemp.Fields(0).Value <> "" Then
                     ExceptFieldData = ExceptFieldData & RsTemp.Fields(0).Value & "、"
                 End If
                 RsTemp.MoveNext
             Wend
         End If
         ExceptFieldData = Left(ExceptFieldData, Len(ExceptFieldData) - 1)
         'End
         
      'Add by Morgan 2005/11/9
      Case "案件回覆單"
         'edit by nickc 2006/05/11 解決由本所案號進來的問題
         'strExc(0) = "SELECT ET06 FROM EXCEPTCONDITION WHERE ET01='" & m_FinalSty & _
            "' AND ET02='" & m_CP09 & "' AND ET03='" & m_Situ & "' " & _
            "AND ET04='" & m_User & "' AND ET05='下一程序'"
         strExc(0) = "SELECT ET06 FROM EXCEPTCONDITION WHERE ET01='" & m_FinalSty & _
            "' AND ET02='" & m_SrcKey & "' AND ET03='" & m_Situ & "' " & _
            "AND ET04='" & m_User & "' AND ET05='下一程序'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            'Added by Lydia 2021/01/11 定稿呼叫案件回覆單內容加印費用; P(大陸)核准之領證、CFP期限通知管制表
            If (m_MySt(1) = "P" And m_FinalSty = "05") Or (m_MySt(1) = "CFP" And m_FinalSty = "10") Then
                案件回覆單_AddFee = True
            End If
            'end 2021/01/11
            'Modify by Morgan 2006/5/11
            'If m_CP09 > "C" Then
            If Left(m_CP09, 1) = "C" Then
               'Modified by Lydia 2021/01/11
               'g_PrtForm001.PrintReturnSheet m_CP09, "" & RsTemp.Fields(0), , , True, ExceptFieldData, True
               g_PrtForm001.PrintReturnSheet m_CP09, "" & RsTemp.Fields(0), , , True, ExceptFieldData, True, , , , 案件回覆單_AddFee
            Else
               'Modified by Lydia 2021/01/11
               'g_PrtForm001.PrintReturnSheet , "" & RsTemp.Fields(0), , , True, ExceptFieldData, True, m_CP01 & m_CP02 & m_CP03 & m_CP04
               g_PrtForm001.PrintReturnSheet , "" & RsTemp.Fields(0), , , True, ExceptFieldData, True, m_CP01 & m_CP02 & m_CP03 & m_CP04, , , 案件回覆單_AddFee
            End If
            案件回覆單_AddFee = False 'Added by Lydia 2021/01/11
         End If
         
      Case "案件回覆單2"
         strExc(0) = "SELECT ET06 FROM EXCEPTCONDITION WHERE ET01='" & m_FinalSty & _
            "' AND ET02='" & m_CP09 & "' AND ET03='" & m_Situ & "' " & _
            "AND ET04='" & m_User & "' AND ET05='下一程序2'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            'Modify by Morgan 2006/5/11
            'If m_CP09 > "C" Then
            If Left(m_CP09, 1) = "C" Then
               g_PrtForm001.PrintReturnSheet m_CP09, "" & RsTemp.Fields(0), , , True, ExceptFieldData, True
            Else
               g_PrtForm001.PrintReturnSheet , "" & RsTemp.Fields(0), , , True, ExceptFieldData, True, m_CP01 & m_CP02 & m_CP03 & m_CP04
            End If
         End If
      
      'Add by Morgan 2005/8/10
      Case "出名代理人"
         strExc(0) = "SELECT ST02 FROM CASEPROGRESS,STAFF WHERE INSTR(CP110,ST01)>0 AND CP09='" & m_Rule & "' order by st01"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            RsTemp.MoveFirst
            strExc(0) = RsTemp.GetString(, , , "、")
            ExceptFieldData = Left(strExc(0), Len(strExc(0)) - 1)
         End If
               
      'Add by Morgan 2009/2/2
      Case "出名代理人及稱謂"
         strExc(0) = "SELECT ST02,NVL(OA06,'專利代理人') FROM (SELECT ST02,ST01,CP01 FROM CASEPROGRESS,STAFF WHERE INSTR(CP110,ST01)>0 AND CP09='" & m_Rule & "'),OURAGENT WHERE OA01(+)=CP01 AND OA02(+)=ST01 order by st01"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            RsTemp.MoveFirst
            strExc(1) = ""
            Do While Not RsTemp.EOF
               '名字與稱謂間不必加空白--靜芳
               strExc(1) = strExc(1) & "、" & RsTemp(0) & RsTemp(1)
               RsTemp.MoveNext
            Loop
            ExceptFieldData = Mid(strExc(1), 2)
         End If
               
      'Add by Morgan 2006/3/9
      Case "出名代理人資料"
         ExceptFieldData = GetOurAgentData(m_Rule)

      'Add by Morgan 2007/6/25
      Case "出名代理人/申"
         ExceptFieldData = GetOurAgentData(m_Rule, , 1)
      
      'Add by Morgan 2007/6/25
      Case "出名代理人/申1"
         ExceptFieldData = GetOurAgentData(m_Rule, , 2)
         
      'Add by Morgan 2010/4/29
      Case "出名代理人/申2"
         ExceptFieldData = GetOurAgentData(m_Rule, , 3)
         
      'Add by Morgan 2006/7/6
      Case "出名代理人/英"
         '抓最新發文的AB類出名代理人
          strExc(0) = "select cp110 from caseprogress where cp09<'C' and cp27>0 and cp110 is not null and " & ChgCaseprogress(m_MySt(1) & m_MySt(2) & m_MySt(3) & m_MySt(4)) & " order by cp27 desc, cp09 desc"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            'Modify by Morgan 2007/10/24 不再印林律師
            'strExc(0) = "select st12 from staff where instr('" & RsTemp.Fields(0) & "',st01)>0 order by 1"
            'Modify by Morgan 2010/6/25 改抓 OA07
            'strExc(0) = "select st12 from staff,ouragent where instr('" & RsTemp.Fields(0) & "',st01)>0 and oa02(+)=st01 and oa01='" & m_MySt(1) & "' order by 1"
            strExc(0) = "select nvl(oa07,st12) from staff,ouragent where instr('" & RsTemp.Fields(0) & "',st01)>0 and oa02(+)=st01 and oa01='" & m_MySt(1) & "' order by st01"
            'end 2007/10/24
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               If RsTemp.RecordCount = 1 Then
                  ExceptFieldData = "Mr. " & RsTemp.Fields(0)
               Else
                  Do While Not RsTemp.EOF
                     ExceptFieldData = ExceptFieldData & RsTemp.AbsolutePosition & ". Mr. " & RsTemp.Fields(0) & "  "
                     RsTemp.MoveNext
                  Loop
                  ExceptFieldData = RTrim(ExceptFieldData)
               End If
            End If
         End If
      'Add by Morgan 2006/7/6
      Case "出名代理人/中"
         '抓最新發文的AB類出名代理人
          strExc(0) = "select cp110 from caseprogress where cp09<'C' and cp27>0 and cp110 is not null and " & ChgCaseprogress(m_MySt(1) & m_MySt(2) & m_MySt(3) & m_MySt(4)) & " order by cp27 desc, cp09 desc"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            'Modify by Morgan 2007/10/24 不再印林律師
            'strExc(0) = "select st02 from staff where instr('" & RsTemp.Fields(0) & "',st01)>0 order by 1"
            strExc(0) = "select st02 from staff,ouragent where instr('" & RsTemp.Fields(0) & "',st01)>0 and oa02(+)=st01 and oa01='" & m_MySt(1) & "' order by st01"
            'end 2007/10/24
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               If RsTemp.RecordCount = 1 Then
                  ExceptFieldData = "" & RsTemp.Fields(0)
               Else
                  Do While Not RsTemp.EOF
                     ExceptFieldData = ExceptFieldData & RsTemp.AbsolutePosition & ". " & RsTemp.Fields(0) & "  "
                     RsTemp.MoveNext
                  Loop
                  ExceptFieldData = RTrim(ExceptFieldData)
               End If
            End If
         End If
      'Add by Morgan 2006/8/2
      Case "出名代理人/新"
         '抓最新發文的AB類出名代理人
         strExc(0) = "select cp110 from caseprogress where cp09<'C' and cp27>0 and cp110 is not null and " & ChgCaseprogress(m_MySt(1) & m_MySt(2) & m_MySt(3) & m_MySt(4)) & " order by cp27 desc, cp09 desc"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            'Modify by Morgan 2008/1/10
            'strExc(0) = "select st02 from staff where instr('" & RsTemp.Fields(0) & "',st01)>0 order by 1"
            strExc(0) = "select st02 from staff,ouragent where instr('" & RsTemp.Fields(0) & "',st01)>0 and oa02(+)=st01 and oa01='" & m_MySt(1) & "' order by st01"
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               RsTemp.MoveFirst
               strExc(0) = RsTemp.GetString(, , , "、")
               ExceptFieldData = Left(strExc(0), Len(strExc(0)) - 1)
            End If
         End If
         
      'Add by Morgan 2009/2/2
      Case "出名代理人及稱謂/新"
         '抓最新發文的AB類出名代理人
          strExc(0) = "select cp110 from caseprogress where cp09<'C' and cp27>0 and cp110 is not null and " & ChgCaseprogress(m_MySt(1) & m_MySt(2) & m_MySt(3) & m_MySt(4)) & " order by cp27 desc, cp09 desc"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            strExc(0) = "select st02,NVL(OA06,'專利代理人') from staff,ouragent where instr('" & RsTemp.Fields(0) & "',st01)>0 and oa02(+)=st01 and oa01='" & m_MySt(1) & "' order by st01"
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               RsTemp.MoveFirst
               strExc(1) = ""
               Do While Not RsTemp.EOF
                  '名字與稱謂間不必加空白--靜芳
                  strExc(1) = strExc(1) & "、" & RsTemp(0) & RsTemp(1)
                  RsTemp.MoveNext
               Loop
               ExceptFieldData = Mid(strExc(1), 2)
            End If
         End If
         
      'Add by Morgan 2006/8/17 P開窗用
      Case "客戶案號或專利種類/P"
         strTmp = ExceptFieldData("客戶案件案號/中")
         If strTmp <> "" Then
            ExceptFieldData = strTmp
         Else
            ExceptFieldData = DoChange("國家檔-國名(中）") & DoChange("專利商標種類-國內名稱")
         End If
         
      'Add by Morgan 2006/8/18 P大陸案開窗用
      Case "客戶案號或專利種類/P大"
         strTmp = ExceptFieldData("客戶案件案號/中")
         If strTmp <> "" Then
            ExceptFieldData = strTmp
         Else
            ExceptFieldData = DoChange("國家檔-國名(中）") & DoChange("專利商標種類-大陸名稱")
         End If
      'Add by Morgan 2006/8/17 CFP開窗用
      Case "客戶案號或專利種類/CFP"
         strTmp = ExceptFieldData("客戶案件案號/中")
         If strTmp <> "" Then
            ExceptFieldData = strTmp
         Else
            'Modified by Morgan 2024/6/17 國家後面加空白否則ECPPatent會不好識別
            ExceptFieldData = Left(DoChange("國家檔-國名(中）"), 6) & " " & DoChange("專利商標種類-英文名稱")
         End If

      'Add by Morgan 2007/1/18
      Case "信函傳真/FC"
         strExc(1) = PUB_GetReceiver(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), m_CP10, m_SysKind)
         If strExc(1) <> "" Then
            If Left(strExc(1), 1) = "Y" Then
               strExc(0) = "SELECT FA14,FA15 FROM FAGENT WHERE " & ChgFagent(strExc(1))
            Else
               strExc(0) = "SELECT CU18,CU19 FROM CUSTOMER WHERE " & ChgCustomer(strExc(1))
            End If
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               With RsTemp
                  ExceptFieldData = "" & .Fields(0)
                  If Not IsNull(.Fields(1)) Then
                     If ExceptFieldData <> "" Then
                        ExceptFieldData = ExceptFieldData & ", " & .Fields(1)
                     Else
                        ExceptFieldData = "" & .Fields(1)
                     End If
                  End If
               End With
            End If
         End If
      'Add by Morgan 2007/11/13 傳真,電話 要對齊故需補滿20格
      Case "信函傳真1/FC"
         strExc(1) = PUB_GetReceiver(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), m_CP10, m_SysKind)
         If strExc(1) <> "" Then
            If Left(strExc(1), 1) = "Y" Then
               strExc(0) = "SELECT NVL(FA14,FA15) FROM FAGENT WHERE " & ChgFagent(strExc(1))
            Else
               strExc(0) = "SELECT NVL(CU18,CU19) FROM CUSTOMER WHERE " & ChgCustomer(strExc(1))
            End If
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               ExceptFieldData = "" & RsTemp.Fields(0)
            End If
         End If
         ExceptFieldData = Left(ExceptFieldData & Space(20), 20)
      Case "信函電話1/FC"
         strExc(1) = PUB_GetReceiver(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), m_CP10, m_SysKind)
         If strExc(1) <> "" Then
            If Left(strExc(1), 1) = "Y" Then
               strExc(0) = "SELECT NVL(FA12,FA13) FROM FAGENT WHERE " & ChgFagent(strExc(1))
            Else
               strExc(0) = "SELECT NVL(CU16,CU17) FROM CUSTOMER WHERE " & ChgCustomer(strExc(1))
            End If
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               ExceptFieldData = "" & RsTemp.Fields(0)
            End If
         End If
         ExceptFieldData = Left(ExceptFieldData & Space(20), 20)
      'end 2007/11/13
      'Add by Morgan 2007/1/18
      Case "信函傳真/CF"
         '以案件進度檔代理人抓FAGENT檔，列印出英文名稱及POB或地址
         strExc(0) = "SELECT FA14,FA15 FROM CASEPROGRESS,FAGENT WHERE CP09='" & m_Rule & "' AND FA01(+)=SUBSTR(CP44,1,8) AND FA02(+)=SUBSTR(CP44,9,1)"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            With RsTemp
               ExceptFieldData = "" & .Fields(0)
               If Not IsNull(.Fields(1)) Then
                  If ExceptFieldData <> "" Then
                     ExceptFieldData = ExceptFieldData & ", " & .Fields(1)
                  Else
                     ExceptFieldData = "" & .Fields(1)
                  End If
               End If
            End With
         End If
         
      Case Else
         'edit by nickc 2008/03/05 原先此段移到 2
         ExceptFieldData = ExceptFieldData2(strField, strCP10)
   End Select
End Function

'add by nickc 2008/03/05 因為 ExceptFieldData爆ㄌ
'Modify By Sindy 2015/1/8 加Optional strCP10 As String = ""
Public Function ExceptFieldData2(ByVal strField As String, Optional strCP10 As String = "") As String
Dim strTmp As String, i As Integer, iTmp As String
'Add By Cheng 2003/01/27
Dim strSql As String
Dim rsTmp As ADODB.Recordset
Dim strPA08 As String
Dim strPA09 As String
Dim strPA72 As String
Dim strKey(5) As String
Dim strCaseFee(1 To 2) As String
Dim bFind As Boolean
Dim varPA72 As Variant
Dim varRef As Variant
Dim nPos As Integer
Dim ii As Integer
'Add By Cheng 2003/01/19
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset
'Add By Cheng 2003/01/22
Dim StrSqlB As String
Dim rsB As New ADODB.Recordset
Dim strNP09 As String '法定期限
Dim strNextPayDay  As String '預計以後繳年費日
Dim dblYearDiff As Double
Dim arrTM09 '商品類別陣列
Dim blnTMMerch As Boolean '商品類別屬商品
Dim blnTMSrv As Boolean '商品類別屬服務
'add by nickc 2008/02/27
Dim m_line As Variant
Dim strTemp As String 'Add By Sindy 2010/01/13
Dim bPaper As Boolean 'Added by Morgan2014/8/29
Dim iCopys As Integer 'Added by Morgan 2014/9/4
Dim bReturn As Boolean 'Added by Morgan 2016/10/14
Dim strTM44 As String 'Add By Sindy 2017/4/12
Dim intL As Integer, intA As Integer, intB As Integer, intC As Integer  'Added by Lydia 2019/05/22
Dim stAddrCustNo As String 'Added by Morgan 2021/10/12

   If strCP10 <> "" Then m_CP10 = strCP10 'Add By Sindy 2015/1/8 ex.如撰寫信函中有共用信函抬頭/英
   ExceptFieldData2 = ""
   Select Case strField
      'add by nickc 2007/08/06
      Case "定稿所別"
         Select Case PUB_GetST06(PUB_GetAKindSalesNo(m_CP01, m_CP02, m_CP03, m_CP04))
         Case "2"  '中
                ExceptFieldData2 = "臺中所  電話:(04)23270288(總機) E-Mail:taie@seed.net.tw 地址:臺中市40353臺中港路一段198號10樓"
         Case "3"  '南
                ExceptFieldData2 = "臺南所  電話:(06)2743866(總機) E-Mail:taie@seed.net.tw 地址:臺南市70140府連路364號4樓"
         Case "4"  '高
                ExceptFieldData2 = "高雄所  電話:(07)2363602(總機) E-Mail:taie@seed.net.tw 地址:高雄市80750建國二路36號8樓"
         Case Else     '剩下的歸北所
                ExceptFieldData2 = "臺北所  電話:(02)25061023(總機) E-Mail:taie@seed.net.tw 地址:臺北市10491長安東路二段112號9樓"
        End Select
      Case "定稿傳真"
         Select Case PUB_GetST06(PUB_GetAKindSalesNo(m_CP01, m_CP02, m_CP03, m_CP04))
         Case "2"  '中
                ExceptFieldData2 = "04-23227483"
         Case "3"  '南
                ExceptFieldData2 = "06-2744030"
         Case "4"  '高
                ExceptFieldData2 = "07-2364360"
         Case Else     '剩下的歸北所
                ExceptFieldData2 = "02-25011666"
        End Select
        
      'Add By Sindy 2018/8/6 優先權明細日期和號數
      Case "優先權明細日期和號數/英", "優先權明細日期和號數/日"
         strExc(0) = "SELECT * FROM PriDate WHERE pd01='" & m_MySt(1) & "' AND " & _
            "pd02='" & m_MySt(2) & "' AND pd03='" & m_MySt(3) & "' AND pd04='" & m_MySt(4) & "'" & _
            " order by pd05 asc,pd06 asc"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
'Priority claimed: February 02, 2018   304421006
'                  February 02, 2018   304421024
'                  February 02, 2018   304421033
'                  May 18, 2018        304532102
         If intI = 1 Then
            RsTemp.MoveFirst
            Do While Not RsTemp.EOF
               If Right(strField, 2) = "/英" Then '英文
                  ExceptFieldData2 = ExceptFieldData2 & IIf(ExceptFieldData2 <> "", vbCrLf, "") & _
                                       ParserKeyWord("/", RsTemp.Fields("pd05"), "英") & "  No." & RsTemp.Fields("pd06")
               ElseIf Right(strField, 2) = "/日" Then '日文
                  ExceptFieldData2 = ExceptFieldData2 & IIf(ExceptFieldData2 <> "", vbCrLf, "") & _
                                       ParserKeyWord("/", RsTemp.Fields("pd05"), "格式") & "  No." & RsTemp.Fields("pd06")
               End If
               RsTemp.MoveNext
            Loop
         End If
         
      'Add by Morgan 2007/10/4
      'Modified by Morgan 2019/1/28 +有核對已准專利才印,有核對已准專利不印(反向使用)
      Case "是否核對已准專利", "有核對已准專利才印", "有核對已准專利不印"
         strExc(0) = "select 1 from caseprogress where " & ChgCaseprogress(m_MySt(1) & m_MySt(2) & m_MySt(3) & m_MySt(4)) & " and cp10='926' and cp57 is null"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            'Modify by Morgan 2011/6/24
            'If strPrintType = "3" Then
            '   ExceptFieldData2 = "。"
            'Else
            '   ExceptFieldData2 = "."
            'End If
            ExceptFieldData2 = "♀"
         End If
         
      '2010/4/8 ADD BY SONIA
      Case "來函下一程序"
         strExc(0) = "select DECODE(PA09,'000',CPM03,CPM04) from NEXTPROGRESS,CASEPROPERTYMAP,PATENT where NP01='" & m_Rule & "' AND NP06 IS NULL AND NP02=CPM01 AND NP07=CPM02 AND NP02=PA01 AND NP03=PA02 AND NP04=PA03 AND NP05=PA04 "
         strExc(0) = strExc(0) & " UNION select DECODE(TM10,'000',CPM03,CPM04) from NEXTPROGRESS,CASEPROPERTYMAP,TRADEMARK where NP01='" & m_Rule & "' AND NP06 IS NULL AND NP02=CPM01 AND NP07=CPM02 AND NP02=TM01 AND NP03=TM02 AND NP04=TM03 AND NP05=TM04 "
         strExc(0) = strExc(0) & " UNION select DECODE(SP09,'000',CPM03,CPM04) from NEXTPROGRESS,CASEPROPERTYMAP,SERVICEPRACTICE where NP01='" & m_Rule & "' AND NP06 IS NULL AND NP02=CPM01 AND NP07=CPM02 AND NP02=SP01 AND NP03=SP02 AND NP04=SP03 AND NP05=SP04 "
         strExc(0) = strExc(0) & " UNION select DECODE(LC15,'000',CPM03,CPM04) from NEXTPROGRESS,CASEPROPERTYMAP,LAWCASE where NP01='" & m_Rule & "' AND NP06 IS NULL AND NP02=CPM01 AND NP07=CPM02 AND NP02=LC01 AND NP03=LC02 AND NP04=LC03 AND NP05=LC04 "
         strExc(0) = strExc(0) & " UNION select CPM03 from NEXTPROGRESS,CASEPROPERTYMAP,HIRECASE where NP01='" & m_Rule & "' AND NP06 IS NULL AND NP02=CPM01 AND NP07=CPM02 AND HC01=NP02 AND HC02=NP03 AND HC03=NP04 AND HC04=NP05 "
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData2 = "下一程序：" & RsTemp.Fields(0)
         End If
      Case "來函法定期限"
         strExc(0) = "select NP09 from NEXTPROGRESS where NP01='" & m_Rule & "' AND NP06 IS NULL "
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData2 = "法定期限：" & ChangeWStringToWDateString(RsTemp.Fields(0))
         End If
      Case "來函本所期限"
         strExc(0) = "select NP08 from NEXTPROGRESS where NP01='" & m_Rule & "' AND NP06 IS NULL "
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData2 = "本所期限：" & ChangeWStringToWDateString(RsTemp.Fields(0))
         End If
      Case "來函約定期限"
         strExc(0) = "select NP23 from NEXTPROGRESS where NP01='" & m_Rule & "' AND NP06 IS NULL "
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData2 = "約定期限：" & ChangeWStringToWDateString(RsTemp.Fields(0))
         End If
      '2010/4/8 END
      'Add By Sindy 2016/12/5
      Case "陸代定稿加註"
         strExc(0) = "SELECT FA119 FROM Trademark, Fagent WHERE " & TmSt & _
                     " And substr(TM44,1,8)=FA01(+) And substr(TM44,9,1)=FA02(+)"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If Not IsNull(RsTemp.Fields(0)) Then
               ExceptFieldData2 = "* " & RsTemp.Fields(0).Value
            End If
         End If
      '2016/12/5 END
      'Add by Morgan 2009/6/17
      Case "PCT申請號/P"
         strExc(0) = "SELECT PA91 FROM PATENT WHERE " & PaSt
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If Not IsNull(RsTemp.Fields(0)) Then
               ExceptFieldData2 = PUB_GetPCTPriNo("" & RsTemp.Fields(0).Value)
            Else
               ExceptFieldData2 = "PCT申請號"
            End If
         End If
      
      'Add By Sindy 2014/11/25
      Case "發明人(中)/發明人(英)"
         Select Case m_SysKind
            Case 1 '專利
               'IN05:無英文抓日文,無日文抓中文
               strExc(0) = "SELECT IN04,NVL(NVL(IN05,IN06),IN04) FROM PATENTINVENTOR,INVENTOR,NATION WHERE PI01='" & m_MySt(1) & "' AND PI02='" & m_MySt(2) & "' AND PI03='" & m_MySt(3) & "' AND PI04='" & m_MySt(4) & "' AND SUBSTR(PI06,1,8)=IN01(+) AND SUBSTR(PI06,9,2)=IN02(+) AND IN11=NA01(+) ORDER BY PI05 ASC"
         End Select
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         ExceptFieldData2 = ""
         If intI = 1 Then
            RsTemp.MoveFirst
            Do While Not RsTemp.EOF
               If Not IsNull(RsTemp.Fields(0)) Or Not IsNull(RsTemp.Fields(1)) Then
                  If ExceptFieldData2 = "" Then
                     ExceptFieldData2 = "" & RsTemp.Fields(0).Value & "／( " & RsTemp.Fields(1).Value & " )"
                  Else
                     ExceptFieldData2 = ExceptFieldData2 & vbCrLf & "　　　　　　　　　　　　" & RsTemp.Fields(0).Value & "／( " & RsTemp.Fields(1).Value & " )"
                  End If
               End If
               RsTemp.MoveNext
            Loop
         End If
      'Add By Sindy 2014/11/25
      Case "發明人地址(中)/發明人地址(英)"
         Select Case m_SysKind
            Case 1 '專利
               strExc(0) = "SELECT IN07,IN08 FROM PATENTINVENTOR,INVENTOR,NATION WHERE PI01='" & m_MySt(1) & "' AND PI02='" & m_MySt(2) & "' AND PI03='" & m_MySt(3) & "' AND PI04='" & m_MySt(4) & "' AND SUBSTR(PI06,1,8)=IN01(+) AND SUBSTR(PI06,9,2)=IN02(+) AND IN11=NA01(+) ORDER BY PI05 ASC"
         End Select
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         ExceptFieldData2 = ""
         If intI = 1 Then
            RsTemp.MoveFirst
            Do While Not RsTemp.EOF
               If Not IsNull(RsTemp.Fields(0)) Or Not IsNull(RsTemp.Fields(1)) Then
                  If ExceptFieldData2 = "" Then
                     ExceptFieldData2 = "" & RsTemp.Fields(0).Value & "／( " & RsTemp.Fields(1).Value & " )"
                  Else
                     ExceptFieldData2 = ExceptFieldData2 & vbCrLf & "　　　　　　　　　　　　" & RsTemp.Fields(0).Value & "／( " & RsTemp.Fields(1).Value & " )"
                  End If
               End If
               RsTemp.MoveNext
            Loop
         End If
      'Add By Sindy 2014/11/25
      Case "發明人地址(中)/大"
         Select Case m_SysKind
            Case 1 '專利
               strExc(0) = "SELECT IN07 FROM PATENTINVENTOR,INVENTOR,NATION WHERE PI01='" & m_MySt(1) & "' AND PI02='" & m_MySt(2) & "' AND PI03='" & m_MySt(3) & "' AND PI04='" & m_MySt(4) & "' AND SUBSTR(PI06,1,8)=IN01(+) AND SUBSTR(PI06,9,2)=IN02(+) AND IN11=NA01(+) ORDER BY PI05 ASC"
         End Select
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         ExceptFieldData2 = ""
         If intI = 1 Then
            RsTemp.MoveFirst
            Do While Not RsTemp.EOF
               If Not IsNull(RsTemp.Fields(0)) Then
                  If ExceptFieldData2 = "" Then
                     ExceptFieldData2 = RsTemp.Fields(0).Value
                  Else
                     ExceptFieldData2 = ExceptFieldData2 & vbCrLf & "　　　　　　　　　　　　" & RsTemp.Fields(0).Value
                  End If
               End If
               RsTemp.MoveNext
            Loop
         End If
      'Add By Sindy 2014/11/25
      Case "發明人地址(英)/大"
         Select Case m_SysKind
            Case 1 '專利
               strExc(0) = "SELECT IN08 FROM PATENTINVENTOR,INVENTOR,NATION WHERE PI01='" & m_MySt(1) & "' AND PI02='" & m_MySt(2) & "' AND PI03='" & m_MySt(3) & "' AND PI04='" & m_MySt(4) & "' AND SUBSTR(PI06,1,8)=IN01(+) AND SUBSTR(PI06,9,2)=IN02(+) AND IN11=NA01(+) ORDER BY PI05 ASC"
         End Select
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         ExceptFieldData2 = ""
         If intI = 1 Then
            RsTemp.MoveFirst
            Do While Not RsTemp.EOF
               If Not IsNull(RsTemp.Fields(0)) Then
                  If ExceptFieldData2 = "" Then
                     ExceptFieldData2 = RsTemp.Fields(0).Value
                  Else
                     ExceptFieldData2 = ExceptFieldData2 & vbCrLf & "　　　　　　　　　　　　" & RsTemp.Fields(0).Value
                  End If
               End If
               RsTemp.MoveNext
            Loop
         End If
      
      'Add by Morgan 2009/6/17
      Case "發明人1地址(中)/大", "發明人2地址(中)/大", "發明人3地址(中)/大", "發明人4地址(中)/大", "發明人5地址(中)/大", "發明人6地址(中)/大", "發明人7地址(中)/大", "發明人8地址(中)/大", "發明人9地址(中)/大", "發明人10地址(中)/大"
         'Modify By Sindy 2014/11/25 改用 發明人地址(中)/大
         If strSrvDate(1) >= 專利發明人檔啟用日 Then
            ExceptFieldData2 = ""
         Else
         '2014/11/25 END
            strExc(1) = 59 + Val(Mid(strField, 4, 2))
            Select Case m_SysKind
               Case 1 '專利
                  strExc(0) = "SELECT IN07 FROM PATENT,INVENTOR,NATION WHERE SUBSTR(PA" & strExc(1) & ",1,8)=IN01(+) AND SUBSTR(PA" & strExc(1) & ",9,2)=IN02(+) AND IN11=NA01(+) AND " & PaSt
            End Select
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               If Not IsNull(RsTemp.Fields(0)) Then
                  ExceptFieldData2 = "" & RsTemp.Fields(0).Value
               End If
            End If
         End If
         
      Case "發明人1地址(英)/大", "發明人2地址(英)/大", "發明人3地址(英)/大", "發明人4地址(英)/大", "發明人5地址(英)/大", "發明人6地址(英)/大", "發明人7地址(英)/大", "發明人8地址(英)/大", "發明人9地址(英)/大", "發明人10地址(英)/大"
         'Modify By Sindy 2014/11/25 改用 發明人地址(英)/大
         If strSrvDate(1) >= 專利發明人檔啟用日 Then
            ExceptFieldData2 = ""
         Else
         '2014/11/25 END
            strExc(1) = 59 + Val(Mid(strField, 4, 2))
            Select Case m_SysKind
               Case 1 '專利
                  strExc(0) = "SELECT IN08 FROM PATENT,INVENTOR,NATION WHERE SUBSTR(PA" & strExc(1) & ",1,8)=IN01(+) AND SUBSTR(PA" & strExc(1) & ",9,2)=IN02(+) AND IN11=NA01(+) AND " & PaSt
            End Select
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               If Not IsNull(RsTemp.Fields(0)) Then
                  ExceptFieldData2 = "" & RsTemp.Fields(0).Value
               End If
            End If
         End If
      'end 2009/6/17
      
      'Modify By Sindy 2014/11/25 無使用Mark
'      'Add by Morgan 2009/9/21
'      Case "發明人1國籍/英", "發明人2國籍/英", "發明人3國籍/英", "發明人4國籍/英", "發明人5國籍/英", "發明人6國籍/英", "發明人7國籍/英", "發明人8國籍/英", "發明人9國籍/英", "發明人10國籍/英"
'         Select Case m_SysKind
'            Case 1 '專利
'               strExc(1) = 59 + Val(Mid(strField, 4, 2))
'               strExc(0) = "SELECT decode(substr(NA01,1,2),'00','Taiwan, R.O.C.',NA04) FROM PATENT,INVENTOR,NATION WHERE SUBSTR(PA" & strExc(1) & ",1,8)=IN01(+) AND SUBSTR(PA" & strExc(1) & ",9,2)=IN02(+) AND IN11=NA01(+) AND " & PaSt
'         End Select
'         intI = 1
'         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
'         If intI = 1 Then
'            If Not IsNull(RsTemp.Fields(0)) Then
'               ExceptFieldData2 = "" & RsTemp.Fields(0).Value
'            Else
'               ExceptFieldData2 = ""
'            End If
'         End If
         
      'Added by Morgan 2016/10/14
      Case "副本收受人"
         If PUB_GetCC(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), strExc(3)) Then
            strExc(0) = "select NVL(NVL(CU104,CU04),CU05||' '||CU88||' '||CU89||' '||CU90) from customer where cu01='" & Left(strExc(3), 8) & "' and cu02='" & Mid(strExc(3), 9) & "'"
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               If Not IsNull(RsTemp.Fields(0)) Then
                  ExceptFieldData2 = "" & RsTemp.Fields(0).Value
               End If
            End If
         Else
            ExceptFieldData2 = ""
         End If
      
      'add by nickc 2008/02/27
      'Modified by Morgan 2016/10/14 +中申開窗郵號-副
      Case "中申開窗郵號", "中申開窗郵號-副"
         'Modify by Morgan 2008/8/8 改呼叫共用函數
         ExceptFieldData2 = String(17, "　")
         If ChkNoAddr() = False Then 'Added by Morgan 2018/10/17 E化客戶定稿不要印郵遞區號及地址
            'Added by Morgan 2016/10/14
            If Right(strField, 2) = "-副" Then
               If PUB_GetCC(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), strExc(3), strExc(4)) Then
                  If PUB_GetAddrRef(strExc(3), , , , , , , strExc(0), , , strExc(4)) = True Then
                     ExceptFieldData2 = strExc(0) & String(17 - Len(strExc(0)), "　")
                  End If
               End If
            Else
            'end 2016/10/14
               If PUB_GetAddrRef("", m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), , , strExc(0)) = True Then
                  ExceptFieldData2 = strExc(0) & String(17 - Len(strExc(0)), "　")
               End If
            End If 'Added by Morgan 2016/10/14
            'end 2008/8/8
         End If
         g_ExceptFieldData2 = ExceptFieldData2 'Add By Sindy 2010/01/13
         
      'add by nickc 2008/02/27
      'Modified by Morgan 2016/10/14 +中申開窗郵號/掛-副
      Case "中申開窗郵號/掛", "中申開窗郵號/掛-副"
         stAddrCustNo = "" 'Added by Morgan 2021/10/12
         'Modify by Morgan 2008/8/8 改呼叫共用函數(8/10改印框線)
         'Added by Morgan 2018/11/19 E化客戶定稿不要印郵遞區號及地址(掛號信目前只有79075的特定Y編號不寄紙本)
         If ChkNoAddr() = True Then
            ExceptFieldData2 = String(17, "　")
         Else
         'end 2018/11/19
            ExceptFieldData2 = String(13, "　")
            'Added by Morgan 2016/10/14
            If Right(strField, 2) = "-副" Then
               If PUB_GetCC(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), strExc(3), strExc(4)) Then
                  If PUB_GetAddrRef(strExc(3), , , , , , , strExc(0), , , strExc(4)) = True Then
                     ExceptFieldData2 = strExc(0) & String(13 - Len(strExc(0)), "　")
                  End If
               End If
            'Modified by Morgan 2025/7/22
            'Else
            ElseIf ChkRegisteredMail() = False Then
            'end 2025/7/22
            'end 2016/10/14
               'Modified by Morgan 2021/10/12
               If PUB_GetAddrRef(stAddrCustNo, m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), , , strExc(0)) = True Then
                  ExceptFieldData2 = strExc(0) & String(13 - Len(strExc(0)), "　")
               End If
            End If 'Added by Morgan 2016/10/14
            
            'ExceptFieldData2 = ExceptFieldData2 & "＊掛號＊"
            '2008/10/29 MODIFY BY SONIA 國外部收文之案件不印掛號 P-088579
            'ExceptFieldData2 = ExceptFieldData2 & "　|#(框線)掛號#|　"
            'Modify By Sindy 2015/8/31 + Mid(GetStaffDepartment(PUB_GetAKindSalesNo(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4))), 1, 2) = "F3"
            '                          因法務部開始收專利商標的關係 ex.T-197272
            'modify by sonia 2018/8/10 改判斷PUB_GetAddrRef傳出strExc(0)郵遞區號是否有值,否則國外部收文之國內客戶就不會印'掛號'CFT-012485
            If Mid(GetStaffDepartment(PUB_GetAKindSalesNo(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4))), 1, 1) <> "F" Or _
               Mid(GetStaffDepartment(PUB_GetAKindSalesNo(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4))), 1, 2) = "F3" Or strExc(0) <> "" Then
               
               'Added by Morgan 2021/10/12 X15416020(宋健民)案件掛號改為雙掛號
               If stAddrCustNo = "X15416020" Then
                  ExceptFieldData2 = ExceptFieldData2 & "　|#(框線)雙掛號#|"
               Else
                  ExceptFieldData2 = ExceptFieldData2 & "　|#(框線)掛號#|　"
               End If
               'end 2021/10/12

               'Modified by Morgan 2021/10/8 從Nowprint移來(原來程式位置沒有作用)
               'Added by Morgan 2018/1/11
               'E化非直寄取消掛號字樣 --郭
               If g_LD18 <> "" And strExc(0) = "" Then
                  strExc(0) = "select * from letterprogress where lp01='" & g_LD18 & "' and lp26='Y' and NVL(lp11,'N')<>'Y'"
                  intI = 1
                  Set AdoRecordSet3 = ClsLawReadRstMsg(intI, strExc(0))
                  If intI = 1 Then
                     ExceptFieldData2 = Replace(ExceptFieldData2, "|#(框線)掛號#|", "　　")
                     ExceptFieldData2 = Replace(ExceptFieldData2, "|#(框線)雙掛號#|", "　　　")
                  End If
               End If
               'end 2018/1/11
               
            'Added by Morgan 2014/6/16
            Else
               ExceptFieldData2 = ExceptFieldData2 & String(4, "　")
            'end 2014/6/16
            End If
            '2008/10/29 END
            'end 2008/8/8
         End If
         
      'Added by Morgan 2014/5/12
      Case "中申開窗郵號/平", "中申開窗郵號/平-副"
         'Added by Morgan 2018/11/14 E化客戶定稿不要印郵遞區號及地址
         If ChkNoAddr() = True Then
            ExceptFieldData2 = String(17, "　")
         Else
         'end 2018/11/17
            ExceptFieldData2 = String(13, "　")
            'Added by Morgan 2016/10/14
            If Right(strField, 2) = "-副" Then
               If PUB_GetCC(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), strExc(3), strExc(4)) Then
                  If PUB_GetAddrRef(strExc(3), , , , , , , strExc(0), , , strExc(4)) = True Then
                     ExceptFieldData2 = strExc(0) & String(13 - Len(strExc(0)), "　")
                  End If
               End If
            Else
            'end 2016/10/14
               If PUB_GetAddrRef("", m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), , , strExc(0)) = True Then
                  ExceptFieldData2 = strExc(0) & String(13 - Len(strExc(0)), "　")
               End If
            End If 'Added by Morgan 2016/10/14
            
            'Added by Morgan 2015/5/12 純E化不印
            'Memoed by Morgan 2016/10/14 與秀玲討論決定目前副本E化設定同正本不另外判斷
            If PUB_GetEMailFlag(m_MySt(1) & m_MySt(2) & m_MySt(3) & m_MySt(4), , , bPaper) = True And bPaper = False Then
               ExceptFieldData2 = ExceptFieldData2 & "　　　　"
            Else
            'end 2015/5/12
            
               If Mid(GetStaffDepartment(PUB_GetAKindSalesNo(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4))), 1, 1) <> "F" Then
                  'Modified by Morgan 2014/5/23 不要框--謝經理
                  'ExceptFieldData2 = ExceptFieldData2 & "　|#(框線)平信#|　"
                  ExceptFieldData2 = ExceptFieldData2 & "　平信　"
               'Added by Morgan 2015/5/12
               Else
                  ExceptFieldData2 = ExceptFieldData2 & "　　　　"
               'end 2015/5/12
               End If
               
            End If 'Added by Morgan 2015/5/12
            
         End If 'Added by Morgan 2018/11/14
            
      'add by nickc 2008/02/27
      'Add By Sindy 2013/11/4 +中申開窗地址/多個案號
      'Modified by Morgan 2025/7/29 +, "中申開窗地址/集體2", "中申開窗地址/集體2-副"
      Case "中申開窗地址", "中申開窗地址/集體", "中申開窗地址/多個案號", "中申開窗地址-副", "中申開窗地址/集體-副", "中申開窗地址/多個案號-副", "中申開窗地址/集體2", "中申開窗地址/集體2-副"
         bReturn = False
         'Added by Morgan 2016/10/14
         If Right(strField, 2) = "-副" Then
            If PUB_GetCC(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), strExc(3), strExc(4)) Then
               m_LP33 = strExc(3): m_LP34 = strExc(4)
               bReturn = PUB_GetAddrRef(strExc(3), , , , , strExc(0), strExc(1), , strExc(2), , strExc(4))
            End If
         Else
            'Modify by Morgan 2008/8/8 改呼叫共用函數
            bReturn = PUB_GetAddrRef("", m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), strExc(0), strExc(1), , strExc(2))
         End If
         
         If bReturn Then
            '地址
            If strExc(2) = "" Then
               ExceptFieldData2 = String(20, "　")
            'Added by Morgan 2018/10/17 E化客戶定稿不要印郵遞區號及地址
            ElseIf ChkNoAddr() = True Then
               ExceptFieldData2 = String(20, "　")
            'end 2018/10/17
            Else
               ExceptFieldData2 = ToWide(Trim(CheckStr(strExc(2))))
            End If
            '收件人
            'Modify by Morgan 2011/1/11 T173149 申請人名稱未造字留空白不可去除
            'ExceptFieldData2 = ExceptFieldData2 & vbCrLf & Trim(CheckStr(strExc(0)))
            ExceptFieldData2 = ExceptFieldData2 & vbCrLf & RTrim(strExc(0))
            '接洽人
            ExceptFieldData2 = ExceptFieldData2 & vbCrLf & RTrim(strExc(1))
            If Len(Trim(CheckStr(strExc(1)))) < 6 Then
               ExceptFieldData2 = ExceptFieldData2 & String(6 - Len(Trim(CheckStr(strExc(1)))), "　") & "鈞啟"
            Else
               ExceptFieldData2 = ExceptFieldData2 & "　鈞啟"
            End If
         End If
         
         'end 2008/8/8
         If ExceptFieldData2 <> "" Then
            'Add By Sindy 2013/11/4
            'Modified by Morgan 2016/10/14
            'If strField = "中申開窗地址/多個案號" Then
            If InStr(strField, "中申開窗地址/多個案號") = 1 Then
'               '等地址折行完成後再加上案號...取消,改回案號也要折行
               strExc(0) = "SELECT ET06 FROM EXCEPTCONDITION" & _
                           " where ET01='" & m_FinalSty & "' and ET02='" & m_CP09 & "' and ET03='" & m_Situ & "'" & _
                           " and ET05='多個案號'"
               intI = 1
               Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
               If intI = 1 Then
                  If Trim("" & RsTemp.Fields("ET06")) <> "" Then
                     ExceptFieldData2 = ExceptFieldData2 & Trim(RsTemp.Fields("ET06"))
                  Else
                     If m_MySt(3) & m_MySt(4) = "000" Then
                        ExceptFieldData2 = ExceptFieldData2 & "(" & m_MySt(1) & "-" & m_MySt(2) & ")"
                     Else
                        ExceptFieldData2 = ExceptFieldData2 & "(" & m_MySt(1) & "-" & m_MySt(2) & "-" & m_MySt(3) & "-" & m_MySt(4) & ")"
                     End If
                  End If
               End If
            Else
            '2013/11/4 END
               If m_MySt(3) & m_MySt(4) = "000" Then
                  'Add by Morgan 2010/5/25
                  'Modified by Morgan 2016/10/14
                  'If strField = "中申開窗地址/集體" Then
                  If InStr(strField, "中申開窗地址/集體") = 1 Then
                     ExceptFieldData2 = ExceptFieldData2 & "(" & m_MySt(1) & "-" & m_MySt(2) & GetMaxPA03(m_MySt(1), m_MySt(2), m_MySt(4)) & ")"
                  'Added by Morgan 2025/7/29
                  ElseIf InStr(strField, "中申開窗地址/集體2") = 1 Then
                     ExceptFieldData2 = ExceptFieldData2 & "(" & m_MySt(1) & "-" & m_MySt(2) & GetMaxPA03(m_MySt(1), m_MySt(2), m_MySt(4), True) & ")"
                  'end 2025/7/29
                  Else
                  'end 2010/5/25
                     ExceptFieldData2 = ExceptFieldData2 & "(" & m_MySt(1) & "-" & m_MySt(2) & ")"
                  End If
               Else
                    ExceptFieldData2 = ExceptFieldData2 & "(" & m_MySt(1) & "-" & m_MySt(2) & "-" & m_MySt(3) & "-" & m_MySt(4) & ")"
               End If
            End If
            m_line = Split(ExceptFieldData2, vbCrLf)
            For ii = 0 To UBound(m_line)
                 ExceptFieldData2 = m_line(ii)
                 Do While ExceptFieldData2 <> StrToStr(ExceptFieldData2, 17)
                     If InStr(1, m_line(ii), StrToStr(ExceptFieldData2, 17)) = 1 Then
                         m_line(ii) = Mid(m_line(ii), 1, InStr(1, m_line(ii), StrToStr(ExceptFieldData2, 17)) - 1) & StrToStr(ExceptFieldData2, 17) & vbCrLf & Replace(m_line(ii), StrToStr(ExceptFieldData2, 17), "")
                     Else
                         m_line(ii) = Mid(m_line(ii), 1, InStr(1, m_line(ii), StrToStr(ExceptFieldData2, 17)) - 1) & StrToStr(ExceptFieldData2, 17) & vbCrLf & Replace(Mid(m_line(ii), InStr(1, m_line(ii), StrToStr(ExceptFieldData2, 17))), StrToStr(ExceptFieldData2, 17), "")
                     End If
                     ExceptFieldData2 = Replace(ExceptFieldData2, StrToStr(ExceptFieldData2, 17), "")
                 Loop
            Next ii
            ExceptFieldData2 = Join(m_line, vbCrLf)
            m_line = Split(ExceptFieldData2, vbCrLf)
            For ii = 0 To UBound(m_line)
                 m_line(ii) = m_line(ii)
            Next ii
            ExceptFieldData2 = Join(m_line, vbCrLf)
'            'Add By Sindy 2013/11/4
'            If strField = "中申開窗地址/多個案號" Then
'               strExc(0) = "SELECT ET06 FROM EXCEPTCONDITION" & _
'                           " where ET01='" & m_FinalSty & "' and ET02='" & m_CP09 & "' and ET03='" & m_Situ & "'" & _
'                           " and ET05='多個案號'"
'               intI = 1
'               Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
'               If intI = 1 Then
'                  If Trim("" & RsTemp.Fields("ET06")) <> "" Then
'                     ExceptFieldData2 = ExceptFieldData2 & Trim(RsTemp.Fields("ET06"))
'                  Else
'                     If m_MySt(3) & m_MySt(4) = "000" Then
'                        ExceptFieldData2 = ExceptFieldData2 & "(" & m_MySt(1) & "-" & m_MySt(2) & ")"
'                     Else
'                        ExceptFieldData2 = ExceptFieldData2 & "(" & m_MySt(1) & "-" & m_MySt(2) & "-" & m_MySt(3) & "-" & m_MySt(4) & ")"
'                     End If
'                  End If
'               End If
'            End If
'            '2013/11/4 END
            m_line = Split(ExceptFieldData2, vbCrLf)
            If UBound(m_line) < 3 Then
                 ExceptFieldData2 = ExceptFieldData2 & vbCrLf
            End If
         End If
         g_ExceptFieldData2 = ExceptFieldData2 'Add By Sindy 2010/01/13
         
      'add by nickc 2008/02/27
      Case "中代開窗地址"
         Select Case m_SysKind
            Case 1 '專利
               '2008/11/19 modify by sonia 聯絡人先抓案件的聯絡人,再抓代理人的
               'strExc(0) = "SELECT fa17,NVL(fa04,fa05||' '||fa63||' '||fa64||' '||fa65),fa07 FROM PATENT,fagent WHERE " & PaSt & " and substr(pa75,1,8)=fa01(+) and substr(pa75,9,1)=fa02(+) "
               'Modify By Sindy 2010/01/13 增加抓FC代理人欄位
               'strExc(0) = "SELECT fa17,NVL(fa04,fa05||' '||fa63||' '||fa64||' '||fa65),nvl(pa51,fa07) FROM PATENT,fagent WHERE " & PaSt & " and substr(pa75,1,8)=fa01(+) and substr(pa75,9,1)=fa02(+) "
               '2015/1/9 modify by sonia 聯絡人無中文抓英文18碼,無英文抓中文
               'strExc(0) = "SELECT fa17,NVL(fa04,fa05||' '||fa63||' '||fa64||' '||fa65),nvl(pa51,fa07),pa75 FROM PATENT,fagent WHERE " & PaSt & " and substr(pa75,1,8)=fa01(+) and substr(pa75,9,1)=fa02(+) "
               'Modified by Morgan 2017/1/12 加聯絡人2,另有跟秀玲確不必限制字數,日文還要加部門欄位
               'strExc(0) = "SELECT fa17,NVL(fa04,fa05||' '||fa63||' '||fa64||' '||fa65),nvl(pa51,decode(pa52||pa53,null,fa07,null)) tm38,pa75,substr(nvl(pa52,decode(pa53,null,fa08,null)),1,18) tm39,nvl(pa53,fa09) tm40 FROM PATENT,fagent WHERE " & PaSt & " and substr(pa75,1,8)=fa01(+) and substr(pa75,9,1)=fa02(+) "
               strExc(0) = "SELECT fa17,NVL(fa04,fa05||' '||fa63||' '||fa64||' '||fa65),nvl(pa51,decode(pa52||pa53,null,fa07,null)) tm38,pa75,nvl(pa52,decode(pa53,null,fa08,null)) tm39,nvl(pa53,fa09) tm40,decode(pa53,'',fa78,pa139) tm76" & _
                  ",decode(pa51||pa52||pa53,'',fa52,pa54) tm41,decode(pa51||pa52||pa53,'',fa53,pa55) tm42,decode(pa51||pa52||pa53,'',fa54,pa56)tm43" & _
                  " FROM PATENT,fagent WHERE " & PaSt & " and substr(pa75,1,8)=fa01(+) and substr(pa75,9,1)=fa02(+) "
            Case 2 '商標
               '2008/11/19 modify by sonia 聯絡人先抓案件的聯絡人,再抓代理人的
               'strExc(0) = "SELECT fa17,NVL(fa04,fa05||' '||fa63||' '||fa64||' '||fa65),fa07 FROM TRADEMARK,fagent WHERE " & TmSt & " and substr(tm44,1,8)=fa01(+) and substr(tm44,9,1)=fa02(+) "
               'Modify By Sindy 2010/01/13 增加抓FC代理人欄位
               'strExc(0) = "SELECT fa17,NVL(fa04,fa05||' '||fa63||' '||fa64||' '||fa65),nvl(tm38,fa07) FROM TRADEMARK,fagent WHERE " & TmSt & " and substr(tm44,1,8)=fa01(+) and substr(tm44,9,1)=fa02(+) "
               'Modify By Sindy 2013/12/3
               'strExc(0) = "SELECT fa17,NVL(fa04,fa05||' '||fa63||' '||fa64||' '||fa65),nvl(tm38,fa07),tm44 FROM TRADEMARK,fagent WHERE " & TmSt & " and substr(tm44,1,8)=fa01(+) and substr(tm44,9,1)=fa02(+) "
               '2015/1/9 modify by sonia 聯絡人無中文抓英文18碼,無英文抓中文
               'strExc(0) = "SELECT NVL(fa17,fa18||' '||fa19||' '||fa20||' '||fa21||' '||fa22||' '||fa70),NVL(fa04,fa05||' '||fa63||' '||fa64||' '||fa65),nvl(tm38,fa07),tm44 FROM TRADEMARK,fagent WHERE " & TmSt & " and substr(tm44,1,8)=fa01(+) and substr(tm44,9,1)=fa02(+) "
               'Modified by Morgan 2017/1/12 加聯絡人2,另有跟秀玲確不必限制字數,日文還要加部門欄位
               'strExc(0) = "SELECT NVL(fa17,fa18||' '||fa19||' '||fa20||' '||fa21||' '||fa22||' '||fa70),NVL(fa04,fa05||' '||fa63||' '||fa64||' '||fa65),nvl(tm38,decode(tm39||tm40,null,fa07,null)) tm38,tm44,substr(nvl(tm39,decode(tm40,null,fa08,null)),1,18) tm39,nvl(tm40,fa09) tm40 FROM TRADEMARK,fagent WHERE " & TmSt & " and substr(tm44,1,8)=fa01(+) and substr(tm44,9,1)=fa02(+) "
               strExc(0) = "SELECT NVL(fa17,fa18||' '||fa19||' '||fa20||' '||fa21||' '||fa22||' '||fa70),NVL(fa04,fa05||' '||fa63||' '||fa64||' '||fa65),nvl(tm38,decode(tm39||tm40,null,fa07,null)) tm38,tm44,nvl(tm39,decode(tm40,null,fa08,null)) tm39,nvl(tm40,fa09) tm40,decode(tm40,'',fa78,tm76) tm76" & _
                  ",decode(tm38||tm39||tm40,'',fa52,tm41) tm41,decode(tm38||tm39||tm40,'',fa53,tm42) tm42,decode(tm38||tm39||tm40,'',fa54,tm43)tm43" & _
                  " FROM TRADEMARK,fagent WHERE " & TmSt & " and substr(tm44,1,8)=fa01(+) and substr(tm44,9,1)=fa02(+) "
            Case 3 '法務
               '2008/11/19 modify by sonia 聯絡人先抓案件的聯絡人,再抓代理人的
               'strExc(0) = "SELECT fa17,NVL(fa04,fa05||' '||fa63||' '||fa64||' '||fa65),fa07 FROM LAWCASE,fagent WHERE " & LcSt & " and substr(lc22,1,8)=fa01(+) and substr(lc22,9,1)=fa02(+) "
               'Modify By Sindy 2010/01/13 增加抓FC代理人欄位
               'strExc(0) = "SELECT fa17,NVL(fa04,fa05||' '||fa63||' '||fa64||' '||fa65),nvl(lc18,fa07) FROM LAWCASE,fagent WHERE " & LcSt & " and substr(lc22,1,8)=fa01(+) and substr(lc22,9,1)=fa02(+) "
               '2015/1/9 modify by sonia 聯絡人無中文抓英文18碼,無英文抓中文
               'strExc(0) = "SELECT fa17,NVL(fa04,fa05||' '||fa63||' '||fa64||' '||fa65),nvl(lc18,fa07),lc22 FROM LAWCASE,fagent WHERE " & LcSt & " and substr(lc22,1,8)=fa01(+) and substr(lc22,9,1)=fa02(+) "
               'Modified by Morgan 2017/1/12 加聯絡人2,另有跟秀玲確不必限制字數,日文還要加部門欄位
               'strExc(0) = "SELECT fa17,NVL(fa04,fa05||' '||fa63||' '||fa64||' '||fa65),nvl(lc18,decode(lc19||lc20,null,fa07,null)) tm38,lc22,substr(nvl(lc19,decode(lc20,null,fa08,null)),1,18) tm39,nvl(lc20,fa09) tm40 FROM LAWCASE,fagent WHERE " & LcSt & " and substr(lc22,1,8)=fa01(+) and substr(lc22,9,1)=fa02(+) "
               strExc(0) = "SELECT fa17,NVL(fa04,fa05||' '||fa63||' '||fa64||' '||fa65),nvl(lc18,decode(lc19||lc20,null,fa07,null)) tm38,lc22,nvl(lc19,decode(lc20,null,fa08,null)) tm39,nvl(lc20,fa09) tm40,decode(lc20,'',fa78,lc39) tm76" & _
                  ",'' tm41,'' tm42,'' tm43 FROM LAWCASE,fagent WHERE " & LcSt & " and substr(lc22,1,8)=fa01(+) and substr(lc22,9,1)=fa02(+) "
               
            Case 4 '顧問
               'modify by sonia 2015/12/3 T*案件聯絡人無中文抓英文18碼,無英文抓中文(2015/1/9漏改此段)
               'strExc(0) = "SELECT '','','','' FROM HIRECASE,fagent WHERE " & HcSt & "  "
               strExc(0) = "SELECT '','','' tm38,'','' tm39,'' tm40,'' tm76,'' tm41,'' tm42,'' tm43 FROM HIRECASE,fagent WHERE " & HcSt & "  "
            Case 5, 6   '服務
               '2008/11/19 modify by sonia 聯絡人先抓案件的聯絡人,再抓代理人的
               'strExc(0) = "SELECT fa17,NVL(fa04,fa05||' '||fa63||' '||fa64||' '||fa65),fa07 FROM SERVICEPRACTICE,fagent WHERE " & SpSt & " and substr(sp26,1,8)=fa01(+) and substr(sp26,9,1)=fa02(+) "
               'Modify By Sindy 2010/01/13 增加抓FC代理人欄位
               'strExc(0) = "SELECT fa17,NVL(fa04,fa05||' '||fa63||' '||fa64||' '||fa65),nvl(sp30,fa07) FROM SERVICEPRACTICE,fagent WHERE " & SpSt & " and substr(sp26,1,8)=fa01(+) and substr(sp26,9,1)=fa02(+) "
               'modify by sonia 2015/12/3 T*案件聯絡人無中文抓英文18碼,無英文抓中文(2015/1/9漏改此段)
               'strExc(0) = "SELECT fa17,NVL(fa04,fa05||' '||fa63||' '||fa64||' '||fa65),nvl(sp30,fa07),sp26 FROM SERVICEPRACTICE,fagent WHERE " & SpSt & " and substr(sp26,1,8)=fa01(+) and substr(sp26,9,1)=fa02(+) "
               If Left(m_MySt(1), 1) = "T" Then
                  strExc(0) = "SELECT NVL(fa17,fa18||' '||fa19||' '||fa20||' '||fa21||' '||fa22||' '||fa70),NVL(fa04,fa05||' '||fa63||' '||fa64||' '||fa65),nvl(sp30,fa07) tm38,sp26,'' tm39,'' tm40,'' tm76,'' tm41,'' tm42,'' tm43 FROM SERVICEPRACTICE,fagent WHERE " & SpSt & " and substr(sp26,1,8)=fa01(+) and substr(sp26,9,1)=fa02(+) "
               Else
                  strExc(0) = "SELECT fa17,NVL(fa04,fa05||' '||fa63||' '||fa64||' '||fa65),nvl(sp30,fa07) tm38,sp26,'' tm39,'' tm40,'' tm76,'' tm41,'' tm42,'' tm43 FROM SERVICEPRACTICE,fagent WHERE " & SpSt & " and substr(sp26,1,8)=fa01(+) and substr(sp26,9,1)=fa02(+) "
               End If
               'end 2015/12/3
         End Select
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         'Add By Sindy 2010/01/13
         strTemp = ""
         If intI <> 1 Then strTemp = "中申開窗"
         'Modified by Morgan 2017/1/12 要分開判斷否則會當
         'If intI = 1 And IsNull(RsTemp.Fields(3).Value) Then strTemp = "中申開窗"
         If intI = 1 Then
            If IsNull(RsTemp.Fields(3).Value) Then strTemp = "中申開窗"
         End If
         'end 2017/1/12
         If strTemp = "中申開窗" Then
            Call ExceptFieldData2("中申開窗郵號")
            strTemp = Trim(g_ExceptFieldData2)
            Call ExceptFieldData2("中申開窗地址")
            If strTemp <> "" Then
               strTemp = strTemp & vbCrLf & Trim(g_ExceptFieldData2)
            Else
               strTemp = Trim(g_ExceptFieldData2)
            End If
            ExceptFieldData2 = strTemp
            Exit Function
         End If
         '2010/01/13 End
         If intI = 1 Then
            If IsNull(RsTemp.Fields(0).Value) Then
               ExceptFieldData2 = ""
            Else
               '2015/1/9 modify by sonia 聯絡人無中文抓英文18碼,無英文抓中文
               'ExceptFieldData2 = Trim(CheckStr(RsTemp.Fields(0))) & vbCrLf & Trim(CheckStr(RsTemp.Fields(1))) & vbCrLf & Trim(CheckStr(RsTemp.Fields(2))) & String(6 - Len(Trim(CheckStr(RsTemp.Fields(2)))), "　") & "鈞啟"
               If ChkNoAddr() = True Then 'Added by Morgan 2018/10/17 E化客戶定稿不要印郵遞區號及地址
                  ExceptFieldData2 = vbCrLf & Trim(CheckStr(RsTemp.Fields(1)))  'Added by Morgan 2017/1/16
               Else
                  ExceptFieldData2 = Trim(CheckStr(RsTemp.Fields(0))) & vbCrLf & Trim(CheckStr(RsTemp.Fields(1))) 'Added by Morgan 2017/1/16
               End If
               '中文
               If Trim(CheckStr(RsTemp.Fields("tm38"))) <> "" Then
                  'Modified by Morgan 2017/1/12 +聯絡人2
                  'ExceptFieldData2 = Trim(CheckStr(RsTemp.Fields(0))) & vbCrLf & Trim(CheckStr(RsTemp.Fields(1))) & vbCrLf & Trim(CheckStr(RsTemp.Fields(2))) & String(6 - Len(Trim(CheckStr(RsTemp.Fields(2)))), "　") & "鈞啟"
                  If IsNull(RsTemp.Fields("tm41")) Then
                     'Modified by Morgan 2017/9/4 日文聯絡人會超過6個字
                     If Len(Trim(CheckStr(RsTemp.Fields(2)))) < 6 Then
                        ExceptFieldData2 = ExceptFieldData2 & vbCrLf & Trim(CheckStr(RsTemp.Fields(2))) & String(6 - Len(Trim(CheckStr(RsTemp.Fields(2)))), "　") & "鈞啟"
                     Else
                        ExceptFieldData2 = ExceptFieldData2 & vbCrLf & Trim(CheckStr(RsTemp.Fields(2))) & " 鈞啟"
                     End If
                  Else
                     ExceptFieldData2 = ExceptFieldData2 & vbCrLf & Trim(CheckStr(RsTemp.Fields(2)))
                     'Modified by Morgan 2017/9/4 日文聯絡人會超過6個字
                     If Len(Trim(CheckStr(RsTemp.Fields("tm41")))) < 6 Then
                        ExceptFieldData2 = ExceptFieldData2 & vbCrLf & Trim(CheckStr(RsTemp.Fields("tm41"))) & String(6 - Len(Trim(CheckStr(RsTemp.Fields("tm41")))), "　") & "鈞啟"
                     Else
                        ExceptFieldData2 = ExceptFieldData2 & vbCrLf & Trim(CheckStr(RsTemp.Fields("tm41"))) & " 鈞啟"
                     End If
                  End If
                  'end 2017/1/12
                  
               '英文
               ElseIf Trim(CheckStr(RsTemp.Fields("tm39"))) <> "" Then
                  'Modified by Morgan 2017/1/12 +聯絡人2,且不必限制長度
                  'ExceptFieldData2 = Trim(CheckStr(RsTemp.Fields(0))) & vbCrLf & Trim(CheckStr(RsTemp.Fields(1))) & vbCrLf & Trim(CheckStr(RsTemp.Fields("tm39"))) & String(18 - Len(Trim(CheckStr(RsTemp.Fields("tm39")))), " ") & "鈞啟"
                  If IsNull(RsTemp.Fields("tm42")) Then
                     ExceptFieldData2 = ExceptFieldData2 & vbCrLf & Trim(CheckStr(RsTemp.Fields("tm39"))) & " 鈞啟"
                  Else
                     ExceptFieldData2 = ExceptFieldData2 & vbCrLf & Trim(CheckStr(RsTemp.Fields("tm39")))
                     ExceptFieldData2 = ExceptFieldData2 & vbCrLf & Trim(CheckStr(RsTemp.Fields("tm42"))) & " 鈞啟"
                  End If
                  'end 2017/1/12
                  
               Else
                  'Modified by Morgan 2016/3/1 日文聯絡人會超過6個字
                  'Modified by Morgan 2017/1/12 +聯絡人部門,聯絡人2
                  'If Len(Trim(CheckStr(RsTemp.Fields("tm40")))) > 6 Then
                  '   ExceptFieldData2 = Trim(CheckStr(RsTemp.Fields(0))) & vbCrLf & Trim(CheckStr(RsTemp.Fields(1))) & vbCrLf & Trim(CheckStr(RsTemp.Fields("tm40"))) & "　鈞啟"
                  'Else
                  '   ExceptFieldData2 = Trim(CheckStr(RsTemp.Fields(0))) & vbCrLf & Trim(CheckStr(RsTemp.Fields(1))) & vbCrLf & Trim(CheckStr(RsTemp.Fields("tm40"))) & String(6 - Len(Trim(CheckStr(RsTemp.Fields("tm40")))), "　") & "鈞啟"
                  'End If
                  
                  '日文
                  If Trim(CheckStr(RsTemp.Fields("tm40"))) <> "" Then
                     '聯絡人部門
                     If Not IsNull(RsTemp.Fields("tm76")) Then
                        ExceptFieldData2 = ExceptFieldData2 & vbCrLf & Trim(CheckStr(RsTemp.Fields("tm76")))
                     End If
                     If IsNull(RsTemp.Fields("tm43")) Then
                        ExceptFieldData2 = ExceptFieldData2 & vbCrLf & Trim(CheckStr(RsTemp.Fields("tm40"))) & " 鈞啟"
                     Else
                        ExceptFieldData2 = ExceptFieldData2 & vbCrLf & Trim(CheckStr(RsTemp.Fields("tm40")))
                        ExceptFieldData2 = ExceptFieldData2 & vbCrLf & Trim(CheckStr(RsTemp.Fields("tm43"))) & " 鈞啟"
                     End If
                  Else
                     ExceptFieldData2 = ExceptFieldData2 & vbCrLf & String(6, "　") & "鈞啟"
                  End If
                  'end 2017/1/12
               End If
               'end
               
               If m_MySt(3) & m_MySt(4) = "000" Then
                    ExceptFieldData2 = ExceptFieldData2 & "(" & m_MySt(1) & "-" & m_MySt(2) & ")"
               Else
                    ExceptFieldData2 = ExceptFieldData2 & "(" & m_MySt(1) & "-" & m_MySt(2) & "-" & m_MySt(3) & "-" & m_MySt(4) & ")"
               End If
               m_line = Split(ExceptFieldData2, vbCrLf)
               For ii = 0 To UBound(m_line)
                    ExceptFieldData2 = m_line(ii)
                    Do While ExceptFieldData2 <> StrToStr(ExceptFieldData2, 17)
                        If InStr(1, m_line(ii), StrToStr(ExceptFieldData2, 17)) = 1 Then
                            m_line(ii) = Mid(m_line(ii), 1, InStr(1, m_line(ii), StrToStr(ExceptFieldData2, 17)) - 1) & StrToStr(ExceptFieldData2, 17) & vbCrLf & Replace(m_line(ii), StrToStr(ExceptFieldData2, 17), "")
                        Else
                            m_line(ii) = Mid(m_line(ii), 1, InStr(1, m_line(ii), StrToStr(ExceptFieldData2, 17)) - 1) & StrToStr(ExceptFieldData2, 17) & vbCrLf & Replace(Mid(m_line(ii), InStr(1, m_line(ii), StrToStr(ExceptFieldData2, 17))), StrToStr(ExceptFieldData2, 17), "")
                        End If
                        ExceptFieldData2 = Replace(ExceptFieldData2, StrToStr(ExceptFieldData2, 17), "")
                    Loop
               Next ii
               ExceptFieldData2 = Join(m_line, vbCrLf)
               m_line = Split(ExceptFieldData2, vbCrLf)
               For ii = 0 To UBound(m_line)
                    m_line(ii) = m_line(ii)
               Next ii
               ExceptFieldData2 = Join(m_line, vbCrLf)
               m_line = Split(ExceptFieldData2, vbCrLf)
               If UBound(m_line) < 3 Then
                    ExceptFieldData2 = ExceptFieldData2 & vbCrLf
               End If
            End If
         End If
      'Add By Sindy 2017/3/30 FCT的需求
      Case "Classes"
         strExc(0) = "SELECT tm01,nvl(tm09,'') tm09 FROM TRADEMARK WHERE " & TmSt & " "
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         ExceptFieldData2 = ""
         If intI = 1 Then
            If InStr(RsTemp.Fields("tm09"), ",") > 0 Then
                ExceptFieldData2 = "Classes: "
            Else
                ExceptFieldData2 = "Class: "
            End If
            ExceptFieldData2 = ExceptFieldData2 & RsTemp.Fields("tm09")
         End If
      '2017/3/30 END
      'Add By Sindy 2017/4/5 FCT的需求
      Case "多類別要印"
         strExc(0) = "SELECT tm01,nvl(tm09,'') tm09 FROM TRADEMARK WHERE " & TmSt & " "
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         ExceptFieldData2 = ""
         If intI = 1 Then
            If InStr(RsTemp.Fields("tm09"), ",") > 0 Then
                ExceptFieldData2 = "♀"
            End If
         End If
      '2017/4/5 END
      Case "多人申請"
         Select Case m_SysKind
            Case 1 '專利
               strExc(0) = "SELECT pa26,pa27,pa28,pa29,pa30 FROM PATENT WHERE " & PaSt & " "
            Case 2 '商標
               strExc(0) = "SELECT tm23,tm78,tm79,tm80,tm81 FROM TRADEMARK WHERE " & TmSt & " "
            Case 3 '法務
               'Modify By Sindy 2011/2/21 增加LC43,LC44,LC45,LC46
               strExc(0) = "SELECT lc11,lc43,lc44,lc45,lc46 FROM LAWCASE WHERE " & LcSt & " "
            Case 4 '顧問
               'Modify By Sindy 2011/2/21 增加HC24,HC25,HC26,HC27
               strExc(0) = "SELECT hc05,hc24,hc25,hc26,hc27 FROM HIRECASE WHERE " & HcSt & " "
            Case 5, 6   '服務
               strExc(0) = "SELECT sp08,sp58,sp59,sp65,sp66 FROM SERVICEPRACTICE WHERE " & SpSt & " "
         End Select
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         ExceptFieldData2 = "　　　　　　"
         If intI = 1 Then
            If Not IsNull(RsTemp.Fields(0).Value) And (Not IsNull(RsTemp.Fields(1).Value) Or Not IsNull(RsTemp.Fields(2).Value) Or Not IsNull(RsTemp.Fields(3).Value) Or Not IsNull(RsTemp.Fields(4).Value)) Then
                ExceptFieldData2 = "（多人申請）"
            ElseIf Not IsNull(RsTemp.Fields(1).Value) And (Not IsNull(RsTemp.Fields(0).Value) Or Not IsNull(RsTemp.Fields(2).Value) Or Not IsNull(RsTemp.Fields(3).Value) Or Not IsNull(RsTemp.Fields(4).Value)) Then
                ExceptFieldData2 = "（多人申請）"
            ElseIf Not IsNull(RsTemp.Fields(2).Value) And (Not IsNull(RsTemp.Fields(0).Value) Or Not IsNull(RsTemp.Fields(1).Value) Or Not IsNull(RsTemp.Fields(3).Value) Or Not IsNull(RsTemp.Fields(4).Value)) Then
                ExceptFieldData2 = "（多人申請）"
            ElseIf Not IsNull(RsTemp.Fields(3).Value) And (Not IsNull(RsTemp.Fields(0).Value) Or Not IsNull(RsTemp.Fields(1).Value) Or Not IsNull(RsTemp.Fields(2).Value) Or Not IsNull(RsTemp.Fields(4).Value)) Then
                ExceptFieldData2 = "（多人申請）"
            ElseIf Not IsNull(RsTemp.Fields(4).Value) And (Not IsNull(RsTemp.Fields(0).Value) Or Not IsNull(RsTemp.Fields(1).Value) Or Not IsNull(RsTemp.Fields(2).Value) Or Not IsNull(RsTemp.Fields(3).Value)) Then
                ExceptFieldData2 = "（多人申請）"
            End If
         End If
      
      'Add by Sindy 2021/2/4 有E化,及因疾情不能郵寄的都要顯示出”E-mail:”
      Case "電子信箱/FC/催延展"
         Dim strNA86 As String '是否停止郵務
         Call GetPrjPeopleNum6(m_MySt(1) & "-" & m_MySt(2) & "-" & m_MySt(3) & "-" & m_MySt(4), "NA86", strNA86)
         '有E化 或 停止郵務
         If PUB_GetEMailFlag(m_MySt(1) & m_MySt(2) & m_MySt(3) & m_MySt(4), m_CP10 = "605") = True Or _
            strNA86 = "Y" Then
            '不管有無資料都要印
            If strPrintType = "3" Then '日文
               ExceptFieldData2 = "ＥＭＡＩＬ："
            Else
               'Modify by Morgan 2011/6/22
               'ExceptFieldData2 = "E-mail : "
               ExceptFieldData2 = "E-mail: "
            End If
            strExc(1) = PUB_GetReceiver(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), m_CP10, m_SysKind)
            If strExc(1) <> "" Then
               If Left(strExc(1), 1) = "Y" Then
                  strExc(0) = "SELECT FA16 FROM FAGENT WHERE " & ChgFagent(strExc(1))
               Else
                  strExc(0) = "SELECT CU20 FROM CUSTOMER WHERE " & ChgCustomer(strExc(1))
               End If
               intI = 1
               Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
               If intI = 1 Then
                  With RsTemp
                     ExceptFieldData2 = ExceptFieldData2 & .Fields(0)
                  End With
               End If
            End If
         End If
         
      'Add by Morgan 2008/3/20 要存電子檔的才印
      Case "電子信箱/FC"
         If PUB_GetEMailFlag(m_MySt(1) & m_MySt(2) & m_MySt(3) & m_MySt(4), m_CP10 = "605") = True Then
            '不管有無資料都要印
            If strPrintType = "3" Then '日文
               ExceptFieldData2 = "ＥＭＡＩＬ："
            Else
               'Modify by Morgan 2011/6/22
               'ExceptFieldData2 = "E-mail : "
               ExceptFieldData2 = "E-mail: "
            End If
            strExc(1) = PUB_GetReceiver(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), m_CP10, m_SysKind)
            If strExc(1) <> "" Then
               If Left(strExc(1), 1) = "Y" Then
                  strExc(0) = "SELECT FA16 FROM FAGENT WHERE " & ChgFagent(strExc(1))
               Else
                  strExc(0) = "SELECT CU20 FROM CUSTOMER WHERE " & ChgCustomer(strExc(1))
               End If
               intI = 1
               Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
               If intI = 1 Then
                  With RsTemp
                     ExceptFieldData2 = ExceptFieldData2 & .Fields(0)
                  End With
               End If
            End If
         End If
      
      'Add by Morgan 2015/6/16 E化的才印
      Case "電子信箱"
         If PUB_GetEMailFlag(m_MySt(1) & m_MySt(2) & m_MySt(3) & m_MySt(4)) = True Then
            strExc(0) = "select pa26,pa75 from patent where pa01='" & m_MySt(1) & "' and pa02='" & m_MySt(2) & "' and pa03='" & m_MySt(3) & "' and pa04='" & m_MySt(4) & "' and pa26 is not null"
            strExc(0) = strExc(0) & " union all select tm23,tm44 from trademark where tm01='" & m_MySt(1) & "' and tm02='" & m_MySt(2) & "' and tm03='" & m_MySt(3) & "' and tm04='" & m_MySt(4) & "' and tm23 is not null"
            strExc(0) = strExc(0) & " union all select sp08,sp26 from servicepractice where sp01='" & m_MySt(1) & "' and sp02='" & m_MySt(2) & "' and sp03='" & m_MySt(3) & "' and sp04='" & m_MySt(4) & "' and sp08 is not null"
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               ExceptFieldData2 = "E-mail: "
               If Not IsNull(RsTemp(1)) Then
                  strExc(0) = "SELECT FA16 FROM FAGENT WHERE fa01='" & Left(RsTemp(1), 8) & "' and fa02='" & Mid(RsTemp(1), 9) & "'"
               Else
                  strExc(0) = "SELECT CU20 FROM CUSTOMER WHERE cu01='" & Left(RsTemp(0), 8) & "' and cu02='" & Mid(RsTemp(0), 9) & "'"
               End If
               intI = 1
               Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
               If intI = 1 Then
                  ExceptFieldData2 = ExceptFieldData2 & RsTemp.Fields(0)
               End If
            End If
         End If
         
      'Added by Morgan 2018/10/22 收件人為客戶的定稿
      Case "指定信箱"
         strExc(0) = "select pa26 from patent where pa01='" & m_MySt(1) & "' and pa02='" & m_MySt(2) & "' and pa03='" & m_MySt(3) & "' and pa04='" & m_MySt(4) & "' and pa26 is not null"
         strExc(0) = strExc(0) & " union all select tm23 from trademark where tm01='" & m_MySt(1) & "' and tm02='" & m_MySt(2) & "' and tm03='" & m_MySt(3) & "' and tm04='" & m_MySt(4) & "' and tm23 is not null"
         strExc(0) = strExc(0) & " union all select sp08 from servicepractice where sp01='" & m_MySt(1) & "' and sp02='" & m_MySt(2) & "' and sp03='" & m_MySt(3) & "' and sp04='" & m_MySt(4) & "' and sp08 is not null"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If PUB_ChkECust(RsTemp(0), m_MySt(1), strExc(0), intI, m_bolSalesHandle) = True Then
               'Modified by Morgan 2021/10/12 指定信箱只帶第1個(因開放可設多個信箱及副本)
               If InStr(strExc(0), ";") > 0 Then
                  strExc(0) = Left(strExc(0), InStr(strExc(0), ";") - 1)
               End If
               'end 2021/10/12
               ExceptFieldData2 = "E-mail: " & strExc(0)
               
               If strSrvDate(1) >= e化客戶啟用日 And intI = 1 Then m_bolECust = True
               If m_bolSalesHandle Then m_bolXECust = True 'Added by Morgan 2025/11/11
            End If
         End If
         
      'Added by Morgan 2018/11/21
      Case "指定信箱-副"
         If PUB_GetCC(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), strExc(3)) = True Then
            bReturn = PUB_ChkECust(strExc(3), m_MySt(1), strExc(0), intI)
            If bReturn = True Then
               ExceptFieldData2 = "E-mail: " & strExc(0)
               If strSrvDate(1) >= e化客戶啟用日 And intI = 1 Then m_bolECust = True
            End If
            'Added by Morgan 2018/11/21 更新信函進度
            'Removed by Morgan 2022/3/21
            'If g_LD18 <> "" Then
            '   UpdateNoneApplLtr g_LD18, IIf(bReturn = True, "Y", ""), strExc(3)
            'End If
            'end 2022/3/21
            'End 2018/11/21
         End If
         
      'Added by Morgan 2018/10/16
      Case "指定信箱/被授權"
         strExc(0) = "SELECT CP72 FROM CASEPROGRESS WHERE CP09='" & m_Rule & "' and CP72 is not null"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            bReturn = PUB_ChkECust(RsTemp(0), m_MySt(1), strExc(0), intI, m_bolSalesHandle)
            If bReturn = True Then
               ExceptFieldData2 = "E-mail: " & strExc(0)
               If strSrvDate(1) >= e化客戶啟用日 And intI = 1 Then m_bolECust = True
               If m_bolSalesHandle Then m_bolXECust = True 'Added by Morgan 2025/11/11
            End If
            'Added by Morgan 2018/11/5 更新信函進度
            If g_LD18 <> "" Then
               UpdateNoneApplLtr g_LD18, IIf(bReturn = True, "Y", ""), RsTemp(0)
            End If
            'End 2018/11/5
         End If
         
      'Added by Morgan 2018/10/17
      Case "指定信箱/移轉"
         strExc(0) = "SELECT CP56 FROM CASEPROGRESS WHERE CP09='" & m_Rule & "' and CP56 is not null"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            bReturn = PUB_ChkECust(RsTemp(0), m_MySt(1), strExc(0), intI, m_bolSalesHandle)
            If bReturn = True Then
               ExceptFieldData2 = "E-mail: " & strExc(0)
               If strSrvDate(1) >= e化客戶啟用日 And intI = 1 Then m_bolECust = True
               If m_bolSalesHandle Then m_bolXECust = True 'Added by Morgan 2025/11/11
            End If
            'Added by Morgan 2018/11/5 更新信函進度
            If g_LD18 <> "" Then
               UpdateNoneApplLtr g_LD18, IIf(bReturn = True, "Y", ""), RsTemp(0)
            End If
            'End 2018/11/5
         End If
      
      'Added by Morgan 2018/10/17
      Case "指定信箱/移轉人"
         strExc(0) = "SELECT CP55 FROM CASEPROGRESS WHERE CP09='" & m_Rule & "' and CP55 is not null"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            bReturn = PUB_ChkECust(RsTemp(0), m_MySt(1), strExc(0), intI, m_bolSalesHandle)
            If bReturn = True Then
               ExceptFieldData2 = "E-mail: " & strExc(0)
               If strSrvDate(1) >= e化客戶啟用日 And intI = 1 Then m_bolECust = True
               If m_bolSalesHandle Then m_bolXECust = True 'Added by Morgan 2025/11/11
            End If
            'Added by Morgan 2018/11/5 更新信函進度
            If g_LD18 <> "" Then
               UpdateNoneApplLtr g_LD18, IIf(bReturn = True, "Y", ""), RsTemp(0)
            End If
            'End 2018/11/5
         End If
         
      'Added by Morgan 2018/10/17
      Case "指定信箱/相關被授權"
         strExc(0) = "SELECT CP72 FROM CASEPROGRESS WHERE CP09=(SELECT CP43 FROM CASEPROGRESS WHERE CP09='" & m_Rule & "') and CP72 is not null"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            bReturn = PUB_ChkECust(RsTemp(0), m_MySt(1), strExc(0), intI, m_bolSalesHandle)
            If bReturn = True Then
               ExceptFieldData2 = "E-mail: " & strExc(0)
               If strSrvDate(1) >= e化客戶啟用日 And intI = 1 Then m_bolECust = True
               If m_bolSalesHandle Then m_bolXECust = True 'Added by Morgan 2025/11/11
            End If
            'Added by Morgan 2018/11/5 更新信函進度
            If g_LD18 <> "" Then
               UpdateNoneApplLtr g_LD18, IIf(bReturn = True, "Y", ""), RsTemp(0)
            End If
            'End 2018/11/5
         End If
         
      'Added by Morgan 2012/12/11
      Case "非e化才印", "e化不印"
         If PUB_GetEMailFlag(m_MySt(1) & m_MySt(2) & m_MySt(3) & m_MySt(4), m_CP10 = "605") = False Then
            ExceptFieldData2 = "♀"
         End If
      
      'Added by Morgan 2014/4/24
      Case "e化才印", "非e化不印"
         If PUB_GetEMailFlag(m_MySt(1) & m_MySt(2) & m_MySt(3) & m_MySt(4), m_CP10 = "605") = True Then
            ExceptFieldData2 = "♀"
         End If
         
      'Added by Morgan 2014/8/29
      'Modified by Morgan 2017/3/9 FCP核准函(frm060316_1)有例外設定(特定Y+X不寄紙本)
      Case "寄紙本才印", "不寄紙本不印"
         If PUB_GetEMailFlag(m_MySt(1) & m_MySt(2) & m_MySt(3) & m_MySt(4), m_CP10 = "605", , bPaper) = True Then
            If bPaper = True Then
               'Modified by Morgan 2014/9/4
               'ExceptFieldData2 = "♀"
               PUB_GetCopySetting iCopys, m_CP01, m_CP02, m_CP03, m_CP04, m_CP10, m_FinalSty, m_Situ
               If iCopys <> 1 Then ExceptFieldData2 = "♀"
               'end 2014/9/4
            End If
         Else
            ExceptFieldData2 = "♀"
         End If
      
      'Added by Morgan 2014/8/29
      'Modified by Morgan 2017/3/9 FCP核准函(frm060316_1)有例外設定(特定Y+X不寄紙本)
      Case "不寄紙本才印", "寄紙本不印"
         If PUB_GetEMailFlag(m_MySt(1) & m_MySt(2) & m_MySt(3) & m_MySt(4), m_CP10 = "605", , bPaper) = True Then
            If bPaper = False Then
               ExceptFieldData2 = "♀"
            'Added by Morgan 2014/9/4
            Else
               PUB_GetCopySetting iCopys, m_CP01, m_CP02, m_CP03, m_CP04, m_CP10, m_FinalSty, m_Situ
               If iCopys = 1 Then ExceptFieldData2 = "♀"
            'end 2014/9/4
            End If
         End If
         
      'Add by Morgan 2008/3/26 要存電子檔的印信箱,否則印傳真
      Case "信箱或傳真/FC"
         '不管有無資料都要印
         strExc(1) = PUB_GetReceiver(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), m_CP10, m_SysKind)
         'EMail
         If PUB_GetEMailFlag(m_MySt(1) & m_MySt(2) & m_MySt(3) & m_MySt(4), (m_CP10 = "605" Or m_CP10 = "1605")) = True Then
            strExc(2) = "1"
            If strPrintType = "3" Then '日文
               ExceptFieldData2 = "ＥＭＡＩＬ："
            Else
               'Modify by Morgan 2011/6/22
               'ExceptFieldData2 = "E-mail : "
               ExceptFieldData2 = "E-mail: "
            End If
         'Fax
         Else
            strExc(2) = "2"
            If strPrintType = "3" Then '日文
               ExceptFieldData2 = "ＦＡＸ："
            Else
               'Modify by Morgan 2011/6/22
               'ExceptFieldData2 = "Fax : "
               ExceptFieldData2 = "Fax: "
            End If
         End If
         If strExc(1) <> "" Then
            If Left(strExc(1), 1) = "Y" Then
               strExc(0) = "SELECT FA14,FA15,FA16 FROM FAGENT WHERE " & ChgFagent(strExc(1))
            Else
               strExc(0) = "SELECT CU18,CU19,CU20 FROM CUSTOMER WHERE " & ChgCustomer(strExc(1))
            End If
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               With RsTemp
                  'EMail
                  If strExc(2) = "1" Then
                     ExceptFieldData2 = ExceptFieldData2 & .Fields(2)
                  'Fax
                  Else
                     If Not IsNull(.Fields(0)) And Not IsNull(.Fields(1)) Then
                        ExceptFieldData2 = ExceptFieldData2 & .Fields(0) & ", " & .Fields(1)
                     Else
                        ExceptFieldData2 = ExceptFieldData2 & .Fields(0) & .Fields(1)
                     End If
                  End If
               End With
            End If
         End If
         
      'Add by Morgan 2010/12/17
      Case "電子信箱/CF"
         ExceptFieldData2 = PUB_GetCFAgentEMail(m_Rule)
      
      'Add by Morgan 2010/12/17
      Case "系統時間"
         ExceptFieldData2 = Now
         
      'Add by Sindy 2010/8/3 FCT傳真信函且操作人員為F1*者, 抓取FAX2
      Case "FCTFAX2"
         ExceptFieldData2 = ""
         If m_MySt(1) = "FCT" And Left(Trim(Pub_StrUserSt15), 2) = "F1" Then
            strExc(0) = "SELECT FA15 FROM Trademark,FAGENT WHERE TM01='" & m_MySt(1) & "' AND TM02='" & m_MySt(2) & "' AND TM03='" & m_MySt(3) & "' AND TM04='" & m_MySt(4) & "' AND TM44 is not null AND FA01(+)=substr(TM44,1,8) AND FA02(+)=substr(TM44,9) "
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               With RsTemp
                  If Not IsNull(.Fields(0)) Then
                     ExceptFieldData2 = "FAX: " & .Fields(0)
                  End If
               End With
            End If
         End If
         
      'Add by Morgan 2008/5/15
      Case "相關案申請資料"
         strExc(0) = "select na04,pa10,pa11 from (" & PUB_GetRelCaseVTB(m_MySt) & "),patent,nation" & _
            " where pa01(+)=X01 and pa02(+)=X02 and pa03(+)=X03 and pa04(+)=X04" & _
            " and pa10>0 and na01(+)=pa09 "
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData2 = ""
            With RsTemp
            Do While Not .EOF
               If Not IsNull(.Fields("pa11")) Then
                  ExceptFieldData2 = ExceptFieldData2 & " " & _
                  .Fields("na04") & " application No. " & .Fields("pa11") & " was filed on " & ChgEngDate(.Fields("pa10")) & "."
               Else
                  ExceptFieldData2 = ExceptFieldData2 & " " & _
                  .Fields("na04") & " application was filed on " & ChgEngDate(.Fields("pa10")) & "."
               End If
               .MoveNext
            Loop
            End With
         End If
         
      'Add by Morgan 2008/6/23
      Case "申請案發文日"
         strExc(0) = "select cp27 from caseprogress" & _
            " where " & ChgCaseprogress(m_MySt(1) & m_MySt(2) & m_MySt(3) & m_MySt(4)) & " and cp10 in ('101','102','103') order by 1 desc"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData2 = "" & RsTemp.Fields(0)
         End If
         
      'Add by Morgan 2008/7/9 不抓聯絡人,全半型都算1字
      'Modify by Morgan 2010/6/10 +不印本所號
      Case "中代開窗地址/CF", "中代開窗地址/CF/不印本所號"
         'Added by Morgan 2025/10/22 若已電子化則應該要抓發文的代理人這樣EMail抓收件人時才會一致
         If g_LD18 <> "" Then
            strExc(0) = "SELECT fa17,NVL(fa04,fa05||' '||fa63||' '||fa64||' '||fa65) FROM CASEPROGRESS,FAGENT WHERE CP09='" & g_LD18 & "' AND FA01(+)=SUBSTR(CP44,1,8) AND FA02(+)=SUBSTR(CP44,9,1)"
         Else
         'end 2025/10/22
         
            'Modified by Morgan 2011/11/18
            '考慮有可能換過代理人,P案的解除期限/取消收文定稿改抓最新發文代理人(檢索報告例外) Ex.P-092000
            'strExc(0) = "SELECT fa17,NVL(fa04,fa05||' '||fa63||' '||fa64||' '||fa65) FROM CASEPROGRESS,FAGENT WHERE CP09='" & m_Rule & "' AND FA01(+)=SUBSTR(CP44,1,8) AND FA02(+)=SUBSTR(CP44,9,1)"
            If m_MySt(1) = "P" And m_FinalSty = "14" And m_MySt(5) <> "421" Then
               strExc(0) = "SELECT fa17,NVL(fa04,fa05||' '||fa63||' '||fa64||' '||fa65) FROM CASEPROGRESS,FAGENT" & _
                  " WHERE " & ChgCaseprogress(m_MySt(1) & m_MySt(2) & m_MySt(3) & m_MySt(4)) & _
                  " AND CP44 Is Not Null AND CP09<'C' and cp57 is null AND FA01(+)=SUBSTR(CP44,1,8) AND FA02(+)=SUBSTR(CP44,9,1)" & _
                  " Order By CP27 Desc, CP09 Desc"
            Else
               strExc(0) = "SELECT fa17,NVL(fa04,fa05||' '||fa63||' '||fa64||' '||fa65) FROM CASEPROGRESS,FAGENT WHERE CP09='" & m_Rule & "' AND FA01(+)=SUBSTR(CP44,1,8) AND FA02(+)=SUBSTR(CP44,9,1)"
            End If
            
         End If 'Added by Morgan 2025/10/22
         'end 2011/11/18
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            'Modified by Morgan 2012/4/11 +考慮只有收件人但沒有地址情形(只傳真不需地址)--Ex.P-100999 敏惠
            'If IsNull(RsTemp.Fields(0).Value) Then
            If Trim(RsTemp.Fields(0).Value & RsTemp.Fields(1).Value) = Empty Then
               'Modify by Morgan 2008/10/13 要預留空白--郭
               'ExceptFieldData2 = ""
               ExceptFieldData2 = vbCrLf & vbCrLf & vbCrLf & vbCrLf
            Else
               ExceptFieldData2 = Trim(CheckStr(RsTemp.Fields(0))) & vbCrLf & Trim(CheckStr(RsTemp.Fields(1)))
               
               m_line = Split(ExceptFieldData2, vbCrLf)
               For ii = 0 To UBound(m_line)
                    ExceptFieldData2 = m_line(ii)
                    Do While ExceptFieldData2 <> Left(ExceptFieldData2, 17)
                        If InStr(1, m_line(ii), Left(ExceptFieldData2, 17)) = 1 Then
                            m_line(ii) = Mid(m_line(ii), 1, InStr(1, m_line(ii), Left(ExceptFieldData2, 17)) - 1) & Left(ExceptFieldData2, 17) & vbCrLf & Replace(m_line(ii), Left(ExceptFieldData2, 17), "")
                        Else
                            m_line(ii) = Mid(m_line(ii), 1, InStr(1, m_line(ii), Left(ExceptFieldData2, 17)) - 1) & Left(ExceptFieldData2, 17) & vbCrLf & Replace(Mid(m_line(ii), InStr(1, m_line(ii), Left(ExceptFieldData2, 17))), Left(ExceptFieldData2, 17), "")
                        End If
                        ExceptFieldData2 = Replace(ExceptFieldData2, Left(ExceptFieldData2, 17), "")
                    Loop
               Next ii
               ExceptFieldData2 = Join(m_line, vbCrLf)
               m_line = Split(ExceptFieldData2, vbCrLf)
               ExceptFieldData2 = Join(m_line, vbCrLf)
               If Len(m_line(UBound(m_line))) < 6 Then
                  ExceptFieldData2 = ExceptFieldData2 & String(6 - Len(m_line(UBound(m_line))), "　") & "鈞啟"
               Else
                  ExceptFieldData2 = ExceptFieldData2 & vbCrLf & String(6, "　") & "鈞啟"
               End If
               
               If strField <> "中代開窗地址/CF/不印本所號" Then 'Add by Morgan 2010/6/10
                  If m_MySt(3) & m_MySt(4) = "000" Then
                       ExceptFieldData2 = ExceptFieldData2 & "(" & m_MySt(1) & "-" & m_MySt(2) & ")"
                  Else
                       ExceptFieldData2 = ExceptFieldData2 & "(" & m_MySt(1) & "-" & m_MySt(2) & "-" & m_MySt(3) & "-" & m_MySt(4) & ")"
                  End If
               End If 'Add by Morgan 2010/6/10
               
               m_line = Split(ExceptFieldData2, vbCrLf)
               For ii = UBound(m_line) To 3
                  ExceptFieldData2 = ExceptFieldData2 & vbCrLf
               Next
            End If
         End If
         
      'Add by Morgan 2008/7/11
      Case "中申開窗郵號/被授權"
         If ChkNoAddr() = False Then 'Added by Morgan 2018/10/17 E化客戶定稿不要印郵遞區號及地址
            strExc(0) = "SELECT CP72 FROM CASEPROGRESS WHERE CP09='" & m_Rule & "' and CP72 is not null"
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               strExc(1) = "" & RsTemp.Fields(0)
               If strExc(1) <> "" Then
                  If PUB_GetAddrRef(strExc(1), , , , , , , strExc(0)) Then
                     ExceptFieldData2 = strExc(0) & String(17 - Len(strExc(0)), "　")
                  End If
               End If
            End If
         End If
         
         If ExceptFieldData2 = "" Then
            ExceptFieldData2 = String(17, "　")
         End If
         
      'Add by Morgan 2008/7/11
      Case "中申開窗地址/被授權"
         strExc(0) = "SELECT CP72 FROM CASEPROGRESS WHERE CP09='" & m_Rule & "'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            strExc(3) = "" & RsTemp.Fields(0)
            'Added by Morgan 2016/11/3
            strExc(4) = ""
            'Removed by Morgan 2016/12/5 目前副本只考慮個案或申請人
            'If Right(strField, 2) = "-副" Then
            '   If PUB_GetCCbyCustNo(strExc(3), strExc(5), strExc(4)) Then
            '      strExc(3) = strExc(5)
            '      m_LP33 = strExc(3): m_LP34 = strExc(4)
            '   Else
            '      strExc(3) = ""
            '   End If
            'End If
            ''end 2016/11/3
            If strExc(3) <> "" Then
               'Modified by Morgan 2016/11/3 +副本接洽人
               'If PUB_GetAddrRef(strExc(3), , , , , strExc(0), strExc(1), , strExc(2)) = True Then
               If PUB_GetAddrRef(strExc(3), , , , , strExc(0), strExc(1), , strExc(2), , strExc(4)) = True Then
               'end 2016/11/3
                  '地址
                  If strExc(2) = "" Then
                     ExceptFieldData2 = String(20, "　")
                  'Added by Morgan 2018/10/17 E化客戶定稿不要印郵遞區號及地址
                  ElseIf ChkNoAddr() = True Then
                     ExceptFieldData2 = String(20, "　")
                  'end 2018/10/17
                  Else
                     ExceptFieldData2 = ToWide(Trim(CheckStr(strExc(2))))
                  End If
                  '收件人
                  ExceptFieldData2 = ExceptFieldData2 & vbCrLf & Trim(CheckStr(strExc(0)))
                  '接洽人
                  ExceptFieldData2 = ExceptFieldData2 & vbCrLf & Trim(CheckStr(strExc(1)))
                  If Len(Trim(CheckStr(strExc(1)))) < 6 Then
                     ExceptFieldData2 = ExceptFieldData2 & String(6 - Len(Trim(CheckStr(strExc(1)))), "　") & "鈞啟"
                  Else
                     ExceptFieldData2 = ExceptFieldData2 & "　鈞啟"
                  End If
               End If
            End If
         End If
         If ExceptFieldData2 <> "" Then
            If m_MySt(3) & m_MySt(4) = "000" Then
                 ExceptFieldData2 = ExceptFieldData2 & "(" & m_MySt(1) & "-" & m_MySt(2) & ")"
            Else
                 ExceptFieldData2 = ExceptFieldData2 & "(" & m_MySt(1) & "-" & m_MySt(2) & "-" & m_MySt(3) & "-" & m_MySt(4) & ")"
            End If
            m_line = Split(ExceptFieldData2, vbCrLf)
            For ii = 0 To UBound(m_line)
                 ExceptFieldData2 = m_line(ii)
                 Do While ExceptFieldData2 <> StrToStr(ExceptFieldData2, 17)
                     If InStr(1, m_line(ii), StrToStr(ExceptFieldData2, 17)) = 1 Then
                         m_line(ii) = Mid(m_line(ii), 1, InStr(1, m_line(ii), StrToStr(ExceptFieldData2, 17)) - 1) & StrToStr(ExceptFieldData2, 17) & vbCrLf & Replace(m_line(ii), StrToStr(ExceptFieldData2, 17), "")
                     Else
                         m_line(ii) = Mid(m_line(ii), 1, InStr(1, m_line(ii), StrToStr(ExceptFieldData2, 17)) - 1) & StrToStr(ExceptFieldData2, 17) & vbCrLf & Replace(Mid(m_line(ii), InStr(1, m_line(ii), StrToStr(ExceptFieldData2, 17))), StrToStr(ExceptFieldData2, 17), "")
                     End If
                     ExceptFieldData2 = Replace(ExceptFieldData2, StrToStr(ExceptFieldData2, 17), "")
                 Loop
            Next ii
            ExceptFieldData2 = Join(m_line, vbCrLf)
            m_line = Split(ExceptFieldData2, vbCrLf)
            For ii = 0 To UBound(m_line)
                 m_line(ii) = m_line(ii)
            Next ii
            ExceptFieldData2 = Join(m_line, vbCrLf)
            m_line = Split(ExceptFieldData2, vbCrLf)
            If UBound(m_line) < 3 Then
                 ExceptFieldData2 = ExceptFieldData2 & vbCrLf
            End If
         End If
        
      'Add by Morgan 2008/7/11
      Case "中申開窗郵號/移轉"
         If ChkNoAddr() = False Then 'Added by Morgan 2018/10/17 E化客戶定稿不要印郵遞區號及地址
            strExc(0) = "SELECT CP56 FROM CASEPROGRESS WHERE CP09='" & m_Rule & "'"
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               strExc(1) = "" & RsTemp.Fields(0)
               'Removed by Morgan 2016/12/5 副本只考慮個案或申請人
               ''Added by Morgan 2016/11/3
               'If Right(strField, 2) = "-副" Then
               '   If PUB_GetCCbyCustNo(strExc(1), strExc(2)) Then
               '      strExc(1) = strExc(2)
               '   Else
               '      strExc(1) = ""
               '   End If
               'End If
               ''end 2016/11/3
               If strExc(1) <> "" Then
                  If PUB_GetAddrRef(strExc(1), , , , , , , strExc(0)) = True Then
                     ExceptFieldData2 = strExc(0) & String(17 - Len(strExc(0)), "　")
                  End If
               End If
            End If
         End If
         
         If ExceptFieldData2 = "" Then
            ExceptFieldData2 = String(17, "　")
         End If
         
      'Add by Morgan 2008/7/11
      Case "中申開窗地址/移轉"
         strExc(0) = "SELECT CP56 FROM CASEPROGRESS WHERE CP09='" & m_Rule & "'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            strExc(3) = "" & RsTemp.Fields(0)
            'Added by Morgan 2016/11/3
            strExc(4) = ""
            'Removed by Morgan 2016/12/5 副本只考慮個案或申請人
            'If Right(strField, 2) = "-副" Then
            '   If PUB_GetCCbyCustNo(strExc(3), strExc(5), strExc(4)) Then
            '      strExc(3) = strExc(5)
            '      m_LP33 = strExc(3): m_LP34 = strExc(4)
            '   Else
            '      strExc(3) = ""
            '   End If
            'End If
            ''end 2016/11/3
            If strExc(3) <> "" Then
               'Modified by Morgan 2016/11/3 +副本接洽人
               'If PUB_GetAddrRef(strExc(3), , , , , strExc(0), strExc(1), , strExc(2)) = True Then
               If PUB_GetAddrRef(strExc(3), , , , , strExc(0), strExc(1), , strExc(2), , strExc(4)) = True Then
               'end 2016/11/3
                  '地址
                  If strExc(2) = "" Then
                     ExceptFieldData2 = String(20, "　")
                  'Added by Morgan 2018/10/17 E化客戶定稿不要印郵遞區號及地址
                  ElseIf ChkNoAddr() = True Then
                     ExceptFieldData2 = String(20, "　")
                  'end 2018/10/17
                  Else
                     ExceptFieldData2 = ToWide(Trim(CheckStr(strExc(2))))
                  End If
                  '收件人
                  ExceptFieldData2 = ExceptFieldData2 & vbCrLf & Trim(CheckStr(strExc(0)))
                  '接洽人
                  ExceptFieldData2 = ExceptFieldData2 & vbCrLf & Trim(CheckStr(strExc(1)))
                  If Len(Trim(CheckStr(strExc(1)))) < 6 Then
                     ExceptFieldData2 = ExceptFieldData2 & String(6 - Len(Trim(CheckStr(strExc(1)))), "　") & "鈞啟"
                  Else
                     ExceptFieldData2 = ExceptFieldData2 & "　鈞啟"
                  End If
               End If
            End If
         End If
         If ExceptFieldData2 <> "" Then
            If m_MySt(3) & m_MySt(4) = "000" Then
                 ExceptFieldData2 = ExceptFieldData2 & "(" & m_MySt(1) & "-" & m_MySt(2) & ")"
            Else
                 ExceptFieldData2 = ExceptFieldData2 & "(" & m_MySt(1) & "-" & m_MySt(2) & "-" & m_MySt(3) & "-" & m_MySt(4) & ")"
            End If
            m_line = Split(ExceptFieldData2, vbCrLf)
            For ii = 0 To UBound(m_line)
                 ExceptFieldData2 = m_line(ii)
                 Do While ExceptFieldData2 <> StrToStr(ExceptFieldData2, 17)
                     If InStr(1, m_line(ii), StrToStr(ExceptFieldData2, 17)) = 1 Then
                         m_line(ii) = Mid(m_line(ii), 1, InStr(1, m_line(ii), StrToStr(ExceptFieldData2, 17)) - 1) & StrToStr(ExceptFieldData2, 17) & vbCrLf & Replace(m_line(ii), StrToStr(ExceptFieldData2, 17), "")
                     Else
                         m_line(ii) = Mid(m_line(ii), 1, InStr(1, m_line(ii), StrToStr(ExceptFieldData2, 17)) - 1) & StrToStr(ExceptFieldData2, 17) & vbCrLf & Replace(Mid(m_line(ii), InStr(1, m_line(ii), StrToStr(ExceptFieldData2, 17))), StrToStr(ExceptFieldData2, 17), "")
                     End If
                     ExceptFieldData2 = Replace(ExceptFieldData2, StrToStr(ExceptFieldData2, 17), "")
                 Loop
            Next ii
            ExceptFieldData2 = Join(m_line, vbCrLf)
            m_line = Split(ExceptFieldData2, vbCrLf)
            For ii = 0 To UBound(m_line)
                 m_line(ii) = m_line(ii)
            Next ii
            ExceptFieldData2 = Join(m_line, vbCrLf)
            m_line = Split(ExceptFieldData2, vbCrLf)
            If UBound(m_line) < 3 Then
                 ExceptFieldData2 = ExceptFieldData2 & vbCrLf
            End If
         End If
         
      'Add by Morgan 2008/7/22
      Case "中申開窗郵號/移轉人"
         If ChkNoAddr() = False Then 'Added by Morgan 2018/10/17 E化客戶定稿不要印郵遞區號及地址
            strExc(0) = "SELECT CP55 FROM CASEPROGRESS WHERE CP09='" & m_Rule & "'"
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               strExc(1) = "" & RsTemp.Fields(0)
               'Removed by Morgan 2016/12/5 副本只考慮個案或申請人
               ''Added by Morgan 2016/11/3
               'If Right(strField, 2) = "-副" Then
               '   If PUB_GetCCbyCustNo(strExc(1), strExc(2)) Then
               '      strExc(1) = strExc(2)
               '   Else
               '      strExc(1) = ""
               '   End If
               'End If
               ''end 2016/11/3
               If strExc(1) <> "" Then
                  If PUB_GetAddrRef(strExc(1), , , , , , , strExc(0)) = True Then
                     ExceptFieldData2 = strExc(0) & String(17 - Len(strExc(0)), "　")
                  End If
               End If
            End If
         End If
         
         If ExceptFieldData2 = "" Then
            ExceptFieldData2 = String(17, "　")
         End If
         
      'Add by Morgan 2008/7/22
      Case "中申開窗地址/移轉人"
         strExc(0) = "SELECT CP55 FROM CASEPROGRESS WHERE CP09='" & m_Rule & "'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            strExc(3) = "" & RsTemp.Fields(0)
            'Added by Morgan 2016/11/3
            strExc(4) = ""
            'Removed by Morgan 2016/12/5 副本只考慮個案或申請人
            'If Right(strField, 2) = "-副" Then
            '   If PUB_GetCCbyCustNo(strExc(3), strExc(5), strExc(4)) Then
            '      strExc(3) = strExc(5)
            '      m_LP33 = strExc(3): m_LP34 = strExc(4)
            '   Else
            '      strExc(3) = ""
            '   End If
            'End If
            ''end 2016/11/3
            If strExc(3) <> "" Then
               'Modified by Morgan 2016/11/3 +副本接洽人
               'If PUB_GetAddrRef(strExc(3), , , , , strExc(0), strExc(1), , strExc(2)) = True Then
               If PUB_GetAddrRef(strExc(3), , , , , strExc(0), strExc(1), , strExc(2), , strExc(4)) = True Then
               'end 2016/11/3
                  '地址
                  If strExc(2) = "" Then
                     ExceptFieldData2 = String(20, "　")
                  'Added by Morgan 2018/10/17 E化客戶定稿不要印郵遞區號及地址
                  ElseIf ChkNoAddr() = True Then
                     ExceptFieldData2 = String(20, "　")
                  Else
                     ExceptFieldData2 = ToWide(Trim(CheckStr(strExc(2))))
                  End If
                  '收件人
                  ExceptFieldData2 = ExceptFieldData2 & vbCrLf & Trim(CheckStr(strExc(0)))
                  '接洽人
                  ExceptFieldData2 = ExceptFieldData2 & vbCrLf & Trim(CheckStr(strExc(1)))
                  If Len(Trim(CheckStr(strExc(1)))) < 6 Then
                     ExceptFieldData2 = ExceptFieldData2 & String(6 - Len(Trim(CheckStr(strExc(1)))), "　") & "鈞啟"
                  Else
                     ExceptFieldData2 = ExceptFieldData2 & "　鈞啟"
                  End If
               End If
            End If
         End If
         If ExceptFieldData2 <> "" Then
            If m_MySt(3) & m_MySt(4) = "000" Then
                 ExceptFieldData2 = ExceptFieldData2 & "(" & m_MySt(1) & "-" & m_MySt(2) & ")"
            Else
                 ExceptFieldData2 = ExceptFieldData2 & "(" & m_MySt(1) & "-" & m_MySt(2) & "-" & m_MySt(3) & "-" & m_MySt(4) & ")"
            End If
            m_line = Split(ExceptFieldData2, vbCrLf)
            For ii = 0 To UBound(m_line)
                 ExceptFieldData2 = m_line(ii)
                 Do While ExceptFieldData2 <> StrToStr(ExceptFieldData2, 17)
                     If InStr(1, m_line(ii), StrToStr(ExceptFieldData2, 17)) = 1 Then
                         m_line(ii) = Mid(m_line(ii), 1, InStr(1, m_line(ii), StrToStr(ExceptFieldData2, 17)) - 1) & StrToStr(ExceptFieldData2, 17) & vbCrLf & Replace(m_line(ii), StrToStr(ExceptFieldData2, 17), "")
                     Else
                         m_line(ii) = Mid(m_line(ii), 1, InStr(1, m_line(ii), StrToStr(ExceptFieldData2, 17)) - 1) & StrToStr(ExceptFieldData2, 17) & vbCrLf & Replace(Mid(m_line(ii), InStr(1, m_line(ii), StrToStr(ExceptFieldData2, 17))), StrToStr(ExceptFieldData2, 17), "")
                     End If
                     ExceptFieldData2 = Replace(ExceptFieldData2, StrToStr(ExceptFieldData2, 17), "")
                 Loop
            Next ii
            ExceptFieldData2 = Join(m_line, vbCrLf)
            m_line = Split(ExceptFieldData2, vbCrLf)
            For ii = 0 To UBound(m_line)
                 m_line(ii) = m_line(ii)
            Next ii
            ExceptFieldData2 = Join(m_line, vbCrLf)
            m_line = Split(ExceptFieldData2, vbCrLf)
            If UBound(m_line) < 3 Then
                 ExceptFieldData2 = ExceptFieldData2 & vbCrLf
            End If
         End If
         
      'Add by Morgan 2008/8/22
      Case "中申開窗郵號/相關被授權"
         If ChkNoAddr() = False Then 'Added by Morgan 2018/10/17 E化客戶定稿不要印郵遞區號及地址
            strExc(0) = "SELECT CP72 FROM CASEPROGRESS WHERE CP09=(SELECT CP43 FROM CASEPROGRESS WHERE CP09='" & m_Rule & "')"
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               strExc(1) = "" & RsTemp.Fields(0)
               'Removed by Morgan 2016/12/5 副本只考慮個案或申請人
               ''Added by Morgan 2016/11/3
               'If Right(strField, 2) = "-副" Then
               '   If PUB_GetCCbyCustNo(strExc(1), strExc(2)) Then
               '      strExc(1) = strExc(2)
               '   Else
               '      strExc(1) = ""
               '   End If
               'End If
               ''end 2016/11/3
               If strExc(1) <> "" Then
                  If PUB_GetAddrRef(strExc(1), , , , , , , strExc(0)) = True Then
                     ExceptFieldData2 = strExc(0) & String(17 - Len(strExc(0)), "　")
                  End If
               End If
            End If
         End If
         If ExceptFieldData2 = "" Then
            ExceptFieldData2 = String(17, "　")
         End If
         
      'Add by Morgan 2008/8/22
      Case "中申開窗地址/相關被授權"
         strExc(0) = "SELECT CP72 FROM CASEPROGRESS WHERE CP09=(SELECT CP43 FROM CASEPROGRESS WHERE CP09='" & m_Rule & "')"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            strExc(3) = "" & RsTemp.Fields(0)
            'Added by Morgan 2016/11/3
            strExc(4) = ""
            'Removed by Morgan 2017/12/14 目前副本只考慮個案或申請人
            'If Right(strField, 2) = "-副" Then
            '   If PUB_GetCCbyCustNo(strExc(3), strExc(5), strExc(4)) Then
            '      strExc(3) = strExc(5)
            '      m_LP33 = strExc(3): m_LP34 = strExc(4)
            '   Else
            '      strExc(3) = ""
            '   End If
            'End If
            'end 2017/12/14
            'end 2016/11/3
            If strExc(3) <> "" Then
               'Modified by Morgan 2016/11/3 +副本接洽人
               'If PUB_GetAddrRef(strExc(3), , , , , strExc(0), strExc(1), , strExc(2)) = True Then
               If PUB_GetAddrRef(strExc(3), , , , , strExc(0), strExc(1), , strExc(2), , strExc(4)) = True Then
               'end 2016/11/3
                  '地址
                  If strExc(2) = "" Then
                     ExceptFieldData2 = String(20, "　")
                  'Added by Morgan 2018/10/17 E化客戶定稿不要印郵遞區號及地址
                  ElseIf ChkNoAddr() = True Then
                     ExceptFieldData2 = String(20, "　")
                  'end 2018/10/17
                  Else
                     ExceptFieldData2 = ToWide(Trim(CheckStr(strExc(2))))
                  End If
                  '收件人
                  ExceptFieldData2 = ExceptFieldData2 & vbCrLf & Trim(CheckStr(strExc(0)))
                  '接洽人
                  ExceptFieldData2 = ExceptFieldData2 & vbCrLf & Trim(CheckStr(strExc(1)))
                  If Len(Trim(CheckStr(strExc(1)))) < 6 Then
                     ExceptFieldData2 = ExceptFieldData2 & String(6 - Len(Trim(CheckStr(strExc(1)))), "　") & "鈞啟"
                  Else
                     ExceptFieldData2 = ExceptFieldData2 & "　鈞啟"
                  End If
               End If
            End If
         End If
         If ExceptFieldData2 <> "" Then
            If m_MySt(3) & m_MySt(4) = "000" Then
                 ExceptFieldData2 = ExceptFieldData2 & "(" & m_MySt(1) & "-" & m_MySt(2) & ")"
            Else
                 ExceptFieldData2 = ExceptFieldData2 & "(" & m_MySt(1) & "-" & m_MySt(2) & "-" & m_MySt(3) & "-" & m_MySt(4) & ")"
            End If
            m_line = Split(ExceptFieldData2, vbCrLf)
            For ii = 0 To UBound(m_line)
                 ExceptFieldData2 = m_line(ii)
                 Do While ExceptFieldData2 <> StrToStr(ExceptFieldData2, 17)
                     If InStr(1, m_line(ii), StrToStr(ExceptFieldData2, 17)) = 1 Then
                         m_line(ii) = Mid(m_line(ii), 1, InStr(1, m_line(ii), StrToStr(ExceptFieldData2, 17)) - 1) & StrToStr(ExceptFieldData2, 17) & vbCrLf & Replace(m_line(ii), StrToStr(ExceptFieldData2, 17), "")
                     Else
                         m_line(ii) = Mid(m_line(ii), 1, InStr(1, m_line(ii), StrToStr(ExceptFieldData2, 17)) - 1) & StrToStr(ExceptFieldData2, 17) & vbCrLf & Replace(Mid(m_line(ii), InStr(1, m_line(ii), StrToStr(ExceptFieldData2, 17))), StrToStr(ExceptFieldData2, 17), "")
                     End If
                     ExceptFieldData2 = Replace(ExceptFieldData2, StrToStr(ExceptFieldData2, 17), "")
                 Loop
            Next ii
            ExceptFieldData2 = Join(m_line, vbCrLf)
            m_line = Split(ExceptFieldData2, vbCrLf)
            For ii = 0 To UBound(m_line)
                 m_line(ii) = m_line(ii)
            Next ii
            ExceptFieldData2 = Join(m_line, vbCrLf)
            m_line = Split(ExceptFieldData2, vbCrLf)
            If UBound(m_line) < 3 Then
                 ExceptFieldData2 = ExceptFieldData2 & vbCrLf
            End If
         End If
         
      'Add by Morgan 2008/8/27
      Case "申請人1稱謂"
         ExceptFieldData2 = PUB_GetAppTitle(, m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4))
         If ExceptFieldData2 <> "" Then
            ExceptFieldData2 = "　" & ExceptFieldData2
         End If
         
      'Add by Morgan 2008/8/28
      Case "被授權人稱謂"
         strExc(0) = "SELECT CP72 FROM CASEPROGRESS WHERE CP09='" & m_Rule & "'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData2 = PUB_GetAppTitle("" & RsTemp(0))
            If ExceptFieldData2 <> "" Then
               ExceptFieldData2 = "　" & ExceptFieldData2
            End If
         End If
      
      'Add by Morgan 2008/8/28
      Case "移轉申請人稱謂"
         strExc(0) = "SELECT CP56 FROM CASEPROGRESS WHERE CP09='" & m_Rule & "'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData2 = PUB_GetAppTitle("" & RsTemp(0))
            If ExceptFieldData2 <> "" Then
               ExceptFieldData2 = "　" & ExceptFieldData2
            End If
         End If
         
      'Add by Morgan 2008/8/28
      Case "移轉人稱謂"
         strExc(0) = "SELECT CP55 FROM CASEPROGRESS WHERE CP09='" & m_Rule & "'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData2 = PUB_GetAppTitle("" & RsTemp(0))
            If ExceptFieldData2 <> "" Then
               ExceptFieldData2 = "　" & ExceptFieldData2
            End If
         End If
         
      'Add by Morgan 2008/8/28
      Case "相關被授權人稱謂"
         strExc(0) = "SELECT CP72 FROM CASEPROGRESS WHERE CP09=(SELECT CP43 FROM CASEPROGRESS WHERE CP09='" & m_Rule & "')"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData2 = PUB_GetAppTitle("" & RsTemp(0))
            If ExceptFieldData2 <> "" Then
               ExceptFieldData2 = "　" & ExceptFieldData2
            End If
         End If
         
      'Add by Morgan 2008/9/2
      Case "起始繳費年度"
         strExc(0) = "select decode(pa08,'1',na20,'2',na22,na24) Type" & _
            ",decode(pa08,'1',na21,'2',na23,na25) Years" & _
            " from patent,nation where pa01='" & m_MySt(1) & "' and pa02='" & m_MySt(2) & "' and pa03='" & m_MySt(3) & "' and pa04='" & m_MySt(4) & "'" & _
            " and na01(+)=pa09"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            strExc(1) = "" & RsTemp("Years")
            intI = InStr(strExc(1), ",")
            If intI > 0 Then
               strExc(2) = Left(strExc(1), intI - 1)
            Else
               strExc(2) = strExc(1)
            End If
            If "" & RsTemp.Fields("Type") = "605" Then
               ExceptFieldData2 = strExc(2)
            Else
               ExceptFieldData2 = Val(strExc(2)) + 1
            End If
         End If
         
      'Add by Morgan 2008/9/2
      Case "繳費案件性質"
         'Modified by Lydia 2018/06/05 修改顯示案件性質 '020',CPM04,CPM03 => '000',CPM03,CPM04
         strExc(0) = "select decode(pa09,'000',cpm03,cpm04) from (select pa01,pa09,decode(pa08,'1',na20,'2',na22,na24) Type" & _
            " from patent,nation where pa01='" & m_MySt(1) & "' and pa02='" & m_MySt(2) & "' and pa03='" & m_MySt(3) & "' and pa04='" & m_MySt(4) & "'" & _
            " and na01(+)=pa09),casepropertymap where cpm02(+)=Type and cpm01(+)=pa01"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData2 = "" & RsTemp(0)
         End If
         
      'Add By Sindy 98/04/08
      Case "代表圖色"
         ExceptFieldData2 = GetPicColor(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4))
      Case "TMGoods標題" '僅一項商品類別時, 才顯示商品名稱(超過5個用•••), 反之不顯示
         'Modify By Sindy 2017/10/30 + 增加排除未延展商品 : IIf(m_MySt(5) = "102", " and tg18 is null", "")
         strExc(0) = "select tg05,tg06,tg07,tg08,tg15,tg16,tg17 from tmgoods where tg01='" & m_MySt(1) & "' and tg02='" & m_MySt(2) & "' and tg03='" & m_MySt(3) & "' and tg04='" & m_MySt(4) & "'" & IIf(m_MySt(5) = "102", " and tg18 is null", "") & " order by tg05 "
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         ExceptFieldData2 = ""
         If RsTemp.RecordCount = 1 Then
            ExceptFieldData2 = vbCrLf & "商品名稱："
         End If
      Case "TMGoods截" '僅一項商品類別時, 才顯示商品名稱(超過5個用•••), 反之不顯示
         'Modify By Sindy 2017/10/30 + m_MySt(5)
         ExceptFieldData2 = GetTMGoods(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), m_MySt(5))
      '98/04/08 End
      'Added by Lydia 2019/05/22 T台灣案延展通知(業務管制表)之商品名稱調整；因為”TMGoods標題"”、”TMGoods截”還有核准定稿，所以另外處理
      Case "TMGoods標題1"  '超過1項商品類別會在第2頁列印，所以保留商品名稱標題
         strExc(0) = "select tg05,tg06,tg07,tg08,tg15,tg16,tg17 from tmgoods where tg01='" & m_MySt(1) & "' and tg02='" & m_MySt(2) & "' and tg03='" & m_MySt(3) & "' and tg04='" & m_MySt(4) & "'" & IIf(m_MySt(5) = "102", " and tg18 is null", "") & " order by tg05 "
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         ExceptFieldData2 = ""
         If RsTemp.RecordCount >= 1 Then
            ExceptFieldData2 = vbCrLf & "商品名稱："
         End If
      Case "TMGoods第1頁"
         '商品名稱第1頁可印完 +  只有一個類別 => 直接顯示
         strExc(0) = "select tg05,tg06,tg07,tg08,tg15,tg16,tg17 from tmgoods where tg01='" & m_MySt(1) & "' and tg02='" & m_MySt(2) & "' and tg03='" & m_MySt(3) & "' and tg04='" & m_MySt(4) & "' " & IIf(m_MySt(5) = "102", " and tg18 is null", "") & " order by tg05 "
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         ExceptFieldData2 = ""
         If RsTemp.RecordCount > 1 Then
            ExceptFieldData2 = "(詳見本通知函背面)"
         ElseIf RsTemp.RecordCount = 1 Then
            'Modified by Lydia 2023/02/14 + trim()
            If GetTextLength(Trim("" & RsTemp.Fields("tg06") & RsTemp.Fields("tg15"))) > 26 Then
                ExceptFieldData2 = "(詳見本通知函背面)"
            Else '只有一個類別,並且不超過可顯示範圍
                ExceptFieldData2 = CheckStr("" & RsTemp.Fields("tg06") & RsTemp.Fields("tg15"))
            End If
         End If
      Case "TMGoods第2頁"
         '不可超過第2頁
         'Memo by Lydia 2019/08/22 因為原本單面印整批定稿約半小時,改成雙面列印要1小時以上;
                                                  '改成先計算商品名稱的可印範圍存入例外欄位記錄,減少印整批定稿的時間
         strExc(0) = "select tg05,tg06,tg07,tg08,tg15,tg16,tg17 from tmgoods where tg01='" & m_MySt(1) & "' and tg02='" & m_MySt(2) & "' and tg03='" & m_MySt(3) & "' and tg04='" & m_MySt(4) & "' " & IIf(m_MySt(5) = "102", " and tg18 is null", "") & " order by tg05 "
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         ExceptFieldData2 = ""
         strExc(1) = "": strExc(2) = "": strExc(3) = ""
         If RsTemp.RecordCount >= 1 Then
            intI = RsTemp.RecordCount
            RsTemp.MoveFirst
            strExc(2) = "第" & RsTemp.Fields("tg05") & "類："
            Do While Not RsTemp.EOF
                'Modified by Lydia 2023/02/13 +trim()
                strExc(1) = strExc(1) & IIf(strExc(1) <> "", "第" & RsTemp.Fields("tg05") & "類：", "") & CheckStr(Trim("" & RsTemp.Fields("tg06") & RsTemp.Fields("tg15"))) & vbCrLf
                RsTemp.MoveNext
            Loop
            'Modified by Lydia 2023/02/14 去掉 vbCrLf ; 雅雯反應2/1開始第2頁都會印商品類別名稱
            'If Not (intI = 1 And GetTextLength(strExc(1)) <= 26) Then '商品名稱第1頁可印完 只有一個類別 >= 直接顯示
            If Not (intI = 1 And GetTextLength(Replace(strExc(1), vbCrLf, "")) <= 26) Then
               '計算第2頁版面：高40~42行，每一行最多34中文字
               'Memo by Lydia 2020/01/09 Word2013預設.doc檔的第2頁版面，最大行數43(含未完全列出的備註2行)；
               '但是Word2013預設.docx檔，在插入代表圖後最大行數小於43，改用變數控制
               strExc(1) = "商品名稱：" & vbCrLf & strExc(2) & strExc(1)
               m_line = Empty
               m_line = Split(strExc(1), vbCrLf)
               intL = 0 '行數
               For ii = 0 To UBound(m_line)
                   If Trim(m_line(ii)) <> "" Then
                       strTemp = m_line(ii)
                       intI = GetTextLength(strTemp)
                       For i = 0 To intI \ 68
                            strExc(4) = Trim(convForm(strTemp, 68))
                            strExc(3) = strExc(3) & strExc(4)
                            strTemp = MidB(strTemp, LenB(strExc(4)) + 1)
                            If i > 0 Then intL = intL + 1
                            'Modified by Lydia 2020/01/09 改用變數控制
                            'If intL = 40 Then
                            If intL = TMGoods第2頁行數 - 2 Then
                                '省略號的位置
                                If GetTextLength(strExc(4)) > 62 Then
                                    intA = InStrRev(strExc(3), "、")
                                    intB = InStrRev(strExc(3), "，")
                                    intC = InStrRev(strExc(3), "；")
                                    If intA + intB + intC > 0 Then
                                        If intA > intB Then
                                           intI = intA
                                        Else
                                           intI = intB
                                        End If
                                        If intI < intC Then
                                           intI = intC
                                        End If
                                        strExc(3) = Mid(strExc(3), 1, intI - 1) & "~~~" & Mid(strExc(3), intI)
                                    Else
                                        strExc(3) = Mid(strExc(3), 1, Len(strExc(3)) - 3) & "~~~" & Mid(strExc(3), Len(strExc(3)) - 3)
                                    End If
                                Else
                                    If InStr(strExc(4), "。") = 0 Then
                                       strExc(3) = strExc(3) & "~~~"
                                    End If
                                End If
                                strExc(3) = strExc(3) & "|||" '第2頁最末行的位置
                            End If
                       Next i
                       If intI \ 68 > 0 And Trim(strTemp) <> "" Then '剩下的字串
                           strExc(3) = strExc(3) & strTemp
                           intL = intL + 1
                           'Modified by Lydia 2020/01/09 改用變數控制
                           'If intL = 40 Then strExc(3) = strExc(3) & "~~~|||" '省略號+第2頁最末行的位置
                           If intL = TMGoods第2頁行數 - 2 Then strExc(3) = strExc(3) & "~~~|||"
                       End If
                       intL = intL + 1
                       strExc(3) = strExc(3) & vbCrLf
                   End If
               Next ii
               'Modified by Lydia 2020/01/09 改用變數控制
               'If intL <= 42 Then
               If intL <= TMGoods第2頁行數 Then
                  strExc(3) = Replace(strExc(3), "~~~", "")
                  strExc(3) = Replace(strExc(3), "|||", "")
               Else '商品名稱第2頁無法印完
                  If InStr(strExc(3), "~~~") > 0 Then
                      strExc(3) = Mid(strExc(3), 1, InStr(strExc(3), "~~~") - 1)
                      strExc(3) = strExc(3) & "•••"
                  Else
                       strExc(3) = Mid(strExc(3), 1, InStr(strExc(3), "|||") - 1)
                  End If
                  strExc(3) = strExc(3) & vbCrLf & "（限於篇幅，本案之商品名稱未完全列出，欲瞭解完整之商品名稱，請與本所智權人員聯繫）"
               End If
               ExceptFieldData2 = strExc(3)
            End If
         End If
      'end 2019/05/22
      
      'Add by Morgan 2009/4/17
      Case "專利起算日"
         strExc(0) = "select decode(pa08,'1',na40,'2',na43,'3',na46)" & _
            " from patent,nation where pa01='" & m_MySt(1) & "'" & _
            " and pa02='" & m_MySt(2) & "' and pa03='" & m_MySt(3) & "'" & _
            " and pa04='" & m_MySt(4) & "' and na01(+)=pa09"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            Select Case "" & RsTemp.Fields(0)
               Case "2": ExceptFieldData2 = "申請日"
               Case "4": ExceptFieldData2 = "核准日"
               Case "5": ExceptFieldData2 = "公告日"
               Case "6": ExceptFieldData2 = "發證日"
               Case "7": ExceptFieldData2 = "公開日"
            End Select
         End If
      Case "專用年度"
         strExc(0) = "select decode(pa08,'1',na07,'2',na09,'3',na11),pa08,pa09,pa10" & _
            " from patent,nation where pa01='" & m_MySt(1) & "'" & _
            " and pa02='" & m_MySt(2) & "' and pa03='" & m_MySt(3) & "'" & _
            " and pa04='" & m_MySt(4) & "' and na01(+)=pa09"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            'Modify by Morgan 2009/8/14 統一用阿拉伯數字
            'ExceptFieldData2 = PUB_ChgNumber2Chinese(RsTemp.Fields(0))
            'Added by Morgan 2021/6/7 大陸110/6/1以前申請的設計案專用期為10年
            If RsTemp.Fields("pa08") = "3" And RsTemp.Fields("pa09") = "020" And RsTemp.Fields("pa10") > 0 And RsTemp.Fields("pa10") < 20210601 Then
               ExceptFieldData2 = 10
            Else
            'end 2021/6/7
            
               ExceptFieldData2 = RsTemp.Fields(0)
            End If
         End If
      Case "年費起繳年"
         strExc(0) = "select decode(pa08,'1',na21,'2',na23,'3',na25)" & _
            " from patent,nation where pa01='" & m_MySt(1) & "'" & _
            " and pa02='" & m_MySt(2) & "' and pa03='" & m_MySt(3) & "'" & _
            " and pa04='" & m_MySt(4) & "' and na01(+)=pa09"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            strExc(1) = "" & RsTemp.Fields(0)
            If InStr(strExc(1), ",") > 0 Then
               ExceptFieldData2 = Left(strExc(1), InStr(strExc(1), ",") - 1)
            Else
               ExceptFieldData2 = strExc(1)
            End If
            
         End If
      'end 2009/4/17
      
      'Add by Morgan 2009/7/1
      Case "PCT申請日"
         'Removed by Morgan 2024/12/12 改只抓基本檔，因有多個PCT國內案時會抓錯 Ex:CFP-034653
         'strExc(0) = "select pa10 from casemap,patent" & _
         '   " where cm01='" & m_MySt(1) & "' and cm02='" & m_MySt(2) & "'" & _
         '   " and cm03='" & m_MySt(3) & "' and cm04='" & m_MySt(4) & "'" & _
         '   " and pa01(+)=cm05 and pa02(+)=cm06 and pa03(+)=cm07 and pa04(+)=cm08 and pa09='056'"
         'intI = 1
         'Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         'If intI = 1 Then
         '   ExceptFieldData2 = "" & RsTemp.Fields(0)
         '
         ''Added by Morgan 2016/5/26 PCT案非本所辦理時改抓申請日
         'ElseIf intI = 0 Then
         'end 2024/12/12
         
            strExc(0) = "select pa10 from patent where pa01='" & m_MySt(1) & "' and pa02='" & m_MySt(2) & "' and pa03='" & m_MySt(3) & "' and pa04='" & m_MySt(4) & "'"
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               ExceptFieldData2 = "" & RsTemp.Fields(0)
            End If
            
         'end 2016/5/26
         'End If 'Removed by Morgan 2024/12/12
         
      Case "PCT申請號"
         'Removed by Morgan 2024/12/12 改只抓基本檔，因有多個PCT國內案時會抓錯 Ex:CFP-034653
         'strExc(0) = "select pa11 from casemap,patent" & _
         '   " where cm01='" & m_MySt(1) & "' and cm02='" & m_MySt(2) & "'" & _
         '   " and cm03='" & m_MySt(3) & "' and cm04='" & m_MySt(4) & "'" & _
         '   " and pa01(+)=cm05 and pa02(+)=cm06 and pa03(+)=cm07 and pa04(+)=cm08 and pa09='056'"
         'intI = 1
         'Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         'If intI = 1 Then
         '   ExceptFieldData2 = "" & RsTemp.Fields(0)
         ''Added by Morgan 2016/5/26 PCT案非本所辦理時改抓案件備註
         'ElseIf intI = 0 Then
         'end 2024/12/12
         
            strExc(0) = "select pa91 from patent where pa01='" & m_MySt(1) & "' and pa02='" & m_MySt(2) & "' and pa03='" & m_MySt(3) & "' and pa04='" & m_MySt(4) & "'"
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               ExceptFieldData2 = PUB_GetPCTPriNo("" & RsTemp.Fields(0))
            End If
            
         'end 2016/5/26
         'End If 'Removed by Morgan 2024/12/12
         
      'end 2009/7/1
      
      'Add by Morgan 2009/7/21 注意排序要與其他例外欄位一致
      Case "優先權國家/已發文"
         strExc(0) = "select na03 from pridate,nation" & _
            " where pd01='" & m_MySt(1) & "' and pd02='" & m_MySt(2) & "'" & _
            " and pd03='" & m_MySt(3) & "' and pd04='" & m_MySt(4) & "'" & _
            " and exists(select * from caseprogress where cp01=pd01 and cp02=pd02 and cp03=pd03 and cp04=pd04 and cp10 in ('106','121') and cp27>0 and cp57 is null)" & _
            " and na01(+)=pd07  order by PD05 asc,PD07 asc"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData2 = "" & RsTemp.Fields(0)
            strExc(0) = "" & RsTemp.Fields(0)
            RsTemp.MoveNext
            Do While Not RsTemp.EOF
               If strExc(0) <> "" & RsTemp.Fields(0) Then
                  ExceptFieldData2 = ExceptFieldData2 & "; " & RsTemp.Fields(0)
                  strExc(0) = "" & RsTemp.Fields(0)
               End If
               RsTemp.MoveNext
            Loop
         End If
         
      'Add by Morgan 2009/7/22
      Case "最終提申期限"
         strExc(0) = "select np09 from nextprogress" & _
            " where np02='" & m_MySt(1) & "' and np03='" & m_MySt(2) & "'" & _
            " and np04='" & m_MySt(3) & "' and np05='" & m_MySt(4) & "'" & _
            " and np06 is null and np07='996'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData2 = "" & RsTemp.Fields(0)
         End If
         
      'Add by Morgan 2009/7/28
      Case "台灣案加速審查提醒"
         strExc(0) = "select pa08,na28,na29,na49,na53 from patent,nation where pa01='" & m_MySt(1) & "' and pa02='" & m_MySt(2) & "'" & _
            " and pa03='" & m_MySt(3) & "' and pa04='" & m_MySt(4) & "' and na01(+)=pa09"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            '發明或新型有訂實審期限的國家
            If RsTemp("pa08") = "1" Or (RsTemp("pa08") = "2" And Not IsNull(RsTemp("na28")) And RsTemp("na29") > 0) Then
               'Add by Morgan 2010/5/12 發證控制自動發證的才要帶
               If m_MySt(1) = "P" Or m_FinalSty <> "05" Or (m_FinalSty = "05" And ((RsTemp("pa08") = "1" And RsTemp("na49") = "Y") Or (RsTemp("pa08") = "2" And RsTemp("na53") = "Y"))) Then
                  
                  '台灣案已收文通知實審日且相關收文號尚無結果(不必管是否曾收文加速審查)
                  'Modified by Morgan 2019/12/2 要排除已閉卷案件 CFP-27006,P-105425
                  strExc(0) = "select 1 from casemap,patent,caseprogress a" & _
                     " where cm01='" & m_MySt(1) & "' and cm02='" & m_MySt(2) & "'" & _
                     " and cm03='" & m_MySt(3) & "' and cm04='" & m_MySt(4) & "'" & _
                     " and pa01(+)=cm05 and pa02(+)=cm06 and pa03(+)=cm07 and pa04(+)=cm08" & _
                     " and (pa16 is null or pa16='2') and pa09='000' and pa57 is null" & _
                     " and cp01(+)=pa01 and cp02(+)=pa02 and cp03(+)=pa03 and cp04(+)=pa04 and cp10='1204'" & _
                     " and exists(select * from caseprogress b where b.cp09=a.cp43 and b.cp24 is null)"
                  intI = 1
                  Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
                  If intI = 1 Then
                     ExceptFieldData2 = "|?台灣案加速審查提醒?|"
                  End If
               End If
            End If
         End If
      'Add by Morgan 2009/7/31
      Case "PCT進EPC新案指示信專用段落"
         strExc(0) = "select 1 from patent where pa01='" & m_MySt(1) & "' and pa02='" & m_MySt(2) & "'" & _
            " and pa03='" & m_MySt(3) & "' and pa04='" & m_MySt(4) & "' and pa46='Y' and pa09='221'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData2 = "|?PCT進EPC新案指示信專用段落?|"
         End If
         
      'Added by Morgan 2013/4/24
      Case "定稿日"
         If g_LetterDate = "" Then g_LetterDate = strSrvDate(1)
         ExceptFieldData2 = g_LetterDate
      Case "定稿日/年度"
         If g_LetterDate = "" Then g_LetterDate = strSrvDate(1)
         strTmp = TransDate(g_LetterDate, 1)
         If Len(strTmp) = 6 Then
            ExceptFieldData2 = Left(strTmp, 2)
         Else
            ExceptFieldData2 = Left(strTmp, 3)
         End If
         
      'Add by Morgan 2009/8/20
      Case "定稿日/中"
         If g_LetterDate = "" Then
            g_LetterDate = strSrvDate(2)
         Else
            g_LetterDate = TransDate(g_LetterDate, 1)
         End If
         If Len(g_LetterDate) = 6 Then
            ExceptFieldData2 = "中華民國" & Mid(g_LetterDate, 1, 2) & "年" & Mid(g_LetterDate, 3, 2) & "月" & Right(g_LetterDate, 2) & "日"
         Else
            ExceptFieldData2 = "中華民國" & Mid(g_LetterDate, 1, 3) & "年" & Mid(g_LetterDate, 4, 2) & "月" & Right(g_LetterDate, 2) & "日"
         End If
         g_LetterDate = TransDate(g_LetterDate, 2) 'Added by Morgan 2016/6/28 要記錄西元年,否則整批定稿該案後的日期會錯(原中文定稿已改西元格式,目前已經沒有定稿使用這個例外欄位)

      Case "定稿日/英"
         strTmp = Empty
         If g_LetterDate = "" Then g_LetterDate = strSrvDate(1)
         ExceptFieldData2 = TranslateKeyWord(incCNV_ENGLISH_DATE, g_LetterDate, strTmp)
         
      Case "定稿日/中西"
         If g_LetterDate = "" Then g_LetterDate = strSrvDate(1)
         ExceptFieldData2 = Mid(g_LetterDate, 1, 4) & "年" & Mid(g_LetterDate, 5, 2) & "月" & Mid(g_LetterDate, 7, 2) & "日"

      'end 2009/8/20
      'Added by Morgan 2012/12/24
      Case "英文專利種類名稱"
         strExc(0) = "select pa11 from patent where pa01='" & m_MySt(1) & "' and pa02='" & m_MySt(2) & "'" & _
            " and pa03='" & m_MySt(3) & "' and pa04='" & m_MySt(4) & "'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            '申請案號第10碼
            If Mid("" & RsTemp(0), 10, 1) = "D" Then
               ExceptFieldData2 = "Derivational Design"
            End If
         End If
         If ExceptFieldData2 = "" Then ExceptFieldData2 = DoChange("專利商標種類-英文名稱")
         
      'Added by Morgan 2012/12/24
      Case "日文專利種類名稱"
         strExc(0) = "select pa11 from patent where pa01='" & m_MySt(1) & "' and pa02='" & m_MySt(2) & "'" & _
            " and pa03='" & m_MySt(3) & "' and pa04='" & m_MySt(4) & "'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            '申請案號第10碼
            If Mid("" & RsTemp(0), 10, 1) = "D" Then
               ExceptFieldData2 = "派生意匠"
            End If
         End If
         If ExceptFieldData2 = "" Then ExceptFieldData2 = DoChange("專利商標種類-日文名稱")
         
      'Added by Morgan 2012/12/19
      Case "國內專利種類名稱"
         strExc(0) = "select pa11 from patent where pa01='" & m_MySt(1) & "' and pa02='" & m_MySt(2) & "'" & _
            " and pa03='" & m_MySt(3) & "' and pa04='" & m_MySt(4) & "'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            '申請案號第10碼
            If Mid("" & RsTemp(0), 10, 1) = "D" Then
               ExceptFieldData2 = "衍生設計"
            End If
         End If
         If ExceptFieldData2 = "" Then ExceptFieldData2 = DoChange("專利商標種類-國內名稱")
      
      'Add by Morgan 2010/5/25
      Case "專利商標種類-國內名稱/集體"
      
         ExceptFieldData2 = GetPatentTypeName(m_MySt(1), m_MySt(2), m_MySt(4)) & DoChange("專利商標種類-國內名稱")
         
      'Add by Morgan 2021/3/15
      Case "專利基本檔-申請案號/集體"
         ExceptFieldData2 = DoChange("專利基本檔-申請案號") & GetMaxPatentAppNo(m_MySt(1), m_MySt(2), m_MySt(4))
         
      'Add by Morgan 2010/5/25
      Case "專利基本檔-專利號數/集體"
         ExceptFieldData2 = DoChange("專利基本檔-專利號數") & GetMaxPatentNo(m_MySt(1), m_MySt(2), m_MySt(4))
      
      'Add by Morgan 2011/4/28
      Case "專利基本檔-公告號/集體"
         ExceptFieldData2 = DoChange("專利基本檔-公告號") & GetMaxPublicNo(m_MySt(1), m_MySt(2), m_MySt(4))
         
      'Add by Morgan 2010/11/15
      Case "下次年費法限", "下次年費所限"
         strExc(0) = "select np08,np09 from nextprogress" & _
            " where np02='" & m_MySt(1) & "' and np03='" & m_MySt(2) & "'" & _
            " and np04='" & m_MySt(3) & "' and np05='" & m_MySt(4) & "'" & _
            " and np06 is null and np07='605'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If strField = "下次年費法限" Then
               ExceptFieldData2 = "" & RsTemp.Fields("np09")
            Else
               ExceptFieldData2 = "" & RsTemp.Fields("np08")
            End If
         End If
      'Add by Morgan 2010/11/17
      Case "優先權資料/英", "優先權日/英", "優先權國家+申請號/英"
         'Modified by Morgan 2018/9/18 排序加,PD06,PD07 --Lina Ex:FCP-59530
         strExc(0) = "SELECT PD05,PD06,PD07,NA04 FROM PRIDATE,NATION WHERE PD01='" & m_MySt(1) & "'" & _
            " AND PD02='" & m_MySt(2) & "' AND PD03='" & m_MySt(3) & "' AND PD04='" & m_MySt(4) & "'" & _
            " AND PD07=NA01(+) ORDER BY PD05,PD06,PD07"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            With RsTemp
            Do While Not .EOF
               'Added by Morgan 2025/4/24
               If strField = "優先權日/英" Then
                  If ExceptFieldData2 <> "" Then ExceptFieldData2 = ExceptFieldData2 & "; "
                  strTmp = ParserKeyWord("/", .Fields("PD05"), "英")
                  ExceptFieldData2 = ExceptFieldData2 & strTmp
                  
               ElseIf strField = "優先權國家+申請號/英" Then
                  If ExceptFieldData2 <> "" Then ExceptFieldData2 = ExceptFieldData2 & "; "
                  ExceptFieldData2 = ExceptFieldData2 & .Fields("NA04") & " Patent Application No. " & .Fields("PD06")
                  
               Else
               'end 2025/4/24
                  If ExceptFieldData2 <> "" Then ExceptFieldData2 = ExceptFieldData2 & vbCrLf
                  strTmp = ParserKeyWord("/", .Fields("PD05"), "英")
                  ExceptFieldData2 = ExceptFieldData2 & .Fields("NA04") & " Patent Application No. " & .Fields("PD06") & " filed on " & strTmp
               End If
               .MoveNext
            Loop
            End With
         End If
         
      'Add by Morgan 2011/2/10
      Case "FMP", "非FMP"
         strExc(0) = "select cp12 FROM CASEPROGRESS WHERE CP09='" & m_Rule & "'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If Left(RsTemp(0), 1) = "F" Then
               If strField = "FMP" Then
                  ExceptFieldData2 = "♀"
               End If
            Else
               If strField = "非FMP" Then
                  ExceptFieldData2 = "♀"
               End If
            End If
         End If
         
      'Add by Morgan 2011/2/16
      Case "有無優先權", "優先權或申請日"
         strExc(0) = "SELECT 1 FROM PRIDATE WHERE PD01='" & m_MySt(1) & "'" & _
            " AND PD02='" & m_MySt(2) & "' AND PD03='" & m_MySt(3) & "' AND PD04='" & m_MySt(4) & "' AND ROWNUM<2"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If strField = "有無優先權" Then
               ExceptFieldData2 = "♀"
            Else
               ExceptFieldData2 = "the priority date"
            End If
         ElseIf strField = "優先權或申請日" Then
            ExceptFieldData2 = "the filing date"
         End If
         
      'Add by Morgan 2011/3/2
      Case "專利號或申請號"
         strExc(0) = "SELECT PA11,PA22 FROM PATENT WHERE " & PaSt
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If Not IsNull(RsTemp.Fields(1)) Then
               ExceptFieldData2 = "Patent No. " & RsTemp.Fields(1).Value
               ExceptFieldData2 = ExceptFieldData("專利種類/英") & " " & ExceptFieldData2
            ElseIf Not IsNull(RsTemp.Fields(0)) Then
               ExceptFieldData2 = "Application No. " & RsTemp.Fields(0).Value
               ExceptFieldData2 = DoChange("專利商標種類-英文名稱") & " " & ExceptFieldData2
            Else
               ExceptFieldData2 = DoChange("專利商標種類-英文名稱") & " " & "Application"
            End If
         End If
      
      'Added by Morgan 2011/11/28
      Case "第幾年年費/英"
         strExc(0) = "select cp53,cp54 from caseprogress where cp09='" & m_Rule & "'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData2 = PUB_GetEngPayYear("" & RsTemp.Fields("cp53"), "" & RsTemp.Fields("cp54"))
         End If
      
      'Added by Morgan 2012/4/10
      Case "無年費收據"
         If m_MySt(6) = "231" Then ExceptFieldData2 = "♀"
        
      'Added by Morgan 2012/6/13
      Case "是否列印Title"
         strExc(0) = "select pa90 FROM patent WHERE " & PaSt
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If RsTemp(0) = "Y" Then
               ExceptFieldData2 = "♀"
            End If
         End If
         
'Removed by Morgan 2020/3/23 不再使用
'      'Added by Morgan 2012/8/16
'      Case "專利信函下款"
'         If m_MySt(1) = "P" Or m_MySt(1) = "CFP" Then
'            strExc(0) = "select pa161 from patent where " & PaSt & " and pa161='Y'"
'            intI = 1
'            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
'            If intI = 1 Then
'               ExceptFieldData2 = "台一國際專利商標事務所"
'            Else
'               ExceptFieldData2 = "台一國際專利法律事務所"
'            End If
'         End If
'end 2020/3/23
      
      'Added by Morgan 2014/1/17
      Case "信函下款", "出名公司", "出名公司/日", "智權公司出名才印"
'Modified by Morgan 2020/3/23
'         strExc(0) = PUB_GetReceiptComp(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4))
'         If strExc(0) = "J" Then
'            ExceptFieldData2 = "台一智權股份有限公司"
'         ElseIf strExc(0) = "T" Then
'            ExceptFieldData2 = "台一國際專利商標事務所"
'         'Modified by Morgan 2015/2/10
'         'ElseIf m_MySt(1) = "P" Or m_MySt(1) = "PS" Or m_MySt(1) = "CFP" Or m_MySt(1) = "CPS" Then
'         '   ExceptFieldData2 = "台一國際專利法律事務所"
'         'Else
'         '   ExceptFieldData2 = "台一國際專利商標事務所"
'         ElseIf InStr(m_MySt(1), "T") > 0 Or m_MySt(1) = "S" Then
'            ExceptFieldData2 = "台一國際專利商標事務所"
'         Else
'            ExceptFieldData2 = "台一國際專利法律事務所"
'         'end 2015/2/10
'         End If
         strExc(0) = PUB_GetReceiptComp(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), True)
         If strField = "出名公司/日" Then
            If strSrvDate(1) >= 智慧所更名日 Then
               ExceptFieldData2 = CompNameQuery(strExc(0), "3")
            ElseIf m_MySt(1) = "FCP" Then
               ExceptFieldData2 = "台一罈G利 (特許) 法律事務所"
            Else
               ExceptFieldData2 = "台一罈痡M利法律事務所"
            End If
         'Added by Morgan 2021/2/22
         ElseIf strField = "智權公司出名才印" Then
            If strExc(0) = "J" Then
               ExceptFieldData2 = "♀"
            End If
         'end 2021/2/22
         Else
            ExceptFieldData2 = CompNameQuery(strExc(0))
         End If
'end 2020/3/23
         
         'Added by Morgan 2021/11/11 E化客戶加印公司章
         If strField = "信函下款" Then
            If m_bolECust = True Then
               ExceptFieldData2 = ExceptFieldData2 & "|#(自動公司章)#|"
            End If
         End If
         'end 2021/11/11
         
      'Added by Sindy 2014/4/9
      Case "信函下款/英1"
         strExc(0) = PUB_GetReceiptComp(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4))
         
         If strExc(0) = "J" Then
            ExceptFieldData2 = "Tai E Intellectual"
         Else
            ExceptFieldData2 = "Tai E International"
         End If
      Case "信函下款/英2"
         strExc(0) = PUB_GetReceiptComp(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4))
         
         If strExc(0) = "J" Then
            ExceptFieldData2 = "Property Co., Ltd."
         Else
            ExceptFieldData2 = "Patent & Law Office"
         End If
      '2014/4/9 END
         
      'Added by Morgan 2012/8/31
      Case "指定提申日"
         strExc(0) = "select np09 from caseprogress,nextprogress where cp09='" & m_Rule & "' and np01(+)=cp09 and np07='995'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData2 = RsTemp(0)
         End If
      
'Modified by Morgan 2020/12/3 改可減免案件的所有中小企業都要列印--玲玲
'      'Added by Morgan 2013/3/27
'      Case "案件可減免且有中小企業"
'         strExc(0) = PUB_GetCaseDiscStat(m_MySt(1) & m_MySt(2) & m_MySt(3) & m_MySt(4), strExc(1))
'         If strExc(0) = "Y" And InStr(strExc(1), "3") > 0 Then
'            ExceptFieldData2 = "♀"
'         End If
'      'Added by Morgan 2013/4/22
'      'Modified by Morgan 2020/7/24 +"減免資格勾選5", "減免資格數值5", "減免資格勾選6", "減免資格數值6"
'      Case "減免資格勾選1", "減免資格數值1", "減免資格勾選2", "減免資格數值2", "減免資格勾選3", "減免資格數值3", "減免資格勾選4", "減免資格數值4", "減免資格勾選5", "減免資格數值5", "減免資格勾選6", "減免資格數值6", "可減免中小企業名稱"
'         strExc(0) = "select decode('3',a1.ad10,a1.ad15,a2.ad10,a2.ad15,a3.ad10,a3.ad15,a4.ad10,a4.ad15,a5.ad10,a5.ad15) c01" & _
'            ",decode('3',a1.ad10,a1.ad16,a2.ad10,a2.ad16,a3.ad10,a3.ad16,a4.ad10,a4.ad16,a5.ad10,a5.ad16) c02" & _
'            ",decode('3',a1.ad10,pa26,a2.ad10,pa27,a3.ad10,pa28,a4.ad10,pa29,a5.ad10,pa30) c03" & _
'            " from patent,applicantdiscount a1,applicantdiscount a2,applicantdiscount a3,applicantdiscount a4,applicantdiscount a5" & _
'            " where " & PaSt & " and a1.ad01(+)=substr(pa26,1,8) and a1.ad02(+)='000' and a1.ad10(+)='3'" & _
'            "  and a2.ad01(+)=substr(pa27,1,8) and a2.ad02(+)='000' and a2.ad10(+)='3'" & _
'            "  and a3.ad01(+)=substr(pa28,1,8) and a3.ad02(+)='000' and a3.ad10(+)='3'" & _
'            "  and a4.ad01(+)=substr(pa29,1,8) and a4.ad02(+)='000' and a4.ad10(+)='3'" & _
'            "  and a5.ad01(+)=substr(pa30,1,8) and a5.ad02(+)='000' and a5.ad10(+)='3'"
'         intI = 1
'         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
'         If intI = 1 Then
'            If strField = "可減免中小企業名稱" Then
'               strExc(0) = "select cu04 from customer where cu01='" & Left(RsTemp(2), 8) & "' and cu02='" & Mid(RsTemp(2), 9) & "'"
'               intI = 1
'               Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
'               If intI = 1 Then
'                  ExceptFieldData2 = "" & RsTemp(0)
'               End If
'            Else
'               If Left(Right(strField, 3), 2) = "勾選" Then
'                  If Right(strField, 1) = RsTemp(0) Then
'                     ExceptFieldData2 = "■"
'                  Else
'                     ExceptFieldData2 = "□"
'                  End If
'               Else
'                  If Right(strField, 1) = RsTemp(0) Then
'                     ExceptFieldData2 = "" & RsTemp(1)
'                  Else
'                     ExceptFieldData2 = "         "
'                  End If
'               End If
'            End If
'         End If
      Case "案件可減免且有中小企業", "可減免中小企業名稱", "可減免中小企業名稱2" _
         , "可減免中小企業名稱3", "可減免中小企業名稱4", "可減免中小企業名稱5" _
         , "減免資格勾選5", "減免資格數值5", "減免資格勾選6", "減免資格數值6" _
         , "減免資格勾選52", "減免資格數值52", "減免資格勾選62", "減免資格數值62" _
         , "減免資格勾選53", "減免資格數值53", "減免資格勾選63", "減免資格數值63" _
         , "減免資格勾選54", "減免資格數值54", "減免資格勾選64", "減免資格數值64" _
         , "減免資格勾選55", "減免資格數值55", "減免資格勾選65", "減免資格數值65"
         If PUB_GetCaseDiscStat(m_MySt(1) & m_MySt(2) & m_MySt(3) & m_MySt(4), strExc(1)) = "Y" Then
            If InStr(strExc(1), "3") > 0 Then
               If strField = "案件可減免且有中小企業" Then
                  ExceptFieldData2 = "♀"
               Else
                  strExc(0) = "select decode('3',a1.ad10,pa26) app,decode('3',a1.ad10,a1.ad15) chk,decode('3',a1.ad10,a1.ad16) val" & _
                     ",decode('3',a2.ad10,pa27) app2,decode('3',a2.ad10,a2.ad15) chk2,decode('3',a2.ad10,a2.ad16) val2" & _
                     ",decode('3',a3.ad10,pa28) app3,decode('3',a3.ad10,a3.ad15) chk3,decode('3',a3.ad10,a3.ad16) val3" & _
                     ",decode('3',a4.ad10,pa29) app4,decode('3',a4.ad10,a4.ad15) chk4,decode('3',a4.ad10,a4.ad16) val4" & _
                     ",decode('3',a5.ad10,pa30) app5,decode('3',a5.ad10,a5.ad15) chk5,decode('3',a5.ad10,a5.ad16) val5" & _
                     " from patent,applicantdiscount a1,applicantdiscount a2,applicantdiscount a3,applicantdiscount a4,applicantdiscount a5" & _
                     " where " & PaSt & _
                     " and a1.ad01(+)=substr(pa26,1,8) and a1.ad02(+)='000' and a1.ad10(+)='3'" & _
                     " and a2.ad01(+)=substr(pa27,1,8) and a2.ad02(+)='000' and a2.ad10(+)='3'" & _
                     " and a3.ad01(+)=substr(pa28,1,8) and a3.ad02(+)='000' and a3.ad10(+)='3'" & _
                     " and a4.ad01(+)=substr(pa29,1,8) and a4.ad02(+)='000' and a4.ad10(+)='3'" & _
                     " and a5.ad01(+)=substr(pa30,1,8) and a5.ad02(+)='000' and a5.ad10(+)='3'"
                  intI = 1
                  Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
                  If intI = 1 Then
                     If InStr(strField, "可減免中小企業名稱") = 1 Then
                        strExc(1) = "" & RsTemp("app" & Mid(strField, 10))
                        If strExc(1) <> "" Then
                           strExc(0) = "select cu04 from customer where cu01='" & Left(strExc(1), 8) & "' and cu02='" & Mid(strExc(1), 9) & "'"
                           intI = 1
                           Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
                           If intI = 1 Then
                              ExceptFieldData2 = "" & RsTemp(0)
                           End If
                        End If
                     
                     ElseIf InStr(strField, "減免資格勾選") = 1 Then
                        strExc(1) = "" & RsTemp("chk" & Mid(strField, 8))
                        If strExc(1) = Mid(strField, 7, 1) Then
                           ExceptFieldData2 = "■"
                        Else
                           ExceptFieldData2 = "□"
                        End If
                        
                     ElseIf InStr(strField, "減免資格數值") = 1 Then
                        strExc(1) = "" & RsTemp("chk" & Mid(strField, 8))
                        If strExc(1) = Mid(strField, 7, 1) Then
                           ExceptFieldData2 = "" & RsTemp("val" & Mid(strField, 8))
                        Else
                           ExceptFieldData2 = "         "
                        End If
                     End If
                  End If
               End If
            End If
         End If
'end 2020/12/3
      'Added by Morgan 2013/5/15
      Case "電子送件"
         strExc(0) = "select cp09 from caseprogress where cp09='" & m_Rule & "' and cp118 is not null"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            'Modified by Morgan 2013/9/17 改"電子申請"為"電子送件"與系統欄位一致
            'ExceptFieldData2 = "　|#(框線)電子申請#|　"
            ExceptFieldData2 = "　|#(框線)電子送件#|　"
         End If
      'Added by Morgan 2014/4/23
      Case "新型要印"
         strExc(0) = "select 1 from patent where " & PaSt & " and pa08='2'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData2 = "♀"
         End If
         
      'Added by Morgan 2015/12/17
      'Modified by Morgan 2023/1/9 +非發明不印
      Case "發明要印", "非發明不印"
         strExc(0) = "select 1 from patent where " & PaSt & " and pa08='1'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData2 = "♀"
         End If
      'Added by Morgan 2017/10/31
      Case "發明非分割要印"
         strExc(0) = "select 1 from patent where " & PaSt & " and pa08='1' and not exists(select * from caseprogress where cp01=pa01 and cp02=pa02 and cp03=pa03 and cp04=pa04 and cp10='307')"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData2 = "♀"
         End If
      'Added by Morgan 2016/2/1
      Case "設計要印", "設計不印"
         strExc(0) = "select 1 from patent where " & PaSt & " and pa08='3'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData2 = "♀"
         End If
         
      'Added by Morgan 2014/5/9
      Case "發文字號"
         'Modified by Morgan 2014/6/13 原定稿有 7 & 8 個空白兩種，統一改留 7 個。
         ExceptFieldData2 = String(7, " ")
         'Add By Sindy 2020/2/4
         'If (m_MySt(1) = "FCT" Or Left(m_MySt(1), 1) = "T") And strSrvDate(1) < T商標電子化第2階段啟用日 Then
         'Else
         If g_LD18 <> "" Then
         '2020/2/4 END
            'Modified by Morgan 2014/8/13 +判斷是否為申請書
            'Modify by Sindy 2019/10/18 +T案電子化
'            If (m_MySt(1) = "P" And (m_FinalSty = "01" Or m_FinalSty = "16")) Then
'               strExc(0) = "select 1 from appform where af01='" & g_LD18 & "'"
'            Else
'               strExc(0) = "select 1 from letterprogress where lp01='" & g_LD18 & "'"
'            End If
            strExc(0) = "select 1 from appform where af01='" & g_LD18 & "'"
            strExc(0) = strExc(0) & " union " & _
                        "select 1 from letterprogress where lp01='" & g_LD18 & "'"
            '2019/10/18 END
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               ExceptFieldData2 = Right(g_LD18, 6)
            End If
            
         'Added by Morgan 2021/11/11 未電子化系統(此變數在指定信箱設定，只適用客戶函)
         'Modified by Morgan 2025/11/11 半E化客戶也要印
         ElseIf m_bolECust Or m_bolXECust Then
            ExceptFieldData2 = Right(m_SrcKey, 6)
         'end 2021/11/11
         End If
         
      'Added by Morgan 2014/12/11
      Case "指示信署名"
         'Modified by Morgan 2014/12/18
         'ExceptFieldData2 = PUB_GetOrderLetterSignature()
         ExceptFieldData2 = PUB_GetOrderLetterSignature(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4))
         
      'Added by Morgan 2015/10/23
      '補文件或補優先權證明的所限(取日期小的)
      Case "FMP補件所限"
         strExc(0) = "select min(NP08) from nextprogress where np02='" & m_MySt(1) & "' and np03='" & m_MySt(2) & "' and np04='" & m_MySt(3) & "' and np05='" & m_MySt(4) & "' and np06||np07 in ('202','232')"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData2 = "" & RsTemp(0)
         End If
         
      'Added by Morgan 2021/6/7
      Case "FMP發明新型要補優先權證明才印"
         strExc(0) = "select pa08,pa10 from nextprogress,patent where np02='" & m_MySt(1) & "' and np03='" & m_MySt(2) & "'" & _
            " and np04='" & m_MySt(3) & "' and np05='" & m_MySt(4) & "' and np06||np07='232'" & _
            " and pa01(+)=np02 and pa02(+)=np03 and pa03(+)=np04 and pa04(+)=np05 and pa08 in ('1','2') and pa10>=20210601"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData2 = "♀"
         End If
         
      'Added by Morgan 2021/6/7
      Case "申請日2021/6/1以後才印"
         strExc(0) = "select pa08,pa10 from patent where pa01='" & m_MySt(1) & "' and pa02='" & m_MySt(2) & "'" & _
            " and pa03='" & m_MySt(3) & "' and pa04='" & m_MySt(4) & "' and pa10>=20210601"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData2 = "♀"
         End If
         
      'Added by Morgan 2015/10/23
      Case "FMP補件內容", "FMP有缺文件"
         strExc(0) = "select np15 from nextprogress where np02='" & m_MySt(1) & "' and np03='" & m_MySt(2) & "'" & _
            " and np04='" & m_MySt(3) & "' and np05='" & m_MySt(4) & "' and np06||np07 in ('202','232')"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If strField = "FMP有缺文件" Then
               ExceptFieldData2 = "♀"
            Else
               intI = 0
               strExc(1) = ""
               With RsTemp
               Do While Not .EOF
                  intI = intI + 1
                  If .RecordCount = 1 Then
                     strExc(2) = "●"
                  Else
                     strExc(2) = "(" & intI & ")"
                  End If
                  Select Case "" & .Fields(0)
                     Case "委託書"
                        strExc(1) = strExc(1) & vbCrLf & strExc(2) & " An original Power of Attorney executed by a representative of the applicant"
                     Case "轉讓證明"
                        strExc(1) = strExc(1) & vbCrLf & strExc(2) & " An original Certificate of Assignment of Right of Priority signed by the inventors" & _
                           vbCrLf & "   or a notarized copy of the Worldwide Assignment duly executed by the inventors"
                     Case "優先權證明"
                        strExc(1) = strExc(1) & vbCrLf & strExc(2) & " A certified copy of the priority document"
                     Case Else
                        strExc(1) = strExc(1) & vbCrLf & strExc(2) & .Fields(0)
                  End Select
                  .MoveNext
               Loop
               End With
               ExceptFieldData2 = strExc(1)
            End If
         End If
      
      'Added by Morgan 2015/10/23
      Case "CFP指示信優先權主張"
         strExc(0) = "SELECT pd05,na04,ptm05,pd06 FROM PRIDATE, NATION, PATENT, PATENTTRADEMARKMAP WHERE PD01='" & m_MySt(1) & "'" & _
            " AND PD02='" & m_MySt(2) & "' AND PD03='" & m_MySt(3) & "' AND PD04='" & m_MySt(4) & "'" & _
            " AND NA01(+)=PD07 AND PA11(+)=PD06 AND PTM01(+)='1' AND PTM02=NVL(PA08,PD08)"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            With RsTemp
            strExc(1) = "Please claim priority of " & .Fields("na04") & " " & .Fields("ptm05") & " application No." & .Fields("pd06") & " of " & ChgEngDate(.Fields("pd05"))
            .MoveNext
            Do While Not .EOF
               If .RecordCount > 2 Then
                  strExc(1) = strExc(1) & "; "
               End If
               If .AbsolutePosition = .RecordCount Then
                  strExc(1) = strExc(1) & "and "
               End If
               strExc(1) = strExc(1) & .Fields("na04") & " " & .Fields("ptm05") & " application No." & .Fields("pd06") & " of " & ChgEngDate(.Fields("pd05"))
               .MoveNext
            Loop
            strExc(1) = strExc(1) & "."
            End With
            ExceptFieldData2 = strExc(1)
         End If
      
'CANCEL BY SONIA 2014/4/30 移到的最前面,當變數名稱相同時,先讀EXCEPTCONDITION,若無資料才抓程式定義的值
'      Case Else
'         ' 取得例外條件檔案中的資料
'         ' 90.07.27 modify by louis (以本所案號進入時 m_Rule已被截掉案件性質代號)
'         'strExc(0) = "SELECT ET06 FROM EXCEPTCONDITION WHERE ET01='" & m_FinalSty & _
'         '   "' AND ET02='" & m_Rule & "' AND ET03='" & m_Situ & "' " & _
'         '   "AND ET04='" & m_User & "' AND ET05='" & strField & "'"
'         strExc(0) = "SELECT ET06 FROM EXCEPTCONDITION WHERE ET01='" & m_FinalSty & _
'            "' AND ET02='" & m_SrcKey & "' AND ET03='" & m_Situ & "' " & _
'            "AND ET04='" & m_User & "' AND ET05='" & strField & "'"
'         intI = 1
'         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
'         If intI = 1 Then
'            If IsNull(RsTemp.Fields(0).Value) = False Then ExceptFieldData2 = RsTemp.Fields(0).Value
'         End If
'2014/4/30 END
      'Added by Lydia 2019/05/22 程式長度太長，另外分出ExceptFieldData3
      Case Else
          ExceptFieldData2 = ExceptFieldData3(strField, strCP10)
   End Select
End Function

'Added by Lydia 2019/05/22
Public Function ExceptFieldData3(ByVal strField As String, Optional strCP10 As String = "") As String
Dim strTmp As String, i As Integer, iTmp As String
'Add By Cheng 2003/01/27
Dim strSql As String
Dim rsTmp As ADODB.Recordset
Dim strPA08 As String
Dim strPA09 As String
Dim strPA72 As String
Dim strKey(5) As String
Dim strCaseFee(1 To 2) As String
Dim bFind As Boolean
Dim varPA72 As Variant
Dim varRef As Variant
Dim nPos As Integer
Dim ii As Integer
'Add By Cheng 2003/01/19
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset
'Add By Cheng 2003/01/22
Dim StrSqlB As String
Dim rsB As New ADODB.Recordset
Dim strNP09 As String '法定期限
Dim strNextPayDay  As String '預計以後繳年費日
Dim dblYearDiff As Double
Dim arrTM09 '商品類別陣列
Dim blnTMMerch As Boolean '商品類別屬商品
Dim blnTMSrv As Boolean '商品類別屬服務
'add by nickc 2008/02/27
Dim m_line As Variant
Dim strTemp As String 'Add By Sindy 2010/01/13
Dim bPaper As Boolean 'Added by Morgan2014/8/29
Dim iCopys As Integer 'Added by Morgan 2014/9/4
Dim bReturn As Boolean 'Added by Morgan 2016/10/14
Dim strTM44 As String 'Add By Sindy 2017/4/12
'Add By Sindy 2025/6/13
Dim strTM23 As String, strTM78 As String, strTM79 As String, strTM80 As String, strTM81 As String
Dim strCon As String, strLST10 As String
'2025/6/13 END
Dim gReport As String 'Add By Sindy 2021/3/30
Dim bolHad416 As Boolean 'Add By Sindy 2021/7/23
Dim tmpArr1 As Variant, jj As Integer, intA As Integer  'Added by Lydia 2022/09/15
Dim strTemp1() As String, strTemp2() As String, StrYear1 As String, StrYear2 As String 'Added by Morgan 2024/4/1

   If strCP10 <> "" Then m_CP10 = strCP10 'Add By Sindy 2015/1/8 ex.如撰寫信函中有共用信函抬頭/英
   ExceptFieldData3 = ""
   Select Case strField
      'Added by Morgan 2016/7/7
      Case "是否印美金"
         '目前抓案件代理人列印設定, 後續可能需考慮年費代理人甚至請款對象的設定另外還會有幣別問題
         strExc(0) = "SELECT NVL(FA115,'2') FROM PATENT, FAGENT WHERE PA01='" & m_MySt(1) & "'" & _
            " AND PA02='" & m_MySt(2) & "' AND PA03='" & m_MySt(3) & "' AND PA04='" & m_MySt(4) & "'" & _
            " AND FA01(+)=SUBSTR(PA75,1,8) AND FA02(+)=SUBSTR(PA75,9)"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            '純台幣不印,其他要印
            If RsTemp(0) <> "1" Then
               ExceptFieldData3 = "♀"
            End If
         End If
      
      'Added by Morgan 2019/8/16 108.11.1台灣專利新法設計案專用期由申請日起12年延長為15年,資料更新前要用規則算出後帶至相關定稿(FCP年費通知函、請款函、逾期補繳通知函,消滅函)
      Case "設計案15年屆滿日", "設計案適用新法才印", "設計案適用新法不印"
         strExc(0) = "SELECT PA10,PA25 FROM PATENT WHERE PA01='" & m_MySt(1) & "'" & _
            " AND PA02='" & m_MySt(2) & "' AND PA03='" & m_MySt(3) & "' AND PA04='" & m_MySt(4) & "' AND PA08='3' AND PA09='000' and pa25>=20191101"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If strField = "設計案15年屆滿日" Then
               If strSrvDate(1) < "20191101" Then
                  'Modified by Morgan 2019/10/29 衍生設計專用期止日延用母案非由申請日起算
                  'ExceptFieldData3 = CompDate(2, -1, CompDate(0, 15, RsTemp("pa10")))
                  ExceptFieldData3 = CompDate(0, 3, RsTemp("pa25"))
                  'end 2019/10/29
               Else
                  ExceptFieldData3 = "" & RsTemp("pa25")
               End If
            Else
               ExceptFieldData3 = "♀"
            End If
         End If
         
      'Add By Sindy 2017/4/12
      Case "FCT特殊請款文字對照" '特殊定稿，即有Debit Note的句子替換如下
         strExc(0) = "SELECT TM23,TM78,TM79,TM80,TM81,TM44,cp27 FROM Trademark,caseprogress WHERE TM01='" & m_MySt(1) & "'" & _
            " AND TM02='" & m_MySt(2) & "' AND TM03='" & m_MySt(3) & "' AND TM04='" & m_MySt(4) & "'" & _
            " AND TM01=CP01(+) AND TM02=CP02(+) AND TM03=CP03(+) AND TM04=CP04(+)" & _
            " AND cp09(+)='" & m_Rule & "'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            strTM44 = "" & RsTemp.Fields("TM44")
            strTM23 = "" & RsTemp.Fields("TM23")
            strTM78 = "" & RsTemp.Fields("TM78")
            strTM79 = "" & RsTemp.Fields("TM79")
            strTM80 = "" & RsTemp.Fields("TM80")
            strTM81 = "" & RsTemp.Fields("TM81")
            '發文日期
            m_CP27 = "" & RsTemp.Fields("cp27")
            If m_CP27 <> "" Then
               strExc(10) = Format(DateAdd("m", 1, ChangeWStringToWDateString(m_CP27)), "YYYYMMDD")
               strExc(9) = ChgEngDate(strExc(10))
               strExc(9) = Left(strExc(9), InStr(strExc(9), " ")) & Left(strExc(10), 4)
            Else
               strExc(9) = ""
            End If
            'Modify By Sindy 2025/6/13 此類資料改至”定稿特殊請款文字維護”做設定
            '取用文字內容的優先順序:
            '   1.編號先抓8碼, 再抓6碼
            '   2.代理人+申請人 -> 申請人 -> 代理人
            '還有,須再考慮排除的申請人編號
            For ii = 1 To 8 '8種狀況
               If ii = 1 Then 'Y8碼 對 X8碼
                  strCon = "length(LST01)=8 AND LST01||'0'='" & strTM44 & "'" & _
                           " AND length(LST02)=8" & _
                           " AND (LST02||'0'='" & strTM23 & "' or LST02||'0'='" & strTM78 & "' or LST02||'0'='" & strTM79 & "' or LST02||'0'='" & strTM80 & "' or LST02||'0'='" & strTM81 & "')"
               ElseIf ii = 2 Then 'Y8碼 對 X6碼
                  strCon = "length(LST01)=8 AND LST01||'0'='" & strTM44 & "'" & _
                           " AND (instr('" & strTM23 & "',LST02)>0" & _
                             " or instr('" & strTM78 & "',LST02)>0" & _
                             " or instr('" & strTM79 & "',LST02)>0" & _
                             " or instr('" & strTM80 & "',LST02)>0" & _
                             " or instr('" & strTM81 & "',LST02)>0)"
               ElseIf ii = 3 Then 'Y6碼 對 X8碼
                  strCon = "instr('" & strTM44 & "',LST01)>0" & _
                           " AND length(LST02)=8" & _
                           " AND (LST02||'0'='" & strTM23 & "' or LST02||'0'='" & strTM78 & "' or LST02||'0'='" & strTM79 & "' or LST02||'0'='" & strTM80 & "' or LST02||'0'='" & strTM81 & "')"
               ElseIf ii = 4 Then 'Y6碼 對 X6碼
                  strCon = "instr('" & strTM44 & "',LST01)>0" & _
                           " AND (instr('" & strTM23 & "',LST02)>0" & _
                             " or instr('" & strTM78 & "',LST02)>0" & _
                             " or instr('" & strTM79 & "',LST02)>0" & _
                             " or instr('" & strTM80 & "',LST02)>0" & _
                             " or instr('" & strTM81 & "',LST02)>0)"
               ElseIf ii = 5 Then 'Y8碼 對 無X
                  strCon = "length(LST01)=8 AND LST01||'0'='" & strTM44 & "' AND LST02='0'"
               ElseIf ii = 6 Then '無Y 對 X8碼
                  strCon = "LST01='0'" & _
                           " AND length(LST02)=8" & _
                           " AND (LST02||'0'='" & strTM23 & "' or LST02||'0'='" & strTM78 & "' or LST02||'0'='" & strTM79 & "' or LST02||'0'='" & strTM80 & "' or LST02||'0'='" & strTM81 & "')"
               ElseIf ii = 7 Then 'Y6碼 對 無X
                  strCon = "instr('" & strTM44 & "',LST01)>0 AND LST02='0'"
               Else 'If ii = 8 Then '無Y 對 X6碼
                  strCon = "LST01='0'" & _
                           " AND (instr('" & strTM23 & "',LST02)>0" & _
                             " or instr('" & strTM78 & "',LST02)>0" & _
                             " or instr('" & strTM79 & "',LST02)>0" & _
                             " or instr('" & strTM80 & "',LST02)>0" & _
                             " or instr('" & strTM81 & "',LST02)>0)"
               End If
               'ORDER BY LST10 ASC=>依有”排除的申請人編號”會排序在最前面
               strExc(0) = "SELECT * FROM LETTERSETTEXT WHERE " & strCon & " ORDER BY LST10 ASC"
               intI = 1
               Set rsA = ClsLawReadRstMsg(intI, strExc(0))
               If intI = 1 Then
                  rsA.MoveFirst
                  Do While Not rsA.EOF
                     '考慮有排除的申請人編號
                     If "" & rsA.Fields("LST10") <> "" Then
                        strLST10 = rsA.Fields("LST10")
                        If Len(strLST10) = 8 Then strLST10 = strLST10 & "0"
                        If InStr(strTM23, strLST10) > 0 Or _
                           InStr(strTM78, strLST10) > 0 Or _
                           InStr(strTM79, strLST10) > 0 Or _
                           InStr(strTM80, strLST10) > 0 Or _
                           InStr(strTM81, strLST10) > 0 Then
                           Exit Do
                        End If
                     Else
                        ExceptFieldData3 = rsA.Fields("LST03")
                        Exit For
                     End If
                     rsA.MoveNext
                  Loop
               End If
            Next ii
            '特定Tag置換相對應的文字
            If InStr(ExceptFieldData3, "發文日期") > 0 And strExc(9) <> "" Then
               ExceptFieldData3 = Replace(ExceptFieldData3, "發文日期", strExc(9))
            End If
            '2025/6/13 END
            
            'Modify By Sindy 2025/6/18 開始使用上列表格設定Mark程式
'            Select Case strTM44
'               'Add By Sindy 2018/8/6
'               Case "Y27811010"
'                  ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)DE-HQ.e.invoices@bshg.com#| for your kind settlement."
'               'Modify By Sindy 2018/8/14 Mark:取消代理人Y53600之特殊定稿
'               Case "Y53600000"
''                  ExceptFieldData3 = "Our debit note will be separately sent-to |#(底線)billing@goodmanmooney.com#| with a copy to |#(底線)Melissa@goodmanmooney.com#| for your kind settlement."
'                  'Add By Sindy 2024/8/7 修改特殊定稿資料: 美國代理人Goodman Mooney, LLP (Y53600)
'                  ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)accounting@goodmanmooney.com#| for your kind settlement."
'               '2018/8/6 END
'               Case "Y52234000" 'Abercrombie & Fitch Europe Sagl
'                  'ExceptFieldData3 = "Our debit note will be separately uploaded to TyMetrix 360 e-billing system for your kind settlement."
'                  'Modify By Sindy 2017/11/8
'                  ExceptFieldData3 = "Our debit note will be separately uploaded to TyMetrix 360 e-billing system in the end of this month for your kind settlement."
'               Case "Y52679000" 'Mattel, Inc.
'                  'Modify By Sindy 2018/1/24
'                  'ExceptFieldData3 = "Our debit note will be sent to MGSSAELIN@Mattel.com for your kind settlement."
'                  'Modify By Sindy 2018/10/4
'                  'ExceptFieldData3 = "Our debit note will be sent to |#(底線)MGSSAPACEI@mattel.com#| for your kind settlement."
'                  'Modify By Sindy 2020/9/1
'                  'ExceptFieldData3 = "Our debit note will be sent to |#(底線)MGSSAELIN@mattel.com#| for your kind settlement."
'                  'Modify By Sindy 2024/7/18
'                  'ExceptFieldData3 = "Our debit note for services rendered will be separately uploaded to Coupa system for your kind remittance."
'                  ExceptFieldData3 = "Our debit note for services rendered will be separately uploaded to Counsellink system for your kind remittance."
'               Case "Y21652070" 'Fish & Richardson P.C.
'                  ExceptFieldData3 = "Our debit note will be separately uploaded to https://frvp.fr.com for your kind settlement."
'               Case "Y34870010" 'Church & Dwight Co., Inc. Law Department
'                  'Modify By Sindy 2019/3/11 陳金蓮:但其代理之申請人X48721C1潔碧有限公司Water Pik, Inc.不須設定特殊定稿
'                  If Not ("" & RsTemp.Fields("TM23") = "X48721C10" Or _
'                          "" & RsTemp.Fields("TM78") = "X48721C10" Or _
'                          "" & RsTemp.Fields("TM79") = "X48721C10" Or _
'                          "" & RsTemp.Fields("TM80") = "X48721C10" Or _
'                          "" & RsTemp.Fields("TM81") = "X48721C10") Then
'                  '2019/3/11 END
'                     ExceptFieldData3 = "Our debit note for services rendered has been separately uploaded to Serengeti Tracker system for your kind remittance."
'                  End If
'               'cancel by sonia 2018/3/19 陳金蓮通知
'               'Case "Y54380000", "Y54380010", "Y54380B10" 'Seqirus
'               '   ExceptFieldData3 = "Our debit note will be submitted to the e-billing system for your kind settlement."
'               'end 2018/3/19
'               'Add By Sindy 2018/12/5
'               'Add By Sindy 2019/2/21 Mark
''               Case "Y54380010" 'Seqirus
''                  ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)flu.trademarks@seqirus.com#| with copies to the following two e-mail address for your kind settlement: |#(底線)nicole.rizzo_smith@seqirus.com#| and |#(底線)Jenna.Ruggirio@Seqirus.com#|"
'               'Add By Sindy 2019/2/21
'               'Modify By Sindy 2022/8/12 取消Y54380
''               Case "Y54380000" 'Seqirus (美)
''                  ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)accounts.uk@seqirus.com#|, with a copy to |#(底線)flu.trademarks@seqirus.com#| for your kind settlement."
'               'Add By Sindy 2018/4/23
'               Case "Y20179010" 'DAVUES CIKKUSIB CAVE (澳洲)
'                  ExceptFieldData3 = "Our debit note will be separately sent to |#(底線)mail@davies.com.au#| by e-mail only for your kind settlement."
'               Case "Y53598000" 'Lane IP Limited (英國)
'                  'Modify By Sindy 2019/9/9
''                  ExceptFieldData3 = "The Scanned copy of our debit note will be sent to |#(底線)invoicing@laneip.com#| for your kind settlement."
'                  'Modify By Sindy 2024/12/9 英國代理人Lane IP因被合併後更名為ABION UK LIMITED
'                  'ExceptFieldData3 = "Our debit note will be separately sent to |#(底線)invoicing@laneip.com#| for your settlement."
'                  ExceptFieldData3 = "Our debit note will be separately sent to |#(底線)accountspayableuk@Abion.com#| for your settlement."
'               Case "Y54872000" 'ANOVIP
'                  ExceptFieldData3 = "Our debit note for service rendered will be separately sent to |#(底線)accounts@anovip.com#|, and your earliest remittance will be appreciated."
'               Case "Y18271000" 'CTS CORPORATION (美國)
'                  ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)cts@easyaccessap.com#| with a copy to |#(底線)Daniel.Deneufbourg@ctscorp.com#| for your kind settlement."
'               Case "Y20656000" 'Lerner David Littenberg Krumholz & Mentlik, LLP (美國)
'                  'Modify Sindy 2019/7/26
'                  'ExceptFieldData3 = "Our debit note is also attached with copies to |#(底線)ap@lernerdavid.com#| for your kind settlement."
'                  ExceptFieldData3 = "Our debit note for services rendered has been attached and sent to |#(底線)Fi@lernerdavid.com#|, with a copy to |#(底線)international@lernerdavid.com#|, for your kind settlement."
'               Case "Y53593000" 'Kacvinsky Daisak Bluni PLLC (Princeton office) (美國)
'                  ExceptFieldData3 = "Our debit note will be separately email to Ms. Diane Rampino at |#(底線)drampino@kdbfirm.com#|, with copies to |#(底線)mhall@kdbfirm.com#| and cseaton@kdbfirm.com."
'               Case "Y53942000" 'Xperi Corporation (美國)
'                  ExceptFieldData3 = "Our debit note will be submitte d via TyMetrix 360 for your kind settlement."
'               Case "Y19357000" 'IPSIDE, "Innovative IP (法國)"
'                  'Modify By Sindy 2022/5/13
'                  ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)supplier@ipside.com#| for your kind settlement."
'               'Add By Sindy 2019/5/30
'               '請協助設定代理人IPSIDE (Y19357B1、 Y19357B3及Y19357B7)之定稿為特殊定稿
'               Case "Y19357B10", "Y19357B30", "Y19357B70"
'                  ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)supplier@ipside.com#| for your kind settlement."
'               '2019/5/30 END
'               Case "Y51799100" 'Sandvik AB, Trademarks and Brand Related IP
'                  'Modify By Sindy 2021/1/18
'                  'ExceptFieldData3 = "Our debit note will be sent to |#(底線)Conexus.invoice@sandvik.com#| separately for your kind settlement."
'                  ExceptFieldData3 = "Our debit note will be sent to |#(底線)sandvikab.se.invoice@sandvik.com#| separately for your kind settlement."
'               Case "Y20490000" 'The Lubrizol Corporation (美國)
'                  ExceptFieldData3 = "Our monthly debit note will be sent to |#(底線)trademarks@lubrizol.com#| in early " & strExc(9) & ", via email only for your kind settlement."
'               Case "Y48309000" 'SYNGENTA CROP PROTECTION AG Intellectual Property (瑞士)
'                  'Modify By Sindy 2018/7/23
'                  'ExceptFieldData3 = "We will upload the invoice to the Collaborati system for trademark services rendered during this month in early " & strExc(9) & " in accordance with your company's instruction for patent and trademark services."
'                  ExceptFieldData3 = "We will submit a consolidated invoice for trademark services rendered during this month to the e-billing system Collaborati in early " & strExc(9) & " for your kind settlement."
'               'Add By Sindy 2020/11/2
'               Case "Y54102000" 'SUNDARAM-CLAYTON LIMITED (印度)
'                  ExceptFieldData3 = "We will send a consolidated invoice for trademark services rendered during this month to your company in early " & strExc(9) & " for your kind settlement."
'               Case "Y54772000" 'Continental AG (德國)
'                  ExceptFieldData3 = "Our debit note will be sent to |#(底線)hb_accounts.payable@conti.de#| for your kind settlement."
'               '2018/4/23 END
'               'Add By Sindy 2018/5/24
'               Case "Y48880000" 'PROCOPIO, CORY, HARGREAVES & SAVITCH LLP
'                  ExceptFieldData3 = "Our debit note will be separately sent to |#(底線)accounts.payable@procopio.com#| for your kind settlement."
'               'Add by Amy 2018/06/07
'               Case "Y20600000"
'                  ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)invoice@brevalex.com#|, with a copy to you (|#(底線)christophe.saliou@brevalex.com#|) for your kind settlement."
'               Case "Y55037000"
'                  ExceptFieldData3 = "The original debit note will be seperately mailed to ""Macdonald & Muir Limited"" in Scotland for your kind settlement."
'               'end 2018/06/07
'               'Add By Sindy 2019/2/18
'               Case "Y51409000", "Y51409B10" 'COZEN O'CONNER
'                  ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)invoice@cozen.com#| for your kind settlement."
'               'Add By Sindy 2019/4/11
'               Case "Y34440B60" 'Morgan, Lewis & Bockius LLP
'                  ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)tminvoices@morganlewis.com#| for your kind settlement."
'               'Add By Sindy 2019/4/25
'               Case "Y46834000"
'                  ExceptFieldData3 = "Our debit note for services rendered will be sent to |#(底線)accountspayable@karlmayer.com#| for your kind settlement."
'               'Add By Sindy 2019/5/17
'               Case "Y52622000" 'Keltie LLP
'                  ExceptFieldData3 = "Our debit note will be separately sent to |#(底線)invoices@keltie.com#| for your kind settlement."
'               'Add By Sindy 2019/9/23
'               Case "Y52543000" 'ZF FRIEDRICHSHAFEN AG
'                  ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)Invoice.Friedrichshafen@zf.com#| for your kind settlement."
'               'Add By Sindy 2020/1/15
'               Case "Y54917000"
'                  'Modify By Sindy 2021/4/14
'                  'ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)vingesto@pdf.scancloud.se#| for settlement."
'                  'Modify By Sindy 2022/12/26
'                  'ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)vingesto@pdf.scancloud.se#| and with a copy to you for settlement."
'                  'Modify By Sindy 2025/6/4
'                  'ExceptFieldData3 = "Our debit note will be separately sent to |#(底線)vingesto@pdf.scancloud.se#| and with a copy to |#(底線)trademarks@vinge.se#| for settlement."
'                  ExceptFieldData3 = "Our debit note will be separately sent to |#(底線)APsto@vinge.se#| and with a copy to |#(底線)trademarks@vinge.se#| for settlement."
'               'Add By Sindy 2020/3/12
'               Case "Y30264000"
'                  ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)kreditoren@ceramtec.de#| for your kind settlement."
'               'Add By Sindy 2020/3/30
'               'Removed by Morgan 2023/3/2 併到下面
'               'Case "Y45799080"
'               '   ExceptFieldData3 = "Our debit note will be submitted to the e-billing system for your kind settlement."
'               'end 2023/3/2
'               'Add By Sindy 2020/5/5
'               Case "Y19142000" 'Volkswagen AG
'                  ExceptFieldData3 = "Our debit note for services rendered will be uploaded to your finance application for your settlement, yet a copy is also attached herewith for your reference."
'               'Add By Sindy 2020/5/15
'               Case "Y55159000" 'Orth Kluth Rechtsanwaelt
'                  ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)accounting@orthkluth.com#| for your kind settlement."
'               'Add By Sindy 2020/7/27
'               'Modify By Sindy 2022/8/18 取消代理人Y55402之特殊定稿設定
''               Case "Y55402000" 'Delivery Hero SE
''                  ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)invoices.1001@deliveryhero.com#| for your settlement."
'               'Add By Sindy 2020/8/28
'               Case "Y25061050" 'Jacobacci & Partners
'                  ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)foreign.invoices@jacobacci.com#| for your settlement."
'               'Add By Sindy 2020/8/31
'               Case "Y27911010" 'BSH Hausgeraete GmbH
'                  ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)DE-MCW.e.invoices@bshg.com#| for your settlement."
'               'Add By Sindy 2020/12/16
'               Case "Y54749000" 'John Deere (China) Investment Co., Ltd.
'                  ExceptFieldData3 = "Our invoice will be separately uploaded to the e-billing system for your settlement."
'               'Add By Sindy 2021/2/19
'               Case "Y54688000" 'Smiths Medical Smiths Medical
'                  ExceptFieldData3 = "Our debit note will be separately submitted via Serengeti Legal Tracker as instructed."
'               'Add By Sindy 2021/3/23
'               Case "Y54733000" 'Alfa Laval Corporate AB Trademark Department
'                  ExceptFieldData3 = "Our debit note will be separately sent to |#(底線)invoice.corporate@alfalaval.com#| for settlement."
'               'Add By Sindy 2021/4/19
'               Case "Y47570000" 'Roschier Brands, Attorneys Ltd
'                  ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)accounts.brands@roschier.com#| for settlement."
'               'Add By Sindy 2021/5/19
'               Case "Y53829000"
'                  'Modify By Sindy 2022/2/23
'                  'ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)accountspayable@power.com#| for your company's settlement."
'                  ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)ap@power.com#| and |#(底線)Accounts.payable@power.com#| for your company's settlement."
'               'Add By Sindy 2021/6/16 Axis Global Pty Limited (澳洲)
'               Case "Y54914000"
'                  ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)accounts@axisglobal.com.au#|, and your earliest remittance will be appreciated."
'               'Add By Sindy 2021/8/20
'               Case "Y54226000" 'Superdry plc
'                  'ExceptFieldData3 = "Upon receipt of your approval, our invoice will be issued and sent to |#(底線)invoices@superdry.com#| for settlement."
'                  ExceptFieldData3 = "The invoice to be issued for this matter will be included in our monthly billing list which will be separately sent to |#(底線)trademarks@superdry.com#| for your approval."
'               'Add By Sindy 2021/9/7
'               Case "Y25061010" 'JACOBACCI & PARTNERS S.P.A.
'                  ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)foreign.invoices@jacobacci.com#| for your settlement."
'               'Add By Sindy 2021/10/7
'               Case "Y43328000" 'Mast-Jagermeister SE Legal & Trademark Protection
'                  ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)invoice@jaegermeister.de#| for settlement."
'               'Add By Sindy 2021/10/14
'               Case "Y20111000" ' Barker Brettell LLP
'                  ExceptFieldData3 = "Our debit note will be separately sent to |#(底線)purchase.ledger@barkerbrettell.co.uk#| for your kind settlement."
'               'Add By Sindy 2021/11/22
'               Case "Y36362010"
'                  ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)invoice@skoda-auto.cz#| for settlement."
'               'Add By Sindy 2022/7/14
'               Case "Y55163000" 'Cohausz & Florack Patent-und Rechtsanwalte
'                  ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)invoice@cohausz-florack.de#| for settlement."
'               'Add By Sindy 2022/8/12 Y5413501 (Mr. Oleg Metz c/o JENOPTIK AG Recht & IP)
'               Case "Y54135010"
'                  ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)eInvoice@trioptics.com#| with a copy to |#(底線)patent@trioptics.com#| for settlement."
'               'Add By Sindy 2022/8/18 Y54364 Bird & Bird (MEA) LLP
'               Case "Y54364000"
'                  ExceptFieldData3 = "Our debit note will be separately sent to |#(底線)apuae@twobirds.com#| for your kind settlement."
'               'Add By Sindy 2022/8/19 Y55751 Birkenstock IP GmbH
'               Case "Y55751000"
'                  ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)BS-Invoice@birkenstock.com#| at the end of this month for your settlement."
'               'Add By Sindy 2022/8/22 Y5385101 NLO Shieldmark B.V.
'               Case "Y53851010"
'                  ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)bookkeeping@nlo.eu#| for settlement."
'               'Add By Sindy 2022/9/20 Y55550（Schneider Electric Belgium nv/sa）
'               Case "Y55550000"
'                  ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)BE-invoices-BEGM@schneider-electric.com#| for settlement."
'               'Add By Sindy 2022/9/22 Y54139 Akran Intellectual Property s.r.l.
'               Case "Y54139000"
'                  ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)amministrazione@akran.it#| for your settlement."
'               'Add By Sindy 2022/10/21 Y22327 MKS Instruments, Inc. (美)
'               Case "Y22327000"
'                  ExceptFieldData3 = "Our debit note for services rendered has been separately uploaded to Serengeti Tracker system for your kind remittance."
'               'Add By Sindy 2022/10/21 Y1796604
'               Case "Y17966040"
'                  'Modify By Sindy 2023/8/15
'                  'ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)storaenso.fi@maildrop.wm.net#| for settlement."
'                  ExceptFieldData3 = "Our debit note will be separately sent to |#(底線)maildrop.fi@storaenso.com#| for settlement."
'               'Add By Sindy 2022/11/30 Y55463 Dirk Rossmann GmbH
'               Case "Y55463000"
'                  ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)rechnungen@rossmann.de#| with a copy to |#(底線)markenrecht@rossmann.de#| for your settlement."
'               'Add By Sindy 2023/2/14 + Y55609
'               Case "Y55609000"
'                  ExceptFieldData3 = "Our debit note will be separately sent to |#(底線)invoice.hks@hubner-group.com#| and with a copy to you for settlement."
'               'Add By Sindy 2023/3/13 + Y53817 Bird & Bird LLP (英國)
'               Case "Y53817000"
'                  ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)LondonBMinvoices@twobirds.com#| for your kind settlement."
'               'Add By Sindy 2023/4/25 + Y55814 Alleima EMEA AB Alleima Group Trademark Function
'               Case "Y55814000"
'                  ExceptFieldData3 = "Our debit note will be separately sent to |#(底線)emea.se.invoice@alleima.com#| and |#(底線)apsupport_se@alleima.com#| for settlement."
'               'Add By Sindy 2023/7/20 + AUDI AG
'               Case "Y53603000"
'                  ExceptFieldData3 = "Our debit note for services rendered will be uploaded to your finance application for your settlement, yet a copy is also attached herewith for your reference."
'               'Add By Sindy 2023/8/17 + Y20267
'               Case "Y20267000"
'                  ExceptFieldData3 = "Our debit note will be separately sent to |#(底線)accountspayable@vo.eu#| for settlement."
'               'Add By Sindy 2023/9/11 +Y19261 Stetina Brunda Garred & Brucker
'               Case "Y19261000"
'                  ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)jblandford@stetinalaw.com#| for your settlement."
'               'Added by Lydia 2024/01/29 +Y55009 ; 沈佳穎(Monica)
'               Case "Y55009000"
'                  ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)invoice@rwzh.com#| for your settlement."
'               'Add By Sindy 2024/2/1 + Y54657; 洪琬姿協助設定印尼代理人 AFFA - Intellectual Property Rights
'               Case "Y54657000"
'                  ExceptFieldData3 = "Our debit note will be separately sent to |#(底線)accounting@affa.co.id#| for your kind settlement."
'               'Add By Sindy 2024/11/1
'               Case "Y49110000"
'                  ExceptFieldData3 = "Our debit note will be separately sent to |#(底線)trademarks@schoenherr.eu#| for settlement."
'               'Add By Sindy 2024/12/30
'               Case "Y45583000"
'                  ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)invoice@olbrichtpatent.de#| for your settlement."
'               'Add By Sindy 2025/2/11 + 德丹麥代理人 Y55759 Aera A/S
'               Case "Y55759000"
'                  ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)invoice@aera-ip.com#| for your settlement."
'               'Add By Sindy 2025/3/3 Y46443 MAROSCIA & ASSOCIATI S.R.L.
'               Case "Y46443000"
'                  ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)amministrazione@maroscia.com#| for your settlement."
'               'Added by Morgan 2025/5/27  Potter Clarkson (Y20115)--黃咸達/琬姿
'               Case "Y20115000"
'                  ExceptFieldData3 = "Our debit note will be separately sent to |#(底線)invoices@potterclarkson.com#| for your kind settlement."
'               'Add By Sindy 2025/6/4
'               Case "Y56181000"
'                  ExceptFieldData3 = "Our debit note will be separately sent to |#(底線)invoices_ctag@ptg.contitech.de#| for settlement."
'            End Select
'
'            'Add By Sindy 2020/7/20 Case "Y20225070" 'Marks & Clerk LLP (Edinburgh)
'            'Modify By Sindy 2021/5/5 Y20225, Y20225010, Y20225020, Y20225030, Y20225040, Y20225050, Y20225060, Y20225080, Y20225090
'            If Left(strTM44, 6) = "Y20225" Then
'               ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)associatepurchases@marks-clerk.com#|, and your earliest remittance will be appreciated."
'            'Add By Sindy 2023/8/8 + Y3368602
'            'Add By Sindy 2024/6/11 + Y3368601 德國代理人advotec. Patent- und Rechtsanwalte
'            ElseIf Left(strTM44, 6) = "Y33686" Then
'               ExceptFieldData3 = "Our debit note will be separately sent to |#(底線)invoice@advotec.de#| for settlement."
'            End If
'            '2021/5/5 END
'
'            'Added by Morgan 2023/3/2
'            'Novartis集團合併並改用常數 strTmNovartisCust 判斷
'            If ("" & RsTemp.Fields("TM23") <> "" And InStr(strTmNovartisCust, Left("" & RsTemp.Fields("TM23"), 6)) > 0) Or _
'               ("" & RsTemp.Fields("TM78") <> "" And InStr(strTmNovartisCust, Left("" & RsTemp.Fields("TM78"), 6)) > 0) Or _
'               ("" & RsTemp.Fields("TM79") <> "" And InStr(strTmNovartisCust, Left("" & RsTemp.Fields("TM79"), 6)) > 0) Or _
'               ("" & RsTemp.Fields("TM80") <> "" And InStr(strTmNovartisCust, Left("" & RsTemp.Fields("TM80"), 6)) > 0) Or _
'               ("" & RsTemp.Fields("TM81") <> "" And InStr(strTmNovartisCust, Left("" & RsTemp.Fields("TM81"), 6)) > 0) Or _
'               (strTM44 <> "" And InStr(strTmNovartisCust, Left(strTM44, 6)) > 0) Then
'               ExceptFieldData3 = "Our debit note will be submitted to the e-billing system for your kind settlement."
'            End If
'
'            'X56976000 East West Bank
'            If "" & RsTemp.Fields("TM23") = "X56976000" Or _
'               "" & RsTemp.Fields("TM78") = "X56976000" Or _
'               "" & RsTemp.Fields("TM79") = "X56976000" Or _
'               "" & RsTemp.Fields("TM80") = "X56976000" Or _
'               "" & RsTemp.Fields("TM81") = "X56976000" Then
'               'Modify By Sindy 2018/11/7
'               'ExceptFieldData3 = "Our debit note will be separately sent to |#(底線)EASTWESTBANK@AVIDBILL.COM#| and |#(底線)tammy.wong@eastwestbank.com#|."
'               'Modify By Sindy 2021/7/20
'               'ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)eastwestbankj@avidbill.com#|, with a copy to Ms. Tammy Wong at |#(底線)tammy.wong@eastwestbank.com#| via e-mail only."
'               ExceptFieldData3 = "Our debit note for services rendered will be sent directly to the client at |#(底線)eastwestbank@avidbill.com#| for its settlement."
'            'Modify By Sindy 2017/5/12
'            'X45799010 NOVARTIS AG
'            'Modified by Morgan Novartis集團合併並改用常數 strTmNovartisCust 判斷
'            'ElseIf "" & RsTemp.Fields("TM23") = "X45799010" Or _
'            '   "" & RsTemp.Fields("TM78") = "X45799010" Or _
'            '   "" & RsTemp.Fields("TM79") = "X45799010" Or _
'            '   "" & RsTemp.Fields("TM80") = "X45799010" Or _
'            '   "" & RsTemp.Fields("TM81") = "X45799010" Then
'            '   ExceptFieldData3 = "Our debit note will be submitted to the e-billing system for your kind settlement."
'            ElseIf ("" & RsTemp.Fields("TM23") <> "" And InStr(strTmNovartisCust, Left("" & RsTemp.Fields("TM23"), 6)) > 0) Or _
'               ("" & RsTemp.Fields("TM78") <> "" And InStr(strTmNovartisCust, Left("" & RsTemp.Fields("TM78"), 6)) > 0) Or _
'               ("" & RsTemp.Fields("TM79") <> "" And InStr(strTmNovartisCust, Left("" & RsTemp.Fields("TM79"), 6)) > 0) Or _
'               ("" & RsTemp.Fields("TM80") <> "" And InStr(strTmNovartisCust, Left("" & RsTemp.Fields("TM80"), 6)) > 0) Or _
'               ("" & RsTemp.Fields("TM81") <> "" And InStr(strTmNovartisCust, Left("" & RsTemp.Fields("TM81"), 6)) > 0) Or _
'               (strTM44 <> "" And InStr(strTmNovartisCust, Left(strTM44, 6)) > 0) Then
'               ExceptFieldData3 = "Our debit note will be submitted to the e-billing system for your kind settlement."
'            'end 2023/3/2
'            'ALL STAR C.V. (荷蘭-代理人為美國)
'            ElseIf "" & RsTemp.Fields("TM23") = "X70009000" Or _
'               "" & RsTemp.Fields("TM78") = "X70009000" Or _
'               "" & RsTemp.Fields("TM79") = "X70009000" Or _
'               "" & RsTemp.Fields("TM80") = "X70009000" Or _
'               "" & RsTemp.Fields("TM81") = "X70009000" Then
'               ExceptFieldData3 = "Our debit note for services rendered will be separately forwarded to |#(底線)accountspayable@mccrus.com#| by e-mail only for your kind settlement."
'            'Add By Sindy 2018/9/7
'            'X70124000 NORDSON CORPORATION
'            ElseIf "" & RsTemp.Fields("TM23") = "X70124000" Or _
'               "" & RsTemp.Fields("TM78") = "X70124000" Or _
'               "" & RsTemp.Fields("TM79") = "X70124000" Or _
'               "" & RsTemp.Fields("TM80") = "X70124000" Or _
'               "" & RsTemp.Fields("TM81") = "X70124000" Then
'               'Modify By Sindy 2019/1/15
'               'ExceptFieldData3 = "Our debit note for services rendered will be separately sent to Ms. Gina Beredo (|#(底線)Gina.Beredo@nordson.com#|) with a copy to |#(底線)patentlaw@nordson.com#| for your kind settlement."
'               ExceptFieldData3 = "Our debit note for services rendered has been separately uploaded to Serengeti Tracker system for your kind remittance."
'            'Add By Sindy 2019/6/24
'            ElseIf "" & RsTemp.Fields("TM23") = "X61139010" Or _
'               "" & RsTemp.Fields("TM78") = "X61139010" Or _
'               "" & RsTemp.Fields("TM79") = "X61139010" Or _
'               "" & RsTemp.Fields("TM80") = "X61139010" Or _
'               "" & RsTemp.Fields("TM81") = "X61139010" Or _
'               "" & RsTemp.Fields("TM23") = "X61645000" Or _
'               "" & RsTemp.Fields("TM78") = "X61645000" Or _
'               "" & RsTemp.Fields("TM79") = "X61645000" Or _
'               "" & RsTemp.Fields("TM80") = "X61645000" Or _
'               "" & RsTemp.Fields("TM81") = "X61645000" Then
'               'Modify By Sindy 2021/2/18
'               'ExceptFieldData3 = "Our debit note for services rendered will be separately uploaded through SimpleLegal system for your kind settlement."
'               ExceptFieldData3 = "Our debit note for services rendered will be separately uploaded to SimpleLegal for the client's settlement."
'            'Add By Sindy 2020/11/12 FRESENIUS MEDICAL CARE DEUTSCHLAND GMBH
'            ElseIf "" & RsTemp.Fields("TM23") = "X19893020" Or _
'               "" & RsTemp.Fields("TM78") = "X19893020" Or _
'               "" & RsTemp.Fields("TM79") = "X19893020" Or _
'               "" & RsTemp.Fields("TM80") = "X19893020" Or _
'               "" & RsTemp.Fields("TM81") = "X19893020" Then
'               ExceptFieldData3 = "Our debit note will be separately sent to |#(底線)fmcdeu-gmbh-accounts.payable@fmc-ag.com#| for settlement."
'
'            'Add By Sindy 2022/5/13
'            ElseIf Left("" & RsTemp.Fields("TM23"), 6) = "X83548" Or _
'               Left("" & RsTemp.Fields("TM78"), 6) = "X83548" Or _
'               Left("" & RsTemp.Fields("TM79"), 6) = "X83548" Or _
'               Left("" & RsTemp.Fields("TM80"), 6) = "X83548" Or _
'               Left("" & RsTemp.Fields("TM81"), 6) = "X83548" Then
'               ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)pdfinvoices_se@sandvik.com#| for settlement."
'
'            'Add By Sindy 2022/8/5 X2119903 (Baxter International Inc.)之定稿為特殊定稿，即將定稿內有debit note的句子更換
'            ElseIf Left("" & RsTemp.Fields("TM23"), 8) = "X2119903" Or _
'               Left("" & RsTemp.Fields("TM78"), 8) = "X2119903" Or _
'               Left("" & RsTemp.Fields("TM79"), 8) = "X2119903" Or _
'               Left("" & RsTemp.Fields("TM80"), 8) = "X2119903" Or _
'               Left("" & RsTemp.Fields("TM81"), 8) = "X2119903" Then
'               ExceptFieldData3 = "Our debit note for services rendered has been separately uploaded to Serengeti Legal Tracker system for your kind remittance."
'
'            'Add By Sindy 2021/3/4
'            'X74676 Seqirus UK Limited (英國)
'            'X74045 Seqirus S.r.l. (義大利)
'            'X63977 Seqirus Vaccines Limited (英國)
'            'Modify By Sindy 2022/8/12 取消申請人X74676(Seqirus UK Limited)、X74045(Seqirus S.r.l.)、 X63977(Seqirus Vaccines Limited) 之特殊定稿設定
''            ElseIf "" & RsTemp.Fields("TM23") = "X74676000" Or _
''               "" & RsTemp.Fields("TM78") = "X74676000" Or _
''               "" & RsTemp.Fields("TM79") = "X74676000" Or _
''               "" & RsTemp.Fields("TM80") = "X74676000" Or _
''               "" & RsTemp.Fields("TM81") = "X74676000" Or _
''               "" & RsTemp.Fields("TM23") = "X74045000" Or _
''               "" & RsTemp.Fields("TM78") = "X74045000" Or _
''               "" & RsTemp.Fields("TM79") = "X74045000" Or _
''               "" & RsTemp.Fields("TM80") = "X74045000" Or _
''               "" & RsTemp.Fields("TM81") = "X74045000" Or _
''               "" & RsTemp.Fields("TM23") = "X63977000" Or _
''               "" & RsTemp.Fields("TM78") = "X63977000" Or _
''               "" & RsTemp.Fields("TM79") = "X63977000" Or _
''               "" & RsTemp.Fields("TM80") = "X63977000" Or _
''               "" & RsTemp.Fields("TM81") = "X63977000" Then
''               ExceptFieldData3 = "Our monthly debit note will be separately uploaded to the doeLEGAL ASCENT system in early " & strExc(9) & " for your kind remittance."
'            End If
'
'            'Add By Sindy 2022/8/12
'            '請協助設定下列編號組合之定稿為特殊定稿，即將定稿內容有Debit Note的句子更換如下：
'            'Our monthly debit note will be separately uploaded to the doeLEGAL ASCENT system for your kind remittance.
'            'Y54380 + X74676
'            '         X85583
'            '         X74045
'            '         X63977
'            'Add By Sindy 2022/8/12
'            If Left(strTM44, 6) = "Y54380" Then
'               If InStr("" & RsTemp.Fields("TM23"), "X74676") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM78"), "X74676") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM79"), "X74676") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM80"), "X74676") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM81"), "X74676") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM23"), "X85583") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM78"), "X85583") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM79"), "X85583") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM80"), "X85583") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM81"), "X85583") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM23"), "X74045") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM78"), "X74045") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM79"), "X74045") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM80"), "X74045") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM81"), "X74045") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM23"), "X63977") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM78"), "X63977") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM79"), "X63977") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM80"), "X63977") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM81"), "X63977") > 0 Then
'                  ExceptFieldData3 = "Our monthly debit note will be separately uploaded to the doeLEGAL ASCENT system for your kind remittance."
'               End If
'            'Add By Sindy 2022/8/18 有關代理人Y55402 Delivery Hero SE 請依申請人設定其有關請款單部分之特殊定稿內容
'            ElseIf Left(strTM44, 6) = "Y55402" Then
'               'X82732 Delivery Hero SE
'               'X83137 FOODPANDA GMBH
'               If InStr("" & RsTemp.Fields("TM23"), "X82732") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM78"), "X82732") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM79"), "X82732") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM80"), "X82732") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM81"), "X82732") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM23"), "X83137") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM78"), "X83137") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM79"), "X83137") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM80"), "X83137") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM81"), "X83137") > 0 Then
'                  ExceptFieldData3 = "We will submit a monthly consolidated invoice for our services rendered to |#(底線)invoices.1001@deliveryhero.com#| at the end of this month for your kind settlement."
'               'X84527 Delivery Hero APAC Pte Limited
'               'X83051 Delivery Hero Kitchens APAC Holding Pte. Ltd.
'               ElseIf InStr("" & RsTemp.Fields("TM23"), "X84527") > 0 Or _
'                      InStr("" & RsTemp.Fields("TM78"), "X84527") > 0 Or _
'                      InStr("" & RsTemp.Fields("TM79"), "X84527") > 0 Or _
'                      InStr("" & RsTemp.Fields("TM80"), "X84527") > 0 Or _
'                      InStr("" & RsTemp.Fields("TM81"), "X84527") > 0 Or _
'                      InStr("" & RsTemp.Fields("TM23"), "X83051") > 0 Or _
'                      InStr("" & RsTemp.Fields("TM78"), "X83051") > 0 Or _
'                      InStr("" & RsTemp.Fields("TM79"), "X83051") > 0 Or _
'                      InStr("" & RsTemp.Fields("TM80"), "X83051") > 0 Or _
'                      InStr("" & RsTemp.Fields("TM81"), "X83051") > 0 Then
'                  ExceptFieldData3 = "Our debit note for services rendered will be included in the monthly summary and consolidated invoice will be forwarded to |#(底線)apacip@foodpanda.com#| at the end of this month."
'               End If
'               '2022/8/18 END
'            'Add By Sindy 2023/6/27 CARL FREUDENBERG KG Patents, Trademarks and Information
'            ElseIf Left(strTM44, 6) = "Y17853" Then
'            '2023/6/27 END
'               'FREUDENBERG SE
'               If InStr("" & RsTemp.Fields("TM23"), "X73155") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM78"), "X73155") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM79"), "X73155") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM80"), "X73155") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM81"), "X73155") > 0 Then
'                  ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)fse.invoices@freudenberg.com#| for your kind settlement."
'               'CARL FREUDENBERG KG
'               ElseIf InStr("" & RsTemp.Fields("TM23"), "X17853") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM78"), "X17853") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM79"), "X17853") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM80"), "X17853") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM81"), "X17853") > 0 Then
'                  ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)cf.invoices@freudenberg.com#| for your kind settlement."
'               'CARL FREUDENBERG KG
'               ElseIf InStr("" & RsTemp.Fields("TM23"), "X17853C10") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM78"), "X17853C10") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM79"), "X17853C10") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM80"), "X17853C10") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM81"), "X17853C10") > 0 Then
'                  ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)cf.invoices@freudenberg.com#| for your kind settlement."
'               'CARL FREUDENBERG KG
'               ElseIf InStr("" & RsTemp.Fields("TM23"), "X73365000") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM78"), "X73365000") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM79"), "X73365000") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM80"), "X73365000") > 0 Or _
'                  InStr("" & RsTemp.Fields("TM81"), "X73365000") > 0 Then
'                  ExceptFieldData3 = "Our debit note for services rendered will be separately sent to |#(底線)cf.invoices@freudenberg.com#| for your kind settlement."
'               End If
'            End If
            '2025/6/18 END
            
            'Modify By Sindy 2018/5/30 取消ChgSQL,因為會變company''s instruction
            'Modify By Sindy 2018/7/23 沒有加ChgSQL,會因為's存檔失敗,無法產生定稿內容 ex:FCT-041852
            ExceptFieldData3 = ChgSQL(ExceptFieldData3)
         End If
      '2017/4/12 END
      
      'Added by Morgan 2018/4/18
      'Modified by Morgan 2021/3/29 +"香港相關案申請國家/英"
      Case "香港相關案申請國家", "香港相關案本所案號", "香港相關案申請案號", "香港相關案申請國家/英"
         strExc(0) = "SELECT NA03,PA01||'-'||PA02||DECODE(PA03||PA04,'000','','-'||PA03||'-'||PA04) RNo,PA11,decode(na01,'020','PRC',decode(instr('101,201',na01),0,null,'the ')||initcap(NA04)) NA04" & _
            " FROM CASEMAP,PATENT,NATION WHERE CM01='" & m_MySt(1) & "'" & _
            " AND CM02='" & m_MySt(2) & "' AND CM03='" & m_MySt(3) & "' AND CM04='" & m_MySt(4) & "' AND CM10='4'" & _
            " AND PA01(+)=CM05 AND PA02(+)=CM06 AND PA03(+)=CM07 AND PA04(+)=CM08 AND NA01(+)=PA09"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If strField = "香港相關案申請國家" Then
               ExceptFieldData3 = RsTemp("NA03")
            ElseIf strField = "香港相關案申請國家/英" Then
               ExceptFieldData3 = RsTemp("NA04")
            ElseIf strField = "香港相關案本所案號" Then
               ExceptFieldData3 = RsTemp("RNo")
            ElseIf strField = "香港相關案申請案號" Then
               ExceptFieldData3 = RsTemp("PA11")
            End If
         End If
         
      'Added by Morgan 2018/6/21 FCP定稿 Y45814000 BASF案件要用
      'Modified by Morgan 2018/8/31 +Y54554 BASF (China)
      'Modified by Morgan 2019/1/29 +Y55062 BASF Chemicals India Pvt. Ltd.
      'Modified by Morgan 2019/7/11 +Y45697  BASF Schweiz AG --劉興杰
      'Modified by Morgan 2020/8/7 +Y55062B10 (BASF Chemicals India Pvt. Ltd.) -- 洪培堯
      Case "BASF要印", "BASF不印"
         strExc(0) = "SELECT pa75 FROM PATENT WHERE " & PaSt & " and instr('Y45814000,Y54554000,Y54554B10,Y55062000,Y45697000,Y55062B10,Y46933000,Y33268020,Y55901000,Y53788000,Y52263010',pa75)>0" & _
            " union SELECT sp26 FROM SERVICEPRACTICE WHERE " & SpSt & " and instr('Y45814000,Y54554000,Y54554B10,Y55062000,Y45697000,Y55062B10,Y46933000,Y33268020,Y55901000,Y53788000,Y52263010',sp26)>0"
         
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData3 = "♀"
         End If
      'Added by Morgan 2025/4/24
      Case "SE要印", "SE不印"
         strExc(0) = "SELECT pa75 FROM PATENT WHERE " & PaSt & " and pa75='Y34049010'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData3 = "♀"
         End If
         
      'Add By Sindy 2021/8/5 非BASF所用
      Case "下一程序法限非BASF/英", "下一程序所限非BASF/英", "下一程序約定期限非BASF/英"
         'Modify By Sindy 2021/7/23 David:申請階段定稿標題不必列實審期限=>那僅是預告
         '因此基本檔無公開日則標題不必列實審期限。
         strExc(0) = "select pa01,pa12 from patent" & _
            " where pa01='" & m_MySt(1) & "' and pa02='" & m_MySt(2) & "'" & _
            " and pa03='" & m_MySt(3) & "' and pa04='" & m_MySt(4) & "'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         bolHad416 = False
         If intI = 1 Then
            If Val("" & RsTemp.Fields("pa12")) > 0 Then
               bolHad416 = True
            End If
         End If
         '2021/7/23 END
         'Modify By Sindy 2021/7/23 + IIf(bolHad416 = False, " and np07<>'416'", "")
         'Modified by Morgan 2022/1/22 + np08,np23 有值也要
         strExc(0) = "select distinct np09,np08,np23 from nextprogress" & _
            " where np02='" & m_MySt(1) & "' and np03='" & m_MySt(2) & "'" & _
            " and np04='" & m_MySt(3) & "' and np05='" & m_MySt(4) & "'" & _
            " and np06 is null and (np09>" & strSrvDate(1) & " or np08>" & strSrvDate(1) & " or np23>" & strSrvDate(1) & ")" & strNpSqlOfNoSalesDuty & _
            IIf(bolHad416 = False, " and np07<>'416'", "") & _
            " order by np09 asc"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If strField = "下一程序法限非BASF/英" Then
               ExceptFieldData3 = "" & RsTemp.Fields("np09")
            ElseIf strField = "下一程序所限非BASF/英" Then
               ExceptFieldData3 = "" & RsTemp.Fields("np08")
            'Add By Sindy 2021/8/5
            ElseIf strField = "下一程序約定期限非BASF/英" Then
               ExceptFieldData3 = "" & RsTemp.Fields("np23")
            '2021/8/5 END
            End If
            RsTemp.MoveNext
            Do While Not RsTemp.EOF
               If strField = "下一程序法限非BASF/英" Then
                  ExceptFieldData3 = ExceptFieldData3 & "," & RsTemp.Fields("np09")
               ElseIf strField = "下一程序所限非BASF/英" Then
                  ExceptFieldData3 = ExceptFieldData3 & "," & RsTemp.Fields("np08")
               'Add By Sindy 2021/8/5
               ElseIf strField = "下一程序約定期限非BASF/英" Then
                  ExceptFieldData3 = ExceptFieldData3 & "," & RsTemp.Fields("np23")
               '2021/8/5 END
               End If
               RsTemp.MoveNext
            Loop
            ExceptFieldData3 = ParserKeyWord("/", ExceptFieldData3, "英")
         Else
            ExceptFieldData3 = ""
         End If
         
      'Modify By Sindy 2021/8/5 + 下一程序約定期限/英
      Case "下一程序法限/英", "下一程序所限/英", "下一程序約定期限/英"
         'Modify By Sindy 2021/7/23 David:申請階段定稿標題不必列實審期限=>那僅是預告
         '因此基本檔無公開日則標題不必列實審期限。
         strExc(0) = "select pa01,pa12 from patent" & _
            " where pa01='" & m_MySt(1) & "' and pa02='" & m_MySt(2) & "'" & _
            " and pa03='" & m_MySt(3) & "' and pa04='" & m_MySt(4) & "'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         bolHad416 = False
         If intI = 1 Then
            If Val("" & RsTemp.Fields("pa12")) > 0 Then
               bolHad416 = True
            End If
         End If
         '2021/7/23 END
         'Modify By Sindy 2021/7/23 + IIf(bolHad416 = False, " and np07<>'416'", "")
         strExc(0) = "select distinct np09,np08,np23 from nextprogress" & _
            " where np02='" & m_MySt(1) & "' and np03='" & m_MySt(2) & "'" & _
            " and np04='" & m_MySt(3) & "' and np05='" & m_MySt(4) & "'" & _
            " and np06 is null and np09>" & strSrvDate(1) & strNpSqlOfNoSalesDuty & _
            IIf(bolHad416 = False, " and np07<>'416'", "") & _
            " order by np09 asc"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If strField = "下一程序法限/英" Then
               ExceptFieldData3 = "" & RsTemp.Fields("np09")
            ElseIf strField = "下一程序所限/英" Then
               ExceptFieldData3 = "" & RsTemp.Fields("np08")
            'Add By Sindy 2021/8/5
            ElseIf strField = "下一程序約定期限/英" Then
               ExceptFieldData3 = "" & RsTemp.Fields("np23")
            '2021/8/5 END
            End If
            RsTemp.MoveNext
            Do While Not RsTemp.EOF
               If strField = "下一程序法限/英" Then
                  ExceptFieldData3 = ExceptFieldData3 & "," & RsTemp.Fields("np09")
               ElseIf strField = "下一程序所限/英" Then
                  ExceptFieldData3 = ExceptFieldData3 & "," & RsTemp.Fields("np08")
               'Add By Sindy 2021/8/5
               ElseIf strField = "下一程序約定期限/英" Then
                  ExceptFieldData3 = ExceptFieldData3 & "," & RsTemp.Fields("np23")
               '2021/8/5 END
               End If
               RsTemp.MoveNext
            Loop
            ExceptFieldData3 = ParserKeyWord("/", ExceptFieldData3, "英")
         Else
            ExceptFieldData3 = "None"
         End If
         
      Case "發明人1/英"
         strExc(0) = "SELECT in05 FROM PATENTINVENTOR,INVENTOR" & _
                  " WHERE Pi01='" & m_MySt(1) & "' AND Pi02='" & m_MySt(2) & "' AND Pi03='" & m_MySt(3) & "' AND Pi04='" & m_MySt(4) & "'" & _
                  " AND SUBSTR(pi06,1,8)=IN01(+) AND SUBSTR(pi06,9,2)=IN02(+)" & _
                  " order by pi05 asc"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData3 = "" & RsTemp(0)
         End If
      'end 2018/6/21
      
      'Added by Morgan 2018/8/3 三友(Y30953),戈程(Y52537)新型,設計領證或結案可退費 --玲玲
      'Modified by Morgan 2018/8/17 +上海唯源(Y52404) --玲玲
      Case "領證提醒陸代退還費用", "領證結案提醒陸代退還費用", "結案提醒陸代退還領證費用"
         strExc(0) = "select pa10 from caseprogress a,patent" & _
            " where cp09='" & g_LD18 & "' and cp44 in ('Y30953000','Y52537000','Y52404000')" & _
            " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04 and pa09='020'" & _
            " and exists(select * from caseprogress b where b.cp01=a.cp01 and b.cp02=a.cp02 and b.cp03=a.cp03 and b.cp04=a.cp04" & _
            " and b.cp10 in ('102','103') and b.cp44=a.cp44)"
         If strField = "領證提醒陸代退還費用" Then
            strExc(0) = strExc(0) & " and pa10<20180801"
         ElseIf strField = "結案提醒陸代退還領證費用" Then
            strExc(0) = strExc(0) & " and nvl(pa16,'N')='N'"
         End If
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData3 = "♀"
         End If
         
      'Added by Morgan 2018/8/7
      'Modified by Morgan 2024/4/26 EPC子案改抓母案申請案號,只有德國繳年費要抓子案申請號(國家階段申請號)，故更改例外欄位
      'Case "EPC母案申請案號"
      '   strExc(0) = "SELECT PA11 FROM PATENT WHERE PA01='" & m_MySt(1) & "' AND PA02='" & _
      '      m_MySt(2) & "' AND PA03='" & m_MySt(3) & "' AND PA04='00'"
      '   intI = 1
      '   Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
      '   If intI = 1 Then
      '      ExceptFieldData3 = "" & RsTemp.Fields(0).Value
      '   End If
      Case "EPC子案申請案號"
         strExc(0) = "SELECT PA11 FROM PATENT WHERE " & PaSt
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData3 = "" & RsTemp.Fields(0).Value
         End If
      'end 2024/4/26
      
      'Added by Morgan 2018/11/22
      Case "EPC子案申請國家"
         If m_MySt(4) <> "00" Then
            ExceptFieldData3 = ExceptFieldData3("申請國家")
         End If
      Case "申請國家"
         If m_MySt(6) = "201" Then
            ExceptFieldData3 = "U.K." '英國
         Else
            ExceptFieldData3 = DoChange("專利基本檔-申請國家", "NA04")
         End If
      'end 2018/11/22
      
      'Added by Morgan 2019/1/23
      'Modified by Morgan 2021/6/11 +實審自動代繳帶出2
      Case "實審自動代繳帶出", "實審自動代繳不帶出", "實審自動代繳帶出2"
         strExc(0) = "SELECT NVL(PA69,NVL(FA124,CU177)),PA26 FROM PATENT,FAGENT,CUSTOMER WHERE " & PaSt & _
            " AND FA01(+)=SUBSTR(PA75,1,8) AND FA02(+)=SUBSTR(PA75,9) AND CU01(+)=SUBSTR(PA26,1,8) AND CU02(+)=SUBSTR(PA26,9)"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If Not IsNull(RsTemp(0)) Then
               strExc(0) = "X68646000,X47178000" '定稿不同
               If strField = "實審自動代繳帶出" Then
                  If InStr(strExc(0), RsTemp("pa26")) = 0 Then
                     ExceptFieldData3 = "♀"
                  End If
               ElseIf strField = "實審自動代繳帶出2" Then
                  If InStr(strExc(0), RsTemp("pa26")) > 0 Then
                     ExceptFieldData3 = "♀"
                  End If
               Else
                  ExceptFieldData3 = "♀"
               End If
            End If
         End If
               
      'Modify By Sindy 2021/4/27 +, "實審約定期限"
      Case "有實審期限帶出", "實審本所期限", "實審法定期限", "實審約定期限"
         'Modify By Sindy 2021/4/27 +,NP23
         strExc(0) = "SELECT NP08,NP09,NP23 FROM PATENT,NEXTPROGRESS WHERE " & PaSt & _
            " AND NP02(+)=PA01 AND NP03(+)=PA02 AND NP04(+)=PA03 AND NP05(+)=PA04 AND NP07='416' AND NP06 IS NULL"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If strField = "有實審期限帶出" Then
               ExceptFieldData3 = "♀"
            ElseIf strField = "實審本所期限" Then
               ExceptFieldData3 = RsTemp("NP08")
            'Modify By Sindy 2021/4/27
            ElseIf strField = "實審約定期限" Then
               ExceptFieldData3 = RsTemp("NP23")
            '2021/4/27 END
            ElseIf strField = "實審法定期限" Then
               ExceptFieldData3 = RsTemp("NP09")
            End If
         End If
      'end 2019/1/23
      
      Case "新型未收技術報告才印" 'Added by Morgan 2019/1/28
         strExc(0) = "SELECT 1 FROM PATENT WHERE " & PaSt & _
            " AND PA08='2' AND NOT EXISTS(SELECT * FROM CASEPROGRESS WHERE CP01=PA01 AND CP02=PA02 AND CP03=PA03 AND CP04=PA04 AND CP10='421' AND CP57 IS NULL)"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData3 = "♀"
         End If
      'Added by Morgan 2019/3/29
      Case "日本發明10年內要印"
         'Modified by Morgan 2019/4/11 +判斷實審提申日>=20190401--禧佩
         strExc(0) = "SELECT PA11 FROM PATENT WHERE " & PaSt & _
            " AND PA08='1' AND PA09='011' AND nvl(lastyear(pa72),0)<10" & _
            " AND EXISTS(SELECT* FROM CASEPROGRESS WHERE CP01=PA01 AND CP02=PA02 AND CP03=PA03 AND CP04=PA04 AND CP10='416' AND NVL(CP47,CP27)>20190401)"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData3 = "♀"
         End If
      'Added by Morgan 2019/4/25
      Case "日專可減免時印", "日專不可減免時印"
         strExc(0) = "SELECT CP81 FROM CASEPROGRESS,PATENT WHERE CP09='" & m_Rule & "' AND PA01(+)=CP01 AND PA02(+)=CP02 AND PA03(+)=CP03 AND PA04(+)=CP04 AND PA09='011' AND PA08='1'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If strField = "日專可減免時印" Then
               If RsTemp(0) = "Y" Then ExceptFieldData3 = "♀"
            ElseIf strField = "日專不可減免時印" Then
               If RsTemp(0) = "N" Then ExceptFieldData3 = "♀"
            End If
         End If
         
      Case "日專實審可減免時印", "日專實審不可減免時印"
          strExc(0) = "SELECT CP81 FROM CASEPROGRESS,PATENT WHERE CP01='" & m_MySt(1) & "' and CP02='" & m_MySt(2) & "'" & _
            " and CP03='" & m_MySt(3) & "' and CP04='" & m_MySt(4) & "' and cp10='416' AND PA01(+)=CP01 AND PA02(+)=CP02 AND PA03(+)=CP03 AND PA04(+)=CP04 AND PA09='011' AND PA08='1'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If strField = "日專實審可減免時印" Then
               If RsTemp(0) = "Y" Then ExceptFieldData3 = "♀"
            ElseIf strField = "日專實審不可減免時印" Then
               If RsTemp(0) = "N" Then ExceptFieldData3 = "♀"
            End If
         End If
         
      Case "申請人1減免資格/英"
         strExc(0) = "select ad03,ad10,ad15 from patent,applicantdiscount where " & PaSt & " AND PA09='011' AND PA08='1' and ad01(+)=substr(pa26,1,8) and ad02(+)=pa09 and ad03 is not null"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If RsTemp("ad03") = "Y" Then
               ExceptFieldData3 = PUB_GetJpDiscountDesc(RsTemp("ad10"), RsTemp("ad15"), "2")
            End If
         End If
      Case "申請人2減免資格/英"
         strExc(0) = "select ad03,ad10,ad15 from patent,applicantdiscount where " & PaSt & " AND PA09='011' AND PA08='1' and ad01(+)=substr(pa27,1,8) and ad02(+)=pa09 and ad03 is not null"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If RsTemp("ad03") = "Y" Then
               ExceptFieldData3 = PUB_GetJpDiscountDesc(RsTemp("ad10"), RsTemp("ad15"), "2")
            End If
         End If
      Case "申請人3減免資格/英"
         strExc(0) = "select ad03,ad10,ad15 from patent,applicantdiscount where " & PaSt & " AND PA09='011' AND PA08='1' and ad01(+)=substr(pa28,1,8) and ad02(+)=pa09 and ad03 is not null"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If RsTemp("ad03") = "Y" Then
               ExceptFieldData3 = PUB_GetJpDiscountDesc(RsTemp("ad10"), RsTemp("ad15"), "2")
            End If
         End If
      Case "申請人4減免資格/英"
         strExc(0) = "select ad03,ad10,ad15 from patent,applicantdiscount where " & PaSt & " AND PA09='011' AND PA08='1' and ad01(+)=substr(pa29,1,8) and ad02(+)=pa09 and ad03 is not null"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If RsTemp("ad03") = "Y" Then
               ExceptFieldData3 = PUB_GetJpDiscountDesc(RsTemp("ad10"), RsTemp("ad15"), "2")
            End If
         End If
      Case "申請人5減免資格/英"
         strExc(0) = "select ad03,ad10,ad15 from patent,applicantdiscount where " & PaSt & " AND PA09='011' AND PA08='1' and ad01(+)=substr(pa30,1,8) and ad02(+)=pa09 and ad03 is not null"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If RsTemp("ad03") = "Y" Then
               ExceptFieldData3 = PUB_GetJpDiscountDesc(RsTemp("ad10"), RsTemp("ad15"), "2")
            End If
         End If
      'end 2019/4/25
      
      'Added by Lydia 2019/08/28
      Case "回答要章"
            '日本代理人Nikon (Y45149) 催年費定稿
            strExc(1) = PUB_GetReceiver(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), m_CP10, m_SysKind)
            If strExc(1) = "Y45149000" Then 'Nikon
                ExceptFieldData3 = "|#(回答要章)#|"
            Else
                ExceptFieldData3 = "　　　　　　" '因為與<系統日/英>在同一行，所以要補空白
            End If
            
      'Added by Morgan 2019/9/18
      Case "設計未收文延緩審查"
         strExc(0) = "SELECT 1 FROM PATENT WHERE " & PaSt & _
            " AND PA08='3' AND NOT EXISTS(SELECT * FROM CASEPROGRESS WHERE CP01=PA01 AND CP02=PA02 AND CP03=PA03 AND CP04=PA04 AND CP10='245' AND CP57 IS NULL)"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData3 = "♀"
         End If
      'Added by Morgan 2023/9/15
      Case "設計未收文加速審查"
         strExc(0) = "SELECT 1 FROM PATENT WHERE " & PaSt & _
            " AND PA08='3' AND NOT EXISTS(SELECT * FROM CASEPROGRESS WHERE CP01=PA01 AND CP02=PA02 AND CP03=PA03 AND CP04=PA04 AND CP10='422' AND CP57 IS NULL)"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData3 = "♀"
         End If
      'Added by Morgan 2019/9/18
      Case "設計已發文延緩審查"
         strExc(0) = "SELECT 1 FROM PATENT WHERE " & PaSt & _
            " AND PA08='3' AND  EXISTS(SELECT * FROM CASEPROGRESS WHERE CP01=PA01 AND CP02=PA02 AND CP03=PA03 AND CP04=PA04 AND CP10='245' AND CP57 IS NULL and cp27>0)"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData3 = "♀"
         End If
      'Added by Lydia 2019/09/20
      Case "商標種類國內名稱電子送件"
         'Modified by Lydia 2021/09/11 增加「原為聯合服務標章」=>「92年修正前服務標章」
         'strExc(0) = "SELECT PTM03||Decode(TM58, Null, '', Decode(instr(TM58, '原為服務標章'), 0, '', '(92年修正前服務標章)') ) as PTM03" & _
                            " FROM TRADEMARK, PatentTrademarkMap WHERE " & TmSt & " And TM08=PTM02(+) And '2'=PTM01 "
         strExc(0) = "SELECT PTM03||Decode(TM58, Null, '', Decode(instr(TM58, '原為服務標章'), 0, Decode(Instr(Tm58, '原為聯合服務標章'), 0, '', '(92年修正前服務標章)'), '(92年修正前服務標章)') ) as PTM03" & _
                            " FROM TRADEMARK, PatentTrademarkMap WHERE " & TmSt & " And TM08=PTM02(+) And '2'=PTM01 "
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData3 = "" & RsTemp.Fields(0).Value
         End If
      'Added by Morgan 2019/9/20
      Case "紙本證書", "申請紙本專利證書"
         '墨西哥非紙本
         'Modified by Morgan 2023/6/13
         'If m_MySt(6) <> "104" Then
         strExc(0) = "select pa08,cp27 from patent,caseprogress where " & PaSt & " and cp01(+)=pa01 and cp02(+)=pa02 and cp03(+)=pa03 and cp04(+)=pa04 and cp10(+)='443' and cp159(+)=0"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If RsTemp("cp27") > 0 Then
               ExceptFieldData3 = "♀"
               
            ElseIf strField = "紙本證書" Then
               If PUB_IsECertificate(m_MySt(6), m_MySt(1), RsTemp("pa08")) = False Then
                  ExceptFieldData3 = "♀"
               End If
            End If
         End If
         'end 2023/6/13
      
      'Added by Morgan 2023/6/14
      Case "俄羅斯未申請紙本證書才印"
         If m_MySt(6) = "023" Then
            If PUB_ChkCPExist(m_MySt(), "443") = False Then
               ExceptFieldData3 = "♀"
            End If
         End If
      
      'Added by Morgan 2019/12/12
      Case "X設寄證書後年費不續辦N要印"
         strExc(0) = "SELECT 1 FROM PATENT,CUSTOMER WHERE " & PaSt & _
            " AND CU01(+)=SUBSTR(PA26,1,8) AND CU02(+)=SUBSTR(PA26,9) AND CU74='N'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData3 = "♀"
         End If
         
      'Added by Morgan 2019/12/17
      Case "領證一併請款二次核對要印"
         strExc(0) = "SELECT 1 FROM PATENT,CASEPROGRESS,ACC1L0 WHERE " & PaSt & _
            " AND CP01(+)=PA01 AND CP02(+)=PA02 AND CP03(+)=PA03 AND CP04(+)=PA04 AND CP10='601' AND CP57 IS NULL" & _
            " AND A1L01(+)=CP60 AND A1L04='926'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData3 = "♀"
         End If
         
      'Added by Morgan 2019/12/17
      Case "二次核對中", "二次核對中/附請款單", "二次核對中/附公報", "二次核對中/附公報/附請款單"
         'Modify By Sindy 2021/3/11 + ,PA26
         strExc(0) = "SELECT PA01,PA02,PA03,PA04,PA75,CP20,CP27,CP57,CP60,PA26,PA27,PA28,PA29,PA30" & _
            " FROM PATENT,CASEPROGRESS WHERE " & PaSt & _
            " AND CP01(+)=PA01 AND CP02(+)=PA02 AND CP03(+)=PA03 AND CP04(+)=PA04" & _
            " and cp10='926' and cp27||cp57 is null"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            'Add By Sindy 2021/3/29 通知函承辦單備註設定
            Call PUB_GetFcpEMPBillSpec(RsTemp("PA01") & RsTemp("PA02") & RsTemp("PA03") & RsTemp("PA04"), "03", _
                         RsTemp("PA75"), "" & RsTemp("PA26") & "," & RsTemp("PA27") & "," & RsTemp("PA28") & "," & RsTemp("PA29") & "," & RsTemp("PA30"), _
                         , , , , , , , , gReport)
            '2021/3/29 END
            
            '二次核對不附公報
            'Modified by Morgan 2019/12/18 補 Y45149000
            'Add By Sindy 2021/3/9
            ' Y33801 (SNELL & WILMER (PHOENIX OFFICE)) + X68646 (ASM IP Holding B.V.)
            ' Y33801B2 (Snell & Wilmer L.L.P. (Los Angeles Office))+ X68646 (ASM IP Holding B.V.)
            ' Y33801 (SNELL & WILMER (PHOENIX OFFICE)) + X47178 (ASM AMERICA, INC.)
            ' Y33801B2 (Snell & Wilmer L.L.P. (Los Angeles Office))+X47178 (ASM AMERICA, INC.)
            'Modify By Sindy 2021/3/30 + Or gReport = "Y"
'            If InStr("Y45149000,Y20438000,Y34210000,Y34210030,Y51982000,Y34210010,Y34210020", Left(RsTemp("PA75"), 8)) > 0 Or _
'               ("" & RsTemp("PA75") = "Y33801000" And Left("" & RsTemp("PA26"), 8) = "X6864600") Or _
'               ("" & RsTemp("PA75") = "Y33801B20" And Left("" & RsTemp("PA26"), 8) = "X6864600") Or _
'               ("" & RsTemp("PA75") = "Y33801000" And Left("" & RsTemp("PA26"), 8) = "X4717800") Or _
'               ("" & RsTemp("PA75") = "Y33801B20" And Left("" & RsTemp("PA26"), 8) = "X4717800")
            'Modified by Lydia 2023/11/03 依據FCP-62224輸入證書時二核尚未發文未請款，應該列出”二次核對中/附公報/附請款單”；與Sindy討論應該是FEB23的判斷有問題
            'If gReport = "Y" Then '二次核對不附公報
            'Modified by Morgan 2023/11/14 還原,gReport='Y'是證書有附公報故推斷二次核對不附公報,應該是日文定稿要增加 "二次核對中/附請款單"的段落
            'If gReport <> "Y" Then '二次核對不附公報
            If gReport = "Y" Then '二次核對不附公報
            'end 2023/11/14
               '不附請款單(不請款或有請款單號)
               If RsTemp("CP20") & RsTemp("CP60") <> "" Then
                  If strField = "二次核對中" Then
                     ExceptFieldData3 = "♀"
                  End If
               Else
                  If strField = "二次核對中/附請款單" Then
                     ExceptFieldData3 = "♀"
                  End If
               End If
               
            '二次核對要附公報
            Else
               '不附請款單(不請款或有請款單號)
               If RsTemp("CP20") & RsTemp("CP60") <> "" Then
                  If strField = "二次核對中/附公報" Then
                     ExceptFieldData3 = "♀"
                  End If
               Else
                  If strField = "二次核對中/附公報/附請款單" Then
                     ExceptFieldData3 = "♀"
                  End If
               End If
            End If
         End If
      
      'Added by Morgan 2019/12/17
      'Modified by Morgan 2025/8/27 +年費自動代繳要印
      Case "年費自動代繳不印", "年費自動代繳才印", "年費自動代繳要印"
         If PUB_GetAutoPay(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4)) = "Y" Then
            ExceptFieldData3 = "♀"
         End If
      'Added by Morgan 2020/6/11
      Case "收款後辦案不印", "收款後辦案才印"
         strExc(0) = "SELECT NVL(FA39,CU72) FA39 FROM PATENT,FAGENT,CUSTOMER WHERE " & PaSt & _
            " AND FA01(+)=SUBSTR(PA75,1,8) AND FA02(+)=SUBSTR(PA75,9)" & _
            " AND CU01(+)=SUBSTR(PA26,1,8) AND CU02(+)=SUBSTR(PA26,9)"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If RsTemp(0) = "Y" Then
               ExceptFieldData3 = "♀"
            End If
         End If
      'Added by Morgan 2020/6/16
      Case "Y55430+X82692不印", "Y55430+X82692才印"
         strExc(0) = "SELECT 1 FROM PATENT WHERE " & PaSt & " and pa75='Y55430000' and pa26='X82692000'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData3 = "♀"
         End If
      'Added by Morgan 2022/3/313
      'Modified by Morgan 2022/4/27 +X82908才印,X82908不印(特殊內容改獨立段落，比較好控制)
      Case "X82908不帶出", "X82908才印", "X82908不印"
         strExc(0) = "SELECT 1 FROM PATENT WHERE " & PaSt & " and pa26='X82908000'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData3 = "♀"
         End If
      'Added by Morgan 2022/5/18
      Case "Y53034才印"
         strExc(0) = "SELECT 1 FROM PATENT WHERE " & PaSt & " and pa75='Y53034000'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData3 = "♀"
         End If
         
      'Added by Morgan 2020/10/15 CFP證書定稿控制用( CFP-05-000-24 )
      Case "無正本不印", "無正本要印"
         'Modified by Morgan 2022/1/6 改抓國家檔設定
         'strExc(0) = Pub_GetSpecMan("CFP證書無正本國家")
         'If InStr(strExc(0), m_MySt(6)) > 0 Then
         '   ExceptFieldData3 = "♀"
         strExc(0) = "SELECT pa08 FROM PATENT WHERE " & PaSt
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If PUB_IsECertificate(m_MySt(6), m_MySt(1), RsTemp("pa08")) = True Then
               'Modified by Morgan 2023/6/14 俄羅斯沒有申請紙本專利證書才無正本
               'ExceptFieldData3 = "♀"
               If m_MySt(6) = "023" Then
                  If PUB_ChkCPExist(m_MySt(), "443") = False Then
                     ExceptFieldData3 = "♀"
                  End If
               Else
                  ExceptFieldData3 = "♀"
               End If
               'end 2023/6/14
            End If
         'end 2022/1/6
         End If
      'Added by Morgan 2020/10/15 CFP證書定稿控制用( CFP-05-000-24 )
      Case "無維持費用不印"
         strExc(0) = "select 1 from patent,nation where pa01='" & m_MySt(1) & "' and pa02='" & m_MySt(2) & "'" & _
            " and pa03='" & m_MySt(3) & "' and pa04='" & m_MySt(4) & "' and na01(+)=pa09" & _
            " and ((pa08='1' and na07 is not null and na20 is null) or (pa08='2' and na09 is not null and na22 is null)" & _
            " or (pa08='3' and na11 is not null and na24 is null))"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData3 = "♀"
         End If
         
      'Added by Morgan 2021/1/27
      Case "歐盟案證書號"
         strExc(0) = "select b.pa22 from patent a,caserelation1,patent b" & _
            " where a.pa01='" & m_MySt(1) & "' and a.pa02='" & m_MySt(2) & "'" & _
            " and a.pa03='" & m_MySt(3) & "' and a.pa04='" & m_MySt(4) & "' and cr01(+)=a.pa01" & _
            " and cr02(+)=a.pa02 and cr03(+)=a.pa03 and cr04(+)=a.pa04 and b.pa01(+)=cr05" & _
            " and b.pa02(+)=cr06 and b.pa03(+)=cr07 and b.pa04(+)=cr08 and b.pa09='239'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData3 = "" & RsTemp(0)
         End If
      'Added by Morgan 2021/1/27
      Case "歐盟案註冊號"
         strExc(0) = "select b.tm15 from trademark a,caserelation1,trademark b" & _
            " where a.tm01='" & m_MySt(1) & "' and a.tm02='" & m_MySt(2) & "'" & _
            " and a.tm03='" & m_MySt(3) & "' and a.tm04='" & m_MySt(4) & "' and cr01(+)=a.tm01" & _
            " and cr02(+)=a.tm02 and cr03(+)=a.tm03 and cr04(+)=a.tm04 and b.tm01(+)=cr05" & _
            " and b.tm02(+)=cr06 and b.tm03(+)=cr07 and b.tm04(+)=cr08 and b.tm10='239'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData3 = "" & RsTemp(0)
         End If
         
      'Added by Morgan 2021/2/1
      Case "AMKOR要印", "AMKOR不印"
         strExc(0) = "select 1 from patent where pa01='" & m_MySt(1) & "' and pa02='" & m_MySt(2) & "'" & _
            " and pa03='" & m_MySt(3) & "' and pa04='" & m_MySt(4) & "'" & _
            " and (instr(pa26||pa27||pa28||pa29||pa30,'X7110200')>0" & _
            " or instr(pa26||pa27||pa28||pa29||pa30,'X8069100')>0" & _
            " or instr(pa26||pa27||pa28||pa29||pa30,'X80691C1')>0" & _
            " or instr(pa26||pa27||pa28||pa29||pa30,'X8178000')>0)"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData3 = "♀"
         End If
         
      'Added by Morgan 2021/3/17
      Case "英申開窗地址"
         strExc(1) = GetPrjPeopleNum1(m_MySt(1) & "-" & m_MySt(2) & "-" & m_MySt(3) & "-" & m_MySt(4))
         If strExc(1) <> "" Then
            strExc(0) = "SELECT CU05,CU88,CU89,CU90,CU24,CU25,CU26,CU27,CU28||CU102," & _
               "CU65,CU66,CU67,CU68,CU69,CU102 FROM CUSTOMER WHERE " & ChgCustomer(strExc(1))
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
            If intI = 1 Then
            With RsTemp
               For i = 0 To 3
                  If Not IsNull(.Fields(i)) Then ExceptFieldData3 = ExceptFieldData3 & .Fields(i) & vbCrLf
               Next
               If .Fields(9) <> "" Or .Fields(10) <> "" Or .Fields(11) <> "" Or .Fields(12) <> "" Or .Fields(13) <> "" Then
                  For i = 9 To 13
                     If Not IsNull(.Fields(i)) Then ExceptFieldData3 = ExceptFieldData3 & .Fields(i) & vbCrLf
                  Next
               Else
                  For i = 4 To 8
                     If Not IsNull(.Fields(i)) Then ExceptFieldData3 = ExceptFieldData3 & .Fields(i) & vbCrLf
                  Next
                  i = 14
                  If Not IsNull(.Fields(i)) Then ExceptFieldData3 = ExceptFieldData3 & .Fields(i) & vbCrLf
               End If
               If ExceptFieldData3 <> "" Then
                     ExceptFieldData3 = LeftB(ExceptFieldData3, LenB(ExceptFieldData3) - LenB(vbCrLf))
               End If
            End With
            End If
         End If
         
      'Added by Morgan 2021/10/1
      Case "專利權期限補償-本所期限", "專利權期限補償-法定期限", "專利權期限補償-約定期限"
         strExc(0) = "select np08,np09,np23 from nextprogress" & _
            " where np02='" & m_MySt(1) & "' and np03='" & m_MySt(2) & "'" & _
            " and np04='" & m_MySt(3) & "' and np05='" & m_MySt(4) & "' and np07='445' order by np09 desc"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            Select Case Right(strField, 4)
            Case "本所期限"
               ExceptFieldData3 = "" & RsTemp("np08")
            Case "法定期限"
               ExceptFieldData3 = "" & RsTemp("np09")
            Case "約定期限"
               ExceptFieldData3 = "" & RsTemp("np23")
            End Select
         End If
      
      'Modified by Morgan 2021/10/12 從ExceptFieldData移來
      'Add by Morgan 2007/10/4
      Case "主張優先權敘述"
         strTmp = Parser("{<優先權資料-優先權日>/英}")
         If strTmp <> "" Then
            ExceptFieldData3 = " Please claim priority date of " & strTmp & " with " & Parser("<優先權資料-優先權國家!NA04>") & " application No. " & Parser("<優先權資料-優先權號>") & "."
         Else
            ExceptFieldData3 = " No priority is to be claimed."
         End If
      'Add By Sindy 2017/8/1 優先權明細資料
      Case "優先權明細資料", "優先權明細資料/英", "優先權明細資料/日"
         strPA08 = ""
         strExc(0) = "SELECT PA08 FROM PATENT WHERE PA01='" & m_MySt(1) & "' AND " & _
            "PA02='" & m_MySt(2) & "' AND PA03='" & m_MySt(3) & "' AND PA04='" & m_MySt(4) & "' "
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If IsNull(RsTemp.Fields("PA08")) = False Then strPA08 = RsTemp.Fields("PA08")
         End If
         If Right(strField, 2) = "/英" Then
            strTmp = "1"
         ElseIf Right(strField, 2) = "/日" Then
            strTmp = "2"
         Else
            strTmp = "0"
         End If
         ExceptFieldData3 = PUB_GetApplPriDate(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), strPA08, strTmp)
'ex:FCP-055899
'　　1.. S. A.、December 04, 2015、14/959,921
'　　2.. S. A.、December 04, 2015、14/960,101
'　　3.. S. A.、December 04, 2015、14/960,115
'　　4.ＰＣＴ、December 04, 2015、PCT/US15/64073
'　　5.ＰＣＴ、December 04, 2015、PCT/US15/64110
'　　6.ＰＣＴ、December 04, 2015、PCT/US15/64045
'　　7.. S. A.、June 08, 2016、15/177,302
         If ExceptFieldData3 <> "" Then
            ExceptFieldData3 = "　　" & Replace(ExceptFieldData3, vbCrLf, vbCrLf & "　　")
         End If
      'end 2021/10/12
      
      'Added by Lydia 2022/03/03
      Case "申請書發明人資料"  'ex.FCP-066642發明申請書的發明人資料超過4000字
           ExceptFieldData3 = PUB_GetFormatInventor(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), False, "1")
      Case "基本表發明人資料"  'ex.FCP-066642發明申請書的發明人資料超過4000字
           ExceptFieldData3 = PUB_GetFormatInventor(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), False, "2")
      'end 2022/03/03
      
      'Added by Morgan 2022/4/7
      Case "一案兩請新型案要印", "發明案申請號", "發明案彼所案號", "發明案本所案號"
         If PUB_GetDualCaseInvInfo(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), strExc(1), strExc(2), strExc(3)) Then
            If strField = "一案兩請新型案要印" Then
               ExceptFieldData3 = "♀"
            ElseIf strField = "發明案申請號" Then
               ExceptFieldData3 = strExc(2)
            ElseIf strField = "發明案彼所案號" Then
               ExceptFieldData3 = strExc(3)
            ElseIf strField = "發明案本所案號" Then
               ExceptFieldData3 = strExc(1)
            End If
         End If
      'end 2022/4/7
      
      'Added by Morgan 2022/7/14
      Case "付款後辦案", "付款後辦案不印"
         strExc(0) = "SELECT PA26,PA75 FROM PATENT WHERE PA01='" & m_MySt(1) & "' AND " & _
            "PA02='" & m_MySt(2) & "' AND PA03='" & m_MySt(3) & "' AND PA04='" & m_MySt(4) & "' "
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If CU72FA39("" & RsTemp("PA26"), "" & RsTemp("PA75")) Then
               ExceptFieldData3 = "♀"
            End If
         End If
         
      'Added by Morgan 2022/12/5
      Case "紙本證書才印", "電子證書才印", "112以後領證不印", "電子證書不印", "證書形式"
         strExc(0) = "SELECT PA178 FROM PATENT WHERE PA01='" & m_MySt(1) & "' AND " & _
            "PA02='" & m_MySt(2) & "' AND PA03='" & m_MySt(3) & "' AND PA04='" & m_MySt(4) & "'"
         strExc(0) = strExc(0) & " UNION SELECT TM136 FROM TRADEMARK WHERE TM01='" & m_MySt(1) & "' AND " & _
            "TM02='" & m_MySt(2) & "' AND TM03='" & m_MySt(3) & "' AND TM04='" & m_MySt(4) & "'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If strField = "112以後領證不印" Then
               '有設定證書形式都是112以後領證的
               If Not IsNull(RsTemp(0)) Then
                  ExceptFieldData3 = "♀"
               End If
            ElseIf strField = "電子證書才印" Or strField = "電子證書不印" Then
               If RsTemp(0) = "1" Then
                  ExceptFieldData3 = "♀"
               End If
            ElseIf strField = "紙本證書才印" Then
               If RsTemp(0) = "2" Then
                  ExceptFieldData3 = "♀"
               End If
            ElseIf strField = "證書形式" Then
               If strSrvDate(1) >= "20230101" Then
                  If RsTemp(0) = "1" Then
                     ExceptFieldData3 = "電子"
                  ElseIf RsTemp(0) = "2" Then
                     ExceptFieldData3 = "紙本"
                  End If
               End If
            End If
         End If
      'Added by Morgan 2022/12/16
      Case "已指示證書形式不印", "已指示電子證書才印", "已指示電子證書不印", "已指示紙本證書才印", "已指示紙本證書不印"
         strExc(0) = PUB_GetCertType(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4))
         If strExc(0) <> "" Then
            If strField = "已指示證書形式不印" Then
               ExceptFieldData3 = "♀"
            ElseIf strExc(0) = "1" Then
               If strField = "已指示電子證書才印" Or strField = "已指示電子證書不印" Then
                  ExceptFieldData3 = "♀"
               End If
            ElseIf strExc(0) = "2" Then
               If strField = "已指示紙本證書才印" Or strField = "已指示紙本證書不印" Then
                  ExceptFieldData3 = "♀"
               End If
            End If
         End If
      'Added by Morgan 2022/12/16
      Case "領證自動代繳才印", "領證自動代繳不印", "領證自動代繳已指示電子證書才印", "領證自動代繳已指示紙本證書才印"
         strExc(0) = PUB_FCAutoCert(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4))
         If strExc(0) = "Y" Then
            If strField = "領證自動代繳才印" Or strField = "領證自動代繳不印" Then
               ExceptFieldData3 = "♀"
            Else
               strExc(0) = PUB_GetCertType(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4))
               If strExc(0) = "1" Then
                  If strField = "領證自動代繳已指示電子證書才印" Then
                     ExceptFieldData3 = "♀"
                  End If
               ElseIf strExc(0) = "2" Then
                  If strField = "領證自動代繳已指示紙本證書才印" Then
                     ExceptFieldData3 = "♀"
                  End If
               End If
            End If
         End If
         
      'Added by Morgan 2023/1/6
      Case "標章不印", "標章才印"
         strExc(0) = "select * from trademark,patenttrademarkmap where " & TmSt & _
            " and ptm01(+)='2' and PTM02(+)=TM08 and instr(ptm03||ptm04,'標章')>0"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData3 = "♀"
         End If
      'end 2023/1/6
      
      'Added by Lydia 2023/11/23
      Case "區別商標/標章"
         strExc(0) = "select * from trademark,patenttrademarkmap where " & TmSt & _
            " and ptm01(+)='2' and PTM02(+)=TM08 and instr(ptm03||ptm04,'標章')>0"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData3 = "標章"
         Else
            ExceptFieldData3 = "商標"
         End If
      'end 2023/11/23
      
      'Add by Sindy 2024/6/14
      Case "商標描述中文", "商標描述英文", "商標描述日文"
         strExc(0) = "select tm137,tm138,tm139 from trademark" & _
            " where tm01='" & m_MySt(1) & "' and tm02='" & m_MySt(2) & "' and tm03='" & m_MySt(3) & "' and tm04='" & m_MySt(4) & "'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If strField = "商標描述中文" Then
               ExceptFieldData3 = "" & RsTemp.Fields("tm137")
            ElseIf strField = "商標描述英文" Then
               ExceptFieldData3 = "" & RsTemp.Fields("tm138")
            Else
               ExceptFieldData3 = "" & RsTemp.Fields("tm139")
            End If
         End If
         
      'Added by Morgan 2023/2/15
      Case "指定商品簡單日文", "沒有指定商品簡單日文才印"
         strExc(0) = "select TG08,TG17 from trademark,tmgoods" & _
            " where tm01='" & m_MySt(1) & "' and tm02='" & m_MySt(2) & "' and tm03='" & m_MySt(3) & "' and tm04='" & m_MySt(4) & "'" & _
            " and instr(tm09,',')=0 and tg01(+)=tm01 and tg02(+)=tm02 and tg03(+)=tm03 and tg04(+)=tm04 and tg05(+)=tm09 and tg08||tg17 is not null"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If strField = "指定商品簡單日文" Then
               ExceptFieldData3 = RsTemp(0) & RsTemp(1)
            End If
         Else
            If strField = "沒有指定商品簡單日文才印" Then
               ExceptFieldData3 = "♀"
            End If
         End If
         
      'Added by Sindy 2023/7/27
      Case "商標公報有資料才印", "公報註冊號數", "公報申請日期", "公報商標名稱", "公報商標權人", _
           "公報代理人", "公報權利期間", "公報審查人員"
         
         strSql = "select tmbulletindata.*,tm01,tm02,tm03,tm04,tm08 from tmbulletindata,trademark " & _
                  "Where tm01='" & m_MySt(1) & "' and tm02='" & m_MySt(2) & "' and tm03='" & m_MySt(3) & "' and tm04='" & m_MySt(4) & "'" & _
                  " and tbd02=tm15 and tbd03=tm08 and tbd16='1' and tbd15='A'" & _
                  " and tm44 is null"
         Set rsTmp = New ADODB.Recordset
         rsTmp.CursorLocation = adUseClient
         rsTmp.Open strSql, cnnConnection, adOpenDynamic
         If rsTmp.RecordCount > 0 Then
            If strField = "商標公報有資料才印" Then
               ExceptFieldData3 = "♀"
               Exit Function
            End If
            If "" & rsTmp.Fields("tm08") = "7" Or "" & rsTmp.Fields("tm08") = "8" Then
               strTitle = "標章"
            Else
               strTitle = "商標"
            End If
            
            If strField = "公報註冊號數" Then
               ExceptFieldData3 = "註冊" & GetTradeMarkName("" & rsTmp.Fields("TBD03"), 0) & _
                                  "第" & "" & rsTmp.Fields("TBD02") & "號　" & _
                                  "申請案號：" & "" & rsTmp.Fields("TBD04") & "　" & _
                                  Left(rsTmp.Fields("TBD01"), 2) & "卷" & Format(Right(rsTmp.Fields("TBD01"), 2), "00") & "期　" & _
                                  ChangeWStringToTDateString(PUB_ChgTMBM07ToDate(rsTmp.Fields("TBD01"))) & "　商標圖樣：" & "" & rsTmp.Fields("TBD05")
               Exit Function
            ElseIf strField = "公報申請日期" Then
               strTemp = "|#(小字)" & rsTmp.Fields("TBD06") & "#|"
               If "" & rsTmp.Fields("TBD13") <> "" Then
                  strTemp = strTemp & vbCrLf & "|#(小字)優先權日：" & "" & rsTmp.Fields("TBD13") & "#|" & vbCrLf
               End If
               ExceptFieldData3 = strTemp
               Exit Function
            ElseIf strField = "公報商標名稱" Then
               ExceptFieldData3 = "" & rsTmp.Fields("TBD07")
               Exit Function
            ElseIf strField = "公報代理人" Then
               ExceptFieldData3 = "" & rsTmp.Fields("TBD08")
               Exit Function
            ElseIf strField = "公報權利期間" Then
               ExceptFieldData3 = "" & rsTmp.Fields("TBD09")
               Exit Function
            ElseIf strField = "公報審查人員" Then
               strTemp = "|#(小字)" & rsTmp.Fields("TBD10") & "#|"
               ExceptFieldData3 = strTemp
               Exit Function
            End If
            '商標權人資料
            If strField = "公報商標權人" Then
               Dim bolIsTit As Boolean
               strSql = "select tm08,tmbulletinowner.* from trademark,tmbulletinowner" & _
                        " Where tm01='" & m_MySt(1) & "' and tm02='" & m_MySt(2) & "' and tm03='" & m_MySt(3) & "' and tm04='" & m_MySt(4) & "'" & _
                        " and tbor01=tm15 and tbor06=tm08 order by tbor02 asc"
               intI = 1: strTemp = ""
               Set RsTemp = ClsLawReadRstMsg(intI, strSql)
               If intI = 1 Then
                  RsTemp.MoveFirst
                  For intI = 1 To RsTemp.RecordCount
                     bolIsTit = False '尚無標題
                     If strTemp <> "" Then strTemp = strTemp & vbCrLf
                     If "" & RsTemp.Fields("tbor03") <> "" Then
                        If bolIsTit = False Then
                           strTemp = strTemp & "|#(小字)" & strTitle & "權人：" & RsTemp.Fields("tbor03") & "#|" '& vbCrLf
                           bolIsTit = True '有標題了
                        Else
                           strTemp = strTemp & "|#(小字)" & "　　　　　" & RsTemp.Fields("tbor03") & "#|" '& vbCrLf
                        End If
                     End If
                     If "" & RsTemp.Fields("tbor04") <> "" Then
                        If strTemp <> "" Then strTemp = strTemp & vbCrLf
                        If bolIsTit = False Then
                           strTemp = strTemp & "|#(小字)" & strTitle & "權人：" & RsTemp.Fields("tbor04") & "#|" '& vbCrLf
                           bolIsTit = True '有標題了
                        Else
                           strTemp = strTemp & "|#(小字)" & "　　　　　" & RsTemp.Fields("tbor04") & "#|" '& vbCrLf
                        End If
                     End If
                     If "" & RsTemp.Fields("tbor05") <> "" Then
                        If strTemp <> "" Then strTemp = strTemp & vbCrLf
                        If bolIsTit = False Then
                           strTemp = strTemp & "|#(小字)" & strTitle & "權人：" & RsTemp.Fields("tbor05") & "#|" '& vbCrLf
                           bolIsTit = True '有標題了
                        Else
                           strTemp = strTemp & "|#(小字)" & "　　　　　" & RsTemp.Fields("tbor05") & "#|" '& vbCrLf
                        End If
                     End If
                     RsTemp.MoveNext
                  Next intI
               End If
               ExceptFieldData3 = strTemp
               Exit Function
            End If
         End If
         
      'Added by Lydia 2022/09/15 用在FCT,T案之電子送件申請書(frm03020605_1): 101申請,102延展
      Case "指定使用商品服務類別及名稱", "商品服務類別及名稱-部分延展"
         'ex.FCT-49623有38類描述長度有5857字
         strExc(9) = ""
         strExc(0) = "select tm01, tm09 from trademark where tm01='" & m_MySt(1) & "' and tm02='" & m_MySt(2) & "' and tm03='" & m_MySt(3) & "' and tm04='" & m_MySt(4) & "' "
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
             strExc(9) = "" & RsTemp.Fields("tm09")
             strExc(1) = "": strExc(2) = ""
             strExc(0) = BeforePrintGetDBData("TMGoods:" & m_MySt(1) & "-" & m_MySt(2) & "-" & m_MySt(3) & "-" & m_MySt(4) & "-||區隔", True)
             If Trim(strExc(0)) <> "" Then
                  tmpArr1 = Empty
                  tmpArr1 = Split(strExc(0), "||")
                  jj = 1
                  For intA = 0 To UBound(tmpArr1)
                      strExc(1) = Trim(tmpArr1(intA))
                      If strExc(1) <> "" Then
                           'Modified by Lydia 2019/07/31 阿蓮:FCT不要組群代碼 ; 嘉雯: 內商的商品服務類別內容是用智慧局插件產生,代空白也可以,而外商多半無法用智慧局所以才用人工撰寫
                           strExc(2) = strExc(2) & _
                                     "【指定使用商品服務類別及名稱" & jj & "】  " & vbCrLf & _
                                     "　　【類別】　　　　　　　　　" & Mid(strExc(1), 1, InStr(strExc(1), "：") - 1) & vbCrLf & _
                                     "　　【商品服務名稱】　　　　　" & Mid(strExc(1), InStr(strExc(1), "：") + 1) & vbCrLf
                           jj = jj + 1
                      End If
                  Next intA
             'Added by Lydia 2019/07/31 阿蓮: 因為在產生申請書時才撰寫商品服務,所以依收文的類別產生
             'Memo by Lydia 2019/07/31 嘉雯: 內商的商品服務類別內容是用智慧局插件產生,代空白也可以,而外商多半無法用智慧局所以才用人工撰寫
             ElseIf strExc(9) <> "" Then
                  tmpArr1 = Empty
                  tmpArr1 = Split(strExc(9), ",")
                  jj = 1
                  For intA = 0 To UBound(tmpArr1)
                      strExc(1) = Trim(tmpArr1(intA))
                      If strExc(1) <> "" Then
                           strExc(2) = strExc(2) & _
                                     "【指定使用商品服務類別及名稱" & jj & "】  " & vbCrLf & _
                                     "　　【類別】　　　　　　　　　" & strExc(1) & vbCrLf & _
                                     "　　【商品服務名稱】　　　　　" & vbCrLf
                           jj = jj + 1
                      End If
                  Next intA
             'end 2019/07/31
             Else
                  'Modified by Lydia 2019/07/31 阿蓮:FCT不要組群代碼
                  strExc(2) = "【指定使用商品服務類別及名稱1】  " & vbCrLf & _
                            "　　【類別】　　　　　　　　　" & vbCrLf & _
                            "　　【商品服務名稱】　　　　　" & vbCrLf
             End If
             
         End If
         
         If InStr(strField, "部分延展") > 0 Then
             ExceptFieldData3 = Replace(strExc(2), "指定使用商品服務類別及名稱", "部分延展")
         Else
             ExceptFieldData3 = strExc(2)
         End If
      'end 2022/09/15
      'Added by Lydia 2023/05/18
      Case "CFP指示信優先權主張-EPC不提供前案"
         strExc(0) = "SELECT pd05,na04,ptm05,pd06 FROM PRIDATE, NATION, PATENT, PATENTTRADEMARKMAP WHERE PD01='" & m_MySt(1) & "'" & _
            " AND PD02='" & m_MySt(2) & "' AND PD03='" & m_MySt(3) & "' AND PD04='" & m_MySt(4) & "'" & _
            " AND NA01(+)=PD07 AND PA11(+)=PD06 AND PTM01(+)='1' AND PTM02=NVL(PA08,PD08) AND INSTR('" & cntEPC新案發文不須提供前案 & "' ,PD07) > 0 "
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            With RsTemp
            strExc(1) = "Please claim priority of " & .Fields("na04") & " " & .Fields("ptm05") & " application No." & .Fields("pd06") & " of " & ChgEngDate(.Fields("pd05"))
            .MoveNext
            Do While Not .EOF
               If .RecordCount > 2 Then
                  strExc(1) = strExc(1) & "; "
               End If
               If .AbsolutePosition = .RecordCount Then
                  strExc(1) = strExc(1) & "and "
               End If
               strExc(1) = strExc(1) & .Fields("na04") & " " & .Fields("ptm05") & " application No." & .Fields("pd06") & " of " & ChgEngDate(.Fields("pd05"))
               .MoveNext
            Loop
            strExc(1) = strExc(1) & "."
            End With
            ExceptFieldData3 = strExc(1)
         End If
         'end 2023/05/18
         
      'Added by Morgan 2023/8/24
      Case "辦理依據-發文日期", "辦理依據-智專字", "辦理依據-發文號"
         strExc(0) = "SELECT ed01,ed08,ed17 FROM CASEPROGRESS,edocument WHERE CP09='" & m_Rule & "' and ed11(+)=cp43 and ed01 is not null"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If strField = "辦理依據-發文日期" Then
               ExceptFieldData3 = ChangeWStringToTDateString(RsTemp("ed08"))
            ElseIf strField = "辦理依據-智專字" Then
               ExceptFieldData3 = Mid(RsTemp("ed17"), InStr(RsTemp("ed17"), "智專") + 2)
            ElseIf strField = "辦理依據-發文號" Then
               ExceptFieldData3 = "" & RsTemp("ed01")
            End If
         End If
      Case "一案兩請-新型申請案號"
         strExc(0) = "SELECT cm05,cm06,cm07,cm08 FROM casemap WHERE cm01='" & m_MySt(1) & "' and cm02='" & m_MySt(2) & "' and cm03='" & m_MySt(3) & "' and cm04='" & m_MySt(4) & "' and cm10='3'" & _
            " union SELECT cm01,cm02,cm03,cm04 FROM casemap WHERE cm05='" & m_MySt(1) & "' and cm06='" & m_MySt(2) & "' and cm07='" & m_MySt(3) & "' and cm08='" & m_MySt(4) & "' and cm10='3'"
         strExc(0) = "select pa11 from (" & strExc(0) & ") x,patent where pa01(+)=cm05 and pa02(+)=cm06 and pa03(+)=cm07 and pa04(+)=cm08 and pa08='2'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData3 = "" & RsTemp("pa11")
         End If
      'end 2023/8/24
      
      'Added by Morgan 2023/9/14
      Case "官方發文日"
         strExc(0) = "SELECT ed08 FROM edocument WHERE ed11='" & m_Rule & "'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData3 = "" & RsTemp("ed08")
         End If
      'end 2023/9/14
      'Added by Morgan 2024/3/28
      Case "無圖要印", "有圖要印"
         strExc(0) = "select nvl(pa173,1) from patent where " & PaSt & " and pa08 in ('1','2')"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If RsTemp(0) > 0 Then
               If strField = "有圖要印" Then
                  ExceptFieldData3 = "♀"
               End If
            Else
               If strField = "無圖要印" Then
                  ExceptFieldData3 = "♀"
               End If
            End If
         End If
      Case "有收文藥品專利連結告代要印"
         If PUB_ChkCPExist(m_MySt, "959") = True Then
            ExceptFieldData3 = "♀"
         End If
      Case "領證及繳年費發文日"
         If PUB_ChkCPExist(m_MySt, "601", , , , , strExc(0)) = True Then
            ExceptFieldData3 = strExc(0)
         End If
      Case "領證及繳年費繳費年度/英"
         'Modified by Morgan 2024/4/1 改抓基本檔(舊資料CP沒有年度)
         'strExc(0) = "select cp53,cp54 from patent,caseprogress where " & PaSt & " and cp01(+)=pa01 and cp02(+)=pa02 and cp03(+)=pa03 and cp04(+)=pa04 and cp10='601' and cp27>0"
         strExc(0) = "select cp27,pa72,pa73 from patent,caseprogress where " & PaSt & " and cp01(+)=pa01 and cp02(+)=pa02 and cp03(+)=pa03 and cp04(+)=pa04 and cp10='601' and cp27>0"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            strTemp1 = Split(RsTemp("pa72"), ",")
            strTemp2 = Split(RsTemp("pa73"), ",")
            StrYear1 = "": StrYear2 = ""
            For ii = 0 To UBound(strTemp1)
               If Val(strTemp2(ii)) = RsTemp("cp27") Then
                  If StrYear1 = "" Then StrYear1 = strTemp1(ii)
                  StrYear2 = strTemp1(ii)
               End If
            Next
            ExceptFieldData3 = PUB_GetEngPayYear(StrYear1, StrYear2)
         End If
      Case "申請人英文(多)"
         strExc(0) = "select pa26,pa27,pa28,pa29,pa30 from patent where " & PaSt
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData3 = GetCustomerName(RsTemp("pa26"), "1")
            If Not IsNull(RsTemp("pa27")) Then
               ExceptFieldData3 = ExceptFieldData3 & " and " & GetCustomerName(RsTemp("pa27"), "1")
            End If
            If Not IsNull(RsTemp("pa28")) Then
               ExceptFieldData3 = ExceptFieldData3 & " and " & GetCustomerName(RsTemp("pa28"), "1")
            End If
            If Not IsNull(RsTemp("pa29")) Then
               ExceptFieldData3 = ExceptFieldData3 & " and " & GetCustomerName(RsTemp("pa29"), "1")
            End If
            If Not IsNull(RsTemp("pa30")) Then
               ExceptFieldData3 = ExceptFieldData3 & " and " & GetCustomerName(RsTemp("pa30"), "1")
            End If
         End If
      Case "組別主管專業代號/國外", "組別主管英文名"
         strExc(0) = "select pa150,st12,st17 from patent,setspecman,staff where " & PaSt & " and OCODE(+)=decode(pa150,'1','T','2','R','3','S','4','T1')  and st01(+)=oman"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If strField = "組別主管英文名" Then
               ExceptFieldData3 = RsTemp("st12")
            Else
               ExceptFieldData3 = RsTemp("st17")
            End If
         End If
      'end 2024/3/28
      'Added by Morgan 2024/9/20
      Case "申請國智財局/英"
         strExc(0) = "select pa09,initcap(na04) na04 from patent,nation where " & PaSt & " and na01(+)=pa09"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If RsTemp("pa09") = "020" Then
               ExceptFieldData3 = "China National Intellectual Property Administration (CNIPA)"
            Else
               ExceptFieldData3 = RsTemp("na04") & " Intellectual Property Department"
            End If
         End If
         
      'Added by Morgan 2024/10/8
      Case "補繳期限過專用期不印", "補繳期限過專用期要印"
         strExc(0) = "select * from caseprogress,patent where cp09='" & m_Rule & "' and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04 and cp07>pa25"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData3 = "♀"
         End If
      'add by sonia 2024/12/26 台灣著作權TC申請日在2025/1/1以後者加年效力費提醒
      Case "2025效力費提醒"
          strExc(0) = "select * from servicepractice where " & SpSt & " and sp01='TC' and sp09='000' and sp10>=20250101"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData3 = "♀"
         End If
     'end 2024/12/26
     
         
      'Added by Morgan 2025/2/7
      Case "大陸國籍要印1", "大陸國籍要印2", "大陸國籍要印3", "大陸國籍要印4", "大陸國籍要印5"
         strExc(1) = "PA" & (25 + Val(Right(strField, 1)))
         Select Case m_SysKind
            Case 1 '專利
               strExc(0) = "SELECT CU10 FROM PATENT,CUSTOMER WHERE SUBSTR(" & strExc(1) & ",1,8)=CU01(+) AND SUBSTR(" & strExc(1) & ",9,1)=CU02(+) AND " & PaSt
         End Select
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If RsTemp.Fields(0) = "020" Then
               ExceptFieldData3 = "♀"
            End If
         End If
         
      'Added by Morgan 2025/3/5
      Case "前案彼所案號"
         strExc(0) = "SELECT CP45,CP27 FROM CASEPROGRESS A WHERE CP01='" & m_MySt(1) & "'" & _
            " AND CP02='" & m_MySt(2) & "' AND CP03='0' AND CP04='00'" & _
            " AND CP44=(SELECT CP44 FROM CASEPROGRESS B WHERE CP09='" & m_Rule & "') ORDER BY CP27 DESC"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            ExceptFieldData3 = "" & RsTemp.Fields("CP45")
         End If
      'end 2025/3/5
      
      'Added by Morgan 2025/5/8
      Case "開智權帳單提醒-年費"
         strExc(0) = "select pa161 from patent where " & PaSt
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If "" & RsTemp(0) = "J" Then
               ExceptFieldData3 = "Please note that the referenced application is entrusted to you in the name of |#(粗體,底線)Tai E Intellectual Property Co., Ltd.#| Please have |#(底線)all of your invoices for this case issued to the title of Tai E Intellectual Property Co., Ltd#|, thank you." & vbCrLf
            Else
               ExceptFieldData3 = "Please note that the referenced application is entrusted to you in the name of |#(粗體,底線)Tai E International Patent & Law Office.#| Please have |#(底線)all of your invoices for this case issued to the title of Tai E International Patent & Law Office#|, thank you." & vbCrLf
            End If
         End If
   End Select
   
   Set rsA = Nothing
End Function

'Modify By Sindy 2023/7/28
'將公報卷期轉換為日期
Public Function PUB_ChgTMBM07ToDate(strData As String)
Dim strYY As String
Dim strMM As String
Dim strDD As String
'920101 : 3001, 920116 : 3002 ...(每年會有24期)

strYY = (Val(Mid(strData, 1, Len(strData) - 2)) + 62)
strMM = Format(Right(strData, 2) / 2, "00")
If Right(strData, 2) Mod 2 <> 0 Then
    strDD = "01"
Else
    strDD = "16"
End If
PUB_ChgTMBM07ToDate = DBDATE(strYY & strMM & strDD)
End Function

'Modified by Morgan 2022/7/15 從basPublic移來
'收款後辦案
'Modified by Morgan 2020/6/11 改XY都要判斷--David
Public Function CU72FA39(ByVal pa26 As String, ByVal pa75 As String) As Boolean
   Dim rsTemp1 As ADODB.Recordset, stSQL As String, intQ As Integer
   CU72FA39 = False
   
   'If pa75 = "" Then
   '   stSQL = "SELECT CU72 FROM CUSTOMER WHERE " & ChgCustomer(pa26)
   'Else
   '   stSQL = "SELECT FA39 FROM FAGENT WHERE " & ChgFagent(pa75)
   'End If
   If pa26 <> "" Then
      stSQL = "SELECT CU72 FROM CUSTOMER WHERE " & ChgCustomer(pa26) & " and CU72='Y'"
   End If
   If pa75 <> "" Then
      If stSQL <> "" Then stSQL = stSQL & " union "
      stSQL = "SELECT FA39 FROM FAGENT WHERE " & ChgFagent(pa75) & " and FA39='Y'"
   End If
   'end 2020/6/11
   
   intQ = 1
   Set rsTemp1 = ClsLawReadRstMsg(intQ, stSQL) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
   If intQ = 1 Then
      If rsTemp1.Fields(0) = "Y" Then CU72FA39 = True
   End If
   Set rsTemp1 = Nothing
End Function


'Added by Morgan 2019/4/12
'日本發明案是否可減免
Public Function PUB_ChkJpDiscount(pPA01 As String, pPA02 As String, pPA03 As String, pPA04 As String, Optional pChk416 As Boolean = False) As Boolean
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   
   stSQL = "SELECT PA11 FROM PATENT WHERE pa01='" & pPA01 & "' and pa02='" & pPA02 & "' and pa03='" & pPA03 & "' and pa04='" & pPA04 & "'" & _
      " AND PA08='1' AND PA09='011' AND nvl(lastyear(pa72),0)<10"
   If pChk416 Then
      stSQL = stSQL & " AND EXISTS(SELECT* FROM CASEPROGRESS WHERE CP01=PA01 AND CP02=PA02 AND CP03=PA03 AND CP04=PA04 AND CP10='416' AND NVL(CP47,CP27)>20190401)"
   End If
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      PUB_ChkJpDiscount = True
   End If
   Set rsQuery = Nothing
End Function

'Added by Morgan 2019/4/12
'日本發明案減免資格
Public Function PUB_GetJpDiscountDesc(pAD10 As String, pAD15 As String, Optional pLanguage As String = "1") As String
   Dim stDesc As String
   Select Case pAD10
   Case "1"
      If pLanguage = "2" Then
         stDesc = "    Small/Medium-sized Enterprises (SMEs) (Companies)(50% reduction)"
         stDesc = stDesc & vbCrLf & "    Type of industry:" & vbCrLf
      Else
         stDesc = "中小企業"
      End If
      
      Select Case pAD15
      Case "1"
         If pLanguage = "2" Then
            stDesc = stDesc & "    Manufacturing, construction, transportation, etc. (Employees 300 or fewer)"
         Else
            stDesc = stDesc & "-製造業、建築業、運輸業（員工300人以下）"
         End If
         
      Case "2"
         If pLanguage = "2" Then
            stDesc = stDesc & "    Manufacturing, construction, transportation, etc. (Total capital or investment 300 million JPY or less)"
         Else
            stDesc = stDesc & "-製造業、建築業、運輸業（總資本額3億日圓以下）"
         End If
      Case "3"
         If pLanguage = "2" Then
            stDesc = stDesc & "    Wholesale business (Employees 100 or fewer)"
         Else
            stDesc = stDesc & "-批發業（員工100人以下）"
         End If
      Case "4"
         If pLanguage = "2" Then
            stDesc = stDesc & "    Wholesale business (Total capital or investment 100 million JPY or less)"
         Else
            stDesc = stDesc & "-服務業（員工100人以下）"
         End If
      Case "5"
         If pLanguage = "2" Then
            stDesc = stDesc & "    Service business (Employees 100 or fewer)"
         Else
            stDesc = stDesc & "-服務業（總資本額5,000萬日圓以下）"
         End If
      Case "6"
         If pLanguage = "2" Then
            stDesc = stDesc & "    Service business (Total capital or investment 50 million JPY or less)"
         Else
            stDesc = stDesc & "-製造業、建築業、運輸業（員工300人以下）"
         End If
      Case "7"
         If pLanguage = "2" Then
            stDesc = stDesc & "    Retail business (Employees 50 or fewer)"
         Else
            stDesc = stDesc & "-零售業（員工50人以下）"
         End If
      Case "8"
         If pLanguage = "2" Then
            stDesc = stDesc & "    Retail business (Total capital or investment 50 million JPY or less)"
         Else
            stDesc = stDesc & "-零售業（總資本額5,000萬日圓以下）"
         End If
      Case "9"
         If pLanguage = "2" Then
            stDesc = stDesc & "    Rubber manufacturing (other than manufacturing of car and plane tires and inner tubes, and industrial belts) (Employees 900 or fewer)"
         Else
            stDesc = stDesc & "-橡膠製造業（汽車和飛機輪胎、內胎和工業用皮帶的製造業除外）（員工900人以下）"
         End If
      Case "10"
         If pLanguage = "2" Then
            stDesc = stDesc & "    Rubber manufacturing (other than manufacturing of car and plane tires and inner tubes, and industrial belts) (Total capital or investment 300 million JPY or less)"
         Else
            stDesc = stDesc & "-橡膠製造業（汽車和飛機輪胎、內胎和工業用皮帶的製造業除外）（總資本額3億日圓以下）"
         End If
      Case "11"
         If pLanguage = "2" Then
            stDesc = stDesc & "    Software or information processing business (Employees 300 or fewer)"
         Else
            stDesc = stDesc & "-軟體或資料處理業（員工300人以下）"
         End If
      Case "12"
         If pLanguage = "2" Then
            stDesc = stDesc & "    Software or information processing business (Total capital or investment 300 million JPY or less)"
         Else
            stDesc = stDesc & "-軟體或資料處理業（總資本額3億日圓以下）"
         End If
      Case "13"
         If pLanguage = "2" Then
            stDesc = stDesc & "    Hotel business (Employees 200 or fewer)"
         Else
            stDesc = stDesc & "-旅館業（員工200人以下）"
         End If
      Case "14"
         If pLanguage = "2" Then
            stDesc = stDesc & "    Hotel business (Total capital or investment 50 million JPY or less)"
         Else
            stDesc = stDesc & "-旅館業（總資本額5,000萬日圓以下）"
         End If
      End Select
   Case "2"
      If pLanguage = "2" Then
         stDesc = "    SMEs (Sole proprietors) (50% reduction)"
         stDesc = stDesc & vbCrLf & "    Type of industry:" & vbCrLf
      Else
         stDesc = "獨資企業"
      End If
      Select Case pAD15
      Case "1"
         If pLanguage = "2" Then
            stDesc = stDesc & "    Manufacturing, construction, transportation, etc. (Employees 300 or fewer)"
         Else
            stDesc = stDesc & "-製造業、建築業、運輸業（員工300人以下）"
         End If
      Case "2"
         If pLanguage = "2" Then
            stDesc = stDesc & "    Wholesale business (Employees 100 or fewer)"
         Else
            stDesc = stDesc & "-批發業（員工100人以下）"
         End If
      Case "3"
         If pLanguage = "2" Then
            stDesc = stDesc & "    Service business (Employees 100 or fewer)"
         Else
            stDesc = stDesc & "-服務業（員工100人以下）"
         End If
      Case "4"
         If pLanguage = "2" Then
            stDesc = stDesc & "    Retail business (Employees 50 or fewer)"
         Else
            stDesc = stDesc & "-零售業（員工50人以下）"
         End If
      Case "5"
         If pLanguage = "2" Then
            stDesc = stDesc & "    Rubber manufacturing (other than manufacturing of car and plane tires and inner tubes, and industrial belts) (Employees 900 or fewer)"
         Else
            stDesc = stDesc & "-橡膠製造業（汽車和飛機輪胎、內胎和工業用皮帶的製造業除外）（員工900人以下）"
         End If
      Case "6"
         If pLanguage = "2" Then
            stDesc = stDesc & "    Software or information processing business (Employees 300 or fewer)"
         Else
            stDesc = stDesc & "-軟體或資料處理業（員工300人以下)"
         End If
      Case "7"
         If pLanguage = "2" Then
            stDesc = stDesc & "    Hotel business (Employees 200 or fewer)"
         Else
            stDesc = stDesc & "-旅館業（員工200人以下)"
         End If
      End Select
   Case "3"
      If pLanguage = "2" Then
         stDesc = "    Small-scale enterprises (66% reduction)" & vbCrLf
      Else
         stDesc = "小企業"
      End If
      Select Case pAD15
      Case "1"
         If pLanguage = "2" Then
            stDesc = stDesc & "    Legal entities" & vbCrLf
            'Added by Morgan 2019/6/19 --禧佩
            stDesc = stDesc & "    20 employees or fewer (5 employees or fewer for trading or service companies)"
         Else
            stDesc = stDesc & "-一般企業：員工20人以下（貿易或服務業公司員工5人以下）"
         End If
      Case "2"
         If pLanguage = "2" Then
            stDesc = stDesc & "    Sole proprietors"
         Else
            stDesc = stDesc & "-獨資企業：員工20人以下（貿易或服務業公司員工5人以下）"
         End If
      End Select
   Case "4"
      If pLanguage = "2" Then
         stDesc = "    Venture SMEs (66% reduction)" & vbCrLf
      Else
         stDesc = "新興企業"
      End If
      Select Case pAD15
      Case "1"
         If pLanguage = "2" Then
            stDesc = stDesc & "    Legal entities" & vbCrLf
            stDesc = stDesc & "    An entity that was established less than 10 years ago and has a total investment amount of 300 million JPY or less."
         Else
            stDesc = stDesc & "-中小型企業：公司成立未滿10年且總資本額3億日圓以下"
         End If
      Case "2"
         If pLanguage = "2" Then
            stDesc = stDesc & "    Sole proprietors"
         Else
            stDesc = stDesc & "-獨資企業：公司成立未滿10年"
         End If
      End Select
   Case "5"
      If pLanguage = "2" Then
         stDesc = "    University (50% reduction)" & vbCrLf
      Else
         stDesc = "大學"
      End If
      Select Case pAD15
      Case "1"
         If pLanguage = "2" Then
            stDesc = stDesc & "    A university or individual primarily conducting research at a university)"
         Else
            stDesc = stDesc & "-大學及任職於大學並從事研究之個人"
         End If
      End Select
   Case "6"
      If pLanguage = "2" Then
         stDesc = "    Individual" & vbCrLf
      Else
         stDesc = "個人"
      End If
      Select Case pAD15
      Case "1"
         If pLanguage = "2" Then
            stDesc = stDesc & "    For persons earning incomes less than JPY 1,500,000 a year (examination and  1-3rd annuity full reduction, 4-10th annuity 50% reduction)"
         Else
            stDesc = stDesc & "-年所得合計未滿日幣150萬"
         End If
      Case "2"
         If pLanguage = "2" Then
            stDesc = stDesc & "    For persons earning incomes less than JPY 2,500,000 a year (50% reduction)"
         Else
            stDesc = stDesc & "-年所得合計未滿日幣250萬"
         End If
      Case "3"
         If pLanguage = "2" Then
            stDesc = stDesc & "    For persons total sum of real estate income and business income calculated less than JPY 2,900,000 a year (50% reduction)"
         Else
            stDesc = stDesc & "-獨資企業房屋土地交易所得額及營利事業所得額合計未滿日幣290萬"
         End If
      End Select
   End Select
   
   PUB_GetJpDiscountDesc = stDesc
End Function

' 檢查欄位名稱是否為一般Table中的欄位
Private Function IsTaieDBField(ByVal textField As String) As Boolean
   Dim rsTmp As New ADODB.Recordset
   Dim strExc(0) As String
   ' 檢查欄位名稱對照檔
   strExc(0) = "SELECT * FROM FIELDNAMEMAP WHERE FNM02='" & textField & "'"
   intI = 1
   Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
   If intI = 1 Then
      IsTaieDBField = True
   Else
      IsTaieDBField = False
   End If
End Function

'Modify by Morgan 2003/12/29 加 strTmp1 ,strTmp2 兩個選擇性參數
' 取得欄位的內容
'Modify By Sindy 2015/4/14 Private ==> Public
'Private Function DoChange(ByVal ChSt As String, Optional ByVal strOther As String = "", Optional ByVal strTmp1 As String = "", Optional ByVal strTmp3 As String = "") As String
Public Function DoChange(ByVal ChSt As String, Optional ByVal strOther As String = "", Optional ByVal strTmp1 As String = "", Optional ByVal strTmp3 As String = "") As String
'2015/4/14 END
Dim Tmp(1 To 5) As String, St1 As Integer
Dim DoLoop As Boolean, St As String
Dim i As Integer, j As Integer, Pos As Integer
Dim RcT As New ADODB.Recordset
'Add By Cheng 2003/02/13
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset
'Add By Sindy 2014/11/21
Dim strCol As String
Dim varPI06 As Variant
Dim ii As Integer, jj As Integer
'2014/11/21 END
Dim strAppl As String 'Add By Sindy 2015/1/29
'Add By Sindy 2016/10/18
Dim intIN05 As Integer, bolHadIN05 As Boolean
Dim varTemp As Variant
Dim strText As String
'2016/10/18 END
Dim strCP43 As String 'Add By Sindy 2025/7/7
   
   DoLoop = False
   'Modify by Morgan 2003/12/29
   If strTmp1 <> "" Then
      Tmp(1) = strTmp1
      Tmp(3) = strTmp3
   Else
      ' 由欄位對照檔取得欄位的英文名稱及 Table 名(在DataBase 中Table內的欄位名稱)
      strExc(0) = "SELECT FNM01,FNM03 FROM FIELDNAMEMAP WHERE FNM02='" & ChSt & "'"
      intI = 1
      Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
      If intI = 1 Then
         Tmp(1) = RsTemp.Fields(0).Value
         Tmp(3) = RsTemp.Fields(1).Value
      End If
   End If
   
A0:   Select Case Tmp(3)
         ' 案件(國家)收費表
         Case "CASEFEE"
            strExc(0) = "SELECT " & Tmp(1) & " FROM CASEFEE WHERE CF01='" & _
               m_MySt(1) & "' AND CF02='" & m_MySt(6) & "' AND CF03='" & _
               m_MySt(5) & "'"
         ' 案件進度檔
         Case "CASEPROGRESS"
            'Add by Morgan 2007/1/25 如果傳進來的是本所案號時不用抓
            If m_RefKind = 1 Then
               DoChange = ""
               Exit Function
            End If
            'end 2007/1/25
            Select Case Tmp(1)
               Case "CP24"
                  strExc(0) = "SELECT DECODE(CP24,'1','成立','不成立') FROM CASEPROGRESS WHERE CP09='" & m_Rule & "'"
               'Modify by Morgan 2006/10/23
               'Case "CP55", "CP56", "CP72" 加移轉申請人2~5 & 移轉人2~5
               Case "CP55", "CP56", "CP72", "CP89", "CP90", "CP91", "CP92", "CP93", "CP94", "CP95", "CP96"
                    Select Case Left(strOther, 2)
                    Case "NA"
                        Select Case strOther
                        Case "NA04"
                            strExc(1) = "NA04"
                        End Select
                        strExc(0) = "SELECT " & strExc(1) & " FROM CASEPROGRESS, CUSTOMER, Nation WHERE " & _
                           "CP09='" & m_Rule & "' AND SUBSTR(" & Tmp(1) & ",1,8)=CU01(+) AND " & _
                           "SUBSTR(" & Tmp(1) & ",9,1)=CU02(+) And CU10=NA01(+) "
                    Case Else
                          Select Case strOther
                             Case "中", "CU04"
                                strExc(1) = "CU04"
                             Case "英", "CU05"
                                'strExc(1) = "CU05||DECODE(CU88,NULL,'',' '||CU88)||DECODE(CU89,NULL,'',' '||CU89)||DECODE(CU90,NULL,'',' '||CU90)"
                                strExc(1) = "CU05"
                                '2009/12/2 ADD BY SONIA FCT移轉501發文及核准定稿,為版面美觀故移轉人及受讓人都統一大寫
                                If m_MySt(1) = "FCT" And m_MySt(5) = "501" Then
                                   If m_FinalSty = "01" And m_Situ = "00" Then
                                      strExc(1) = "UPPER(CU05)"
                                   ElseIf m_FinalSty = "03" And m_Situ >= "11" And m_Situ <= "14" Then
                                      strExc(1) = "UPPER(CU05)"
                                   End If
                                End If
                                '2009/12/2 END
                             'Add By Cheng 2003/01/15
                             '英文名稱串連
                             Case "CU05CU88CU89CU90"
                                strExc(1) = "CU05||DECODE(CU88,NULL,'',' '||CU88)||DECODE(CU89,NULL,'',' '||CU89)||DECODE(CU90,NULL,'',' '||CU90)"
                                '2009/12/2 ADD BY SONIA FCT移轉501發文及核准定稿,為版面美觀故移轉人及受讓人都統一大寫
                                If m_MySt(1) = "FCT" And m_MySt(5) = "501" Then
                                   If m_FinalSty = "01" And m_Situ = "00" Then
                                      strExc(1) = "UPPER(CU05||DECODE(CU88,NULL,'',' '||CU88)||DECODE(CU89,NULL,'',' '||CU89)||DECODE(CU90,NULL,'',' '||CU90))"
                                   ElseIf m_FinalSty = "03" And m_Situ >= "11" And m_Situ <= "14" Then
                                      strExc(1) = "UPPER(CU05||DECODE(CU88,NULL,'',' '||CU88)||DECODE(CU89,NULL,'',' '||CU89)||DECODE(CU90,NULL,'',' '||CU90))"
                                   End If
                                End If
                                '2009/12/2 END
                             '2009/12/2 ADD BY SONIA FCT移轉501發文及核准定稿,為版面美觀故移轉人及受讓人都統一大寫
                             Case "英", "CU88"
                                strExc(1) = "CU88"
                                If m_MySt(1) = "FCT" And m_MySt(5) = "501" Then
                                   If m_FinalSty = "01" And m_Situ = "00" Then
                                      strExc(1) = "UPPER(CU88)"
                                   ElseIf m_FinalSty = "03" And m_Situ >= "11" And m_Situ <= "14" Then
                                      strExc(1) = "UPPER(CU88)"
                                   End If
                                End If
                             Case "英", "CU89"
                                strExc(1) = "CU89"
                                If m_MySt(1) = "FCT" And m_MySt(5) = "501" Then
                                   If m_FinalSty = "01" And m_Situ = "00" Then
                                      strExc(1) = "UPPER(CU89)"
                                   ElseIf m_FinalSty = "03" And m_Situ >= "11" And m_Situ <= "14" Then
                                      strExc(1) = "UPPER(CU89)"
                                   End If
                                End If
                             Case "英", "CU90"
                                strExc(1) = "CU90"
                                If m_MySt(1) = "FCT" And m_MySt(5) = "501" Then
                                   If m_FinalSty = "01" And m_Situ = "00" Then
                                      strExc(1) = "UPPER(CU90)"
                                   ElseIf m_FinalSty = "03" And m_Situ >= "11" And m_Situ <= "14" Then
                                      strExc(1) = "UPPER(CU90)"
                                   End If
                                End If
                             '2009/12/2 END
                             Case "日", "CU06"
                                strExc(1) = "CU06"
                             Case "CU15"
                                'Modify By Sindy 2012/5/24
                                'strExc(1) = "DECODE(CU15,'0','台端','貴公司')"
                                strExc(1) = "DECODE(CU15,'0','台端','1','貴公司','貴單位')"
                            'Add By Cheng 2003/01/10
                             Case "CU16" '電話
                                'Modified by Morgan 2023/11/29 先抓接洽人
                                'strExc(1) = "'TEL：'||CU16||DECODE(CU17,NULL,'',','||CU17)"
                                strExc(1) = "'TEL：'||NVL(PCC30,CU16||DECODE(CU17,NULL,'',','||CU17))"
                                'end 2023/11/29
                             Case "CU18" 'FAX
                                'Modified by Morgan 2023/11/29 先抓接洽人
                                'strExc(1) = "'　FAX：'||CU18||DECODE(CU19,NULL,'',','||CU19)"
                                strExc(1) = "'　FAX：'||NVL(PCC31,CU18||DECODE(CU19,NULL,'',','||CU19))"
                                'end 2023/11/29
                             'Add By Cheng 2003/01/07
                             '聯絡地址郵遞區號
                             Case "CU30"
                                'Modify By Cheng 2003/08/05
        '                        strExc(1) = "CU30"
                                strExc(1) = "Decode(CU80, Null, CU30, CU80)"
                             Case "CU31"
                                'Modify By Cheng 2003/08/05
        '                        strExc(1) = "CU31"
                                strExc(1) = "Decode(CU80, Null, CU31, '')"
                             Case "CU24"
                                strExc(1) = "CU24||DECODE(CU25,NULL,'',' '||CU25)||DECODE(CU26,NULL,'',' '||CU26)||DECODE(CU27,NULL,'',' '||CU27)||DECODE(CU28,NULL,'',' '||CU28)"
                             'Add By Sindy 2017/12/1 修法:106/12/01開始中文名稱為公司者後面要加外商國名
                             Case "CU04外商國名"
                                strExc(1) = "decode(cu15,'1',nvl(NA81,''),'')||CU04"
                             '2017/12/1 END
                             Case Else
                                'Modify By Cheng 2003/01/15
                                '直接設定傳入的欄位名稱
        '                        strExc(1) = "CU04"
                                strExc(1) = strOther
                          End Select
                          'Modify By Sindy 2015/1/29
'                          strExc(0) = "SELECT " & strExc(1) & " FROM CASEPROGRESS,CUSTOMER WHERE " & _
'                             "CP09='" & m_Rule & "' AND SUBSTR(" & Tmp(1) & ",1,8)=CU01(+) AND " & _
'                             "SUBSTR(" & Tmp(1) & ",9,1)=CU02(+)"
                           'Modified by Morgan 2023/11/29 +potcustcont
                           strExc(0) = "SELECT " & strExc(1) & " FROM CASEPROGRESS,CUSTOMER,nation,potcustcont WHERE " & _
                             "CP09='" & m_Rule & "' AND SUBSTR(" & Tmp(1) & ",1,8)=CU01(+) AND " & _
                             "SUBSTR(" & Tmp(1) & ",9,1)=CU02(+) AND CU10=NA01(+)" & _
                             " and pcc01(+)=cu01 and pcc02(+)=cu127"
                           'end 2023/11/29
                           '2015/1/29 END
                    End Select
               Case "CP12"
                  strExc(0) = "SELECT SUBSTR(A0902,1,3) FROM CASEPROGRESS,ACC090 WHERE " & _
                     "CP09='" & m_Rule & "' AND CP12=A0901(+)"
               Case "CP13"
                  strExc(0) = "SELECT ST02 FROM CASEPROGRESS,STAFF WHERE " & _
                     "CP09='" & m_Rule & "' AND CP13=ST01(+)"
               Case "CP44"
                  Select Case strOther
                     Case "中"
                        strExc(1) = "FA04"
                     Case "英"
                        strExc(1) = "FA05||DECODE(FA63,NULL,'',' '||FA63)||DECODE(FA64,NULL,'',' '||FA64)||DECODE(FA65,NULL,'',' '||FA65)"
                     Case "日"
                        strExc(1) = "FA06"
                     Case Else
                        'Modify by Morgan 2004/9/21
                        'strExc(1) = "FA04"
                        strExc(1) = strOther
                        
                        'Added by Morgan 2012/6/21
                        'CFP 日本案 CF代理人為 Y51835 E-Mail 用 mm@miyoshipat.co.jp --慧汶 101/5/30 請作單
                        If strExc(1) = "FA16" And m_MySt(1) = "CFP" And m_MySt(6) = "011" Then
                           strExc(1) = "decode(cp44,'Y51835000','mm@miyoshipat.co.jp',FA16)"
                        End If
                        'end 2012/6/21
                        
                  End Select
                  strExc(0) = "SELECT " & strExc(1) & " FROM CASEPROGRESS,FAGENT WHERE " & _
                     "CP09='" & m_Rule & "' AND SUBSTR(" & Tmp(1) & ",1,8)=FA01(+) AND " & _
                     "SUBSTR(" & Tmp(1) & ",9,1)=FA02(+)"
               Case "CP10"
                  Select Case strOther
                     Case "中"
                        If m_MySt(6) = "000" Then
                           strExc(1) = "CPM03"
                        Else
                           strExc(1) = "CPM04"
                        End If
                     Case "英"
                        strExc(1) = "CPM10"
                     Case Else
                        If m_MySt(6) = "000" Then
                           strExc(1) = "CPM03"
                        Else
                           strExc(1) = "CPM04"
                        End If
                  End Select
                  strExc(0) = "SELECT " & strExc(1) & " FROM CASEPROPERTYMAP WHERE CPM01='" & m_MySt(1) & "' AND CPM02='" & m_MySt(5) & "'"
               Case Else
                  strExc(0) = "SELECT " & Tmp(1) & " FROM CASEPROGRESS WHERE CP09='" & m_Rule & "'"
            End Select
         ' 案件性質對照檔
         Case "CASEPROPERTYMAP"
            strExc(0) = "SELECT " & Tmp(1) & " FROM CASEPROPERTYMAP WHERE " & _
                "CPM01='" & m_MySt(1) & "' AND CPM02='" & m_MySt(5) & "'"
         ' 變更事項檔
         Case "CHANGEEVENT"
            Select Case Tmp(1)
               Case "CE04", "CE05", "CE06", "CE07", "CE08"
                  Select Case strOther
                     Case "CU04"
                        strExc(1) = "CU04"
                     Case "CU05"
                        'strExc(1) = "CU05||DECODE(CU88,NULL,'',' '||CU88)||DECODE(CU89,NULL,'',' '||CU89)||DECODE(CU90,NULL,'',' '||CU90)"
                        strExc(1) = "CU05"
                     'Add By Cheng 2003/01/15
                     '英文名稱串連
                     Case "CU05CU88CU89CU90"
                        strExc(1) = "CU05||DECODE(CU88,NULL,'',' '||CU88)||DECODE(CU89,NULL,'',' '||CU89)||DECODE(CU90,NULL,'',' '||CU90)"
                     Case "CU06"
                        strExc(1) = "CU06"
                     Case "CU11"
                        strExc(1) = "CU11"
                     Case "CU15"
                        'Modify By Sindy 2012/5/24
                        'strExc(1) = "DECODE(CU15,'0','台端','貴公司')"
                        strExc(1) = "DECODE(CU15,'0','台端','1','貴公司','貴單位')"
                     Case "CU00"
                        strExc(1) = "DECODE(CU15,'0',DECODE(SUBSTR(CU11,2,1),'1','先生','2','小姐'),'')"
                    'Add By Cheng 2003/01/07
                    '聯絡地址郵遞區號
                     Case "CU30"
                        strExc(1) = "CU30"
                     'Add By Sindy 2017/12/1 修法:106/12/01開始中文名稱為公司者後面要加外商國名
                     Case "CU04外商國名"
                        strExc(1) = "decode(cu15,'1',nvl(NA81,''),'')||CU04"
                     '2017/12/1 END
                     Case Else
                        'Modify By Cheng 2003/01/15
                        '直接設定傳入的欄位名稱
'                        strExc(1) = "CU04"
                        strExc(1) = strOther
                  End Select
                  strExc(0) = "SELECT " & strExc(1) & " FROM CHANGEEVENT,CUSTOMER,nation WHERE CE01='" & m_Rule & "' AND " & _
                     "SUBSTR(" & Tmp(1) & ",1,8)=CU01(+) AND SUBSTR(" & Tmp(1) & ",9,1)=CU02(+) AND CU10=NA01(+)"
               Case Else
                  strExc(0) = "SELECT " & Tmp(1) & " FROM CHANGEEVENT WHERE CE01='" & m_Rule & "'"
            End Select
         ' 大陸專利公報檔
         Case "CPBULLETIN"
               ' 專利
               strExc(0) = "SELECT " & Tmp(1) & " FROM CPBULLETIN WHERE CPB01='" & m_MySt(7) & "'"
         ' 客戶基本檔
         Case "CUSTOMER"
            'Modify By Sindy 2022/3/11 ex:T-238055 <客戶檔-代表人1(英)>
            Select Case m_SysKind
               Case 2 '商標
                  strExc(0) = "SELECT " & Tmp(1) & " FROM TRADEMARK,CUSTOMER WHERE " & TmSt & _
                     " AND (SUBSTR(TM23,1,8)=CU01 AND SUBSTR(TM23,9,1)=CU02" & _
                     " OR SUBSTR(TM78,1,8)=CU01 AND SUBSTR(TM78,9,1)=CU02" & _
                     " OR SUBSTR(TM79,1,8)=CU01 AND SUBSTR(TM79,9,1)=CU02" & _
                     " OR SUBSTR(TM80,1,8)=CU01 AND SUBSTR(TM80,9,1)=CU02" & _
                     " OR SUBSTR(TM81,1,8)=CU01 AND SUBSTR(TM81,9,1)=CU02)"
               Case 6 '服務業務-商標
                  strExc(0) = "SELECT " & Tmp(1) & " FROM SERVICEPRACTICE,CUSTOMER WHERE SP01='" & m_MySt(1) & "' AND " & _
                     "SP02='" & m_MySt(2) & "' AND SP03='" & m_MySt(3) & "' AND SP04='" & m_MySt(4) & "'" & _
                     " AND (SUBSTR(SP08,1,8)=CU01 AND SUBSTR(SP08,9,1)=CU02" & _
                     " OR SUBSTR(SP58,1,8)=CU01 AND SUBSTR(SP58,9,1)=CU02" & _
                     " OR SUBSTR(SP59,1,8)=CU01 AND SUBSTR(SP59,9,1)=CU02" & _
                     " OR SUBSTR(SP65,1,8)=CU01 AND SUBSTR(SP65,9,1)=CU02" & _
                     " OR SUBSTR(SP66,1,8)=CU01 AND SUBSTR(SP66,9,1)=CU02)"
            End Select
            '2022/3/11 END
         ' 國外代理人基本資料檔
         Case "FAGENT"
            Select Case m_SysKind
               Case 1 '專利
                  strExc(0) = "SELECT " & Tmp(1) & " FROM PATENT,FAGENT WHERE " & PaSt & _
                     " AND SUBSTR(PA75,1,8)=FA01(+) AND SUBSTR(PA75,9,1)=FA02(+)"
               Case 2 '商標
                  strExc(0) = "SELECT " & Tmp(1) & " FROM TRADEMARK,FAGENT WHERE " & TmSt & _
                     " AND SUBSTR(TM44,1,8)=FA01(+) AND SUBSTR(TM44,9,1)=FA02(+)"
            End Select
         ' 客戶發明人檔
         Case "INVENTOR"
            
         ' 下一程序資料檔
         Case "NEXTPROGRESS"
            If Tmp(1) = "NP08" Or Tmp(1) = "NP09" Then
               strExc(0) = "SELECT " & Tmp(1) & " FROM NEXTPROGRESS WHERE NP02=" & _
                  "'" & m_MySt(1) & "' AND NP03='" & m_MySt(2) & "' AND NP04=" & _
                  "'" & m_MySt(3) & "' AND NP05='" & m_MySt(4) & "' AND NP07=" & _
                  "'" & m_MySt(5) & "' AND NP06=NULL"
            Else
               strExc(0) = "SELECT " & Tmp(1) & " FROM NEXTPROGRESS WHERE NP01='" & _
               m_Rule & "'"
            End If
         ' 國家基本檔
         Case "NATION"
            Select Case Tmp(1)
               Case "NA06", "NA08", "NA10", "NA12"
                  strExc(0) = "SELECT " & Tmp(1) & " FROM NATION WHERE NA01='" & m_MySt(6) & "'"
                  St1 = 0
                  intI = 1
                  Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
                  If intI = 1 Then
                     If Not IsNull(RsTemp.Fields(0).Value) Then St1 = RsTemp.Fields(0).Value
                  End If
                  Select Case St1
                     ' 收文日在案件進度檔
                     Case 1
                        Tmp(1) = "CP05"
                        Tmp(3) = "CASEPROGRESS"
                     ' 申請日
                     Case 2
                        Select Case m_SysKind
                           ' 專利
                           Case 1
                              Tmp(1) = "PA10"
                              Tmp(3) = "PATENT"
                           ' 商標
                           Case 2
                              Tmp(1) = "TM11"
                              Tmp(3) = "TRADEMARK"
                        End Select
                     ' 發文日在案件進度檔
                     Case 3
                        Tmp(1) = "CP27"
                        Tmp(3) = "CASEPROGRESS"
                     ' 准駁日在案件進度檔
                     Case 4
                        Tmp(1) = "CP25"
                        Tmp(3) = "CASEPROGRESS"
                     ' 公告日
                     Case 5
                        Select Case m_SysKind
                           ' 專利
                           Case 1
                              Tmp(1) = "PA14"
                              Tmp(3) = "PATENT"
                           ' 商標
                           Case 2
                              Tmp(1) = "TM14"
                              Tmp(3) = "TRADEMARK"
                        End Select
                     ' 發證日
                     Case 6
                        Select Case m_SysKind
                           ' 專利
                           Case 1
                              Tmp(1) = "PA21"
                              Tmp(3) = "PATENT"
                           ' 商標
                           Case 2
                              Tmp(1) = "TM20"
                              Tmp(3) = "TRADEMARK"
                        End Select
                  End Select
                  ' 回到取檔案欄位內容的地方
                  GoTo A0
               Case Else
                  strExc(0) = "SELECT " & Tmp(1) & " FROM NATION WHERE NA01='" & m_MySt(6) & "'"
            End Select
         ' 專利基本檔
         Case "PATENT"
            Select Case Tmp(1)
               'Add by Morgan 2007/1/25 案號不必重抓
               Case "PA01", "PA02", "PA03", "PA04"
                  DoChange = m_MySt(Val(Right(Tmp(1), 1)))
                  Exit Function
               'end 2007/1/25
               
              ' 申請人需到客戶檔中取得真正的資料
               Case "PA26", "PA27", "PA28", "PA29", "PA30"
                  Select Case strOther
                     Case "CU04", "CU04外商國名"
                        strExc(1) = strOther
                        'Add By Sindy 2017/12/1 修法:106/12/01開始中文名稱為公司者後面要加外商國名
                        If strOther = "CU04外商國名" Then
                           strExc(0) = "SELECT decode(cu15,'1',nvl(NA81,''),'')||CU04 FROM PATENT,CUSTOMER,nation WHERE " & PaSt & _
                              " AND SUBSTR(" & Tmp(1) & ",1,8)=CU01(+) AND SUBSTR(" & Tmp(1) & ",9,1)=CU02(+)" & _
                              " AND CU10=na01(+)"
                        Else
                        '2017/12/1 END
                           strExc(0) = "SELECT " & strExc(1) & " FROM PATENT,CUSTOMER WHERE " & PaSt & _
                              " AND SUBSTR(" & Tmp(1) & ",1,8)=CU01(+) AND SUBSTR(" & Tmp(1) & ",9,1)=CU02(+)"
                        End If
                        'Add by Morgan 2008/4/1
                        'FCP申請書申請人不出名控制
                        If m_MySt(1) = "FCP" And m_FinalSty = "01" Then
                           strExc(0) = strExc(0) & " AND (PA27 IS NULL OR NVL(cu123,'Y')='Y')"
                        End If
                     'Add by Morgan 2005/4/28 無英文抓日文
                     Case "CU05"
                        strExc(1) = "NVL(CU05,CU06)"
                        strExc(0) = "SELECT " & strExc(1) & " FROM PATENT,CUSTOMER WHERE " & PaSt & _
                           " AND SUBSTR(" & Tmp(1) & ",1,8)=CU01(+) AND SUBSTR(" & Tmp(1) & ",9,1)=CU02(+)"
                     'Add By Cheng 2003/01/15
                     '英文名稱串連
                     Case "CU05CU88CU89CU90"
                        strExc(1) = "CU05||DECODE(CU88,NULL,'',' '||CU88)||DECODE(CU89,NULL,'',' '||CU89)||DECODE(CU90,NULL,'',' '||CU90)"
                        strExc(0) = "SELECT " & strExc(1) & " FROM PATENT,CUSTOMER WHERE " & PaSt & _
                           " AND SUBSTR(" & Tmp(1) & ",1,8)=CU01(+) AND SUBSTR(" & Tmp(1) & ",9,1)=CU02(+)"
                     Case "CU06"
                        strExc(1) = "CU06"
                        strExc(0) = "SELECT " & strExc(1) & " FROM PATENT,CUSTOMER WHERE " & PaSt & _
                           " AND SUBSTR(" & Tmp(1) & ",1,8)=CU01(+) AND SUBSTR(" & Tmp(1) & ",9,1)=CU02(+)"
                     Case "CU11"
                        strExc(1) = "CU11"
                        strExc(0) = "SELECT " & strExc(1) & " FROM PATENT,CUSTOMER WHERE " & PaSt & _
                           " AND SUBSTR(" & Tmp(1) & ",1,8)=CU01(+) AND SUBSTR(" & Tmp(1) & ",9,1)=CU02(+)"
                     Case "CU15"
                        'Modify By Sindy 2012/5/24
                        'strExc(1) = "DECODE(CU15,'0','台端','貴公司')"
                        strExc(1) = "DECODE(CU15,'0','台端','1','貴公司','貴單位')"
                        strExc(0) = "SELECT " & strExc(1) & " FROM PATENT,CUSTOMER WHERE " & PaSt & _
                           " AND SUBSTR(" & Tmp(1) & ",1,8)=CU01(+) AND SUBSTR(" & Tmp(1) & ",9,1)=CU02(+)"
                     'Add By Cheng 2002/06/14
                     Case "CU16"
                        'Modified by Morgan 2023/11/29 先抓接洽人
                        'strExc(1) = "'TEL：'||CU16||DECODE(CU17,NULL,'',','||CU17)"
                        'strExc(0) = "SELECT " & strExc(1) & " FROM PATENT,CUSTOMER WHERE " & PaSt & _
                           " AND SUBSTR(" & Tmp(1) & ",1,8)=CU01(+) AND SUBSTR(" & Tmp(1) & ",9,1)=CU02(+)"
                        strExc(1) = "'TEL：'||nvl(PCC30,CU16||DECODE(CU17,NULL,'',','||CU17))"
                        strExc(0) = "SELECT " & strExc(1) & " FROM PATENT,CUSTOMER,potcustcont WHERE " & PaSt & _
                           " AND SUBSTR(" & Tmp(1) & ",1,8)=CU01(+) AND SUBSTR(" & Tmp(1) & ",9,1)=CU02(+)" & _
                           " and pcc01(+)=cu01 and pcc02(+)=nvl(pa149,cu127)"
                        'end 2023/11/29
                     Case "CU18"
                        'Modified by Morgan 2023/11/29 先抓接洽人
                        'strExc(1) = "'　FAX：'||CU18||DECODE(CU19,NULL,'',','||CU19)"
                        'strExc(0) = "SELECT " & strExc(1) & " FROM PATENT,CUSTOMER WHERE " & PaSt & _
                           " AND SUBSTR(" & Tmp(1) & ",1,8)=CU01(+) AND SUBSTR(" & Tmp(1) & ",9,1)=CU02(+)"
                        strExc(1) = "'　FAX：'||NVL(PCC31,CU18||DECODE(CU19,NULL,'',','||CU19))"
                        strExc(0) = "SELECT " & strExc(1) & " FROM PATENT,CUSTOMER,potcustcont WHERE " & PaSt & _
                           " AND SUBSTR(" & Tmp(1) & ",1,8)=CU01(+) AND SUBSTR(" & Tmp(1) & ",9,1)=CU02(+)" & _
                           " and pcc01(+)=cu01 and pcc02(+)=nvl(pa149,cu127)"
                        'end 2023/11/29
                     Case "CU00"
                        strExc(1) = "DECODE(CU15,'0',DECODE(SUBSTR(CU11,2,1),'1','先生','2','小姐'),'')"
                        strExc(0) = "SELECT " & strExc(1) & " FROM PATENT,CUSTOMER WHERE " & PaSt & _
                           " AND SUBSTR(" & Tmp(1) & ",1,8)=CU01(+) AND SUBSTR(" & Tmp(1) & ",9,1)=CU02(+)"
                     'Add By Cheng 2003/01/07
                     '聯絡地址郵遞區號
                     Case "CU30"
'                        'Modify By Cheng 2003/05/06
'                        strExc(1) = "CU30"
                        strExc(1) = "Decode(CU80,Null,CU30,CU80)"
                        strExc(0) = "SELECT " & strExc(1) & " FROM PATENT,CUSTOMER WHERE " & PaSt & _
                           " AND SUBSTR(" & Tmp(1) & ",1,8)=CU01(+) AND SUBSTR(" & Tmp(1) & ",9,1)=CU02(+)"
                     Case "CU31"
                        'Modify By Cheng 2003/05/06
'                        strExc(1) = "CU31"
                        strExc(1) = "Decode(CU80,Null,CU31,'')"
                        strExc(0) = "SELECT " & strExc(1) & " FROM PATENT,CUSTOMER WHERE " & PaSt & _
                           " AND SUBSTR(" & Tmp(1) & ",1,8)=CU01(+) AND SUBSTR(" & Tmp(1) & ",9,1)=CU02(+)"
                     '92.1.22 ADD BY SONIA 申請人國外ID對照
                     Case "AFID03"
                        strExc(0) = "SELECT " & strOther & " FROM PATENT,APPLICANTFOREIGNID WHERE " & PaSt & _
                           " AND SUBSTR(" & Tmp(1) & ",1,8)=AFID01(+) AND PA09=AFID02(+)"
                        'Modified by Lydia 2015/04/10 申請人同一國家可有多筆ID, 故必須掃過所有符合條件的記錄
                        DoLoop = True
                     '92.1.22 END
                     Case Else
                        ' 91.10.24 MODIFY BY SONIA
                        'strExc(1) = "CU04"
                        strExc(1) = strOther
                        'Modify by Morgan 2010/1/7 去除右方空白
                        strExc(0) = "SELECT rtrim(" & strExc(1) & ") FROM PATENT,CUSTOMER WHERE " & PaSt & _
                           " AND SUBSTR(" & Tmp(1) & ",1,8)=CU01(+) AND SUBSTR(" & Tmp(1) & ",9,1)=CU02(+)"
                  End Select
                  'Memo by Lydia 2021/08/17 刪除舊程式碼：專利發明人在專利基本檔60~69
                ' 卷宗性質
               Case "PA23"
                  'Modified by Morgan 2022/3/18 大陸要帶無效宣告
                  'strExc(0) = "SELECT DECODE(PA23,'1','申請','2','異議','3','舉發') FROM PATENT WHERE " & PaSt
                  strExc(0) = "SELECT DECODE(PA23,'1','申請','2','異議','3',decode(pa09,'020','無效宣告','舉發')) FROM PATENT WHERE " & PaSt
                  'end 2022/3/18
              ' 申請國家需到國家檔中取得真正的資料
               Case "PA09"
                  Select Case strOther
                     Case "NA03"
                        strExc(1) = "NA03"
                     Case "NA04"
                        'Memo by Morgan 2013/3/5 若有修改時撰寫信函也要同步改
                        'Modify by Morgan 2006/5/19 英美前面+the
                        'strExc(1) = "NA04"
                        '2008/9/12 modify by sonia
                        'strExc(1) = "decode(instr('101,201',na01),0,null,'the ')||initcap(NA04)"
                        strExc(1) = "decode(na01,'000','Taiwan','020','PRC',decode(instr('101,201',na01),0,null,'the ')||initcap(NA04))"
                        '2008/9/12 end
                     Case Else
                        strExc(1) = "NA03"
                  End Select
                  strExc(0) = "SELECT " & strExc(1) & " FROM PATENT,NATION WHERE " & PaSt & _
                     " AND PA09=NA01(+)"

               'Added by Morgan 2024/4/26
               Case "PA11"
                  'EPC子案改抓母案申請案號,只有德國繳年費要抓子案申請號(國家階段申請號)改用例外欄位"EPC子案申請案號"
                  'Modified by Morgan 2024/7/23 子案申請國不會是221
                  'If m_MySt(6) = "221" And m_MySt(4) <> "00" Then
                  If m_MySt(4) <> "00" Then
                  'end 2024/7/23
                     strExc(0) = "SELECT PA11 FROM PATENT WHERE PA01='" & m_MySt(1) & "' AND PA02='" & _
                        m_MySt(2) & "' AND PA03='" & m_MySt(3) & "' AND PA04='00'"
                  Else
                     strExc(0) = "SELECT " & Tmp(1) & " FROM PATENT WHERE " & PaSt
                  End If
               'end 2024/4/26
                  'Modify By Sindy 2025/7/7 檢查是否有1405=受理技術報告申請,要帶出對應的申請案號
                  If m_MySt(6) = "000" Then
                     strCP43 = m_Rule
                     '先檢查相關總收文號有沒有對應到申請技術報告
                     Do While strCP43 <> ""
                        strExc(9) = "SELECT cp43 FROM caseprogress WHERE cp09='" & strCP43 & "' and cp43 is not null"
                        intI = 1
                        Set RsTemp = ClsLawReadRstMsg(intI, strExc(9))
                        If intI = 1 Then
                           strCP43 = RsTemp.Fields("cp43")
                        Else
                           Exit Do
                        End If
                     Loop
                     strExc(9) = "SELECT cp10 FROM caseprogress WHERE cp09='" & strCP43 & "'"
                     intI = 1
                     Set RsTemp = ClsLawReadRstMsg(intI, strExc(9))
                     If intI = 1 Then
                        If RsTemp.Fields("cp10") = "421" Then
                           strExc(9) = "SELECT upper(cp36) FROM PATENT,CASEPROGRESS WHERE " & PaSt & _
                                       " AND CP01(+)=PA01 AND CP02(+)=PA02 AND CP03(+)=PA03 AND CP04(+)=PA04 AND CP10='1405'" & _
                                       " AND cp36 is not null" & _
                                       " order by CP05 desc"
                           intI = 1
                           Set RsTemp = ClsLawReadRstMsg(intI, strExc(9))
                           If intI = 1 Then
                              strExc(0) = "SELECT upper(cp36) FROM PATENT,CASEPROGRESS WHERE " & PaSt & _
                                          " AND CP01(+)=PA01 AND CP02(+)=PA02 AND CP03(+)=PA03 AND CP04(+)=PA04 AND CP10='1405'" & _
                                          " AND cp36 is not null" & _
                                          " order by CP05 desc"
                           End If
                        End If
                     End If
                  End If
                  '2025/7/7 END
                  
               Case Else
                  strExc(0) = "SELECT " & Tmp(1) & " FROM PATENT WHERE " & PaSt
                  
                  'Add by Morgan 2008/4/1
                  'FCP申請書申請人不出名控制(代表人)
                  If m_MySt(1) = "FCP" And m_FinalSty = "01" Then
                     Select Case Tmp(1)
                        Case "PA79", "PA82"
                           strExc(1) = "PA26"
                        Case "PA109", "PA112"
                           strExc(1) = "PA27"
                        Case "PA115", "PA118"
                           strExc(1) = "PA28"
                        Case "PA121", "PA124"
                           strExc(1) = "PA29"
                        Case "PA127", "PA130"
                           strExc(1) = "PA30"
                        Case Else
                           strExc(1) = ""
                     End Select
                     If strExc(1) <> "" Then
                        strExc(0) = strExc(0) & " AND (PA27 IS NULL OR EXISTS(SELECT * FROM CUSTOMER WHERE CU01=SUBSTR(" & strExc(1) & ",1,8) AND CU02=SUBSTR(" & strExc(1) & ",9,1) AND NVL(cu123,'Y')='Y'))"
                     End If
                  End If
            End Select
         ' 專利商標種類/著作權登記項目對照表
         Case "PATENTTRADEMARKMAP"
            ' 分類(商標, 專利)
            If InStr(m_MySt(1), "T") > 0 Then
               St = "2"
                'Modify By Cheng 2003/01/02
                '商標種類1~3為商標,4~6為服務商標
'               strExc(0) = "SELECT " & Tmp(1) & " FROM PATENTTRADEMARKMAP,TRADEMARK WHERE " & TmSt & _
'                  " AND PTM01='" & St & "' AND PTM02=TM08"
                'Modify By Cheng 2003/01/23
                '若傳入的欄位為PTM04
                If UCase(Tmp(1)) = "PTM04" Then
                    strExc(0) = "SELECT DECODE(TM08,'1','商標','2','商標','3','商標','4','服務商標','5','服務商標','6','服務商標'," & Tmp(1) & ") FROM PATENTTRADEMARKMAP,TRADEMARK WHERE " & TmSt & _
                       " AND PTM01='" & St & "' AND PTM02=TM08"
                '若傳入其他欄位
                Else
                    strExc(0) = "SELECT " & Tmp(1) & " FROM PATENTTRADEMARKMAP,TRADEMARK WHERE " & TmSt & _
                       " AND PTM01='" & St & "' AND PTM02=TM08"
                End If
            ElseIf InStr(m_MySt(1), "P") > 0 Then
               St = "1"
               
               'Modify by Morgan 2006/5/30 若為香港時 發明->標準專利記錄請求,實用新型->短期專利   2008/2/13 sonia 改為標準專利
'               strExc(0) = "SELECT " & Tmp(1) & " FROM PATENTTRADEMARKMAP,PATENT WHERE " & PaSt & _
'                  " AND PTM01='" & St & "' AND PTM02=PA08"
               '若傳入的欄位為PTM04
               If UCase(Tmp(1)) = "PTM04" Then
                  strExc(0) = "SELECT decode(pa09,'013',decode(pa08,'1','標準專利','2','短期專利',PTM04),PTM04) FROM PATENTTRADEMARKMAP,PATENT WHERE " & PaSt & _
                     " AND PTM01='" & St & "' AND PTM02=PA08"
               Else
                  'Modified by Morgan 2012/5/9 +植物新品種保護
                  'strExc(0) = "SELECT " & Tmp(1) & " FROM PATENTTRADEMARKMAP,PATENT WHERE " & PaSt & _
                     " AND PTM01='" & St & "' AND PTM02=PA08"
                  'Modified by Morgan 2019/1/21 +植物新品種保護英文 Ex:CFP-029088指示信主旨
                  strExc(0) = "SELECT DECODE(CP10,NULL," & Tmp(1) & ",decode(UPPER('" & Tmp(1) & "'),'PTM05','Plant Breeder''s Right','植物新品種保護')) FROM PATENTTRADEMARKMAP,PATENT,CASEPROGRESS WHERE " & PaSt & _
                     " AND PTM01='" & St & "' AND PTM02=PA08 AND CP01(+)=PA01 AND CP02(+)=PA02 AND CP03(+)=PA03 AND CP04(+)=PA04 AND CP10(+)='120'"
                  'Modify By Sindy 2025/7/7 檢查相關總收文號串到最後,是否為421=申請技術報告,才要帶出"新型技報"
                  If UCase(Tmp(1)) = "PTM03" And m_MySt(6) = "000" Then
                     strCP43 = m_Rule
                     Do While strCP43 <> ""
                        strExc(9) = "SELECT cp43 FROM caseprogress WHERE cp09='" & strCP43 & "' and cp43 is not null"
                        intI = 1
                        Set RsTemp = ClsLawReadRstMsg(intI, strExc(9))
                        If intI = 1 Then
                           strCP43 = RsTemp.Fields("cp43")
                        Else
                           Exit Do
                        End If
                     Loop
                     strExc(9) = "SELECT cp10 FROM caseprogress WHERE cp09='" & strCP43 & "'"
                     intI = 1
                     Set RsTemp = ClsLawReadRstMsg(intI, strExc(9))
                     If intI = 1 Then
                        If RsTemp.Fields("cp10") = "421" Then
                           strExc(0) = "SELECT '新型技報' FROM PATENTTRADEMARKMAP,PATENT,CASEPROGRESS WHERE " & PaSt & _
                              " AND PTM01='" & St & "' AND PTM02=PA08 AND CP01(+)=PA01 AND CP02(+)=PA02 AND CP03(+)=PA03 AND CP04(+)=PA04 AND CP10='421'"
                        End If
                     End If
                  End If
                  '2025/7/7 END
               End If
            End If
         ' 專利年費資料檔
         Case "PATENTYEARFEE"
            strExc(0) = "SELECT PA08,CP44 FROM PATENT,CASEPROGRESS WHERE CP09='" & m_Rule & "' AND PA01=CP01 AND PA02=CP02 AND PA03=CP03 AND PA04=CP04"
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               strExc(1) = "'" & RsTemp.Fields(0) & "'"
               If IsNull(RsTemp.Fields(1)) Then
                  strExc(2) = "'" & String(9, "0") & "'"
               Else
                  strExc(2) = "'" & RsTemp.Fields(1) & "'"
               End If
            Else
               strExc(1) = "NULL"
               strExc(2) = "NULL"
            End If
            strExc(0) = "SELECT " & Tmp(1) & " FROM PATENTYEARFEE WHERE YF01='" & _
               m_MySt(6) & "' AND YF02=" & strExc(1) & " AND YF03=" & strExc(2) & _
               " AND YF04='" & m_MySt(5) & "' AND YF05=" & m_MySt(7)
         ' 優先權資料對照檔
         Case "PRIDATE"
            Select Case Tmp(1)
               ' 申請國家需到國家檔中取得真正的資料
                Case "PD07"
                   Select Case strOther
                      Case "NA03"
                         strExc(1) = "NA03"
                      Case "NA04"
                         strExc(1) = "NA04"
                      Case Else
                         strExc(1) = "NA03"
                   End Select
                   strExc(0) = "SELECT " & strExc(1) & " FROM PRIDATE,NATION WHERE PD01='" & m_MySt(1) & "' AND " & _
                      "PD02='" & m_MySt(2) & "' AND PD03='" & m_MySt(3) & "' AND PD04='" & m_MySt(4) & "'" & _
                      " AND PD07=NA01(+)"
                   'Remove by Morgan 2007/12/26
                   'strExc(0) = strExc(0) & " order by PD07"
                
                'Added by Morgan 2014/1/23
                Case "PD08" '優先權種類
                   If strOther = "PTM04" Or strOther = "PTM05" Or strOther = "PTM06" Then
                     strExc(1) = strOther
                  Else
                     strExc(1) = "PTM05"
                  End If
                     strExc(0) = "SELECT " & strExc(1) & " FROM PRIDATE,PATENT,PATENTTRADEMARKMAP WHERE PD01='" & m_MySt(1) & "' AND " & _
                      "PD02='" & m_MySt(2) & "' AND PD03='" & m_MySt(3) & "' AND PD04='" & m_MySt(4) & "'" & _
                      " AND PA11(+)=PD06 AND PTM01(+)='1' AND PTM02=NVL(PA08,PD08)"
                
'cancel by sonia 2019/12/3 會影響定稿之{<優先權資料-優先權日>/英}
'                'add by sonia 2019/11/12
'                Case "PD05" '優先權日
'                     strExc(0) = "SELECT SQLDATEW(" & Tmp(1) & ") FROM PRIDATE WHERE " & _
'                        "PD01='" & m_MySt(1) & "' AND PD02='" & m_MySt(2) & _
'                        "' AND PD03='" & m_MySt(3) & "' AND PD04='" & m_MySt(4) & "'"
'                'end 2019/11/12
'end 2019/12/3
                
                Case Else
                     strExc(0) = "SELECT " & Tmp(1) & " FROM PRIDATE WHERE " & _
                        "PD01='" & m_MySt(1) & "' AND PD02='" & m_MySt(2) & _
                        "' AND PD03='" & m_MySt(3) & "' AND PD04='" & m_MySt(4) & "'"
            End Select
            'Add by Morgan 2007/12/26 排序要統一否則多筆時會搭配錯
            strExc(0) = strExc(0) & " order by PD05 asc,PD07 asc"
            'end 2007/12/26
            
            ' 對優先權對照檔來說, 符合條件的國家會有很多筆, 故必須掃過所有符合條件的記錄
            DoLoop = True
         ' 員工檔
         Case "STAFF"
            If Tmp(1) = "ST07" Then
               strExc(0) = "SELECT ST07 FROM STAFF WHERE ST01='" & m_User & "'"
            Else
               ' 依照
               Select Case m_RefKind
                  ' 由收文號取資料
                  Case 0
                     strExc(0) = "SELECT " & Tmp(1) & " FROM STAFF,CASEPROGRESS WHERE " & _
                        "CP09='" & m_Rule & "' AND CP13=ST01(+)"
                  ' 由本所案號來取得資料
                  Case 1
                     Select Case m_SysKind
                        ' 專利
                        Case 1
                           strExc(0) = "SELECT " & Tmp(1) & " FROM STAFF WHERE ST01=" & _
                              "(SELECT CP13 FROM CASEPROPERGRESS WHERE (CU01,CU02) IN " & _
                              "(SELECT SUBSTR(PA26,1,8),SUBSTR(PA26,9,1) FROM PATENT WHERE " & PaSt & ")"
                        ' 商標
                        Case 2
                           strExc(0) = "SELECT " & Tmp(1) & " FROM STAFF WHERE ST01=" & _
                              "(SELECT CP13 FROM CASEPROPERGRESS WHERE (CU01,CU02) IN " & _
                              " (SELECT SUBSTR(TM23,1,8),SUBSTR(TM23,9,1) FROM TRADEMARK WHERE " & TmSt & ")"
                     End Select
               End Select
            End If
         ' 服務業務基本資料檔
         Case "SERVICEPRACTICE"
            Select Case Tmp(1)
               'Modify By Sindy 2011/2/21 增加SP65,SP66
               Case "SP08", "SP58", "SP59", "SP65", "SP66"
                  Select Case strOther
                     Case "CU04"
                        strExc(1) = "CU04"
                        'Modify By Cheng 2003/01/03
                     Case "CU05"
'                        strExc(1) = "CU05||DECODE(CU88,NULL,'',' '||CU88)||DECODE(CU89,NULL,'',' '||CU89)||DECODE(CU90,NULL,'',' '||CU90)"
                        strExc(1) = "CU05"
                     'Add By Cheng 2003/01/15
                     '英文名稱串連
                     Case "CU05CU88CU89CU90"
                        strExc(1) = "CU05||DECODE(CU88,NULL,'',' '||CU88)||DECODE(CU89,NULL,'',' '||CU89)||DECODE(CU90,NULL,'',' '||CU90)"
                     Case "CU06"
                        strExc(1) = "CU06"
                     Case "CU11"
                        strExc(1) = "CU11"
                     Case "CU15"
                        'Modify By Sindy 2012/5/24
                        'strExc(1) = "DECODE(CU15,'0','台端','貴公司')"
                        strExc(1) = "DECODE(CU15,'0','台端','1','貴公司','貴單位')"
                     'Add By Cheng 2002/06/14
                     Case "CU16"
                        'Modified by Morgan 2023/11/29 先抓接洽人
                        'strExc(1) = "'TEL：'||CU16||DECODE(CU17,NULL,'',','||CU17)"
                        strExc(1) = "'TEL：'||NVL(PCC30,CU16||DECODE(CU17,NULL,'',','||CU17))"
                        'end 2023/11/29
                     Case "CU18"
                        'Modified by Morgan 2023/11/29 先抓接洽人
                        'strExc(1) = "'　FAX：'||CU18||DECODE(CU19,NULL,'',','||CU19)"
                        strExc(1) = "'　FAX：'||NVL(PCC31,CU18||DECODE(CU19,NULL,'',','||CU19))"
                        'end 2023/11/29
                     Case "CU00"
                        strExc(1) = "DECODE(CU15,'0',DECODE(SUBSTR(CU11,2,1),'1','先生','2','小姐'),'')"
                     'Add By Cheng 2003/01/07
                     '聯絡地址郵遞區號
                     Case "CU30"
'                        'Modify By Cheng 2003/05/06
'                        strExc(1) = "CU30"
                        strExc(1) = "Decode(CU80,Null,CU30,CU80)"
                     Case "CU31"
                        'Modify By Cheng 2003/05/06
'                        strExc(1) = "CU31"
                        strExc(1) = "Decode(CU80,Null,CU31,'')"
                     'Add By Sindy 2017/12/1 修法:106/12/01開始中文名稱為公司者後面要加外商國名
                     Case "CU04外商國名"
                        strExc(1) = "decode(cu15,'1',nvl(NA81,''),'')||CU04"
                     '2017/12/1 END
                     Case Else
                        'Modify By Cheng 2003/01/15
                        '直接設定所傳入的欄位名稱
'                        strExc(1) = "CU04"
                         strExc(1) = strOther
                  End Select
                  'Modified by Morgan 2023/11/29 +potcustcont
                  strExc(0) = "SELECT " & strExc(1) & " FROM SERVICEPRACTICE,CUSTOMER,nation,potcustcont WHERE SP01='" & m_MySt(1) & "' AND " & _
                     "SP02='" & m_MySt(2) & "' AND SP03='" & m_MySt(3) & "' AND SP04='" & m_MySt(4) & "'" & _
                     " AND SUBSTR(" & Tmp(1) & ",1,8)=CU01(+) AND SUBSTR(" & Tmp(1) & ",9,1)=CU02(+) AND CU10=NA01(+)" & _
                     " and pcc01(+)=cu01 and pcc02(+)=nvl(sp78,cu127)"
                  'end 2023/11/29
              ' 申請國家需到國家檔中取得真正的資料
               Case "SP09"
                  Select Case strOther
                     Case "NA03"
                        strExc(1) = "NA03"
                     Case "NA04"
                        strExc(1) = "NA04"
                     Case Else
                        strExc(1) = "NA03"
                  End Select
                  strExc(0) = "SELECT " & strExc(1) & " FROM SERVICEPRACTICE,NATION WHERE SP01='" & m_MySt(1) & "' AND " & _
                     "SP02='" & m_MySt(2) & "' AND SP03='" & m_MySt(3) & "' AND SP04='" & m_MySt(4) & "'" & _
                     " AND SP09=NA01(+)"
               'add by nickc 2006/04/28  start
               Case "SP32"
                    Select Case strOther
                       Case "TM09"
                        strExc(1) = "TM09"
                       Case Else
                        strExc(1) = "SP32"
                    End Select
                  strExc(0) = "SELECT " & strExc(1) & " FROM SERVICEPRACTICE,trademark WHERE SP01='" & m_MySt(1) & "' AND " & _
                     "SP02='" & m_MySt(2) & "' AND SP03='" & m_MySt(3) & "' AND SP04='" & m_MySt(4) & "'" & _
                     " AND SP32=tm15(+)"
                Case "SP26"
                  Select Case strOther
                     Case "中"
                        strExc(1) = "decode(SP01,'T',nvl(fa04,cu04),FA04)"
                        strExc(0) = "SELECT " & strExc(1) & " FROM SERVICEPRACTICE,FAGENT,customer WHERE SP01='" & m_MySt(1) & "' AND " & _
                                    "SP02='" & m_MySt(2) & "' AND SP03='" & m_MySt(3) & "' AND SP04='" & m_MySt(4) & "' " & _
                                    " AND SUBSTR(SP26,1,8)=FA01(+) AND SUBSTR(SP26,9,1)=FA02(+) and substr(SP08,1,8)=cu01(+) and substr(SP08,9,1)=cu02(+) "
                     Case "英"
                        strExc(1) = "FA05||DECODE(FA63,NULL,'',' '||FA63)||DECODE(FA64,NULL,'',' '||FA64)||DECODE(FA65,NULL,'',' '||FA65)"
                        strExc(0) = "SELECT " & strExc(1) & " FROM SERVICEPRACTICE,FAGENT WHERE SP01='" & m_MySt(1) & "' AND " & _
                                    "SP02='" & m_MySt(2) & "' AND SP03='" & m_MySt(3) & "' AND SP04='" & m_MySt(4) & "' " & _
                                    " AND SUBSTR(SP26,1,8)=FA01(+) AND SUBSTR(SP26,9,1)=FA02(+)"
                     Case "日"
                        strExc(1) = "FA06"
                        strExc(0) = "SELECT " & strExc(1) & " FROM SERVICEPRACTICE,FAGENT WHERE SP01='" & m_MySt(1) & "' AND " & _
                                    "SP02='" & m_MySt(2) & "' AND SP03='" & m_MySt(3) & "' AND SP04='" & m_MySt(4) & "' " & _
                                    " AND SUBSTR(SP26,1,8)=FA01(+) AND SUBSTR(TM44,9,1)=FA02(+)"
                     Case Else
                        strExc(0) = "SELECT " & Tmp(1) & " FROM SERVICEPRACTICE WHERE SP01='" & m_MySt(1) & "' AND " & _
                                    "SP02='" & m_MySt(2) & "' AND SP03='" & m_MySt(3) & "' AND SP04='" & m_MySt(4) & "' "
                  End Select
               'add end
               Case Else
                  strExc(0) = "SELECT " & Tmp(1) & " FROM SERVICEPRACTICE WHERE SP01='" & m_MySt(1) & "' AND " & _
                     "SP02='" & m_MySt(2) & "' AND SP03='" & m_MySt(3) & "' AND SP04='" & m_MySt(4) & "'"
            End Select
            
         ' 國內專利公報檔
         Case "TPBULLETIN"
            strExc(0) = "SELECT " & Tmp(1) & " FROM TPBULLETIN,PATENT WHERE " & PaSt & _
               " AND TPB01=PA11"
        'Add By Cheng 2003/08/05
         ' 國內專利公開公報檔
         Case "TPGAZETTE"
            strExc(0) = "SELECT " & Tmp(1) & " FROM TPGAZETTE,PATENT WHERE " & PaSt & _
               " AND TPG01=PA11"
         'Add By Sindy 2011/6/28
         ' 顧問基本檔
         Case "HIRECASE"
            Select Case Tmp(1)
               Case "HC05", "HC24", "HC25", "HC26", "HC27"
                  Select Case strOther
                     Case "CU04"
                        strExc(1) = "CU04"
                     Case "CU05"
                        strExc(1) = "CU05"
                     '英文名稱串連
                     Case "CU05CU88CU89CU90"
                        strExc(1) = "CU05||DECODE(CU88,NULL,'',' '||CU88)||DECODE(CU89,NULL,'',' '||CU89)||DECODE(CU90,NULL,'',' '||CU90)"
                     Case "CU06"
                        strExc(1) = "CU06"
                     Case "CU11"
                        strExc(1) = "CU11"
                     Case "CU15"
                        'Modify By Sindy 2012/5/24
                        'strExc(1) = "DECODE(CU15,'0','台端','貴公司')"
                        strExc(1) = "DECODE(CU15,'0','台端','1','貴公司','貴單位')"
                     Case "CU16"
                        'Modified by Morgan 2023/11/29 先抓接洽人
                        'strExc(1) = "'TEL：'||CU16||DECODE(CU17,NULL,'',','||CU17)"
                        strExc(1) = "'TEL：'||NVL(PCC30,CU16||DECODE(CU17,NULL,'',','||CU17))"
                        'end 2023/11/29
                     Case "CU18"
                        'Modified by Morgan 2023/11/29 先抓接洽人
                        'strExc(1) = "'　FAX：'||CU18||DECODE(CU19,NULL,'',','||CU19)"
                        strExc(1) = "'　FAX：'||NVL(PCC31,CU18||DECODE(CU19,NULL,'',','||CU19))"
                        'end 2023/11/289
                     Case "CU00"
                        strExc(1) = "DECODE(CU15,'0',DECODE(SUBSTR(CU11,2,1),'1','先生','2','小姐'),'')"
                     '聯絡地址郵遞區號
                     Case "CU30"
                        strExc(1) = "Decode(CU80,Null,CU30,CU80)"
                     Case "CU31"
                        strExc(1) = "Decode(CU80,Null,CU31,'')"
                     Case Else
                        '直接設定所傳入的欄位名稱
                         strExc(1) = strOther
                  End Select
                  'Modified by Morgan 2023/11/29 +接洽人
                  'strExc(0) = "SELECT " & strExc(1) & " FROM HIRECASE,CUSTOMER WHERE " & HcSt & _
                     " AND SUBSTR(" & Tmp(1) & ",1,8)=CU01(+) AND SUBSTR(" & Tmp(1) & ",9,1)=CU02(+)"
                  strExc(0) = "SELECT " & strExc(1) & " FROM HIRECASE,CUSTOMER,potcustcont WHERE " & HcSt & _
                     " AND SUBSTR(" & Tmp(1) & ",1,8)=CU01(+) AND SUBSTR(" & Tmp(1) & ",9,1)=CU02(+)" & _
                     " and pcc01(+)=cu01 and pcc02(+)=nvl(hc23,cu127)"
                  'end 2023/11/29
               Case Else
                  strExc(0) = "SELECT " & Tmp(1) & " FROM HIRECASE WHERE " & HcSt
            End Select
         ' 法務基本檔
         Case "LAWCASE"
            Select Case Tmp(1)
               Case "LC11", "LC43", "LC44", "LC45", "LC46"
                  Select Case strOther
                     Case "CU04"
                        strExc(1) = "CU04"
                     Case "CU05"
                        strExc(1) = "CU05"
                     '英文名稱串連
                     Case "CU05CU88CU89CU90"
                        strExc(1) = "CU05||DECODE(CU88,NULL,'',' '||CU88)||DECODE(CU89,NULL,'',' '||CU89)||DECODE(CU90,NULL,'',' '||CU90)"
                     Case "CU06"
                        strExc(1) = "CU06"
                     Case "CU11"
                        strExc(1) = "CU11"
                     Case "CU15"
                        'Modify By Sindy 2012/5/24
                        'strExc(1) = "DECODE(CU15,'0','台端','貴公司')"
                        strExc(1) = "DECODE(CU15,'0','台端','1','貴公司','貴單位')"
                     Case "CU16"
                        'Modified by Morgan 2023/11/29 先抓接洽人
                        'strExc(1) = "'TEL：'||CU16||DECODE(CU17,NULL,'',','||CU17)"
                        strExc(1) = "'TEL：'||NVL(PCC30,CU16||DECODE(CU17,NULL,'',','||CU17))"
                        'end 2023/11/29
                     Case "CU18"
                        'Modified by Morgan 2023/11/29 先抓接洽人
                        strExc(1) = "'　FAX：'||CU18||DECODE(CU19,NULL,'',','||CU19)"
                        strExc(1) = "'　FAX：'||NVL(PCC31,CU18||DECODE(CU19,NULL,'',','||CU19))"
                        'end 2023/11/29
                     Case "CU00"
                        strExc(1) = "DECODE(CU15,'0',DECODE(SUBSTR(CU11,2,1),'1','先生','2','小姐'),'')"
                     '聯絡地址郵遞區號
                     Case "CU30"
                        strExc(1) = "Decode(CU80,Null,CU30,CU80)"
                     Case "CU31"
                        strExc(1) = "Decode(CU80,Null,CU31,'')"
                     Case Else
                        '直接設定所傳入的欄位名稱
                         strExc(1) = strOther
                  End Select
                  'Modified by Morgan 2023/11/29 +potcustcont
                  strExc(0) = "SELECT " & strExc(1) & " FROM LAWCASE,CUSTOMER,potcustcont WHERE " & LcSt & _
                     " AND SUBSTR(" & Tmp(1) & ",1,8)=CU01(+) AND SUBSTR(" & Tmp(1) & ",9,1)=CU02(+)" & _
                     " and pcc01(+)=cu01 and pcc02(+)=nvl(lc42,cu127)"
                  'end 2023/11/29
               '相關國家
               Case "LC15"
                  Select Case strOther
                     Case "NA03"
                        strExc(1) = "NA03"
                     Case "NA04"
                        strExc(1) = "NA04"
                     Case Else
                        strExc(1) = "NA03"
                  End Select
                  strExc(0) = "SELECT " & strExc(1) & " FROM LAWCASE,NATION WHERE " & LcSt & _
                     " AND SP09=NA01(+)"
               Case Else
                  strExc(0) = "SELECT " & Tmp(1) & " FROM LAWCASE WHERE " & LcSt
            End Select
         ' 商標基本檔
         Case "TRADEMARK"
            Select Case Tmp(1)
               'edit by nickc 2007/03/01
               'Case "TM23"
               Case "TM23", "TM78", "TM79", "TM80", "TM81"
                  Select Case strOther
                     Case "CU04"
                           strExc(1) = "CU04"
                     'Added by Lydia 2019/07/10 對智慧局文件要+國籍(阿蓮: 修法後一直用人工修改); 商標保持用大陸地區
                     Case "CU04外商國名"
                     'Memo by Lydia 2019/07/11 遵照桂所長指示：台灣案申請書之申請人名稱欄，國外客戶之國籍標示方式統一 ; 在國籍xx商與申請人名稱之間 , 固定都加•區隔
                                        '因為外商日文組所有的申請書皆以下列方式表示(例：日商．黛怡茜股份有限公司)，皆是由客戶指示標示的方式，偶有客戶（約1%）會要求不加一點， 蓋因日商後有無一點，有些代理人非常的在意
                           'Modified by Lydia 2019/08/05 ８月份有收到智慧局行文於七月討論結果，決定外商後不再加點或空格，並於８月１日開始施行。
                           'strExc(1) = "decode(cu10||cu15,'0201','大陸地區．',decode(cu15,'1',nvl(NA81,'')||'．',''))||CU04"
                           'Modified by Lydia 2019/08/29 大陸改成大陸商;FCT和T的自然人+XX籍(紙本)
                           'strExc(1) = "decode(cu10||cu15,'0201','大陸地區．',decode(cu15,'1',nvl(NA81,''),''))||CU04"
                           strExc(1) = "DECODE(CU15,0,SUBSTR(NA81,1,LENGTH(NA81)-1)||'籍',1,NA81,NULL)||CU04"
                     'Modify By Cheng 2003/01/03
                     Case "CU05"
'                        strExc(1) = "CU05||DECODE(CU88,NULL,'',' '||CU88)||DECODE(CU89,NULL,'',' '||CU89)||DECODE(CU90,NULL,'',' '||CU90)"
                         strExc(1) = "CU05"
                     'Add By Cheng 2003/01/15
                     '英文名稱串連
                     Case "CU05CU88CU89CU90"
                        strExc(1) = "CU05||DECODE(CU88,NULL,'',' '||CU88)||DECODE(CU89,NULL,'',' '||CU89)||DECODE(CU90,NULL,'',' '||CU90)"
                     Case "CU06"
                        strExc(1) = "CU06"
                     Case "CU15"
                        'Modify By Sindy 2012/5/24
                        'strExc(1) = "DECODE(CU15,'0','台端','貴公司')"
                        strExc(1) = "DECODE(CU15,'0','台端','1','貴公司','貴單位')"
                     'Add By Cheng 2002/06/12
                     Case "CU16"
                        'Modified by Morgan 2023/11/29 先抓接洽人
                        'strExc(1) = "'TEL：'||CU16||DECODE(CU17,NULL,'',','||CU17)"
                        strExc(1) = "'TEL：'||nvl(PCC30,CU16||DECODE(CU17,NULL,'',','||CU17))"
                        'end 2023/11/29
                     Case "CU18"
                        'Modified by Morgan 2023/11/29 先抓接洽人
                        'strExc(1) = "'　FAX：'||CU18||DECODE(CU19,NULL,'',','||CU19)"
                        strExc(1) = "'　FAX：'||nvl(PCC31,CU18||DECODE(CU19,NULL,'',','||CU19))"
                        'end 2023/11/29
                     Case "CU00"
                        strExc(1) = "DECODE(CU15,'0',DECODE(SUBSTR(CU11,2,1),'1','先生','2','小姐'),'')"
                     'Add By Cheng 2003/01/07
                     '聯絡地址郵遞區號
                     Case "CU30"
'                        'Modify By Cheng 2003/05/06
'                        strExc(1) = "CU30"
                        strExc(1) = "Decode(CU80,Null,CU30,CU80)"
                     Case "CU31"
                        'Modify By Cheng 2003/05/06
'                        strExc(1) = "CU31"
                        strExc(1) = "Decode(CU80,Null,CU31,'')"
                    Case Else
                        'Modify By Cheng 2003/01/10
'                        strExc(1) = "CU04"
                        strExc(1) = strOther
                  End Select
                  'edit by nickc 2007/03/01
                  'strExc(0) = "SELECT " & strExc(1) & " FROM TRADEMARK,CUSTOMER WHERE " & TmSt & _
                     " AND SUBSTR(TM23,1,8)=CU01(+) AND SUBSTR(TM23,9,1)=CU02(+)"
                  'Add By Sindy 2015/1/29
'                  strExc(0) = "SELECT " & strExc(1) & " FROM TRADEMARK,CUSTOMER WHERE " & TmSt & _
'                     " AND SUBSTR(" & Tmp(1) & ",1,8)=CU01(+) AND SUBSTR(" & Tmp(1) & ",9,1)=CU02(+)"
                  'Modified by Morgan 2023/11/29 +potcustcont
                  strExc(0) = "SELECT " & strExc(1) & " FROM TRADEMARK,CUSTOMER,nation,potcustcont WHERE " & TmSt & _
                     " AND SUBSTR(" & Tmp(1) & ",1,8)=CU01(+) AND SUBSTR(" & Tmp(1) & ",9,1)=CU02(+) AND CU10=NA01(+)" & _
                     " and pcc01(+)=cu01 and pcc02(+)=nvl(tm123,cu127)"
                  'end 2023/11/29
               'Add By Sindy 2015/1/29 申請地址1,2,3,4,5(中)
               Case "TM24", "TM82", "TM83", "TM84", "TM85"
                  If Tmp(1) = "TM24" Then strAppl = "TM23"
                  If Tmp(1) = "TM82" Then strAppl = "TM78"
                  If Tmp(1) = "TM83" Then strAppl = "TM79"
                  If Tmp(1) = "TM84" Then strAppl = "TM80"
                  If Tmp(1) = "TM85" Then strAppl = "TM81"
                  strExc(1) = strOther
                  If UCase(strOther) = UCase("Na03ChgNumStyle") Then
                     strExc(1) = "decode(sign(instr('000,001,002,003,004,005,006,007,008,009,010',CU10)),1,'台灣',na03)||' '||" & Tmp(1) & ",'" & strOther & "'"
                     strExc(0) = "SELECT " & strExc(1) & " FROM TRADEMARK,CUSTOMER,nation WHERE " & TmSt & _
                        " AND SUBSTR(" & strAppl & ",1,8)=CU01(+) AND SUBSTR(" & strAppl & ",9,1)=CU02(+) AND CU10=NA01(+)"
                  Else
                     strExc(0) = "SELECT " & Tmp(1) & " FROM TRADEMARK WHERE " & TmSt
                  End If
               '2015/1/29 END
               
               'Add By Cheng 2003/01/06
               Case "TM28"
                    strExc(1) = " DECODE(TM28,'1','申請','2','異議','3','評定','4','舉發','') "
                    strExc(0) = "SELECT " & strExc(1) & " FROM TRADEMARK WHERE " & TmSt
                Case "TM44"
                  Select Case strOther
                     Case "中"
                        'edit by nickc 2005/12/27 T 的中文代理人定稿代理人沒有換客戶
                        'strExc(1) = "FA04"
                        strExc(1) = "decode(tm01,'T',nvl(fa04,cu04),FA04)"
                        'add by nickc 2005/12/27 move from
                        strExc(0) = "SELECT " & strExc(1) & " FROM TRADEMARK,FAGENT,customer WHERE " & TmSt & _
                                    " AND SUBSTR(TM44,1,8)=FA01(+) AND SUBSTR(TM44,9,1)=FA02(+) and substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+) "
                     Case "英"
                        strExc(1) = "FA05||DECODE(FA63,NULL,'',' '||FA63)||DECODE(FA64,NULL,'',' '||FA64)||DECODE(FA65,NULL,'',' '||FA65)"
                        'add by nickc 2005/12/27 move from
                        strExc(0) = "SELECT " & strExc(1) & " FROM TRADEMARK,FAGENT WHERE " & TmSt & _
                                    " AND SUBSTR(TM44,1,8)=FA01(+) AND SUBSTR(TM44,9,1)=FA02(+)"
                     Case "日"
                        strExc(1) = "FA06"
                        'add by nickc 2005/12/27 move from
                        strExc(0) = "SELECT " & strExc(1) & " FROM TRADEMARK,FAGENT WHERE " & TmSt & _
                                    " AND SUBSTR(TM44,1,8)=FA01(+) AND SUBSTR(TM44,9,1)=FA02(+)"
                     Case Else
                        strExc(1) = "FA04"
                        'add by nickc 2005/12/27 move from
                        strExc(0) = "SELECT " & strExc(1) & " FROM TRADEMARK,FAGENT WHERE " & TmSt & _
                                    " AND SUBSTR(TM44,1,8)=FA01(+) AND SUBSTR(TM44,9,1)=FA02(+)"
                  End Select
                  'edit by nickc 2005/12/27
                  'strExc(0) = "SELECT " & strExc(1) & " FROM TRADEMARK,FAGENT WHERE " & TmSt & _
                     " AND SUBSTR(TM44,1,8)=FA01(+) AND SUBSTR(TM44,9,1)=FA02(+)"
              ' 申請國家需到國家檔中取得真正的資料
               Case "TM10"
                  Select Case strOther
                     Case "NA03"
                        strExc(1) = "NA03"
                     Case "NA04"
                        strExc(1) = "NA04"
                     Case Else
                        strExc(1) = "NA03"
                  End Select
                  strExc(0) = "SELECT " & strExc(1) & " FROM TRADEMARK,NATION WHERE " & TmSt & _
                     " AND TM10=NA01(+)"
                  '2009/2/24 ADD BY SONIA 區分馬德里案抓法不同
                  If m_MySt(1) = "TF" Then
                     If m_MySt(3) = "0" And m_MySt(4) = "00" Then
                        'Modify By Sindy 2010/5/18
                        'strExc(0) = "SELECT '' FROM DUAL"
                        DoChange = ""
                        Exit Function
                        '2010/5/18 End
                     Else
                        strExc(0) = "SELECT '（'||" & strExc(1) & "||'）' FROM TRADEMARK,NATION WHERE " & TmSt & _
                           " AND TM10=NA01(+)"
                     End If
                  End If
                  '2009/2/24 END
               'Add By Sindy 2025/9/17 tm05 ==> nvl(tm131,tm05) 有定稿商標名稱時,則抓此欄位值顯示,無時,就用TM05
               Case "TM05"
                  If m_FinalSty = "90" Then '申請書維持抓TM05
                     strExc(0) = "SELECT tm05 FROM TRADEMARK WHERE " & TmSt
                  Else
                     strExc(0) = "SELECT nvl(tm131,tm05) FROM TRADEMARK WHERE " & TmSt
                  End If
               '2025/9/17 END
               Case Else
                  strExc(0) = "SELECT " & Tmp(1) & " FROM TRADEMARK WHERE " & TmSt
            End Select
         ' 商標公報檔
         Case "TMBULLETIN"
'            strExc(0) = "SELECT " & Tmp(1) & " FROM TMBULLETINMASTER WHERE " & TmSt
         
         'Add By Sindy 2014/11/24
         ' 專利案發明人檔
         Case "PATENTINVENTOR"
         '2014/11/24 END
         
         ' 其它
         Case Else
            DoChange = ""
            Exit Function
      End Select
   
   Tmp(4) = "": Tmp(5) = ""
   intI = 1
   Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
   If intI = 1 Then
      If DoLoop = False Then
         If IsNull(RsTemp.Fields(0).Value) = False Then
            Tmp(4) = RsTemp.Fields(0).Value
            'Add By Sindy 2015/1/29 檢查是否有要數字全型換半型
            If InStr(UCase(strExc(1)), UCase("ChgNumStyle")) > 0 Then
               Tmp(4) = PUB_ChgNumeralStyle(Tmp(4))
               'Modify by Sindy 2022/4/14 除去地址前面的郵遞區號
               Dim strTempAddr As String
               If Tmp(4) <> "" And Left(Tmp(4), 2) = "台灣" Then
                  strTempAddr = Trim(Mid(Tmp(4), 3))
                  Do While (Left(strTempAddr, 1) >= "１" And Left(strTempAddr, 1) <= "９") Or (Left(strTempAddr, 1) >= "1" And Left(strTempAddr, 1) <= "9")
                     strTempAddr = Mid(strTempAddr, 2)
                  Loop
                  Tmp(4) = "台灣 " & strTempAddr
               End If
               '2022/4/14 END
            End If
            '2015/1/29 END
         End If
      Else
         Do While Not RsTemp.EOF
            If IsNull(RsTemp.Fields(0).Value) = False Then
                'Modify By Cheng 2003/01/02
                'Mofieid by Morgan 2015/10/22 +PD08
                If Tmp(1) = "PD05" Or Tmp(1) = "PD06" Or Tmp(1) = "PD07" Or Tmp(1) = "PD08" Then
                     'Modify by Morgan 2007/9/21 控制國家重複只印一次 --玲玲
                     If Tmp(1) = "PD07" Then
                        'Modified by Morgan 2015/8/5 多個國家時都要印否則會與優先權日號對不上
                        'If Tmp(5) <> "" & RsTemp.Fields(0).Value Then
                           Tmp(5) = RsTemp.Fields(0).Value
                           '對於多筆記錄以'; '來連起來
                           Tmp(4) = Tmp(4) & "; " & RsTemp.Fields(0).Value
                        'End If
                        'end 2015/8/5
                     Else
                        '對於多筆記錄以'; '來連起來
                        Tmp(4) = Tmp(4) & "; " & RsTemp.Fields(0).Value
                     End If
                Else
                   'Modified by Lydia 2015/04/10 申請人同一國家可有多筆ID, 故必須掃過所有符合條件的記錄
                    If strOther = "AFID03" Then
                      Tmp(4) = Tmp(4) & "、" & RsTemp.Fields(0).Value
                    Else
                    'end 2015/04/10
                      ' 對於多筆記錄以','來連起來
                      Tmp(4) = Tmp(4) & "," & RsTemp.Fields(0).Value
                    End If
                End If
            End If
            RsTemp.MoveNext
         Loop
         
         'Added by Morgan 2015/8/5
         '優先權國家全部相同印一次
         If Tmp(1) = "PD07" Then
            If Trim(Replace(Replace(Tmp(4), Tmp(5), ""), ";", "")) = "" Then
               Tmp(4) = Tmp(5)
            End If
         End If
         'end 2015/8/5
         
        'Add By Cheng 2003/01/02
         If Left(Tmp(4), 2) = "; " Then Tmp(4) = Right(Tmp(4), Len(Tmp(4)) - 2)
         If Left(Tmp(4), 1) = "," Then Tmp(4) = Right(Tmp(4), Len(Tmp(4)) - 1)
         If Left(Tmp(4), 1) = "、" Then Tmp(4) = Right(Tmp(4), Len(Tmp(4)) - 1) 'Modified by Lydia 2015/04/10
         If m_MySt(1) = "FCT" And Tmp(4) = "" Then Tmp(4) = "None"
      End If
   End If
   
   ' 特殊例外的狀況
   Select Case Tmp(1)
      'Add By Sindy 2014/11/21
      ' 專利案發明人檔
      Case "PI06"
         If InStr(strOther, "!") = 0 Then
            strCol = strOther
         Else
            varPI06 = Split(strOther, "!")
            strCol = varPI06(0)
         End If
         strCol = Replace(strCol, "IN", ",IN")
         strCol = Mid(strCol, 2)
         
         'Add By Sindy 2016/10/18 英文名稱是第幾個欄位
         intIN05 = 0: bolHadIN05 = False
         varTemp = Split(strCol, ",")
         For ii = 0 To UBound(varTemp)
            If varTemp(ii) = "IN05" Then
               bolHadIN05 = True
               intIN05 = ii
               Exit For
            End If
         Next ii
         '2016/10/18 END
         
         Tmp(4) = "": strExc(10) = 0
         'IN05:無英文抓日文,無日文抓中文
         'Modify By Sindy 2016/10/18 + ,na03,nvl(in05,'') as chkIN05
         'modify by Sindy 2019/4/25 無日文抓英文,無英文抓中文
         strSql = "SELECT " & IIf(UCase(strCol) = "IN05", "NVL(NVL(IN05,IN06),IN04)", IIf(UCase(strCol) = "IN06", "NVL(NVL(IN06,IN05),IN04)", UCase(strCol))) & ",na03,nvl(in05,'') as chkIN05 FROM PATENTINVENTOR,INVENTOR,Nation" & _
                  " WHERE Pi01='" & m_MySt(1) & "' AND Pi02='" & m_MySt(2) & "' AND Pi03='" & m_MySt(3) & "' AND Pi04='" & m_MySt(4) & "'" & _
                  " AND SUBSTR(pi06,1,8)=IN01(+) AND SUBSTR(pi06,9,2)=IN02(+) AND in11=na01(+)" & _
                  " order by pi05 asc"
         Set rsA = New ADODB.Recordset
         rsA.CursorLocation = adUseClient
         rsA.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
         If rsA.RecordCount > 0 Then
            rsA.MoveFirst
            Do While Not rsA.EOF
               strExc(10) = strExc(10) + 1
               'Modify By Sindy 2016/10/18
               For ii = 0 To UBound(Split(strCol, ","))
                  strText = Trim("" & rsA.Fields(ii))
                  
                  'Add By Sindy 2016/10/18 英文名稱要特別處理
                  If m_MySt(1) = "FCP" Then
                     If intIN05 = ii And "" & rsA.Fields("chkIN05") <> "" And bolHadIN05 = True Then
                        'Modify By Sindy 2016/11/10 敏莉說名有太多輸入狀況,全部都轉大寫好了
                        strText = UCase(strText)
'                        '姓:全部大寫
'                        '名:第一個字大寫其他全部小寫
'                        'If "" & rsA.Fields("na03") <> "日本" Then
'                           varTemp = Split(strText, ",")
'                           If InStr(strText, ",") > 0 Then
'                              strText = UCase(Trim(varTemp(0))) & ", " & StrConv(Trim(varTemp(1)), vbProperCase)
'                           End If
'                        'End If
                     End If
                  End If
                  '2016/10/18 END
                  
                  If strText <> "" Then
                     '全部串在一起
                     If InStr(strOther, "!") = 0 And InStr(strOther, "/") = 0 Then
                        Tmp(4) = Tmp(4) & strText
                     '要換行
                     Else
                        'Add By Sindy 2018/5/28 中文時才加英文 P-02-000-32
                        If PUB_ChkIsFMP(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4)) = True Then
                           If strCol = "IN04" Then 'Add By Sindy 2018/6/6 P-08-000-52
                              If InStr(rsA.Fields(ii), ",") > 0 Then
                                 varTemp = Split(Trim(rsA.Fields(ii)), ",")
                                 strText = varTemp(1) & " " & varTemp(0) & "/"
                              End If
                              '英文名稱
                              If Trim("" & rsA.Fields("chkIN05")) <> "" Then
                                 strText = strText & rsA.Fields("chkIN05")
                              End If
                              If rsA.RecordCount > 1 Then
                                 strText = strExc(10) & "." & strText
                              End If
                           End If
                        End If
                        '2018/5/28 END
                        If Tmp(4) = "" Then '第一筆
                           Tmp(4) = strText
                           If m_MySt(1) = "CFP" Then
                              Tmp(4) = Tmp(4) & " (??? is the surname)"
                           End If
                        Else
                           Tmp(4) = Tmp(4) & vbCrLf
                           If Val(Mid(varPI06(1), 2)) > 0 Then
                              For jj = 1 To Val(Mid(varPI06(1), 2))
                                 Tmp(4) = Tmp(4) & "　"
                              Next jj
                           End If
                           Tmp(4) = Tmp(4) & strText
                        End If
                     End If
                  End If
               Next ii
               '2016/10/18 END
               rsA.MoveNext
            Loop
         End If
         rsA.Close
         Set rsA = Nothing
      '2014/11/21 END
      Case "PA72" '判斷第幾次付款
'         Dim strSql As String
         Dim rsTmp As ADODB.Recordset
         Dim strPA08 As String
         Dim strPA09 As String
         Dim strPA72 As String
         Dim strKey(5) As String
         Dim strCaseFee(1 To 2) As String
         Dim bFind As Boolean
         Dim varPA72 As Variant
         Dim varRef As Variant
         ' 取得資料
         Tmp(4) = "0"
         If IsEmptyText(m_CP01) = False And IsEmptyText(m_CP02) = False And IsEmptyText(m_CP03) = False And IsEmptyText(m_CP04) = False Then
            bFind = False
            ' 先取得PATENT的相關資料
            strSql = "SELECT PA08,PA09,PA72 FROM PATENT " & _
                     "WHERE PA01 = '" & m_CP01 & "' AND " & _
                           "PA02 = '" & m_CP02 & "' AND " & _
                           "PA03 = '" & m_CP03 & "' AND " & _
                           "PA04 = '" & m_CP04 & "' "
            Set rsTmp = New ADODB.Recordset
            rsTmp.CursorLocation = adUseClient
            rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
            If rsTmp.RecordCount > 0 Then
               bFind = True
               If IsNull(rsTmp.Fields("PA08")) = False Then strPA08 = rsTmp.Fields("PA08")
               If IsNull(rsTmp.Fields("PA09")) = False Then strPA09 = rsTmp.Fields("PA09")
               If IsNull(rsTmp.Fields("PA72")) = False Then strPA72 = rsTmp.Fields("PA72")
            End If
            rsTmp.Close
            Set rsTmp = Nothing
                        
            If bFind Then
               strKey(0) = m_CP09
               strKey(1) = m_CP01
               strKey(2) = m_CP02
               strKey(3) = m_CP03
               strKey(4) = m_CP04
               bFind = GetMoneyDate(strPA08, strPA09, strKey, strCaseFee(1), strCaseFee(2))
               If bFind Then
                  Dim nPos As Integer
                  ' 尋找下次繳年費的位置
                  If IsEmptyText(strPA72) = False Then
                     varPA72 = Split(strPA72, ",")
                     For nPos = 0 To UBound(varPA72)
                        If IsEmptyText(varPA72(nPos)) = True Then
                           nPos = nPos - 1
                           Exit For
                        End If
                     Next nPos
                     If IsEmptyText(varPA72(UBound(varPA72))) = False Then
                        nPos = UBound(varPA72)
                     End If
                     If nPos < 0 Then
                        nPos = 0
                     End If
                  Else
                     nPos = 0
                  End If
                  ' 目前所取得的nPos即是下次繳年費的位置
                  
                  ' 取得正確的年度
                  If IsEmptyText(strCaseFee(2)) = False Then
                     varRef = Split(strCaseFee(2), ",")
                     If nPos <= UBound(varRef) Then
                        Tmp(4) = varRef(nPos)
                     End If
                  End If
               End If
            End If
         End If
         
         'Dim varTmp As Variant
         'varTmp = Split(Tmp(4), ",")
         ''***************************
         ''nick 900821
         ''Tmp(4) = Format(UBound(varTmp) + 1)
         'Dim ff As Integer
         'For ff = 0 To UBound(varTmp)
         '   If Len(varTmp(ff)) = 0 Then
         '      Tmp(4) = ff + 1
         '      Exit For
         '   End If
         'Next ff
         ''***************************
      Case "CP12", "ST02"
         If m_Copys > 1 And m_CopysCount = 1 Then Tmp(4) = ""
      Case "NP07"
         If m_Copys > 1 And m_CopysCount = 1 Then
            Tmp(4) = ""
         Else
            Tmp(4) = "下一程序 : " & Tmp(4)
         End If
      Case "PA26", "PA27", "PA28", "PA29", "PA30"
          'Modified by Lydia 2014/12/23 領証及年費的申請書若其申請人超過1位,則在申請人前面加序號
          'Modify by Lydia 2014/12/30 序號後加半形句點和空白一格
         If m_MySt(1) = "FCP" And m_FinalSty = "01" And m_Situ = "12" Then
           If Tmp(1) = "PA26" Then
                StrSQLa = "SELECT * FROM PATENT WHERE " & PaSt & " And PA27 Is Not NULL "
                rsA.CursorLocation = adUseClient
                rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
            '若有第二個人申請人時
                If rsA.RecordCount > 0 Then
                    If Not IsEmptyText(Tmp(4)) Then Tmp(4) = "１. " & Tmp(4) & "　"
                '若無第二個申請人時
                Else
                    If Not IsEmptyText(Tmp(4)) Then Tmp(4) = "" & Tmp(4) & "　"
                End If
           
           ElseIf Tmp(1) = "PA27" And Not IsEmptyText(Tmp(4)) Then Tmp(4) = "２. " & Tmp(4) & "　"
           ElseIf Tmp(1) = "PA28" And Not IsEmptyText(Tmp(4)) Then Tmp(4) = "３. " & Tmp(4) & "　"
           ElseIf Tmp(1) = "PA29" And Not IsEmptyText(Tmp(4)) Then Tmp(4) = "４. " & Tmp(4) & "　"
           ElseIf Tmp(1) = "PA30" And Not IsEmptyText(Tmp(4)) Then Tmp(4) = "５. " & Tmp(4) & "　"
           End If
          'end 2014/12/23
         ElseIf (strOther = "CU04" Or strOther = "CU06") Then
            Tmp(4) = Tmp(4) & " "
         ElseIf (strOther = "CU05" Or strOther = "CU88" Or strOther = "CU89" Or strOther = "CU90") Then
            Tmp(4) = Tmp(4) & " "
         'Modified by Lydia 2015/04/10 申請人同一國家可有多筆ID(識別番號)
         ElseIf strOther = "AFID03" Then
               If Len(Trim(Tmp(4))) > 0 Then
                  'Modified by Morgan 2021/5/4
                  'Tmp(4) = "  " & "識別番號: " & Tmp(4)
                  If m_MySt(6) = "011" Then
                     Tmp(4) = "  " & "識別番號: " & Tmp(4)
                  Else
                     Tmp(4) = "  " & "Code No.: " & Tmp(4)
                  End If
               End If
         'end 2015/04/10
         End If

      ' MIDIFY BY SONIA 90.10.6
      Case "PA31", "PA32", "PA33", "PA34"
         Tmp(4) = Tmp(4) & "　"
      ' 90.08.27 modify by louis (代表人要加上數字)
      'Modify by Lydia 2014/12/30 序號後加半形句點和空白一格
      Case "PA79":
            StrSQLa = "SELECT * FROM PATENT WHERE " & PaSt & " And PA27 Is Not NULL "
            
            rsA.CursorLocation = adUseClient
            rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
            '若有第二個人申請人時
            If rsA.RecordCount > 0 Then
                If Not IsEmptyText(Tmp(4)) Then Tmp(4) = "１. " & Tmp(4)
            '若無第二個申請人時
            Else
                If Not IsEmptyText(Tmp(4)) Then Tmp(4) = "" & Tmp(4)
            End If
            If rsA.State <> adStateClosed Then rsA.Close
            Set rsA = Nothing
      Case "PA109":
         If Not IsEmptyText(Tmp(4)) Then Tmp(4) = "２. " & Tmp(4)
      Case "PA115":
         If Not IsEmptyText(Tmp(4)) Then Tmp(4) = "３. " & Tmp(4)
      Case "PA121":
         If Not IsEmptyText(Tmp(4)) Then Tmp(4) = "４. " & Tmp(4)
      Case "PA126":
         If Not IsEmptyText(Tmp(4)) Then Tmp(4) = "５. " & Tmp(4)
      'end 'Modify by Lydia 2014/12/30
      Case "PA82", "PA112", "PA118", "PA124", "PA129":
            'Modify By Cheng 2003/02/13
            '若為第一個申請人的第二個代表人
            If Tmp(1) = "PA82" Then
                StrSQLa = "SELECT * FROM PATENT WHERE " & PaSt & " And PA27 Is Not NULL "
                rsA.CursorLocation = adUseClient
                rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
                '若有第二個人申請人時
                If rsA.RecordCount > 0 Then
                    If Not IsEmptyText(Tmp(4)) Then Tmp(4) = "　" & Tmp(4)
                '若無第二個申請人時
                Else
                    If Not IsEmptyText(Tmp(4)) Then Tmp(4) = "" & Tmp(4)
                End If
                If rsA.State <> adStateClosed Then rsA.Close
                Set rsA = Nothing
            '其他代表人
            Else
                 If Not IsEmptyText(Tmp(4)) Then Tmp(4) = "　" & Tmp(4)
            End If
        'Add By Cheng 2003/03/10
        '商標基本檔的代表人1(英)
      Case "TM48":
            StrSQLa = "SELECT * FROM TRADEMARK WHERE " & TmSt & " And TM51 Is Not NULL "
            rsA.CursorLocation = adUseClient
            rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
            '若有代表人2時
            If rsA.RecordCount > 0 Then
                If Not IsEmptyText(Tmp(4)) Then Tmp(4) = "1." & Tmp(4)
            '若無代表人2時
            Else
                If Not IsEmptyText(Tmp(4)) Then Tmp(4) = "" & Tmp(4)
            End If
            If rsA.State <> adStateClosed Then rsA.Close
            Set rsA = Nothing
        '商標基本檔的代表人2(英)
      Case "TM51":
         If Not IsEmptyText(Tmp(4)) Then Tmp(4) = "2." & Tmp(4)
      

      Case Else
   End Select
   DoChange = Tmp(4)
   Exit Function
'Err:
'   MsgBox Err.Description
End Function

' 取得欄位的內容
Private Function GetField(ByVal strData As String) As String
 Dim strTmp As String, i As Integer
   strTmp = strData
   i = InStr(strTmp, "!")
   If i > 0 Then
      strData = Left(strTmp, i - 1)
      strTmp = UCase(Mid(strTmp, i + 1))
   End If
   ' 檢查此欄位名稱是否為一般資料庫所使用的欄位還是例外條件欄位
   If IsTaieDBField(strData) = False Then
      ' 例外條件欄位
      GetField = ExceptFieldData(strData)
   Else
      ' 欄位名稱是否為一般資料庫所使用的欄位
      GetField = DoChange(strData, strTmp)
   End If
End Function

' 解譯文件內容
Private Function Parser(ByVal strData As String) As String
   'Modified by Morgan 2024/3/14 位置會超過int上限,都改long
   Dim nLength As String            ' 字串長度
   Dim bConvert As Boolean          ' 是否繼續轉換
   Dim nLeftBrace As Long        ' 左方小括弧的位置
   Dim nRightBrace As Long       ' 右方小括弧的位置
   Dim strKeyWord As String         ' 轉換或運算的指令
   Dim strField As String           ' 轉換或運算後的欄位內容
   Dim strValue As String           ' 轉換或運算所需的參數
   Dim nLeftBracket As Long      ' 左方大括弧的位置
   Dim nRightBracket As Long     ' 右方大括弧的位置
   Dim nPrevBracket As Long      ' 前次右方大括弧的位置
   Dim nBracket As Long          ' 大括弧的計數
   Dim strTemp As String            ' 暫存用字串
   Dim strTemp2 As String            ' 暫存用字串2
   Dim nCount As Long            ' 計數器
   Dim nRightTmp As Long         ' 暫存用字串
   Dim strSamp  As String           ' 業務區的字串
    'Add By Cheng 2002/12/30
    Dim ii As Long
    Dim strSpecChr As String
    Dim strNewPage As String
   
   'Add by Morgan 2003/12/26
   '解析文件中所有資料庫欄位
   Dim stField As String, stFields As String, lngPos As Long, arrFields() As String, strTmp As String
   Dim strSql As String, rsQuery As New ADODB.Recordset, lngIdx As Long, bolExcept As Boolean
   Dim strTmp1 As String, strTmp3 As String
   Dim iStart As Long '搜尋起始位置 Added by Morgan 2014/3/19
   Dim iPos As Long, iPos2 As Long, iPos3 As Long 'Added by Morgan 2019/1/24
   
On Error GoTo ErrHnd
   
   'Added by Morgan 2020/5/19
   strData = Replace(strData, "[[", Chr(c_DMLSign))  '將[[替換為chr(16)
   strData = Replace(strData, "]]", Chr(c_DMRSign))  '將]]替換為chr(17)
   strData = Replace(strData, "|!", Chr(c_DALSign))  '將|!替換為chr(18)
   strData = Replace(strData, "!|", Chr(c_DARSign))  '將!|替換為chr(19)
   'end 2020/5/19
   
   'Add by Morgan 2004/10/27
   strData = Replace(strData, "[", Chr(c_MLSign))  '將[替換為chr(30)
   strData = Replace(strData, "]", Chr(c_MRSign))  '將[替換為chr(31)
   '2004/10/27 end
   
   'Add by Morgan 2007/11/29
   strData = Replace(strData, "｛", Chr(c_FLLSign))  '將｛替換為chr(24)
   strData = Replace(strData, "｝", Chr(c_FLRSign))  '將｝替換為chr(25)
   strData = Replace(strData, "〔", Chr(c_FMLSign))  '將〔替換為chr(26)
   strData = Replace(strData, "〕", Chr(c_FMRSign))  '將〕替換為chr(27)
   '2007/11/29 end

   stFields = "": lngPos = 1
   
   ' 取得文件內容的長度
      nLength = Len(strData)
      Do While nLength > lngPos
         ' 左括弧的位置
         nLeftBrace = InStr(lngPos, strData, "<")
         ' 右括弧的位置
         nRightBrace = InStr(nLeftBrace + 1, strData, ">")
         ' 若文件中有左括弧及右括弧時
         If nLeftBrace > 0 And nRightBrace > nLeftBrace Then
            ' 取得括弧內的欄位名稱
            stField = Mid(strData, nLeftBrace + 1, nRightBrace - nLeftBrace - 1)
            nLeftBrace = InStr(stField, "!")
            If nLeftBrace > 0 Then
               stField = Left(stField, nLeftBrace - 1)
            End If
            stFields = stFields & "'" & stField & "'" & ","
            lngPos = nRightBrace + 1
         Else
            Exit Do
         End If
      Loop
      
      If Len(stFields) > 0 Then stFields = Left(stFields, Len(stFields) - 1)
      
      Erase arrFields
      ReDim arrFields(0, 2)
      If stFields > "" Then
         strSql = "SELECT FNM01,FNM02,FNM03 FROM FIELDNAMEMAP WHERE FNM02 in (" & stFields & ")"
         rsQuery.CursorLocation = adUseClient
         rsQuery.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
         If rsQuery.RecordCount > 0 Then
            Erase arrFields
            ReDim arrFields(rsQuery.RecordCount - 1, 2)
            rsQuery.MoveFirst
            For lngIdx = 0 To rsQuery.RecordCount - 1
               arrFields(lngIdx, 0) = rsQuery.Fields("FNM01").Value
               arrFields(lngIdx, 1) = rsQuery.Fields("FNM02").Value
               arrFields(lngIdx, 2) = rsQuery.Fields("FNM03").Value
               rsQuery.MoveNext
            Next
         End If
         If rsQuery.State <> adStateClosed Then rsQuery.Close
         Set rsQuery = Nothing
      End If

   'Add end --------------------
   
   ' 90.08.22 modify by louis (預備在第一頁列印時所切割的位置)
   m_SplitPos = 0
   
   bConvert = True
   iStart = 1 'Added by Morgan 2014/3/19
   While bConvert = True
      ' 取得文件內容的長度
      nLength = Len(strData)
      ' 左括弧的位置
      'Modified by Morgan 2014/3/19
      'nLeftBrace = InStr(strData, "<")
      nLeftBrace = InStr(iStart, strData, "<")
      'end 2014/3/19
      ' 右括弧的位置
      'Modified by Morgan 2014/3/19
      'nRightBrace = InStr(strData, ">")
      nRightBrace = InStr(nLeftBrace + 1, strData, ">")
      'end 2014/3/19
      'end 2014/3/19
      ' 若文件中有左括弧及右括弧時
      If nLeftBrace > 0 And nRightBrace > 0 Then
         ' 取得括弧內的欄位名稱
         strField = Mid(strData, nLeftBrace + 1, nRightBrace - nLeftBrace - 1)
         ' 90.08.22 modify by louis (取得該預備第一頁列印的切割位置)
         
         'Modify by Morgan 2003/12/26
'         If strField = "案件進度檔-業務區別" Then
'            m_SplitPos = nLeftBrace - 1
'            strSamp = GetField(strField)
'         End If
'         ' 取得欄位的內容
'         strField = GetField(strField)
         
         If strField = "案件進度檔-業務區別" Then
            m_SplitPos = nLeftBrace - 1
            ' 欄位名稱是否為一般資料庫所使用的欄位
            strSamp = DoChange(strField, strField)
            strField = strSamp
         Else
            ' 檢查此欄位名稱是否為一般資料庫所使用的欄位還是例外條件欄位
            strTmp = strField
            lngPos = InStr(strTmp, "!")
            If lngPos > 0 Then
               strField = Left(strTmp, lngPos - 1)
               strTmp = UCase(Mid(strTmp, lngPos + 1))
            End If
            bolExcept = True
            strTmp1 = "": strTmp3 = ""
            For lngIdx = LBound(arrFields, 1) To UBound(arrFields, 1)
               If strField = arrFields(lngIdx, 1) Then
                  bolExcept = False
                  strTmp1 = arrFields(lngIdx, 0)
                  strTmp3 = arrFields(lngIdx, 2)
                  Exit For
               End If
            Next lngIdx
            
            If bolExcept = True Then
               ' 例外條件欄位
               strField = ExceptFieldData(strField)
            Else
               ' 欄位名稱是否為一般資料庫所使用的欄位
               strField = DoChange(strField, strTmp, strTmp1, strTmp3)
            End If
            
         End If
         
'Modify end-------------------------

        'Add By Cheng 2002/12/30
        '先跳頁再換行, 秩序不要變
        '跳頁
        If UBound(Split(strField, "NewPage")) > 0 Then
            strNewPage = ""
            For ii = 1 To UBound(Split(strField, "NewPage"))
                strNewPage = "" & strNewPage
            Next ii
            strField = Replace(strField, "NewPage", "")
            '換行
            strSpecChr = ""
            If UBound(Split(strField, "vbCrLf")) > 0 Then
                 For ii = 1 To UBound(Split(strField, "vbCrLf"))
                    strSpecChr = vbCrLf & strSpecChr
                 Next ii
                strField = Replace(strField, "vbCrLf", "")
            End If
            strField = strNewPage & strSpecChr & strField
        End If
        
         ' 設定左右兩方的括弧位置
         nLeftBracket = nLeftBrace
         nRightBracket = nRightBrace
         ' 當左括弧位置不為文件內容的第一個字元時
         If nLeftBrace > 1 Then
            nCount = 1
            nPrevBracket = nRightBrace
            Do While Mid(strData, nLeftBrace - nCount, 1) = "{"
               strTemp = Right(strData, nLength - nPrevBracket)
               nRightTmp = InStr(strTemp, "}")
               If nRightTmp > 0 Then
                  ' 文件內容中左方的大括弧位置
                  nLeftBracket = nLeftBrace - nCount
                  ' 文件內容中右方的大括弧位置 = 前一次右方括弧的位置 + 目前在子字串所找尋到右方括弧的位置
                  nRightBracket = nPrevBracket + nRightTmp
                  ' 取得 KeyWord 指令
                  strKeyWord = Mid(strData, nPrevBracket + 1, 1)
                  ' 90.07.24 modify by louis (檢查必須包含運算元及運算子)
                  If nRightBracket - nPrevBracket > 2 Then
                     ' 取得執行KeyWord指令的參數
                     strValue = Mid(strData, nPrevBracket + 2, nRightBracket - nPrevBracket - 2)
                     ' 取得轉換後的欄位內容
                     strField = ParserKeyWord(strKeyWord, strField, strValue)
                  End If
                  ' 設定前次右方括弧的位置
                  nPrevBracket = nRightBracket
               End If
               nCount = nCount + 1
               ' 欲找尋括弧的字元位置小於0
               If nLeftBrace - nCount <= 0 Then
                  Exit Do
               End If
            Loop
         End If
         
         ' 將取得並運算過的欄位內容取代原先的欄位運算字串
         strData = Left(strData, nLeftBracket - 1) & strField & Right(strData, nLength - nRightBracket)
         iStart = nRightBracket + (Len(strData) - nLength) + 1 'Added by Morgan 2014/3/19
         bConvert = True
      Else
         bConvert = False
      End If
   Wend
   
   'Added by Morgan 2020/5/19
   '若[[...]]內有|!...!|時，若|!...!|內為空白時整段不印
   nLeftBrace = InStr(strData, Chr(c_DMLSign))
   Do While nLeftBrace > 0
      nRightBrace = InStr(strData, Chr(c_DMRSign))
      strTemp = Trim(Mid(strData, nLeftBrace + 1, nRightBrace - nLeftBrace - 1))
      '無內容
      If strTemp = "" Then
         '後面是跳行或沒東西
         If Mid(strData, nRightBrace + 1, 2) = vbCrLf Or nRightBrace = Len(strData) Then
            '第一字
            If nLeftBrace = 1 Then
               strData = Mid(strData, nRightBrace + 3)
            ElseIf nLeftBrace > 2 Then
               '前面是跳行
               If Mid(strData, nLeftBrace - 2, 2) = vbCrLf Then
                  strData = Left(strData, nLeftBrace - 3) & Mid(strData, nRightBrace + 1)
               Else
                  strData = Left(strData, nLeftBrace - 1) & Mid(strData, nRightBrace + 1)
               End If
            Else
               strData = Left(strData, nLeftBrace - 1) & Mid(strData, nRightBrace + 1)
            End If
         Else
            strData = Left(strData, nLeftBrace - 1) & Mid(strData, nRightBrace + 1)
         End If
         
      '有內容
      Else
         strTemp = Mid(strData, nLeftBrace + 1, nRightBrace - nLeftBrace - 1)
         iPos2 = InStr(strTemp, Chr(c_DALSign)) '|!
         iPos3 = InStr(strTemp, Chr(c_DARSign)) '!|
         If iPos2 > 0 And iPos3 > iPos2 Then
            strExc(10) = Trim(Mid(strTemp, iPos2 + 1, iPos3 - iPos2 - 1))
            If strExc(10) = "" Then
               '後面是跳行或沒東西
               If Mid(strData, nRightBrace + 1, 2) = vbCrLf Or nRightBrace = Len(strData) Then
                  '第一字
                  If nLeftBrace = 1 Then
                     strData = Mid(strData, nRightBrace + 3)
                  ElseIf nLeftBrace > 2 Then
                     '前面是跳行
                     If Mid(strData, nLeftBrace - 2, 2) = vbCrLf Then
                        strData = Left(strData, nLeftBrace - 3) & Mid(strData, nRightBrace + 1)
                     Else
                        strData = Left(strData, nLeftBrace - 1) & Mid(strData, nRightBrace + 1)
                     End If
                  Else
                     strData = Left(strData, nLeftBrace - 1) & Mid(strData, nRightBrace + 1)
                  End If
               Else
                  strData = Left(strData, nLeftBrace - 1) & Mid(strData, nRightBrace + 1)
               End If
            Else
               If strExc(10) = "♂" Or Replace(strExc(10), "♀", "") = "" Then
                  strData = Left(strData, nLeftBrace - 1) & Replace(strTemp, Chr(c_DALSign) & strExc(10) & Chr(c_DARSign), "") & Mid(strData, nRightBrace + 1)
               Else
                  strData = Left(strData, nLeftBrace - 1) & Replace(Replace(strTemp, Chr(c_DALSign), ""), Chr(c_DARSign), "") & Mid(strData, nRightBrace + 1)
               End If
            End If
         Else
            strData = Left(strData, nLeftBrace - 1) & strTemp & Mid(strData, nRightBrace + 1)
         End If
      End If
      nLeftBrace = InStr(strData, Chr(c_DMLSign))
   Loop
   'end 2020/5/19
   
   '去除空白列
   'Modify by Morgan 2004/10/27 [ 識別符號改chr(30)
   'nLeftBrace = InStr(strData, "[")
   nLeftBrace = InStr(strData, Chr(c_MLSign))
   '2004/10/27 end
   Do While nLeftBrace > 0
      'Modify by Morgan 2004/10/27 [ 識別符號改chr(30)
      'nRightBrace = InStr(strData, "]")
      nRightBrace = InStr(strData, Chr(c_MRSign))
      '2004/10/27 end
      
      strTemp = Trim(Mid(strData, nLeftBrace + 1, nRightBrace - nLeftBrace - 1))
      If strTemp = "" Then
         'Modify by Morgan 2011/8/19 要考慮左括弧是第一個字元的情形,且也要判斷是否為獨立行
         'If InStr(Mid(strData, nLeftBrace - 2), vbCrLf) > 0 Then
         '   strData = Left(strData, nLeftBrace - 3) & Mid(strData, nRightBrace + 1)
         If nLeftBrace = 1 And Mid(strData, nRightBrace + 1, 2) = vbCrLf Then
            strData = Mid(strData, nRightBrace + 3)
         ElseIf nLeftBrace > 2 Then
            If Mid(strData, nLeftBrace - 2, 2) = vbCrLf Then
               strData = Left(strData, nLeftBrace - 3) & Mid(strData, nRightBrace + 1)
            ElseIf Mid(strData, nLeftBrace - 2, 2) = vbCrLf And nRightBrace = Len(strData) Then
               strData = Left(strData, nLeftBrace - 3)
            Else
               strData = Left(strData, nLeftBrace - 1) & Mid(strData, nRightBrace + 1)
            End If
         Else 'Memo by Morgan 2011/8/19 非獨立行
            strData = Left(strData, nLeftBrace - 1) & Mid(strData, nRightBrace + 1)
         'end 2011/8/19
         End If
         
      Else
         'Modify By Cheng 2002/12/27
         '若FCP且非申請書, 前面不加全形空白
         If (m_CP01 = "FCP" Or m_CP01 = "FG" Or m_CP01 = "FCT") And m_FinalSty <> "01" Then
            strTemp2 = ""
         'Added by Lydia 2023/08/08 CFT電子送件申請書比照FCT電子送件申請, 前面不加全形空白  ----CFT申請英文證明書
         ElseIf m_CP01 = "CFT" And m_FinalSty = "90" Then
            strTemp2 = ""
         'end 2023/08/08
         'Added by Morgan 2013/1/14 排除英文定稿(Ex.FMP案)
         ElseIf strPrintType = "4" Then
            strTemp2 = ""
         'end 2013/1/14
         Else
            strTemp2 = "　"
         End If
         
         'Modify by Morgan 2004/10/5
         '若[]內有〔〕時，若〔〕內為空白時整列不印
         'strData = Left(strData, nLeftBrace - 1) & strTemp1 & Mid(strData, nLeftBrace + 1, nRightBrace - nLeftBrace - 1) & Mid(strData, nRightBrace + 1)
         strTemp = Mid(strData, nLeftBrace + 1, nRightBrace - nLeftBrace - 1)
         'Modify by Morgan 2007/11/29
         'If InStr(strTemp, "〔") > 0 Then
         '   If Trim(Mid(strTemp, InStr(strTemp, "〔") + 1, InStr(strTemp, "〕") - InStr(strTemp, "〔") - 1)) = "" Then
         If InStr(strTemp, Chr(c_FMLSign)) > 0 Then
            strExc(10) = Trim(Mid(strTemp, InStr(strTemp, Chr(c_FMLSign)) + 1, InStr(strTemp, Chr(c_FMRSign)) - InStr(strTemp, Chr(c_FMLSign)) - 1))
            If strExc(10) <> "" Then
               iPos = InStr(strTemp, Chr(c_FMRSign)) 'Added by Morgan 2019/1/24
               'Added by Morgan 2018/6/21
               '若[]內也有｛｝時，若｛｝內為♀則整列不印
               If InStr(strTemp, Chr(c_FLLSign)) > 0 Then
                  strExc(9) = Mid(strTemp, InStr(strTemp, Chr(c_FLLSign)) + 1, InStr(strTemp, Chr(c_FLRSign)) - InStr(strTemp, Chr(c_FLLSign)) - 1)
                  If strExc(9) = "♀" Then
                     strExc(10) = ""
                  End If
                  strTemp = Replace(strTemp, Chr(c_FLLSign) & strExc(9) & Chr(c_FLRSign), "")
               'Added by Morgan 2019/1/24
               '若[]內有第2組〔〕時，若〔〕內為空白則整列不印
               ElseIf InStr(iPos + 1, strTemp, Chr(c_FMLSign)) > 0 Then
                  strExc(9) = Mid(strTemp, InStr(iPos + 1, strTemp, Chr(c_FMLSign)) + 1, InStr(iPos + 1, strTemp, Chr(c_FMRSign)) - InStr(iPos + 1, strTemp, Chr(c_FMLSign)) - 1)
                  If strExc(9) = "" Then
                     strExc(10) = ""
                  'Added by Morgan 2019/4/25
                  ElseIf strExc(9) = "♀" Then
                     strTemp = Replace(strTemp, Chr(c_FMLSign) & strExc(9) & Chr(c_FMRSign), "")
                  'end 2019/4/25
                  '非♀
                  ElseIf strExc(9) <> "♀" Then
                     strTemp = Replace(strTemp, Chr(c_FMLSign) & strExc(9) & Chr(c_FMRSign), strExc(9))
                  End If
               'end 2019/1/24
               End If
               'end 2018/6/21
            End If
            
            If strExc(10) = "" Then
         'end 2007/11/29
               'Modify by Morgan 2011/8/19 要考慮左括弧是第一個字元的情形,且也要判斷是否為獨立行
               'If InStr(Mid(strData, nLeftBrace - 2, 2), vbCrLf) > 0 Then
               '   strData = Left(strData, nLeftBrace - 3) & Mid(strData, nRightBrace + 1)
               '第1段
               If nLeftBrace = 1 And Mid(strData, nRightBrace + 1, 2) = vbCrLf Then
                  strData = Mid(strData, nRightBrace + 3)
               ElseIf nLeftBrace > 2 Then
                  '最後1段
                  If Mid(strData, nLeftBrace - 2, 2) = vbCrLf And nRightBrace = Len(strData) Then
                     strData = Left(strData, nLeftBrace - 3)
                  '中間單獨1段
                  ElseIf Mid(strData, nLeftBrace - 2, 2) = vbCrLf And Mid(strData, nRightBrace + 1, 2) = vbCrLf Then
                     strData = Left(strData, nLeftBrace - 3) & Mid(strData, nRightBrace + 1)
                  '非獨立段
                  Else
                     strData = Left(strData, nLeftBrace - 1) & Mid(strData, nRightBrace + 1)
                  End If
               'end 2011/8/19
               '非獨立段(接第二字)
               Else
                  strData = Left(strData, nLeftBrace - 1) & Mid(strData, nRightBrace + 1)
               End If
            Else
               'Modify by Morgan 2005/10/31 改非行首不加全形空白
               'strData = Left(strData, nLeftBrace - 1) & strTemp2 & Replace(Replace(strTemp, "〔", ""), "〕", "") & Mid(strData, nRightBrace + 1)
               'Modify by Morgan 2007/11/29
               'strData = Left(strData, nLeftBrace - 1) & IIf(Left(strTemp, 1) = "　", strTemp2, "") & Replace(Replace(strTemp, "〔", ""), "〕", "") & Mid(strData, nRightBrace + 1)
               'Add by Morgan 2009/8/19 若〔〕內為♂或♀時不印
               'Modify by Morgan 2011/6/23 多個♀視為相同作用
               'If strExc(10) = "♂" Or strExc(10) = "♀" Then
               If strExc(10) = "♂" Or Replace(strExc(10), "♀", "") = "" Then
                  strData = Left(strData, nLeftBrace - 1) & IIf(Left(strTemp, 1) = "　", strTemp2, "") & Replace(strTemp, Chr(c_FMLSign) & strExc(10) & Chr(c_FMRSign), "") & Mid(strData, nRightBrace + 1)
               Else
                  strData = Left(strData, nLeftBrace - 1) & IIf(Left(strTemp, 1) = "　", strTemp2, "") & Replace(Replace(strTemp, Chr(c_FMLSign), ""), Chr(c_FMRSign), "") & Mid(strData, nRightBrace + 1)
               End If
               'end 2007/11/29
            End If
         'Add by Morgan 2007/5/2
         '若[]內有｛｝時，若｛｝內不為空白時只印｛｝內文字
         'Modify by Morgan 2007/11/29
         'ElseIf InStr(strTemp, "｛") > 0 Then
         '   strExc(10) = Trim(Mid(strTemp, InStr(strTemp, "｛") + 1, InStr(strTemp, "｝") - InStr(strTemp, "｛") - 1))
         ElseIf InStr(strTemp, Chr(c_FLLSign)) > 0 Then
            strExc(10) = Mid(strTemp, InStr(strTemp, Chr(c_FLLSign)) + 1, InStr(strTemp, Chr(c_FLRSign)) - InStr(strTemp, Chr(c_FLLSign)) - 1)
         'end 2007/11/29
            '有文字
            If Trim(Replace(strExc(10), vbCrLf, "")) > "" Then
               'Add by Morgan 2009/8/19 若｛｝內為♂或♀時都不印
               'Modify by Morgan 2011/6/23 多個♀視為相同作用
               'If strExc(10) = "♂" Or strExc(10) = "♀" Then
               If strExc(10) = "♂" Or Replace(strExc(10), "♀", "") = "" Then
                  '第1段
                  If nLeftBrace = 1 And Mid(strData, nRightBrace + 1, 2) = vbCrLf Then
                     strData = Mid(strData, nRightBrace + 3)
                  ElseIf nLeftBrace > 2 Then
                     '最後1段
                     If Mid(strData, nLeftBrace - 2, 2) = vbCrLf And nRightBrace = Len(strData) Then
                        strData = Left(strData, nLeftBrace - 3)
                     '中間單獨1段
                     ElseIf Mid(strData, nLeftBrace - 2, 2) = vbCrLf And Mid(strData, nRightBrace + 1, 2) = vbCrLf Then
                        strData = Left(strData, nLeftBrace - 3) & Mid(strData, nRightBrace + 1)
                     '非獨立段
                     Else
                        strData = Left(strData, nLeftBrace - 1) & Mid(strData, nRightBrace + 1)
                     End If
                  'end 2011/8/19
                  '非獨立段(接第二字)
                  Else
                     strData = Left(strData, nLeftBrace - 1) & Mid(strData, nRightBrace + 1)
                  End If
               Else
                  strData = Left(strData, nLeftBrace - 1) & strExc(10) & Mid(strData, nRightBrace + 1)
               End If
            '無文字
            Else
               'Modify by Morgan 2007/11/29
               'strTemp = Replace(strTemp, "｛" & strExc(10) & "｝", "")
               strTemp = Replace(strTemp, Chr(c_FLLSign) & strExc(10) & Chr(c_FLRSign), "")
               'end 2007/11/29
               If Replace(strTemp, vbCrLf, "") = "" Then
                  strData = Left(strData, nLeftBrace - 1) & Mid(strData, nRightBrace + 1)
               Else
                  strData = Left(strData, nLeftBrace - 1) & strTemp & Mid(strData, nRightBrace + 1)
               End If
            End If
         'end 2007/5/2
         Else
            strData = Left(strData, nLeftBrace - 1) & strTemp2 & Mid(strData, nLeftBrace + 1, nRightBrace - nLeftBrace - 1) & Mid(strData, nRightBrace + 1)
         End If
      End If
      'Modify by Morgan 2004/10/27 [ 識別符號改chr(30)
      'nLeftBrace = InStr(strData, "[")
      nLeftBrace = InStr(strData, Chr(c_MLSign))
      '2004/10/27 end
   Loop
    
    If m_CP01 = "FCP" Or m_CP01 = "FG" Then
         'Added by Morgan 2012/6/6 +目前定稿有用到
         strData = Replace(strData, Chr(c_FMLSign), "〔")  '將chr(26)還原為〔
         strData = Replace(strData, Chr(c_FMRSign), "〕")  '將chr(27)還原為〕

    Else
        '去除空白列
        'Modify by Morgan 2007/11/29
        'nLeftBrace = InStr(strData, "〔")
        nLeftBrace = InStr(strData, Chr(c_FMLSign))
        'end 2007/11/29
        Do While nLeftBrace > 0
            'Modify by Morgan 2007/11/29
            'nRightBrace = InStr(strData, "〕")
            nRightBrace = InStr(strData, Chr(c_FMRSign))
            'end 2007/11/29
            strTemp = Trim(Mid(strData, nLeftBrace + 1, nRightBrace - nLeftBrace - 1))
            If strTemp = "" Then
               'Modify by Morgan 2006/3/16
               '加判斷是否為第一個字
               If nLeftBrace = 1 Then
                  'Add by Morgan 2011/8/19
                  If Mid(strData, nRightBrace + 1, 2) = vbCrLf Then
                     strData = Mid(strData, nRightBrace + 3)
                  Else
                  'end 2011/8/19
                     strData = Mid(strData, nRightBrace + 1)
               'Add by Morgan 2011/8/19
                  End If
               ElseIf nLeftBrace = 2 Then
                  strData = Left(strData, nLeftBrace - 1) & Mid(strData, nRightBrace + 1)
               ElseIf Mid(strData, nLeftBrace - 2, 2) = vbCrLf And nRightBrace = Len(strData) Then
                     strData = Left(strData, nLeftBrace - 3)
               'end 2011/8/19
               Else
                  '清除跳行符號
                  'If InStr(Mid(strData, nLeftBrace - 2), vbCrLf) > 0 Then
                  If Mid(strData, nLeftBrace - 2, 2) = vbCrLf Then
                      strData = Left(strData, nLeftBrace - 3) & Mid(strData, nRightBrace + 1)
                  'Add by Morgan 2005/11/11 清除跳頁符號
                  ElseIf Mid(strData, nLeftBrace - 1, 1) = Chr(12) Then
                    strData = Left(strData, nLeftBrace - 2) & Mid(strData, nRightBrace + 1)
                  Else
                    strData = Left(strData, nLeftBrace - 1) & Mid(strData, nRightBrace + 1)
                  End If
               End If
            Else
               '前面不加全形空白
               strData = Left(strData, nLeftBrace - 1) & "" & Mid(strData, nLeftBrace + 1, nRightBrace - nLeftBrace - 1) & Mid(strData, nRightBrace + 1)
            End If
            'Modify by Morgan 2007/11/29
            'nLeftBrace = InStr(strData, "〔")
            nLeftBrace = InStr(strData, Chr(c_FMLSign))
            'end 2007/11/29
        Loop
    End If
   Parser = strData
   ' 90.08.22 modify by louis
   If m_SplitPos > 0 Then
      m_SplitPos = InStr(strData, strSamp) - 1
   End If
   
ErrHnd:
   If Err.Number <> 0 Then
      MsgBox Err.Description
   End If
End Function

' 解譯欄位的附帶指令
Private Function ParserKeyWord(ByVal strKeyWord As String, ByVal strData As String, ByVal strParam) As String
   Dim strReturn As String
   Dim strValue As String
   'Add By Cheng 2003/01/09
   Dim ii As Integer
   Dim strTData As String
   Dim intTDataLeng As Integer
   Const intConstLengCH As Integer = 14
   Const intConstLengEN As Integer = 60 '小寫算1個字, 大寫算1.5個字
   Const intConstLengCHJP As Integer = 21
   'Add By Cheng 2003/01/16
   Dim arrWords '字串陣列
   Dim strTempData As String '暫存文字
   Dim intChrCnt As Integer '計算字數
   Dim jj As Integer '回圈序號

   'Add By Cheng 2003/02/07
   Dim intLine As Integer '記錄案件名稱所位行數
    
   ' 去除掉頭尾多餘的空白
   strParam = Trim(strParam)
   strReturn = strData
   Select Case strKeyWord
      Case "+":
         'Add By Sindy 2012/4/20
         If Right(strParam, 3) = "工作天" Then
            strValue = Left(strParam, Len(strParam) - 3)
            strReturn = TranslateKeyWord(incADD_WorkDAY, strData, strValue)
            
         'Added by Morgan 2019/12/2
         '專用期止日要減1日(因計算方式特別要改用函數)
         ElseIf Right(strParam, 6) = "年(-1日)" Then
            strValue = Left(strParam, Len(strParam) - 6)
            'Modified by Morgan 2019/12/4 +第3參數傳 Y
            strReturn = PUB_GetEndDate(strData, Val(strValue), "Y")
         'end 2019/12/2
         
         Else
         '2012/4/20 End
            Select Case Right(strParam, 1)
               Case "年":
                  strValue = Left(strParam, Len(strParam) - 1)
                  strReturn = TranslateKeyWord(incADD_YEAR, strData, strValue)
               Case "月":
                  strValue = Left(strParam, Len(strParam) - 1)
                  strReturn = TranslateKeyWord(incADD_MONTH, strData, strValue)
               Case "日":
                  strValue = Left(strParam, Len(strParam) - 1)
                  strReturn = TranslateKeyWord(incADD_DAY, strData, strValue)
               Case Else:
                  strValue = strParam
                  strReturn = TranslateKeyWord(incADD_VALUE, strData, strValue)
            End Select
         End If
      Case "-":
         'Add By Sindy 2012/4/20
         If Right(strParam, 3) = "工作天" Then
            strValue = Left(strParam, Len(strParam) - 3)
            strReturn = TranslateKeyWord(incSUB_WorkDAY, strData, strValue)
         Else
         '2012/4/20 End
            Select Case Right(strParam, 1)
               Case "年":
                  strValue = Left(strParam, Len(strParam) - 1)
                  strReturn = TranslateKeyWord(incSUB_YEAR, strData, strValue)
               Case "月":
                  strValue = Left(strParam, Len(strParam) - 1)
                  strReturn = TranslateKeyWord(incSUB_MONTH, strData, strValue)
               Case "日":
                  strValue = Left(strParam, Len(strParam) - 1)
                  strReturn = TranslateKeyWord(incSUB_DAY, strData, strValue)
                   'Add By Cheng 2003/04/28
                   '若為-7日時
                   If strValue = "7" Then
                       '若-7日後的日期小於等於(系統日 + 3 日) , 則設為系統日 + 3 日
                       If strReturn <= ChangeWDateStringToWString(DateAdd("d", 3, ChangeWStringToWDateString(ServerDate))) Then
                           strReturn = ChangeWDateStringToWString(DateAdd("d", 3, ChangeWStringToWDateString(ServerDate)))
                       End If
                   End If
               Case Else:
                  strValue = strParam
                  strReturn = TranslateKeyWord(incSUB_VALUE, strData, strValue)
            End Select
         End If
      Case "/":
         Select Case strParam
            Case "次":
               strValue = Empty
               strReturn = TranslateKeyWord(incCNV_ENGLISH_FREQUENCY, strData, strValue)
            Case "英":
               strValue = Empty
               'Modified by Morgan 2012/12/28
               '一個以上日期用逗號區隔
               If InStr(strData, ",") > 0 Then
                  arrWords = Split(strData, ",")
                  strReturn = TranslateKeyWord(incCNV_ENGLISH_DATE, arrWords(0), strValue)
                  For ii = LBound(arrWords) + 1 To UBound(arrWords)
                     arrWords(ii) = Trim(arrWords(ii))
                     If arrWords(ii) <> "" Then
                        strReturn = strReturn & ", " & TranslateKeyWord(incCNV_ENGLISH_DATE, arrWords(ii), strValue)
                     End If
                  Next
               Else
                  strReturn = TranslateKeyWord(incCNV_ENGLISH_DATE, strData, strValue)
               End If
               
            Case "中民":
               strValue = Empty
               strData = PUB_DBDATE(strData)   'add by sonia 2019/11/11
               'modify by sonia 2020/2/7 申請書或催審函的中民一定要用民國年月日
               'strReturn = TranslateKeyWord(incCNV_CHINESE_MINKO, strData, strValue)
               strExc(0) = "SELECT * FROM TEXTTYPE WHERE TYP02='" & m_MySt(1) & "' AND TYP01='" & m_FinalSty & "' AND (INSTR(TYP03,'申請書')>0 OR INSTR(TYP03,'催審')>0)"
               intI = 1
               Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
               If intI = 1 Then
                  strReturn = TranslateKeyWord(incCNV_CHINESE_MINKO1, strData, strValue)
               Else
                  strReturn = TranslateKeyWord(incCNV_CHINESE_MINKO, strData, strValue)
               End If
               'end 2020/2/7

            Case "中西":
               strValue = Empty
               strData = PUB_DBDATE(strData)   '2008/9/15 add by sonia
               strReturn = TranslateKeyWord(incCNV_CHINESE_CUN, strData, strValue)
            'add by sonia 2019/11/13 專用期間欄依台->台用民國(西元)年月日,其他皆為西元年月日(台->各國,外->台)
            Case "中民西"
               strValue = Empty
               strData = PUB_DBDATE(strData)
               strReturn = TranslateKeyWord(incCNV_CHINESE_MINKO_CUN, strData, strValue)
            'end 2019/11/13
            'Add By Cheng 2002/09/11
            Case "月日":
               strValue = Empty
               strReturn = TranslateKeyWord(incGET_MMDD, strData, strValue)
            Case "年民":
               strValue = Empty
               strReturn = TranslateKeyWord(incGET_EYEAR, strData, strValue)
            Case "年西":
               strValue = Empty
               strReturn = TranslateKeyWord(incGET_WYEAR, strData, strValue)
            'Add by Morgan 2004/11/29
            '將日期格式化
            Case "格式":
               strValue = Empty
               strReturn = TranslateKeyWord(intCNV_DATE_FORMAT, strData, strValue)
               
            'Add By Cheng 2003/01/09
            '中文案件名稱折行
            Case "中折"
                'Modify By Cheng 2003/02/18
                '若有傳入資料
                If strReturn <> "" Then
                    strTData = ""
                    strReturn = Trim(strReturn)
                    intTDataLeng = Len(strReturn)
                    '若案件名稱長度大於折行長度條件
                    If intTDataLeng > intConstLengCH Then
                        For ii = 0 To Fix(intTDataLeng / intConstLengCH) - 1
                            '加換行符號及空白
                            strTData = strTData & Mid(strReturn, 1 + (ii * intConstLengCH), intConstLengCH) & vbCrLf & "　　　　　　　　　　　　　　"
                        Next ii
                        strTData = strTData & Mid(strReturn, 1 + (ii * intConstLengCH), intConstLengCH)
                        strReturn = strTData
                    End If
                End If
            'Add By Cheng 2003/01/09
            '英文案件名稱折行
            Case "英折"
                'Modify By Cheng 2003/02/18
                '若有傳入資料
                If strReturn <> "" Then
                    'Add By Cheng 2003/02/07
                    '預設案件名稱所佔行數為一行
                    intLine = 1
                    intChrCnt = 0
                    strTData = ""
                    strTempData = ""
                    strReturn = Trim(strReturn)
                    intTDataLeng = Len(strReturn)
                    'Modify By Cheng 2003/01/27
                    '不判斷案件名稱長度大於折行長度, 都進折行判斷
    '                '若案件名稱長度大於折行長度條件
    '                If intTDataLeng > intConstLengEN Then
                        arrWords = Split(strReturn, " ")
                        For ii = LBound(arrWords) To UBound(arrWords)
                            arrWords(ii) = Trim(arrWords(ii))
                            If arrWords(ii) <> "" Then
                                For jj = 1 To Len(arrWords(ii))
                                    '若為英文大寫字元
                                    If Asc(Mid(arrWords(ii), jj, 1)) >= 65 And Asc(Mid(arrWords(ii), jj, 1)) <= 90 Then
                                        intChrCnt = intChrCnt + 1.5
                                    Else
                                        intChrCnt = intChrCnt + 1
                                    End If
                                Next jj
                                strTData = strTData & arrWords(ii) & " "
                                intChrCnt = intChrCnt + 1
                                '若超過每行固定長度
                                If intChrCnt >= intConstLengEN Then
                                    '案件名稱所佔行數加一
                                    intLine = intLine + 1
                                    strTempData = strTempData & Left(strTData, Len(strTData) - (Len(arrWords(ii)) + 1)) & vbCrLf & "　　　　　　　　　　"
                                    intChrCnt = 0
                                    strTData = ""
                                    For jj = 1 To Len(arrWords(ii))
                                        '若為英文大寫字元
                                        If Asc(Mid(arrWords(ii), jj, 1)) >= 65 And Asc(Mid(arrWords(ii), jj, 1)) <= 90 Then
                                            intChrCnt = intChrCnt + 1.5
                                        Else
                                            intChrCnt = intChrCnt + 1
                                        End If
                                    Next jj
                                    strTData = strTData & arrWords(ii) & " "
                                    intChrCnt = intChrCnt + 1
                                End If
                                '若已至最後一個陣列時
                                If ii = UBound(arrWords) Then
                                    strTempData = strTempData & Left(strTData, Len(strTData) - 1)
                                End If
                            End If
                        Next ii
                        strReturn = IIf(Right(strTempData, 1) = " ", Left(strTempData, Len(strTempData) - 1), strTempData)
                        'Add By Cheng 2003/02/07
                        '若案件名稱所佔行數只有一行時, 多加一換行字元
                        strReturn = strReturn & vbCrLf
    '                End If
                End If
            'Add By Cheng 2003/05/22
            '英文案件名稱折行
            Case "英折4"
                If strReturn <> "" Then
                    '預設案件名稱所佔行數為一行
                    intLine = 1
                    intChrCnt = 0
                    strTData = ""
                    strTempData = ""
                    strReturn = Trim(strReturn)
                    intTDataLeng = Len(strReturn)
                    '不判斷案件名稱長度大於折行長度, 都進折行判斷
                    arrWords = Split(strReturn, " ")
                    For ii = LBound(arrWords) To UBound(arrWords)
                        arrWords(ii) = Trim(arrWords(ii))
                        If arrWords(ii) <> "" Then
                            For jj = 1 To Len(arrWords(ii))
                                '若為英文大寫字元
                                If Asc(Mid(arrWords(ii), jj, 1)) >= 65 And Asc(Mid(arrWords(ii), jj, 1)) <= 90 Then
                                    intChrCnt = intChrCnt + 1.5
                                Else
                                    intChrCnt = intChrCnt + 1
                                End If
                            Next jj
                            strTData = strTData & arrWords(ii) & " "
                            intChrCnt = intChrCnt + 1
                            '若超過每行固定長度
                            If intChrCnt >= 80 - 4 Then
                                '案件名稱所佔行數加一
                                intLine = intLine + 1
                                strTempData = strTempData & Left(strTData, Len(strTData) - (Len(arrWords(ii)) + 1)) & vbCrLf & "    "
                                intChrCnt = 0
                                strTData = ""
                                For jj = 1 To Len(arrWords(ii))
                                    '若為英文大寫字元
                                    If Asc(Mid(arrWords(ii), jj, 1)) >= 65 And Asc(Mid(arrWords(ii), jj, 1)) <= 90 Then
                                        intChrCnt = intChrCnt + 1.5
                                    Else
                                        intChrCnt = intChrCnt + 1
                                    End If
                                Next jj
                                strTData = strTData & arrWords(ii) & " "
                                intChrCnt = intChrCnt + 1
                            End If
                            '若已至最後一個陣列時
                            If ii = UBound(arrWords) Then
                                strTempData = strTempData & Left(strTData, Len(strTData) - 1)
                            End If
                        End If
                    Next ii
                    'Add By Sindy 2016/3/17
                    If strTempData <> "" Then
                    '2016/3/17 END
                     strReturn = IIf(Right(strTempData, 1) = " ", Left(strTempData, Len(strTempData) - 1), strTempData)
                    End If
                End If
            'Add By Cheng 2003/01/09
            'CFP中文或日文案件名稱折行
            Case "中日折"
                'Modify By Cheng 2003/02/18
                '若有傳入資料
                If strReturn <> "" Then
                    strTData = ""
                    strReturn = Trim(strReturn)
                    intTDataLeng = Len(strReturn)
                    '若案件名稱長度大於折行長度條件
                    If intTDataLeng > intConstLengCHJP Then
                        For ii = 0 To Fix(intTDataLeng / intConstLengCHJP) - 1
                            '加換行符號及空白
                            strTData = strTData & Mid(strReturn, 1 + (ii * intConstLengCHJP), intConstLengCHJP) & vbCrLf & "　　　　　　　　　　"
                        Next ii
                        strTData = strTData & Mid(strReturn, 1 + (ii * intConstLengCHJP), intConstLengCHJP)
                        strReturn = strTData
                    End If
                End If
            'Add By Cheng 2003/01/22
            Case "U" '英文字轉換成大寫
                strReturn = UCase("" & strData)
            'Add By Cheng 2003/03/13
            Case "L" '英文字轉換成小寫
                strReturn = LCase("" & strData)
            'Add By Cheng 2003/01/23
            '商標種類"4"至"6"時為"Services", 其餘帶"Goods"
            Case "GS"
                strReturn = IIf("" & strData >= "4" And "" & strData <= "6", "Services", "Goods")
            'Add By Cheng 2003/03/10
            '商標種類"4"至"6"時為"Service Mark", 其餘帶"Trademark"
            Case "TS"
                strReturn = IIf("" & strData >= "4" And "" & strData <= "6", "Service Mark", "Trademark")
                
            'Added by Morgan 2014/2/26
            Case "英簡"
               strValue = Empty
               '一個以上日期用逗號區隔
               If InStr(strData, ",") > 0 Then
                  arrWords = Split(strData, ",")
                  strReturn = Format(ChangeWStringToWDateString(CStr(arrWords(0))), "mmm dd, yyyy")
                  For ii = LBound(arrWords) + 1 To UBound(arrWords)
                     arrWords(ii) = Trim(arrWords(ii))
                     If arrWords(ii) <> "" Then
                        strReturn = Format(ChangeWStringToWDateString(CStr(arrWords(ii))), "mmm dd, yyyy")
                     End If
                  Next
               Else
                  strReturn = Format(ChangeWStringToWDateString(strData), "mmm dd, yyyy")
               End If
               
         End Select
      'Add By Cheng 2002/01/22
      '將金額轉換為#,###格式
      Case ",":
         'Modify By Cheng 2002/08/13
'         strReturn = IIf(IsNull(strReturn) Or Len("" & strReturn) <= 0, _
'                              "", Format(Val(strReturn), "#,##0"))
         If "" & strReturn = "" Then
            strReturn = ""
         'Modified by Morgan 2024/4/29 數字才轉換，否則帶原內容
         'Else
         ElseIf IsNumeric(strReturn) Then
         'end 2024/4/29
            Select Case Len(strReturn) - InStr(strReturn, ".")
            Case Len(strReturn) '無小數點
               strReturn = Format(Val(strReturn), "#,##0")
            Case 1 '小數一位
               strReturn = Format(Val(strReturn), "#,##0.0")
            Case 2 '小數二位
               strReturn = Format(Val(strReturn), "#,##0.00")
            Case 3 '小數三位
               strReturn = Format(Val(strReturn), "#,##0.000")
            End Select
         End If
   End Select
   

    'Add By Cheng 2003/08/26
    Select Case strKeyWord
    Case "/":
      Select Case Left(strParam, 2)
         Case "日折"
            'Modify by Morgan 2011/8/19 國外信紙新版面每行減2字
            'strReturn = SplitTitle(strReturn, Val(Mid(strParam, 3)), 72)
            'Modified by Morgan 2011/11/9
            jj = InStr(3, strParam, ",")
            If jj > 0 Then
               strReturn = SplitTitle(strReturn, Val(Mid(strParam, 3, jj - 3)), 68, , Mid(strParam, jj + 1))
            Else
               strReturn = SplitTitle(strReturn, Val(Mid(strParam, 3)), 68)
            End If
         'add by nickc 2007/02/15 有些要折行，但是裡面有換行符號，會折錯
         Case "換折"
            arrWords = Split(strReturn, vbCrLf)
            strReturn = ""
            For ii = 0 To UBound(arrWords)
                'edit by nickc 2007/05/21 修改字可以放更多在一行
                'strReturn = strReturn & SplitTitle(arrWords(ii), Val(Mid(strParam, 3)), , False)
                strReturn = strReturn & SplitTitle(arrWords(ii), Val(Mid(strParam, 3)), 76, False)
                If ii <> UBound(arrWords) Then
                    strReturn = strReturn & vbCrLf
                End If
            Next ii
         Case Else
            Select Case Left(strParam, 1)
               Case "取":
                  strValue = Val(Right(strParam, Len(strParam) - 1))
                  strReturn = Left(strData, strValue)
               'Add by Morgan 2004/10/8 折行並可指定前面空白數
               Case "折":
                  strReturn = SplitTitle(strReturn, Val(Mid(strParam, 2)))
               Case "換":    'add by nickc 2007/08/07 幾個字換行
                  strReturn = SplitTitle(strReturn, 0, Val(Mid(strParam, 2)))
               'Add by nick 2004/11/01 補前面空白數
               Case "空":    '後面接要空的數目 以半形計算
                  strReturn = Replace(strReturn, vbCrLf, vbCrLf & Space(Val(Mid(strParam, 2))))
            End Select
      End Select
    End Select
    ParserKeyWord = strReturn
End Function
'Add by Morgan 2004/10/7
'改自 ParserKeyWord 的英折4程式段
'字串長度計算：小寫=1,大寫=1.5,全形=2
'iPreLen=前置字串長度
'edit by nickc 2007/02/15 IsTrim 預設 true
'Modified by Morgan 2011/11/9 +iPrintedLen:該行已列印長度,當不等同跳行要預留空白長度時要設定
'Private Function SplitTitle(ByVal stTitle As String, ByVal iPreLen As Integer, Optional iMaxLen As Integer = 66) As String
Private Function SplitTitle(ByVal stTitle As String, ByVal iPreLen As Integer, Optional iMaxLen As Integer = 66, Optional IsTrim As Boolean = True, Optional iPrintedLen As Integer = -1) As String

   Dim iTLen As Integer '字串總長度
   Dim arrWords '單字陣列
   Dim stRtn As String '回傳字串
   Dim iWordLen As Single  '單字長度
   Dim iLineLen As Single '一列字串長度
   Dim ii As Integer, jj As Integer
   Dim stChar As String
   Dim iRestLen As Single '列剩餘可印長度
   Dim iWordPos As Integer '列剩餘可印字串位置
   Dim iCharLen As Single '字元長度
   Dim bJump As Boolean, stRemainChars As String '是否跳行符號,剩餘字元
   Dim strChars As String, kk As Integer
   
   If iPrintedLen = -1 Then iPrintedLen = iPreLen 'Added by Morgan 2011/11/9
   
   'add by nickc 2007/02/15
   If IsTrim = True Then
        stTitle = Trim(stTitle)
   End If
   iTLen = Len(stTitle)
   
   If iTLen > 0 Then
      '拆字
      arrWords = Split(stTitle, " ")
      'Modified by Morgan 2011/11/9
      'iLineLen = iPreLen: stRtn = ""
      iLineLen = iPrintedLen: stRtn = ""
      
      For ii = LBound(arrWords) To UBound(arrWords)
        'add by nickc 2007/02/15
        If IsTrim = True Then
             arrWords(ii) = Trim(arrWords(ii))
        End If
         iRestLen = iMaxLen - iLineLen
         
'Add by Morgan 2007/11/19 考慮有跳行字元
PrintSplitWord:
         bJump = False
         stRemainChars = ""
'end 2007/11/19
         If arrWords(ii) <> "" Then
            iWordLen = 0
            For jj = 1 To Len(arrWords(ii))
               stChar = Mid(arrWords(ii), jj, 1)
               'Add by Morgan 2007/11/19 考慮有跳行字元
               If stChar = Chr(13) Then
                  bJump = True
                  If jj < Len(arrWords(ii)) Then
                     'Modified by Morgan 2012/11/19 +考慮只有chr(13)的情形
                     If Mid(arrWords(ii), jj + 1, 1) = Chr(10) Then
                        stRemainChars = Mid(arrWords(ii), jj + 2)
                     Else
                        stRemainChars = Mid(arrWords(ii), jj + 1)
                     End If
                  End If
                  arrWords(ii) = Left(arrWords(ii), jj - 1)
                  Exit For
               End If
               'end 2007/11/19
               
               iWordLen = iWordLen + 1
               '全形字算2個
               If Asc(stChar) < 0 Then
                  iWordLen = iWordLen + 1
               'Added by Morgan 2022/7/11
               'Unicode算2個
               ElseIf PUB_ChkUnicod(stChar) Then
                  iWordLen = iWordLen + 1
               'end 2022/7/11
               '英文大寫字元算1.5個
               ElseIf Asc(stChar) >= 65 And Asc(stChar) <= 90 Then
                  iWordLen = iWordLen + 0.5
               
               End If
            Next jj
            '若單字超過列可印長度時斷字
            'Modified by Morgan 2022/7/11
            'If iPreLen + iWordLen > iMaxLen Then
            If iPrintedLen + iWordLen > iMaxLen Then
            'end 2022/7/11
               iWordLen = 0: iWordPos = 0
               For jj = 1 To Len(arrWords(ii))
                  stChar = Mid(arrWords(ii), jj, 1)
                  '全形字算2個
                  If Asc(stChar) < 0 Then
                     iCharLen = 2
                  'Added by Morgan 2022/7/11
                  'Unicode算2個
                  ElseIf PUB_ChkUnicod(stChar) Then
                     iCharLen = 2
                  'end 2022/7/11
                  '英文大寫字元算1.5個
                  ElseIf Asc(stChar) >= 65 And Asc(stChar) <= 90 Then
                     iCharLen = 1.5
                  '其餘算1個
                  Else
                     iCharLen = 1
                  End If
                  iWordLen = iWordLen + iCharLen
                  If iLineLen + iWordLen > iMaxLen Then
                     iWordPos = iWordPos + 1
                     'Modified by Morgan 2018/1/30 考慮化學的案件名稱較特殊，加判斷優先以最後一個非英文字母折行 Ex.FCP-58229
                     'If jj - iWordPos > 0 Then
                     '   stRtn = stRtn & Mid(arrWords(ii), iWordPos, jj - iWordPos)
                     'End If
                     'iWordPos = jj
                     'stRtn = stRtn & vbCrLf & String(iPreLen, " ") & Mid(arrWords(ii), iWordPos, 1)
                     'iLineLen = iPreLen + iCharLen
                     strChars = Mid(arrWords(ii), iWordPos, jj - iWordPos)
                     '從後面開始逐字檢查
                     For kk = Len(strChars) To 1 Step -1
                        strExc(2) = Mid(strChars, kk, 1)
                        '檢查是否非英文字母
                        If UCase(strExc(2)) < "A" Or UCase(strExc(2)) > "Z" Then
                           Exit For
                        End If
                     Next
                     '無
                     If kk = 0 Then
                        stRtn = stRtn & strChars & vbCrLf & String(iPreLen, " ")
                        jj = jj - 1
                     '有
                     Else
                        stRtn = stRtn & Left(strChars, kk) & vbCrLf & String(iPreLen, " ")
                        jj = iWordPos + kk - 1
                     End If
                     iWordPos = jj
                     iLineLen = iPreLen
                     'end 2018/1/30
                     iWordLen = 0
                  End If
               Next jj
               arrWords(ii) = Mid(arrWords(ii), iWordPos + 1)
            End If
            
            '若超過每行固定長度則跳行
            If iLineLen + iWordLen > iMaxLen Then
               stRtn = stRtn & vbCrLf & String(iPreLen, " ") & arrWords(ii)
               iLineLen = iPreLen + iWordLen
            Else
               stRtn = stRtn & arrWords(ii)
               iLineLen = iLineLen + iWordLen
            End If
            '若不是最後一個字時加空白
            If iLineLen < iMaxLen Then
               stRtn = stRtn & " "
               iLineLen = iLineLen + 1
            End If
         End If
         'Add by Morgan 2007/11/19 考慮有跳行字元
         If bJump = True Then
            stRtn = stRtn & vbCrLf & String(iPreLen, " ")
            iLineLen = iPreLen
            If stRemainChars <> "" Then
               arrWords(ii) = stRemainChars
               GoTo PrintSplitWord
            End If
         End If
         'end 2007/11/19
      Next ii
   End If
   SplitTitle = stRtn
End Function

' 執行指令
' Input : keyWord ==> 指令種類
'         strData ==> 原始的資料
'         strParam ==> 附加的資料或數值
'         strCaseNo ==> 非定稿傳本所案號,以判斷日期欄之民國或西元格式  'add by sonia 2020/2/20
Public Function TranslateKeyWord(ByVal KeyWord As String, ByVal strData As String, ByVal strParam, Optional strCaseNo As String) As String
   Dim nParam As Long
   Dim strTmp As String
   
   ' 先將傳回值設成原始的資料
   TranslateKeyWord = strData
   ' 欄位內容
   If strData = Empty Then
      GoTo EXITSUB
   End If
   
   Select Case KeyWord
      ' 加上#值
      Case incADD_VALUE:
         nParam = Val(strParam)
         TranslateKeyWord = Format(Val(strData) + nParam)
      ' 加上#年
      Case incADD_YEAR:
         nParam = Val(strParam)
         strTmp = CompDate(0, nParam, strData)
         TranslateKeyWord = CleanDate(strTmp)
      ' 加上#月
      Case incADD_MONTH:
         nParam = Val(strParam)
         strTmp = CompDate(1, nParam, strData)
         'Add by Morgan 2004/12/21 P與FCP需考慮月底問題
         If m_MySt(1) = "P" Or m_MySt(1) = "FCP" Then
            PUB_LastDayConvert strData, strTmp
         End If
         TranslateKeyWord = CleanDate(strTmp)
      ' 加上#天
      Case incADD_DAY:
         nParam = Val(strParam)
         strTmp = CompDate(2, nParam, strData)
         TranslateKeyWord = CleanDate(strTmp)
      'Add By Sindy 2012/4/20
      ' 加上#工作天 (含當日)
      Case incADD_WorkDAY:
         nParam = Val(strParam)
         strTmp = CompWorkDay(nParam, strData, 0)
         TranslateKeyWord = CleanDate(strTmp)
      '2012/4/20 End
      ' 減掉#數值
      Case incSUB_VALUE:
         nParam = Val(strParam)
         TranslateKeyWord = Format(Val(strData) - nParam)
      ' 減掉#年
      Case incSUB_YEAR:
         nParam = Val(strParam)
         strTmp = CompDate(0, -nParam, strData)
         TranslateKeyWord = CleanDate(strTmp)
      ' 減掉#月
      Case incSUB_MONTH:
         nParam = Val(strParam)
         strTmp = CompDate(1, -nParam, strData)
         TranslateKeyWord = CleanDate(strTmp)
      ' 減掉#天
      Case incSUB_DAY:
         nParam = Val(strParam)
         strTmp = CompDate(2, -nParam, strData)
         TranslateKeyWord = CleanDate(strTmp)
      'Add By Sindy 2012/4/20
      ' 減掉#工作天 (含當日)
      Case incSUB_WorkDAY:
         nParam = Val(strParam)
         strTmp = CompWorkDay(nParam, strData, 1)
         TranslateKeyWord = CleanDate(strTmp)
      '2012/4/20
      ' 改為中文民國日期 (民國#年#月#日)
      'modify by sonia 2019/11/8 +incCNV_CHINESE_CUN,統一台灣案用民國年月日,但外至台改用西元年月日,非台灣案用西元年月日
      Case incCNV_CHINESE_MINKO, incCNV_CHINESE_CUN:
         'modify by sonia 2019/11/8 統一台灣案用民國年月日,非台灣案用西元年月日,但外至台改用西元年月,以程式控制減少修改定稿設計(因為有台灣及非台灣案共用的定稿)
         'strTmp = TransDate(strData, 1)
         'MODIFY BY SONIA 90.10.21
         'If Len(strTmp) = 6 Then
         '   TranslateKeyWord = Mid(strTmp, 1, 2) & "年" & Mid(strTmp, 3, 2) & "月" & Mid(strTmp, 5, 2) & "日"
         'Else
         '   TranslateKeyWord = Mid(strTmp, 1, 3) & "年" & Mid(strTmp, 4, 2) & "月" & Mid(strTmp, 6, 2) & "日"
         'End If
         strTmp = TransDate(strData, 1)
         'add by sonia 2020/2/20 非定稿傳本所案號,以判斷日期欄之民國或西元格式
         If strCaseNo <> "" Then
            PaSt = "PA01='" & Mid(strCaseNo, 1, Len(strCaseNo) - 9) & "' AND PA02='" & Mid(strCaseNo, Len(strCaseNo) - 8, 6) & "' AND PA03='" & _
               Mid(strCaseNo, Len(strCaseNo) - 2, 1) & "' AND PA04='" & Mid(strCaseNo, Len(strCaseNo) - 1, 2) & "'"
            TmSt = "TM01='" & Mid(strCaseNo, 1, Len(strCaseNo) - 9) & "' AND TM02='" & Mid(strCaseNo, Len(strCaseNo) - 8, 6) & "' AND TM03='" & _
               Mid(strCaseNo, Len(strCaseNo) - 2, 1) & "' AND TM04='" & Mid(strCaseNo, Len(strCaseNo) - 1, 2) & "'"
            LcSt = "LC01='" & Mid(strCaseNo, 1, Len(strCaseNo) - 9) & "' AND LC02='" & Mid(strCaseNo, Len(strCaseNo) - 8, 6) & "' AND LC03='" & _
               Mid(strCaseNo, Len(strCaseNo) - 2, 1) & "' AND LC04='" & Mid(strCaseNo, Len(strCaseNo) - 1, 2) & "'"
            HcSt = "HC01='" & Mid(strCaseNo, 1, Len(strCaseNo) - 9) & "' AND HC02='" & Mid(strCaseNo, Len(strCaseNo) - 8, 6) & "' AND HC03='" & _
               Mid(strCaseNo, Len(strCaseNo) - 2, 1) & "' AND HC04='" & Mid(strCaseNo, Len(strCaseNo) - 1, 2) & "'"
            SpSt = "SP01='" & Mid(strCaseNo, 1, Len(strCaseNo) - 9) & "' AND SP02='" & Mid(strCaseNo, Len(strCaseNo) - 8, 6) & "' AND SP03='" & _
               Mid(strCaseNo, Len(strCaseNo) - 2, 1) & "' AND SP04='" & Mid(strCaseNo, Len(strCaseNo) - 1, 2) & "'"
         End If
         'end 2020/2/20
         strExc(0) = "SELECT PA09,PA75,CU87 FROM PATENT,CUSTOMER WHERE SUBSTR(PA26,1,8)=CU01(+) AND SUBSTR(PA26,9,1)=CU02(+) AND " & PaSt
         strExc(0) = strExc(0) & " Union SELECT TM10,TM44,CU87 FROM TRADEMARK,CUSTOMER WHERE SUBSTR(TM23,1,8)=CU01(+) AND SUBSTR(TM23,9,1)=CU02(+) AND " & TmSt
         strExc(0) = strExc(0) & " Union SELECT LC15,LC22,CU87 FROM LAWCASE,CUSTOMER WHERE SUBSTR(LC11,1,8)=CU01(+) AND SUBSTR(LC11,9,1)=CU02(+) AND " & LcSt
         strExc(0) = strExc(0) & " Union SELECT '000','',CU87 FROM HIRECASE,CUSTOMER WHERE SUBSTR(HC05,1,8)=CU01(+) AND SUBSTR(HC05,9,1)=CU02(+) AND " & HcSt
         strExc(0) = strExc(0) & " Union SELECT SP09,SP26,CU87 FROM SERVICEPRACTICE,CUSTOMER WHERE SUBSTR(SP08,1,8)=CU01(+) AND SUBSTR(SP08,9,1)=CU02(+) AND " & SpSt
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If "" & RsTemp.Fields(0).Value <> "000" Or "" & RsTemp.Fields(1).Value <> "" Then
               TranslateKeyWord = Mid(strData, 1, 4) & "年" & Mid(strData, 5, 2) & "月" & Mid(strData, 7, 2) & "日"
            Else
               If "" & RsTemp.Fields(2).Value > "010" Then
                  TranslateKeyWord = Mid(strData, 1, 4) & "年" & Mid(strData, 5, 2) & "月" & Mid(strData, 7, 2) & "日"
               Else
                  If Len(strTmp) = 6 Then
                     TranslateKeyWord = Mid(strTmp, 1, 2) & "年" & Mid(strTmp, 3, 2) & "月" & Mid(strTmp, 5, 2) & "日"
                  Else
                     TranslateKeyWord = Mid(strTmp, 1, 3) & "年" & Mid(strTmp, 4, 2) & "月" & Mid(strTmp, 6, 2) & "日"
                  End If
               End If
            End If
         Else
            If Len(strTmp) = 6 Then
               TranslateKeyWord = Mid(strTmp, 1, 2) & "年" & Mid(strTmp, 3, 2) & "月" & Mid(strTmp, 5, 2) & "日"
            Else
               TranslateKeyWord = Mid(strTmp, 1, 3) & "年" & Mid(strTmp, 4, 2) & "月" & Mid(strTmp, 6, 2) & "日"
            End If
         End If
         'end 2019/11/8
'         TranslateKeyWord = "民國" & Mid(strTmp, 1, 2) & "年" & Mid(strTmp, 3, 2) & "月" & Mid(strTmp, 5, 2) & "日"
'cancel by sonia 2019/11/8 改寫到民國年處,再依申請國家判斷
'      ' 改為中文西元日期 (西元#年#月#日)
'      Case incCNV_CHINESE_CUN:
'         TranslateKeyWord = Mid(strData, 1, 4) & "年" & Mid(strData, 5, 2) & "月" & Mid(strData, 7, 2) & "日"
''         TranslateKeyWord = "西元" & Mid(strTmp, 1, 4) & "年" & Mid(strTmp, 5, 2) & "月" & Mid(strTmp, 7, 2) & "日"
'end 2019/11/8
      ' 改為改為中文民國(西元年)日期 (民國#(西元年)年#月#日) 專用期間欄依台->台用民國(西元)年月日,其他皆為西元年月日(台->各國,外->台)
      Case incCNV_CHINESE_MINKO_CUN:
         strTmp = TransDate(strData, 1)
         strExc(0) = "SELECT PA09,PA75,CU87 FROM PATENT,CUSTOMER WHERE SUBSTR(PA26,1,8)=CU01(+) AND SUBSTR(PA26,9,1)=CU02(+) AND " & PaSt
         strExc(0) = strExc(0) & " Union SELECT TM10,TM44,CU87 FROM TRADEMARK,CUSTOMER WHERE SUBSTR(TM23,1,8)=CU01(+) AND SUBSTR(TM23,9,1)=CU02(+) AND " & TmSt
         strExc(0) = strExc(0) & " Union SELECT LC15,LC22,CU87 FROM LAWCASE,CUSTOMER WHERE SUBSTR(LC11,1,8)=CU01(+) AND SUBSTR(LC11,9,1)=CU02(+) AND " & LcSt
         strExc(0) = strExc(0) & " Union SELECT '000','',CU87 FROM HIRECASE,CUSTOMER WHERE SUBSTR(HC05,1,8)=CU01(+) AND SUBSTR(HC05,9,1)=CU02(+) AND " & HcSt
         strExc(0) = strExc(0) & " Union SELECT SP09,SP26,CU87 FROM SERVICEPRACTICE,CUSTOMER WHERE SUBSTR(SP08,1,8)=CU01(+) AND SUBSTR(SP08,9,1)=CU02(+) AND " & SpSt
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            If "" & RsTemp.Fields(0).Value <> "000" Or "" & RsTemp.Fields(1).Value <> "" Then
               TranslateKeyWord = Mid(strData, 1, 4) & "年" & Mid(strData, 5, 2) & "月" & Mid(strData, 7, 2) & "日"
            Else
               If "" & RsTemp.Fields(2).Value > "010" Then
                  TranslateKeyWord = Mid(strData, 1, 4) & "年" & Mid(strData, 5, 2) & "月" & Mid(strData, 7, 2) & "日"
               Else
                  'Added by Lydia 2020/12/03 增加民國100年以前的判斷; ex. T-225849之註冊證
                  If Len(strTmp) = 6 Then
                      TranslateKeyWord = Mid(strTmp, 1, 2) & "(" & Mid(strData, 1, 4) & ")年" & Mid(strTmp, 3, 2) & "月" & Mid(strTmp, 5, 2) & "日"
                  Else
                  'end 2020/12/03
                      TranslateKeyWord = Mid(strTmp, 1, 3) & "(" & Mid(strData, 1, 4) & ")年" & Mid(strTmp, 4, 2) & "月" & Mid(strTmp, 6, 2) & "日"
                  End If 'Added by Lydia 2020/12/03
               End If
            End If
         Else
            TranslateKeyWord = Mid(strTmp, 1, 3) & "(" & Mid(strData, 1, 4) & ")年" & Mid(strTmp, 4, 2) & "月" & Mid(strTmp, 6, 2) & "日"
         End If
      'end 2019/11/13
      'add by sonia 2019/11/26 非定稿之程式用
      ' 改為中文民國日期 (民國#年#月#日)
      Case incCNV_CHINESE_MINKO1:
         strTmp = TransDate(strData, 1)
         If Len(strTmp) = 6 Then
            TranslateKeyWord = Mid(strTmp, 1, 2) & "年" & Mid(strTmp, 3, 2) & "月" & Mid(strTmp, 5, 2) & "日"
         Else
            TranslateKeyWord = Mid(strTmp, 1, 3) & "年" & Mid(strTmp, 4, 2) & "月" & Mid(strTmp, 6, 2) & "日"
         End If
      ' 改為中文西元日期 (西元#年#月#日)
      Case incCNV_CHINESE_CUN1:
         TranslateKeyWord = Mid(strData, 1, 4) & "年" & Mid(strData, 5, 2) & "月" & Mid(strData, 7, 2) & "日"
      'end 2019/11/26
      ' 改為英文日期
      Case incCNV_ENGLISH_DATE:
         TranslateKeyWord = ChgEngDate(strData)
      ' 轉換成英文的次數
      Case incCNV_ENGLISH_FREQUENCY:
         Select Case strData
            Case "1": TranslateKeyWord = "1st"
            Case "2": TranslateKeyWord = "2nd"
            Case "3": TranslateKeyWord = "3rd"
            Case Else: TranslateKeyWord = strData & "th"
         End Select
      ' 取得系統日期
      Case incGET_SYSDATE:
         TranslateKeyWord = Date
      'Add By Cheng 2002/09/11
      '取得月日
      Case incGET_MMDD:
         TranslateKeyWord = Val(Mid(strData, 5, 2)) & "月" & Val(Mid(strData, 7, 2)) & "日"
      '取得年民
      Case incGET_EYEAR:
         TranslateKeyWord = Val(Mid(strData, 1, 4)) - 1911 & "年"
      '取得年西
      Case incGET_WYEAR:
         TranslateKeyWord = Val(Mid(strData, 1, 4)) & "年"
      '日期格式化1 Add by Morgan 2004/11/29
      Case intCNV_DATE_FORMAT
         TranslateKeyWord = Format(strData, "####/##/##")
   End Select
EXITSUB:
End Function

Public Function ChgEngDate(ByVal strValue As String) As String
Dim strTmp As String
'Add By Cheng 2003/01/02
Dim ii As Integer
Dim arrTmp
   
'Modify By Cheng 2003/01/02
ChgEngDate = ""
'若有傳入值
'Modified by Morgan 2022/4/21 可能傳入空白
'If strValue <> "" Then
If Trim(strValue) <> "" Then
'end 2022/4/21
    arrTmp = Split(strValue, "; ")
    For ii = 0 To UBound(arrTmp)
        Select Case Mid(arrTmp(ii), 5, 2)
           Case "01": strTmp = "January "
           Case "02": strTmp = "February "
           Case "03": strTmp = "March "
           Case "04": strTmp = "April "
           Case "05": strTmp = "May "
           Case "06": strTmp = "June "
           Case "07": strTmp = "July "
           Case "08": strTmp = "August "
           Case "09": strTmp = "September "
           Case "10": strTmp = "October "
           Case "11": strTmp = "November "
           Case "12": strTmp = "December "
        End Select
        'Modify By Cheng 2003/01/30
'        ChgEngDate = ChgEngDate & strTmp & Right(strValue, 2) & ", " & Left(strValue, 4) & "; "
        ChgEngDate = ChgEngDate & strTmp & Right(arrTmp(ii), 2) & ", " & Left(arrTmp(ii), 4) & "; "
    Next ii
    ChgEngDate = Left(ChgEngDate, Len(ChgEngDate) - 2)
Else
   'Modified by Morgan 2022/4/21
   'ChgEngDate = ""
   ChgEngDate = strValue
   'end 2022/4/21
End If
End Function

' 清除日期中的 / 符號
Private Function CleanDate(ByVal strDate As String) As String
   Dim nLength As Integer
   Dim nPos As Integer
   Dim nPosNext As Integer
   Dim nSubLen As Integer
   Dim bConvert As Boolean
   Dim strTmp As String
   
   ' 先去除日期中的
   bConvert = True
   Do While bConvert = True
      nLength = Len(strDate)
      nPos = InStr(strDate, "/")
      If nPos > 0 Then
         nSubLen = 0
         nPosNext = InStr(Right(strDate, nLength - nPos), "/")
         If nPosNext > 0 Then
            nSubLen = nPosNext - 1
         Else
            nSubLen = nLength - nPos
         End If
         strTmp = Empty
         If nSubLen = 1 Then strTmp = "0"
         strDate = Left(strDate, nPos - 1) & strTmp & Right(strDate, nLength - nPos)
         bConvert = True
      Else
         bConvert = False
      End If
   Loop
   
   CleanDate = strDate
End Function

Public Sub EndLetter(ByVal ET01 As String, ByVal ET02 As String, ByVal ET03 As String, ByVal ET04 As String)
   strExc(1) = "DELETE FROM EXCEPTCONDITION WHERE ET01='" & ET01 & "' AND ET02='" & ET02 & _
      "' AND ET03='" & ET03 & "' AND ET04='" & ET04 & "'"
   'edit by nickc 2007/02/05 不用 dll 了
   'If Not objLawDll.ExecSQL(1, strExc) Then
   If Not ClsLawExecSQL(1, strExc) Then
   End If
End Sub

''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' 將目前所要列印的定稿資料存入資料庫中
' Input : strData ==> 所要儲存到資料庫中的定稿內容
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
'Modify by Morgan 2008/8/25 +編輯時上已列印標記
'Modify by Morgan 2016/11/2 +strDataCC:副本內容,str990CP09:副本信函收文號
Private Sub SaveToDB(ByVal strData As String, Optional bolEdit As Boolean, Optional strLetterRecNo As String, Optional strDataCC As String, Optional str990CP09 As String)
   Dim strSql As String, intR As Integer
   Dim strOrient As String
   Dim strSplitPos As String
   Dim strDate As String
   Dim strTime As String
   'Add by Morgan 2010/11/12
   'Modified by Morgan 2017/9/7
   'Dim strData1 As String
   'Dim strData2 As String
   Dim arrData(9) As String
   Dim ii As Integer, iLen As Integer
   'end 2017/9/7
   Dim RsTemp As New ADODB.Recordset
   'Add By Sindy 2015/7/24
   Dim strPrintData As String, strTemp As String
   'Dim ff1 As Integer, strFileName As String
   '2015/7/24 END
   Dim m_bolEmail As Boolean, m_bolPlusPaper As Boolean
   Dim strPrintData2 As String 'Added by Morgan 2016/11/2
   Dim strLD27 As String, strLP41 As String, strLD16 As String 'Add By Sindy 2019/12/4
   
   strDate = strSrvDate(1)
GetCurrTime:
   'Modify By Cheng 2003/04/22
   '抓Server的時間
'   strTime = Format(Time, "HHMMSS")
   strTime = Right("000000" & ServerTime, 6)
   'Add By Cheng 2003/03/14
   '取得日期及時間
   pub_strDate = strDate
   pub_strTime = strTime
    
   'Modify By Sindy 2019/11/26 為使產生的定稿資料有秒差
   strSql = "update LETTERDEMAND set LD01='" & strUserNum & "'" & _
            " where LD01='" & strUserNum & "' and LD02=" & strDate & _
            " and LD03=" & strTime & ""
   cnnConnection.Execute strSql, intR
   If intR > 0 Then '資料已存在
      Sleep 100
      GoTo GetCurrTime
   End If
   '2019/11/26 END
   
   strOrient = strPrintType
   strSplitPos = "NULL"
   If m_SplitPos > 0 Then
      strSplitPos = CStr(m_SplitPos)
   End If
   
'Modify by Morgan 2010/11/12
'   strSql = "INSERT INTO LETTERDEMAND (LD01,LD02,LD03,LD04,LD05,LD06,LD07,LD08,LD09,LD10,LD11,LD12,LD13,LD14,LD15) " & _
'               "VALUES ('" & strUserNum & "'," & _
'                        strDate & "," & _
'                        strTime & "," & _
'                        DBNullString(m_CP09) & "," & _
'                        DBNullString(m_CP01) & "," & _
'                        DBNullString(m_CP02) & "," & _
'                        DBNullString(m_CP03) & "," & _
'                        DBNullString(m_CP04) & "," & _
'                        DBNullString(m_CP10) & "," & _
'                        DBNullString(m_FinalSty) & "," & _
'                        DBNullString(m_Situ) & "," & _
'                        DBNullString(strOrient) & "," & _
'                        m_Copys & "," & _
'                        strSplitPos & "," & _
'                        "'" & ChgSQL(strData) & " ') "
'   cnnConnection.Execute strSql
'   'add by nickc 2006/09/07 外商陳金蓮增加  FCT 所有的定稿都不放  除了期限管制表外
'   'Modify by Morgan 2008/8/25 +編輯模式也不放
'   'Modify by Morgan 2009/11/18 +FMP定稿(strUserNum = strFMPNum)
'   If (m_CP01 = "FCT" And m_FinalSty <> "10") Or strUserNum = strFMPNum Or bolEdit = True Then
'        strSql = "update LETTERDEMAND set ld16='*' where ld01='" & strUserNum & "' and ld02=" & strDate & " and ld03=" & strTime & " "
'        cnnConnection.Execute strSql
'   End If

   'Modified by Morgan 2017/9/7 O12(UTF8)當超過一定長度會發生ORA-01461錯誤,改2000bytes
   'strData1 = PUB_LeftB(strData, 4000)
   'If Len(strData1) < Len(strData) Then
   '   strData2 = Mid(strData, Len(strData1) + 1)
   '   'Add By Sindy 2015/7/24 檢查定稿內容是否還是太大
   '   strPrintData = ""
   '   If Len(strData2) > 4000 Then
   '      strTemp = strData2
   '      strData2 = PUB_LeftB(strTemp, 4000)
   '      strPrintData = Mid(strTemp, Len(strData2) + 1)
   '   End If
   '   '2015/7/24 END
   'End If
   strTemp = strData
   iLen = 1300
   For ii = 0 To 9
      'Modified by Morgan 2018/9/10 O12欄位長度單位改用char,不用再考慮位元數
      'Modified by Morgan 2018/9/11 還原(UpdateBatch會當)
      arrData(ii) = PUB_LeftB(strTemp, iLen)
     ' arrData(ii) = Left(strTemp, iLen)
      'end 2018/9/10
      If Len(arrData(ii)) < Len(strTemp) Then
         strTemp = Mid(strTemp, Len(arrData(ii)) + 1)
      Else
         strTemp = ""
         Exit For
      End If
   Next
   If strTemp <> "" Then
      strPrintData = strTemp
   End If
   'end 2017/9/7
   
   'Modify By Sindy 2015/10/30 FCP催年費催實審時,因電子檔已存放卷宗區,不需留所列印份數減一份
   'Modify By Sindy 2016/1/26 FCP公開通知函、年費逾期、專利權消滅,因電子檔已存放卷宗區,不需留所列印份數減一份
   'If m_CP01 = "FCP" And m_FinalSty = "08" Then
   If m_CP01 = "FCP" And (m_FinalSty = "08" Or m_FinalSty = "13" Or m_FinalSty = "14") Then
      m_Copys = m_Copys - 1
   End If
   '2015/10/30 END
   'Add By Sindy 2015/12/7 非E化且有c.c.時,定稿信多印一份
   If m_CP01 = "FCP" And m_FinalSty = "08" And m_Situ <> "98" Then
      m_bolEmail = PUB_GetEMailFlag(m_Rule, True, , m_bolPlusPaper)
      If m_bolEmail = False And InStr(ExceptFieldData("副本聯絡人"), "c.c.") > 0 Then
         m_Copys = m_Copys + 1
      End If
   End If
   '2015/12/7 END
   
   'Add By Sindy 2019/12/4 判斷副檔名
   strLD27 = "NULL"
   'Added by Morgan 2021/3/19
   If m_LD27 <> "" Then
      strLD27 = m_LD27
   'end 2021/3/19
   ElseIf strLetterRecNo <> "" Then
      strExc(0) = "select * from letterprogress where lp01='" & strLetterRecNo & "'"
      intI = 1
      Set AdoRecordSet3 = ClsLawReadRstMsg(intI, strExc(0))
      If intI = 1 Then
         strLP41 = "" & AdoRecordSet3.Fields("LP41") '是否為回覆單
      End If
      'Modify By Sindy 2021/10/18 要列印出來的定稿
      If m_CP01 = "T" And m_FinalSty = "04" And m_Situ = "00" Then
         'T-04-000-00=案件回覆單
         strLD27 = UCase("BLANK")
         strSql = "update letterprogress set LP41='Y' where lp01='" & strLetterRecNo & "'"
         cnnConnection.Execute strSql, intR
      Else
      '2021/10/18 END
         If strLP41 = "Y" Then
            '回覆單
            strLD27 = UCase("BLANK")
         'Modify By Sindy 2020/11/19 T-171043:業務員期限管制-英文定稿
         '   (Mid(m_CP01, 1, 1) = "T" And strOrient <> "5" And strOrient <> "6") => Mid(m_CP01, 1, 1) = "T"
         '   考慮系統出的都是客戶函,申請書和指示信應該不會Run到此段程式,所以直接存CUS
         ElseIf (InStr("'P','PS','CFP','CPS'", "'" & m_CP01 & "'") > 0 And strOrient = "1") Or _
            Mid(m_CP01, 1, 1) = "T" Then
            '客戶函
            strLD27 = UCase("CUS")
         Else
            '申請書或指示信
            strLD27 = UCase("DATA")
         End If
      End If
   End If
   '2019/12/4 END
   
   'Add By Sindy 2019/11/21 新增前先把舊資料刪除,後續電子化轉檔時方便合併上傳卷宗區
   'Modify By Sindy 2019/12/5 拿掉判斷 LD01='" & strUserNum & "'
   strSql = "delete LETTERDEMAND where LD05='" & m_CP01 & "' and LD06='" & m_CP02 & "' and LD07='" & m_CP03 & "' and LD08='" & m_CP04 & "'" & _
            " and LD09='" & m_CP10 & "' and LD10='" & m_FinalSty & "' and LD11='" & m_Situ & "'" & _
            IIf(m_CP09 = "", "", " and LD04='" & m_CP09 & "'")
   cnnConnection.Execute strSql, intI
   '2019/11/21 END
   
   strSql = "select * from LETTERDEMAND where rownum<1"
   With RsTemp
   .CursorType = adOpenDynamic
   .CursorLocation = adUseClient
   .LockType = adLockBatchOptimistic
   .Open strSql, cnnConnection
   .AddNew
   .Fields("LD01") = strUserNum
   .Fields("LD02") = strDate
   .Fields("LD03") = strTime
   .Fields("LD04") = m_CP09
   .Fields("LD05") = m_CP01
   .Fields("LD06") = m_CP02
   .Fields("LD07") = m_CP03
   .Fields("LD08") = m_CP04
   .Fields("LD09") = m_CP10
   .Fields("LD10") = m_FinalSty
   .Fields("LD11") = m_Situ
   .Fields("LD12") = strOrient
   .Fields("LD13") = m_Copys
   .Fields("LD14") = IIf(strSplitPos = "NULL", Null, strSplitPos)
   .Fields("LD27") = IIf(strLD27 = "NULL", Null, strLD27) 'Add By Sindy 2019/12/4 副檔名
   strLD16 = "NULL" 'Add By Sindy 2019/12/4
   'Modified by Morgan 2017/9/7
   '.Fields("LD15") = strData1
   .Fields("LD15") = arrData(0)
   'end 2017/9/7
   If (m_CP01 = "FCT" And m_FinalSty <> "10") Or strUserNum = strFMPNum Or bolEdit = True Then
      .Fields("LD16") = "*"
      strLD16 = "*" 'Add By Sindy 2019/12/4
      
   'Added by Morgan 2015/7/9 E化不印
   'Modified by Morgan 2015/7/13 抓橫式(申請書和客戶函的發文號相同無法區分)
  'Modified by Lydia 2019/05/22 +橫式雙面LD12=8
   'ElseIf strOrient = "1" And strLetterRecNo <> "" Then
   ElseIf (strOrient = "1" Or strOrient = "8") And strLetterRecNo <> "" Then
      If ChkNoPrint(strLetterRecNo) = True Then
         .Fields("LD16") = "*"
         strLD16 = "*" 'Add By Sindy 2019/12/4
      End If
   'end 2015/7/9
   
   'Add By Sindy 2019/11/22
   'T案有轉檔的檢查是否不印
   'Modify By Sindy 2020/11/26 1701.註冊證, 1728.收款寄證均要列印出來
   ElseIf Left(m_CP01, 1) = "T" And strLetterRecNo <> "" And _
      (m_CP10 <> "1701" And m_CP10 <> "1728") Then
      If ChkNoPrint3(strLetterRecNo) = True Then
         .Fields("LD16") = "*"
         strLD16 = "*" 'Add By Sindy 2019/12/4
      End If
      
   'Added by Morgan 2015/10/27
   'P案指示信有轉檔的不印
   ElseIf strOrient = 6 And m_CP01 = "P" And strLetterRecNo <> "" Then
      If ChkNoPrint2(strLetterRecNo) = True Then
         .Fields("LD16") = "*"
         strLD16 = "*" 'Add By Sindy 2019/12/4
      End If
   'end 2015/10/27
   
   'Added by Morgan 2018/9/26
   'CFP指示信都不印
   'Modified by Morgan 2021/3/11 證書除外(寶齡富錦案為英文定稿且證書要印紙本)
   ElseIf strOrient = 4 And m_CP01 = "CFP" And strLetterRecNo <> "" And m_FinalSty <> "05" Then
      .Fields("LD16") = "*"
      strLD16 = "*" 'Add By Sindy 2019/12/4
   End If
   
   'Added by Morgan 2023/7/26
   'FMP案A類發文客戶函不印
   If m_CP01 = "P" And Left(strLetterRecNo, 1) = "A" And strLD27 = "CUS" And bNoPrint = False And strLD16 <> "*" Then
      If PUB_ChkIsFMP(m_CP01, m_CP02, m_CP03, m_CP04) = True Then
         bNoPrint = True
      End If
   End If
   'end 2023/7/26
   
   'Modified by Morgan 2017/9/7
   '.Fields("LD17") = strData2
   .Fields("LD17") = arrData(1)
   'end 2017/9/7
   .Fields("LD18") = strLetterRecNo 'Added by Morgan 2014/4/11
   'Added by Morgan 2017/9/7
   For ii = 2 To 9
      .Fields("LD" & 17 + ii) = arrData(ii)
   Next
   'end 2017/9/7
   
   'Added by Morgan 2018/7/3 回覆單要更新信函進度 LP41
   If strLetterRecNo <> "" And m_CP01 = "CFP" And m_FinalSty = "03" And m_Situ = "12" Then
      strSql = "update letterprogress set LP10='',LP41='Y' where lp01='" & strLetterRecNo & "'"
      cnnConnection.Execute strSql, intI
      .Fields("LD16") = "*" 'Added by Morgan 2018/11/12 回覆單整批不印--禧佩
      strLD16 = "*" 'Add By Sindy 2019/12/4
   End If
   'end 2018/7/3
   
   'Added by Morgan 2021/3/21
   If bNoPrint Then
      .Fields("LD16") = "*"
      strLD16 = "*"
   End If
   'end 2021/3/21
   
   .UpdateBatch
   
   'Added by Morgan 2016/8/29
   '國內客戶函檢查是否有副本收件人,若有則自動新增990的B類收文、定稿及信函進度
   'LD03+1否則會和正本定稿duplicate
   strPrintData2 = ""
   If strDataCC <> "" Then
      If str990CP09 = "" Then
         If PUB_Add990CP(m_CP01, m_CP02, m_CP03, m_CP04, strLetterRecNo, str990CP09, m_LP33, m_LP34) = True Then
            '已電子化的系統還要更新LP
            'Removed by Morgan 2018/11/21 改 PUB_Add990CP 內
            'If strLetterRecNo <> "" Then
            '   '正本已判發要更新副本相關欄位
            '   strSql = "update letterprogress a set (lp04,lp05,lp10,lp11,lp26,lp27,lp28,lp29,lp30,lp32)=(select b.lp04,b.lp05,b.lp10,b.lp11,b.lp26,b.lp27,b.lp28,b.lp29,b.lp30,b.lp32 from letterprogress b where b.lp01='" & strLetterRecNo & "')" & _
            '      " where lp01='" & str990CP09 & "' and exists(select * from letterprogress b where b.lp01='" & strLetterRecNo & "' and b.lp05>0)"
            '   cnnConnection.Execute strSql, intI
            '   If intI = 1 Then
            '      'E化副本自動發文
            '      strSql = "update caseprogress set cp28=cp09,cp127=to_char(sysdate,'YYYYMMDD'),cp128=to_char(sysdate,'HH24MISS') where cp09='" & str990CP09 & "' and exists(select * from caseprogress b where b.cp09='" & strLetterRecNo & "' and cp154='QPGMR')"
            '      cnnConnection.Execute strSql, intI
            '      If intI = 1 Then
            '         strSql = "update caseprogress set cp154='QPGMR' where cp09='" & str990CP09 & "'"
            '         cnnConnection.Execute strSql, intI
            '      End If
            '   End If
            'End If
            'end 2018/11/21
            
           
         
            'Modified by Morgan 2017/9/7
            'strData1 = PUB_LeftB(strDataCC, 4000)
            'If Len(strData1) < Len(strDataCC) Then
            '   strData2 = Mid(strDataCC, Len(strData1) + 1)
            '   strTemp = strData2
            '   strData2 = PUB_LeftB(strTemp, 4000)
            '   If Len(strData2) < Len(strTemp) Then
            '      strPrintData2 = Mid(strTemp, Len(strData2) + 1)
            '   End If
            'End If
            'strSql = "insert into letterdemand(ld01,ld02,ld03,ld04,ld05,ld06,ld07,ld08,ld09,ld10,ld11,ld12,ld13,ld15,ld16,ld17,ld18)" & _
               " select ld01,ld02,ld03+1,ld04,ld05,ld06,ld07,ld08,ld09,ld10,ld11,ld12,ld13,'" & ChgSQL(strData1) & "',ld16,'" & ChgSQL(strData2) & "','" & str990CP09 & "'" & _
               " from letterdemand where ld01='" & strUserNum & "' and ld02=" & strDate & " and ld03=" & strTime
            'cnnConnection.Execute strSql, intI
         End If
      End If
      
      If str990CP09 <> "" Then
         strDataCC = Replace(strDataCC, "第" & Right(strLetterRecNo, 6) & "號", "第" & Right(str990CP09, 6) & "號", 1, 1) 'Added by Morgan 2016/12/14 發文字號要改成副本的收文號後6碼
         Erase arrData
         strTemp = strDataCC
         iLen = 1300
         For ii = 0 To 9
            'Modified by Morgan 2018/9/10 O12欄位長度單位改用char,不用再考慮位元數
            'Modified by Morgan 2018/9/11 還原(UpdateBatch會當)
            arrData(ii) = PUB_LeftB(strTemp, iLen)
            'arrData(ii) = Left(strTemp, iLen)
            'end 2018/9/10
            If Len(arrData(ii)) < Len(strTemp) Then
               strTemp = Mid(strTemp, Len(arrData(ii)) + 1)
            Else
               strTemp = ""
               Exit For
            End If
         Next
         If strTemp <> "" Then
            strPrintData2 = strTemp
         End If

         .AddNew
         .Fields("LD01") = strUserNum
         .Fields("LD02") = strDate
         .Fields("LD03") = strTime + 1
         .Fields("LD04") = m_CP09
         .Fields("LD05") = m_CP01
         .Fields("LD06") = m_CP02
         .Fields("LD07") = m_CP03
         .Fields("LD08") = m_CP04
         .Fields("LD09") = m_CP10
         .Fields("LD10") = m_FinalSty
         .Fields("LD11") = m_Situ
         .Fields("LD12") = strOrient
         .Fields("LD13") = m_Copys
         .Fields("LD14") = IIf(strSplitPos = "NULL", Null, strSplitPos)
         .Fields("LD27") = IIf(strLD27 = "NULL", Null, strLD27) 'Add By Sindy 2019/12/4 副檔名
         .Fields("LD15") = arrData(0)
         'Modify By Sindy 2019/12/4 Mark,改存變數值
         'Modified by Morgan 2022/5/24
         '只有給申請人的中文信會有副本信函且正副本收件人的E化設定不一定相同，需個別考慮是否列印紙本
         '.Fields("LD16") = IIf(strLD16 = "NULL", Null, strLD16)
         If bolEdit = True Then
            .Fields("LD16") = "*"
         ElseIf ChkNoPrint(str990CP09) = True Then
            .Fields("LD16") = "*"
         End If
         'end 2022/5/24
         
'         If (m_CP01 = "FCT" And m_FinalSty <> "10") Or strUserNum = strFMPNum Or bolEdit = True Then
'            .Fields("LD16") = "*"
'         'Modified by Lydia 2019/05/22 +橫式雙面LD12=8
'         'ElseIf strOrient = "1" And strLetterRecNo <> "" Then
'         ElseIf (strOrient = "1" Or strOrient = "8") And strLetterRecNo <> "" Then
'            If ChkNoPrint(strLetterRecNo) = True Then
'               .Fields("LD16") = "*"
'            End If
'         ElseIf strOrient = 6 And m_CP01 = "P" And strLetterRecNo <> "" Then
'            If ChkNoPrint2(strLetterRecNo) = True Then
'               .Fields("LD16") = "*"
'            End If
'         End If
         '2019/12/4 END
         .Fields("LD17") = arrData(1)
         .Fields("LD18") = str990CP09
         m_990CP09 = str990CP09 'Added by Morgan 2023/10/18
         For ii = 2 To 9
            .Fields("LD" & 17 + ii) = arrData(ii)
         Next
         .UpdateBatch
         'end 2017/9/7
      End If
      Sleep 1000 '避免連續產生定稿時發生會dupe(目前催年費快的時候只差1秒)
   End If
   'end 2016/8/29
   
   End With
   Set RsTemp = Nothing
'end 2010/11/12
   'Add By Sindy 2015/7/24 將超過的定稿內容存成文字檔,放至桌面上,供人員使用
   If strPrintData <> "" Or strPrintData2 <> "" Then 'Modified by Morgan 2016/11/2 +strPrintData2
'      If ff1 > 0 Then Close #ff1
'      ff1 = FreeFile
'      strFileName = m_CP01 & "-" & m_CP02 & "-" & m_CP03 & "-" & m_CP04 & " " & m_CP10 & " " & m_FinalSty & " " & m_Situ & "內容太大的定稿內容.txt"
'      Open PUB_Getdesktop & "\" & strFileName For Output As ff1
'      Print #ff1, strPrintData
'      Close ff1
'      MsgBox "定稿內容因案件資料過多，無法完整產生於原定稿中，" & vbCrLf & vbCrLf & "因此超過的部份放置 " & PUB_Getdesktop & "\" & strFileName
      MsgBox "定稿內容因案件資料過多，無法完整儲存定稿內容，請至「定稿資料維護」按「修改鍵」重新產生完整定稿內容!!"
   End If
   '2015/7/24 END
End Sub

'Added by Morgan 2015/7/9
'檢查E化的不必列印(LP26='Y')
'有例外(掛號直寄或證書),加判斷發文室已發文(LP15='Y')
Private Function ChkNoPrint(pRecNo As String) As Boolean
   Dim stSQL As String, intR As Integer
   Dim rsQuery As ADODB.Recordset
   
   'Modified by Morgan 2015/9/1 FMP案除外(目前仍需列印紙本存卷)
   'Modified by Morgan 2021/11/15 全E化(LP26='E')也不要印，另是否實體改判斷LP51
   'stSQL = "select lp01 from letterprogress,caseprogress where lp01='" & pRecNo & "' and lp26='Y' and lp15='Y' and cp09(+)=lp01 and cp12 not like 'F%'"
   stSQL = "select lp01 from letterprogress,caseprogress where lp01='" & pRecNo & "' and lp26 is not null and lp51 is null and lp15='Y' and cp09(+)=lp01 and cp12 not like 'F%'"
   'Added by Morgan 2025/3/11 FMP的1913期限通知也不印(新增時會發EMail通知智權)--品薇
   stSQL = stSQL & " union select cp09 from caseprogress where cp09='" & pRecNo & "' and cp10='1913' and cp01='P' and cp12 like 'F%'"
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      ChkNoPrint = True
   End If
End Function
'Added by Morgan 2015/10/29
Private Function ChkNoPrint2(pRecNo As String) As Boolean
   Dim stSQL As String, intR As Integer
   Dim rsQuery As ADODB.Recordset
   
   'FMP案除外(目前仍需列印紙本存卷)
   'Modified by Morgan 2016/5/24 FMP也不印
   'stSQL = "select af01 from appform,caseprogress where af01='" & pRecNo & "' and cp09(+)=af01 and cp12 not like 'F%'"
   stSQL = "select af01 from appform where af01='" & pRecNo & "'"
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      ChkNoPrint2 = True
   End If
End Function

'Add By Sindy 2019/11/21
Private Function ChkNoPrint3(pRecNo As String) As Boolean
Dim stSQL As String, intR As Integer
Dim rsQuery As ADODB.Recordset
Dim stCustNo As String, salesNo As String, salesArea As String
Dim Str01 As String, Str02 As String, Str03 As String, Str04 As String
Dim bolPaper As Boolean
Dim strFaNo As String
   
   ChkNoPrint3 = False
   '巨京,MCTF電子化不列印定稿,用EMail寄信
   stSQL = "select cp01||'-'||cp02||'-'||cp03||'-'||cp04 from caseprogress where cp09='" & pRecNo & "'"
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      Str01 = SystemNumber(rsQuery(0), 1)
      Str02 = SystemNumber(rsQuery(0), 2)
      Str03 = SystemNumber(rsQuery(0), 3)
      Str04 = SystemNumber(rsQuery(0), 4)
      'MCTF案
      If Mid(PUB_GetAKindSalesNo(Str01, Str02, Str03, Str04), 1, 4) = "MCTF" Then
         ChkNoPrint3 = True
      End If
      stCustNo = GetPrjPeopleNum1(rsQuery(0)) '抓申請人1代碼
      If stCustNo <> "" Then
         salesArea = GetCuSales(stCustNo, salesNo)
         '巨京
         If salesNo = "96029" Or salesNo = "96030" Then
            ChkNoPrint3 = True
         End If
      End If
      '檢查是否有同時寄紙本
      If strSrvDate(1) >= T商標電子化第2階段啟用日 Then
         If ChkNoPrint3 = True Then
            'Modify By Sindy 2023/3/23 Mark: 因巨京,MCTF電子化後還是要維持列印定稿,就不用再檢查此判斷
            '                                不然變成要記得去設定 bolPaper=True
            ChkNoPrint3 = False
'            Call PUB_GetEMailFlag(Str01 & Str02 & Str03 & Str04, , , bolPaper)
'            If bolPaper = True Then ChkNoPrint3 = False
         End If
      Else
         '基本檔FC代理人-->基本檔申請人
         strFaNo = PUB_GetA1K03(Str01, Str02, Str03, Str04)
         If Mid(strFaNo, 1, 1) = "Y" Then 'FC代理人
            stSQL = "SELECT fa01 FROM fagent" & _
                    " WHERE Fa01='" & Mid(strFaNo, 1, 8) & "' and Fa02='" & Mid(strFaNo, 9, 1) & "'" & _
                    " AND FA119 IS NOT NULL" & _
                    " AND instr(FA119,'寄送')>0"
            intR = 1
            Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
            If intR = 1 Then
               ChkNoPrint3 = False '須寄送,要列印出紙本
            End If
         End If
      End If
   End If
End Function

'Added by Morgan 2014/6/19
'Modified by Morgan 2021/8/13 +pLP26:是否E化(Y=一般E化案件, E=E化客戶)
'檢查是否有信函進度
Private Function ChkIsELetter(pLP01 As String, Optional pLP26 As String) As Boolean
   Dim stSQL As String, intR As Integer
   Dim rsQuery As ADODB.Recordset
   
   stSQL = "select * from letterprogress where lp01='" & pLP01 & "'"
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      ChkIsELetter = True
      pLP26 = "" & rsQuery("LP26")
   End If
End Function

''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' 列印定稿
' Input : strUser ==> 使用者代碼
' Output : 0 = 成功
'          1 = 無該使用者代碼所需列印的資料
'          2 = 發生異常錯誤
' 說明 : 此函式只會列印資料庫中符合該使用者的待印資料
'            |&.......&|符號間的內容副本不印
'            |\.......\|符號間的內容第一份不印
'            |*......*|符號間的內容第一二份不印(P-01-601-06&07,P-01-605-07&08 除外)
'            |@......@|符號間的內容只印在第一份
'            |$......$|符號間的內容只印在最後一份(1份以上有效)
'            |%......%|符號間的內容最後一份不印(1份以上有效)
'            |?......?|符號間放子定稿的中文說明將在列印前才讀取(應付列印內容超過4000字問題---Morgan)
'                       2004/09/16 nick 修改可以印之前再到資料庫抓資料 |?識別碼:Key?|       ex:|?TMGoods:key?|
'                       請參閱  BeforePrintGetDBData
'            |#......#|符號間放子定稿的中文說明將在解析例外欄位前讀取並組成完整定稿內容(為應付定稿內容超過4000字問題---Morgan)
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
'Modify By Cheng 2002/08/21
'Public Function PrinterLetterDB(ByVal strUser As String) As Integer
'加傳入直式或橫式
'Public Function PrinterLetterDB(ByVal strUser As String, _
'   Optional ByRef strDL02 As String = "", _
'   Optional ByRef strDL03 As String = "") As Integer

'Modify by Morgan 2011/3/1 +bolPrintReverse:反序列印
'Modify by Morgan 2011/7/12 +strOrientation 可以傳 4
'Modify by Morgan 2011/7/20 +bolOlderLetter 是否為指示信
'Modify by Morgan 2014/3/11 +pCopys 份數
'Modify by Amy 2018/07/30 +strFormName
'Modified by Morgan 2022/11/3 +pMaxRow 最大筆數
Public Function PrinterLetterDB(ByVal strUser As String, _
   Optional ByRef strOrientation As String, _
   Optional ByRef strDL02 As String = "", _
   Optional ByRef strDL03 As String = "", _
   Optional ByVal bolPrintReverse As Boolean = False, _
   Optional ByVal pCopys As Integer = 0, _
   Optional ByVal pExport2Pdf As Boolean = False, _
   Optional ByVal pPdfSaveName As String, _
   Optional ByVal strFormName As String = "", _
   Optional ByVal pMaxRow As Integer = 0) As Integer
   
   'Add by Morgan 2011/6/1
   Dim bolAlwaysHead As Boolean '是否固定印信頭
   Dim iPicNo As Integer, iPicNo2 As Integer '圖檔編號
   Dim iPicNoLst As Integer '前次信頭編號
   Dim stFileName As String
   Dim stFileName2 As String 'Added by Morgan 2011/12/12 中所善向曾發生頁尾印成頁首的圖故另外宣告變數存放頁尾圖檔
   Dim oShape
   'end 2011/6/1
   Dim strSql As String
   Dim rsTmp As ADODB.Recordset
   ' 日期
   Dim strDate As String
   Dim strTime As String
   ' 列印方向
   Dim bLandscape As Boolean
   ' 系統別
   Dim strKEY01 As String
   ' 文字內容
   Dim strData As String
   ' 定稿別
   Dim strType As String
   ' 份數
   Dim nCopys As Integer
   ' 分割的位置
   Dim nSplitPos As Long
   Dim strPage1 As String
   Dim strNewPage1 As String
   Dim jj As Integer
   'Modified by Lydia 2020/02/17 ii As Integer=> lngCnt as Long
   'Dim ii As Integer
   Dim lngCnt As Long
   'end 2020/02/17
   Dim StrSQLa As String
   Dim rsA As New ADODB.Recordset
   Dim intNowCopy As Integer '目前份數
   Dim blnFormatSet As Boolean '是否設定格式(只要設定一次即可)
   Dim oWord As Word.Application
   Dim bVisible As Boolean
   Dim bolBarShow As Boolean
   'Added by Morgan 2013/6/26
   Dim iCopyNo As Integer, iCopy As Integer, iCopys As Integer
   Dim bolReverse As Boolean
   Dim stComp As String 'Added by Morgan 2013/12/30
   Dim strFindText As String 'Add By Sindy 2014/10/9
   Dim intCaseKind As Integer 'Add By Sindy 2015/7/16
   Dim lngLast As Long
   Dim iHeadCount As Integer
   Dim showColorFirst As Boolean 'Add by Amy 2018/08/01 是否先抓彩色代表圖
   Dim strReplText As String  'Added by Lydia 2020/02/17
   Dim strLD10 As String 'Add By Sindy 2020/2/21 定稿別
   Dim bolTwLtr As Boolean 'Added by Morgan 2020/3/26 是否中文對內定稿
   Dim bolFCTJpTrans As Boolean 'Added by Morgan 2023/2/6 是否FCT日譯文
   Dim bolPrintGazette As Boolean, strPdfFile As String, strPdfPrinter As String 'Added by Morgan 2024/11/27 是否印公報
   
   showColorFirst = True 'Added by Morgan 2021/6/30 改預設先抓彩色代表圖 --經理
   
   bolBarShow = Forms(0).StatusBar1.Visible
   Forms(0).StatusBar1.Visible = True
    
    'Add By Cheng 2002/11/18
    ' 若是從整批列印進入, 刪除兩天前(工作天)定稿資料
    If strDL02 = "" And strDL03 = "" Then
        
        '***例外欄位不論何系統皆刪除前五個工作天的資料
        'Modify by Morgan 2010/1/12 員工編號F字頭控制20個工作天
        'Modify by Morgan 2011/5/4  改為刪除10個工作天前的資料--採陳金蓮建議
        'Modify by Morgan 2015/1/22 員工編號F字頭改30個工作天
        'Modify by Morgan 2017/1/17 再改國外部人員都留30個工作天--陳金蓮
        'Modify by Morgan 2022/8/17 統一改都留30個工作天,內專也有需求--陳玲玲
        'strSql = "Delete From ExceptCondition Where ET04<'F' AND ET07 < " & DBDATE(PUB_GetWorkDay(-10))
        'strSql = "Delete From ExceptCondition Where ET07 < " & DBDATE(PUB_GetWorkDay(-10)) & " and not exists(select * from staff where st01=ET04 and substr(st03,1,1)='F')"
        'cnnConnection.Execute strSql, intI
        'strSql = "Delete From ExceptCondition Where ET04>='F' AND ET07 < " & DBDATE(PUB_GetWorkDay(-30))
        'strSql = "Delete From ExceptCondition Where ET07 < " & DBDATE(PUB_GetWorkDay(-30)) & " and exists(select * from staff where st01=ET04 and substr(st03,1,1)='F')"
        strSql = "Delete From ExceptCondition Where ET07 < " & DBDATE(PUB_GetWorkDay(-30))
        cnnConnection.Execute strSql, intI
        '所有系統類別一律刪前五個工作天的資料
        'strSql = "DELETE FROM LETTERDEMAND WHERE LD01<'F' AND LD02 < " & DBDATE(PUB_GetWorkDay(-10))
        'strSql = "DELETE FROM LETTERDEMAND WHERE LD02 < " & DBDATE(PUB_GetWorkDay(-10)) & " and not exists(select * from staff where st01=LD01 and substr(st03,1,1)='F')"
        'cnnConnection.Execute strSql, intI
        'strSql = "DELETE FROM LETTERDEMAND WHERE LD01>='F' AND LD02 < " & DBDATE(PUB_GetWorkDay(-30))
        'strSql = "DELETE FROM LETTERDEMAND WHERE LD02 < " & DBDATE(PUB_GetWorkDay(-30)) & " and exists(select * from staff where st01=LD01 and substr(st03,1,1)='F')"
        strSql = "DELETE FROM LETTERDEMAND WHERE LD02 < " & DBDATE(PUB_GetWorkDay(-30))
        cnnConnection.Execute strSql, intI
    End If
    
    'Add by Morgan 2008/7/16  因代表圖若為wmf格式有時會無法在使用後刪除故於此處做
    If Dir(App.path & "\*.wmf") <> "" Then
      Kill App.path & "\*.wmf"
    End If
    
   ' 預設無資料
   PrinterLetterDB = 1
   
   '整批列印
   'Modify By Cheng 2002/09/17
'   If IsMissing(strDL02) And IsMissing(strDL03) Then
   'Modified by Morgan 2012/8/16 +收據公司別
   If strDL02 = "" And strDL03 = "" Then
        'Modify by Morgan 2004/11/11 橫印加英文格式
         strSql = "SELECT L.* FROM LETTERDEMAND L " & _
            "WHERE LD01 = '" & strUser & "' And LD16 Is Null And LD12='" & strOrientation & "' " & _
            " ORDER BY LD02, LD03 ASC "
        
        'Add By Cheng 2003/01/03
        StrSQLa = "Select * From Staff Where ST01='" & strUserNum & "' "
        rsA.CursorLocation = adUseClient
        rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
        If rsA.RecordCount > 0 Then
            '若部門別為外專程序
            If rsA("ST03") = "F22" Then
                '加列印方向條件
                '排序方式依日期, 定稿別, 本所案號
                'Modified by Morgan 2014/5/29 本所案號順序改為產生定稿的時間順序(Ex.年證費請款函會依管制人順序產生定稿)
                strSql = "SELECT L.* FROM LETTERDEMAND L " & _
                               "WHERE LD01 = '" & strUser & "' And LD16 Is Null And LD12='" & strOrientation & "' " & _
                               "ORDER BY LD02, LD10, LD03 "
            
            'Added by Morgan 2015/9/1
            '內專程序列印"12 - 催年費／實體審查通知函","19 - 年費逾期補繳通知函",排序要依業務區,申請人,接洽人排序(相同接洽人裝一封)
            'Modified by Morgan 2016/5/11 內專催年費要先照所別排序
            'Modified by Morgan 2016/7/22 非臺灣的年費逾期補繳通知函照輸入順序列印(非整批)--玲玲
            'Modified by Lydia 2019/05/22 +橫式雙面LD12=8
            'Modified by Morgan 2019/10/22 +P案非例行性通知函(P21)比照大宗方式列印
            'Modified by Morgan 2019/10/24 排序欄位+PA75
            'ElseIf rsA("ST03") = "P12" And strOrientation = "1" Then
            ElseIf rsA("ST03") = "P12" And (strOrientation = "1" Or strOrientation = "8") Then
               strSql = "SELECT L.*,DECODE(decode(ld05||ld10,'P21','1','P12','1','P19',DECODE(PA09,'000','1')),'1',ST06||CU12||CU13||PA75||PA26||NVL(PA149,CU127),'0') Srt FROM LETTERDEMAND L,patent,customer,staff " & _
                  "WHERE LD01 = '" & strUser & "' And LD16 Is Null And LD12='" & strOrientation & "' " & _
                  " and pa01(+)=ld05 and pa02(+)=ld06 and pa03(+)=ld07 and pa04(+)=ld08 and cu01(+)=substr(pa26,1,8) and cu02(+)=substr(pa26,9) and st01(+)=cu13" & _
                  " ORDER BY Srt, LD02, LD03"
            'end 2015/9/1
            End If
        End If
        If rsA.State <> adStateClosed Then rsA.Close
        Set rsA = Nothing
      
   '單筆列印
   Else
      strSql = "SELECT L.* FROM LETTERDEMAND L " & _
               "WHERE LD01 = '" & strUser & "' " & _
               " AND LD02 = " & Val(strDL02) & " " & _
               " AND LD03 = " & Val(strDL03) & " " & _
               " ORDER BY LD02, LD03 ASC "
   End If
   Set rsTmp = New ADODB.Recordset
   rsTmp.CursorLocation = adUseClient
   rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If rsTmp.RecordCount > 0 Then
      
      strOrientation = rsTmp.Fields("LD12") 'Add by Morgan 2011/6/28 修正單筆列印未傳入 strOrientation 參數問題
      
      Forms(0).StatusBar1.Panels(1).Text = "定稿列印中請稍候...( 0/" & rsTmp.RecordCount & " )"
      DoEvents
      
      strPdfPrinter = PUB_GetOsDefaultPrinter 'Added by Morgan 2024/11/29
      
   '預設目前所在份數
   intNowCopy = 0
   
On Error GoTo ERRORSECTION1
    
ReWord: 'Add By Sindy 2020/2/21
   'Modify by Morgan 2011/6/28 g_WordAp 有可能是 Object 或 Nothing
   'If g_WordAp Is Nothing Then
   If TypeName(g_WordAp) <> "Application" Then
      Set g_WordAp = New Word.Application
   ''Add by Morgan 2008/1/14
   ''如果原先的Word的正在使用中則另外開新的跑
   ElseIf g_WordAp.Visible = True Then
   'Modify by Morgan 2008/12/18 XP開新的Word會有錯誤訊息故取消
   '   Set oWord = g_WordAp
   '   Set g_WordAp = New Word.Application
   ''end 2008/1/14
      bVisible = g_WordAp.Visible
   'end 2008/12/18
   End If
   
   iPicNoLst = -1 'Added by Morgan 2012/8/16
   g_WordAp.Visible = False
   g_WordAp.Documents.add
   
   '尚未預設定稿格式
   blnFormatSet = False

On Error GoTo ERRORSECTION2

   If g_LetterDebug Then g_WordAp.Visible = True 'Added by Morgan 2017/9/5
   
   With g_WordAp.Application
      '.Selection.Font.Name = "標楷體" 'Removed by Morgan 2017/10/20 日文定稿折行會有問題，移到後面設定
      'Add by Morgan 2011/6/3
      '切換為整頁模式
      If .ActiveWindow.View.SplitSpecial = wdPaneNone Then
         .ActiveWindow.ActivePane.View.Type = wdPageView
      Else
         .ActiveWindow.View.Type = wdPageView
      End If
      'Added by Lydia 2019/05/22 橫式雙面LD12=8, 設頁首頁尾的為奇偶數不同(奇數頁才有)
      If "" & rsTmp.Fields("LD12") = "8" Then
          .ActiveDocument.PageSetup.OddAndEvenPagesHeaderFooter = True '奇偶數不同(奇數頁才有)
          '.ActiveDocument.PageSetup.DifferentFirstPageHeaderFooter = True '首頁不同
      End If
   End With
      
      Do While rsTmp.EOF = False
         'Add By Sindy 2023/8/4
         If rsTmp.Fields("LD12") = "8" And rsTmp.Fields("LD10") = "05" And rsTmp.Fields("LD11") = "08" And rsTmp.Fields("LD05") = "T" Then
            g_WordAp.Visible = True '插商標公報圖片才不會走位
         Else
            g_WordAp.Visible = False
         End If
         '2023/8/4 END
         g_LD18 = "" & rsTmp.Fields("LD18") 'Added by Morgan 2014/5/9
         
         Forms(0).StatusBar1.Panels(1).Text = "定稿列印中請稍候...( " & rsTmp.AbsolutePosition & "/" & rsTmp.RecordCount & " )"
         DoEvents
         
         ' 有資料
         PrinterLetterDB = 0
         
         '記錄目前所在份數
         intNowCopy = intNowCopy + 1
         ' 日期
         If IsNull(rsTmp.Fields("LD02")) = False Then
            strDate = rsTmp.Fields("LD02")
         End If
         ' 時間
         If IsNull(rsTmp.Fields("LD03")) = False Then
            strTime = rsTmp.Fields("LD03")
         End If
         ' 系統別
         strKEY01 = Empty
         If IsNull(rsTmp.Fields("LD05")) = False Then
            strKEY01 = rsTmp.Fields("LD05")
         End If
         'add by nickc 2006/03/28 指定變數內容 本所案號
         m_MySt(1) = CheckStr(rsTmp.Fields("LD05"))
         m_MySt(2) = CheckStr(rsTmp.Fields("LD06"))
         m_MySt(3) = CheckStr(rsTmp.Fields("LD07"))
         m_MySt(4) = CheckStr(rsTmp.Fields("LD08"))
         'Add bY Amy 2018/07/30 FCT定稿先抓彩圖
         If UCase(strFormName) = "FRM1105" And m_MySt(1) = "FCT" Then showColorFirst = True
         
         'Add by Morgan 2010/3/15
         
         ' 定稿別
         strType = "00"
         If IsNull(rsTmp.Fields("LD10")) = False Then
            strType = rsTmp.Fields("LD10")
         End If
         
         'Add by Morgan 2010/3/15
         m_MySt(5) = rsTmp.Fields("ld09")
         If IsNull(rsTmp.Fields("ld04")) Then
            m_SrcKey = m_MySt(1) & m_MySt(2) & m_MySt(3) & m_MySt(4) & "&" & m_MySt(5)
         Else
            m_SrcKey = rsTmp.Fields("ld04")
         End If
         m_CP01 = m_MySt(1)
         m_CP02 = m_MySt(2)
         m_CP03 = m_MySt(3)
         m_CP04 = m_MySt(4)
         m_CP10 = m_MySt(5)
         m_FinalSty = strType '定稿別
         m_Situ = rsTmp.Fields("LD11") '處理狀況
         PaSt = "PA01='" & m_MySt(1) & "' AND PA02='" & m_MySt(2) & "' AND PA03='" & _
            m_MySt(3) & "' AND PA04='" & m_MySt(4) & "'"
         TmSt = "TM01='" & m_MySt(1) & "' AND TM02='" & m_MySt(2) & "' AND TM03='" & _
            m_MySt(3) & "' AND TM04='" & m_MySt(4) & "'"
         LcSt = "LC01='" & m_MySt(1) & "' AND LC02='" & m_MySt(2) & "' AND LC03='" & _
            m_MySt(3) & "' AND LC04='" & m_MySt(4) & "'"
         HcSt = "HC01='" & m_MySt(1) & "' AND HC02='" & m_MySt(2) & "' AND HC03='" & _
            m_MySt(3) & "' AND HC04='" & m_MySt(4) & "'"
         SpSt = "SP01='" & m_MySt(1) & "' AND SP02='" & m_MySt(2) & "' AND SP03='" & _
            m_MySt(3) & "' AND SP04='" & m_MySt(4) & "'"
         
         m_User = strUser
         'end 2010/3/15
         
         ' 列印方向
         bLandscape = False
         If IsNull(rsTmp.Fields("LD12")) = False Then
            If rsTmp.Fields("LD12") = "2" Then
               bLandscape = True
            End If
         End If
         ' 份數
         If pCopys > 0 Then
            nCopys = pCopys
         Else
            nCopys = 1
            If IsNull(rsTmp.Fields("LD13")) = False Then
               nCopys = CInt(rsTmp.Fields("LD13"))
            End If
         End If
         
         'Modify By Sindy 2015/10/30 列印份數為0時,代表不列印
         If nCopys = 0 Then
            GoTo WordClose 'Add By Sindy 2016/1/26
            Exit Function
         End If
         
         ' 分割的位置
         nSplitPos = 0
         If IsNull(rsTmp.Fields("LD14")) = False Then
            nSplitPos = CInt(rsTmp.Fields("LD14"))
         End If
         ' 資料內容
         strData = Empty
         If IsNull(rsTmp.Fields("LD15")) = False Then
            'Modify by Morgan 2010/11/12
            'strData = rsTmp.Fields("LD15")
            'Modified by Morgan 2017/9/7
            'strData = rsTmp.Fields("LD15") & rsTmp.Fields("LD17")
            strData = rsTmp.Fields("LD15") & rsTmp.Fields("LD17") & rsTmp.Fields("LD19") & rsTmp.Fields("LD20") & rsTmp.Fields("LD21") & rsTmp.Fields("LD22") & rsTmp.Fields("LD23") & rsTmp.Fields("LD24") & rsTmp.Fields("LD25") & rsTmp.Fields("LD26")
            'end 2017/9/7
            'Add by Morgan 2004/7/7
            'Modify by Morgan 2010/12/10
            'strData = TransText(strData)
            Do While InStr(1, strData, "|?") <> 0
              strData = TransText(strData)
            Loop
            
            'Add By Sindy 2014/10/9
            'Modified by Morgan 2014/11/12
            'If InStr(strData, "簽名檔)#|") > 0 Then
            If InStr(strData, "簽名檔)#|") > 0 And InStr(strData, "自動簽名檔)#|") = 0 Then
            'end 2014/11/12
               strFindText = Mid(strData, InStrRev(Left(strData, InStr(strData, "簽名檔)#|")), "|#"), ((InStr(strData, "簽名檔)#|") + 5) + 1) - InStrRev(Left(strData, InStr(strData, "簽名檔)#|")), "|#"))
               strData = Replace(strData, strFindText, "")
            End If
            '2014/10/9 END
                        
            'Added by Morgan 2021/11/3 紙本不印公司章
            If pExport2Pdf = False And InStr(strData, "|#(自動公司章)#|") > 0 Then
               strFindText = "|#(自動公司章)#|"
               strData = Replace(strData, strFindText, "")
            End If
            'end 2021/11/3
         End If
        
         'Add by Morgan 2008/7/30
         'Modified by Lydia 2019/05/22 +橫式雙面LD12=8
         'If rsTmp.Fields("LD12") = 1 And InStr(strData, "鈞啟") > 0 Then
         If (rsTmp.Fields("LD12") = 1 Or rsTmp.Fields("LD12") = 8) And InStr(strData, "鈞啟") > 0 Then
            m_bolNewFormat = True
         Else
            m_bolNewFormat = False
         End If
         
         'Added by Morgan 2020/3/26
         If strSrvDate(1) >= 智慧所更名日 Then
            stComp = PUB_GetReceiptComp(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), True)
         Else
         'end 2020/3/26
            stComp = PUB_GetReceiptComp(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4)) 'Added by Morgan 2013/12/30
         End If 'Added by Morgan 2020/3/26
         
         'Add by Morgan 2011/6/1 客戶通知函(橫式)加印信頭
         'Modified by Lydia 2019/05/22 +橫式雙面LD12=8
         'If rsTmp.Fields("LD12") = 1 Then
         If (rsTmp.Fields("LD12") = 1 Or rsTmp.Fields("LD12") = 8) Then
      
            'Modify by Morgan 2011/7/4 +CFP,CPS
            'Modify by Morgan 2011/7/20 +P,PS
            'If m_MySt(1) = "CFT" Or m_MySt(1) = "CFC" Or m_MySt(1) = "CFP" Or m_MySt(1) = "CPS" Then
            'Modify by Morgan 2011/8/11 +L,LA
            'Modify by Morgan 2015/2/10 +S(目前沒有)
            'Modified by Lydia 2024/03/01 +ACS
            If m_MySt(1) = "CFT" Or m_MySt(1) = "CFC" Or m_MySt(1) = "CFP" Or m_MySt(1) = "CPS" Or m_MySt(1) = "P" Or m_MySt(1) = "PS" Or _
                         m_MySt(1) = "L" Or m_MySt(1) = "LA" Or m_MySt(1) = "S" Or m_MySt(1) = "ACS" Then
               bolAlwaysHead = True
               
               'Modified by Morgan 2015/2/10 改與信函下款一致
               'iPicNo = 10
               'Modified by Lydia 2024/03/01 +ACS
               If InStr(m_MySt(1), "T") > 0 Or m_MySt(1) = "S" Or m_MySt(1) = "ACS" Then
                  iPicNo = 12
               Else
                  iPicNo = 10
               End If
               'end 2015/2/10
               
               iPicNo2 = 11
               
               'Added by Morgan 2012/8/16
               '若收據公司別設定為 1 公司時,改用專利商標信頭
               'Modified by Morgan 2013/12/30
               'If m_MySt(1) = "CFP" Or m_MySt(1) = "P" Then
               '   If rsTmp.Fields("Comp") = "Y" Then
               '      iPicNo = 12
               '   End If
               'End If
               If stComp = "T" Then
                  iPicNo = 12
               ElseIf stComp = "J" Then
                  iPicNo = 28
                  'Modified by Morgan 2015/11/18
                  '統一用10樓的傳真--陳鳳英
                  'If m_MySt(1) = "CFT" Then
                  '   iPicNo2 = 29 'fax:25090804
                  'Else
                     iPicNo2 = 31 'fax:25011666
                  'End If
                  'end 2015/11/18
               End If
               'end 2013/12/30
               
            'Added by Morgan 2011/10/24
            'Modify By Sindy 2024/4/16 + Or m_MySt(1) = "FCT"
            ElseIf Left(m_MySt(1), 1) = "T" Or m_MySt(1) = "FCT" Then
               bolAlwaysHead = True
               iPicNo = 12
               iPicNo2 = 11
               'Added by Morgan 2013/12/30
               If stComp = "J" Then
                  iPicNo = 28
                  iPicNo2 = 31
               End If
               'end 2013/12/30
               
            'Added by Morgan 2016/4/8
            'FCP中文定稿(申請書除外)
            ElseIf (m_MySt(1) = "FCP" And strType <> "01") Then
               bolAlwaysHead = True
               iPicNo = 5
               iPicNo2 = 9
            'end 2016/4/8
            
            End If
               
            'Added by Morgan 2020/4/1
            If bolAlwaysHead = True Then
               If strSrvDate(1) >= 智慧所更名日 Then
                  PUB_GetLetterPicID stComp, m_MySt(1), iPicNo, iPicNo2, 1, False
                  bolTwLtr = True
               End If
            End If
            'end 2020/4/1
            
         'Add by Sindy 2015/7/16 +日文  外專程序的定稿均印信頭
         ElseIf rsTmp.Fields("LD12") = 3 Then
            'Modify by Morgan 2006/1/9 改用標楷體--請作單
            '.Selection.Font.Name = "細明體"
            'Modified by Morgan 2014/9/24 改回細明體 --毓芳
            '.Selection.Font.Name = "標楷體"
            'Modified by Morgan 2022/7/13 改 MS Mincho -- 毓芳, May
            'g_WordAp.Selection.Font.Name = "細明體"
            g_WordAp.Selection.Font.Name = "MS Mincho"
            'end 2022/7/13
            'end 2014/9/24
            
            g_WordAp.Selection.PageSetup.Orientation = wdOrientPortrait
            g_WordAp.Selection.Orientation = wdTextOrientationHorizontal
            'Modify by Morgan 2005/7/19 改12號字--春美,易雲
            '.Selection.Font.Size = 13
'Modify by Morgan 2005/7/19 改12號字--春美,易雲
               'g_WordAp.Selection.Font.Size = 13
'Modify By Sindy 2019/3/14 Mark.亭妙反應修改和列印的字體大小不一樣,因列印時這裡又會把字體全部改為12
'自然ChgWordFormat的小字都會又被改回來
'FCP-07-1603-06
'               g_WordAp.Selection.Font.Size = 12
'2019/3/14 END
            
            'Add by Morgan 2011/7/11
            'Modified by Morgan 2020/4/1 +FCT--陳金蓮
            If m_MySt(1) = "FCT" Or m_MySt(1) = "CFP" Or m_MySt(1) = "CFC" Or m_MySt(1) = "FCP" Or m_MySt(1) = "FG" Then
               bolAlwaysHead = True
               bolFCTJpTrans = False 'Added by Morgan 2023/2/6
               'Added by Morgan 2020/4/6
               '日文譯文不要信頭
               If m_MySt(1) = "FCT" Then
                  If ChkJPNoHead(rsTmp.Fields("LD09"), rsTmp.Fields("LD10"), rsTmp.Fields("LD11")) Then
                     bolAlwaysHead = False
                     bolFCTJpTrans = True
                  End If
               End If
               'end 2020/4/6
               
               'Added by Morgan 2020/3/26
               If strSrvDate(1) >= 智慧所更名日 Then
                  stComp = PUB_GetReceiptComp(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), True)
                  PUB_GetLetterPicID stComp, m_MySt(1), iPicNo, iPicNo2, 3, True, Pub_StrUserSt03
               Else
               'end 2020/3/26
                  
                  iPicNo = 5
                  iPicNo2 = 9
                  'Added by Morgan 2013/12/30
                  stComp = PUB_GetReceiptComp(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4))
                  '智權公司
                  If stComp = "J" Then
                     iPicNo = 21
                     'patent信箱
                     If m_MySt(1) = "CFP" Then
                        iPicNo2 = 22
                     'ipdept信箱
                     ElseIf m_MySt(1) = "CFT" Then
                        iPicNo2 = 24
                     End If
                  '專利處對國外都用專利法律公司(patent信箱)
                  ElseIf strUserNum <> strFMPNum And (m_MySt(1) = "CFP" Or m_MySt(1) = "P") Then
                     iPicNo2 = 18
                  End If
                  'end 2013/12/30
                  
               End If 'Added by Morgan 2020/3/26
            End If
            
         'Add by Sindy 2015/7/16 +英文  外專程序的定稿均印信頭
         ElseIf rsTmp.Fields("LD12") = 4 Then
            g_WordAp.Selection.Font.Name = "Times New Roman"
            g_WordAp.Selection.PageSetup.Orientation = wdOrientPortrait
            g_WordAp.Selection.Orientation = wdTextOrientationHorizontal
            g_WordAp.Selection.Font.Size = 12
            
            '一律要印信頭
            'Removed by Morgan 2020/4/1 FCT也要--陳金蓮
            'If ClsPDGetSystemKind(m_MySt(1), intCaseKind) = True Then
            '   If intCaseKind = 專利 Then bolAlwaysHead = True
            'End If
            bolAlwaysHead = True
            'end 2020/4/1
            
            'Added by Morgan 2020/3/26
            If strSrvDate(1) >= 智慧所更名日 Then
               stComp = PUB_GetReceiptComp(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), True)
               PUB_GetLetterPicID stComp, m_MySt(1), iPicNo, iPicNo2, 2, True, Pub_StrUserSt03
            Else
            'end 2020/3/26
            
               iPicNo = 5
               iPicNo2 = 9
               
               stComp = PUB_GetReceiptComp(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4))
               '智權公司
               If stComp = "J" Then
                  'patent信箱
                  If m_MySt(1) = "CFP" Then
                     iPicNo = 21
                     iPicNo2 = 22
                  'ipdept信箱
                  ElseIf m_MySt(1) = "CFT" Then
                     iPicNo = 21
                     iPicNo2 = 24
                  End If
               '專利處對國外都用專利法律公司(patent信箱)
               ElseIf strUserNum <> strFMPNum And (m_MySt(1) = "CFP" Or m_MySt(1) = "P") Then
                  iPicNo2 = 18
               End If
               
            End If 'Added by Morgan 2020/3/26
            
         'Add by Morgan 2011/7/21 +大陸指示信格式
         ElseIf rsTmp.Fields("LD12") = 6 Then
            bolAlwaysHead = True
            
            'Added by Morgan 2020/3/26
            If strSrvDate(1) >= 智慧所更名日 Then
               stComp = PUB_GetReceiptComp(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), True)
               PUB_GetLetterPicID stComp, m_MySt(1), iPicNo, iPicNo2, 1, True, Pub_StrUserSt03
            Else
            'end 2020/3/26
               
               iPicNo = 7
               iPicNo2 = 0
               
               'Added by Morgan 2013/12/30
               If m_MySt(1) = "P" Then
                  stComp = PUB_GetReceiptComp(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4))
                  '智權公司(patent信箱)
                  If stComp = "J" Then
                     iPicNo = 21
                     iPicNo2 = 26
                  '非智權公司都用專利法律(patent信箱)
                  Else
                     iPicNo = 19
                  End If
               End If
               'end 2013/12/30
            End If 'Added by Morgan 2020/3/26
         End If
         'end 2011/6/1
                  
         jj = g_WordAp.ActiveDocument.BuiltInDocumentProperties(wdPropertyPages) + 1  'Added by Lydia 2020/06/04 預估跳頁後的頁數;目前頁面+1
         
         'Added by Morgan 2012/8/16
         '若信頭不同時先列印
         'Modify By Sindy 2020/2/21 + Or _
            (rsTmp.Fields("LD12") = "7" And strSrvDate(1) < T商標電子化第2階段啟用日)
         'If iPicNoLst <> iPicNo And iPicNoLst > -1 Then
         'Modified by Lydia 2020/06/04 橫式雙面LD12=8,預估第二個案件以後,跳頁後的頁數不為奇數頁先列印,避免後面案件的版面不對; ex.T-174601第一頁的行數超過第一頁
         'If (iPicNoLst <> iPicNo And iPicNoLst > -1) Or _
            (rsTmp.Fields("LD12") = "7" And strSrvDate(1) < T商標電子化第2階段啟用日 And (strLD10 <> "" And strLD10 <> rsTmp.Fields("LD10"))) Then
         'Modified by Morgan 2024/11/27 +列印P台灣案的證書函要接著印公告公報
         If (strLD10 <> "" And bolPrintGazette) Or (iPicNoLst <> iPicNo And iPicNoLst > -1) Or _
            (rsTmp.Fields("LD12") = "7" And strSrvDate(1) < T商標電子化第2階段啟用日 And (strLD10 <> "" And strLD10 <> rsTmp.Fields("LD10"))) Or _
            ("" & rsTmp.Fields("LD12") = "8" And intNowCopy > 1 And (jj Mod 2) = 0) Then
            g_WordAp.Selection.WholeStory
            '若為日文定稿
            If strOrientation = "3" Then
               If (m_MySt(1) = "FCT" Or m_MySt(1) = "CFT" Or m_MySt(1) = "CFC" Or m_MySt(1) = "S") Then
                  'Modified by Morgan 2022/7/13 改 MS Mincho -- 毓芳, May
                  'g_WordAp.Selection.Font.Name = "細明體"
                  g_WordAp.Selection.Font.Name = "MS Mincho"
                  'Removed by Morgan 2022/12/20 取消,非英數字(符號、造字...)也會被影響 --經理、May
                  'g_WordAp.Selection.Font.Name = "Times New Roman" 'Added by Morgan 2022/12/14 英數字 -- May,毓芳沒意見
                  'end 2022/12/20
                  'end 2022/7/13
               Else
                  g_WordAp.Selection.Font.Size = 12
                  'Modified by Morgan 2014/9/24 改回細明體 --毓芳
                  'g_WordAp.Selection.Font.Name = "標楷體"
                  'g_WordAp.Selection.Font.Name = "Times New Roman"
                  'Modified by Morgan 2022/7/13 改 MS Mincho -- 毓芳, May
                  'g_WordAp.Selection.Font.Name = "細明體"
                  g_WordAp.Selection.Font.Name = "MS Mincho"
                  'end 2022/7/13
                  'end 2014/9/24
               End If
               
               
            Else
               g_WordAp.Selection.Font.Name = "標楷體" 'Added by Morgan 2017/10/20
               g_WordAp.Selection.Font.Name = "Times New Roman"
            End If
            
            '列印定稿
'Removed by Morgan 2013/7/1 改產生內容時就反序
'            'Modified by Morgan 2013/4/23
'            'word 2007 可能不支援,改有傳才設定
'            If bolPrintReverse = True Then
'               g_WordAp.Options.PrintReverse = True
'            End If
'            'end 2013/4/23
'end 2013/7/1

            g_WordAp.PrintOut Background:=False, Copies:=1, Collate:=True
            
'Removed by Morgan 2013/7/1 改產生內容時就反序
'            'Added by Morgan 2013/4/23 要還原否則會影響後面的定稿順序
'            If bolPrintReverse = True Then
'               g_WordAp.Options.PrintReverse = False
'            End If
'            'end 2013/4/23
'end 2013/7/1

            g_WordAp.Selection.WholeStory
            g_WordAp.Selection.Delete
            
            'Added by Morgan 2024/11/29
            '列印P台灣案的證書函要接著印公告公報
            If bolPrintGazette And strPdfFile <> "" Then
               PUB_PrintPDF strPdfFile, strPdfPrinter
               PUB_WaitUntilNoJob strPdfPrinter 'Added by Morgan 2025/1/15 等公報印完再繼續才能跟定稿搭配
            End If
            'end 2024/11/29
            
            intNowCopy = 1
            blnFormatSet = False
            
            'Add By Sindy 2020/2/21
            g_WordAp.ActiveDocument.Close wdDoNotSaveChanges
            intNowCopy = 0
            strLD10 = ""
            bolAlwaysHead = False
            
            GoTo ReWord
            '2020/2/21 END
         End If
         iPicNoLst = iPicNo
         strLD10 = "" & rsTmp.Fields("LD10") '定稿別
         'end 2012/8/16
         
         bolPrintGazette = PUB_ChkPrintGazette(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), m_FinalSty, strPdfFile) 'Added by Morgan 2024/12/3
         
         'Add by Morgan 2010/2/4
         With g_WordAp
            If intNowCopy > 1 Then
               '跳頁
               .Selection.EndKey Unit:=wdStory
               .Selection.InsertBreak Type:=wdPageBreak
            Else
               ' 清除原文件的資料內容
               .Selection.WholeStory
               .Selection.Delete
            End If
            
'Removed by Morgan 2015/7/21 併入下面的格式設定
'            If rsTmp.Fields("LD12") = 1 Then '橫式才有開窗問題
'               '開窗定稿
'               If m_bolNewFormat = True Then
'                  '固定行高
'                  .Selection.ParagraphFormat.LineSpacingRule = wdLineSpaceExactly
'                  .Selection.ParagraphFormat.LineSpacing = 15
'                  .Selection.PageSetup.TopMargin = .CentimetersToPoints(3.53)
'                  '下邊界加大
'                  .Selection.PageSetup.BottomMargin = .CentimetersToPoints(2.5)
'               Else
'                  .Selection.ParagraphFormat.LineSpacingRule = 0
'                  .Selection.PageSetup.TopMargin = .CentimetersToPoints(3.53)
'                  .Selection.PageSetup.BottomMargin = .CentimetersToPoints(2)
'               End If
'            'Add by Morgan 2011/10/24
'            ElseIf rsTmp.Fields("LD12") = 7 Then
'                  '固定行高
'                  .Selection.ParagraphFormat.LineSpacingRule = wdLineSpaceExactly
'                  .Selection.ParagraphFormat.LineSpacing = 15
'                  .Selection.PageSetup.TopMargin = .CentimetersToPoints(3.53)
'            End If
            
         End With
         'end 2010/2/4
               
        'Modify By Cheng 2003/01/16
        '若尚未設定定稿格式(只要設定一次即可)
        If Not blnFormatSet Then
            'blnFormatSet = True 'Removed by Morgan 2023/1/18 格式一律重設，否則跳頁後列距會還原為預設
         
    '         g_WordAp.Visible = False
             '設定文件格式
             With g_WordAp
                '.Selection.Font.Name = "標楷體" 'Removed by Morgan 2017/10/20 日文定稿折行會有問題，移到確認格式時設定
                If bLandscape Then
                   .Selection.PageSetup.Orientation = wdOrientLandscape
                   '直印平躺
                   .Selection.Orientation = wdTextOrientationHorizontalRotatedFarEast
                   .Selection.Font.Size = 16
                Else
                   .Selection.PageSetup.Orientation = wdOrientPortrait
                   .Selection.Orientation = wdTextOrientationHorizontal
                   .Selection.Font.Size = 14
                End If
                
               'Add by Morgan 2004/11/11 加英文版面
               'Modify by Morgan 2011/6/1 目前只有CFP用,其他維持原版面等用新信紙時再統一(其他系統也會設定成英文但僅限分類用)
               'Modify by Morgan 2011/7/12 英文日文都改用新信紙版面
               If (rsTmp.Fields("LD12") = 4 Or rsTmp.Fields("LD12") = 3) Then
                  '.Selection.ParagraphFormat.LineSpacingRule = 0
                  .Selection.PageSetup.LeftMargin = .CentimetersToPoints(3.175)
                  .Selection.PageSetup.RightMargin = .CentimetersToPoints(3.175)
                  '.Selection.PageSetup.TopMargin = .CentimetersToPoints(5)
                  'Added by Morgan 2023/2/6 FCT日譯文上邊界設3CM--79020
                  If m_MySt(1) = "FCT" And bolFCTJpTrans Then
                     .Selection.PageSetup.TopMargin = .CentimetersToPoints(3)
                  Else
                  'end 2023/2/6
                     .Selection.PageSetup.TopMargin = .CentimetersToPoints(4) 'Add By Sindy 2015/7/17 外專要改開窗信封,因此為了看到地址姓名而調整
                  End If 'Added by Morgan 2023/2/6
                  .Selection.PageSetup.BottomMargin = .CentimetersToPoints(3)
                  .Selection.PageSetup.FooterDistance = .CentimetersToPoints(2.5)
                  'Add by Morgan 2011/7/12 新信紙版面
                  If (m_MySt(1) = "FCT" Or m_MySt(1) = "CFT" Or m_MySt(1) = "CFC" Or m_MySt(1) = "S") Then
                     .Selection.Font.Size = 13
                  Else
                     .Selection.Font.Size = 12
                  End If
               
               Else
               
                  'Modified by Morgan 2016/4/8 +FCP中文定稿(申請書除外)
                  'Modified by Lydia 2019/05/22 +橫式雙面LD12=8
                  'If m_MySt(1) = "FCP" And rsTmp.Fields("LD12") = 1 And strType <> "01" Then
                  If m_MySt(1) = "FCP" And (rsTmp.Fields("LD12") = 1 Or rsTmp.Fields("LD12") = 8) And strType <> "01" Then
                     .Selection.Font.Size = 12
                  End If
                  
                  .Selection.PageSetup.LeftMargin = .CentimetersToPoints(2)
                  .Selection.PageSetup.RightMargin = .CentimetersToPoints(2)
                  
                  'Modified by Morgan 2014/5/12　要和編輯模式一樣
'                  If rsTmp.Fields("LD12") = 6 Then
'                     '固定行高
'                     .Selection.ParagraphFormat.LineSpacingRule = wdLineSpaceExactly
'                     .Selection.ParagraphFormat.LineSpacing = 15
'                     .Selection.PageSetup.TopMargin = .CentimetersToPoints(5.14)
'                     '下邊界加大
'                     .Selection.PageSetup.BottomMargin = .CentimetersToPoints(2.5)
'                  End If
                  'Modified by Lydia 2019/08/14 排除橫式雙面LD12=8
                  'Modified by Lydia 2019/08/19 取消橫式雙面LD12=8,因為行距有點壓到(ex.T220181)
                  'If bolAlwaysHead = True And rsTmp.Fields("LD12") <> 8 Then
                  'Memo by Lydia 2019/08/22 橫式雙面LD12=8的目前版面,若有調整需要一併修改"TMGoods第2頁"的計算方式
                  If bolAlwaysHead = True Then
                     '固定行高
                     .Selection.ParagraphFormat.LineSpacingRule = wdLineSpaceExactly
                     .Selection.ParagraphFormat.LineSpacing = 15
                     If rsTmp.Fields("LD12") = 6 Then
                        .Selection.PageSetup.TopMargin = .CentimetersToPoints(5.14)
                     Else
                        .Selection.PageSetup.TopMargin = .CentimetersToPoints(4)
                     End If
                     '下邊界加大
                     .Selection.PageSetup.BottomMargin = .CentimetersToPoints(2.5)
                  'Modified by Lydia 2019/05/22 +橫式雙面LD12=8
                  'ElseIf rsTmp.Fields("LD12") = 1 Then
                  ElseIf (rsTmp.Fields("LD12") = 1 Or rsTmp.Fields("LD12") = 8) Then
                     .Selection.PageSetup.TopMargin = .CentimetersToPoints(3.53)
                     If m_bolNewFormat = True Then
                        .Selection.ParagraphFormat.LineSpacingRule = wdLineSpaceExactly
                        .Selection.PageSetup.BottomMargin = .CentimetersToPoints(2.5)
                     Else
                        .Selection.ParagraphFormat.LineSpacingRule = 0
                        .Selection.ParagraphFormat.LineSpacing = 12
                        .Selection.PageSetup.BottomMargin = .CentimetersToPoints(2)
                     End If
                  
                  'Add by Morgan 2015/7/21 上面移來
                  ElseIf rsTmp.Fields("LD12") = 7 Then
                        '固定行高
                        .Selection.ParagraphFormat.LineSpacingRule = wdLineSpaceExactly
                        .Selection.ParagraphFormat.LineSpacing = 15
                        .Selection.PageSetup.TopMargin = .CentimetersToPoints(3.53)

                        'Add By Sindy 2019/11/21
                        If ((strType = "10" Or strType = "15") And Left(m_MySt(1), 1) = "T" And strSrvDate(1) >= T商標電子化啟用日) Or _
                           (Left(m_MySt(1), 1) = "T" And strSrvDate(1) >= T商標電子化第2階段啟用日) Then
                           '大->台
                           bolAlwaysHead = True
                           
                           'Added by Morgan 2020/3/26
                           If strSrvDate(1) >= 智慧所更名日 Then
                              stComp = PUB_GetReceiptComp(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), True)
                              PUB_GetLetterPicID stComp, m_MySt(1), iPicNo, iPicNo2, 1, True, Pub_StrUserSt03
                           Else
                           'end 2020/3/26
                              iPicNo = 7
                              iPicNo2 = 0
                           End If 'Added by Morgan 2020/3/26
                        End If
                        '2019/11/21 END
                  End If
                  'end 2014/5/12
               End If
               
               'Modify by Morgan 2008/7/23 都預設靠左與編輯模式一致 CFP-020900
               'Modify by Morgan 2004/11/11 FCP,FCT定稿跳行時不要分散對齊
               'If m_MySt(1) <> "FCP" And m_MySt(1) <> "FCT" Then
               '   .Selection.ParagraphFormat.Alignment = wdAlignParagraphJustify
               'Else
               '   .Selection.ParagraphFormat.Alignment = wdAlignParagraphLeft
               'End If
               .Selection.ParagraphFormat.Alignment = wdAlignParagraphLeft
               'end 2008/7/23
               
               .Selection.ParagraphFormat.FarEastLineBreakControl = False 'Added by Morgan 2013/4/15 不要避頭尾,否則word2000造字會有斷行問題
               .Selection.ParagraphFormat.DisableLineHeightGrid = True
                ' 90.07.25 modify by louis (首列凸排五個字元)
                Select Case strKEY01
                   ' 只有P類及FCP類的各式申請書才要首列凸排
                   ' Added by Lydia 2016/04/01 +T案的催審函
                   Case "P", "FCP", "T"
                   'Modify by Morgan 2009/9/18 P催審函是申請書才要凸排
                   'Modified by Morgan 2015/6/23
                   'If (strType = "01") Or (strKEY01 = "P" And strType = "16" And strPrintType = "5") Or (strKEY01 = "FCP" And strType = "11") Then
                   ' Modified by Lydia 2016/04/01 +T案的催審函T,11,000,03
                   'Modifiec by Lydia 2016/04/11 debug
                  ' If (strType = "01") Or (strKEY01 = "P" And strType = "16" And rsTmp.Fields("LD12") = "5") Or (strKEY01 = "FCP" And strType = "11") _
                        Or (strKEY01 = "T" And strType = "11" And "" & rsTmp.Fields("LD11") = "03") Then
                   If (strType = "01" And strKEY01 <> "T") Or (strKEY01 = "P" And strType = "16" And rsTmp.Fields("LD12") = "5") Or (strKEY01 = "FCP" And strType = "11") _
                        Or (strKEY01 = "T" And strType = "11" And "" & rsTmp.Fields("LD11") = "03") Then
                  'end 2015/6/23
                        If rsTmp.Fields("LD12") = 5 Then
                           'Modify by  Morgan 2004/12/23 只有FCP用16號字
                           'Modify by Morgan 2004/12/31 P也改回16號字;41200,42100,60114,60115官方申請書列外
                           'If strKEY01 = "FCP" Then
                           'Modify by Morgan 2007/9/21 加第三人申請技術報告80700
                           'If strKEY01 = "FCP" Or (strKEY01 = "P" And InStr("41200,42100,60114,60115", "" & rsTmp("LD09").Value & rsTmp("LD11").Value) = 0) Then
                           'Modified by Morgan 2013/3/26 +,60116,60117
                           'Modified by Morgan 2013/5/21 +,60511,60512
                           If strKEY01 = "FCP" Or (strKEY01 = "P" And InStr("41200,42100,60114,60115,60116,60117,60511,60512,80700", "" & rsTmp("LD09").Value & rsTmp("LD11").Value) = 0) Then
                              .Selection.Font.Size = 16
                           End If
                           .Selection.PageSetup.TopMargin = .CentimetersToPoints(3.17) 'Add by Morgan 2004/12/31
                           .Selection.ParagraphFormat.LeftIndent = .CentimetersToPoints(3)
                           'Modify by Morgan 2011/1/6 改與修改一致
                           '.Selection.ParagraphFormat.RightIndent = .CentimetersToPoints(1)
                           .Selection.ParagraphFormat.RightIndent = .CentimetersToPoints(0)
                        Else
                           .Selection.ParagraphFormat.LeftIndent = .CentimetersToPoints(2)
                           .Selection.ParagraphFormat.RightIndent = .CentimetersToPoints(0)
                        End If
                   
                   
                   'If strType = "01" Then  MODIFY BY SONIA 90.10.20
                         
                         .Selection.ParagraphFormat.SpaceBefore = 0
                         .Selection.ParagraphFormat.SpaceAfter = 0
                         .Selection.ParagraphFormat.LineSpacingRule = wdLineSpaceSingle
                         .Selection.ParagraphFormat.Alignment = wdAlignParagraphJustify
                         .Selection.ParagraphFormat.WidowControl = False
                         .Selection.ParagraphFormat.KeepWithNext = False
                         .Selection.ParagraphFormat.KeepTogether = False
                         .Selection.ParagraphFormat.PageBreakBefore = False
                         .Selection.ParagraphFormat.NoLineNumber = False
                         .Selection.ParagraphFormat.Hyphenation = True
                         ' Modified by Lydia 2016/04/01 +T案的催審函T,11,000,03
                         If strKEY01 = "T" And strType = "11" And "" & rsTmp.Fields("LD11") = "03" Then
                            .Selection.ParagraphFormat.FirstLineIndent = .CentimetersToPoints(-2)
                         Else
                            .Selection.ParagraphFormat.FirstLineIndent = .CentimetersToPoints(-1.7)
                         End If
                         .Selection.ParagraphFormat.OutlineLevel = wdOutlineLevelBodyText
                         .Selection.ParagraphFormat.AutoAdjustRightIndent = True
                         .Selection.ParagraphFormat.DisableLineHeightGrid = True
                         '.Selection.ParagraphFormat.FarEastLineBreakControl = True 'Removed by Morgan 2013/4/15 不要避頭尾,否則word2000造字會有斷行問題
                         .Selection.ParagraphFormat.WordWrap = True
                         .Selection.ParagraphFormat.HangingPunctuation = True
                         .Selection.ParagraphFormat.HalfWidthPunctuationOnTopOfLine = False
                         .Selection.ParagraphFormat.AddSpaceBetweenFarEastAndAlpha = True
                         .Selection.ParagraphFormat.AddSpaceBetweenFarEastAndDigit = True
                         .Selection.ParagraphFormat.BaseLineAlignment = wdBaselineAlignAuto
                        'Add By Cheng 2003/01/13
                        '加三個全形空白, 以與其他頁數的第一列起始位置對齊
                        If blnFormatSet = False Then
                           .Selection.TypeText "　　　"
                        End If
                      End If
                   'add by nick 2004/12/16
                   Case "FCT"
                        If rsTmp.Fields("LD12") = 5 Then
                           .Selection.Font.Size = 12
                           .Selection.ParagraphFormat.LeftIndent = .CentimetersToPoints(3)
                           'Modify by Morgan 2011/1/6 改與修改一致
                           '.Selection.ParagraphFormat.RightIndent = .CentimetersToPoints(1)
                           .Selection.ParagraphFormat.RightIndent = .CentimetersToPoints(0)
                           .Selection.ParagraphFormat.SpaceBefore = 0
                           .Selection.ParagraphFormat.SpaceAfter = 0
                           .Selection.ParagraphFormat.LineSpacingRule = wdLineSpaceSingle
                           .Selection.ParagraphFormat.Alignment = wdAlignParagraphJustify
                           .Selection.ParagraphFormat.WidowControl = False
                           .Selection.ParagraphFormat.KeepWithNext = False
                           .Selection.ParagraphFormat.KeepTogether = False
                           .Selection.ParagraphFormat.PageBreakBefore = False
                           .Selection.ParagraphFormat.NoLineNumber = False
                           .Selection.ParagraphFormat.Hyphenation = True
                           'Modified by Lydia 2016/04/14  催審函調整,首列凸排
                           '.Selection.ParagraphFormat.FirstLineIndent = .CentimetersToPoints(-1.7)
                           If strType = "11" Then
                              .Selection.Font.Size = 14
                              .Selection.PageSetup.TopMargin = .CentimetersToPoints(3.17)
                              .Selection.ParagraphFormat.FirstLineIndent = .CentimetersToPoints(-2)
                           Else
                              .Selection.ParagraphFormat.FirstLineIndent = .CentimetersToPoints(-1.7)
                           End If
                           'end 2016/04/14
                           .Selection.ParagraphFormat.OutlineLevel = wdOutlineLevelBodyText
                           .Selection.ParagraphFormat.AutoAdjustRightIndent = True
                           .Selection.ParagraphFormat.DisableLineHeightGrid = True
                           '.Selection.ParagraphFormat.FarEastLineBreakControl = True'Removed by Morgan 2013/4/15 不要避頭尾,否則word2000造字會有斷行問題
                           .Selection.ParagraphFormat.WordWrap = True
                           .Selection.ParagraphFormat.HangingPunctuation = True
                           .Selection.ParagraphFormat.HalfWidthPunctuationOnTopOfLine = False
                           .Selection.ParagraphFormat.AddSpaceBetweenFarEastAndAlpha = True
                           .Selection.ParagraphFormat.AddSpaceBetweenFarEastAndDigit = True
                           .Selection.ParagraphFormat.BaseLineAlignment = wdBaselineAlignAuto
                           If blnFormatSet = False Then
                              .Selection.TypeText "　　　"
                           End If
                        End If
                   Case Else
                End Select
                
               'Add by Morgan 2011/2/11 FCP承辦的定稿用 12 號字
               If strUserNum = strFMPNum Then .Selection.Font.Size = 12
      
               'Add by Morgan 2007/11/1 紀錄原設定
               lSize = .Selection.Font.Size
               lAlignment = .Selection.ParagraphFormat.Alignment
               lBold = .Selection.Font.Bold
               lItalic = .Selection.Font.Italic
               lUnderline = .Selection.Font.Underline
               'end 2007/11/1
               
               'Add by Morgan 2011/6/1
               If bolAlwaysHead Then
'Modified by Morgan 2015/7/21 改與修改一致
'                  'Add by Morgan 2011/7/21 大陸指示信
'                  If rsTmp.Fields("LD12") = 6 Then
'                     If PUB_ReadDB2File(stFileName, iPicNo) = True Then
'                        .ActiveWindow.ActivePane.View.SeekView = wdSeekCurrentPageHeader
'                        Set oShape = .ActiveDocument.Shapes.AddPicture(Anchor:=.Selection.Range, FileName:=stFileName, LinkToFile:=False, SaveWithDocument:=True)
'                        oShape.ZOrder 4
'                        oShape.LockAnchor = True
'                        oShape.LockAspectRatio = -1
'                        oShape.Width = 546.5
'                        oShape.RelativeHorizontalPosition = wdRelativeHorizontalPositionPage
'                        oShape.RelativeVerticalPosition = wdRelativeVerticalPositionPage
'                        oShape.Left = .CentimetersToPoints(1)
'                        'Modified by Morgan 2015/6/22 配合E化列印EMail信頭向上微調
'                        'oShape.Top = .CentimetersToPoints(1)
'                        oShape.Top = .CentimetersToPoints(0.8)
'                        .ActiveWindow.ActivePane.View.SeekView = wdSeekMainDocument
'                     End If
'                  Else
'                  'end 2011/7/21
'                     If PUB_ReadDB2File(stFileName, iPicNo) = True Then
'                        .ActiveWindow.ActivePane.View.SeekView = wdSeekCurrentPageHeader
'                        Set oShape = .ActiveDocument.Shapes.AddPicture(Anchor:=.Selection.Range, FileName:=stFileName, LinkToFile:=False, SaveWithDocument:=True)
'                        oShape.ZOrder 4
'                        oShape.LockAnchor = True
'                        oShape.LockAspectRatio = -1
'                        oShape.Width = .CentimetersToPoints(21)
'                        oShape.RelativeHorizontalPosition = wdRelativeHorizontalPositionPage
'                        oShape.RelativeVerticalPosition = wdRelativeVerticalPositionPage
'                        oShape.Left = .CentimetersToPoints(0)
'                        oShape.Top = .CentimetersToPoints(0.5)
'                        If PUB_ReadDB2File(stFileName2, iPicNo2) = True Then
'                           .ActiveWindow.ActivePane.View.SeekView = wdSeekCurrentPageFooter
'                           Set oShape = .ActiveDocument.Shapes.AddPicture(Anchor:=.Selection.Range, FileName:=stFileName2, LinkToFile:=False, SaveWithDocument:=True)
'                           oShape.ZOrder 4
'                           oShape.LockAnchor = True
'                           oShape.LockAspectRatio = -1
'                           oShape.Width = .CentimetersToPoints(21)
'                           oShape.RelativeHorizontalPosition = wdRelativeHorizontalPositionPage
'                           oShape.RelativeVerticalPosition = wdRelativeVerticalPositionPage
'                           oShape.Left = .CentimetersToPoints(0)
'                           oShape.Top = .CentimetersToPoints(27)
'                        End If
'                        .ActiveWindow.ActivePane.View.SeekView = wdSeekMainDocument
'                     End If
                  .Selection.HomeKey Unit:=wdStory, Extend:=wdMove
                  If PUB_ReadDB2File(stFileName, iPicNo) = True Then
                     .ActiveWindow.ActivePane.View.SeekView = wdSeekCurrentPageHeader
                     PUB_AddConfidential .Selection, strData 'Added by Morgan 2025/4/9
                     Set oShape = .ActiveDocument.Shapes.AddPicture(Anchor:=.Selection.Range, FileName:=stFileName, LinkToFile:=False, SaveWithDocument:=True)
                     oShape.ZOrder 4
                     oShape.LockAnchor = True
                     oShape.LockAspectRatio = -1
                     oShape.WrapFormat.Type = 5 'Added by Morgan 2025/4/9
                     If iPicNo2 <> 0 Then
                        oShape.RelativeHorizontalPosition = wdRelativeHorizontalPositionPage
                        oShape.RelativeVerticalPosition = wdRelativeVerticalPositionPage
                        oShape.Width = .CentimetersToPoints(21)
                        oShape.Left = .CentimetersToPoints(0)
                       'Added by Morgan 2020/3/26
                        If strSrvDate(1) >= 智慧所更名日 Then
                           oShape.Top = .CentimetersToPoints(0)
                        Else
                        'end 2020/3/26
                           '英文
                           If iPicNo = 5 Then
                              oShape.Top = .CentimetersToPoints(0)
                           '中文
                           Else
                              oShape.Top = .CentimetersToPoints(0.5)
                           End If
                        End If 'Added by Morgan 2020/3/26
                     
                        If PUB_ReadDB2File(stFileName, iPicNo2) = True Then
                           .ActiveWindow.ActivePane.View.SeekView = wdSeekCurrentPageFooter
                           Set oShape = .ActiveDocument.Shapes.AddPicture(Anchor:=.Selection.Range, FileName:=stFileName, LinkToFile:=False, SaveWithDocument:=True)
                           oShape.ZOrder 4
                           oShape.LockAnchor = True
                           oShape.LockAspectRatio = -1
                           oShape.Width = .CentimetersToPoints(21)
                           oShape.RelativeHorizontalPosition = wdRelativeHorizontalPositionPage
                           oShape.RelativeVerticalPosition = wdRelativeVerticalPositionPage
                           oShape.Left = .CentimetersToPoints(0)
                           'Added by Morgan 2020/3/26
                            If strSrvDate(1) >= 智慧所更名日 Then
                               If bolTwLtr = True Then '中文對國內定稿
                                  oShape.Top = .CentimetersToPoints(27.2)
                               Else
                                  oShape.Top = .CentimetersToPoints(27.6)
                               End If
                            Else
                            'end 2020/3/26
                                 '英文
                                 If iPicNo2 = 9 Then
                                    oShape.Top = .CentimetersToPoints(27.6)
                                 '中文
                                 Else
                                    oShape.Top = .CentimetersToPoints(27)
                                 End If
                                 
                              End If 'Added by Morgan 2020/3/26
                        End If
                     Else
                        oShape.Width = 546.5
                        oShape.RelativeHorizontalPosition = wdRelativeHorizontalPositionPage
                        oShape.RelativeVerticalPosition = wdRelativeVerticalPositionPage
                        oShape.Left = .CentimetersToPoints(1)
                        'Added by Morgan 2020/3/26
                        If strSrvDate(1) >= 智慧所更名日 Then
                           oShape.Top = .CentimetersToPoints(0)
                        Else
                        'end 2020/3/26
                           oShape.Top = .CentimetersToPoints(0.8)
                        End If 'Added by Morgan 2020/3/26
                     End If
                     .ActiveWindow.ActivePane.View.SeekView = wdSeekMainDocument
                  End If
                  .Selection.EndKey Unit:=wdStory
               End If
               'end 2011/6/1
            End With
        End If
        
        '設定Word區塊
         With g_WordAp
            'Add by Morgan 2005/1/10 內專申請書有兩種字型大小需個別設訂
            If rsTmp.Fields("LD12") = 5 And strKEY01 = "P" Then
               'Modify by Morgan 2007/9/21 加第三人申請技術報告80700
               'If InStr("41200,42100,60114,60115", "" & rsTmp("LD09").Value & rsTmp("LD11").Value) = 0 Then
               'Modified by Morgan 2013/3/26 +,60116,60117
               If InStr("41200,42100,60114,60115,60116,60117,80700", "" & rsTmp("LD09").Value & rsTmp("LD11").Value) = 0 Then
                  .Selection.Font.Size = 16
               Else
                  .Selection.Font.Size = 14
               End If
               lSize = .Selection.Font.Size
            End If
         
            'Add by Morgan 2007/6/26
            If strKEY01 = "P" And strType = "02" And (rsTmp.Fields("LD11") = "98" Or rsTmp.Fields("LD11") = "99") Then
               .Selection.Font.Size = 12
               lSize = .Selection.Font.Size
            End If
            'end 2007/6/26
            
            'If nCopys = 0 Then nCopys = 1
            
            '列印份數超過一份
            'Modified by Morgan 2014/5/5 電子化後給客戶的和留所的相同
            'Modified by Morgan 2014/6/19 103/7/1 起有存電子信函的只要印 1 份
            'If nCopys > 1 Then
            If nCopys > 1 Or pCopys > 0 Or g_LD18 <> "" Then
            'end 2014/5/5
               '除 T開頭 外都改反序列印
               'Modify By Sindy 2015/7/17
               'If Left(strKEY01, 1) = "T" Then
               If (Left(strKEY01, 1) = "T" Or Left(Pub_StrUserSt03, 2) = "F2") Then
               '2015/7/17 END
                  bolReverse = bolPrintReverse
               Else
                  bolReverse = True '反序列印
               End If
               
               'Modified by Morgan 2013/6/26 重新整理並加可選擇反序列印
               iCopys = nCopys
               For iCopy = 1 To iCopys
                  '反序
                  If bolReverse = True Then
                     iCopyNo = iCopys - iCopy + 1
                  Else
                     iCopyNo = iCopy
                  End If
               
                  If iCopyNo = 1 Then '第一份
                     '整理第一份定稿內容
                     strPage1 = strData
                     strNewPage1 = ""
                     jj = 0
                     'Memo by Lydia 2020/02/17 ii => lngCnt
                     For lngCnt = 1 To Len(strPage1)
                        '第一份不印(起)
                        If Mid(strPage1, lngCnt, 2) = "|\" Then
                           jj = 1
                           lngCnt = lngCnt + 1
                        '第一份不印(迄)
                        ElseIf Mid(strPage1, lngCnt, 2) = "\|" Then
                           jj = 0
                           lngCnt = lngCnt + 1
                        '第一二份不印(起)
                        ElseIf Mid(strPage1, lngCnt, 2) = "|*" Then
                           jj = 1
                           lngCnt = lngCnt + 1
                        '第一二份不印(迄)
                        ElseIf Mid(strPage1, lngCnt, 2) = "*|" Then
                           jj = 0
                           lngCnt = lngCnt + 1
                        '只印在最後一份(起)
                        ElseIf Mid(strPage1, lngCnt, 2) = "|$" Then
                           jj = 1
                           lngCnt = lngCnt + 1
                        '只印在最後一份(迄)
                        ElseIf Mid(strPage1, lngCnt, 2) = "$|" Then
                           jj = 0
                           lngCnt = lngCnt + 1
                        ElseIf jj = 0 Then
                           strNewPage1 = strNewPage1 & Mid(strPage1, lngCnt, 1)
                        End If
                     Next lngCnt
                     
                      strNewPage1 = Replace(strNewPage1, "|@", "")
                      strNewPage1 = Replace(strNewPage1, "@|", "")
                      
                      'Add by Morgan 2010/5/4
                      strNewPage1 = Replace(strNewPage1, "|$", "")
                      strNewPage1 = Replace(strNewPage1, "$|", "")
                      strNewPage1 = Replace(strNewPage1, "|%", "")
                      strNewPage1 = Replace(strNewPage1, "%|", "")
                     'end 2010/5/4
                      
                      'add by nickc 2006/03/28 加入代表圖   ---start
                      CalVbCrLfCount = 0
                      If InStr(1, strNewPage1, "|#代表圖#|") <> 0 Then
                         CalVbCrLfStr = Mid(strNewPage1, InStr(1, strNewPage1, "案件回覆單"), InStr(1, strNewPage1, "|#代表圖#|") - 1 - InStr(1, strNewPage1, "案件回覆單") + 1)
                         Do While InStr(1, CalVbCrLfStr, vbCrLf) <> 0
                             CalVbCrLfCount = CalVbCrLfCount + 1
                             CalVbCrLfStr = Mid(CalVbCrLfStr, InStr(1, CalVbCrLfStr, vbCrLf) + 1)
                         Loop
                        'Modify by Morgan 2009/4/24 商標往上提3 行
                        'CalVbCrLfCount = CalVbCrLfCount + 5
                        If m_MySt(1) = "T" Then
                           CalVbCrLfCount = CalVbCrLfCount + 2
                        Else
                           CalVbCrLfCount = CalVbCrLfCount + 5
                        End If
                      End If
                      
                     'Add by Morgan 2007/11/6 格式初始化
                     
                     .Selection.EndKey Unit:=wdStory
                     
                     'Added by Morgan 2013/6/27
                     If iCopy > 1 Then
                        .Selection.InsertBreak Type:=wdPageBreak
                     End If
                     'end 2013/6/27
                     
                     'Remove by Morgan 2010/2/4 移到上面做
                     'If intNowCopy > 1 Then
                     '   .Selection.InsertBreak Type:=wdPageBreak
                     'End If
                     
                     .Selection.Font.Size = lSize
                     .Selection.ParagraphFormat.Alignment = lAlignment
                     .Selection.Font.Bold = lBold
                     .Selection.Font.Italic = lItalic
                     .Selection.Font.Underline = lUnderline
                     'end 2007/11/6
                     
                     ' 印第一份
                     'Added by Lydia 2020/02/17 Word的.Selection.TypeText有長度限制20000字(ex.FCT-45394的定稿:通知申請案號(英譯本)FCT,02,101,11的商品名稱只顯示到第7類)
                     If GetTextLength(strNewPage1) > 20000 Then
                         strReplText = strNewPage1
                         'Modified by Lydia 2025/07/24
                         'For lngLast = 1 To GetTextLength(strReplText) Step 20000
                         '   strFindText = RTrim(convForm(strReplText, 20000))
                         '   .Selection.TypeText strFindText
                         '   strReplText = Replace(strReplText, strFindText, "")
                         'Next
                         Do
                           strFindText = RTrim(convForm(strReplText, 20000))
                           .Selection.TypeText strFindText
                           If strReplText = strFindText Then
                              Exit Do
                           Else
                              strReplText = Mid(strReplText, Len(strFindText) + 1)
                           End If
                         Loop
                         'end 2025/07/24
                         DoEvents
                     Else
                     'end 2020/02/17
                         .Selection.TypeText strNewPage1: DoEvents
                         '.Selection.TypeParagraph
                     End If 'Added by Lydia 2020/02/17
                     
                     'add by morgan 2007/9/17 檢查有無要在 word 裡面轉換的關鍵字，若是有，必須經過轉換
                     'Modify by Amy 2018/08/24 +showColorFirst
                     If InStr(1, strNewPage1, "|#(") <> 0 Then
                         ChgWordFormat g_WordAp, strNewPage1, showColorFirst
                     End If
                     'add by nickc 2006/03/28 加入印代表圖
                     If CalVbCrLfCount <> 0 Then
                         PUB_AddInPicToWord g_WordAp, CalVbCrLfCount, showColorFirst
                     End If
                     'add by morgan 2007/09/17 加入新定稿的固定代表圖
                     If InStr(1, strNewPage1, "|#右代表圖#|") <> 0 Then
                         PUB_AddInPicToWordR g_WordAp, showColorFirst
                     End If
                     'Add By Sindy 2014/3/18 加入新定稿的固定代表圖2
                     If InStr(1, strNewPage1, "|#右代表圖2#|") <> 0 Then
                         PUB_AddInPicToWordR2 g_WordAp, showColorFirst
                     End If
                     'Modify By Sindy 2014/3/19 加入新定稿的固定代表圖3
                     If InStr(1, strNewPage1, "|#右代表圖3#|") <> 0 Then
                         PUB_AddInPicToWordR3 g_WordAp, showColorFirst
                     End If
                     'end 2018/07/30
                     'Add By Sindy 2023/8/2 加入右代表圖-公報
                     If InStr(1, strNewPage1, "|#右代表圖-公報#|") <> 0 Then
                         strSql = "select tmbulletindata.*,tm01,tm02,tm03,tm04,tm08 from tmbulletindata,trademark " & _
                                  "Where tm01='" & m_MySt(1) & "' and tm02='" & m_MySt(2) & "' and tm03='" & m_MySt(3) & "' and tm04='" & m_MySt(4) & "'" & _
                                  " and tbd02=tm15 and tbd03=tm08 and tbd16='1' and tbd15='A'" & _
                                  " and tm44 is null"
                         Set RsTemp = ClsLawReadRstMsg(intI, strSql)
                         If intI = 1 Then
                            If "" & RsTemp.Fields("TBD12") <> "" Then
                               PUB_AddInPicToWordR4 g_WordAp.Application, RsTemp.Fields("TBD12")
                            End If
                         End If
                     End If
                     '2023/8/2 END
                     
                  ElseIf iCopyNo = 2 Then '第二份 Added by Morgan 2013/6/26
               
                     '內專國內案, 定稿別為各式申請書(01), 案件性質為領證及繳年費(601), 年費(605), 處理狀況為"06","07", 第二份內容同第一份
                     If ("" & rsTmp("LD05").Value = "P" And "" & rsTmp("LD10").Value = "01" And "" & rsTmp("LD09").Value = 領證及繳年費 And ("" & rsTmp("LD11").Value = "06" Or "" & rsTmp("LD11").Value = "07")) Or _
                         ("" & rsTmp("LD05").Value = "P" And "" & rsTmp("LD10").Value = "01" And "" & rsTmp("LD09").Value = 年費 And ("" & rsTmp("LD11").Value = "07" Or "" & rsTmp("LD11").Value = "08")) Then
                        '整理第二份定稿內容
                        strPage1 = strData
                        strNewPage1 = ""
                        jj = 0
                        'Memo by Lydia 2020/02/17 ii => lngCnt
                        For lngCnt = 1 To Len(strPage1)
                           If Mid(strPage1, lngCnt, 2) = "|\" Then
                              jj = 1
                              lngCnt = lngCnt + 1
                           ElseIf Mid(strPage1, lngCnt, 2) = "\|" Then
                              jj = 0
                              lngCnt = lngCnt + 1
                           ElseIf Mid(strPage1, lngCnt, 2) = "|@" Then
                              jj = 1
                              lngCnt = lngCnt + 1
                           ElseIf Mid(strPage1, lngCnt, 2) = "@|" Then
                              jj = 0
                              lngCnt = lngCnt + 1
                              
                           'Modify by Morgan 2010/5/4 最後一份不印控制
                           'Modified by Morgan 2013/6/26
                           'ElseIf nCopys = 2 Then
                           ElseIf iCopyNo = iCopys Then
                           'end 2013/6/26
                              '|%...%| 最後一份不印
                              If Mid(strPage1, lngCnt, 2) = "|%" Then
                                 jj = 1
                                 lngCnt = lngCnt + 1
                              ElseIf Mid(strPage1, lngCnt, 2) = "%|" Then
                                 jj = 0
                                 lngCnt = lngCnt + 1
                              ElseIf jj = 0 Then
                                 strNewPage1 = strNewPage1 & Mid(strPage1, lngCnt, 1)
                              End If
                              
                           '|$...$| 只印最後一份
                           ElseIf Mid(strPage1, lngCnt, 2) = "|$" Then
                              jj = 1
                              lngCnt = lngCnt + 1
                           ElseIf Mid(strPage1, lngCnt, 2) = "$|" Then
                              jj = 0
                              lngCnt = lngCnt + 1
                           ElseIf jj = 0 Then
                              strNewPage1 = strNewPage1 & Mid(strPage1, lngCnt, 1)
                           End If
                           'end 2010/5/4
                        Next lngCnt
                        
                        strNewPage1 = Replace(strNewPage1, "|*", "")
                        strNewPage1 = Replace(strNewPage1, "*|", "")
                       
                        'Add by Morgan 2010/5/4
                        strNewPage1 = Replace(strNewPage1, "|$", "")
                        strNewPage1 = Replace(strNewPage1, "$|", "")
                        strNewPage1 = Replace(strNewPage1, "|%", "")
                        strNewPage1 = Replace(strNewPage1, "%|", "")
                        'end 2010/5/4
                       
                        'add by nickc 2006/03/28 加入代表圖   ---start
                        CalVbCrLfCount = 0
                        If InStr(1, strNewPage1, "|#代表圖#|") <> 0 Then
                           CalVbCrLfStr = Mid(strNewPage1, InStr(1, strNewPage1, "案件回覆單"), InStr(1, strNewPage1, "|#代表圖#|") - 1 - InStr(1, strNewPage1, "案件回覆單") + 1)
                           Do While InStr(1, CalVbCrLfStr, vbCrLf) <> 0
                               CalVbCrLfCount = CalVbCrLfCount + 1
                               CalVbCrLfStr = Mid(CalVbCrLfStr, InStr(1, CalVbCrLfStr, vbCrLf) + 1)
                           Loop
                           'Modify by Morgan 2009/4/24 商標往上提3 行
                           'CalVbCrLfCount = CalVbCrLfCount + 5
                           If m_MySt(1) = "T" Then
                              CalVbCrLfCount = CalVbCrLfCount + 2
                           Else
                              CalVbCrLfCount = CalVbCrLfCount + 5
                           End If
                        End If
                      
                        'Add by Morgan 2007/11/6 格式初始化
                        .Selection.EndKey Unit:=wdStory
                        If iCopy > 1 Then
                           .Selection.InsertBreak Type:=wdPageBreak
                        End If
                        .Selection.Font.Size = lSize
                        .Selection.ParagraphFormat.Alignment = lAlignment
                        .Selection.Font.Bold = lBold
                        .Selection.Font.Italic = lItalic
                        .Selection.Font.Underline = lUnderline
                        'end 2007/11/6
                     
                        ' 印第二份
                        'Added by Lydia 2020/02/17 Word的.Selection.TypeText有長度限制20000字(ex.FCT-45394的定稿:通知申請案號(英譯本)FCT,02,101,11的商品名稱只顯示到第7類)
                        If GetTextLength(strNewPage1) > 20000 Then
                            strReplText = strNewPage1
                            'Modified by Lydia 2025/07/24
                            'For lngLast = 1 To GetTextLength(strReplText) Step 20000
                            '   strFindText = RTrim(convForm(strReplText, 20000))
                            '   .Selection.TypeText strFindText
                            '   strReplText = Replace(strReplText, strFindText, "")
                            'Next
                            Do
                              strFindText = RTrim(convForm(strReplText, 20000))
                              .Selection.TypeText strFindText
                              If strReplText = strFindText Then
                                 Exit Do
                              Else
                                 strReplText = Mid(strReplText, Len(strFindText) + 1)
                              End If
                            Loop
                            'end 2025/07/24
                            DoEvents
                        Else
                        'end 2020/02/17
                            .Selection.TypeText strNewPage1: DoEvents
                            '.Selection.TypeParagraph
                        End If 'Added by Lydia 2020/02/17
                         
                        'add by morgan 2007/9/17 檢查有無要在 word 裡面轉換的關鍵字，若是有，必須經過轉換
                        'Modify by Amy 2018/08/24 +showColorFirst
                        If InStr(1, strNewPage1, "|#(") <> 0 Then
                            ChgWordFormat g_WordAp, strNewPage1, showColorFirst
                        End If
                         
                        'add by nickc 2006/03/28 加入印代表圖
                        If CalVbCrLfCount <> 0 Then
                            PUB_AddInPicToWord g_WordAp, CalVbCrLfCount, showColorFirst
                        End If
                        'add by morgan 2007/09/17 加入新定稿的固定代表圖
                        If InStr(1, strNewPage1, "|#右代表圖#|") <> 0 Then
                            PUB_AddInPicToWordR g_WordAp, showColorFirst
                        End If
                        'Add By Sindy 2014/3/18 加入新定稿的固定代表圖2
                        If InStr(1, strNewPage1, "|#右代表圖2#|") <> 0 Then
                            PUB_AddInPicToWordR2 g_WordAp, showColorFirst
                        End If
                        'Modify By Sindy 2014/3/19 加入新定稿的固定代表圖3
                        If InStr(1, strNewPage1, "|#右代表圖3#|") <> 0 Then
                            PUB_AddInPicToWordR3 g_WordAp, showColorFirst
                        End If
                        'end 2018/07/30
                        
                        '列印份數總份數 - 1 份
                        'nCopys = nCopys - 1 'Removed by Morgan 2013/6/27
                  
                     'Add by Morgan 2004/8/10
                     '第二份控制 |*... *| 中間的 第二份也不印
                     Else
                         '整理第二份定稿內容
                        strPage1 = strData
                        strNewPage1 = ""
                        jj = 0
                        'Memo by Lydia 2020/02/17 ii => lngCnt
                        For lngCnt = 1 To Len(strPage1)
                           If Mid(strPage1, lngCnt, 2) = "|*" Or Mid(strPage1, lngCnt, 2) = "|@" Then
                              jj = 1
                              lngCnt = lngCnt + 1
                           ElseIf Mid(strPage1, lngCnt, 2) = "*|" Or Mid(strPage1, lngCnt, 2) = "@|" Then
                              jj = 0
                              lngCnt = lngCnt + 1
                           
                           'Modify by Morgan 2010/5/4 最後一份不印控制
                           'Modified by Morgan 2013/6/26
                           'ElseIf nCopys = 2 Then
                           ElseIf iCopyNo = iCopys Then
                           'end 2013/6/26
                           
                              '|%...%| 最後一份不印
                              If Mid(strPage1, lngCnt, 2) = "|%" Then
                                 jj = 1
                                 lngCnt = lngCnt + 1
                              ElseIf Mid(strPage1, lngCnt, 2) = "%|" Then
                                 jj = 0
                                 lngCnt = lngCnt + 1
                              ElseIf jj = 0 Then
                                 strNewPage1 = strNewPage1 & Mid(strPage1, lngCnt, 1)
                              End If
                              
                           '|$...$| 只印最後一份
                           ElseIf Mid(strPage1, lngCnt, 2) = "|$" Then
                              jj = 1
                              lngCnt = lngCnt + 1
                           ElseIf Mid(strPage1, lngCnt, 2) = "$|" Then
                              jj = 0
                              lngCnt = lngCnt + 1
                           ElseIf jj = 0 Then
                              strNewPage1 = strNewPage1 & Mid(strPage1, lngCnt, 1)
                           End If
                           'end 2010/5/4
                        Next lngCnt
                        strNewPage1 = Replace(strNewPage1, "|\", "")
                        strNewPage1 = Replace(strNewPage1, "\|", "")
                       
                        'Add by Morgan 2010/5/4
                         strNewPage1 = Replace(strNewPage1, "|$", "")
                         strNewPage1 = Replace(strNewPage1, "$|", "")
                         strNewPage1 = Replace(strNewPage1, "|%", "")
                         strNewPage1 = Replace(strNewPage1, "%|", "")
                        'end 2010/5/4
                       
                        'add by nickc 2006/03/28 加入代表圖   ---start
                        CalVbCrLfCount = 0
                        If InStr(1, strNewPage1, "|#代表圖#|") <> 0 Then
                           CalVbCrLfStr = Mid(strNewPage1, InStr(1, strNewPage1, "案件回覆單"), InStr(1, strNewPage1, "|#代表圖#|") - 1 - InStr(1, strNewPage1, "案件回覆單") + 1)
                           Do While InStr(1, CalVbCrLfStr, vbCrLf) <> 0
                               CalVbCrLfCount = CalVbCrLfCount + 1
                               CalVbCrLfStr = Mid(CalVbCrLfStr, InStr(1, CalVbCrLfStr, vbCrLf) + 1)
                           Loop
                           'Modify by Morgan 2009/4/24 商標往上提3 行
                           'CalVbCrLfCount = CalVbCrLfCount + 5
                           If m_MySt(1) = "T" Then
                              CalVbCrLfCount = CalVbCrLfCount + 2
                           Else
                              CalVbCrLfCount = CalVbCrLfCount + 5
                           End If
                        End If
                      
                        'Add by Morgan 2007/11/6 格式初始化
                        .Selection.EndKey Unit:=wdStory
                        
                        If iCopy > 1 Then
                           .Selection.InsertBreak Type:=wdPageBreak
                        End If
                        .Selection.Font.Size = lSize
                        .Selection.ParagraphFormat.Alignment = lAlignment
                        .Selection.Font.Bold = lBold
                        .Selection.Font.Italic = lItalic
                        .Selection.Font.Underline = lUnderline
                        'end 2007/11/6
                        
                        ' 印第二份
                        'Added by Lydia 2020/02/17 Word的.Selection.TypeText有長度限制20000字(ex.FCT-45394的定稿:通知申請案號(英譯本)FCT,02,101,11的商品名稱只顯示到第7類)
                        If GetTextLength(strNewPage1) > 20000 Then
                            strReplText = strNewPage1
                            'Modified by Lydia 2025/07/24
                            'For lngLast = 1 To GetTextLength(strReplText) Step 20000
                            '   strFindText = RTrim(convForm(strReplText, 20000))
                            '   .Selection.TypeText strFindText
                            '   strReplText = Replace(strReplText, strFindText, "")
                            'Next
                            Do
                              strFindText = RTrim(convForm(strReplText, 20000))
                              .Selection.TypeText strFindText
                              If strReplText = strFindText Then
                                 Exit Do
                              Else
                                 strReplText = Mid(strReplText, Len(strFindText) + 1)
                              End If
                            Loop
                            'end 2025/07/24
                            DoEvents
                        Else
                        'end 2020/02/17
                            .Selection.TypeText strNewPage1: DoEvents
                        End If 'Added by Lydia 2020/02/17
                        
                        'add by morgan 2007/9/17 檢查有無要在 word 裡面轉換的關鍵字，若是有，必須經過轉換
                        'Modify by Amy 2018/08/24 +showColorFirst=>是否先抓彩色代表圖
                        If InStr(1, strNewPage1, "|#(") <> 0 Then
                            ChgWordFormat g_WordAp, strNewPage1, showColorFirst
                        End If
                        
                        'add by nickc 2006/03/28 加入印代表圖
                        If CalVbCrLfCount <> 0 Then
                            PUB_AddInPicToWord g_WordAp, CalVbCrLfCount, showColorFirst
                        End If
                        'add by morgan 2007/09/17 加入新定稿的固定代表圖
                        If InStr(1, strNewPage1, "|#右代表圖#|") <> 0 Then
                            PUB_AddInPicToWordR g_WordAp, showColorFirst
                        End If
                        'Add By Sindy 2014/3/18 加入新定稿的固定代表圖2
                        If InStr(1, strNewPage1, "|#右代表圖2#|") <> 0 Then
                            PUB_AddInPicToWordR2 g_WordAp, showColorFirst
                        End If
                        'Modify By Sindy 2014/3/19 加入新定稿的固定代表圖3
                        If InStr(1, strNewPage1, "|#右代表圖3#|") <> 0 Then
                            PUB_AddInPicToWordR3 g_WordAp, showColorFirst
                        End If
                        'end 2018/07/30
                       
                       '列印份數總份數 - 1 份
                       nCopys = nCopys - 1
                     End If
                   
                  ElseIf iCopyNo > 2 And iCopyNo < iCopys Then '第3~倒數第2份 Added by Moragn 2013/6/26
               
                     'Removed by Morgan 2013/6/26
                     ''若還有頁數
                     'If nCopys - 1 > 0 Then
                     '   If nCopys - 2 > 0 Then 'Add by Morgan 2010/5/4 最後一份抽出
                     'end 2013/6/26
                  
                     ' 印其餘的部份
                     'Modified by Morgan 2013/6/27
                     'strData = Replace(strData, "|\", "")
                     'strData = Replace(strData, "\|", "")
                     'strData = Replace(strData, "|*", "")
                     'strData = Replace(strData, "*|", "")
                     'strNewPage1 = strData
                     strPage1 = strData
                     strPage1 = Replace(strPage1, "|\", "")
                     strPage1 = Replace(strPage1, "\|", "")
                     strPage1 = Replace(strPage1, "|*", "")
                     strPage1 = Replace(strPage1, "*|", "")
                     strNewPage1 = strPage1
                     'end 2013/6/27
                     
                     '若有只在第一頁列印的資料, 要排除
                     'Modify by Morgan 2010/5/4
                     'If InStr(strData, "|@") > 0 Then
                     'Modified by Morgan 2013/6/27
                     'If InStr(strData, "|@") > 0 Or InStr(strData, "|$") > 0 Then
                     If InStr(strPage1, "|@") > 0 Or InStr(strPage1, "|$") > 0 Then
                     
                        '整理後續定稿內容
                        'strPage1 = strData 'Removed by Morgan 2013/6/27
                        strNewPage1 = ""
                        jj = 0
                        'Memo by Lydia 2020/02/17 ii => lngCnt
                        For lngCnt = 1 To Len(strPage1)
                           If Mid(strPage1, lngCnt, 2) = "|@" Then
                              jj = 1
                              lngCnt = lngCnt + 1
                           ElseIf Mid(strPage1, lngCnt, 2) = "@|" Then
                              jj = 0
                              lngCnt = lngCnt + 1
                           'Add by Morgan 2010/5/4
                           ElseIf Mid(strPage1, lngCnt, 2) = "|$" Then
                              jj = 1
                              lngCnt = lngCnt + 1
                           ElseIf Mid(strPage1, lngCnt, 2) = "$|" Then
                              jj = 0
                              lngCnt = lngCnt + 1
                           ElseIf jj = 0 Then
                              strNewPage1 = strNewPage1 & Mid(strPage1, lngCnt, 1)
                           End If
                        Next lngCnt
                     End If
                    
                     'Add by Morgan 2010/5/4
                      strNewPage1 = Replace(strNewPage1, "|$", "")
                      strNewPage1 = Replace(strNewPage1, "$|", "")
                      strNewPage1 = Replace(strNewPage1, "|%", "")
                      strNewPage1 = Replace(strNewPage1, "%|", "")
                     'end 2010/5/4
                    
                     
                     'Removed by Morgan 2013/6/26 改寫法
                     ''Modify by Morgan 2010/5/4 最後一份抽出
                     ''For ii = 1 To nCopys - 1
                     'For ii = 1 To nCopys - 2
                     'end 2013/6/26
                         
                     'add by nickc 2006/03/28 加入代表圖   ---start
                     CalVbCrLfCount = 0
                     If InStr(1, strNewPage1, "|#代表圖#|") <> 0 Then
                        CalVbCrLfStr = Mid(strNewPage1, InStr(1, strNewPage1, "案件回覆單"), InStr(1, strNewPage1, "|#代表圖#|") - 1 - InStr(1, strNewPage1, "案件回覆單") + 1)
                        Do While InStr(1, CalVbCrLfStr, vbCrLf) <> 0
                            CalVbCrLfCount = CalVbCrLfCount + 1
                            CalVbCrLfStr = Mid(CalVbCrLfStr, InStr(1, CalVbCrLfStr, vbCrLf) + 1)
                        Loop
                        'Modify by Morgan 2009/4/24 商標往上提3 行
                        'CalVbCrLfCount = CalVbCrLfCount + 5
                        If m_MySt(1) = "T" Then
                           CalVbCrLfCount = CalVbCrLfCount + 2
                        Else
                           CalVbCrLfCount = CalVbCrLfCount + 5
                        End If
                     End If
                         
                     'Add by Morgan 2007/11/6 格式初始化
                     .Selection.EndKey Unit:=wdStory
                     If iCopy > 1 Then
                        .Selection.InsertBreak Type:=wdPageBreak
                     End If
                     .Selection.Font.Size = lSize
                     .Selection.ParagraphFormat.Alignment = lAlignment
                     .Selection.Font.Bold = lBold
                     .Selection.Font.Italic = lItalic
                     .Selection.Font.Underline = lUnderline
                     'end 2007/11/6
                        
                     'Added by Lydia 2020/02/17 Word的.Selection.TypeText有長度限制20000字(ex.FCT-45394的定稿:通知申請案號(英譯本)FCT,02,101,11的商品名稱只顯示到第7類)
                     If GetTextLength(strNewPage1) > 20000 Then
                         strReplText = strNewPage1
                         'Modified by Lydia 2025/07/24
                         'For lngLast = 1 To GetTextLength(strReplText) Step 20000
                         '   strFindText = RTrim(convForm(strReplText, 20000))
                         '   .Selection.TypeText strFindText
                         '   strReplText = Replace(strReplText, strFindText, "")
                         'Next
                         Do
                           strFindText = RTrim(convForm(strReplText, 20000))
                           .Selection.TypeText strFindText
                           If strReplText = strFindText Then
                              Exit Do
                           Else
                              strReplText = Mid(strReplText, Len(strFindText) + 1)
                           End If
                         Loop
                         'end 2025/07/24
                         DoEvents
                     Else
                     'end 2020/02/17
                        .Selection.TypeText strNewPage1: DoEvents
                        '.Selection.TypeParagraph
                     End If 'Added by Lydia 2020/02/17
                     
                     'add by morgan 2007/9/17 檢查有無要在 word 裡面轉換的關鍵字，若是有，必須經過轉換
                     'Modify by Amy 2018/08/24 +showColorFirst
                     If InStr(1, strNewPage1, "|#(") <> 0 Then
                         ChgWordFormat g_WordAp, strNewPage1, showColorFirst
                     End If
                     
                     'add by nickc 2006/03/28 加入印代表圖
                     If CalVbCrLfCount <> 0 Then
                         PUB_AddInPicToWord g_WordAp, CalVbCrLfCount, showColorFirst
                     End If
                     'add by morgan 2007/09/17 加入新定稿的固定代表圖
                     If InStr(1, strNewPage1, "|#右代表圖#|") <> 0 Then
                         PUB_AddInPicToWordR g_WordAp, showColorFirst
                     End If
                     'Add By Sindy 2014/3/18 加入新定稿的固定代表圖2
                     If InStr(1, strNewPage1, "|#右代表圖2#|") <> 0 Then
                         PUB_AddInPicToWordR2 g_WordAp, showColorFirst
                     End If
                     'Modify By Sindy 2014/3/19 加入新定稿的固定代表圖3
                     If InStr(1, strNewPage1, "|#右代表圖3#|") <> 0 Then
                         PUB_AddInPicToWordR3 g_WordAp, showColorFirst
                     End If
                     'end 2018/07/30
                     
                     'Next 'Removed by Morgan 2013/6/26 改寫法
                     
                  ElseIf iCopyNo = iCopys Then 'Added by Morgan 2013/6/26 最後一份
                  
                     'Add by Morgan 2010/5/4 最後一份
                      '整理最後一份定稿內容
                     strPage1 = strData
                     strNewPage1 = ""
                     jj = 0
                     
                     For lngCnt = 1 To Len(strPage1)
                         If Mid(strPage1, lngCnt, 2) = "|@" Then
                            jj = 1
                            lngCnt = lngCnt + 1
                        ElseIf Mid(strPage1, lngCnt, 2) = "@|" Then
                            jj = 0
                            lngCnt = lngCnt + 1
                        ElseIf Mid(strPage1, lngCnt, 2) = "|%" Then
                            jj = 1
                            lngCnt = lngCnt + 1
                        ElseIf Mid(strPage1, lngCnt, 2) = "%|" Then
                            jj = 0
                            lngCnt = lngCnt + 1
                        ElseIf jj = 0 Then
                           strNewPage1 = strNewPage1 & Mid(strPage1, lngCnt, 1)
                        End If
                     Next lngCnt
                       
                     strNewPage1 = Replace(strNewPage1, "|\", "")
                     strNewPage1 = Replace(strNewPage1, "\|", "")
                     strNewPage1 = Replace(strNewPage1, "|*", "")
                     strNewPage1 = Replace(strNewPage1, "*|", "")
                     strNewPage1 = Replace(strNewPage1, "|$", "")
                     strNewPage1 = Replace(strNewPage1, "$|", "")
                     
                     'add by nickc 2006/03/28 加入代表圖   ---start
                     CalVbCrLfCount = 0
                     If InStr(1, strNewPage1, "|#代表圖#|") <> 0 Then
                        CalVbCrLfStr = Mid(strNewPage1, InStr(1, strNewPage1, "案件回覆單"), InStr(1, strNewPage1, "|#代表圖#|") - 1 - InStr(1, strNewPage1, "案件回覆單") + 1)
                        Do While InStr(1, CalVbCrLfStr, vbCrLf) <> 0
                            CalVbCrLfCount = CalVbCrLfCount + 1
                            CalVbCrLfStr = Mid(CalVbCrLfStr, InStr(1, CalVbCrLfStr, vbCrLf) + 1)
                        Loop
                         'Modify by Morgan 2009/4/24 商標往上提3 行
                         'CalVbCrLfCount = CalVbCrLfCount + 5
                         If m_MySt(1) = "T" Then
                            CalVbCrLfCount = CalVbCrLfCount + 2
                         Else
                            CalVbCrLfCount = CalVbCrLfCount + 5
                         End If
                     End If
                     
                     'Add by Morgan 2007/11/6 格式初始化
                     .Selection.EndKey Unit:=wdStory
                     If iCopy > 1 Then 'Added by Morgan 2013/6/27
                        .Selection.InsertBreak Type:=wdPageBreak
                     End If 'Added by Morgan 2013/6/27
                     .Selection.Font.Size = lSize
                     .Selection.ParagraphFormat.Alignment = lAlignment
                     .Selection.Font.Bold = lBold
                     .Selection.Font.Italic = lItalic
                     .Selection.Font.Underline = lUnderline
                     'end 2007/11/6
                     
                     ' 印最後一份
                     'Added by Lydia 2020/02/17 Word的.Selection.TypeText有長度限制20000字(ex.FCT-45394的定稿:通知申請案號(英譯本)FCT,02,101,11的商品名稱只顯示到第7類)
                     If GetTextLength(strNewPage1) > 20000 Then
                         strReplText = strNewPage1
                         'Modified by Lydia 2025/07/24
                         'For lngLast = 1 To GetTextLength(strReplText) Step 20000
                         '   strFindText = RTrim(convForm(strReplText, 20000))
                         '   .Selection.TypeText strFindText
                         '   strReplText = Replace(strReplText, strFindText, "")
                         'Next
                         Do
                           strFindText = RTrim(convForm(strReplText, 20000))
                           .Selection.TypeText strFindText
                           If strReplText = strFindText Then
                              Exit Do
                           Else
                              strReplText = Mid(strReplText, Len(strFindText) + 1)
                           End If
                         Loop
                         'end 2025/07/24
                         DoEvents
                     Else
                     'end 2020/02/17
                        .Selection.TypeText strNewPage1: DoEvents
                     End If 'Added by Lydia 2020/02/17
                     
                     'add by morgan 2007/9/17 檢查有無要在 word 裡面轉換的關鍵字，若是有，必須經過轉換
                     'Modify by Amy 2018/08/24 +showColorFirst
                     If InStr(1, strNewPage1, "|#(") <> 0 Then
                         ChgWordFormat g_WordAp, strNewPage1, showColorFirst
                     End If
                     
                     'add by nickc 2006/03/28 加入印代表圖
                     If CalVbCrLfCount <> 0 Then
                        PUB_AddInPicToWord g_WordAp, CalVbCrLfCount, showColorFirst
                     End If
                     'add by morgan 2007/09/17 加入新定稿的固定代表圖
                     If InStr(1, strNewPage1, "|#右代表圖#|") <> 0 Then
                        PUB_AddInPicToWordR g_WordAp, showColorFirst
                     End If
                     'end 2010/5/5
                     'Add By Sindy 2014/3/18 加入新定稿的固定代表圖2
                     If InStr(1, strNewPage1, "|#右代表圖2#|") <> 0 Then
                         PUB_AddInPicToWordR2 g_WordAp, showColorFirst
                     End If
                     'Modify By Sindy 2014/3/19 加入新定稿的固定代表圖3
                     If InStr(1, strNewPage1, "|#右代表圖3#|") <> 0 Then
                         PUB_AddInPicToWordR3 g_WordAp, showColorFirst
                     End If
                     'end 2018/07/30
                     
                  End If 'Added by Morgan 2013/6/26
                  
               Next 'Added by Morgan 2013/6/26
            '列印份數只有一份
            Else
               ' 印全部
               
               'Modify By Sindy 2015/7/9
               '整理第一份定稿內容
               strPage1 = strData
               strNewPage1 = ""
               jj = 0
               For lngCnt = 1 To Len(strPage1)
                  '第一份不印(起)
                  If Mid(strPage1, lngCnt, 2) = "|\" Then
                     jj = 1
                     lngCnt = lngCnt + 1
                  '第一份不印(迄)
                  ElseIf Mid(strPage1, lngCnt, 2) = "\|" Then
                     jj = 0
                     lngCnt = lngCnt + 1
                  '第一二份不印(起)
                  ElseIf Mid(strPage1, lngCnt, 2) = "|*" Then
                     jj = 1
                     lngCnt = lngCnt + 1
                  '第一二份不印(迄)
                  ElseIf Mid(strPage1, lngCnt, 2) = "*|" Then
                     jj = 0
                     lngCnt = lngCnt + 1
                  ElseIf jj = 0 Then
                     strNewPage1 = strNewPage1 & Mid(strPage1, lngCnt, 1)
                  End If
               Next lngCnt
'               strData = Replace(strData, "|\", "")
'               strData = Replace(strData, "\|", "")
'               strData = Replace(strData, "|*", "")
'               strData = Replace(strData, "*|", "")
               strData = strNewPage1
               '2015/7/9 END
               
               strData = Replace(strData, "|@", "")
               strData = Replace(strData, "@|", "")
               'Add by Morgan 2010/5/4
                strNewPage1 = Replace(strNewPage1, "|$", "")
                strNewPage1 = Replace(strNewPage1, "$|", "")
                strNewPage1 = Replace(strNewPage1, "|%", "")
                strNewPage1 = Replace(strNewPage1, "%|", "")
               'end 2010/5/4
               
               'add by nickc 2006/03/28 加入代表圖   ---start
               CalVbCrLfCount = 0
               If InStr(1, strData, "|#代表圖#|") <> 0 Then
                  CalVbCrLfStr = Mid(strData, InStr(1, strData, "案件回覆單"), InStr(1, strData, "|#代表圖#|") - 1 - InStr(1, strData, "案件回覆單") + 1)
                  Do While InStr(1, CalVbCrLfStr, vbCrLf) <> 0
                      CalVbCrLfCount = CalVbCrLfCount + 1
                      CalVbCrLfStr = Mid(CalVbCrLfStr, InStr(1, CalVbCrLfStr, vbCrLf) + 1)
                  Loop
                  'Modify by Morgan 2009/4/24 商標往上提3 行
                  'CalVbCrLfCount = CalVbCrLfCount + 5
                  If m_MySt(1) = "T" Then
                     CalVbCrLfCount = CalVbCrLfCount + 2
                  Else
                     CalVbCrLfCount = CalVbCrLfCount + 5
                  End If
               End If
                
               'Add by Morgan 2007/11/6 格式初始化
               .Selection.EndKey Unit:=wdStory
               
               'Remove by Morgan 2010/2/4 移到上面做
               'If intNowCopy > 1 Then
               '   .Selection.InsertBreak Type:=wdPageBreak
               'End If
               
               .Selection.Font.Size = lSize
               .Selection.ParagraphFormat.Alignment = lAlignment
               .Selection.Font.Bold = lBold
               .Selection.Font.Italic = lItalic
               .Selection.Font.Underline = lUnderline
               'end 2007/11/6
                'Added by Lydia 2020/02/17 Word的.Selection.TypeText有長度限制20000字(ex.FCT-45394的定稿:通知申請案號(英譯本)FCT,02,101,11的商品名稱只顯示到第7類)
                If GetTextLength(strData) > 20000 Then
                    strReplText = strData
                    'Modified by Lydia 2025/07/24
                    'For lngLast = 1 To GetTextLength(strReplText) Step 20000
                    '   strFindText = RTrim(convForm(strReplText, 20000))
                    '   .Selection.TypeText strFindText
                    '   strReplText = Replace(strReplText, strFindText, "")
                    'Next
                    Do
                      strFindText = RTrim(convForm(strReplText, 20000))
                      .Selection.TypeText strFindText
                      If strReplText = strFindText Then
                         Exit Do
                      Else
                         strReplText = Mid(strReplText, Len(strFindText) + 1)
                      End If
                    Loop
                    'end 2025/07/24
                Else
                'end 2020/02/17
                    .Selection.TypeText strData: DoEvents
                    '.Selection.TypeParagraph
                End If 'Added by Lydia 2020/02/17
                
               'add by morgan 2007/9/17 檢查有無要在 word 裡面轉換的關鍵字，若是有，必須經過轉換
               'Modify by Amy 2018/08/24 +showColorFirst
               If InStr(1, strData, "|#(") <> 0 Then
                   ChgWordFormat g_WordAp, strData, showColorFirst
               End If
               
               'add by nickc 2006/03/28 加入印代表圖
               If CalVbCrLfCount <> 0 Then
                   PUB_AddInPicToWord g_WordAp, CalVbCrLfCount, showColorFirst
               End If
               'add by morgan 2007/09/17 加入新定稿的固定代表圖
               If InStr(1, strData, "|#右代表圖#|") <> 0 Then
                   PUB_AddInPicToWordR g_WordAp, showColorFirst
               End If
               'Add By Sindy 2014/3/18 加入新定稿的固定代表圖2
               If InStr(1, strData, "|#右代表圖2#|") <> 0 Then
                   PUB_AddInPicToWordR2 g_WordAp, showColorFirst
               End If
               'Modify By Sindy 2014/3/19 加入新定稿的固定代表圖3
               If InStr(1, strData, "|#右代表圖3#|") <> 0 Then
                   PUB_AddInPicToWordR3 g_WordAp, showColorFirst
               End If
               'end 2018/07/30
            End If
         End With
        'Add By Cheng 2002/11/20
        '若是從整批列印進入, 則加註列印Mark"*"
        If strDL02 = "" And strDL03 = "" Then
            strSql = "Update LETTERDEMAND Set LD16='*' " & _
                            " WHERE LD01 = '" & strUserNum & "' AND " & _
                            " LD02 = " & strDate & " AND " & _
                            " LD03 = " & strTime & " "
            'Modify By Sindy 2025/8/11 Mark:這個log無用
            'Pub_SeekTbLog strSql 'Add By Sindy 2020/12/2 桂英:定稿沒有放出來,找不出原因
            '2025/8/11 END
            cnnConnection.Execute strSql
        End If
        
        If pMaxRow > 0 And rsTmp.AbsolutePosition >= pMaxRow Then Exit Do 'Added by Morgan 2022/11/4
        rsTmp.MoveNext
      Loop
         g_WordAp.Selection.WholeStory
         
        '若為日文定稿
        If strOrientation = "3" Then
            'Add by Morgan 2011/7/14
            If (m_MySt(1) = "FCT" Or m_MySt(1) = "CFT" Or m_MySt(1) = "CFC" Or m_MySt(1) = "S") Then
               'Modified by Morgan 2022/7/13 改 MS Mincho -- 毓芳, May
               'g_WordAp.Selection.Font.Name = "細明體"
               g_WordAp.Selection.Font.Name = "MS Mincho"
               'Removed by Morgan 2022/12/20 取消,非英數字(符號、造字...)也會被影響 --經理、May
               'g_WordAp.Selection.Font.Name = "Times New Roman" 'Added by Morgan 2022/12/14 英數字 -- May,毓芳沒意見
               'end 2022/12/20
               'end 2022/7/13
            Else
            'end 2011/7/14
            
               'Modify by Morgan 2005/7/19 改12號字--春美,易雲
               'g_WordAp.Selection.Font.Size = 13
'Modify By Sindy 2019/3/14 Mark.亭妙反應修改和列印的字體大小不一樣,因列印時這裡又會把字體全部改為12
'自然ChgWordFormat的小字都會又被改回來
'FCP-07-1603-06
'               g_WordAp.Selection.Font.Size = 12
'2019/3/14 END
               'Modify by Morgan 2006/1/9 改用標楷體--請作單
               'g_WordAp.Selection.Font.Name = "細明體"
               'Modified by Morgan 2014/9/24 改回細明體 --毓芳
               'g_WordAp.Selection.Font.Name = "標楷體"
               'g_WordAp.Selection.Font.Name = "Times New Roman"
               'Modified by Morgan 2022/7/13 改 MS Mincho -- 毓芳, May
               'g_WordAp.Selection.Font.Name = "細明體"
               g_WordAp.Selection.Font.Name = "MS Mincho"
               'Removed by Morgan 2022/12/20 取消,非英數字(符號、造字...)也會被影響 --經理、May
               'g_WordAp.Selection.Font.Name = "Times New Roman" 'Added by Morgan 2022/12/14 英數字 -- May,毓芳沒意見
               'end 2022/12/20
               'end 2022/7/13
               'end 2014/9/24
            End If 'Add by Morgan 2011/7/14
        Else
            g_WordAp.Selection.Font.Name = "標楷體" 'Added by Morgan 2017/10/20
            g_WordAp.Selection.Font.Name = "Times New Roman"
        End If
        
      '列印定稿
      'Modify by Morgan 2008/1/4 改前景列印,若原先已有使用中的Word(系統產生的)則將批次列印用的Word()的關掉,保持只有一個Word物件
      'g_WordAp.PrintOut Copies:=1, Collate:=True: DoEvents
      ' 清除原文件的資料內容
      'g_WordAp.Selection.WholeStory
      'g_WordAp.Selection.Delete
      
'Removed by Morgan 2013/6/27 改產生內容時就反序
'      'Modified by Morgan 2013/4/22
'      'word 2007 可能不支援,改有傳才設定
'      If bolPrintReverse = True Then
'         g_WordAp.Options.PrintReverse = True 'Add by Morgan 2010/12/21
'      End If
'      'end 2013/4/22
'end 2013/6/27
      
      'Modified by Morgan 2017/9/15
      'g_WordAp.PrintOut Background:=False, Copies:=1, Collate:=True
      If pExport2Pdf Then
         g_WordAp.ActiveDocument.ExportAsFixedFormat OutputFileName:=pPdfSaveName, ExportFormat:=17, OpenAfterExport:=False
      Else
         g_WordAp.PrintOut Background:=False, Copies:=1, Collate:=True
         
         
         'Added by Morgan 2024/11/29
         '列印P台灣案的證書函要接著印公告公報
         If bolPrintGazette And strPdfFile <> "" Then
            PUB_PrintPDF strPdfFile, strPdfPrinter
         End If
         'end 2024/11/29
      End If
      'end 2017/9/15
      
'Removed by Morgan 2013/6/27 改產生內容時就反序
'      'Added by Morgan 2013/4/23 要還原否則會影響後面的定稿順序
'      If bolPrintReverse = True Then
'         g_WordAp.Options.PrintReverse = False
'      End If
'      'end 2013/4/23
'end 2013/6/27

WordClose:
      g_WordAp.ActiveDocument.Close wdDoNotSaveChanges
      
      'Modify by Morgan 2008/12/18
      'g_WordAp.Quit wdDoNotSaveChanges
      'Set g_WordAp = Nothing
      'If Not oWord Is Nothing Then
      '   Set g_WordAp = oWord
      '   Set oWord = Nothing
      'End If
      If bVisible = True Then
         g_WordAp.Visible = True
      Else
         g_WordAp.Quit wdDoNotSaveChanges
         Set g_WordAp = Nothing
      End If
      'end 2008/1/4
   End If
   
   rsTmp.Close
   Set rsTmp = Nothing
   
   GoTo ExitMe
   
ERRORSECTION1:
   
   Select Case Err.Number
      Case 91, 462:
         Set g_WordAp = New Word.Application
         g_WordAp.Documents.add
         Resume Next
      Case Else
         MsgBox "錯誤 : " & Err.Description, vbCritical
         ' 發生錯誤
         PrinterLetterDB = 2
         GoTo ExitMe
   End Select
   
   
   GoTo ExitMe
   
ERRORSECTION2:
   
   Select Case Err.Number
      Case 91:
         g_WordAp.Documents.add
         Resume Next
      Case 462:
         Set g_WordAp = New Word.Application
         g_WordAp.Documents.add
         Resume Next
      Case Else:
         MsgBox "錯誤 : " & Err.Description, vbCritical
         ' 發生錯誤
         PrinterLetterDB = 2
         GoTo ExitMe
   End Select
   GoTo ExitMe
   
ExitMe:
   Forms(0).StatusBar1.Visible = bolBarShow
End Function

''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' 列印定稿
' 說明 : 此函式除了會列印資料庫中待印的定稿以外還回顯示列印完畢的訊息
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
'Modify By Cheng 2003/01/21
'傳入列印方向參數
'Public Sub PrinterLetterDemand()
Public Sub PrinterLetterDemand(Optional strOrientation As String)
   Dim nResult As Integer, nResult2 As Integer
   
   ' 設定滑鼠為Waiting
   Screen.MousePointer = vbHourglass
   ' 列印定稿
   '傳入列印方向參數
   'Modified by Morgan 2022/11/4 改每次印40筆(因為筆數多時Word會越來越慢)
   'nResult = PrinterLetterDB(strUserNum, strOrientation)
   nResult = PrinterLetterDB(strUserNum, strOrientation, , , , , , , , 40)
   nResult2 = nResult
   Do While nResult2 = 0
      nResult2 = PrinterLetterDB(strUserNum, strOrientation, , , , , , , , 40)
   Loop
   If nResult2 <> 1 Then nResult = nResult2
   'end 2022/11/4
   
   ' 設定滑鼠為預設
   Screen.MousePointer = vbDefault
   
   Select Case nResult
      Case 0:
         MsgBox "列印完畢! ", vbOKOnly + vbInformation, "列印定稿"
      Case 1:
         MsgBox "沒有待印的資料! ", vbOKOnly + vbInformation, "列印定稿"
      Case 2:
      Case Else:
   End Select
End Sub

'Add By Cheng 2002/11/20
'取得工作天(以系統日為基準)
Public Function PUB_GetWorkDay(intInterval As Integer) As String
'intInterval : 往前或往後幾個工作天
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset
Dim ii As Integer

'***假設工作天才會使用本系統***
PUB_GetWorkDay = strSrvDate(1)
If intInterval = 0 Then Exit Function
If intInterval > 0 Then
    'Modify By Cheng 2003/05/08
'    strSQLA = " Select * From WorkDay Where WD01 >= " & Val(ServerDate) & " Order By WD01 "
    StrSQLa = " Select * From WorkDay Where WD01 >= " & Val(strSrvDate(1)) & " Order By WD01 "
Else
    'Modify By Cheng 2003/05/08
'    strSQLA = " Select * From WorkDay Where WD01 <= " & Val(ServerDate) & " Order By WD01 Desc "
    StrSQLa = " Select * From WorkDay Where WD01 <= " & Val(strSrvDate(1)) & " Order By WD01 Desc "
End If
If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing
rsA.CursorLocation = adUseClient
'依往前或往後幾個工作天之參數, 設定最大筆數
rsA.MaxRecords = Abs(intInterval)
rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
If rsA.RecordCount > 0 Then
    'Modify By Cheng 2003/04/15
'    For ii = 0 To Abs(intInterval)
    For ii = 1 To Abs(intInterval)
        PUB_GetWorkDay = "" & rsA.Fields(0).Value
        rsA.MoveNext
        If rsA.EOF Then Exit For
    Next ii
End If
If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing
End Function

'Add By Cheng 2002/12/08
'若傳入的日期為工作天則抓當天, 若傳入的日期非工作天則抓最近的工作天
'Modified by Morgan 2014/11/26 +bolNoAdd:是否剔除補班工作天
Public Function PUB_GetWorkDay1(strBeginDate As String, blnBefore As Boolean, Optional bolNoAdd As Boolean = False) As String
'strBeginDate : 基準日
'blnBefore : True 往前抓, False 往後抓
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset
Dim ii As Integer
Dim stCon As String

'Added by Morgan 2014/11/26
If bolNoAdd Then
   stCon = " and wd06 is null"
End If
'end 2014/11/26

If strBeginDate = "" Then PUB_GetWorkDay1 = "": Exit Function
'往前抓
If blnBefore = True Then
    StrSQLa = " Select * From WorkDay Where WD01 <= " & Val(DBDATE(strBeginDate)) & stCon & " Order By WD01 Desc "
'往後抓
Else
    StrSQLa = " Select * From WorkDay Where WD01 >= " & Val(DBDATE(strBeginDate)) & stCon & " Order By WD01 "
End If
rsA.CursorLocation = adUseClient
'Add by Morgan 2003/12/31
rsA.MaxRecords = 1

rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
If rsA.RecordCount > 0 Then
    PUB_GetWorkDay1 = "" & rsA.Fields(0).Value
Else
    PUB_GetWorkDay1 = ""
End If
If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing
End Function
'Add by Morgan 2004/7/1
'讀取申請人相關資料
Public Function PUB_GetAppData(ByVal strAppNo As String, ByRef stFld() As String, ByVal iIdx As Integer) As Boolean

On Error GoTo ErrHnd

   strAppNo = Left(strAppNo & "000", 9)
   
   strSql = "SELECT CU11,CU07,CU10,NA03 FROM CUSTOMER,NATION" & _
      " WHERE CU01='" & Left(strAppNo, 8) & "' AND CU02='" & Right(strAppNo, 1) & "'" & _
      " AND NA01=CU10"
   CheckOC
   adoRecordset.CursorLocation = adUseClient
   adoRecordset.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If adoRecordset.RecordCount > 0 Then
      stFld(iIdx, 0) = "" & adoRecordset(0)
      stFld(iIdx, 1) = "" & adoRecordset(1)
      stFld(iIdx, 2) = "" & adoRecordset(2)
      stFld(iIdx, 3) = "" & adoRecordset(3)
      PUB_GetAppData = True
   End If
   
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
   CheckOC
   
End Function

'2008/10/29 ADD BY SONIA 雙署名,由ExceptFieldData抽出來,因為撰寫信函也要用
Public Function PUB_GetCompany(strCP01 As String, strCP02 As String, strCP03 As String, strCP04 As String) As String
   Dim stComp As String
   
   'Modified by Morgan 2014/1/17 +特殊出名公司 pa161,tm130,sp85
   strExc(0) = "SELECT cu13,pa161 FROM PATENT,customer WHERE PA01='" & strCP01 & "' AND PA02='" & strCP02 & "' AND PA03='" & strCP03 & "' AND PA04='" & strCP04 & "' and substr(pa26,1,8)=cu01(+) and substr(pa26,9,1)=cu02(+) "
   strExc(0) = strExc(0) & " union SELECT cu13,tm130 FROM trademark,customer WHERE tm01='" & strCP01 & "' AND tm02='" & strCP02 & "' AND tm03='" & strCP03 & "' AND tm04='" & strCP04 & "' and substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+) "
   'Add by Morgan 2009/8/10 服務業務也要 TM-000051
   strExc(0) = strExc(0) & " union SELECT cu13,sp85 FROM servicepractice,customer WHERE sp01='" & strCP01 & "' AND sp02='" & strCP02 & "' AND sp03='" & strCP03 & "' AND sp04='" & strCP04 & "' and substr(sp08,1,8)=cu01(+) and substr(sp08,9,1)=cu02(+) "
   intI = 1
   Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
   If intI = 1 Then
      'Modify by Morgan 2008/6/30
      'If CheckStr(RsTemp.Fields(0)) = "96030" Or CheckStr(RsTemp.Fields(0)) = "96032" Then
      If CheckStr(RsTemp.Fields(0)) = "96029" Or CheckStr(RsTemp.Fields(0)) = "96030" Then
          'Modified by Morgan 2020/3/23
          'PUB_GetCompany = "北京巨京知識產權代理有限公司　　　　　台一國際專利商標事務所　敬上"
          'Modified by Morgan 2023/11/8  取消巨京--鄭天雲/沈佳穎
          'If strSrvDate(1) >= 事務所合併日 Then
          '  PUB_GetCompany = "北京巨京知識產權代理有限公司　　　　　" & CompNameQuery("2") & "　敬上"
          'Else
          '  PUB_GetCompany = "北京巨京知識產權代理有限公司　　　　　" & CompNameQuery("1") & "　敬上"
          'End If
          PUB_GetCompany = "　　　　　　　　　　　　　　　　　　　" & CompNameQuery("2") & "　敬上"
          'end 2023/11/8
          'end 2020/3/23
          
      '2008/9/5 add by sonia
      Else
         If CheckStr(RsTemp.Fields(0)) = "96031" Or CheckStr(RsTemp.Fields(0)) = "96032" Then
            'Modified by Morgan 2020/3/23
            'PUB_GetCompany = "北京巨京知識產權代理有限公司　　　　　台一國際專利法律事務所　敬上"
            PUB_GetCompany = "北京巨京知識產權代理有限公司　　　　　" & CompNameQuery("2") & "　敬上"
            'end 2020/3/23
            
         '2008/9/5 end
         Else
            '2008/9/5 modify by sonia
            'PUB_GetCompany = "　　　　　　　　　　　　　　　　　　　　台一國際專利商標事務所"
            'Modify by Morgan 2009/8/10 服務業務也要
            'If strCP01 = "P" Then
            If strCP01 = "P" Or strCP01 = "PS" Then
               'Modified by Morgan 2014/12/11
               'PUB_GetCompany = "　　　　　　　　　　　　　　　　　　　　　　　　　王　錦　寬　敬上"
               'Modified by Morgan 2014/12/18
               'PUB_GetCompany = PUB_GetOrderLetterSignature
               PUB_GetCompany = PUB_GetOrderLetterSignature(strCP01, strCP02, strCP03, strCP04)
               'end 2014/12/18
               'end 2014/12/11
            Else
               
               'Modified by Morgan 2020/3/23
               ''Added by Morgan 2014/1/17
               'If RsTemp.Fields(0) = "J" Then
               '   PUB_GetCompany = "　　　　　　　　　　　　　　　　　　　台一智權股份有限公司　敬上"
               'Else
               ''end 2014/1/17
               '   PUB_GetCompany = "　　　　　　　　　　　　　　　　　　　台一國際專利商標事務所　敬上"
               'End If
               stComp = PUB_GetReceiptComp(strCP01, strCP02, strCP03, strCP04, True)
               PUB_GetCompany = "　　　　　　　　　　　　　　　　　　　" & CompNameQuery(stComp) & "　敬上"
               'end 2020/3/23
            End If
            '2008/9/5 end
         End If
      End If
   End If
End Function
'2008/10/29 END

'Add by Morgan 2004/7/1
'列印專利年費減免申請書
'stData()：文件相關資料
'stAppData()：申請人相關資料
'bolEdit：是否修改
'bolEdit：是否出名
Public Sub PUB_PrintDiscForm(ByRef stData() As String, ByRef stAppData() As String, ByVal bolName As Boolean, ByVal bolEdit As Boolean, Optional ByVal bolReasign As Boolean = False)

   Dim strTemp As String, lngMoney As Long, iAppCnt As Integer, ii As Integer, iCopys As Integer
   Dim stFind As String
   Dim bolRetry As Boolean
   Const cstCheck As String = "ν"
   Dim StrSQLa As String 'Added by lydia 2022/03/29
   
On Error GoTo ErrHnd

   If g_WordAp Is Nothing Then Set g_WordAp = New Word.Application

   If g_WordAp.Documents.Count > 0 Then g_WordAp.Documents.Close savechanges:=False
   With g_WordAp
      .Documents.Open FileName:=App.path & "\29專利年費減免申請書.doc", ReadOnly:=True
      '.Visible = True
      .Selection.Font.Name = "標楷體"
      .Selection.Font.Size = 14

      stFind = "申請案號："
      .Selection.Find.ClearFormatting
      If .Selection.Find.Execute(stFind) = True Then
         .Selection.MoveRight Unit:=wdCharacter, Count:=1 '右移一格
         .Selection.Delete wdCharacter, Count:=1
         .Selection.TypeText Text:="" & stData(1)
      End If

      stFind = "26400"
      .Selection.Find.ClearFormatting
      If .Selection.Find.Execute(stFind) = True Then
         .Selection.MoveRight Unit:=wdCharacter, Count:=1 '右移一格
         .Selection.TypeText Text:=Space(30) & stData(2)
      End If

      stFind = "申請日期："
      .Selection.Find.ClearFormatting
      If .Selection.Find.Execute(stFind) = True Then
         .Selection.MoveRight Unit:=wdCharacter, Count:=1 '右移一格
         .Selection.Delete wdCharacter, Count:=1
         .Selection.TypeText Text:=stData(3)
      End If

      Select Case stData(4)
         Case "1"
            stFind = "發明"
         Case "2"
            stFind = "新型"
         Case "3"
            stFind = "設計"
      End Select
      .Selection.Find.ClearFormatting
      If .Selection.Find.Execute(stFind) = True Then
         .Selection.MoveLeft Unit:=wdCharacter, Count:=2 '左移一格
         .Selection.TypeBackspace
         .Selection.TypeText Text:=cstCheck
         .Selection.Delete wdCharacter, Count:=1
      End If
      stFind = "第"
      .Selection.Find.ClearFormatting
      If .Selection.Find.Execute(stFind) = True Then
         .Selection.MoveRight Unit:=wdCharacter, Count:=1 '右移一格
         .Selection.Delete wdCharacter, Count:=1
         .Selection.TypeText Text:=stData(5)
      End If

      stFind = ""
      'Modify by Morgan 2004/7/22
      '改會多選
      If InStr(stData(6), "1") > 0 Then
         stFind = "自然人"
         .Selection.Find.ClearFormatting
         If .Selection.Find.Execute(stFind) = True Then
            .Selection.MoveLeft Unit:=wdCharacter, Count:=2 '左移一格
            .Selection.TypeBackspace
            .Selection.TypeText Text:=cstCheck
            .Selection.Delete wdCharacter, Count:=1
         End If
      End If
      If InStr(stData(6), "2") > 0 Then
         stFind = "學校"
         .Selection.Find.ClearFormatting
         If .Selection.Find.Execute(stFind) = True Then
            .Selection.MoveLeft Unit:=wdCharacter, Count:=2 '左移一格
            .Selection.TypeBackspace
            .Selection.TypeText Text:=cstCheck
            .Selection.Delete wdCharacter, Count:=1
         End If
      End If
      If InStr(stData(6), "3") > 0 Then
         stFind = "中小企業"
         .Selection.Find.ClearFormatting
         If .Selection.Find.Execute(stFind) = True Then
            .Selection.MoveLeft Unit:=wdCharacter, Count:=2 '左移一格
            .Selection.TypeBackspace
            .Selection.TypeText Text:=cstCheck
            .Selection.Delete wdCharacter, Count:=1
         End If
      End If
      'End
      
      For ii = Val(Left(stData(7), 1)) To Val(Right(stData(7), 1))
         stFind = "第" & PUB_ChgNumber2Chinese(Format(ii)) & "年"
         .Selection.Find.ClearFormatting
         If .Selection.Find.Execute(stFind) = True Then
            .Selection.MoveLeft Unit:=wdCharacter, Count:=2 '左移一格
            .Selection.TypeBackspace
            .Selection.TypeText Text:=cstCheck
            .Selection.Delete wdCharacter, Count:=1
         End If
      Next
      
      stFind = "第六年"
      .Selection.Find.ClearFormatting
      If .Selection.Find.Execute(stFind) = True Then
         .Selection.MoveRight Unit:=wdCharacter, Count:=3 '右移一格
         .Selection.TypeBackspace
         .Selection.TypeText Text:=cstCheck
         .Selection.Delete wdCharacter, Count:=1
      End If

      strTemp = stData(7)
      stFind = "年至第"
      .Selection.Find.ClearFormatting
      If .Selection.Find.Execute(stFind) = True Then
         .Selection.TypeBackspace
         .Selection.Delete wdCharacter, Count:=1
         .Selection.TypeBackspace
         .Selection.Delete wdCharacter, Count:=1
         .Selection.TypeText Text:=strTemp
         stFind = "新台幣"
         .Selection.Find.ClearFormatting
         If .Selection.Find.Execute(stFind) = True Then
            .Selection.MoveRight Unit:=wdCharacter, Count:=1 '右移一格
            .Selection.Delete wdCharacter, Count:=1
            .Selection.TypeText Text:=stData(8)
         End If
      End If

      'Add by Morgan 2007/6/26
      If bolReasign = True Then
         stFind = "一、"
         .Selection.Find.ClearFormatting
         If .Selection.Find.Execute(stFind) = True Then
            .Selection.MoveLeft Unit:=wdCharacter, Count:=1 '右移一格
            .Selection.Font.Size = 14
            'Modified by Lydia 2022/03/29 抓員工名稱: 76012 桂齊恆、81040 閻啟泰
            '.Selection.TypeText "本案同時辦理重新委任「桂齊恆、閻啟泰」為專利代理人，檢附委任書。"
            StrSQLa = Replace(PUB_ReadUserData("76012,81040"), ",", "、")
            .Selection.TypeText "本案同時辦理重新委任「" & StrSQLa & "」為專利代理人，檢附委任書。"
            'end 2022/03/39
            .Selection.TypeParagraph
         End If
      End If

      stFind = "共"
      .Selection.Find.ClearFormatting
      If .Selection.Find.Execute(stFind) = True Then
         .Selection.MoveRight Unit:=wdCharacter, Count:=1 '右移一格
         .Selection.Delete wdCharacter, Count:=1
         .Selection.TypeText Text:=stData(9)
      End If

      iAppCnt = Val(stData(9))
      stFind = "姓名或名稱"
      .Selection.Find.ClearFormatting
      If .Selection.Find.Execute(stFind) = True Then
         .Selection.MoveDown Unit:=wdLine, Count:=1   '下移一列
         .Selection.TypeBackspace
         .Selection.Delete wdCharacter, Count:=1
         .Selection.ParagraphFormat.IndentCharWidth 1
         .Selection.Font.Bold = False
         If iAppCnt = 1 Then
            .Selection.TypeText stAppData(1, 4) & "  ID：" & stAppData(1, 0)
         Else
            .Selection.TypeText "1." & stAppData(1, 4) & "  ID：" & stAppData(1, 0)
            For ii = 2 To iAppCnt
               .Selection.TypeParagraph
               '.Selection.ParagraphFormat.IndentCharWidth 1
               .Selection.TypeText Format(ii) & "." & stAppData(ii, 4) & "  ID：" & stAppData(ii, 0)
            Next
         End If
      End If
      stFind = "代表人"
      .Selection.Find.ClearFormatting
      If .Selection.Find.Execute(stFind) = True Then
         .Selection.EndKey Unit:=wdLine
         .Selection.TypeParagraph
         .Selection.ParagraphFormat.IndentCharWidth 1
         .Selection.Font.Bold = False
         If iAppCnt = 1 Then
            .Selection.TypeText stAppData(1, 1)
         Else
            .Selection.TypeText "1." & stAppData(1, 1)
            For ii = 2 To iAppCnt
               .Selection.TypeParagraph
               '.Selection.ParagraphFormat.IndentCharWidth 1
               .Selection.TypeText Format(ii) & "." & stAppData(ii, 1)
            Next
         End If
      End If

      stFind = "住居所"
      .Selection.Find.ClearFormatting
      If .Selection.Find.Execute(stFind) = True Then
         .Selection.EndKey Unit:=wdLine
         .Selection.TypeParagraph
         .Selection.ParagraphFormat.IndentCharWidth 1
         .Selection.Font.Bold = False
         If iAppCnt = 1 Then
            .Selection.TypeText "" & stAppData(1, 5)
         Else
            .Selection.TypeText "1." & stAppData(1, 5)
            For ii = 2 To iAppCnt
               .Selection.TypeParagraph
               '.Selection.ParagraphFormat.IndentCharWidth 1
               .Selection.TypeText Format(ii) & "." & stAppData(ii, 5)
            Next
         End If
      End If

      stFind = "國籍"
      .Selection.Find.ClearFormatting
      If .Selection.Find.Execute(stFind) = True Then
         .Selection.EndKey Unit:=wdLine
         .Selection.TypeParagraph
         .Selection.ParagraphFormat.IndentCharWidth 1
         .Selection.Font.Bold = False
         If iAppCnt = 1 Then
            .Selection.TypeText IIf(Val(stAppData(1, 2)) < 10, "中華民國", stAppData(1, 3))
         Else
            .Selection.TypeText "1." & IIf(Val(stAppData(1, 2)) < 10, "中華民國", stAppData(1, 3))
            For ii = 2 To iAppCnt
               .Selection.TypeParagraph
               '.Selection.ParagraphFormat.IndentCharWidth 1
               .Selection.TypeText Format(ii) & "." & IIf(Val(stAppData(ii, 2)) < 10, "中華民國", stAppData(ii, 3))
            Next
         End If
      End If

      If bolName = True Then
      
'Modify by Morgan 2006/3/9
'         stFind = "（蓋章）"
'         .Selection.Find.ClearFormatting
'         If .Selection.Find.Execute(stFind) = True Then
'            .Selection.MoveRight Unit:=wdCharacter, Count:=1 '右移一格
'            .Selection.Delete wdCharacter, Count:=1
'            'Modify by Morgan 2005/9/29 改動態
'            '.Selection.TypeText "林 鎰 珠 專利代理人"
'            .Selection.TypeText stData(18) & " 專利代理人"
'         End If
'         stFind = "ID： "
'         .Selection.Find.ClearFormatting
'         If .Selection.Find.Execute(stFind) = True Then
'            'Modify by Morgan 2005/9/29 改不印
'            '.Selection.MoveRight Unit:=wdCharacter, Count:=1 '右移一格
'            '.Selection.Delete wdCharacter, Count:=1
'            '.Selection.TypeText "B100462593"
'            .Selection.Delete wdCharacter, Count:=2
'         End If
'         stFind = "台代字第"
'         .Selection.Find.ClearFormatting
'         If .Selection.Find.Execute(stFind) = True Then
'            .Selection.MoveRight Unit:=wdCharacter, Count:=1 '右移一格
'            .Selection.Delete wdCharacter, Count:=1
'            .Selection.TypeText "　四七四　"
'         End If
         stFind = "姓名："
         .Selection.Find.ClearFormatting
         If .Selection.Find.Execute(stFind) = True Then
            .Selection.TypeText GetOurAgentData(stData(19), False)
         End If
'2006/3/9 end

         stFind = "地址： "
         .Selection.Find.ClearFormatting
         If .Selection.Find.Execute(stFind) = True Then
            .Selection.MoveRight Unit:=wdCharacter, Count:=1 '右移一格
            .Selection.Delete wdCharacter, Count:=1
            .Selection.TypeText "台北市中山區長安東路二段一一二號九樓"
         End If
         stFind = "聯絡電話及分機： "
         .Selection.Find.ClearFormatting
         If .Selection.Find.Execute(stFind) = True Then
            .Selection.MoveRight Unit:=wdCharacter, Count:=1 '右移一格
            .Selection.Delete wdCharacter, Count:=1
            .Selection.TypeText "(02)2506-1023/分機341"
         End If
         stFind = "E-MAIL： "
         .Selection.Find.ClearFormatting
         If .Selection.Find.Execute(stFind) = True Then
            .Selection.MoveRight Unit:=wdCharacter, Count:=1 '右移一格
            .Selection.Delete wdCharacter, Count:=1
            .Selection.TypeText "taie@seed.net.tw"
            .Selection.TypeParagraph
            .Selection.Font.Bold = False
            'Modify by Morgan 2011/6/21
            '.Selection.TypeText "發文字號：" & Left(stData(3), 2) & "年" & Mid(stData(3), 4, 2) & "月" & Right(stData(3), 2) & "日(" & Left(stData(3), 2) & ")晉" & PUB_GetST07(strUserNum) & "字第　　　　號"
            .Selection.TypeText "發文字號：" & Format(PUB_DBYEAR(stData(3)) - 1911) & "年" & Format(PUB_DBMONTH(stData(3))) & "月" & Format(PUB_DBDAY(stData(3))) & "日(" & Format(PUB_DBYEAR(stData(3)) - 1911) & ")晉" & PUB_GetST07(strUserNum) & "字第　　　　號"
         End If
      End If

      lngMoney = Val(stData(10))
      If lngMoney > 0 Then
         stFind = "繳納第"
         .Selection.Find.ClearFormatting
         If .Selection.Find.Execute(stFind) = True Then
            .Selection.MoveRight Unit:=wdCharacter, Count:=1 '右移一格
            .Selection.Delete wdCharacter, Count:=1
            .Selection.TypeText stData(11)
         End If
         stFind = "年至第"
         .Selection.Find.ClearFormatting
         If .Selection.Find.Execute(stFind) = True Then
            .Selection.MoveRight Unit:=wdCharacter, Count:=1 '右移一格
            .Selection.Delete wdCharacter, Count:=1
            .Selection.TypeText stData(12)
         End If
         
         'Add by Morgan 2009/2/26 逾期補繳加註
         If stData(20) = "Y" Then
            stFind = "年費金額："
            .Selection.Find.ClearFormatting
            If .Selection.Find.Execute(stFind) = True Then
               .Selection.MoveRight Unit:=wdCharacter, Count:=1 '右移一格
               'Modify by Morgan 2009/3/4 -- 敏惠
               '.Selection.Font.Size = 14
               '.Selection.Font.Bold = False
               '.Selection.TypeText Text:="(""當年年費""逾期補繳)"
               .Selection.TypeText Text:="(逾期補繳)"
               'end 2009/3/4
            End If
         End If
         
         strTemp = ""
         If lngMoney >= 100000 Then
            strTemp = ShowNumberWord(Left(Format(lngMoney), 1))
            strTemp = strTemp & "拾"
            lngMoney = lngMoney Mod 100000
         End If
         If lngMoney >= 10000 Then
            strTemp = strTemp & ShowNumberWord(Left(Format(lngMoney), 1))
            lngMoney = lngMoney Mod 10000
         End If


         stFind = "共計新台幣："
         .Selection.Find.ClearFormatting
         If .Selection.Find.Execute(stFind) = True Then
            .Selection.MoveRight Unit:=wdCharacter, Count:=1 '右移一格
            .Selection.Delete wdCharacter, Count:=1
            .Selection.Font.Bold = False
            .Selection.TypeText Text:=IIf(strTemp = "", "零", strTemp)
         End If

         strTemp = ""
         If lngMoney >= 1000 Then
            strTemp = ShowNumberWord(Left(Format(lngMoney), 1))
            lngMoney = lngMoney Mod 1000
         End If

         stFind = "萬"
         .Selection.Find.ClearFormatting
         If .Selection.Find.Execute(stFind) = True Then
            .Selection.MoveRight Unit:=wdCharacter, Count:=1 '右移一格
            .Selection.Delete wdCharacter, Count:=1
            .Selection.Font.Bold = False
            .Selection.TypeText Text:=IIf(strTemp = "", "零", strTemp)
         End If

         strTemp = ""
         If lngMoney >= 100 Then
            strTemp = strTemp & ShowNumberWord(Left(Format(lngMoney), 1))
            lngMoney = lngMoney Mod 100
         End If

         stFind = "千"
         .Selection.Find.ClearFormatting
         If .Selection.Find.Execute(stFind) = True Then
            .Selection.MoveRight Unit:=wdCharacter, Count:=1 '右移一格
            .Selection.Delete wdCharacter, Count:=1
            .Selection.Font.Bold = False
            .Selection.TypeText Text:=IIf(strTemp = "", "零", strTemp)
         End If

         strTemp = ""
         If lngMoney >= 10 Then
            strTemp = strTemp & ShowNumberWord(Left(Format(lngMoney), 1))
            strTemp = strTemp & "拾"
            lngMoney = lngMoney Mod 10
         End If
         If lngMoney >= 1 Then
            strTemp = strTemp & ShowNumberWord(Left(Format(lngMoney), 1))
         End If

         stFind = "百"
         .Selection.Find.ClearFormatting
         If .Selection.Find.Execute(stFind) = True Then
            .Selection.MoveRight Unit:=wdCharacter, Count:=1 '右移一格
            .Selection.Delete wdCharacter, Count:=1
            .Selection.Font.Bold = False
            .Selection.TypeText Text:=IIf(strTemp = "", "零", strTemp)
         End If
         .Selection.EndKey Unit:=wdLine
         .Selection.TypeText Text:="(NT " & Format(Val(stData(10)), "###,###,###") & " 元)"
      End If

      If bolEdit = False Then
         .PrintOut Copies:=1, Collate:=True: DoEvents
      End If


      If stData(13) <> "" Then
         .Selection.EndKey Unit:=wdStory
         .Selection.TypeParagraph
         .Selection.TypeParagraph
         .Selection.Font.Size = 14
         .Selection.Font.Bold = True
         .Selection.TypeText Text:="下一次年費請於 " & stData(13) & " 前通知本所繳交，"
         .Selection.TypeParagraph
         .Selection.TypeText Text:="逾補繳期限，則專利權當然消滅。"
      End If

      If bolEdit = False Then
         .PrintOut Copies:=1, Collate:=True: DoEvents
      End If
      
      '分所號
      If stData(17) <> "" Then
         stFind = "申請日期："
         .Selection.Find.ClearFormatting
         .Selection.HomeKey Unit:=wdStory
         If .Selection.Find.Execute(stFind) = True Then
            .Selection.EndKey Unit:=wdLine
            .Selection.Font.Bold = False
            .Selection.Font.Name = "標楷體"
            .Selection.TypeText Text:=Space(30) & stData(17)
         End If
      End If

      .Selection.EndKey Unit:=wdStory
      .Selection.TypeParagraph
      .Selection.TypeParagraph
      .Selection.Font.Bold = True
      .Selection.TypeText Text:=stData(14) & "　" & stData(15)

      iCopys = Val(stData(16))
      If bolEdit = False Then
         .PrintOut Copies:=iCopys - 2, Collate:=True: DoEvents
         .Documents.Close savechanges:=False
      Else
         .Visible = True
      End If

   End With

ErrHnd:
   
   If Err.Number <> 0 Then
      If Err.Number = 462 And bolRetry = False Then
         Set g_WordAp = New Word.Application
         Err.Clear
         bolRetry = True
         Resume
      Else
         MsgBox Err.Description, vbCritical
      End If
   End If
End Sub
'Modify by Morgan 2009/7/31 改先抓各系統的子定稿抓不到才改抓P
'Add by Morgan 2004/7/7
'取得共用文字內容
Private Function GetText(ByVal FTM06 As String, Optional ByVal FTM01 As String, Optional ByVal FTM02 As String = "22", Optional ByVal FTM03 As String = "000") As String
   Dim strRtn As String, bAfter As Boolean
   Dim adoRst As ADODB.Recordset, stSQL As String, intR As Integer
   
   If FTM01 = Empty Then
      bAfter = True
      FTM01 = m_MySt(1)
   End If
   
   'Modify by Morgan 2010/11/12 定稿內容+FTM08
   stSQL = "SELECT FTM05,FTM08 FROM FINALTEXTMAP WHERE FTM01='" & FTM01 & "' AND FTM02='" & FTM02 & "' AND FTM03='" & FTM03 & "' AND FTM06='" & ChgSQL(FTM06) & "'"
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      strRtn = "" & adoRst.Fields(0) & adoRst.Fields(1)
      'Add by Morgan 2009/7/28 後置處理的公用文字可有例外欄位(需測試,可能不是所有例外欄位都適用)
      If bAfter Then
         strRtn = Parser(strRtn)
      End If
      'end 2009/7/28
   ElseIf FTM01 <> "P" Then
      'Modify by Morgan 2010/11/12 定稿內容+FTM08
      stSQL = "SELECT FTM05,FTM08 FROM FINALTEXTMAP WHERE FTM01='P' AND FTM02='" & FTM02 & "' AND FTM03='" & FTM03 & "' AND FTM06='" & ChgSQL(FTM06) & "'"
      intR = 1
      Set adoRst = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         strRtn = "" & adoRst.Fields(0) & adoRst.Fields(1)
         If bAfter Then
            strRtn = Parser(strRtn)
         End If
      End If
   End If
   GetText = strRtn
   
   Set adoRst = Nothing
End Function
'Add by Morgan 2004/7/7 -->後置作業(列印前)
'取得共用文字內容，暫時只能抓一次
'|?......?|符號間的內容最後才到資料庫(FTM05)抓(為應付定稿超過4000字問題---Morgan)
Private Function TransText(ByVal stContent As String) As String
   TransText = stContent
   Dim iPos1 As Integer, iPos2 As Integer, stFTM06 As String, stText As String
   iPos1 = InStr(stContent, "|?")
   If iPos1 > 0 Then
      iPos2 = InStr(stContent, "?|")
      If iPos2 > iPos1 Then
         stFTM06 = Mid(stContent, iPos1 + 2, iPos2 - iPos1 - 2)
         stText = GetText(stFTM06) '後置作業不可傳系統別
         If stText <> "" Then
            TransText = Left(stContent, iPos1 - 1) & stText & Right(stContent, Len(stContent) - iPos2 - 1)
         '當搜尋不到時，就是有要印 word 前再抓資料的需求，因為欄位長度不足
         Else
            stText = BeforePrintGetDBData(stFTM06)
            'If stText <> "" Then
                TransText = Left(stContent, iPos1 - 1) & stText & Right(stContent, Len(stContent) - iPos2 - 1)
            'End If
         End If
      End If
   End If
End Function

'add by nick 2004/09/16
'當搜尋不到時，就是有要印 word 前再抓資料的需求，因為欄位長度不足
'oStr 格式     TMGoods:CFT-999999-0-00
'Modify By Sindy 2014/7/18 Private->Public
'Private Function BeforePrintGetDBData(ByVal oStr As String) As String
'Modify by Amy 2017/03/13 +bolNotShowTit:不顯示 商品類別：/指定商品：文字
'Modify by Amy 2019/05/30 +bolShowCEJ 是否show 中->英->日 for 客戶總簿用
Public Function BeforePrintGetDBData(ByVal oStr As String, Optional ByVal bolNotShowTit As Boolean = False, Optional ByVal bolShowCEJ As Boolean = False) As String
Dim Key930916 As String
Dim PKey930916 As String
Dim tmpKey930916 As Variant
Dim oStrSQL As String
Dim RS930916 As New ADODB.Recordset
Dim tmpOtherCol As Variant, strCP10 As String 'Add By Sindy 2017/10/26
Dim stTemp As String 'Add by Amy 2020/08/27

tmpKey930916 = Split(oStr, ":")
Key930916 = Trim(tmpKey930916(0))
PKey930916 = Trim(tmpKey930916(1))
Select Case Key930916
Case "TMGoods"
        'Add By Sindy 2017/10/26
        strCP10 = m_MySt(5)
'        tmpOtherCol = Split(PKey930916, ",")
'        If UBound(tmpOtherCol) > 0 Then
'            tmpKey930916 = Split(tmpOtherCol(0), "-")
'            strCP10 = tmpOtherCol(1)
'        Else
        '2017/10/26 END
         tmpKey930916 = Split(PKey930916, "-")
'        End If
        
        '商品服務檔
        'edit by nickc 2008/03/05 多筆一起帶出
        'oStrSQL = "select tg06,tg07,tg08 from tmgoods where tg01='" & Trim(tmpKey930916(0)) & "' and tg02='" & Trim(tmpKey930916(1)) & "' and tg03='" & IIf(UBound(tmpKey930916) >= 2, Trim(tmpKey930916(2)), "0") & "' and tg04='" & IIf(UBound(tmpKey930916) = 3, Trim(tmpKey930916(3)), "00") & "' order by tg05 "
        'edit by nickc 2008/03/28  加欄位
        'oStrSQL = "select tg05,tg06,tg07,tg08 from tmgoods where tg01='" & Trim(tmpKey930916(0)) & "' and tg02='" & Trim(tmpKey930916(1)) & "' and tg03='" & IIf(UBound(tmpKey930916) >= 2, Trim(tmpKey930916(2)), "0") & "' and tg04='" & IIf(UBound(tmpKey930916) = 3, Trim(tmpKey930916(3)), "00") & "' order by tg05 "
        'Modify By Sindy 2017/10/26 +,tg18
        oStrSQL = "select tg05,tg06,tg07,tg08,tg15,tg16,tg17,tg18 from tmgoods where tg01='" & Trim(tmpKey930916(0)) & "' and tg02='" & Trim(tmpKey930916(1)) & "' and tg03='" & IIf(UBound(tmpKey930916) >= 2, Trim(tmpKey930916(2)), "0") & "' and tg04='" & IIf(UBound(tmpKey930916) = 3, Trim(tmpKey930916(3)), "00") & "' order by tg05 "
        If RS930916.State = 1 Then RS930916.Close
        RS930916.CursorLocation = adUseClient
        RS930916.Open oStrSQL, cnnConnection, adOpenStatic, adLockReadOnly
        If RS930916.RecordCount <> 0 Then
            'edit by nickc 2008/03/05 多筆一起帶出
            'BeforePrintGetDBData =  CheckStr(RS930916.Fields(0).Value) & CheckStr(RS930916.Fields(1).Value) & CheckStr(RS930916.Fields(2).Value)
            RS930916.MoveFirst
            'Modify by Amy 2017/03/13 +if 不秀 商品類別：/指定商品：時不換行
            If bolNotShowTit = False Then
                BeforePrintGetDBData = vbCrLf
            Else
                BeforePrintGetDBData = ""
            End If
            Do While Not RS930916.EOF
               'Add By Sindy 2017/10/26 若為延展案,未延展商品類別不顯示出來
               If Not (strCP10 = "102" And "" & RS930916.Fields("tg18") = "N") Then
               '2017/10/26 END
                'BeforePrintGetDBData = BeforePrintGetDBData & CheckStr(RS930916.Fields(0).Value) & CheckStr(RS930916.Fields(1).Value) & CheckStr(RS930916.Fields(2).Value)
                'edit by nickc 2008/03/28 加欄位
                'BeforePrintGetDBData = BeforePrintGetDBData & CheckStr(RS930916.Fields("TG05")) & "：" & CheckStr(RS930916.Fields("TG06").Value) & CheckStr(RS930916.Fields("TG07").Value) & CheckStr(RS930916.Fields("TG08").Value) & vbCrLf
                '2008/11/25 MODIFY BY SONIA TF-000570
                'BeforePrintGetDBData = BeforePrintGetDBData & CheckStr(RS930916.Fields("TG05")) & "：" & CheckStr(RS930916.Fields("TG06").Value) & CheckStr(RS930916.Fields("TG15").Value) & CheckStr(RS930916.Fields("TG07").Value) & CheckStr(RS930916.Fields("TG16").Value) & CheckStr(RS930916.Fields("TG08").Value) & CheckStr(RS930916.Fields("TG17").Value) & vbCrLf
                If Trim(tmpKey930916(0)) = "TF" Then
                  'Modified by Lydia 2020/02/17 去掉DB中的換行符號+PUB_StringFilter()
                  'Remove by Lydia 2020/02/27 因為CFT會用換行號,所以還原不用PUB_StringFilter
                  BeforePrintGetDBData = BeforePrintGetDBData & "第" & CheckStr(RS930916.Fields("TG05")) & "類：" & CheckStr(RS930916.Fields("TG06").Value) & CheckStr(RS930916.Fields("TG15").Value) & CheckStr(RS930916.Fields("TG07").Value) & CheckStr(RS930916.Fields("TG16").Value) & CheckStr(RS930916.Fields("TG08").Value) & CheckStr(RS930916.Fields("TG17").Value) & vbCrLf
                Else
                  'Modify By Sindy 2009/07/03
                  'BeforePrintGetDBData = BeforePrintGetDBData & CheckStr(RS930916.Fields("TG05")) & "：" & CheckStr(RS930916.Fields("TG06").Value) & CheckStr(RS930916.Fields("TG15").Value) & CheckStr(RS930916.Fields("TG07").Value) & CheckStr(RS930916.Fields("TG16").Value) & CheckStr(RS930916.Fields("TG08").Value) & CheckStr(RS930916.Fields("TG17").Value) & vbCrLf
                  If Trim(tmpKey930916(4)) = "" Then '全部
                     'Modified by Lydia 2020/02/17 去掉DB中的換行符號+PUB_StringFilter()
                     'Remove by Lydia 2020/02/27 因為CFT會用換行號,所以還原不用PUB_StringFilter
                     BeforePrintGetDBData = BeforePrintGetDBData & CheckStr(RS930916.Fields("TG05")) & "：" & CheckStr(RS930916.Fields("TG06").Value) & CheckStr(RS930916.Fields("TG15").Value) & CheckStr(RS930916.Fields("TG07").Value) & CheckStr(RS930916.Fields("TG16").Value) & CheckStr(RS930916.Fields("TG08").Value) & CheckStr(RS930916.Fields("TG17").Value) & vbCrLf
                  ElseIf Trim(tmpKey930916(4)) = "中文" Then
                     'Modified by Lydia 2020/02/17 去掉DB中的換行符號+PUB_StringFilter()
                     'Remove by Lydia 2020/02/27 因為CFT會用換行號,所以還原不用PUB_StringFilter
                     BeforePrintGetDBData = BeforePrintGetDBData & CheckStr(RS930916.Fields("TG05")) & "：" & CheckStr(RS930916.Fields("TG06").Value) & CheckStr(RS930916.Fields("TG15").Value) & vbCrLf
                  'Add By Sindy 2014/8/20
                  ElseIf Trim(tmpKey930916(4)) = "中文含第類" Then
                     'Modified by Lydia 2020/02/17 去掉DB中的換行符號+PUB_StringFilter()
                     'Remove by Lydia 2020/02/27 因為CFT會用換行號,所以還原不用PUB_StringFilter
                     BeforePrintGetDBData = BeforePrintGetDBData & "第" & CheckStr(RS930916.Fields("TG05")) & "類：" & CheckStr(RS930916.Fields("TG06").Value) & CheckStr(RS930916.Fields("TG15").Value) & vbCrLf
                  '2014/8/20 END
                  
                  'Added by Morgan 2022/12/30
                  ElseIf Trim(tmpKey930916(4)) = "分割" Then
                     If BeforePrintGetDBData = vbCrLf Then BeforePrintGetDBData = ""
                     BeforePrintGetDBData = BeforePrintGetDBData & vbCrLf & "第" & CheckStr(RS930916.Fields("TG05")) & "類：「" & CheckStr(RS930916.Fields("TG06").Value) & CheckStr(RS930916.Fields("TG15").Value) & "」" & IIf(Val(RS930916.Fields("TG05")) >= 35 And Val(RS930916.Fields("TG05")) <= 45, "服務", "商品")
                  ElseIf Trim(tmpKey930916(4)) = "標章分割" Then
                     BeforePrintGetDBData = BeforePrintGetDBData & "「" & CheckStr(RS930916.Fields("TG06").Value) & CheckStr(RS930916.Fields("TG15").Value) & "」"
                  'Add By Sindy 2014/7/18
                  ElseIf Trim(tmpKey930916(4)) = "中文含標題" Then
                    'Modify by Amy 2017/03/13 +if
                    If bolNotShowTit = False Then
                        'Modified by Lydia 2020/02/17 去掉DB中的換行符號+PUB_StringFilter()
                        'Remove by Lydia 2020/02/27 因為CFT會用換行號,所以還原不用PUB_StringFilter
                        BeforePrintGetDBData = BeforePrintGetDBData & "商品類別：" & CheckStr(RS930916.Fields("TG05")) & vbCrLf
                        BeforePrintGetDBData = BeforePrintGetDBData & "指定商品：" & CheckStr(RS930916.Fields("TG06").Value) & CheckStr(RS930916.Fields("TG15").Value) & vbCrLf
                    Else
                        'Modify by Amy 2019/05/30 +if bolShowCEJ
                        'Modified by Lydia 2020/02/17 去掉DB中的換行符號+PUB_StringFilter()
                        'Remove by Lydia 2020/02/27 因為CFT會用換行號,所以還原不用PUB_StringFilter
                        'Modify by Amy 2020/08/27 原使用BeforePrintGetDBData 造成多個類別內否不會串 ex:CFT-013694(案件總簿)
                        stTemp = CheckStr(RS930916.Fields("TG06").Value) & CheckStr(RS930916.Fields("TG15").Value)
                        If bolShowCEJ = True And stTemp = MsgText(601) Then
                            stTemp = CheckStr(RS930916.Fields("TG07").Value) & CheckStr(RS930916.Fields("TG16").Value)
                            If stTemp = MsgText(601) Then
                                stTemp = CheckStr(RS930916.Fields("TG08").Value) & CheckStr(RS930916.Fields("TG17").Value)
                            End If
                        End If
                        BeforePrintGetDBData = BeforePrintGetDBData & CheckStr(RS930916.Fields("TG05")) & "類：" & stTemp & vbCrLf
                        'end 2020/08/27
                        'endif 2019/05/30
                    End If
                  '2014/7/18 END
                  ElseIf Trim(tmpKey930916(4)) = "英文" Then
                     'Modify by Morgan 2009/7/22
                     'BeforePrintGetDBData = BeforePrintGetDBData & CheckStr(RS930916.Fields("TG05")) & "：" & CheckStr(RS930916.Fields("TG07").Value) & CheckStr(RS930916.Fields("TG16").Value) & vbCrLf
                     'Modified by Lydia 2020/02/17 去掉DB中的換行符號+PUB_StringFilter()
                     'Remove by Lydia 2020/02/27 因為CFT會用換行號,所以還原不用PUB_StringFilter
                     BeforePrintGetDBData = BeforePrintGetDBData & "Class " & CheckStr(RS930916.Fields("TG05")) & "：" & CheckStr(RS930916.Fields("TG07").Value) & CheckStr(RS930916.Fields("TG16").Value) & vbCrLf
                  'Added by Lydia 2019/04/03
                  ElseIf Trim(tmpKey930916(4)) = "||區隔" Then
                     'Modified by Lydia 2020/02/17 去掉DB中的換行符號+PUB_StringFilter()
                     'Remove by Lydia 2020/02/27 因為CFT會用換行號,所以還原不用PUB_StringFilter
                     BeforePrintGetDBData = BeforePrintGetDBData & CheckStr(RS930916.Fields("TG05")) & "：" & CheckStr(RS930916.Fields("TG06").Value) & CheckStr(RS930916.Fields("TG15").Value) & "||"
                  'end 2019/04/03
                  Else '日文
                     'Modified by Lydia 2020/02/17 去掉DB中的換行符號+PUB_StringFilter()
                     'Remove by Lydia 2020/02/27 因為CFT會用換行號,所以還原不用PUB_StringFilter
                     BeforePrintGetDBData = BeforePrintGetDBData & CheckStr(RS930916.Fields("TG05")) & "：" & CheckStr(RS930916.Fields("TG08").Value) & CheckStr(RS930916.Fields("TG17").Value) & vbCrLf
                  End If
                End If
                '2008/11/25 end
               End If
               RS930916.MoveNext
            Loop
        Else
            BeforePrintGetDBData = ""
        End If

Case Else
End Select
End Function

'Add by Morgan 2005/5/17
'列印定稿
'Modify by Morgan 2011/3/1 +bolPrintReverse:反序列印
'Modif by Morgan 2011/6/23 +strReceiveNo內含&的判斷,bolRePrint參數,多筆列印
'Modify By Sindy 2015/10/30 + Optional ByVal bolWordToPDF As Boolean = False 'True=定稿轉PDF
'                             Optional ByRef pFileName As String
'Modify By Sindy 2017/2/17 + , Optional ByVal bPrintLetter As Boolean = True'是否印定稿letter
'Modified by Lydia 2019/10/22 +bRecMax 只列印最後定稿
Public Function PUB_PrintLetter(ByVal strReceiveNo As String, Optional bolPrintReverse As Boolean = False, _
                        Optional bolRePrint As Boolean = False, Optional ByVal bolWordToPDF As Boolean = False, _
                        Optional ByRef pFileName As String, Optional ByVal bPrintLetter As Boolean = True, _
                        Optional ByVal bRecMax As Boolean = False) As Boolean

   Dim stLD03 As String, stLD12 As String, stCon As String, iPos As Integer
   Dim adoRst As ADODB.Recordset, iR As Integer
   'Add By Sindy 2015/10/30
   Dim m_AttachPath As String
   Dim lngPointer As Long
   Dim strFileName As String
   Dim intRow As Integer
   Dim strMergeName As String
   Dim strCmd As String
   Dim process_id As Long
   Dim process_handle As Long
   Dim strMergeFN As String
   '2015/10/30 END
   
On Error GoTo ErrHnd

   'Add By Sindy 2015/10/30 先檢查暫存資料夾是否存在
   If bolWordToPDF = True Then
      If Pub_GetPrinterIndex("PDFCreator") < 0 Then Exit Function
      'Modify By Sindy 2015/11/20
      'm_AttachPath = App.path & Pub_GetSpecMan("EmpFlowAttPath")
      m_AttachPath = App.path & "\" & strUserNum
      '2015/11/20 END
      If Dir(m_AttachPath, vbDirectory) = "" Then
         MkDir m_AttachPath
      Else
         If Dir(m_AttachPath & "\.") <> "" Then
            'Modify By Sindy 2017/1/4 Mark:江如玉在執行繳年費或催實審定稿時會出現無使用權限 ex.FCP-049881
            'Kill m_AttachPath & "\*.*"
         End If
      End If
   End If
   '2015/10/30 END

   iPos = InStr(strReceiveNo, "&")
   If iPos > 0 Then
      stCon = stCon & " and ld05='" & Left(strReceiveNo, iPos - 10) & "'"
      stCon = stCon & " and ld06='" & Mid(strReceiveNo, iPos - 9, 6) & "'"
      stCon = stCon & " and ld07='" & Mid(strReceiveNo, iPos - 3, 1) & "'"
      stCon = stCon & " and ld08='" & Mid(strReceiveNo, iPos - 2, 2) & "'"
      stCon = stCon & " and ld09='" & Mid(strReceiveNo, iPos + 1) & "'"
   Else
      stCon = stCon & " and ld04='" & strReceiveNo & "'"
   End If
   
   'Modified by Lydia 2019/10/22 排除只列印最後定稿
   'If bolRePrint = False Then
   If bolRePrint = False And bRecMax = False Then
      stCon = stCon & " and ld16 is null"
   End If
   
   'Added by Lydia 2019/10/22 只列印最後定稿; ex. FCP-59598做特殊請款單,去掉備註內容和要修改請款函Text2(0)=Y=>LD16=* ; 因為ld16已上*, 無法產生app.path\*.pdf
   If bRecMax = True Then
          strSql = "select max(LD03) ld03 from letterdemand where ld01='" & strUserNum & "' and ld02=" & strSrvDate(1) & stCon
          strSql = "select LD03,LD12 from letterdemand where ld01='" & strUserNum & "' and ld02=" & strSrvDate(1) & stCon & _
                      " and ld03=(" & strSql & ") order by ld03 asc"
   Else
   'end 2019/10/22
          strSql = "select LD03,LD12 from letterdemand where ld01='" & strUserNum & "' and ld02=" & strSrvDate(1) & stCon & " order by ld03 asc"
   End If 'end 2019/10/22
   iR = 1 'Added by Morgan 2019/11/22
   Set adoRst = ClsLawReadRstMsg(iR, strSql)
   intRow = 0
   If iR = 1 Then
      With adoRst
      .MoveFirst
      strMergeFN = "" 'Add By Sindy 2015/11/20
      Do While Not .EOF
         intRow = intRow + 1 'Add By Sindy 2015/10/30
         stLD03 = "" & .Fields("LD03")
         stLD12 = "" & .Fields("LD12")
         
         'Add By Sindy 2017/2/17
         If bPrintLetter = True Then
            PrinterLetterDB strUserNum, "", strSrvDate(1), stLD03, bolPrintReverse
            DoEvents 'Add By Sindy 2015/12/11 等待列印完成
            Err.Clear 'Add by Morgan 2011/7/4 前面可能會有不知名的錯誤
            strSql = "Update letterdemand Set LD16='*' Where ld01='" & strUserNum & "' AND ld02=" & strSrvDate(1) & " and ld03=" & stLD03
            cnnConnection.Execute strSql
         End If
         '2017/2/17 END
         
         'Add By Sindy 2015/10/30 定稿轉PDF
         If bolWordToPDF = True Then
            lngPointer = Screen.MousePointer
            Screen.MousePointer = vbHourglass
            
            strFileName = "$$" & intRow & "." & strUserNum & strSrvDate(1) & stLD03 & ".pdf"
            strMergeFN = strMergeFN & IIf(strMergeFN <> "", " ", "") & """" & m_AttachPath & "\" & strFileName & """" 'Add By Sindy 2015/11/20"
            pFileName = m_AttachPath & "\" & strFileName
            'Added by Morgan 2017/10/6
            If pub_Word2Pdf Then
               PrinterLetterDB strUserNum, "", strSrvDate(1), stLD03, , 1, True, pFileName
               PUB_PrintLetter = True 'Added by Morgan 2017/10/12
            Else
            'end 2017/10/6
               pub_OsPrinter = PUB_GetOsDefaultPrinter
               'Load frmPDF
               frmPDF.Show
               frmPDF.StartProcess m_AttachPath, strFileName
               PUB_SetOsDefaultPrinter Printer.DeviceName
               PUB_SetWordActivePrinter
               If PrinterLetterDB(strUserNum, "", strSrvDate(1), stLD03, , 1) = 0 Then
                  frmPDF.EndtProcess
                  PUB_PrintLetter = True
               End If
               DoEvents 'Add By Sindy 2015/12/11 等待PDF列印完成
               Unload frmPDF
               PUB_SetOsDefaultPrinter pub_OsPrinter
            End If 'Added by Morgan 2017/10/6
            Screen.MousePointer = lngPointer
         End If
         '2015/10/30 END
         
         .MoveNext
      Loop
      
      'Add By Sindy 2015/10/30 欲定稿轉PDF當是多檔時,必須合併成一個檔案
      'pdftk.exe C:\97038\PDFTEST\*.pdf cat output C:\97038\PDFTEST\merge.pdf
      If bolWordToPDF = True And .RecordCount > 1 And PUB_PrintLetter = True Then
         strMergeName = "merge" & ServerTime & ".pdf"
         strCmd = pub_PdftkEXE & " " & strMergeFN & " cat output """ & m_AttachPath & "\" & strMergeName & """"
         process_id = Shell(strCmd, vbHide)
         process_handle = OpenProcess(PROCESS_TERMINATE, 0, process_id)
         If process_handle <> 0 Then
            For intI = 1 To 10
               If PUB_CheckIsRunning(pub_PdftkName) = True Then
                  Sleep 1000
               Else
                  Exit For
               End If
            Next
            If intI > 10 Then
               TerminateProcess process_handle, 0&
               CloseHandle process_handle
               PUB_PrintLetter = False 'MsgBox "合併PDF失敗！"
               GoTo ErrHnd
            Else
               CloseHandle process_handle
            End If
         Else
            PUB_PrintLetter = False 'MsgBox "合併PDF失敗！"
            GoTo ErrHnd
         End If
         pFileName = m_AttachPath & "\" & strMergeName
      End If
      '2015/10/30 END
      
      End With
   End If
   
ErrHnd:
   If Err.Number <> 0 Then
      MsgBox Err.Description, vbCritical
   End If
   Set adoRst = Nothing
   Screen.MousePointer = lngPointer 'Add By Sindy 2015/10/30
End Function

'Modify by Morgan 2007/6/25 加p_iType
'Modify by Morgan 2009/2/2 稱謂改抓OA06
Private Function GetOurAgentData(ByVal p_CP09 As String, Optional p_bSkip As Boolean = True, Optional p_iType As Integer = 0) As String
   Dim bTwoUp As Boolean
   
   CheckOC
   '2010/5/7 MODIFY BY SONIA 原OA04為出名代理人之ID,改抓員工檔ST26
   'strSql = "SELECT ST02,OA04,OA05,NVL(OA06,'專利代理人') OA06 FROM CASEPROGRESS,STAFF,OURAGENT WHERE INSTR(CP110,ST01)>0 AND OA01=CP01 AND OA02=ST01 AND CP09='" & p_CP09 & "' order by OA03"
   strSql = "SELECT ST02,ST26,OA05,NVL(OA06,'專利代理人') OA06 FROM CASEPROGRESS,STAFF,OURAGENT WHERE INSTR(CP110,ST01)>0 AND OA01=CP01 AND OA02=ST01 AND CP09='" & p_CP09 & "' order by OA03"
   With adoRecordset
      .CursorLocation = adUseClient
      .Open strSql, cnnConnection, adOpenForwardOnly, adLockReadOnly
      If .RecordCount > 0 Then
         If .RecordCount > 1 Then bTwoUp = True
         Do While Not .EOF
            Select Case p_iType
               Case 0
                  '第二個以後要空一格全形
                  If GetOurAgentData <> "" Then GetOurAgentData = GetOurAgentData & Chr(13) & Chr(10) & IIf(p_bSkip, "　", "")
                  '兩個以上要加序號
                  If bTwoUp Then
                     'GetOurAgentData = GetOurAgentData & .AbsolutePosition & ".姓名：" & .Fields("ST02") & " 專利代理人、ID：" & .Fields("OA04") & Chr(13) & Chr(10) & String(29, " ") & "證書字號：" & .Fields("OA05")
                     '2010/5/7 MODIFY BY SONIA 原OA04為出名代理人之ID,改抓員工檔ST26
                     'GetOurAgentData = GetOurAgentData & .AbsolutePosition & ".姓名：" & .Fields("ST02") & " " & .Fields("OA06") & "、ID：" & .Fields("OA04") & Chr(13) & Chr(10) & String(29, " ") & "證書字號：" & .Fields("OA05")
                     'Modify By Sindy 2019/9/18 雅娟/韻丞指示申請書出名代理人去掉ID
                     'GetOurAgentData = GetOurAgentData & .AbsolutePosition & ".姓名：" & .Fields("ST02") & " " & .Fields("OA06") & "、ID：" & .Fields("ST26") & Chr(13) & Chr(10) & String(29, " ") & "證書字號：" & .Fields("OA05")
                     GetOurAgentData = GetOurAgentData & .AbsolutePosition & ".姓名：" & .Fields("ST02") & " " & .Fields("OA06") & "、證書字號：" & .Fields("OA05")
                  Else
                     '2010/5/7 MODIFY BY SONIA 原OA04為出名代理人之ID,改抓員工檔ST26
                     'GetOurAgentData = GetOurAgentData & "姓名：" & .Fields("ST02") & " " & .Fields("OA06") & "、ID：" & .Fields("OA04") & Chr(13) & Chr(10) & String(27, " ") & "證書字號：" & .Fields("OA05")
                     'Modify By Sindy 2019/9/18 雅娟/韻丞指示申請書出名代理人去掉ID
                     'GetOurAgentData = GetOurAgentData & "姓名：" & .Fields("ST02") & " " & .Fields("OA06") & "、ID：" & .Fields("ST26") & Chr(13) & Chr(10) & String(27, " ") & "證書字號：" & .Fields("OA05")
                     GetOurAgentData = GetOurAgentData & "姓名：" & .Fields("ST02") & " " & .Fields("OA06") & "、證書字號：" & .Fields("OA05")
                  End If
               Case 1
                  If GetOurAgentData <> "" Then
                     If .RecordCount = .AbsolutePosition Then
                        GetOurAgentData = GetOurAgentData & "及"
                     Else
                        GetOurAgentData = GetOurAgentData & "、"
                     End If
                  End If
                  'GetOurAgentData = GetOurAgentData & "「" & .Fields("ST02") & "專利代理人」"
                  GetOurAgentData = GetOurAgentData & "「" & .Fields("ST02") & .Fields("OA06") & "」"
               Case 2
                  If GetOurAgentData <> "" Then
                     GetOurAgentData = GetOurAgentData & "、"
                  End If
                  'GetOurAgentData = GetOurAgentData & .Fields("ST02") & "　專利代理人"
                  GetOurAgentData = GetOurAgentData & .Fields("ST02") & "　" & .Fields("OA06")
               Case 3
                  If GetOurAgentData <> "" Then
                     GetOurAgentData = GetOurAgentData & "、"
                  End If
                  GetOurAgentData = GetOurAgentData & .Fields("ST02") & .Fields("OA06") & "(" & .Fields("OA05") & ")"
            End Select
            .MoveNext
         Loop
      End If
   End With

End Function

'Modify by Amy 2018/07/30 +showColorFirst=>是否先抓彩色代表圖
'Modified by Morgan 2021/7/1 showColorFirst 預設改 Ture(彩圖優先)--經理
Public Sub PUB_AddInPicToWord(ByRef oWord As Word.Application, oCrLfCount As Integer, Optional ByVal showColorFirst As Boolean = True)
    Dim bytes() As Byte
    Dim file_num As Integer
    Dim rsPic As New ADODB.Recordset
    Dim IsWmf As Boolean
    'add by nickc 2007/11/28
    Dim stSQL As String
    Dim intR As Integer
    Dim oShape 'Added by Morgan 2012/8/16
    Dim GetAttachFile As Boolean
    Dim stFileName As String 'Add by Amy 2018/07/30
    
'    Dim GpInput As mGDIpEx.GdiplusStartupInput
   With oWord
'        GpInput.GdiplusVersion = 1
'        If (mGDIpEx.GdiplusStartup(m_GDIpToken, GpInput) = [OK]) Then
''            Set rsPic = New ADODB.Recordset
''            rsPic.CursorLocation = adUseClient
''            rsPic.Open "select * from ImgByteFile where ibf01='" & m_MySt(1) & "' and ibf02='" & m_MySt(2) & "' and ibf03='" & m_MySt(3) & "' and ibf04='" & m_MySt(4) & "' and ibf05='1' ", cnnConnection, adOpenStatic, adLockOptimistic
            'Modify by Amy 2018/07/30 Mark原程式改GetImgByteFile_Case做
'            stSQL = "select * from ImgByteFile where ibf01='" & m_MySt(1) & "' and ibf02='" & m_MySt(2) & "' and ibf03='" & m_MySt(3) & "' and ibf04='" & m_MySt(4) & "' and ibf05='1' "
'            intR = 1
'            Set rsPic = ClsLawReadRstMsg(intR, stSQL)
'
''            'Add by Morgan 2007/11/6 若無代表圖時抓建置中的圖
''            If intR = 0 Then
''               stSQL = "select ibf06,ibf13,ibf14,1 Sort from ImgByteFile where ibf01='000' and ibf02='000000' and ibf03='0' and ibf04='00' and ibf05='1'"
''               intR = 1
''               Set rsPic = ClsLawReadRstMsg(intR, stSQL)
''            End If
''            'end 2007/11/6
'
'            If intR = 1 Then
'               If CheckStr(rsPic.Fields("ibf06")) = "1" Or CheckStr(rsPic.Fields("ibf06")) = "2" Then IsWmf = False Else IsWmf = True
'
'               'Add By Sindy 2017/8/10
''               If "" & rsPic.Fields("IBF15") <> "" Then
'                  GetAttachFile = PUB_GetFtpFile(rsPic.Fields("IBF15"), App.path & "\$$" & m_MySt(1) & m_MySt(2) & m_MySt(3) & m_MySt(4) & "." & IIf(IsWmf, "wmf", "jpg"), UCase("ImgByteFile"))
''               Else
''               '2017/8/10 END
''                  ReDim bytes(Val(rsPic.Fields("ibf13").Value))
''                  bytes() = rsPic.Fields("ibf14").GetChunk(Val(rsPic.Fields("ibf13").Value))
''                  file_num = FreeFile
''                  'edit by nickc 2007/11/27 指定檔名
''                  'Open App.Path & "\tmp." & IIf(IsWmf, "wmf", "jpg") For Binary Access Write As #file_num
''                  'Modify By Sindy 2014/1/14 +$$
''                  Open App.path & "\$$" & m_MySt(1) & m_MySt(2) & m_MySt(3) & m_MySt(4) & "." & IIf(IsWmf, "wmf", "jpg") For Binary Access Write As #file_num
''                  Put #file_num, , bytes()
''                  Close #file_num
''               End If
            '代表圖
            stFileName = App.path & "\$$" & m_MySt(1) & m_MySt(2) & m_MySt(3) & m_MySt(4)
            If GetImgByteFile_Case(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), stFileName, IIf(showColorFirst = True, 0, 9)) = True Then
            'end 2018/07/30
                '開啟查詢
                .Selection.HomeKey Unit:=wdStory
                .Selection.Find.ClearFormatting
                .Selection.Find.Text = "|#代表圖#|"
                .Selection.Find.Replacement.Text = ""
                .Selection.Find.Forward = True
                .Selection.Find.Wrap = wdFindContinue
                .Selection.Find.Format = False
                .Selection.Find.MatchCase = False
                .Selection.Find.MatchWholeWord = False
                .Selection.Find.MatchWildcards = False
                .Selection.Find.MatchSoundsLike = False
                .Selection.Find.MatchAllWordForms = False
                .Selection.Find.MatchByte = True
                .Selection.Find.Execute
                
                '插入圖片檔案
                .ChangeFileOpenDirectory App.path & "\"
                'edit by nickc 2007/11/27 指定檔名
                '.ActiveDocument.Shapes.AddPicture Anchor:=.Selection.Range, FileName:= _
                    App.Path & "\tmp." & IIf(IsWmf, "wmf", "jpg"), LinkToFile:= _
                    False, SaveWithDocument:=True
               'Modified by Morgan 2012/8/16 改用 oShape 操作(原用變數名稱當改信頭文件重複使用時會有錯)
                'Modify by Amy 2018/07/30 改用stFileName
                'Set oShape = .ActiveDocument.Shapes.AddPicture(Anchor:=.Selection.Range, FileName:=App.path & "\$$" & m_MySt(1) & m_MySt(2) & m_MySt(3) & m_MySt(4) & "." & IIf(IsWmf, "wmf", "jpg"), LinkToFile:=False, SaveWithDocument:=True)
                Set oShape = .ActiveDocument.Shapes.AddPicture(Anchor:=.Selection.Range, FileName:=stFileName, LinkToFile:=False, SaveWithDocument:=True)
                '.ActiveDocument.Shapes("Picture " & Trim(.ActiveDocument.Shapes.Count + 1)).Select
        
                oShape.ZOrder msoBringInFrontOfText
                oShape.Fill.Visible = msoTrue
                oShape.Fill.Solid
                'edit by nickc 2007/12/07 修正底色
                'oShape.Fill.ForeColor.RGB = RGB(51, 102, 255)
                oShape.Fill.ForeColor.RGB = RGB(255, 255, 255)
                oShape.Fill.Transparency = 0.5
                oShape.Line.Weight = 0.75
                oShape.Line.DashStyle = msoLineSolid
                oShape.Line.Style = msoLineSingle
                oShape.Line.Transparency = 0#
               'Modify by Morgan 2009/4/24 加框線
               'oShape.Line.Visible = msoFalse
               oShape.Line.Visible = msoTrue
               oShape.Line.ForeColor.RGB = RGB(0, 0, 0)
               oShape.Line.BackColor.RGB = RGB(255, 255, 255)
               'end 2009/4/24
                oShape.LockAspectRatio = msoTrue
                '定義大小
                'oShape.Height = 199.35 '216.15 '171.2
                oShape.Width = 210 '179.8 '242.95
                If oShape.Height > 199.35 Then '216.15 Then
                    oShape.Height = 199.35 '216.15
                End If
                oShape.PictureFormat.Brightness = 0.5
                oShape.PictureFormat.Contrast = 0.5
                oShape.PictureFormat.ColorType = msoPictureAutomatic
                oShape.PictureFormat.CropLeft = 0#
                oShape.PictureFormat.CropRight = 0#
                oShape.PictureFormat.CropTop = 0#
                oShape.PictureFormat.CropBottom = 0#
                'Modify by Morgan 2009/4/24 設位置相對於邊界,不透明
                'oShape.RelativeHorizontalPosition = _
                '    wdRelativeHorizontalPositionColumn
                'oShape.RelativeVerticalPosition = _
                '    wdRelativeVerticalPositionParagraph
                oShape.RelativeHorizontalPosition = wdRelativeHorizontalPositionPage
                oShape.RelativeVerticalPosition = wdRelativeVerticalPositionPage
                oShape.Fill.Transparency = 0#
                'end 2009/4/24
         
                oShape.LockAnchor = False
                '圖蓋文
                oShape.WrapFormat.Type = wdWrapNone
                oShape.WrapFormat.Side = wdWrapBoth
                oShape.WrapFormat.DistanceTop = .CentimetersToPoints(0)
                oShape.WrapFormat.DistanceBottom = .CentimetersToPoints(0)
                oShape.WrapFormat.DistanceLeft = .CentimetersToPoints(0.32)
                oShape.WrapFormat.DistanceRight = .CentimetersToPoints(0.32)
                
                '移到指定位置
                'Modify by Morgan 2009/4/24 改固定位置
                'oShape.Left = ((15 - (oShape.Width / 14)) / 2) * 14 '((15 - (oShape.Width / 11.987)) / 2) * 11.987
                'oShape.Top = ((12 - (oShape.Height / 16.6125)) / 2) * 16.6125  ' (oCrLfCount + ((12 - (oShape.Height / 18)) / 2)) * 18#
                'Modify By Sindy 2009/04/28 增加判斷行高
                If .Selection.ParagraphFormat.LineSpacing = 15 Then
                  oShape.Left = .CentimetersToPoints(1.7)
                  oShape.Top = .CentimetersToPoints(4.3 + 0.495 * oCrLfCount)
                '2009/04/28 End
                Else
                  oShape.Left = .CentimetersToPoints(1.7)
                  oShape.Top = .CentimetersToPoints(4.3 + 0.622 * oCrLfCount)
                End If
            End If
            
            '插完圖片將關鍵字取代掉
            .Selection.HomeKey Unit:=wdStory
            .Selection.Find.ClearFormatting
            .Selection.Find.Text = "|#代表圖#|"
            .Selection.Find.Replacement.Text = ""
            .Selection.Find.Forward = True
            .Selection.Find.Wrap = wdFindContinue
            .Selection.Find.Format = False
            .Selection.Find.MatchCase = False
            .Selection.Find.MatchWholeWord = False
            .Selection.Find.MatchWildcards = False
            .Selection.Find.MatchSoundsLike = False
            .Selection.Find.MatchAllWordForms = False
            .Selection.Find.MatchByte = True
            .Selection.Find.Execute
            If .Selection.Find.Forward = True Then
                .Selection.Collapse Direction:=wdCollapseStart
            Else
                .Selection.Collapse Direction:=wdCollapseEnd
            End If
            .Selection.Find.Execute Replace:=wdReplaceOne
            If .Selection.Find.Forward = True Then
                .Selection.Collapse Direction:=wdCollapseEnd
            Else
                .Selection.Collapse Direction:=wdCollapseStart
            End If
            .Selection.Find.Execute
            .Selection.EndKey Unit:=wdStory
'            Call mGDIpEx.GdiplusShutdown(m_GDIpToken)
            'edit by nickc 2007/11/27 指定檔名
            'If Dir(App.Path & "\tmp." & IIf(IsWmf, "wmf", "jpg")) <> "" Then
               'Kill App.Path & "\tmp." & IIf(IsWmf, "wmf", "jpg")
            'Modify By Sindy 2014/1/14 Mark起來在此處不刪除檔案,檔名加$$,APP統一K動時再一併刪除
'            If Dir(App.path & "\" & m_MySt(1) & m_MySt(2) & m_MySt(3) & m_MySt(4) & "." & IIf(IsWmf, "wmf", "jpg")) <> "" Then
'               Kill App.path & "\" & m_MySt(1) & m_MySt(2) & m_MySt(3) & m_MySt(4) & "." & IIf(IsWmf, "wmf", "jpg")
'            End If
'        End If
   End With
End Sub
'Add by Morgan 2006/7/26 轉全形數字
Public Function toDblFont(p_InWord As String) As String
   'Modify by Amy 2022/03/31 改同一個fucnion
'   Dim iPos As Integer, stRtn As String
'   For iPos = 1 To Len(p_InWord)
'      stRtn = stRtn & StrConv(Mid(p_InWord, iPos, 1), vbWide)
'   Next
'   toDblFont = stRtn
     toDblFont = PUB_ChangeZIPToSir(p_InWord)
End Function
'Add by Morgan 2006/10/19
'設定Word預設印表機
Public Sub PUB_SetWordActivePrinter()
   Dim oWordApp As Word.Application
On Error GoTo SetNothing
   'Modify by Morgan 2011/7/13
   'If Not g_WordAp Is Nothing Then
   If TypeName(g_WordAp) = "Application" Then
      Set oWordApp = New Word.Application
      If g_WordAp.ActivePrinter <> oWordApp.ActivePrinter Then
         g_WordAp.ActivePrinter = oWordApp.ActivePrinter
      End If
      oWordApp.Quit Word.wdDoNotSaveChanges
   End If
   Set oWordApp = Nothing
   
SetNothing:
   If Err.Number <> 0 Then
      Set g_WordAp = Nothing
   End If
End Sub
'Add by Morgan 2006/10/19
'解析組合定稿 |#.....#|-->前置作業(產生列印內容前)
Private Function PreParse(ByVal p_Data As String) As String
   Const sLSign As String = "|#" '左識別符號
   Const sRSign As String = "#|" '右識別符號
   Dim iLPos As Integer '識別符號起始位置
   Dim iRPos As Integer '識別符號終止位置
   Dim sLetterName As String '子定稿名稱(FTM06)
   Dim sTemp As String '子定稿名稱內容
   Dim sGoodData As String '已解析字串
   Dim sRestData As String '未解析字串
   
   sRestData = p_Data
   Do While Len(sRestData) > 0
      iLPos = InStr(sRestData, sLSign)
      iRPos = InStr(iLPos + 2, sRestData, sRSign)
      If iLPos > 0 And iRPos > iLPos + 2 Then
         sLetterName = Mid(sRestData, iLPos + 2, iRPos - iLPos - 2)
         sTemp = GetText(sLetterName, m_MySt(1))
         If sTemp <> "" Then
            sGoodData = sGoodData & Left(sRestData, iLPos - 1) & sTemp
         Else
            sGoodData = sGoodData & Left(sRestData, iRPos + 1)
         End If
         sRestData = Mid(sRestData, iRPos + 2)
      Else
         sGoodData = sGoodData & sRestData
         Exit Do
      End If
   Loop
   PreParse = sGoodData
   
End Function
'Add by Morgan 2007/4/20
'Memo by Morgan 2011/6/27 目前定稿內有"<跳頁>"的不一定會跳頁(要看是否有其他控制決定),所以只能計算出最大頁數而非實際頁數
'定稿是否有跳頁
Public Function PUB_IsMultiPage(p_ET01 As String, p_ET02 As String, p_ET03 As String) As Boolean
   Dim iPos As Integer
   Dim sCaseNo(1 To 4) As String
   Dim sCP10 As String
   
   iPos = InStr(p_ET02, "&")
   
   '本所號
   If iPos > 0 Then
      sCP10 = Mid(p_ET02, iPos)
      ChgCaseNo Left(p_ET02, iPos - 1), sCaseNo
   Else
      '收文號
      strExc(0) = "select cp10,cp01,cp02,cp03,cp04 from caseprogress where cp09='" & p_ET02 & "'"
      intI = 1
      Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
      If intI = 1 Then
         sCP10 = RsTemp(0)
         sCaseNo(1) = RsTemp(1)
         sCaseNo(2) = RsTemp(2)
         sCaseNo(3) = RsTemp(3)
         sCaseNo(4) = RsTemp(4)
      End If
   End If
   'Modify by Morgan 2010/11/12 定稿內容+FTM08
   strExc(0) = "select instr(ftm05,'<跳頁>'),ftm05,ftm08 from finaltextmap where ftm01='" & sCaseNo(1) & "' and ftm02='" & p_ET01 & "' and ftm04='" & p_ET03 & "' and ftm03 in ('000','" & sCP10 & "') order by ftm03 desc"
   intI = 1
   Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
   If intI = 1 Then
      'Modify by Morgan 2010/11/20
      'If RsTemp(0) > 0 Then
      If InStr("" & RsTemp(1) & RsTemp(2), "<跳頁>") > 0 Then
      'end 2010/11/20
         PUB_IsMultiPage = True
      End If
   End If
   
End Function

'Add by Morgan 2007/7/3
'下一筆重新委任發文字號
Public Function PUB_GetNextNum(p_Date As String) As String
   PUB_GetNextNum = "000001"
   strExc(0) = "select max(cp28) from caseprogress where cp01='P' and cp10='928' and cp27=" & p_Date
   intI = 1
   Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
   If intI = 1 Then
      PUB_GetNextNum = Format(Val("" & RsTemp.Fields(0)) + 1, "000000")
   End If
End Function

'add by nickc 2007/08/06 修改 word  裡面的格式
'格式  |#().....#|                  () 內為處理方式  ...要處理的文字
'Modify by Amy 2018/07/27 +showColorFirst=>是否先抓彩色代表圖
'Modified by Morgan 2021/7/1 showColorFirst 預設改 Ture(彩圖優先)--經理
Public Sub ChgWordFormat(ByRef oWord As Word.Application, strData As String, Optional ByVal showColorFirst As Boolean = True)
Dim SeekWord As String
Dim oAction As String
Dim oOldWord As String
Dim oNewWord As String
Dim iPos1 As Long, iPos2 As Long, iPos3 As Long 'Modified by Morgan 2023/11/21 改型態為long(長度會超過integer)

On Error GoTo ErrHnd

SeekWord = strData
'Add by Morgan 2007/9/17

Do While InStr(SeekWord, "|#(") <> 0
    iPos1 = 0
    iPos2 = 0
    iPos3 = 0
    iPos1 = InStr(SeekWord, "|#(")
RedoStr:
    If iPos1 > 0 Then
        iPos2 = InStr(iPos1, SeekWord, ")")
        iPos3 = InStr(iPos1, SeekWord, "#|")
        If iPos2 > iPos1 Then
            oAction = Mid(SeekWord, iPos1 + 3, iPos2 - iPos1 - 3)
            oOldWord = Mid(SeekWord, iPos1, iPos3 - iPos1 + 2)
            oNewWord = Mid(SeekWord, iPos2 + 1, iPos3 - iPos2 - 1)
            '若拆出來的字串內還有需要轉換的符號，則先做裡面
            If InStr(1, oNewWord, "|#(") <> 0 Then
                iPos1 = iPos1 + 4 + Len(oAction) + InStr(1, oNewWord, "|#(") - 1
                GoTo RedoStr
            Else
                '執行VBA
                'Modify by Amy 2018/07/27 +showColorFirst
                SeekWord = DoWordVBA(oWord, oAction, oOldWord, oNewWord, SeekWord, showColorFirst)
            End If
      End If
   End If
Loop
'oWord.Selection.ParagraphFormat.Alignment = wdAlignParagraphLeft

Exit Sub
ErrHnd:
   MsgBox Err.Description
   
End Sub

'Added by Morgan 2014/5/19
'格式  |#().....#|                  () 內為處理方式  ...要處理的文字
Public Function ChgHTMLFormat(ByRef strData As String) As String
Dim SeekWord As String
Dim oAction As String
Dim oOldWord As String
Dim oNewWord As String
Dim iPos1 As Integer, iPos2 As Integer, iPos3 As Integer

On Error GoTo ErrHnd

SeekWord = strData
'Add by Morgan 2007/9/17

Do While InStr(SeekWord, "|#(") <> 0
    iPos1 = 0
    iPos2 = 0
    iPos3 = 0
    iPos1 = InStr(SeekWord, "|#(")
RedoStr:
    If iPos1 > 0 Then
        iPos2 = InStr(iPos1, SeekWord, ")")
        iPos3 = InStr(iPos1, SeekWord, "#|")
        If iPos2 > iPos1 Then
            oAction = Mid(SeekWord, iPos1 + 3, iPos2 - iPos1 - 3)
            oOldWord = Mid(SeekWord, iPos1, iPos3 - iPos1 + 2)
            oNewWord = Mid(SeekWord, iPos2 + 1, iPos3 - iPos2 - 1)
            '若拆出來的字串內還有需要轉換的符號，則先做裡面
            If InStr(1, oNewWord, "|#(") <> 0 Then
                iPos1 = iPos1 + 4 + Len(oAction) + InStr(1, oNewWord, "|#(") - 1
                GoTo RedoStr
            Else
                '執行VBA
                SeekWord = getHTML(oAction, oOldWord, oNewWord, SeekWord)
            End If
      End If
   End If
Loop
ChgHTMLFormat = SeekWord

Exit Function
ErrHnd:
   MsgBox Err.Description
   
End Function

Private Function getHTML(oAction As String, oOldWord As String, oNewWord As String, SeekWord As String) As String
   Dim arrAct, intJ As Integer, tagP As String, tagSPAN As String, tagB As String, tagI As String, tagU As String, tagSUP As String, tagFONT As String, tagLead As String, tagClose As String
   arrAct = Split(oAction, ",")
   
   tagP = ""
   tagSPAN = ""
   tagFONT = ""
   tagB = ""
   tagI = ""
   tagU = ""
   tagSUP = ""
   
On Error GoTo HTMLErr
   
        For intJ = LBound(arrAct) To UBound(arrAct)
         
         Select Case arrAct(intJ)
            Case "標題1"
               tagSPAN = tagSPAN & "font-size:20.0pt;"
               If tagB = "" Then tagB = "<B>"
               tagP = tagP & " align=center "
                
            Case "標題2"
                tagSPAN = tagSPAN & "font-size:18.0pt;"
                If tagB = "" Then tagB = "<B>"
                tagP = tagP & " align=center "
             
            Case "標題3"
                tagSPAN = tagSPAN & "font-size:16.0pt;"
                If tagB = "" Then tagB = "<B>"
                tagP = tagP & " align=center "
                
            Case "大字"
                tagSPAN = tagSPAN & "font-size:14.0pt;"
                
            Case "中字"
                tagSPAN = tagSPAN & "font-size:12.0pt;"
                
            Case "11字"
                tagSPAN = tagSPAN & "font-size:11.0pt;"
                
            Case "小字"
                tagSPAN = tagSPAN & "font-size:10.0pt;"
                
            Case "靠右"
                tagP = tagP & " align=right "
                
            Case "置中"
                tagP = tagP & " align=center "
                
            Case "分散"
                
            Case "粗體"
                If tagB = "" Then tagB = "<B>"
                
            Case "斜體"
                If tagI = "" Then tagI = "<I>"
                
            Case "底線"
               If tagU = "" Then tagU = "<U>"
               
            Case "框線"
            
            Case "上標"
               If tagSUP = "" Then tagSUP = "<SUP>"
               
            Case "網底"
            
            Case "細明體"
               tagFONT = tagFONT & " face=""細明體"""
               
            Case "勾選"
            
            Case Else
         End Select
      Next
      
      If tagP <> "" Then tagP = "<P " & tagP & ">"
      If tagSPAN <> "" Then tagSPAN = "<SPAN style='" & tagSPAN & "'>"
      If tagFONT <> "" Then tagFONT = "<FONT " & tagFONT & ">"
      
      tagLead = tagP & tagSPAN & tagFONT & tagB & tagI & tagU & tagSUP
      If tagSUP <> "" Then tagClose = tagClose & "</SUP>"
      If tagU <> "" Then tagClose = tagClose & "</U>"
      If tagI <> "" Then tagClose = tagClose & "</I>"
      If tagB <> "" Then tagClose = tagClose & "</B>"
      If tagFONT <> "" Then tagClose = tagClose & "</FONT>"
      If tagSPAN <> "" Then tagClose = tagClose & "</SPAN>"
      If tagP <> "" Then tagClose = tagClose & "</P>"
      

'將字取代掉
getHTML = Replace(SeekWord, oOldWord, tagLead & oNewWord & tagClose, 1, 1)

Exit Function
HTMLErr:
    'MsgBox "Word 執行錯誤！", vbExclamation, "嚴重警告！"
    MsgBox Err.Description
    
    getHTML = Replace(Replace(SeekWord, "|#", ""), "#|", "")
End Function

'add by nickc 2007/08/06 執行 Word VBA
'oAction 處理方式
'oOldWord  含 |#()   #|  的原始文字
'oNewWord 最後的文字       不含 |#()   #|
'showColorFirst 是否先抓彩色代表圖 'Add by Amy 2018/07/27
'Rem by Morgan 2008/8/20 若因同時有裝Excel而導致錯誤時，需用Regtlib.exe將MSWord8.olb重新註冊。
'Modified by Morgan 2021/7/1 showColorFirst 預設改 Ture(彩圖優先)--經理
Private Function DoWordVBA(ByRef oWord As Word.Application, oAction As String, oOldWord As String, oNewWord As String, SeekWord As String, Optional showColorFirst As Boolean = True) As String
   'Add by Morgan 2007/10/29 改可一次多種設定,用","號區隔
   Dim arrAct() As String
   Dim intJ As Integer
   Dim strSignFile As String 'Add By Sindy 2014/10/8 簽名檔路徑及檔名
   Dim BolHaveImg As Boolean 'Add By Sindy 2014/10/9
   Dim oShape 'Added by Morgan 2014/11/12
   Dim strIBF02 As String 'Added by Morgan 2015/8/18
   'Added by Lydia 2016/02/17
   Dim bolAutoPic As Boolean '自動代表圖
   Dim pageX As Double '頁面X軸位置
   Dim pageY As Double '頁面Y軸位置
   'end 2016/02/17
   Dim iPicPos As Double 'Added by Lydia 2017/05/03 圖片的位置
   Dim bVisibled As Boolean 'Added by Lydia 2017/05/18 記錄Word是否顯示
   Dim oTable As Word.Table 'Added by Morgan 2019/10/15
   Dim tmpHigh As Double, tmpWidth As Double, pExRate As Double 'Added by Lydia 2020/05/25
   'Added by Morgan 2020/11/17
   Dim stComp As String '公司別
   Dim bolStamp As Boolean '是否為戳印(不占行數)
   Dim bolMoveUp As Boolean '是否移到上方相對位置(公司章) Added by Morgan 2021/8/13
   Dim bolAlignR As Boolean '是否段落有靠右(公司章) Added by Morgan 2021/8/13
   Dim intK As Integer 'Added by Morgan 2020/12/17
   Dim lngLoc As Long 'Added by Morgan 2022/2/17
   Dim strTmpArr As String, StrSQLa As String 'Added by Lydia 2022/03/29
   Dim strSignFile2 As String, strIBF03 As String, strIBF04 As String, strSignName As String 'Added by Morgan 2024/3/29
   Dim bolTextDone As Boolean 'Added by Morgan 2025/8/26
   
   arrAct = Split(oAction, ",")
   'end 2007/10/29
   
On Error GoTo 0
On Error GoTo WrdErr
   
   'With oWord 'Removed by Morgan 2017/4/27 Win7 64bit 下會當(以下程式原 .Selection 都改為 oWord.Selection )
         '移到文件最上方
         'Modify by Morgan 2007/12/14 為加速只往前移3頁
         '.Selection.HomeKey Unit:=wdStory
         oWord.Selection.GoTo what:=wdGoToPage, which:=wdGoToPrevious, Count:=3
         'end 2007/12/14
         '執行尋找
         oWord.Selection.Find.ClearFormatting
         oWord.Selection.Find.Text = oOldWord
         oWord.Selection.Find.Replacement.Text = ""
         oWord.Selection.Find.Forward = True
         oWord.Selection.Find.Wrap = wdFindContinue
         oWord.Selection.Find.Format = False
         oWord.Selection.Find.MatchCase = False
         oWord.Selection.Find.MatchWholeWord = False
         oWord.Selection.Find.MatchWildcards = False
         oWord.Selection.Find.MatchSoundsLike = False
         oWord.Selection.Find.MatchAllWordForms = False
         oWord.Selection.Find.MatchByte = True
      'Modified by Morgan 2014/11/27 有找到才做(Ex.字串內含跳行符時搜尋字串會略過跳行以後的內容而找不到)
         '.Selection.Find.Execute
      If oWord.Selection.Find.Execute() = True Then
         'end 2014/11/27
         
        'Modify by Morgan 2007/10/29 改可一次多種設定,用","號區隔
        'Select Case oAction
        For intJ = LBound(arrAct) To UBound(arrAct)
         'Modified by Lydia 2022/03/29 因為署名檔有Unicode,所以需要轉Big5 ; 閻啟泰
         'Select Case arrAct(intJ)
         strTmpArr = PUB_UniToBIG5(arrAct(intJ))
         Select Case strTmpArr
         'end 2022/03/29
            Case "標題1"
                oWord.Selection.Font.Size = 20
                oWord.Selection.Font.Bold = wdToggle
                oWord.Selection.ParagraphFormat.Alignment = wdAlignParagraphCenter
                
            Case "標題2"
                oWord.Selection.Font.Size = 18
                oWord.Selection.Font.Bold = wdToggle
                oWord.Selection.ParagraphFormat.Alignment = wdAlignParagraphCenter
             
            Case "標題3"
                oWord.Selection.Font.Size = 16
                oWord.Selection.Font.Bold = wdToggle
                oWord.Selection.ParagraphFormat.Alignment = wdAlignParagraphCenter
                
            'Add By Sindy 2015/12/11 FCP委任狀中譯文
            Case "標題4"
                oWord.Selection.Font.Size = 26
                oWord.Selection.Font.Bold = wdToggle
                oWord.Selection.ParagraphFormat.Alignment = wdAlignParagraphCenter
                
            'Added by Morgan 2018/1/12 FCP電子送件申請書
            Case "標題5"
                oWord.Selection.Font.Size = 22
                oWord.Selection.ParagraphFormat.Alignment = wdAlignParagraphCenter
            
            Case "紅字" 'Added by Morgan 2018/1/23
               oWord.Selection.Font.ColorIndex = wdRed
               
            Case "大字"
                '執行改字大小
                oWord.Selection.Font.Size = 14
                '.Selection.HomeKey Unit:=wdStory '
            Case "中字"
                '執行改字大小
                oWord.Selection.Font.Size = 12
                '.Selection.HomeKey Unit:=wdStory
            Case "11字"
                '執行改字大小
                oWord.Selection.Font.Size = 11
            'Add By Sindy 2015/10/28
            Case "18字"
                '執行改字大小
                oWord.Selection.Font.Size = 18
            '2015/10/28 END
            'Added by Lydia 2016/06/06
            Case "16字"
                '執行改字大小
                oWord.Selection.Font.Size = 16
            'end 2016/06/06
            Case "小字"
                '執行改字大小
                oWord.Selection.Font.Size = 10
                '.Selection.HomeKey Unit:=wdStory
            Case "靠右"
                oWord.Selection.ParagraphFormat.Alignment = wdAlignParagraphRight
            Case "置中"
                oWord.Selection.ParagraphFormat.Alignment = wdAlignParagraphCenter
                
            Case "分散"
                oWord.Selection.ParagraphFormat.Alignment = wdAlignParagraphDistribute
                
            Case "粗體"
                oWord.Selection.Font.Bold = wdToggle
            Case "斜體"
                oWord.Selection.Font.Italic = wdToggle
            Case "底線"
                oWord.Selection.Font.Underline = wdUnderlineSingle
            Case "框線"
               oWord.Selection.Font.Borders(1).LineStyle = wdLineStyleSingle
            'Add by Morgan 2011/5/23
            Case "上標"
               oWord.Selection.Font.Superscript = wdToggle
            'Added by Morgan 2012/4/27
            Case "網底"
               oWord.Selection.Font.Shading.Texture = wdTexture15Percent
               oWord.Selection.Font.Shading.ForegroundPatternColorIndex = wdBlack
               oWord.Selection.Font.Shading.BackgroundPatternColorIndex = wdWhite
            'Added by Morgan 2012/9/19(僅非日文的單筆維護有效,整批列印只能有一種中文字型)
            Case "細明體"
                oWord.Selection.Font.Name = "細明體"
                
            'Added by Morgan 2013/4/19
            Case "勾選"
               oWord.Selection.InsertSymbol Font:="Wingdings", CharacterNumber:=-3842, Unicode:=True
            'Added by Morgan 2014/10/2
            Case "線高"
               oWord.Selection.ParagraphFormat.LineSpacingRule = wdLineSpaceExactly
               oWord.Selection.ParagraphFormat.LineSpacing = 9
            'Added by Lydia 2020/09/25
            Case "分節"
                oWord.Selection.TypeParagraph
                oWord.Selection.InsertBreak Type:=wdSectionBreakNextPage
            'Add By Sindy 2014/10/2
            'Modified by Morgan 2014/11/12 +"王錦寬自動簽名檔", "雙署名自動簽名檔"
            'Modify By Sindy 2015/6/4 +"閰英自動簽名檔", "閰中自動簽名檔"
            'Modify By Sindy 2015/7/24 +"秘/Confidential自動簽名檔", "InvoiceEnclosed自動簽名檔"
            'Modified by Morgan 2015/8/18 +"林景郁英文字動簽名檔","林景郁中文字動簽名檔"
            'Modified by Lydia 2016/02/17 +自動代表圖
            'Modify By Sindy 2016/7/1 + 林景郁大陸中文自動簽名檔(M51-000047-0-00)
            'Modify By Sindy 2016/8/3 + 林景郁大陸中文雙署名自動簽名檔(M51-000047-1-00)
            'Modified by Lydia 2019/08/28 +回答要章(M51-000059-0-00)
            'Modified by Morgan 2020/11/17 +公司章
            'Modified by Morgan 2021/8/13 +自動公司章(變數接在公司名稱後,要印在相對位置)
            'Modified by Lydia 2022/03/29 + Unicode轉Big5=> "閻?泰自動簽名檔"
            'Modified by Morgan 2023/5/3 -"王錦寬自動簽名檔",目前已沒使用且將退休
            Case "閰英簽名檔", "閰中簽名檔", "雙署名自動簽名檔", _
                 "閻啟泰自動簽名檔", "指示信自動簽名檔", "閰英自動簽名檔", "閰中自動簽名檔", _
                 "閰英繳年費自動簽名檔", "confirmation自動簽名檔", "秘/Confidential自動簽名檔", _
                 "InvoiceEnclosed自動簽名檔", "林景郁英文自動簽名檔", "林景郁中文自動簽名檔", _
                 "自動代表圖", "右自動代表圖", "林景郁大陸中文自動簽名檔", "林景郁大陸中文雙署名自動簽名檔", _
                 "回答要章", "公司章", "自動公司章", "閻?泰自動簽名檔"
               'Add By Sindy 2014/10/8
               '檢查是否已下載簽名檔
               BolHaveImg = False
               strSignFile = "$$"
               'Modified by Lydia 2022/03/29 後面arrAct(intJ)改為strTmpArr ;因為署名檔有Unicode,所以需要轉Big5
               'Add by Sindy 2015/7/6
               If InStr(strTmpArr, "confirmation自動簽名檔") > 0 Then
                  strIBF02 = "000041" 'Added by Morgan 2015/8/18
                  strSignFile = strSignFile & "M51000041000.jpg"
               '2015/7/6 END
               'Add by Sindy 2015/7/24
               ElseIf InStr(strTmpArr, "秘/Confidential自動簽名檔") > 0 Then
                  strIBF02 = "000042" 'Added by Morgan 2015/8/18
                  strSignFile = strSignFile & "M51000042000.jpg"
               ElseIf InStr(strTmpArr, "InvoiceEnclosed自動簽名檔") > 0 Then
                  strIBF02 = "000043" 'Added by Sindy 2015/10/2
                  strSignFile = strSignFile & "M51000043000.jpg"
               '2015/7/24 END
               ElseIf InStr(strTmpArr, "閰英繳年費自動簽名檔") > 0 Then 'Add by Sindy 2015/6/30
                  strIBF02 = "000040" 'Added by Morgan 2015/8/18
                  strSignFile = strSignFile & "M51000040000.jpg"
               '2015/6/30 END
               ElseIf InStr(strTmpArr, "閰英") > 0 Then
                  'Add By Sindy 2020/9/8 特殊申請人的出名人簽名檔
                  If PUB_SpecAPPLOutAgent_FCP(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4)) = True Then
                     strIBF02 = "000088"
                     strSignFile = strSignFile & "M51000088000.jpg"
                  Else
                  '2020/9/8 END
                     strIBF02 = "000034" 'Added by Morgan 2015/8/18
                     strSignFile = strSignFile & "M51000034000.jpg"
                  End If
                  'Add by Sindy 2014/11/12 固定行高
                  oWord.Selection.ParagraphFormat.LineSpacingRule = wdLineSpaceExactly
                  oWord.Selection.ParagraphFormat.LineSpacing = 22
                  '2014/11/12 END
               ElseIf InStr(strTmpArr, "閰中") > 0 Then
                  strIBF02 = "000035" 'Added by Morgan 2015/8/18
                  strSignFile = strSignFile & "M51000035000.jpg"
               'Added by Morgan 2014/11/12
               'Removed by Morgan 2023/5/3 沒用了
               'ElseIf strTmpArr = "王錦寬自動簽名檔" Then
               '   strIBF02 = "000033" 'Added by Morgan 2015/8/18
               '   strSignFile = strSignFile & "M51000033000.jpg"
               'end 2023/5/3
               ElseIf strTmpArr = "雙署名自動簽名檔" Then
                  'Modified by Lydia 2017/05/03 P大陸案變更為雙署名檔(顯示公司別)
                  If m_CP01 = "P" Then
                        'Modified by Lydia 2022/03/29
                        'If InStr(Replace(PUB_GetCompany(m_CP01, m_CP02, m_CP03, m_CP04), "　", ""), "閻啟泰") > 0 Then
                        StrSQLa = PUB_UniToBIG5(Replace(PUB_GetCompany(m_CP01, m_CP02, m_CP03, m_CP04), "　", ""))
                        If InStr(StrSQLa, "閻啟泰") > 0 Or InStr(StrSQLa, "閻?泰") > 0 Then
                        'end 2022/03/29
                           strIBF02 = "000034"
                           strSignFile = strSignFile & "M51000034000.jpg" '英文簽名
                           iPicPos = 雙署名POS_1
                        'Modified by Morgan 2023/5/3
                        'Else
                        ElseIf InStr(StrSQLa, "郭雅娟") > 0 Then
                           strIBF02 = "000092"
                           strSignFile = strSignFile & "M51000092000.jpg"
                           iPicPos = 雙署名POS_2
                        ElseIf InStr(StrSQLa, "王錦寬") > 0 Then
                        'end 2023/5/3
                           strIBF02 = "000054"
                           strSignFile = strSignFile & "M51000054000.jpg"
                           iPicPos = 雙署名POS_2
                        End If
                  Else
                  'end 2017/05/03
                       'Modified by Lydia 2022/03/29
                       'If InStr(Replace(PUB_GetCompany(m_CP01, m_CP02, m_CP03, m_CP04), "　", ""), "王錦寬") > 0 Then
                       StrSQLa = StrSQLa = PUB_UniToBIG5(Replace(PUB_GetCompany(m_CP01, m_CP02, m_CP03, m_CP04), "　", ""))
                       'Memo by Morgan 2023/5/3 P案已改雙署名，不會再執行到此段程式碼，無需修改
                       If InStr(StrSQLa, "王錦寬") > 0 Then
                       'end 2022/03/29
                          strIBF02 = "000033" 'Added by Morgan 2015/8/18
                          strSignFile = strSignFile & "M51000033000.jpg"
                       'Added by Morgan 2014/12/11
                       'Modified by Lydia 2022/03/29
                       'ElseIf InStr(Replace(PUB_GetCompany(m_CP01, m_CP02, m_CP03, m_CP04), "　", ""), "閻啟泰") > 0 Then
                       ElseIf InStr(StrSQLa, "閻啟泰") > 0 Or InStr(StrSQLa, "閻?泰") > 0 Then
                          strIBF02 = "000036" 'Added by Morgan 2015/8/18
                          strSignFile = strSignFile & "M51000036000.jpg"
                       'end 2014/12/11
                       End If
                    'end 2014/11/12
                  End If 'end 2017/05/03
               'Added by Morgan 2014/12/11
               'Modified by Lydia 2022/03/29
               'ElseIf strTmpArr = "閻啟泰自動簽名檔" Then
               ElseIf strTmpArr = "閻啟泰自動簽名檔" Or strTmpArr = "閻?泰自動簽名檔" Then
                  strIBF02 = "000036" 'Added by Morgan 2015/8/18
                  strSignFile = strSignFile & "M51000036000.jpg"
               
               ElseIf strTmpArr = "指示信自動簽名檔" Then
                  'Modified by Lydia 2022/03/29
                  'If InStr(Replace(PUB_GetOrderLetterSignature(m_CP01, m_CP02, m_CP03, m_CP04), "　", ""), "王錦寬") > 0 Then
                  StrSQLa = StrSQLa = PUB_UniToBIG5(Replace(PUB_GetOrderLetterSignature(m_CP01, m_CP02, m_CP03, m_CP04), "　", ""))
                  'Memo by Morgan 2023/5/3 P案已改雙署名，不會再執行到此段程式碼，無需修改
                  If InStr(StrSQLa, "王錦寬") > 0 Then
                  'end 2022/03/29
                     strIBF02 = "000033" 'Added by Morgan 2015/8/18
                     strSignFile = strSignFile & "M51000033000.jpg"
                  'Modified by Lydia 2022/03/29
                  'ElseIf InStr(Replace(PUB_GetOrderLetterSignature(m_CP01, m_CP02, m_CP03, m_CP04), "　", ""), "閻啟泰") > 0 Then
                  ElseIf InStr(StrSQLa, "閻啟泰") > 0 Or InStr(StrSQLa, "閻?泰") > 0 Then
                     strIBF02 = "000036" 'Added by Morgan 2015/8/18
                     strSignFile = strSignFile & "M51000036000.jpg"
                  End If
               'end 2014/12/11
               'Added by Morgan 2015/8/18
               ElseIf strTmpArr = "林景郁英文自動簽名檔" Then
                  strIBF02 = "000044" 'Added by Morgan 2015/8/18
                  strSignFile = strSignFile & "M51000044000.jpg"
               ElseIf strTmpArr = "林景郁中文自動簽名檔" Then
                  strIBF02 = "000045" 'Added by Morgan 2015/8/18
                  strSignFile = strSignFile & "M51000045000.jpg"
               'end 2015/8/18
               'Add By Sindy 2016/7/1
               ElseIf strTmpArr = "林景郁大陸中文自動簽名檔" Then
                  strIBF02 = "000047"
                  strSignFile = strSignFile & "M51000047000.jpg"
               '2016/7/1 END
               'Add By Sindy 2016/8/3
               ElseIf strTmpArr = "林景郁大陸中文雙署名自動簽名檔" Then
                  If InStr(PUB_GetCompany(m_CP01, m_CP02, m_CP03, m_CP04), "北京巨京") > 0 Then
                     strIBF02 = "000049"
                     strSignFile = strSignFile & "M51000049000.jpg"
                  Else
                     strIBF02 = "000047"
                     strSignFile = strSignFile & "M51000047000.jpg"
                  End If
               '2016/8/3 END
               'Added by Lydia 2019/08/28
               ElseIf strTmpArr = "回答要章" Then
                     strIBF02 = "000059"
                     strSignFile = strSignFile & "M51000059000.jpg"
               'Added by Lydia 2016/02/17
               ElseIf strTmpArr = "自動代表圖" Or strTmpArr = "右自動代表圖" Then
                  strIBF02 = m_MySt(2)
                  strSignFile = strSignFile & m_MySt(1) & m_MySt(2) & m_MySt(3) & m_MySt(4) & ".jpg"
                  bolAutoPic = True
               'end 2016/02/17
               
               'Added by Morgan 2020/11/17
               'Modified by Morgan 2021/8/13 +自動公司章
               ElseIf strTmpArr = "公司章" Or strTmpArr = "自動公司章" Then
                  stComp = PUB_GetReceiptComp(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), True)
                  If stComp = "J" Then '智權
                     strIBF02 = "000053"
                     strSignFile = strSignFile & "M51000053000.jpg"
                  ElseIf stComp = "L" Then '法律
                     strIBF02 = "000067"
                     strSignFile = strSignFile & "M51000067000.jpg"
                  ElseIf stComp = "2" Then '智慧
                     strIBF02 = "000066"
                     strSignFile = strSignFile & "M51000066000.jpg"
                  End If
                  bolStamp = True
                  'Added by Morgan 2021/8/13
                  If strTmpArr = "自動公司章" Then
                     bolMoveUp = True
                     If oWord.Selection.ParagraphFormat.Alignment = wdAlignParagraphRight Then
                        bolAlignR = True
                     End If
                  End If
                  'end 2021/8/13
               End If
               '-----end ----後面arrAct(intJ)改為strTmpArr ;因為署名檔有Unicode,所以需要轉Big5
               
               strSignFile = App.path & "\" & strSignFile
               'Modify by Amy 2018/07/26 代表圖上線,圖要先刪除重抓
               If strSrvDate(1) >= 彩色代表圖啟用日 Then
                  If Dir(strSignFile) <> "" Then Kill strSignFile
               End If
               If Dir(strSignFile) = "" Then '檔案不存在,重新下載
'Modified by Morgan 2015/8/18
'                  'Add by Sindy 2015/7/6
'                  If InStr(arrAct(intJ), "confirmation自動簽名檔") > 0 Then
'                     BolHaveImg = GetImgByteFile("M51", "000041", "0", "00")
'                  '2015/7/6 END
'                  'Add by Sindy 2015/7/24
'                  ElseIf InStr(arrAct(intJ), "秘/Confidential自動簽名檔") > 0 Then
'                     BolHaveImg = GetImgByteFile("M51", "000042", "0", "00")
'                  ElseIf InStr(arrAct(intJ), "InvoiceEnclosed自動簽名檔") > 0 Then
'                     BolHaveImg = GetImgByteFile("M51", "000043", "0", "00")
'                  '2015/7/24 END
'                  ElseIf InStr(arrAct(intJ), "閰英繳年費自動簽名檔") > 0 Then 'Add by Sindy 2015/6/30
'                     BolHaveImg = GetImgByteFile("M51", "000040", "0", "00")
'                  '2015/6/30 END
'                  ElseIf InStr(arrAct(intJ), "閰英") > 0 Then
'                     BolHaveImg = GetImgByteFile("M51", "000034", "0", "00")
'                  ElseIf InStr(arrAct(intJ), "閰中") > 0 Then
'                     BolHaveImg = GetImgByteFile("M51", "000035", "0", "00")
'                  'Added by Morgan 2014/11/12
'                  ElseIf InStr(strSignFile, "M51000033000") > 0 Then
'                     BolHaveImg = GetImgByteFile("M51", "000033", "0", "00")
'                  'Added by Morgan 2014/12/11
'                  ElseIf InStr(strSignFile, "M51000036000") > 0 Then
'                     BolHaveImg = GetImgByteFile("M51", "000036", "0", "00")
'                  End If
                  'Added by Lydia 2016/02/17 自動代表圖
                  If bolAutoPic = True Then
                     If Dir(Replace(strSignFile, ".jpg", ".wmf")) = "" Then
                        'Modified by Lydia 2017/07/21 CFT指示信倘為彩色，請不要帶出商標圖
                        'BolHaveImg = GetImgByteFile(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4))
                        'Modify by Amy 2018/07/26 +if
                        If strSrvDate(1) >= 彩色代表圖啟用日 Then
                            BolHaveImg = GetImgByteFile_Case(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), strSignFile, IIf(showColorFirst = True, 0, 9))
                        Else
                            BolHaveImg = GetImgByteFile(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), , , , , IIf(m_MySt(1) & m_FinalSty = "CFT15", "1", ""))
                        End If
                     End If
                  Else
                  'end 2016/02/17
                     'Modify by Amy 2018/07/26 改function
                     'BolHaveImg = GetImgByteFile("M51", strIBF02, "0", "00")
                     BolHaveImg = PUB_ReadDB2File(strSignFile, Val(strIBF02))
                  End If
                  
'end 2015/8/18
               Else
                  BolHaveImg = True
               End If
               '2014/10/8 END
               If BolHaveImg = True Then
'                  '插入一列二欄的表格
'                  .Selection.Tables.Add Range:=.Selection.Range, NumRows:=1, NumColumns:=2
'                  '設定欄框為無線
'                  .Selection.Tables(1).AutoFormat Format:=wdTableFormatSimple1, ApplyBorders:=False, ApplyShading:=True, ApplyFont:=True, ApplyColor:=True, _
'                        ApplyHeadingRows:=True, ApplyLastRow:=False, ApplyFirstColumn:=True, ApplyLastColumn:=False, AutoFit:=False
'                  '設定第一個欄寬為6.5
'                  .Selection.Cells.SetWidth ColumnWidth:=.CentimetersToPoints(6.5), RulerStyle:=wdAdjustNone
'                  '移到第二欄
'                  .Selection.MoveRight Unit:=wdCell
                  '插入圖片
                  'Modified by Morgan 2014/11/12
                  'word 2007 以下的 Shape 物件位置會跑掉
                  '.Selection.InlineShapes.AddPicture FileName:=strSignFile, LinkToFile:=False, SaveWithDocument:=True
                  'Modify By Sindy 2015/7/3 +And InStr(UCase(strSignFile), UCase("M51000040000.jpg")) = 0 ==> "閰英繳年費自動簽名檔"列印時圖片會跑到上面
                  'Modify By Sindy 2015/7/27 FCP-037720 confirmation的章會蓋到系統日期 FCP-13-1605-01
'                  If Val(.Version) >= 12 And InStr(UCase(strSignFile), UCase("M51000040000.jpg")) = 0 Then
'                     '為了外專的簽名檔上面不要多一行空白列
'                     Set oShape = .Selection.InlineShapes.AddPicture(FileName:=strSignFile, LinkToFile:=False, SaveWithDocument:=True).ConvertToShape
'                     oShape.WrapFormat.Type = 5
'                     oShape.WrapFormat.Side = wdWrapBoth
'                  Else
                   'Added by Lydia 2016/02/17 自動代表圖
                   'Modified by Lydia 2017/05/03 加簽名檔
                   'If bolAutoPic Then
                   'Modified by Lydia 2017/05/22 簽名檔不用調整大小,所以不用重設位置,改塞空白
                   'If bolAutoPic Or iPicPos > 0 Then
                   'Modified by Moran 2020/11/18 +bolStamp
                   'If bolAutoPic Then
                   If bolAutoPic Or bolStamp Then
                   'end 2020/11/18
                       '記錄在頁面的位置
                       'pageY = .Selection.Information(wdVerticalPositionRelativeToPage)
                       'pageX = .Selection.Information(wdHorizontalPositionRelativeToPage)
                       'Added by Lydia 2017/05/03 桂英反應英譯稿的自動代表圖位置不正確,記錄頁面位置
                       'Added by Lydia 2017/05/18 Word97若不顯示,無法取得正確位置,會停在信頭下方
                       bVisibled = g_WordAp.Visible
                       If bVisibled = False Then g_WordAp.Visible = True
                       'end 2017/05/18
                       
                        pageY = oWord.Selection.Information(wdVerticalPositionRelativeToPage)
                        pageX = oWord.Selection.Information(wdHorizontalPositionRelativeToPage)
                        
                       'end 2017/05/03
                       
                       'Modified by Lydia 2020/07/03 改寫法(桂英:案件回覆列印有時會出現”'~'方法失敗”)
                       'Set oShape = oWord.Selection.InlineShapes.AddPicture(FileName:=strSignFile, LinkToFile:=False, SaveWithDocument:=True).ConvertToShape
                       oWord.Selection.Delete
                       Set oShape = oWord.ActiveDocument.Shapes.AddPicture(Anchor:=oWord.Selection.Range, FileName:=strSignFile, LinkToFile:=False, SaveWithDocument:=True)
                      'end 2020/07/03
                      
                       'Added by Morgan 2022/3/22
                       If arrAct(intJ) = "自動公司章" Then
                           m_AutoStampNameInWord = oShape.Name
                       End If
                       'end 2022/3/22
                      
                       '調整圖片大小
                       oShape.LockAspectRatio = msoTrue
                       '(實測:Top和Left是以AddPicture的相對位置,若以頁面距離來算是無法對準)
                       'oShape.RelativeHorizontalPosition = wdRelativeHorizontalPositionPage
                       'oShape.RelativeVerticalPosition = wdRelativeVerticalPositionPage
                       'Modified by Lydia 2017/05/03 +判斷 bolAutoPic
                       If bolAutoPic = True Then
                            'Added by Lydia 2020/05/25 增加案件回覆單
                            If InStr(1, SeekWord, "案件回覆單") > 0 Then
                                '依原比例縮放
                                pExRate = 0
                                tmpHigh = oShape.Height
                                tmpWidth = oShape.Width
                                If oShape.Height > oWord.CentimetersToPoints(5) Then
                                   pExRate = Round(oWord.CentimetersToPoints(5) / oShape.Height, 2)
                                   tmpHigh = tmpHigh * pExRate
                                   tmpWidth = tmpWidth * pExRate
                                End If
                                If tmpWidth > oWord.CentimetersToPoints(5) Then
                                   pExRate = Round(oWord.CentimetersToPoints(5) / tmpWidth, 2)
                                   tmpHigh = tmpHigh * pExRate
                                   tmpWidth = tmpWidth * pExRate
                                End If
                                oShape.Height = tmpHigh
                                oShape.Width = tmpWidth
                            Else
                            'end 2020/05/25
                                oShape.Height = oWord.CentimetersToPoints(3.5)
                                If oShape.Width > oWord.CentimetersToPoints(4.5) Then
                                   oShape.Width = oWord.CentimetersToPoints(4.5)
                                End If
                            End If 'Added by Lydia 2020/05/25
                       End If 'end 2017/05/03
                     
                       '移動回原來的位置 (實測:Top和Left是以AddPicture的相對位置,還原只需=0)
                       'Modified by Lydia 2017/05/03 桂英反應英譯稿的自動代表圖位置不正確,記錄頁面位置還原
                       'oShape.Top = oWord.CentimetersToPoints(0.1) ' Round(pageY / 20, 1) '座標值為twips ,20twips=1點
                       'oShape.Left = oWord.CentimetersToPoints(0.1) ' Round(pageX / 20, 1)
                       oShape.RelativeHorizontalPosition = wdRelativeHorizontalPositionPage
                       oShape.RelativeVerticalPosition = wdRelativeVerticalPositionPage
                       oShape.Top = pageY
                       oShape.Left = pageX
                       'end 2017/05/03
                       

                       If arrAct(intJ) = "右自動代表圖" Then
                           'Modified by Lydia 2017/05/03 改成頁面位置
                           'oShape.Left = oWord.CentimetersToPoints(11.6)
                           oShape.Left = oWord.CentimetersToPoints(13.2)
                       'Added by Lydia 2017/05/03 +簽名檔
                       ElseIf iPicPos > 0 Then
                           oShape.Left = oWord.CentimetersToPoints(iPicPos)
                       'end 2017/05/03
                       End If
                       
                       '圖蓋文
                       'Modified by Lydia 2017/05/03 +判斷 bolAutoPic
                       'Modified by Morgan 2020/11/17
                       'If bolAutoPic = True Then
                       If bolAutoPic Or bolStamp Then
                       'end 2020/11/17
                          oShape.WrapFormat.Type = wdWrapNone
                          oShape.WrapFormat.Side = wdWrapBoth
                       End If 'end 2017/05/03
                       
                     'Added by Morgan 2020/11/19
                     If bolStamp Then
                        oShape.RelativeVerticalPosition = wdRelativeVerticalPositionParagraph 'Added by Morgan 2021/8/17 隨文字移動
                        oShape.Top = 0 'Added by Morgan 2022/2/18 要重設，否則不同版本位置會跑掉
                        oShape.Height = oWord.CentimetersToPoints(2.7)
                        oShape.ZOrder 5 '文蓋圖
                     End If
                     'end 2020/11/19
                     
                     'Added by Morgan 2021/8/13 自動公司章要調整位置到左上方
                     'Modified by Morgan 2021/11/17 向下微調兩行左右以避免蓋到本文
                      If bolMoveUp Then
                         'Modified by Morgan 2022/2/17
                         lngLoc = oShape.Top - oShape.Height + 25
                         oShape.Top = lngLoc
                         lngLoc = 0
                         oShape.Left = oShape.Left - oShape.Width
                         If bolAlignR Then
                            oShape.Left = oShape.Left + 100
                         End If
                      End If
                      'end 2021/8/13
                     
                     If bVisibled = False Then g_WordAp.Visible = False 'Added by Lydia 2017/05/18 還原不顯示 'Modified by Morgan 2025/3/20 改在圖片新增後，因為起始位置有時也會跑掉
                     
                   Else
                   'end 2016/02/17
                     '單行行高
                     'Modified by Lydia 2017/05/22 簽名檔不用調整大小,所以不用重設位置,改塞空白
                     If iPicPos > 0 Then
                        oWord.Selection.MoveLeft
                        oWord.Selection.Text = String(iPicPos, "　")  '塞空白
                        oWord.Selection.MoveLeft
                        oWord.Selection.Find.Text = oOldWord  '重新抓
                        oWord.Selection.Find.Replacement.Text = ""
                        oWord.Selection.Find.Execute
                     End If
                     'end 2017/05/22
                     oWord.Selection.ParagraphFormat.LineSpacingRule = wdLineSpaceSingle
                     oWord.Selection.InlineShapes.AddPicture FileName:=strSignFile, LinkToFile:=False, SaveWithDocument:=True
                   End If
'                  End If
                  'end 2014/11/12
               Else
                  oWord.Selection.Delete
               End If
               
'Removed by Morgan 2024/3/29 沒用了
'            'Added by Morgan 2020/12/17
'            Case "109脫歐通知2案件清單"
'               strExc(0) = "select cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) cno" & _
'                  ",decode(tm01,null,pa11,tm12) pno,decode(tm01,null,pa05,tm05) pnm,tm09,CP01,CP02,CP03,CP04" & _
'                  " from caseprogress,patent,trademark where cp28='" & g_LD18 & "'" & _
'                  " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04" & _
'                  " and tm01(+)=cp01 and tm02(+)=cp02 and tm03(+)=cp03 and tm04(+)=cp04" & _
'                  " order by 1"
'               intI = 1
'               Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
'               If intI = 1 Then
'                  intI = RsTemp.RecordCount
'                  If RsTemp("cp01") = "CFP" Then
'                     Set oTable = oWord.Selection.Tables.add(Range:=oWord.Selection.Range, NumRows:=(intI * 5 + 3), NumColumns:=4)
'                  Else
'                     Set oTable = oWord.Selection.Tables.add(Range:=oWord.Selection.Range, NumRows:=(intI * 5 + 3), NumColumns:=5)
'                  End If
'                  With oTable
'                  .Select
'                  oWord.Selection.Font.Size = 12
'                  .Columns(1).SetWidth ColumnWidth:=oWord.CentimetersToPoints(3.2), RulerStyle:=wdAdjustProportional
'                  .Columns(2).SetWidth ColumnWidth:=oWord.CentimetersToPoints(2.3), RulerStyle:=wdAdjustProportional
'                  If RsTemp("cp01") = "CFP" Then
'                     .Columns(3).SetWidth ColumnWidth:=oWord.CentimetersToPoints(8), RulerStyle:=wdAdjustProportional
'                  Else
'                     .Columns(3).SetWidth ColumnWidth:=oWord.CentimetersToPoints(5), RulerStyle:=wdAdjustProportional
'                     .Columns(4).SetWidth ColumnWidth:=oWord.CentimetersToPoints(3), RulerStyle:=wdAdjustProportional
'                  End If
'
'                  '格線
'                  .Borders(wdBorderLeft).LineStyle = wdLineStyleNone
'                  .Borders(wdBorderRight).LineStyle = wdLineStyleNone
'                  .Borders(wdBorderTop).LineStyle = wdLineStyleNone
'                  .Borders(wdBorderBottom).LineStyle = wdLineStyleNone
'                  .Borders(wdBorderVertical).LineStyle = wdLineStyleNone
'                  .Borders(wdBorderHorizontal).LineStyle = wdLineStyleNone
'
'                  '標題
'                  .Rows(1).Cells.Merge
'                  .Rows(1).Cells(1).Select
'                  oWord.Selection.ParagraphFormat.Alignment = wdAlignParagraphCenter
'                  '欄位名稱
'                  .Rows(2).Select
'                  '實心底線
'                  With oWord.Selection.Borders(wdBorderBottom)
'                      .LineStyle = wdLineStyleSingle
'                      .LineWidth = wdLineWidth150pt
'                      .ColorIndex = wdAuto
'                  End With
'                  'oWord.Selection.ParagraphFormat.Alignment = wdAlignParagraphCenter
'                  .Rows(2).Cells(1).Select
'                  oWord.Selection.TypeText "本所案號"
'                  .Rows(2).Cells(2).Select
'                  oWord.Selection.TypeText "申請號"
'                  .Rows(2).Cells(3).Select
'                  oWord.Selection.TypeText "案件名稱"
'                  If RsTemp("cp01") = "CFP" Then
'                     .Rows(2).Cells(4).Select
'                     oWord.Selection.TypeText "委任英國代理人"
'                  Else
'                     .Rows(2).Cells(4).Select
'                     oWord.Selection.TypeText "類別"
'                     .Rows(2).Cells(5).Select
'                     oWord.Selection.TypeText "委任英國代理人"
'                  End If
'
'                  .Rows(intI * 5 + 3).Select
'                  '實心底線
'                  With oWord.Selection.Borders(wdBorderBottom)
'                      .LineStyle = wdLineStyleSingle
'                      .LineWidth = wdLineWidth150pt
'                      .ColorIndex = wdAuto
'                  End With
'
'                  End With
'                  With RsTemp
'                  intI = 0
'                  intK = 0
'                  Do While Not .EOF
'                     If intI > 0 Then
'                        '第8筆要跳頁
'                        If intI + 1 = 8 Then
'                           oTable.Rows(2 + intI * 5 + 1 + intK).Select
'                           oWord.Selection.InsertRows 4
'                           intK = 4
'                        ElseIf (intI - 7) Mod 8 = 0 Then
'                           oTable.Rows(2 + intI * 5 + 1 + intK).Select
'                           oWord.Selection.InsertRows 3
'                           intK = intK + 3
'                        End If
'
'                        '分隔虛線
'                        oTable.Rows(2 + intI * 5 + 1 + intK).Select
'                        With oWord.Selection.Borders(wdBorderTop)
'                            .LineStyle = wdLineStyleDashLargeGap
'                            .LineWidth = wdLineWidth100pt
'                            .ColorIndex = wdAuto
'                        End With
'                     End If
'
'                     oTable.Rows(2 + intI * 5 + 1 + intK).Cells(1).Select
'                     oWord.Selection.TypeText "" & .Fields("cno")
'                     oTable.Rows(2 + intI * 5 + 1 + intK).Cells(2).Select
'                     oWord.Selection.TypeText "" & .Fields("pno")
'                     oTable.Rows(2 + intI * 5 + 1 + intK).Cells(3).Select
'                     oWord.Selection.TypeText "" & .Fields("pnm")
'                     If RsTemp("cp01") = "CFP" Then
'                        oTable.Rows(2 + intI * 5 + 1 + intK).Cells(4).Select
'                        oWord.Selection.TypeText "5,000"
'                     Else
'                        oTable.Rows(2 + intI * 5 + 1 + intK).Cells(4).Select
'                        oWord.Selection.TypeText "" & .Fields("tm09")
'                        oTable.Rows(2 + intI * 5 + 1 + intK).Cells(5).Select
'                        oWord.Selection.TypeText "5,000"
'                     End If
'
'                     oTable.Rows(2 + intI * 5 + 3 + intK).Cells(1).Select
'                     If RsTemp("cp01") = "CFP" Then
'                        oWord.Selection.MoveRight Unit:=wdCharacter, Count:=2, Extend:=wdExtend
'                     Else
'                        oWord.Selection.MoveRight Unit:=wdCharacter, Count:=3, Extend:=wdExtend
'                     End If
'                     oWord.Selection.Cells.Merge
'                     oWord.Selection.TypeText "□ 本人／本公司同意辦理委任英國代理人處理後續事宜。"
'
'                     oTable.Rows(2 + intI * 5 + 4 + intK).Cells(1).Select
'                     If RsTemp("cp01") = "CFP" Then
'                        oWord.Selection.MoveRight Unit:=wdCharacter, Count:=2, Extend:=wdExtend
'                     Else
'                        oWord.Selection.MoveRight Unit:=wdCharacter, Count:=3, Extend:=wdExtend
'                     End If
'                     oWord.Selection.Cells.Merge
'                     oWord.Selection.TypeText "□ 本人／本公司不同意辦理委任英國代理人處理後續事宜。"
'                     If RsTemp("cp01") = "CFP" Then
'                        oTable.Rows(2 + intI * 5 + 2 + intK).Cells(4).Select
'                     Else
'                        oTable.Rows(2 + intI * 5 + 2 + intK).Cells(5).Select
'                     End If
'                     strSignFile = App.path & "\$$" & .Fields("cp01") & .Fields("cp02") & .Fields("cp03") & .Fields("cp04")
'                     If GetImgByteFile_Case(.Fields("cp01"), .Fields("cp02"), .Fields("cp03"), .Fields("cp04"), strSignFile) = True Then
'                        'If oWord.Visible = False Then oWord.Visible = True
'                        Set oShape = oWord.ActiveDocument.Shapes.AddPicture(Anchor:=oWord.Selection.Range, FileName:=strSignFile, LinkToFile:=False, SaveWithDocument:=True)
'                        oShape.LockAspectRatio = msoTrue
'                        oShape.Top = oWord.CentimetersToPoints(0.1)
'                        If oShape.Height > oWord.CentimetersToPoints(2) Then
'                           oShape.Height = oWord.CentimetersToPoints(2)
'                        End If
'                        If oShape.Width > oWord.CentimetersToPoints(3.2) Then
'                           oShape.Width = oWord.CentimetersToPoints(3.2)
'                        End If
'                     End If
'                     intI = intI + 1
'                     .MoveNext
'                  Loop
'                  End With
'               End If
'
'            'Added by Morgan 2019/10/15
'            Case "台灣設計案專用期延長案件清單"
'               strExc(0) = "select cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) cno" & _
'                  ",pa22 pno,pa05 pnm,sqldatet(pa24) pdt1,sqldatet(pa25) pdt2" & _
'                  ",sqldatet(to_char(add_months(to_date(pa10,'yyyymmdd'),180)-1,'yyyymmdd')) pdt3" & _
'                  ",sqldatew(pa25) pdt4,sqldatew(to_char(add_months(to_date(pa10,'yyyymmdd'),180)-1,'yyyymmdd')) pdt5" & _
'                  ",pa75,pa77 from (select lp01 from letterprogress where lp01='" & g_LD18 & "'" & _
'                  " union select lp01 from letterprogress where lp42='" & g_LD18 & "') x" & _
'                  ",caseprogress,patent where cp09(+)=lp01" & _
'                  " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04 order by 1"
'               intI = 1
'               Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
'               If intI = 1 Then
'
'                  intI = RsTemp.RecordCount
'                  If Not IsNull(RsTemp.Fields("pa75")) Then
'                     Set oTable = oWord.Selection.Tables.add(Range:=oWord.Selection.Range, NumRows:=(intI + 2), NumColumns:=6)
'                  Else
'                     Set oTable = oWord.Selection.Tables.add(Range:=oWord.Selection.Range, NumRows:=(intI + 2), NumColumns:=5)
'                  End If
'                  With oTable
'                  .Select
'                  oWord.Selection.Font.Size = 12
'                  If Not IsNull(RsTemp.Fields("pa75")) Then
'                     .Columns(1).SetWidth ColumnWidth:=oWord.CentimetersToPoints(2.5), RulerStyle:=wdAdjustProportional
'                     .Columns(2).SetWidth ColumnWidth:=oWord.CentimetersToPoints(2.8), RulerStyle:=wdAdjustProportional
'                     .Columns(3).SetWidth ColumnWidth:=oWord.CentimetersToPoints(2), RulerStyle:=wdAdjustProportional
'                     .Columns(4).SetWidth ColumnWidth:=oWord.CentimetersToPoints(5), RulerStyle:=wdAdjustProportional
'                     .Columns(5).SetWidth ColumnWidth:=oWord.CentimetersToPoints(2.4), RulerStyle:=wdAdjustProportional
'                  Else
'                     .Columns(1).SetWidth ColumnWidth:=oWord.CentimetersToPoints(2.5), RulerStyle:=wdAdjustProportional
'                     .Columns(2).SetWidth ColumnWidth:=oWord.CentimetersToPoints(2), RulerStyle:=wdAdjustProportional
'                     .Columns(3).SetWidth ColumnWidth:=oWord.CentimetersToPoints(5), RulerStyle:=wdAdjustProportional
'                     .Columns(4).SetWidth ColumnWidth:=oWord.CentimetersToPoints(3.8), RulerStyle:=wdAdjustProportional
'                  End If
'
'                  '格線
'                  .Borders(wdBorderLeft).LineStyle = wdLineStyleSingle
'                  .Borders(wdBorderRight).LineStyle = wdLineStyleSingle
'                  .Borders(wdBorderTop).LineStyle = wdLineStyleSingle
'                  .Borders(wdBorderBottom).LineStyle = wdLineStyleSingle
'                  .Borders(wdBorderVertical).LineStyle = wdLineStyleSingle
'                  .Borders(wdBorderHorizontal).LineStyle = wdLineStyleSingle
'
'                  '標題
'                  .Rows(1).Cells.Merge
'                  .Rows(1).Cells(1).Select
'                  oWord.Selection.ParagraphFormat.Alignment = wdAlignParagraphCenter
'                  oWord.Selection.TypeText "案件清單"
'                  .Rows(1).Cells(1).Borders(wdBorderLeft).LineStyle = wdLineStyleNone
'                  .Rows(1).Cells(1).Borders(wdBorderRight).LineStyle = wdLineStyleNone
'                  .Rows(1).Cells(1).Borders(wdBorderTop).LineStyle = wdLineStyleNone
'
'                  '欄位名稱
'                  .Rows(2).Select
'                  oWord.Selection.ParagraphFormat.Alignment = wdAlignParagraphCenter
'                  If Not IsNull(RsTemp.Fields("pa75")) Then
'                     .Rows(2).Cells(1).Select
'                     oWord.Selection.TypeText "我方案號"
'                     .Rows(2).Cells(2).Select
'                     oWord.Selection.TypeText "貴方卷號"
'                     .Rows(2).Cells(3).Select
'                     oWord.Selection.TypeText "證書號"
'                     .Rows(2).Cells(4).Select
'                     oWord.Selection.TypeText "設計名稱"
'                     .Rows(2).Cells(5).Select
'                     oWord.Selection.TypeText "原專利權止日"
'                     .Rows(2).Cells(6).Select
'                     oWord.Selection.TypeText "新法專利權止日"
'                  Else
'                     .Rows(2).Cells(1).Select
'                     oWord.Selection.TypeText "本所案號"
'                     .Rows(2).Cells(2).Select
'                     oWord.Selection.TypeText "證書號"
'                     .Rows(2).Cells(3).Select
'                     oWord.Selection.TypeText "設計名稱"
'                     .Rows(2).Cells(4).Select
'                     oWord.Selection.TypeText "原專利權期間"
'                     .Rows(2).Cells(5).Select
'                     oWord.Selection.TypeText "新法專利權期間"
'                  End If
'                  End With
'                  With RsTemp
'                  intI = 0
'                  Do While Not .EOF
'                     intI = intI + 1
'                     If Not IsNull(RsTemp.Fields("pa75")) Then
'                        oTable.Rows(2 + intI).Cells(1).Select
'                        oWord.Selection.TypeText "" & .Fields("cno")
'                        oTable.Rows(2 + intI).Cells(2).Select
'                        oWord.Selection.TypeText "" & .Fields("pa77")
'                        oTable.Rows(2 + intI).Cells(3).Select
'                        oWord.Selection.TypeText "" & .Fields("pno")
'                        oTable.Rows(2 + intI).Cells(4).Select
'                        oWord.Selection.TypeText "" & .Fields("pnm")
'                        oTable.Rows(2 + intI).Cells(5).Select
'                        oWord.Selection.TypeText .Fields("pdt4")
'                        oTable.Rows(2 + intI).Cells(6).Select
'                        oWord.Selection.TypeText .Fields("pdt5")
'                     Else
'                        oTable.Rows(2 + intI).Cells(1).Select
'                        oWord.Selection.TypeText "" & .Fields("cno")
'                        oTable.Rows(2 + intI).Cells(2).Select
'                        oWord.Selection.TypeText "" & .Fields("pno")
'                        oTable.Rows(2 + intI).Cells(3).Select
'                        oWord.Selection.TypeText "" & .Fields("pnm")
'                        oTable.Rows(2 + intI).Cells(4).Select
'                        oWord.Selection.TypeText .Fields("pdt1") & "-" & .Fields("pdt2")
'                        oTable.Rows(2 + intI).Cells(5).Select
'                        oWord.Selection.TypeText .Fields("pdt1") & "-" & .Fields("pdt3")
'                     End If
'                     .MoveNext
'                  Loop
'                  End With
'               End If
               
            'Added by Morgan 2023/2/15
            Case "商品及服務附件檔"
               oWord.Selection.Delete
               If CopyTMGoodsAtt() = True Then
                  oWord.Selection.TypeText Chr(12)
                  oWord.Selection.Paste
                  oWord.Selection.TypeBackspace
               End If
            'end 2023/2/15
            
            'Add By Sindy 2023/8/1
            Case "公報商品"
               'Add By Sindy 2023/9/19 +文字描述
               strSql = "select tmbulletindata.*,tm01,tm02,tm03,tm04,tm08 from tmbulletindata,trademark " & _
                        "Where tm01='" & m_MySt(1) & "' and tm02='" & m_MySt(2) & "' and tm03='" & m_MySt(3) & "' and tm04='" & m_MySt(4) & "'" & _
                        " and tbd02=tm15 and tbd03=tm08 and tbd16='1' and tbd15='A'" & _
                        " and tm44 is null"
               intI = 1
               Set RsTemp = ClsLawReadRstMsg(intI, strSql)
               If intI = 1 Then
                  If "" & RsTemp.Fields("TBD11") <> "" Then
                     oWord.Selection.Font.Size = 10 '小字
                     oWord.Selection.TypeText RsTemp.Fields("TBD11")
                     oWord.Selection.TypeParagraph
                     oWord.Selection.TypeParagraph
                  Else
                     oWord.Selection.TypeParagraph
                  End If
               Else
                  oWord.Selection.TypeParagraph
               End If
               '2023/9/19 END
               
               strSql = "select tm08,tmbulletingoods.* from trademark,tmbulletingoods" & _
                  " Where tm01='" & m_MySt(1) & "' and tm02='" & m_MySt(2) & "' and tm03='" & m_MySt(3) & "' and tm04='" & m_MySt(4) & "'" & _
                  " and tbg01=tm15 and tbg07=tm08 order by tbg02 asc"
               intI = 1: strExc(10) = ""
               Set RsTemp = ClsLawReadRstMsg(intI, strSql)
               If intI = 1 Then
                  oWord.Selection.Font.Size = 10 '小字
                  RsTemp.MoveFirst
                  For intI = 1 To RsTemp.RecordCount
                     If strExc(10) <> "" Then oWord.Selection.TypeParagraph
                     If "" & RsTemp.Fields("tbg03") <> "" Then
                        oWord.Selection.TypeText RsTemp.Fields("tbg03")
                        oWord.Selection.TypeParagraph
                     End If
                     strExc(10) = Trim("" & RsTemp.Fields("tbg04")) & _
                                  Trim("" & RsTemp.Fields("tbg05")) & _
                                  Trim("" & RsTemp.Fields("tbg06")) & _
                                  Trim("" & RsTemp.Fields("tbg08")) & _
                                  Trim("" & RsTemp.Fields("tbg09")) & _
                                  Trim("" & RsTemp.Fields("tbg10"))
                     If "" & RsTemp.Fields("tm08") = "7" Then '證明標章
                        oWord.Selection.TypeText "證明內容：" & strExc(10)
                     ElseIf "" & RsTemp.Fields("tm08") = "8" Then '團體標章
                        oWord.Selection.TypeText "表彰內容：" & strExc(10)
                     Else
                        oWord.Selection.TypeText "商品或服務名稱：" & strExc(10)
                     End If
                     RsTemp.MoveNext
                  Next intI
               End If
            '2023/8/1 END
            
            'Added by Morgan 2024/3/29
            Case "FCP工程師落款"
               
               oWord.Visible = True 'Added by Morgan 2024/4/1 不顯示的話調整圖片時會錯誤
               oWord.Selection.Delete
               oWord.Selection.Delete
               
               Set oTable = oWord.Selection.Tables.add(Range:=oWord.Selection.Range, NumRows:=2, NumColumns:=2)
               With oTable
                  .Columns(1).SetWidth ColumnWidth:=oWord.CentimetersToPoints(6.3), RulerStyle:=wdAdjustProportional
                 .Borders(wdBorderLeft).LineStyle = wdLineStyleNone
                 .Borders(wdBorderRight).LineStyle = wdLineStyleNone
                 .Borders(wdBorderTop).LineStyle = wdLineStyleNone
                 .Borders(wdBorderBottom).LineStyle = wdLineStyleNone
                 .Borders(wdBorderVertical).LineStyle = wdLineStyleNone
                 .Borders(wdBorderDiagonalDown).LineStyle = wdLineStyleNone
                 .Borders(wdBorderDiagonalUp).LineStyle = wdLineStyleNone
                 .Borders.Shadow = False
               End With
               
               oTable.Rows(1).Select
               oWord.Selection.Cells.VerticalAlignment = wdAlignVerticalBottom
               oWord.Selection.Cells(1).SetHeight RowHeight:=36, HeightRule:=wdRowHeightAtLeast
               
               '組別主管簽名檔
               strSignFile = "$$M51"
               strIBF02 = "000088"
               strSignName = ""
               If PUB_SpecAPPLOutAgent_FCP(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4)) = True Then
                  strIBF03 = "1"
                  strIBF04 = "00"
                  strExc(0) = "select st12 from setspecman,staff where OCODE='外專德國客戶指定工程師窗口'  and st01(+)=oman"
                  intI = 1
                  Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
                  If intI = 1 Then
                     strSignName = "" & RsTemp("st12")
                  End If
               Else
                  strIBF03 = "0"
                  strExc(0) = "select pa150,st12 from patent,setspecman,staff where " & PaSt & " and OCODE(+)=decode(pa150,'1','T','2','R','3','S','4','T1')  and st01(+)=oman"
                  intI = 1
                  Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
                  If intI = 1 Then
                     strIBF04 = Right("0" & RsTemp("pa150"), 2)
                     strSignName = "" & RsTemp("st12")
                  End If
               End If
               strSignFile = strSignFile & strIBF02 & strIBF03 & strIBF04 & ".jpg"
               strSignFile = App.path & "\" & strSignFile
               If Dir(strSignFile) <> "" Then Kill strSignFile
               If Dir(strSignFile) = "" Then
                  BolHaveImg = PUB_ReadDB2File(strSignFile, Val(strIBF02), , strIBF03, strIBF04)
                  If BolHaveImg = True Then
                     oTable.Rows(1).Cells(1).Select
                     oWord.Selection.Collapse Direction:=wdCollapseStart
                     Set oShape = oWord.ActiveDocument.Shapes.AddPicture(Anchor:=oWord.Selection.Range, FileName:=strSignFile, LinkToFile:=False, SaveWithDocument:=True)
                     pExRate = 0
                     tmpHigh = oShape.Height
                     tmpWidth = oShape.Width
                     If oShape.Height > oWord.CentimetersToPoints(1.22) Then
                        pExRate = Round(oWord.CentimetersToPoints(1.22) / oShape.Height, 2)
                        tmpHigh = tmpHigh * pExRate
                        tmpWidth = tmpWidth * pExRate
                     End If
                     oShape.Height = tmpHigh
                     oShape.Width = tmpWidth
                  End If
               End If
               '組別主管署名
               strExc(0) = strSignName & vbCrLf & "Assistant Manager" & vbCrLf & "International Patent Division"
               oTable.Rows(2).Cells(1).Select
               oWord.Selection.TypeText strExc(0)
                           
               '出名代理人
               strSignFile = "$$M51000034000.jpg"
               strIBF02 = "34"
               strSignFile = App.path & "\" & strSignFile
               If Dir(strSignFile) <> "" Then Kill strSignFile
               If Dir(strSignFile) = "" Then
                  BolHaveImg = PUB_ReadDB2File(strSignFile, Val(strIBF02))
                  If BolHaveImg = True Then
                     oTable.Rows(1).Cells(2).Select
                     oWord.Selection.Collapse Direction:=wdCollapseStart
                     Set oShape = oWord.ActiveDocument.Shapes.AddPicture(Anchor:=oWord.Selection.Range, FileName:=strSignFile, LinkToFile:=False, SaveWithDocument:=True)
                  End If
               End If
               strExc(0) = "Fred C. T. Yen" & vbCrLf & "Patent Attorney" & vbCrLf & "Managing Partner"
               oTable.Rows(2).Cells(2).Select
               oWord.Selection.TypeText strExc(0)
               
            'Added by Morgan 2025/8/26
            Case "超連結" '只能放最後或獨立設定
               oWord.Selection.Text = oNewWord
               oWord.ActiveDocument.Hyperlinks.add Anchor:=oWord.Selection.Range, address:=oNewWord, SubAddress:=""
               bolTextDone = True
            'end 2025/8/26
            
            Case Else
               'Added by Morgan 2019/6/4
               '縮排###(Ex:縮排1.25=內縮1.25公分)
               If Left(arrAct(intJ), 2) = "縮排" And IsNumeric(Mid(arrAct(intJ), 3)) Then
                  oWord.Selection.Delete '不可取消(有可能沒有內容) Memo by Morgan 2023/1/11
                  With oWord.Selection.ParagraphFormat
                      .LeftIndent = oWord.CentimetersToPoints(Val(Mid(arrAct(intJ), 3)))
                  End With
               End If
               'Added by Morgan 2019/10/15
               If Left(arrAct(intJ), 2) = "凸排" And IsNumeric(Mid(arrAct(intJ), 3)) Then
                  oWord.Selection.Delete '不可取消(有可能沒有內容) Memo by Morgan 2023/1/11
                  With oWord.Selection.ParagraphFormat
                      .LeftIndent = oWord.CentimetersToPoints(Val(Mid(arrAct(intJ), 3)))
                      .FirstLineIndent = oWord.CentimetersToPoints(-1 * Val(Mid(arrAct(intJ), 3)))
                  End With
               End If
               'end 2019/6/4
               
               'Added by Morgan 2023/2/22 插入Word內容
               If LCase(Right(arrAct(intJ), 4)) = ".doc" Or LCase(Right(arrAct(intJ), 5)) = ".docx" Then
                  oWord.Selection.Delete
                  Call InsWordDoc(arrAct(intJ), oWord)
               End If
               'end 2023/2/22
         End Select
      Next 'Add by Morgan 2007/10/29
      
      If Not bolTextDone Then 'Added by Morgan 2025/8/26
         oWord.Selection.TypeText oNewWord
      End If
      
   End If 'Added by Morgan 2014/11/27
'end 2007/10/30

'End With 'Removed by Morgan 2017/4/27

'將字取代掉
'Modify by Morgan 2007/12/20 需考慮控制字串重複問題
'DoWordVBA = Replace(SeekWord, oOldWord, oNewWord)
DoWordVBA = Replace(SeekWord, oOldWord, oNewWord, 1, 1)

Exit Function
WrdErr:
    'MsgBox "Word 執行錯誤！", vbExclamation, "嚴重警告！"
    'Modified by Morgan 2022/2/17 除錯測試
    'MsgBox Err.Description
    MsgBox Err.Number & ":" & Err.Description & IIf(lngLoc <> 0, vbCrLf & vbCrLf & lngLoc, "")
    'end 2022/2/17
    DoWordVBA = Replace(Replace(SeekWord, "|#", ""), "#|", "")
    
End Function

'add by nickc 2007/08/07
'Modify by Amy 2018/07/30 +showColorFirst=>是否先抓彩色代表圖
'Modified by Morgan 2021/7/1 showColorFirst 預設改 Ture(彩圖優先)--經理
Public Sub PUB_AddInPicToWordR(ByRef oWord As Word.Application, Optional ByVal showColorFirst As Boolean = True)
   Dim bytes() As Byte
   Dim file_num As Integer
   Dim rsPic As New ADODB.Recordset
   Dim IsWmf As Boolean
   'Add by Morgan 2007/11/6
   Dim stSQL As String
   Dim intR As Integer
   Dim stFileName As String
   Dim oShape 'Added by Morgan 2012/8/16
   
On Error GoTo ErrHnd

   With oWord
            
      '開啟查詢
      'Modify by Morgan 2007/12/14 為加速只往前移3頁
      '.Selection.HomeKey Unit:=wdStory
      .Selection.GoTo what:=wdGoToPage, which:=wdGoToPrevious, Count:=3
      'end 2007/12/14
      .Selection.Find.ClearFormatting
      .Selection.Find.Text = "|#右代表圖#|"
      .Selection.Find.Replacement.Text = ""
      .Selection.Find.Forward = True
      .Selection.Find.Wrap = wdFindContinue
      .Selection.Find.Format = False
      .Selection.Find.MatchCase = False
      .Selection.Find.MatchWholeWord = False
      .Selection.Find.MatchWildcards = False
      .Selection.Find.MatchSoundsLike = False
      .Selection.Find.MatchAllWordForms = False
      .Selection.Find.MatchByte = True
      .Selection.Find.Execute
      .Selection.Delete 'Add by Morgan 2007/11/8
                
      'Modify by Amy 2018/07/30 Mark原程式改GetImgByteFile_Case做
'      stSQL = "select * from ImgByteFile where ibf01='" & m_MySt(1) & "' and ibf02='" & m_MySt(2) & "' and ibf03='" & m_MySt(3) & "' and ibf04='" & m_MySt(4) & "' and ibf05='1' "
'      intR = 1
'      Set rsPic = ClsLawReadRstMsg(intR, stSQL)
''Remove by Morgan 2008/1/4 無代表圖改不印
''      'Add by Morgan 2007/11/6 若無代表圖時抓建置中的圖
''      If intR = 0 Then
''         stSQL = "select ibf06,ibf13,ibf14,1 Sort from ImgByteFile where ibf01='000' and ibf02='000000' and ibf03='0' and ibf04='00' and ibf05='1'"
''         intR = 1
''         Set rsPic = ClsLawReadRstMsg(intR, stSQL)
''      End If
''      'end 2007/11/6
'      If intR = 1 Then
'
'         If CheckStr(rsPic.Fields("ibf06")) = "1" Or CheckStr(rsPic.Fields("ibf06")) = "2" Then IsWmf = False Else IsWmf = True
'         stFileName = m_MySt(1) & m_MySt(2) & m_MySt(3) & m_MySt(4) & "." & IIf(IsWmf, "wmf", "jpg")
'
'         'Modify by Morgan 2008/7/16 若已存在時不再重新產生(wmf格式有時會無法刪除故產生第二份定稿時讀檔也會有錯)
'         If Dir(App.path & "\" & stFileName) = "" Then
'            'Add By Sindy 2017/8/10
''            If "" & rsPic.Fields("IBF15") <> "" Then
'               If PUB_GetFtpFile(rsPic.Fields("IBF15"), App.path & "\" & stFileName, UCase("ImgByteFile")) = False Then
'                  GoTo ErrHnd
'               End If
''            Else
''            '2017/8/10 END
''               ReDim bytes(Val(rsPic.Fields("ibf13").Value))
''               bytes() = rsPic.Fields("ibf14").GetChunk(Val(rsPic.Fields("ibf13").Value))
''               file_num = FreeFile
''               'edit by nickc 2007/11/27 指定檔名
''               'Open App.Path & "\tmp." & IIf(IsWmf, "wmf", "jpg") For Binary Access Write As #file_num
''               Open App.path & "\" & stFileName For Binary Access Write As #file_num
''               Put #file_num, , bytes()
''               Close #file_num
''            End If
'         End If
      '代表圖
      If GetImgByteFile_Case(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), stFileName, IIf(showColorFirst = True, 0, 9)) = True Then
         stFileName = Replace(stFileName, App.path & "\", "")
      'end 2018/07/30
         '插入圖片檔案
         .ChangeFileOpenDirectory App.path & "\"
         'edit by nickc 2007/11/27 指定檔名
         '.ActiveDocument.Shapes.AddPicture Anchor:=.Selection.Range, FileName:= _
         App.Path & "\tmp." & IIf(IsWmf, "wmf", "jpg"), LinkToFile:= _
         False, SaveWithDocument:=True
         'Modified by Morgan 2012/8/16 改用 oShape 操作(原用變數名稱當改信頭文件重複使用時會有錯)
         Set oShape = .ActiveDocument.Shapes.AddPicture(Anchor:=.Selection.Range, FileName:=App.path & "\" & stFileName, LinkToFile:=False, SaveWithDocument:=True)
         '.ActiveDocument.Shapes("Picture " & Trim(.ActiveDocument.Shapes.Count + 1)).Select
         
         oShape.ZOrder msoBringInFrontOfText
         oShape.Fill.Visible = msoTrue
         oShape.Fill.Solid
         'add by nickc 2007/12/07 修正底色
         oShape.Fill.ForeColor.RGB = RGB(255, 255, 255)
         oShape.Fill.Transparency = 0.5
         oShape.Line.Weight = 0.75
         oShape.Line.DashStyle = msoLineSolid
         oShape.Line.Style = msoLineSingle
         oShape.Line.Transparency = 0#
         'Modified by Morgan 2013/11/11 商標定稿加 CFT ,大小統一改為 5cm X 5cm,不加框
         'oShape.Line.Visible = msoTrue   'msoFalse   畫框線
         'Modify By Sindy 2014/3/10
         'If m_MySt(1) = "T" Or m_MySt(1) = "CFT" Then
         'Modify By Sindy 2014/4/2 薛經理說專利要畫框線
         'If m_MySt(1) = "T" Or m_MySt(1) = "CFT" Or m_MySt(1) = "P" Or m_MySt(1) = "CFP" Then
         'Modified by Lydia 2016/02/17 加著作權TC
         'Modified by Lydia 2016/06/06 +TF
         'Modify By Sindy 2017/7/25 看TM-000085定稿為何圖太大, 但T-177495不會
         'If m_MySt(1) = "T" Or m_MySt(1) = "CFT" Or m_MySt(1) = "TC" Or m_MySt(1) = "TF" Then
         If InStr(m_MySt(1), "T") > 0 Then
         '2017/7/25 END
            oShape.Line.Visible = msoFalse
         Else
            oShape.Line.Visible = msoTrue   'msoFalse   畫框線
         End If
         'end 2013/11/11
         oShape.Line.ForeColor.RGB = RGB(0, 0, 0)
         oShape.Line.BackColor.RGB = RGB(255, 255, 255)
         oShape.LockAspectRatio = msoTrue
         '定義大小
         '鎖定最高 圖區
         'Modify by Morgan 2007/9/17
         'oShape.Height = 280
         'Modify by Sindy 2009/04/24 T要求把圖縮小
         'Modified by Morgan 2013/11/11 商標定稿加 CFT ,大小統一改為 5cm X 5cm,不加框
         'If m_MySt(1) = "T" Then
            'oShape.Height = 230
            'If oShape.Width > 200 Then
            '   oShape.Width = 200
            'End If
         'Modify By Sindy 2014/3/10
         'If m_MySt(1) = "T" Or m_MySt(1) = "CFT" Then
         'Modified by Lydia 2016/02/17 加著作權TC
         'Modified by Lydia 2016/06/06 +TF
         'Modify By Sindy 2017/7/25 看TM-000085定稿為何圖太大, 但T-177495不會 : Mark, 因大家一致抓法
'         If m_MySt(1) = "T" Or m_MySt(1) = "CFT" Or m_MySt(1) = "P" Or m_MySt(1) = "CFP" Or m_MySt(1) = "TC" Or m_MySt(1) = "TF" Then
         'Added by Lydia 2020/06/04 內商延展通知定稿(橫式雙面)的代表圖改為4.5公分; 因為5/27整合商標部內商及外商的延展定稿多出申請國家一行,而T-174601的商標名稱折成4行,造成第一頁內容超過版面,形成之後案件全部奇偶頁不對
         If m_MySt(1) = "T" And ((m_FinalSty = "10" And InStr("21,22,23", m_Situ) > 0) Or (m_FinalSty = "03" And InStr("16,", m_Situ) > 0)) Then
            oShape.Height = .CentimetersToPoints(4.5)
            If oShape.Width > .CentimetersToPoints(4.5) Then
               oShape.Width = .CentimetersToPoints(4.5)
            End If
         Else
         'end 2020/06/04
            oShape.Height = .CentimetersToPoints(5)
            If oShape.Width > .CentimetersToPoints(5) Then
               oShape.Width = .CentimetersToPoints(5)
            End If
            'end 2013/11/11
         End If 'Added by Lydia 2020/06/04
'         Else
'            oShape.Height = 250
'            If oShape.Width > 220 Then
'               oShape.Width = 220
'            End If
'         End If
         'end 2007/9/17
         
         oShape.PictureFormat.Brightness = 0.5
         oShape.PictureFormat.Contrast = 0.5
         oShape.PictureFormat.ColorType = msoPictureAutomatic
         oShape.PictureFormat.CropLeft = 0#
         oShape.PictureFormat.CropRight = 0#
         oShape.PictureFormat.CropTop = 0#
         oShape.PictureFormat.CropBottom = 0#
         'Modify by Morgan 2007/9/17 設位置相對於邊界,不透明
         'oShape.RelativeHorizontalPosition = wdRelativeHorizontalPositionColumn
         'oShape.RelativeVerticalPosition = wdRelativeVerticalPositionParagraph
         oShape.RelativeHorizontalPosition = wdRelativeHorizontalPositionPage
         oShape.RelativeVerticalPosition = wdRelativeVerticalPositionPage
         oShape.Fill.Transparency = 0#
         'end 2007/9/17
                
         oShape.LockAnchor = False
         '圖蓋文
         oShape.WrapFormat.Type = wdWrapNone
         oShape.WrapFormat.Side = wdWrapBoth
         oShape.WrapFormat.DistanceTop = .CentimetersToPoints(0)
         oShape.WrapFormat.DistanceBottom = .CentimetersToPoints(0)
         oShape.WrapFormat.DistanceLeft = .CentimetersToPoints(0.32)
         oShape.WrapFormat.DistanceRight = .CentimetersToPoints(0.32)
         'Modify by Morgan 2007/9/17
         '移到指定位置
          'Add by Morgan 2008/7/14 配合新定稿紙
         If m_bolNewFormat = True Then
            'Added by Morgan 2013/11/11
            'Modify By Sindy 2014/3/10
            'Modified by Lydia 2016/02/17 加著作權TC
            'If m_MySt(1) = "T" Or m_MySt(1) = "CFT" Then
            'Modified by Lydia 2016/06/06 +TF
            'Modify By Sindy 2017/7/25 看TM-000085定稿為何圖太大, 但T-177495不會 : Mark, 因大家一致抓法
'            If m_MySt(1) = "T" Or m_MySt(1) = "CFT" Or m_MySt(1) = "P" Or m_MySt(1) = "CFP" Or m_MySt(1) = "TC" Or m_MySt(1) = "TF" Then
               oShape.Left = .CentimetersToPoints(13.2)
               'oShape.Top = .CentimetersToPoints(6.6)
               oShape.Top = .CentimetersToPoints(6.65) 'Modify By Sindy 2014/3/10
'            Else
'            'end 2013/11/11
'               oShape.Left = .CentimetersToPoints(11.2)
'               oShape.Top = .CentimetersToPoints(6.6)
'            End If 'Added by Morgan 2013/11/11
         'end 2008/7/14
         Else
            '申請人一下面那一行
            oShape.Left = .CentimetersToPoints(11)
            oShape.Top = .CentimetersToPoints(8)
         End If
         'end 2007/9/17
         
         'Add By Sindy 2022/1/24
         If m_MySt(1) = "000" Then '個人人事資料明細表:員工照片
            oShape.Left = .CentimetersToPoints(15)
            oShape.Top = .CentimetersToPoints(4)
         End If
         '2022/1/24 END
         
         If Dir(App.path & "\" & stFileName) <> "" Then
            Kill App.path & "\" & stFileName
         End If
         
      End If
      .Selection.EndKey Unit:=wdStory
   End With
   Exit Sub
'Add by Morgan 2008/7/16 加判斷若錯誤為無法刪除檔案時繼續(下次跑整批定稿時會刪)
ErrHnd:
   If (pub_OS = 1 And Err.Number = 75) Or (pub_OS <> 1 And Err.Number = 70) Then
      Resume Next
   Else
      Err.Raise Err.Number
   End If
End Sub

'Add By Sindy 2014/3/18 利用 PUB_AddInPicToWordR 延伸出來的函數
'Modify by Amy 2018/07/30 +showColorFirst=>是否先抓彩色代表圖
'Modified by Morgan 2021/7/1 showColorFirst 預設改 Ture(彩圖優先)--經理
Public Sub PUB_AddInPicToWordR2(ByRef oWord As Word.Application, Optional ByVal showColorFirst As Boolean = True)
   Dim bytes() As Byte
   Dim file_num As Integer
   Dim rsPic As New ADODB.Recordset
   Dim IsWmf As Boolean
   Dim stSQL As String
   Dim intR As Integer
   Dim stFileName As String
   Dim oShape
   
On Error GoTo ErrHnd
   
   With oWord
      '開啟查詢
      '.Selection.HomeKey Unit:=wdStory
      .Selection.GoTo what:=wdGoToPage, which:=wdGoToPrevious, Count:=3
      .Selection.Find.ClearFormatting
      .Selection.Find.Text = "|#右代表圖2#|"
      .Selection.Find.Replacement.Text = ""
      .Selection.Find.Forward = True
      .Selection.Find.Wrap = wdFindContinue
      .Selection.Find.Format = False
      .Selection.Find.MatchCase = False
      .Selection.Find.MatchWholeWord = False
      .Selection.Find.MatchWildcards = False
      .Selection.Find.MatchSoundsLike = False
      .Selection.Find.MatchAllWordForms = False
      .Selection.Find.MatchByte = True
      .Selection.Find.Execute
      .Selection.Delete
         
      'Modify by Amy 2018/07/30 Mark原程式改GetImgByteFile_Case做
'      stSQL = "select * from ImgByteFile where ibf01='" & m_MySt(1) & "' and ibf02='" & m_MySt(2) & "' and ibf03='" & m_MySt(3) & "' and ibf04='" & m_MySt(4) & "' and ibf05='1' "
'      intR = 1
'      Set rsPic = ClsLawReadRstMsg(intR, stSQL)
'      If intR = 1 Then
'         If CheckStr(rsPic.Fields("ibf06")) = "1" Or CheckStr(rsPic.Fields("ibf06")) = "2" Then IsWmf = False Else IsWmf = True
'         stFileName = m_MySt(1) & m_MySt(2) & m_MySt(3) & m_MySt(4) & "." & IIf(IsWmf, "wmf", "jpg")
'
'         '若已存在時不再重新產生(wmf格式有時會無法刪除故產生第二份定稿時讀檔也會有錯)
'         If Dir(App.path & "\" & stFileName) = "" Then
'            'Add By Sindy 2017/8/10
''            If "" & rsPic.Fields("IBF15") <> "" Then
'               If PUB_GetFtpFile(rsPic.Fields("IBF15"), App.path & "\" & stFileName, UCase("ImgByteFile")) = False Then
'                  GoTo ErrHnd
'               End If
''            Else
''            '2017/8/10 END
''               ReDim bytes(Val(rsPic.Fields("ibf13").Value))
''               bytes() = rsPic.Fields("ibf14").GetChunk(Val(rsPic.Fields("ibf13").Value))
''               file_num = FreeFile
''               '指定檔名
''               Open App.path & "\" & stFileName For Binary Access Write As #file_num
''               Put #file_num, , bytes()
''               Close #file_num
''            End If
'         End If
         '代表圖
         If GetImgByteFile_Case(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), stFileName, IIf(showColorFirst = True, 0, 9)) = True Then
            stFileName = Replace(stFileName, App.path & "\", "")
         'end 2018/07/30
         
         '插入圖片檔案
         .ChangeFileOpenDirectory App.path & "\"
         '指定檔名
         '改用 oShape 操作(原用變數名稱當改信頭文件重複使用時會有錯)
         Set oShape = .ActiveDocument.Shapes.AddPicture(Anchor:=.Selection.Range, FileName:=App.path & "\" & stFileName, LinkToFile:=False, SaveWithDocument:=True)
         '.ActiveDocument.Shapes("Picture " & Trim(.ActiveDocument.Shapes.Count + 1)).Select
         
         oShape.ZOrder msoBringInFrontOfText
         oShape.Fill.Visible = msoTrue
         oShape.Fill.Solid
         '修正底色
         oShape.Fill.ForeColor.RGB = RGB(255, 255, 255)
         oShape.Fill.Transparency = 0.5
         oShape.Line.Weight = 0.75
         oShape.Line.DashStyle = msoLineSolid
         oShape.Line.Style = msoLineSingle
         oShape.Line.Transparency = 0#
         oShape.Line.Visible = msoTrue '畫框線
         oShape.Line.ForeColor.RGB = RGB(0, 0, 0)
         oShape.Line.BackColor.RGB = RGB(255, 255, 255)
         oShape.LockAspectRatio = msoTrue
         '定義大小
         oShape.Height = .CentimetersToPoints(5)
         If oShape.Width > .CentimetersToPoints(5) Then
            oShape.Width = .CentimetersToPoints(5)
         End If
         
         oShape.PictureFormat.Brightness = 0.5
         oShape.PictureFormat.Contrast = 0.5
         oShape.PictureFormat.ColorType = msoPictureAutomatic
         oShape.PictureFormat.CropLeft = 0#
         oShape.PictureFormat.CropRight = 0#
         oShape.PictureFormat.CropTop = 0#
         oShape.PictureFormat.CropBottom = 0#
         '設位置相對於邊界,不透明
         'oShape.RelativeHorizontalPosition = wdRelativeHorizontalPositionColumn
         'oShape.RelativeVerticalPosition = wdRelativeVerticalPositionParagraph
         oShape.RelativeHorizontalPosition = wdRelativeHorizontalPositionPage
         oShape.RelativeVerticalPosition = wdRelativeVerticalPositionPage
         oShape.Fill.Transparency = 0#
                
         oShape.LockAnchor = False
         '圖蓋文
         oShape.WrapFormat.Type = wdWrapNone
         oShape.WrapFormat.Side = wdWrapBoth
         oShape.WrapFormat.DistanceTop = .CentimetersToPoints(0)
         oShape.WrapFormat.DistanceBottom = .CentimetersToPoints(0)
         oShape.WrapFormat.DistanceLeft = .CentimetersToPoints(0.32)
         oShape.WrapFormat.DistanceRight = .CentimetersToPoints(0.32)
         '移到指定位置
         'Modify By Sindy 2014/4/29 讓圖在開窗裡儘量可以看的完整點
         'oShape.Left = .CentimetersToPoints(15.2)
         'oShape.Top = .CentimetersToPoints(4.2)
         oShape.Left = .CentimetersToPoints(14)
         oShape.Top = .CentimetersToPoints(4.8)
         '2014/4/29 END
         
         If Dir(App.path & "\" & stFileName) <> "" Then
            Kill App.path & "\" & stFileName
         End If
         
      End If
      .Selection.EndKey Unit:=wdStory
   End With
   Exit Sub
'加判斷若錯誤為無法刪除檔案時繼續(下次跑整批定稿時會刪)
ErrHnd:
   If (pub_OS = 1 And Err.Number = 75) Or (pub_OS <> 1 And Err.Number = 70) Then
      Resume Next
   Else
      Err.Raise Err.Number
   End If
End Sub

'Add By Sindy 2014/3/19 利用 PUB_AddInPicToWordR 延伸出來的函數
'使用在P的大陸案年費,台灣案通知領證、年費
'Modify by Amy 2018/07/30 +showColorFirst=>是否先抓彩色代表圖
'Modified by Morgan 2021/7/1 showColorFirst 預設改 Ture(彩圖優先)--經理
Public Sub PUB_AddInPicToWordR3(ByRef oWord As Word.Application, Optional ByVal showColorFirst As Boolean = True)
   Dim bytes() As Byte
   Dim file_num As Integer
   Dim rsPic As New ADODB.Recordset
   Dim IsWmf As Boolean
   'Add by Morgan 2007/11/6
   Dim stSQL As String
   Dim intR As Integer
   Dim stFileName As String
   Dim oShape 'Added by Morgan 2012/8/16
   
On Error GoTo ErrHnd

   With oWord
            
      '開啟查詢
      'Modify by Morgan 2007/12/14 為加速只往前移3頁
      '.Selection.HomeKey Unit:=wdStory
      .Selection.GoTo what:=wdGoToPage, which:=wdGoToPrevious, Count:=3
      'end 2007/12/14
      .Selection.Find.ClearFormatting
      .Selection.Find.Text = "|#右代表圖3#|"
      .Selection.Find.Replacement.Text = ""
      .Selection.Find.Forward = True
      .Selection.Find.Wrap = wdFindContinue
      .Selection.Find.Format = False
      .Selection.Find.MatchCase = False
      .Selection.Find.MatchWholeWord = False
      .Selection.Find.MatchWildcards = False
      .Selection.Find.MatchSoundsLike = False
      .Selection.Find.MatchAllWordForms = False
      .Selection.Find.MatchByte = True
      .Selection.Find.Execute
      .Selection.Delete 'Add by Morgan 2007/11/8
                
      'Modify by Amy 2018/07/30 Mark原程式改GetImgByteFile_Case做
'      stSQL = "select * from ImgByteFile where ibf01='" & m_MySt(1) & "' and ibf02='" & m_MySt(2) & "' and ibf03='" & m_MySt(3) & "' and ibf04='" & m_MySt(4) & "' and ibf05='1' "
'      intR = 1
'      Set rsPic = ClsLawReadRstMsg(intR, stSQL)
'
''Remove by Morgan 2008/1/4 無代表圖改不印
''      'Add by Morgan 2007/11/6 若無代表圖時抓建置中的圖
''      If intR = 0 Then
''         stSQL = "select ibf06,ibf13,ibf14,1 Sort from ImgByteFile where ibf01='000' and ibf02='000000' and ibf03='0' and ibf04='00' and ibf05='1'"
''         intR = 1
''         Set rsPic = ClsLawReadRstMsg(intR, stSQL)
''      End If
''      'end 2007/11/6
'
'      If intR = 1 Then
'         'Add By Sindy 2017/3/14 FCT彩色代表圖不顯示
'         If m_MySt(1) = "FCT" And CheckStr(rsPic.Fields("ibf06")) = "2" Then
'            GoTo RunEnd
'         End If
'         '2017/3/14 END
'         If CheckStr(rsPic.Fields("ibf06")) = "1" Or CheckStr(rsPic.Fields("ibf06")) = "2" Then IsWmf = False Else IsWmf = True
'         stFileName = m_MySt(1) & m_MySt(2) & m_MySt(3) & m_MySt(4) & "." & IIf(IsWmf, "wmf", "jpg")
'
'         'Modify by Morgan 2008/7/16 若已存在時不再重新產生(wmf格式有時會無法刪除故產生第二份定稿時讀檔也會有錯)
'         If Dir(App.path & "\" & stFileName) = "" Then
'            'Add By Sindy 2017/8/10
''            If "" & rsPic.Fields("IBF15") <> "" Then
'               If PUB_GetFtpFile(rsPic.Fields("IBF15"), App.path & "\" & stFileName, UCase("ImgByteFile")) = False Then
'                  GoTo ErrHnd
'               End If
''            Else
''            '2017/8/10 END
''               ReDim bytes(Val(rsPic.Fields("ibf13").Value))
''               bytes() = rsPic.Fields("ibf14").GetChunk(Val(rsPic.Fields("ibf13").Value))
''               file_num = FreeFile
''               'edit by nickc 2007/11/27 指定檔名
''               'Open App.Path & "\tmp." & IIf(IsWmf, "wmf", "jpg") For Binary Access Write As #file_num
''               Open App.path & "\" & stFileName For Binary Access Write As #file_num
''               Put #file_num, , bytes()
''               Close #file_num
''            End If
'         End If
      '代表圖
      If GetImgByteFile_Case(m_MySt(1), m_MySt(2), m_MySt(3), m_MySt(4), stFileName, IIf(showColorFirst = True, 0, 9)) = True Then
         stFileName = Replace(stFileName, App.path & "\", "")
         'end 2018/07/30
         '插入圖片檔案
         .ChangeFileOpenDirectory App.path & "\"
         'edit by nickc 2007/11/27 指定檔名
         '.ActiveDocument.Shapes.AddPicture Anchor:=.Selection.Range, FileName:= _
         App.Path & "\tmp." & IIf(IsWmf, "wmf", "jpg"), LinkToFile:= _
         False, SaveWithDocument:=True
         'Modified by Morgan 2012/8/16 改用 oShape 操作(原用變數名稱當改信頭文件重複使用時會有錯)
         Set oShape = .ActiveDocument.Shapes.AddPicture(Anchor:=.Selection.Range, FileName:=App.path & "\" & stFileName, LinkToFile:=False, SaveWithDocument:=True)
         '.ActiveDocument.Shapes("Picture " & Trim(.ActiveDocument.Shapes.Count + 1)).Select
         
         oShape.ZOrder msoBringInFrontOfText
         oShape.Fill.Visible = msoTrue
         oShape.Fill.Solid
         'add by nickc 2007/12/07 修正底色
         oShape.Fill.ForeColor.RGB = RGB(255, 255, 255)
         oShape.Fill.Transparency = 0.5
         oShape.Line.Weight = 0.75
         oShape.Line.DashStyle = msoLineSolid
         oShape.Line.Style = msoLineSingle
         oShape.Line.Transparency = 0#
         'Modified by Morgan 2013/11/11 商標定稿加 CFT ,大小統一改為 5cm X 5cm,不加框
         'oShape.Line.Visible = msoTrue   'msoFalse   畫框線
         'Add By Sindy 2017/3/14 FCT申請案號輸入及註冊證譯文代表圖
         If m_MySt(1) = "FCT" Then
            oShape.Line.Visible = msoFalse   'msoFalse  不畫框線
         Else
         '2017/3/14 END
            oShape.Line.Visible = msoTrue   'msoFalse   畫框線
         End If
         oShape.Line.ForeColor.RGB = RGB(0, 0, 0)
         oShape.Line.BackColor.RGB = RGB(255, 255, 255)
         oShape.LockAspectRatio = msoTrue
         '定義大小
         '鎖定最高 圖區
         'Modify by Morgan 2007/9/17
         'oShape.Height = 280
         'Modify by Sindy 2009/04/24 T要求把圖縮小
         'Modified by Morgan 2013/11/11 商標定稿加 CFT ,大小統一改為 5cm X 5cm,不加框
         'If m_MySt(1) = "T" Then
            'oShape.Height = 230
            'If oShape.Width > 200 Then
            '   oShape.Width = 200
            'End If
         'Add By Sindy 2017/3/14 FCT申請案號輸入及註冊證譯文代表圖
         'Modify By Sindy 2022/7/27 阿蓮:05.註冊證譯文帶出之商標圖大小原本為7.06公分, 改為5公分, 以節省調整之作業時間
         '                          FCT-05-1701-15 ex:FCT-48498
         If m_MySt(1) = "FCT" Then
            If m_FinalSty = "05" Then
               '5公分
'               oShape.Height = 141.75 '230
'               If oShape.Width > 141.75 Then '> 200
'                  oShape.Width = 141.75 '200
'               End If
               'Modify By Sindy 2023/3/13 將原設定之5公分修改為5.5公分
               '5.5公分
               oShape.Height = 156
               If oShape.Width > 156 Then
                  oShape.Width = 156
               End If
               '2023/3/13 END
            Else
            '2022/7/27 END
               'FCT-02-101-09,FCT-02-101-14: 02.申請案號 ex:FCT-49404
               oShape.Height = 230
               If oShape.Width > 200 Then
                  oShape.Width = 200
               End If
            End If
         Else
         '2017/3/14 END
            oShape.Height = 250
            If oShape.Width > 220 Then
               oShape.Width = 220
            End If
         End If
         oShape.PictureFormat.Brightness = 0.5
         oShape.PictureFormat.Contrast = 0.5
         oShape.PictureFormat.ColorType = msoPictureAutomatic
         oShape.PictureFormat.CropLeft = 0#
         oShape.PictureFormat.CropRight = 0#
         oShape.PictureFormat.CropTop = 0#
         oShape.PictureFormat.CropBottom = 0#
         'Modify by Morgan 2007/9/17 設位置相對於邊界,不透明
         'oShape.RelativeHorizontalPosition = wdRelativeHorizontalPositionColumn
         'oShape.RelativeVerticalPosition = wdRelativeVerticalPositionParagraph
         oShape.RelativeHorizontalPosition = wdRelativeHorizontalPositionPage
         oShape.RelativeVerticalPosition = wdRelativeVerticalPositionPage
         oShape.Fill.Transparency = 0#
         'end 2007/9/17
                
         oShape.LockAnchor = False
         '圖蓋文
         oShape.WrapFormat.Type = wdWrapNone
         oShape.WrapFormat.Side = wdWrapBoth
         oShape.WrapFormat.DistanceTop = .CentimetersToPoints(0)
         oShape.WrapFormat.DistanceBottom = .CentimetersToPoints(0)
         oShape.WrapFormat.DistanceLeft = .CentimetersToPoints(0.32)
         oShape.WrapFormat.DistanceRight = .CentimetersToPoints(0.32)
         'Modify by Morgan 2007/9/17
         '移到指定位置
          'Add by Morgan 2008/7/14 配合新定稿紙
         If m_bolNewFormat = True Then
            oShape.Left = .CentimetersToPoints(11.2)
            oShape.Top = .CentimetersToPoints(6.65)
         Else
            'Add By Sindy 2017/3/14 FCT申請案號輸入及註冊證譯文代表圖
            If m_MySt(1) = "FCT" Then
               oShape.Left = .CentimetersToPoints(7)
               'Modify By Sindy 2022/1/5 FCT-48427
               If m_FinalSty = "02" Then '申請案號
                  oShape.Top = .CentimetersToPoints(10)
               Else
               '2022/1/5 END
                  oShape.Top = .CentimetersToPoints(14) '(10) Modify By Sindy 2021/11/4 FCT-047076
               End If
            Else
            '2017/3/14 END
               '申請人一下面那一行
               oShape.Left = .CentimetersToPoints(11)
               oShape.Top = .CentimetersToPoints(8)
            End If
         End If
         'end 2007/9/17
         oShape.ZOrder 5 'Added by Morgan 2023/2/8 文字在前

         If Dir(App.path & "\" & stFileName) <> "" Then
            Kill App.path & "\" & stFileName
         End If
      End If
RunEnd: 'Add By Sindy 2017/3/14
      .Selection.EndKey Unit:=wdStory
   End With
   Exit Sub
'Add by Morgan 2008/7/16 加判斷若錯誤為無法刪除檔案時繼續(下次跑整批定稿時會刪)
ErrHnd:
   If (pub_OS = 1 And Err.Number = 75) Or (pub_OS <> 1 And Err.Number = 70) Then
      Resume Next
   Else
      Err.Raise Err.Number
   End If
End Sub

'Add By Sindy 2023/7/31
Public Sub PUB_AddInPicToWordR4(ByRef oWord As Word.Application, strFileName As String)
   Dim bytes() As Byte
   Dim file_num As Integer
   Dim rsPic As New ADODB.Recordset
   Dim IsWmf As Boolean
   'Add by Morgan 2007/11/6
   Dim stSQL As String
   Dim intR As Integer
   Dim stFileName As String
   Dim strFilePath As String
   Dim oShape 'Added by Lydia 2016/09/29

On Error GoTo ErrHnd
   
   strFilePath = Pub_GetSpecMan("內商開拓資料存放路徑") & "\XmlTrans"
   With oWord
'      .Selection.MoveDown
      
      '開啟查詢
      'Modify by Morgan 2007/12/14 為加速只往前移3頁
      '.Selection.HomeKey Unit:=wdStory
      .Selection.GoTo what:=wdGoToPage, which:=wdGoToPrevious, Count:=3
      'end 2007/12/14
      .Selection.Find.ClearFormatting
      .Selection.Find.Text = "|#右代表圖-公報#|"
      .Selection.Find.Replacement.Text = ""
      .Selection.Find.Forward = True
      .Selection.Find.Wrap = wdFindContinue
      .Selection.Find.Format = False
      .Selection.Find.MatchCase = False
      .Selection.Find.MatchWholeWord = False
      .Selection.Find.MatchWildcards = False
      .Selection.Find.MatchSoundsLike = False
      .Selection.Find.MatchAllWordForms = False
      .Selection.Find.MatchByte = True
      .Selection.Find.Execute
      '.Selection.Select
      .Selection.Delete 'Add by Morgan 2007/11/8

      If InStr(strFileName, "imagesdata") = 0 Then
         strFileName = "imagesdata/" & strFileName 'TBD12=imagesdata/egimg_109049498_1_048003.jpg
      End If

      '插入圖片檔案
      .ChangeFileOpenDirectory strFilePath & "\imagesdata\"
      'Add By Sindy 2012/10/17 檢查檔案是否存在
      If FileExists(Replace(strFilePath & "\" & strFileName, "/", "\")) = False Then Exit Sub
      '2012/10/17 End
      '指定檔名
      'Modified by Lydia 2016/09/29 用舊寫法會造成Word2010出錯
      '.ActiveDocument.Shapes.AddPicture Anchor:=.Selection.Range, FileName:= _
      'txtPath(0) & "\" & strFileName, LinkToFile:= _
      'False, SaveWithDocument:=True
      '.ActiveDocument.Shapes("Picture " & Trim(.ActiveDocument.Shapes.Count + 1)).Select
      Set oShape = .ActiveDocument.Shapes.AddPicture(Anchor:=.Selection.Range, FileName:=strFilePath & "\" & strFileName, LinkToFile:=False, SaveWithDocument:=True)
      oShape.Select
      
'
'         .Selection.ShapeRange.ZOrder msoBringInFrontOfText
'         .Selection.ShapeRange.Fill.Visible = msoTrue
'         .Selection.ShapeRange.Fill.Solid
'         'add by nickc 2007/12/07 修正底色
'         .Selection.ShapeRange.Fill.ForeColor.RGB = RGB(255, 255, 255)
'         .Selection.ShapeRange.Fill.Transparency = 0.5
'         .Selection.ShapeRange.Line.Weight = 0.75
'         .Selection.ShapeRange.Line.DashStyle = msoLineSolid
'         .Selection.ShapeRange.Line.Style = msoLineSingle
'         .Selection.ShapeRange.Line.Transparency = 0#
'         .Selection.ShapeRange.Line.Visible = msoFalse   'msoTrue.畫框線
'         .Selection.ShapeRange.Line.ForeColor.RGB = RGB(0, 0, 0)
'         .Selection.ShapeRange.Line.BackColor.RGB = RGB(255, 255, 255)
'         .Selection.ShapeRange.LockAspectRatio = msoTrue
'
'         '定義大小
'         '鎖定最高 圖區
'         '圖大小
'         .Selection.ShapeRange.Height = 230
'         If .Selection.ShapeRange.Width > 150 Then
'            .Selection.ShapeRange.Width = 150
'         End If
'
'         .Selection.ShapeRange.PictureFormat.Brightness = 0.5
'         .Selection.ShapeRange.PictureFormat.Contrast = 0.5
'         .Selection.ShapeRange.PictureFormat.ColorType = msoPictureAutomatic
'         .Selection.ShapeRange.PictureFormat.CropLeft = 0#
'         .Selection.ShapeRange.PictureFormat.CropRight = 0#
'         .Selection.ShapeRange.PictureFormat.CropTop = 0#
'         .Selection.ShapeRange.PictureFormat.CropBottom = 0#
'         '設位置相對於邊界,不透明
'         .Selection.ShapeRange.RelativeHorizontalPosition = wdRelativeHorizontalPositionPage
'         .Selection.ShapeRange.RelativeVerticalPosition = wdRelativeVerticalPositionPage
'         .Selection.ShapeRange.Fill.Transparency = 0#
'
'         .Selection.ShapeRange.LockAnchor = False
'         '圖蓋文
'         .Selection.ShapeRange.WrapFormat.Type = wdWrapSquare 'wdWrapNone.圖蓋文 wdWrapSquare.文字繞圖
'         .Selection.ShapeRange.WrapFormat.Side = wdWrapBoth
'         .Selection.ShapeRange.WrapFormat.DistanceTop = .CentimetersToPoints(0)
'         .Selection.ShapeRange.WrapFormat.DistanceBottom = .CentimetersToPoints(0)
'         .Selection.ShapeRange.WrapFormat.DistanceLeft = .CentimetersToPoints(0.32)
'         .Selection.ShapeRange.WrapFormat.DistanceRight = .CentimetersToPoints(0.32)
'         '移到指定位置
'         '申請人一下面那一行
'         .Selection.ShapeRange.Left = .CentimetersToPoints(12) '11.2
'         '.Selection.ShapeRange.Top = .CentimetersToPoints(6.6)
      
      '定義大小
      '鎖定最高 圖區
      '圖大小
      'Modified by Lydia 2016/09/29
'      .Selection.ShapeRange.LockAspectRatio = msoTrue
'      .Selection.ShapeRange.Height = 230
'      If .Selection.ShapeRange.Width > 150 Then
'         .Selection.ShapeRange.Width = 150
'      End If
'      '移到指定位置
'      .Selection.ShapeRange.Left = .CentimetersToPoints(12) '11.2
'      '.Selection.ShapeRange.Top = .CentimetersToPoints(1)
'      .Selection.ShapeRange.LockAnchor = False
'      '圖蓋文
'      .Selection.ShapeRange.WrapFormat.Type = wdWrapSquare 'wdWrapNone.圖蓋文 wdWrapSquare.文字繞圖
      oShape.LockAspectRatio = msoTrue
      oShape.Height = 230
      If oShape.Width > 150 Then
         oShape.Width = 150
      End If
      '移到指定位置
      oShape.Left = .CentimetersToPoints(12)
      oShape.LockAnchor = False
      '圖蓋文
      oShape.WrapFormat.Type = wdWrapSquare
      
      .Selection.EndKey Unit:=wdStory
   End With
   Exit Sub
   
'Add by Morgan 2008/7/16 加判斷若錯誤為無法刪除檔案時繼續(下次跑整批定稿時會刪)
ErrHnd:
   If (pub_OS = 1 And Err.Number = 75) Or (pub_OS <> 1 And Err.Number = 70) Then 'Err.Number = 5152
      Resume Next
   Else
      Err.Raise Err.Number
   End If
End Sub

'Add by Morgan 2008/3/13
'檢查列印份數的列外狀況
Public Sub PUB_GetCopySetting(ByRef p_iCopy As Integer, ByVal cp01 As String, ByVal cp02 As String, ByVal cp03 As String, ByVal cp04 As String, Optional ByVal CP10 As String, Optional ByVal p_FinalSty As String, Optional ByVal p_Situ As String, Optional ByVal pRecNo As String)
   Dim strReceiver As String, iKind As Integer, strApplicant As String
   Dim stSQL As String, rsTmp As ADODB.Recordset, intR As Integer
   
   If p_iCopy = 0 Then
   
      'Added by Morgan 2014/6/19
      '103/7/1 起有存電子信函的只要印 1 份
      'Modified by Morgan 2014/7/2 從nowprint移來
      If pRecNo <> "" Then
         If ChkIsELetter(pRecNo) = True Then
            p_iCopy = 1
            Set rsTmp = Nothing
            Exit Sub
         End If
      End If
      'end 2014/6/19
      
'Modify by Morgan 2009/4/30 改判斷信函抬頭(FCP-032016)
'      If CP01 = "FCP" Then
'         stSQL = "select fa87 from patent,fagent" & _
'            " where pa01='" & CP01 & "' and pa02='" & cp02 & "' and pa03='" & cp03 & "' and pa04='" & cp04 & "'" & _
'            " and fa01(+)=substr(pa75,1,8) and fa02(+)=substr(pa75,9,1)"
'
'      ElseIf CP01 = "FCT" Then
'         stSQL = "select fa88 from trademark,fagent" & _
'            " where tm01='" & CP01 & "' and tm02='" & cp02 & "' and tm03='" & cp03 & "' and tm04='" & cp04 & "'" & _
'            " and fa01(+)=substr(tm44,1,8) and fa02(+)=substr(tm44,9,1)"
'      Else
'         Exit Sub
'      End If
      '2011/12/15 modify by sonia 加T,TF
      'Modify By Sindy 2017/11/9 加S,CFC
      If cp01 = "FCP" Or cp01 = "FG" Or cp01 = "FCT" Or cp01 = "T" Or cp01 = "TF" Or _
         cp01 = "S" Or cp01 = "CFC" Then
         
         '2011/12/15 ADD BY SONIA 內商案件註冊證除外
         If (cp01 = "T" Or cp01 = "TF") And CP10 = "1701" Then
         '2011/12/15 END
         ElseIf ClsPDGetSystemKind(cp01, iKind) Then
            'Add by Morgan 2009/9/24 基本檔也放份數欄位
            Select Case iKind
               Case 1
                  stSQL = "select pa153,pa155,pa26 from patent where pa01='" & cp01 & "' and pa02='" & cp02 & "' and pa03='" & cp03 & "' and pa04='" & cp04 & "'"
               Case 2
                  stSQL = "select tm124,tm126,tm23 from trademark where tm01='" & cp01 & "' and tm02='" & cp02 & "' and tm03='" & cp03 & "' and tm04='" & cp04 & "'"
               Case Else
                  stSQL = "select sp81,sp83,sp08 from servicepractice where sp01='" & cp01 & "' and sp02='" & cp02 & "' and sp03='" & cp03 & "' and sp04='" & cp04 & "'"
            End Select
            intR = 1
            Set rsTmp = ClsLawReadRstMsg(intR, stSQL)
            If intR = 1 Then
               If Not IsNull(rsTmp.Fields(0)) Then
                  p_iCopy = Val("" & rsTmp.Fields(0))
               Else
            'end 2009/924
                  strApplicant = "" & rsTmp.Fields(2)
                  strReceiver = PUB_GetReceiver(cp01, cp02, cp03, cp04, CP10)
                  If Left(strReceiver, 1) = "Y" Then
                     'Add by Morgan 2009/10/14
                     '代理人為Y52013(Tsujimaru)且申請人為X47660(日東電工)時,其對外定稿信函及請款單均列印4份
                     If cp01 = "FCP" And strReceiver = "Y52013000" And strApplicant = "X47660000" Then
                        p_iCopy = 4
                     'Added by Morgan 2015/11/10
                     '代理人Y45537 (KAWAKITA & ASSOCIATES)指示其底下申請人為X45149 (NIKON CORPORATION)之案件，所有文件只寄一份。
                     ElseIf cp01 = "FCP" And strReceiver = "Y45537000" And strApplicant = "X45149000" Then
                        p_iCopy = 2
                     'end 2015/11/10
                     Else
                     'end 2009/10/14
                        If cp01 = "FCP" Or cp01 = "FG" Then
                           stSQL = "select fa87 from fagent" & _
                              " where fa01='" & Left(strReceiver, 8) & "' and fa02='" & Mid(strReceiver, 9) & "' and fa87>0"
                        Else
                           stSQL = "select fa88 from fagent" & _
                              " where fa01='" & Left(strReceiver, 8) & "' and fa02='" & Mid(strReceiver, 9) & "' and fa88>0"
                        End If
                        intR = 1
                        Set rsTmp = ClsLawReadRstMsg(intR, stSQL)
                        If intR = 1 Then
                           p_iCopy = Val("" & rsTmp.Fields(0))
                        End If
                     End If
                  'Add by Morgan 2009/9/24 客戶檔也放份數欄位
                  Else
                     If cp01 = "FCP" Or cp01 = "FG" Then
                        stSQL = "select cu133 from customer" & _
                           " where cu01='" & Left(strReceiver, 8) & "' and cu02='" & Mid(strReceiver, 9) & "' and cu133>0"
                     Else
                        stSQL = "select cu134 from customer" & _
                           " where cu01='" & Left(strReceiver, 8) & "' and cu02='" & Mid(strReceiver, 9) & "' and cu134>0"
                     End If
                     intR = 1
                     Set rsTmp = ClsLawReadRstMsg(intR, stSQL)
                     If intR = 1 Then
                        p_iCopy = Val("" & rsTmp.Fields(0))
                     End If
                  'end 2009/9/24
                  End If
               End If
            End If
         End If
         
         'ADD BY SONIA 2014/4/24 自Nowprint移過來(FCP證書函及公告函至少要兩份 --林芳如,葉敏莉,但證書函傳真封面仍維持一份)
         'Modify By Sindy 2015/12/8 Mark:淑華說”公報”取消不須加1份
         'If cp01 = "FCP" And (p_FinalSty = "07" Or p_FinalSty = "05") And p_Situ <> "98" Then
         If cp01 = "FCP" And (p_FinalSty = "07") And p_Situ <> "98" Then
            If p_iCopy = 1 Then p_iCopy = 2
            '特定代理人或申請人只要一份--SUSAN 2014/4/24
            'modify by sonia 2015/11/20 發現2015/5/8應再修改但此處漏改,取消Y20085000再加X47833000,X47833020,X17901010
            'If strReceiver = "Y52218000" Or strReceiver = "Y20085000" Or strApplicant = "X34291000" Or strApplicant = "X21382010" Then
            If strReceiver = "Y52218000" Or strApplicant = "X34291000" Or strApplicant = "X21382010" Or strApplicant = "X47833000" Or strApplicant = "X47833020" Or strApplicant = "X17901010" Then
               p_iCopy = 1
            End If
         End If
         '2014/4/24 END
      End If
   End If
   Set rsTmp = Nothing
End Sub

'Add by Morgan 2006/8/24
'從資料庫讀出檔案
Private Function ReadDB2File(ByRef p_FileName As String, Optional p_Sys As String) As Boolean
   Dim iPicNo As Integer
   Select Case p_Sys
      Case "FCT", "CFT"
         iPicNo = 1
      'Modify By Sindy 2009/07/24 增加LIN系統類別
      'modify by sonia 2019/7/31 +ACS系統類別
      Case "FCP", "FG", "FCL", "CFL", "P", "LIN", "ACS"
         iPicNo = 2
      Case "CFP", "CPS"
         iPicNo = 3
      Case Else
         iPicNo = 4
   End Select
   ReadDB2File = PUB_ReadDB2File(p_FileName, iPicNo)
End Function
'Add by Morgan 2008/5/30
'下次繳費年度
Public Function PUB_GetNextYear(p_CNo() As String, Optional p_Desc As String) As String
   Dim stSQL As String, intR As Integer
   Dim strPA08 As String, strPA09 As String, strPA72 As String
   Dim strKey(5) As String
   Dim bFind As Boolean
   Dim strCaseFee(1 To 2) As String
   Dim varPA72, varRef
   Dim ii As Integer
   Dim strFeeType As String 'Add By Sindy 2009/07/16
   Dim intFixNo As Integer  '2010/2/12 ADD BY SONIA
   Dim strPA10 As String 'Added by Morgan 2022/6/13

   p_Desc = ""
   'Modified by Morgan 2022/6/13 +PA10
   stSQL = "SELECT PA08,PA09,PA72,PA10 FROM PATENT WHERE PA01='" & p_CNo(1) & "' And PA02='" & p_CNo(2) & "' AND PA03='" & p_CNo(3) & "' AND PA04='" & p_CNo(4) & "'"
   intR = 1
   Set AdoRecordSet3 = ClsLawReadRstMsg(intR, stSQL)
   With AdoRecordSet3
   If intR = 1 Then
      strPA08 = "" & .Fields("PA08")
      strPA09 = "" & .Fields("PA09")
      strPA72 = "" & .Fields("PA72")
      strPA10 = "" & .Fields("PA10") 'Added by Morgan 2022/6/13
      strKey(0) = ""
      strKey(1) = p_CNo(1)
      strKey(2) = p_CNo(2)
      strKey(3) = p_CNo(3)
      strKey(4) = p_CNo(4)
      '2010/2/12 MODIFY BY SONIA 抓修法次數
      'bFind = GetMoneyDate(strPA08, strPA09, strKey, strCaseFee(1), strCaseFee(2))
      bFind = GetMoneyDate(strPA08, strPA09, strKey, strCaseFee(1), strCaseFee(2), , , intFixNo)
      If bFind Then
         '尋找下次繳年費的位置
         '若已有繳費記錄
         If IsEmptyText(strPA72) = False Then
            varPA72 = Split(strPA72, ",")
            If IsEmptyText(strCaseFee(2)) = False Then
               varRef = Split(strCaseFee(2), ",")
               For ii = LBound(varRef) To UBound(varRef)
                  If Val(varPA72(UBound(varPA72))) < Val(varRef(ii)) Then
                       PUB_GetNextYear = varRef(ii)
                       Exit For
                  End If
               Next ii
            End If
         '若無繳費記錄
         Else
            If IsEmptyText(strCaseFee(2)) = False Then
                varRef = Split(strCaseFee(2), ",")
                PUB_GetNextYear = varRef(LBound(varRef))
            End If
         End If
      End If
            
      If PUB_GetNextYear = "" Then Exit Function 'Add by Morgan 2010/5/7

      'Add By Sindy 2009/07/16
      '年度說明
      'Modified by Morgan 2022/6/13 +strPA10
      strFeeType = PUB_GetNa20Na22Na24(strPA09, strPA08, strPA10)
      '2010/2/12 MODIFY BY SONIA
      'p_Desc = PUB_GetYF15(strPA09, strPA08, "Y0000000", strFeeType, CDbl(PUB_GetNextYear))
      'Added by Morgan 2013/8/23 印尼年費第1次為發證日後1年繳已使用完的年費Ex.CFP-23499 申請日 99/10/20 發證日 101/7/12 第1次繳費期限 102/7/12 須繳 99/10/20-101/10/19 1-2年年費
      If strPA09 = "017" And strFeeType = "605" And strPA72 = "" Then
         p_Desc = PUB_GetXDesc(p_CNo(1), p_CNo(2), p_CNo(3), p_CNo(4))
      'Added by Morgan 2025/3/18
      '2024/10/5起俄羅斯發明及新型年費改一次繳5年
      ElseIf strPA09 = "023" And strFeeType = "605" And (strPA08 = "1" Or strPA08 = "2") And Val(PUB_GetNextYear) Mod 5 <> 0 Then
         intR = 5 * (Val(PUB_GetNextYear) \ 5 + 1)
         p_Desc = "第" & PUB_GetNextYear & "-" & intR & "年"
      'end 2025/3/18
      Else
      'end 2013/8/23
         p_Desc = PUB_GetYF15(strPA09, strPA08, "Y000000" & intFixNo, strFeeType, CDbl(PUB_GetNextYear))
      End If 'Added by Morgan 2013/8/23
      '2009/07/16 End

'      '2008/8/22 add by sonia 019泰國新型第7年年費,通知函改為第7至8年,因第8年不用繳
'      If strPA08 = "2" And strPA09 = "019" Then
'         Select Case PUB_GetNextYear
'            Case "7"
'               p_Desc = "7至8"
'            Case "9"                '2008/9/2 add by sonia泰國新型第9年年費,通知函改為第9至10年
'               p_Desc = "9至10"
'         End Select
'      End If
'      '2008/8/22 end
'      '2008/9/2 add by sonia 012韓國新型第2年年費,通知函改為第2至3年,因第3年不用繳
'      If strPA08 = "2" And strPA09 = "012" Then
'         Select Case PUB_GetNextYear
'            Case "2"
'               p_Desc = "2至3"
'         End Select
'      End If
'      '2008/8/22 end
   End If
   End With
End Function
'Add By Cheng 2003/01/28
'批次列印地址條
'Modify By Cheng 2003/06/06
'Public Sub PUB_PrintAddressList(strAL01 As String, strPrinterName As String)
Public Sub PUB_PrintAddressList(strAL01 As String, strPrinterName As String, Optional blnDelRepeat As Boolean = False)
'blnDelRepeat : 是否刪除屬於相同代理人或申請人的地址條資料
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset
'Add By Cheng 2003/06/06
Dim strFaCuNo As String '記錄代理人或申請人代號
    
    'Add By Cheng 2003/06/06
    If blnDelRepeat = True Then
        'Modified by Lydia 2019/04/02 PK: 使用者帳號@電腦名稱(pub_HostName)
        'Modify By Sindy 2021/3/30 + , AL09, AL10
        StrSQLa = "Select Nvl(PA75, PA26), PA01, PA02, PA03, PA04, AL06, AL09, AL10 From AddressList, Patent Where AL02=PA01 And AL03=PA02 And AL04=PA03 And AL05=PA04 And AL01='" & strAL01 & "@" & pub_HostName & "' "
        StrSQLa = StrSQLa & " UNION Select Nvl(TM44, TM23), TM01, TM02, TM03, TM04, AL06, AL09, AL10 From AddressList, Trademark Where AL02=TM01 And AL03=TM02 And AL04=TM03 And AL05=TM04 And AL01='" & strAL01 & "@" & pub_HostName & "' "
        StrSQLa = StrSQLa & " UNION Select Nvl(LC22, LC11), LC01, LC02, LC03, LC04, AL06, AL09, AL10 From AddressList, Lawcase Where AL02=LC01 And AL03=LC02 And AL04=LC03 And AL05=LC04 And AL01='" & strAL01 & "@" & pub_HostName & "' "
        StrSQLa = StrSQLa & " UNION Select Nvl('', HC05), HC01, HC02, HC03, HC04, AL06, AL09, AL10 From AddressList, Hirecase Where AL02=HC01 And AL03=HC02 And AL04=HC03 And AL05=HC04 And AL01='" & strAL01 & "@" & pub_HostName & "' "
        StrSQLa = StrSQLa & " UNION Select Nvl(SP26, SP08), SP01, SP02, SP03, SP04, AL06, AL09, AL10 From AddressList, ServicePractice Where AL02=SP01 And AL03=SP02 And AL04=SP03 And AL05=SP04 And AL01='" & strAL01 & "@" & pub_HostName & "' "
        'end 2019/04/02
        '2007/9/13 MODIFY BY SONIA 加入 AL06排序
        StrSQLa = StrSQLa & " Order By 1,AL06 "
        rsA.CursorLocation = adUseClient
        rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
        If rsA.RecordCount > 0 Then
            strFaCuNo = " "
            While Not rsA.EOF
                '若代理人或申請人不同
                If strFaCuNo <> "" & rsA.Fields(0).Value Then
                    strFaCuNo = "" & rsA.Fields(0).Value
                '若代理人或申請人相同
                Else
                    'Modified by Lydia 2019/04/02 PK: 使用者帳號@電腦名稱(pub_HostName)
                    StrSQLa = "Delete From AddressList Where AL01='" & strAL01 & "@" & pub_HostName & "' And AL02='" & rsA.Fields(1).Value & "' And AL03='" & rsA.Fields(2).Value & "' And AL04='" & rsA.Fields(3).Value & "' And AL05='" & rsA.Fields(4).Value & "' And AL06=" & rsA.Fields(5).Value
                    cnnConnection.Execute StrSQLa
                End If
                rsA.MoveNext
            Wend
        End If
        If rsA.State <> adStateClosed Then rsA.Close
        Set rsA = Nothing
    End If
    'Modified by Lydia 2019/04/02 PK: 使用者帳號@電腦名稱(pub_HostName)
    'Modify By Sindy 2021/3/30 + , AL09, AL10
    StrSQLa = "Select PA75, PA26, PA01, PA02, PA03, PA04, AL06, AL09, AL10 From AddressList, Patent Where AL02=PA01 And AL03=PA02 And AL04=PA03 And AL05=PA04 And AL01='" & strAL01 & "@" & pub_HostName & "' "
    StrSQLa = StrSQLa & " UNION Select TM44, TM23, TM01, TM02, TM03, TM04, AL06, AL09, AL10 From AddressList, Trademark Where AL02=TM01 And AL03=TM02 And AL04=TM03 And AL05=TM04 And AL01='" & strAL01 & "@" & pub_HostName & "' "
    StrSQLa = StrSQLa & " UNION Select LC22, LC11, LC01, LC02, LC03, LC04, AL06, AL09, AL10 From AddressList, Lawcase Where AL02=LC01 And AL03=LC02 And AL04=LC03 And AL05=LC04 And AL01='" & strAL01 & "@" & pub_HostName & "' "
    StrSQLa = StrSQLa & " UNION Select '', HC05, HC01, HC02, HC03, HC04, AL06, AL09, AL10 From AddressList, Hirecase Where AL02=HC01 And AL03=HC02 And AL04=HC03 And AL05=HC04 And AL01='" & strAL01 & "@" & pub_HostName & "' "
    StrSQLa = StrSQLa & " UNION Select SP26, SP08, SP01, SP02, SP03, SP04, AL06, AL09, AL10 From AddressList, ServicePractice Where AL02=SP01 And AL03=SP02 And AL04=SP03 And AL05=SP04 And AL01='" & strAL01 & "@" & pub_HostName & "' "
    'end 2019/04/02
    StrSQLa = StrSQLa & " Order By AL06 "
    rsA.CursorLocation = adUseClient
    rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
    '若有地址條資料
    If rsA.RecordCount > 0 Then
        '設定為整批列印地址條
        pub_blnBatchPrintAddress = True
        '載入表單
        Load frm083014: DoEvents
        '隱藏表單
        frm083014.Hide
        '設定印表機
        frm083014.SetPrinter strPrinterName
        '列印份數
        frm083014.Text1(3).Text = "1"
        '是否含不寄雜誌的對象
        frm083014.Text1(5).Text = "Y"
        'Add By Sindy 2021/3/30
        '指定收件人
        If "" & rsA.Fields("AL09") <> "" Then
            If Left(rsA.Fields("AL09"), 1) = "X" Then
               frm083014.Opt1(0).Value = True
               frm083014.Text1(0).Text = ChangeCustomerL(rsA.Fields("AL09"))
            ElseIf Left(rsA.Fields("AL09"), 1) = "Y" Then
               frm083014.Opt1(1).Value = True
               frm083014.Text1(1).Text = ChangeCustomerL(rsA.Fields("AL09"))
            End If
        End If
        '聯絡人名稱1
        If "" & rsA.Fields("AL10") <> "" Then
            'Modified by Lydia 2024/05/07 變更欄位Text1(13)=>textFM2(0)
            frm083014.textFM2(0).Text = rsA.Fields("AL10")
        End If
        '2021/3/30 END
        '執行列印
        frm083014.cmdPrint_Click: DoEvents
    End If
    Do While pub_blnBatchPrintAddress = True
    Loop
    '退出
    
   'Added by Morgan 2012/10/3 若逾時候重新登入需重抓資料
   If rsA.State = adStateClosed Then
      rsA.CursorLocation = adUseClient
      rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
   End If
   'end 2012/10/3
      
    If rsA.RecordCount > 0 Then frm083014.cmdBack_Click: DoEvents
    If rsA.State <> adStateClosed Then rsA.Close
    Set rsA = Nothing
End Sub

'Add by Morgan 2008/12/11
'下次繳費次數
Public Function PUB_GetNextTime(p_CNo() As String, Optional p_Desc As String) As String
   Dim stSQL As String, intR As Integer, strRtn As String
   Dim strPA08 As String, strPA09 As String, strPA72 As String
   Dim strKey(5) As String
   Dim bFind As Boolean
   Dim strCaseFee(1 To 2) As String
   Dim varPA72, varRef
   Dim ii As Integer
   'Add By Sindy 2009/07/16
   Dim strYear As String
   Dim strFeeType As String
   '2009/07/16 End
   Dim intFixNo As Integer
   Dim strPA10 As String 'Added by Morgan 2022/6/13
   
   p_Desc = ""
   'Modified by Morgan 2022/6/13 +PA10
   stSQL = "SELECT PA08,PA09,PA72,PA10 FROM PATENT WHERE PA01='" & p_CNo(1) & "' And PA02='" & p_CNo(2) & "' AND PA03='" & p_CNo(3) & "' AND PA04='" & p_CNo(4) & "'"
   intR = 1
   Set RsTemp = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      If IsNull(RsTemp.Fields("PA08")) = False Then strPA08 = RsTemp.Fields("PA08")
      If IsNull(RsTemp.Fields("PA09")) = False Then strPA09 = RsTemp.Fields("PA09")
      If IsNull(RsTemp.Fields("PA72")) = False Then strPA72 = RsTemp.Fields("PA72")
      strPA10 = "" & RsTemp.Fields("PA10") 'Added by Morgan 2022/6/13
      strKey(0) = ""
      strKey(1) = p_CNo(1)
      strKey(2) = p_CNo(2)
      strKey(3) = p_CNo(3)
      strKey(4) = p_CNo(4)
      bFind = GetMoneyDate(strPA08, strPA09, strKey, strCaseFee(1), strCaseFee(2), , p_CNo(5), intFixNo)
      If bFind Then
         ' 尋找下次繳費的位置
         '若已有繳費記錄
         If IsEmptyText(strPA72) = False Then
              varPA72 = Split(strPA72, ",")
              If IsEmptyText(strCaseFee(2)) = False Then
                 varRef = Split(strCaseFee(2), ",")
                 For ii = LBound(varRef) To UBound(varRef)
                     If Val(varPA72(UBound(varPA72))) < Val(varRef(ii)) Then
                          strYear = Val(varRef(ii)) 'Add By Sindy 2009/07/16
                          strRtn = ii + 1
                          Exit For
                     End If
                 Next ii
              End If
          '若無繳費記錄
          Else
              If IsEmptyText(strCaseFee(2)) = False Then
                  'Add By Sindy 2009/07/16
                  varRef = Split(strCaseFee(2), ",")
                  strYear = Val(varRef(0))
                  '2009/07/16 End
                  strRtn = 1
              End If
         End If
      End If
   End If

   'Add By Sindy 2009/07/16
   '年度說明
   If Val(strYear) > 0 Then 'Add by Morgan 2009/11/5 要判斷有年度
      'Modified by Morgan 2022/6/13 +strPA10
      strFeeType = PUB_GetNa20Na22Na24(strPA09, strPA08, strPA10)
      'Modify by Morgan 2009/11/5 若有修法時改抓修法次數對應的代理人編號
      'p_Desc = PUB_GetYF15(strPA09, strPA08, "Y0000000", strFeeType, CDbl(strYear))
      p_Desc = PUB_GetYF15(strPA09, strPA08, "Y000000" & intFixNo, strFeeType, CDbl(strYear))
   End If
   
   '2009/07/16 End

'   '92.9.17 add by sonia
'   If strPA09 = "101" Then
'      Select Case strRtn
'         Case 1
'            p_Desc = "1次(第5~8年)"
'         Case 2
'            p_Desc = "2次(第9~12年)"
'         Case 3
'            p_Desc = "3次(第13年~專用期屆滿)"
'      End Select
'   End If
'   '92.9.17 end
'   '2007/6/1 ADD BY SONIA
'   If strPA09 = "231" Then
'      Select Case strPA08
'         Case "2"
'            Select Case strRtn
'               Case 1
'                  p_Desc = "1次(第4~6年)"
'               Case 2
'                  p_Desc = "2次(第7~8年)"
'               Case 3
'                  p_Desc = "3次(第9年~專用期屆滿)"
'            End Select
'         Case "3"
'            Select Case strRtn
'               Case 1
'                  p_Desc = "1次(第6~10年)"
'               Case 2
'                  p_Desc = "2次(第11~15年)"
'               Case 3
'                  p_Desc = "3次(第16~20年)"
'               Case 4
'                  p_Desc = "4次(第20年~專用期屆滿)"
'            End Select
'      End Select
'   End If
   PUB_GetNextTime = strRtn
End Function
'Add by Morgan 2010/3/17
'新穎性優惠期
Public Function PUB_GetFavorDate(p_PA91 As String) As String
   Dim iPos1 As Integer, iPos2 As Integer, strReturn As String
   iPos1 = InStr(p_PA91, "新穎性優惠期日期")
   If iPos1 > 0 Then
      iPos2 = InStr(iPos1, p_PA91, ";")
      If iPos2 > iPos1 + 8 Then
         strReturn = Mid(p_PA91, iPos1 + 8, iPos2 - iPos1 - 8)
         If IsNumeric(strReturn) Then
            strReturn = strReturn
         Else
            strReturn = ""
         End If
      End If
   End If
   PUB_GetFavorDate = strReturn
End Function
'Added by Morgan 2020/7/29
'是否 PCT案By Pass
Public Function PUB_IsPCTByPass(p_PA91 As String) As Boolean
   If InStr(p_PA91, "PCT案 by pass") > 0 Then
      PUB_IsPCTByPass = True
   End If
End Function
'PCT優先權日
Public Function PUB_GetPCTPriDate(p_PA91 As String) As String
   Dim iPos1 As Integer, iPos2 As Integer, strReturn As String
   iPos1 = InStr(p_PA91, "PCT優先權日")
   If iPos1 > 0 Then
      iPos2 = InStr(iPos1, p_PA91, ";")
      If iPos2 > iPos1 + 7 Then
         strReturn = Mid(p_PA91, iPos1 + 7, iPos2 - iPos1 - 7)
         If IsNumeric(strReturn) Then
            strReturn = TransDate(strReturn, 2)
         Else
            strReturn = ""
         End If
      End If
   End If
   PUB_GetPCTPriDate = strReturn
End Function

'Add by Morgan 2009/11/30 PCT申請號
Public Function PUB_GetPCTPriNo(p_PA91 As String) As String
   Dim iPos1 As Integer, iPos2 As Integer, strReturn As String
   iPos1 = InStr(p_PA91, "PCT申請號")
   If iPos1 > 0 Then
      iPos2 = InStr(iPos1, p_PA91, ";")
      If iPos2 > iPos1 + 6 Then
         strReturn = Mid(p_PA91, iPos1 + 6, iPos2 - iPos1 - 6)
      End If
   End If
   PUB_GetPCTPriNo = strReturn
End Function

'Add by Morgan 2010/2/23
'設定作業系統印表機為程式目前印表機
Public Sub PUB_SetOsPrtAsApp()
   pub_OsPrinter = PUB_GetOsDefaultPrinter
   pub_AppPrinter = Printer.DeviceName
   If pub_OsPrinter <> pub_AppPrinter Then
      PUB_SetOsDefaultPrinter pub_AppPrinter
   End If
End Sub

'Add by Morgan 2010/2/3
'---------------------------------------------------------------
' 取得作業系統預設印表機名稱
'---------------------------------------------------------------
Public Function PUB_GetOsDefaultPrinter() As String
    Dim strBuffer As String * 254
    Dim iRetValue As Long
    Dim strDefaultPrinterInfo As String
    Dim tblDefaultPrinterInfo() As String
    Dim objPrinter As Printer

    ' Retreive current default printer information
    iRetValue = GetProfileString("windows", "device", ",,,", strBuffer, 254)
    strDefaultPrinterInfo = Left(strBuffer, InStr(strBuffer, Chr(0)) - 1)
    tblDefaultPrinterInfo = Split(strDefaultPrinterInfo, ",")
    For Each objPrinter In Printers
        If objPrinter.DeviceName = tblDefaultPrinterInfo(0) Then
            ' Default printer found !
            PUB_GetOsDefaultPrinter = objPrinter.DeviceName
            Exit For
        End If
    Next
    Set objPrinter = Nothing
End Function

'Add by Morgan 2010/2/3
'設定作業系統預設印表機
Public Sub PUB_SetOsDefaultPrinter(strPrinter As String)
   Dim idx As Integer, strTmpPrinter As String
   If strPrinter <> "" Then
      strTmpPrinter = PUB_GetOsDefaultPrinter
      If strPrinter <> strTmpPrinter Then
         '檢查有存在才做
         For idx = 0 To Printers.Count - 1
            If Printers(idx).DeviceName = strPrinter Then
               strTmpPrinter = Printer.DeviceName 'Added by Morgan 2017/9/30 Win7下若未讀取 DeviceName 就將 TrackDefault 設 False 後來再讀 DeviceName 就會有 484 錯誤
               Printer.TrackDefault = False
               CreateObject("WScript.Network").SetDefaultPrinter strPrinter
               'Modified by Morgan 2025/9/11 換變數
               'pub_OsPrinter = strPrinter 'Added by Morgan 2025/9/3
               pub_OsPrinterA = strPrinter
               'end 2025/9/11
               Exit For
            End If
         Next
      End If
   End If
End Sub

'Add by Morgan 2010/2/23
'還原作業系統的預設印表機
Public Sub PUB_RestoreOsPrt()
   PUB_SetOsDefaultPrinter pub_OsPrinter
End Sub
'Add by Morgan 2010/5/25
'最大追加號(集體設計)
'Modified by Morgan 2025/7/29 +bolAll:所有國家(英國只有發文通知函合併其他都各案通知--禧佩)
Private Function GetMaxPA03(stPA01 As String, stPA02 As String, stPA04 As String, Optional bolAll As Boolean = False) As String
   Dim stSQL As String, intR As Integer
   Dim adoRst As ADODB.Recordset
   'modify by sonia 2016/8/11 +韓國012 CFP-028750
   'stSQL = "select pa03 from patent where pa01='" & stPA01 & "' and pa02='" & stPA02 & "' and pa04='" & stPA04 & "' and pa09='239' order by pa03 desc"
   'Modified by Morgan 2018/4/11 排除已閉卷案 Ex:CFP-030191 --禧佩
   'Modified by Morgan 2023/3/23 +日本011 Ex:CFP-033709
   'Modified by Morgan 2025/7/21 +英國201 Ex:CFP-035264--禧佩
   stSQL = "select pa03 from patent where pa01='" & stPA01 & "' and pa02='" & stPA02 & "' and pa04='" & stPA04 & "' and pa08='3' and pa09 in ('239','012','011'" & IIf(bolAll, ",'201'", "") & ") and pa57 is null order by pa03 desc"
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      If adoRst(0) <> "0" Then
         GetMaxPA03 = "-0~" & adoRst(0)
      End If
   End If
   Set adoRst = Nothing
End Function
'Add by Morgan 2010/5/25
'集體(設計)
Private Function GetPatentTypeName(stPA01 As String, stPA02 As String, stPA04 As String) As String
   Dim stSQL As String, intR As Integer
   Dim adoRst As ADODB.Recordset
   'modify by sonia 2016/8/11 +韓國012 CFP-028750
   'stSQL = "select pa03 from patent where pa01='" & stPA01 & "' and pa02='" & stPA02 & "' and pa04='" & stPA04 & "' and pa09='239' order by pa03 desc"
   'Modified by Morgan 2023/3/23 +日本011 CFP-033709
   'Modified by Morgan 2025/7/29 +英國201 Ex:CFP-035264--禧佩
   stSQL = "select pa03 from patent where pa01='" & stPA01 & "' and pa02='" & stPA02 & "' and pa04='" & stPA04 & "' and pa08='3' and pa09 in ('239','012','011','201') order by pa03 desc"
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      If adoRst(0) <> "0" Then
         GetPatentTypeName = "集體"
      End If
   End If
   Set adoRst = Nothing
End Function
'Add by Morgan 2021/3/15
'最大申請號(集體設計),先控制歐盟(考慮送件順序有誤,用申請案號排序 Ex:CFP-32148)--玫音
Private Function GetMaxPatentAppNo(stPA01 As String, stPA02 As String, stPA04 As String) As String
   Dim stSQL As String, intR As Integer
   Dim adoRst As ADODB.Recordset
   stSQL = "select pa03,pa11 from patent where pa01='" & stPA01 & "' and pa02='" & stPA02 & "' and pa04='" & stPA04 & "' and pa09='239' and pa11 is not null  order by pa11 desc"
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      If adoRst(0) <> "0" Then
         GetMaxPatentAppNo = "~" & Right(adoRst(1), 4)
      End If
   End If
   Set adoRst = Nothing
End Function

'Add by Morgan 2010/5/25
'最大證書號(集體設計)
Private Function GetMaxPatentNo(stPA01 As String, stPA02 As String, stPA04 As String) As String
   Dim stSQL As String, intR As Integer
   Dim adoRst As ADODB.Recordset
   'modify by sonia 2016/8/11 +韓國012 CFP-028750
   'stSQL = "select pa03,pa22 from patent where pa01='" & stPA01 & "' and pa02='" & stPA02 & "' and pa04='" & stPA04 & "' and pa09='239' order by pa03 desc"
   'Modified by Morgan 2018/4/11 +pa22 is not null
   stSQL = "select pa03,pa22 from patent where pa01='" & stPA01 & "' and pa02='" & stPA02 & "' and pa04='" & stPA04 & "' and pa08='3' and pa09 in ('239','012') and pa22 is not null  order by pa03 desc"
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      If adoRst(0) <> "0" Then
         GetMaxPatentNo = "~" & Right(adoRst(1), 4)
      End If
   End If
   Set adoRst = Nothing
End Function

'Add by Morgan 2011/4/28
'最大公告號(集體設計)
Private Function GetMaxPublicNo(stPA01 As String, stPA02 As String, stPA04 As String) As String
   Dim stSQL As String, intR As Integer
   Dim adoRst As ADODB.Recordset
   'modify by sonia 2016/8/11 +韓國012 CFP-028750
   'stSQL = "select pa03,pa15 from patent where pa01='" & stPA01 & "' and pa02='" & stPA02 & "' and pa04='" & stPA04 & "' and pa09='239' order by pa03 desc"
   'Modified by Morgan 2018/4/11 +pa15 is not null
   stSQL = "select pa03,pa15 from patent where pa01='" & stPA01 & "' and pa02='" & stPA02 & "' and pa04='" & stPA04 & "' and pa08='3' and pa09 in ('239','012') and pa15 is not null order by pa03 desc"
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      If adoRst(0) <> "0" Then
         GetMaxPublicNo = "~" & Right(adoRst(1), 4)
      End If
   End If
   Set adoRst = Nothing
End Function

'Add by Morgan 2010/11/11
Public Function PUB_LeftB(ByVal pString As String, ByVal pLen As Single, Optional pNormal As Boolean = True) As String
   Dim strOut As String
   Dim ii As Integer
   
   If pNormal Then
      For ii = 1 To Len(pString)
         strOut = Left(pString, ii)
         If LenB(StrConv(strOut, vbFromUnicode)) > pLen Then
            Exit For
         Else
            PUB_LeftB = strOut
         End If
      Next
   Else
      PUB_LeftB = StrConv(MidB(StrConv(pString, vbFromUnicode), 1, pLen), vbUnicode)
   End If
End Function
'Add by Morgan 2010/12/17
'CF代理人代表信箱
Public Function PUB_GetCFAgentEMail(pCP09 As String) As String
   Dim stMailBox As String
   Dim stSQL As String, intR As Integer
   Dim adoRst As ADODB.Recordset
   stSQL = "select fa16 from caseprogress,fagent where CP09='" & pCP09 & "' and fa01(+)=substr(cp44,1,8) and fa02(+)=substr(cp44,9)"
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      stMailBox = "" & adoRst.Fields(0)
      'Add by Morgan 2011/8/17 抓第一個信箱
      If InStr(stMailBox, ";") > 0 Then
         stMailBox = Left(stMailBox, InStr(stMailBox, ";") - 1)
      End If
      
      PUB_GetCFAgentEMail = stMailBox
   End If
   Set adoRst = Nothing
End Function

'Add by Morgan 2011/6/23
'Modify by Amy 2013/10/31 +判斷FC代理人(pa75)有設帳款處理情形(fa103)者，pBillNo回傳空值
'檢查案件6個月以上未收款
Public Function PUB_GetUnPaidBill(pCP01 As String, pCP02 As String, pCP03 As String, pCP04 As String, Optional pBillNo As String) As Boolean
   Dim stSQL As String, iR As Integer
   Dim adoRst As ADODB.Recordset
   Dim strDizhang As String 'Add by Amy 2013/10/31
   
   pBillNo = ""
   'Modified by Morgan 2011/11/15 +排除已銷帳
   'Modified by Morgan 2012/6/13 +判斷請款單與基本檔相同代理人
   'Modify by Amy 2013/10/31 +pa75
'   stSQL = "select a1k01 from acc1k0,patent where a1k13='" & pCP01 & "' and a1k14='" & pCP02 & "' and a1k15='" & IIf(pCP03 = "", "0", pCP03) & "' and a1k16='" & IIf(pCP04 = "", "00", pCP04) & "'" & _
'      " and a1k12 is null and a1k29 is null and a1k25 is null and a1k02+19110000<to_char(add_months(sysdate,-6),'yyyymmdd') and pa01(+)=a1k13 and pa02(+)=a1k14 and pa03(+)=a1k15 and pa04(+)=a1k16 and substr(pa75,1,8)=substr(a1k03,1,8)"
   'Modified by Morgan 2013/12/30 排除有設定不催款者(FA101='N')--David,帳款處理情形也要判斷 a1k28--秀玲
   'stSQL = "select a1k01,pa75 from acc1k0,patent where a1k13='" & pCP01 & "' and a1k14='" & pCP02 & "' and a1k15='" & IIf(pCP03 = "", "0", pCP03) & "' and a1k16='" & IIf(pCP04 = "", "00", pCP04) & "'" & _
      " and a1k12 is null and a1k29 is null and a1k25 is null and a1k02+19110000<to_char(add_months(sysdate,-6),'yyyymmdd') and pa01(+)=a1k13 and pa02(+)=a1k14 and pa03(+)=a1k15 and pa04(+)=a1k16 and substr(pa75,1,8)=substr(a1k03,1,8)"
   stSQL = "select a1k01,a1k28 from acc1k0,patent,fagent where a1k13='" & pCP01 & "' and a1k14='" & pCP02 & "' and a1k15='" & IIf(pCP03 = "", "0", pCP03) & "' and a1k16='" & IIf(pCP04 = "", "00", pCP04) & "'" & _
      " and a1k12 is null and a1k29 is null and a1k25 is null and a1k02+19110000<to_char(add_months(sysdate,-6),'yyyymmdd') and pa01(+)=a1k13 and pa02(+)=a1k14 and pa03(+)=a1k15 and pa04(+)=a1k16 and substr(pa75,1,8)=substr(a1k03,1,8)" & _
      " and fa01(+)=substr(a1k28,1,8) and fa02(+)=substr(a1k28,9) and fa101 is null"
   'Added by Morgan 2023/2/13 Murgitroyd相關編號FCP案程序階段不帶出催款段落及未付款項之帳單
   stSQL = stSQL & " and not (a1k13='FCP' and instr('Y2099000,Y2099001,Y2099002,Y2099003,Y2099004,Y2099005,Y20990B8,Y2099800,Y52527000,Y5262600,Y2099006,Y5338300,Y20990B7,Y3253900,Y5241200',fa01)>0)"
   'end 2023/2/13
   iR = 1
   Set adoRst = ClsLawReadRstMsg(iR, stSQL)
   If iR = 1 Then
      PUB_GetUnPaidBill = True
      With adoRst
       
       'Modify by Amy 2013/10/31 +判斷FC代理人(pa75)有設帳款處理情形(fa103)者，pBillNo回傳空值
        'Modified by Morgan 2013/12/30
        'strDizhang = GetDizhang(.Fields("pa75"), , False, 2)
        strDizhang = GetDizhang(.Fields("a1k28"), , False, 2)
        If strDizhang = "" Then
            pBillNo = .Fields("a1k01")
            .MoveNext
            Do While Not .EOF
               'Added by Morgan 2013/12/30 改判斷a1k28所以回圈內也要
               strDizhang = GetDizhang(.Fields("a1k28"), , False, 2)
               If strDizhang <> "" Then
                  pBillNo = ""
                  PUB_GetUnPaidBill = False
                  Exit Do
               End If
               'end 2013/12/30
               pBillNo = pBillNo & "," & .Fields("a1k01")
               .MoveNext
            Loop
        'ADD BY SONIA 2013/11/12
        Else
            PUB_GetUnPaidBill = False
        '2013/11/12 END
        End If 'end 2013/10/31
      End With
   End If
   Set adoRst = Nothing
End Function

'Added by Morgan 2011/11/28
Public Function PUB_GetEngPayYear(pFromYear As String, pToYear As String) As String
   Dim iFromYear As Integer, iToYear As Integer
   Dim strAnnuity As String
   
   iFromYear = Val(pFromYear)
   iToYear = Val(pToYear)
      
   If iFromYear > 0 And iToYear > 0 Then
      If iToYear > iFromYear Then
         Select Case iFromYear
            Case 1
               strAnnuity = iFromYear & "st to "
            Case 2
               strAnnuity = iFromYear & "nd to "
            Case 3
               strAnnuity = iFromYear & "rd to "
            Case Else
               strAnnuity = iFromYear & "th to "
         End Select
      End If
      
      Select Case iToYear
         Case 1
            strAnnuity = strAnnuity & iToYear & "st"
         Case 2
            strAnnuity = strAnnuity & iToYear & "nd"
         Case 3
            strAnnuity = strAnnuity & iToYear & "rd"
         Case Else
            strAnnuity = strAnnuity & iToYear & "th"
      End Select
      
      PUB_GetEngPayYear = strAnnuity
   End If
   
End Function

'Added by Morgan 2011/11/30 Email字元過濾
Public Sub PUB_EMailFilter(ByRef pKeyCode As Integer)
   Dim stChar As String
   stChar = Chr(pKeyCode)
   If stChar = "," Or stChar = "[" Or stChar = "]" Or stChar = "!" Or stChar = "(" Or stChar = ")" Or stChar = "=" Or stChar = "\" _
      Or stChar = "/" Or stChar = "<" Or stChar = ">" Or stChar = "$" Or stChar = "%" Or stChar = "^" Or stChar = "*" Or stChar = " " Then
      pKeyCode = 0
      If stChar = " " Then stChar = "空白"
      MsgBox "EMail 不允許包含【 " & stChar & " 】符號！"
   End If
End Sub

'*************************************************
'  工具列按鈕失效設定1
'
'*************************************************
Public Sub tool1_enabled()
   With Forms(0)
      .Toolbar1.Buttons.Item(1).Enabled = True
      .Toolbar1.Buttons.Item(4).Enabled = True
      .Toolbar1.Buttons.Item(5).Enabled = True
      .Toolbar1.Buttons.Item(6).Enabled = False
      .Toolbar1.Buttons.Item(7).Enabled = False
      .Toolbar1.Buttons.Item(8).Enabled = True
      .Toolbar1.Buttons.Item(9).Enabled = True
      .Toolbar1.Buttons.Item(10).Enabled = True
      'Added by Morgan 2023/7/27
      If m_ToolBarNobrowse Then
         .Toolbar1.Buttons.Item(13).Enabled = False
         .Toolbar1.Buttons.Item(14).Enabled = False
         .Toolbar1.Buttons.Item(15).Enabled = False
         .Toolbar1.Buttons.Item(16).Enabled = False
      Else
      'end 2023/7/27
         .Toolbar1.Buttons.Item(13).Enabled = True
         .Toolbar1.Buttons.Item(14).Enabled = True
         .Toolbar1.Buttons.Item(15).Enabled = True
         .Toolbar1.Buttons.Item(16).Enabled = True
      End If 'Added by Morgan 2023/7/27
      '2015/10/21 add by sonia 加入總經理權限(等級01),可使用所有程式,但維護程式只有查詢功能,不可新增刪除修改)
      If PUB_GetST05(strUserNum) = "01" Then
         .Toolbar1.Buttons.Item(4).Enabled = False
         .Toolbar1.Buttons.Item(5).Enabled = False
         .Toolbar1.Buttons.Item(8).Enabled = False
      End If
      '2015/10/21 end
   End With
End Sub

'*************************************************
'  工具列按鈕失效設定2
'
'*************************************************
Public Sub tool2_enabled()
   With Forms(0)
      .Toolbar1.Buttons.Item(1).Enabled = False
      .Toolbar1.Buttons.Item(4).Enabled = False
      .Toolbar1.Buttons.Item(5).Enabled = False
      .Toolbar1.Buttons.Item(6).Enabled = True
      .Toolbar1.Buttons.Item(7).Enabled = True
      .Toolbar1.Buttons.Item(8).Enabled = False
      .Toolbar1.Buttons.Item(9).Enabled = False
      .Toolbar1.Buttons.Item(10).Enabled = False
      .Toolbar1.Buttons.Item(13).Enabled = False
      .Toolbar1.Buttons.Item(14).Enabled = False
      .Toolbar1.Buttons.Item(15).Enabled = False
      .Toolbar1.Buttons.Item(16).Enabled = False
   End With
End Sub

'*************************************************
'  工具列按鈕失效設定3
'
'*************************************************
Public Sub tool3_enabled()
   With Forms(0)
      .Toolbar1.Buttons.Item(1).Enabled = True
      .Toolbar1.Buttons.Item(4).Enabled = False
      .Toolbar1.Buttons.Item(5).Enabled = False
      .Toolbar1.Buttons.Item(6).Enabled = False
      .Toolbar1.Buttons.Item(7).Enabled = False
      .Toolbar1.Buttons.Item(8).Enabled = False
      .Toolbar1.Buttons.Item(9).Enabled = False
      .Toolbar1.Buttons.Item(10).Enabled = False
      .Toolbar1.Buttons.Item(13).Enabled = False
      .Toolbar1.Buttons.Item(14).Enabled = False
      .Toolbar1.Buttons.Item(15).Enabled = False
      .Toolbar1.Buttons.Item(16).Enabled = False
   End With
End Sub

'*************************************************
'  工具列按鈕失效設定4
'
'*************************************************
Public Sub tool4_enabled()
   With Forms(0)
      .Toolbar1.Buttons.Item(1).Enabled = False
      .Toolbar1.Buttons.Item(4).Enabled = False
      .Toolbar1.Buttons.Item(5).Enabled = False
      .Toolbar1.Buttons.Item(6).Enabled = False
      .Toolbar1.Buttons.Item(7).Enabled = False
      .Toolbar1.Buttons.Item(8).Enabled = False
      .Toolbar1.Buttons.Item(9).Enabled = False
      .Toolbar1.Buttons.Item(10).Enabled = False
      .Toolbar1.Buttons.Item(13).Enabled = False
      .Toolbar1.Buttons.Item(14).Enabled = False
      .Toolbar1.Buttons.Item(15).Enabled = False
      .Toolbar1.Buttons.Item(16).Enabled = False
   End With
End Sub

'*************************************************
'  工具列按鈕失效設定5
'
'*************************************************
Public Sub tool5_enabled()
   With Forms(0)
      .Toolbar1.Buttons.Item(1).Enabled = True
      .Toolbar1.Buttons.Item(4).Enabled = False
      .Toolbar1.Buttons.Item(5).Enabled = False
      .Toolbar1.Buttons.Item(6).Enabled = True
      .Toolbar1.Buttons.Item(7).Enabled = False
      .Toolbar1.Buttons.Item(8).Enabled = True
      .Toolbar1.Buttons.Item(9).Enabled = True
      .Toolbar1.Buttons.Item(10).Enabled = True
      .Toolbar1.Buttons.Item(13).Enabled = True
      .Toolbar1.Buttons.Item(14).Enabled = True
      .Toolbar1.Buttons.Item(15).Enabled = True
      .Toolbar1.Buttons.Item(16).Enabled = True
   End With
End Sub

'*************************************************
'  工具列按鈕失效設定6
'
'*************************************************
Public Sub tool6_enabled()
   With Forms(0)
      .Toolbar1.Buttons.Item(1).Enabled = True
      .Toolbar1.Buttons.Item(4).Enabled = False
      .Toolbar1.Buttons.Item(5).Enabled = False
      .Toolbar1.Buttons.Item(6).Enabled = False
      .Toolbar1.Buttons.Item(7).Enabled = False
      .Toolbar1.Buttons.Item(8).Enabled = False
      .Toolbar1.Buttons.Item(9).Enabled = False
      .Toolbar1.Buttons.Item(10).Enabled = False
      .Toolbar1.Buttons.Item(13).Enabled = True
      .Toolbar1.Buttons.Item(14).Enabled = True
      .Toolbar1.Buttons.Item(15).Enabled = True
      .Toolbar1.Buttons.Item(16).Enabled = True
   End With
End Sub

'*************************************************
'  工具列按鈕失效設定7
'
'*************************************************
Public Sub tool7_enabled()
   With Forms(0)
      .Toolbar1.Buttons.Item(1).Enabled = True
      .Toolbar1.Buttons.Item(4).Enabled = False
      .Toolbar1.Buttons.Item(5).Enabled = True
      .Toolbar1.Buttons.Item(6).Enabled = False
      .Toolbar1.Buttons.Item(7).Enabled = False
      .Toolbar1.Buttons.Item(8).Enabled = False
      .Toolbar1.Buttons.Item(9).Enabled = False
      .Toolbar1.Buttons.Item(10).Enabled = False
      .Toolbar1.Buttons.Item(13).Enabled = False
      .Toolbar1.Buttons.Item(14).Enabled = False
      .Toolbar1.Buttons.Item(15).Enabled = False
      .Toolbar1.Buttons.Item(16).Enabled = False
   End With
End Sub

'*************************************************
'  工具列按鈕失效設定8
'
'*************************************************
Public Sub tool8_enabled()
   With Forms(0)
      .Toolbar1.Buttons.Item(1).Enabled = True
      .Toolbar1.Buttons.Item(4).Enabled = False
      .Toolbar1.Buttons.Item(5).Enabled = True
      .Toolbar1.Buttons.Item(6).Enabled = False
      .Toolbar1.Buttons.Item(7).Enabled = False
      .Toolbar1.Buttons.Item(8).Enabled = False
      .Toolbar1.Buttons.Item(9).Enabled = True
      .Toolbar1.Buttons.Item(10).Enabled = False
      .Toolbar1.Buttons.Item(13).Enabled = True
      .Toolbar1.Buttons.Item(14).Enabled = True
      .Toolbar1.Buttons.Item(15).Enabled = True
      .Toolbar1.Buttons.Item(16).Enabled = True
      '2015/10/21 add by sonia 加入總經理權限(等級01),可使用所有程式,但維護程式只有查詢功能,不可新增刪除修改)
      If PUB_GetST05(strUserNum) = "01" Then
         .Toolbar1.Buttons.Item(5).Enabled = False
      End If
      '2015/10/21 end
   End With
End Sub

'*************************************************
'  工具列按鈕失效設定9
'
'*************************************************
Public Sub tool9_enabled()
   With Forms(0)
      .Toolbar1.Buttons.Item(1).Enabled = True
      .Toolbar1.Buttons.Item(4).Enabled = True
      .Toolbar1.Buttons.Item(5).Enabled = False
      .Toolbar1.Buttons.Item(6).Enabled = False
      .Toolbar1.Buttons.Item(7).Enabled = False
      .Toolbar1.Buttons.Item(8).Enabled = False
      .Toolbar1.Buttons.Item(9).Enabled = False
      .Toolbar1.Buttons.Item(10).Enabled = False
      .Toolbar1.Buttons.Item(13).Enabled = False
      .Toolbar1.Buttons.Item(14).Enabled = False
      .Toolbar1.Buttons.Item(15).Enabled = False
      .Toolbar1.Buttons.Item(16).Enabled = False
   End With
End Sub

'*************************************************
'  工具列按鈕失效設定10
'
'*************************************************
Public Sub tool10_enabled()
   With Forms(0)
      .Toolbar1.Buttons.Item(1).Enabled = True
      .Toolbar1.Buttons.Item(4).Enabled = True
      .Toolbar1.Buttons.Item(5).Enabled = True
      .Toolbar1.Buttons.Item(6).Enabled = False
      .Toolbar1.Buttons.Item(7).Enabled = False
      .Toolbar1.Buttons.Item(8).Enabled = True
      .Toolbar1.Buttons.Item(9).Enabled = False
      .Toolbar1.Buttons.Item(10).Enabled = False
      .Toolbar1.Buttons.Item(13).Enabled = False
      .Toolbar1.Buttons.Item(14).Enabled = False
      .Toolbar1.Buttons.Item(15).Enabled = False
      .Toolbar1.Buttons.Item(16).Enabled = False
   End With
End Sub

'*************************************************
'  工具列按鈕失效設定11
'
'*************************************************
Public Sub tool11_enabled()
   With Forms(0)
      .Toolbar1.Buttons.Item(1).Enabled = False
      .Toolbar1.Buttons.Item(4).Enabled = False
      .Toolbar1.Buttons.Item(5).Enabled = False
      .Toolbar1.Buttons.Item(6).Enabled = True
      .Toolbar1.Buttons.Item(7).Enabled = False
      .Toolbar1.Buttons.Item(8).Enabled = False
      .Toolbar1.Buttons.Item(9).Enabled = False
      .Toolbar1.Buttons.Item(10).Enabled = False
      .Toolbar1.Buttons.Item(13).Enabled = False
      .Toolbar1.Buttons.Item(14).Enabled = False
      .Toolbar1.Buttons.Item(15).Enabled = False
      .Toolbar1.Buttons.Item(16).Enabled = False
   End With
End Sub

'*************************************************
'  工具列按鈕失效設定12
'
'*************************************************
Public Sub tool12_enabled()
   With Forms(0)
      .Toolbar1.Buttons.Item(1).Enabled = True
      .Toolbar1.Buttons.Item(4).Enabled = True
      .Toolbar1.Buttons.Item(5).Enabled = True
      .Toolbar1.Buttons.Item(6).Enabled = False
      .Toolbar1.Buttons.Item(7).Enabled = False
      .Toolbar1.Buttons.Item(8).Enabled = True
      .Toolbar1.Buttons.Item(9).Enabled = False
      .Toolbar1.Buttons.Item(10).Enabled = False
      .Toolbar1.Buttons.Item(13).Enabled = False
      .Toolbar1.Buttons.Item(14).Enabled = False
      .Toolbar1.Buttons.Item(15).Enabled = False
      .Toolbar1.Buttons.Item(16).Enabled = False
   End With
End Sub

'*************************************************
'  工具列按鈕失效設定13
'
'*************************************************
Public Sub tool13_enabled()
   With Forms(0)
      .Toolbar1.Buttons.Item(1).Enabled = True
      .Toolbar1.Buttons.Item(4).Enabled = False
      .Toolbar1.Buttons.Item(5).Enabled = False
      .Toolbar1.Buttons.Item(6).Enabled = False
      .Toolbar1.Buttons.Item(7).Enabled = False
      .Toolbar1.Buttons.Item(8).Enabled = False
      .Toolbar1.Buttons.Item(9).Enabled = True
      .Toolbar1.Buttons.Item(10).Enabled = False
      .Toolbar1.Buttons.Item(13).Enabled = False
      .Toolbar1.Buttons.Item(14).Enabled = False
      .Toolbar1.Buttons.Item(15).Enabled = False
      .Toolbar1.Buttons.Item(16).Enabled = False
   End With
End Sub

'*************************************************
'  工具列按鈕失效設定14
'
'*************************************************
Public Sub tool14_enabled()
   With Forms(0)
      .Toolbar1.Buttons.Item(1).Enabled = True
      .Toolbar1.Buttons.Item(4).Enabled = True
      .Toolbar1.Buttons.Item(5).Enabled = True
      .Toolbar1.Buttons.Item(6).Enabled = False
      .Toolbar1.Buttons.Item(7).Enabled = False
      .Toolbar1.Buttons.Item(8).Enabled = False
      .Toolbar1.Buttons.Item(9).Enabled = True
      .Toolbar1.Buttons.Item(10).Enabled = False
      .Toolbar1.Buttons.Item(13).Enabled = True
      .Toolbar1.Buttons.Item(14).Enabled = True
      .Toolbar1.Buttons.Item(15).Enabled = True
      .Toolbar1.Buttons.Item(16).Enabled = True
   End With
End Sub

'*************************************************
'  工具列按鈕失效設定15
'
'*************************************************
Public Sub tool15_enabled()
   With Forms(0)
      .Toolbar1.Buttons.Item(1).Enabled = True
      .Toolbar1.Buttons.Item(4).Enabled = False
      .Toolbar1.Buttons.Item(5).Enabled = False
      .Toolbar1.Buttons.Item(6).Enabled = False
      .Toolbar1.Buttons.Item(7).Enabled = False
      .Toolbar1.Buttons.Item(8).Enabled = False
      .Toolbar1.Buttons.Item(9).Enabled = True
      .Toolbar1.Buttons.Item(10).Enabled = False
      .Toolbar1.Buttons.Item(13).Enabled = True
      .Toolbar1.Buttons.Item(14).Enabled = True
      .Toolbar1.Buttons.Item(15).Enabled = True
      .Toolbar1.Buttons.Item(16).Enabled = True
   End With
End Sub

'*************************************************
'  工具列按鈕失效設定16
'
'*************************************************
'Add by Morgan 2010/11/19
Public Sub tool16_enabled()
   With Forms(0)
      .Toolbar1.Buttons.Item(1).Enabled = True
      .Toolbar1.Buttons.Item(4).Enabled = False
      .Toolbar1.Buttons.Item(5).Enabled = True
      .Toolbar1.Buttons.Item(6).Enabled = False
      .Toolbar1.Buttons.Item(7).Enabled = False
      .Toolbar1.Buttons.Item(8).Enabled = True
      .Toolbar1.Buttons.Item(9).Enabled = False
      .Toolbar1.Buttons.Item(10).Enabled = False
      .Toolbar1.Buttons.Item(13).Enabled = True
      .Toolbar1.Buttons.Item(14).Enabled = True
      .Toolbar1.Buttons.Item(15).Enabled = True
      .Toolbar1.Buttons.Item(16).Enabled = True
   End With
End Sub

'*************************************************
'  工具列按鈕失效設定17
'
'*************************************************
'2012/8/9 add by sonia 財務智慧局開票送件三支程式用
Public Sub tool17_enabled()
   With Forms(0)
      .Toolbar1.Buttons.Item(1).Enabled = True
      .Toolbar1.Buttons.Item(4).Enabled = False
      .Toolbar1.Buttons.Item(5).Enabled = False
      .Toolbar1.Buttons.Item(6).Enabled = True
      .Toolbar1.Buttons.Item(7).Enabled = False
      .Toolbar1.Buttons.Item(8).Enabled = False
      .Toolbar1.Buttons.Item(9).Enabled = False
      .Toolbar1.Buttons.Item(10).Enabled = False
      .Toolbar1.Buttons.Item(13).Enabled = False
      .Toolbar1.Buttons.Item(14).Enabled = False
      .Toolbar1.Buttons.Item(15).Enabled = False
      .Toolbar1.Buttons.Item(16).Enabled = False
   End With
End Sub

'Add by Morgan 2005/9/6
'*************************************************
'  工具列按鈕失效設定18
'
'*************************************************
Public Sub tool18_enabled()
   With Forms(0)
      .Toolbar1.Buttons.Item(1).Enabled = True
      .Toolbar1.Buttons.Item(4).Enabled = False
      .Toolbar1.Buttons.Item(5).Enabled = True
      .Toolbar1.Buttons.Item(6).Enabled = False
      .Toolbar1.Buttons.Item(7).Enabled = False
      .Toolbar1.Buttons.Item(8).Enabled = False
      .Toolbar1.Buttons.Item(9).Enabled = True
      .Toolbar1.Buttons.Item(10).Enabled = False
      .Toolbar1.Buttons.Item(13).Enabled = False
      .Toolbar1.Buttons.Item(14).Enabled = False
      .Toolbar1.Buttons.Item(15).Enabled = False
      .Toolbar1.Buttons.Item(16).Enabled = False
   End With
End Sub

'Modified by Morgan 2013/12/27 +商標,法務,服務
'案件特殊出名公司
'Modified by Morgan 2020/3/23 +pRtnCompID:是否回傳公司別代碼,pAccComp:是否回傳作帳公司別代碼
Public Function PUB_GetReceiptComp(pCP01 As String, pCP02 As String, pCP03 As String, pCP04 As String, Optional pRtnCompID As Boolean = False, Optional pAccComp As Boolean = False) As String
   Dim stSQL As String, intR As Integer
   Dim adoRst As ADODB.Recordset
   Dim stComp As String
   Select Case CheckSys(pCP01)
      Case "1"
         stSQL = "select pa161 from patent where pa01='" & pCP01 & "' and pa02='" & pCP02 & "' and pa03='" & pCP03 & "' and pa04='" & pCP04 & "' and pa161 is not null"
      Case "2"
         stSQL = "select tm130 from trademark where tm01='" & pCP01 & "' and tm02='" & pCP02 & "' and tm03='" & pCP03 & "' and tm04='" & pCP04 & "' and tm130 is not null"
      Case "3"
         stSQL = "select lc48 from lawcase where lc01='" & pCP01 & "' and lc02='" & pCP02 & "' and lc03='" & pCP03 & "' and lc04='" & pCP04 & "' and lc48 is not null"
      Case Else
         stSQL = "select sp85 from servicepractice where sp01='" & pCP01 & "' and sp02='" & pCP02 & "' and sp03='" & pCP03 & "' and sp04='" & pCP04 & "' and sp85 is not null"
   End Select
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      stComp = adoRst(0)
   End If
   
   'Added by Morgan 2020/3/23
   If pRtnCompID = True Then
      If stComp = "T" Then stComp = "1" '商標出名傳回1公司
      If stComp = "" Then
         If InStr(pCP01, "T") > 0 Or pCP01 = "S" Then
            stComp = "1"
         ElseIf InStr(pCP01, "L") > 0 And strSrvDate(1) >= 智慧所更名日 Then
            stComp = "L"
         Else
            stComp = "2"
         End If
      End If
      If strSrvDate(1) >= 事務所合併日 Then
         If stComp = "1" Then stComp = "2"
      End If
      
      'Added by Morgan 2020/3/26
      If pAccComp = True Then
         If stComp = "2" Then stComp = "1"
      End If
      'end 2020/3/26
   End If
   'end 2020/3/23
   
   PUB_GetReceiptComp = stComp
   Set adoRst = Nothing
End Function
'Added by Morgan 2013/5/24
'文字轉數字
Public Function PUB_chgWord2Num(pWord As String) As String
   Dim ii As Single, stChar As String, StNum As String
   For ii = 1 To Len(pWord)
      stChar = Mid(pWord, ii, 1)
      stChar = Format(stChar) '全形數字轉半形
      Select Case stChar
      Case "一", "壹"
         StNum = StNum & "1"
      Case "二", "貳"
         StNum = StNum & "2"
      Case "三", "參"
         StNum = StNum & "3"
      Case "四", "肆"
         StNum = StNum & "4"
      Case "五", "伍"
         StNum = StNum & "5"
      Case "六", "陸"
         StNum = StNum & "6"
      Case "七", "柒"
         StNum = StNum & "7"
      Case "八", "捌"
         StNum = StNum & "8"
      Case "九", "玖"
         StNum = StNum & "9"
      Case "Ｏ", "零"
         StNum = StNum & "0"
      Case Else
         StNum = StNum & stChar
      End Select
   Next
   If IsNumeric(StNum) Then
      PUB_chgWord2Num = StNum
   Else
      PUB_chgWord2Num = pWord
   End If
End Function

Public Sub SetLetterSt()
   PaSt = "PA01='" & m_MySt(1) & "' AND PA02='" & m_MySt(2) & "' AND PA03='" & _
      m_MySt(3) & "' AND PA04='" & m_MySt(4) & "'"
   TmSt = "TM01='" & m_MySt(1) & "' AND TM02='" & m_MySt(2) & "' AND TM03='" & _
      m_MySt(3) & "' AND TM04='" & m_MySt(4) & "'"
   LcSt = "LC01='" & m_MySt(1) & "' AND LC02='" & m_MySt(2) & "' AND LC03='" & _
      m_MySt(3) & "' AND LC04='" & m_MySt(4) & "'"
   HcSt = "HC01='" & m_MySt(1) & "' AND HC02='" & m_MySt(2) & "' AND HC03='" & _
      m_MySt(3) & "' AND HC04='" & m_MySt(4) & "'"
   SpSt = "SP01='" & m_MySt(1) & "' AND SP02='" & m_MySt(2) & "' AND SP03='" & _
      m_MySt(3) & "' AND SP04='" & m_MySt(4) & "'"
End Sub

'Added by Morgan 2013/8/23
'印尼第一次年費應繳年度
Public Function PUB_GetXDesc(pPA01 As String, pPA02 As String, pPA03 As String, pPA04 As String) As String
   Dim stSQL As String, intR As Integer, iToYear As Integer
   Dim rsQuery As ADODB.Recordset
   
   '印尼發明及新型的年費期限第1次為發證日6個月內須繳交自申請日起算累計至發證日次年之年費
   'Modified by Morgan 2021/11/4 +PA20
   '核准日6個月內須繳交自申請日起算累計至核准日次年之年費，之後則逐年提前於屆滿前1個月(申請日)繳交
   stSQL = "SELECT PA10,PA21,PA72,PA20 FROM PATENT WHERE PA01='" & pPA01 & "' And PA02='" & pPA02 & "' AND PA03='" & pPA03 & "' AND PA04='" & pPA04 & "' and pa09='017'"
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      If IsNull(rsQuery("pa72")) Then
         PUB_GetXDesc = "第1年"
         'Modified by Morgan 2021/11/5
         'If rsQuery("pa10") > 0 And rsQuery("pa21") > 0 Then
         '   'Modified by Morgan 2016/10/27
         '   'iToYear = (rsQuery("pa21") - rsQuery("pa10")) \ 10000 + 1
         '   iToYear = (rsQuery("pa21") - rsQuery("pa10")) \ 10000 + 2
         '   'end 2016/10/27
         If rsQuery("pa10") > 0 And rsQuery("pa20") > 0 Then
            iToYear = PUB_GetIDNToYear(rsQuery("pa10"), rsQuery("pa20"))
         'end 2021/11/5
            If iToYear > 1 Then
               PUB_GetXDesc = "第1-" & iToYear & "年"
            End If
         End If
      End If
   End If
   Set rsQuery = Nothing
End Function

'Added by Morgan 2021/11/5
'印尼第一次年費應繳年度
Public Function PUB_GetIDNToYear(pPA10 As String, pPA20 As String) As Integer
   If Val(pPA20) > 0 And Val(pPA10) > 0 Then
      '核准日6個月內須繳交自申請日起算累計至核准日次年之年費，之後則逐年提前於屆滿前1個月(申請日)繳交
      PUB_GetIDNToYear = (Val(DBDATE(pPA20)) - Val(DBDATE(pPA10))) \ 10000 + 2
   End If
End Function

'Added by Morgan 2013/7/1
'造字轉Unicode
Public Function PUB_Big5toUnicode(pText As String) As String
   Dim stSQL As String, intR As Integer
   Dim adoRst As ADODB.Recordset
   Dim stBig5 As String, stUniCode As String
   Dim stNew As String
   
   stNew = pText
   stSQL = "select * from unicodemap"
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      Do While Not adoRst.EOF
         stBig5 = adoRst("UM01")
         'Modified by Morgan 2014/1/16 改放16進位內碼
         'stUniCode = StrConv("" & adoRst("UM02"), vbFromUnicode)
         stUniCode = ChrW("&H" & adoRst("UM02"))
         stNew = Replace(stNew, stBig5, stUniCode)
         adoRst.MoveNext
      Loop
   End If
   PUB_Big5toUnicode = stNew
   Set adoRst = Nothing
End Function

'Added by Morgan 2014/5/27
'插入簽名檔 (位置還有問題)
Private Sub AddSignature(ByVal pNameText As String, pPicNo As Single)
   Dim stFileName As String
   Dim oInlineShape As Word.InlineShape
   Dim oShape As Word.Shape
   
   If PUB_ReadDB2File(stFileName, CInt(pPicNo)) = False Then Exit Sub
   
   With g_WordAp.Application
   .Selection.GoTo what:=wdGoToPage, which:=wdGoToPrevious, Count:=3
   .Selection.Find.ClearFormatting
   .Selection.Find.Text = pNameText
   .Selection.Find.Replacement.Text = ""
   .Selection.Find.Forward = True
   .Selection.Find.Wrap = wdFindContinue
   .Selection.Find.Format = False
   .Selection.Find.MatchCase = False
   .Selection.Find.MatchWholeWord = False
   .Selection.Find.MatchWildcards = False
   .Selection.Find.MatchSoundsLike = False
   .Selection.Find.MatchAllWordForms = False
   .Selection.Find.MatchByte = True
   .Selection.Find.Execute
   .Selection.MoveLeft Unit:=wdCharacter, Count:=1
   Set oInlineShape = .Selection.InlineShapes.AddPicture(stFileName, False, True)
   Set oShape = oInlineShape.ConvertToShape
   'oShape.ZOrder 4 '文字前
   oShape.ZOrder 5 '文字後
   
   oShape.LockAspectRatio = msoTrue
   oShape.Height = .CentimetersToPoints(1.5)
   '文字上方 1.5 公分
   oShape.Top = oShape.Top + .CentimetersToPoints(0.6)
   End With
   
   Set oInlineShape = Nothing
   Set oShape = Nothing
End Sub

'Add By Sindy 2014/7/17
'下載卷和代表圖檔
'Modified by Lydia 2017/07/21 代表圖區分黑白或彩色(strKind);bolCheck 檢查是否存在
Public Function GetImgByteFile(ByVal strIBF01 As String, ByVal strIBF02 As String, ByVal strIBF03 As String, _
                               ByVal strIBF04 As String, Optional ByVal strIBF05 As String = "1", _
                               Optional ByRef pFileName As String, Optional ByVal pSavePath As String, _
                               Optional ByVal bolReDownLoad As Boolean = True, Optional ByVal strKind As String = "", _
                               Optional ByVal bolCheck As Boolean = False) As Boolean
Dim stAttPath As String
Dim lngSize As Long
Dim iFileNo As Integer
Dim bytes() As Byte
Dim rsA As New ADODB.Recordset
Dim strQ As String 'Add by Amy 2018/07/20
   
On Error GoTo ErrHnd
   
   GetImgByteFile = False
   If pFileName = "" Then
      pFileName = "$$" & strIBF01 & strIBF02 & strIBF03 & strIBF04
      If strIBF05 = "4" Then
         pFileName = pFileName & ".doc"
      ElseIf strIBF05 = "5" Then
         pFileName = pFileName & ".pdf"
      Else
         pFileName = pFileName & ".jpg"
      End If
   End If
   If pSavePath = "" Then
      stAttPath = App.path & "\" & pFileName
      '檔案已存在
      If Dir(stAttPath) <> "" Then
         '不必重新下載
         If bolReDownLoad = False Then
            pFileName = stAttPath
            GetImgByteFile = True
            Exit Function
         End If
      End If
   Else
      stAttPath = pSavePath
   End If
   
   'Modify by Amy 2018/07/20 彩色代表圖
   If strSrvDate(1) >= 彩色代表圖啟用日 And strIBF05 = "1" Then
   Else
        strQ = strQ & " and ibf05='" & strIBF05 & "'"
        'Added by Lydia 2017/07/21 代表圖區分黑白或彩色
        If strKind = "1" Then '黑白
           strQ = strQ & " and ibf06 in ('1','3')"
        ElseIf strKind = "2" Then '彩色
           strQ = strQ & " and ibf06 in ('2','4')"
        End If
        'end 2017/07/21
   End If
   'Modify By Sindy 2018/10/31 TF馬德里商標圖檔-子案的圖同母案
   '固定都以IBF01=tm01 AND IBF02=substr(tm02,1,5)||'0' AND IBF03='0' AND IBF04='00' 去抓代表圖
   If strIBF01 = "TF" Then
      strQ = "Select * From ImgByteFile Where ibf01='" & strIBF01 & "' and ibf02='" & Mid(strIBF02, 1, 5) & "0" & "' And ibf03='0' And ibf04='00' " & _
                strQ
   Else
   '2018/10/31 END
      strQ = "Select * From ImgByteFile Where ibf01='" & strIBF01 & "' and ibf02='" & strIBF02 & "' and ibf03='" & strIBF03 & "' and ibf04='" & strIBF04 & "' " & _
                strQ
      'end 2018/07/20
   End If
   intI = 1
   Set rsA = ClsLawReadRstMsg(intI, strQ)
   If intI = 1 Then
      'Modified by Lydia 2017/07/21 檢查不用下載檔案
      'If rsA.RecordCount = 1 Then
      If rsA.RecordCount = 1 And bolCheck = True Then
         GetImgByteFile = True
      End If
      If rsA.RecordCount = 1 And bolCheck = False Then
      'end 2017/07/21
         If Dir(stAttPath) <> "" Then Kill stAttPath
         'Add By Sindy 2017/8/10
'         If "" & rsA.Fields("IBF15") <> "" Then
            GetImgByteFile = PUB_GetFtpFile(rsA.Fields("IBF15"), stAttPath, UCase("ImgByteFile"))
'         Else
'         '2017/8/10 END
'            With rsA
'            lngSize = Val(.Fields("ibf13").Value)
'            ReDim bytes(lngSize)
'            If lngSize > 0 Then bytes() = .Fields("ibf14").GetChunk(lngSize)
'            End With
'            iFileNo = FreeFile
'            Open stAttPath For Binary Access Write As #iFileNo
'            If lngSize > 0 Then Put #iFileNo, , bytes()
'            Close #iFileNo
'            GetImgByteFile = True
'         End If
         pFileName = stAttPath
      End If
   End If
   
   Set rsA = Nothing
   Exit Function
   
ErrHnd:
   Set rsA = Nothing
   MsgBox Err.Description, vbCritical
   If iFileNo > 0 Then Close #iFileNo
End Function
'Added by Morgan 2014/12/9 自 acc2480 抽出為共用
Public Function PUB_GetCreatorNameInWord() As String
   Dim oWordApp As Word.Application
   Dim strOsDefaultPrinter As String
   Dim strCreatorName As String, intCreatorId As Integer
   
On Error GoTo SetNothing
   intCreatorId = PUB_PrinterIndex("PDFCreator")
   If intCreatorId >= 0 Then
      strCreatorName = Printers(intCreatorId).DeviceName
   Else
      Exit Function
   End If
   '切換控 OS 印表機
   strOsDefaultPrinter = PUB_GetOsDefaultPrinter
   If strCreatorName <> strOsDefaultPrinter Then
      PUB_SetOsDefaultPrinter strCreatorName
   End If
   
   '記錄 Word 印表機名稱
   Set oWordApp = New Word.Application
   oWordApp.Visible = True 'Added by Morgan 2017/10/6 若有錯誤時才能看得見
   PUB_GetCreatorNameInWord = oWordApp.ActivePrinter
   oWordApp.Quit Word.wdDoNotSaveChanges
   
   '還原 OS 印表機
   PUB_SetOsDefaultPrinter strOsDefaultPrinter
   
SetNothing:
   Set oWordApp = Nothing
   If strOsDefaultPrinter <> "" And strCreatorName <> strOsDefaultPrinter Then PUB_SetOsDefaultPrinter strOsDefaultPrinter
End Function

Public Function PUB_PrinterIndex(Printername As String) As Long
   Dim i As Long
   PUB_PrinterIndex = -1
   For i = 0 To Printers.Count - 1
    If UCase(Printers(i).DeviceName) = UCase$(Printername) Then
     PUB_PrinterIndex = i
     Exit For
    End If
   Next i
End Function
'end 2014/12/9

'Added by Morgan 2014/12/11
'Modified by Morgan 2014/12/18 +pCP01,pCP02,pCP03,pCP04
Public Function PUB_GetOrderLetterSignature(pCP01 As String, pCP02 As String, pCP03 As String, pCP04 As String) As String
   'Modified by Lydia 2022/03/29
   'Dim stST03 As String
   Dim intJ As Integer, strB1 As String, strB2 As String
   'Modified by Morgan 2014/12/18  撰寫信函工程也會用故要加判斷是否為寰華案件
   'If Left(stST03, 2) = "F2" Then
   If PUB_FMPtoCheck(1, 2, "", pCP01, pCP02, pCP03, pCP04) = True Then
   'end 2014/12/18
      'Modified by Lydia 2022/03/29 抓員工名稱: 81040 閻啟泰
      'PUB_GetOrderLetterSignature = "　　　　　　　　　　　　　　　　　　　　　　　　　閻　啟　泰　敬上"
      strB1 = GetStaffName("81040", True)
      For intJ = 1 To Len(strB1)
          strB2 = strB2 & Mid(strB1, intJ, 1) & "　"
      Next intJ
      PUB_GetOrderLetterSignature = "　　　　　　　　　　　　　　　　　　　　　　　　　" & strB2 & "敬上"
      'end 2022/03/29
   Else
      'Modified by Lydia 2017/05/11 P大陸案改成雙署名檔
      'PUB_GetOrderLetterSignature = "　　　　　　　　　　　　　　　　　　　　　　　　　王　錦　寬　敬上"
      'Modified by Morgan 2023/5/3
      If strSrvDate(1) >= "20230511" Then
         PUB_GetOrderLetterSignature = "　　　　　　　　　　　　　　　　　　　　　　林景郁　　郭雅娟　敬上"
      Else
         PUB_GetOrderLetterSignature = "　　　　　　　　　　　　　　　　　　　　　　林景郁　　王錦寬　敬上"
      End If
      'end 2023/5/3
   End If
End Function

'Add By Sindy 2014/12/12 轉換全形數字變成半形數字
Public Function PUB_ChgNumeralStyle(strData As String) As String
Dim ii As Integer
Dim strTemp As String
   
   PUB_ChgNumeralStyle = ""
   For ii = 1 To Len(strData)
      strTemp = Mid(strData, ii, 1)
      Select Case strTemp
         Case "１"
            strTemp = "1"
         Case "２"
            strTemp = "2"
         Case "３"
            strTemp = "3"
         Case "４"
            strTemp = "4"
         Case "５"
            strTemp = "5"
         Case "６"
            strTemp = "6"
         Case "７"
            strTemp = "7"
         Case "８"
            strTemp = "8"
         Case "９"
            strTemp = "9"
         Case "０"
            strTemp = "0"
      End Select
      PUB_ChgNumeralStyle = PUB_ChgNumeralStyle & strTemp
   Next ii
End Function

'Add By Sindy 2016/3/30 轉換全形英文變成半形英文
Public Function PUB_ChgEnglishStyle(strData As String) As String
Dim ii As Integer
Dim strTemp As String
   
   PUB_ChgEnglishStyle = ""
   For ii = 1 To Len(strData)
      strTemp = Mid(strData, ii, 1)
      Select Case strTemp
         Case "Ａ"
            strTemp = "A"
         Case "Ｂ"
            strTemp = "B"
         Case "Ｃ"
            strTemp = "C"
         Case "Ｄ"
            strTemp = "D"
         Case "Ｅ"
            strTemp = "E"
         Case "Ｆ"
            strTemp = "F"
         Case "Ｇ"
            strTemp = "G"
         Case "Ｈ"
            strTemp = "H"
         Case "Ｉ"
            strTemp = "I"
         Case "Ｊ"
            strTemp = "J"
         Case "Ｋ"
            strTemp = "K"
         Case "Ｌ"
            strTemp = "L"
         Case "Ｍ"
            strTemp = "M"
         Case "Ｎ"
            strTemp = "N"
         Case "Ｏ"
            strTemp = "O"
         Case "Ｐ"
            strTemp = "P"
         Case "Ｑ"
            strTemp = "Q"
         Case "Ｒ"
            strTemp = "R"
         Case "Ｓ"
            strTemp = "S"
         Case "Ｔ"
            strTemp = "T"
         Case "Ｕ"
            strTemp = "U"
         Case "Ｖ"
            strTemp = "V"
         Case "Ｗ"
            strTemp = "W"
         Case "Ｘ"
            strTemp = "X"
         Case "Ｙ"
            strTemp = "Y"
         Case "Ｚ"
            strTemp = "Z"
      End Select
      PUB_ChgEnglishStyle = PUB_ChgEnglishStyle & strTemp
   Next ii
End Function

'Added by Morgan 2015/5/19
'定稿智權人員名稱
Public Function PUB_GetSalesLetterName(pID As String) As String
   Dim stSQL As String, intR As Integer
   Dim rsQuery As ADODB.Recordset
   
   stSQL = "select st65 from staff where st01='" & pID & "'"
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      PUB_GetSalesLetterName = "" & rsQuery(0)
   End If
   Set rsQuery = Nothing
   
End Function

'Added by Morgan 2015/5/19
'定稿智權人員名稱
Public Function PUB_GetLetterSalesName(pID As String) As String
   Dim stSQL As String, intR As Integer
   Dim rsQuery As ADODB.Recordset
   
   stSQL = "select st65 from staff where st01='" & pID & "'"
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      PUB_GetLetterSalesName = "" & rsQuery(0)
   End If
   Set rsQuery = Nothing
   
End Function

'Added by Morgan 2015/5/19
'定稿智權人員區別
Public Function PUB_GetLetterSalesZone(pID As String) As String
   Dim stSQL As String, intR As Integer
   Dim rsQuery As ADODB.Recordset
   
   stSQL = "select st66 from staff where st01='" & pID & "'"
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      PUB_GetLetterSalesZone = "" & rsQuery(0)
   End If
   Set rsQuery = Nothing
   
End Function

'Added by Morgan 2017/9/15
'定稿轉pdf(Word Export)
Public Function PUB_ConvLetter2PDFbyWord(pLD01 As String, pLD02 As String, pLD03 As String, Optional ByRef pFileName As String) As Boolean
   Dim lngPointer As Long
   Dim strPath As String, strFileName As String, iPos As Integer
   
   lngPointer = Screen.MousePointer
   Screen.MousePointer = vbHourglass
   
On Error GoTo ErrHnd
   
   If pFileName <> "" Then
      iPos = InStrRev(pFileName, "\")
      If iPos > 0 Then
         strPath = Left(pFileName, iPos - 1)
         strFileName = Mid(pFileName, iPos + 1)
      Else
         strFileName = pFileName
      End If
   End If
   If strPath = "" Then strPath = App.path
   If strFileName = "" Then strFileName = "$$" & pLD01 & pLD02 & pLD03 & ".pdf"
   
   pFileName = strPath & "\" & strFileName
   
   If PrinterLetterDB(pLD01, , pLD02, pLD03, , 1, True, pFileName) = 0 Then
      PUB_ConvLetter2PDFbyWord = True
   End If
   
ErrHnd:

   If Err.Number <> 0 Then
      MsgBox Err.Description, vbCritical
   End If
   Screen.MousePointer = lngPointer
   
End Function

'Added by Morgan 2014/3/5
'定稿轉pdf
Public Function PUB_ConvLetter2PDF(pLD01 As String, pLD02 As String, pLD03 As String, Optional ByRef pFileName As String) As Boolean
   Dim lngPointer As Long
   Dim strPath As String, strFileName As String, iPos As Integer
   
   If Pub_GetPrinterIndex("PDFCreator") < 0 Then Exit Function
   
   lngPointer = Screen.MousePointer
   Screen.MousePointer = vbHourglass
   
On Error GoTo ErrHnd
   
   If pFileName <> "" Then
      iPos = InStrRev(pFileName, "\")
      If iPos > 0 Then
         strPath = Left(pFileName, iPos - 1)
         strFileName = Mid(pFileName, iPos + 1)
      Else
         strFileName = pFileName
      End If
   End If
   If strPath = "" Then strPath = App.path
   If strFileName = "" Then strFileName = "$$" & pLD01 & pLD02 & pLD03 & ".pdf"
   
   pFileName = strPath & "\" & strFileName
   
   pub_OsPrinter = PUB_GetOsDefaultPrinter
   'Load frmPDF
   frmPDF.Show
   frmPDF.StartProcess strPath, strFileName
   PUB_SetOsDefaultPrinter Printer.DeviceName
   PUB_SetWordActivePrinter
   If PrinterLetterDB(pLD01, , pLD02, pLD03, , 1) = 0 Then
      frmPDF.EndtProcess
      PUB_ConvLetter2PDF = True
   End If
   Unload frmPDF
   PUB_SetOsDefaultPrinter pub_OsPrinter
   
ErrHnd:

   If Err.Number <> 0 Then
      MsgBox Err.Description, vbCritical
   End If
   Screen.MousePointer = lngPointer
   
End Function

'Added by Morgan 2015/12/25
'設定薪資資料濃淡設定HScrollBar
Public Sub PUB_SetForeColorScroll(ByRef oHScroll As HScrollBar)
   Dim stValue As String
   
   With oHScroll
   .max = 200
   .Min = 150
   stValue = PUB_GetLastDate(strUserNum, "薪資資料濃淡設定值")
   If Val(stValue) >= .Min And Val(stValue) <= .max Then
      .Value = Val(stValue)
   Else
      .Value = 175
   End If
   End With
End Sub

'Added by Morgan 2015/12/25
'儲存薪資資料濃淡設定
Public Sub PUB_SaveForeColor(ByRef oHScroll As HScrollBar)
   PUB_SaveLastDate strUserNum, "薪資資料濃淡設定值", oHScroll.Value
End Sub

'Added by Morgan 2015/12/25
'0-255數字轉RGB灰階顏色值
Public Function PUB_GetColor(pOct As Integer) As Long
   PUB_GetColor = Val("&H" & Hex(pOct) & Hex(pOct) & Hex(pOct))
End Function

'Added by Morgan 2016/1/5
'啟動薪資計時
Public Sub PUB_EnableSalaryTimer()
   Forms(0).tmrSalary.Enabled = True
   Forms(0).tmrSalary.Tag = ""
End Sub

'Added by Morgan 2016/1/5
'薪資計時歸零
Public Sub PUB_ResetSalaryTimer(pForm As Form)
   If Not pForm Is Nothing Then
      If LCase(Left(pForm.Name, 5)) = "frm17" Then Forms(0).tmrSalary.Tag = 0
   End If
End Sub

'Added by Morgan 2016/1/5
'顯示薪資倒數計時
Public Sub PUB_ShowSalaryCountDown(pLabel As Label)
   Dim iSec As Integer
   iSec = 60 - Val(Forms(0).tmrSalary.Tag)
   '10秒內才顯示否則隱藏
   If iSec <= 10 Then
      pLabel.Visible = True
      pLabel = "若您未繼續移動滑鼠,將會於 " & iSec & " 秒後登出"
   Else
      pLabel.Visible = False
   End If
End Sub

'Added by Morgan 2016/1/5
'檢查薪資可用狀態
Public Function PUB_SalaryEnabled() As Boolean
   PUB_SalaryEnabled = Forms(0).tmrSalary.Enabled
End Function

'Added by Morgan 2016/1/5
'可查薪資名單加入下拉選單
Public Sub PUB_AddSalaryUser(pCombo As Object, Optional bolFnoDisplay As Boolean = True)
   Dim ii As Integer, arrTmp() As String
   
   arrTmp = Split(Pub_StaffList, ";")
   pCombo.Clear
   For ii = LBound(arrTmp) To UBound(arrTmp)
      If arrTmp(ii) <> "" Then
         'modify by sonia 2016/2/26 年終及扣繳資料不顯示F編號在下拉選單
         'pCombo.AddItem arrTmp(ii)
         If bolFnoDisplay Or Left(Right(arrTmp(ii), 5), 1) <> "F" Then
            pCombo.AddItem arrTmp(ii)
         End If
      End If
   Next
   If pCombo.ListCount > 0 Then
      pCombo.ListIndex = 0
   End If
End Sub

'Added by Lydia 2016/06/07 取得年費,維持費,延展費 第X年(第X次)
Public Function PUB_GetCPMnexttimes(ByVal strKEY01 As String, ByVal strKEY02 As String, ByVal strKEY03 As String, ByVal strKEY04 As String, ByVal strKEY05 As String, ByVal strKEY06 As String, ByVal bstNP07 As String, ByVal p_stNP07 As String)
'strKey01~04    案號
'strKey05       國別
'strKey06       專利/商標種類
'bstNP07        傳入的案件性質(可多筆,以","區隔)
'p_stNP07       指定案件性質
Dim arrNP07 As Variant
Dim strCPM03s As String
Dim m_iFixNo As Integer '修法次數
Dim strYear As String '抓下次繳費年度
Dim m_Nexttimes As String '抓下次繳費次數
Dim strYF15 As String '年費年度說明
Dim strKey(0 To 4) As String
Dim strFeeType As String
Dim strFeeYear As String
Dim m_CaseFee(1 To 2) As String
Dim aryCaseFee As Variant
Dim rsRD As New ADODB.Recordset
Dim inA As Integer
Dim iX As Integer
Dim Str01 As String
Dim strPA10 As String 'Added by Morgan 2022/6/13

   If (strKEY01 = "P" Or strKEY01 = "CFP") And (InStr(bstNP07, "605") > 0 Or InStr(bstNP07, "606") > 0 Or InStr(bstNP07, "607") > 0) Then
       '設定本所案號
       strKey(0) = ""
       strKey(1) = strKEY01
       strKey(2) = strKEY02
       strKey(3) = strKEY03
       strKey(4) = strKEY04
       arrNP07 = Empty
       arrNP07 = Split(bstNP07, ",")
       strCPM03s = ""
       For iX = LBound(arrNP07) To UBound(arrNP07)
          If Trim(arrNP07(iX)) <> "" Then 'Added by Lydia 2018/06/06 去掉空白 (智權部的案件回覆單列印ex.CFP-026080)
              '抓案件性質名稱
              Str01 = "": strFeeYear = ""
              If strKEY05 = "000" And (InStr(1, strKEY01, "P") > 0 Or InStr(1, strKEY01, "T") > 0) Then
                 strSql = "select DECODE(CPM03,'（無）',CPM04,CPM03) CPM03 from CasePropertyMap where cpm01='" & strKEY01 & "' and cpm02='" & arrNP07(iX) & "'"
              Else
                 strSql = "select DECODE(CPM04,'（無）',CPM03,CPM04) CPM03 from CasePropertyMap where cpm01='" & strKEY01 & "' and cpm02='" & arrNP07(iX) & "'"
              End If
              inA = 1
              Set rsRD = ClsLawReadRstMsg(inA, strSql)
              If inA = 1 Then
                 Str01 = Str01 & IIf(Str01 <> "", ",", "") & rsRD.Fields("CPM03")
              End If
              
              'Added by Morgan 2022/6/13
              strSql = "select pa10 from patent where pa01='" & strKEY01 & "' and pa02='" & strKEY02 & "' and pa03='" & strKEY03 & "' and pa04='" & strKEY04 & "'"
              inA = 1
              Set rsRD = ClsLawReadRstMsg(inA, strSql)
              If inA = 1 Then
                  strPA10 = "" & rsRD.Fields("pa10")
              End If
              'end 2022/6/13
              
              'CFP-大馬新型延展費,俄羅斯設計延展費
              'Modified by Morgan 2017/7/3 俄羅斯5/2改國家代碼 "233"->"023"
              'Modified by Morgan 2022/6/13
              '2015/1/1以前提申案件除了延展費外仍要繳年費，2015/1/1以後提申案件僅須繳延展費(一併修正申請日參數傳成申請國家問題)
              'If (strKEY01 = "CFP" And strKEY05 = "018" And strKEY06 = "2" And arrNP07(iX) = "607") Or _
                 (strKEY01 = "CFP" And strKEY05 = "023" And strKEY06 = "3" And arrNP07(iX) = "607") Then
              '    strFeeYear = " " & PUB_GetExpYF607(strKEY05, strKEY01, strKEY02, strKEY03, strKEY04, strKEY05)
              If (strKEY01 = "CFP" And strKEY05 = "018" And strKEY06 = "2" And arrNP07(iX) = "607") Or _
                 (strKEY01 = "CFP" And strKEY05 = "023" And strKEY06 = "3" And arrNP07(iX) = "607" And Val(strPA10) < 20150101) Then
                   strFeeYear = " " & PUB_GetExpYF607(strKEY05, strKEY01, strKEY02, strKEY03, strKEY04, strPA10)
               'end 2022/6/13
              ElseIf (arrNP07(iX) = "605" Or arrNP07(iX) = "606" Or arrNP07(iX) = "607") Then
                  '取得繳年費的資料(抓修法次數)
                  If GetMoneyDate(strKEY06, strKEY05, strKey, m_CaseFee(1), m_CaseFee(2), , , m_iFixNo) = True Then
                     '取得下次繳費次數/年度
                     m_Nexttimes = PUB_Getnexttimes(strKEY01, strKEY02, strKEY03, strKEY04, strYear)
                     If m_Nexttimes <> "" Then
                        If p_stNP07 = "605" Then '605.年費
                           aryCaseFee = Split(m_CaseFee(2), ",")
                           'Modified by Morgan 2022/6/13 +strPA10
                           strFeeType = PUB_GetNa20Na22Na24(strKEY05, strKEY06, strPA10)
                           If strKEY05 = "017" And strFeeType = "605" And m_Nexttimes = "1" Then
                              strYF15 = PUB_GetXDesc(strKEY01, strKEY02, strKEY03, strKEY04)
                           'Added by Morgan 2025/3/18
                           '2024/10/5起俄羅斯發明及新型年費改一次繳5年
                           ElseIf strKEY05 = "023" And strFeeType = "605" And (strKEY06 = "1" Or strKEY06 = "2") Then
                              Call PUB_GetNextYear(strKey, strYF15)
                           'end 2025/3/18
                           Else
                              strYF15 = PUB_GetYF15(strKEY05, strKEY06, "Y000000" & m_iFixNo, strFeeType, CDbl(strYear))
                           End If
                           strFeeYear = " " & strYF15
            
                        ElseIf p_stNP07 = "606" Or p_stNP07 = "607" Then '606.維持費 607.延展費
                           '年度說明
                           'Modified by Morgan 2022/6/13 +strPA10
                           strFeeType = PUB_GetNa20Na22Na24(strKEY05, strKEY06, strPA10)
                           strYF15 = PUB_GetYF15(strKEY05, strKEY06, "Y000000" & m_iFixNo, strFeeType, CDbl(strYear))
                           strFeeYear = " " & strYF15
                        End If
                     End If
                  End If
              End If
              strCPM03s = strCPM03s & Str01 & strFeeYear & ","
          End If 'end 2018/06/06
       Next
       If Right(strCPM03s, 1) = "," Then strCPM03s = Mid(strCPM03s, 1, Len(strCPM03s) - 1)
   End If
   PUB_GetCPMnexttimes = strCPM03s
End Function

'Added by Morgan 2016/8/12
'以本所案號讀取國內副本收件人
Public Function PUB_GetCC(pCNo1 As String, pCNo2 As String, pCNo3 As String, pCNo4 As String, Optional pCustNo As String, Optional pContNo As String) As Boolean
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   
   stSQL = "select nvl(pa168,cu166) CustNo,decode(pa168,null,cu167,pa169) ContNo" & _
      " from (select pa26,pa168,pa169 from patent where pa01='" & pCNo1 & "' and pa02='" & pCNo2 & "' and pa03='" & pCNo3 & "' and pa04='" & pCNo4 & "'" & _
      " union all select tm23,tm132,tm133 from trademark where tm01='" & pCNo1 & "' and tm02='" & pCNo2 & "' and tm03='" & pCNo3 & "' and tm04='" & pCNo4 & "'" & _
      " union all select sp08,sp86,sp87 from servicepractice where sp01='" & pCNo1 & "' and sp02='" & pCNo2 & "' and sp03='" & pCNo3 & "' and sp04='" & pCNo4 & "'" & _
      "),customer where cu01(+)=substr(pa26,1,8) and cu02(+)=substr(pa26,9) and pa168||cu166 is not null"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      pCustNo = "" & rsQuery("CustNo")
      pContNo = "" & rsQuery("ContNo")
      PUB_GetCC = True
   Else
      pCustNo = ""
      pContNo = ""
   End If
   Set rsQuery = Nothing
End Function

'Added by Morgan 2016/11/3
'以客戶編號讀取國內副本收件人
Public Function PUB_GetCCbyCustNo(pCNo, Optional pCustNo As String, Optional pContNo As String) As Boolean
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   
   stSQL = "select cu166 CustNo,cu167 ContNo" & _
      " from customer where cu01='" & Left(pCNo, 8) & "' and cu02='" & Mid(pCNo, 9) & "' and cu166 is not null"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      pCustNo = "" & rsQuery("CustNo")
      pContNo = "" & rsQuery("ContNo")
      PUB_GetCCbyCustNo = True
   Else
      pCustNo = ""
      pContNo = ""
   End If
   Set rsQuery = Nothing
End Function

'Added by Morgan 2016/8/29
'新增副本進度檔
'Modified by Morgan 2023/10/18 取消參數 pInTrans 改用變數 m_bInTrans 判斷(因報價轉定稿會錯)
'Public Function PUB_Add990CP(pCP01 As String, pCP02 As String, pCP03 As String, pCP04 As String, Optional pRecNo As String, Optional pCopyRecNo As String, Optional pLP33 As String, Optional pLP34 As String, Optional pNoCP27 As Boolean = False, Optional pInTrans As Boolean = False) As Boolean
Public Function PUB_Add990CP(pCP01 As String, pCP02 As String, pCP03 As String, pCP04 As String, Optional pRecNo As String, Optional pCopyRecNo As String, Optional pLP33 As String, Optional pLP34 As String, Optional pNoCP27 As Boolean = False) As Boolean
   Dim stSQL As String, intR As Integer, stCP12 As String, stCP13 As String, stCP27 As String
   Dim stLP26 As String, stLP11 As String
   'Added by Morgan 2022/3/21
   Dim rsQuery As ADODB.Recordset
   Dim stOrgCP10 As String, bolIsRegLtr As Boolean
   'end 2022/3/21
   
   If Not m_bInTrans Then
      cnnConnection.BeginTrans
   End If
   
On Error GoTo ErrHnd
   'Modified by Morgan 2018/11/21 改用D類(內部作業,不會收A類的性質)
   'pCopyRecNo = AutoNo("B", 6, 1)
   pCopyRecNo = AutoNo("D", 6, 1)
   
   If pNoCP27 Then
      stCP27 = "null"
   Else
      stCP27 = strSrvDate(1)
   End If
   
   If pRecNo <> "" Then
      stSQL = "insert into caseprogress(CP01,CP02,CP03,CP04,CP05,CP09,CP10,CP12,CP13,CP14,CP20,CP26,CP27,CP32,CP43)" & _
         " select cp01,cp02,cp03,cp04," & strSrvDate(1) & ",'" & pCopyRecNo & "','990',CP12,CP13,'" & strUserNum & "','N','N'," & stCP27 & ",'N',cp09 from caseprogress where cp09='" & pRecNo & "'"
      cnnConnection.Execute stSQL, intR
      
'Modified by Morgan 2022/3/21 正副本E化設定會不同改用模組新增後再更新相關欄位
'      stSQL = "insert into letterprogress(lp01,lp02,lp03,lp04,lp10,lp33,lp34) values('" & pCopyRecNo & "',0," & strSrvDate(1) & ",'QPGMR','Y','" & pLP33 & "','" & pLP34 & "')"
'      cnnConnection.Execute stSQL, intR
'      'Added by Morgan 2019/9/9
'      stCP13 = PUB_GetAKindSalesNo(pCP01, pCP02, pCP03, pCP04)
'      stSQL = "update LetterProgress set lp06='" & stCP13 & "' where lp01='" & pCopyRecNo & "'"
'      cnnConnection.Execute stSQL, intR
'      'end 2019/9/9
'
'      '正本已判發要更新副本相關欄位
'      stSQL = "update letterprogress a set (lp04,lp05,lp10,lp11,lp26,lp27,lp28,lp29,lp30,lp32)=(select b.lp04,b.lp05,b.lp10,b.lp11,b.lp26,b.lp27,b.lp28,b.lp29,b.lp30,b.lp32 from letterprogress b where b.lp01='" & pRecNo & "')" & _
'         " where lp01='" & pCopyRecNo & "' and exists(select * from letterprogress b where b.lp01='" & pRecNo & "' and b.lp05>0)"
'      cnnConnection.Execute stSQL, intR
'      If intR = 1 Then
'         'E化副本自動發文
'         'Modify By Sindy 2021/1/8 取消更新cp28 => cp28=cp09,
'         stSQL = "update caseprogress set cp127=to_char(sysdate,'YYYYMMDD'),cp128=to_char(sysdate,'HH24MISS') where cp09='" & pCopyRecNo & "' and exists(select * from caseprogress b where b.cp09='" & pRecNo & "' and cp154='QPGMR')"
'         cnnConnection.Execute stSQL, intR
'         If intR = 1 Then
'            stSQL = "update caseprogress set cp154='QPGMR' where cp09='" & pCopyRecNo & "'"
'            cnnConnection.Execute stSQL, intR
'         End If
'      End If
'      'end 2018/11/21

      stSQL = "select cp10,lp52 from caseprogress,letterprogress where cp09='" & pRecNo & "' and lp01(+)=cp09"
      intR = 1
      Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
      PUB_AddLetterProgress pCopyRecNo, 0, True, "QPGMR", IIf("" & rsQuery("lp52") = "Y", True, False), pLP33, rsQuery("cp10")
      '清除繪圖發後補看人員,更新收受人,聯絡人
      stSQL = "update LetterProgress set lp22='',lp33='" & pLP33 & "',lp34='" & pLP34 & "' where lp01='" & pCopyRecNo & "'"
      cnnConnection.Execute stSQL, intR
      '正本已判發要更新副本相關欄位
      stSQL = "update letterprogress a set (lp04,lp05,lp10,lp27,lp28,lp29,lp30,lp32)=(select b.lp04,b.lp05,b.lp10,b.lp27,b.lp28,b.lp29,b.lp30,b.lp32 from letterprogress b where b.lp01='" & pRecNo & "')" & _
         " where lp01='" & pCopyRecNo & "' and exists(select * from letterprogress b where b.lp01='" & pRecNo & "' and b.lp05>0)"
      cnnConnection.Execute stSQL, intR
'end 2022/3/21
      
   Else
      stCP13 = PUB_GetAKindSalesNo(pCP01, pCP02, pCP03, pCP04)
      stCP12 = GetSalesArea(stCP13)
      stSQL = "insert into caseprogress(CP01,CP02,CP03,CP04,CP05,CP09,CP10,CP12,CP13,CP14,CP20,CP26,CP27,CP32)" & _
         " values('" & pCP01 & "','" & pCP02 & "','" & pCP03 & "','" & pCP04 & "'," & strSrvDate(1) & ",'" & pCopyRecNo & "','990','" & stCP12 & "','" & stCP13 & "','" & strUserNum & "','N','N'," & stCP27 & ",'N')"
      cnnConnection.Execute stSQL, intR
   End If
           
   
   If Not m_bInTrans Then
      cnnConnection.CommitTrans
   End If
   
   PUB_Add990CP = True
   Exit Function
   
ErrHnd:

   If Not m_bInTrans Then
      cnnConnection.RollbackTrans
      MsgBox Err.Description, vbCritical
   Else
      Err.Raise Err.Number
   End If
   
End Function

'Added by Morgan 2016/10/14
'|&...&|:符號間的內容副本不印
Private Function ChgCCContent(ByVal pContent As String) As String
   Dim iPos1 As Integer, iPos2 As Integer
   
   '刪除|&...&|內容
   iPos1 = InStr(pContent, "|&")
   If iPos1 > 0 Then
      iPos2 = InStr(iPos1 + 2, pContent, "&|")
      If iPos2 > iPos1 Then
         pContent = Left(pContent, iPos1 - 1) & Mid(pContent, iPos2 + 2)
      End If
   End If
   pContent = Replace(pContent, "<指定信箱>", "<指定信箱-副>")
   pContent = Replace(pContent, "<中申開窗郵號>", "<中申開窗郵號-副>")
   pContent = Replace(pContent, "<中申開窗郵號/掛>", "<中申開窗郵號/掛-副>")
   pContent = Replace(pContent, "<中申開窗郵號/平>", "<中申開窗郵號/平-副>")
   pContent = Replace(pContent, "<中申開窗郵號/被授權>", "<中申開窗郵號/被授權-副>")
   pContent = Replace(pContent, "<中申開窗郵號/移轉>", "<中申開窗郵號/移轉-副>")
   pContent = Replace(pContent, "<中申開窗郵號/移轉人>", "<中申開窗郵號/移轉人-副>")
   pContent = Replace(pContent, "<中申開窗郵號/相關被授權>", "<中申開窗郵號/相關被授權-副>")
   
   pContent = Replace(pContent, "<中申開窗地址>", "<中申開窗地址-副>")
   pContent = Replace(pContent, "<中申開窗地址/集體>", "<中申開窗地址/集體-副>")
   pContent = Replace(pContent, "<中申開窗地址/多個案號>", "<中申開窗地址/多個案號-副>")
   pContent = Replace(pContent, "<中申開窗地址/被授權>", "<中申開窗地址/被授權-副>")
   pContent = Replace(pContent, "<中申開窗地址/移轉>", "<中申開窗地址/移轉-副>")
   pContent = Replace(pContent, "<中申開窗地址/移轉人>", "<中申開窗地址/移轉人-副>")
   pContent = Replace(pContent, "<中申開窗地址/相關被授權>", "<中申開窗地址/相關被授權-副>")
   
   pContent = Replace(pContent, "副本：", "|#(框線)副本#|：")
   ChgCCContent = pContent
End Function

'Added by Morgan 2016/12/5
'檢查有設定副本收受人時自動內部收文990(不上發文)
Public Function PUB_ChkCC(pCP01 As String, pCP02 As String, pCP03 As String, pCP04 As String, pCP09 As String, Optional p990CP09 As String) As Boolean
   Dim stCustNo As String, stCustName As String
   Dim stSQL As String, intQ As Integer, rsQuery As ADODB.Recordset
   
   If PUB_GetCC(pCP01, pCP02, pCP03, pCP04, stCustNo) = True Then
      stSQL = "select cp09 from caseprogress where cp43='" & pCP09 & "' and cp10='990' and cp27 is null"
      intQ = 1
      Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
      If intQ = 1 Then
         p990CP09 = rsQuery(0)
      ElseIf intQ = 0 Then
         If PUB_Add990CP(pCP01, pCP02, pCP03, pCP04, pCP09, p990CP09, , , True) = False Then
            Exit Function
         End If
      Else
         Exit Function
      End If
      If ClsPDGetCustomerNameAndAddress(stCustNo, stCustName) Then
         MsgBox "本案需通知副本收受人( " & stCustName & " )！" & vbCrLf & vbCrLf & "請製作副本客戶函上傳至副本信函(" & p990CP09 & ")的卷宗區！", vbInformation
      Else
         Exit Function
      End If
   End If
   PUB_ChkCC = True
   
   Set rsQuery = Nothing
End Function
'end 2016/12/5

'Added by Morgan 2022/2/21
'客戶函發文日
'pDate:發文日期(沒傳為系統日)
'pPrintDay:是否帶出日
Public Function PUB_GetCusLetterDate(Optional pDate As String = "", Optional pPrintDay As Boolean = False) As String
   Dim strDate As String
   
   If pDate <> "" Then
      strDate = DBDATE(pDate)
   Else
      strDate = strSrvDate(1)
   End If
   PUB_GetCusLetterDate = "中華民國" & Val(Mid(strDate, 1, 4)) - 1911 & "(" & Mid(strDate, 1, 4) & ")年" & Mid(strDate, 5, 2) & "月" & IIf(pPrintDay, Right(strDate, 2), "   ") & "日"
   
End Function

'Added by Morgan 2022/2/21
'客戶函原始檔FTP路徑
Public Function PUB_GetCusOrgFilePath(pCP09 As String, Optional pErrMsg As String = "") As String
   Dim stSQL As String
   Dim intQ As Integer
   Dim RsQ As ADODB.Recordset
   
   stSQL = "select cpf13,cpf02 from caseprogress,casepaperfile where cp09='" & pCP09 & "' and cpf01(+)=cp09" & _
      " and (substr(upper(cpf02),-1*(length(cp10)+9))='.'||cp10 ||'.CUS.DOC' or substr(upper(cpf02),-1*(length(cp10)+10))='.'||cp10 ||'.CUS.DOCX')"
   intQ = 1
   Set RsQ = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      If RsQ.RecordCount = 1 Then
         PUB_GetCusOrgFilePath = RsQ.Fields("cpf13")
      End If
   End If
End Function

'Added by Morgan 2022/2/21
'客戶函檔名
Public Function PUB_GetCusLetterName(pCP09 As String) As String
   Dim stSQL As String
   Dim intQ As Integer
   Dim RsQ As ADODB.Recordset
   
   stSQL = "select cp01,cp02,cp03,cp04,cp10 from caseprogress where cp09='" & pCP09 & "'"
   intQ = 1
   Set RsQ = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      PUB_GetCusLetterName = PUB_CaseNo2FileName(RsQ("cp01"), RsQ("cp02"), RsQ("cp03"), RsQ("cp04")) & "." & RsQ("cp10") & ".CUS.PDF"
   End If
   Set RsQ = Nothing
End Function
'Added by Morgan 2022/2/21
'客戶函加發文日轉PDF(原始檔下載,更新發文日,轉PDF上傳卷宗區)
'回傳 pPdfFileName: 卷宗區檔名
Public Function PUB_MakeCusPdf(ByVal pCP09 As String, ByRef pPDFFileName As String) As Boolean
   Dim stOrgFtpPath As String
   Dim stFindStr As String, stReplaceStr As String
   Dim strLetterDate As String, ii As Integer
   Dim bolFind As Boolean
   Dim bDelPdf As Boolean
   Dim stFilePath As String, stDocPath As String, stDocName As String
   Dim stPdfPath As String
   Dim oFileSys As New FileSystemObject
   Dim oFile
   
   stOrgFtpPath = PUB_GetCusOrgFilePath(pCP09)
   If stOrgFtpPath = "" Then
      If MsgBox("無法下載客戶函原始檔，請自行確認客戶函內的發文日期是否正確，是否要繼續？", vbYesNo + vbQuestion + vbDefaultButton2) = vbYes Then
         PUB_MakeCusPdf = True
      Else
         PUB_MakeCusPdf = False
      End If
      Exit Function
   End If
   
   pPDFFileName = PUB_GetCusLetterName(pCP09)
   
   stFilePath = App.path & "\" & strUserNum
   stDocPath = stFilePath & "\$TEMP.doc"
   stPdfPath = stFilePath & "\" & pPDFFileName
   
   If Dir(stFilePath, vbDirectory) = "" Then
      MkDir stFilePath
   End If
   
   If Dir(stDocPath) <> "" Then
      Kill stDocPath
   End If
   
   If Dir(stPdfPath) <> "" Then
      Kill stPdfPath
   End If
   
   If PUB_GetFtpFile(stOrgFtpPath, stDocPath, "CASEPAPERFILE", True) Then
      'Modified by Morgan 2025/11/11 商標的歷程也要用，改寫函數
      'stFindStr = PUB_GetCusLetterDate
      'stReplaceStr = PUB_GetCusLetterDate(, True)
      'If TypeName(g_WordAp) <> "Application" Then
      '   Set g_WordAp = New Word.Application
      'End If
      'g_WordAp.Documents.Open stDocPath
      'g_WordAp.Selection.Find.ClearFormatting
      'g_WordAp.Selection.Find.Text = stFindStr
      'g_WordAp.Selection.Find.Replacement.Text = ""
      'bolFind = g_WordAp.Selection.Find.Execute()
      'If Not bolFind Then
      '    '可能有跨月或跨年問題,用上個月日期再搜尋一次
      '   strLetterDate = CompDate(1, -1, strSrvDate(1))
      '   stFindStr = PUB_GetCusLetterDate(strLetterDate)
      '   g_WordAp.Selection.Find.Text = stFindStr
      '   bolFind = g_WordAp.Selection.Find.Execute()
      'End If
      'If bolFind Then
      '   g_WordAp.ActiveDocument.TrackRevisions = False '不要追蹤修訂否則會有標記
      '   g_WordAp.Selection.TypeText stReplaceStr
      '   g_WordAp.ActiveDocument.Save
      '   g_WordAp.ActiveDocument.ExportAsFixedFormat OutputFileName:=stPdfPath, ExportFormat:=17, OpenAfterExport:=False
      '   g_WordAp.Quit wdDoNotSaveChanges
      '   Set g_WordAp = Nothing
      If PUB_UpdCustLetterDate(stDocPath) Then
         If TypeName(g_WordAp) <> "Application" Then
            Set g_WordAp = New Word.Application
         End If
         g_WordAp.Documents.Open stDocPath
         g_WordAp.ActiveDocument.ExportAsFixedFormat OutputFileName:=stPdfPath, ExportFormat:=17, OpenAfterExport:=False
         g_WordAp.Quit wdDoNotSaveChanges
         Set g_WordAp = Nothing
      'end 2025/11/11
         If Dir(stPdfPath) <> "" Then
            strSql = "update CasePaperPDF set cpp01=cpp01 where cpp01='" & pCP09 & "' and upper(cpp02)=upper('" & pPDFFileName & "')"
            cnnConnection.Execute strSql, intI
            If intI > 0 Then
               If MsgBox("卷宗區已存在" & pPDFFileName & "，是否要覆蓋？", vbYesNo + vbQuestion + vbDefaultButton2) = vbYes Then
                  bDelPdf = True
               Else
                  Exit Function
               End If
            End If
      
            If bDelPdf Then
               PUB_DelFtpFile2 pCP09, " and upper(cpp02)=upper('" & pPDFFileName & "')" '必須在DB資料刪除前執行
               
               strSql = "delete from CasePaperPDF where cpp01='" & pCP09 & "' and upper(cpp02)=upper('" & pPDFFileName & "')"
               cnnConnection.Execute strSql, intI
            End If
      
            Set oFile = oFileSys.GetFile(stPdfPath)
            SaveAttFile_PDF pCP09, stPdfPath, oFile.Name, Format(oFile.DateLastModified, "YYYYMMDD"), Format(oFile.DateLastModified, "HHMMSS"), False, , , True
            
            '先保留工程師原始檔不更新
            'Set oFile = oFileSys.GetFile(stDocPath)
            'SaveAttFile_Org pCP09, stDocPath, oFile.Name, Format(oFile.DateLastModified, "YYYYMMDD"), Format(oFile.DateLastModified, "HHMMSS")
            
            PUB_MakeCusPdf = True
         End If
      Else
         g_WordAp.Quit wdDoNotSaveChanges
         Set g_WordAp = Nothing
         If MsgBox("原始檔內找不到需更新的發文日，請自行確認客戶函內的發文日期是否正確，是否要繼續？", vbYesNo + vbQuestion + vbDefaultButton2) = vbYes Then
            pPDFFileName = "" 'Added by Morgan 2024/11/6 發文判斷沒有轉檔不要刪除卷宗區客戶函
            PUB_MakeCusPdf = True
         Else
            PUB_MakeCusPdf = False
         End If
      End If
   End If
   
End Function

'Modified by Morgan 2018/9/13 從內專發文移來
'Added by Morgan 2016/11/25
Public Function PUB_Make990Pdf(ByVal pCP01 As String, ByVal p990CP09 As String, ByVal pDocFtpPath As String, ByVal pPDFFileName As String, Optional ByVal pRegisteredMail As Boolean = False) As Boolean
   'Dim stOs_Printer As String 'Removed by Morgan 2018/9/13
   Dim stDocPath As String, stSrcDocPath As String
   Dim st990PdfPath As String, st990DocPath As String, st990DocName As String
   Dim oFileSys As New FileSystemObject
   Dim oFile
   
   stDocPath = App.path & "\" & strUserNum
   stSrcDocPath = stDocPath & "\$TEMP.doc"
   st990PdfPath = stDocPath & "\" & pPDFFileName
   st990DocName = Replace(UCase(pPDFFileName), ".PDF", ".DOC")
   st990DocPath = stDocPath & "\" & st990DocName
   If Dir(stDocPath, vbDirectory) = "" Then
      MkDir stDocPath
   End If
   
   If Dir(stSrcDocPath) <> "" Then
      Kill stSrcDocPath
   End If
   
   If Dir(st990PdfPath) <> "" Then
      Kill st990PdfPath
   End If
   
   If Dir(st990DocPath) <> "" Then
      Kill st990DocPath
   End If
   
   If PUB_GetFtpFile(pDocFtpPath, stSrcDocPath, "CASEPAPERFILE", True) Then
      'Removed by Morgan 2018/9/13
      'stOs_Printer = PUB_GetOsDefaultPrinter
      'PUB_SetOsDefaultPrinter "PDFCreator"
      'PUB_SetWordActivePrinter
      'end 2018/9/13
      
      NowPrint p990CP09, IIf(pCP01 = "P", "02", "01"), IIf(pRegisteredMail, "91", "90"), True, strUserNum, , , , , , , , , False, , , , , , , True
      
      
      'PUB_SetOsDefaultPrinter stOs_Printer 'Removed by Morgan 2018/9/13
      
      g_WordAp.Documents.Open stSrcDocPath
      g_WordAp.Selection.Find.ClearFormatting
      g_WordAp.Selection.Find.Text = "敬啟者："
      If g_WordAp.Selection.Find.Execute Then
         g_WordAp.Selection.EndKey Unit:=wdLine
         g_WordAp.Selection.EndKey Unit:=wdStory, Extend:=wdExtend
         g_WordAp.Selection.Copy
         g_WordAp.ActiveDocument.Close wdDoNotSaveChanges
         g_WordAp.Selection.Paste
         
         'Modified by Morgan 2018/9/13
         'frmPDF.Show
         'frmPDF.StartProcess stDocPath, pPdfFileName
         'g_WordAp.PrintOut Background:=False, Copies:=1, Collate:=True
         'frmPDF.EndtProcess
         'Unload frmPDF
         g_WordAp.ActiveDocument.SaveAs st990DocPath
         g_WordAp.ActiveDocument.ExportAsFixedFormat OutputFileName:=st990PdfPath, ExportFormat:=17, OpenAfterExport:=False
         'end 2018/9/13
         
         g_WordAp.Quit wdDoNotSaveChanges
         If Dir(stDocPath & "\" & pPDFFileName) <> "" Then
            Set oFile = oFileSys.GetFile(st990PdfPath)
            SaveAttFile_PDF p990CP09, st990PdfPath, oFile.Name, Format(oFile.DateLastModified, "YYYYMMDD"), Format(oFile.DateLastModified, "HHMMSS"), False, , , True
            
            Set oFile = oFileSys.GetFile(st990DocPath)
            SaveAttFile_Org p990CP09, st990DocPath, st990DocName, Format(oFile.DateLastModified, "YYYYMMDD"), Format(oFile.DateLastModified, "HHMMSS")
            
            PUB_Make990Pdf = True
         End If
      End If
   End If
   
End Function

'Added by Lydia 2016/12/22 內商之非爭議案核准或註冊證輸入,原本定稿的欠款資料改成D類收文控制(1728)
'Modified by Lydia 2017/04/06 + strSpec 特定代理人->mail內文不同
'Modified by Lydia 2023/04/11 +iAppNo 申請人1~5
Public Function PUB_CheckA1kdataMail(ByVal iT01 As String, ByVal iT02 As String, ByVal iT03 As String, ByVal iT04 As String, ByVal iT44 As String, ByVal iAppNo As String, ByVal pCP09 As String, ByVal pCP10 As String, ByVal pCP13 As String, ByVal nCP09 As String, ByRef uLD02 As String, ByRef strAC2470 As String, ByRef strSpec As String) As Boolean
'iT01~iT04  本所案號
'iT44       FC代理人
'pCP09/pCP13      發核准點選的案件進度
'nCP09                  核准或註冊證輸入產生的進度
'uLD02      更新定稿日期
'strAC2470  定稿加印催款單
Dim strA1kdata As String
Dim strNewCP09 As String
Dim strList As String 'Added by Lydia 2017/01/19
Dim strListMail As String 'Added by Lydia 2025/08/07

    PUB_CheckA1kdataMail = False
    uLD02 = ""
    strAC2470 = ""
    strSpec = "N" 'Added by Lydia 2017/04/06
    
    'Modified by Lydia 2017/01/03 判斷有誤
    'If iT01 <> "T" And (pCP10 = "101" Or pCP10 = "308") Then
    '   Exit Function
    'Else
    If iT01 = "T" And pCP10 <> "101" And pCP10 <> "308" Then
    'end 2017/01/03
       'Modified by Lydia 2017/04/06 +抓請款對象
       'strA1kdata = GetT_020_a1k_data(iT01, iT02, iT03, iT04, "2", True)
       strA1kdata = GetT_020_a1k_data(iT01, iT02, iT03, iT04, "2", True, strAC2470)
       If strA1kdata <> "" Then
           PUB_CheckA1kdataMail = True
           '若FC代理人(TM44)為Y54181或Y52618時，加印該案件之催款單電子檔
           'Modified by Lydia 2017/01/05 直接寄証 +Y51566 上海建毅
           'Modified by Lydia 2017/01/19 改存在系統特殊設定
           'If Mid(iT44, 1, 6) = "Y54181" Or Mid(iT44, 1, 6) = "Y52618" Or Mid(iT44, 1, 6) = "Y51566" Then
           'Modified by Lydia 2024/09/20 變更名稱
           'strList = Pub_GetSpecMan("收款寄證特定代理人")
           strList = Pub_GetSpecMan("收款寄證排除代理人")
           strListMail = Pub_GetSpecMan("收款寄證只印催款單") 'Added by Lydia 2025/08/07
           'Modified by Lydia 2023/04/11 FC代理人為Y21399000且申請人為X51886000時，不做收款寄證之控制。
           'If Mid(iT44, 1, 6) <> "" And InStr(strList, Mid(iT44, 1, 6)) > 0 Then
           'Modified by Lydia 2025/08/07 Y2139900 永新專利(僅限X5188600華為)只印催款單
           'If (Mid(iT44, 1, 6) <> "" And InStr(strList, Mid(iT44, 1, 6)) > 0) Or (iT44 = "Y21399000" And InStr(iAppNo, "X51886000") > 0) Then
           'Modified by Lydia 2025/11/12 增加Y52459060(大陸萬慧達楊明明)設定催款不壓核准文件(同Y5328800超凡)
           If (Mid(iT44, 1, 6) <> "" And InStr(strList, Mid(iT44, 1, 6)) > 0) Or iT44 = "Y52459060" Then
              'Memo by Lydia 2024/12/30 不產生收款寄證進度但仍印催款單(定稿)，同時產生催款函Email
              'Modified by Lydia 2017/04/06
              'strAC2470 = iT44
              strSpec = "Y"
           'Mark by Lydia 2024/06/05 原本巨京商標(96030)在今年改成為代理人Y52269之案件，比照Y53876 北京惠利爾----from 湘芸,桂英
           'ElseIf pCP13 = "96030" Then
               '智權人員為巨京商標(96030)之案件,要正常印出定稿但不開新郵件催款
           '    PUB_CheckA1kdataMail = False
           'Added by Lydia 2024/09/20 正常印出定稿但不開新郵件催款: 巨京(Y52269), 寰華(Y53374)
           'Modified by Lydia 2025/08/07 增加Y51566上海建毅,Y52404上海唯源=>改成系統特殊設定； Y2139900 永新專利(僅限X5188600華為)只印催款單
           'ElseIf (Mid(iT44, 1, 6) <> "" And InStr("Y52269,Y53374", Mid(iT44, 1, 6)) > 0) Then
           ElseIf (Mid(iT44, 1, 6) <> "" And InStr(strListMail, Mid(iT44, 1, 6)) > 0) Or (iT44 = "Y21399000" And InStr(iAppNo, "X51886000") > 0) Then
                'Memo by Lydia 2024/12/30 不產生收款寄證進度但仍印催款單(定稿)，不產生催款函Email
                PUB_CheckA1kdataMail = False
           'end 2024/09/20
           Else
                '除了上述特殊代理人及智權人員為巨京商標(96030)之案件以外，只要有欠款的案件新增D類'收款寄證'(1728)進度,同時開新郵件催款;
                '先產生定稿資料但不印出來，原定稿中之欠款資料取消，將定稿日期LD02和其他例外欄位的日期ET07的日期都放99999999，但LD16上'N'(以免整批列印被印出)，以便於下述D類'收款寄證'(1728)進度發文時可列印定稿
               uLD02 = "99999999"
           End If
           
           If uLD02 <> "" Then
             '新增D類'收款寄證'(1728)進度
             '因為產生定稿在存檔之後,若程式預設不產生定稿,要由使用者人工處理這道進度(EX.撰寫信函)
              strNewCP09 = AutoNo("D", 6)
              'Modified by Lydia 2017/05/23 系統日+3個月若為假日則抓下一個工作日; CompDate(1, 3, strSrvDate(1)) => compworkday(1,CompDate(1, 3, strSrvDate(1)),0)
              strSql = "INSERT INTO CaseProgress (CP01,CP02,CP03,CP04,CP05,CP06,CP07,CP09,CP10,CP12,CP13,CP14,CP26,CP32,CP43) " & _
                       "VALUES ('" & iT01 & "','" & iT02 & "','" & iT03 & "','" & iT04 & "','" & strSrvDate(1) & "','" & CompWorkDay(1, CompDate(1, 3, strSrvDate(1)), 0) & "','" & CompWorkDay(1, CompDate(1, 3, strSrvDate(1)), 0) & "'," & _
                         "'" & strNewCP09 & "','1728','" & GetSalesArea(pCP13) & "','" & pCP13 & "'," & _
                         "'" & strUserNum & "','N','N','" & nCP09 & "')"
              cnnConnection.Execute strSql
           End If
       End If
    End If
    
End Function


'Added by Lydia 2016/12/22 收款寄帳(1728)控制-更新定稿日期
'Modified by Lydia 2017/04/24 改成Function
'Public Sub PUB_UpdateET07LD0216(ByVal mType As String, ByVal MD04 As String, ByVal MD05 As String, ByVal MD06 As String, ByVal MD07 As String, ByVal MD08 As String, Optional ByVal MD10 As String, Optional ByRef mUpDate As String = "99999999")
Public Function PUB_UpdateET07LD0216(ByVal mType As String, ByVal MD04 As String, ByVal MD05 As String, ByVal MD06 As String, ByVal MD07 As String, ByVal MD08 As String, Optional ByVal MD10 As String, Optional ByRef mUpDate As String = "99999999")
'mType 1:延緩出定稿 ,2:可以出定稿
'MD05~MD08 本所案號; MD04 定稿收文號; MD10 定稿別
'mUpDate 延緩日期
Dim rsUp As New ADODB.Recordset
Dim strUpd As String
Dim intU As Integer
Dim pMD04 As String  'D類收文的定稿收文號
Dim pMD10 As String  'D類收文的定稿別
'Added by Lydia 2017/04/21
Dim pSTime As String '暫存系統時間
Dim rsSearch As New ADODB.Recordset
'end 2017/04/21
Dim strUpLP01 As String
Dim strLD09 As String 'Add By Sindy 2021/3/16
   
   PUB_UpdateET07LD0216 = False 'Added by Lydia 2017/04/24
   '抓D類收文的定稿收文號,定稿別
   If mType = 2 Then
      strSql = "select nvl(d2.ld04,d1.ld04) ld04,nvl(d2.ld10,d1.ld10) ld10,d1.ld09 ld09 from caseprogress c1,caseprogress c2,letterdemand d1,letterdemand d2 " & _
               "where c1.cp09='" & MD04 & "' and c1.cp43=c2.cp09(+) " & _
               "and c1.cp09=d1.ld04(+) and c1.cp10=d1.ld09(+) and d1.ld02(+)='99999999' " & _
               "and c2.cp09=d2.ld04(+) and c2.cp10=d2.ld09(+) and d2.ld02(+)='99999999' "
      intU = 1
      Set rsUp = ClsLawReadRstMsg(intU, strSql)
      If intU = 1 Then
         'Modified by Lydia 2017/10/18 + "" &
         pMD04 = "" & rsUp.Fields(0)
         pMD10 = "" & rsUp.Fields(1)
         'end 2017/10/18
         strLD09 = "" & rsUp.Fields(2) 'Add By Sindy 2021/3/16
      End If
      Set rsUp = Nothing
   End If
   
On Error GoTo ErrUpd01

    '延緩出定稿
    If mType = "1" Then
      cnnConnection.BeginTrans
        'Modified by Lydia 2017/08/23 定稿時間不可重複
        'strSql = "update letterdemand set ld16='N',ld02='" & mUpDate & "' where ld05='" & MD05 & "' and ld06='" & MD06 & "' and ld07='" & MD07 & "' and ld08='" & MD08 & "'" & _
                 " and ld04='" & MD04 & "'" & IIf(MD10 = "", "", " and ld10='" & MD10 & "'") & _
                 " and ld16 is null and ld01='" & strUserNum & "' "
'        If mUpDate = "99999999" Then
'           pSTime = PUB_GetUniqeLD03(strUserNum, "99999999", Format(ServerTime, "000000"))
'        End If
        'Modified by Lydia 2018/05/03 debug (造成T211995的註冊證CA7019744定稿時間和T211649(CA7019744)重複
        'strSql = "update letterdemand set ld16='N',ld02='" & mUpDate & "'" & IIf(mUpDate = "9", ",ld03=" & pSTime, "") & " where ld05='" & MD05 & "' and ld06='" & MD06 & "' and ld07='" & MD07 & "' and ld08='" & MD08 & "'" & _
                 " and ld04='" & MD04 & "'" & IIf(MD10 = "", "", " and ld10='" & MD10 & "'") & _
                 " and ld16 is null and ld01='" & strUserNum & "' "
'         strSql = "update letterdemand set ld16='N',ld02='" & mUpDate & "'" & IIf(mUpDate = "99999999", ",ld03=" & pSTime, "") & _
'                  " where ld05='" & MD05 & "' and ld06='" & MD06 & "' and ld07='" & MD07 & "' and ld08='" & MD08 & "'" & _
'                  " and ld04='" & MD04 & "'" & IIf(MD10 = "", "", " and ld10='" & MD10 & "'") & _
'                  " and ld16 is null and ld01='" & strUserNum & "' "
'         cnnConnection.Execute strSql, intU
'         'end 2017/08/23
         'Modify By Sindy 2021/8/19 T-231608~10 註冊證多個定稿(英文定稿+英譯)
         strSql = "select * from letterdemand " & _
                  " where ld05='" & MD05 & "' and ld06='" & MD06 & "' and ld07='" & MD07 & "' and ld08='" & MD08 & "'" & _
                  " and ld04='" & MD04 & "'" & IIf(MD10 = "", "", " and ld10='" & MD10 & "'") & _
                  " and ld16 is null and ld01='" & strUserNum & "' "
         intU = 1
         Set rsUp = ClsLawReadRstMsg(intU, strSql)
         If intU = 1 Then
            rsUp.MoveFirst
            Do While Not rsUp.EOF
               pSTime = PUB_GetUniqeLD03(strUserNum, "99999999", Format(rsUp.Fields("ld03"), "000000"))
         '2021/8/19 END
               strSql = "update letterdemand set ld16='N',ld02='" & mUpDate & "'" & IIf(mUpDate = "99999999", ",ld03=" & pSTime, "") & _
                        " where ld05='" & MD05 & "' and ld06='" & MD06 & "' and ld07='" & MD07 & "' and ld08='" & MD08 & "'" & _
                        " and ld04='" & MD04 & "'" & IIf(MD10 = "", "", " and ld10='" & MD10 & "'") & _
                        " and ld16 is null and ld01='" & strUserNum & "' " & _
                        " and ld02=" & rsUp.Fields("ld02") & " and ld03=" & rsUp.Fields("ld03")
               cnnConnection.Execute strSql, intU
               rsUp.MoveNext
            Loop
            'If intU > 0 Then
               strSql = "update exceptcondition set et07='" & mUpDate & "' where et04='" & strUserNum & "' and et02='" & MD04 & "'" & IIf(MD10 = "", "", " and et01='" & MD10 & "'")
               cnnConnection.Execute strSql, intU
               
               'Add By Sindy 2020/12/15 延緩信函進度產生定稿電子檔
               'strSql = "update letterprogress set lp09=" & mUpDate & ",lP10=null where lp01='" & MD04 & "'"
               strSql = "select ld18 from letterdemand" & _
                        " where ld05='" & MD05 & "' and ld06='" & MD06 & "' and ld07='" & MD07 & "' and ld08='" & MD08 & "'" & _
                        " and ld04='" & MD04 & "'" & IIf(MD10 = "", "", " and ld10='" & MD10 & "'") & _
                        " and ld02='99999999' and ld01='" & strUserNum & "'"
               intU = 1
               Set rsUp = ClsLawReadRstMsg(intU, strSql)
               If intU = 1 Then
                  strUpLP01 = "" & rsUp.Fields("ld18")
               End If
               Set rsUp = Nothing
               If strUpLP01 <> "" Then
                  Call PUB_NotCusLP(strUpLP01) '不出客戶函
                  strSql = "update letterprogress set lp09=" & mUpDate & " where lp01='" & strUpLP01 & "'"
                  cnnConnection.Execute strSql, intU
               End If
               '2020/12/15 END
            'End If
         End If
         Set rsUp = Nothing
         
      cnnConnection.CommitTrans
      
    '可以出定稿
    ElseIf mType = "2" And pMD04 <> "" And pMD10 <> "" Then
      'cnnConnection.BeginTrans 放在發文存檔
        If mUpDate = "99999999" Then mUpDate = strSrvDate(1)
        'Modifie by Lydia 2017/01/25 原定稿改由"收款寄證"發文人員列印 =>+ ld01='" & strUserNum & "'
        'Modified by Lydia 2017/03/27 為了維持定稿順序,一併變更定稿時間 => + ld03=" & format(servertime,"000000") & ",
      'Modified by Lydia 2017/04/21 改成迴圈判斷是否為中文定稿(type)和定稿時間不可重複
      '  strSql = "update letterdemand set ld01='" & strUserNum & "', ld16=null, ld02='" & mUpDate & "', ld03=" & Format(ServerTime, "000000") & ", ld15=replace(ld15,substr(ld15,instr(ld15,'發函日期：')+5,11),'" & PUB_DBYEAR(strSrvDate(1)) & "年" & PUB_DBMONTH(strSrvDate(1)) & "月" & PUB_DBDAY(strSrvDate(1)) & "日" & "')" & _
                 " where ld05='" & MD05 & "' and ld06='" & MD06 & "' and ld07='" & MD07 & "' and ld08='" & MD08 & "'" & _
                 " and ld02='99999999' and ld04='" & pMD04 & "' and ld10='" & pMD10 & "' "
                 
      '  cnnConnection.Execute strSql, intU
      '  If intU > 0 Then
      '      'Modified by Lydia 2017/01/25 原定稿改由"收款寄證"發文人員列印 =>+ et04='" & strUserNum & "'
      '      strSql = "update exceptcondition set et04='" & strUserNum & "', et07='" & mUpDate & "' where et07='99999999' and et02='" & pMD04 & "' and et01='" & pMD10 & "' "
      '      cnnConnection.Execute strSql, intU
      '  End If
      ''cnnConnection.CommitTrans
      strSql = "select ld01,ld02,ld03,ld04,ld05,ld06,ld07,ld08,ld09,ld10,ld11,ld12,ld13,decode(sign(instr(ld15,'發函日期：')),1,'Y',decode(sign(instr(ld15,'中華民國')),1,'Y','N')) type " & _
               "from letterdemand where ld05='" & MD05 & "' and ld06='" & MD06 & "' and ld07='" & MD07 & "' and ld08='" & MD08 & "' and ld02='99999999' and ld04='" & pMD04 & "' and ld10='" & pMD10 & "' " & _
               "order by ld11" '依處理狀況排序
      intU = 1
      Set rsUp = ClsLawReadRstMsg(intU, strSql)
      If intU = 1 Then
         rsUp.MoveFirst
         Do While Not rsUp.EOF
            '記錄時間
            If pSTime = "" Then
              pSTime = Format(ServerTime, "000000")
            Else '多定稿->差一秒
              'Modified by Lydia 2017/08/23
              'pSTime = Format(Val(pSTime) + 1, "000000")
              pSTime = Val(Format(DateAdd("s", 1, Format(pSTime, "##:##:##")), "HHMMSS"))
            End If
            
            '中文定稿
            If "" & rsUp.Fields("type") = "Y" Then
                'Modified by Lydia 2020/06/05 參考frm000001; ex.T-221876內文的公告日被變更到
                'strSql = "update letterdemand set ld01='" & strUserNum & "', ld16=null, ld02='" & mUpDate & "', ld03=" & pSTime & ", ld15=replace(ld15,substr(ld15,instr(ld15,'發函日期：')+5,11),'" & PUB_DBYEAR(strSrvDate(1)) & "年" & PUB_DBMONTH(strSrvDate(1)) & "月" & PUB_DBDAY(strSrvDate(1)) & "日" & "')" & _
                         " where ld05='" & MD05 & "' and ld06='" & MD06 & "' and ld07='" & MD07 & "' and ld08='" & MD08 & "' and ld11='" & rsUp.Fields("ld11") & "'" & _
                         " and ld02='99999999' and ld03=" & CNULL("" & rsUp.Fields("ld03"), True) & " and ld04='" & pMD04 & "' and ld10='" & pMD10 & "' and instr(LD15,'發函日期：') > 0 "
                strSql = "update letterdemand set ld01='" & strUserNum & "', ld16=null, ld02='" & mUpDate & "', ld03=" & pSTime & ", ld15=replace(ld15,substr(ld15,instr(ld15,'發函日期：'),16),'發函日期：" & PUB_DBYEAR(strSrvDate(1)) & "年" & PUB_DBMONTH(strSrvDate(1)) & "月" & PUB_DBDAY(strSrvDate(1)) & "日" & "')" & _
                         " where ld05='" & MD05 & "' and ld06='" & MD06 & "' and ld07='" & MD07 & "' and ld08='" & MD08 & "' and ld11='" & rsUp.Fields("ld11") & "'" & _
                         " and ld02='99999999' and ld03=" & CNULL("" & rsUp.Fields("ld03"), True) & " and ld04='" & pMD04 & "' and ld10='" & pMD10 & "' and instr(LD15,'發函日期：') > 0 "
                cnnConnection.Execute strSql, intU
                'Modified by Lydia 2019/11/25 增加中民西的顯示, ex: 108(2019)年11月22日
                'strSql = "update letterdemand set ld01='" & strUserNum & "', ld16=null, ld02='" & mUpDate & "', ld03=" & pSTime & ", ld15=replace(ld15,substr(ld15,instr(ld15,'中華民國')+4,11),'" & PUB_DBYEAR(strSrvDate(1)) & "年" & PUB_DBMONTH(strSrvDate(1)) & "月" & PUB_DBDAY(strSrvDate(1)) & "日" & "')" & _
                         " where ld05='" & MD05 & "' and ld06='" & MD06 & "' and ld07='" & MD07 & "' and ld08='" & MD08 & "' and ld11='" & rsUp.Fields("ld11") & "'" & _
                         " and ld02='99999999' and ld03=" & CNULL("" & rsUp.Fields("ld03"), True) & " and ld04='" & pMD04 & "' and ld10='" & pMD10 & "' and instr(LD15,'中華民國') > 0 "
                'cnnConnection.Execute strSql, intU
                '舊制:中民=>中民西
                strUpd = PUB_DBYEAR(strSrvDate(1))
                'Modified by Lydia 2020/06/05 參考frm000001
                'strSql = "update letterdemand set ld01='" & strUserNum & "', ld16=null, ld02='" & mUpDate & "', ld03=" & pSTime & ", ld15=replace(ld15,substr(ld15,instr(ld15,'中華民國')+4,11),'" & Val(strUpd) - 1911 & "(" & strUpd & ")" & "年" & PUB_DBMONTH(strSrvDate(1)) & "月" & PUB_DBDAY(strSrvDate(1)) & "日" & "')" & _
                         " where ld05='" & MD05 & "' and ld06='" & MD06 & "' and ld07='" & MD07 & "' and ld08='" & MD08 & "' and ld11='" & rsUp.Fields("ld11") & "'" & _
                         " and ld02='99999999' and ld03=" & CNULL("" & rsUp.Fields("ld03"), True) & " and ld04='" & pMD04 & "' and ld10='" & pMD10 & "' and instr(LD15,'中華民國') > 0 and substr(ld15,instr(ld15,'中華民國')+7,1)<>'(' "
                strSql = "update letterdemand set ld01='" & strUserNum & "', ld16=null, ld02='" & mUpDate & "', ld03=" & pSTime & ", ld15=replace(ld15,substr(ld15,instr(ld15,'中華民國'),15),'中華民國" & Val(strUpd) - 1911 & "(" & strUpd & ")" & "年" & PUB_DBMONTH(strSrvDate(1)) & "月" & PUB_DBDAY(strSrvDate(1)) & "日" & "')" & _
                         " where ld05='" & MD05 & "' and ld06='" & MD06 & "' and ld07='" & MD07 & "' and ld08='" & MD08 & "' and ld11='" & rsUp.Fields("ld11") & "'" & _
                        " and ld02='99999999' and ld03=" & CNULL("" & rsUp.Fields("ld03"), True) & " and ld04='" & pMD04 & "' and ld10='" & pMD10 & "' and instr(LD15,'中華民國') > 0 and substr(ld15,instr(ld15,'中華民國')+7,1)<>'(' "
                cnnConnection.Execute strSql, intU
                '新制:中民西=>中民西
                'Modified by Lydia 2020/06/05 參考frm000001
                'strSql = "update letterdemand set ld01='" & strUserNum & "', ld16=null, ld02='" & mUpDate & "', ld03=" & pSTime & ", ld15=replace(ld15,substr(ld15,instr(ld15,'中華民國')+4,16),'" & Val(strUpd) - 1911 & "(" & strUpd & ")" & "年" & PUB_DBMONTH(strSrvDate(1)) & "月" & PUB_DBDAY(strSrvDate(1)) & "日" & "')" & _
                         " where ld05='" & MD05 & "' and ld06='" & MD06 & "' and ld07='" & MD07 & "' and ld08='" & MD08 & "' and ld11='" & rsUp.Fields("ld11") & "'" & _
                         " and ld02='99999999' and ld03=" & CNULL("" & rsUp.Fields("ld03"), True) & " and ld04='" & pMD04 & "' and ld10='" & pMD10 & "' and instr(LD15,'中華民國') > 0 and substr(ld15,instr(ld15,'中華民國')+7,1)='(' "
                strSql = "update letterdemand set ld01='" & strUserNum & "', ld16=null, ld02='" & mUpDate & "', ld03=" & pSTime & ", ld15=replace(ld15,substr(ld15,instr(ld15,'中華民國'),20),'中華民國" & Val(strUpd) - 1911 & "(" & strUpd & ")" & "年" & PUB_DBMONTH(strSrvDate(1)) & "月" & PUB_DBDAY(strSrvDate(1)) & "日" & "')" & _
                         " where ld05='" & MD05 & "' and ld06='" & MD06 & "' and ld07='" & MD07 & "' and ld08='" & MD08 & "' and ld11='" & rsUp.Fields("ld11") & "'" & _
                         " and ld02='99999999' and ld03=" & CNULL("" & rsUp.Fields("ld03"), True) & " and ld04='" & pMD04 & "' and ld10='" & pMD10 & "' and instr(LD15,'中華民國') > 0 and substr(ld15,instr(ld15,'中華民國')+7,1)='(' "
                cnnConnection.Execute strSql, intU
                'end 2019/11/25
                strSql = "update exceptcondition set et04='" & strUserNum & "', et07='" & mUpDate & "' where et07='99999999' and et02='" & pMD04 & "' and et01='" & pMD10 & "' and et03='" & rsUp.Fields("ld11") & "'"
                cnnConnection.Execute strSql, intU
            '英文定稿
            Else
                strSql = "select et06 from exceptcondition where et07='99999999' and et02='" & pMD04 & "' and et01='" & pMD10 & "' and et05='定稿發函日期' order by et03 "
                intU = 1
                Set rsSearch = ClsLawReadRstMsg(intU, strSql)
                    If intU = 1 Then
                      strExc(1) = ChgEngDate("" & rsSearch.Fields("et06"))
                      strExc(2) = ChgEngDate(strSrvDate(1))
                      strExc(3) = PUB_DBYEAR("" & rsSearch.Fields("et06")) & "年" & PUB_DBMONTH("" & rsSearch.Fields("et06")) & "月" & PUB_DBDAY("" & rsSearch.Fields("et06")) & "日"
                      strExc(4) = PUB_DBYEAR(strSrvDate(1)) & "年" & PUB_DBMONTH(strSrvDate(1)) & "月" & PUB_DBDAY(strSrvDate(1)) & "日"
                      
                      strSql = "update letterdemand set ld01='" & strUserNum & "', ld16=null, ld02='" & mUpDate & "', ld03=" & pSTime & ", LD15=REPLACE(LD15,'" & strExc(1) & "'||chr(13),'" & strExc(2) & "'||chr(13)) " & _
                               " where ld05='" & MD05 & "' and ld06='" & MD06 & "' and ld07='" & MD07 & "' and ld08='" & MD08 & "' and ld11='" & rsUp.Fields("ld11") & "'" & _
                               " and ld02='99999999' and ld03=" & CNULL("" & rsUp.Fields("ld03"), True) & " and ld04='" & pMD04 & "' and ld10='" & pMD10 & "' and instr(LD15,'" & strExc(1) & "'||chr(13)) > 0 "
                      cnnConnection.Execute strSql, intU
                      strSql = "update letterdemand set ld01='" & strUserNum & "', ld16=null, ld02='" & mUpDate & "', ld03=" & pSTime & ", LD15=REPLACE(LD15,'" & strExc(3) & "'||chr(13),'" & strExc(4) & "'||chr(13)) " & _
                               " where ld05='" & MD05 & "' and ld06='" & MD06 & "' and ld07='" & MD07 & "' and ld08='" & MD08 & "' and ld11='" & rsUp.Fields("ld11") & "'" & _
                               " and ld02='99999999' and ld03=" & CNULL("" & rsUp.Fields("ld03"), True) & " and ld04='" & pMD04 & "' and ld10='" & pMD10 & "' and instr(LD15,'" & strExc(3) & "'||chr(13)) > 0 "
                      cnnConnection.Execute strSql, intU
                      
                      'Add By Sindy 2021/8/20 英譯文中不見得需要做日期轉換, 但還是要做LD02更新日期, 放開定稿
                      strSql = "update letterdemand set ld01='" & strUserNum & "', ld16=null, ld02='" & mUpDate & "', ld03=" & pSTime & _
                               " where ld05='" & MD05 & "' and ld06='" & MD06 & "' and ld07='" & MD07 & "' and ld08='" & MD08 & "' and ld11='" & rsUp.Fields("ld11") & "'" & _
                               " and ld02='99999999' and ld03=" & CNULL("" & rsUp.Fields("ld03"), True) & " and ld04='" & pMD04 & "' and ld10='" & pMD10 & "'"
                      cnnConnection.Execute strSql, intU
                      '2021/8/20 END
                      
                      strSql = "update exceptcondition set et04='" & strUserNum & "', et07='" & mUpDate & "' where et07='99999999' and et02='" & pMD04 & "' and et01='" & pMD10 & "' and et03='" & rsUp.Fields("ld11") & "'"
                      cnnConnection.Execute strSql, intU
                Else
                    MsgBox "英文定稿未更新發函日期!"
                End If
            End If

            rsUp.MoveNext
         Loop
         
         'Add By Sindy 2020/12/29 刪除例外欄位=定稿日期,定稿以系統日產出
         strSql = "delete from EXCEPTCONDITION" & _
                  " where et07='99999999' and et02='" & pMD04 & "' and et01='" & pMD10 & "'" & _
                  " and et05='定稿日期'"
         cnnConnection.Execute strSql, intU
         
         'Add By Sindy 2020/12/15 放出定稿,信函進度可以產生定稿電子檔至卷宗區
'         strSql = "update letterprogress set lp09=0,lP10='Y'" & _
'                  " where lp01 in(select ld18 from letterdemand" & _
'                                 " where ld05='" & MD05 & "' and ld06='" & MD06 & "' and ld07='" & MD07 & "' and ld08='" & MD08 & "'" & _
'                                 " and ld02='99999999' and ld04='" & pMD04 & "' and ld10='" & pMD10 & "')"
         'Modify By Sindy 2021/1/28 + lp05=decode(lp03,0,0," & strSrvDate(1) & "), : 發文室看到的日期才會是放定稿出來的這一天
         'Modified by Lydia 2023/12/25 因為產生LetterProgress到收款寄證上發文日的時間可能半年以上，若這期間MCTF的人員有異動，就可能發生定稿要確認的人員LP06已經不是當初LetterProgress產生時的LP06人員，例：T-236299、T-236298，所以在收款寄證(1728) 更新定稿資料時要同時以最新的PUB_GetAKindSalesNo去更新LP06。
         'strSql = "update letterprogress set lp05=decode(lp03,0,0," & strSrvDate(1) & "),lp09=0,lP10='Y' where lp01='" & MD04 & "'"
         strSql = "update letterprogress set lp05=decode(lp03,0,0," & strSrvDate(1) & "),lp09=0,lP10='Y',lp06=" & CNULL(PUB_GetAKindSalesNo(MD05, MD06, MD07, MD08)) & " where lp01='" & MD04 & "'"
         cnnConnection.Execute strSql, intU
         If intU = 0 Then
            strSql = "select tm23,tm44,cp10 from caseprogress,trademark" & _
                     " where cp09='" & MD04 & "'" & _
                     " and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+)"
            intU = 1
            Set rsUp = ClsLawReadRstMsg(intU, strSql)
            If intU = 1 Then
               '通知客戶
               PUB_AddLetterProgress MD04, 0, True, , , "" & rsUp.Fields("tm23"), "" & rsUp.Fields("cp10"), "" & rsUp.Fields("tm44")
               'Add By Sindy 2021/1/26
               strSql = "update letterdemand set ld18='" & MD04 & "',ld27='CUS'" & _
                        " where ld05='" & MD05 & "' and ld06='" & MD06 & "' and ld07='" & MD07 & "' and ld08='" & MD08 & "'" & _
                        " and ld04='" & pMD04 & "'"
               cnnConnection.Execute strSql, intU
               '2021/1/26 END
            End If
            Set rsUp = Nothing
         End If
         '2020/12/15 END
         'Add By Sindy 2021/3/16 MCT註冊證為直寄
         'Modify By Sindy 2021/4/6 商標處決定將MCT註冊證改為非直寄(親送/寄送/不寄)之方式。
'         If strLD09 = "1701" Then
'            strSql = "update letterprogress set lp11='Y' where lp01='" & MD04 & "'"
'            cnnConnection.Execute strSql, intU
'         End If
         '2021/3/16 END
      End If
      'end 2017/04/21
    End If
    
    PUB_UpdateET07LD0216 = True 'Added by Lydia 2017/04/24
    Exit Function
    
ErrUpd01:
    If Err.Number <> 0 Then
       'Modified by Lydia 2017/04/24 發文可能會因為重複輸入,但未刪除舊定稿造成重覆主鍵而失敗
        'MsgBox "更新定稿日期失敗:" & Err.Description
        'cnnConnection.RollbackTrans
        If mType = "1" Then
            MsgBox "更新定稿日期失敗:" & Err.Description
            cnnConnection.RollbackTrans
        Else
            MsgBox "更新定稿日期失敗:" & Err.Description & vbCrLf & "若為重覆輸入,請先刪除舊定稿!"
        End If
        Exit Function
        'end 2017/04/24
    End If
End Function

'Add By Sindy 2015/11/26
'申請書:優先權資料
'Modify By Sindy 2017/8/1 + Optional strType As String = "3"
'strType : 0.中文 1.英文 2.日文 3.申請書
Public Function PUB_GetApplPriDate(strPA01 As String, strPA02 As String, strPA03 As String, _
      strPA04 As String, strPA08 As String, Optional strType As String = "3") As String
Dim ii As Integer
Dim rsA As New ADODB.Recordset
Dim strNation As String, strNa72 As String
   
   PUB_GetApplPriDate = ""
   
   'Modify By Sindy 2016/1/8 靜芳 : pd07優先權國家=pd09優先權存取碼 : 代表是以電子交換檢送
   '先抓非電子交換的
   'Modify By Sindy 2016/11/24 +na72:IPO國籍代碼+中文國名
   'na03 ==> 改抓取 na72
   strExc(0) = "select pd05,pd06,pd07,pd08,pd09,na03,na04,na72 from PriDate,nation" & _
               " where pd01='" & strPA01 & "' and pd02='" & strPA02 & "' and pd03='" & strPA03 & "' and pd04='" & strPA04 & "'" & _
               " and pd07=na01(+)"
   'Modify By Sindy 2017/8/4
   If strType = "3" Then '申請書
      strExc(0) = strExc(0) & _
               " and not ((pd07='011' and pd09 is not null)" & _
               " or (pd07=pd09 and pd09 is not null))"
   End If
   'Modify By Sindy 2021/7/2 外專告准定稿優先權資料的順序，先以優先權日期判斷(小->大)，若日期一樣則再以優先權案號判斷(小->大)
   strExc(0) = strExc(0) & " order by pd05 asc,pd06 asc"
   '2017/8/4 END
   intI = 1
   Set rsA = ClsLawReadRstMsg(intI, strExc(0))
   If intI = 1 Then
      rsA.MoveFirst
      ii = 0
      Do While rsA.EOF = False
         ii = ii + 1
         'Modify By Sindy 2017/8/1
         If strType = "1" Then '英文
            PUB_GetApplPriDate = PUB_GetApplPriDate & IIf(PUB_GetApplPriDate <> "", vbCrLf, "") & _
                                 ii & "." & rsA.Fields("na04") & "、" & ParserKeyWord("/", rsA.Fields("pd05"), "英") & "、" & rsA.Fields("pd06")
         ElseIf strType = "2" Then '日文
            PUB_GetApplPriDate = PUB_GetApplPriDate & IIf(PUB_GetApplPriDate <> "", vbCrLf, "") & _
                                 ii & "." & rsA.Fields("na03") & "、" & ParserKeyWord("/", rsA.Fields("pd05"), "格式") & "、" & rsA.Fields("pd06")
         Else
         '2017/8/1 END
            PUB_GetApplPriDate = PUB_GetApplPriDate & IIf(PUB_GetApplPriDate <> "", vbCrLf, "") & _
                                 ii & "." & PUB_FirstCutEngText(rsA.Fields("na72")) & "、" & Left(rsA.Fields("pd05"), 4) & "." & Mid(rsA.Fields("pd05"), 5, 2) & "." & Right(rsA.Fields("pd05"), 2) & "、" & rsA.Fields("pd06")
         End If
         'Modify By Sindy 2017/8/4
         If strType = "3" Then '申請書
            If Trim("" & rsA.Fields("pd09")) <> "" Then
               PUB_GetApplPriDate = PUB_GetApplPriDate & _
                                    "、" & IIf("" & rsA.Fields("pd08") = "", GetPatentName(strPA08, 0), GetPatentName("" & rsA.Fields("pd08"), 0)) & "、" & rsA.Fields("pd09")
            End If
         End If
         '2017/8/4 END
         rsA.MoveNext
      Loop
   End If
   rsA.Close
   
   'Modify By Sindy 2017/8/4
   If strType = "3" Then '申請書
   '2017/8/4 END
      '再抓有電子交換的
      'Modify By Sindy 2021/7/2 外專告准定稿優先權資料的順序，先以優先權日期判斷(小->大)，若日期一樣則再以優先權案號判斷(小->大)
      strExc(0) = "select pd05,pd06,pd07,pd08,pd09 from PriDate" & _
                  " where pd01='" & strPA01 & "' and pd02='" & strPA02 & "' and pd03='" & strPA03 & "' and pd04='" & strPA04 & "'" & _
                  " and ((pd07='011' and pd09 is not null)" & _
                  "     or (pd07=pd09 and pd09 is not null))" & _
                  " order by pd05 asc,pd06 asc"
      intI = 1
      Set rsA = ClsLawReadRstMsg(intI, strExc(0))
      If intI = 1 Then
         PUB_GetApplPriDate = PUB_GetApplPriDate & IIf(PUB_GetApplPriDate <> "", vbCrLf, "") & _
                              "■ |#(粗體)以電子交換方式檢送優先權證明文件：#||#(小字,粗體)(優先權證明文件以電子交換方式檢送者，僅須勾選及填寫本項資料)#|"
         rsA.Close
         '日本有電子交換
         'Modify By Sindy 2016/11/24 +na72:IPO國籍代碼+中文國名
         'Modify By Sindy 2021/7/2 外專告准定稿優先權資料的順序，先以優先權日期判斷(小->大)，若日期一樣則再以優先權案號判斷(小->大)
         strExc(0) = "select pd05,pd06,pd07,pd08,pd09,na03,na72 from PriDate,nation" & _
                     " where pd01='" & strPA01 & "' and pd02='" & strPA02 & "' and pd03='" & strPA03 & "' and pd04='" & strPA04 & "'" & _
                     " and pd07=na01(+)" & _
                     " and (pd07='011' and pd09 is not null)" & _
                     " order by pd05 asc,pd06 asc"
         intI = 1
         Set rsA = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            PUB_GetApplPriDate = PUB_GetApplPriDate & IIf(PUB_GetApplPriDate <> "", vbCrLf, "") & _
                                 "■ |#(粗體)日本：#||#(小字,粗體)【請依序註記：申請日、申請案號、國外申請專利類別、存取碼 】#|"
            rsA.MoveFirst
            ii = 0
            Do While rsA.EOF = False
               ii = ii + 1
               PUB_GetApplPriDate = PUB_GetApplPriDate & IIf(PUB_GetApplPriDate <> "", vbCrLf, "") & _
                                    ii & "." & PUB_FirstCutEngText(rsA.Fields("na72")) & "、" & Left(rsA.Fields("pd05"), 4) & "." & Mid(rsA.Fields("pd05"), 5, 2) & "." & Right(rsA.Fields("pd05"), 2) & "、" & rsA.Fields("pd06") & _
                                    "、" & IIf("" & rsA.Fields("pd08") = "", GetPatentName(strPA08, 0), GetPatentName("" & rsA.Fields("pd08"), 0)) & "、" & rsA.Fields("pd09")
               rsA.MoveNext
            Loop
         End If
         rsA.Close
         '其他國家有電子交換
         'Modify By Sindy 2016/11/24 +na72:IPO國籍代碼+中文國名
         'Modify By Sindy 2021/7/2 外專告准定稿優先權資料的順序，先以優先權日期判斷(小->大)，若日期一樣則再以優先權案號判斷(小->大)
         strExc(0) = "select pd05,pd06,pd07,pd08,pd09,na03,na72 from PriDate,nation" & _
                     " where pd01='" & strPA01 & "' and pd02='" & strPA02 & "' and pd03='" & strPA03 & "' and pd04='" & strPA04 & "'" & _
                     " and pd07=na01(+)" & _
                     " and pd07=pd09 and pd09 is not null" & _
                     " order by pd07,pd05 asc,pd06 asc"
         intI = 1
         Set rsA = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            rsA.MoveFirst
            strNation = ""
            Do While rsA.EOF = False
               strNa72 = PUB_FirstCutEngText(rsA.Fields("na72"))
               If strNation <> strNa72 Then
                  PUB_GetApplPriDate = PUB_GetApplPriDate & IIf(PUB_GetApplPriDate <> "", vbCrLf, "") & _
                                       "■ |#(粗體)" & strNa72 & "：#||#(小字,粗體)【請依序註記：申請日、申請案號 】#|"
                  ii = 0
               End If
               ii = ii + 1
               PUB_GetApplPriDate = PUB_GetApplPriDate & IIf(PUB_GetApplPriDate <> "", vbCrLf, "") & _
                                    ii & "." & strNa72 & "、" & Left(rsA.Fields("pd05"), 4) & "." & Mid(rsA.Fields("pd05"), 5, 2) & "." & Right(rsA.Fields("pd05"), 2) & "、" & rsA.Fields("pd06")
               strNation = rsA.Fields("na72")
               rsA.MoveNext
            Loop
         End If
      End If
      rsA.Close
   End If
   
   Set rsA = Nothing
End Function

'Add By Sindy
'截掉前頭英文字母
Public Function PUB_FirstCutEngText(strText As String) As String
Dim i As Integer
   For i = 1 To Len(strText)
      If Not (Asc(Mid(strText, i, 1)) >= 65 And Asc(Mid(strText, i, 1)) <= 90 Or _
         Asc(Mid(strText, i, 1)) >= 97 And Asc(Mid(strText, i, 1)) <= 122) Then
         PUB_FirstCutEngText = Mid(strText, i)
         Exit Function
      End If
   Next i
End Function

'Added by Lydia 2017/08/23 判斷定稿時間不可重複
Public Function PUB_GetUniqeLD03(ByVal pLD01 As String, ByVal pLD02 As String, pLD03 As String) As String
Dim intA As Integer, strA1 As String
Dim rsB As New ADODB.Recordset
Dim strTimeList As String
Dim strHH As String, strMM As String, strSS As String

    strA1 = "select ld03 from letterdemand where ld01='" & pLD01 & "' and ld02='" & pLD02 & "' "
    intA = 1
    Set rsB = ClsLawReadRstMsg(intA, strA1)
    If intA = 1 Then
       strTimeList = rsB.GetString(adClipString, , , ",")
       intA = InStr(strTimeList, Val(pLD03))
       strA1 = pLD03
       If intA > 0 Then
          strA1 = Val(Format(DateAdd("s", 1, Format(IIf(Len(strA1) < 5, strA1 & "00", strA1), "##:##:##")), "HHMMSS"))
       End If
       Do While intA > 0
          strA1 = Val(Format(DateAdd("s", 1, Format(strA1, "##:##:##")), "HHMMSS"))
          intA = InStr(strTimeList, strA1)
       Loop
       PUB_GetUniqeLD03 = strA1
    Else
       PUB_GetUniqeLD03 = pLD03
    End If
    Set rsB = Nothing
End Function
'Added by Morgan 2017/10/24
'平台類別代碼轉中文
Public Function PUB_GetCW03Name(pValue As String) As String
   Dim stName As String
   
   Select Case pValue
   Case "1": stName = "IP管理"
   Case "2": stName = "檔案存取"
   Case "3": stName = "電子帳單"
   Case "4": stName = "憑證"
   Case "5": stName = "線上刊物"
   Case "6": stName = "翻譯社" 'Add By Sindy 2021/3/26
   Case "7": stName = "媒介平台" 'Add By Sindy 2021/3/26
   End Select
   
   PUB_GetCW03Name = stName
End Function

'Added by Morgan 2017/10/24
'設定平台類別選單
Public Sub PUB_SetCW03Combo(pCombo As ComboBox)
   pCombo.Clear
   pCombo.AddItem "1 IP管理"
   pCombo.AddItem "2 檔案存取"
   pCombo.AddItem "3 電子帳單"
   pCombo.AddItem "4 憑證"
   pCombo.AddItem "5 線上刊物"
   pCombo.AddItem "6 翻譯社" 'Add By Sindy 2021/3/26
   pCombo.AddItem "7 媒介平台" 'Add By Sindy 2021/3/26
End Sub
'Added by Morgan 2017/10/24
'平台類別語法
Public Function PUB_GetCW03SQL() As String
   'Add By Sindy 2021/3/26 + ,'6','翻譯社','7','媒介平台'
   PUB_GetCW03SQL = "decode(cw03,'1','IP管理','2','檔案存取','3','電子帳單','4','憑證','5','線上刊物','6','翻譯社','7','媒介平台',cw03)"
End Function

'Add by Morgan 2008/4/29
'暫存檔轉定稿
'Modified by Morgan 2015/10/12 +p_UserNo:報價定稿產生人員
Public Function PUB_Cache2Letter(Optional p_LC01 As String, Optional p_LC02 As String, Optional p_bPrint As Boolean = True, Optional p_bEdit As Boolean = False, Optional p_bCheckOnly As Boolean = False, Optional p_bUpdate As Boolean = False, Optional p_UserNo As String) As Boolean
   Dim stDate As String
   Dim stSQL As String, intR As Integer, adoRst As ADODB.Recordset, adoTmp As ADODB.Recordset
   Dim stExc(4) As String, stLD02 As String, stLD03 As String
   Dim stCP64 As String, stCon As String
   Dim ChkTG As Boolean, strSysType As String, strLC04 As String 'Add By Sindy 2011/5/24
   Dim lngUS601DownFee As Long 'Added by Morgan 2013/10/21 美國領證調降金額
   'Added by Lydia 2016/05/27
   Dim rsDetail As New ADODB.Recordset
   Dim bolKeyPoint As Boolean
   'Added by Lydia 2016/08/22
   Dim stSalesAmt As String '業務報價金額
   Dim stSalesP As String '業務報價點數
   Dim UpdCP09 As String
   Dim bolConn As Boolean 'Add By Sindy 2016/10/4
   Dim strNA01 As String 'Added by Lydia 2017/05/18 案件的申請國家
   Dim strLD18 As String 'Added by Morgan 2017/12/20
   Dim strNation As String 'Add By Sindy 2022/8/11
   Dim strUPDesc As String 'Added by Morgan 2023/3/7 UP註冊費敘述
   Dim StrCaseList As String 'Added by Morgan 2023/9/15 轉定稿案件清單
   
 On Error GoTo ErrHnd
   
   ChkTG = False 'Add By Sindy 2011/5/24
   'Modify by Morgan 2008/11/26 要略過已刪除的下一程序
   If p_LC01 = "" Then
      '系統日往前 ? 個工作天日期
      stDate = CompWorkDay(報價確認天數, strSrvDate(1), 1)
      '抓未列印且已確認或超過設定天數
      'Modify By Sindy 2011/5/24
'      stSQL = "select * from lettercache,nextprogress where lc10='" & strUserNum & "' and lc13 is null and np01(+)=lc01 and np22=lc02" & _
'         " and NVL(LC06,lc11)<" & stDate
      'Modify By Sindy 2014/12/2 因為會有lc02='0'的狀況; np22=lc02 ==> np22(+)=lc02
      'Modified by Morgan 2015/10/12 +可抓指定請假人的報價定稿
      If p_UserNo = "" Then p_UserNo = strUserNum
      
      'Modified by Morgan 2016/10/6 CFP報價定稿改同P案-依所別→區別→業務→客戶--甄妮
      'stSQL = "select * from lettercache a,nextprogress b,caseprogress c where lc10='" & p_UserNo & "' and lc13 is null and np01(+)=lc01 and np22(+)=lc02 and cp09(+)=lc01" & _
           " and NVL(LC06,lc11)<" & stDate
      'Modified by Morgan 2018/10/15 +已確認也要能列印 --慧汶
      If Pub_StrUserSt03 = "P12" Then
         stSQL = "select a.*,b.*,c.*,DECODE(decode(cp01||lc04,'CFP10','1'),'1',ST06||CU12||CU13||PA26||NVL(PA149,CU127),'0') Srt,lp11,lp15,lp26,lp51" & _
            " from lettercache a,nextprogress b,caseprogress c,patent,customer,staff,letterprogress where lc10='" & p_UserNo & "' and lc13 is null and np01(+)=lc01 and np22(+)=lc02 and cp09(+)=lc01" & _
            " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04 and cu01(+)=substr(pa26,1,8) and cu02(+)=substr(pa26,9) and st01(+)=cu13 and (LC08>0 or NVL(LC06,lc11)<" & stDate & ") and lp01(+)=lc18"
      Else
         'Modified by Morgan 2018/10/26 非專利處改回不提前 --桂英
         stSQL = "select a.*,b.*,c.*,'0' Srt,lp11,lp15,lp26,lp51 from lettercache a,nextprogress b,caseprogress c,letterprogress where lc10='" & p_UserNo & "' and lc13 is null and np01(+)=lc01 and np22(+)=lc02 and cp09(+)=lc01" & _
           " and NVL(LC06,lc11)<" & stDate & " and lp01(+)=lc18"
      End If
      'end 2016/10/6
      'end 2015/10/12
      
      'Add by Morgan 2008/6/4 只檢查有無資料
      If p_bCheckOnly = True Then
         stSQL = stSQL & " and rownum<2"
      End If
      'end 2008/6/4
   
      'Modified by Morgan 2016/10/6 +Srt
      stSQL = stSQL & " order by Srt,lc11,lc12"
      
   Else
      'Modify By Sindy 2011/5/24
'      stSQL = "select * from lettercache,nextprogress where lc01='" & p_LC01 & "' and lc02='" & p_LC02 & "' and lc10='" & strUserNum & "' and np01(+)=lc01 and np22=lc02"
      'Modify By Sindy 2014/12/2 因為會有lc02='0'的狀況; np22=lc02 ==> np22(+)=lc02
      stSQL = "select * from lettercache,nextprogress,caseprogress,letterprogress where lc01='" & p_LC01 & "' and lc02='" & p_LC02 & "' and lc10='" & strUserNum & "' and np01(+)=lc01 and np22(+)=lc02 and cp09(+)=lc01 and lp01(+)=lc18"
   End If
   
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
   
      'Add by Morgan 2008/6/4 只檢查有無資料
      If p_bCheckOnly = True Then
         PUB_Cache2Letter = True
         GoTo ErrHnd
      End If
      'end 2008/6/4
      
      With adoRst
      Do While Not .EOF
         'Add By Sindy 2016/10/4
         cnnConnection.BeginTrans
         bolConn = True
         m_bInTrans = bolConn 'Added by Morgan 2023/10/18
         '2016/10/4 END
         
         strSysType = "" & .Fields("CP01") 'Add By Sindy 2011/5/24
         'Add By Sindy 2022/8/11 抓申請國家
         strNation = GetPrjNation1("" & .Fields("CP01") & "-" & .Fields("CP02") & "-" & .Fields("CP03") & "-" & .Fields("CP04"))
         
         strLC04 = "" & .Fields("LC04") 'Add By Sindy 2011/5/24
         'Added by Lydia 2016/05/27 定稿報價輸入簽核主管和點數
         bolKeyPoint = False
         strKeyPoint = "" 'Added by Lydia 2016/10/11
         Call ClsPDCheckCaseCodeIsExist("" & .Fields("CP01"), "" & .Fields("CP02"), "" & .Fields("CP03"), "" & .Fields("CP04"), , , , , strNA01) 'Added by Lydia 2017/05/18 案件的申請國別
         
         If "" & .Fields("LC17") = "Y" And TypeName(Tmpfrm880004_4) <> "Nothing" Then
            stSQL = "select lcv01,lcv02,lcv03,lcv06 from lettercachevar where lcv01='" & .Fields("LC01") & "' and lcv02='" & .Fields("LC02") & "' and instr(lcv03,'點數')>0 and instr(lcv03,'合計')=0 "
            'Added by Lydia 2016/10/11 只詢問有修改報價的項目
            stSQL = stSQL & " and lcv04<>lcv06 and nvl(lcv06,'0')>'0'"
            
            intR = 1
            Set rsDetail = ClsLawReadRstMsg(intR, stSQL)
            If intR = 1 Then
               rsDetail.MoveFirst
               Do While Not rsDetail.EOF
                   Tmpfrm880004_4.iStiu = 4
                   Tmpfrm880004_4.m_LCV01 = rsDetail.Fields("lcv01")
                   Tmpfrm880004_4.m_LCV02 = rsDetail.Fields("lcv02")
                   Tmpfrm880004_4.m_LCV03 = rsDetail.Fields("lcv03")
                   Tmpfrm880004_4.m_LCV06 = rsDetail.Fields("lcv06")
                   Tmpfrm880004_4.m_LC07 = "" & .Fields("LC07")
                   Tmpfrm880004_4.Caption = "期限通知報價點數-提高點數"
                   Tmpfrm880004_4.Show vbModal
                   rsDetail.MoveNext
               Loop
               '因為費用項目可能有一筆以上(例如:CFP馬來西亞新型案和俄羅斯設計案合併605,607定稿),所以最後更新費用和點數合計
               'Modified by Lydia 2016/10/13 sum(decode(b.lcv10,'0',b.lcv04,b.lcv10)) = > sum(decode(nvl(b.lcv10,'0'),'0',b.lcv04,b.lcv10))
               stSQL = "update lettercachevar a set a.lcv10=(select to_char(sum(decode(nvl(b.lcv10,'0'),'0',b.lcv04,b.lcv10))) from lettercachevar b where b.lcv01=a.lcv01 and b.lcv02=a.lcv02 and b.lcv05='Y') " & _
                       "where a.lcv01='" & .Fields("LC01") & "' and a.lcv02='" & .Fields("LC02") & "' and a.lcv03='費用合計' "
               cnnConnection.Execute stSQL, intR
               'Modified by Lydia 2016/10/13 sum(decode(c.lcv10,'0',c.lcv04,c.lcv10)) = > sum(decode(nvl(c.lcv10,'0'),'0',c.lcv04,c.lcv10))
               stSQL = "update lettercachevar a set a.lcv10=(select to_char(sum(decode(nvl(c.lcv10,'0'),'0',c.lcv04,c.lcv10))) from lettercachevar b ,lettercachevar c where b.lcv01=a.lcv01 and b.lcv02=a.lcv02 and b.lcv05='Y' and b.lcv01=c.lcv01(+) and b.lcv02=c.lcv02(+) and b.lcv03||'點數'=c.lcv03(+)) " & _
                       "where a.lcv01='" & .Fields("LC01") & "' and a.lcv02='" & .Fields("LC02") & "' and a.lcv03='點數合計' "
               cnnConnection.Execute stSQL, intR
            End If
            bolKeyPoint = True
         End If
         'end 2016/05/27
         
         '清除例外欄位
         stSQL = "delete EXCEPTCONDITION where et01='" & .Fields("LC04") & "'" & _
            " and et02='" & .Fields("LC03") & "' and et03='" & .Fields("LC05") & "' and et04='" & strUserNum & "'"
         cnnConnection.Execute stSQL, intR
         '新增例外欄位
         '2009/12/1 modify by sonia T-149372發註冊證LC04=05,LC05=20,點數LCV06改為0時不寫例外欄位
         'stSQL = "INSERT INTO EXCEPTCONDITION (ET01,ET02,ET03,ET04,ET05,ET06) " & _
            " SELECT '" & .Fields("LC04") & "','" & .Fields("LC03") & "','" & .Fields("LC05") & "','" & strUserNum & _
            "',LCV03,NVL(LCV06,LCV04) FROM LETTERCACHEVAR WHERE LCV01='" & .Fields("LC01") & "'" & _
            " AND LCV02='" & .Fields("LC02") & "'"
         'cnnConnection.Execute stSQL, intR
         'Modify By Sindy 2011/5/24
         'modify by sonia 2019/2/1 大陸T註冊證分二種,紙本證書LC05=20,電子證書LC05=27
         'If .Fields("CP01") = "T" And .Fields("LC04") & .Fields("LC05") = "0520" Then 'T發註冊證
         If .Fields("CP01") = "T" And .Fields("LC04") = "05" Then 'T發註冊證
            stSQL = "INSERT INTO EXCEPTCONDITION (ET01,ET02,ET03,ET04,ET05,ET06) " & _
               " SELECT '" & .Fields("LC04") & "','" & .Fields("LC03") & "','" & .Fields("LC05") & "','" & strUserNum & _
               "',LCV03,NVL(LCV06,LCV04) FROM LETTERCACHEVAR WHERE LCV01='" & .Fields("LC01") & "'" & _
               " AND LCV02='" & .Fields("LC02") & "' AND LCV03<>'領證費'"
            cnnConnection.Execute stSQL, intR
            
            '大陸領證費全文
            'Modify By Sindy 2011/8/22
            'stExc(1) = "本程序領證費用計新台幣'||TO_CHAR(NVL(LCV06,LCV04),'99G999')||'元整，尚祈費神擲寄本所。"
            stExc(1) = "本程序費用計新台幣'||TO_CHAR(NVL(LCV06,LCV04),'99G999')||'元整，尚祈費神擲寄本所。"
            stSQL = "INSERT INTO EXCEPTCONDITION (ET01,ET02,ET03,ET04,ET05,ET06) " & _
               " SELECT '" & .Fields("LC04") & "','" & .Fields("LC03") & "','" & .Fields("LC05") & "','" & strUserNum & _
               "','大陸領證費全文','" & stExc(1) & "' FROM LETTERCACHEVAR WHERE LCV01='" & .Fields("LC01") & "'" & _
               " AND LCV02='" & .Fields("LC02") & "' AND LCV03='領證費' AND (LCV06 IS NULL OR LCV06>0)"
            cnnConnection.Execute stSQL, intR
         
         'Add By Sindy 2011/5/24
         ElseIf .Fields("CP01") = "CFT" And .Fields("LC04") = "05" Then 'CFT發註冊證
            stSQL = "INSERT INTO EXCEPTCONDITION (ET01,ET02,ET03,ET04,ET05,ET06) " & _
               " SELECT '" & .Fields("LC04") & "','" & .Fields("LC03") & "','" & .Fields("LC05") & "','" & strUserNum & _
               "',LCV03,NVL(LCV06,LCV04) FROM LETTERCACHEVAR WHERE LCV01='" & .Fields("LC01") & "'" & _
               " AND LCV02='" & .Fields("LC02") & "' AND LCV03 not in('領證費','ChkTG')"
            cnnConnection.Execute stSQL, intR
            
            stSQL = "SELECT * FROM LETTERCACHEVAR WHERE LCV01='" & .Fields("LC01") & "'" & _
               " AND LCV02='" & .Fields("LC02") & "' AND LCV03='ChkTG'"
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, stSQL)
            If intI = 1 Then
               ChkTG = True
            End If
            
            '加註領證費
            'Modify By Sindy 2022/8/11
            If strNation = "101" Then '美國
               stExc(1) = "Trim(TO_CHAR(NVL(LCV06,LCV04),'99G999'))"
            Else
            '2022/8/11 END
               stExc(1) = "'本案最後領證程序費用為新台幣'||Trim(TO_CHAR(NVL(LCV06,LCV04),'99G999'))||'元整，敬請撥冗惠付！不勝感荷。'" & vbCrLf
            End If
            stSQL = "INSERT INTO EXCEPTCONDITION (ET01,ET02,ET03,ET04,ET05,ET06) " & _
               " SELECT '" & .Fields("LC04") & "','" & .Fields("LC03") & "','" & .Fields("LC05") & "','" & strUserNum & _
               "','加註領證費'," & stExc(1) & " FROM LETTERCACHEVAR WHERE LCV01='" & .Fields("LC01") & "'" & _
               " AND LCV02='" & .Fields("LC02") & "' AND LCV03='領證費' AND (LCV06 IS NULL OR LCV06>0)"
            cnnConnection.Execute stSQL, intR
         '2011/5/24 End
         
         Else
            'Modified by Lydia 2016/05/27 有定稿報價輸入簽核主管和點數,改抓簽核點數;若簽核點數=0,表示該主管不同意提高點數,要抓程序報價
            'stSQL = "INSERT INTO EXCEPTCONDITION (ET01,ET02,ET03,ET04,ET05,ET06) " & _
               " SELECT '" & .Fields("LC04") & "','" & .Fields("LC03") & "','" & .Fields("LC05") & "','" & strUserNum & _
               "',LCV03,NVL(LCV06,LCV04) FROM LETTERCACHEVAR WHERE LCV01='" & .Fields("LC01") & "'" & _
               " AND LCV02='" & .Fields("LC02") & "'"
            stSQL = "INSERT INTO EXCEPTCONDITION (ET01,ET02,ET03,ET04,ET05,ET06) " & _
               " SELECT '" & .Fields("LC04") & "','" & .Fields("LC03") & "','" & .Fields("LC05") & "','" & strUserNum & _
               "',LCV03,decode(lcv09,null,NVL(LCV06,LCV04),decode(lcv10,'0',lcv04,lcv10)) FROM LETTERCACHEVAR WHERE LCV01='" & .Fields("LC01") & "'" & _
               " AND LCV02='" & .Fields("LC02") & "'"
            cnnConnection.Execute stSQL, intR
         End If
         
         stCP64 = "" 'Added by Morgan 2013/9/27
         'Add by Morgan 2008/9/4
         stCon = " AND a.LCV06<>a.LCV04"
         'Modify by Morgan 2008/11/17 +判斷只讀智權人員可修改的欄位
         'Add by Morgan 2010/3/24 CFP領證報價若有進度備註時定稿也要帶出
         'Modified by Morgan 2013/10/21 美國領證103/1/1以前加新的報價
         stSQL = "select cp64,pa08,pa09,pa91 from nextprogress,caseprogress,patent" & _
            " where np01='" & .Fields("LC01") & "' and np22=" & .Fields("LC02") & _
            " and np02='CFP' and np07='601' and cp09(+)=np01 and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04"
         intR = 1
         Set adoTmp = ClsLawReadRstMsg(intR, stSQL)
         If intR = 1 Then
            'Modify by Morgan 2010/5/25 只抓有調整的，否則定稿會太大而無法存檔。
            'stCon = ""
            'Modified by Morgan 2013/10/21
            'stCP64 = "" & adoTmp(0)
            If InStr("" & adoTmp(0), "補虧損") > 0 Or InStr("" & adoTmp(0), "補未收費程序") > 0 Then
               stCP64 = "" & adoTmp(0)
            End If
            'end 2013/10/21
         End If
         
         stExc(1) = ""
         'Add By Sindy 2011/5/24
         stExc(2) = ""
         stExc(3) = ""
         '2011/5/24 End
         
         'Added by Lydia 2016/08/22 抓業務報價金額和點數
         stSalesAmt = ""
         stSalesP = ""
         'If "" & .Fields("LC07") <> "" And "" & .Fields("LC08") <> "" Then 'Remove by Lydia 2016/09/06 有可能業務不確認
            'Modified by Lydia 2016/09/09 有可能業務不改價
            'stSQL = "SELECT sum(nvl(a.lcv06,a.lcv04)) samt,sum(nvl(b.lcv06,b.lcv04)) pamt " & _
                    "FROM LETTERCACHEVAR a, LETTERCACHEVAR b WHERE a.LCV01='" & .Fields("LC01") & "' and a.LCV02='" & .Fields("LC02") & "' and a.LCV05='Y' AND a.LCV08 IS NULL " & _
                    "and b.LCV01(+)=a.LCV01 and b.LCV02(+)=a.LCV02 and b.LCV03(+)=a.LCV03||'點數' order by 1*a.lcv04 desc "
            'Modified by Lydia 2016/10/05 主管簽核>智權報價>程序報價
            'stSQL = "SELECT sum(decode(nvl(a.lcv06,0),0,a.lcv04,a.lcv06)) samt,sum(decode(nvl(b.lcv06,0),0,b.lcv04,b.lcv06)) pamt " & _
                    "FROM LETTERCACHEVAR a, LETTERCACHEVAR b WHERE a.LCV01='" & .Fields("LC01") & "' and a.LCV02='" & .Fields("LC02") & "' and a.LCV05='Y' AND a.LCV08 IS NULL " & _
                    "and b.LCV01(+)=a.LCV01 and b.LCV02(+)=a.LCV02 and b.LCV03(+)=a.LCV03||'點數' order by 1*a.lcv04 desc "
            'Modified by Morgan 2019/6/3 取消 a.LCV08 IS NULL 條件(業務不可修改的報價也要加 Ex:CFP-029943的面詢費)
            'stSQL = "SELECT sum(decode(nvl(a.lcv10,0),0,decode(nvl(a.lcv06,0),0,a.lcv04,a.lcv06),a.lcv10)) samt," & _
                    "sum(decode(nvl(b.lcv10,0),0,decode(nvl(b.lcv06,0),0,b.lcv04,b.lcv06),b.lcv10)) pamt " & _
                    "FROM LETTERCACHEVAR a, LETTERCACHEVAR b WHERE a.LCV01='" & .Fields("LC01") & "' and a.LCV02='" & .Fields("LC02") & "' and a.LCV05='Y' AND a.LCV08 IS NULL " & _
                    "and b.LCV01(+)=a.LCV01 and b.LCV02(+)=a.LCV02 and b.LCV03(+)=a.LCV03||'點數' order by 1*a.lcv04 desc "
            'Modified by Morgan 2023/3/7 總計要排除ＵＰ註冊費
            stSQL = "SELECT sum(decode(nvl(a.lcv10,0),0,decode(nvl(a.lcv06,0),0,a.lcv04,a.lcv06),a.lcv10)) samt," & _
                    "sum(decode(nvl(b.lcv10,0),0,decode(nvl(b.lcv06,0),0,b.lcv04,b.lcv06),b.lcv10)) pamt " & _
                    "FROM LETTERCACHEVAR a, LETTERCACHEVAR b WHERE a.LCV01='" & .Fields("LC01") & "' and a.LCV02='" & .Fields("LC02") & "' and a.LCV05='Y'" & _
                    "and b.LCV01(+)=a.LCV01 and b.LCV02(+)=a.LCV02 and b.LCV03(+)=a.LCV03||'點數' and a.LCV03<>'ＵＰ註冊費'"
            intR = 1
            Set adoTmp = ClsLawReadRstMsg(intR, stSQL)
            If intR = 1 Then
               stSalesAmt = Val("" & adoTmp.Fields("samt"))
               stSalesP = Val("" & adoTmp.Fields("pamt"))
            End If
         'End If
         'end 2016/08/22
         
         'Added by Lydia 2021/04/08 CFT發註冊證預設費用和點數; 因為下方判斷是針對智權人員有改點數,產生<程序報價：>的內容
         If strSysType = "CFT" And strLC04 = "05" Then
             stExc(2) = stSalesAmt
             stExc(3) = stSalesP
         End If
         'end 2021/04/08
         
'         stSQL = " SELECT '" & .Fields("LC04") & "','" & .Fields("LC03") & "','" & .Fields("LC05") & "','" & strUserNum & _
'            "',a.LCV03,a.LCV04,b.LCV04 pt FROM LETTERCACHEVAR a, LETTERCACHEVAR b WHERE a.LCV01='" & .Fields("LC01") & "'" & _
'            " AND a.LCV02='" & .Fields("LC02") & "' and a.LCV05='Y' AND a.LCV08 IS NULL " & stCon & " and b.LCV01(+)=a.LCV01 and b.LCV02(+)=a.LCV02 and b.LCV03(+)=a.LCV03||'點數' order by 1*a.lcv04 desc"
         'Added by Lydia 2017/05/18 EPC案件固定顯示程序報價
         If "" & .Fields("CP01") = "CFP" And strNA01 = "221" Then
            stSQL = " SELECT '" & .Fields("LC04") & "','" & .Fields("LC03") & "','" & .Fields("LC05") & "','" & strUserNum & _
                    "',a.LCV03,TO_CHAR(a.LCV04,'999G999') amt1,b.LCV04 pt1,a.LCV06 amt2,b.LCV06 pt2 FROM LETTERCACHEVAR a, LETTERCACHEVAR b WHERE a.LCV01='" & .Fields("LC01") & "'" & _
                    " AND a.LCV02='" & .Fields("LC02") & "' and a.LCV05='Y' AND a.LCV08 IS NULL and b.LCV01(+)=a.LCV01 and b.LCV02(+)=a.LCV02 and b.LCV03(+)=a.LCV03||'點數' order by 1*a.lcv04 desc"
         Else
         'end 2017/05/18
            stSQL = " SELECT '" & .Fields("LC04") & "','" & .Fields("LC03") & "','" & .Fields("LC05") & "','" & strUserNum & _
                    "',a.LCV03,TO_CHAR(a.LCV04,'999G999') amt1,b.LCV04 pt1,a.LCV06 amt2,b.LCV06 pt2 FROM LETTERCACHEVAR a, LETTERCACHEVAR b WHERE a.LCV01='" & .Fields("LC01") & "'" & _
                    " AND a.LCV02='" & .Fields("LC02") & "' and a.LCV05='Y' AND a.LCV08 IS NULL " & stCon & " and b.LCV01(+)=a.LCV01 and b.LCV02(+)=a.LCV02 and b.LCV03(+)=a.LCV03||'點數' order by 1*a.lcv04 desc"
         End If 'end 2017/05/18
         
         intR = 1
         Set adoTmp = ClsLawReadRstMsg(intR, stSQL)
         If intR = 1 Then
            With adoTmp
            .MoveFirst
            stExc(1) = "程序報價：" & .Fields("LCV03") & " " & .Fields("amt1") & "(" & .Fields("pt1") & "P)"
            'Add By Sindy 2011/5/24
            stExc(2) = "" & .Fields("amt2")
            stExc(3) = "" & .Fields("pt2")
            '2011/5/24 End
            .MoveNext
            Do While Not .EOF
               stExc(1) = stExc(1) & "，" & .Fields("LCV03") & " " & .Fields("amt1") & "(" & .Fields("pt1") & "P)"
               .MoveNext
            Loop
            stExc(1) = stExc(1) & "。"
            End With
            'Added by Lydia 2016/05/27 有定稿報價輸入簽核主管和點數,所以前面抓的定稿內文的<費用>等於主管簽核的金額,例外抓智權報價
            If bolKeyPoint Then
               With adoTmp
                  .MoveFirst
                  stExc(1) = stExc(1) & vbCrLf & "智權報價：" & .Fields("LCV03") & " " & PUB_StrToStr(Format(.Fields("amt2"), "###,##0"), 8, True, True) & "(" & .Fields("pt2") & "P)"
                  .MoveNext
                  Do While Not .EOF
                     stExc(1) = stExc(1) & "，" & .Fields("LCV03") & " " & PUB_StrToStr(Format(.Fields("amt2"), "###,##0"), 8, True, True) & "(" & .Fields("pt2") & "P)"
                     .MoveNext
                  Loop
                  stExc(1) = stExc(1) & "。"
               End With
            End If
            'end 2016/05/27
         End If
         
         '新增例外欄位
         'Add by Morgan 2010/3/24
         If stCP64 <> "" Then
            If stExc(1) = "" Then
               stExc(1) = "*備註:" & stCP64
            Else
               stExc(1) = stExc(1) & vbCrLf & "*備註:" & stCP64
            End If
         End If
         
         If stExc(1) <> "" Then
            stSQL = "INSERT INTO EXCEPTCONDITION (ET01,ET02,ET03,ET04,ET05,ET06) " & _
               " values('" & .Fields("LC04") & "','" & .Fields("LC03") & "','" & .Fields("LC05") & "','" & strUserNum & _
               "','程序報價','" & ChgSQL(stExc(1)) & "')"
            cnnConnection.Execute stSQL, intR
         End If
        'Move by Lydia 2021/04/08 從stExc(1) <> "" 移出來
        'Add By Sindy 2011/5/24
        If strSysType = "CFT" And strLC04 = "05" Then  'CFT發註冊證
           stSQL = "INSERT INTO EXCEPTCONDITION (ET01,ET02,ET03,ET04,ET05,ET06) " & _
              " values('" & .Fields("LC04") & "','" & .Fields("LC03") & "','" & .Fields("LC05") & "','" & strUserNum & _
              "','費用','" & stExc(2) & "')"
           cnnConnection.Execute stSQL, intR
           stSQL = "INSERT INTO EXCEPTCONDITION (ET01,ET02,ET03,ET04,ET05,ET06) " & _
              " values('" & .Fields("LC04") & "','" & .Fields("LC03") & "','" & .Fields("LC05") & "','" & strUserNum & _
              "','費用點數','" & stExc(3) & "')"
           cnnConnection.Execute stSQL, intR
        End If
        '2011/5/24 End
        '-----Move by Lydia 2021/04/08
         
         strUPDesc = "" 'Added by Morgan 2023/3/23
         'EPC 領證要另外組"指定國註冊費"內容
         If .Fields("LC04") = "03" And (.Fields("LC05") = "10" Or .Fields("LC05") = "14") Then
            'Modify by Morgan 2009/5/7 依照英文字母排序以便於對照代理人來信--禧佩
            'Modified by Morgan 2016/3/10 國家檔會有多筆加判斷抓代碼3碼的資料
            'Modified by Morgan 2023/3/7 +ＵＰ註冊費點數
            'stSQL = "select lcv03, nvl(lcv06,lcv04) Price,na04 from lettercachevar,nation" & _
               " where lcv01='" & .Fields("LC01") & "' and lcv02=" & .Fields("LC02") & _
               " and lcv03 like '%註冊費' and na03(+)=replace(lcv03,'註冊費','') and length(na01)=3 order by na04"
            stSQL = "select a.lcv03, nvl(a.lcv06,a.lcv04) Price,na04,na01,nvl(b.lcv06,b.lcv04) Pts from lettercachevar a,nation,lettercachevar b" & _
               " where a.lcv01='" & .Fields("LC01") & "' and a.lcv02=" & .Fields("LC02") & _
               " and a.lcv03 like '%註冊費' and na03(+)=replace(a.lcv03,'註冊費','') and length(na01)=3" & _
               " and b.LCV01(+)=a.LCV01 and b.LCV02(+)=a.LCV02 and b.LCV03(+)=a.LCV03||'點數'" & _
               " order by na04"
            intR = 1
            Set adoTmp = ClsLawReadRstMsg(intR, stSQL)
            If intR = 1 Then
               stExc(1) = ""
               With adoTmp
               intR = 0
               Do While Not .EOF
                  'Added by Morgan 2023/3/7 UP224除外
                  If .Fields("na01") = "224" Then
                     strUPDesc = ",此費用未包含" & .Fields("LCV03") & .Fields("Price") & "(" & .Fields("Pts") & ")"
                  Else
                  'end 2023/2/7
                     intR = intR + 1
                     '國家
                     stExc(2) = Replace(.Fields("LCV03"), "註冊費", "")
                     If stExc(2) = "瑞士" Then
                        stExc(2) = stExc(2) & "/列茲敦斯登"
                     End If
                     'Modified by Morgan 2023/3/6 新定稿內縮兩字,最後一列不加跳行
                     If stExc(1) <> "" Then stExc(1) = stExc(1) & Chr$(13)
                     stExc(1) = stExc(1) & "　　" & intR & "." & stExc(2) & _
                        "：新台幣 " & .Fields("Price") & " 元整。"
                        
                  End If 'Added by Morgan 2023/3/7
                  .MoveNext
               Loop
               End With
               '新增例外欄位
               stSQL = "INSERT INTO EXCEPTCONDITION (ET01,ET02,ET03,ET04,ET05,ET06) " & _
                  " values('" & .Fields("LC04") & "','" & .Fields("LC03") & "','" & .Fields("LC05") & "','" & strUserNum & _
                  "','EPC核准國家領證費用','" & stExc(1) & "')"
               cnnConnection.Execute stSQL, intR
            End If
            
         'EPC 年費要另外組"指定國年費"內容
         ElseIf .Fields("LC04") = "10" And .Fields("LC05") = "08" Then
            'Modified by Lydia 2016/10/05 主管簽核>智權報價>程序報價
            'stSQL = "select lcv03, nvl(lcv06,lcv04) Price from lettercachevar where lcv01='" & .Fields("LC01") & "' and lcv02=" & .Fields("LC02") & _
               " and lcv03 like '%年費'"
            stSQL = "select lcv03, nvl(nvl(lcv10,lcv06),lcv04) Price from lettercachevar where lcv01='" & .Fields("LC01") & "' and lcv02=" & .Fields("LC02") & _
               " and lcv03 like '%年費'"
            intR = 1
            Set adoTmp = ClsLawReadRstMsg(intR, stSQL)
            If intR = 1 Then
               stExc(1) = ""
               With adoTmp
               Do While Not .EOF
                  '國家
                  stExc(2) = Replace(.Fields("LCV03"), "年費", "")
                  stExc(1) = stExc(1) & "　　" & .AbsolutePosition & "." & stExc(2) & _
                     "：新台幣 " & .Fields("Price") & " 元整。" & Chr$(13)
                  .MoveNext
               Loop
               End With
               '新增例外欄位
               stSQL = "INSERT INTO EXCEPTCONDITION (ET01,ET02,ET03,ET04,ET05,ET06) " & _
                  " values('" & .Fields("LC04") & "','" & .Fields("LC03") & "','" & .Fields("LC05") & "','" & strUserNum & _
                  "','EPC指定國家年費費用','" & stExc(1) & "')"
               cnnConnection.Execute stSQL, intR
            End If
         End If
                           
         strLD18 = "" & .Fields("LC18") 'Added by Morgan 2018/7/17 CFP電子化
                  
         '產生定稿
         If p_bEdit = True Then
            NowPrint .Fields("LC03"), .Fields("LC04"), .Fields("LC05"), True, strUserNum, , , , , , , , , , , , , strLD18
            'Add By Sindy 2011/5/24
            If ChkTG = True Then
               EndLetter .Fields("LC04"), .Fields("LC03"), "26", strUserNum
               NowPrint .Fields("LC03"), .Fields("LC04"), "26", True, strUserNum
            End If
            '2011/5/24 End
            stLD02 = strSrvDate(1)
            stLD03 = Right("000000" & ServerTime, 6)
         Else
            NowPrint .Fields("LC03"), .Fields("LC04"), .Fields("LC05"), False, strUserNum, , , , , , , , , , , , , strLD18
            'Add By Sindy 2011/5/24
            If ChkTG = True Then
               EndLetter .Fields("LC04"), .Fields("LC03"), "26", strUserNum
               NowPrint .Fields("LC03"), .Fields("LC04"), "26", False, strUserNum
            End If
            '2011/5/24 End
            stLD02 = pub_strDate
            stLD03 = pub_strTime
         End If
         
         '更新暫存
            stSQL = "update lettercache set lc13=" & stLD02 & ",lc14=" & stLD03 & _
               " where lc01='" & .Fields("LC01") & "' and lc02='" & .Fields("LC02") & "'"
            cnnConnection.Execute stSQL, intR
            
         'Added by Morgan 2025/2/6 發文室反應判發日(程序自行判發的)與送到發文室的日期差很大，故改與發文日同步(實際也是此時才確認金額轉定稿)
         stSQL = "update letterprogress set lp05=" & strSrvDate(1) & " WHERE lp01='" & .Fields("LC01") & "' and lp04 is null and lp05>0 and exists(select * from caseprogress where cp09=lp01 and cp27 is null)"
         cnnConnection.Execute stSQL, intR
         'end 2025/2/6

         '列印
         'Modify by Morgan 2009/9/15 +只轉定稿不列印功能
         If p_bUpdate Or p_bPrint Then
            'Added by Morgan 2019/2/20 有已列印註記者除外(因目前郭雅娟有特定e化客戶直寄也不要印)
            intR = 0
            If strLD18 <> "" Then
               stSQL = "Update LETTERDEMAND Set LD16=LD16 WHERE LD01='" & strUserNum & "'" & _
                    " AND LD02=" & stLD02 & " AND LD03=" & stLD03 & " AND LD16='*' and LD18='" & strLD18 & "'"
               cnnConnection.Execute stSQL, intR
            End If
            If intR = 0 Then
            'end 2019/2/20
            
               If p_bPrint Then
                  PrinterLetterDB strUserNum, , stLD02, stLD03
                  
                  'Added by Morgan 2023/10/18
                  If m_990CP09 <> "" Then
                     PrinterLetterDB strUserNum, , stLD02, stLD03 + 1
                  End If
                  'end 2023/10/18
               End If
               
               '更新已列印註記
               stSQL = "Update LETTERDEMAND Set LD16='*' WHERE LD01='" & strUserNum & "'" & _
                    " AND LD02=" & stLD02 & " AND LD03=" & stLD03
               cnnConnection.Execute stSQL, intR
               
            End If 'Added by Morgan 2019/2/20
         End If
         
         'Add by Morgan 2008/5/27
         '若為核准定稿時該來函要上發文日
         'Modified by Lydia 2015/10/05 + 1008
         'Modified by Morgan 2023/3/2 EPC核准函除外(要先會稿)
         'Modified by Morgan 2023/9/28 EPC核准函改不需會稿可直接發文--玫音
         'If Not (strNA01 = "221" And .Fields("CP01") = "CFP" And .Fields("CP10") = "1001") Then
         If .Fields("CP01") = "CFP" And (.Fields("CP10") = "1001" Or .Fields("CP10") = "1603" Or .Fields("CP10") = "1008") Then
         'end 2023/9/28
            stSQL = "Update caseprogress Set cp27=" & strSrvDate(1) & " WHERE cp09='" & .Fields("LC01") & "'" & _
               " and cp01='CFP' and (cp10='1001' or cp10='1603' or cp10='1008') AND cp27 is null"
            cnnConnection.Execute stSQL, intR
         End If
         
         'Added by Morgan 2020/8/7
         'EPC核准報價定稿,子案也一併上發文
         'Modified by Morgan 2023/3/2 EPC核准函不上發文，改以申請國家判斷
         'If .Fields("CP01") = "CFP" And .Fields("CP10") = "1001" And intR > 0 Then
         If .Fields("CP01") = "CFP" And .Fields("CP10") = "1001" And strNA01 = "221" Then
         'end 2023/3/2
            stSQL = "update caseprogress set cp27=" & strSrvDate(1) & " WHERE cp43='" & .Fields("LC01") & "' and cp04<>'00' and cp10='" & .Fields("CP10") & "' and cp27 is null"
            cnnConnection.Execute stSQL, intI
         End If
         'end 2020/8/7
         
         'Added by Lydia 2017/01/12 歐盟集體設計案，因子案證書皆為與母案併一函定稿通知，寄證書費用也謹一筆，故母案發文時請系統將子案一併也上發文日
         If .Fields("CP01") = "CFP" And .Fields("CP10") = "1603" And intR > 0 Then
            strSql = Pub_GetCFPQuery105(.Fields("CP01"), .Fields("CP02"), .Fields("CP03"), .Fields("CP04"))
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strSql)
            If intI = 1 Then
               RsTemp.MoveFirst
               Do While Not RsTemp.EOF
                  stSQL = "Update caseprogress Set cp27=" & strSrvDate(1) & " WHERE cp01='" & RsTemp.Fields("cp01") & "' and cp02='" & RsTemp.Fields("cp02") & "' and cp03='" & RsTemp.Fields("cp03") & "' and cp04='" & RsTemp.Fields("cp04") & "' and cp10='1603' and cp27 is null "
                  cnnConnection.Execute stSQL, intR
                  RsTemp.MoveNext
               Loop
            End If
         End If
         'end 2017/01/12
         
         'Modified by Morgan 2016/1/13 期限通知(1913)報價也改在此時上發文日
         stSQL = "Update caseprogress Set cp27=" & strSrvDate(1) & " WHERE cp43='" & .Fields("LC01") & "' and cp30='" & .Fields("LC02") & "'" & _
               " and cp10='1913' AND cp27 is null"
         cnnConnection.Execute stSQL, intR
         
         'Added by Morgan 2021/10/29 併函通知的也要上發文日
         stSQL = "Update caseprogress Set cp27=" & strSrvDate(1) & " WHERE cp09 in (select lp01 from caseprogress,letterprogress" & _
            " where cp43='" & .Fields("LC01") & "' and cp30='" & .Fields("LC02") & "' and cp10='1913' and cp27>0 and lp42(+)=cp09 and lp10='N')" & _
            " and cp27 is null"
         cnnConnection.Execute stSQL, intR
         'end 2021/10/29
         
         'Add By Sindy 2021/1/6 內商電子化後,報價定稿改在此處才上專業部發文日
         stSQL = "Update caseprogress Set cp27=" & strSrvDate(1) & " WHERE cp09='" & .Fields("LC01") & "'" & _
               " and substr(cp01,1,1)='T' AND cp27 is null"
         cnnConnection.Execute stSQL, intR
         'Add By Sindy 2021/2/17
         If intR = 1 And strLD18 <> "" Then
            stSQL = "update letterprogress set lp05=decode(lp03,0,0," & strSrvDate(1) & "),lP10='Y' where lp01='" & strLD18 & "'"
            cnnConnection.Execute stSQL, intR
         End If
         '2021/2/17 END
         '2021/1/6 END
         
         If strLD18 <> "" Then PUB_UpdateLP03 strLD18 'Added by Morgan 2017/12/20
         'end 2016/1/13
         
         'Add By Sindy 2014/4/18 要產生來函通知進度
         Dim strCP09 As String
         Dim m_bolInsCP As Boolean
         Dim strCP10 As String
         Dim rsC As New ADODB.Recordset
         Dim strNewCP09 As String
         Dim m_TM01 As String, m_TM02 As String, m_TM03 As String, m_TM04 As String
         strCP09 = .Fields("LC01")
'Add by Lydia 2014/10/29 　LC02="0"＝＞為自動發證國家之證書號輸入(frm05010403_2)時產生，因為無下一程序所以預設LC02=NP22=0
'         m_TM01 = .Fields("NP02")
'         m_TM02 = .Fields("NP03")
'         m_TM03 = .Fields("NP04")
'         m_TM04 = .Fields("NP05")
         m_TM01 = .Fields("CP01")
         m_TM02 = .Fields("CP02")
         m_TM03 = .Fields("CP03")
         m_TM04 = .Fields("CP04")
         If m_TM01 = "CFT" And _
            .Fields("LC04") = "10" And _
            (.Fields("NP07") = "102" Or .Fields("NP07") = "105") Then
            m_bolInsCP = True
            '若為使用宣誓時,收文的案件性質為1711.通知使用宣誓時不產生進度
            If .Fields("NP07") = "105" Then '使用宣誓
               strSql = "select cp10 from caseprogress where cp09='" & strCP09 & "'"
               rsC.CursorLocation = adUseClient
               rsC.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
               If rsC.RecordCount > 0 Then
                  If rsC.Fields("cp10") = "1711" Then
                     m_bolInsCP = False
                  End If
               End If
               If rsC.State <> adStateClosed Then rsC.Close
            End If
            If m_bolInsCP = True Then
               strSql = "select cp05 from caseprogress " & _
                        "where cp01='" & m_TM01 & "' and cp02='" & m_TM02 & "' and cp03='" & m_TM03 & "' and cp04='" & m_TM04 & "'"
               If .Fields("NP07") = "102" Then '延展
                  strSql = strSql & " and cp10='1717'"
                  strCP10 = "1717"
               ElseIf .Fields("NP07") = "105" Then '使用宣誓
                  strSql = strSql & " and cp10='1723'"
                  strCP10 = "1723"
               End If
               strSql = strSql & " order by cp05 desc"
               rsC.CursorLocation = adUseClient
               rsC.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
               If rsC.RecordCount > 0 Then
                  rsC.MoveFirst
                  '檢查30天內重新以此方式作業,以詢問方式確認是否要產生通知進度
                  If CompWorkDay(30, rsC.Fields(0), 0) >= strSrvDate(1) Then
                     If MsgBox(m_TM01 & "-" & m_TM02 & "-" & m_TM03 & "-" & m_TM04 & "是否產生來函通知進度？", vbExclamation + vbYesNo + vbDefaultButton2, "重要訊息！") = vbNo Then
                        m_bolInsCP = False
                     End If
                  End If
               End If
               If rsC.State <> adStateClosed Then rsC.Close
               Set rsC = Nothing
               If m_bolInsCP = True Then
                  'Modified by Lydia 2016/12/22 本所管控C類進度自2017/01/01起改用D類收文
                  'strNewCP09 = AutoNo("C", 6)
                  If strSrvDate(1) >= 本所D類收文啟用日 Then
                      strNewCP09 = AutoNo("D", 6)
                  Else
                      strNewCP09 = AutoNo("C", 6)
                  End If
                  'end 2016/12/22
                  
                  'Modify By Sindy 2015/4/30 +,CP30
                  'Modify by Morgan 2023/10/18 +CP06,CP07 (寄發文件會帶到EMail內文)
                  strSql = "INSERT INTO CaseProgress (CP01,CP02,CP03,CP04,CP05,CP06,CP07,CP09,CP10,CP12,CP13,CP14,CP20,CP26,CP32,CP43,CP27,CP30) " & _
                  "VALUES ('" & m_TM01 & "','" & m_TM02 & "','" & m_TM03 & "','" & m_TM04 & "'," & strSrvDate(1) & "," & CNULL("" & .Fields("NP08"), True) & "," & CNULL("" & .Fields("NP09"), True) & "," & _
                          "'" & strNewCP09 & "','" & strCP10 & "','" & GetSalesArea(IIf(m_TM01 = "FCT", PUB_GetFCTSalesNo(m_TM01, m_TM02, m_TM03, m_TM04), PUB_GetAKindSalesNo(m_TM01, m_TM02, m_TM03, m_TM04))) & "','" & IIf(m_TM01 = "FCT", PUB_GetFCTSalesNo(m_TM01, m_TM02, m_TM03, m_TM04), PUB_GetAKindSalesNo(m_TM01, m_TM02, m_TM03, m_TM04)) & "','" & strUserNum & "'," & _
                          "'N','N','N'," & _
                          "'" & strCP09 & "'," & strSrvDate(1) & "," & CNULL("" & .Fields("NP22")) & ")"
                  cnnConnection.Execute strSql, intR
               End If
            End If
         End If
         '2014/4/18 End
         
         'Added by Morgan 2017/12/26 CFP報價內容寫入報價備註(LP35)
         'Modify by Sindy 2019/11/6 +if
         'If strLD18 <> "" And .Fields("CP01") = "CFP" Then
         If strLD18 <> "" Then
         '2019/11/6 END
            
            'Removed by Morgan 2021/8/30 LP35目前都沒給看且內容不正確，先取消(舊資料已清除)，看進度備註會比較正確(程序人員有時也會人工修改)
            'stSQL = "Update LetterProgress set LP35=(SELECT '費用='||max(decode(substr(et05,1,2),'費用',ltrim(to_char(et06,'99,999,999'))))" & _
               "||max(decode(substr(et05,1,2),'點數','('||et06||'P)'))" & _
               "||max(decode(et05,'程序報價','; '||et06))" & _
               " From exceptcondition where et01='" & .Fields("LC04") & "' and et02='" & .Fields("LC03") & "' and et03='" & .Fields("LC05") & "'" & _
               " and et04='" & strUserNum & "' and et05 in ('費用','費用合計','費用','點數','點數合計','程序報價'))" & _
               " Where LP01='" & strLD18 & "'"
            'cnnConnection.Execute stSQL, intR
            'end 2021/8/30
            
            'Modify by Sindy 2019/11/6 +if
            If .Fields("CP01") = "CFP" Then
            '2019/11/6 END
               'Added by Morgan 2018/11/27
               '進度備註要加程序報價
               stSQL = "Update CaseProgress set cp64=(select max(decode(et06,'','',et06||'; '))||cp64" & _
                  " From exceptcondition where et01='" & .Fields("LC04") & "' and et02='" & .Fields("LC03") & "' and et03='" & .Fields("LC05") & "'" & _
                  " and et04='" & strUserNum & "' and et05='程序報價')" & _
                  " where cp09='" & strLD18 & "'"
               cnnConnection.Execute stSQL, intR
               'end 2018/11/27
               
               'Added by Morgan 2019/6/3
               '備註要列明細 Ex:CFP-029943的面詢費
               stSQL = "SELECT nvl(a.LCV07,a.LCV03) 項目" & _
                  ",decode(nvl(a.lcv10,0),0,decode(nvl(a.lcv06,0),0,a.lcv04,a.lcv06),a.lcv10) 確認金額" & _
                  ",decode(nvl(b.lcv10,0),0,decode(nvl(b.lcv06,0),0,b.lcv04,b.lcv06),b.lcv10) 確認點數" & _
                  " FROM LETTERCACHEVAR a, LETTERCACHEVAR b WHERE a.LCV01='" & .Fields("LC01") & "' and a.LCV02='" & .Fields("LC02") & "' and a.LCV05='Y'" & _
                  " and b.LCV01(+)=a.LCV01 and b.LCV02(+)=a.LCV02 and b.LCV03(+)=a.LCV03||'點數' order by 1*a.lcv04 desc "
               intR = 1
               Set adoTmp = ClsLawReadRstMsg(intR, stSQL)
               If intR = 1 Then
                  With adoTmp
                  If .RecordCount > 1 Then
                  stCP64 = ""
                  Do While Not .EOF
                     stCP64 = stCP64 & IIf(stCP64 <> "", ",", "") & .Fields(0) & "=" & .Fields(1) & "(" & .Fields(2) & ")"
                     .MoveNext
                  Loop
                  stCP64 = stCP64 & "; "
                  stSQL = "Update CaseProgress set cp64='" & ChgSQL(stCP64) & "'||cp64 where cp09='" & strLD18 & "'"
                  cnnConnection.Execute stSQL, intR
                  End If
                  End With
               End If
               'end 2019/6/3
            End If
         End If
         'end 2017/12/26
         
         'Added by Lydia 2016/09/01 有報價確認,更新案件進度備註
         If (Val(stSalesAmt) > 0 Or Val(stSalesP) > 0) Then
            If strLD18 <> "" Then PUB_UpdateLP2930 strLD18, Val(stSalesAmt), Val(stSalesP) 'Added by Morgan 2017/12/21
             strExc(1) = ""
             '抓對應的進度檔(ex: 1913通知期限); 當LC17=Y,會將LC11(建檔日期+1天)
             strSql = "select 1 ord, cp01,cp02,cp03,cp04,cp05,cp09,cp10,cp64 from caseprogress where cp43='" & .Fields("LC01") & "' and cp30='" & .Fields("LC02") & "' and length(cp10)=4 " & _
                      "and cp66>='" & IIf("" & .Fields("LC17") = "Y", CompDate(2, -1, .Fields("LC11")), .Fields("LC11")) & "' "
             '其他(專利-專利證書,專利-核准,商標-註冊證)
             strSql = strSql & "union all select 2 ord, cp01,cp02,cp03,cp04,cp05,cp09,cp10,cp64 from caseprogress,systemkind " & _
                       "where cp09='" & .Fields("LC01") & "' and cp01=sk01(+) and sk02||cp10 in ('11603','51603','11001','21701','61701') order by ord, cp09 desc "
             rsC.CursorLocation = adUseClient
             rsC.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
             If rsC.RecordCount > 0 Then
                rsC.MoveFirst
                'Modified by Morgan 2023/3/7 +strUPDesc
                stSQL = "Update caseprogress set CP64='" & ChangeWStringToWDateString(strSrvDate(1)) & " " & 業務報價確認備註 & Format(stSalesAmt, DDollar2) & "(" & stSalesP & "P)" & strUPDesc & ";'||CP64 " & _
                        "WHERE cp09=" & CNULL(rsC.Fields("CP09"))
                cnnConnection.Execute stSQL, intR
             End If
            If rsC.State <> adStateClosed Then rsC.Close

         End If
         'END 2016/09/01
         
         'Add By Sindy 2016/10/4
         cnnConnection.CommitTrans
         bolConn = False
         m_bInTrans = bolConn 'Added by Morgan 2023/10/18
         '2016/10/4 END
         
         
         'Added by Lydia 2016/10/11 因為報價項目可能不只一項,將信函合併
         If bolKeyPoint = True Then
            PUB_SendMail strUserNum, "" & .Fields("LC07"), "", .Fields("CP01") & "-" & .Fields("CP02") & IIf("" & .Fields("CP03") & .Fields("CP04") = "000", "", "-" & .Fields("CP03") & "-" & .Fields("CP04")) & " 期限通知報價點數", vbCrLf & strKeyPoint
         End If
         'end 2016/10/11
         
         'Added by Morgan 2023/9/15
         StrCaseList = StrCaseList & .Fields("CP01") & "-" & .Fields("CP02") & IIf("" & .Fields("CP03") & .Fields("CP04") = "000", "", "-" & .Fields("CP03") & "-" & .Fields("CP04"))
         '無紙:E化無實體且為全E或半E(非直寄)
         If Not IsNull(.Fields("lp26")) And IsNull(.Fields("lp51")) And (.Fields("lp26") = "E" Or IsNull(.Fields("lp11"))) Then
            StrCaseList = StrCaseList & "(無紙)"
         End If
         
         'Added by Morgan 2023/10/18
         If m_990CP09 <> "" Then
            StrCaseList = StrCaseList & vbCrLf & .Fields("CP01") & "-" & .Fields("CP02") & IIf("" & .Fields("CP03") & .Fields("CP04") = "000", "", "-" & .Fields("CP03") & "-" & .Fields("CP04")) & "(副本信函)"
            m_990CP09 = ""
         End If
         'end 2023/10/18
         
         StrCaseList = StrCaseList & vbCrLf
         'end 2023/9/15
         .MoveNext
      Loop
      End With
      PUB_Cache2Letter = True
      If p_bPrint = True Then
         'Modified by Morgan 2023/9/15 +清單
         MsgBox "列印完畢! " & vbCrLf & vbCrLf & "清單：" & vbCrLf & StrCaseList, vbOKOnly + vbInformation, "列印定稿"
      End If
   Else
      If p_bPrint = True Then
         MsgBox "無待列印定稿資料！"
      End If
   End If
   
ErrHnd:
   'Add By Sindy 2016/10/4
   If bolConn = True Then
      cnnConnection.RollbackTrans
   End If
   '2016/10/4 END
   
   If Err.Number <> 0 Then
      MsgBox Err.Description, vbCritical
   End If
   Set adoRst = Nothing
   Set adoTmp = Nothing
End Function

'Added by Morgan 2018/3/8
'FCP本所案號轉檔名
Public Function PUB_FCPCaseNo2FileName(ByVal pCP01 As String, ByVal pCP02 As String, ByVal pCP03 As String, ByVal pCP04 As String) As String
   If pCP03 = "" Then pCP03 = "0"
   If pCP04 = "" Then pCP04 = "00"
   'Modified by Lydia 2020/01/20 +Format
   'PUB_FCPCaseNo2FileName = pCP01 & pCP02 & IIf(pCP03 & pCP04 <> "000", pCP03 & pCP04, "")
   'Modified by Lydia 2020/02/17 配合卷宗區檔名格式統一(參考PUB_CaseNo2FileName)
   'PUB_FCPCaseNo2FileName = pCP01 & Format(pCP02, "000000") & IIf(pCP03 & pCP04 <> "000", pCP03 & pCP04, "")
   PUB_FCPCaseNo2FileName = pCP01 & Format(pCP02, "000000") & IIf(pCP04 <> "00", "-" & pCP03 & "-" & pCP04, IIf(pCP03 <> "0", "-" & pCP03, ""))
End Function

'Add by Amy 2018/07/27 取得案件代表圖 for 彩色代表圖上線,有取圖回傳True
'intChoose:0-全部圖先抓彩圖/9-全部圖先抓黑白圖/1-黑白圖/2-彩色圖
'Modified by Lydia 2021/01/08  取得IBF05,IBF06  + Optional ByRef strIBF05 As String = "", Optional ByRef strIBF06 As String = ""
Public Function GetImgByteFile_Case(ByVal strIBF01 As String, ByVal strIBF02 As String, ByVal strIBF03 As String, ByVal strIBF04 As String, _
                                                        ByRef stAttPath As String, Optional ByVal intChoose = 0, Optional ByRef strIBF05 As String = "", Optional ByRef strIBF06 As String = "") As Boolean
    Dim RsQ As New ADODB.Recordset
    Dim strQ As String, strWhere As String, strLoadPath As String
    Dim intQ As Integer
    Dim IsWmf As Boolean
   
On Error GoTo ErrHnd
   
    GetImgByteFile_Case = False
    strLoadPath = stAttPath
    
    Select Case intChoose
        Case 1
            strWhere = strWhere & "And Ibf05='1' "
        Case 2
            strWhere = strWhere & "And Ibf05='2' "
        Case 9
            strWhere = strWhere & "Order by ibf05 ASC"
        Case Else
            strWhere = strWhere & "Order by ibf05 Desc "
    End Select
    'Modify By Sindy 2018/10/31 TF馬德里商標圖檔-子案的圖同母案
    '固定都以IBF01=tm01 AND IBF02=substr(tm02,1,5)||'0' AND IBF03='0' AND IBF04='00' 去抓代表圖
    If strIBF01 = "TF" Then
      strQ = "Select * From ImgByteFile Where ibf01='" & strIBF01 & "' And ibf02='" & Mid(strIBF02, 1, 5) & "0" & "' And ibf03='0' And ibf04='00' " & _
                 strWhere
    Else
    '2018/10/31 END
      strQ = "Select * From ImgByteFile Where ibf01='" & strIBF01 & "' And ibf02='" & strIBF02 & "' And ibf03='" & strIBF03 & "' And ibf04='" & strIBF04 & "' " & _
                 strWhere
    End If
    intQ = 1
    Set RsQ = ClsLawReadRstMsg(intQ, strQ)
    If intQ = 1 Then
        RsQ.MoveFirst
        'Modify by Amy 2018/08/14 FCT 舊代表圖(ibf05=1)彩圖格式不印 ex:FCT-042565
        If strIBF01 = "FCT" And "" & RsQ.Fields("ibf05") = "1" And "" & RsQ.Fields("ibf06") = "2" Then
            Set RsQ = Nothing
            Exit Function
        End If
        'end 2018/08/14
        If CheckStr(RsQ.Fields("ibf06")) = "3" Or CheckStr(RsQ.Fields("ibf06")) = "4" Then IsWmf = True
        If strLoadPath = MsgText(601) Then
            'Modify By Sindy 2019/10/9 + $$ :事後檔案才會被清除，不會一直殘留在使用者電腦裡
            strLoadPath = App.path & "\$$" & strIBF01 & strIBF02 & strIBF03 & strIBF04 & "." & IIf(IsWmf, "wmf", "jpg")
        ElseIf InStr(strLoadPath, ".wmf") = 0 And InStr(strLoadPath, ".wmf") = 0 Then
            strLoadPath = strLoadPath & "." & IIf(IsWmf, "wmf", "jpg")
        End If
        If Dir(strLoadPath) <> "" Then Kill strLoadPath
        GetImgByteFile_Case = PUB_GetFtpFile(RsQ.Fields("IBF15"), strLoadPath, UCase("ImgByteFile"))
        stAttPath = strLoadPath
        'Added by Lydia 2021/01/08
        strIBF05 = "" & RsQ.Fields("IBF05")
        strIBF06 = "" & RsQ.Fields("IBF06")
        'end 2021/01/08
        GetImgByteFile_Case = True
    End If
    
    Set RsQ = Nothing
    Exit Function
   
ErrHnd:
    Set RsQ = Nothing
    MsgBox Err.Description, vbCritical
End Function

'Added by Morgan 2018/8/20
'信函主旨(目前只適用CFP指示信)
Public Function PUB_GetSubject(pCP01 As String, pCP02 As String, pCP03 As String, pCP04 As String, Optional pCP10 As String, Optional pAppNo As String, Optional pYrRef As String, Optional pPA09 As String, Optional pPA46 As String) As String
   Dim stSubject As String, stPatent As String, stNation As String, stAppNo As String
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   
   If pCP01 <> "CFP" Then Exit Function
   
   '特殊
   'PCT申請
   If pPA09 = "056" And pCP10 = "109" Then
      stSubject = "New PCT International Application filed with the USPTO as Receiving Office; "
   '歐盟設計
   ElseIf pPA09 = "239" And pCP10 = "103" Then
      'Modified by Morgan 2025/5/16 --玫音/慧汶
      'stSubject = "New Community Design Application in Europe; "
      stSubject = "New European Union Design Application in Europe; "
   '美國暫時申請
   ElseIf pCP10 = "118" Then
      stSubject = "New Provisional Patent Application in U.S.A.; "
   Else
      m_MySt(1) = pCP01
      m_MySt(2) = pCP02
      m_MySt(3) = pCP03
      m_MySt(4) = pCP04
      m_MySt(6) = pPA09
      m_SysKind = CheckSys(pCP01)
      SetLetterSt
      '新申請案
      If InStr(NewCasePtyList, pCP10) > 0 Then
         'PCT案
         If pPA46 = "Y" And (pCP10 = "101" Or pCP10 = "102") Then
            stNation = DoChange("專利基本檔-申請國家", "NA04")
            stSubject = "International application entering " & stNation & " national phase; "
         '美國CIP
         ElseIf pCP10 = "113" Then
            stAppNo = ExceptFieldData("前案申請案號")
            stSubject = "Continuation-in-Part Application of Patent Application No. " & stAppNo & " in U.S.A.;"
         '美國CPA
         ElseIf pCP10 = "114" Then
            stAppNo = ExceptFieldData("前案申請案號")
            stSubject = "Continued Prosecution Application of U.S. Patent Application No. " & stAppNo & "; "
         '美國再發行
         ElseIf pCP10 = "115" Then
            stAppNo = ExceptFieldData("前案專利號數")
            stSubject = "Reissue Application of U.S. Patent No." & stAppNo & "; "
         'CA申請
         ElseIf pCP10 = "122" Then
            stAppNo = ExceptFieldData("前案申請案號")
            stSubject = "A Continuation Application of U.S. Application No. " & stAppNo & "; "
         '其他
         Else
            stPatent = DoChange("專利商標種類-英文名稱")
            '申請國家
            'Modified by Morgan 2018/11/22
            'Select Case pPA09
            'Case "201": stNation = "U.K." '英國
            'Case Else
            '   stNation = DoChange("專利基本檔-申請國家", "NA04")
            'End Select
            stNation = ExceptFieldData2("申請國家")
            'end 2018/11/22
            '分割
            If pCP10 = "307" Then
               stAppNo = ExceptFieldData("分割母案申請案號")
               stSubject = "Divisional Application of " & stNation & " " & stPatent & " Application No. " & stAppNo & "; "
            Else
               stSubject = "New " & stPatent & " Application in " & stNation & "; "
            End If
         End If
      Else
         stPatent = DoChange("專利商標種類-英文名稱")
         stSubject = stPatent & " Application"
         If pAppNo <> "" Then
            stSubject = stSubject & " No. " & pAppNo
         End If
         'Added by Morgan 2018/10/5 子案主旨要帶申請國家--禧佩
         If pCP04 <> "00" Then
            'Modified by Morgan 2018/11/22
            'If pPA09 = "201" Then
            '   stNation = "U.K."
            'Else
            '   stNation = DoChange("專利基本檔-申請國家", "NA04")
            'End If
            stNation = ExceptFieldData2("申請國家")
            'end 2018/11/22
            stSubject = stSubject & " in " & stNation
         End If
         'end 2018/10/5
         
         stSubject = stSubject & "; "
         If pYrRef <> "" Then
            stSubject = stSubject & "Your Ref: " & pYrRef & ", "
         End If
      End If
   End If
   stSubject = stSubject & "Our Ref: " & pCP01 & "-" & pCP02 & IIf(pCP03 & pCP04 = "000", "", "-" & pCP03 & "-" & pCP04)
   PUB_GetSubject = stSubject
End Function
'Added by Morgan 2018/8/20
'顯示定稿維護畫面
Public Sub ShowEditForm()
   Dim oForm As Form
   For Each oForm In Forms
      If oForm.Name = "frm1105_1" Then
         oForm.ZOrder
         Exit For
      End If
   Next
End Sub

'Added by Morgan 2018/8/24
'讀取傳真封面
Public Function PUB_GetFaxPage(pLD18 As String, pLD01 As String, pLD02 As String, pLD03 As String) As String
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   Dim stLetter As String
   
   '檢查前一個定稿若是傳真封面則回傳定稿內容
   stSQL = "select ld01,ld02,ld03,ld04,ld10,ld11,ld18 from letterdemand" & _
      " where ld18='" & pLD18 & "' and ld01='" & pLD01 & "' and ld02=" & pLD02 & " and ld03<" & pLD03 & _
      " and ld05='CFP' and ld12 in ('3','4') ORDER BY LD03 DESC"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      With rsQuery
      If .Fields("LD10") = "01" And InStr("89,90,99,Z9", .Fields("LD11")) > 0 Then
         NowPrint .Fields("ld04"), .Fields("ld10"), .Fields("ld11"), False, .Fields("ld01"), , , True, stLetter, , , , , False, , , , .Fields("ld18")
      End If
      End With
      PUB_GetFaxPage = stLetter
   End If
   Set rsQuery = Nothing
End Function

'Added by Morgan 2018/9/6
'工程師承辦進度的指示信檢查
Public Function PUB_EngLtrChk(ByVal pCP09 As String, ByVal pCP27 As String, ByRef pEngLetter As Boolean) As Boolean
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
      
   pEngLetter = False
   If pCP09 < "C" Then
      '檢查卷宗區是否有.DATA.PDF
      '若承辦人非程序非繪圖,且沒有同日發文的進度有指示信
      stSQL = "select cpp02 from casepaperpdf where cpp01='" & pCP09 & "' and instr(upper(cpp02),'.DATA.PDF')>0 and cpp10<>'D'"
      intQ = 1
      Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
      If intQ = 1 Then
         pEngLetter = True
      Else
         stSQL = "select * from caseprogress a,staff" & _
            " where a.cp09='" & pCP09 & "' and st01(+)=a.cp14 and st03<>'P12' and st03<>'P13'" & _
            " and not exists(select * from caseprogress b,appform where b.cp01=a.cp01 and b.cp02=a.cp02" & _
            " and b.cp03=a.cp03 and b.cp04=a.cp04 and b.cp27=" & DBDATE(pCP27) & " and af01(+)=b.cp09 and af01 is not null)"
         intQ = 1
         Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
         If intQ = 1 Then
            If MsgBox("卷宗區無指示信(.DATA.PDF)，本程序是否確定沒有指示信？" & vbCrLf & vbCrLf & vbCrLf & "※若指示信<副檔名>不正確請先更名後再發文!!", vbYesNo + vbDefaultButton2 + vbQuestion) = vbNo Then
               GoTo flgExit
            End If
         End If
      End If
   End If
   PUB_EngLtrChk = True
   
flgExit:
   Set rsQuery = Nothing
End Function

'Added by Morgan 2018/10/17
'是否不印地址
Private Function ChkNoAddr() As Boolean
   Dim stSQL As String
   Dim intQ As Integer
   Dim rsQuery As ADODB.Recordset
   
   If m_bolECust = True Then
      '已電子化系統:非FMP案且無實體文件(發文人員(CP154)是否為QPGMR)時不印
      If g_LD18 <> "" Then
         'Modified by Morgan 2019/4/18 取消發文日判斷(CFP報價定稿轉檔時尚無發文日)
         stSQL = "select cp09 from letterprogress,caseprogress" & _
            " where lp01='" & g_LD18 & "' and lp26='E'" & _
            " and cp09(+)=lp01 and cp154='QPGMR'"
         intQ = 1
         Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
         If intQ = 1 Then ChkNoAddr = True
      '未電子化系統:預設不印
      Else
         '使用者選擇要印
         If g_bolELtrAddr Then
            ChkNoAddr = False
         '預設
         Else
            ChkNoAddr = True
         End If
      End If
   End If
   
   Set rsQuery = Nothing
End Function

'Added by Morgan 2019/5/2
'Modified by Morgan 2025/11/11 +pIncludeSalesHandle
'是否指定E化客戶案件
Public Function PUB_ChkECustCase(ByVal pCP01 As String, ByVal pCP02 As String, ByVal pCP03 As String, ByVal pCP04 As String, Optional pIncludeSalesHandle As Boolean = False) As Boolean
   Dim stSQL As String
   Dim intQ As Integer
   Dim rsQuery As ADODB.Recordset
   Dim bolSalesHandle As Boolean
   
   stSQL = "select pa26 from patent where pa01='" & pCP01 & "' and pa02='" & pCP02 & "' and pa03='" & pCP03 & "' and pa04='" & pCP04 & "' and pa26 is not null"
   stSQL = stSQL & " union all select tm23 from trademark where tm01='" & pCP01 & "' and tm02='" & pCP02 & "' and tm03='" & pCP03 & "' and tm04='" & pCP04 & "' and tm23 is not null"
   stSQL = stSQL & " union all select sp08 from servicepractice where sp01='" & pCP01 & "' and sp02='" & pCP02 & "' and sp03='" & pCP03 & "' and sp04='" & pCP04 & "' and sp08 is not null"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      If PUB_ChkECust(rsQuery(0), pCP01, , intQ, bolSalesHandle) Then
         If intQ = 1 Then
            PUB_ChkECustCase = True
         'Added by Morgan 2025/11/11
         ElseIf bolSalesHandle And pIncludeSalesHandle Then
            PUB_ChkECustCase = True
         'end 2025/11/11
         End If
      End If
   End If
   Set rsQuery = Nothing
End Function

'Added by Morgan 2018/10/23
'Modified by Morgan 2019/4/19 +pMailType:1=指定信箱,2=代表信箱
'Modified by Morgan 2024/11/11 +pSalesHandle:是否業務自行處理(半E化)
'E化客戶指定信箱
Public Function PUB_ChkECust(ByVal pCustNo As String, ByVal pSys As String, Optional ByRef pEMail As String, Optional ByRef pMailType As Integer, Optional ByRef pSalesHandle As Boolean) As Boolean
   Dim stSQL As String
   Dim intQ As Integer
   Dim rsQuery As ADODB.Recordset
   
   pMailType = 0
   pSalesHandle = False
   If strSrvDate(1) >= e化客戶啟用日 Or (pSys = "P" Or pSys = "PS" Or pSys = "CFP" Or pSys = "CPS") Then
      pCustNo = Left(pCustNo & "000", 9)
      stSQL = "SELECT CU124,CU126,CU176,CU20,CU187,CU80 FROM CUSTOMER WHERE cu01='" & Left(pCustNo, 8) & "' and cu02='" & Mid(pCustNo, 9) & "'"
      intQ = 1
      Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
      If intQ = 1 Then
         'Added by Morgan 2024/11/11
         If rsQuery.Fields("cu80") = "業務自行處理" Then
            pSalesHandle = True
         End If
         'end 2024/11/11
                  
         If pSys = "P" Or pSys = "PS" Or pSys = "CFP" Or pSys = "CPS" Then
            If rsQuery("CU124") = "Y" Then
               PUB_ChkECust = True
               '若無指定信箱時表示尚未簽同意,仍維持舊E化模式帶代表信箱
               If strSrvDate(1) >= e化客戶啟用日 And Not IsNull(rsQuery.Fields("CU176")) Then
                  pEMail = rsQuery.Fields("CU176")
                  pMailType = 1
               Else
                  pEMail = "" & rsQuery.Fields("CU20")
                  pMailType = 2
               End If
            End If
         Else
            '設E化且有指定信箱(因商標尚未電子化,若只設E化但無指定信箱時並無意義)
            'Modified by Morgan 2021/12/14 全E化上線後，內商半E化客戶的信函也要印EMail
            If rsQuery("CU126") = "Y" Then
               PUB_ChkECust = True
               If Not IsNull(rsQuery.Fields("CU176")) Then
                  If Not IsNull(rsQuery.Fields("CU187")) Then
                     pEMail = rsQuery.Fields("CU187")
                  Else
                     pEMail = rsQuery.Fields("CU176")
                  End If
                  pMailType = 1
               Else
                  pEMail = "" & rsQuery.Fields("CU20")
                  pMailType = 2
               End If
            End If
         End If
      End If
   End If
   
   'Added by Morgan 2022/2/14 若有多個信箱時只回傳第1個
   If InStr(pEMail, ";") > 0 Then
      pEMail = Left(pEMail, InStr(pEMail, ";") - 1)
   End If
   'end 2022/2/14
   
   Set rsQuery = Nothing
End Function

'Added by Morgan 2018/11/5
'更新 非申請人/副本收受人 通知函的信函進度
Private Sub UpdateNoneApplLtr(pLP01 As String, pLP26 As String, pLD33 As String)
   Dim stSQL As String, intR As Integer, strCon As String
      
   '更新收受人(LP33)
   stSQL = "update letterprogress set LP33='" & pLD33 & "' where lp01='" & pLP01 & "' and nvl(lp33,'X')<>'" & pLD33 & "'"
   cnnConnection.Execute stSQL, intR
   
   '更新是否E化(LP26)
   stSQL = "update letterprogress set LP26='" & pLP26 & "' where lp01='" & pLP01 & "' and nvl(lp26,'N')<>nvl('" & pLP26 & "','N')"
   cnnConnection.Execute stSQL, intR
   If intR = 1 Then
      'E化
      If pLP26 = "Y" Then
         'Added by Morgan 2018/11/21
         If strSrvDate(1) >= e化客戶啟用日 Then
            '上線後直寄不必智權確認
            stSQL = "update letterprogress set lp06='QPGMR',lp07=to_char(sysdate,'YYYYMMDD') where lp01='" & pLP01 & "' and lp10='Y' and lp11='Y' and lp07=0"
            cnnConnection.Execute stSQL, intR
         Else
            '上線前掛號直寄要給發文室發文(平信不會設直寄)
            strCon = " and not exists(select * from letterprogress where lp01=cp09 and lp11='Y')"
         End If
         'end 2018/11/21
         
         '目前 非申請人/副本收受人 通知函沒有直寄或有實體的可直接上發文室發文(若將來有其他狀況時參考PUB_AddLetterProgress內容修改)
         'Modify By Sindy 2021/1/8 取消更新cp28 => cp28=cp09,
         stSQL = "update caseprogress set cp127=to_char(sysdate,'YYYYMMDD'),cp128=to_char(sysdate,'HH24MISS') where cp09='" & pLP01 & "'" & strCon
         cnnConnection.Execute stSQL, intR
         If intR = 1 Then
            'Trigger 會寫發文人故要另外更新
            stSQL = "update caseprogress set cp154='QPGMR' where cp09='" & pLP01 & "'"
            cnnConnection.Execute stSQL, intR
         End If
         
      '非E化
      Else
         '取消發文室發文
         'Modify By Sindy 2021/1/8 取消更新cp28 => cp28=NULL,
         stSQL = "update caseprogress set cp127=NULL,cp128=NULL,cp154=NULL where cp09='" & pLP01 & "' and cp154='QPGMR'"
         cnnConnection.Execute stSQL, intR
         
         If strSrvDate(1) >= e化客戶啟用日 Then
            stSQL = "update letterprogress set lp06=null,lp07=0 where lp01='" & pLP01 & "' and lp06='QPGMR'"
            cnnConnection.Execute stSQL, intR
         End If
      End If
   End If
   
End Sub

'Added by Morgan 2025/8/15
'用App開啟Pdf檔(ShellExecute不支援Unicode檔名"
Public Sub PUB_OpenPdf(pFileName As String)
   Dim program_name As String
   Dim process_id As Long
   
   program_name = PUB_SetFileAssociation
   '路徑可能含空白要加雙引號
   process_id = Shell("""" & program_name & """ """ & pFileName & """", vbNormalFocus)
End Sub

'Added by Morgan 2016/3/30 從 frm1105_1 搬來
Public Sub PUB_PrintPDF(pFileName As String, Optional pPrinter As String, Optional pCopy As Integer)
   Dim program_name As String
   Dim process_id As Long
   Dim process_handle As Long
   Dim ii As Integer
   
   If pPrinter = "" Then pPrinter = Printer.DeviceName

   program_name = PUB_SetFileAssociation

   '因為第 2 個以後開啟的 Reader 才會印完後自動關閉,所以固定先開一個空的程式,全部印完後再關閉
   'Modified by Morgan 2017/5/15 路徑可能含空白,改加雙引號
   process_id = Shell("""" & program_name & """", vbHide)
   process_handle = OpenProcess(PROCESS_TERMINATE, 0, process_id)
   
   PUB_PrintOnePdf program_name, " /n /t """ & pFileName & """ """ & pPrinter & """"
   
   'Added by Morgan 2018/11/30 印多份
   If pCopy > 0 Then
      For ii = 2 To pCopy
         PUB_PrintOnePdf program_name, " /n /t """ & pFileName & """ """ & pPrinter & """"
      Next
   End If
   'end 2018/11/30
   If process_handle <> 0 Then
      TerminateProcess process_handle, 0&
      CloseHandle process_handle
   End If
End Sub

'Added by Morgan 2016/3/30 從 frm1105_1 搬來
Public Sub PUB_PrintOnePdf(ByVal program_name As String, parameters As String)
Dim process_id As Long
Dim process_handle As Long
    ' Start the program.
    On Error GoTo ShellError

    'Modified by Morgan 2017/5/15 路徑可能含空白,改加雙引號
    process_id = Shell("""" & program_name & """ " & parameters, vbHide)
    
    On Error GoTo 0

    ' Wait for the program to finish.
    ' Get the process handle.
    process_handle = OpenProcess(SYNCHRONIZE, 0, process_id)
    If process_handle <> 0 Then
        'Modified by Morgan 2019/2/21 改等3秒就好，否則若第一個Reader沒有正常開啟時會本次列印後不會結束而當住
        'WaitForSingleObject process_handle, INFINITE
        WaitForSingleObject process_handle, 3000
        CloseHandle process_handle
    End If

    Exit Sub

ShellError:
    MsgBox " " & _
        program_name & vbCrLf & _
        Err.Description, vbOKOnly Or vbExclamation, _
        "Error"
End Sub

'Added by Morgan 2018/11/30
'列印商標註冊費繳費單
'Modify By Sindy 2018/12/14 + , Optional bolPrint As Boolean = False
'                             , Optional bolOpenFile As Boolean = True
'Modify By Sindy 2020/11/26 + Optional ByRef strAttach As String = ""
Public Function PUB_PrintTFeeForm(pCP01 As String, pCP02 As String, pCP03 As String, pCP04 As String, _
   Optional pPrinter As String, Optional bolPrint As Boolean = False, Optional bolOpenFile As Boolean = True, _
   Optional ByRef strAttach As String = "")
   
   Dim stFileName As String
   Dim iCopy As Integer, ii As Integer
   Dim bPaper As Boolean
   Dim strFileNm As String 'Add by Sindy 2018/11/30
   Dim hLocalFile As Long
   'Added by Lydia 2018/12/26
   Dim rsA1 As New ADODB.Recordset
   Dim strA1 As String
   'end 2018/12/26
   
On Error GoTo Error
   
   PUB_PrintTFeeForm = False
   If PUB_ChkDir(strTFeeForm) = False Then
      'MsgBox "無法讀取繳費單資料夾(" & strTFeeForm & ")，列印取消！", vbCritical
      Exit Function
   Else
      strFileNm = strTFeeForm & "\" & pCP01 & pCP02 & IIf(pCP03 & pCP04 = "000", "", "-" & pCP03 & "-" & pCP04) & "*.pdf"
      stFileName = strFileNm
      stFileName = Dir(stFileName)
      If stFileName <> "" Then
         PUB_PrintTFeeForm = True
         
         If pCP01 = "FCT" Then
            If PUB_GetEMailFlag(pCP01 & pCP02 & pCP03 & pCP04, , , bPaper) = True And bPaper = False Then
               'modify by sonia 2021/4/15 減少1份
               iCopy = 2
            Else
               'modify by sonia 2021/4/15 減少1份
               iCopy = 3
            End If
         End If
         'Added by Lydia 2018/12/26 代理人為日本區預設列印商標註冊費繳費單為3份。
         If pCP01 = "FCT" Then
              strA1 = "SELECT TM44,FA10 FROM TRADEMARK, FAGENT WHERE TM01='" & pCP01 & "' AND TM02='" & pCP02 & "' AND TM03='" & pCP03 & "' AND TM04='" & pCP04 & "' AND SUBSTR(TM44,1,8)=FA01(+) AND SUBSTR(TM44,9,1)=FA02(+) "
              ii = 1
              Set rsA1 = ClsLawReadRstMsg(ii, strA1)
              If ii = 1 Then
                  If Mid("" & rsA1.Fields("FA10"), 1, 3) = "011" Then
                      'modify by sonia 2021/4/15 減少1份
                      iCopy = 2
                  End If
              End If
              Set rsA1 = Nothing
         End If
         'end 2018/12/26
         
         strAttach = strTFeeForm & "\" & stFileName 'Add By Sindy 2020/11/26
         If bolPrint = True Then
            '列印
            PUB_PrintPDF strTFeeForm & "\" & stFileName, pPrinter, iCopy
         ElseIf bolOpenFile = True Then
            'Modify By Sindy 2018/12/4
            '開啟
            ShellExecute hLocalFile, "open", strTFeeForm & "\" & stFileName, vbNullString, vbNullString, 1
            '2018/12/4 END
         End If
      'Add by Sindy 2018/11/30
      ElseIf bolPrint = True Or bolOpenFile = True Then
         If strSrvDate(1) >= "20190201" Then
            MsgBox strFileNm & " 沒有繳費單電子檔", vbInformation
         Else
            MsgBox strFileNm & " 核准審定書要是107年12月之後的才有繳費單電子檔", vbInformation
         End If
      '2018/11/30 END
      End If
   End If
   
   Exit Function
   
Error:
   If Err.Number <> 0 Then
       MsgBox Err.Description, vbCritical
   End If
End Function

'Added by Morgan 2019/3/8
'員工檔專利處組別(ST70)轉中文說明
Public Function PUB_CST70(p_Code As String, Optional p_Dept As String = "P11") As String
   Dim rsQuery As ADODB.Recordset
   Dim intQ As Integer
   Dim stSQL As String
   
   stSQL = "select CST70('" & p_Code & "','" & p_Dept & "') from dual"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      PUB_CST70 = "" & rsQuery(0)
   End If
   Set rsQuery = Nothing
End Function

'Added by Lydia 2019/03/13 開啟中Word轉成PDF檔
'Modified by Lydia 2023/04/27 開啟中Word轉成PDF檔/Doc檔 PUB_PrintWord2File
'Public Function PUB_PrintWord2PDF(ByRef p_WordAp, ByVal pFolder As String, ByVal pFileName As String, Optional ByRef outFileName As String, Optional ByVal pOsDefPrinter As String) As Boolean
'   Dim strFullName As String
'
'   If UCase(TypeName(p_WordAp)) = "NOTHING" Then
'       Exit Function
'   End If
'   If pFolder = "" Or pFileName = "" Then
'       Exit Function
'   End If
'
'   If Right(UCase(pFileName), 4) <> ".PDF" Then
'       outFileName = pFileName & ".pdf"
'   Else
'       outFileName = pFileName
'   End If
'   strFullName = pFolder & "\" & outFileName
'
'On Error GoTo ErrHandle
'
'   RidFile strFullName '刪除舊檔
'
'   If pub_Word2Pdf Then
'      p_WordAp.ActiveDocument.ExportAsFixedFormat OutputFileName:=strFullName, ExportFormat:=17, OpenAfterExport:=False
'   Else
'      If pOsDefPrinter = "" Then
'          pOsDefPrinter = PUB_GetOsDefaultPrinter '作業系統預設印表機
'      End If
'      frmPDF.Show
'      frmPDF.StartProcess pFolder, pFileName
'      '切換印表機
'      If PUB_PdfCreatorNameInWord = "" Then PUB_PdfCreatorNameInWord = PUB_GetCreatorNameInWord
'      p_WordAp.ActivePrinter = PUB_PdfCreatorNameInWord
'      p_WordAp.ActiveDocument.PrintOut Background:=False, Copies:=1, Collate:=True
'      frmPDF.EndtProcess
'      Unload frmPDF
'
'      '還原印表機
'      PUB_SetOsDefaultPrinter pOsDefPrinter
'      PUB_SetWordActivePrinter
'      PUB_RestorePrinter pOsDefPrinter
'   End If
'
'   PUB_PrintWord2PDF = True
'
'   '關閉Word
'    p_WordAp.ActiveDocument.Close wdDoNotSaveChanges
'    If p_WordAp.Documents.Count = 0 Then
'       p_WordAp.Quit wdDoNotSaveChanges
'       Set p_WordAp = Nothing
'    End If
'
'    Exit Function
'
'ErrHandle:
'    If Err.Number <> 0 Then
'        MsgBox Err.Description, vbCritical, "Wor檔轉PDF檔失敗"
'    End If
'
'    Resume Next
'End Function

'Added by Lydia 2023/04/27 開啟中Word轉成PDF檔/DOC檔
Public Function PUB_PrintWord2File(ByRef p_WordAp, ByVal pFolder As String, ByVal pFileName As String, Optional ByRef outFileName As String) As Boolean
   Dim strFullName As String
   
   If UCase(TypeName(p_WordAp)) = "NOTHING" Then
       Exit Function
   End If
   If pFolder = "" Or pFileName = "" Then
       Exit Function
   End If
   
   If Right(UCase(pFileName), 4) <> ".PDF" And Right(UCase(pFileName), 4) <> ".DOC" And Right(UCase(pFileName), 4) <> ".DOCX" Then
       outFileName = pFileName & ".pdf"  '預設PDF檔
   Else
       outFileName = pFileName
   End If
   strFullName = pFolder & "\" & outFileName
   
On Error GoTo ErrHandle

   RidFile strFullName '刪除舊檔
   
   If Right(UCase(strFullName), 4) = ".PDF" Then
      p_WordAp.ActiveDocument.ExportAsFixedFormat OutputFileName:=strFullName, ExportFormat:=17, OpenAfterExport:=False
   Else
      p_WordAp.ActiveDocument.SaveAs strFullName
   End If
   
   PUB_PrintWord2File = True
   
   '關閉Word
   p_WordAp.ActiveDocument.Close wdDoNotSaveChanges
   p_WordAp.Quit wdDoNotSaveChanges
   Set p_WordAp = Nothing
   Exit Function
    
ErrHandle:
   If Err.Number <> 0 Then
        MsgBox Err.Description, vbCritical, "開啟中Word轉成PDF檔/DOC檔"
   End If
    
   Resume Next
End Function
'Add By Sindy 2020/1/21 從 frm030402 搬來此處,為共用函數
'Add By Cheng 2004/02/10
'取得菲律賓每五年的使用宣誓年度
Public Function PUB_Get030To105Year(strTM01 As String, strTM02 As String, _
   strTM03 As String, strTM04 As String, strNP09 As String) As String
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset

PUB_Get030To105Year = ""
If strNP09 <> "" Then
    StrSQLa = "Select * From Trademark Where " & ChgTradeMark(strTM01 & strTM02 & strTM03 & strTM04) & " And TM21 Is Not Null "
    rsA.CursorLocation = adUseClient
    rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
    If rsA.RecordCount > 0 Then
        PUB_Get030To105Year = DateDiff("yyyy", ChangeWStringToWDateString("" & rsA("TM21").Value), ChangeWStringToWDateString(strNP09))
        If Val(PUB_Get030To105Year) < 5 Then
            PUB_Get030To105Year = "零"
        ElseIf Val(PUB_Get030To105Year) >= 5 And Val(PUB_Get030To105Year) < 10 Then
            PUB_Get030To105Year = "五"
        ElseIf Val(PUB_Get030To105Year) >= 10 And Val(PUB_Get030To105Year) < 15 Then
            PUB_Get030To105Year = "十"
        ElseIf Val(PUB_Get030To105Year) >= 15 And Val(PUB_Get030To105Year) < 20 Then
            PUB_Get030To105Year = "十五"
        ElseIf Val(PUB_Get030To105Year) >= 20 And Val(PUB_Get030To105Year) < 25 Then
            PUB_Get030To105Year = "二十"
        ElseIf Val(PUB_Get030To105Year) >= 25 And Val(PUB_Get030To105Year) < 30 Then
            PUB_Get030To105Year = "二十五"
        ElseIf Val(PUB_Get030To105Year) >= 30 Then
            PUB_Get030To105Year = "三十"
        End If
    End If
    If rsA.State <> adStateClosed Then rsA.Close
    Set rsA = Nothing
End If
End Function

'Added by Lydia 2019/11/26 個案/Y/X基本檔設定寄證書後年費不續辦，目前案件的年費期限自動上不續辦
'Move by Lydia 2020/03/13 從basPublic搬來
'Modified by Lydia 2020/03/16 改成Function
'Public Sub Pub_AutoUpdFCP605(ByVal pNo As String)
Public Function Pub_AutoUpdFCP605(ByVal pNo As String, ByRef pSQL As String, ByRef pErrMsg As String)
Dim intJ As Integer
Dim rsBD As New ADODB.Recordset
Dim strConSql As String, strB1 As String, strA1 As String
Dim strCNo(1 To 4) As String

    If pNo = "" Then Exit Function
    
    If Left(pNo, 1) = "Y" Then
        strConSql = " pa75=" & CNULL(ChangeCustomerL(pNo))
        strA1 = "代理人-" & ChangeCustomerL(pNo)
    ElseIf Left(pNo, 1) = "X" Then
        '判斷申請人1的案件,含更名前的案件
        strConSql = " pa26 like '" & Left(ChangeCustomerL(pNo), 8) & "%' "
        strA1 = "申請人1-" & ChangeCustomerL(pNo)
    Else
        Call ChgCaseNo(Replace(pNo, "-", ""), strCNo)
        strConSql = " pa01='" & strCNo(1) & "' and pa02='" & strCNo(2) & "' and pa03='" & strCNo(3) & "' and pa04='" & strCNo(4) & "' "
        strA1 = "專利基本檔-" & strCNo(1) & "-" & strCNo(2) & IIf(strCNo(3) & strCNo(4) <> "000", "-" & strCNo(3) & "-" & strCNo(4), "")
    End If
    
'Added by Lydia 2020/03/16
On Error GoTo ErrHandle
    pErrMsg = ""
'end 2020/03/16

    If strConSql <> "" Then
        'Modified by Lydia 2019/12/11 FMP案要排除香港案013和澳門案044 ; 因為不是每年繳費(by 潘子微)
        'strB1 = "SELECT NP01,NP22 FROM PATENT, FAGENT, NEXTPROGRESS, CUSTOMER X1" & _
                    " WHERE " & strConSql & _
                    " AND SUBSTR(PA75,1,8)=FA01(+) AND SUBSTR(PA75,9,1)=FA02(+) AND SUBSTR(PA26,1,8)=X1.CU01(+) AND SUBSTR(PA26,9,1)=X1.CU02(+)" & _
                    " AND NVL(PA156,NVL(FA41,X1.CU74))='N' " & _
                    " AND PA01=NP02 AND PA02=NP03 AND PA03=NP04 AND PA04=NP05 AND NP06 IS NULL AND NP07='605'" & _
                    " AND PA57||PA108 IS NULL"
        'Modified by Lydia 2019/12/12 有專用期間(PA24,PA25)才上不續辦(因為公告到專利證書下來有一段期間，輸入證書號沒有年費期限會無法輸入)
        'Modified by Lydia 2020/01/03 剔除"有專利證書未發文之案件"; ex.FCP-52960
        'strB1 = "SELECT NP01,NP22 FROM PATENT, FAGENT, NEXTPROGRESS, CUSTOMER X1" & _
                    " WHERE " & strConSql & " AND (PA01='FCP' OR (PA01='P' AND PA09<>'013' AND PA09<>'044')) " & _
                    " AND SUBSTR(PA75,1,8)=FA01(+) AND SUBSTR(PA75,9,1)=FA02(+) AND SUBSTR(PA26,1,8)=X1.CU01(+) AND SUBSTR(PA26,9,1)=X1.CU02(+)" & _
                    " AND NVL(PA156,NVL(FA41,X1.CU74))='N' AND PA24||PA25 IS NOT NULL" & _
                    " AND PA01=NP02 AND PA02=NP03 AND PA03=NP04 AND PA04=NP05 AND NP06 IS NULL AND NP07='605'" & _
                    " AND PA57||PA108 IS NULL"
        'Modified by Lydia 2020/03/16 FMP案件不自動上年費不續辦，改發清單給程序，由各區程序逐筆產生定稿通知大陸代理人
        'strB1 = "SELECT NP01,NP22 FROM PATENT, FAGENT, NEXTPROGRESS, CUSTOMER X1" & _
                    " WHERE " & strConSql & " AND (PA01='FCP' OR (PA01='P' AND PA09<>'013' AND PA09<>'044')) " & _
                    " AND SUBSTR(PA75,1,8)=FA01(+) AND SUBSTR(PA75,9,1)=FA02(+) AND SUBSTR(PA26,1,8)=X1.CU01(+) AND SUBSTR(PA26,9,1)=X1.CU02(+)" & _
                    " AND NVL(PA156,NVL(FA41,X1.CU74))='N' AND PA24||PA25 IS NOT NULL" & _
                    " AND PA01=NP02 AND PA02=NP03 AND PA03=NP04 AND PA04=NP05 AND NP06 IS NULL AND NP07='605'" & _
                    " AND PA57||PA108 IS NULL AND (PA01,PA02,PA03,PA04) NOT IN (SELECT CP01,CP02,CP03,CP04 FROM CASEPROGRESS WHERE CP01 IN ('FCP','P') AND CP10='1603'  AND CP158=0 AND CP159=0)"
        strB1 = "SELECT NP01,NP22 FROM PATENT, FAGENT, NEXTPROGRESS, CUSTOMER X1" & _
                    " WHERE " & strConSql & " AND PA01='FCP' " & _
                    " AND SUBSTR(PA75,1,8)=FA01(+) AND SUBSTR(PA75,9,1)=FA02(+) AND SUBSTR(PA26,1,8)=X1.CU01(+) AND SUBSTR(PA26,9,1)=X1.CU02(+)" & _
                    " AND NVL(PA156,NVL(FA41,X1.CU74))='N' AND PA24||PA25 IS NOT NULL" & _
                    " AND PA01=NP02 AND PA02=NP03 AND PA03=NP04 AND PA04=NP05 AND NP06 IS NULL AND NP07='605'" & _
                    " AND PA57||PA108 IS NULL AND (PA01,PA02,PA03,PA04) NOT IN (SELECT CP01,CP02,CP03,CP04 FROM CASEPROGRESS WHERE CP01='FCP' AND CP10='1603'  AND CP158=0 AND CP159=0)"
        'Added by Lydia 2020/03/16 回傳-抓FMP案的範圍
        pSQL = "SELECT PATENT.*, NEXTPROGRESS.* FROM PATENT, FAGENT, NEXTPROGRESS, CUSTOMER X1" & _
                    " WHERE " & strConSql & " AND (PA01='P' AND PA09<>'013' AND PA09<>'044') " & _
                    " AND SUBSTR(PA75,1,8)=FA01(+) AND SUBSTR(PA75,9,1)=FA02(+) AND SUBSTR(PA26,1,8)=X1.CU01(+) AND SUBSTR(PA26,9,1)=X1.CU02(+)" & _
                    " AND NVL(PA156,NVL(FA41,X1.CU74))='N' AND PA24||PA25 IS NOT NULL" & _
                    " AND PA01=NP02 AND PA02=NP03 AND PA03=NP04 AND PA04=NP05 AND NP06 IS NULL AND NP07='605'" & _
                    " AND PA57||PA108 IS NULL AND (PA01,PA02,PA03,PA04) NOT IN (SELECT CP01,CP02,CP03,CP04 FROM CASEPROGRESS WHERE CP01='P' AND CP10='1603'  AND CP158=0 AND CP159=0)"
        
        'Modified by Lydia 2019/12/10 補上解除期限日期NP11、原因NP12='99'
        strB1 = "UPDATE NEXTPROGRESS SET NP06='N', NP11=" & strSrvDate(1) & ", NP12='99',NP15='" & ChangeTStringToTDateString(strSrvDate(2)) & strA1 & "，設年費不續辦;'||NP15 WHERE (NP01,NP22) IN (" & strB1 & ")" & _
                   " AND NP06 IS NULL"
        cnnConnection.Execute strB1, intJ
    End If
    
'Added by Lydia 2020/03/16
    Pub_AutoUpdFCP605 = True
    Exit Function
    
ErrHandle:
    If Err.Number <> "" Then
        pErrMsg = pErrMsg & vbCrLf & "個案/Y/X基本檔設定寄證書後年費不續辦，目前案件的年費期限自動上不續辦，發生錯誤---" & Err.Description
    End If
End Function

'Added by Lydia 2020/03/16 FMP案件不自動上年費不續辦，改發清單給程序，由各區程序逐筆產生定稿通知大陸代理人
                                        '(寰華案件：各區程序；非寰華案件：郭經理)
Public Function PUB_GetP605Email(ByVal pKind As String, ByVal pSQL As String, ByRef pErrMsg As String) As Boolean
'pKind : 1-由個案/X/Y編號基本檔將年費上續辦, 2-每月批次(frmAutoBatch.strMenu25)FCP寄證書後年費不續辦
Dim intB As Integer, iRound As Integer
Dim intW As Integer, iRow As Integer
Dim rsRD As New ADODB.Recordset
Dim strB1 As String, strB2 As String
Dim strMid As String
Dim ff605 As Integer
Dim strTmpFile As String, strDefName As String
Dim strDefDir As String
Dim strTo As String
Dim strTitle1 As String, strTitle2 As String
Dim tmpArr1 As Variant, tmpArr2 As Variant
Dim strTemp(0 To 5) As String
Dim strSub1 As String, strSub2 As String

    If pKind = "" Or pSQL = "" Then Exit Function
    
On Error GoTo ErrHandle

    pErrMsg = ""
    If pKind = "1" Then
        strDefDir = App.path & "\" & strUserNum
    Else
        strDefDir = App.path & "\textfile"
    End If

    strDefName = strDefDir & "\FMP案件年費不續辦清單*.txt"
    'Modifiedby Lydia 2020/08/19
    'If Dir(strDefName) <> "" Then
    '    Kill strDefName
    'End If
    Call PUB_KillTempFile(Mid(IIf(pKind = "1", "\" & strUserNum, "\textfile") & "\FMP案件年費不續辦清單*.txt", 2)) 'Added by Lydia 2020/08/19 清除舊檔
    'end 2020/08/19
    
    strMid = FMP2openSqlCont '寰華案判斷SQL
    strSub1 = "FMP案件不自動上年費不續辦，由各區程序逐筆Key年費不續辦產生定稿後通知大陸代理人。"
    strSub2 = "FMP案件年費不續辦清單,請發函通知大陸代理人"
    For iRound = 1 To 2
        'Modified by Lydia 2020/05/18 管制人要抓FC代理人的程序管制人
        'strB1 = "SELECT F0.CP01,F0.CP02,F0.CP03,F0.CP04,NVL(NA79,NA16) FMP_MAN,PA11,NVL(PA05,NVL(PA06,PA07)) CASENAME,NP09,NP15,F0.CP44,NVL(FA04,NVL(FA05,FA06)) FA_NAME " & _
                    "FROM CASEPROGRESS F0,( " & pSQL & ") X,FAGENT,NATION " & _
                    "WHERE X.PA01=F0.CP01(+) AND X.PA02=F0.CP02(+) AND X.PA03=F0.CP03(+) AND X.PA04=F0.CP04(+) AND F0.CP31='Y' AND SUBSTR(F0.CP12,1,1)='F' " & _
                    "AND SUBSTR(F0.CP44,1,8)=FA01(+) AND SUBSTR(F0.CP44,9,1)=FA02(+) AND FA10=NA01(+) "
        strB1 = "SELECT F0.CP01,F0.CP02,F0.CP03,F0.CP04,NVL(N2.NA79,N2.NA16) FMP_MAN,PA11,NVL(PA05,NVL(PA06,PA07)) CASENAME,NP09,NP15,F0.CP44,NVL(A1.FA04,NVL(A1.FA05,A1.FA06)) FA_NAME " & _
                    "FROM CASEPROGRESS F0,( " & pSQL & ") X,FAGENT A1,NATION N1,FAGENT A2,NATION N2 " & _
                    "WHERE X.PA01=F0.CP01(+) AND X.PA02=F0.CP02(+) AND X.PA03=F0.CP03(+) AND X.PA04=F0.CP04(+) AND F0.CP31='Y' AND SUBSTR(F0.CP12,1,1)='F' " & _
                    "AND SUBSTR(F0.CP44,1,8)=A1.FA01(+) AND SUBSTR(F0.CP44,9,1)=A1.FA02(+) AND A1.FA10=N1.NA01(+) " & _
                    "AND SUBSTR(PA75,1,8)=A2.FA01(+) AND SUBSTR(PA75,9,1)=A2.FA02(+) AND A2.FA10=N2.NA01(+) "
        strTo = ""
        If iRound = 2 Then '非寰華案
            strMid = Replace(strMid, "exists", "not exists")
        End If
        strB1 = strB1 & strMid
        intB = 1
        Set rsRD = ClsLawReadRstMsg(intB, strB1)
        If intB = 1 Then
            strTitle = "": strTitle2 = ""
            If iRound = 1 Then
                strB1 = "本所案號,申請案號,智權人員,案件名稱,年費期限,下一程序備註"
                strTmpFile = Replace(strDefName, "*", "_寰華案")
            Else
                strB1 = "本所案號,申請案號,智權人員,案件名稱,年費期限,大陸代理人"
                strTmpFile = Replace(strDefName, "*", "_非寰華案")
            End If
            strB2 = "15,15,8,26,10,30"
            tmpArr1 = Empty: tmpArr2 = Empty
            tmpArr1 = Split(strB1, ",")
            tmpArr2 = Split(strB2, ",")
            For intB = 0 To UBound(tmpArr1)
               If Trim(tmpArr1(intB)) <> "" Then
                   strTitle = strTitle & convForm(tmpArr1(intB), Val(tmpArr2(intB))) & " "
                   strTitle2 = strTitle2 & String(Val(tmpArr2(intB)), "=") & " "
               End If
            Next
            strTitle = Mid(strTitle, 1, Len(strTitle) - 1)
            strTitle2 = Mid(strTitle2, 1, Len(strTitle2) - 1)
            iRow = 0
            intW = GetTextLength(strTitle)
            rsRD.MoveFirst
            Do While Not rsRD.EOF
                 If strTo <> IIf(iRound = 1, "" & rsRD.Fields("fmp_man"), "79075") Then
                        If strTo <> "" Then
                            '寄給FMP管制人或內專人員
                            Print #ff605, String(intW, "=")
                            Print #ff605, "共 " & iRow & " 筆" & String(intW - GetTextLength("共 " & iRow & " 筆"), " ")
                            Close ff605
                            iRow = 0 'Added by Lydia 2021/02/09 debug
                            If pKind = "1" Then
                                 PUB_SendMail strUserNum, strTo, "", IIf(iRound = 1, strSub1, strSub2), vbCrLf & "請參考附件", , strTmpFile
                            Else '每月批次-先放在MailCache
                                 '以mc11儲存檔案路徑
                                 strB1 = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08,mc11) values (" & _
                                        CNULL("QPGMR") & ", " & CNULL(strTo) & ", to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss')," & _
                                        CNULL(IIf(iRound = 1, strSub1, strSub2)) & "," & _
                                        CNULL("請參考附件") & "," & CNULL(strTmpFile) & ") "
                                 cnnConnection.Execute strB1
                            End If
                        End If
                        '檔案名稱+通知人員
                        strTmpFile = Replace(strDefName, "*.txt", "(" & IIf(iRound = 1, "" & rsRD.Fields("fmp_man"), "79075") & ").txt")
                        
                        If Dir(strTmpFile) <> "" Then
                            Kill strTmpFile
                        End If
                        ff605 = FreeFile
                        Open strTmpFile For Output As ff605
                        
                        Print #ff605, String(35, " ") & "FMP案件年費不續辦清單" & IIf(iRound = 1, "_寰華案", "_非寰華案")
                        Print #ff605, ""
                        Print #ff605, IIf(pKind = "1", "列印人員：" & strUserName & String(70, " "), "") & "列印日期：" & ChangeTStringToTDateString(strSrvDate(2))
                        Print #ff605, strTitle
                        Print #ff605, strTitle2
                 End If
                 '本所案號
                 strTemp(0) = convForm(rsRD.Fields("CP01") & "-" & rsRD.Fields("CP02") & "-" & rsRD.Fields("CP03") & "-" & rsRD.Fields("CP04"), Val(tmpArr2(0)))
                 '申請案號
                 strTemp(1) = convForm("" & rsRD.Fields("PA11"), Val(tmpArr2(1)))
                 '智權人員
                 strTemp(2) = PUB_GetFCPSalesNo(rsRD.Fields("CP01"), rsRD.Fields("CP02"), rsRD.Fields("CP03"), rsRD.Fields("CP04"))
                 strTemp(2) = convForm(GetStaffName(strTemp(2)), Val(tmpArr2(2)))
                 '案件名稱
                 strTemp(3) = convForm("" & rsRD.Fields("casename"), Val(tmpArr2(3)))
                 '年費期限
                 strTemp(4) = convForm(ChangeWStringToTDateString("" & rsRD.Fields("np09")), Val(tmpArr2(4)))
                 '下一程序備註/大陸代理人
                 If iRound = 1 Then
                     strTemp(5) = convForm("" & rsRD.Fields("np15"), Val(tmpArr2(5)))
                 Else
                     strTemp(5) = convForm("" & rsRD.Fields("fa_name"), Val(tmpArr2(5)))
                 End If
                 Print #ff605, strTemp(0) & " "; strTemp(1) & " " & strTemp(2) & " " & strTemp(3) & " " & strTemp(4) & " " & strTemp(5) & " "
                 strTo = IIf(iRound = 1, "" & rsRD.Fields("fmp_man"), "79075")
                 iRow = iRow + 1
                 rsRD.MoveNext
            Loop
            If strTo <> "" Then
                '寄給FMP管制人或內專人員
                Print #ff605, String(intW, "=")
                Print #ff605, "共 " & iRow & " 筆" & String(intW - GetTextLength("共 " & iRow & " 筆"), " ")
                Close ff605
                If pKind = "1" Then
                    PUB_SendMail strUserNum, strTo, "", IIf(iRound = 1, strSub1, strSub2), vbCrLf & "請參考附件", , strTmpFile
                Else '每月批次-先放在MailCache
                     '以mc11儲存檔案路徑
                     strB1 = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08,mc11) values (" & _
                            CNULL("QPGMR") & ", " & CNULL(strTo) & ", to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss')," & _
                            CNULL(IIf(iRound = 1, strSub1, strSub2)) & "," & _
                            CNULL("請參考附件") & "," & CNULL(strTmpFile) & ") "
                     cnnConnection.Execute strB1
                End If
            End If
        End If
    Next iRound
   
    PUB_GetP605Email = True
    
    Set rsRD = Nothing
    Exit Function
    
ErrHandle:
   If Err.Number <> 0 Then
       pErrMsg = pErrMsg & vbCrLf & "FMP案件改發清單給程序，發生錯誤---" & Err.Description
   End If
End Function

'Added by Morgan 2020/3/24
'取得信頭/尾代碼
'傳入:pCompNo=公司別(2,J,L), pSYS=系統別(P,T...), pLang=語文(1:中文,2:英文), pOuter=是否對國外, pDept=操作人部門
'回傳:pPicNo1=信頭代碼, pPicNo2=信尾代碼
Public Sub PUB_GetLetterPicID(ByVal pCompNo As String, Optional ByVal pSys As String, Optional ByRef pPicNo1 As Integer, Optional ByRef pPicNo2 As Integer, Optional ByVal pLang As String = "1", Optional ByVal pOuter As Boolean = False, Optional ByVal pDept As String, Optional ByVal pFullPage As Boolean = False)
  
   pPicNo1 = 0 '信頭
   pPicNo2 = 0 '信尾
   
   '信紙
   'Modified by Lydia 2024/12/11 +  pDept = "HALF"
   If pFullPage = True Or pDept = "HALF" Then
      If pCompNo = "J" Then
         pPicNo1 = 87 '87.紙-英-智權ipdept+9Fax
      Else
         pPicNo1 = 86 '英-智慧+法律ipdept+9Fax
      End If
      'Added by Lydia 2024/12/11 改用EXCEL：信頭、信尾分開來
      If pDept = "HALF" Then
        If pCompNo = "J" Then
           pPicNo1 = 73 '智權公司 ipdept
           pPicNo2 = 69 '尾-英-9FFax
        Else
           pPicNo1 = 68 '智慧+法律 ipdept 英
           pPicNo2 = 69 '尾-英-9FFax
        End If
      End If
      'end 2024/12/11
      Exit Sub
   End If
   
   'FC案件固定用 ipdept(英文)
   If Left(pSys, 1) = "F" Then
      pPicNo1 = 68 '智慧+法律 ipdept 英
      pPicNo2 = 69 '尾-英-9FFax
   Else
   
      If pDept = "" Then pDept = GetStaffDepartment(strUserNum)
      '中文
      If pLang = "1" Then
         '對國內:
         If pOuter = False Then
            'lawoffice
            If pCompNo = "L" Then
               pPicNo1 = 76 '智慧+法律 lawoffice 中
               'Modified by Morgan 2020/4/8 改全所信尾--夏慧珠
               'pPicNo2 = 78 '尾-中-法律
               pPicNo2 = 82 '尾-中-全所
               'end 2020/4/8
            'ipdept
            Else
               If pCompNo = "J" Then
                  pPicNo1 = 73 '智權公司 ipdept
                  pPicNo2 = 77 '尾-中-智權
               Else
                  pPicNo1 = 79 '智慧+法律 ipdept 中
                  pPicNo2 = 82 '尾-中-全所
               End If
            End If
            
         '對國外(大陸)
         Else
            'lawoffice
            If pCompNo = "L" Then
               pPicNo1 = 83 '智慧+法律 lawoffice 英
               pPicNo2 = 72 '尾-英-10FFax(夏慧珠尚未提供,暫用)
            'ipdept
            Else
               '智權公司
               If pCompNo = "J" Then
                  pPicNo1 = 73 '智權公司 ipdept
               Else
                  pPicNo1 = 68 '智慧+法律 ipdept 英
               End If
               
               If Left(pDept, 1) = "F" Then
                  pPicNo2 = 69 '尾-英-9FFax
               Else
                  pPicNo2 = 72 '尾-英-10FFax
               End If
            End If
         End If
         
      '英/日文
      Else
         'lawoffice
         If pCompNo = "L" Then
            pPicNo1 = 83 '智慧+法律 lawoffice 英
            pPicNo2 = 72 '尾-英-10FFax(未製作,暫用)
         'ipdept
         Else
            '智權公司
            If pCompNo = "J" Then
               pPicNo1 = 73 '智權公司 ipdept
            Else
               pPicNo1 = 68 '智慧+法律 ipdept 英
            End If
            
            If Left(pDept, 1) = "F" Then
               pPicNo2 = 69 '尾-英-9FFax
            Else
               pPicNo2 = 72 '尾-英-10FFax
            End If
         End If
      End If
   End If
End Sub

'Added by Morgan 2020/3/30
'事務所名稱(合併後1公司改抓2公司名稱)
Public Function PUB_GetCompName2(ByVal pCompID As String) As String
      
   If strSrvDate(1) >= 智慧所更名日 Then
      If pCompID = "1" Then pCompID = "2"
   End If
   PUB_GetCompName2 = CompNameQuery(pCompID)
   
End Function

'Added by Morgan 2020//4/6
'檢查FCT日文不要信頭
Private Function ChkJPNoHead(pLD09 As String, pLD10 As String, pLD11 As String) As Boolean
   Dim srtQ As String, intQ As Integer
   Dim RsQ As ADODB.Recordset
   
   srtQ = "select ftm06 from finaltextmap where ftm01='FCT' and ftm07='2' and ftm02='" & pLD10 & "' and ftm03 in('000','" & pLD09 & "') and ftm04='" & pLD11 & "' order by ftm03 desc"
   intQ = 1
   Set RsQ = ClsLawReadRstMsg(intQ, srtQ)
   If intQ = 1 Then
       If InStr("" & RsQ(0), "譯文") > 0 Then
         ChkJPNoHead = True
       End If
   End If
   Set RsQ = Nothing
End Function

'Added by Morgan 2020/4/10
'非寰華之FMP案有期限(下一程序)來函要通知外專程序(目前為86024)
'Modified by Morgan 2020/9/15 +pToSales,pFCase;除已閉卷的來函通知外(未閉卷已併入工程師通知信)，改通知智權人員cc主管及FMP案外專程序窗口,且加入寰華案
'Modified by Morgan 2023/4/10 +pAfterReKeyIn:2次確認後發信
'Modified by Morgan 2024/6/5 +pChkDN:是否檢查未請款
Public Sub PUB_FMPCaseInform(pCP09 As String, Optional pCheckNP As Boolean = True, Optional pToSales As Boolean = True, Optional pFCase As Boolean = False, Optional pAfterReKeyIn As Boolean = False, Optional pChkDN As Boolean = False)
   Dim stSQL As String, intR As Integer
   Dim stRefPty As String 'Added by Morgan 2023/8/10
   'Added by Lydia 2024/05/13
   Dim stCP(1 To 4) As String, stNA16 As String, stCC As String
   Dim rsA1 As New ADODB.Recordset
   Dim stContent As String
   
   stRefPty = PUB_GetRelateCasePropertyName(pCP09, "1") 'Added by Morgan 2023/8/10
   
   'Modified by Morgan 2020/6/8 排除 通知期限-標準專利批准記錄請求(Ex:P-119937) --敏莉
   'Added by Morgan 2020/9/15
   If pToSales = True Then
      If pFCase = True Then
         'Added by Lydia 2024/05/13
         stCP(1) = "select cp01,cp02,cp03,cp04 from caseprogress where cp09='" & pCP09 & "' "
         intR = 1
         Set rsA1 = ClsLawReadRstMsg(intR, stCP(1))
         If intR = 1 Then
            stCP(1) = "" & rsA1.Fields("cp01")
            stCP(2) = "" & rsA1.Fields("cp02")
            stCP(3) = "" & rsA1.Fields("cp03")
            stCP(4) = "" & rsA1.Fields("cp04")
            stNA16 = PUB_GetFCPHandler(stCP(1), stCP(2), stCP(3), stCP(4))
            If stNA16 <> "" Then
               stCC = PUB_GetFCPProSup(stNA16)
               stCC = stNA16 & ";" & stCC
            Else
               stNA16 = strUserNum
               stCC = strUserNum
            End If
         End If
         'end 2024/05/13
         'Modified by Morgan 2020/11/12 寰華加CC給程序(建立人員)及backup(卷宗區)
         'Modified by Morgan 2023/4/10 +pAfterReKeyIn
         'Modified by Lydia 2024/05/13 若程序管制人員請假，請修改副本收件人:去掉操作人員主管，加上程序管制人員＋主管
         'stSQL = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08,mc09,mc12)" & _
            " select '" & strUserNum & "',cp13,to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss')" & _
            ",'【FMP(寰華)案'||m1.cpm04||decode(c1.cp10,'1913','-'||m2.cpm04,'" & stRefPty & "通知')||'】 Our Ref: '||c1.cp01||'-'||c1.cp02||decode(c1.cp03||c1.cp04,'000','','-'||c1.cp03||'-'||c1.cp04)||' [INCOM.'||c1.cp10||'] ，請通知代理人！'" & _
            ",'如旨',s1.st52||';'||s2.st52||';" & strUserNum & ";backup'," & IIf(pAfterReKeyIn, "99999999", "0") & " mc12" & _
            " from caseprogress c1,casepropertymap m1,nextprogress,casepropertymap m2,staff s1,staff s2" & _
            " where c1.cp09='" & pCP09 & "' and c1.cp12 like 'F%' and m1.cpm01(+)=c1.cp01 and m1.cpm02(+)=c1.cp10" & _
            " and np01(+)=c1.cp43 and np22(+)=c1.cp30 and c1.cp10||np07<>'1913111' and m2.cpm01(+)=np02 and m2.cpm02(+)=np07" & _
            " and s1.st01(+)=cp13 and s2.st01(+)=cp14"
         'Modified by Morgan 2025/5/7 +mc13
         stSQL = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08,mc09,mc12,mc13)" & _
            " select '" & strUserNum & "',cp13,to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss')" & _
            ",'【FMP(寰華)案'||m1.cpm04||decode(c1.cp10,'1913','-'||m2.cpm04,'" & stRefPty & "通知')||'】 Our Ref: '||c1.cp01||'-'||c1.cp02||decode(c1.cp03||c1.cp04,'000','','-'||c1.cp03||'-'||c1.cp04)||' [INCOM.'||c1.cp10||'] ，請通知代理人！'" & _
            ",'如旨',s1.st52||';'||decode(instr('" & stNA16 & "','" & strUserNum & "'),0,'" & stCC & "',s2.st52)||';" & strUserNum & ";backup'," & IIf(pAfterReKeyIn, "99999999", "0") & " mc12,c1.cp09 mc13" & _
            " from caseprogress c1,casepropertymap m1,nextprogress,casepropertymap m2,staff s1,staff s2" & _
            " where c1.cp09='" & pCP09 & "' and c1.cp12 like 'F%' and m1.cpm01(+)=c1.cp01 and m1.cpm02(+)=c1.cp10" & _
            " and np01(+)=c1.cp43 and np22(+)=c1.cp30 and c1.cp10||np07<>'1913111' and m2.cpm01(+)=np02 and m2.cpm02(+)=np07" & _
            " and s1.st01(+)=cp13 and s2.st01(+)=cp14"
            
        If pCheckNP = True Then
           stSQL = stSQL & " and exists(select * from nextprogress where np01=cp09 and np06 is null)"
        End If
      Else
      
         stContent = "如旨"
         'Added by Morgan 2024/6/5 FMP非寰華案的申請核准加未請款管控--Lisa
         If pChkDN Then
            stSQL = "select cpm04 from caseprogress,casepropertymap" & _
               " where (cp01,cp02,cp03,cp04) in (select cp01,cp02,cp03,cp04 from caseprogress where cp09='" & pCP09 & "')" & _
               " and cp20||cp60 is null and cp159=0 and cp10<>'901' and cp10<>'902' and (cp09<'B' or cp10 in ('1002','1009','1202'))" & _
               " and cpm01(+)=cp01 and cpm02(+)=cp10"
            intR = 1
            Set rsA1 = ClsLawReadRstMsg(intR, stSQL)
            If intR = 1 Then
               rsA1.MoveFirst
               stContent = rsA1.GetString(, , , "、")
               stContent = Mid(stContent, 1, Len(stContent) - 1)
               stContent = "「尚有須請款之案件性質未請款：" & stContent & "」"
            End If
         End If
         'end 2024/6/5
      
         'Modified by Morgan 2023/4/10 +pAfterReKeyIn
         'Modified by Morgan 2023/5/25 不必再CC給FMP案外專程序窗口--敏莉
         'Modified by Morgan 2025/5/7 +mc13,否則2次確認後不會更新mc12 Ex:P-125765
         stSQL = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08,mc09,mc12,mc13)" & _
            " select '" & strUserNum & "',cp13,to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss')" & _
            ",'FMP案'||m1.cpm04||decode(c1.cp10,'1913','-'||m2.cpm04,'" & stRefPty & "通知')||':'||c1.cp01||'-'||c1.cp02||decode(c1.cp03||c1.cp04,'000','','-'||c1.cp03||'-'||c1.cp04)||'，請通知代理人！'" & _
            ",'" & ChgSQL(stContent) & "',st52," & IIf(pAfterReKeyIn, "99999999", "0") & " mc12,c1.cp09 mc13" & _
            " from caseprogress c1,casepropertymap m1,nextprogress,casepropertymap m2,staff" & _
            " where c1.cp09='" & pCP09 & "' and c1.cp12 like 'F%' and m1.cpm01(+)=c1.cp01 and m1.cpm02(+)=c1.cp10" & _
            " and np01(+)=c1.cp43 and np22(+)=c1.cp30 and c1.cp10||np07<>'1913111' and m2.cpm01(+)=np02 and m2.cpm02(+)=np07" & _
            " and st01(+)=cp13"
         
      End If
   Else
   'end 2020/9/15
      
      stSQL = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08)" & _
         " select '" & strUserNum & "',oMan,to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss')" & _
         ",'FMP案'||m1.cpm04||decode(c1.cp10,'1913','-'||m2.cpm04,'" & stRefPty & "通知')||':'||c1.cp01||'-'||c1.cp02||decode(c1.cp03||c1.cp04,'000','','-'||c1.cp03||'-'||c1.cp04)" & _
         ",'如旨' from caseprogress c1,casepropertymap m1,nextprogress,casepropertymap m2,setSpecMan " & _
         " where c1.cp09='" & pCP09 & "' and c1.cp12 like 'F%' and m1.cpm01(+)=c1.cp01 and m1.cpm02(+)=c1.cp10" & _
         " and np01(+)=c1.cp43 and np22(+)=c1.cp30 and c1.cp10||np07<>'1913111' and m2.cpm01(+)=np02 and m2.cpm02(+)=np07" & _
         " and ocode(+)='FMP案外專程序窗口'"

   End If 'Added by Morgan 2020/9/15
   
   'Modified by Morgan 2023/5/26 +寰華案才判斷,FMP電子化所有來函都要EMail通知
   'If pCheckNP = True Then
   If pCheckNP = True And pFCase Then
   'end 2023/5/26
        stSQL = stSQL & " and exists(select * from nextprogress where np01=cp09 and np06 is null)"
   End If
      
   cnnConnection.Execute stSQL, intR
   Set rsA1 = Nothing 'Added by Lydia 2024/05/13
   
End Sub

'Added by Morgan 2020/5/19
'測試用函數
Public Sub PUB_MyTest()
   Dim stOld As String, stNew As String
   
   stOld = "[[12345" & vbCrLf & "xxxabcde|!xxx!|]]"
   
   stNew = Parser(stOld)
   Debug.Print stNew
End Sub

'Added by Lydia 2020/08/17 外專領證／年費發文之承辦單=>發email通知
Public Sub PUB_GetFCPEmpMail(ByVal pType As String, ByVal pKeyNo As String, ByVal pStrType As String, ByVal pCP148 As String, ByVal pPaid As String, ByVal pRecDate As String, ByVal pMemo As String, _
                                Optional ByRef pCP152 As String, Optional ByRef pMC02 As String, Optional ByRef pMC07 As String, Optional ByRef pMC08 As String, Optional ByRef pMC09 As String)
'pType : 1-直接存檔, 2-回傳, 3-整批年費發文(2022/4/12)
'pKeyNo : 收文號
'pStrType : 是否e/E化
'pCP148 : 特殊請款單
'pPaid : 已收款(1-不寄D/N, 2-寄D/N)
'pRecDate : 當天請款Y
'pMemo : 逾期補繳(來源表單的設定之描述)
'pMC02、pMC07、pMC08、pMC09: 收件人、主旨、內文、CC
Dim strB1 As String, intB As Integer, strB2 As String
Dim rsBD As New ADODB.Recordset
Dim intR As Integer
Dim strTo As String, strCC As String, strSubject As String, strContent As String, strSpeed As String
Dim bolGetSpec As Boolean 'Added by Lydia 2020/09/17 有特殊設定
Dim tmpArr1 As Variant
     
    If pType = "2" Then
        pMC02 = "": pMC07 = "": pMC08 = "": pMC09 = ""
    End If
    
    'Modified by Lydia 2023/05/02 +CP84
    strB1 = "select cp01,cp02,cp03,cp04,cp10,decode(pa09,'000',cpm03,cpm04) cp10n," & _
                "cp60,cp152,cp53,cp54,Substr(Nvl(Fa10,Cu10),1,3) Fcna01 ,pa75,pa26,pa27,pa28,pa29,pa30,cp84 " & _
                "from caseprogress, patent,casepropertymap,fagent,customer " & _
                "where cp09='" & pKeyNo & "' and cp01=pa01(+) and cp02=pa02(+) and cp03=pa03(+) and cp04=pa04(+) and cp01=cpm01(+) and cp10=cpm02(+) " & _
                "and substr(pa75,1,8)=fa01(+) and substr(pa75,9,1)=fa02(+) and substr(pa26,1,8)=cu01(+) and substr(pa26,9,1)=cu02(+) "
    intB = 1
    Set rsBD = ClsLawReadRstMsg(intB, strB1)
    If intB = 1 Then
        '抓承辦單特殊設定(FcpEmpBill): 備註、速別、Email收件人+CC
        'Modified by Lydia 2020/09/18 + 有特殊設定bolGetSpec
        'Modified by Lydia 2025/07/22 + 回傳主旨strSubject
        bolGetSpec = PUB_GetFcpEMPBillSpec(rsBD.Fields("cp01") & rsBD.Fields("cp02") & rsBD.Fields("cp03") & rsBD.Fields("cp04"), "06", "" & rsBD.Fields("pa75"), _
                                   rsBD.Fields("pa26") & "," & rsBD.Fields("pa27") & "," & rsBD.Fields("pa28") & "," & rsBD.Fields("pa29") & "," & rsBD.Fields("pa30"), , strB2, strSpeed, strSubject, , , strTo, strCC)
        '---------
        'Remove by Lydia 2021/01/19
        'If pCP148 = "Y" Then
        '    'ex: 【已送件-領證及繳年費/年費】可請款發文(email) Our Ref: FCP-0XXXXX [INCOM.601/605]
        '    strSubject = "【已送件-" & rsBD.Fields("cp10n") & " X1】可請款發文( X2) Our Ref: " & rsBD.Fields("cp01") & "-" & rsBD.Fields("cp02") & IIf(rsBD.Fields("cp03") <> "0", "-" & rsBD.Fields("cp03"), "") & IIf(rsBD.Fields("cp04") <> "00", "-" & rsBD.Fields("cp04"), "") & " [INCOM." & rsBD.Fields("cp10") & "]"
        'Else
        '
        'End If
        'end 2021/01/19
        'ex: 【已送件-領證及繳年費/年費】可請款發文(email) Our Ref: FCP-0XXXXX [INCOM.601/605]
        'ex: 【已送件-領證及繳年費/年費-特殊請款】請進行請款 Our Ref: FCP-0XXXXX [INCOM.601/605]
        'Modified by Lydia 2023/03/23 請將(Murgitroyd案優先)移至主旨前面，以便承辦可以快速辨認(by Bobbie); +PUB_GetSetMailSubF2
        'Modified by Lydia 2025/07/22 + 在Our Ref:前+回傳主旨strSubject " Our Ref: "
        strSubject = PUB_GetSetMailSubF2("" & rsBD.Fields("pa75")) & "【已送件-" & rsBD.Fields("cp10n") & " X1】" & IIf(pCP148 = "Y", "請進行請款 ( X2)", "可請款發文( X2)") & strSubject & " Our Ref: " & rsBD.Fields("cp01") & "-" & rsBD.Fields("cp02") & IIf(rsBD.Fields("cp03") <> "0", "-" & rsBD.Fields("cp03"), "") & IIf(rsBD.Fields("cp04") <> "00", "-" & rsBD.Fields("cp04"), "") & " [INCOM." & rsBD.Fields("cp10") & "]"
        
        '優先主旨: 特殊請款>當天請款>已收款>一般
        strB1 = ""
        If pCP148 = "Y" Then strB1 = strB1 & ",特殊請款"
        If pRecDate = "Y" Then strB1 = strB1 & ",當天請款"
        If pPaid = "1" Then
             strB1 = strB1 & ",已收款不寄D/N"
        ElseIf pPaid = "2" Then
            strB1 = strB1 & ",已收款寄D/N"
        End If
        If strB1 <> "" Then
           strSubject = Replace(strSubject, " X1", "-" & Mid(strB1, 2))
        Else
           strSubject = Replace(strSubject, " X1", "")
        End If
        '速別: e/E化
        strB1 = ""
        If strSpeed <> "" Then
             strB1 = strB1 & "," & strSpeed '抓承辦單設定FcpEmpBill
        Else
             '參考承辦單的預設 (PUB_PrintFCPEmpBill)
            'Modified by Lydia 2021/01/19 改成模組
'            If pStrType = "E" Then 'E+寄
'               If "" & rsBD.Fields("fcna01") = "011" Then '日本
'                  strSpeed = "Email+平信"
'               ElseIf "" & rsBD.Fields("fcna01") = "101" Then '美國
'                  strSpeed = "Email+掛號"
'               Else
'                  strSpeed = "Email+平信"
'               End If
'            ElseIf pStrType = "e" Then 'E化
'               strSpeed = "Email"
'            Else '非E化
'               If "" & rsBD.Fields("fcna01") = "011" Then '日本
'                  strSpeed = "掛號"
'               ElseIf "" & rsBD.Fields("fcna01") = "101" Then '美國
'                  strSpeed = "掛號"
'               Else
'                  strSpeed = "平信"
'               End If
'            End If
            strSpeed = GetFCPEmpSpeed(pStrType, "" & rsBD.Fields("fcna01"))
            'end 2021/01/19
            
            If "" & rsBD.Fields("fcna01") = "231" Then '德國
               If pStrType = "E" Then 'E+寄
                  strSpeed = "Email+掛號"
               ElseIf pStrType = "e" Then 'E化
                  strSpeed = "Email"
               Else '非E化
                  strSpeed = "掛號"
               End If
            End If
            '平信改掛號 --因為2020/02/21郵局業務調整
            If strSpeed <> "" Then strSpeed = Replace(strSpeed, "平信", "掛號")
            strB1 = strB1 & "," & strSpeed
        End If
        If strB1 = "" Or (pCP148 = "Y" And strSpeed = "") Then '特殊請款要判斷有無承辦單特殊設定
           strSubject = Replace(strSubject, "( X2)", "")
        Else
           strSubject = Replace(strSubject, " X2", Mid(strB1, 2))
        End If
        
        '內文
        intR = 1
        '逾期補繳(來源表單的設定之描述)
        If pMemo <> "" Then
            strContent = strContent & intR & ". " & pMemo & vbCrLf
            intR = intR + 1
        End If
        If strB2 <> "" Then '抓承辦單設定FcpEmpBill
           '若有換行，前面加3空白
           strContent = strContent & intR & ". " & Replace(strB2, Chr(13) & Chr(10), Chr(13) & Chr(10) & "　") & vbCrLf
           intR = intR + 1
        ElseIf Not (pCP148 = "Y" Or pRecDate = "Y") Then
           If pStrType = "e" Then '小e,Email
           Else '大E,E+寄　；紙本
               strContent = strContent & intR & ". 已出紙本，程序請整理請款紙本會承辦寄出。" & vbCrLf
               intR = intR + 1
           End If
        End If
        
        If pCP148 = "Y" Then
            strContent = strContent & intR & ". 特殊請款，請進行人工請款作業。" & vbCrLf
            intR = intR + 1
        End If
        If pRecDate = "Y" Then
            strContent = strContent & intR & ". 程序：待收據至請整理請款附件email承辦寄出及backup。" & vbCrLf
            intR = intR + 1
        End If
        If "" & rsBD.Fields("cp152") <> "" Then pCP152 = "" & rsBD.Fields("cp152")
        If pStrType = "" Then '紙本
            'Modified by Lydia 2023/05/02 "。" => ，規費金額：NTD
            strContent = strContent & intR & ". 請印收據紙本，收據下載日：" & ChangeWStringToTDateString(pCP152) & IIf(Val("" & rsBD.Fields("cp84")) > 0, "，規費金額：NTD " & rsBD.Fields("cp84"), "") & vbCrLf
        Else
            'Modified by Lydia 2023/05/02 "。" => ，規費金額：NTD
            strContent = strContent & intR & ". 收據下載日：" & ChangeWStringToTDateString(pCP152) & IIf(Val("" & rsBD.Fields("cp84")) > 0, "，規費金額：NTD " & rsBD.Fields("cp84"), "") & vbCrLf
        End If
        intR = intR + 1
        strContent = strContent & intR & ". 繳費年度：第" & IIf(Val("" & rsBD.Fields("cp53")) = 0, "  ", rsBD.Fields("cp53")) & "年∼第" & IIf(Val("" & rsBD.Fields("cp54")) = 0, "  ", rsBD.Fields("cp54")) & "年" & vbCrLf
        intR = intR + 1
        If pStrType = "" And pCP148 <> "Y" Then  '非E化，只存紙本  'Modified by Lydia 2020/08/07 特殊請款放在Typing2
           '請款定稿、帳單Backup回存卷宗區[paper.601/605] (對承辦人員)
            strContent = strContent & intR & ". 請款定稿、帳單Backup回存卷宗區[paper." & rsBD.Fields("cp10") & "]" & vbCrLf
        ElseIf pCP148 = "Y" Then '特殊請款不存DN
            strContent = strContent & intR & ". 請款定稿已存Typing2 。" & vbCrLf
        Else
            strContent = strContent & intR & ". 請款定稿、帳單已存Typing2 。" & vbCrLf
        End If
        intR = intR + 1
        'Email收件人: 指定人員代號F001-FCP承辦管制人NA51、F002-FCP承辦管制人之主管、F011-FCP程序管制人NA16、F012-FCP程序管制人之主管。
        If strTo = "" Then '無特殊設定，一般
           'Memo by Lydia 2020/08/13 Sharon: 當天請款>特殊請款>一般(e/E/紙本)
           If pRecDate = "Y" Then '當天請款Y
                strTo = "F011;"
           ElseIf pCP148 = "Y" Then '特殊請款單
                strTo = "F001;"
           ElseIf pStrType = "e" Then
                strTo = "F001;"
           ElseIf pStrType = "E" Then
                strTo = "F001;F011;"
           Else    '非E化,只寄紙本
                strTo = "F011;"
           End If
        Else
           strTo = Replace(strTo, ",", ";") & ";"
           strTo = Replace(Replace(Replace(Replace(strTo, "01;", "F001;"), "02;", "F002;"), "11;", "F011;"), "12;", "F012;")
        End If
        'Email副本收件人
        If strCC = "" Then '無特殊設定，一般
           'Memo by Lydia 2020/08/13 Sharon: 當天請款>特殊請款>一般(e/E/紙本)
           If pRecDate = "Y" Then '當天請款Y
                'strCC = "F012;" '8/13  程序主管不用CC
           ElseIf pCP148 = "Y" Then '特殊請款單
                strCC = "F002;F011;"
           ElseIf pStrType = "e" Then
                strCC = "F002;F011;"
           ElseIf pStrType = "E" Then
                strCC = "F002;"
           Else    '非E化,只寄紙本
                'strCC = "F012;"  '8/13  程序主管不用CC
           End If
        'Added by Lydia 2020/09/17 不要副本
        ElseIf strCC = "00;" Or strCC = "00" Then
              strCC = ""
        'end 2020/09/17
        Else
           strCC = Replace(strCC, ",", ";") & ";"
           strCC = Replace(Replace(Replace(Replace(strCC, "01;", "F001;"), "02;", "F002;"), "11;", "F011;"), "12;", "F012;")
        End If
        '收件人當中有承辦,才預設CC回backup, 自動歸入卷宗區
        'Modified by Lydia 2021/04/29 修改判斷
        'If InStr(strTo & ";", "F001;") > 0 Or InStr(strTo & ";", "F002;") > 0 Then
        If (InStr(strTo & ";", "F001;") > 0 Or InStr(strTo & ";", "F002;") > 0) And InStr(strCC & ";", "backup;") = 0 Then
            strCC = strCC & "backup;"
        End If
                                
        tmpArr1 = Split(strTo & ";" & strCC, ";")
        For intB = 0 To UBound(tmpArr1)
            If Trim(tmpArr1(intB)) <> "" And InStr("F001;F002;F011;F012;", Trim(tmpArr1(intB))) > 0 Then
                If InStr(strTo & ";" & strCC, Trim(tmpArr1(intB))) > 0 Then '未置換
                   strB1 = ""
                   Select Case Trim(tmpArr1(intB))
                       Case "F001"  'FCP承辦
                            strB1 = PUB_GetFCPSalesNo(rsBD.Fields("cp01"), rsBD.Fields("cp02"), rsBD.Fields("cp03"), rsBD.Fields("cp04"), rsBD.Fields("cp10"))
                            strTo = Replace(strTo, "F001;", strB1 & ";")
                            strCC = Replace(strCC, "F001;", strB1 & ";")
                       Case "F002"  'FCP承辦主管
                            strB1 = PUB_GetFCPProSup(PUB_GetFCPSalesNo(rsBD.Fields("cp01"), rsBD.Fields("cp02"), rsBD.Fields("cp03"), rsBD.Fields("cp04"), rsBD.Fields("cp10")))
                            strTo = Replace(strTo, "F002;", strB1 & ";")
                            strCC = Replace(strCC, "F002;", strB1 & ";")
                       Case "F011"  'FCP程序
                            strB1 = PUB_GetFCPHandler(rsBD.Fields("cp01"), rsBD.Fields("cp02"), rsBD.Fields("cp03"), rsBD.Fields("cp04"), rsBD.Fields("cp10"))
                            strTo = Replace(strTo, "F011;", strB1 & ";")
                            strCC = Replace(strCC, "F011;", strB1 & ";")
                       Case "F012"  'FCP程序主管
                            strB1 = PUB_GetFCPProSup(PUB_GetFCPHandler(rsBD.Fields("cp01"), rsBD.Fields("cp02"), rsBD.Fields("cp03"), rsBD.Fields("cp04"), rsBD.Fields("cp10")))
                            strTo = Replace(strTo, "F012;", strB1 & ";")
                            strCC = Replace(strCC, "F012;", strB1 & ";")
                   End Select
                End If
            End If
        Next intB
        
        'Added by Lydia 2022/04/12 將[實審請款]及[領證、年費請款] ，發文後自動發Outlook請款通知信中的C.C.人員請增加發文人員本身。(因為發文工作轉交非管制人員負責)
        If InStr(strCC, strUserNum) = 0 And pType <> "3" Then strCC = strUserNum & ";" & strCC
        
        'Modified by Lydi 2022/04/12 +整批年費發文 pType = "3"
        If pType = "1" Or pType = "3" Then  '1-直接存檔
            strB1 = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08,mc09)" & _
                        "values('" & strUserNum & "','" & strTo & "',to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss')" & _
                        ",'" & ChgSQL(strSubject) & "','" & ChgSQL(strContent) & "'," & CNULL(strCC) & ")"
            cnnConnection.Execute strB1, intI
        ElseIf pType = "2" Then '2-回傳
            pMC02 = strTo
            pMC07 = strSubject
            pMC08 = strContent
            pMC09 = strCC
        End If
    End If
   
    Set rsBD = Nothing
End Sub

'Added by Lydia 2019/03/04 通知函承辦單備註設定(FCPEmpBill)
'dbCaseNo:本所案號,dbPty:承辦單類別,dbFA:代理人編號,dbCu:申請人編號
'Modified by Lydia 2020/07/02 +Email收件人pStrTo,Email副本收件人pStrCC
'Move by Lydia 2020/08/20 從basPublic移過來
'Modify By Sindy 2021/3/24 + , Optional ByRef pStrReport As String = "", _
                  Optional ByVal pStrCol As String = "", Optional ByRef pStrColText As String = "", _
                  Optional ByVal pFEB20 As String = "", Optional ByVal pFEB21 As String = "", Optional ByVal pFEB22 As String = ""
Public Function PUB_GetFcpEMPBillSpec(dbCaseNo As String, dbPty As String, dbFA As String, dbCu As String, _
                  Optional ByRef pBolMsg As Boolean = False, _
                  Optional ByRef pMemo As String = "", Optional ByRef pSpeed As String = "", _
                  Optional ByRef pSubject As String = "", Optional ByRef pAppend As String = "", _
                  Optional ByRef pOther As String = "", _
                  Optional ByRef pStrTo As String, Optional ByRef pStrCC As String, _
                  Optional ByRef pStrReport As String = "", _
                  Optional ByVal pStrCol As String = "", Optional ByRef pStrColText As String = "", _
                  Optional ByRef pFEB20 As String = "", Optional ByRef pFEB21 As String = "", _
                  Optional ByRef pFEB22 As String = "") As Boolean
Dim stSQL As String, iR As Integer
Dim stCon As String
Dim strCon1 As String
Dim rsQuery As ADODB.Recordset
'Added by Lydia 2019/03/08 逐筆判斷Y代理人+X申請人1~5;若有一筆以上合併備註,其他只使用第一筆符合
Dim strMemo As String
Dim strAList As String
Dim iCall As Integer, iRound As Integer
Dim tmpArr As Variant, tmpArr2 As Variant
   
   'Add By Sindy 2021/3/29
   pMemo = "": pSpeed = "": pSubject = "": pAppend = ""
   pOther = ""
   pStrReport = "": pStrColText = ""
   pFEB20 = "": pFEB21 = "": pFEB22 = ""
   '2021/3/29 END
   
   If dbFA <> "" Then dbFA = ChangeCustomerL(dbFA) 'Add By Sindy 2021/8/3
   'Added by Lydia 2019/03/08 判斷有幾個申請人
   tmpArr = Split(dbCu, ",")
   For iR = 0 To UBound(tmpArr)
       If Trim(tmpArr(iR)) <> "" Then
           tmpArr(iR) = ChangeCustomerL(Trim(tmpArr(iR))) 'Add By Sindy 2021/8/3
           iCall = iCall + 1
       End If
   Next iR
   'end 2019/03/08
   
   '順序 1.本所案號 2.代理人+申請人 3.代理人 4.申請人
   If dbPty <> "" Then stCon = stCon & " and FEB06='" & dbPty & "' "
   'Modified by Lydia 2019/03/08 第3,5行補上stCon
   'Modified by Lydia 2019/03/03 改成逐筆判斷Y代理人+X申請人1~5
   'stSQL = "select 0 Od1, FEB02, FEB07, FEB08, FEB09, FEB10, FEB11 from FcpEMPBill where FEB03='" & dbCaseNo & "' " & stCon & _
      " union select 1 Od1, FEB02, FEB07, FEB08, FEB09, FEB10, FEB11 from FcpEMPBill where FEB04='" & Left(dbFA, 8) & "' and FEB05='" & Left(dbCu, 8) & "' " & stCon & _
      " union select 2 Od1, FEB02, FEB07, FEB08, FEB09, FEB10, FEB11 from FcpEMPBill where FEB04='" & Left(dbFA, 8) & "' and FEB05='" & Left(dbCu, 6) & "' " & stCon & _
      " union select 3 Od1, FEB02, FEB07, FEB08, FEB09, FEB10, FEB11 from FcpEMPBill where FEB04='" & Left(dbFA, 8) & "' and FEB05 is null" & stCon & _
      " union select 4 Od1, FEB02, FEB07, FEB08, FEB09, FEB10, FEB11 from FcpEMPBill where FEB04='" & Left(dbFA, 6) & "' and FEB05='" & Left(dbCu, 8) & "' " & stCon & _
      " union select 5 Od1, FEB02, FEB07, FEB08, FEB09, FEB10, FEB11 from FcpEMPBill where FEB04='" & Left(dbFA, 6) & "' and FEB05='" & Left(dbCu, 6) & "' " & stCon & _
      " union select 6 Od1, FEB02, FEB07, FEB08, FEB09, FEB10, FEB11 from FcpEMPBill where FEB04='" & Left(dbFA, 6) & "' and FEB05 is null" & stCon & _
      " union select 7 Od1, FEB02, FEB07, FEB08, FEB09, FEB10, FEB11 from FcpEMPBill where FEB04 is null and FEB05='" & Left(dbCu, 8) & "' " & stCon & _
      " union select 8 Od1, FEB02, FEB07, FEB08, FEB09, FEB10, FEB11 from FcpEMPBill where FEB04 is null and FEB05='" & Left(dbCu, 6) & "' " & stCon & _
      " order by Od1, FEB02, FEB07, FEB08, FEB09, FEB10, FEB11"
   strCon1 = "FEB02, FEB07, FEB08, FEB09, FEB10, FEB11, FEB18, FEB19, FEB23, FEB25, FEB04, FEB05 " 'Added by Lydia 2023/03/22
   For iRound = 1 To iCall
        'Modified by Lydia 2020/07/02 + FEB18,FEB19
        'Modify By Sindy 2021/3/24 + ,FEB23, FEB25, FEB04, FEB05" & IIf(pStrCol <> "", "," & pStrCol, "") & ",FEB20,FEB21,FEB22
        'Modified by Lydia 2023/03/22 從先處理Y編號，改成先處理Y+X編號 ---Sharon
        'stSQL = "select 0 Od1, FEB02, FEB07, FEB08, FEB09, FEB10, FEB11, FEB18, FEB19, FEB23, FEB25, FEB04, FEB05" & IIf(pStrCol <> "", "," & pStrCol, "") & ",FEB20,FEB21,FEB22 from FcpEMPBill where FEB03='" & dbCaseNo & "' " & stCon & _
           " union select 1 Od1, FEB02, FEB07, FEB08, FEB09, FEB10, FEB11, FEB18, FEB19, FEB23, FEB25, FEB04, FEB05" & IIf(pStrCol <> "", "," & pStrCol, "") & ",FEB20,FEB21,FEB22 from FcpEMPBill where FEB04='" & Left(dbFA, 8) & "' and FEB05='" & Left(tmpArr(iRound - 1), 8) & "' " & stCon & _
           " union select 2 Od1, FEB02, FEB07, FEB08, FEB09, FEB10, FEB11, FEB18, FEB19, FEB23, FEB25, FEB04, FEB05" & IIf(pStrCol <> "", "," & pStrCol, "") & ",FEB20,FEB21,FEB22 from FcpEMPBill where FEB04='" & Left(dbFA, 8) & "' and FEB05='" & Left(tmpArr(iRound - 1), 6) & "' " & stCon & _
           " union select 3 Od1, FEB02, FEB07, FEB08, FEB09, FEB10, FEB11, FEB18, FEB19, FEB23, FEB25, FEB04, FEB05" & IIf(pStrCol <> "", "," & pStrCol, "") & ",FEB20,FEB21,FEB22 from FcpEMPBill where FEB04='" & Left(dbFA, 8) & "' and FEB05 is null" & stCon & _
           " union select 4 Od1, FEB02, FEB07, FEB08, FEB09, FEB10, FEB11, FEB18, FEB19, FEB23, FEB25, FEB04, FEB05" & IIf(pStrCol <> "", "," & pStrCol, "") & ",FEB20,FEB21,FEB22 from FcpEMPBill where FEB04='" & Left(dbFA, 6) & "' and FEB05='" & Left(tmpArr(iRound - 1), 8) & "' " & stCon & _
           " union select 5 Od1, FEB02, FEB07, FEB08, FEB09, FEB10, FEB11, FEB18, FEB19, FEB23, FEB25, FEB04, FEB05" & IIf(pStrCol <> "", "," & pStrCol, "") & ",FEB20,FEB21,FEB22 from FcpEMPBill where FEB04='" & Left(dbFA, 6) & "' and FEB05='" & Left(tmpArr(iRound - 1), 6) & "' " & stCon & _
           " union select 6 Od1, FEB02, FEB07, FEB08, FEB09, FEB10, FEB11, FEB18, FEB19, FEB23, FEB25, FEB04, FEB05" & IIf(pStrCol <> "", "," & pStrCol, "") & ",FEB20,FEB21,FEB22 from FcpEMPBill where FEB04='" & Left(dbFA, 6) & "' and FEB05 is null" & stCon & _
           " union select 7 Od1, FEB02, FEB07, FEB08, FEB09, FEB10, FEB11, FEB18, FEB19, FEB23, FEB25, FEB04, FEB05" & IIf(pStrCol <> "", "," & pStrCol, "") & ",FEB20,FEB21,FEB22 from FcpEMPBill where FEB04 is null and FEB05='" & Left(tmpArr(iRound - 1), 8) & "' " & stCon & _
           " union select 8 Od1, FEB02, FEB07, FEB08, FEB09, FEB10, FEB11, FEB18, FEB19, FEB23, FEB25, FEB04, FEB05" & IIf(pStrCol <> "", "," & pStrCol, "") & ",FEB20,FEB21,FEB22 from FcpEMPBill where FEB04 is null and FEB05='" & Left(tmpArr(iRound - 1), 6) & "' " & stCon & _
           " order by Od1, FEB02, FEB07, FEB08, FEB09, FEB10, FEB11"
        stSQL = "select 0 Od1, " & strCon1 & IIf(pStrCol <> "", "," & pStrCol, "") & ",FEB20,FEB21,FEB22 from FcpEMPBill where FEB03='" & dbCaseNo & "' " & stCon & _
           " union select 1 Od1, " & strCon1 & IIf(pStrCol <> "", "," & pStrCol, "") & ",FEB20,FEB21,FEB22 from FcpEMPBill where FEB04='" & Left(dbFA, 8) & "' and FEB05='" & Left(tmpArr(iRound - 1), 8) & "' " & stCon & _
           " union select 2 Od1, " & strCon1 & IIf(pStrCol <> "", "," & pStrCol, "") & ",FEB20,FEB21,FEB22 from FcpEMPBill where FEB04='" & Left(dbFA, 8) & "' and FEB05='" & Left(tmpArr(iRound - 1), 6) & "' " & stCon & _
           " union select 3 Od1, " & strCon1 & IIf(pStrCol <> "", "," & pStrCol, "") & ",FEB20,FEB21,FEB22 from FcpEMPBill where FEB04='" & Left(dbFA, 6) & "' and FEB05='" & Left(tmpArr(iRound - 1), 8) & "' " & stCon & _
           " union select 4 Od1, " & strCon1 & IIf(pStrCol <> "", "," & pStrCol, "") & ",FEB20,FEB21,FEB22 from FcpEMPBill where FEB04='" & Left(dbFA, 6) & "' and FEB05='" & Left(tmpArr(iRound - 1), 6) & "' " & stCon & _
           " union select 5 Od1, " & strCon1 & IIf(pStrCol <> "", "," & pStrCol, "") & ",FEB20,FEB21,FEB22 from FcpEMPBill where FEB04='" & Left(dbFA, 8) & "' and FEB05 is null" & stCon & _
           " union select 6 Od1, " & strCon1 & IIf(pStrCol <> "", "," & pStrCol, "") & ",FEB20,FEB21,FEB22 from FcpEMPBill where FEB04='" & Left(dbFA, 6) & "' and FEB05 is null" & stCon & _
           " union select 7 Od1, " & strCon1 & IIf(pStrCol <> "", "," & pStrCol, "") & ",FEB20,FEB21,FEB22 from FcpEMPBill where FEB04 is null and FEB05='" & Left(tmpArr(iRound - 1), 8) & "' " & stCon & _
           " union select 8 Od1, " & strCon1 & IIf(pStrCol <> "", "," & pStrCol, "") & ",FEB20,FEB21,FEB22 from FcpEMPBill where FEB04 is null and FEB05='" & Left(tmpArr(iRound - 1), 6) & "' " & stCon & _
           " order by Od1, FEB02, FEB07, FEB08, FEB09, FEB10, FEB11"
   'end 2019/03/08
            iR = 1
            Set rsQuery = ClsLawReadRstMsg(iR, stSQL)
            If iR = 1 Then
               'Add By Sindy 2021/3/24 檢查是否有要踢除的編號
               If "" & rsQuery.Fields("FEB25") <> "" Then
                  tmpArr2 = Split(rsQuery.Fields("FEB25"), ",")
                  For iR = 0 To UBound(tmpArr2)
                     If Trim(tmpArr2(iR)) <> "" Then
                        If Left(rsQuery.Fields("FEB25"), 1) = "Y" Then
                           If InStr(dbFA, Trim(tmpArr2(iR))) > 0 Then
                              GoTo ReadNext
                           End If
                        ElseIf Left(rsQuery.Fields("FEB25"), 1) = "X" Then
                           If InStr(dbCu, Trim(tmpArr2(iR))) > 0 Then
                              GoTo ReadNext
                           End If
                        End If
                     End If
                  Next iR
               End If
               '2021/3/24 END
               
               PUB_GetFcpEMPBillSpec = True
               'Mark by Lydia 2019/03/08 移到下方
               ''03-證書函使用: 1.彈訊息+列印在承辦單, 2.僅列印在承辦單
               'If "" & rsQuery.Fields("FEB07") = "1" Then
               '     pBolMsg = True
               'Else
               '     pBolMsg = False
               'End If
               
               '承辦單:備註
               'Modified by Lydia 2019/03/08 逐筆判斷Y代理人+X申請人1~5;若有一筆以上合併備註,其他只使用第一筆符合
               'pMemo = "" & rsQuery.Fields("FEB02")
               If "" & rsQuery.Fields("FEB02") <> "" Then
                    If strMemo = "" Then
                        strMemo = "" & rsQuery.Fields("FEB02")
                    Else
                        'Added by Lydia 2020/07/02
                        If InStr(strMemo, "" & rsQuery.Fields("FEB02")) = 0 Then
                            strMemo = strMemo & IIf(strMemo <> "", vbCrLf, "") & rsQuery.Fields("FEB02")
                        End If
                    End If
                    '03-證書函使用: 1.彈訊息+列印在承辦單, 2.僅列印在承辦單
                    If pBolMsg = False And "" & rsQuery.Fields("FEB07") = "1" Then
                         pBolMsg = True
                    End If
               End If
               'end 2019/03/08
               If strAList = "" Then 'Added by Lydia 2019/03/08 其他欄位只使用第一筆符合
                  '承辦單:速別
                  pSpeed = "" & rsQuery.Fields("FEB08")
                  '承辦單:主旨
                  pSubject = "" & rsQuery.Fields("FEB09")
                  'pAppend 承辦單: 附件
                  pAppend = "" & rsQuery.Fields("FEB10")
                  '承辦單:其他
                  pOther = "" & rsQuery.Fields("FEB11")
                  'Added by Lydia 2020/07/02
                  pStrTo = "" & rsQuery.Fields("FEB18") 'Email收件人
                  pStrCC = "" & rsQuery.Fields("FEB19") 'Email副本收件人
                  'end 2020/07/02
                  'Modify By Sindy 2021/3/24
                  pStrReport = "" & rsQuery.Fields("FEB23") '優先寄專利證書+公報
                  If pStrCol <> "" Then
                     pStrColText = "" & rsQuery.Fields(pStrCol) '欲取得的資料欄位值
                  End If
                  pFEB20 = "" & rsQuery.Fields("FEB20") '證書正本
                  pFEB21 = "" & rsQuery.Fields("FEB21") '地址條收件人
                  pFEB22 = "" & rsQuery.Fields("FEB22") '聯絡人名稱
                  '2021/3/24 END
               End If 'end 2019/03/08
               'Added by Lydia 2019/03/08 本所案號符合,不用繼續判斷
               If "" & rsQuery.Fields("Od1") = "0" Then
                  GoTo JumpToEnd
               End If
               strAList = strAList & IIf(strAList <> "", ",", "") & tmpArr(iRound - 1)
               'end 2019/03/08
            End If
ReadNext:
'Added by Lydia 2019/03/08
   Next iRound
   
JumpToEnd:
   pMemo = strMemo
'end 2019/03/08
   
   Set rsQuery = Nothing
End Function

'Add By Sindy 2015/6/16 列印FCP承辦單
'Modified by Lydia 2020/07/09 +傳入備註m_OptMemo
'Move by Lydia 2020/08/20 從basPublic移過來
Public Sub PUB_PrintFCPEmpBill(m_strPA01 As String, m_strPA02 As String, m_strPA03 As String, m_strPA04 As String, m_strRptKind As String, _
                               Optional m_strCP09 As String = "", Optional m_strCP10 As String = "", Optional m_strNP09 As String = "", _
                               Optional m_strMemo As String = "", Optional m_OptMemo As String = "")
'strRptKind : 14.公開公報
'             04.核准函
'             05.公告公報 : m_strMemo=符號註記
'             07.證書函
'             08.繳年費通知函 m_strMemo=繳費年度
'             08.繳年費通知函 m_strCP10=416.實體審查
'             10.年證費請款函 m_strMemo=1.領證及繳年費 2.年費
'             13.專利權消滅 / 年費逾期 : m_strMemo=1.專利權消滅 2.年費逾期
'Memo by Lydia 2019/03/04 新增「通知函承辦單設定維護(frm060509)整理現有類別如下：
'Memo by Lydia 2019/03/05 統一更名=>告准承辦單、公告公報承辦單、寄證書承辦單、年費請款承辦單、實審請款承辦單、年證費請款承辦單
'             01-核准函 => 告准承辦單
'             02-公告公報 => 公告公報承辦單
'             03-證書函 => 寄證書承辦單
              'Modified by Lydia 2019/10/18 更名: 繳年費通知承辦單
'             04-繳年費通知函 => (2019/03/05) 年費請款承辦單 => (2019/10/18) 繳年費通知承辦單
'             05-一般發文-實審416實體審查請款函 => 實審請款承辦單
'             06-年證費請款函 => 年證費請款承辦單
'Memo by Lydia 2020/02/21
'            因郵局已取消國外信件之限時專送、限掛（快遞）業務,故有關承辦單速別的設定
'            1.  原設定限掛的->全改為掛號
'            2.  年費請款承辦單: 限時->全改為掛號'Memo by Lydia 2020/02/26 包含6-年證費請款、5-實審請款
'            3.  E+限時->改為E+平信
'            4.  限時->改為掛號
Dim rsA As New ADODB.Recordset
Dim m_PA12 As String '公開日
Dim m_FCna01 As String, m_FCNa03 As String 'FC代理人國籍
Dim m_FCNa16 As String 'FC代理人國籍的FCP管制人
Dim m_eMail As String '是否E化
Dim m_CP14 As String, oStrA14 As String '承辦人代碼
Dim m_CP64 As String '案件備註
Dim strSpeed As String '速別
Dim strGetPaper As String '受文者
Dim strMainText As String '主旨
Dim strAppend As String '附件
Dim strOther As String '其他
Dim strNote As String '備註
Dim strControlEmp As String '管制人員
Dim LenStar As Long
'Dim IsHaveTaieLogo As Boolean
Dim i As Integer
Dim DrawCount As Integer
Dim intFixedHigh As Integer
Dim ArrStr As Variant
Dim strYear As String, strNP15 As String
Dim m_FCPEmp As String
Dim m_PA76 As String, m_PA25 As String
Dim m_PA75 As String, m_PA160 As String 'Add By Sindy 2015/11/3
Dim m_PA26 As String                    'add by sonia 2015/11/30
Dim m_CP152 As String 'Added by Lydia 2019/01/04 扣款日期
Dim m_CP84 As String 'Added by Lydia 2023/05/02 規費金額
'Added by Lydia 2019/03/04 通知函承辦單備註設定
Dim bolGetSpec As Boolean
Dim gMemo As String, gSpeed As String, gMain As String, gAppend As String, gOther As String '備註內容、速別、主旨、附件、其他
'Added by Lydia 2019/03/08
Dim m_PA27 As String, m_PA28 As String, m_PA29 As String, m_PA30 As String
Dim m_PA150 As String 'Added by Lydia 2019/09/03 工程師組別
Dim m_PA174 As String 'Added by Lydia 2020/02/27 名稱有特殊字
Dim gReport As String 'Add By Sindy 2021/3/30
Dim m_PA178 As String 'Added by Morgan 2023/2/9

   '粗線深度
   DrawCount = 20
   intFixedHigh = 400 '行高
   
'   IsHaveTaieLogo = False
'   If Dir(Trim(App.path) & "\taie_logo.jpg") <> "" Then
'      IsHaveTaieLogo = True
'      pic1.Picture = LoadPicture(App.path & "\taie_logo.jpg")
'   ElseIf Dir("c:\pics\taie_logo.jpg") <> "" Then
'      IsHaveTaieLogo = True
'      pic1.Picture = LoadPicture("c:\pics\taie_logo.jpg")
'   End If
   
   '基本檔資料
   'modify by sonia 2015/11/30 +pa26
   'Modified by Lydia 2019/03/08 +PA27,PA28,PA29,PA30
   'Modified by Lydia 2019/09/03 +PA150
   'Modified by Lydia 2020/02/27 +PA174
   'Modified by Morgan 2023/2/9 +PA178
   strSql = "Select pa01,pa02,pa03,pa04,pa09,pa12,na01,na03,GetEmailFlag(PA01||PA02||PA03||PA04) eMail," & _
              "na16,na51,st02,PA76,cu96,pa25,pa75,pa160,pa26,PA27,PA28,PA29,PA30,PA150,PA174,PA178 " & _
             " From Patent,nation,fagent,staff,customer" & _
            " Where PA01='" & m_strPA01 & "' AND PA02='" & m_strPA02 & "' AND PA03='" & m_strPA03 & "' AND PA04='" & m_strPA04 & "'" & _
              " and substr(pa75,1,8)=fa01(+) and substr(pa75,9,1)=fa02(+) and fa10=na01(+)" & _
              " and na16=st01(+)" & _
              " and substr(pa26,1,8)=cu01(+) and substr(pa26,9,1)=cu02(+)"
   rsA.CursorLocation = adUseClient
   rsA.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If rsA.RecordCount > 0 Then
      m_PA12 = "" & rsA.Fields("pa12")
      m_FCna01 = Left(Trim("" & rsA.Fields("na01")), 3)
      m_FCNa03 = Trim("" & rsA.Fields("na03"))
      m_eMail = "" & rsA.Fields("eMail")
      m_FCNa16 = Trim("" & rsA.Fields("st02"))
      'Modified by Morgan 2018/5/16 大陸代理人有特殊控制 Ex:FCP-57342
      'm_FCPEmp = GetPrjSalesNM(Trim("" & rsA.Fields("na51"))) 'FCP承辦業務員
      m_FCPEmp = GetPrjSalesNM(PUB_GetFCPSalesNo(m_strPA01, m_strPA02, m_strPA03, m_strPA04)) 'FCP承辦業務員
      'end 2018/5/16
      '年費代理人:個案年費代理人為主,若無時,再取申請人的年費代理人
      If Trim("" & rsA.Fields("PA76")) = "" Then
         m_PA76 = Trim("" & rsA.Fields("cu96"))
      Else
         m_PA76 = Trim("" & rsA.Fields("PA76"))
      End If
      
      m_PA25 = "" & rsA.Fields("PA25") '專用期間(止)
      m_PA75 = "" & rsA.Fields("PA75") 'FC代理人
      m_PA26 = "" & rsA.Fields("PA26") '第1申請人
      m_PA160 = "" & rsA.Fields("PA160") '國際分類
      'Added by Lydia 2019/03/08
      m_PA27 = "" & rsA.Fields("PA27") '第2申請人
      m_PA28 = "" & rsA.Fields("PA28") '第3申請人
      m_PA29 = "" & rsA.Fields("PA29") '第4申請人
      m_PA30 = "" & rsA.Fields("PA30") '第5申請人
      'Added by Lydia 2019/09/03
      m_PA150 = "" & rsA.Fields("PA150")
      'Added by Lydia 2020/02/27
      m_PA174 = "" & rsA.Fields("PA174")
      m_PA178 = "" & rsA.Fields("PA178") 'Added by Morgan 2023/2/9
   End If
   If rsA.State <> adStateClosed Then rsA.Close
   
   'Added by Lydia 2019/03/04 通知函承辦單備註設定
   'Modified by Lydia 2019/03/08 逐筆判斷Y代理人+X申請人1~5
   'bolGetSpec = PUB_GetFcpEMPBillSpec(m_strPA01 & m_strPA02 & m_strPA03 & m_strPA04, m_strRptKind, m_PA75, m_PA26, , gMemo, gSpeed, gMain, gAppend, gOther)
   'Modify By Sindy 2021/3/30 + gReport
   bolGetSpec = PUB_GetFcpEMPBillSpec(m_strPA01 & m_strPA02 & m_strPA03 & m_strPA04, m_strRptKind, m_PA75, m_PA26 & "," & m_PA27 & "," & m_PA28 & "," & m_PA29 & "," & m_PA30, , gMemo, gSpeed, gMain, gAppend, gOther, , , gReport)
   
   '進度檔資料
   If m_strCP09 <> "" Then
      'Modified by Lydia 2019/01/04 +CP152
      'Modified by Lydia 2023/05/02 +CP84
      strSql = "Select CP64,CP152,CP84" & _
                " From caseprogress Where CP09='" & m_strCP09 & "'"
      rsA.CursorLocation = adUseClient
      rsA.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      If rsA.RecordCount > 0 Then
         m_CP64 = "" & rsA.Fields("CP64")
         m_CP152 = "" & rsA.Fields("CP152")
         m_CP84 = "" & rsA.Fields("CP84") 'Added by Lydia 2023/05/02
      End If
      If rsA.State <> adStateClosed Then rsA.Close
   End If
   
   If m_CP14 = "" Then
      oStrA14 = PUB_GetST07(strUserNum)
   Else
      oStrA14 = PUB_GetST07(m_CP14)
   End If
      
   '********** 共同的欄位值 **********
   '受文者
   strGetPaper = m_FCNa03 & " 代理人" '受文者:國家+代理人
   '08.繳年費通知函 10.年證費請款函 13.專利權消滅 / 年費逾期(m_strMemo = "2")
   'Modified by Lydia 2019/03/04 更換類別代號; 專利權消滅 / 年費逾期已不列印承辦單
   'If m_strRptKind = "08" Or m_strRptKind = "10" Or _
      (m_strRptKind = "13" And m_strMemo = "2") Then
   'Memo by Lydia 2019/10/18  "04-繳年費通知承辦單" 和
   If m_strRptKind = "04" Or m_strRptKind = "06" Then
      If m_PA76 <> "" Then
         strGetPaper = "年費代理人（" & m_PA76 & "）"
      End If
   End If
   strOther = "其他：" '其他
   
   '速別
   'Modified by Lydia 2021/01/19 改成模組；因為有部份性質改成email
'   If m_eMail = "E" Then 'E+寄
'      If m_FCna01 = "011" Then '日本
'         'Modified by Lydia 2020/02/21
'         'strSpeed = "Email+限時"
'         strSpeed = "Email+平信"
'      ElseIf m_FCna01 = "101" Then '美國
'         strSpeed = "Email+掛號"
'      Else
'         strSpeed = "Email+平信"
'      End If
'   ElseIf m_eMail = "e" Then 'E化
'      strSpeed = "Email"
'   Else '非E化
'      If m_FCna01 = "011" Then '日本
'         'Modified by Lydia 2020/02/21
'         'strSpeed = "限時"
'         strSpeed = "掛號"
'      ElseIf m_FCna01 = "101" Then '美國
'         strSpeed = "掛號"
'      Else
'         strSpeed = "平信"
'      End If
'   End If
   strSpeed = GetFCPEmpSpeed(m_eMail, m_FCna01)
   'end 2021/01/19
   '********** END **********
   
   '核准函
   'Modified by Lydia 2019/03/04 更換類別代號;04=>01
   'Memo by Lydia 2019/10/18 承辦單類別："01-核准函 => 告准承辦單"
   If m_strRptKind = "01" Then
      '速別
      If m_eMail = "E" Then 'E+寄
         If m_FCna01 = "101" Then '美國
            strSpeed = "Email+掛號"
         Else
            'Modified by Lydia 2020/02/21
            'strSpeed = "Email+限時"
            strSpeed = "Email+平信"
         End If
      ElseIf m_eMail = "e" Then 'E化
         strSpeed = "Email"
      Else '非E化
         If m_FCna01 = "101" Then '美國
            strSpeed = "Fax+掛號"
         Else
            'Modified by Lydia 2020/02/21
            'strSpeed = "Fax+限時"
            strSpeed = "Fax+平信"
         End If
      End If
      'Modify By Sindy 2017/6/16 詠心要預設的
      'Remove by Lydia 2019/03/04 改為:通知函承辦單備註設定
      'Select Case "" & m_PA75
      '   Case "Y45149000", "Y34210030", "Y27766000", "Y45204000", "Y48292030", "Y51304020"
      '      strSpeed = "上傳"
      'End Select
      '2017/6/16 END
      'end 2019/03/04
      
      strMainText = "告准、告可領證" '主旨
      strAppend = "核准函及譯文" '附件
      '備註
      If Trim(m_CP64) <> "" And InStr(m_CP64, "承辦單備註:") > 0 Then
         LenStar = InStr(m_CP64, "承辦單備註:") + Len("承辦單備註:")
         'Add By Sindy 2019/1/8
         If InStr(LenStar, m_CP64, "|") = 0 Then
            strNote = Mid(m_CP64, LenStar)
         Else
         '2019/1/8 END
            strNote = Mid(m_CP64, LenStar, InStr(LenStar, m_CP64, "|") - 1 - Len("承辦單備註:"))
         End If
      End If
      strOther = "發文：信已另發文，卷退□承辦　　　　　收文領證|" & _
                 "　　　　　　　　　　　□程序　　　　　更正核准函|" & _
                 "　　　　　　　　　　　□工程師第一次核對|" & _
                 "　　　工程師第一次核對後卷退檔" '其他
      'Added by Lydia 2019/03/04 通知函承辦單備註設定
      If bolGetSpec = True Then
          '備註: 在輸入核准時,會寫預設備註在B類收文的進度備註=>不變更
          'Added by Lydia 2020/02/10 將告准承辦單的備註內容列印在核准函輸入備註內容之下，若有 "可登錄專利連結"的備註列印在最下方 by敏莉
          If gMemo <> "" Then strNote = strNote & IIf(strNote <> "", vbCrLf, "") & gMemo & vbCrLf
          
          '速別
          If gSpeed <> "" Then strSpeed = gSpeed
          '主旨
          If gMain <> "" Then strMainText = gMain
          '附件
          If gAppend <> "" Then strAppend = gAppend
          '其他
          If gOther <> "" Then strOther = gOther
      End If
      'end 2019/03/04
      
      'Added by Lydia 2020/02/27 名稱有特殊字
      If m_PA174 <> "" Then
          strNote = strNote & vbCrLf & "■有特殊字"
      End If
      
      'Added by Lydia 2019/09/03 專利連結管控(藥品專利連結告代):化學組固定於通知告准承辦單備註新增
      'Memo by Lydia 2020/02/27 專利連結管控放在最後
      If m_PA150 = "2" Then
         strNote = strNote & vbCrLf & "□可登錄專利連結"
      End If
      
   '公告公報
   'Modified by Lydia 2019/03/04 更換類別代號;05=>02
   'Memo by Lydia 2019/10/18 承辦單類別："02-公告公報 => 公告公報承辦單"
   ElseIf m_strRptKind = "02" Then
      strMainText = "寄公報" '主旨
      strAppend = "公報二份" '附件
      '速別
      If m_eMail = "E" Then 'E+寄
         strSpeed = "Email+郵寄"
      ElseIf m_eMail = "e" Then 'E化
         strSpeed = "Email"
      Else '非E化
         strSpeed = "郵寄"
      End If
      '備註
      If Trim(m_strMemo) = "" Then
         strNote = "和二次核對同一信封"
      ElseIf Trim(m_strMemo) = "e" Then
         'Modified by Lydia 2020/01/07 已上傳到卷宗區fcp-workflow => 卷宗區
         strNote = "和二次核對一起E" & vbCrLf & _
                   "電子檔已存於卷宗區"
         strAppend = "公報一份" '附件
      ElseIf Trim(m_strMemo) = "E" Then
         'Modified by Lydia 2020/01/07 已上傳到卷宗區fcp-workflow => 卷宗區
         strNote = "和二次核對一起E及郵寄" & vbCrLf & _
                   "電子檔已存於卷宗區"
      ElseIf Trim(m_strMemo) = "◎" Then
         strNote = "和證書同一信封"
      ElseIf InStr(Trim(m_strMemo), "◎") > 0 Then
         If InStr(Trim(m_strMemo), "e") > 0 Then
            'Modified by Lydia 2020/01/07 已上傳到卷宗區fcp-workflow => 卷宗區
            strNote = "和證書一起E" & vbCrLf & _
                      "電子檔已存於卷宗區"
            strAppend = "公報一份" '附件
         ElseIf InStr(Trim(m_strMemo), "E") > 0 Then
            'Modified by Lydia 2020/01/07 已上傳到卷宗區fcp-workflow => 卷宗區
            strNote = "和證書一起E及郵寄" & vbCrLf & _
                      "電子檔已存於卷宗區"
         End If
      End If
      
      'Added by Lydia 2018/09/27　特殊備註和速別
      'Remove by Lydia 2019/03/04 改為:通知函承辦單備註設定
'      If "" & m_PA75 <> "" And InStr("Y34210000,Y34210010,Y34210000,Y34210020,Y34210030", m_PA75) > 0 Then
'            strSpeed = "特殊(上傳+DHL)"
'            strNote = "和證書一併上傳+郵寄，" & vbCrLf & _
'                           "※公報須另外掃描(請選擇彩色掃描功能)，不可直接使用下載的版本" & vbCrLf & _
'                           "電子檔已存於fcp-workflow"
'      End If
'      'end 2018/09/27
'      'Added by Lydia 2019/01/04 已與Sharon確認Y45149000基本都是系統上傳,只有證書函需要紙本郵寄=>特殊(上傳+DHL)
'      If m_PA75 = "Y45149000" Then
'            strSpeed = "上傳"
'            strAppend = "公報一份" '附件
'            strNote = "和證書一起上傳系統" & vbCrLf & _
'                           "電子檔已存於fcp-workflow"
'      End If
'      'end 2019/01/04
'      'Added by Lydia 2019/02/27
'      If m_PA75 = "Y51333010" Then
'           strSpeed = "特殊(E+限掛)"
'      End If
'      If "" & m_PA75 <> "" And InStr("Y51333010,Y55054000", m_PA75) > 0 Then
'            strNote = "和證書一起E+寄(中文定稿:公報定稿合併於證書定稿中)" & vbCrLf & _
'                           "電子檔已存於fcp-workflow"
'      End If
'      'end 2019/02/27
      'end 2019/03/04
      'Added by Lydia 2019/03/04 通知函承辦單備註設定
      If bolGetSpec = True Then
          '備註
          If gMemo <> "" Then strNote = gMemo
          '速別
          If gSpeed <> "" Then strSpeed = gSpeed
          '主旨
          If gMain <> "" Then strMainText = gMain
          '附件
          If gAppend <> "" Then strAppend = gAppend
          '其他
          If gOther <> "" Then strOther = gOther
      End If
      'end 2019/03/04
      
   '證書函
   'Modified by Lydia 2019/03/04 更換類別代號;07=>03
   'Memo by Lydia 2019/10/18 承辦單類別："03-證書函 => 寄證書承辦單"
   ElseIf m_strRptKind = "03" Then
      '速別
      'Modify By Sindy 2015/11/18
'      If m_eMail = "E" Or m_eMail = "e" Then 'E+寄
'         If m_FCna01 = "011" Then '日本
'            strSpeed = "Email+限時掛號"
'         Else
'            strSpeed = "Email+掛號"
'         End If
''      ElseIf m_eMail = "e" Then 'E化
''         strSpeed = "Email"
'      Else '非E化
'         If m_FCna01 = "011" Then '日本
'            strSpeed = "Fax+限時掛號"
'         Else
'            strSpeed = "Fax+掛號"
'         End If
'      End If
      'Modify By Sindy 2016/10/28
'      If m_FCna01 = "101" Then '美國
'         strSpeed = "掛號"
'      Else
'         strSpeed = "限時掛號"
'      End If
      '2015/11/18 END
      
      If m_eMail = "E" Or m_eMail = "e" Then 'E+寄
         If m_FCna01 = "101" Then '美國
            strSpeed = "E+掛號"
         Else
            'Modified by Lydia 2020/02/21
            'strSpeed = "E+限時掛號"
            strSpeed = "E+掛號"
         End If
      Else '非E化
         If m_FCna01 = "101" Then '美國
            strSpeed = "Fax+掛號"
         Else
            'Modified by Lydia 2020/02/21
            'strSpeed = "Fax+限時掛號"
            strSpeed = "Fax+掛號"
         End If
      End If
      '2016/10/28 END
      
      If m_PA178 = "1" Then strSpeed = "E-Mail 或上傳(電子證書，不寄紙本)"  'Added by Morgan 2023/2/9 電子證書速別預設
      
      'add by sonia 2015/11/30 特殊客戶要產生電子檔,速別"特殊",此處修改名單則frm060317_1的QueryLetterData也要修改
      'Modify By Sindy 2015/12/2
      'Remove by Lydia 2019/03/04 改為:通知函承辦單備註設定
'      Select Case "" & m_PA75
'         'Modify By Sindy 2016/9/26 + Y54047000
'         'Modify By Sindy 2017/8/30 + Y54747000
'         Case "Y48292030", "Y52075000", "Y54047000", "Y54747000"
'            strSpeed = "特殊(不寄)"
'         Case "Y27766000", "Y51774000", "Y45204000"
'            strSpeed = "特殊(限掛)"
'         'Modify By Sindy 2016/3/3 +Y20078000
'         'Case "Y34210000", "Y34210020", "Y34210030", "Y45149000", "Y20078000"
'         'Modified by Lydia 2018/09/27
'         'Case "Y34210020", "Y45149000", "Y20078000"
'         Case "Y45149000", "Y20078000"
'            strSpeed = "特殊(DHL)"
'         'Modify By Sindy 2017/9/15
'         'Modified by Lydia 2018/09/27
'         'Case "Y34210000", "Y34210030"
'         Case "Y34210000", "Y34210010", "Y34210000", "Y34210020", "Y34210030"
'            strSpeed = "特殊(上傳+DHL)"
'         'Add By Sindy 2016/7/13 +Y47453000
'         Case "Y47453000"
'            strSpeed = "特殊(E+DHL)"
'         'Add By Sindy 2016/2/24 Y51742000調整內容
'         Case "Y51742000"
'            strSpeed = "特殊(不用EMail,只要寄DHL)"
'         '2016/2/24 END
'         'Modify By Sindy 2017/10/6 + Y48651000
'         Case "Y48651000"
'            strSpeed = "特殊(FAX+DHL)"
'         'Modify By Sindy 2016/1/20 +Y34310000
'         'Modify By Sindy 2016/1/25 +Y20064000
'         'Modify By Sindy 2016/2/3  +Y34271000, Y51817040
'         'Modify By Sindy 2016/3/17 +Y20876010
'         'Modify By Sindy 2016/3/23 +Y54391000
'         'Modify By Sindy 2016/3/29 +Y20624000
'         'Modify By Sindy 2016/3/29 +Y52989000
'         'Modify By Sindy 2016/5/5  +Y47032000
'         'Modify By Sindy 2016/6/15 +Y51333010
'         Case "Y34310000", "Y20064000", "Y34271000", "Y51817040", "Y20876010", _
'              "Y54391000", "Y20624000", "Y52989000", "Y47032000", "Y51333010"
'            strSpeed = "特殊(E+限掛)"
'         'Add By Sindy 2016/2/24 +Y47168000
'         Case "Y47168000"
'            strSpeed = "特殊(傳真+E+限掛)"
'         'Modify By Sindy 2016/6/15 +Y51982000
'         'Modify By Sindy 2016/9/21 +Y52643000
'         Case "Y51982000", "Y52643000"
'            strSpeed = "特殊(E+掛號)"
'         '2016/6/15 END
'      End Select
'      Select Case "" & Left(m_PA26, 8)
'         Case "X3429100"
'            strSpeed = "特殊(不寄)"
'      End Select
'      'end 2015/11/30
'      'Add By Sindy 2016/9/2
'      If "" & m_PA75 = "Y34232000" And "" & Left(m_PA26, 8) = "X4863700" Then
'         strSpeed = "特殊(E+限掛)"
'      'Modify By Sindy 2017/10/6 + Y48651000 + X4863700
'      ElseIf "" & m_PA75 = "Y48651000" And "" & Left(m_PA26, 8) = "X4863700" Then
'         strSpeed = "特殊(Email(加密)+DHL)"
'      End If
      'end 2019/03/04
      
      strMainText = "寄證書" '主旨
      '附件
      strAppend = "■證書正本、譯文、期限表"
      
      '檢查有無核對已准專利
      strSql = "Select CP09 From caseprogress" & _
                " Where CP01='" & m_strPA01 & "' and CP02='" & m_strPA02 & "' and CP03='" & m_strPA03 & "' and CP04='" & m_strPA04 & "'" & _
                " and CP10='926' and cp57 is null"
      rsA.CursorLocation = adUseClient
      rsA.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      '若無核對已准專利收文時,公報自動勾選
      'Modify By Sindy 2016/2/19 Y45149 代理人要求寄證書時一併寄公報 + Or m_PA75 = "Y45149000"
      'Modify By Sindy 2016/6/15 + Y51982000 代理人要求寄證書時一併寄公報
      'Modify By Sindy 2017/9/15 Y34210000 或 Y34210030 代理人要求寄證書時一併寄公報
      'Modified by Lydia 2018/09/27 +Y34210010,Y34210020
      'Modify By Sindy 2021/3/9 要優先寄專利證書+公告公報，後寄二核報告信+帳單
      '  Y33801 (SNELL & WILMER (PHOENIX OFFICE)) + X68646 (ASM IP Holding B.V.)
      '  Y33801B2 (Snell & Wilmer L.L.P. (Los Angeles Office))+ X68646 (ASM IP Holding B.V.)
      '  Y33801 (SNELL & WILMER (PHOENIX OFFICE)) + X47178 (ASM AMERICA, INC.)
      '  Y33801B2 (Snell & Wilmer L.L.P. (Los Angeles Office))+X47178 (ASM AMERICA, INC.)
      'Modify By Sindy 2021/3/30 + Or gReport = "Y"
'      If rsA.RecordCount = 0 Or _
'         (m_PA75 = "Y45149000" Or m_PA75 = "Y51982000" Or _
'          m_PA75 = "Y34210000" Or m_PA75 = "Y34210030" Or m_PA75 = "Y34210010" Or m_PA75 = "Y34210020") Or _
'         (m_PA75 = "Y33801000" And Left(m_PA26, 8) = "X6864600") Or _
'         (m_PA75 = "Y33801B20" And Left(m_PA26, 8) = "X6864600") Or _
'         (m_PA75 = "Y33801000" And Left(m_PA26, 8) = "X4717800") Or _
'         (m_PA75 = "Y33801B20" And Left(m_PA26, 8) = "X4717800")
      If rsA.RecordCount = 0 Or gReport = "Y" Then
         strAppend = strAppend & " ■公報" & vbCrLf
      Else
         strAppend = strAppend & " □公報" & vbCrLf
      End If
      If rsA.State <> adStateClosed Then rsA.Close
      
      '判斷IPC為A61K及A01N時自動勾選
      If m_PA160 = "A01N" Or m_PA160 = "A61K" Then
         strAppend = strAppend & "■Tai E Note"
      Else
         strAppend = strAppend & "□Tai E Note"
      End If
      '其他
      'Modified by Lydia 2016/08/15 有設定寄證書後不續辦之案件,代出FCP承辦業務
      'strOther = "發文後，卷退□承辦　　　　　填不續單連絡單" & vbCrLf & _
                 "　　　　　　□程序　　　　　更正證書" & vbCrLf & _
                 "　　　　　　□檔案室"
      'Memo by Lydia 2019/08/08 若有設定自動不續辦,改備註
      strExc(0) = ""
      If PUB_ChkPA70kind(m_strPA01, m_strPA02, m_strPA03, m_strPA04, "N") Then
          strExc(0) = PUB_StrToStr(GetStaffName(PUB_GetFCPSalesNo(m_strPA01, m_strPA02, m_strPA03, m_strPA04)), 8, True)
      Else
          strExc(0) = "　　　　"
      End If
            
      'Added by Lydia 2019/03/04 預設抓進度備註的內容=>備註
      'Mark by Lydia 2023/02/22 直接抓當時的承辦單設定
      'If Trim(m_CP64) <> "" And InStr(m_CP64, "承辦單備註:") > 0 Then
      '   LenStar = InStr(m_CP64, "承辦單備註:") + Len("承辦單備註:")
      '   If InStr(LenStar, m_CP64, "|") = 0 Then
      '      strNote = Mid(m_CP64, LenStar)
      '   Else
      '      strNote = Mid(m_CP64, LenStar, InStr(LenStar, m_CP64, "|") - 1 - Len("承辦單備註:"))
      '   End If
      'End If
      ''end 2019/03/04
      
      'Added by Lydia 2019/08/08 因為系動自動上不續,改顯示
      If Trim(strExc(0)) <> "" Then
          strOther = "發文後，卷退■系統自動於次月1日上年費不續辦"
      Else
      'end 2019/08/08
          strOther = "發文後，卷退□承辦　" & strExc(0) & "填不續辦連絡單"
      End If
      
      strOther = strOther & vbCrLf & _
                 "　　　　　　□程序　　　　　更正證書" & vbCrLf & _
                 "　　　　　　□檔案室"
      
      'Added by Lydia 2019/03/04 通知函承辦單備註設定
      If bolGetSpec = True Then
          '備註: 在輸入證書號數時,會寫預設備註在進度備註=>不變更(Memo by Lydia 2023/02/22 前面進度備註已取消
          'Added by Lydia 2023/02/22 請取消key證書來函時將備註回寫到進度檔之設定，在對外通知函\證書函則直接抓當時的承辦單設定
          If gMemo <> "" Then strNote = strNote & IIf(strNote <> "", vbCrLf, "") & gMemo & vbCrLf
          
          '速別
          If gSpeed <> "" Then
               strSpeed = gSpeed
               If m_PA178 = "1" Then strSpeed = strSpeed & "(電子證書，不寄紙本)" 'Added by Morgan 2023/2/9 電子證書速別加文字
          End If
          '主旨
          If gMain <> "" Then strMainText = gMain
          '附件
          If gAppend <> "" Then strAppend = gAppend
          '其他
          If gOther <> "" Then strOther = gOther
      End If
      'end 2019/03/04
      
      'Added by Lydia 2020/02/27 名稱有特殊字
      If m_PA174 <> "" Then
          strNote = strNote & vbCrLf & "■有特殊字"
      End If
            
   '繳年費通知函
   'Modified by Morgan 2017/11/1 +"09"
   'ElseIf m_strRptKind = "08" Then
   'Modified by Lydia 2019/03/04 更換類別代號;08=>04, 09=>05
   
   'Memo by Lydia 2019/10/18 承辦單類別："04-繳年費通知函 => (2019/03/05) 年費請款承辦單 => (2019/10/18) 繳年費通知承辦單"
                                                                '  "05-一般發文-實審416實體審查請款函 => 實審請款承辦單"
   ElseIf m_strRptKind = "04" Or m_strRptKind = "05" Then
      If m_strCP10 = 實體審查 Then '416.實體審查
         'Added by Lydia 2020/02/26 實審請款: 平信改掛號 --因為2020/02/21郵局業務調整
         If strSpeed <> "" Then strSpeed = Replace(strSpeed, "平信", "掛號")
         
         If IsNumeric(m_strNP09) = False And m_strNP09 <> "" Then
            strMainText = m_strNP09 '實體審查請款
            'Add By Sindy 2017/3/30
            strAppend = "申請書、D/N、收據"
            strOther = "退檔案室"
            '2017/3/30 END
         Else
            strMainText = "催實體審查  (" & ChangeWStringToTDateString(m_strNP09) & ")" '主旨
         End If
         'Added by Lydia 2019/01/04 有扣款日期，加註「收據下載日期」。
         If m_CP152 <> "" Then
              'Modified by Lydia 2023/05/02 +規費金額
              strNote = "收據下載日期：" & ChangeTStringToTDateString(TransDate(m_CP152, 1)) & IIf(Val(m_CP84) > 0, "，規費金額：NTD " & m_CP84, "") & vbCrLf
         End If
         'end 2019/01/04
      Else
         ArrStr = Split(m_strMemo, ";")
         If UBound(ArrStr) >= 0 Then
            strYear = ArrStr(0)
            strNP15 = ArrStr(1)
         End If
         '下一程序備註有出現傳真或FAX
         If Trim(strNP15) <> "" And (InStr(strNP15, "傳真") > 0 Or InStr(UCase(strNP15), UCase("fax")) > 0) Then
            If InStr(strSpeed, "Email") = 0 Then
               strSpeed = "Fax+" & strSpeed
            End If
         End If
         strMainText = "催繳第" & strYear & "年年費  (" & ChangeWStringToTDateString(m_strNP09) & ")" '主旨
         strControlEmp = m_FCNa16 '管制人員
      End If
      
      'Added by Lydia 2019/03/04 通知函承辦單備註設定
      If bolGetSpec = True Then
          '備註
          If gMemo <> "" Then
              If strNote <> "" And InStr(strNote, "收據下載日期：") > 0 Then '有扣款日期，加註「收據下載日期」。
                 strNote = strNote & gMemo
              Else
                 strNote = gMemo
              End If
          End If
          '速別
          If gSpeed <> "" Then strSpeed = gSpeed
          '主旨
          If gMain <> "" Then strMainText = gMain
          '附件
          If gAppend <> "" Then strAppend = gAppend
          '其他
          If gOther <> "" Then strOther = gOther
      End If
      'end 2019/03/04
      'Added by Lydia 2020/07/09 實審發文：輸入已收款，於承辦單加上備註(最前面)
      If m_strCP10 = 實體審查 And m_OptMemo <> "" Then
          strNote = m_OptMemo & vbCrLf & strNote
      End If
      
   '年證費請款函 m_strMemo=1.領證及繳年費 2.年費
   'Modified by Lydia 2019/03/04 更換類別代號;10=>06
   'Memo by Lydia 2019/10/18 承辦單類別："06-年證費請款函 => 年證費請款承辦單"
   ElseIf m_strRptKind = "06" Then
      'Add By Sindy 2017/2/13 代理人為德國區案件以掛號寄出
      If m_FCna01 = "231" Then '德國
         If m_eMail = "E" Then 'E+寄
            strSpeed = "Email+掛號"
         ElseIf m_eMail = "e" Then 'E化
            strSpeed = "Email"
         Else '非E化
            strSpeed = "掛號"
         End If
      End If
      '2017/2/13 END
      
      'Added by Lydia 2020/02/26 年證費請款: 平信改掛號 --因為2020/02/21郵局業務調整
      If strSpeed <> "" Then strSpeed = Replace(strSpeed, "平信", "掛號")
      
      '主旨
      If Trim(m_strMemo) = "1" Then
         strMainText = "領證請款"
      Else
         strMainText = "年費請款"
      End If
      strAppend = "請款信、DN、收據" '附件
      '備註
      strNote = "※與FCP　　　　　　同一信封（　　　件同一信封）"
      If m_eMail = "E" Then
         strNote = strNote & vbCrLf & vbCrLf & "1.承辦Email　2.判發　3.發文　4.退檔"
      ElseIf m_eMail = "e" Then
         strNote = strNote & vbCrLf & vbCrLf & "1.承辦Email　2.判發　3.退檔"
      Else
         strNote = strNote & vbCrLf & vbCrLf & "1.判發　2.發文　3.退檔"
      End If
      'Added by Lydia 2019/10/15 有扣款日期，加註「收據下載日期」。
      If m_CP152 <> "" Then
           'Modified by Lydia 2023/05/02 +規費金額
           strNote = strNote & vbCrLf & vbCrLf & "收據下載日期：" & ChangeTStringToTDateString(TransDate(m_CP152, 1)) & IIf(Val(m_CP84) > 0, "，規費金額：NTD " & m_CP84, "") & vbCrLf
      End If
      'end 2019/10/15
      
      '管制人員
      strControlEmp = m_FCPEmp
      If m_eMail = "E" Or m_eMail = "e" Then
         strControlEmp = strControlEmp & vbCrLf & "(座位)"
      Else
         strControlEmp = strControlEmp & vbCrLf & "(請款櫃)"
      End If
      'Added by Lydia 2019/03/04 通知函承辦單備註設定
      If bolGetSpec = True Then
          '備註
          If gMemo <> "" Then strNote = gMemo
          '速別
          If gSpeed <> "" Then strSpeed = gSpeed
          '主旨
          If gMain <> "" Then strMainText = gMain
          '附件
          If gAppend <> "" Then strAppend = gAppend
          '其他
          If gOther <> "" Then strOther = gOther
      End If
      'end 2019/03/04
      
   '13.專利權消滅 / 年費逾期
   'Remove by Lydia 2019/03/04 專利權消滅 、 年費逾期、公開公報已不列印承辦單
'   ElseIf m_strRptKind = "13" Then
'      '速別
'      If m_eMail = "E" Then 'E+寄
'         If m_FCna01 = "011" Then '日本
'            strSpeed = "Email+限時"
'         Else
'            strSpeed = "Email+平信"
'         End If
'      ElseIf m_eMail = "e" Then 'E化
'         strSpeed = "Email"
'      Else '非E化
'         If m_FCna01 = "011" Then '日本
'            strSpeed = "限時"
'         Else
'            strSpeed = "平信"
'         End If
'      End If
'      '管制人員
'      strControlEmp = "江如玉"
'      If m_strMemo = "1" Then '專利權消滅
'         '主旨
'         If Val(m_PA25) <= Val(strSrvDate(1)) Then '專用期間(止)
'            strMainText = "通知專利權期滿"
'         Else
'            strMainText = "通知專利權消滅"
'         End If
'      Else '2.年費逾期
'         '主旨
'         strMainText = "通知年費逾期補繳期限"
'      End If
'      '備註
'      'Y45149000.Nikon
'      'Y27766000.MURATA
'      If m_PA75 = "Y45149000" Or m_PA75 = "Y27766000" Then
'         strSpeed = "上傳"
'         strNote = "1.上傳系統　2.判發　3.留底信退" & strControlEmp
'      ElseIf m_eMail = "e" Then 'E化
'         strNote = "1.判發　2.留底信退" & strControlEmp
'      Else
'         strNote = "1.判發　2.信另外發文　3.留底信退" & strControlEmp
'      End If
'      If m_strMemo = "2" Then '2.年費逾期
'         If Val(m_strPA02) <= 28500 Then
'            If m_eMail = "e" Then 'E化
'               strNote = strNote & "　3.卷請退劉經理"
'            Else
'               strNote = strNote & "　4.卷請退劉經理"
'            End If
'         Else
'            If m_eMail = "e" Then 'E化
'               strNote = strNote & "　3.卷退檔"
'            Else
'               strNote = strNote & "　4.卷退檔"
'            End If
'         End If
'      End If
'
'   '公開公報
'   ElseIf m_strRptKind = "14" Then
'      strMainText = "寄公開公報" & "（" & Mid(m_PA12, 5, 2) & "/" & Right(m_PA12, 2) & "）|退檔案室" '主旨
'      strAppend = "公開公報" '附件
   'end 2019/03/04
   End If
   
   'Added by Lydia 2020/02/06 亭妙反應:實審發文自動產生帳單,有時候承辦單變成橫印
   '參考frm090801: 故意設定紙張屬性以便清除印表機狀態(相同印表機驅動程式會沿用原設定值,Ex.進紙槽)
   Printer.PaperSize = 9
   Printer.EndDoc
   Printer.Orientation = 1
   'end 2020/02/06
   
   '畫線 *****************************
   '裝訂線
   Printer.DrawStyle = 2
   Printer.Line (500, 0)-(500, 6300)
   Printer.Line (500, 6300 + Printer.TextHeight("裝"))-(500, 7400)
   Printer.Line (500, 7400 + Printer.TextHeight("訂"))-(500, 8600)
   Printer.Line (500, 8600 + Printer.TextHeight("線"))-(500, 17000)
   '打字
   Printer.CurrentX = 500 - (Printer.TextWidth("裝") / 2)
   Printer.CurrentY = 6300
   Printer.Print "裝"
   Printer.CurrentX = 500 - (Printer.TextWidth("訂") / 2)
   Printer.CurrentY = 7400
   Printer.Print "訂"
   Printer.CurrentX = 500 - (Printer.TextWidth("線") / 2)
   Printer.CurrentY = 8600
   Printer.Print "線"
   Printer.DrawStyle = 0
   
   '寄送方式：方格
   'object.Line [Step] (x1, y1) [Step] - (x2, y2), [color], [B][F]
'   Printer.Line (8800, 350)-(10000, 650), , B: Printer.Line (10000, 350)-(11200, 650), , B
'   Printer.Line (8800, 650)-(10000, 950), , B: Printer.Line (10000, 650)-(11200, 950), , B
'   Printer.Line (8800, 1050)-(10000, 1350), , B: Printer.Line (10000, 1050)-(11200, 1350), , B
'   Printer.Line (8800, 1350)-(10000, 1650), , B: Printer.Line (10000, 1350)-(11200, 1650), , B
   '粗線
   For i = 1 To DrawCount
      Printer.Line (1000 + i, 5 * intFixedHigh + i)-(11200 + i, 40 * intFixedHigh + i), , B '最外框
   Next i
   '方格
   Printer.Line (1000, 5 * intFixedHigh)-(11200, 6 * intFixedHigh), , B    '速別
   Printer.Line (1000, 6 * intFixedHigh)-(11200, 7 * intFixedHigh), , B     '發文
   Printer.Line (1000, 7 * intFixedHigh)-(11200, 9 * intFixedHigh), , B     '受文者
   Printer.Line (1000, 9 * intFixedHigh)-(11200, 11 * intFixedHigh), , B     '副本收受者
   Printer.Line (1000, 11 * intFixedHigh)-(11200, 13 * intFixedHigh), , B     '主旨
   'Added by Lydia 2019/10/01 年證費請款函改格式
   If m_strRptKind = "06" Then
        Printer.Line (1000, 13 * intFixedHigh)-(11200, 15 * intFixedHigh), , B     '附件，管制人員
        Printer.Line (1000, 15 * intFixedHigh)-(11200, 16 * intFixedHigh), , B     '判行，核稿，監印，承辦
        Printer.Line (1000, 16 * intFixedHigh)-(11200, 22 * intFixedHigh), , B
   Else
   'end 2019/10/01
        Printer.Line (1000, 13 * intFixedHigh)-(11200, 15 * intFixedHigh), , B     '附件，管制人員
        Printer.Line (1000, 15 * intFixedHigh)-(11200, 16 * intFixedHigh), , B     '判行，核稿，監印，承辦
        Printer.Line (1000, 16 * intFixedHigh)-(11200, 22 * intFixedHigh), , B
   End If
   Printer.Line (1000, 22 * intFixedHigh)-(11200, 23 * intFixedHigh), , B     '備註
   Printer.Line (1000, 23 * intFixedHigh)-(11200, 36 * intFixedHigh), , B
   Printer.Line (1000, 36 * intFixedHigh)-(11200, 40 * intFixedHigh), , B     '其他
   Printer.Line (7800, 7 * intFixedHigh)-(11200, 8 * intFixedHigh), , B     '本所案號
   Printer.Line (7800, 11 * intFixedHigh)-(11200, 10 * intFixedHigh), , B     '本所期限
   '直線
   Printer.Line (2200, 5 * intFixedHigh)-(2200, 15 * intFixedHigh)     '小標題
   Printer.Line (7800, 7 * intFixedHigh)-(7800, 11 * intFixedHigh)     '本所案號
   Printer.Line (9000, 7 * intFixedHigh)-(9000, 11 * intFixedHigh)
   'Added by Lydia 2019/10/01 "06-年證費請款函"改格式
   If m_strRptKind = "06" Then
        Printer.Line (5200, 13 * intFixedHigh)-(5200, 22 * intFixedHigh)     '判行,核稿
        Printer.Line (9000, 13 * intFixedHigh)-(9000, 22 * intFixedHigh)     '管制人員,承辦
   Else
   'end 2019/10/01
        Printer.Line (7800, 13 * intFixedHigh)-(7800, 22 * intFixedHigh)     '管制人員
        Printer.Line (9000, 13 * intFixedHigh)-(9000, 22 * intFixedHigh)
        Printer.Line (4500, 15 * intFixedHigh)-(4500, 22 * intFixedHigh)     '判行,核稿
   End If
   
   '畫線結束 ***************************
   
   '抬頭
'   If IsHaveTaieLogo = True Then
'      Printer.PaintPicture pic1.Picture, 2710 + ((DrawLeftMove - DrawRightMove) / 2) + DrawLeftMove, 240, 600, 600
'   End If
   Printer.Font.Name = "標楷體"
   Printer.Font.Size = 22
   Printer.CurrentX = 3550
   Printer.CurrentY = 460
   'Modify By Sindy 2020/3/26
   'Printer.Print "台一國際專利法律事務所"
   Printer.Print CompNameQuery("2")
   '2020/3/26 END
   Printer.CurrentX = 4880
   Printer.CurrentY = 1020
   Printer.Print "外專承辦單"
   Printer.Font.Size = 14
   PUB_PrintFontIntoBox "速別", 1000, 5 * intFixedHigh, 2200, 6 * intFixedHigh
   PUB_PrintFontIntoBox strSpeed, 2300, 5 * intFixedHigh, 11200, 6 * intFixedHigh, , False '速別
   PUB_PrintFontIntoBox "發文", 1000, 6 * intFixedHigh, 2200, 7 * intFixedHigh
   PUB_PrintFontIntoBox Val(Left(strSrvDate(1), 4)) - 1911 & " 年 " & Mid(strSrvDate(1), 5, 2) & " 月    日 晉" & IIf(Trim(oStrA14) = "", "    ", oStrA14) & "字第                號", 2300, 6 * intFixedHigh, 11200, 7 * intFixedHigh, , False
   PUB_PrintFontIntoBox "受文者", 1000, 7 * intFixedHigh, 2200, 9 * intFixedHigh
   PUB_PrintFontIntoBox strGetPaper, 2300, 7 * intFixedHigh, 7800, 9 * intFixedHigh, , False '受文者
   PUB_PrintFontIntoBox "副本|收受者", 1000, 9 * intFixedHigh, 2200, 11 * intFixedHigh
   PUB_PrintFontIntoBox "主旨", 1000, 11 * intFixedHigh, 2200, 13 * intFixedHigh
   PUB_PrintFontIntoBox strMainText, 2300, 11 * intFixedHigh, 11200, 13 * intFixedHigh, , False '主旨
   PUB_PrintFontIntoBox "附件", 1000, 13 * intFixedHigh, 2200, 15 * intFixedHigh
   PUB_PrintFontIntoBox strAppend, 2300, 13 * intFixedHigh, 7800, 15 * intFixedHigh, , False '附件
   PUB_PrintFontIntoBox "本所案號", 7800, 7 * intFixedHigh, 9000, 8 * intFixedHigh
   PUB_PrintFontIntoBox m_strPA01 & "-" & m_strPA02 & "-" & m_strPA03 & "-" & m_strPA04, 9000, 7 * intFixedHigh, 11200, 8 * intFixedHigh
   PUB_PrintFontIntoBox "約定期限", 7800, 8 * intFixedHigh, 9000, 9 * intFixedHigh
   PUB_PrintFontIntoBox "    年    月    日", 9000, 8 * intFixedHigh, 11200, 9 * intFixedHigh
   PUB_PrintFontIntoBox "本所期限", 7800, 9 * intFixedHigh, 9000, 10 * intFixedHigh
   PUB_PrintFontIntoBox "    年    月    日", 9000, 9 * intFixedHigh, 11200, 10 * intFixedHigh
   PUB_PrintFontIntoBox "法定期限", 7800, 10 * intFixedHigh, 9000, 11 * intFixedHigh
   PUB_PrintFontIntoBox "    年    月    日", 9000, 10 * intFixedHigh, 11200, 11 * intFixedHigh
   'Added by Lydia 2019/10/01 "06-年證費請款函"改格式
   If m_strRptKind = "06" Then
        PUB_PrintFontIntoBox "判行", 1000, 15 * intFixedHigh, 5200, 16 * intFixedHigh
        PUB_PrintFontIntoBox "核稿(Email OK+SAVED)", 5200, 13 * intFixedHigh, 9000, 15 * intFixedHigh
        PUB_PrintFontIntoBox Replace(strControlEmp, vbCrLf, " "), 5200, 15 * intFixedHigh, 9000, 16 * intFixedHigh '管制人員=FCP承辦
        PUB_PrintFontIntoBox "程序人員", 9000, 13 * intFixedHigh, 11200, 15 * intFixedHigh
        PUB_PrintFontIntoBox m_FCNa16, 9000, 15 * intFixedHigh, 11200, 16 * intFixedHigh  'FCP程序人員
   Else
   'end 2019/10/01
        PUB_PrintFontIntoBox "管制人員", 7800, 13 * intFixedHigh, 9000, 15 * intFixedHigh
        PUB_PrintFontIntoBox strControlEmp, 9000, 13 * intFixedHigh, 10500, 15 * intFixedHigh '管制人員
        PUB_PrintFontIntoBox "判行", 1000, 15 * intFixedHigh, 4500, 16 * intFixedHigh
        'Add By Sindy 2017/10/24
        '繳年費通知函 and 416.實體審查 => (m_strRptKind = "08" And m_strCP10 = 實體審查)
        '或年證費請款函 m_strMemo=1.領證及繳年費 2.年費 => m_strRptKind = "10"
        'Modified by Morgan 2017/11/1
        'If (m_strRptKind = "08" And m_strCP10 = 實體審查) Or m_strRptKind = "10" Then
        'Modified by Lydia 2019/03/04 更換類別代號;09=>05,10=>06
        'Memo by Lydia 2019/10/18 承辦單類別："05-一般發文-實審416實體審查請款函 => 實審請款承辦單"
        If (m_strRptKind = "05" And m_strCP10 = 實體審查) Or m_strRptKind = "06" Then
        'end 2017/11/1
           PUB_PrintFontIntoBox "核稿(Email OK+SAVED)", 4500, 15 * intFixedHigh, 7800, 16 * intFixedHigh
        Else
        '2017/10/24 END
           PUB_PrintFontIntoBox "核稿", 4500, 15 * intFixedHigh, 7800, 16 * intFixedHigh
        End If
        PUB_PrintFontIntoBox "監印", 7800, 15 * intFixedHigh, 9000, 15 * intFixedHigh
        PUB_PrintFontIntoBox "承辦", 9000, 15 * intFixedHigh, 11200, 16 * intFixedHigh
   End If
   PUB_PrintFontIntoBox "備　　　　　註", 1000, 22 * intFixedHigh, 11200, 23 * intFixedHigh
   PUB_PrintFontIntoBox strNote, 1100, 23 * intFixedHigh, 11200, 36 * intFixedHigh, False, False '備註
   PUB_PrintFontIntoBox strOther, 1100, 36 * intFixedHigh, 11200, 40 * intFixedHigh, False, False '其他
   
   '印資料
   '寄送方式：方格
   'object.Line [Step] (x1, y1) [Step] - (x2, y2), [color], [B][F]
'   PUB_PrintFontIntoBox "Email", 8800, 350, 10000, 650: PUB_PrintFontIntoBox "FAX", 10000, 350, 11200, 650
'   PUB_PrintFontIntoBox "上傳", 8800, 650, 10000, 950: PUB_PrintFontIntoBox "限時雙掛號", 10000, 650, 11200, 950
'   PUB_PrintFontIntoBox "快遞", 8800, 1050, 10000, 1350: PUB_PrintFontIntoBox "平信", 10000, 1050, 11200, 1350
'   PUB_PrintFontIntoBox "限時", 8800, 1350, 10000, 1650: PUB_PrintFontIntoBox "掛號", 10000, 1350, 11200, 1650
   
   Set rsA = Nothing
   Printer.EndDoc
End Sub

'Add By Lydia 2016/8/18 檢查專利/代理人/申請人是否設定為寄證書後年費不續辦(N)
'Move by Lydia 2020/08/20 從basPublic移過來
Public Function PUB_ChkPA70kind(ByVal strCP01 As String, ByVal strCP02 As String, ByVal strCP03 As String, ByVal strCP04 As String, ByVal cType As String) As Boolean
Dim rsAD As New ADODB.Recordset
Dim StrStr As String

   PUB_ChkPA70kind = False
   
   'Modified by Lydia 2019/11/26 個案PA70=N寄證書後年費不續辦，改為PA156(FCP年費特殊管制)
   'strStr = "select pa70 from patent where pa70=" & CNULL(cType) & " and pa01='" & strCP01 & "' and pa02='" & strCP02 & "' and pa03='" & strCP03 & "' and pa04='" & strCP04 & "' " & _
            "union select fa41 from patent,fagent where fa41=" & CNULL(cType) & " and substr(pa75,1,8)=fa01(+) and substr(pa75,9,1)=fa02(+) and pa01='" & strCP01 & "' and pa02='" & strCP02 & "' and pa03='" & strCP03 & "' and pa04='" & strCP04 & "' " & _
            "union select cu74 from patent,customer where cu74=" & CNULL(cType) & " and substr(pa26,1,8)=cu01(+) and substr(pa26,9,1)=cu02(+) and pa01='" & strCP01 & "' and pa02='" & strCP02 & "' and pa03='" & strCP03 & "' and pa04='" & strCP04 & "' " & _
            "union select cu74 from patent,customer where cu74=" & CNULL(cType) & " and substr(pa27,1,8)=cu01(+) and substr(pa27,9,1)=cu02(+) and pa01='" & strCP01 & "' and pa02='" & strCP02 & "' and pa03='" & strCP03 & "' and pa04='" & strCP04 & "' " & _
            "union select cu74 from patent,customer where cu74=" & CNULL(cType) & " and substr(pa28,1,8)=cu01(+) and substr(pa28,9,1)=cu02(+) and pa01='" & strCP01 & "' and pa02='" & strCP02 & "' and pa03='" & strCP03 & "' and pa04='" & strCP04 & "' " & _
            "union select cu74 from patent,customer where cu74=" & CNULL(cType) & " and substr(pa29,1,8)=cu01(+) and substr(pa29,9,1)=cu02(+) and pa01='" & strCP01 & "' and pa02='" & strCP02 & "' and pa03='" & strCP03 & "' and pa04='" & strCP04 & "' " & _
            "union select cu74 from patent,customer where cu74=" & CNULL(cType) & " and substr(pa30,1,8)=cu01(+) and substr(pa30,9,1)=cu02(+) and pa01='" & strCP01 & "' and pa02='" & strCP02 & "' and pa03='" & strCP03 & "' and pa04='" & strCP04 & "'"
   StrStr = "select pa156 from patent where pa156=" & CNULL(cType) & " and pa01='" & strCP01 & "' and pa02='" & strCP02 & "' and pa03='" & strCP03 & "' and pa04='" & strCP04 & "' " & _
            "union select fa41 from patent,fagent where fa41=" & CNULL(cType) & " and substr(pa75,1,8)=fa01(+) and substr(pa75,9,1)=fa02(+) and pa01='" & strCP01 & "' and pa02='" & strCP02 & "' and pa03='" & strCP03 & "' and pa04='" & strCP04 & "' " & _
            "union select cu74 from patent,customer where cu74=" & CNULL(cType) & " and substr(pa26,1,8)=cu01(+) and substr(pa26,9,1)=cu02(+) and pa01='" & strCP01 & "' and pa02='" & strCP02 & "' and pa03='" & strCP03 & "' and pa04='" & strCP04 & "' " & _
            "union select cu74 from patent,customer where cu74=" & CNULL(cType) & " and substr(pa27,1,8)=cu01(+) and substr(pa27,9,1)=cu02(+) and pa01='" & strCP01 & "' and pa02='" & strCP02 & "' and pa03='" & strCP03 & "' and pa04='" & strCP04 & "' " & _
            "union select cu74 from patent,customer where cu74=" & CNULL(cType) & " and substr(pa28,1,8)=cu01(+) and substr(pa28,9,1)=cu02(+) and pa01='" & strCP01 & "' and pa02='" & strCP02 & "' and pa03='" & strCP03 & "' and pa04='" & strCP04 & "' " & _
            "union select cu74 from patent,customer where cu74=" & CNULL(cType) & " and substr(pa29,1,8)=cu01(+) and substr(pa29,9,1)=cu02(+) and pa01='" & strCP01 & "' and pa02='" & strCP02 & "' and pa03='" & strCP03 & "' and pa04='" & strCP04 & "' " & _
            "union select cu74 from patent,customer where cu74=" & CNULL(cType) & " and substr(pa30,1,8)=cu01(+) and substr(pa30,9,1)=cu02(+) and pa01='" & strCP01 & "' and pa02='" & strCP02 & "' and pa03='" & strCP03 & "' and pa04='" & strCP04 & "'"
   intI = 1
   Set rsAD = ClsLawReadRstMsg(intI, StrStr)
   
   If intI = 1 Then PUB_ChkPA70kind = True
   'Added by Lydia 2020/10/15 判個案寄證書後年費續辦的情況;  ex:FCP-061110個案設寄證書後年費續辦PA156=Y,但是代理人設年費不續辦
   If cType = "N" Then
       StrStr = "select pa156 from patent where pa156='Y' and pa01='" & strCP01 & "' and pa02='" & strCP02 & "' and pa03='" & strCP03 & "' and pa04='" & strCP04 & "' "
       intI = 1
       Set rsAD = ClsLawReadRstMsg(intI, StrStr)
       If intI = 1 Then PUB_ChkPA70kind = False
   End If
   'end 2020/10/15
   
   Set rsAD = Nothing
End Function

'放字進去框框中
'Modify By Sindy 2015/10/16 +Optional intFontSize As Integer = 0
'Move by Lydia 2020/08/20
Public Sub PUB_PrintFontIntoBox(ByVal oStr As String, oLeft As Integer, oUp As Integer, oRight As Integer, oDown As Integer, _
                                Optional IsCenterH As Boolean = True, Optional IsCenterW As Boolean = True, _
                                Optional IsAvgFont As Boolean = False, Optional intFontSize As Integer = 0)
'oStr 要放的字    要分行就要加 |
'oLeft, oUp  框框左上角
'oRight, 0Down 框框右下角
'IsCenter 是否置中
'IsAvgFont 是否自平均分配  與 IsCenterW = true  同時使用 無效
'Sub PrintFontIntoBox(ByVal oStr As String, oLeft As Integer, oUp As Integer, oRight As Integer, oDown As Integer, Optional IsCenterH As Boolean = True, Optional IsCenterW As Boolean = True)
Dim BoxHeight As Integer
Dim BoxWidth As Integer
Dim FontHeight As Integer
Dim FontWidth As Double
Dim ArrStr As Variant
Dim oIntI As Integer
Dim oIntJ As Integer
Dim FontTop As Integer
Dim FontLeft As Integer
Dim FontAllHeight As Integer
Dim SingleFontWidth As Integer
Dim CalFontWidth As Integer
Dim SingleFont As String
Dim TmpFont As String         '暫存的單字
Dim TmpAllFont As String         '暫存的整格字
Dim TmpLineFont As String
'add by nickc 2007/03/01
Dim TmpPrtWd As Integer

   'add by nickc 2005/09/09
   oStr = Replace(oStr, vbCrLf, "|")
   '先去跳行符號
   oStr = Replace(Replace(oStr, Chr(13), ""), Chr(10), "")
   BoxHeight = oDown - oUp
   BoxWidth = oRight - oLeft
   FontHeight = Printer.TextHeight(Mid(oStr, 1, 1))
   FontWidth = Printer.TextWidth(Mid(oStr, 1, 1))
   ArrStr = Split(Replace(oStr, vbCrLf, ""), "|")
   '檢查若是超過長度，自動跳行
   For oIntI = 0 To UBound(ArrStr)
      '超過
      TmpFont = ArrStr(oIntI)
      If Left(Trim(ArrStr(oIntI)), 1) = "□" Then
         'Modify By Sindy 2015/10/16
         If intFontSize > 0 Then
            Printer.Font.Size = intFontSize
         Else
         '2015/10/16 END
            Printer.Font.Size = 14 '9
         End If
      Else
         'Modify By Sindy 2015/10/16
         If intFontSize > 0 Then
            Printer.Font.Size = intFontSize
         Else
         '2015/10/16 END
            Printer.Font.Size = 14
         End If
      End If
      If TmpFont <> "" Then
         FontHeight = Printer.TextHeight(Mid(Trim(ArrStr(oIntI)), 1, 1))
         FontWidth = Printer.TextWidth(ArrStr(oIntI))
         If Len(TmpFont) > (BoxWidth / FontWidth) Then
            TmpAllFont = ""
            SingleFont = ""
            CalFontWidth = 0
            SingleFontWidth = 0
            TmpFont = ""
            TmpLineFont = ""
            TmpFont = ArrStr(oIntI)
            Do While Not Len(TmpFont) = 0
               SingleFont = PUB_GetOneFont(TmpFont)
               SingleFontWidth = Printer.TextWidth(SingleFont)
               If Printer.TextWidth(TmpLineFont) + SingleFontWidth > BoxWidth Then
                  TmpAllFont = TmpAllFont & TmpLineFont & "|"
                  TmpLineFont = ""
                  CalFontWidth = 0
               End If
               TmpLineFont = TmpLineFont & SingleFont
            Loop
            If TmpLineFont <> "" Then
               TmpAllFont = TmpAllFont & TmpLineFont
            End If
            If TmpAllFont <> "" Then
               ArrStr(oIntI) = TmpAllFont
            End If
         End If
      End If
   Next oIntI
   oStr = Join(ArrStr, "|")
   ArrStr = Split(oStr, "|")
   If IsCenterH = True Then
      FontAllHeight = (Val(UBound(ArrStr)) + 1) * FontHeight
      If FontAllHeight > BoxHeight Then FontAllHeight = BoxHeight
      FontTop = ((BoxHeight - FontAllHeight) / 2) + oUp
   Else
      FontTop = oUp
   End If
   For oIntI = 0 To UBound(ArrStr)
      If (FontTop + (FontHeight * (oIntI + 1))) < oDown Then
         'FontTop = FontTop + (FontHeight * oIntI)
         If IsCenterW = True Then
            FontWidth = Printer.TextWidth(ArrStr(oIntI))
            FontLeft = ((BoxWidth - FontWidth) / 2) + oLeft
            'add by nickc 2007/03/08 遇到第一個是 □ 改縮小
            If Left(Trim(ArrStr(oIntI)), 1) = "□" Then
               'Modify By Sindy 2015/10/16
               If intFontSize > 0 Then
                  Printer.Font.Size = intFontSize
               Else
               '2015/10/16 END
                  Printer.Font.Size = 14 '9
               End If
   '            FontHeight = Printer.TextHeight(Mid(oStr, 1, 1))
   '            FontWidth = Printer.TextWidth(ArrStr(oIntI))
   '            FontLeft = ((BoxWidth - FontWidth) / 2) + oLeft
            End If
            Printer.CurrentX = FontLeft
            Printer.CurrentY = FontTop + (FontHeight * oIntI)
            Printer.Print ArrStr(oIntI)
            'add by nickc 2007/03/08 遇到第一個是 □ 改縮小
            If Left(Trim(ArrStr(oIntI)), 1) = "□" Then
               'Modify By Sindy 2015/10/16
               If intFontSize > 0 Then
                  Printer.Font.Size = intFontSize
               Else
               '2015/10/16 END
                  Printer.Font.Size = 14
               End If
            End If
         ElseIf IsAvgFont = True Then
            'oLeft = BoxWidth \ Len(ArrStr(0))
            
            For oIntJ = 1 To Len(ArrStr(oIntI))
               TmpFont = Mid(ArrStr(oIntI), oIntJ, 1)
               FontWidth = Printer.TextWidth(TmpFont)
               TmpPrtWd = ((BoxWidth - FontWidth) \ (Len(ArrStr(oIntI)) - 1))
               FontLeft = (((BoxWidth - FontWidth) \ (Len(ArrStr(oIntI)) - 1)) * (oIntJ - 1)) + oLeft
               Printer.CurrentX = FontLeft
               Printer.CurrentY = FontTop + (FontHeight * oIntI)
               Printer.Print TmpFont
            Next oIntJ
         Else
            FontLeft = oLeft
            'add by nickc 2007/03/08 遇到第一個是 □ 改縮小
            If Left(Trim(ArrStr(oIntI)), 1) = "□" Then
               'Modify By Sindy 2015/10/16
               If intFontSize > 0 Then
                  Printer.Font.Size = intFontSize
               Else
               '2015/10/16 END
                  Printer.Font.Size = 14 '9
               End If
   '            FontHeight = Printer.TextHeight(Mid(oStr, 1, 1))
   '            FontWidth = Printer.TextWidth(ArrStr(oIntI))
   '            FontLeft = ((BoxWidth - FontWidth) / 2) + oLeft
            End If
            Printer.CurrentX = FontLeft
            Printer.CurrentY = FontTop + (FontHeight * oIntI)
            Printer.Print ArrStr(oIntI)
            'add by nickc 2007/03/08 遇到第一個是 □ 改縮小
            If Left(Trim(ArrStr(oIntI)), 1) = "□" Then
               'Modify By Sindy 2015/10/16
               If intFontSize > 0 Then
                  Printer.Font.Size = intFontSize
               Else
               '2015/10/16 END
                  Printer.Font.Size = 14
               End If
            End If
         End If
      End If
   Next oIntI
End Sub

'Move by Lydia 2020/08/20 從basPublic移過來
Public Function PUB_GetOneFont(ByRef oStr As String) As String
Dim i As Integer
   
   PUB_GetOneFont = ""
   If Asc(Mid(oStr, 1, 1)) < 0 Or Asc(Mid(oStr, 1, 1)) > 256 Then
      '雙位元組
      PUB_GetOneFont = Mid(oStr, 1, 1)
      oStr = Mid(oStr, 2)
      Exit Function
   Else
      Select Case Mid(oStr, 1, 1)
      '符號，或特殊字
      Case ",", " ", ":", ";", "!"
         PUB_GetOneFont = Mid(oStr, 1, 1)
         oStr = Mid(oStr, 2)
      '單位元組
      Case Else
         For i = 1 To Len(oStr)
            If Asc(Mid(oStr, i, 1)) < 0 Or Asc(Mid(oStr, i, 1)) > 256 Then
               Exit For
            Else
               Select Case Mid(oStr, i, 1)
               '符號，或特殊字
               Case ",", " ", ":", ";", "!"
                  Exit For
               Case Else
                  If Asc(Mid(oStr, i, 1)) = 13 Or Asc(Mid(oStr, i, 1)) = 10 Then
                     oStr = Mid(oStr, 2)
                     Exit For
                  Else
                     PUB_GetOneFont = PUB_GetOneFont & Mid(oStr, i, 1)
                  End If
               End Select
            End If
         Next i
         oStr = Mid(oStr, Len(PUB_GetOneFont) + 1)
      End Select
   End If
End Function

'Add By Sindy 2020/9/8 特殊申請人的出名人簽名檔
'Memo by Morgan 2024/3/29 換窗口時要改: 承辦組簽名檔 M51-00088-0-00, 工程師名檔 M51-00088-1-00,系統特殊設定[外專德國客戶指定工程師窗口]
Public Function PUB_SpecAPPLOutAgent_FCP(ByVal strCP01 As String, ByVal strCP02 As String, _
   ByVal strCP03 As String, ByVal strCP04 As String) As Boolean
   
Dim strAppl1 As String, strAppl2 As String, strAppl3 As String, strAppl4 As String, strAppl5 As String
   
   PUB_SpecAPPLOutAgent_FCP = False
   '設定德國客戶:其所有程序階段之定稿出名人簽名檔（Ryan Liou）
   'X81804000 Fresenius Medical Care Deutschland GmbH
   'X19893020 FRESENIUS MEDICAL CARE DEUTSCHLAND GMBH
   strAppl1 = GetPrjPeopleNum1(strCP01 & "-" & strCP02 & "-" & strCP03 & "-" & strCP04)
   strAppl2 = GetPrjPeopleNum2(strCP01 & "-" & strCP02 & "-" & strCP03 & "-" & strCP04)
   strAppl3 = GetPrjPeopleNum3(strCP01 & "-" & strCP02 & "-" & strCP03 & "-" & strCP04)
   strAppl4 = GetPrjPeopleNum4(strCP01 & "-" & strCP02 & "-" & strCP03 & "-" & strCP04)
   strAppl5 = GetPrjPeopleNum5(strCP01 & "-" & strCP02 & "-" & strCP03 & "-" & strCP04)
   If strAppl1 = "X81804000" Or strAppl2 = "X81804000" Or strAppl3 = "X81804000" Or strAppl4 = "X81804000" Or strAppl5 = "X81804000" Or _
      strAppl1 = "X19893020" Or strAppl2 = "X19893020" Or strAppl3 = "X19893020" Or strAppl4 = "X19893020" Or strAppl5 = "X19893020" Then
      PUB_SpecAPPLOutAgent_FCP = True
   End If
   '2020/9/8 END
End Function

'Add By Sindy 2022/3/10 設定特定客戶之特殊通知函定稿
'Modify By Sindy 2022/8/25 + , Optional ByVal strET01 As String:定稿別
Public Function PUB_SpecApplData_FCT(ByVal strCP01 As String, ByVal strCP02 As String, _
   ByVal strCP03 As String, ByVal strCP04 As String, ByVal strCP10 As String, _
   ByRef strET03 As String, Optional ByRef strET03_1 As String, Optional ByVal strET01 As String) As Boolean
   
Dim strAppl1 As String, strAppl2 As String, strAppl3 As String, strAppl4 As String, strAppl5 As String
Dim strTM44 As String
   
   strET03 = "": strET03_1 = ""
   PUB_SpecApplData_FCT = False
   If strET01 = "" Then Exit Function 'Add By Sindy 2024/8/7 必要欄位值
   
   '琬姿(商標.副理.Amanda)
   '因應直接來所客戶瑞士商 Novartis AG (X45799010)及義大利商Giorgio Armani SpA (X76135) 之要求
   '需修改商標新案申請及延展申請通知函之定稿,設定
   '1.瑞士商 Novartis AG新案申請通知函
   '  案件收文之代理人Y編號為: Y45799080、Y52341或Y49575060
   '2.義大利商Giorgio Armani SpA新案申請及延展申請通知函
   '  案件收文之代理人Y編號為: Y54600
   strAppl1 = GetPrjPeopleNum1(strCP01 & "-" & strCP02 & "-" & strCP03 & "-" & strCP04)
   strAppl2 = GetPrjPeopleNum2(strCP01 & "-" & strCP02 & "-" & strCP03 & "-" & strCP04)
   strAppl3 = GetPrjPeopleNum3(strCP01 & "-" & strCP02 & "-" & strCP03 & "-" & strCP04)
   strAppl4 = GetPrjPeopleNum4(strCP01 & "-" & strCP02 & "-" & strCP03 & "-" & strCP04)
   strAppl5 = GetPrjPeopleNum5(strCP01 & "-" & strCP02 & "-" & strCP03 & "-" & strCP04)
   strTM44 = GetPrjPeopleNum6(strCP01 & "-" & strCP02 & "-" & strCP03 & "-" & strCP04)
   
   'Modified by Morgan 2023/1/5 Novartis集團改用常數 strTmNovartisCust 判斷
   'If strAppl1 = "X45799010" Or strAppl2 = "X45799010" Or strAppl3 = "X45799010" Or strAppl4 = "X45799010" Or strAppl5 = "X45799010" Then
   '   If strTM44 = "Y45799080" Or Mid(strTM44, 1, 6) = "Y52341" Or strTM44 = "Y49575060" Then
   If (strAppl1 <> "" And InStr(strTmNovartisCust, Left(strAppl1, 6)) > 0) Or _
      (strAppl2 <> "" And InStr(strTmNovartisCust, Left(strAppl2, 6)) > 0) Or _
      (strAppl3 <> "" And InStr(strTmNovartisCust, Left(strAppl3, 6)) > 0) Or _
      (strAppl4 <> "" And InStr(strTmNovartisCust, Left(strAppl4, 6)) > 0) Or _
      (strAppl5 <> "" And InStr(strTmNovartisCust, Left(strAppl5, 6)) > 0) Or _
      (strTM44 <> "" And InStr(strTmNovartisCust, Left(strTM44, 6)) > 0) Then
   'end 2023/1/5
         'Modify By Sindy 2022/8/25
         If strET01 = "05" Then '05=註冊證
            'Modified by Morgan 2023/2/2  可用通用定稿--洪琬姿
            'strET03 = "25"
            strET03 = "22"
            'end 2023/2/2
            PUB_SpecApplData_FCT = True
         '01=發文
         ElseIf strET01 = "01" Then
            If strCP10 = "717" Then '717.註冊費
               strET03 = "04"
               PUB_SpecApplData_FCT = True
            End If
         'Modify By Sindy 2024/8/7
         ElseIf strET01 = "02" And (strCP10 = "101" Or strCP10 = "308") Then '通知申請案號
         '2024/8/7 END
         '2022/8/25 END
            strET03 = "20"
            PUB_SpecApplData_FCT = True
         End If
      'End If 'Removed by Morgan 2023/1/5
   ElseIf Mid(strAppl1, 1, 6) = "X76135" _
       Or Mid(strAppl2, 1, 6) = "X76135" _
       Or Mid(strAppl3, 1, 6) = "X76135" _
       Or Mid(strAppl4, 1, 6) = "X76135" _
       Or Mid(strAppl5, 1, 6) = "X76135" Then
      If Mid(strTM44, 1, 6) = "Y54600" Then
         'Modify By Sindy 2024/8/7 + strET01 = "02" And
         If strET01 = "02" And (strCP10 = "101" Or strCP10 = "308") Then '通知申請案號
            strET03 = "21"
            PUB_SpecApplData_FCT = True
         'Modify By Sindy 2024/8/7
         '01=發文
         ElseIf strET01 = "01" Then
         '2024/8/7 END
            If strCP10 = "102" Then '延展
               strET03 = "10"
               PUB_SpecApplData_FCT = True
            End If
         End If
      End If
   'Modify By Sindy 2024/5/20 FCT註冊費717發文，代理人Y30011+申請人X29307010時增加特殊定稿如附件
   ElseIf Mid(strAppl1, 1, 8) = "X2930701" _
       Or Mid(strAppl2, 1, 8) = "X2930701" _
       Or Mid(strAppl3, 1, 8) = "X2930701" _
       Or Mid(strAppl4, 1, 8) = "X2930701" _
       Or Mid(strAppl5, 1, 8) = "X2930701" Then
      If Mid(strTM44, 1, 6) = "Y30011" Then
         '01=發文
         If strET01 = "01" Then
            If strCP10 = "717" Then '717.註冊費
               strET03 = "05"
               PUB_SpecApplData_FCT = True
            End If
         End If
      End If
      '2024/5/20 END
   'Add By Sindy 2024/8/2 設定特殊定稿資料: 法商 L'air Liquide
   ElseIf Mid(strTM44, 1, 6) = "Y51613" Then
      '03=核准
      If strET01 = "03" Then
         If strCP10 = "101" Then '英文-註冊費自動代繳
            strET03 = "03"
            PUB_SpecApplData_FCT = True
         End If
      End If
   End If
End Function

'Added by Lydia 2021/01/05 CFP案件收文時自動帶入已報價之費用
'Modified by Morgan 2021/8/17 +pShowMsg:是否彈提醒訊息(目前為接洽單檢查CFP領證是否含其他費用,若有則提醒且不預設收文金額)
Public Function PUB_CheckCFPtoFee(ByVal pNation As String, ByVal pNP02 As String, ByVal pNP01 As String, ByVal pNP22 As String, ByVal pNP07 As String, ByVal pNP15 As String, _
                                                    ByRef lvTot As String, ByRef lvFee As String, ByRef lvDot As String, Optional pShowMsg As Boolean = False) As Boolean
'CFP之領證.年費案件，於定稿報價確認後，即將款項自動設定於系統中，於收文時，即自動帶入款項，智權人員確認與客戶之報價是否相同後，於確認或修改後即可列印。
'CFP案包含EPC的領證及年費程序，再由智權人員依客戶的指示調整費用。
Dim intQ  As Integer, rsRD As New ADODB.Recordset
Dim strQ1 As String, strB1 As String
Dim pNP07_1 As String, pNP07_2 As String
Dim strCase(0 To 4) As String

'----------------------------------------------
    '1.  抓選擇的下一程序601,605,606,607及歐盟案613延展費(英國)=相關總收文NP01,NP22去串LetterCacheVar的LCV01,LCV02；
    '2.  從LetterCacheVar判斷NVL(LCV07,LCV03)收文性質名稱相同的”費用、點數”；以下為特別抓法：
        'A.  EPC案直接抓”費用合計、點數合計”；
        'B.  歐盟案613延展費(英國)：改抓相同NP01的延展607(NP01,NP22)。
        'C.  英國案：注意也有新案非脫歐案的延展報價，用一般的抓法。
            '若收文「委任代理人(CFP.444)」時歐盟案下一程序之/「延展費(英國)613」期限轉至新案號並改案件性質為「延展費607」；下一程序備註加註「歐盟案案號」=>
            '所以英國案之下一程序備註有加註「歐盟案案號」，用該程序的相關總收文NP01抓「歐盟案案號」的下一單據NP24=NP01，再抓歐盟案的延展(NP01,NP22)。
'----------------------------------------------

   lvTot = "" '費用
   lvFee = "" '規費
   lvDot = "" '點數
    
   If pNP02 <> "CFP" And (pNP01 = "" Or pNP22 = "" Or pNP07 = "") Then GoTo EXITSUB
   
   pNP07_1 = Trim(Left(pNP07, 4))
   pNP07_2 = Trim(Mid(pNP07, 5))
   
   If InStr("601,605,606,607,613,", pNP07_1 & ",") > 0 Then
       If pNation = "221" And pNP07_1 <> "613" Then   'EPC
            strQ1 = "SELECT LCV03 AS CTITLE,NVL(LCV10,NVL(LCV06,LCV04)) AS CDETAIL  FROM LETTERCACHEVAR " & _
                        "WHERE LCV01='" & pNP01 & "' AND LCV02='" & pNP22 & "' AND (LCV03='費用合計' OR LCV03 LIKE '%點數')"
       ElseIf pNation = "239" And pNP07_1 = "613" Then '歐盟案613延展費(英國)
            strQ1 = "SELECT LCV03 AS CTITLE,NVL(LCV10,NVL(LCV06,LCV04)) AS CDETAIL FROM LETTERCACHEVAR " & _
                        "WHERE (LCV01,LCV02)=(SELECT NP01,NP22 FROM NEXTPROGRESS WHERE NP01='" & pNP01 & "' AND NP07='607') " & _
                        "AND LCV03 LIKE '英國%' "
       ElseIf pNation = "201" And pNP07_1 <> "613" And pNP15 <> "" And InStr(pNP15, "歐盟案案號：") > 0 Then
            '英國脫歐案：先收委任代理人444的情況
            strCase(0) = Mid(pNP15, InStr(pNP15, "歐盟案案號：") + Len("歐盟案案號："), 12)
            strB1 = ""
            If Left(strCase(0), 3) = "CFP" Then
                Call ChgCaseNo(strCase(0), strCase)
                If strCase(1) <> "" Then
                    strB1 = " AND NP02='" & strCase(1) & "' AND NP03='" & strCase(2) & "' AND NP04='" & strCase(3) & "' AND NP05='" & strCase(4) & "' "
                End If
            End If
            strQ1 = "SELECT LCV03 AS CTITLE,NVL(LCV10,NVL(LCV06,LCV04)) AS CDETAIL FROM LETTERCACHEVAR " & _
                        "WHERE (LCV01,LCV02)=(SELECT NP01,NP22 FROM NEXTPROGRESS WHERE NP01=(SELECT NP01 FROM NEXTPROGRESS WHERE NP24='" & pNP01 & "' AND NP07='444') AND NP07='607' " & strB1 & _
                        ") AND LCV03 LIKE '英國%'"
       Else   '一般
            strQ1 = "SELECT LCV03 AS CTITLE,NVL(LCV10,NVL(LCV06,LCV04)) AS CDETAIL FROM LETTERCACHEVAR " & _
                       "WHERE LCV01='" & pNP01 & "' AND LCV02='" & pNP22 & "' AND LCV03 IN ("
            If pNP07_2 = "領證" Then  '指定字
                   strQ1 = strQ1 & " '領證費','領證費點數') "
            Else
                   strQ1 = strQ1 & "SELECT LCV03 FROM LETTERCACHEVAR WHERE LCV01='" & pNP01 & "' AND LCV02='" & pNP22 & "' AND NVL(LCV07,LCV03)='" & pNP07_2 & "' " & _
                       "UNION SELECT LCV03||'點數' FROM LETTERCACHEVAR WHERE LCV01='" & pNP01 & "' AND LCV02='" & pNP22 & "' AND NVL(LCV07,LCV03)='" & pNP07_2 & "') "
            End If
       End If
       If strQ1 <> "" Then
          intQ = 1
          Set rsRD = ClsLawReadRstMsg(intQ, strQ1)
          If intQ = 1 Then
              rsRD.MoveFirst
              Do While Not rsRD.EOF
                   If InStr("" & rsRD.Fields("CTITLE"), "點數") > 0 Then
                        lvDot = Val(lvDot) + Val("" & rsRD.Fields("CDETAIL"))
                   Else
                        lvTot = Val(lvTot) + Val("" & rsRD.Fields("CDETAIL"))   '費用
                   End If
                   rsRD.MoveNext
              Loop
              lvFee = Val(lvTot) - Val(lvDot) * 1000 '規費
              PUB_CheckCFPtoFee = True
              
              'Added by Morgan 2021/8/17
              'CFP領證要再檢查報價是否含其他費用
              If pNP02 = "CFP" And pNP07_1 = "601" Then
                  strQ1 = "SELECT LCV03 AS CTITLE,NVL(LCV10,NVL(LCV06,LCV04)) AS CDETAIL  FROM LETTERCACHEVAR " & _
                        "WHERE LCV01='" & pNP01 & "' AND LCV02='" & pNP22 & "' AND LCV03='費用總計'"
                  intQ = 1
                  Set rsRD = ClsLawReadRstMsg(intQ, strQ1)
                  If intQ = 1 Then
                     If Val("" & rsRD.Fields("CDETAIL")) <> lvTot Then
                        If pShowMsg Then
                           MsgBox "此階段該收的費用應非僅原領證費，費用不自動帶出，請自行決定列單一領證程序並調整費用，或加列一補收款之程序。", vbInformation, "CFP領證費報價提醒"
                        End If
                        PUB_CheckCFPtoFee = False
                     End If
                  End If
              End If
              'end 2021/8/17
              
              Exit Function
          End If
       End If
   End If
EXITSUB:
    Set rsRD = Nothing
    PUB_CheckCFPtoFee = False
End Function

'Add Sindy 2014/9/18 Email化的標題內文
'                            , Optional strFCorCF As String = "":發信對象FC/CF
'Modify By Sindy 2015/1/8 加Optional strCP10 As String = "" ex:FCP-036408的年費
'Modify By Sindy 2020/10/13 + Optional bolRefNo As Boolean = False
'Modify By Sindy 2024/7/22 + , Optional bolCallMail As Boolean = True: True=使用於郵件, False=撰寫信函
'                            , Optional bolFrom1105Callme As Boolean = False: 是否frm1105定稿維護呼叫
'                            , Optional OutCallCP10 As String = ""
Public Function PUB_GetFCeMailConText(strTitle As String, strCP01 As String, strCP02 As String, strCP03 As String, strCP04 As String, _
                                      Optional strFCorCF As String = "", Optional strCP10 As String = "", _
                                      Optional bolRefNo As Boolean = False, Optional bolCallMail As Boolean = True, _
                                      Optional bolFrom1105Callme As Boolean = False, Optional OutCallCP10 As String = "") As String
Dim pa() As String
Dim intWhere As Integer
Dim m_strCustomer As String, m_strFCAgent As String
Dim strNation As String
Dim bolIsECase As Boolean
Dim stCaseNo As String, stYourRef As String, stOurRef As String, bAllApp As Boolean, strCustName As String 'Add By Sindy 2024/7/22
Dim m_strCP44 As String, m_strCP45 As String 'Add By Sindy 2024/7/23
Dim bBASF As Boolean 'Added by Morgan 2018/6/25
   
   PUB_GetFCeMailConText = ""
   ReDim pa(TF_PA) As String
   pa(1) = strCP01
   pa(2) = strCP02
   pa(3) = strCP03
   pa(4) = strCP04
   
   '讀取資料庫資料
   Select Case pa(1) '判斷系統類別
      Case "P", "CFP", "FCP" '專利
          If ClsPDReadPatentDatabase(pa(), intWhere) = False Then Exit Function
          m_strCustomer = Left(pa(26) & "000000000", 9)
          m_strFCAgent = Left(pa(75) & "000000000", 9)
          strNation = pa(9)
          If pa(142) = "Y" Then bolIsECase = True
          
      Case "T", "TF", "CFT", "FCT" '商標
          If ClsPDReadTrademarkDatabase(pa(), intWhere) = False Then Exit Function
          m_strCustomer = Left(pa(23) & "000000000", 9)
          m_strFCAgent = Left(pa(44) & "000000000", 9)
          strNation = pa(10)
          If pa(121) = "Y" Then bolIsECase = True
          
      'modify by sonia 2019/7/31 +ACS系統類別
      Case "L", "FCL", "CFL", "LIN", "ACS" '法務
          If ClsPDReadLawCaseDatabase(pa()) = False Then Exit Function
          m_strCustomer = Left(pa(11) & "000000000", 9)
          m_strFCAgent = Left(pa(22) & "000000000", 9)
          strNation = pa(15)
          
      Case "LA" '顧問
          If ClsPDReadHireCaseDatabase(pa()) = False Then Exit Function
          m_strCustomer = Left(pa(5) & "000000000", 9)
          m_strFCAgent = ""
          strNation = "000"
          
      Case Else '服務業務
          If ClsPDReadServicePracticeDatabase(pa(), intWhere) = False Then Exit Function
          m_strCustomer = Left(pa(8) & "000000000", 9)
          m_strFCAgent = Left(pa(26) & "000000000", 9)
          strNation = pa(9)
          If pa(80) = "Y" Then bolIsECase = True
   End Select
   
   '先抓CF代理人
   m_strCP44 = "": m_strCP45 = ""
   strExc(0) = "select CP44,CP45,CP09 FROM CASEPROGRESS WHERE " & ChgCaseprogress(pa(1) & pa(2) & pa(3) & pa(4)) & _
               " AND CP44 Is Not Null AND cp57 is null AND CP09<'C'"
   'Modify By Sindy 2014/9/4 CFT撰寫信函之CF代理人名稱：文件簽證711及申請英文證明304 不要列入
   If pa(1) = "CFT" Then
     strExc(0) = strExc(0) & " AND CP10 NOT IN ('711','304')"
   End If
   'Added by Morgan 2024/4/11 排除P大陸案年費--郭
   If pa(1) = "P" And pa(9) = "020" Then
      strExc(0) = strExc(0) & " AND CP10<>'605'"
   End If
   'end 2024/4/11
   strExc(0) = strExc(0) & " Order By CP27 Desc, CP09 Desc"
   '2014/9/4 End
   intI = 1
   Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
   If intI = 1 Then
      m_strCP44 = "" & RsTemp.Fields("CP44").Value
      m_strCP45 = "" & RsTemp.Fields("CP45").Value
   End If
   
   Select Case UCase(strTitle)
      Case UCase("IsECase")
         If bolIsECase = False Then
            strExc(0) = "select " & IIf(Left(strCP01, 1) = "T", "cu126", "cu124") & " from customer" & _
                        " where substr('" & m_strCustomer & "',1,8)=cu01(+) and substr('" & m_strCustomer & "',9,1)=cu02(+) and cu124='Y'" & _
                 " union select " & IIf(Left(strCP01, 1) = "T", "fa91", "fa86") & " from fagent" & _
                        " where substr('" & m_strFCAgent & "',1,8)=fa01(+) and substr('" & m_strFCAgent & "',9,1)=fa02(+) and fa86='Y'"
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
            '若PA142...或FA86或CU124有一個設定為Y以E-Mail通知者,就屬於E化的案件
            If intI = 1 Then
               bolIsECase = True '為E化案件
            End If
         End If
         If bolIsECase = True Then PUB_GetFCeMailConText = "Y"
         
      Case UCase("CaseNo")
         '若為專利案件
         If pa(1) = "P" Or pa(1) = "CFP" Or pa(1) = "FCP" Then
            '改抓函數(比照傳真封面)
            If pa(1) = "P" Or pa(1) = "FCP" Then
               PUB_GetFCeMailConText = PUB_GetNationEngNameForLet(pa(9))
            End If
            PUB_GetFCeMailConText = PUB_GetFCeMailConText & PUB_GetEngPatKindName("1", pa(8))
            'FCP比照傳真封面
            If pa(1) = "FCP" Then
               PUB_GetFCeMailConText = PUB_GetFCeMailConText & " Patent Application No. " & pa(11)
               If pa(22) <> "" Then
                  PUB_GetFCeMailConText = PUB_GetFCeMailConText & " (Patent No. " & pa(22) & ")"
               End If
            Else
               '若有專利號數
               If pa(22) <> "" Then
                  PUB_GetFCeMailConText = PUB_GetFCeMailConText & " Patent No. " & pa(22)
               '若無專利號數有申請案號
               ElseIf pa(22) = "" And pa(11) <> "" Then
                  PUB_GetFCeMailConText = PUB_GetFCeMailConText & " Patent Application No. " & pa(11)
               '若無專利號數也無申請案號
               ElseIf pa(22) = "" And pa(11) = "" Then
                  PUB_GetFCeMailConText = PUB_GetFCeMailConText & " Patent Application No."
               End If
            End If
            
         ElseIf pa(1) = "FG" Then
            PUB_GetFCeMailConText = pa(6)
            
         '若為商標案件
         ElseIf pa(1) = "T" Or pa(1) = "TF" Or pa(1) = "CFT" Or pa(1) = "FCT" Then
            '有審定號
            If pa(15) <> "" Then
               If pa(1) = "CFT" Then
                  PUB_GetFCeMailConText = " Trademark Registration No. " & pa(15) & " in " & GetNationName(pa(10), 1)
               Else
                  PUB_GetFCeMailConText = " Taiwan Trademark Registration No. " & pa(15)
               End If
            '無審定號印申請案號
            Else
               If pa(1) = "CFT" Then
                  PUB_GetFCeMailConText = " Trademark Application No. " & pa(12) & " in " & GetNationName(pa(10), 1)
               Else
                  PUB_GetFCeMailConText = " Taiwan Trademark Application No. " & pa(12)
               End If
            End If
         End If
         
      Case UCase("YourRef") '彼所案號
         'CF
         If strFCorCF = "CF" Then
            PUB_GetFCeMailConText = "Your Ref: " & m_strCP45
            GoTo RunEnd
         End If
         
         '若為專利案件
         If pa(1) = "P" Or pa(1) = "CFP" Or pa(1) = "FCP" Then
            'FC
            If strFCorCF = "FC" Then
               'Modify By Sindy 2020/3/19 ex:FCP-036457(年費)
               If strCP10 = "605" Or strCP10 = "1605" Then '1605.通知年費逾期
                  'Modify By Sindy 2020/4/16 增加判斷有年費彼所案號和年費代理人時,才抓年費彼所案號
                  'PUB_GetFCeMailConText = "Your Ref: " & pa(106)
                  If pa(106) <> "" And pa(76) <> "" Then
                     PUB_GetFCeMailConText = "Your Ref: " & pa(106)
                  Else
                     PUB_GetFCeMailConText = "Your Ref: " & pa(77)
                  End If
                  '2020/4/16 END
               Else
               '2020/3/19 END
                  PUB_GetFCeMailConText = "Your Ref: " & pa(77)
               End If
            End If
            
         ElseIf pa(1) = "FG" Then
            'FC
            If strFCorCF = "FC" Then
               PUB_GetFCeMailConText = "Your Ref: " & pa(27)
            End If
           
         '若為商標案件
         ElseIf pa(1) = "T" Or pa(1) = "TF" Or pa(1) = "CFT" Or pa(1) = "FCT" Then
            'FC
            If strFCorCF = "FC" Then
               PUB_GetFCeMailConText = "Your Ref: " & pa(45)
            End If
            
         '若為法務案件
         'modify by sonia 2019/7/31 +ACS系統類別
         ElseIf pa(1) = "FCL" Or pa(1) = "CFL" Or pa(1) = "LIN" Or pa(1) = "ACS" Then
            'FC
            If strFCorCF = "FC" Then
               PUB_GetFCeMailConText = "Your Ref: " & pa(23)
            End If
         End If
         
      Case UCase("OurRef") '本所案號
         PUB_GetFCeMailConText = "Our Ref: " & strCP01 & "-" & strCP02 & IIf(strCP03 & strCP04 = "000", "", "-" & strCP03 & IIf(strCP04 = "00", "", "-" & strCP04))
      
      Case UCase("Main_EMail") 'EMail代表信箱
         'Modify By Sindy 2015/1/8 加Optional strCP10 As String = "" ex:FCP-036408的年費
         If strCP10 <> "" Then
            'Modify By Sindy 2019/3/12
            'PUB_GetFCeMailConText = Trim(Replace(ExceptFieldData("電子信箱/FC", strCP10), "E-mail:", ""))
            PUB_GetFCeMailConText = Trim(Replace(Replace(ExceptFieldData("電子信箱/FC", strCP10), "E-mail:", ""), "ＥＭＡＩＬ：", ""))
         Else
            strExc(0) = "select CP44,CP45,CP09 FROM CASEPROGRESS WHERE " & ChgCaseprogress(pa(1) & pa(2) & pa(3) & pa(4)) & _
                          " AND CP44 Is Not Null AND CP09<'C' and cp57 is null"
            'CFT撰寫信函之CF代理人名稱：文件簽證711及申請英文證明304 不要列入
            If pa(1) = "CFT" Then
              strExc(0) = strExc(0) & " AND CP10 NOT IN ('711','304')"
            End If
            strExc(0) = strExc(0) & " Order By CP27 Desc, CP09 Desc"
            m_strCP44 = ""
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               m_strCP44 = "" & RsTemp.Fields(0).Value
            Else
               m_strCP44 = ""
            End If
            
            If strFCorCF = "FC" Then
               strExc(1) = m_strFCAgent
            ElseIf strFCorCF = "CF" Then
               strExc(1) = m_strCP44
               'Added by Morgan 2012/6/25
               'CFP 日本案 CF代理人為 Y51835 E-Mail 用 mm@miyoshipat.co.jp --慧汶 101/5/30 請作單
               If pa(1) = "CFP" And strNation = "011" And m_strCP44 = "Y51835000" Then
                  PUB_GetFCeMailConText = "mm@miyoshipat.co.jp"
                  Exit Function
               End If
            Else
               strExc(1) = m_strCustomer
            End If
            
            'Add By Sindy 2020/10/13 回傳客戶/代理人編號
            If bolRefNo = True Then
               PUB_GetFCeMailConText = strExc(1)
            Else
            '2020/10/13 END
               If Left(strExc(1), 1) = "Y" Then
                  strExc(0) = "SELECT FA16 FROM FAGENT WHERE " & ChgFagent(strExc(1))
               Else
                  strExc(0) = "SELECT CU20 FROM CUSTOMER WHERE " & ChgCustomer(strExc(1))
               End If
               intI = 1
               Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
               If intI = 1 Then
                  With RsTemp
                     PUB_GetFCeMailConText = "" & .Fields(0)
                  End With
               End If
            End If
         End If
         
      'Add By Sindy 2024/7/22
      Case "RE"
         stCaseNo = "": stYourRef = "": stOurRef = ""
         '若為專利案件
         If pa(1) = "P" Or pa(1) = "CFP" Or pa(1) = "FCP" Then
            PUB_GetFCeMailConText = "Re:"
            '改抓函數(比照傳真封面)
            If pa(1) = "P" Or pa(1) = "FCP" Then
               stCaseNo = stCaseNo & " " & PUB_GetNationEngNameForLet(pa(9))
            End If
            stCaseNo = stCaseNo & PUB_GetEngPatKindName("1", pa(8))
            'FCP比照傳真封面
            If pa(1) = "FCP" Then
               stCaseNo = stCaseNo & " Patent Application No. " & pa(11)
               If pa(22) <> "" Then
                  stCaseNo = stCaseNo & " (Patent No. " & pa(22) & ")"
               End If
            Else
               '若有專利號數
               If pa(22) <> "" Then
                  stCaseNo = stCaseNo & " Patent No. " & pa(22)
               '若無專利號數有申請案號
               ElseIf pa(22) = "" And pa(11) <> "" Then
                  stCaseNo = stCaseNo & " Patent Application No. " & pa(11)
               '若無專利號數也無申請案號
               ElseIf pa(22) = "" And pa(11) = "" Then
                  stCaseNo = stCaseNo & " Patent Application No."
               End If
            End If
            PUB_GetFCeMailConText = PUB_GetFCeMailConText & stCaseNo & vbCrLf
            
            '申請人名稱
            '日本印中文
            If pa(1) = "FCP" Then
               bAllApp = True
            Else
               '帶出所有申請人
               bAllApp = True
            End If
            If strNation = "011" Then
               strCustName = GetCustName(pa(1) & pa(2) & pa(3) & pa(4), "1", bAllApp, String(11, " "), True)
            Else
               strCustName = GetCustName(pa(1) & pa(2) & pa(3) & pa(4), "2", bAllApp, String(11, " "), True)
            End If
            If strCustName <> "" Then
               PUB_GetFCeMailConText = PUB_GetFCeMailConText & IIf(bolCallMail = True, "   ", "") & "   Applicant: " & strCustName & vbCrLf
            End If
            '案件名稱
            'Add By Sindy 2015/5/29
            'If bolFrom1105Callme = False Then '定稿維護時不顯示Title
            '2015/5/29 END
               'Modify By Sindy 2018/11/15 外專承辦人洪培堯反應要顯示Title,Matter ID
               If pa(6) <> "" Then
                  PUB_GetFCeMailConText = PUB_GetFCeMailConText & IIf(bolCallMail = True, "   ", "") & "   Title: " & SplitTitle(pa(6), IIf(bolCallMail = True, 14, 8)) & vbCrLf
               End If
               If pa(159) <> "" And Left(pa(75), 6) = "Y54047" Then
                  PUB_GetFCeMailConText = PUB_GetFCeMailConText & IIf(bolCallMail = True, "   ", "") & "   Matter No.: " & pa(159) & vbCrLf
               End If
               '2018/11/15 END
            'End If
            If strFCorCF <> "CF" Then
               '客戶案件案號
               If pa(48) <> "" Then
                  PUB_GetFCeMailConText = PUB_GetFCeMailConText & IIf(bolCallMail = True, "   ", "") & "   Case No: " & pa(48) & vbCrLf
               End If
            End If
            
            '彼所案號
            'FC
            If strFCorCF = "FC" Then
               'Modify By Sindy 2019/5/23
               'stYourRef = IIf(bolCallMail = True, "   ", "") & "   Your Ref: " & pa(77)
               stYourRef = IIf(bolCallMail = True, "   ", "") & "   Your Ref: " & IIf(OutCallCP10 = "605", IIf(pa(106) <> "" And pa(76) <> "", pa(106), pa(77)), pa(77))
               '2019/5/23 END
               PUB_GetFCeMailConText = PUB_GetFCeMailConText & stYourRef & vbCrLf
            'CF
            ElseIf strFCorCF = "CF" Then
               'Modified by Morgan 2024/3/27
               'stYourRef = IIf(bolCallMail = True, "   ", "") & "   Your Ref: " & cp(0)
               stYourRef = IIf(bolCallMail = True, "   ", "") & "   Your Ref: " & m_strCP45
               'end 2024/3/27
               PUB_GetFCeMailConText = PUB_GetFCeMailConText & stYourRef & vbCrLf
            End If
            
         ElseIf pa(1) = "FG" Then
            PUB_GetFCeMailConText = "Re:"
            stCaseNo = " " & pa(6)
            PUB_GetFCeMailConText = PUB_GetFCeMailConText & stCaseNo & vbCrLf
            '申請人名稱
            '日本印中文
            If strNation = "011" Then
               strCustName = GetCustName(pa(1) & pa(2) & pa(3) & pa(4), "1")
            Else
               strCustName = GetCustName(pa(1) & pa(2) & pa(3) & pa(4), "2")
            End If
            If strCustName <> "" Then
               PUB_GetFCeMailConText = PUB_GetFCeMailConText & IIf(bolCallMail = True, "   ", "") & "   Applicant: " & strCustName & vbCrLf
            End If
            '客戶案件案號
            If pa(29) <> "" Then
               PUB_GetFCeMailConText = PUB_GetFCeMailConText & IIf(bolCallMail = True, "   ", "") & "   Case No: " & pa(29) & vbCrLf
            End If
            '彼所案號
            'FC
            If strFCorCF = "FC" Then
               stYourRef = IIf(bolCallMail = True, "   ", "") & "   Your Ref: " & pa(27)
               PUB_GetFCeMailConText = PUB_GetFCeMailConText & stYourRef & vbCrLf
            'CF
            ElseIf strFCorCF = "CF" Then
               strExc(0) = "select CP45 FROM CaseProgress WHERE " & ChgCaseprogress(pa(1) & pa(2) & pa(3) & pa(4)) & " AND CP44 Is Not Null AND CP57 is null AND CP09<'C' Order By CP27 Desc, CP09 Desc "
               intI = 1
               Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
               If intI = 1 Then
                  strExc(1) = "" & RsTemp.Fields(0)
               End If
               stYourRef = IIf(bolCallMail = True, "   ", "") & "   Your Ref: " & strExc(1)
               PUB_GetFCeMailConText = PUB_GetFCeMailConText & stYourRef & vbCrLf
            End If
           
         '若為商標案件
         ElseIf pa(1) = "T" Or pa(1) = "TF" Or pa(1) = "CFT" Or pa(1) = "FCT" Then
            PUB_GetFCeMailConText = "Re:"
            '有審定號
            If pa(15) <> "" Then
               If pa(1) = "CFT" Then
                  stCaseNo = " Trademark Registration No. " & pa(15) & " in " & GetNationName(pa(10), 1)
               Else
                  stCaseNo = " Taiwan Trademark Registration No. " & pa(15)
               End If
            '無審定號印申請案號
            Else
               If pa(1) = "CFT" Then
                  stCaseNo = " Trademark Application No. " & pa(12) & " in " & GetNationName(pa(10), 1)
               Else
                  stCaseNo = " Taiwan Trademark Application No. " & pa(12)
               End If
            End If
            PUB_GetFCeMailConText = PUB_GetFCeMailConText & stCaseNo & vbCrLf
g:
            '申請人名稱
            strCustName = GetCustName(pa(1) & pa(2) & pa(3) & pa(4), "2")
            If strCustName <> "" Then
               PUB_GetFCeMailConText = PUB_GetFCeMailConText & IIf(bolCallMail = True, "   ", "") & "   Applicant: " & strCustName & vbCrLf
            End If
            '案件名稱
            If pa(5) & pa(6) & pa(7) <> "" Then
               If pa(1) = "CFT" Or pa(1) = "FCT" Then
                  PUB_GetFCeMailConText = PUB_GetFCeMailConText & IIf(bolCallMail = True, "   ", "") & "   Mark: " & pa(5) & pa(6) & pa(7) & vbCrLf
               Else
                  'Add By Sindy 2015/5/29
                  If bolFrom1105Callme = False Then '定稿維護時不顯示Title
                  '2015/5/29 END
                     PUB_GetFCeMailConText = PUB_GetFCeMailConText & IIf(bolCallMail = True, "   ", "") & "   Title: " & pa(5) & pa(6) & pa(7) & vbCrLf
                  End If
               End If
            End If
            '類別
            If pa(9) <> "" Then
               If pa(1) = "CFT" Or pa(1) = "FCT" Then
                  PUB_GetFCeMailConText = PUB_GetFCeMailConText & IIf(bolCallMail = True, "   ", "") & "   Class: " & pa(9) & vbCrLf
               End If
            End If
            '客戶案件案號
            If pa(35) <> "" Then
               PUB_GetFCeMailConText = PUB_GetFCeMailConText & IIf(bolCallMail = True, "   ", "") & "   Case No: " & pa(35) & vbCrLf
            End If
            '彼所案號
            'FC
            If strFCorCF = "FC" Then
               stYourRef = IIf(bolCallMail = True, "   ", "") & "   Your Ref: " & pa(45)
               PUB_GetFCeMailConText = PUB_GetFCeMailConText & stYourRef & vbCrLf
            'CF
            ElseIf strFCorCF = "CF" Then
               stYourRef = IIf(bolCallMail = True, "   ", "") & "   Your Ref: " & m_strCP45
               PUB_GetFCeMailConText = PUB_GetFCeMailConText & stYourRef & vbCrLf
            End If
            
         '若為法務案件
         'modify by sonia 2019/7/30 +ACS系統類別
         ElseIf pa(1) = "FCL" Or pa(1) = "CFL" Or pa(1) = "LIN" Or pa(1) = "ACS" Then
            PUB_GetFCeMailConText = "Re:" & vbCrLf
            '彼所案號
            'FC
            If strFCorCF = "FC" Then
               stYourRef = IIf(bolCallMail = True, "   ", "") & "   Your Ref: " & pa(23)
               PUB_GetFCeMailConText = PUB_GetFCeMailConText & stYourRef & vbCrLf
            'CF
            ElseIf strFCorCF = "CF" Then
               stYourRef = IIf(bolCallMail = True, "   ", "") & "   Your Ref: " & m_strCP45
               PUB_GetFCeMailConText = PUB_GetFCeMailConText & stYourRef & vbCrLf
            End If
         End If
         '本所案號
         stOurRef = IIf(bolCallMail = True, "   ", "") & "   Our Ref: " & pa(1) & "-" & pa(2) & IIf(pa(3) & pa(4) = "000", "", "-" & pa(3) & IIf(pa(4) = "00", "", "-" & pa(4)))
         PUB_GetFCeMailConText = PUB_GetFCeMailConText & stOurRef & vbCrLf
   End Select
   
RunEnd:
   PUB_GetFCeMailConText = Trim(PUB_GetFCeMailConText)
End Function
'Modify By Sindy 2024/7/23 從frm090401撰寫信函搬過來
'Modify by Morgan 2007/3/29 加所有申請人選項
Public Function GetCustName(strCaseNo As String, strLang As String, Optional ByVal bolAll As Boolean = False, Optional ByVal PreStr As String, Optional ByVal bolNum As Boolean = False) As String
On Error GoTo ErrHnd
   
   If bolAll = True Then
      'Modify By Sindy 2011/2/18 增加LC43,LC44,LC45,LC46,HC24,HC25,HC26,HC27
      strSql = "select pa26,pa27,pa28,pa29,pa30 from patent where " & ChgPatent(strCaseNo)
      strSql = strSql & " Union Select tm23,tm78,tm79,tm80,tm81 From Trademark Where " & ChgTradeMark(strCaseNo)
      strSql = strSql & " Union Select LC11,LC43,LC44,LC45,LC46 From Lawcase Where " & ChgLawcase(strCaseNo)
      strSql = strSql & " Union Select HC11,HC24,HC25,HC26,HC27 From Hirecase Where " & ChgHirecase(strCaseNo)
      strSql = strSql & " Union Select sp08,sp58,sp59,sp65,sp66 From ServicePractice Where " & ChgService(strCaseNo)
      
      strSql = "select C1.CU04, C1.CU05||' '||C1.CU88||' '||C1.CU89||' '||C1.CU90, C1.CU06" & _
         ",C2.CU04, C2.CU05||' '||C2.CU88||' '||C2.CU89||' '||C2.CU90, C2.CU06" & _
         ",C3.CU04, C3.CU05||' '||C3.CU88||' '||C3.CU89||' '||C3.CU90, C3.CU06" & _
         ",C4.CU04, C4.CU05||' '||C4.CU88||' '||C4.CU89||' '||C4.CU90, C4.CU06" & _
         ",C5.CU04, C5.CU05||' '||C5.CU88||' '||C5.CU89||' '||C5.CU90, C5.CU06" & _
         " from (" & strSql & ") X,CUSTOMER C1,CUSTOMER C2,CUSTOMER C3,CUSTOMER C4,CUSTOMER C5" & _
         " where C1.CU01(+)=substr(PA26,1,8) And C1.CU02(+)=substr(PA26,9,1)" & _
         " and C2.CU01(+)=substr(PA27,1,8) And C2.CU02(+)=substr(PA27,9,1)" & _
         " and C3.CU01(+)=substr(PA28,1,8) And C3.CU02(+)=substr(PA28,9,1)" & _
         " and C4.CU01(+)=substr(PA29,1,8) And C4.CU02(+)=substr(PA29,9,1)" & _
         " and C5.CU01(+)=substr(PA30,1,8) And C5.CU02(+)=substr(PA30,9,1)"
   Else
      strSql = "Select CU04, CU05||' '||CU88||' '||CU89||' '||CU90, CU06 From Customer, Patent Where substr(PA26,1,8)=CU01 And substr(PA26,9,1)=CU02 And " & ChgPatent(strCaseNo)
      strSql = strSql & " Union Select CU04, CU05||' '||CU88||' '||CU89||' '||CU90, CU06 From Customer, Trademark Where substr(TM23,1,8)=CU01 And substr(TM23,9,1)=CU02 And " & ChgTradeMark(strCaseNo)
      strSql = strSql & " Union Select CU04, CU05||' '||CU88||' '||CU89||' '||CU90, CU06 From Customer, Lawcase Where substr(LC11,1,8)=CU01 And substr(LC11,9,1)=CU02 And " & ChgLawcase(strCaseNo)
      strSql = strSql & " Union Select CU04, CU05||' '||CU88||' '||CU89||' '||CU90, CU06 From Customer, Hirecase Where substr(HC05,1,8)=CU01 And substr(HC11,9,1)=CU02 And " & ChgHirecase(strCaseNo)
      strSql = strSql & " Union Select CU04, CU05||' '||CU88||' '||CU89||' '||CU90, CU06 From Customer, ServicePractice Where substr(SP08,1,8)=CU01 And substr(SP08,9,1)=CU02 And " & ChgService(strCaseNo)
   End If
   CheckOC
   With adoRecordset
      .CursorLocation = adUseClient
      .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      If .RecordCount > 0 Then
         Select Case strLang
            Case "1" '中文
               GetCustName = "" & .Fields(0).Value
               If bolAll = True Then
                  For intI = 1 To 4
                     strExc(1) = Trim("" & .Fields(3 * intI).Value)
                     If strExc(1) <> "" Then
                        GetCustName = GetCustName & vbCrLf & PreStr & strExc(1)
                     End If
                  Next
               End If
            Case "2" '英文
               'Modify by Morgan 2007/7/25 加控制斷行
               'GetCustName = "" & .Fields(1).Value
               'If bolAll = True Then
               '   For intI = 1 To 4
               '      strExc(1) = Trim("" & .Fields(1 + 3 * intI).Value)
               '      If strExc(1) <> "" Then
               '         GetCustName = GetCustName & vbCrLf & PreStr & strExc(1)
               '      End If
               '   Next
               'End If
               If Not IsNull(.Fields(1)) Then
                  If bolAll = False Then
                     GetCustName = SplitTitle(.Fields(1), PUB_GetLen(PreStr))
                  Else
                     If bolNum = True And Trim("" & .Fields(1 + 3 * 1)) <> "" Then
                        GetCustName = SplitTitle("1." & .Fields(1), PUB_GetLen(PreStr))
                     Else
                        GetCustName = SplitTitle(.Fields(1), PUB_GetLen(PreStr))
                     End If
                     For intI = 1 To 4
                        strExc(1) = Trim("" & .Fields(1 + 3 * intI).Value)
                        If strExc(1) <> "" Then
                           If bolNum = True Then
                              GetCustName = GetCustName & vbCrLf & PreStr & SplitTitle(intI + 1 & "." & strExc(1), PUB_GetLen(PreStr) + 1)
                           Else
                              GetCustName = GetCustName & vbCrLf & PreStr & SplitTitle(strExc(1), PUB_GetLen(PreStr))
                           End If
                        End If
                     Next
                  End If
               End If
               'end 2007/7/25
          
            Case "3" '日文
               GetCustName = "" & .Fields(2).Value
               If bolAll = True Then
                  For intI = 1 To 4
                     strExc(1) = Trim("" & .Fields(2 + 3 * intI).Value)
                     If strExc(1) <> "" Then
                        GetCustName = GetCustName & vbCrLf & PreStr & strExc(1)
                     End If
                  Next
               End If
         End Select
      End If
   End With
   
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description
End Function
'Modify By Sindy 2024/7/23 從frm090401撰寫信函搬過來
Public Function PUB_GetLen(strWord As String) As Integer
   Dim stChar As String
   Dim iLen As Integer
   Dim ii As Integer
   For ii = 1 To Len(strWord)
      stChar = Mid(strWord, ii, 1)
      '全形字 2
      If Asc(stChar) < 0 Then
         iLen = iLen + 2
      '英文大寫 1.5
      ElseIf Asc(stChar) >= 65 And Asc(stChar) <= 90 Then
         iLen = iLen + 1.5
      '其他 1
      Else
         iLen = iLen + 1
      End If
   Next
   PUB_GetLen = iLen
End Function

'Added by Lydia 2021/01/19 外專實審發文(實體審查416)之承辦單=>發email通知
Public Sub PUB_GetFCPEmpMail416(ByVal pType As String, ByVal pKeyNo As String, ByVal pStrType As String, ByVal pChkType As String, ByVal pPaid As String, ByVal pRecDate As String, ByVal pStartDate As String, _
                                Optional ByRef pCP152 As String, Optional ByRef pMC02 As String, Optional ByRef pMC07 As String, Optional ByRef pMC08 As String, Optional ByRef pMC09 As String)
'pType : 1-直接存檔, 2-回傳
'pKeyNo : 收文號
'pStrType : 是否e/E化
'pChkType : 1.實審+主動修正, 2.特殊請款單
'pPaid : 已收款(1-不寄D/N, 2-寄D/N)
'pRecDate : 當天報告Y
'pStartDate: 畫面上的發文日
'pMC02、pMC07、pMC08、pMC09: 收件人、主旨、內文、CC
Dim strB1 As String, intB As Integer, strB2 As String
Dim strAddCPn As String
Dim rsBD As New ADODB.Recordset
Dim intR As Integer
Dim strTo As String, strCC As String, strSubject As String, strContent As String, strSpeed As String
Dim bolGetSpec As Boolean '有特殊設定
Dim tmpArr1 As Variant
Dim rsQuery  As New ADODB.Recordset
Dim str203CP14 As String

    If pType = "2" Then
        pMC02 = "": pMC07 = "": pMC08 = "": pMC09 = ""
    End If
     
    'Modified by Lydia 2021/04/21 +PA150
    'Modified by Lydia 2023/05/02 +CP84
    strB1 = "select cp01,cp02,cp03,cp04,cp10,decode(pa09,'000',cpm03,cpm04) cp10n,cp13," & _
                "cp27,cp60,cp148,cp152,cp53,cp54,Substr(Nvl(Fa10,Cu10),1,3) Fcna01 ,pa75,pa26,pa27,pa28,pa29,pa30,pa150,CP84 " & _
                "from caseprogress, patent,casepropertymap,fagent,customer " & _
                "where cp09='" & pKeyNo & "' and cp01=pa01(+) and cp02=pa02(+) and cp03=pa03(+) and cp04=pa04(+) and cp01=cpm01(+) and cp10=cpm02(+) " & _
                "and substr(pa75,1,8)=fa01(+) and substr(pa75,9,1)=fa02(+) and substr(pa26,1,8)=cu01(+) and substr(pa26,9,1)=cu02(+) "
    intB = 1
    Set rsBD = ClsLawReadRstMsg(intB, strB1)
    If intB = 1 Then
        If pChkType = "" And "" & rsBD.Fields("cp148") = "Y" Then pChkType = "2"   '沒有傳入則以進度檔為準
        If "" & rsBD.Fields("cp152") <> "" Then pCP152 = "" & rsBD.Fields("cp152")
        
        '抓承辦單特殊設定(FcpEmpBill): 備註、速別、Email收件人+CC
        bolGetSpec = PUB_GetFcpEMPBillSpec(rsBD.Fields("cp01") & rsBD.Fields("cp02") & rsBD.Fields("cp03") & rsBD.Fields("cp04"), "05", "" & rsBD.Fields("pa75"), _
                                   rsBD.Fields("pa26") & "," & rsBD.Fields("pa27") & "," & rsBD.Fields("pa28") & "," & rsBD.Fields("pa29") & "," & rsBD.Fields("pa30"), , strB2, strSpeed, , , , strTo, strCC)
        '---------
        'ex:【已送件-實審】可請款發文(email) Our Ref: FCP-0XXXXX [INCOM.416]
        'Modified by Lydia 2023/03/23 請將(Murgitroyd案優先)移至主旨前面，以便承辦可以快速辨認(by Bobbie); +PUB_GetSetMailSubF2
        strSubject = PUB_GetSetMailSubF2("" & rsBD.Fields("pa75")) & "【已送件-" & rsBD.Fields("cp10n") & " X1】" & IIf(pChkType <> "0", "請進行請款 ( X2)", "可請款發文( X2)") & " Our Ref: " & rsBD.Fields("cp01") & "-" & rsBD.Fields("cp02") & IIf(rsBD.Fields("cp03") <> "0", "-" & rsBD.Fields("cp03"), "") & IIf(rsBD.Fields("cp04") <> "00", "-" & rsBD.Fields("cp04"), "") & " [INCOM." & rsBD.Fields("cp10") & "]"
        
        'Added by Lydia 2024/03/13
        If "" & rsBD.Fields("pa150") = "4" Then
           strSubject = "【機械設計組】" & strSubject
        End If
        'end 2024/03/13
        
        '優先主旨: 特殊請款>當天報告>已收款>一般
        strB1 = ""
        If pChkType = "1" Then
            '實審+主動修正
            'Modified by Lydia 2022/03/09 +CP07
            'Modified by Lydia 2024/03/13
            'strB1 = "select cpm03,cp14,sqldatet(cp07) cp07 from caseprogress,casepropertymap where cp01='" & rsBD.Fields("cp01") & "' and cp02='" & rsBD.Fields("cp02") & "'  and cp03='" & rsBD.Fields("cp03") & "' and cp04='" & rsBD.Fields("cp04") & "' " & _
                        "and cp158=0 and cp159=0 and cp10='203' and cp01=cpm01(+) and cp10=cpm02(+) "
            strB1 = "select cpm03,cp14,sqldatet(cp07) cp07,st52 from caseprogress,casepropertymap,staff where cp01='" & rsBD.Fields("cp01") & "' and cp02='" & rsBD.Fields("cp02") & "'  and cp03='" & rsBD.Fields("cp03") & "' and cp04='" & rsBD.Fields("cp04") & "' " & _
                        "and cp158=0 and cp159=0 and cp10='203' and cp01=cpm01(+) and cp10=cpm02(+) and cp14=st01(+)"
            intB = 1
            Set rsQuery = ClsLawReadRstMsg(intB, strB1)
            If intB = 0 Then
               strB1 = ""
            Else
               strB1 = "," & rsQuery.Fields("cpm03")
               'Added by Lydia 2022/03/09 email主旨加上主動修正的法限
               If "" & rsQuery.Fields("cp07") <> "" Then
                   strB1 = strB1 & "(法限" & Right(rsQuery.Fields("cp07"), 5) & ")"  'ex.(法限08/06)
               End If
               'end 2022/03/09
               strAddCPn = "203" & strB1
               str203CP14 = "" & rsQuery.Fields("cp14")
               'Added by Lydia 2024/03/13 外專機械設計組人員異動調整程式
               If Mid(str203CP14, 4, 1) = "9" And Mid(str203CP14, 1, 1) <> "F" Then
                  str203CP14 = "" & rsQuery.Fields("st52")  '收件者帶入外專對接主管
               End If
               'end 2024/03/13
            End If
        ElseIf pChkType = "2" Then
            strB1 = strB1 & ",特殊請款"
        End If
        
        If pRecDate = "Y" Then strB1 = strB1 & ",當天報告"
        If pPaid = "1" Then
             strB1 = strB1 & ",已收款不寄D/N"
        ElseIf pPaid = "2" Then
            strB1 = strB1 & ",已收款寄D/N"
        End If
        If strB1 <> "" Then
           strSubject = Replace(strSubject, " X1", "-" & Mid(strB1, 2))
        Else
           strSubject = Replace(strSubject, " X1", "")
        End If
        '速別: e/E化
        strB1 = ""
        If strSpeed <> "" Then
             strB1 = strB1 & "," & strSpeed '抓承辦單設定FcpEmpBill
        Else
            '預設速別
            strSpeed = GetFCPEmpSpeed(pStrType, "" & rsBD.Fields("fcna01"))
            '平信改掛號 --因為2020/02/21郵局業務調整
            If strSpeed <> "" Then strSpeed = Replace(strSpeed, "平信", "掛號")
            strB1 = strB1 & "," & strSpeed
        End If
        If strB1 = "" Or (pChkType <> "" And pChkType <> "0" And strSpeed = "") Then   '特殊請款要判斷有無承辦單特殊設定
           strSubject = Replace(strSubject, "( X2)", "")
        Else
           strSubject = Replace(strSubject, " X2", Mid(strB1, 2))
        End If
        
        '內文
        intR = 1
        '抓承辦單設定FcpEmpBill
        If strB2 <> "" Then
           '若有換行，前面加3空白
           strContent = strContent & intR & ". " & Replace(strB2, Chr(13) & Chr(10), Chr(13) & Chr(10) & "　") & vbCrLf
           intR = intR + 1
        End If
        
        '處理方式
        If pChkType = "1" Then '實審+主動修正
            '1.  實審+主動修正已於xx月xx日(抓發文日)完成送件,請進行email請款流程
            '2.  請完成請款信及請款金額後通知承辦及程序(管制人員)
            strB1 = "" & rsBD.Fields("cp27")
            If strB1 = "" Then strB1 = IIf(pStartDate <> "", pStartDate, strSrvDate(1))
            strContent = strContent & intR & ". " & rsBD.Fields("cp10n") & "+" & Mid(strAddCPn, 5) & "已於" & ChangeTStringToWDateString(strB1) & "完成送件,請進行email請款流程。" & vbCrLf
            intR = intR + 1
            If "" & rsBD.Fields("pa150") <> "3" Then 'Added by Lydia 2021/04/13 增加判斷, 實體審查+主動修正 發文,若為日文組案件Email通知請刪除第2.; 因為日文組和英文組做法不同
                strContent = strContent & intR & ". 請完成請款信及請款金額後通知 " & GetStaffName(PUB_GetFCPSalesNo(rsBD.Fields("cp01"), rsBD.Fields("cp02"), rsBD.Fields("cp03"), rsBD.Fields("cp04"), rsBD.Fields("cp10"))) & " 及 " & GetStaffName(PUB_GetFCPHandler(rsBD.Fields("cp01"), rsBD.Fields("cp02"), rsBD.Fields("cp03"), rsBD.Fields("cp04"), rsBD.Fields("cp10"))) & "。" & vbCrLf
                intR = intR + 1
            End If  'Added by Lydia 2021/04/13
        ElseIf pChkType = "2" Then
            strContent = strContent & intR & ". 特殊請款，請進行人工請款作業。" & vbCrLf
            intR = intR + 1
        Else
            If pRecDate = "Y" Then '當天報告
                   strContent = strContent & intR & ". 送件日當天報告。" & vbCrLf
                   intR = intR + 1
            End If
            If pPaid = "1" Then  '不寄DN
                   strContent = strContent & intR & ". D/N已會財務處。" & vbCrLf
                   intR = intR + 1
            End If
            If pPaid = "2" Then  '寄DN
                   strContent = strContent & intR & ". D/N已加蓋PAID章，D/N已會財務處。" & vbCrLf
                   intR = intR + 1
            End If
             If pStrType = "" Or pStrType = "E" Then
                   '大E,E+寄　；紙本
                   strContent = strContent & intR & ". 已出紙本，程序請整理請款紙本會承辦寄出。" & vbCrLf
                   intR = intR + 1
            End If
        End If
        
        '收據下載日
        If pStrType = "" Then   '紙本
            'Modified by Lydia 2023/05/02 "。" => ，規費金額：NTD
            strContent = strContent & intR & ". 請印收據紙本，收據下載日：" & ChangeWStringToTDateString(pCP152) & IIf(Val("" & rsBD.Fields("cp84")) > 0, "，規費金額：NTD " & rsBD.Fields("cp84"), "") & vbCrLf
            intR = intR + 1
        Else
            'Modified by Lydia 2023/05/02 "。" => ，規費金額：NTD
            strContent = strContent & intR & ". 收據下載日：" & ChangeWStringToTDateString(pCP152) & IIf(Val("" & rsBD.Fields("cp84")) > 0, "，規費金額：NTD " & rsBD.Fields("cp84"), "") & vbCrLf
            intR = intR + 1
        End If
        
        '是否有存Typing2
        If pChkType = "2" Then '特殊請款
            strContent = strContent & intR & ". 請款定稿已存Typing2。" & vbCrLf
            intR = intR + 1
        ElseIf pChkType <> "1" And pChkType <> "2" Then
           If pStrType = "" Then
                strContent = strContent & intR & ". 請款定稿、帳單Backup回存卷宗區[paper.416]。" & vbCrLf
                intR = intR + 1
           Else  'e/E化
                strContent = strContent & intR & ". 請款定稿、帳單已存Typing2。" & vbCrLf
                intR = intR + 1
           End If
        End If
        
        '卷
        If pChkType = "1" Then
           strContent = strContent & intR & ". 卷在程序處。" & vbCrLf
           intR = intR + 1
        ElseIf pStrType = "e" Or pChkType = "2" Then
           strContent = strContent & intR & ". 卷將退檔。" & vbCrLf
           intR = intR + 1
        End If

        'Email收件人: 指定人員代號F001-FCP承辦管制人NA51、F002-FCP承辦管制人之主管、F011-FCP程序管制人NA16、F012-FCP程序管制人之主管、F021-承辦之工程師、F022承辦之工程師主管。
        If strTo = "" Then '無特殊設定，一般
           'Memo by Lydia 2021/01/26 當天報告、已收款不改收件人,依照特殊設定 / e化設定帶出收件人
           If pChkType = "1" Then '實審+主動修正
               strTo = str203CP14 & ";"
           ElseIf pChkType = "2" Or pStrType = "e" Then   '特殊請款單, e化
               'Modified by Lydia 2021/04/29 改為承辦管制人員
               'strTo = rsBD.Fields("cp13") & ";"
               strTo = "F001;"
           ElseIf pStrType = "E" Then
               'Modified by Lydia 2021/04/29 改為承辦管制人員
               'strTo = rsBD.Fields("cp13") & ";F011;"
               strTo = "F001;F011;"
           Else
               strTo = "F011;"
           End If
        Else
           strTo = Replace(strTo, ",", ";") & ";"
           strTo = Replace(Replace(Replace(Replace(Replace(Replace(strTo, "01;", "F001;"), "02;", "F002;"), "11;", "F011;"), "12;", "F012;"), "21;", "F021;"), "22;", "F022;")
        End If
        'Email副本收件人
        If strCC = "" Then '無特殊設定，一般
           'Memo by Lydia 2021/01/26 當天報告、已收款不改CC,依照特殊設定 / e化設定帶出CC
           If pChkType = "1" Then '實審+主動修正
               strCC = PUB_GetFCPEngSup(str203CP14) & ";F011;backup;"
           ElseIf pChkType = "2" Or pStrType = "e" Then '特殊請款單, e化
               'Modified by Lydia 2021/04/29 改為承辦管制人之主管
               'strCC = PUB_GetFCPProSup("" & rsBD.Fields("cp13"))
               'strCC = strCC & ";F011;backup;"
               strCC = strCC & "F002;F011;backup;"
           ElseIf pStrType = "E" Then  'E化
               'Modified by Lydia 2021/04/29 改為承辦管制人之主管
               'strCC = PUB_GetFCPProSup("" & rsBD.Fields("cp13"))
               'strCC = strCC & ";backup;"
               strCC = strCC & "F002;backup;"
           Else    '紙本
               'strCC = "F012;" 'Remove by Lydia 2021/02/23 收件人只有程序,不用CC主管
           End If
        '不要副本
        ElseIf strCC = "00;" Or strCC = "00" Then
              strCC = ""
        Else
           strCC = Replace(strCC, ",", ";") & ";"
           strCC = Replace(Replace(Replace(Replace(Replace(Replace(strCC, "01;", "F001;"), "02;", "F002;"), "11;", "F011;"), "12;", "F012;"), "21;", "F021;"), "22;", "F022;")
        End If
        
        '收件人當中有承辦,才預設CC回backup, 自動歸入卷宗區
        If (InStr(strTo & ";", "F001;") > 0 Or InStr(strTo & ";", "F002;") > 0) And InStr(strCC & ";", "backup;") = 0 Then
            strCC = strCC & "backup;"
        End If
        
        tmpArr1 = Split(strTo & ";" & strCC, ";")
        For intB = 0 To UBound(tmpArr1)
            'Memo by Lydia 2021/01/21 因為「實審+主動修正」才要通知主動修正之工程師和主管(F021;F022)，非實審或該案最後收文之工程師，所以特殊設定之通知工程師先隱藏。
            If Trim(tmpArr1(intB)) <> "" And InStr("F001;F002;F011;F012;", Trim(tmpArr1(intB))) > 0 Then
                If InStr(strTo & ";" & strCC, Trim(tmpArr1(intB))) > 0 Then '未置換
                   strB1 = ""
                   Select Case Trim(tmpArr1(intB))
                       Case "F001"  'FCP承辦
                            strB1 = PUB_GetFCPSalesNo(rsBD.Fields("cp01"), rsBD.Fields("cp02"), rsBD.Fields("cp03"), rsBD.Fields("cp04"), rsBD.Fields("cp10"))
                            strTo = Replace(strTo, "F001;", strB1 & ";")
                            strCC = Replace(strCC, "F001;", strB1 & ";")
                       Case "F002"  'FCP承辦主管
                            strB1 = PUB_GetFCPProSup(PUB_GetFCPSalesNo(rsBD.Fields("cp01"), rsBD.Fields("cp02"), rsBD.Fields("cp03"), rsBD.Fields("cp04"), rsBD.Fields("cp10")))
                            strTo = Replace(strTo, "F002;", strB1 & ";")
                            strCC = Replace(strCC, "F002;", strB1 & ";")
                       Case "F011"  'FCP程序
                            strB1 = PUB_GetFCPHandler(rsBD.Fields("cp01"), rsBD.Fields("cp02"), rsBD.Fields("cp03"), rsBD.Fields("cp04"), rsBD.Fields("cp10"))
                            strTo = Replace(strTo, "F011;", strB1 & ";")
                            strCC = Replace(strCC, "F011;", strB1 & ";")
                       Case "F012"  'FCP程序主管
                            strB1 = PUB_GetFCPProSup(PUB_GetFCPHandler(rsBD.Fields("cp01"), rsBD.Fields("cp02"), rsBD.Fields("cp03"), rsBD.Fields("cp04"), rsBD.Fields("cp10")))
                            strTo = Replace(strTo, "F012;", strB1 & ";")
                            strCC = Replace(strCC, "F012;", strB1 & ";")
                   End Select
                End If
            End If
        Next intB
        
        'Added by Lydia 2022/04/12 將[實審請款]及[領證、年費請款] ，發文後自動發Outlook請款通知信中的C.C.人員請增加發文人員本身。(因為發文工作轉交非管制人員負責)
        If InStr(strCC, strUserNum) = 0 Then strCC = strUserNum & ";" & strCC
        
        If pType = "1" Then '1-直接存檔
            strB1 = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08,mc09)" & _
                        "values('" & strUserNum & "','" & strTo & "',to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss')" & _
                        ",'" & ChgSQL(strSubject) & "','" & ChgSQL(strContent) & "'," & CNULL(strCC) & ")"
            cnnConnection.Execute strB1, intI
        ElseIf pType = "2" Then '2-回傳
            pMC02 = strTo
            pMC07 = strSubject
            pMC08 = strContent
            pMC09 = strCC
        End If
    End If
   
    Set rsBD = Nothing
End Sub

'Added by Lydia 2021/01/19 外專承辦單：預設速別設定
Private Function GetFCPEmpSpeed(ByVal m_EmailType As String, ByVal m_Na01 As String) As String
Dim m_Speed As String

   If m_EmailType = "E" Then 'E+寄
      If m_Na01 = "011" Then '日本
         m_Speed = "Email+平信"
      ElseIf m_Na01 = "101" Then '美國
         m_Speed = "Email+掛號"
      Else
         m_Speed = "Email+平信"
      End If
   ElseIf m_EmailType = "e" Then 'E化
      m_Speed = "Email"
   Else '非E化
      If m_Na01 = "011" Then '日本
         m_Speed = "掛號"
      ElseIf m_Na01 = "101" Then '美國
         m_Speed = "掛號"
      Else
         m_Speed = "平信"
      End If
   End If
   GetFCPEmpSpeed = m_Speed
End Function

'Added by Morgan 2021/8/31
'設定 EMail 通知的期限及繳費年度
'In:  pCP09=通知函收文號
'Out: pOurDate=本所期限, pLawDate=法定期限, pNextYearDesc=下次繳費年度
Public Function PUB_SetDateAndFeeYear(pCP09 As String, pOurDate As String, pLawDate As String, pNextYearDesc As String)
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   Dim arrKey(4) As String, strNextYear As String
   
   pOurDate = "": pLawDate = "": pNextYearDesc = ""
   If Left(pCP09, 1) = "D" Then
      stSQL = "select sqldatet(cp06) dt1,sqldatet(cp07) dt2,np02,np07,np06,pa01,pa02,pa03,pa04,pa08,pa09,lastyear(pa72) lstyr" & _
         " from caseprogress,nextprogress,patent" & _
         " where cp09='" & pCP09 & "' and np01(+)=cp43 and np22(+)=cp30 and np01 is not null" & _
         " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04"
      intQ = 1
      Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
      If intQ = 1 Then
         
         pOurDate = "" & rsQuery("dt1") '本所期限
         pLawDate = "" & rsQuery("dt2") '法定期限
         '專利年費要抓待繳年度
         If Not IsNull(rsQuery("pa01")) Then
            If InStr("605,606,607", rsQuery("np07")) > 0 Then
               '未收文才帶
               If IsNull(rsQuery("np06")) Then
                  arrKey(1) = rsQuery("pa01")
                  arrKey(2) = rsQuery("pa02")
                  arrKey(3) = rsQuery("pa03")
                  arrKey(4) = rsQuery("pa04")
                  strNextYear = PUB_GetNextYear(arrKey, pNextYearDesc)
               End If
            End If
         End If
      End If
   End If
End Function

'Add By Sindy 2018/10/25 發明人英文名稱格式化
'Move by Lydia 2022/03/04 從basFunction搬過來
Public Function PUB_FCPIN05Format_EName(strIN05 As String, strNationNm As String, _
   Optional ByRef strEWord1 As String, Optional ByRef strEWord2 As String) As String
Dim varTemp As Variant
   
   strEWord1 = "               " 'Add By Sindy 2016/8/10
   strEWord2 = "" 'Add By Sindy 2016/8/10
   If strIN05 = "" Then Exit Function 'Add By Sindy 2018/10/26
   varTemp = Split(strIN05, ",")
   If LenB(Trim(varTemp(0))) > 12 Then
      'Modify By Sindy 2016/10/18 姓:全部大寫,日本除外
      'Modify By Sindy 2018/10/25 敏莉:剛剛和日本區的承辦人討論後，他們決定申請書"姓"，"名"的格式就和大家統一就好，故請將代理人為日本的排除拿掉
'      If strNationNm = "日本" Then
'         strEWord1 = Trim(varTemp(0)) & " "
'      Else
         If UBound(varTemp) > 0 Then
            strEWord1 = UCase(Trim(varTemp(0))) & " "
         Else
            strEWord1 = Trim(varTemp(0)) & " "
         End If
'      End If
      '2016/10/18 END
   Else
      'Modify By Sindy 2016/10/18 姓:全部大寫,日本除外
'      If strNationNm = "日本" Then
'         strEWord1 = convForm(CheckStr(Trim(varTemp(0))), 12)
'      Else
         If UBound(varTemp) > 0 Then
            strEWord1 = convForm(CheckStr(UCase(Trim(varTemp(0)))), 12)
         Else
            strEWord1 = convForm(CheckStr(Trim(varTemp(0))), 12)
         End If
'      End If
      '2016/10/18 END
   End If
   If UBound(varTemp) > 0 Then
      'Modify By Sindy 2016/10/18 名:第一個字大寫其他全部小寫,日本除外
'      If strNationNm = "日本" Then
'         strEWord2 = Trim(varTemp(1))
'      Else
         'Modify By Sindy 2018/12/10 BRADLEY, JR., Richard A. => Jr. 錯的
         'strEWord2 = StrConv(Trim(varTemp(1)), vbProperCase)
         'Modified by Lydia 2018/12/11 FCP-59900新案申請書出錯
         'strEWord2 = StrConv(Mid(Replace(UCase("" & RsTemp("IN05")), UCase(Trim(strEWord1)), ""), 2), vbProperCase)
         'Modified by Lydia 2018/12/11 FCP-60099新案申請書出錯
         strEWord2 = StrConv(Mid(Mid(UCase(Trim(strIN05)), Len(Trim(strEWord1)) + 1), 2), vbProperCase)
         '2018/12/10 END
         'Modify By Sindy 2017/8/16 ”-”後的第一個英文字也要大寫
         If InStr(strEWord2, "-") > 0 Then
            strEWord2 = Left(strEWord2, InStr(strEWord2, "-") - 1) & "-" & StrConv(Mid(strEWord2, InStr(strEWord2, "-") + 1), vbProperCase)
         End If
         '2017/8/16 END
'      End If
      '2016/10/18 END
   End If
   
   If InStr(strIN05, ",") > 0 Then
      PUB_FCPIN05Format_EName = Trim(strEWord1) & ", " & Trim(strEWord2)
   Else
      PUB_FCPIN05Format_EName = strEWord1 & " " & strEWord2
   End If
End Function

'Move by Lydia 2022/03/04 從basFunction搬過來
Public Function PUB_ConvertNameFormat(pName As String) As String
   Dim strTmp As String
   
   'Modify By Sindy 2020/11/11 And pName <> "後補" : 不要加,
   If InStr(pName, ",") = 0 And pName <> "後補" Then
      strTmp = Left(pName, 1) & "," & Mid(pName, 2)
   Else
      strTmp = pName
   End If
   PUB_ConvertNameFormat = strTmp
End Function

'Added by Lydia 2022/03/03 讀取申請書的發明人資料; 因為basLetter.BeforePrintGetDBData申請書發明人資料,要共用
'Move by Lydia 2022/03/04 從basFunction搬過來
Public Function PUB_GetFormatInventor(ByVal pCP01 As String, ByVal pCP02 As String, ByVal pCP03 As String, ByVal pCP04 As String, ByVal bolShowEng As Boolean, Optional ByVal pType As String = "2") As String
'pType: 1-申請書的格式, 2-基本表的格式
Dim PTitle As String '發明人,新型創作人,設計人
Dim strQ1 As String, intQ As Integer, intJ As Integer
Dim rsQD As New ADODB.Recordset
Dim strPA26 As String, strPA27 As String, strPA28 As String, strPA29 As String, strPA30 As String
   
   PUB_GetFormatInventor = ""
   
   'Modify By Sindy 2022/4/29 讀取專利基本資料檔
   'Added by Lydia 2022/04/19 另外抓專利種類
   strQ1 = "SELECT PA08,PA26,PA27,PA28,PA29,PA30 FROM PATENT WHERE PA01='" & pCP01 & "' AND PA02='" & pCP02 & "' AND PA03='" & pCP03 & "' AND PA04='" & pCP04 & "' "
   intQ = 1
   Set rsQD = ClsLawReadRstMsg(intQ, strQ1)
   If intQ = 1 Then
      If "" & rsQD("pa08") = "1" Then
         PTitle = "發明人"
      ElseIf "" & rsQD("pa08") = "2" Then
         PTitle = "新型創作人"
      Else
         PTitle = "設計人"
      End If
      strPA26 = "" & rsQD.Fields("PA26")
      strPA27 = "" & rsQD.Fields("PA27")
      strPA28 = "" & rsQD.Fields("PA28")
      strPA29 = "" & rsQD.Fields("PA29")
      strPA30 = "" & rsQD.Fields("PA30")
   Else
      Exit Function
   End If
   'end 2022/04/19
   '專利處
   If Left(Pub_StrUserSt03, 2) = "P1" Then '檢查是否要出英文~
      '是否有收文946.摘要英譯
      strQ1 = "SELECT cp09 FROM caseprogress WHERE CP01='" & pCP01 & "' AND CP02='" & pCP02 & "'" & _
              " AND CP03='" & pCP03 & "' AND CP04='" & pCP04 & "' AND CP10='946' AND cp57 is null"
      intQ = 1
      Set rsQD = ClsLawReadRstMsg(intQ, strQ1)
      If intQ = 1 Then
         bolShowEng = True
      End If
      If strPA26 <> "" Then
         If GetPrjNationNumber1(strPA26) > "010" Then bolShowEng = True
      End If
      If strPA26 <> "" Then
         If GetPrjNationNumber1(strPA26) > "010" Then bolShowEng = True
      End If
      If strPA26 <> "" Then
         If GetPrjNationNumber1(strPA26) > "010" Then bolShowEng = True
      End If
      If strPA26 <> "" Then
         If GetPrjNationNumber1(strPA26) > "010" Then bolShowEng = True
      End If
      If strPA26 <> "" Then
         If GetPrjNationNumber1(strPA26) > "010" Then bolShowEng = True
      End If
   End If
   '2022/4/29 END
   
   strQ1 = " SELECT IN03,IN04,IN05,IN11,NA72,pa08 " & _
               " FROM PatentInventor,INVENTOR,NATION,patent " & _
               " WHERE pi01=" + CNULL(pCP01) + " and pi02=" + CNULL(pCP02) + " and pi03=" + CNULL(pCP03) + " and pi04=" + CNULL(pCP04) & _
               " AND IN01=substr(pi06,1,8) AND IN02=substr(pi06,9,2)" & _
               " AND NA01(+)=IN11" & _
               " and pi01=pa01(+) and pi02=pa02(+) and pi03=pa03(+) and pi04=pa04(+)" & _
               " order by pi05 asc"
   intQ = 1
   Set rsQD = ClsLawReadRstMsg(intQ, strQ1)
   intJ = 1
   If intQ = 1 Then
      rsQD.MoveFirst
      Do While Not rsQD.EOF
         'Modify By Sindy 2018/4/16 Mark:不要空行
         'If pub_getformatinventor <> "" Then pub_getformatinventor = pub_getformatinventor & vbCrLf
         'Modify By Sindy 2018/6/27 敏莉說有ID資料要顯示出來
         'Modify By Sindy 2018/7/9 柏翰說英文相關欄位不顯示
         'Modify By Sindy 2018/10/25 增加英文名稱格式化 PUB_FCPIN05Format_EName
         'Modify By Sindy 2019/5/17 中文名稱3個字的也要加逗號
         'Modify By Sindy 2020/2/7 發明人非台灣國籍時,ID均不顯示
         'If PUB_GetFormatInventor <> "" Then PUB_GetFormatInventor = PUB_GetFormatInventor & IIf(pType = "1", vbCrLf, vbCrLf & vbCrLf) 'Add By Sindy 2019/5/30
         If PUB_GetFormatInventor <> "" Then PUB_GetFormatInventor = PUB_GetFormatInventor & vbCrLf & vbCrLf 'Add By Sindy 2022/5/2
         If pType = "1" Then '1-申請書的格式
          PUB_GetFormatInventor = PUB_GetFormatInventor & "【" & PTitle & intJ & "】" & _
                                                 vbCrLf & "　　【國籍】　　　　　　　　　" & rsQD("NA72") & _
                                                 vbCrLf & "　　【中文姓名】　　　　　　　" & IIf("" & rsQD("IN11") = "000" Or Len(ChgSQL("" & rsQD("IN04"))) = 3, PUB_ConvertNameFormat(ChgSQL("" & rsQD("IN04"))), ChgSQL("" & rsQD("IN04")))
            '外專,或專利處要顯示英文或非台灣國籍時
            If Left(Pub_StrUserSt03, 2) <> "P1" Or (Left(Pub_StrUserSt03, 2) = "P1" And (bolShowEng = True Or "" & rsQD("IN11") <> "000")) Then
               PUB_GetFormatInventor = PUB_GetFormatInventor & vbCrLf & "　　【英文姓名】　　　　　　　" & ChgSQL(PUB_FCPIN05Format_EName("" & rsQD("IN05"), "" & rsQD("NA72")))
            End If
            
         Else '2-基本表的格式
            If PUB_GetFormatInventor = "" Then
               PUB_GetFormatInventor = "　"
            Else
               PUB_GetFormatInventor = PUB_GetFormatInventor & "　　"
            End If
          PUB_GetFormatInventor = PUB_GetFormatInventor & "【" & PTitle & intJ & "】" & _
                                                 vbCrLf & "　　　【國籍】　　　　　　" & rsQD("NA72") & _
            IIf("" & rsQD("IN11") = "000", IIf(Left(Pub_StrUserSt03, 2) = "P1", vbCrLf & "　　　【ID】　　　　　　　" & rsQD("IN03"), IIf(rsQD("IN03") <> "", vbCrLf & "　　　【ID】　　　　　　　" & rsQD("IN03"), "")), "") & _
                                                 vbCrLf & "　　　【中文姓名】　　　　" & IIf("" & rsQD("IN11") = "000" Or Len(ChgSQL("" & rsQD("IN04"))) = 3, PUB_ConvertNameFormat(ChgSQL("" & rsQD("IN04"))), ChgSQL("" & rsQD("IN04")))
            '外專,或專利處要顯示英文或非台灣國籍時
            If Left(Pub_StrUserSt03, 2) <> "P1" Or (Left(Pub_StrUserSt03, 2) = "P1" And (bolShowEng = True Or "" & rsQD("IN11") <> "000")) Then
               PUB_GetFormatInventor = PUB_GetFormatInventor & vbCrLf & "　　　【英文姓名】　　　　" & ChgSQL(PUB_FCPIN05Format_EName("" & rsQD("IN05"), "" & rsQD("NA72")))
            End If
         End If
         intJ = intJ + 1
         rsQD.MoveNext
      Loop
   Else
'Modify By Sindy 2018/6/27 修改都顯示出ID欄
'IIf(Left(Pub_StrUserSt03, 2) = "P1", "　　　【ID】　　　　　　　" & vbCrLf, "")
      'Added by Lydia 2022/06/20 區分申請書和基本表
      If pType = "1" Then
         PUB_GetFormatInventor = "【" & PTitle & intJ & "】" & _
                         vbCrLf & "　　【國籍】　　　　　　" & _
                         vbCrLf & "　　【中文姓名】　　　　"
          '外專,或專利處要顯示英文時
          If Not (Left(Pub_StrUserSt03, 2) = "P1" And bolShowEng = False) Then
             PUB_GetFormatInventor = PUB_GetFormatInventor & vbCrLf & "　　【英文姓名】　　　　"
          End If
      Else
      'end 2022/06/20
         PUB_GetFormatInventor = "　【" & PTitle & intJ & "】" & _
                         vbCrLf & "　　　【國籍】　　　　　　" & _
                         vbCrLf & "　　　【ID】　　　　　　　" & _
                         vbCrLf & "　　　【中文姓名】　　　　"
          '外專,或專利處要顯示英文時
          If Not (Left(Pub_StrUserSt03, 2) = "P1" And bolShowEng = False) Then
             PUB_GetFormatInventor = PUB_GetFormatInventor & vbCrLf & "　　　【英文姓名】　　　　"
          End If
      End If 'Added by Lydia 2022/06/20
   End If
   Set rsQD = Nothing

End Function

'Added by Morgan 2020/2/19
'財務編號
'Modified by Morgan 2023/4/11 +pSys
Public Function PUB_GetACCNO(pNo As String, Optional pSys As String) As String
   Dim stSQL As String, iQ As Integer
   Dim RsQ As ADODB.Recordset
   Dim stSysID As String
   
   If Left(pNo, 1) = "Y" Then
      stSQL = "select NVL(FA28,FA106) AcNo,FA28 AcNoP,FA106 AcNoT from fagent where fa01='" & Left(pNo, 8) & "' and fa02='" & Mid(pNo, 9) & "'"
   Else
      stSQL = "select NVL(CU33,CU146) AcNo,CU33 AcNoP,CU146 AcNoT from customer where cu01='" & Left(pNo, 8) & "' and cu02='" & Mid(pNo, 9) & "'"
   End If
   iQ = 1
   Set RsQ = ClsLawReadRstMsg(iQ, stSQL)
   If iQ = 1 Then
      If pSys <> "" Then
         stSysID = CheckSys(pSys)
         If stSysID = "2" Or stSysID = "6" Then
            PUB_GetACCNO = "" & RsQ(2)
         Else
            PUB_GetACCNO = "" & RsQ(1)
         End If
      Else
         PUB_GetACCNO = "" & RsQ(0)
      End If
   End If
   
   Set RsQ = Nothing
End Function

'Added by Morgan 2022/4/7
'一案兩請以新型案號抓未發證之發明案相關資料
'IN:  PA01~PA04=新型案本所案號
'OUT: InvOurRef=發明案本所案號, InvAppNo=發明案申請案號, InvYourRef=發明案彼所案號, InvDesc=發明案狀態
Public Function PUB_GetDualCaseInvInfo(ByVal pa01 As String, ByVal pa02 As String, ByVal pa03 As String, ByVal pa04 As String, Optional ByRef InvOurRef As String, Optional ByRef InvAppNo As String, Optional ByRef InvYourRef As String, Optional ByRef InvDesc As String) As Boolean
   Dim stSQL As String, intR As Integer, strVTB As String
   Dim rstQ As ADODB.Recordset
   
   InvOurRef = "": InvAppNo = "": InvYourRef = "": InvDesc = ""
   
   strVTB = "select cm05,cm06,cm07,cm08 from patent,casemap" & _
      " where pa01='" & pa01 & "' and pa02='" & pa02 & "' and pa03='" & pa03 & "' and pa04='" & pa04 & "' and pa08='2'" & _
      " and cm01(+)=pa01 and cm02(+)=pa02 and cm03(+)=pa03 and cm04(+)=pa04 and cm10='3'" & _
      " union select cm01,cm02,cm03,cm04 from patent,casemap" & _
      " where pa01='" & pa01 & "' and pa02='" & pa02 & "' and pa03='" & pa03 & "' and pa04='" & pa04 & "' and pa08='2'" & _
      " and cm05(+)=pa01 and cm06(+)=pa02 and cm07(+)=pa03 and cm08(+)=pa04 and cm10='3'"
      
   stSQL = "select pa01||'-'||pa02||decode(pa03||pa04,'000','','-'||pa03||'-'||pa04) OurRef,pa11,pa16,pa77" & _
      " from (" & strVTB & "),patent where pa01(+)=cm05 and pa02(+)=cm06 and pa03(+)=cm07 and pa04(+)=cm08" & _
      " and pa08='1' and pa22 is null and pa57 is null"
   intR = 1
   Set rstQ = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      InvOurRef = rstQ("OurRef")
      InvAppNo = "" & rstQ("pa11")
      InvYourRef = "" & rstQ("pa77")
      If rstQ("pa16") = "1" Then
         InvDesc = "已核准但尚未發證"
      Else
         InvDesc = "尚未核准"
      End If
      PUB_GetDualCaseInvInfo = True
   End If
   Set rstQ = Nothing
End Function

'Added by Morgan 2022/4/6
'一案兩請新型年費逾繳/消滅函提醒
Public Sub PUB_DualCaseInform(ByVal CP09 As String)
   Dim stSQL As String, intR As Integer, strVTB As String
   Dim rstQ As ADODB.Recordset
   Dim strHandler As String, strTo As String, strCC As String
   Dim strSub As String, strCaseNo1 As String, strCaseNo2 As String
   Dim strDesc As String
   'Added by Morgan 2023/9/6
   Dim arrInv(4) As String
   Dim rstQ2 As ADODB.Recordset
   Dim bolNoMail As Boolean
   'end 2023/9/6
                  
   'Modified by Morgan 2023/9/6 +cp27
   stSQL = "select cp01,cp02,cp03,cp04,cp10,cp12,cp13,cp27" & _
      " from caseprogress,patent" & _
      " where cp09='" & CP09 & "' and cp10 in ('1604','1605')" & _
      " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04 and pa08='2'"
   intR = 1
   Set rstQ = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      'Added by Morgan 2023/9/6
      '未發文則新增待執行紀錄
      If IsNull(rstQ("cp27")) Then
         stSQL = "update WaitExeRec set WER02=WER02 where WER01='2' and WER02='" & CP09 & "'"
         cnnConnection.Execute stSQL, intR
         If intR = 0 Then
            stSQL = "insert into WaitExeRec(WER01,WER02) values('2','" & CP09 & "')"
            cnnConnection.Execute stSQL, intR
         End If
      '已發文則刪除待執行紀錄
      Else
         stSQL = "delete from WaitExeRec where wer01='2' and wer02='" & CP09 & "'"
         cnnConnection.Execute stSQL, intR
         If rstQ("cp27") > 19221111 Then
      'end 2023/9/6
            If PUB_GetDualCaseInvInfo(rstQ("CP01"), rstQ("CP02"), rstQ("CP03"), rstQ("CP04"), strCaseNo2, , , strDesc) Then
            
               'Added by Morgan 2023/9/6
               '下列情況不發EMmail通知
               '1.發明案已收到審查意見已逾法定期限，未收文或已不續辦。
               '2.發明案已收到核駁通知已逾法定期限，未收文或已不續辦。
               arrInv(1) = SystemNumber(strCaseNo2, 1)
               arrInv(2) = SystemNumber(strCaseNo2, 2)
               arrInv(3) = SystemNumber(strCaseNo2, 3)
               arrInv(4) = SystemNumber(strCaseNo2, 4)
               stSQL = "select np09 from caseprogress,nextprogress where cp01='" & arrInv(1) & "' and cp02='" & arrInv(2) & "' and cp03='" & arrInv(3) & "' and cp04='" & arrInv(4) & "'" & _
                  " and cp10 in ('1202','1002') and np01(+)=cp09 and nvl(np06,'N')='N' order by np09 desc"
               intR = 1
               Set rstQ2 = ClsLawReadRstMsg(intR, stSQL)
               If intR = 1 Then
                  If rstQ2("np09") < strSrvDate(1) Then
                     bolNoMail = True
                  End If
               End If
               If bolNoMail = False Then
               'end 2023/9/6
               
                  strCaseNo1 = rstQ("CP01") & "-" & rstQ("CP02") & IIf(rstQ("CP03") & rstQ("CP04") = "000", "", "-" & rstQ("CP03") & "-" & rstQ("CP04"))
                  strTo = rstQ("cp13")
                  strCC = ""
                  If rstQ("CP01") = "FCP" Or Left(rstQ("CP12"), 1) = "F" Then
                     strHandler = PUB_GetFCPHandler(rstQ("CP01"), rstQ("CP02"), rstQ("CP03"), rstQ("CP04"))
                     strCC = PUB_GetFCPProSup(strTo) & ";" & strHandler & ";" & PUB_GetFCPProSup(strHandler) & ";backup"
                     strSub = "一案兩請之新型案收到" & IIf(rstQ("cp10") = "1605", "年費逾繳函", "消滅函") & "且發明案" & strDesc & "，請確認是否須報告客戶。Our Ref: " & strCaseNo1 & " [INCOM." & rstQ("cp10") & "]"
                  Else
                     strSub = "一案兩請之新型案[" & strCaseNo1 & "]收到" & IIf(rstQ("cp10") = "1605", "年費逾繳函", "消滅函") & "且發明案[" & strCaseNo2 & "]" & strDesc & "，請提醒客戶。"
                  End If
                  
                  stSQL = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08,mc09)" & _
                        " values('" & strUserNum & "','" & strTo & "',to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss')" & _
                        ",'" & strSub & "','如旨','" & strCC & "')"
                  cnnConnection.Execute stSQL, intR
                  
               End If
            End If
         End If
      End If
   End If
   Set rstQ = Nothing
   Set rstQ2 = Nothing
End Sub

'Added by Morgan 2022/4/18
'以圖片方式列印Uncode文字
'pText=Uncode文字,Px=X座標,Py=Y座標
Public Sub PUB_PrintUnicodeText(pUniText As String, Px As Long, Py As Long, Optional iGap As Integer = 50, Optional ByRef pPicture1 As Object)
   Dim ii As Integer
   Dim strWord As String
   Dim lPx As Long, lPy As Long
   Dim lTextWidth As Long 'Added by Morgan 2022/9/20
   Dim bolPicture As Boolean 'Added by Morgan 2024/2/23
   
   If TypeName(pPicture1) = "PictureBox" Then
      bolPicture = True
   End If
   
   'Added by Morgan 2022/8/4
   If Not PUB_ChkUnicod(pUniText) And iGap = 0 Then
      If bolPicture Then
         pPicture1.CurrentX = Px
         pPicture1.CurrentY = Py
         pPicture1.Print pUniText
      Else
         Printer.CurrentX = Px
         Printer.CurrentY = Py
         Printer.Print pUniText
      End If
   Else
   'end 2022/8/4
   
      lPx = Px: lPy = Py
      For ii = 1 To Len(pUniText)
         If bolPicture Then
            pPicture1.CurrentX = lPx
            pPicture1.CurrentY = lPy
         Else
            Printer.CurrentX = lPx
            Printer.CurrentY = lPy
         End If
         
         strWord = Mid(pUniText, ii, 1)
         If strWord = StrConv(StrConv(strWord, vbFromUnicode), vbUnicode) Then
            If bolPicture Then
               pPicture1.Print strWord
               lPx = lPx + pPicture1.TextWidth(strWord) + iGap
            Else
               Printer.Print strWord
               lPx = lPx + Printer.TextWidth(strWord) + iGap
            End If
         Else
            'Modified by Morgan 2022/5/3 Ext-B問題待解
            'If lstrlen(Mid(pUniText, ii, 2)) = 2 Then
            '   strWord = Mid(pUniText, ii, 2)
            '   ii = ii + 1
            '   PUB_PrintUnicodeWord strWord, lPx, lPy - 15
            'Else
            '   PUB_PrintUnicodeWord strWord, lPx, lPy
            'End If
            
            'Modified by Morgan 2022/9/20
            'PUB_PrintUnicodeWord strWord, lPx, lPy
            'lPx = lPx + Printer.TextWidth("　") + iGap
            PUB_PrintUnicodeWord strWord, lPx, lPy, lTextWidth, , pPicture1
            lPx = lPx + lTextWidth + iGap
            'end 2022/9/20
            If bolPicture Then
               pPicture1.Print
            Else
               Printer.Print 'Added by Morgan 2024/2/6 修正最後一字是Unicode而沒跳行問題(某些程式後續計算位置可能會有錯Ex:尾牙抽獎名條)
            End If
         End If
      Next
   End If
End Sub

'Added by Morgan 2024/2/6
'計算含Unidcode的字寬
Public Function PUB_GetPrintWidth(pUniText As String) As Long
   Dim ii As Integer
   Dim strWord As String
   Dim lTextWidth As Long, lWordWidth As Long
   
   lTextWidth = 0
   For ii = 1 To Len(pUniText)
      strWord = Mid(pUniText, ii, 1)
      If strWord = StrConv(StrConv(strWord, vbFromUnicode), vbUnicode) Then
         lTextWidth = lTextWidth + Printer.TextWidth(strWord)
      Else
         PUB_PrintUnicodeWord strWord, 0, 0, lWordWidth, True
         lTextWidth = lTextWidth + lWordWidth
      End If
   Next
   PUB_GetPrintWidth = lTextWidth
End Function

'Added by Morgan 2022/4/18
'以圖片方式列印Uncode文字
'pText=Uncode文字,Px=X座標,Py=Y座標
'Modified by Morgan 2022/9/20 +pWordWidth
'Modified by Morgan 2024/2/6 +pNoPrint:不印(列印前先計算寬度時會用)
Public Sub PUB_PrintUnicodeWord(pUniWord As String, Px As Long, Py As Long, Optional ByRef pWordWidth As Long, Optional pNoPrint As Boolean = False, Optional ByRef pPicture As Object)
   Const WM_PAINT = &HF
   Const WM_PRINT = &H317
   Const PRF_CLIENT = &H4&    ' Draw the window's client area.
   Const PRF_CHILDREN = &H10& ' Draw all visible child windows.
   Const PRF_OWNED = &H20&    ' Draw all owned windows.
   Dim rv As Long
   Dim bolEnglike As Boolean 'Added by Morgan 2022/9/20
   Dim Lx As Long, lY As Long
   Dim bolPicture As Boolean, iFSize As Integer 'Added by Morgan 2024/2/23
   
   If TypeName(pPicture) = "PictureBox" Then
      bolPicture = True
   End If
   
   With frmpic002
   'Modified by Morgan 2022/5/3
   '調整20號字以下用縮印的方式列印
   If bolPicture Then
      .lblWord.Font.Name = pPicture.Font.Name
      .lblWord.Font.Size = pPicture.Font.Size
   Else
      .lblWord.Font.Name = Printer.Font.Name
      .lblWord.Font.Size = Printer.Font.Size
   End If
   
   .lblUniText.Font.Name = .lblWord.Font.Name
   If .lblWord.Font.Size > .lblUniText.Font.Size Then
      .lblUniText.Font.Size = .lblWord.Font.Size
      .lblUniText.Height = .lblWord.Height
      .lblUniText.Width = .lblWord.Width
      .lblUniText.AutoSize = True
      .Picture1.Width = .lblUniText.Width + 60
      .Picture1.Height = .lblUniText.Height + 60
   End If
   .lblUniText.Caption = pUniWord
   
   'Added by Morgan 2022/9/20 德文可以轉換成英文寬度只有中文的一半
   bolEnglike = False
   .Text1 = pUniWord
   If Asc(.Text1) >= Asc("A") And Asc(.Text1) <= Asc("z") Then
      bolEnglike = True
      .lblUniText.Width = .lblUniText.Width / 2
      '.lblUniText.Height = .lblUniText.Height * 5 / 4
      .Picture1.Width = .lblUniText.Width + 60
      .Picture1.Height = .lblUniText.Height + 60
      .lblWord = pUniWord
   End If
   'end 2022/9/20
   
   If pNoPrint = False Then 'Added by Morgan 2024/2/6
   
      .Picture2.Width = .Picture1.Width
      .Picture2.Height = .Picture1.Height
      .Picture2.AutoRedraw = True
      
      rv = SendMessage(.Picture1.hWnd, WM_PAINT, .Picture2.hDC, 0)
      rv = SendMessage(.Picture1.hWnd, WM_PRINT, .Picture2.hDC, PRF_CHILDREN + PRF_CLIENT + PRF_OWNED)
      .Picture2.Picture = .Picture2.Image
      .Picture2.AutoRedraw = False
      'Modified by Morgan 2022/5/3 列印圖片Y軸要稍微下移否則會突出
      'Printer.PaintPicture .Picture2.Picture, Px, Py, .lblWord.Width, .lblWord.Height
      'Modified by Morgan 2022/9/20 德文字會下沉Y軸要稍微上移,中文字則改不下移否則底部可能會被切掉
      'Printer.PaintPicture .Picture2.Picture, pX, pY + Int(0.08 * .lblWord.Height), .lblWord.Width
      If bolEnglike Then
         If bolPicture Then
            pPicture.PaintPicture .Picture2.Picture, Px, Py - Int(0.14 * .lblWord.Height), .lblWord.Width, .lblWord.Height
         Else
            Printer.PaintPicture .Picture2.Picture, Px, Py - Int(0.14 * .lblWord.Height), .lblWord.Width, .lblWord.Height
         End If
      Else
         'Added by Morgan 2024/2/6 大字修正
         If bolPicture Then
            iFSize = pPicture.Font.Size
         Else
            iFSize = Printer.Font.Size
         End If
         
         If iFSize >= 72 Then
            Lx = Px + .lblWord.Width * 0.1: lY = Py + .lblWord.Height * 0.12 'Y軸向下微調
            If bolPicture Then
               pPicture.PaintPicture .Picture2.Picture, Lx, lY, .lblWord.Width * 0.9, .lblWord.Height * 0.9
            Else
               Printer.PaintPicture .Picture2.Picture, Lx, lY, .lblWord.Width * 0.9, .lblWord.Height * 0.9
            End If
         Else
         'end 2024/2/6
            If bolPicture Then
               pPicture.PaintPicture .Picture2.Picture, Px, Py, .lblWord.Width, .lblWord.Height
            Else
               Printer.PaintPicture .Picture2.Picture, Px, Py, .lblWord.Width, .lblWord.Height
            End If
         End If
      End If
      
   End If 'Added by Morgan 2024/2/6
   
   pWordWidth = .lblWord.Width
   'end 2022/9/20
   End With
   Unload frmpic002
End Sub
'Added by Morgan 2022/7/11
'檢查字串是否含Unicode
Public Function PUB_ChkUnicod(pText As String) As Boolean
   Dim ii As Integer, strWord As String
   For ii = 1 To Len(pText)
      strWord = Mid(pText, ii, 1)
      If strWord <> StrConv(StrConv(strWord, vbFromUnicode), vbUnicode) Then
         PUB_ChkUnicod = True
         Exit For
      End If
   Next
End Function
'Added by Morgan 2022/7/14
'英文轉全形
Public Function PUB_ConvFullChar(pText As String) As String
   Dim ii As Integer, iASC As Integer
   Dim stText As String, stChar As String
   
   For ii = 1 To Len(pText)
      stChar = Mid(pText, ii, 1)
      If stChar >= "A" And stChar <= "Z" Then
         stChar = Chr(Asc("Ａ") + Asc(stChar) - Asc("A"))
      ElseIf stChar >= "a" And stChar <= "v" Then
         stChar = Chr(Asc("ａ") + Asc(stChar) - Asc("a"))
      'w全形的asc有跳號
      ElseIf stChar >= "w" And stChar <= "z" Then
         stChar = Chr(Asc("ｗ") + Asc(stChar) - Asc("w"))
      End If
      stText = stText & stChar
   Next
   PUB_ConvFullChar = stText
End Function

'Added by Morgan 2022/7/20
'申請人已更名，通知重新簽署POA
'Modified by Morgan 2023/4/10 +pAfterReKeyIn
Public Sub PUB_POAInform(pPA01 As String, pPA02 As String, pPA03 As String, pPA04 As String, pCP09 As String, Optional pAfterReKeyIn As Boolean = False)
   Dim stSQL As String, intR As Integer, strNameList As String, strPro As String, strSal As String
   Dim rstQ As ADODB.Recordset
   Dim strSubj As String, strTo As String, strCC As String
   Dim ii As Integer
   Dim bolSendLater As Boolean 'Added by Morgan 2025/6/27
   Dim stPA89Memo  As String 'Add by Amy 2025/08/05
   
   bolSendLater = pAfterReKeyIn  'Added by Morgan 2025/6/27
   
   stSQL = ""
   For ii = 0 To 4
      If ii > 0 Then stSQL = stSQL & " union "
      'Modified by Morgan 2023/9/20 排除已閉卷FCP-061916--Sharon
      stSQL = stSQL & "select cu01||cu02||'('||rtrim(cu05||' '||cu88||' '||cu89||' '||cu90)||')' EName," & ii & " Srt" & _
         " from patent,customer where pa01='" & pPA01 & "' and pa02='" & pPA02 & "' and pa03='" & pPA03 & "' and pa04='" & pPA04 & "' and pa57 is null" & _
         " and substr(pa" & (26 + ii) & ",-1)<>'0' and cu01(+)=substr(pa" & (26 + ii) & ",1,8) and cu02(+)='0'"
   Next
   stSQL = stSQL & " order by Srt"
   intR = 1
   Set rstQ = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      Do While Not rstQ.EOF
         strNameList = strNameList & rstQ(0) & " "
         rstQ.MoveNext
      Loop
      
      'TO：該案程序、該案承辦、該案工程師
      'CC：該案程序主管、該案承辦主管、該案工程師主管、backup。
      
      'FMP(非寰華)不必通知程序
      If Pub_StrUserSt03 = "F22" Then
         strPro = PUB_GetFCPHandler(pPA01, pPA02, pPA03, pPA04)
         strTo = strPro & ";"
         strCC = PUB_GetFCPProSup(strPro) & ";"
         bolSendLater = False 'Added by Morgan 2025/6/27寰華案2次確認流程與內專不同要立即發信
         'Add by Amy 2025/08/05 後續准駁簡單報告=Y,輸C類來函[主旨]最前面加【請簡單報告】(內專也有用到此函數,故只針對外專判斷)-Winfrey
         If Pub_GetField("Patent", "pa01='" & pPA01 & "' And pa02='" & pPA02 & "' And pa03='" & pPA03 & "' And pa04='" & pPA04 & "'", "pa89") = "Y" Then
            stPA89Memo = "【請簡單報告】"
         End If
      End If
      
      strSal = PUB_GetFCPSalesNo(pPA01, pPA02, pPA03, pPA04)
      strTo = strTo & strSal & ";"
      strCC = strCC & PUB_GetFCPProSup(strSal) & ";"
      
      stSQL = "select cp14 from caseprogress where cp09='" & pCP09 & "' and cp14 is not null"
      intR = 1
      Set rstQ = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         strTo = strTo & rstQ("cp14") & ";"
         strCC = strCC & PUB_GetFCPEngSup(rstQ("cp14")) & ";"
      End If
      
      'Modify by Amy 2025/08/05 主旨 +stPA89Memo
      strSubj = stPA89Memo & "本案已收核駁函，下一程序需重新簽署POA且須遞交紙本，此申請人已有新名稱，" & Trim(strNameList) & "；Our Ref: " & pPA01 & "-" & pPA02 & IIf(pPA03 & pPA04 = "000", "", "-" & pPA03 & "-" & pPA04) & " [INCOM.1002]"
      'Modified by Morgan 2023/4/10 +pAfterReKeyIn
      'Modified by Morgan 2025/6/27 改用 bolSendLater 判斷是否延後寄信(2次確認完)
      stSQL = "insert into MailCache(MC01,MC02,MC03,MC04,MC07,MC08,MC09,MC12)" & _
               " values( '" & strUserNum & "','" & strTo & "'" & _
               ",to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss'),'" & ChgSQL(strSubj) & "','如旨','" & strCC & "'," & IIf(bolSendLater, "99999999", "0") & ")"
      cnnConnection.Execute stSQL, intR
      
   End If
End Sub
'Added by Morgan 2022/11/14
Public Sub Showfrmpic002(pMsg As String)
   Load frmpic002
   frmpic002.Label1.Caption = "PDF建立中...請稍候..."
   frmpic002.Show
   frmpic002.ZOrder 0
End Sub

'Added by Lydia 2022/11/25 改成共用模組
'Modfied by Lydia 2023/01/18 +分類 pType
Public Function PUB_GetITStoList(ByVal pFrmName As String, ByVal pKind As String, ByVal pKeyNo As String, ByVal bolSave As Boolean, ByVal bolAll As Boolean, _
          Optional ByVal pStrRes As String = "", Optional ByRef pFilePath As String, Optional ByVal pType As String) As Boolean
'pKind = ITS01
'bolSave : 是否存檔 , pFilePath: 檔案路徑
'bolAll: 是否含失效舊指示
'pStrRes  使用部門: 專利P,商標T
Dim bolRetry As Boolean '是否已發生錯誤且重試
Dim arrTmp As Variant, arrVarTmp As Variant
Dim strGrp As String
Dim strMid As String
Dim intJ As Integer, intK As Integer
Dim bVisible As Boolean 'Word是否顯示
Dim m_WordLeft As Long, m_WordTop As Long 'Word開啟位置
Dim strTitle(0 To 4) As String '清單Word輸出: 表首資料
Dim strCase(1 To 4) As String
Dim intQ As Integer, strQ1 As String
Dim rsQD As New ADODB.Recordset
     
     PUB_GetITStoList = False
     If pKind = "3" Then  '本所案號
         strTitle(0) = pKeyNo
         Call ChgCaseNo(strTitle(0), strCase)
         Call ClsPDCheckCaseCodeIsExist(strCase(1), strCase(2), strCase(3), strCase(4), strTitle(2), strTitle(3), strTitle(4), , strTitle(0))
         strTitle(1) = PUB_GetNationName(strTitle(0))  '申請國家名稱
         strTitle(0) = strCase(1) & "-" & strCase(2) & "-" & strCase(3) & "-" & strCase(4)
     Else
         strQ1 = "select fa01 No,fa04 name1,fa05||fa63||fa64||fa65 name2,fa06 name3,fa69 istatus,substr(na01,1,3) na01,na03" & _
                   " from fagent,nation where fa01 = '" & Mid(pKeyNo & "0000000", 1, 8) & "' and fa02='0' and fa10=na01(+)"
         strQ1 = strQ1 & " union select cu01 No,cu04 name1,cu05||cu88||cu89||cu90 name2,cu06 name3,cu80 istatus,substr(na01,1,3) na01,na03" & _
                   " from customer,nation where cu01 = '" & Mid(pKeyNo & "0000000", 1, 8) & "' and cu02='0' and cu10=na01(+) "
         intQ = 1
         Set rsQD = ClsLawReadRstMsg(intQ, strQ1)
         If intQ = 1 Then
             strTitle(0) = "" & rsQD.Fields("no")
             strTitle(1) = "" & rsQD.Fields("na03")
             strTitle(2) = "" & rsQD.Fields("name1")
             strTitle(3) = "" & rsQD.Fields("name2")
             strTitle(4) = "" & rsQD.Fields("name3")
         End If
     End If
     Set rsQD = Nothing
     
        '讀取各項指示
        'Modified by Lydia 2023/01/18 分類pType
        If Pub_GetInstructions(pFrmName, pKeyNo, strMid, pType, "W", bolAll, IIf(pStrRes <> "", Mid(pStrRes, 2), "")) = True Then
            bolRetry = False
            If Pub_NewWordDoc(g_WordAp, bVisible, m_WordLeft, m_WordTop) = False Then Exit Function
            
On Error GoTo ErrHandle01
            
            'Modified by Lydia 2023/01/18 +pType
            Call PrintITSheader(pKind, pKeyNo, strTitle, pStrRes, pType) '列印Word表頭
            
            arrTmp = Empty
            arrTmp = Split(strMid, "|;|") '分隔記錄
            For intJ = 0 To UBound(arrTmp)
                If Trim(arrTmp(intJ)) <> "" Then
                    arrVarTmp = Empty
                    arrVarTmp = Split(Trim(arrTmp(intJ)), "|+|") '分隔欄位|+|
                    g_WordAp.Selection.Collapse Direction:=wdCollapseStart
                    For intK = 0 To UBound(arrVarTmp)
                        If Trim(arrVarTmp(intK)) <> "" Then
                            Select Case intK
                                Case 0
                                    '預設格式: 文字靠左,首行凸排0.3公分
                                    If intJ = 0 Then
                                        g_WordAp.Selection.Paragraphs.Alignment = wdAlignParagraphLeft
                                        g_WordAp.Selection.ParagraphFormat.LeftIndent = g_WordAp.CentimetersToPoints(0.3)
                                        g_WordAp.Selection.ParagraphFormat.RightIndent = g_WordAp.CentimetersToPoints(0)
                                        g_WordAp.Selection.ParagraphFormat.FirstLineIndent = g_WordAp.CentimetersToPoints(-0.3)
                                    End If
                                    If strGrp <> arrVarTmp(intK) Then
                                       g_WordAp.Selection.Borders(wdBorderTop).LineStyle = wdLineStyleSingle
                                       g_WordAp.Selection.TypeText Text:=Trim(arrVarTmp(intK))
                                    Else
                                       g_WordAp.Selection.Borders(wdBorderTop).LineStyle = wdLineStyleNone
                                    End If
                                    strGrp = arrVarTmp(intK)
                                Case 1, 2
                                    '預設格式:文字置中
                                    If intJ = 0 And intK = 2 Then
                                        g_WordAp.Selection.Paragraphs.Alignment = wdAlignParagraphCenter
                                    End If
                                    'end 2020/06/11
                                    '記錄日期99999999=欄位設定
                                    
                                    g_WordAp.Selection.TypeText Text:=Trim(arrVarTmp(intK))
                            End Select
                        End If
                        g_WordAp.Selection.MoveRight Unit:=wdCharacter, Count:=1
                    Next intK
                    
                    If intJ < UBound(arrTmp) Then
                       g_WordAp.Selection.InsertRows
                       g_WordAp.Selection.Collapse Direction:=wdCollapseStart
                    End If
                End If
            Next intJ
            
            '還原Word位置
            Pub_RePosWord g_WordAp, bVisible, m_WordLeft, m_WordTop
            g_WordAp.Visible = True
            g_WordAp.WindowState = wdWindowStateMaximize
            g_WordAp.Activate
            
            g_WordAp.Selection.WholeStory
            g_WordAp.Selection.Font.Name = "Times New Roman"
            g_WordAp.Selection.EndKey Unit:=wdStory
            If bolSave = False Or pFilePath = "" Then
               MsgBox "Word清單已產生！"
            Else
               g_WordAp.ActiveDocument.SaveAs pFilePath
               g_WordAp.Quit
            End If
            Set g_WordAp = Nothing
        Else
            MsgBox "無清單！"

        End If 'Pub_GetInstructions
     PUB_GetITStoList = True
        
ErrHandle01:
   If Err.Number <> 0 Then
      Select Case Err.Number
         Case 91, 462:
            Set g_WordAp = New Word.Application
            g_WordAp.Documents.add
            If bolRetry = False Then
               bolRetry = True
               Resume
            End If
         Case Else:
            MsgBox "錯誤 : " & Err.Description, vbCritical
      End Select
   End If
End Function

'Added by Lydia 2022/11/25 列印Word表頭; 從frm12040159改成共用模組
'Modified by Lydia 2023/01/18 +分類 pType
Private Sub PrintITSheader(ByVal pKind As String, ByVal pKeyNo As String, ByRef PTitle() As String, ByVal pUseDept As String, Optional ByVal pType As String)
Dim strChk As String
    '邊界
    g_WordAp.Selection.PageSetup.LeftMargin = g_WordAp.CentimetersToPoints(2)
    g_WordAp.Selection.PageSetup.RightMargin = g_WordAp.CentimetersToPoints(2)
    g_WordAp.Selection.PageSetup.TopMargin = g_WordAp.CentimetersToPoints(2)
    g_WordAp.Selection.PageSetup.BottomMargin = g_WordAp.CentimetersToPoints(2)
    
    'Added by Lydia 2023/01/18 依據特定分類增加備註
    If pType = "Y01" Then
       g_WordAp.Selection.Font.Size = 16
       g_WordAp.Selection.Font.Bold = True
       g_WordAp.Selection.TypeText Text:="提醒：「此代理人有特殊告代及修正指示，若確認後仍須收文告代/主動修正，請通知承辦收文。」"
       g_WordAp.Selection.TypeParagraph
       g_WordAp.Selection.Font.Size = 12
       g_WordAp.Selection.Font.Bold = False
       g_WordAp.Selection.TypeParagraph
    End If
    'end 2023/01/16
    
    '新增表格(1X3)
    g_WordAp.Selection.Tables.add Range:=g_WordAp.Selection.Range, NumRows:=1, NumColumns:=3
    g_WordAp.Selection.SelectRow
    g_WordAp.Selection.Cells.VerticalAlignment = wdAlignVerticalTop
    g_WordAp.Selection.Paragraphs.Alignment = wdAlignParagraphLeft
    g_WordAp.Selection.Cells(1).SetWidth ColumnWidth:=g_WordAp.CentimetersToPoints(2.5), RulerStyle:=wdAdjustProportional
    g_WordAp.Selection.Cells(2).SetWidth ColumnWidth:=g_WordAp.CentimetersToPoints(12), RulerStyle:=wdAdjustProportional
    g_WordAp.Selection.Cells(3).SetWidth ColumnWidth:=g_WordAp.CentimetersToPoints(2.5), RulerStyle:=wdAdjustProportional

    g_WordAp.Selection.InsertRows 8
    g_WordAp.Selection.Collapse Direction:=wdCollapseStart
    g_WordAp.Selection.SelectRow
    g_WordAp.Selection.Cells.Merge
    g_WordAp.Selection.Cells.SetHeight RowHeight:=28, HeightRule:=wdRowHeightExactly '固定列高
    g_WordAp.Selection.Cells.VerticalAlignment = wdAlignVerticalCenter
    g_WordAp.Selection.ParagraphFormat.Alignment = wdAlignParagraphCenter
    g_WordAp.Selection.Font.Size = 16
    g_WordAp.Selection.Font.Bold = True
    g_WordAp.Selection.TypeText Text:="各項指示清單"
    g_WordAp.Selection.MoveDown Unit:=wdLine, Count:=2
    
    g_WordAp.Selection.SelectRow
    g_WordAp.Selection.Font.Size = 12
    g_WordAp.Selection.Font.Bold = False
    g_WordAp.Selection.SelectRow
    g_WordAp.Selection.Cells.Merge
    g_WordAp.Selection.ParagraphFormat.Alignment = wdAlignParagraphLeft
    strChk = convForm(IIf(pKind = "2", "申請人編號：", IIf(pKind = "1", "代理人編號：", "本所案號：")) & " " & PTitle(0), 30)
    strChk = strChk & convForm(IIf(pKind = "3", "申請國家：", "國籍：") & PTitle(1), 31)
    strChk = strChk & "列印日期：" & ChangeTStringToTDateString(strSrvDate(2))
    g_WordAp.Selection.TypeText Text:=strChk
    g_WordAp.Selection.MoveRight Unit:=wdCharacter, Count:=2
     
    g_WordAp.Selection.SelectRow
    g_WordAp.Selection.Cells.Merge
    g_WordAp.Selection.TypeText Text:="名稱(中)：" & PTitle(2)
    g_WordAp.Selection.MoveRight Unit:=wdCharacter, Count:=2
     
    g_WordAp.Selection.SelectRow
    g_WordAp.Selection.Cells.Merge
    g_WordAp.Selection.TypeText Text:="　　(英)：" & PTitle(3)
    g_WordAp.Selection.MoveRight Unit:=wdCharacter, Count:=2
     
    g_WordAp.Selection.SelectRow
    g_WordAp.Selection.Cells.Merge
    g_WordAp.Selection.TypeText Text:="　　(日)：" & PTitle(4)
    g_WordAp.Selection.MoveRight Unit:=wdCharacter, Count:=2
     
    If pType <> "Y01" Then 'Added by Lydia 2023/01/18 依據特定分類增加備註
      g_WordAp.Selection.SelectRow
      g_WordAp.Selection.Cells.Merge
      
      '使用部門+P.S
      pUseDept = Replace(pUseDept, ",", "、")
      pUseDept = Replace(pUseDept, ",P", "、P專利")
      pUseDept = Replace(pUseDept, ",T", "、T商標")
      pUseDept = convForm(IIf(pUseDept <> "", "使用部門：", "") & Mid(pUseDept, 2), 56) & "P.S 日期前有*為失效指示"
      g_WordAp.Selection.TypeText Text:=pUseDept
      '完成確認
      strChk = PUB_GetICstatus(pKeyNo)
      If strChk <> "" Then
          g_WordAp.Selection.MoveRight Unit:=wdCharacter, Count:=2
          g_WordAp.Selection.SelectRow
          g_WordAp.Selection.Cells.Merge
          g_WordAp.Selection.TypeText Text:="完成確認：" & strChk
          g_WordAp.Selection.MoveRight Unit:=wdCharacter, Count:=2
      Else
          g_WordAp.Selection.MoveRight Unit:=wdCharacter, Count:=2
      End If
    End If 'Added by Lydia 2023/01/18
    
    g_WordAp.Selection.SelectRow
    g_WordAp.Selection.ParagraphFormat.Alignment = wdAlignParagraphCenter
    g_WordAp.Selection.Borders(wdBorderLeft).LineStyle = wdLineStyleSingle
    g_WordAp.Selection.Borders(wdBorderRight).LineStyle = wdLineStyleSingle
    g_WordAp.Selection.Borders(wdBorderTop).LineStyle = wdLineStyleSingle
    g_WordAp.Selection.Borders(wdBorderBottom).LineStyle = wdLineStyleSingle
    g_WordAp.Selection.Borders(wdBorderHorizontal).LineStyle = wdLineStyleSingle
    g_WordAp.Selection.Borders(wdBorderVertical).LineStyle = wdLineStyleSingle
    g_WordAp.Selection.Borders.Shadow = False
    g_WordAp.Selection.Collapse Direction:=wdCollapseStart
    g_WordAp.Selection.TypeText Text:="分　　類"
    g_WordAp.Selection.MoveRight Unit:=wdCharacter, Count:=1
    g_WordAp.Selection.ParagraphFormat.Alignment = wdAlignParagraphCenter
    g_WordAp.Selection.TypeText Text:="內　　　　容"
    g_WordAp.Selection.MoveRight Unit:=wdCharacter, Count:=1
    g_WordAp.Selection.TypeText Text:="日　　期"
    g_WordAp.Selection.MoveRight Unit:=wdCharacter, Count:=1
    g_WordAp.Selection.InsertRows 1
    g_WordAp.Selection.SelectRow
    g_WordAp.Selection.ParagraphFormat.Alignment = wdAlignParagraphLeft
    g_WordAp.Selection.Collapse Direction:=wdCollapseStart

End Sub

'Added by Lydia 2022/11/25 取得各項指示之完成確認部門; 從frm12040159改成共用模組
Public Function PUB_GetICstatus(ByVal pKeyNo As String) As String
Dim intA As Integer, strA1 As String
Dim rsA1 As New ADODB.Recordset
      
      PUB_GetICstatus = ""
      strA1 = "Select Decode(Ic04,Null,Null,'、外專')||Decode(Ic06,Null,Null,'、內專')||Decode(Ic08,Null,Null,'、外商')||Decode(Ic10,Null,Null,'、內商') as ChkType " & _
                       "From Instconfirm where IC02='" & pKeyNo & "' "
      intA = 1
      Set rsA1 = ClsLawReadRstMsg(intA, strA1)
      If intA = 1 Then
          rsA1.MoveFirst
          Do While Not rsA1.EOF
              If "" & rsA1.Fields("ChkType") <> "" Then
                   PUB_GetICstatus = PUB_GetICstatus & Mid("" & rsA1.Fields("ChkType"), 2)
              End If
              rsA1.MoveNext
          Loop
      End If
      Set rsA1 = Nothing
End Function
'Added by Morgan 2022/12/26
'台灣有證書的案件性質
Public Function PUB_TWCertPty(pCP01 As String, pCP10 As String, Optional pCP02 As String, Optional pCP03 As String, Optional pCP04 As String) As Boolean
   Dim stSQL As String, intR As Integer
   Dim adoRst As ADODB.Recordset
      
   If pCP01 = "T" Or pCP01 = "FCT" Then
      If InStr("," & TMCertPtyList & ",", "," & pCP10 & ",") > 0 Then
         If pCP10 = "308" Then
            stSQL = "select * from trademark where tm01='" & pCP01 & "' and tm02='" & pCP02 & "' and tm03='" & pCP03 & "' and tm04='" & pCP04 & "' and tm20>0"
            intR = 1
            Set adoRst = ClsLawReadRstMsg(intR, stSQL)
            If intR = 1 Then
               PUB_TWCertPty = True
            End If
         Else
            PUB_TWCertPty = True
         End If
      End If
   ElseIf pCP01 = "P" Or pCP01 = "FCP" Then
      If InStr("," & PACertPtyList & ",", "," & pCP10 & ",") > 0 Then
         'Added by Morgan 2023/1/4 FCP發證後讓與也收701
         If pCP10 = "701" Then
            stSQL = "select * from patent where pa01='" & pCP01 & "' and pa02='" & pCP02 & "' and pa03='" & pCP03 & "' and pa04='" & pCP04 & "' and pa22 is not null"
            intR = 1
            Set adoRst = ClsLawReadRstMsg(intR, stSQL)
            If intR = 1 Then
               PUB_TWCertPty = True
            End If
         Else
         'end 2023/1/4
            PUB_TWCertPty = True
         End If
      End If
   End If
   
   Set adoRst = Nothing
End Function
'Added by Morgan 2022/12/5
'證書形式:個案->X->Y
Public Function PUB_GetCertType(pCP01 As String, pCP02 As String, pCP03 As String, pCP04 As String) As String
   Dim stSQL As String, intR As Integer
   Dim adoRst As ADODB.Recordset
   
   stSQL = "SELECT NVL(PA178,NVL(CU189,FA128)) TYP FROM PATENT,FAGENT,CUSTOMER WHERE PA01='" & pCP01 & "' AND " & _
      "PA02='" & pCP02 & "' AND PA03='" & pCP03 & "' AND PA04='" & pCP04 & "' AND " & _
      "FA01(+)=SUBSTR(PA75,1,8) AND FA02(+)=SUBSTR(PA75,9) AND " & _
      "CU01(+)=SUBSTR(PA26,1,8) AND CU02(+)=SUBSTR(PA26,9)" & _
      " UNION SELECT NVL(TM136,NVL(CU190,FA129)) TYP FROM TRADEMARK,FAGENT,CUSTOMER WHERE TM01='" & pCP01 & "' AND " & _
      "TM02='" & pCP02 & "' AND TM03='" & pCP03 & "' AND TM04='" & pCP04 & "' AND " & _
      "FA01(+)=SUBSTR(TM44,1,8) AND FA02(+)=SUBSTR(TM44,9) AND " & _
      "CU01(+)=SUBSTR(TM23,1,8) AND CU02(+)=SUBSTR(TM23,9)"
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      PUB_GetCertType = "" & adoRst(0)
   End If
   Set adoRst = Nothing
End Function

'Added by Morgan 2022/12/16
'FC案是否自動代繳領證/註冊費
Public Function PUB_FCAutoCert(pCP01 As String, pCP02 As String, pCP03 As String, pCP04 As String) As String
   Dim stSQL As String, intR As Integer
   Dim adoRst As ADODB.Recordset
   
   stSQL = "SELECT NVL(PA71,NVL(FA42,CU75)) TYP FROM PATENT,FAGENT,CUSTOMER WHERE PA01='" & pCP01 & "' AND " & _
      "PA02='" & pCP02 & "' AND PA03='" & pCP03 & "' AND PA04='" & pCP04 & "' AND " & _
      "FA01(+)=SUBSTR(PA75,1,8) AND FA02(+)=SUBSTR(PA75,9) AND " & _
      "CU01(+)=SUBSTR(PA26,1,8) AND CU02(+)=SUBSTR(PA26,9)" & _
      " UNION SELECT NVL(TM122,NVL(FA93,CU128)) TYP FROM TRADEMARK,FAGENT,CUSTOMER WHERE TM01='" & pCP01 & "' AND " & _
      "TM02='" & pCP02 & "' AND TM03='" & pCP03 & "' AND TM04='" & pCP04 & "' AND " & _
      "FA01(+)=SUBSTR(TM44,1,8) AND FA02(+)=SUBSTR(TM44,9) AND " & _
      "CU01(+)=SUBSTR(TM23,1,8) AND CU02(+)=SUBSTR(TM23,9)"
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      PUB_FCAutoCert = "" & adoRst(0)
   End If
   Set adoRst = Nothing
End Function

'Added by Lydia 2023/01/18 命名作業不可新增告代和主動修正
Public Function Pub_GetITSforHandle(ByVal pCaseNo, ByVal pFCno As String, ByVal pAppNo As String) As String
Dim tmpArr01 As Variant
Dim intC As Integer, rsCD As New ADODB.Recordset
Dim strC1 As String

    Pub_GetITSforHandle = ""
    If pCaseNo <> "" Then
       strC1 = "Select '1' as ord1, ITS02 from Instructions Where ITS03='Y01' and ITS05 is null and ITS02='" & pCaseNo & "' And ITS01 = " & CNULL(Pub_GetITS01Type(pCaseNo))
    End If
    If pFCno <> "" Then
       strC1 = strC1 & " Union Select '2' as ord1, ITS02 from Instructions Where ITS03='Y01' and ITS05 is null and ITS02='" & Left(ChangeCustomerL(pFCno), 8) & "' And ITS01 = " & CNULL(Pub_GetITS01Type(pFCno))
    End If
    If pAppNo <> "" Then
       tmpArr01 = Split(pAppNo, ",")
       For intC = 0 To UBound(tmpArr01)
           If Trim(tmpArr01(intC)) <> "" Then
              strC1 = strC1 & " Union Select '" & intC + 3 & "' as ord1, ITS02 from Instructions Where ITS03='Y01' and ITS05 is null and ITS02='" & Left(ChangeCustomerL(tmpArr01(intC)), 8) & "' And ITS01 = " & CNULL(Pub_GetITS01Type(tmpArr01(intC)))
           End If
       Next intC
    End If
    If strC1 <> "" Then
       strC1 = strC1 & " order by 1, 2"
       intC = 1
       Set rsCD = ClsLawReadRstMsg(intC, strC1)
       If intC = 1 Then
          rsCD.MoveFirst
          Do While Not rsCD.EOF
              Pub_GetITSforHandle = Pub_GetITSforHandle & "," & rsCD.Fields("ITS02")
              rsCD.MoveNext
          Loop
          If Pub_GetITSforHandle <> "" Then
              Pub_GetITSforHandle = Mid(Pub_GetITSforHandle, 2)
          End If
       End If
    End If
    Set rsCD = Nothing
End Function

'Added by Morgan 2023/2/15
Private Function CopyTMGoodsAtt() As Boolean
   Dim stSQL As String, intQ As Integer
   Dim rstQuery As ADODB.Recordset
   Dim stDocPath As String, stSrcDocPath As String
   
   stDocPath = App.path & "\" & strUserNum
   stSrcDocPath = stDocPath & "\$TEMP.doc"
   If Dir(stDocPath, vbDirectory) = "" Then
      MkDir stDocPath
   End If
   
   If Dir(stSrcDocPath) <> "" Then
      Kill stSrcDocPath
   End If
   
   stSQL = "select TGA09 from tmgoodsatt where tga01='" & m_MySt(1) & "' and tga02='" & m_MySt(2) & "' and tga03='" & m_MySt(3) & "' and tga04='" & m_MySt(4) & "'"
   intQ = 1
   Set rstQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      If PUB_GetFtpFile(rstQuery(0), stSrcDocPath, "TMGoodsAtt") Then
         g_WordAp.Documents.Open stSrcDocPath
         'Added by Morgan 2023/5/9 docx先全選再後轉存doc，否則貼上時若有顏色會變灰(沒全選最後的標題列會沒顏色) Ex:FCP-050525
         g_WordAp.Selection.EndKey Unit:=wdStory, Extend:=wdExtend
         g_WordAp.ActiveDocument.SaveAs FileName:=stSrcDocPath, FileFormat:=wdFormatDocument
         'end 2023/5/9
         g_WordAp.Selection.WholeStory
         g_WordAp.Selection.Copy
         g_WordAp.ActiveDocument.Close wdDoNotSaveChanges
         CopyTMGoodsAtt = True
      End If
   End If
   Set rstQuery = Nothing
End Function

'Added by Morgan 2023/2/22
'插入Word文件
Private Function InsWordDoc(pFileName As String, oWord As Word.Application) As Boolean
   Dim stSrcDocPath As String
   Dim stFile() As String, stID() As String
   
   If InStr(pFileName, "\") > 0 Then
      stSrcDocPath = pFileName
   Else
      stSrcDocPath = App.path & "\" & strUserNum
      stFile = Split(pFileName, " ")
      
      If PUB_GetSampleFile(stFile(1), stFile(0), , stSrcDocPath) = False Then
         Exit Function
      End If
      stSrcDocPath = stSrcDocPath & "\" & stFile(1)
   End If
      
   If Dir(stSrcDocPath) = "" Then
      Exit Function
   End If
   
   oWord.Documents.Open stSrcDocPath
   oWord.Selection.WholeStory
   oWord.Selection.Copy
   oWord.ActiveDocument.Close wdDoNotSaveChanges
   oWord.Selection.Paste
   oWord.Selection.TypeBackspace
   InsWordDoc = True
End Function

'Modified by Lydia 2023/03/23 從basPublic搬過來
'Added by Lydia 2022/09/23 外專MURGITROYD案：FC代理人Y2099001的Email主旨加註
Public Function PUB_GetSetMailSubF2(ByVal pNo As String) As String
   
   PUB_GetSetMailSubF2 = ""
   If pNo <> "" Then
       If InStr(Pub_GetSpecMan("外專MURGITROYD設定"), ChangeCustomerL(pNo)) > 0 Then
          PUB_GetSetMailSubF2 = "(Murgitroyd案)"
       End If
   End If
End Function
'Added by Morgan 2023/3/29
Public Function PUB_GetEntityType(pPA01 As String, pPA02 As String, pPA03 As String, pPA04 As String) As String
   Dim stSQL As String, intR As Integer
   Dim adoRst As ADODB.Recordset
   Dim stType As String
   
   stSQL = "SELECT pa179,pa91 FROM PATENT WHERE PA01='" & pPA01 & "' AND " & _
      "PA02='" & pPA02 & "' AND PA03='" & pPA03 & "' AND PA04='" & pPA04 & "'"
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      If strSrvDate(1) >= PA179啟用日 Then
         PUB_GetEntityType = "" & adoRst.Fields("pa179")
      Else
         If InStr(1, adoRst.Fields("pa91"), "大個體", 1) > 0 Then
            PUB_GetEntityType = "1"
         ElseIf InStr(1, adoRst.Fields("pa91"), "小個體", 1) > 0 Then
            PUB_GetEntityType = "2"
         ElseIf InStr(1, adoRst.Fields("pa91"), "微個體", 1) > 0 Then
            PUB_GetEntityType = "3"
         End If
      End If
   End If
   Set adoRst = Nothing
End Function

'Added by Morgan 2023/9/5
'CFP案B類發文/提申檢查
'PS:目前都在若增加案件性質要確認存檔前是否列印客戶函是會不會被變動，若會則要在存檔前呼叫
Public Function PUB_AskBKindLetter(cp01 As String, CP09 As String, CP10 As String, Optional pChoice As Integer = 0) As String
   Dim stPty As String
   If cp01 = "CFP" And Left(CP09, 1) = "B" And (CP10 = "204" Or CP10 = "107" Or CP10 = "424" Or CP10 = "218") Then
      Call ClsPDGetCaseProperty(cp01, CP10, stPty)
      If pChoice = 0 Or pChoice = 1 Then MsgBox "目前作業程序為【內部收文-" & stPty & "】，請檢視指示信是否有與代議價！", vbExclamation
      If pChoice = 0 Or pChoice = 2 Then
         If MsgBox("目前作業程序為【內部收文-" & stPty & "】，是否通知客戶？", vbQuestion + vbYesNo + vbDefaultButton2) = vbNo Then
            PUB_AskBKindLetter = "N"
         End If
      End If
   End If
End Function

'Added by Lydia 2022/06/13 是否屬於ACS案件中的TIPS及智財報告
'Modified by Lydia 2023/12/15 +bolCR1 判斷相關案號->若為ACS案進一步判斷是否為TIPS案
'Modify By Sindy 2024/5/10 + , Optional ByVal strAddChkCP10 As String = "": 接洽單有增加要檢查的案件性質(113=智財布局分析)
Public Function PUB_ChkACSforTIPS(ByVal pSysNo As String, Optional ByVal pSysPty As String, Optional ByVal bolCR1 As Boolean, _
   Optional ByVal strAddChkCP10 As String = "") As Boolean
'pSysNO:  新案傳入系統別，舊案傳入本所案號
'pSysPty:  新案傳入案件性質(可用,串接)
Dim pCase(1 To 4) As String
Dim intP As Integer, strP1 As String
Dim rsPD As New ADODB.Recordset
Dim tmpArrP As Variant

    PUB_ChkACSforTIPS = False
    
    'Added by Lydia 2024/04/16 改成變數;最後一碼要,
    Dim strCP10List As String
      'Modified by Lydia 2023/12/15 1013=>抽驗L(1013)，新增:抽驗S(1014)
      'Modified by Lydia 2024/04/15 增加案件性質131,132,133,134,141,142,143,144,145,146=>131同101設定,132同1031設定,133同1032設定,134同1033設定,141同1012設定,142同1013設定,143同1014設定,144同1031設定,145同1032設定,146同1033設定
    'ACS之TIPS的案件性質:
    strCP10List = "101,1012,1013,1014,102,1021,1031,1032,1033,1034,1035,124,131,132,133,134,141,142,143,144,145,146,"
    'end 2024/04/16
    'Add By Sindy 2024/5/10
    If strAddChkCP10 <> "" Then
      strCP10List = strCP10List & strAddChkCP10 & IIf(Right(strAddChkCP10, 1) <> ",", ",", "")
    End If
    '2024/5/10 END
    
    If Left(pSysNo, 3) <> "ACS" Then
        'Added by Lydia 2023/12/15 判斷相關案號->若為ACS案進一步判斷是否為TIPS案
        If bolCR1 = True Then
           Call ChgCaseNo(pSysNo, pCase)
           strP1 = "SELECT CR05,CR06,CR07,CR08 FROM CaseRelation1 WHERE CR05='ACS' AND CR01='" & pCase(1) & "' AND CR02='" & pCase(2) & "' AND CR03='" & pCase(3) & "' AND CR04='" & pCase(4) & "' "
           strP1 = strP1 & "UNION SELECT CR01,CR02,CR03,CR04 FROM CaseRelation1 WHERE CR01='ACS' AND CR05='" & pCase(1) & "' AND CR06='" & pCase(2) & "' AND CR07='" & pCase(3) & "' AND CR08='" & pCase(4) & "' "
           intP = 1
           Set rsPD = ClsLawReadRstMsg(intP, strP1)
           If intP = 1 Then
              pSysNo = "" & rsPD.Fields("CR05") & rsPD.Fields("CR06") & rsPD.Fields("CR07") & rsPD.Fields("CR08")
              GoTo JumpToNext
           End If
        End If
        'end 2023/12/15
        Exit Function
    Else
        If pSysNo = "ACS" Then 'ACS新案
            If pSysPty <> "" Then
                tmpArrP = Split(pSysPty, ",")
                For intP = 0 To UBound(tmpArrP)
                    'Modified by Lydia 2024/04/16 改成變數strCP10List
                    If Trim(tmpArrP(intP)) <> "" And InStr(strCP10List, Trim(tmpArrP(intP)) & ",") > 0 Then
                        PUB_ChkACSforTIPS = True
                        Exit Function
                    End If
                Next
            End If
        Else
            'ACS舊案若曾經收文過101、1012、1013、102、1021、1031、1032、1033、1034、1035、124
            'Memo by Lydia 2023/12/15 1013=>抽驗L(1013)，新增:抽驗S(1014)
JumpToNext: 'Added by Lydia 2023/12/15
            Call ChgCaseNo(pSysNo, pCase)
            If pCase(1) <> "" And pCase(2) <> "" Then
                 'Modified by Lydia 2024/04/16 改成變數strCP10List
                 strP1 = "select cp09,cp10 from caseprogress where cp01='" & pCase(1) & "' and cp02='" & pCase(2) & "' and cp03='" & pCase(3) & "' and cp04='" & pCase(4) & "' and cp159=0 and cp10 in (" & GetAddStr(strCP10List) & ") "
                 intP = 1
                 Set rsPD = ClsLawReadRstMsg(intP, strP1)
                 If intP = 1 Then
                    PUB_ChkACSforTIPS = True
                 End If
            End If
        End If
    End If
    Set rsPD = Nothing
End Function

'Added by Morgan 2023/9/23
'部分收款已送件續行尾款請款通知
Public Sub PUB_PaymentReminder(Optional pWER02 As String)
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   Dim strTo As String, strCC As String, strMan As String
   Dim strSub As String, strContent As String
   Dim stDate As String
        
   '依收據判斷是否有未收款
   stSQL = "select cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||cp04) C1" & _
      ",a0j13,a0k04,a0k06+a0k07 C2,a0k17,a0k18,dsf+dof C3,a0k06-dsf-a0k17+tsf C4,a0k07-dof-a0k18+tof C5" & _
      ",tsf+tof C6,cp27,a0k20,st15,wer03 from (" & _
      " select a0j01,a0j13,a0j04,sum(a1u07) dsf,sum(a1u09) dof,sum(a1u08) tsf,sum(a1u10) tof" & _
      " From caseprogress, acc0j0, acc1u0" & _
      " Where cp09='" & pWER02 & "'" & _
      " and cp27>0 And cp75-nvl(cp78,0)>0 And cp79>0" & _
      " and a0j01(+)=cp09 and a1u02(+)=a0j13" & _
      " group by a0j01,a0j13,a0j04) a,acc0k0,staff,caseprogress,waitexerec" & _
      " where a0k01(+)=a0j13 and a0k17+a0k18-tsf-tof>0 and a0k06+a0k07-dsf-dof>a0k17+a0k18-tsf-tof" & _
      " and st01(+)=a0k20 and cp09(+)=a0j01 and wer02(+)=cp09 and wer01(+)='3'"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 0 Then
      stSQL = "delete from WaitExeRec where wer01='3' and wer02='" & pWER02 & "'"
      cnnConnection.Execute stSQL, intQ
      
   ElseIf intQ = 1 Then
      stDate = CompDate(1, 3, rsQuery("cp27"))
      strContent = "本所案號：" & rsQuery("C1") & vbCrLf & _
            "收據編號：" & rsQuery("a0j13") & vbCrLf & _
            "收據抬頭：" & rsQuery("a0k04") & vbCrLf & _
            "應收帳款：" & Format(rsQuery("C2"), "#,##0") & vbCrLf & _
            "已收服務費：" & Format(rsQuery("a0k17"), "#,##0") & vbCrLf & _
            "已收規費：" & Format(rsQuery("a0k18"), "#,##0") & vbCrLf & _
            "銷帳金額：" & Format(rsQuery("C3"), "#,##0") & vbCrLf & _
            "退費金額：" & Format(rsQuery("C6"), "#,##0") & vbCrLf & _
            "未收服務費：" & Format(rsQuery("C4"), "#,##0") & vbCrLf & _
            "未收規費：" & Format(rsQuery("C5"), "#,##0")
            
      '送件逾3個月
      If strSrvDate(1) > stDate Then
         strSub = rsQuery("C1") & "案送件逾3個月尾款尚未收回"
         strTo = rsQuery("a0k20")
         strMan = GetDeptMan(rsQuery("ST15")) '區主管
         If strMan <> "" And strMan <> strTo And strMan <> "74018" Then
            strTo = strTo & ";" & strMan
         End If
         'Modify by Amy 2024/05/17 財務2個特殊設定拆成3個
         If Val(strSrvDate(1)) >= Val(財務拆總帳出納國內應收啟用日) Then
            strCC = Pub_GetSpecMan("財務處應收處理人員")
         Else
            strCC = Pub_GetSpecMan("財務處總帳人員")
         End If
         'end 2024/05/17
         If rsQuery("a0k20") = "74018" Then
            strContent = "您好：" & vbCrLf & strSub & "。" & vbCrLf & vbCrLf & strContent
            
         ElseIf Left(rsQuery("st15"), 1) = "S" Then
            strContent = "您好：" & vbCrLf & vbCrLf & strSub & "，請呈報杜協理核示。" & vbCrLf & vbCrLf & strContent
            strCC = "74018;" & strCC
            
         Else
            strContent = "您好：" & vbCrLf & vbCrLf & strSub & "。" & vbCrLf & vbCrLf & strContent
         End If
         
         '檢查待通知案號是否有重複
         stSQL = "update mailcache set mc13=mc13 where mc02='" & strTo & "' and mc07='" & ChgSQL(strSub) & "' and mc05 is null and mc13='" & rsQuery("a0j13") & "'"
         cnnConnection.Execute stSQL, intQ
         If intQ = 0 Then
            stSQL = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08,mc09,mc13)" & _
                    " values ('" & strUserNum & "','" & strTo & "',to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss')" & _
                    ",'" & ChgSQL(strSub) & "','" & ChgSQL(strContent) & "','" & strCC & "','" & rsQuery("a0j13") & "')"
            cnnConnection.Execute stSQL, intQ
         End If
         
         stSQL = "delete from WaitExeRec where wer01='3' and wer02='" & pWER02 & "'"
         cnnConnection.Execute stSQL, intQ
      
      '已送件
      ElseIf IsNull(rsQuery("wer03")) Then
         strSub = rsQuery("C1") & "案已送件請續行尾款請款"
         strTo = rsQuery("a0k20")
         '檢查待通知案號是否有重複
         stSQL = "update mailcache set mc13=mc13 where mc02='" & strTo & "' and mc07='" & ChgSQL(strSub) & "' and mc05 is null and mc13='" & rsQuery("a0j13") & "'"
         cnnConnection.Execute stSQL, intQ
         If intQ = 0 Then
            strContent = "您好：" & vbCrLf & vbCrLf & rsQuery("C1") & "已於" & ChangeWStringToTDateString(rsQuery("cp27")) & "送件，請續行尾款請款。" & vbCrLf & vbCrLf & strContent
            stSQL = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08,mc13)" & _
                    " values ('" & strUserNum & "','" & strTo & "',to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss')" & _
                    ",'" & ChgSQL(strSub) & "','" & ChgSQL(strContent) & "','" & rsQuery("a0j13") & "')"
            cnnConnection.Execute stSQL, intQ
         End If
         stSQL = "update WaitExeRec set wer03=" & strSrvDate(1) & " where wer01='3' and wer02='" & pWER02 & "'"
         cnnConnection.Execute stSQL, intQ
         
      End If
   End If
   
   Set rsQuery = Nothing
End Sub

'Added by Morgan 2023/8/18
'Modified by Morgan 2023/10/19 +pErrDesc
'檢查待執行紀錄
Public Sub PUB_ChkWaitExeRec(Optional pWER01 As String, Optional pErrDesc As String)
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   Dim bolInTran As Boolean
   Dim stWer01 As String, stWer02 As String
   
On Error GoTo ErrHnd

   pErrDesc = ""
   stSQL = "select * from WaitExeRec"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      With rsQuery
      Do While Not .EOF
         stWer01 = .Fields("wer01")
         stWer02 = .Fields("wer02")
         cnnConnection.BeginTrans
         bolInTran = True
         If stWer01 = "1" Then
            PUB_SetEngInform stWer02, "", True
            stSQL = "delete from WaitExeRec where wer01='1' and wer02='" & stWer02 & "'"
            cnnConnection.Execute stSQL, intQ
            
         'Added by Morgan 2023/9/6
         ElseIf stWer01 = "2" Then
            PUB_DualCaseInform stWer02
         'end 2023/9/6
         
         'Added by Morgan 2023/9/25
         ElseIf stWer01 = "3" Then
            PUB_PaymentReminder stWer02
         'end 2023/9/25
         End If
         cnnConnection.CommitTrans
         bolInTran = False
         .MoveNext
      Loop
      End With
   End If
   
ErrHnd:
   If Err.Number <> 0 Then
      If bolInTran Then cnnConnection.RollbackTrans
      pErrDesc = "ChkWaitExeRec(WER01=" & stWer01 & ", WER02=" & stWer02 & "): ErrNo=" & Err.Number & ", ErrDesc=" & Err.Description
      PUB_WriteLog pErrDesc
   End If
   
   Set rsQuery = Nothing
End Sub

'Added by Morgan 2023/11/9
'Modified by Morgan 2024/9/6 +pStampNo:財務戳章代號
'JPG轉PDF
Public Function PUB_JPG2PDF(pJPGFileName As String, pPDFFileName As String, Optional pKill As Boolean = True, Optional pStampNo As String) As Boolean
   Dim oShape
   Dim arrFileName() As String
   Dim ii As Integer
   
On Error GoTo ErrHnd
   
   arrFileName = Split(pJPGFileName, "*")
   If Pub_NewWordDoc(g_WordAp) = True Then
      With g_WordAp
      For ii = 0 To UBound(arrFileName)
         If arrFileName(ii) <> "" Then
            '多圖插入跳頁
            If ii > 0 Then
               .Selection.EndKey Unit:=wdStory
               .Selection.InsertBreak Type:=wdPageBreak
            End If
                  
            Set oShape = .ActiveDocument.Shapes.AddPicture(Anchor:=.Selection.Range, FileName:=arrFileName(ii), LinkToFile:=False, SaveWithDocument:=True)
            oShape.ZOrder 4
            oShape.LockAnchor = True
            oShape.LockAspectRatio = -1
            oShape.Width = .CentimetersToPoints(21)
            oShape.RelativeHorizontalPosition = wdRelativeHorizontalPositionPage
            oShape.RelativeVerticalPosition = wdRelativeVerticalPositionPage
            oShape.Left = .CentimetersToPoints(0)
            oShape.Top = .CentimetersToPoints(0)
         End If
      Next
      'Added by Morgan 2024/9/5
      If pStampNo <> "" Then
         If PUB_ReadDB2File(arrFileName(0), Val(pStampNo), "M31") Then
            Set oShape = .ActiveDocument.Shapes.AddPicture(Anchor:=.Selection.Range, FileName:=arrFileName(0), LinkToFile:=False, SaveWithDocument:=True)
            oShape.RelativeHorizontalPosition = wdRelativeHorizontalPositionPage
            oShape.RelativeVerticalPosition = wdRelativeVerticalPositionPage
            oShape.Left = .CentimetersToPoints(12.5)
            oShape.Top = .CentimetersToPoints(17.5)
            oShape.LockAspectRatio = msoTrue
            oShape.Width = .CentimetersToPoints(5.9)
         End If
      End If
      'end 2024/9/5
      .ActiveDocument.ExportAsFixedFormat OutputFileName:=pPDFFileName, ExportFormat:=17, OpenAfterExport:=False
      .Quit wdDoNotSaveChanges
      End With
      Set g_WordAp = Nothing
      PUB_JPG2PDF = True
      
On Error Resume Next
      If pKill Then
         For ii = 0 To UBound(arrFileName)
            If arrFileName(ii) <> "" Then
               Kill arrFileName(ii)
            End If
         Next
      End If
      
   End If
   
   Exit Function
   
ErrHnd:
   MsgBox Err.Description, vbCritical
End Function

'Memo by Morgan 2024/5/22 自aacc_fun移來以便薪資系統共用
'Add by Morgan 2007/6/6
'翻譯費具領證明單
Public Sub PUB_PrintReceipt5(p_A2501 As String, p_Yo As Long, Optional p_PageNo As Long)
Dim lngX As Long, lngY As Long, strTemp As String
   
   strExc(0) = "select * from acc250, acc0i0 where a2501='" & p_A2501 & "' and a0i01(+)=a2503"
   intI = 1
   Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
   If intI <> 1 Then
      MsgBox "無法讀取相關資料！"
      Exit Sub
   End If
   
   With RsTemp
      If p_PageNo = 0 Then
         p_PageNo = 1
      Else
         If p_Yo > 0 Then
            Printer.NewPage
            p_PageNo = p_PageNo + 1
            p_Yo = 0
         Else
            p_Yo = Printer.Height / 2
         End If
      End If
      
      Printer.FontName = "標楷體"
      Printer.FontSize = 12
      Printer.CurrentX = 200
      Printer.CurrentY = p_Yo + 0
      Printer.Print "請 沿 此 虛 線 撕 下 寄 回"
      
      Printer.FontSize = 24
      Printer.CurrentX = 3800
      Printer.CurrentY = p_Yo + 1000
      Printer.Font.Underline = True
      Printer.Print "證　明　單"
      Printer.Font.Underline = False
      
      Printer.FontSize = 14
      '回執單號
      strTemp = "" & .Fields("a2501")
      Printer.CurrentX = 750
      Printer.CurrentY = p_Yo + 1500
      Printer.Print strTemp
      
      strTemp = "" & .Fields("a2518")
      'Modify by Amy 2014/06/30 +iif 因格式可能已經轉好才帶入
      strTemp = "日期  " & IIf(InStr(strTemp, "/") > 0, strTemp, CFDate(TransDate(strTemp, 1)))
      Printer.CurrentX = 7500
      Printer.CurrentY = p_Yo + 1500
      Printer.Print strTemp
      
      strTemp = A0802Query("2")
      Printer.CurrentX = 2400
      Printer.CurrentY = p_Yo + 2100
      Printer.Print "茲收到　" & strTemp

      Printer.CurrentX = 750
      Printer.CurrentY = p_Yo + 2700
      Printer.Print "新台幣"
      
      strTemp = Val("" & .Fields("a2504"))
      '加底線
      Printer.Font.Underline = True
      Printer.CurrentX = 2000
      Printer.CurrentY = p_Yo + 2700
      Printer.Print ChangeNumber(strTemp)
      
      Printer.CurrentX = 7500
      Printer.CurrentY = p_Yo + 2700
      Printer.Print "NTD" & Format(strTemp, DDollar) 'NT$
      Printer.Font.Underline = False
      
      strTemp = "上述款項係 "
      Printer.CurrentX = 750
      Printer.CurrentY = p_Yo + 3300
      Printer.Print strTemp
      
      lngX = 750 + Printer.TextWidth(strTemp)
      lngY = p_Yo + 3300
      '款項說明
      strTemp = "" & .Fields("a2514") & " 翻譯費"
      Printer.Font.Underline = True
      XPrint strTemp, lngX, lngY, Printer.TextWidth(String(30, "　")), 300
      Printer.Font.Underline = False
      
      lngX = 750 + Printer.TextWidth(String(5, "　"))
      lngY = lngY + 500
      Printer.CurrentX = lngX
      Printer.CurrentY = lngY
      strTemp = "具　領　人："
      Printer.Print strTemp
      
      lngX = lngX + Printer.TextWidth(strTemp)
      Printer.CurrentX = lngX
      Printer.CurrentY = lngY
      strTemp = " " & .Fields("a2513") & " "
      Printer.Font.Underline = True
      Printer.Print strTemp
      Printer.Font.Underline = False
      
      lngX = lngX + Printer.TextWidth(strTemp)
      Printer.CurrentX = lngX
      Printer.CurrentY = lngY
      strTemp = "　　簽章："
      Printer.Print strTemp
      
      lngX = lngX + Printer.TextWidth(strTemp)
      Printer.CurrentX = lngX
      Printer.CurrentY = lngY
      strTemp = String(5, "　")
      Printer.Font.Underline = True
      Printer.Print strTemp
      Printer.Font.Underline = False
      
      'Remove by Morgan 2008/5/2 不印了--瑞婷
      'lngX = 750 + Printer.TextWidth(String(5, "　"))
      'lngY = lngY + 500
      'Printer.CurrentX = lngX
      'Printer.CurrentY = lngY
      'strTemp = "身分證字號：" & .Fields("a0i18")
      'Printer.Print strTemp
            
      lngX = 750 + Printer.TextWidth(String(5, "　"))
      lngY = lngY + 500
      Printer.CurrentX = lngX
      Printer.CurrentY = lngY
      strTemp = "地　　　址："
      Printer.Print strTemp
      
      lngX = lngX + Printer.TextWidth(strTemp)
      'Modify by Morgan 2009/1/21 廠商郵遞區號欄位自地址欄拆開a0i04
      strTemp = "" & .Fields("a0i04") & .Fields("a0i03")
      XPrint strTemp, lngX, lngY, Printer.TextWidth(String(30, "　")), 300
      
      lngX = 750
      lngY = lngY + 500
      Printer.FontSize = 12
      Printer.CurrentX = lngX
      Printer.CurrentY = lngY
      Printer.Print "敬請於證明單上簽名或蓋章並退回本所　謝謝！"
      
      lngX = 600
      lngY = lngY + 400
      Printer.Line (lngX, p_Yo + 1800)-(lngX + 9650, p_Yo + 1800)
      Printer.Line (lngX, lngY)-(lngX + 9650, lngY)
      Printer.Line (lngX, p_Yo + 1800)-(lngX, lngY)
      Printer.Line (lngX + 9650, p_Yo + 1800)-(lngX + 9650, lngY)
   End With
   
End Sub

'Memo by Morgan 2024/5/22 自aacc_fun移來以便薪資系統共用
'Add by Morgan 2007/6/6
'多行列印
Private Sub XPrint(p_Data As String, p_X As Long, p_Y As Long, p_RowWidth As Long, p_RowHeight As Long)
Dim i As Integer, stTemp As String
   
   For i = 1 To Len(p_Data)
      If p_X + Printer.TextWidth(Left(stTemp, i)) > p_RowWidth Then
         Printer.CurrentX = p_X
         Printer.CurrentY = p_Y
         Printer.Print stTemp
         p_Y = p_Y + p_RowHeight
         stTemp = ""
      End If
      stTemp = stTemp & Mid(p_Data, i, 1)
   Next
   If stTemp <> "" Then
      Printer.CurrentX = p_X
      Printer.CurrentY = p_Y
      Printer.Print stTemp
      stTemp = ""
   End If
End Sub

'Added by Morgan 2024/6/14
'檢查新增的定稿是否是給工程師使用(C類未發文且承辦人<>輸入人)
Private Function ChkIsEngLetter(pCP09 As String) As Boolean
   Dim stSQL As String, intR As Integer
   stSQL = "update caseprogress set cp28=cp28 where cp09='" & pCP09 & "' and substr(cp09,1,1)='C' and cp14<>cp65 and cp27 is null"
   cnnConnection.Execute stSQL, intR
   If intR = 1 Then
      ChkIsEngLetter = True
   End If
End Function

'Added by Morgan 2024/11/4
'請款單領證年費項目年度敘述
Public Function PUB_GetAnnuityDesc(pA1k01 As String, pCP10 As String, pOldDesc As String, Optional pLang As Integer = "2") As String
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   Dim strTemp1() As String
   Dim strTemp2() As String
   Dim ii As Integer, strSendDate As String
   Dim stYr As String, stYr1 As String, stYr2 As String
   Dim strAnnuity As String
   
   stSQL = "select cp27, pa72, pa73 from caseprogress, patent where cp60 = '" & pA1k01 & "' And pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04 and CP10='" & pCP10 & "' and pa01 is not null"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      With rsQuery
      If IsNull(.Fields("pa73").Value) = False Then
         strTemp1 = Split(UCase(.Fields("pa72").Value), ",")
         strTemp2 = Split(UCase(.Fields("pa73").Value), ",")
         For ii = 0 To UBound(strTemp2)
            If Val(strTemp2(ii)) = .Fields("cp27").Value Then
                  If pLang = "2" Then
                     Select Case Val(strTemp1(ii))
                        Case 1
                           stYr = "1st"
                        Case 2
                           stYr = "2nd"
                        Case 3
                           stYr = "3rd"
                        Case Else
                           stYr = strTemp1(ii) & "th"
                     End Select
                  Else
                     stYr = strTemp1(ii)
                  End If
                  
                  If stYr1 = "" Then stYr1 = stYr
                  stYr2 = stYr
            End If
         Next ii
         
         If stYr2 <> stYr1 Then
            If pLang = "2" Then
               strAnnuity = stYr1 & " to " & stYr2
            Else
               strAnnuity = stYr1 & " ~ " & stYr2
            End If
         Else
            strAnnuity = stYr1
         End If
         
         If pCP10 = "601" Then
            If pLang = "2" Then
               PUB_GetAnnuityDesc = Replace(pOldDesc, "1st", strAnnuity)
            Else
               PUB_GetAnnuityDesc = Replace(pOldDesc, "第 1 年", "第 " & strAnnuity & " 年")
            End If
         Else
            If pLang = "2" Then
               If InStr(pOldDesc, "the  annuity") > 0 Then
                  PUB_GetAnnuityDesc = Replace(pOldDesc, "the  annuity", "the " & strAnnuity & " annuity")
               Else
                  PUB_GetAnnuityDesc = pOldDesc & strAnnuity
               End If
            Else
               PUB_GetAnnuityDesc = Replace(pOldDesc, "第  年", "第 " & strAnnuity & " 年")
            End If
         End If
         
      End If
      End With
   End If
   Set rsQuery = Nothing
End Function


'Added by Morgan 2024/10/28
'大陸發明案的專用期止日增加判斷是否有補償天數
'pPA():本所案號,pPA25:目前專用期止日,pDays:補償天數,pCheck:檢核補償天數是否與紀錄一致,pOrgPA25:原專用期止日
Public Function PUB_GetCNExtDays(pPA() As String, Optional pPA25 As String, Optional pDays As Integer, Optional pCheck As Boolean = False, Optional pOrgPA25 As String) As Boolean
   Dim strMsg As String
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   
   pDays = 0
   PUB_GetCNExtDays = True
   'Added by Morgan 2024/11/7
   If pPA25 = "" Then
      stSQL = "select pa25 from patent where pa01='" & pPA(1) & "' and pa02='" & pPA(2) & "' and pa03='" & pPA(3) & "' and pa04='" & pPA(4) & "' and pa25>0"
      intQ = 1
      Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
      If intQ = 1 Then
         pPA25 = rsQuery(0)
      End If
   End If
   'end 2024/11/7
   If Val(pPA25) > 0 Then
      '考慮可能是年費階段來所,原專用期止日改以規則計算用其判斷是否有補償天數
      If GetMoneyDate(11, "020", pPA(), , , pOrgPA25) = True Then
         If pOrgPA25 > 0 Then
            If DBDATE(pPA25) > pOrgPA25 Then
               pDays = CDays(pOrgPA25, pPA25)
            End If
         End If
            
         If pCheck Then
            If pOrgPA25 > 0 Then
               stSQL = "select cp71 from caseprogress a" & _
                  " where cp01='" & pPA(1) & "' and cp02='" & pPA(2) & "' and cp03='" & pPA(3) & "' and cp04='" & pPA(4) & "' and cp10='1001' and cp71>0" & _
                  " and exists(select * from caseprogress b where cp09=a.cp43 and cp10='445')"
               intQ = 1
               Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
               If intQ = 1 Then
                  If Val(rsQuery("cp71")) <> pDays Then
                     MsgBox "來函輸入的補償天數(" & rsQuery("cp71") & "天)與依規則計算的天數(" & pDays & "天)不同，請再確認！", vbCritical
                     PUB_GetCNExtDays = False
                  End If
               ElseIf pDays > 0 Then
                  If MsgBox("無法檢核補償天數是否正確，是否確定為" & pDays & "天？", vbExclamation + vbYesNo + vbDefaultButton2) = vbNo Then
                     PUB_GetCNExtDays = False
                  End If
               End If
            Else
               If MsgBox("無法檢核專用期是否正確，是否確定要存檔？", vbExclamation + vbYesNo + vbDefaultButton2) = vbNo Then
                  PUB_GetCNExtDays = False
               End If
            End If
         End If
      End If
   End If
   Set rsQuery = Nothing
End Function

'Added by Morgan 2024/10/28
'補償期年費期限
Public Function PUB_GetCN615DueDate(pPA() As String) As String
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   Dim strDueDate As String
   
   stSQL = "select sqldatet(np09) np09,np06,cpm04,cp09,cp27 from nextprogress,casepropertymap,caseprogress" & _
      " where np02='" & pPA(1) & "' and np03='" & pPA(2) & "' and np04='" & pPA(3) & "' and np05='" & pPA(4) & "' and np07='615' and nvl(np06,'Y')='Y' and cp09(+)=np24 and cpm01(+)=np02 and cpm02(+)=np07"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      If IsNull(rsQuery("cp27")) Then
         strDueDate = rsQuery("np09") & " (" & rsQuery("cpm04") & ")"
         If Not IsNull(rsQuery("cp09")) Then
            strDueDate = strDueDate & "(已收文)"
         End If
         PUB_GetCN615DueDate = strDueDate
      End If
   End If
   Set rsQuery = Nothing
End Function

'Added by Morgan 2024/11/6
'補償期年費金額
Public Function PUB_GetCN615Fee(pPA() As String) As String
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   Dim strFee As String, strOFee As String, strOldPA25 As String, strOldExpDate As String, strNewExpDate As String, intYrs As Integer
   
   stSQL = "select * from patent" & _
      " where pa01='" & pPA(1) & "' and pa02='" & pPA(2) & "' and pa03='" & pPA(3) & "' and pa04='" & pPA(4) & "'"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      With rsQuery
      If GetMoneyDate(11, "020", pPA(), , , strOldPA25) = True Then
         '專利期滿終止日=專用期止日+1天 (因3/1的前一日可能是28或29，故仍以終止日比較)
         strNewExpDate = CompDate(2, 1, .Fields("pa25")) '新專利期滿終止日
         strOldExpDate = CompDate(2, 1, strOldPA25)      '原專利期滿終止日
         intYrs = Left(strNewExpDate, 4) - Left(strOldExpDate, 4)
         If Mid(strNewExpDate, 5) < Mid(strOldExpDate, 5) Then '未滿1年部分免繳
            intYrs = intYrs - 1
         End If
         If intYrs > 0 Then
            strFee = PUB_GetYF0607(.Fields("pa09"), .Fields("pa08"), .Fields("pa26"), "615", "1", "1", "1")
            If intYrs > 1 Then
               strOFee = PUB_GetYF07(.Fields("pa09"), .Fields("pa08"), .Fields("pa26"), "615", "1", "1", "1")
               strFee = Val(strFee) + Val(strOFee) * (intYrs - 1)
            End If
         End If
         PUB_GetCN615Fee = strFee
      End If
      
      End With
   End If
   Set rsQuery = Nothing
End Function

'Added by Morgan 2024/11/27
'列印台灣專利公報
Public Function PUB_ChkPrintGazette(pPA01 As String, pPA02 As String, pPA03 As String, pPA04 As String, pLD10 As String, pFileName As String) As Boolean
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   
   pFileName = ""
   If pPA01 = "P" And pLD10 = "08" Then
      stSQL = "select cpp01,cpp02  from patent,caseprogress,casepaperpdf" & _
         " where pa01='" & pPA01 & "' and pa02='" & pPA02 & "' and pa03='" & pPA03 & "' and pa04='" & pPA04 & "' and pa09='000'" & _
         " and cp01(+)=pa01 and cp02(+)=pa02 and cp03(+)=pa03 and cp04(+)=pa04 and cp10='1228' and cpp01(+)=cp09 and substr(upper(cpp02),-9)='.'||cp10||'.PDF'"
      intQ = 1
      Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
      If intQ = 1 Then
         With rsQuery
         pFileName = .Fields("cpp02")
         PUB_ChkPrintGazette = PUB_GetAttachFile_CPP(.Fields("cpp01"), pFileName, App.path & "\" & strUserNum)
         End With
      End If
   End If
   
   Set rsQuery = Nothing
End Function

'Added by Lydia 2024/12/10 開啟中Excel轉成PDF檔/XLS檔
Public Function PUB_PrintExcel2File(ByRef p_ExcelAp, ByVal pFolder As String, ByVal pFileName As String, Optional ByRef outFileName As String, Optional ByVal bolClose As Boolean = True) As Boolean
'p_ExcelAp 傳入正在操作的Excel.Application
Dim strFullName As String
   
   If UCase(TypeName(p_ExcelAp)) = "NOTHING" Then
       Exit Function
   End If
   If pFolder = "" Or pFileName = "" Then
       Exit Function
   End If
   
   If Right(UCase(pFileName), 4) <> ".PDF" And Right(UCase(pFileName), 4) <> ".XLS" And Right(UCase(pFileName), 4) <> ".XLSX" Then
       outFileName = pFileName & ".pdf"  '預設PDF檔
   Else
       outFileName = pFileName
   End If
   strFullName = pFolder & "\" & outFileName
   
On Error GoTo ErrHandle

   RidFile strFullName '刪除舊檔
   
   '預設目前工作表=1
   If Right(UCase(strFullName), 4) = ".PDF" Then
      'XlFixedFormatType 列舉: xlTypePDF=0, xlTypeXPS=1
      'XlFixedFormatQuality 列舉: xlQualityStandard=0, xlQualityMinimum=1
      p_ExcelAp.ActiveWorkbook.ExportAsFixedFormat Type:=0, FileName:=strFullName, Quality:=0
   Else
      p_ExcelAp.ActiveDocument.SaveAs strFullName
   End If
   PUB_PrintExcel2File = True
   
   '關閉EXCEL
   If bolClose = True Then
      p_ExcelAp.Workbooks(1).Save
      p_ExcelAp.Quit
      Set p_ExcelAp = Nothing
   End If
   Exit Function
    
ErrHandle:
   If Err.Number <> 0 Then
        MsgBox Err.Description, vbCritical, "開啟中Excel轉成PDF檔/XLS檔"
   End If
    
   Resume Next
End Function

'Added by Morgan 2023/4/6
'Modified by Morgan 2025/1/15 從電子公文移來改公用
Public Sub PUB_WaitUntilNoJob(pPrinter As String)
   Do While GetJobs(pPrinter) <> 0
      Sleep 1000
   Loop
End Sub

'Added by Morgan 2023/4/6
'Modified by Morgan 2025/1/15 從電子公文移來改公用
Private Function GetJobs(pPrinter As String) As Integer
    Dim hPrinter As Long, lNeeded As Long, lReturned As Long
    Dim lJobCount As Long
    OpenPrinter pPrinter, hPrinter, ByVal 0&
    EnumJobs hPrinter, 0, 99, 1, ByVal 0&, 0, lNeeded, lReturned
    If lNeeded > 0 Then
        ReDim byteJobsBuffer(lNeeded - 1) As Byte
        EnumJobs hPrinter, 0, 99, 1, byteJobsBuffer(0), lNeeded, lNeeded, lReturned
        If lReturned > 0 Then
            lJobCount = lReturned
        Else
            lJobCount = 0
        End If
    Else
        lJobCount = 0
    End If
    ClosePrinter hPrinter
    GetJobs = lJobCount
    'MsgBox "Jobs in printer [" & Printer.DeviceName & "] queue: " + CStr(lJobCount), vbInformation

End Function

'Added by Morgan 2025/1/16
'檢查是否為申請人中文函
Private Function IsAppChLetter(pContent) As Boolean
   If InStr(pContent, "<中申開窗") > 0 And InStr(pContent, "致：") > 0 _
            And InStr(pContent, "<中申開窗郵號/被授權>") = 0 _
            And InStr(pContent, "<中申開窗郵號/相關被授權>") = 0 _
            And InStr(pContent, "<中申開窗郵號/移轉人>") = 0 _
            And InStr(pContent, "<中申開窗郵號/移轉>") = 0 Then
      IsAppChLetter = True
   End If
End Function

'Added by Lydia 2025/02/24 與ACS案有關之智財協作(CPS、PS、TT、S、L)發文時一併產生TIPS案請款階段分配比例----教威:減少輸入動作 'Memo by Lydia 2025/04/18 上線日在4/21
Public Sub PUB_InsertACS_TIPS_Rate(ByVal pCP01 As String, ByVal pCP02 As String, ByVal pCP03 As String, ByVal pCP04 As String, ByVal pCP09 As String, ByVal pCP10 As String)
'接洽單收文PS及CPS之智財協作967，TT及S之智財協作737，L之智財協作7601，在收文時一定要輸「本案與總號之有關」欄，且必須要有ACS且為TIPS的案件，
'提醒文字：「案件性質為智財協作，請輸入ACS之TIPS案件案號於「本案與總號之有關」欄」。
Dim intP As Integer, strP1 As String, strP2 As String, strP3 As String
Dim rsPD As New ADODB.Recordset
   
   If pCP02 = "999999" Or Left(pCP09, 1) > "C" Then Exit Sub
   
   If (pCP01 = "CPS" And pCP10 = "967") Or (pCP01 = "PS" And pCP10 = "967") Or (pCP01 = "TT" And pCP10 = "737") Or (pCP01 = "S" And pCP10 = "737") _
         Or (pCP01 = "L" And pCP10 = "7601") Then
   'Added by Lydia 2025/05/05 若該案號除了智財協作外還有其他案件性質(不管有沒有發文日，只要沒有取消收文)時，智財協作那一道的發文就不必發EMAIL給顧服組主管。
       strP1 = "select cp09,cp10 from caseprogress where cp01='" & pCP01 & "' and cp02='" & pCP02 & "' and cp03='" & pCP03 & "' and cp04='" & pCP04 & "' and cp09<>'" & pCP09 & "' and cp09<'C' and cp159=0 "
       intP = 1
       Set rsPD = ClsLawReadRstMsg(intP, strP1)
       If intP = 1 Then
          Exit Sub
       End If
   End If
   '修改：PS、CPS、TT、S、L，這些系統類別的所有發文畫面，只要該案件有ACS之TIPS案的關聯，不管什麼案件性質，都要EMAIL給顧服組主管。
   If pCP01 = "CPS" Or pCP01 = "PS" Or pCP01 = "TT" Or pCP01 = "S" Or pCP01 = "L" Then
   'end 2025/05/05
       'Modified by Lydia 2025/10/22 關聯的ACS案非區塊2(TIPS請款)，也要發通知讓顧服組知道專業部已完成by黃教威; Ex. PS-000514=>ACS-000216
       'strP1 = "select c1.cp14,st02,nvl(c1.cp113,0) cp113,c1.cp158,cr05,cr06,cr07,cr08,atr05,atr06,atr07 " & _
               "From caseprogress c1,staff, caserelation1,(select atr05,atr06,atr07 from acs_tips_rate where atr06='" & pCP09 & "') " & _
               "where c1.cp09='" & pCP09 & "' and c1.cp158>0 and c1.cp14=st01(+) and c1.cp01=cr01(+) and c1.cp02=cr02(+) and c1.cp03=cr03(+) and c1.cp04=cr04(+) and cr05='ACS' " & _
               "and (cr05,cr06,cr07,cr08) in (select c2.cp01,c2.cp02,c2.cp03,c2.cp04 from caseprogress c2 where c2.cp01=cr05 and c2.cp02=cr06 and c2.cp03=cr07 and c2.cp04=cr08 and c2.cp31='Y'  and c2.cp159=0 and c2.cp10 in (" & ACSforTIPSstep & ")) " & _
               "and c1.cp09=atr06(+) "
       strP1 = "select c1.cp14,st02,nvl(c1.cp113,0) cp113,c1.cp158,cr05,cr06,cr07,cr08,atr05,atr06,atr07,c2.cp09,c2.cp10 " & _
               "From caseprogress c1,staff, caserelation1,caseprogress c2 ,(select atr05,atr06,atr07 from acs_tips_rate where atr06='" & pCP09 & "') " & _
               "where c1.cp09='" & pCP09 & "' and c1.cp158>0 and c1.cp14=st01(+) and c1.cp01=cr01(+) and c1.cp02=cr02(+) and c1.cp03=cr03(+) and c1.cp04=cr04(+) and cr05='ACS' " & _
               "and c1.cp09=atr06(+) and cr05=c2.cp01(+) and cr06=c2.cp02(+) and cr07=c2.cp03(+) and cr08=c2.cp04(+) and c2.cp31='Y' "
       intP = 1
       Set rsPD = ClsLawReadRstMsg(intP, strP1)
       If intP = 1 Then
          If "" & rsPD.Fields("cr05") = "ACS" And "" & rsPD.Fields("cr06") <> "" And "" & rsPD.Fields("atr06") = "" Then
              If InStr(ACSforTIPSstep, "" & rsPD.Fields("cp10")) > 0 Then 'Added by Lydia 2025/10/22
                 strP2 = "Insert Into Acs_Tips_Rate (ATR01,ATR02,ATR03,ATR04,ATR05,ATR06,ATR07,ATR08,ATR09,ATR10,ATR13,ATR14) " & _
                        "Values ('" & rsPD.Fields("cr05") & "','" & rsPD.Fields("cr06") & "','" & rsPD.Fields("cr07") & "','" & rsPD.Fields("cr08") & "','" & Val(Left(rsPD.Fields("cp158"), 4)) - 1911 & "' " & _
                        ",'" & pCP09 & "','" & rsPD.Fields("cp14") & "',null,null,null,'" & strUserNum & "', SYSDATE) "
                 cnnConnection.Execute strP2
              End If 'Added by Lydia 2025/10/22
              '通知ACS主管
              strP3 = Pub_GetSpecMan("ACS郵件通知主管")
              If strP3 <> "" Then
                  If InStr(ACSforTIPSstep, "" & rsPD.Fields("cp10")) > 0 Then 'Added by Lydia 2025/10/22
                     strP1 = rsPD.Fields("cr05") & "-" & rsPD.Fields("cr06") & IIf(rsPD.Fields("cr07") & rsPD.Fields("cr08") = "000", "", "-" & rsPD.Fields("cr07") & "-" & rsPD.Fields("cr08")) & "<智財協作案號：" & pCP01 & "-" & pCP02 & IIf(pCP03 & pCP04 = "000", "", "-" & pCP03 & "-" & pCP04) & ">承辦人已發文，顧服組主管請於系統輸入點數分配比例"
                     strP2 = pCP01 & "-" & pCP02 & IIf(pCP03 & pCP04 = "000", "", "-" & pCP03 & "-" & pCP04) & "，收文號：" & pCP09 & "，本次工作時數小計：" & rsPD.Fields("cp113") & "，承辦人：" & rsPD.Fields("st02") & vbCrLf & _
                            vbCrLf & vbCrLf & "主管請至【法務系統->ACS->資料處理->TIPS案請款階段分配比例維護作業】進行設定。"
                  'Added by Lydia 2025/10/22
                  Else  '非區塊2(TIPS請款)通知Email
                     strP1 = rsPD.Fields("cr05") & "-" & rsPD.Fields("cr06") & IIf(rsPD.Fields("cr07") & rsPD.Fields("cr08") = "000", "", "-" & rsPD.Fields("cr07") & "-" & rsPD.Fields("cr08")) & "<智財協作案號：" & pCP01 & "-" & pCP02 & IIf(pCP03 & pCP04 = "000", "", "-" & pCP03 & "-" & pCP04) & ">承辦人已發文"
                     strP2 = pCP01 & "-" & pCP02 & IIf(pCP03 & pCP04 = "000", "", "-" & pCP03 & "-" & pCP04) & "，收文號：" & pCP09 & "，本次工作時數小計：" & rsPD.Fields("cp113") & "，承辦人：" & rsPD.Fields("st02") & vbCrLf
                  End If
                  'end 2025/10/22
                  strP2 = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08,mc09) " & _
                         "values('" & strUserNum & "','" & strP3 & "',to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss') " & _
                         ",'" & ChgSQL(strP1) & "','" & ChgSQL(strP2) & "',null) "
                  cnnConnection.Execute strP2
              End If
          End If
       End If
   End If
   Set rsPD = Nothing
End Sub

'Added by Lydia 2025/04/18 TIPS分配比例管制：「當年度最後一筆款項」入帳後，系統「以同年度智財協作之發文日」加總各協作(CPS、PS、TT、S、L)各道程序智財協作比例，算得「專業點數比例」以及「業績獎金比例」之總比例後，以「同年度入帳總點數 X 總比例」算出「專業點數」以及「業績獎金」通知顧服組主管最終確認
Public Sub PUB_ProcAcs_Tips_Rate1(ByVal bolMailTo As Boolean, ByVal pCP01 As String, ByVal pCP02 As String, ByVal pCP03 As String, ByVal pCP04 As String, pCP09 As String, pCP60 As String)
'「當年度最後一筆款項」入帳後(收款作業)，系統「以同年度智財協作之發文日」加總各協作(CPS、PS、TT、S、L)各道程序智財協作比例，算得「專業點數比例」以及「業績獎金比例」之總比例後，以「同年度入帳總點數 X 總比例」算出「專業點數」以及「業績獎金」(都是點數)通知顧服組主管最終確認，顧服組主管於系統點擊確認(或存檔)由系統通知財務處進行分配
Dim intB As Integer, strB1 As String, strB2 As String, strYear As String
Dim strATR09 As String, strATR10 As String
Dim strAtr09T As String, strAtr10T As String, strRecTot As String, strSaleTot As String
Dim strTo As String, strSub As String
Dim rsBD As New ADODB.Recordset
   
   '○○○年最後一階段款項
   strB1 = "select max(cp115||cp156||cp60) mno from caseprogress " & _
           "where cp01='" & pCP01 & "' and cp02='" & pCP02 & "' and cp03='" & pCP03 & "' and cp04='" & pCP04 & "' and cp115=(" & _
           "select cp115 from caseprogress where cp01='" & pCP01 & "' and cp02='" & pCP02 & "' and cp03='" & pCP03 & "' and cp04='" & pCP04 & "' " & _
           "and cp60='" & pCP60 & "' and nvl(cp156,0)>0) having instr(max(cp115||cp156||cp60),'" & pCP60 & "') >0 "
   intB = 1
   Set rsBD = ClsLawReadRstMsg(intB, strB1)
   If intB = 1 Then
       '請款年度
       strYear = Left("" & rsBD.Fields("mno"), 3)
       '同年度入帳總點數(服務費)
       strB1 = "select nvl(sum(nvl(a1u04,0)+nvl(a1u07,0)-nvl(a1u08,0)),0) fee1,nvl(sum(nvl(a1u05,0)+nvl(a1u09,0)-nvl(a1u10,0)),0) fee2 " & _
               "From caseprogress, acc0j0, acc1u0 where cp01='" & pCP01 & "' and cp02='" & pCP02 & "' and cp03='" & pCP03 & "' and cp04='" & pCP04 & "' " & _
               "and cp115='" & strYear & "' and cp60=a0j13(+) and a0j01='" & pCP09 & "' and a0j13=a1u02(+) and a0j01=a1u03(+) "
       intB = 1
       Set rsBD = ClsLawReadRstMsg(intB, strB1)
       If intB = 1 Then
          strRecTot = Round(Val("" & rsBD.Fields("fee1")) / 1000, 2)
       Else
          strRecTot = "0"
       End If
       strB1 = "select nvl(atr08,0) * 0.01 as atr08 from acs_tips_rate where atr01='" & pCP01 & "' and atr02='" & pCP02 & "' and atr03='" & pCP03 & "' and atr04='" & pCP04 & "' and atr05='1' "
       intB = 1
       strSaleTot = "0"
       strB2 = ""
       Set rsBD = ClsLawReadRstMsg(intB, strB1)
       If intB = 1 Then
          strSaleTot = Round(strRecTot * (1 - Val("" & rsBD.Fields("atr08"))), 2)
          strB2 = Val("" & rsBD.Fields("atr08"))
       End If
       '無ATR08智權人員比例時，不可分潤
       If strB2 = "0" Then Exit Sub
             
       '-----------------------
       strB1 = "select * from ACS_TIPS_RATE1 where AT113||AT114 is not null AND AT101='" & pCP01 & "' and AT102='" & pCP02 & "' and AT103='" & pCP03 & "' and AT104='" & pCP04 & "' and AT105='" & strYear & "' "
       intB = 1
       Set rsBD = ClsLawReadRstMsg(intB, strB1)
       If intB = 1 Then
          strTo = Pub_GetSpecMan("ACS郵件通知主管")
          If strTo <> "" Then
            strB2 = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08,mc09) " & _
                     "values('" & strUserNum & "','" & strTo & "',to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss') " & _
                     ",'" & pCP01 & "-" & pCP02 & IIf(pCP03 & pCP04 = "000", "", "-" & pCP03 & "-" & pCP04) & "(" & strYear & "年)年度結算：主管已確認，請確認最後一筆款項是否正確。','同摘要',null) "
            cnnConnection.Execute strB2
          End If
       Else
          '年度結算並且發mail通知對象【正本：顧服組主管】
          strB2 = "delete from ACS_TIPS_RATE1 where AT101='" & pCP01 & "' and AT102='" & pCP02 & "' and AT103='" & pCP03 & "' and AT104='" & pCP04 & "' and AT105='" & strYear & "' "
          cnnConnection.Execute strB2
          '更新:年度結算系統別(CPS、S、TT、S、L)
          strB2 = "update acs_tips_rate set atr11=(select cp01 from caseprogress where cp09=atr06) " & _
                  "where atr11 is null and atr01='" & pCP01 & "' and atr02='" & pCP02 & "' and atr03='" & pCP03 & "' and atr04='" & pCP04 & "' and atr05='" & strYear & "' "
          cnnConnection.Execute strB2
          strB1 = "select atr11,sum(nvl(atr09,0)) as atr09,sum(nvl(atr10,0)) as atr10 from acs_tips_rate " & _
                  "where atr01='" & pCP01 & "' and atr02='" & pCP02 & "' and atr03='" & pCP03 & "' and atr04='" & pCP04 & "' and atr05='" & strYear & "' group by atr11 order by atr11 "
          intB = 1
          strB2 = ""
          Set rsBD = ClsLawReadRstMsg(intB, strB1)
          If intB = 1 Then
             rsBD.MoveFirst
             Do While Not rsBD.EOF
                strATR09 = Round((Val(strRecTot) * (Val("" & rsBD.Fields("atr09")) / 100)), 2)
                strATR10 = Round(IIf(strSaleTot = "0", strRecTot, strSaleTot) * (Val("" & rsBD.Fields("atr10")) / 100), 2)
                strAtr09T = Val(strAtr09T) + Val(strATR09)
                strAtr10T = Val(strAtr10T) + Val(strATR10)
                strB2 = strB2 & vbCrLf & rsBD.Fields("atr11") & "：專業點數" & strATR09 & "，業績獎金(顧服獎金)" & strATR10
                
                strB1 = "INSERT INTO ACS_TIPS_RATE1 (AT101,AT102,AT103,AT104,AT105,AT106,AT107,AT108,AT109,AT110,AT111,AT112) " & _
                        "VALUES ('" & pCP01 & "','" & pCP02 & "','" & pCP03 & "','" & pCP04 & "','" & strYear & "','" & rsBD.Fields("atr11") & "' " & _
                        ",'" & strRecTot & "','" & rsBD.Fields("atr09") & "','" & strATR09 & "','" & rsBD.Fields("atr10") & "','" & strATR10 & "',to_char(sysdate,'yyyymmdd')) "
                cnnConnection.Execute strB1
                rsBD.MoveNext
             Loop
          Else '無智財協作案件用NONE代表年度結算
             strB1 = "INSERT INTO ACS_TIPS_RATE1 (AT101,AT102,AT103,AT104,AT105,AT106,AT107,AT108,AT109,AT110,AT111,AT112) " & _
                     "VALUES ('" & pCP01 & "','" & pCP02 & "','" & pCP03 & "','" & pCP04 & "','" & strYear & "','NONE' " & _
                     ",'" & strRecTot & "','100','" & strRecTot & "','100','" & strSaleTot & "',to_char(sysdate,'yyyymmdd')) "
             cnnConnection.Execute strB1
             strB2 = strB2 & vbCrLf & "NONE"
          End If
          If strB2 <> "" And bolMailTo = True Then
             strTo = Pub_GetSpecMan("ACS郵件通知主管")
             If strTo <> "" Then
                '總專業點數=繳款總點數、總業績獎金(顧服獎金)=繳款總點數*(100-智權獎金%)
                strB2 = "請顧服組主管確認最終點數分配後通知財務處!" & vbCrLf & _
                        strYear & "年繳款總點數：" & strRecTot & "，專業點數" & strRecTot & "，業績獎金(顧服獎金)" & IIf(strSaleTot = "0", strRecTot, strSaleTot) & vbCrLf & _
                        "智財協作點數：" & strB2 & vbCrLf & _
                        vbCrLf & vbCrLf & "主管請至【法務系統->ACS->資料處理->TIPS案請款階段分配比例-年度結算作業】進行主管確認。"
                strB2 = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08,mc09) " & _
                         "values('" & strUserNum & "','" & strTo & "',to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss') " & _
                         ",'" & pCP01 & "-" & pCP02 & IIf(pCP03 & pCP04 = "000", "", "-" & pCP03 & "-" & pCP04) & "(" & strYear & "年)最後一階段款項已入帳，顧服組主管請於系統確認各智財協作部門分配點數', " & _
                         "'" & ChgSQL(strB2) & "',null) "
                cnnConnection.Execute strB2
             End If
          End If
       End If  '---end ---年度結算並且發mail通知
   End If   '---end--○○○年最後一階段款項
   Set rsBD = Nothing
   
   Exit Sub
   
End Sub

'Added by Morgan 2025/5/6
'特定客戶頁首右上方加印Confidential
Public Sub PUB_AddConfidential(oSelection As Word.Selection, pContent As String)
   
   Dim stQuery As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   Dim stCustNo As String
   
   If m_MySt(1) <> "P" And m_MySt(1) <> "PS" And m_MySt(1) <> "CFP" And m_MySt(1) <> "CPS" Then Exit Sub  'Added by Morgan 2025/5/8 目前只控制專利案
   
   If InStr(pContent, "致：") > 0 Then
      stCustNo = Pub_GetSpecMan("附件要加印機密的客戶")
      If stCustNo <> "" Then
         stQuery = "SELECT NVL(NVL(CU104,CU04),CU05||' '||CU88||' '||CU89||' '||CU90) FROM customer WHERE instr('" & stCustNo & "',cu01)>0"
         intQ = 1
         Set rsQuery = ClsLawReadRstMsg(intQ, stQuery)
         If intQ = 1 Then
            Do While Not rsQuery.EOF
               If InStr(pContent, "致：" & rsQuery(0)) > 0 Then
                  With oSelection
                  .PageSetup.HeaderDistance = g_WordAp.CentimetersToPoints(0.1)
                  .Font.Italic = wdToggle
                  .Font.Bold = wdToggle
                  .Font.Size = 22 'Modified by Morgan 2025/5/7
                  .Font.Name = "Calibri"
                  .ParagraphFormat.Alignment = wdAlignParagraphRight
                  .TypeText "Confidential"
                  End With
                  Exit Do
               End If
               rsQuery.MoveNext
            Loop
         End If
      End If
   End If
   
   Set rsQuery = Nothing
End Sub

'Added by Lydia 2025/05/09 ACS案TIPS請款階段：輸入請款金額，回傳相同金額的收據號碼
'Modified by Lydia 2025/06/03 傳入指定案件性質+pPtyList
Public Function Pub_ACS_TIPS_GetCp60(ByVal pType As String, ByVal pCP01 As String, ByVal pCP02 As String, ByVal pCP03 As String, ByVal pCP04 As String, ByVal pAmt1 As String, Optional ByVal pOldList As String, Optional ByVal pNewList As String, Optional ByVal pPtyList As String) As String
'pType=1(發文作業使用)
Dim intA As Integer, strConA As String, strConB As String
Dim strTempA(0 To 10) As String
Dim rsAD As New ADODB.Recordset

   If Val(pAmt1) = 0 Then Exit Function
   
   Pub_ACS_TIPS_GetCp60 = ""
   
   'Modified by Lydia 2025/06/03 改成可以傳入指定案件性質---ACS案針對其他案件性質增加請款發文定稿通知
   'strTempA(0) = " select a0j01,a0j13,a0j22,a0k08,sum(nvl(a0j09,0)+ nvl(a0j10,0)) as sfee" & _
      " from caseprogress c1,acc0j0,acc0k0" & _
      " where c1.cp01='" & pCP01 & "' and c1.cp02='" & pCP02 & "' and c1.cp03='" & pCP03 & "' and c1.cp04='" & pCP04 & "' and c1.cp10 in (" & ACSforTIPSstep & ")" & _
      " and nvl(c1.cp16,0)>0 and c1.cp159=0 and a0j01=c1.cp09 and a0j13=a0k01" & _
      " and a0j13 not in (select c2.cp60 from caseprogress c2 where c2.cp01='" & pCP01 & "' and c2.cp02='" & pCP02 & "' and c2.cp03='" & pCP03 & "' and c2.cp04='" & pCP04 & "'" & _
      " and c2.cp159=0 and nvl(c2.cp156,0) > 0 and c2.cp60 is not null " & IIf(pOldList <> "", "and cp60 in (" & GetAddStr(pOldList) & ")", "") & " )" & _
      " group by a0j01,a0j13,a0j22,a0k08 having sum(nvl(a0j09,0)+ nvl(a0j10,0)) <> 0"
   strTempA(0) = " select a0j01,a0j13,a0j22,a0k08,sum(nvl(a0j09,0)+ nvl(a0j10,0)) as sfee" & _
      " from caseprogress c1,acc0j0,acc0k0" & _
      " where c1.cp01='" & pCP01 & "' and c1.cp02='" & pCP02 & "' and c1.cp03='" & pCP03 & "' and c1.cp04='" & pCP04 & "' " & _
      IIf(pPtyList <> "", " and c1.cp10 in (" & pPtyList & ")", " and c1.cp10 in (" & ACSforTIPSstep & ")") & _
      " and nvl(c1.cp16,0)>0 and c1.cp159=0 and a0j01=c1.cp09 and a0j13=a0k01" & _
      " and a0j13 not in (select c2.cp60 from caseprogress c2 where c2.cp01='" & pCP01 & "' and c2.cp02='" & pCP02 & "' and c2.cp03='" & pCP03 & "' and c2.cp04='" & pCP04 & "'" & _
      " and c2.cp159=0 " & IIf(pPtyList <> "", "and c2.cp158>0", "and nvl(c2.cp156,0) > 0") & " and c2.cp60 is not null " & IIf(pOldList <> "", "and cp60 in (" & GetAddStr(pOldList) & ")", "") & " )" & _
      " group by a0j01,a0j13,a0j22,a0k08 having sum(nvl(a0j09,0)+ nvl(a0j10,0)) <> 0"
   strTempA(0) = "select * from (" & strTempA(0) & ") where sfee=" & Val(pAmt1) & IIf(pNewList <> "", " and a0j13 not in (" & GetAddStr(pNewList) & ")", "")
   
   intA = 1
   Set rsAD = ClsLawReadRstMsg(intA, strTempA(0))
   If intA = 1 Then
      If rsAD.RecordCount = 1 Then
         Pub_ACS_TIPS_GetCp60 = "" & rsAD.Fields("a0j13")
      Else
         '提供選單
         strTempA(0) = rsAD.RecordCount: strConA = ""
         rsAD.MoveFirst
         Do While Not rsAD.EOF
            strTempA(rsAD.AbsolutePosition) = "" & rsAD.Fields("a0j13")
            strConA = strConA & vbCrLf & rsAD.AbsolutePosition & String(10, " ") & rsAD.Fields("a0j13") & String(6, " ") & rsAD.Fields("a0j22")
            rsAD.MoveNext
         Loop
         strConA = "請款金額與收據金額相符合超過1筆，" & vbCrLf & _
                   "請依提示請輸入選項，" & vbCrLf & _
                   "若要中斷" & IIf(pType = "1", "發文", "輸入") & "作業，請輸入選項0：" & vbCrLf & vbCrLf & _
                   "選項    收據號碼       帳款類別" & vbCrLf & _
                   "====  =========     ===============" & strConA
JumpToReInput:
         'Modified by Lydia 2025/06/03
         'strConB = InputBox(strConA, "TIPS請款階段作業檢查", "0")
         strConB = InputBox(strConA, IIf(pPtyList <> "", "發文請款金額檢查", "TIPS請款階段作業檢查"), "0")
         If strConB = "0" Then
            Exit Function
         Else
            '非數字=0
            If Val(strConB) <= 0 Or Val(strConB) > Val(strTempA(0)) Then
               GoTo JumpToReInput
            Else
               Pub_ACS_TIPS_GetCp60 = strTempA(Val(strConB))
            End If
         End If
      End If
   End If
   Set rsAD = Nothing
End Function

'Added by Morgan 2025/7/22
'檢查E化信函是否要印掛號字樣
Private Function ChkRegisteredMail() As Boolean
   Dim stSQL As String
   Dim intQ As Integer
   Dim rsQuery As ADODB.Recordset
   
   If g_LD18 <> "" Then
      stSQL = "select * from letterprogress where lp01='" & g_LD18 & "' and lp52='Y' and lp10='Y' and lp26='Y'"
      intQ = 1
      Set RsTemp = ClsLawReadRstMsg(intQ, stSQL)
      If intQ = 1 Then
         ChkRegisteredMail = True
      End If
   End If
   
   Set rsQuery = Nothing
End Function

'Add by Morgan 2010/12/23
'項目說明解析
Public Function PUB_ParseItemDesc(ByVal pAmount As Double, ByVal pDesc As String) As String
   Dim iPos1 As Integer, iPos2 As Integer
   Dim strUnit As String, strUnitPrice As String, strQty As String
   Dim dblUnit As Double, dblUnitPrice As Double
   If InStr(pDesc, "[QTY]") > 0 Or InStr(pDesc, "[$") > 0 Or InStr(pDesc, "[#") > 0 Then
      '單價
      iPos1 = InStr(pDesc, "[$")
      If iPos1 > 0 Then
         iPos2 = InStr(pDesc, "$]")
         If iPos2 > iPos1 Then
            strUnitPrice = Mid(pDesc, iPos1 + 2, iPos2 - iPos1 - 2)
            If IsNumeric(strUnitPrice) Then
               dblUnitPrice = Format(strUnitPrice)
            End If
            pDesc = Left(pDesc, iPos1 - 1) & strUnitPrice & Mid(pDesc, iPos2 + 2)
         End If
      End If
      '單位
      dblUnit = 1
      iPos1 = InStr(pDesc, "[#")
      If iPos1 > 0 Then
         iPos2 = InStr(pDesc, "#]")
         If iPos2 > iPos1 Then
            strUnit = Mid(pDesc, iPos1 + 2, iPos2 - iPos1 - 2)
            If IsNumeric(strUnit) Then
               dblUnit = Format(strUnit)
            End If
            pDesc = Left(pDesc, iPos1 - 1) & dblUnit & Mid(pDesc, iPos2 + 2)
         End If
      End If
      '數量
      If pAmount > 0 And dblUnitPrice > 0 And dblUnit > 0 Then
         strQty = Round(pAmount / dblUnitPrice * dblUnit)
      End If
      pDesc = Replace(pDesc, "[QTY]", strQty)
   End If
   PUB_ParseItemDesc = pDesc
End Function

'Added by Morgan 2025/11/11
'客戶通知函寫入發文日
Public Function PUB_UpdCustLetterDate(pFile As String) As Boolean
   Dim bolFind As Boolean
   Dim stFindStr As String, stReplaceStr As String
   
   stFindStr = PUB_GetCusLetterDate
   stReplaceStr = PUB_GetCusLetterDate(, True)
   
   If TypeName(g_WordAp) <> "Application" Then
      Set g_WordAp = New Word.Application
   End If
   g_WordAp.Documents.Open pFile
   g_WordAp.Selection.Find.ClearFormatting
   '檢查定稿日是否為當天
   g_WordAp.Selection.Find.Text = stReplaceStr
   bolFind = g_WordAp.Selection.Find.Execute()
   '若否，再檢查否有當月無日
   If Not bolFind Then
      g_WordAp.Selection.Find.Text = stFindStr
      g_WordAp.Selection.Find.Replacement.Text = ""
      bolFind = g_WordAp.Selection.Find.Execute()
      '若否，用上個月日期再搜尋一次(可能有跨月或跨年問題)
      If Not bolFind Then
         strLetterDate = CompDate(1, -1, strSrvDate(1))
         stFindStr = PUB_GetCusLetterDate(strLetterDate)
         g_WordAp.Selection.Find.Text = stFindStr
         bolFind = g_WordAp.Selection.Find.Execute()
      End If
   
      If bolFind Then
         g_WordAp.ActiveDocument.TrackRevisions = False '不要追蹤修訂否則會有標記
         g_WordAp.Selection.TypeText stReplaceStr
         g_WordAp.ActiveDocument.Save
      End If
   End If
   PUB_UpdCustLetterDate = bolFind
   g_WordAp.Quit wdDoNotSaveChanges
   Set g_WordAp = Nothing
End Function

'Added by Morgan 2025/11/13
'每月發文CFP案件-日本部翻譯
Public Function PUB_JPTranCaseExport(pToMonth As String, Optional pXLSX As String, Optional pSaveFolder As String = "\", Optional pErrMsg As Boolean = False, Optional pMail As Boolean = False) As Boolean
   
   Dim stDateFr As String, stDateTo As String
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   Dim xlsAgentPoint As New Excel.Application
   Dim wksrpt As New Worksheet
   Dim strSubject1 As String
   Dim xlsFileNameA As String
   Dim intCounter As Integer, ii As Integer, iUBound As Integer
   Dim stTO As String, stCC As String
   Dim stColChar As String
   
On Error GoTo ErrHnd
   
   stDateTo = pToMonth
   strSubject1 = stDateTo & "月發文CFP案件-日本部翻譯"
   xlsFileNameA = App.path & pSaveFolder & strSubject1 & ".xlsx"
   
   If Dir(xlsFileNameA) <> "" Then
      Kill xlsFileNameA
   End If
   
   stDateTo = DBDATE(stDateTo & "26")
   stDateFr = CompDate(1, -1, stDateTo)
      
   stSQL = "SELECT CP01||'-'||CP02||DECODE(CP03||CP04,'000','',CP03||CP04) 本所案號, CP14||' '||S1.ST02 承辦人, SQLDATET(CP157) 給案日" & _
         ", SQLDATET(TF26) 完稿期限, SQLDATET(CP06) 本所期限, SQLDATET(EP09) 完稿日, SQLDATET(EP07) 會稿日, SQLDATET(CP27) 發文日" & _
         ", TF04||decode(tf04,null,null,'P') 分配點數, TF36 備註,cp27,cp09" & _
         " FROM CASEPROGRESS, ENGINEERPROGRESS, CASEPROPERTYMAP, STAFF S1,TRANSFEE,Staff_IdMap,STAFF S2, PATENT" & _
         " WHERE cp01='CFP' and cp12 not like 'F%' and cp14 like 'F%' and cp27>=" & stDateFr & " and cp27<" & stDateTo & _
         " AND CP09=EP02(+) AND TF01(+)=CP09 AND CPM01(+)=CP01 AND CPM02(+)=CP10 AND S1.ST01(+)=CP14 and sim02(+)=cp14 and S2.st01(+)=sim01" & _
         " and s2.st93 like 'J%'" & _
         " AND PA01(+)=CP01 AND PA02(+)=CP02 AND PA03(+)=CP03 AND PA04(+)=CP04 and pa09 in ('011','231')" & _
         " ORDER BY cp27,cp09"
   
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      intCounter = 1
      iUBound = 9
      xlsAgentPoint.SheetsInNewWorkbook = 1 '預設工作表數目
      xlsAgentPoint.Workbooks.add
      xlsAgentPoint.Application.WindowState = xlMinimized
      'xlsAgentPoint.Application.Visible = True
      Set wksrpt = xlsAgentPoint.Worksheets(1)
      '設定欄位名稱及欄寬
      For ii = 0 To iUBound
         stColChar = Chr(Asc("A") + ii)
         wksrpt.Range(stColChar & intCounter).Value = rsQuery.Fields(ii).Name
         If rsQuery.Fields(ii).Name = "備註" Then
            wksrpt.Columns(stColChar).HorizontalAlignment = xlLeft
            wksrpt.Range(stColChar & intCounter).HorizontalAlignment = xlCenter
         Else
            wksrpt.Columns(stColChar).HorizontalAlignment = xlCenter
         End If
      Next ii
      
      stColChar = Chr(Asc("A") + iUBound)
      wksrpt.Range("A" & intCounter & ":" & stColChar & intCounter).Select
      
         With xlsAgentPoint.Selection.Font
             .Name = "微軟正黑體"
             .FontStyle = "粗體"
             .Size = 14
             .Strikethrough = False
             .Superscript = False
             .Subscript = False
             .OutlineFont = False
             .Shadow = False
             .ColorIndex = xlAutomatic
             .TintAndShade = 0
         End With
         With xlsAgentPoint.Selection.Interior
             .Pattern = xlSolid
             .PatternColorIndex = xlAutomatic
             .Color = 15773440
             .TintAndShade = 0
             .PatternTintAndShade = 0
         End With
      
      wksrpt.Rows(intCounter).EntireRow.AutoFit
      wksrpt.Rows(intCounter).RowHeight = wksrpt.Rows(intCounter).Height + 10
      
      With rsQuery
      .MoveFirst
      Do While Not .EOF
         intCounter = intCounter + 1
         For ii = 0 To iUBound
            stColChar = Chr(Asc("A") + ii)
            wksrpt.Range(stColChar & intCounter).Value = "" & rsQuery.Fields(ii)
         Next
         wksrpt.Rows(intCounter).EntireRow.AutoFit
         wksrpt.Rows(intCounter).RowHeight = wksrpt.Rows(intCounter).Height + 4
         .MoveNext
      Loop
      End With
      
      '自動設定欄寬
      For ii = 0 To iUBound
         stColChar = Chr(Asc("A") + ii)
         wksrpt.Columns(stColChar).EntireColumn.AutoFit
         wksrpt.Columns(stColChar).ColumnWidth = wksrpt.Columns(stColChar).ColumnWidth + 2
         If wksrpt.Range(stColChar & "1").ColumnWidth > 80 Then
            wksrpt.Range(stColChar & "1").ColumnWidth = 80
         End If
      Next
      
      '加框線ii
      stColChar = Chr(Asc("A") + iUBound)
      wksrpt.Range("A1:" & stColChar & intCounter).Select
      xlsAgentPoint.Selection.Borders(xlDiagonalDown).LineStyle = xlNone
      xlsAgentPoint.Selection.Borders(xlDiagonalUp).LineStyle = xlNone
      With xlsAgentPoint.Selection.Borders(xlEdgeLeft)
          .LineStyle = xlContinuous
          .ColorIndex = 0
          .TintAndShade = 0
          .Weight = xlThin
      End With
      With xlsAgentPoint.Selection.Borders(xlEdgeTop)
          .LineStyle = xlContinuous
          .ColorIndex = 0
          .TintAndShade = 0
          .Weight = xlThin
      End With
      With xlsAgentPoint.Selection.Borders(xlEdgeBottom)
          .LineStyle = xlContinuous
          .ColorIndex = 0
          .TintAndShade = 0
          .Weight = xlThin
      End With
      With xlsAgentPoint.Selection.Borders(xlEdgeRight)
          .LineStyle = xlContinuous
          .ColorIndex = 0
          .TintAndShade = 0
          .Weight = xlThin
      End With
      With xlsAgentPoint.Selection.Borders(xlInsideVertical)
          .LineStyle = xlContinuous
          .ColorIndex = 0
          .TintAndShade = 0
          .Weight = xlThin
      End With
      With xlsAgentPoint.Selection.Borders(xlInsideHorizontal)
          .LineStyle = xlContinuous
          .ColorIndex = 0
          .TintAndShade = 0
          .Weight = xlThin
      End With
      wksrpt.Range("A1").Select
      
      xlsAgentPoint.Workbooks(1).SaveAs FileName:=xlsFileNameA, FileFormat:=51
      xlsAgentPoint.Workbooks.Close
      xlsAgentPoint.Quit
      
      pXLSX = xlsFileNameA
      
      If pMail Then
         stTO = "account"
         stCC = "99037;82026;79075"
         PUB_SendMail strUserNum, stTO, "", strSubject1, "如旨" & vbCrLf & vbCrLf, , xlsFileNameA, , , , stCC, , , , True
      End If
   End If
   PUB_JPTranCaseExport = True
   
ErrHnd:
   If Err.Number <> 0 Then
      If pErrMsg Then
         MsgBox Err.Description, vbCritical
      Else
         WLog Err.Description
      End If
   End If
   Set rsQuery = Nothing
   Set wksrpt = Nothing
   Set xlsAgentPoint = Nothing
End Function


Attribute VB_Name = "basQuery"
'Memo By Sindy 2012/12/5 智權人員欄已修改
'Memo By Sindy 2011/2/15 SQLDate已檢查
'Memo By Sindy 2010/8/5 日期欄已修改
'Modified by Morgan 2011/12/26 Serverdte-19110000 改用 strSrvDate(2)
Option Explicit
 
Public pub_strCommand As String 'Added by Morgan 2020/4/24
Public bolWin7ENloaded As Boolean 'Added by Morgan 2016/10/21 Win7 是否有載入EN輸入法

'Add by Morgan 2011/9/14 變數整合
Public intWSysKindThis As Integer
Public intForm As Integer, strCP09Num As String, strArryCP09() As String
Public intNowRec As Integer, strCP10() As String, strCaseKind() As String

Public IsNoExistData As Boolean
Public intLevel As Integer

Public strKey1 As String
Public StrKey2 As String
Public strKey3 As String
Public strKey4 As String
Public strKey5 As String
Public strKey6 As String
Public strKey7 As String
Public strKey8 As String
Public strKey9 As String
Public strKey10 As String

Public strFormName As String
Public bolToEndByNick As Boolean                         '確定是否結束
Public bolGoBackByNick As Boolean                         '確定是否回前畫面
Public bolFNation As Boolean                             '判斷是否為國外
Public StrStartSystemByNick As String

'Add By Sindy 2014/10/17 使用於oList水平捲軸
Public Declare Function SendMessageByNum Lib "user32" _
  Alias "SendMessageA" (ByVal hWnd As Long, ByVal _
  wMsg As Long, ByVal wParam As Long, ByVal lParam As Long) As Long
Public Const LB_SETHORIZONTALEXTENT = &H194
'2014/10/17 END

'財務系統用
Public strExitControl As String, strFormLink As String, strSendString As String, strSaveConfirm As String, strControlButton As String, strJump  As String
Public strDelConfirm As String, strReceiptConfirm As String, lngBookMark As Long
Public strUserDept As String, strUserLevel As String, strCustNo As String, strCompanyNo As String, strItemNo As String
Public strAccount As String
Public strTitle As String, strComPer As String, strRemark As String, strDate As String

Public lngTotal As Long, dblTotal As Double, dblRate As Double
Public strCondition As String, strCon1 As String, strCon2 As String, strCon3 As String, strCon4 As String, strCon5 As String, strCon6 As String, strCon7 As String, strCon8 As String, strCon9 As String, strCon10 As String
Public strConTitle As String, strCondition1 As String, strCondition2 As String

'Add by Morgan 2003/12/30
Public strPassWord As String
Public strUserName As String
Public strUserNum As String
Public strUser1Num As String
Public strGroup As String
Public Pub_StrUserSt03 As String
Public Pub_StrUserSt93 As String 'Added by Morgan 2023/12/18 新部門
Public Pub_StrUserSt15 As String '使用者收文所屬部門
Public Pub_StrUserSt17 As String 'Add by Morgan 2007/1/25
Public pub_strUserOffice As String '使用者所別
Public Pub_strUserST05 As String   'Add by Lydia 2014/10/31 使用者等級
Public Pub_strUserST11 As String  '使用者群組
'Add By Cheng 2002/04/11
Public g_dbl_NPSerialNo As Double '下一程序檔的序號(PK)

Public cnnConnection As New ADODB.Connection
Public adoRecordset As New ADODB.Recordset
Public adoRecordset1 As New ADODB.Recordset
Public AdoRecordSet3 As New ADODB.Recordset
Public adoEng As New ADODB.Connection
'Public cnnRptConn As New ADODB.Connection 'Removed by Morgan 2025/9/9 沒用了

Public adoTaie As New ADODB.Connection
'Public adoTemp As New ADODB.Connection 'Removed by Morgan 2025/9/9 沒用了
Public adoRecord As New ADODB.Recordset
Public strPublicTemp As String

'Add By Cheng 2001/12/28
Public pub_bln_NeedUpdate As Boolean '是否需要執行更新
Public pub_bln_UpdateActive As Boolean '更新程式是否執行

Public Const YellowColor = &HC0FFFF
Public Const OFS_MAXPATHNAME = 128
Public Const MAX_PATH = 260
Public Const OF_READ = &H0
Public Const CB_SHOWDROPDOWN = &H14F

Private Const WM_NCACTIVATE = &H86
Private Const SC_CLOSE = &HF060&
Private Const MIIM_STATE = &H1
Private Const MIIM_ID = &H2
Private Const MIIM_TYPE = &H10
Private Const MFT_SEPARATOR = &H800
Private Const MFT_STRING = &H0
Private Const MFS_ENABLED = &H0
Private Const MFS_CHECKED = &H8
Private Const MFS_GRAYED = &H3&
'add by nickc 2005/06/13
Private Const CSIDL_PERSONAL = &H5 'My Documents

Public Type SYSTEMTIME
        wYear As Integer
        wMonth As Integer
        wDayOfWeek As Integer
        wDay As Integer
        wHour As Integer
        wMinute As Integer
        wSecond As Integer
        wMilliseconds As Integer
End Type

Public Type SHFILEINFO
        hIcon As Long                      '  out: icon
        iIcon As Long          '  out: icon index
        dwAttributes As Long               '  out: SFGAO_ flags
        szDisplayName As String * MAX_PATH '  out: display name (or path)
        szTypeName As String * 80         '  out: type name
End Type

Public Type FILETIME
        dwLowDateTime As Long
        dwHighDateTime As Long
End Type

Public Type BY_HANDLE_FILE_INFORMATION
        dwFileAttributes As Long
        ftCreationTime As FILETIME
        ftLastAccessTime As FILETIME
        ftLastWriteTime As FILETIME
        dwVolumeSerialNumber As Long
        nFileSizeHigh As Long
        nFileSizeLow As Long
        nNumberOfLinks As Long
        nFileIndexHigh As Long
        nFileIndexLow As Long
End Type

Public Type OFSTRUCT
        cBytes As Byte
        fFixedDisk As Byte
        nErrCode As Integer
        Reserved1 As Integer
        Reserved2 As Integer
        szPathName(OFS_MAXPATHNAME) As Byte
End Type

Public Type TIME_ZONE_INFORMATION
      bias As Long
      StandardName(32) As Integer
      StandardDate As SYSTEMTIME
      StandardBias As Long
      DaylightName(32) As Integer
      DaylightDate As SYSTEMTIME
      DaylightBias As Long
End Type
Public Declare Function OpenFile Lib "kernel32" (ByVal lpFileName As String, lpReOpenBuff As OFSTRUCT, ByVal wStyle As Long) As Long
Public Declare Function GetFileInformationByHandle Lib "kernel32" (ByVal hFile As Long, lpFileInformation As BY_HANDLE_FILE_INFORMATION) As Long
Public Declare Function CloseHandle Lib "kernel32" (ByVal hObject As Long) As Long
Public Declare Function GetTimeZoneInformation Lib "kernel32" (lpTimeZoneInformation As TIME_ZONE_INFORMATION) As Long
Public Declare Function FileTimeToSystemTime Lib "kernel32" (lpFileTime As FILETIME, lpSystemTime As SYSTEMTIME) As Long
Public Declare Function TerminateProcess Lib "kernel32" (ByVal hProcess As Long, ByVal uExitCode As Long) As Long
Public Const PROCESS_TERMINATE = &H1
'end 2011/9/14

Public strExc(0 To 10) As String
Public ProState As String * 1 '設定承辦人狀態 1：個人   2：主管   '3：分所
                                             '設定繪圖人員狀態 1：個人--維護   2：主管--查詢   3：主管--維護  4：個人--查詢
Public ProSysState As String * 1   '設定承辦人或繪圖人員   1：承辦人  2：繪圖人員
'Public objLawDll As Object
'edit by nickc 2007/02/05 不用 dll 了
'Public objLawDll As New clsLaw
'Add By Cheng 2002/07/30
Public intI As Integer
Public RsTemp As New ADODB.Recordset
Public strSql As String

Public Systemkind_g As String       '使用者可用系統別
Public Systemkind_g_P As String       '使用者可用系統別(專)
Public Systemkind_g_T As String       '使用者可用系統別(商)
Public Systemkind_g_TnoS As String       '使用者可用系統別(商不包含服務)

'910919 nick 商標的專用期限判斷值
Public NickTmNa12 As Integer
Public NickTmNa13 As Integer
'Add By Cheng 2003/01/29
Public pub_AddressListSN As Double '地址條序號
'Add By Cheng 2003/03/14
Public pub_strDate As String '定稿日期
Public pub_strTime As String '定稿時間
'Add By Cheng 2003/03/31
Public pub_blnBatchPrintAddress As Boolean '判斷是否整批列印地址條
'Add By Cheng 2003/04/02
Public pub_blnARPrintAddress As Boolean '判斷請款單輸入是否印地址條
'92.04.16 nick
'紀錄 form 用
Public ArrFormByNick As String
Public tmpBol As Variant
Public pub_str_LoginSucceeded As String '判斷是否登入成功 1 : 成功 ,2:失敗 ,""尚未登入
Public Pub_StrST52 As Boolean     '2010/5/10 add by sonia 是否為離職智權人員的帶人主管

'edit by nickc 2007/02/02 不用 dll 了
'Move from basSart by Morgan 2004/3/12
'Public objPublicData As New clsPublicData

'add by nick 2004/07/29 將關閉鈕取消
Private Const xMenuID = 10&
Private hMenu As Long
Private Type MENUITEMINFO
    cbSize As Long
    fMask As Long
    fType As Long
    fState As Long
    wID As Long
    hSubMenu As Long
    hbmpChecked As Long
    hbmpUnchecked As Long
    dwItemData As Long
    dwTypeData As String
    cch As Long
End Type

Private MII As MENUITEMINFO
'Add by Morgan 2011/8/9
Public pub_WinSysPath As String '系統目錄
Public pub_PdfEnable As Boolean '圖檔是否可轉 Pdf 格式
Public Declare Sub Sleep Lib "kernel32" (ByVal dwMilliseconds As Long)

Public Declare Function WNetGetUser Lib "mpr.dll" Alias "WNetGetUserA" (ByVal lpName As String, ByVal lpUserName As String, lpnLength As Long) As Long
Public Declare Function GetSystemDirectory Lib "kernel32" Alias "GetSystemDirectoryA" (ByVal lpBuffer As String, ByVal nSize As Long) As Long
Public Declare Function SHGetSpecialFolderLocation Lib "shell32" (ByVal hwndOwner As Long, ByVal nFolder As Integer, ppidl As Long) As Long
Public Declare Function SHGetPathFromIDList Lib "shell32" Alias "SHGetPathFromIDListA" (ByVal pidl As Long, ByVal szPath As String) As Long
Public Declare Function SetMenuItemInfo Lib "user32" Alias "SetMenuItemInfoA" (ByVal hMenu As Long, ByVal un As Long, ByVal bool As Boolean, lpcMenuItemInfo As MENUITEMINFO) As Long
Public Declare Function GetMenuItemInfo Lib "user32" Alias "GetMenuItemInfoA" (ByVal hMenu As Long, ByVal un As Long, ByVal B As Long, lpMenuItemInfo As MENUITEMINFO) As Long
Public Declare Function GetSystemMenu Lib "user32" (ByVal hWnd As Long, ByVal bRevert As Long) As Long
Public Declare Function SendMessage Lib "user32" Alias "SendMessageA" (ByVal hWnd As Long, ByVal wMsg As Long, ByVal wParam As Long, lParam As Any) As Long

Public g_PrtForm001 As New ClsPrtForm001
Global strSysKind As String
'add by nick 2005/01/12 轉檔用
Type LogArr
    FileName As String    'with path
    FileNum As Long
    LogCount As Long
End Type
'add by nickc 2005/04/22  '判斷是否可以結餘
Global bolEndModCash As Boolean
'add by nickc 2005/08/19 判斷是否登入畫面已經消失
Public IsLoginFormIsUnload As Boolean
'add by nickc 2005/08/23 紀錄維護修改的案號，以便 reload 資料用，用完要清空
Public pub_ModifyCaseNum As String
'add by nickc 2005/09/20  開放可以印圖
Public Pub_Can_Copy_Pic As Boolean
'add by nickc 2005/11/23
Public m_GDIpToken         As Long                       ' Needed to close GDI+
'Add by Morgan 2008/5/15
Public pub_CallNextForm As Boolean '是否呼叫下一個表單(智權人員報價&期限通知用)
'Add by Morgan 2009/11/12 系統別資料
Public pub_SysKind(1 To 6) As String

'Add by Morgan 2006/4/11 判斷作業系統
Public pub_OS As Long
Public pub_OS_Ver As String '作業系統版本 Added by Morgan 2016/10/19
Private Declare Function GetVersionEx& Lib "kernel32" Alias "GetVersionExA" (lpStruct As OsVersionInfo)

Public pub_HostName As String


Private OsVers As OsVersionInfo

Type OsVersionInfo
   dwVersionInfoSize As Long
   dwMajorVersion As Long
   dwMinorVersion As Long
   dwBuildNumber As Long
   dwPlatform As Long
   szCSDVersion As String * 128
End Type

'add by nickc 2006/05/24
Type BITMAP '14 bytes
    bmType As Long          '=0
    bmWidth As Long         '點陣圖寬度(單位：像素)
    bmHeight As Long        '點陣圖高度(單位：像素)
    bmWidthBytes As Long    'the number of bytes in each scan line (word aligned)
    bmPlanes As Integer     '=1
    bmBitsPixel As Integer  '每個像素以幾位元儲存
    bmBits As Long          '指標。指向點陣資料陣列
End Type
Declare Function GetObject Lib "gdi32" Alias "GetObjectA" (ByVal hObject As Long, ByVal nCount As Long, lpObject As Any) As Long
Declare Function StretchBlt Lib "gdi32" (ByVal hDC As Long, ByVal X As Long, ByVal Y As Long, ByVal nWidth As Long, ByVal nHeight As Long, ByVal hSrcDC As Long, ByVal xSrc As Long, ByVal ySrc As Long, ByVal nSrcWidth As Long, ByVal nSrcHeight As Long, ByVal dwRop As Long) As Long
Public Const SRCCOPY        As Long = &HCC0020
'add by nickc 2006/06/06  加解密 start
Dim m_lOnBits(30)   As Long
Dim m_l2Power(30)   As Long
Dim m_bytOnBits(7)  As Byte
Dim m_byt2Power(7)  As Byte
Dim m_InCo(3) As Byte
Dim m_fbsub(255)    As Byte
Dim m_rbsub(255)    As Byte
Dim m_ptab(255)     As Byte
Dim m_ltab(255)     As Byte
Dim m_ftable(255)   As Long
Dim m_rtable(255)   As Long
Dim m_rco(29)       As Long
Dim m_Nk        As Long
Dim m_Nb        As Long
Dim m_Nr        As Long
Dim m_fi(23)    As Byte
Dim m_ri(23)    As Byte
Dim m_fkey(119) As Long
Dim m_rkey(119) As Long
Declare Sub CopyMemory Lib "kernel32" Alias "RtlMoveMemory" (ByVal Destination As Any, ByVal Source As Any, ByVal Length As Long)

'add by nickc 2006/12/06 mail Winsock 用 *********************************
Private Type GUID
    Data1 As Long
    Data2 As Integer
    Data3 As Integer
    Data4(7) As Byte
End Type
Private Declare Function RegCloseKey Lib "advapi32.dll" (ByVal hKey As Long) As Long
Private Declare Function RegOpenKeyEx Lib "advapi32.dll" Alias "RegOpenKeyExA" (ByVal hKey As Long, ByVal lpSubKey As String, ByVal ulOptions As Long, ByVal samDesired As Long, phkResult As Long) As Long
Private Declare Function RegQueryValueExString Lib "advapi32.dll" Alias "RegQueryValueExA" (ByVal hKey As Long, ByVal lpValueName As String, ByVal lpReserved As Long, lpType As Long, ByVal lpData As String, lpcbData As Long) As Long
Private Declare Function CoCreateGuid Lib "ole32.dll" (pGuid As GUID) As Long
Private Declare Function StringFromGUID2 Lib "ole32.dll" (pGuid As GUID, ByVal PointerToString As Long, ByVal MaxLength As Long) As Long
Public APics() As String
Public sBodyText As String
Public Const cBoundaryA As String = "Boundary_A_3435FE2_6617A_AA"
Public Const cBoundaryB As String = "Boundary_B_3435FE2_6617B_BB"
Public Const cCharset = "charset=""Big5""" & vbCrLf 'Added by Morgan 2019/11/21
Public Const cCTEnc = "Content-Transfer-Encoding: quoted-printable" & vbCrLf 'Added by Morgan 2019/11/21
Public Const cAST As String = "*"
Public Const cDASH2 As String = "--"
Public Const cDASH As String = "-"
Public Const cDOT As String = "."
Public Const cSEMIC As String = ";"
Public Const LEN1024 As Long = 1024
Public Const cSRC = "SRC="
Public Const R_BRACKET = ">"
Public Const cSPACE = " "
Public Const cEQUAL = "="

Public Const KEY_QUERY_VALUE = &H1
Public Const HKEY_CLASSES_ROOT = &H80000000
Public Const HKEY_CURRENT_USER = &H80000001

'add by nickc 2006/12/29 紀錄 mail 用
Public Type SeekMails
   fiSender As String
   fiReceiver As String
   fiRecriverNo As String
   fiSubject As String
   fiContent As String
   fiPS As String
End Type
'add by nickc 2007/01/04
Public bolMailFailNoAlert As Boolean    '不秀寄信錯誤訊息
Public bolMailSendOk As Boolean         '寄信成功失敗
Public g_strWriteSysLogFilePath As String '欲記錄Log的完整路徑及檔名 Add By Sindy 2018/5/28
Public PStr_SendMailKey1 As String      '寄信Key1 Add By Sindy 2017/11/16
Public PStr_SendMailKey2 As String      '寄信Key2 Add By Sindy 2017/11/16
Public PStr_SendMailKey3 As String      '寄信Key3 Add By Sindy 2017/11/16

'add by nick 2004/08/18 加入所有 table 欄位數變數
Global TF_CP As Integer   'Table_Fields_CP
Global TF_PA As Integer   'Table_Fields_PA
Global TF_TM As Integer  'Table_Fields_TM
Global TF_LC As Integer   'Table_Fields_LC
Global TF_HC As Integer   'Table_Fields_HC
Global tf_SP As Integer   'Table_Fields_SP
Global TF_NP As Integer   'Table_Fields_NP
Global TF_1K0 As Integer  'Table_Fields_1K0
Global TF_FA As Integer  'Table_Fields_FA Add by Morgan 2006/10/23
Global TF_CU As Integer  'Table_Fields_CU Add by Morgan 2006/10/23
Global TF_NHI As Integer 'Table_Fields_NHI 2013/1/17 add by sonia 補充保費明細檔欄位數
'end

'Added by Morgan 2017/4/20
Public strProvider As String
'Modified by Morgan 2022/3/7
'Public Const cProvider As String = "MSDAORA"
Public Const cProvider As String = "OraOLEDB.Oracle"
'end 2022/3/7
Public Const cOraProvider As String = "OraOLEDB.Oracle"
'end 2017/4/20
'add by nickc 2007/02/06 從 taiedll copy 出來
Public strServerName As String 'Added by Morgan 2019/5/22
Public Const ServerName = "M51CON"
Public Const UserName = "PGMID"
Public Const Password = "PGMPWD"
Public Const HWND_TOPMOST = -1
Public Const SWP_NOMOVE = &H2
Public Const SWP_NOSIZE = &H1
Public Declare Function SetWindowPos Lib "user32" (ByVal hWnd As Long, ByVal hWndInsertAfter As Long, ByVal X As Long, ByVal Y As Long, ByVal cx As Long, ByVal cy As Long, ByVal wFlags_ As Long) As Long
'add by nickc 2007/02/06 從 003 copy 出來
Public m_ShowMsg As Boolean
'move from mdimain 2007/02/07
Public intPCaseKind As Integer, intPWhere As Integer
'代理人新案查詢 move form service_const1 2007/02/07 nickc
Public Const 選擇專利案件性質1 = "發明申請"
Public Const 選擇專利案件性質2 = "設計申請"
Public Const 選擇專利案件性質3 = "新型申請"
Public Const 選擇專利案件性質4 = "聯合新申請"
Public Const 選擇商標案件性質1 = "申請"
'move from basstart 2007/02/07 nickc
Public blnIsFormBack As Boolean
Public ColSysName As New Collection
'add by nickc 2007/06/06 IME 用   *****start
Public Declare Function GetKeyboardLayout Lib "user32" (ByVal dwLayout As Long) As Long
Public Declare Function GetKeyboardLayoutList Lib "user32" (ByVal nBuff As Long, lpList As Long) As Long
Public Declare Function GetKeyboardLayoutName Lib "user32" Alias "GetKeyboardLayoutNameA" (ByVal pwszKLID As String) As Long 'Added by Morgan 2016/10/21
Public Declare Function LoadKeyboardLayout Lib "user32" Alias "LoadKeyboardLayoutA" (ByVal pwszKLID As String, ByVal Flags As Long) As Long 'Added by Morgan 2016/10/21
Public Declare Function ImmGetDescription Lib "imm32.dll" Alias "ImmGetDescriptionA" (ByVal HKL As Long, ByVal lpsz As String, ByVal uBufLen As Long) As Long
Public Declare Function ImmIsIME Lib "imm32.dll" (ByVal HKL As Long) As Long
Public Declare Function ActivateKeyboardLayout Lib "user32" (ByVal HKL As Long, ByVal Flags As Long) As Long
Public Declare Sub keybd_event Lib "user32" (ByVal bVk As Byte, ByVal bScan As Byte, ByVal dwFlags As Long, ByVal dwExtraInfo As Long)
Public Const KLF_REORDER = &H8 'Added by Morgan 2016/10/21
'                                                   ***** end
'end

'Add by Morgan 2008/7/4 是否檢查國外部/專利處期限通知
Public pub_bolInformCheck As Boolean
'Modify by Morgan 2009/2/19 改為變數並於start或重新連線時設定
'Add by Morgan 2008/3/31
'Public Const EFilePath = "\\FCP4\FCP_workflow" 'FCP電子檔存放路徑
'Add by Morgan 2008/5/27
'Public Const FCTeFilePath = "\\FCT\FCT_workflow" 'FCT電子檔存放路徑
Public EFilePath As String
Public FCTeFilePath As String
Public FCLeFilePath As String 'Add by Morgan 2009/4/13 FCL電子檔存放路徑
Public TeFilePath As String 'Add by Sindy 2012/1/11 T電子檔存放路徑
Public 往來記錄附件存放路徑 As String '往來記錄附件存放路徑
Public 法務案開庭紀要存放路徑 As String 'Add By Sindy 2011/6/10
Public 不得代理案件存放路徑 As String 'Add By Sindy 2012/3/19
Public 案件進度附件存放路徑 As String 'Added by Morgan 2012/4/13
Public CF代理人報價附件存放路徑 As String 'Add By Sindy 2012/12/22 CF代理人報價附件存放路徑
Public FCP電子送件檔案存放路徑 As String 'Added by Morgan 2013/7/29
Public GOOD_FTP_IP As String '可用的 FTP SERVER IP
Public 正式資料庫電腦名稱 As String 'Added by Morgan 2017/9/4
Public pub_Word2Pdf As Boolean 'Added by Morgan 2017/9/15 Word是否支援另存Pdf格式
'Public FCP命名追蹤暫存 As String 'Added by Lydia 2017/12/04 'Mark by Lydia 2023/10/12 改用原始檔區存放
'Public FCP命名追蹤收文區 As String 'Added by Lydia 2017/12/04 'Remove by Lydia 2021/12/06 (109/4/6)已將\\Typing2的"English_Vers"和"專利案件"的案件資料夾，全部搬到原始檔區
Public T案收文齊備排除  As String  'Move by Lydia 2019/04/10 從basUpdate搬來
'end 2009/2/19

Public pub_PdftkEXE As String 'pdf合併程式完整路徑 Added by Morgan 2014/5/9
Public pub_PdftkName As String 'pdf合併程式名稱 Added by Morgan 2014/5/9

'Add by Morgan 2009/5/18
Public FTP_IP As String 'FTP Server IP
'2009/12/16 add by sonia
Public pub_QL04 As String  '查詢印表記錄檔操作畫面
Public pub_QL05 As String  '查詢印表記錄檔條件1
Public pub_QL06 As Double  '查詢印表記錄檔結果筆數
Public pub_QL07 As String  '查詢印表記錄檔條件2
'2009/12/16 end

'Added by Morgan 2012/2/1
Public Declare Function OpenProcess Lib "kernel32" (ByVal dwDesiredAccess As Long, ByVal bInheritHandle As Long, ByVal dwProcessId As Long) As Long
Public Const SYNCHRONIZE = &H100000
Public Declare Function WaitForSingleObject Lib "kernel32" (ByVal hHandle As Long, ByVal dwMilliseconds As Long) As Long
Public Const INFINITE = &HFFFFFFFF

'Add by Morgan 2009/5/18
Public Declare Function InternetOpen Lib "wininet.dll" Alias "InternetOpenA" (ByVal sAgent As String, ByVal lAccessType As Long, ByVal sProxyName As String, ByVal sProxyBypass As String, ByVal lFlags As Long) As Long
Public Declare Function InternetGetLastResponseInfo Lib "wininet.dll" Alias "InternetGetLastResponseInfoA" (lpdwError As Long, ByVal lpszBuffer As String, lpdwBufferLength As Long) As Boolean
Public Declare Function InternetConnect Lib "wininet.dll" Alias "InternetConnectA" (ByVal hInternetSession As Long, ByVal sServerName As String, ByVal nServerPort As Integer, ByVal sUsername As String, ByVal sPassword As String, ByVal lService As Long, ByVal lFlags As Long, ByVal lContext As Long) As Long
Public Declare Function InternetReadFileByte Lib "wininet.dll" Alias "InternetReadFile" (ByVal hFile As Long, ByVal AddOfBuffer As Long, ByVal lNumBytesToRead As Long, lNumberOfBytesRead As Long) As Integer
Public Declare Function InternetCloseHandle Lib "wininet.dll" (ByVal hInet As Long) As Integer

'Added by Morgan 2015/3/16
Public Declare Function FtpFindFirstFile Lib "wininet.dll" Alias "FtpFindFirstFileA" (ByVal hFtpSession As Long, ByVal lpszSearchFile As String, lpFindFileData As WIN32_FIND_DATA, ByVal dwFlags As Long, ByVal dwContent As Long) As Long
Public Declare Function FtpRenameFile Lib "wininet.dll" Alias "FtpRenameFileA" (ByVal hFtpSession As Long, ByVal lpszExisting As String, ByVal lpszNew As String) As Boolean
Public Declare Function FtpRemoveDirectory Lib "wininet.dll" Alias "FtpRemoveDirectoryA" (ByVal hFtpSession As Long, ByVal lpszDirectory As String) As Boolean
Public Declare Function InternetFindNextFile Lib "wininet.dll" Alias "InternetFindNextFileA" (ByVal hFind As Long, lpvFindData As WIN32_FIND_DATA) As Long

Public Declare Function FtpOpenFile Lib "wininet.dll" Alias "FtpOpenFileA" (ByVal hFtpSession As Long, ByVal sFileName As String, ByVal lAccess As Long, ByVal lFlags As Long, ByVal lContext As Long) As Long
Public Declare Function FtpGetFile Lib "wininet.dll" Alias "FtpGetFileA" (ByVal hFtpSession As Long, ByVal lpszRemoteFile As String, ByVal lpszNewFile As String, ByVal fFailIfExists As Boolean, ByVal dwLocalFlagsAndAttributes As Long, ByVal dwInternetFlags As Long, ByVal dwContext As Long) As Boolean
Public Declare Function FtpPutFile Lib "wininet.dll" Alias "FtpPutFileA" (ByVal hFtpSession As Long, ByVal lpszLocalFile As String, ByVal lpszNewRemoteFile As String, ByVal dwInternetFlags As Long, ByVal dwContext As Long) As Boolean
Public Declare Function FtpDeleteFile Lib "wininet.dll" Alias "FtpDeleteFileA" (ByVal hFtpSession As Long, ByVal lpszFileName As String) As Boolean
Public Declare Function FtpSetCurrentDirectory Lib "wininet.dll" Alias "FtpSetCurrentDirectoryA" (ByVal hFtpSession As Long, ByVal lpszDirectory As String) As Boolean
Public Declare Function FtpCreateDirectory Lib "wininet.dll" Alias "FtpCreateDirectoryA" (ByVal hConnect As Long, ByVal lpszDirectory As String) As Long

Public Declare Function ShellExecute Lib "SHELL32.DLL" Alias "ShellExecuteA" (ByVal hWnd As Long, ByVal lpOperation As String, ByVal lpFile As String, ByVal lpParameters As String, ByVal lpDirectory As String, ByVal nShowCmd As Long) As Long

Public Const INTERNET_OPEN_TYPE_DIRECT = 1
Public Const INTERNET_SERVICE_FTP = 1
Public Const ERROR_INTERNET_EXTENDED_ERROR = 12003
Public Const INTERNET_FLAG_PASSIVE = &H8000000
Public Const FTP_TRANSFER_TYPE_BINARY = &H1
Public Const FTP_Port As String = "21"
Public Const FILE_ATTRIBUTE_DIRECTORY = &H10
Public Const FILE_ATTRIBUTE_ARCHIVE = &H20
'end 2009/5/18

'Add by Morgan 2010/9/17
Public PUB_PicCopy As StdPicture

'Add by Morgan 2010/2/3
Public pub_OsPrinter As String '原作業系統預設印表機
Public pub_AppPrinter As String '程式預設印表機
Public pub_OsPrinterA As String '目前作業系統預設印表機 Added by Morgan 2025/9/11
'Add by Morgan 2010/7/26
Private Declare Function GetIpAddrTable_API Lib "IpHlpApi" Alias "GetIpAddrTable" (pIPAddrTable As Any, pdwSize As Long, ByVal bOrder As Long) As Long
Public Const WS_VERSION_REQD As Long = &H101
Private Declare Function WSAStartup Lib "WSOCK32.DLL" (ByVal wVersionRequired As Long, lpWSADATA As WSADATA) As Long
Private Declare Function inet_addr Lib "WSOCK32.DLL" (ByVal cp As String) As Long
Private Declare Function IcmpCreateFile Lib "icmp.dll" () As Long
Private Declare Function IcmpSendEcho Lib "icmp.dll" _
   (ByVal IcmpHandle As Long, _
    ByVal DestinationAddress As Long, _
    ByVal RequestData As String, _
    ByVal RequestSize As Long, _
    ByVal RequestOptions As Long, _
    ReplyBuffer As ICMP_ECHO_REPLY, _
    ByVal ReplySize As Long, _
    ByVal TimeOut As Long) As Long
Private Declare Function IcmpCloseHandle Lib "icmp.dll" (ByVal IcmpHandle As Long) As Long

Private Type WSADATA
   wVersion As Integer
   wHighVersion As Integer
   szDescription(0 To 256) As Byte
   szSystemStatus(0 To 128) As Byte
   iMaxSockets As Long
   iMaxUDPDG As Long
   lpVendorInfo As Long
End Type

Private Type IP_OPTION_INFORMATION
   Ttl             As Byte
   Tos             As Byte
   Flags           As Byte
   OptionsSize     As Byte
   OptionsData     As Long
End Type

Public Type ICMP_ECHO_REPLY
   address         As Long
   Status          As Long
   RoundTripTime   As Long
   DataSize        As Long
   Reserved        As Integer
   ptrData                 As Long
   Options        As IP_OPTION_INFORMATION
   data            As String * 250
End Type

'Modify By Sindy 2014/9/3 原在各個程式裡改為共用
Public Declare Function FindExecutable Lib "SHELL32.DLL" Alias "FindExecutableA" (ByVal lpFile As String, ByVal lpDirectory As String, ByVal lpResult As String) As Long
Public Declare Function FindFirstFile Lib "kernel32" Alias "FindFirstFileA" (ByVal lpFileName As String, lpFindFileData As WIN32_FIND_DATA) As Long
Public Declare Function FindNextFile Lib "kernel32" Alias "FindNextFileA" (ByVal hFindFile As Long, lpFindFileData As WIN32_FIND_DATA) As Long
Public Declare Function GetFileAttributes Lib "kernel32" Alias "GetFileAttributesA" (ByVal lpFileName As String) As Long
Public Declare Function FindClose Lib "kernel32" (ByVal hFindFile As Long) As Long
Public Type WIN32_FIND_DATA
    dwFileAttributes As Long
    ftCreationTime As FILETIME
    ftLastAccessTime As FILETIME
    ftLastWriteTime As FILETIME
    nFileSizeHigh As Long
    nFileSizeLow As Long
    dwReserved0 As Long
    dwReserved1 As Long
    cFileName As String * MAX_PATH
    cAlternate As String * 14
End Type
'2014/9/3 END

'Added by Morgan 2016/4/12
'選擇資料夾
Public Const BIF_RETURNONLYFSDIRS = 1
Public Const BIF_DONTGOBELOWDOMAIN = 2
Public Declare Function SHBrowseForFolder Lib "shell32" (lpBI As BrowseInfo) As Long
Public Declare Function lstrcat Lib "kernel32" Alias "lstrcatA" (ByVal lpString1 As String, ByVal lpString2 As String) As Long
Public Type BrowseInfo
   hwndOwner As Long
   pIDLRoot As Long
   pszDisplayName As Long
   lpszTitle As Long
   ulFlags As Long
   lpfnCallback As Long
   lParam As Long
   iImage As Long
End Type
'end 2016/4/12

Public bolNewAppNoFormat As Boolean  'Add by Morgan 2010/8/20 申請號格式 False:舊 Ture:新
Public bolNewPromoterRule As Boolean 'Add by Morgan 2010/9/14 專利處考核新規則
Public bolUnloading As Boolean 'Add by Morgan 2011/3/11 程式是否結束中
Public TMdebate As String 'Add By Sindy 2012/5/7 爭議案件性質
Public Const TMdebateStarDT = 20120601 'Add By Sindy 2012/5/16 T及FCT的台灣爭議案
'Add By Sindy 2025/7/28 T案的727分析屬於爭議案,但FCT案727分析不屬於爭議案
Public Const FCT_NotTMdebate As String = "727"
'2025/7/28 END
'Add By Sindy 2012/7/9 人事系統:上班時數特殊...
Public PUB_bWkSpec As Boolean   '是否為特殊者
Public PUB_intWkHour As Integer '上班的特殊時數
Public PUB_bSpecY As Boolean    '適用的過渡期
'2012/7/9 End
Public Const AccFMPImputCurrStarDate = 20130427 'Add By Sindy 2013/1/28
Public Const InvoiceStartDate = 20140101 'Add By Sindy 2013/12/12 發票啟用日期
Public Const Sh2EPtCode = "DECODE(SIGN(SH01-20140401), -1,DECODE(SH06, 'CFP', NVL(SH05, 0)/3, NVL(SH05,0)/4), SH05*0.2)" 'Added by Morgan 2014/3/20 --2014/4/1起支援改每小時折計0.2基數
Public Const Pt2EPtCode = "NVL(A0N03/1000, CP18)*DECODE(SIGN(CP05-20140401), -1, 0.05, 0.04)" 'Added by Morgan 2014/3/20 --2014/4/1起非智權收文改每點折算0.04基數
Public Const P台灣案電子化啟用日 = 20150101 'Add by Amy 2014/08/14
Public Const 內專全面電子化啟用日 = 20160701 'Add by Morgan 2016/3/24
Public Const 電子公文啟用日 = 20170524 'Add by Morgan 2017/5/22
Public Const CFP第一階段電子化啟用日 = 20181008 'Added by Morgan 2017/11/23
Public Const CFP指示信電子化啟用日 = 20180901 'Added by Morgan 2018/8/15
Public Const 非P結案電子化啟用日 = 20180824 'Add by Amy 2018/06/25
Public Const 彩色代表圖啟用日 = 20180827 'Modify by Amy 2018/08/24
Public Const e化客戶啟用日 = "20220214" 'Add by Morgan 2019/4/23
Public Const 每日業務點數FCPFCT啟用日 = 1080100 'Add by Amy 2018/12/06
Public Const 教育訓練登錄啟用日 = 20201102 'Modify by Amy 2020/11/02
Public Const T商標電子化啟用日 = 20191212 'Moidfy by Amy 2019/12/11 Add By Sindy 2019/10/18
Public Const T商標電子化第2階段啟用日 = 20210101 'Add By Sindy 2019/11/5
Public Const T商標電子送件扣款啟用日 = 20200811 'Add by Amy 2020/01/13
Public Const TM分信系統啟用日 = 20200824 'Add By Sindy 2020/8/4
Public Const 外專信件沖銷啟用日 = 20220810 'Add By Sindy 2022/5/24
Public Const 外商CF信件沖銷啟用日 = 20230711 'Add By Sindy 2023/4/25
Public Const FCP結案單電子化啟用日 = 20250728 'Modify by Amy 2025/07/25
Public Const FCT結案單電子化啟用日 = 20991231 'Add by Amy 2025/06/09
'Modified by Morgan 2021/7/19 改為常數，刪除系統特殊設定
'Public PUB_108RuleDate As String '專利處108考核啟用日 Added by Morgan 2019/3/15 抓系統特殊設定
Public Const PUB_108RuleDate = 20190401
Public Const 無效客戶轉智權人員啟用日 = 20220519 'Modify by Amy 2020/05/18
'end 2021/7/19

Public PUB_PdfCreatorNameInWord As String   'Added by Morgan 2014/8/27
'Add by Lydia 2014/10/31 開放外專程序人員可進入專利處系統操作FMP寰華案件，但非此類案件時外專程序人員不可操作。
Public FMP2openSQL As String '傳SQL條件，使用時原表單SQL的對應table別名設f0(例:caseprogress, patent)
Public FMP2open As Boolean   '判斷是否為外專
'Added by Lydia 2020/03/16 寰華案:新案發文人員為外專程序者
Public Const FMP2openSqlCont = " and exists (select f1.* from caseprogress f1,staff t01 where f1.CP31='Y' and SUBSTR(f1.CP12,1,1) = 'F' and f1.CP44='Y53374000' and f0.CP01=f1.CP01 and f0.CP02=f1.CP02 and f0.CP03=f1.CP03 and f0.CP04=f1.CP04 " & _
                 " and f1.cp83=t01.st01(+) and (t01.st03='F22' or t01.st03 is null) ) "
'end 2014/10/31
'Added by Lydia 2015/03/27 預設領證與年費代理人
Public Const YF0607PAgent1 = "Y00000001" 'P案
Public Const YF0607PAgent2 = "Y00000000" '非P案
'end 2015/03/27
Public Const 案件預設收據公司別啟用日 = 20160721
Public Const 外專開窗信函啟用日 = 20151012 'Add By Sindy 2015/9/21
Public Const 業績輸入啟用年月 = 10501 'Add by Amy 2016/01/30
Public Const 業績自動轉傳票啟用年月 = 10608 'Modify by Amy 2017/08/22
Public Const 業務報價確認備註 As String = "報價：" 'Added by Lydia 2016/08/22
Public Pub_Send_CFPdg As Boolean 'Added by Lydia 2016/08/31 CFP調整點數時並超過點數上限發E-mail給主管批示
Public pub_DbTerminalName As String 'Added by Morgan 2016/9/7
Public strKeyPoint As String 'Added by Lydia 2016/10/11 記錄年費報價控管的主管核可內容
Public ShowFrm060318 As Form 'Add by Amy 2018/11/28
Public Const TranInvoiceDate = 1080701 'Add By Amy 2019/03/26 電子發票上傳啟用日
Public XY特殊權限範圍 As String 'Added by Lydia 2019/10/05 利益衝突案件：申請人/代理人特殊權限的範圍
'Modified by Lydia 2020/04/08 利益衝突案件已上線，啟用日改成常數
Public Const XY特殊權限啟用日 = 20200301
Public Const XY特殊權限啟用日by檔案 = 20200330
'end 2020/04/08
Public Const 組合作帳公司 As String = ",1+J" 'Add by Amy 2020/03/18
'Add by Amy 2020/03/19
Public Const 帳務組合公司 As String = ",P+J"
Public Const 智慧所更名日 = 20200401
Public Const 事務所合併日 = 20200401
'Added by Lydia 2020/05/05
Public Const 國外部關聯企業啟用日 = 20200901 'Memo by Lydia 2020/08/31 國外各項指示及關聯企業功能預計９／１上線
Public Const 各項指示啟用日 = 20200901 'Memo by Lydia 2020/08/31  國外各項指示及關聯企業功能預計９／１上線
'end 2020/05/05
Public Const 法律所案源收文啟用日 = 20200720 'Added by Lydia 2020/05/20 => 'Modified by Lydia 2020/08/03 上線後改為常數
Public Const Form20上線日 = 20220309 'Add By Sindy 2022/1/19 Modified by Morgan 2022/3/8 設定111/3/9上線
Public Const 接洽單電子收文啟用日 = 20230101 'Add by Sindy 2022/08/24
Public Const 外專承辦歷程啟用日 = 20240101 'Add By Sindy 2023/9/15
Public Const FCP核完日改用EP39 = 20231121 'Add By Sindy 2023/10/27 FCP核完日原EP33改用EP39,和專利系統一樣EP33=外文核完日
Public Const 外商承辦歷程啟用日 = 20241209 'Add By Sindy 2024/10/28

Public strBankAcc As String 'Add by Amy 2020/07/13
'****** Memo by Amy 2023/10/23  智權點數實績與結餘變數有[增修] '******
'1.[增修]時,需確認[智權日報表frm210107]是否也要修改
'2.[增加人員]時,需考慮[產生傳票frmacc41g0]應帶的部門
'Modify by Amy 2021/04/29 +P部門P2005  需輸智權點數
Public Const 智權點數實績與結餘輸入部門 As String = "S,F,W,P" 'Add by Amy 2021/01/07
'Memo by Amy 20225/05/13 智權點數實績與結餘特殊員編
'Modify by Amy 2022/04/13 +P1005;2023/08/07 +W3001
'Modify by Amy 2025/11/04 拿掉W2001顧服組目前已經沒有業績目標故不需再輸-教威及婉莘同意
Public Const 智權點數實績與結餘特殊員編 = "F4102;F4103;W1001;W3001;20091;F4104;F4105;F4106;F4107;P2005;P1005" 'Add by Amy 2021/01/18
'****** End Memo '******
Public Const 不需新增SalesPoint人員 = "M0100" 'Add by Amy 2021/05/31 'Modify by Amy 2022/02/17 M0109要新增
Public stChkForm As String 'Add by Amy 2021/12/21 記錄表單及關閉
Public PGColor As Variant 'Added by Lydia 2022/11/15 自訂色彩: 在PUB_SetSystemVar
Public Const 代理人來源啟用日 = "20221219" 'Modify by Amy 2022/12/09
Public Const PA179啟用日 = "20230331" 'Added by Morgan 2023/3/21


Public Function SocketsInitialize() As Boolean
   Dim WSAD As WSADATA
   SocketsInitialize = WSAStartup(WS_VERSION_REQD, WSAD) = 0
End Function

Public Function ping(sAddress As String) As Long
Dim Reply As ICMP_ECHO_REPLY
Dim hIcmp As Long
Dim lAddress As Long
Dim lTimeOut As Long
Dim StringToSend As String

'Short string of data to send
StringToSend = "hello"

'ICMP (ping) timeout
lTimeOut = 1000 'ms

'Convert string address to a long representation.
lAddress = inet_addr(sAddress)

If (lAddress <> -1) And (lAddress <> 0) Then
        
    'Create the handle for ICMP requests.
    hIcmp = IcmpCreateFile()
    
    If hIcmp Then
        'Ping the destination IP address.
        Call IcmpSendEcho(hIcmp, lAddress, StringToSend, Len(StringToSend), 0, Reply, Len(Reply), lTimeOut)

        'Reply status
        ping = Reply.Status
        
        'Close the Icmp handle.
        IcmpCloseHandle hIcmp
    Else
        ping = -1
    End If
Else
    ping = -1
End If

End Function

Public Function GetIpAddrTable()
   Dim Buf(0 To 511) As Byte
   Dim bufSize As Long: bufSize = UBound(Buf) + 1
   Dim Rc As Long
   Rc = GetIpAddrTable_API(Buf(0), bufSize, 1)
   If Rc <> 0 Then Err.Raise vbObjectError, , "GetIpAddrTable failed with return value " & Rc
   Dim NrOfEntries As Integer: NrOfEntries = Buf(1) * 256 + Buf(0)
   If NrOfEntries = 0 Then GetIpAddrTable = Array(): Exit Function
   ReDim IpAddrs(0 To NrOfEntries - 1) As String
   Dim i As Integer
   For i = 0 To NrOfEntries - 1
      Dim j As Integer, s As String: s = ""
      For j = 0 To 3: s = s & IIf(j > 0, ".", "") & Buf(4 + i * 24 + j): Next
      IpAddrs(i) = s
   Next
   GetIpAddrTable = IpAddrs
End Function

Public Function GetLocalIP() As String
   Dim IpAddrs
   Dim IpAddr As String
   
   IpAddrs = GetIpAddrTable
   Dim i As Integer
   For i = LBound(IpAddrs) To UBound(IpAddrs)
      'Debug.Print IpAddrs(i)
      'Modified by Morgan 2020/8/27 改192.168.6.開頭(VPN)的優先
      'Modified by Morgan 2020/9/9 +第3碼小的優先
      If Left(IpAddrs(i), 10) = "192.168.6." Then
         IpAddr = IpAddrs(i)
         Exit For
      ElseIf Left(IpAddrs(i), 8) = "192.168." Then
         If IpAddr = "" Or Val(Mid(IpAddrs(i), 9)) < Val(Mid(IpAddr, 9)) Then
            IpAddr = IpAddrs(i)
         End If
      End If
   Next
   GetLocalIP = IpAddr
End Function

'Add by Morgan 2008/5/23
'取得桌面的路徑
Public Function PUB_Getdesktop() As String
   Dim IDL As Long
   Dim pathname As String
   pathname = Space(512)
   SHGetSpecialFolderLocation 100, &H0, IDL
   SHGetPathFromIDList ByVal IDL, ByVal pathname
   pathname = Split(pathname, Chr$(0))(0)
   PUB_Getdesktop = pathname
 End Function
 
'讀作業系統代碼 1=95 2=NT 其他=未知
Public Function GetVersion32() As Long
   OsVers.dwVersionInfoSize = 148&
   GetVersionEx OsVers
   GetVersion32 = OsVers.dwPlatform
'   If OsVers.dwPlatform = 1& Then
'      GetVersion32 = "95"
'   ElseIf OsVers.dwPlatform = 2& Then
'      GetVersion32 = "NT"
'   Else
'      GetVersion32 = "Unknown"
'   End If
End Function
'2006/4/11 end

'Added by Morgan 2015/8/10
'取得作業系統版本 XP=5.1, Win7=6.1, Win8=6.2
Public Function PUB_GetVersionNo() As String
   Dim osinfo As OsVersionInfo
   Dim retvalue As Integer
   osinfo.dwVersionInfoSize = 148
   osinfo.szCSDVersion = Space$(128)
   retvalue = GetVersionEx(osinfo)
   PUB_GetVersionNo = str$(osinfo.dwMajorVersion) + "." + LTrim(str(osinfo.dwMinorVersion))
End Function

'拆字串(用-區隔)
Public Function SystemNumber(ByRef strSystem As String, ByRef Strindex As Integer) As String                'NICK
Dim Str0001 As String, Str0002 As String, Str0003 As String, Str0004 As String
Dim Int0001 As Integer, Int0002 As Integer
If strSystem = "" Or IsNull(strSystem) Then
Exit Function
End If
'Added by Lydia 2019/06/4
Dim intP As Integer, intJ As Integer
'Dim strTemp  As String
'Dim strNo(1 To 4) As String

'Modify By Sindy 2019/12/24 FCT-6586-T;CFT-021402-0-00-1
If InStr(strSystem, "-") = 0 Then Exit Function
intP = UBound(Split(strSystem, "-"))
For intJ = intP To 2
   If intJ = 2 Then strSystem = strSystem & "-00"
   If intJ = 1 Then strSystem = strSystem & "-0"
Next intJ
'2019/12/24 END

'Modified by Lydia 2019/06/04 參考FCT-6586-T的發文無法匯入卷宗區的問題
Int0001 = InStr(1, Trim(strSystem), "-")
Str0001 = Left(Trim(strSystem), Int0001 - 1)
Int0002 = InStr(Int0001 + 1, Trim(strSystem), "-")
Str0002 = Mid(Trim(strSystem), Int0001 + 1, Int0002 - Int0001 - 1)
Int0001 = InStr(Int0002 + 1, Trim(strSystem), "-")
Str0003 = Mid(Trim(strSystem), Int0002 + 1, Int0001 - Int0002 - 1)
Str0004 = Right(Trim(strSystem), Len(Trim(strSystem)) - Int0001)
'Modify By Sindy 2019/12/24
If InStr(Str0004, "-") > 0 Then
   Str0004 = Left(Str0004, InStr(Str0004, "-") - 1)
End If
'2019/12/24 END
'Int0001 = InStr(1, Trim(strSystem), "-")
'If Int0001 = 0 Then
'    Str0001 = Trim(strSystem)
'Else
'    intP = Int0001
'    strTemp = Trim(strSystem)
'    Do While intP > 0
'        intJ = intJ + 1
'        strNo(intJ) = Mid(strTemp, 1, intP - 1)
'        strTemp = Mid(strTemp, intP + 1)
'        intP = InStr(strTemp, "-")
'    Loop
'    If intJ < 4 Then intJ = intJ + 1
'    strNo(intJ) = strTemp
'    Str0001 = strNo(1)
'    Str0002 = Format(strNo(2), "000000")
'    Str0003 = Right("0" & strNo(3), 1)
'    Str0004 = Right("00" & strNo(4), 2)
'End If
''end 2019/06/04

Select Case Strindex
Case 1
      SystemNumber = Str0001
Case 2
      SystemNumber = Str0002
Case 3
      SystemNumber = Str0003
Case 4
      SystemNumber = Str0004
'Added by Lydia 2019/06/04 完整的本所案號
Case 5
      SystemNumber = Str0001 & Str0002 & Str0003 & Str0004
'end 2019/06/04
Case Else
     MsgBox ("傳入參數錯誤")
End Select
End Function

'拆字串
Public Function SystemNumber1(ByRef strSystem As String, ByRef Strindex As Integer) As String               'NICK
Dim Str0001 As String, Str0002 As String, Str0003 As String, Str0004 As String, Str0005 As String
Dim Int0001 As Integer, Int0002 As Integer
If strSystem = "" Or IsNull(strSystem) Then
Exit Function
End If
Int0001 = InStr(1, Trim(strSystem), "-")
Str0001 = Left(Trim(strSystem), Int0001 - 1)
Int0002 = InStr(Int0001 + 1, Trim(strSystem), "-")
Str0002 = Mid(Trim(strSystem), Int0001 + 1, Int0002 - Int0001 - 1)
Int0001 = InStr(Int0002 + 1, Trim(strSystem), "-")
Str0003 = Mid(Trim(strSystem), Int0002 + 1, Int0001 - Int0002 - 1)
Int0002 = InStr(Int0001 + 1, Trim(strSystem), "-")
Str0004 = Mid(Trim(strSystem), Int0001 + 1, Int0002 - Int0001 - 1)
Str0005 = Right(Trim(strSystem), Len(Trim(strSystem)) - Int0002)

Select Case Strindex
Case 1
      SystemNumber1 = Str0001
Case 2
      SystemNumber1 = Str0002
Case 3
      SystemNumber1 = Str0003
Case 4
      SystemNumber1 = Str0004
Case 5
      SystemNumber1 = Str0005
Case Else
     MsgBox ("傳入參數錯誤")
End Select
End Function

'拆字串
Public Function StringTwoString(ByRef StringAll As String, ByRef StringIndex As Integer) As String          'NICK
Dim Str00001 As String, Str00002 As String, Int00001 As Integer
If StringAll = "" Or IsNull(StringAll) Then
   Exit Function
End If
Int00001 = InStr(1, Trim(StringAll), "=")
Str00001 = Left(Trim(StringAll), Int00001 - 1)
Str00002 = Right(Trim(StringAll), Len(Trim(StringAll)) - Int00001)
Select Case StringIndex
Case 1
      StringTwoString = Str00001
Case 2
      StringTwoString = Str00002
Case Else
     MsgBox ("傳入參數錯誤")
End Select
End Function

'拆字串
Public Function StringTwoString1(ByRef StringAll As String, ByRef StringIndex As Integer) As String                 'NICK
Dim Str00001 As String, Str00002 As String, Str00003 As String, Int00001 As Integer, Int00002 As Integer
If StringAll = "" Or IsNull(StringAll) Then
   Exit Function
End If
Int00001 = InStr(1, Trim(StringAll), "=")
Str00001 = Left(Trim(StringAll), Int00001 - 1)
Int00002 = InStr(Int00001 + 1, Trim(StringAll), "=")
Str00002 = Mid(Trim(StringAll), Int00001 + 1, Int00002 - Int00001 - 1)
Str00003 = Right(Trim(StringAll), Len(Trim(StringAll)) - Int00002)
Select Case StringIndex
Case 1
      StringTwoString1 = Str00001
Case 2
      StringTwoString1 = Str00002
Case 3
      StringTwoString1 = Str00003
Case Else
     MsgBox ("傳入參數錯誤")
End Select
End Function

'拆字串
Public Function StringTwoString2(ByRef StringAll As String, ByRef StringIndex As Integer) As String                'NICK
Dim Str1 As String, Str2 As String, str3 As String, Str4 As String, Str5 As String, Str6 As String, Str7 As String, Int1 As Integer, Int2 As Integer
If StringAll = "" Or IsNull(StringAll) Then
   Exit Function
End If
Int1 = InStr(1, Trim(StringAll), "=")
Str1 = Left(Trim(StringAll), Int1 - 1)
Int2 = InStr(Int1 + 1, Trim(StringAll), "=")
Str2 = Mid(Trim(StringAll), Int1 + 1, Int2 - Int1 - 1)
Int1 = InStr(Int2 + 1, Trim(StringAll), "=")
str3 = Mid(Trim(StringAll), Int2 + 1, Int1 - Int2 - 1)
Int2 = InStr(Int1 + 1, Trim(StringAll), "=")
Str4 = Mid(Trim(StringAll), Int1 + 1, Int2 - Int1 - 1)
Int1 = InStr(Int2 + 1, Trim(StringAll), "=")
Str5 = Mid(Trim(StringAll), Int1 + 1, Int1 - Int2 - 1)
Int2 = InStr(Int1 + 1, Trim(StringAll), "=")
Str6 = Mid(Trim(StringAll), Int1 + 1, Int2 - Int1 - 1)
Int1 = InStr(Int2 + 1, Trim(StringAll), "=")
Str7 = Right(Trim(StringAll), Len(Trim(StringAll)) - Int1)

Select Case StringIndex
Case 1
      StringTwoString2 = Str1
Case 2
      StringTwoString2 = Str2
Case 3
      StringTwoString2 = str3
Case 4
      StringTwoString2 = Str4
Case 5
      StringTwoString2 = Str5
Case 6
      StringTwoString2 = Str6
Case 7
      StringTwoString2 = Str7
Case Else
     MsgBox ("傳入參數錯誤")
End Select
End Function

'關閉連線
Public Sub CheckOC()            'NICK
adoRecordset.Filter = "" 'Add By Sindy 2023/7/21 固定都清除;
                         '   前頭程式若有使用到 Filter 但結束時沒有清空, 其他SQL再使用到 AdoRecordSet3 時會錯誤
If adoRecordset.State <> 0 Then
   adoRecordset.Close
End If
End Sub

'關閉連線
Public Sub CheckOC2()           'NICK
adoRecordset1.Filter = "" 'Add By Sindy 2023/7/21 固定都清除;
                          '   前頭程式若有使用到 Filter 但結束時沒有清空, 其他SQL再使用到 AdoRecordSet3 時會錯誤
If adoRecordset1.State <> 0 Then
   adoRecordset1.Close
End If
End Sub

'關閉連線
Public Sub CheckOC3()           'NICK
AdoRecordSet3.Filter = "" 'Add By Sindy 2023/7/21 固定都清除;
                          '   前頭程式若有使用到 Filter 但結束時沒有清空, 其他SQL再使用到 AdoRecordSet3 時會錯誤
If AdoRecordSet3.State <> 0 Then
   AdoRecordSet3.Close
End If
End Sub

'取的user可用系統類別
Public Function GetSystemKindByNick() As String                'NICK
Dim StrTempGroup As String, i As Integer, strTemp As String
bolFNation = False
CheckOC3
strSql = "SELECT ST11,ST03 FROM STAFF WHERE ST01='" & strUserNum & "'"
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
     If Not IsNull(AdoRecordSet3.Fields(0)) Then
         StrTempGroup = AdoRecordSet3.Fields(0)
         If UCase(Left(CheckStr(AdoRecordSet3.Fields(1)), 1)) = "S" Or AdoRecordSet3.Fields(1) = "P11" Then
            bolFNation = False
         Else
            bolFNation = True
         End If
         '2009/11/13 ADD BY SONIA 開放94007林景郁可查國外代理人資料
         Select Case strUserNum
            'modify by sonia 2021/10/26 王副總專利案說要加開李柏翰99050
            Case "94007", "99050"
               bolFNation = True
         End Select
         '2009/11/13 END
     Else
         StrTempGroup = ""
         GetSystemKindByNick = ""
         Exit Function
     End If
End If
CheckOC3
GetSystemKindByNick = ""
strTemp = ""

'Modified  by Lydia 2025/04/18 + distinct
strSql = "SELECT distinct SG02 FROM STAFF_GROUP WHERE SG01='" & StrTempGroup & "' ORDER BY SG02"
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
    AdoRecordSet3.MoveFirst
     Do While AdoRecordSet3.EOF = False
        If Not IsNull(AdoRecordSet3.Fields(0)) Then
           If strTemp <> AdoRecordSet3.Fields(0) Then
              strTemp = AdoRecordSet3.Fields(0)
              GetSystemKindByNick = GetSystemKindByNick + AdoRecordSet3.Fields(0) + ","
           End If
        End If
        AdoRecordSet3.MoveNext
     Loop
Else
    GetSystemKindByNick = ""
End If

'Added by Lydia 2025/04/18 CFT管制人增加CFC案的權限
If InStr(GetSystemKindByNick & ",", "CFC") = 0 Then
   CheckOC3
   strSql = "select distinct na01 from nation where na69='" & strUserNum & "' "
   AdoRecordSet3.CursorLocation = adUseClient
   AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
      GetSystemKindByNick = GetSystemKindByNick + "CFC,"
   End If
End If
'end 2025/04/18

CheckOC3
End Function

'取的group的種類
Public Function GetGroupKindByTwo() As String                'NICK
Dim strTemp As String
CheckOC3
GetGroupKindByTwo = ""
strTemp = ""
strSql = "SELECT SK01 FROM SYSTEMKIND WHERE SK02=2 ORDER BY SK01"
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
    AdoRecordSet3.MoveFirst
     Do While AdoRecordSet3.EOF = False
        If Not IsNull(AdoRecordSet3.Fields(0)) Then
           If strTemp <> AdoRecordSet3.Fields(0) Then
              strTemp = AdoRecordSet3.Fields(0)
              GetGroupKindByTwo = GetGroupKindByTwo + AdoRecordSet3.Fields(0) + ","
           End If
        End If
        AdoRecordSet3.MoveNext
     Loop
Else
    GetGroupKindByTwo = ""
End If
CheckOC3
End Function

'抓案件名稱        NICK
'Modify By Sindy 2015/7/1 +Optional bolShowTM131 As Boolean = False
Public Function GetPrjName(ByRef Strindex As String, Optional bolShowTM131 As Boolean = False) As String        '抓案件名稱        NICK
If UCase(Left(Strindex, 1)) = "N" Then
    Strindex = Right(Strindex, Len(Strindex) - 1)
End If
strSql = "SELECT NVL(" & IIf(bolShowTM131 = True, "NVL(TM131,TM05)", "TM05") & ",NVL(TM06,TM07)) FROM TRADEMARK WHERE TM01='" & SystemNumber(Strindex, 1) & "'  AND TM02='" & SystemNumber(Strindex, 2) & "' AND TM03='" & SystemNumber(Strindex, 3) & "' AND TM04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select NVL(PA05,NVL(PA06,PA07)) FROM PATENT WHERE PA01='" & SystemNumber(Strindex, 1) & "'  AND PA02='" & SystemNumber(Strindex, 2) & "' AND PA03='" & SystemNumber(Strindex, 3) & "' AND PA04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select NVL(SP05,NVL(SP06,SP07)) FROM SERVICEPRACTICE WHERE SP01='" & SystemNumber(Strindex, 1) & "'  AND SP02='" & SystemNumber(Strindex, 2) & "' AND SP03='" & SystemNumber(Strindex, 3) & "' AND SP04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select NVL(LC05,NVL(LC06,LC07)) FROM LAWCASE WHERE LC01='" & SystemNumber(Strindex, 1) & "'  AND LC02='" & SystemNumber(Strindex, 2) & "' AND LC03='" & SystemNumber(Strindex, 3) & "' AND LC04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select HC06 FROM HIRECASE WHERE HC01='" & SystemNumber(Strindex, 1) & "'  AND HC02='" & SystemNumber(Strindex, 2) & "' AND HC03='" & SystemNumber(Strindex, 3) & "' AND HC04='" & SystemNumber(Strindex, 4) & "' "
CheckOC3
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
    If Not IsNull(AdoRecordSet3.Fields(0)) Then
        GetPrjName = AdoRecordSet3.Fields(0)
    Else
        GetPrjName = ""
    End If
Else
    GetPrjName = ""
End If
CheckOC3
End Function

  '抓申請人
'Public Function GetPrjPeople1(ByRef Strindex As String) As String          '抓申請人
'Modify By Sindy 2018/4/17 + Optional ByVal bolANaCName As Boolean = False
Public Function GetPrjPeople1(ByRef Strindex As String, Optional strOrder As String = "1", _
   Optional ByVal bolANaCName As Boolean = False) As String
Dim rsAS As New ADODB.Recordset

'strOrder:"1"中-->英-->日,"2"英-->中-->日
If Len(Trim(Strindex)) = 9 Then
    If strOrder = "1" Then
        'Modify By Sindy 2021/6/17
        'strSql = "SELECT NVL(CU04,NVL(CU05||CU88||CU89||CU90,CU06)),CU10,CU15 FROM CUSTOMER WHERE CU01='" & Mid(Strindex, 1, 8) & "' AND CU02='" & Mid(Strindex, 9, 1) & "' "
        'Modified by Morgan 2025/11/13 英文名要加Rtrim否則後面會多空白
        strSql = "SELECT NVL(CU04,decode(CU05,null,cu06,rtrim(cu05||' '||CU88||' '||CU89||' '||CU90))),CU10,CU15 FROM CUSTOMER WHERE CU01='" & Mid(Strindex, 1, 8) & "' AND CU02='" & Mid(Strindex, 9, 1) & "' "
    ElseIf strOrder = "2" Then
        'Modify By Sindy 2021/6/17
        'strSql = "SELECT Decode(CU05,Null, Nvl(CU04, CU06), CU05||CU88||CU89||CU90),CU10,CU15 FROM CUSTOMER WHERE CU01='" & Mid(Strindex, 1, 8) & "' AND CU02='" & Mid(Strindex, 9, 1) & "' "
        'Modified by Morgan 2025/11/13 英文名要加Rtrim否則後面會多空白
        strSql = "SELECT Decode(CU05,Null, Nvl(CU04, CU06), rtrim(cu05||' '||CU88||' '||CU89||' '||CU90)),CU10,CU15 FROM CUSTOMER WHERE CU01='" & Mid(Strindex, 1, 8) & "' AND CU02='" & Mid(Strindex, 9, 1) & "' "
    End If
Else
    If strOrder = "1" Then
        'Modify By Sindy 2021/6/17
        'strSql = "SELECT NVL(CU04,NVL(CU05||CU88||CU89||CU90,CU06)),CU10,CU15 FROM CUSTOMER WHERE CU01='" & Mid(Strindex, 1, 8) & "' AND CU02='0' "
        'Modified by Morgan 2025/11/13 英文名要加Rtrim否則後面會多空白
        strSql = "SELECT NVL(CU04,decode(CU05,null,cu06,rtrim(cu05||' '||CU88||' '||CU89||' '||CU90))),CU10,CU15 FROM CUSTOMER WHERE CU01='" & Mid(Strindex, 1, 8) & "' AND CU02='0' "
    ElseIf strOrder = "2" Then
        'Modify By Sindy 2021/6/17
        'strSql = "SELECT Decode(CU05, Null, Nvl(CU04, CU06), CU05||CU88||CU89||CU90,CU06),CU10,CU15 FROM CUSTOMER WHERE CU01='" & Mid(Strindex, 1, 8) & "' AND CU02='0' "
        'Modified by Morgan 2025/11/13 英文名要加Rtrim否則後面會多空白
        strSql = "SELECT Decode(CU05, Null, Nvl(CU04, CU06), rtrim(cu05||' '||CU88||' '||CU89||' '||CU90)),CU10,CU15 FROM CUSTOMER WHERE CU01='" & Mid(Strindex, 1, 8) & "' AND CU02='0' "
    End If
End If
If rsAS.State <> 0 Then rsAS.Close
rsAS.CursorLocation = adUseClient
rsAS.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If rsAS.RecordCount <> 0 And rsAS.RecordCount > 0 Then
   If Not IsNull(rsAS.Fields(0)) Then
      If bolANaCName = True And "" & rsAS.Fields("CU15") = "1" Then '1.公司
         GetPrjPeople1 = GetPrjNationName("" & rsAS.Fields("CU10"), "NA81") & rsAS.Fields(0)
      Else
         GetPrjPeople1 = rsAS.Fields(0)
      End If
   Else
       GetPrjPeople1 = ""
   End If
Else
   GetPrjPeople1 = ""
End If

Set rsAS = Nothing
End Function

 '抓申請國家         NICK
Public Function GetPrjNation(ByRef Strindex As String) As String           '抓申請國家         NICK
If UCase(Left(Strindex, 1)) = "N" Then
    Strindex = Right(Strindex, Len(Strindex) - 1)
End If
Dim strTemp As String
strSql = "SELECT TM10 FROM  TRADEMARK WHERE TM01='" & SystemNumber(Strindex, 1) & "'  AND TM02='" & SystemNumber(Strindex, 2) & "' AND TM03='" & SystemNumber(Strindex, 3) & "' AND TM04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select PA09 FROM PATENT WHERE PA01='" & SystemNumber(Strindex, 1) & "'  AND PA02='" & SystemNumber(Strindex, 2) & "' AND PA03='" & SystemNumber(Strindex, 3) & "' AND PA04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select SP09 FROM SERVICEPRACTICE WHERE SP01='" & SystemNumber(Strindex, 1) & "'  AND SP02='" & SystemNumber(Strindex, 2) & "' AND SP03='" & SystemNumber(Strindex, 3) & "' AND SP04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select LC15 FROM LAWCASE WHERE LC01='" & SystemNumber(Strindex, 1) & "'  AND LC02='" & SystemNumber(Strindex, 2) & "' AND LC03='" & SystemNumber(Strindex, 3) & "' AND LC04='" & SystemNumber(Strindex, 4) & "' "
'2013/8/22 modify by sonia 顧問申請國家''改為'000'
strSql = strSql + " union all select '000' FROM HIRECASE WHERE HC01='" & SystemNumber(Strindex, 1) & "'  AND HC02='" & SystemNumber(Strindex, 2) & "' AND HC03='" & SystemNumber(Strindex, 3) & "' AND HC04='" & SystemNumber(Strindex, 4) & "' "
CheckOC3
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
    If Not IsNull(AdoRecordSet3.Fields(0)) Then
        strTemp = AdoRecordSet3.Fields(0)
    Else
        strTemp = ""
    End If
Else
    strTemp = ""
End If
CheckOC3
GetPrjNation = GetPrjNationName(strTemp)
End Function

   '抓申請國家代碼
Public Function GetPrjNation1(ByRef Strindex As String) As String            '抓申請國家代碼
If UCase(Left(Strindex, 1)) = "N" Then
    Strindex = Right(Strindex, Len(Strindex) - 1)
End If
strSql = "SELECT TM10 FROM  TRADEMARK WHERE TM01='" & SystemNumber(Strindex, 1) & "'  AND TM02='" & SystemNumber(Strindex, 2) & "' AND TM03='" & SystemNumber(Strindex, 3) & "' AND TM04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select PA09 FROM PATENT WHERE PA01='" & SystemNumber(Strindex, 1) & "'  AND PA02='" & SystemNumber(Strindex, 2) & "' AND PA03='" & SystemNumber(Strindex, 3) & "' AND PA04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select SP09 FROM SERVICEPRACTICE WHERE SP01='" & SystemNumber(Strindex, 1) & "'  AND SP02='" & SystemNumber(Strindex, 2) & "' AND SP03='" & SystemNumber(Strindex, 3) & "' AND SP04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select LC15 FROM LAWCASE WHERE LC01='" & SystemNumber(Strindex, 1) & "'  AND LC02='" & SystemNumber(Strindex, 2) & "' AND LC03='" & SystemNumber(Strindex, 3) & "' AND LC04='" & SystemNumber(Strindex, 4) & "' "
'2013/8/22 modify by sonia 顧問申請國家''改為'000'
strSql = strSql + " union all select '000' FROM HIRECASE WHERE HC01='" & SystemNumber(Strindex, 1) & "'  AND HC02='" & SystemNumber(Strindex, 2) & "' AND HC03='" & SystemNumber(Strindex, 3) & "' AND HC04='" & SystemNumber(Strindex, 4) & "' "
CheckOC3
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
    If Not IsNull(AdoRecordSet3.Fields(0)) Then
        GetPrjNation1 = AdoRecordSet3.Fields(0)
    Else
        GetPrjNation1 = ""
    End If
Else
    GetPrjNation1 = ""
End If
CheckOC3
End Function

'抓 專利商標種類 NICK
'Modify By Sindy 2025/2/4 +, Optional ByVal intValType As Integer = 1 : 0.取代碼 1.取中文名稱
Public Function GetPrjKind(ByRef Strindex As String, Optional ByVal intValType As Integer = 1) As String
Dim strTemp As String, strTemp1 As String, strTemp2 As String

   If UCase(Left(Strindex, 1)) = "N" Then
       Strindex = Right(Strindex, Len(Strindex) - 1)
   End If
   
   strSql = "SELECT TM08,TM10 FROM TRADEMARK WHERE TM01='" & SystemNumber(Strindex, 1) & "'  AND TM02='" & SystemNumber(Strindex, 2) & "' AND TM03='" & SystemNumber(Strindex, 3) & "' AND TM04='" & SystemNumber(Strindex, 4) & "' "
   strSql = strSql + " union all select PA08,PA09 FROM PATENT WHERE PA01='" & SystemNumber(Strindex, 1) & "'  AND PA02='" & SystemNumber(Strindex, 2) & "' AND PA03='" & SystemNumber(Strindex, 3) & "' AND PA04='" & SystemNumber(Strindex, 4) & "' "
   CheckOC3
   AdoRecordSet3.CursorLocation = adUseClient
   AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
       If Not IsNull(AdoRecordSet3.Fields(0)) Then
           strTemp = AdoRecordSet3.Fields(0)
       Else
           strTemp = ""
       End If
       If Not IsNull(AdoRecordSet3.Fields(1)) Then
           strTemp1 = AdoRecordSet3.Fields(1)
       Else
           strTemp1 = ""
       End If
   Else
       strTemp = ""
       strTemp1 = ""
   End If
   
   'Add By Sindy 2025/2/4
   If intValType = 0 Then
      GetPrjKind = strTemp
      Exit Function
   End If
   '2025/2/4 END
   
   CheckOC3
   strSql = "SELECT SK02 FROM SYSTEMKIND WHERE SK01='" & SystemNumber(Strindex, 1) & "'"
   AdoRecordSet3.CursorLocation = adUseClient
   AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
       If Not IsNull(AdoRecordSet3.Fields(0)) Then
           strTemp2 = AdoRecordSet3.Fields(0)
       Else
           strTemp2 = ""
       End If
   Else
       strTemp2 = ""
   End If
   CheckOC3
   If strTemp1 = "000" Or UCase(SystemNumber(Strindex, 1)) = "CFP" Then
       strSql = "SELECT PTM03 FROM PATENTTRADEMARKMAP WHERE '" & Trim(strTemp2) & "'=ptm01(+) AND PTM02='" & strTemp & "'"
   Else
       strSql = "SELECT PTM04 FROM PATENTTRADEMARKMAP WHERE '" & Trim(strTemp2) & "'=ptm01(+) AND PTM02='" & strTemp & "'"
   End If
   CheckOC3
   AdoRecordSet3.CursorLocation = adUseClient
   AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
       If Not IsNull(AdoRecordSet3.Fields(0)) Then
           GetPrjKind = AdoRecordSet3.Fields(0)
       Else
           GetPrjKind = ""
       End If
   Else
       GetPrjKind = ""
   End If
   CheckOC3
End Function

  '目前准駁        NICK
Public Function GetPrjState1(ByRef Strindex As String) As String           '目前准駁        NICK
If UCase(Left(Strindex, 1)) = "N" Then
    Strindex = Right(Strindex, Len(Strindex) - 1)
End If
strSql = "SELECT TM16 FROM TRADEMARK WHERE TM01='" & SystemNumber(Strindex, 1) & "'  AND TM02='" & SystemNumber(Strindex, 2) & "' AND TM03='" & SystemNumber(Strindex, 3) & "' AND TM04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select PA16 FROM PATENT WHERE PA01='" & SystemNumber(Strindex, 1) & "'  AND PA02='" & SystemNumber(Strindex, 2) & "' AND PA03='" & SystemNumber(Strindex, 3) & "' AND PA04='" & SystemNumber(Strindex, 4) & "' "
CheckOC3
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
    If Not IsNull(AdoRecordSet3.Fields(0)) Then
        GetPrjState1 = AdoRecordSet3.Fields(0)
    Else
        GetPrjState1 = ""
    End If
Else
    GetPrjState1 = ""
End If
CheckOC3
End Function

 '專用權是否存在        NICK
Public Function GetPrjState2(ByRef Strindex As String) As String           '專用權是否存在        NICK
If UCase(Left(Strindex, 1)) = "N" Then
    Strindex = Right(Strindex, Len(Strindex) - 1)
End If
strSql = "SELECT TM17 FROM TRADEMARK WHERE TM01='" & SystemNumber(Strindex, 1) & "'  AND TM02='" & SystemNumber(Strindex, 2) & "' AND TM03='" & SystemNumber(Strindex, 3) & "' AND TM04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select PA17 FROM PATENT WHERE PA01='" & SystemNumber(Strindex, 1) & "'  AND PA02='" & SystemNumber(Strindex, 2) & "' AND PA03='" & SystemNumber(Strindex, 3) & "' AND PA04='" & SystemNumber(Strindex, 4) & "' "
CheckOC3
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
    If Not IsNull(AdoRecordSet3.Fields(0)) Then
        GetPrjState2 = AdoRecordSet3.Fields(0)
    Else
        GetPrjState2 = ""
    End If
Else
    GetPrjState2 = ""
End If
CheckOC3
End Function

   '閉卷日期        NICK
Public Function GetPrjState3(ByRef Strindex As String) As String           '閉卷日期        NICK
If UCase(Left(Strindex, 1)) = "N" Then
    Strindex = Right(Strindex, Len(Strindex) - 1)
End If
strSql = "SELECT TM30 FROM TRADEMARK WHERE TM01='" & SystemNumber(Strindex, 1) & "'  AND TM02='" & SystemNumber(Strindex, 2) & "' AND TM03='" & SystemNumber(Strindex, 3) & "' AND TM04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select PA58 FROM PATENT WHERE PA01='" & SystemNumber(Strindex, 1) & "'  AND PA02='" & SystemNumber(Strindex, 2) & "' AND PA03='" & SystemNumber(Strindex, 3) & "' AND PA04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select SP16 FROM SERVICEPRACTICE WHERE SP01='" & SystemNumber(Strindex, 1) & "'  AND SP02='" & SystemNumber(Strindex, 2) & "' AND SP03='" & SystemNumber(Strindex, 3) & "' AND SP04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select LC09 FROM LAWCASE WHERE LC01='" & SystemNumber(Strindex, 1) & "'  AND LC02='" & SystemNumber(Strindex, 2) & "' AND LC03='" & SystemNumber(Strindex, 3) & "' AND LC04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select HC10 FROM HIRECASE WHERE HC01='" & SystemNumber(Strindex, 1) & "'  AND HC02='" & SystemNumber(Strindex, 2) & "' AND HC03='" & SystemNumber(Strindex, 3) & "' AND HC04='" & SystemNumber(Strindex, 4) & "' "
CheckOC3
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
    If Not IsNull(AdoRecordSet3.Fields(0)) Then
        GetPrjState3 = ChangeWStringToTString(AdoRecordSet3.Fields(0))
    Else
        GetPrjState3 = ""
    End If
Else
    GetPrjState3 = ""
End If
CheckOC3
End Function

 '案件性質/來函性質        NICK
Public Function GetPrjState4(ByRef Strindex As String, ByRef StrIndex2 As String) As String          '案件性質/來函性質        NICK
If UCase(Left(Strindex, 1)) = "N" Then
    Strindex = Right(Strindex, Len(Strindex) - 1)
End If
Dim strTemp As String, strTemp1 As String, strTemp2 As String
strSql = "SELECT TM10 FROM TRADEMARK WHERE TM01='" & SystemNumber(Strindex, 1) & "'  AND TM02='" & SystemNumber(Strindex, 2) & "' AND TM03='" & SystemNumber(Strindex, 3) & "' AND TM04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select PA09 FROM PATENT WHERE PA01='" & SystemNumber(Strindex, 1) & "'  AND PA02='" & SystemNumber(Strindex, 2) & "' AND PA03='" & SystemNumber(Strindex, 3) & "' AND PA04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select SP09 FROM SERVICEPRACTICE WHERE SP01='" & SystemNumber(Strindex, 1) & "'  AND SP02='" & SystemNumber(Strindex, 2) & "' AND SP03='" & SystemNumber(Strindex, 3) & "' AND SP04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select LC15 FROM LAWCASE WHERE LC01='" & SystemNumber(Strindex, 1) & "'  AND LC02='" & SystemNumber(Strindex, 2) & "' AND LC03='" & SystemNumber(Strindex, 3) & "' AND LC04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select '' FROM HIRECASE WHERE HC01='" & SystemNumber(Strindex, 1) & "'  AND HC02='" & SystemNumber(Strindex, 2) & "' AND HC03='" & SystemNumber(Strindex, 3) & "' AND HC04='" & SystemNumber(Strindex, 4) & "' "
CheckOC3
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
    If Not IsNull(AdoRecordSet3.Fields(0)) Then
        strTemp = AdoRecordSet3.Fields(0)
    Else
        strTemp = ""
    End If
Else
    strTemp = ""
End If
CheckOC3
If strTemp = "000" Then
    strSql = "SELECT CPM03 FROM CASEPROPERTYMAP WHERE CPM01='" & SystemNumber(Strindex, 1) & "' AND CPM02='" & StrIndex2 & "' "
Else
    strSql = "SELECT CPM04 FROM CASEPROPERTYMAP WHERE CPM01='" & SystemNumber(Strindex, 1) & "' AND CPM02='" & StrIndex2 & "' "
End If
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
    If Not IsNull(AdoRecordSet3.Fields(0)) Then
        GetPrjState4 = AdoRecordSet3.Fields(0)
    Else
        GetPrjState4 = ""
    End If
Else
    GetPrjState4 = ""
End If
CheckOC3
End Function

'下一程序        NICK
Public Function GetPrjState5(ByRef Strindex As String, ByRef StrIndex2 As String) As String          '下一程序        NICK
If UCase(Left(Strindex, 1)) = "N" Then
    Strindex = Right(Strindex, Len(Strindex) - 1)
End If
Dim strTemp As String, strTemp1 As String, strTemp2 As String
strSql = "SELECT TM10 FROM TRADEMARK WHERE TM01='" & SystemNumber(Strindex, 1) & "'  AND TM02='" & SystemNumber(Strindex, 2) & "' AND TM03='" & SystemNumber(Strindex, 3) & "' AND TM04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select PA09 FROM PATENT WHERE PA01='" & SystemNumber(Strindex, 1) & "'  AND PA02='" & SystemNumber(Strindex, 2) & "' AND PA03='" & SystemNumber(Strindex, 3) & "' AND PA04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select SP09 FROM SERVICEPRACTICE WHERE SP01='" & SystemNumber(Strindex, 1) & "'  AND SP02='" & SystemNumber(Strindex, 2) & "' AND SP03='" & SystemNumber(Strindex, 3) & "' AND SP04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select LC15 FROM LAWCASE WHERE LC01='" & SystemNumber(Strindex, 1) & "'  AND LC02='" & SystemNumber(Strindex, 2) & "' AND LC03='" & SystemNumber(Strindex, 3) & "' AND LC04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select '' FROM HIRECASE WHERE HC01='" & SystemNumber(Strindex, 1) & "'  AND HC02='" & SystemNumber(Strindex, 2) & "' AND HC03='" & SystemNumber(Strindex, 3) & "' AND HC04='" & SystemNumber(Strindex, 4) & "' "
CheckOC3
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
    If Not IsNull(AdoRecordSet3.Fields(0)) Then
        strTemp = AdoRecordSet3.Fields(0)
    Else
        strTemp = ""
    End If
Else
    strTemp = ""
End If
CheckOC3
strSql = "SELECT NP07 FROM NEXTPROGRESS WHERE NP01='" & StrIndex2 & "' "
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
    If Not IsNull(AdoRecordSet3.Fields(0)) Then
        StrIndex2 = AdoRecordSet3.Fields(0)
    Else
        StrIndex2 = ""
    End If
Else
    StrIndex2 = ""
End If
CheckOC3

If strTemp = "000" Then
    strSql = "SELECT CPM03 FROM CASEPROPERTYMAP WHERE CPM01='" & SystemNumber(Strindex, 1) & "' AND CPM02='" & StrIndex2 & "' "
Else
    strSql = "SELECT CPM04 FROM CASEPROPERTYMAP WHERE CPM01='" & SystemNumber(Strindex, 1) & "' AND CPM02='" & StrIndex2 & "' "
End If
CheckOC3
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
    If Not IsNull(AdoRecordSet3.Fields(0)) Then
        GetPrjState5 = AdoRecordSet3.Fields(0)
    Else
        GetPrjState5 = ""
    End If
Else
    GetPrjState5 = ""
End If
CheckOC3

End Function

'案件性質
'Modify By Sindy 2025/3/25 +Optional strColCnt As String = "":第幾個欄位
Public Function GetPrjState6(ByRef Strindex As String, ByRef StrIndex2 As String, _
   Optional strColCnt As String = "") As String
CheckOC3
strSql = "SELECT CPM03,CPM04 FROM CASEPROPERTYMAP WHERE CPM01='" & Strindex & "' AND CPM02='" & StrIndex2 & "' "
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
   'Modify By Sindy 2025/3/25
   If strColCnt <> "" Then
      If Not IsNull(AdoRecordSet3.Fields(Val(strColCnt))) Then
         GetPrjState6 = AdoRecordSet3.Fields(Val(strColCnt))
      End If
      If GetPrjState6 <> "" Then Exit Function
   End If
   '2025/3/25 END
   If Not IsNull(AdoRecordSet3.Fields(0)) Then
       If AdoRecordSet3.Fields(0) = "（無）" Then
          GetPrjState6 = AdoRecordSet3.Fields(1)
       Else
          GetPrjState6 = AdoRecordSet3.Fields(0)
       End If
   Else
       If Not IsNull(AdoRecordSet3.Fields(1)) Then
           GetPrjState6 = AdoRecordSet3.Fields(1)
       Else
           GetPrjState6 = ""
       End If
   End If
Else
   GetPrjState6 = ""
End If
CheckOC3
End Function

'Add By Sindy 2021/6/17 + Optional ByVal strCol As String, Optional ByRef strColVal As String
Public Function GetPrjState6HM(ByRef Strindex As String, ByRef StrIndex2 As String, _
   Optional ByVal strCol As String, Optional ByRef strColVal As String) As String       '案件性質
CheckOC3

'Modify By Sindy 2021/6/17 + ," & IIf(strCol <> "", strCol, "cpm02") & "
strSql = "SELECT CPM03,CPM04," & IIf(strCol <> "", strCol, "cpm02") & " FROM CASEPROPERTYMAP WHERE CPM01='" & Strindex & "' AND CPM02='" & StrIndex2 & "' "
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
    strColVal = "" & AdoRecordSet3.Fields(2) 'Add By Sindy 2021/6/17
    
    If Not IsNull(AdoRecordSet3.Fields(0)) Then
        GetPrjState6HM = AdoRecordSet3.Fields(0)
    Else
        If Not IsNull(AdoRecordSet3.Fields(1)) Then
            GetPrjState6HM = AdoRecordSet3.Fields(1)
        Else
            GetPrjState6HM = ""
        End If
    End If
Else
    GetPrjState6HM = ""
End If
CheckOC3

End Function

'業務區中文名稱
'Modify by Amy 2024/01/12 +IsNewDept
Public Function GetPrjSalesBlack(ByRef Strindex As String, Optional ByVal IsNewDept As Boolean = False) As String          '業務區中文名稱
CheckOC3
'Modify by Amy 2023/12/19 +新部門
If IsNewDept = True Then
   '簡稱
   strSql = "Select A0922 From Acc090New Where A0921='" & Strindex & "' "
Else
   strSql = "SELECT A0902 FROM ACC090 WHERE A0901='" & Strindex & "' "
End If
'add by nickc 2007/04/18
AdoRecordSet3.CursorLocation = adUseClient

AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
    If Not IsNull(AdoRecordSet3.Fields(0)) Then
        GetPrjSalesBlack = AdoRecordSet3.Fields(0)
    Else
        GetPrjSalesBlack = ""
    End If
Else
    GetPrjSalesBlack = ""
End If
CheckOC3
End Function

 '智權人員,承辦人        NICK
'Modify By Cheng 2002/09/26
'Public Function GetPrjSales(ByRef Strindex As String) As String          '智權人員,承辦人        NICK
Public Function GetPrjSales(ByRef Strindex As String, Optional strStaffKind As String) As String          '智權人員,承辦人        NICK
'strStaffKind:傳入人員種類
Dim s As Integer

If Strindex <> "" Then
   '900801
   '邱小姐說離職不用管
   'strSQL = "SELECT ST02 FROM STAFF WHERE ST01='" & Strindex & "' and st04='1' "
   strSql = "SELECT ST02 FROM STAFF WHERE ST01='" & Strindex & "' "
   CheckOC3
   AdoRecordSet3.CursorLocation = adUseClient
   AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
      If Not IsNull(AdoRecordSet3.Fields(0)) Then
          GetPrjSales = AdoRecordSet3.Fields(0)
      Else
          GetPrjSales = Strindex
      End If
   Else
      'Modify By Cheng 2002/09/27
'      s = MsgBox("無此承辦人，請重新輸入！！", , "User 輸入錯誤！")
      If strStaffKind <> "" Then
         s = MsgBox("無此" & strStaffKind & "，請重新輸入！！", , "User 輸入錯誤！")
      Else
         s = MsgBox("無此承辦人，請重新輸入！！", , "User 輸入錯誤！")
      End If
      GetPrjSales = Strindex
   End If
   CheckOC3
Else
   GetPrjSales = Strindex
End If
End Function

'Modify By Sindy 2020/9/30 + Optional ByRef strST22 As String
'Modify By Sindy 2022/11/30 + Optional ByRef strST17 As String
'Modify By Sindy 2023/9/25 + Optional ByVal strQryCol As String: 要查詢的欄位名稱
'                            Optional ByRef strRefColVal As String: 回傳欄位值
Public Function GetPrjSalesNM(ByRef Strindex As String, Optional ByRef strST22 As String, _
   Optional ByRef strST17 As String, _
   Optional ByVal strQryCol As String, Optional ByRef strRefColVal As String) As String
   
   strST22 = ""
   strST17 = ""
   strRefColVal = "" 'Add By Sindy 2023/9/25
   
If Strindex <> "" Then
   '900801
   '邱小姐說離職不用管
   'strSQL = "SELECT ST02 FROM STAFF WHERE ST01='" & Strindex & "' and st04='1' "
   'Modify By Sindy 2019/12/2 + UCase()
   'Modify By Sindy 2023/9/25 + IIf(strQryCol <> "", "," & strQryCol, "")
   strSql = "SELECT ST02,st22,ST17" & IIf(strQryCol <> "", "," & strQryCol, "") & _
            " FROM STAFF WHERE ST01='" & UCase(Strindex) & "' "
   CheckOC3
   AdoRecordSet3.CursorLocation = adUseClient
   AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
      If Not IsNull(AdoRecordSet3.Fields(0)) Then
         GetPrjSalesNM = AdoRecordSet3.Fields(0)
         strST22 = "" & AdoRecordSet3.Fields("st22") 'Add By Sindy 2020/9/30
         strST17 = "" & AdoRecordSet3.Fields("ST17") 'Add By Sindy 2022/11/30
         'Modify By Sindy 2023/9/25
         If strQryCol <> "" Then
           strRefColVal = "" & AdoRecordSet3.Fields(strQryCol)
         End If
         '2023/9/25 END
      Else
         '901212  邱小姐說代不出來就空白
         'GetPrjSalesNM = Strindex
         GetPrjSalesNM = ""
      End If
   Else
      's = MsgBox("無此承辦人，請重新輸入！！", , "User 輸入錯誤！")
      '901212  邱小姐說代不出來就空白
      'GetPrjSalesNM = Strindex
      GetPrjSalesNM = ""
   End If
   CheckOC3
Else
   '901212  邱小姐說代不出來就空白
   'GetPrjSalesNM = Strindex
   GetPrjSalesNM = ""
End If
End Function

'Add By Sindy 2013/4/23 以員工姓名查詢員工編號
'Modify By Sindy 2014/4/16 + , Optional strStaffDepartment As String, Optional strST06 As String
'Modify By Sindy 2019/2/1 + , Optional ByVal iState As Integer = 0 (0.姓名, +1.員編)
'Modified by Lydia 2019/05/08 +含外翻人員 bolAddF51
'Modify By Sindy 2021/6/22 + , Optional bolNot9 As Boolean = True:過濾員工編號第4碼為9的
Public Function GetPrjSalesNM_2(ByRef Strindex As String, Optional strStaffDepartment As String, _
   Optional strST06 As String, Optional ByVal iState As Integer = 0, Optional ByVal bolAddF51 As Boolean = False, _
   Optional bolNot9 As Boolean = True) As String
   
Dim strCon As String 'Add By Sindy 2019/2/1

   strStaffDepartment = ""
   strST06 = ""
   'Add By Sindy 2019/2/1
   If iState = 1 Then
      strCon = " and ST01='" & UCase(Strindex) & "'"
   Else
   '2019/2/1 END
      'Modify By Sindy 2021/7/8 + UCase
      strCon = " and ST02='" & UCase(Strindex) & "'"
   End If
   
   'Modify By Sindy 2021/6/22 過濾員工編號第4碼為9的
   If bolNot9 = True Then
      strCon = strCon & " and substr(st01,4,1)<>'9'"
'   Else '會用到第4碼是9的, 目前有歷程操作時P11.專利工程師
'      strCon = strCon & " and st03='P11'"
   End If
   '2021/6/22 END
   
   If Strindex <> "" Then
      '只抓在職的
      'strSql = "SELECT ST01 FROM STAFF WHERE ST02='" & Strindex & "' and ST04='1' and substr(ST01,1,1)<>'F' order by st01 asc"
      'Modify By Sindy 2019/2/1
      'strSql = "SELECT ST01,a0902,st04,st06 FROM STAFF,acc090 where st03=a0901 and ST02='" & Strindex & "' and ST04='1' and substr(ST01,1,1)>='6' and substr(ST01,1,1)<'F' order by st01 asc"
      'Modified by Lydia 2019/05/08
      'strSql = "SELECT ST01,a0902,st04,st06 FROM STAFF,acc090 where st03=a0901 " & strCon & " and ST04='1' and substr(ST01,1,1)>='6' and substr(ST01,1,1)<'F' order by st01 asc"
      'Modify By Sindy 2019/12/2 + W人員 or substr(ST01,1,1)='W')
      'strSql = "SELECT ST01,a0902,st04,st06 FROM STAFF,acc090 where st03=a0901 " & strCon & " and ST04='1' and substr(ST01,1,1)>='6' " & IIf(bolAddF51 = False, "and substr(ST01,1,1)<'F' ", "") & "order by st01 asc"
      'Modify By Sindy 2021/6/25 bolAddF51 組的語法有點問題,加(
      'Modify By Sindy 2021/7/7 + OR substr(ST01,1,4)='MCTF'
      'Added by Lydia 2024/01/05
'      If strSrvDate(1) >= 新部門啟用日 Then 'Modify By Sindy 2025/4/24 mark
         'Modified by Lydia 2024/02/29 新建同仁尚未設定ST03,在設定電話分機找不到員工資料;st03=a0901改成st03=a0901(+)
         'Modify By Sindy 2025/4/24 +,st03
         strSql = "SELECT ST01,nvl(a0922,a0902) as a0902,st04,st06,st03 FROM STAFF,acc090,acc090new where st03=a0901(+) and st93=a0921(+) " & strCon & _
                  " and ST04='1' and st01 not in('60000') and ((substr(ST01,1,1)>='6' " & IIf(bolAddF51 = False, "and substr(ST01,1,1)<'F'", "") & ") OR substr(ST01,1,1)='W' OR substr(ST01,1,4)='MCTF')"
'      Else
'      'end 2024/01/05
'         strSql = "SELECT ST01,a0902,st04,st06,st03 FROM STAFF,acc090 where st03=a0901 " & strCon & _
'                  " and ST04='1' and st01 not in('60000') and ((substr(ST01,1,1)>='6' " & IIf(bolAddF51 = False, "and substr(ST01,1,1)<'F'", "") & ") OR substr(ST01,1,1)='W' OR substr(ST01,1,4)='MCTF')"
'         '2019/12/2 END
'      End If
      strSql = strSql & " order by st01 asc"
      CheckOC3
      AdoRecordSet3.CursorLocation = adUseClient
      AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
         'Modify By Sindy 2021/6/22 會用到第4碼是9的, 目前有歷程操作時P11.專利工程師
         If bolNot9 = False Then
            AdoRecordSet3.MoveLast
            'Modify By Sindy 2025/4/24 增加判斷與操作人員部門前2碼相同
            If Not IsNull(AdoRecordSet3.Fields(0)) And Not IsNull(AdoRecordSet3.Fields("st03")) Then
               If Left(AdoRecordSet3.Fields("st03"), 2) = Left(Pub_StrUserSt03, 2) Then
            '2025/4/24 END
                  GetPrjSalesNM_2 = AdoRecordSet3.Fields(0)
                  strStaffDepartment = "" & AdoRecordSet3.Fields("a0902")
                  strST06 = "" & AdoRecordSet3.Fields("st06")
                  Exit Function
               End If
            End If
         End If
         '2021/6/22 END
         
         AdoRecordSet3.MoveFirst
         If Not IsNull(AdoRecordSet3.Fields(0)) Then
            GetPrjSalesNM_2 = AdoRecordSet3.Fields(0)
            strStaffDepartment = "" & AdoRecordSet3.Fields("a0902")
            strST06 = "" & AdoRecordSet3.Fields("st06")
         Else
            GetPrjSalesNM_2 = ""
         End If
     Else
         GetPrjSalesNM_2 = ""
      End If
      CheckOC3
   Else
      GetPrjSalesNM_2 = ""
   End If
End Function

'收據編號
Public Function GetPrjCaseNumber(ByRef Strindex As String) As String            '收據編號
strSql = "SELECT CP60,CP10,CP01 FROM CASEPROGRESS WHERE CP43='" & Strindex & "' "
CheckOC3
GetPrjCaseNumber = ""
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
    AdoRecordSet3.MoveFirst
    Do While AdoRecordSet3.EOF = False
        If Not IsNull(AdoRecordSet3.Fields(2)) Then
            Select Case AdoRecordSet3.Fields(2)
            Case "CFP", "FCP", "P", "CPS", "FG", "PS"
                  If AdoRecordSet3.Fields(1) = "909" Then
                     If Not IsNull(AdoRecordSet3.Fields(0)) Then
                         GetPrjCaseNumber = AdoRecordSet3.Fields(0)
                         Exit Function
                     End If
                  End If
            Case "CFT", "FCT", "T", "TF", "CFC", "S"
                  If AdoRecordSet3.Fields(1) = "704" Then
                     If Not IsNull(AdoRecordSet3.Fields(0)) Then
                         GetPrjCaseNumber = AdoRecordSet3.Fields(0)
                         Exit Function
                     End If
                  End If
            Case Else
                 If Mid(AdoRecordSet3.Fields(2), 1, 1) = "T" Then
                    If AdoRecordSet3.Fields(1) = "704" Then
                        If Not IsNull(AdoRecordSet3.Fields(0)) Then
                            GetPrjCaseNumber = AdoRecordSet3.Fields(0)
                            Exit Function
                        End If
                    End If
                 End If
            End Select
        End If
    AdoRecordSet3.MoveNext
    Loop
Else
    GetPrjCaseNumber = ""
End If
CheckOC3
End Function

'收回日
Public Function GetPrjGoBackDate(ByRef Strindex As String) As String            '收回日
Dim strTemp As String
strSql = "SELECT A0M01 FROM ACC0M0 WHERE A0M02='" & Strindex & "' ORDER BY A0M01 "
CheckOC3
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
    AdoRecordSet3.MoveLast
    If Not IsNull(AdoRecordSet3.Fields(0)) Then
        strTemp = AdoRecordSet3.Fields(0)
    Else
        strTemp = ""
    End If
Else
    strTemp = ""
End If
CheckOC3
'edit by nick  抓最大值
'StrSql = "SELECT A0L02 FROM ACC0L0 WHERE A0L01='" & strTemp & "' "
strSql = "SELECT MAX(A0L02) FROM ACC0L0 WHERE A0L01='" & strTemp & "' "
CheckOC3
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
    If Not IsNull(AdoRecordSet3.Fields(0)) Then
        GetPrjGoBackDate = ChangeTStringToTDateString(str(AdoRecordSet3.Fields(0)))
    Else
        GetPrjGoBackDate = ""
    End If
Else
    GetPrjGoBackDate = ""
End If
CheckOC3
End Function

'收回金額
Public Function GetPrjGoBackMoney(ByRef Strindex As String) As String               '收回金額
Dim IntTatle As Integer
'    edit by nick 2004/11/29  秀玲說應該要抓 CP75 ，不然單一收據有很多收文號十，會錯
' 本來是傳入收據號碼，現改為傳入收文號
strSql = "SELECT cp75 FROM caseprogress WHERE cp09='" & Strindex & "' "
CheckOC3
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
IntTatle = 0
If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
'    edit by nick 2004/11/29  秀玲說應該要抓 CP75 ，不然單一收據有很多收文號十，會錯
'    If Not IsNull(AdoRecordSet3.Fields(0)) Then
'        IntTatle = IntTatle + AdoRecordSet3.Fields(0)
'    End If
'    If Not IsNull(AdoRecordSet3.Fields(1)) Then
'        IntTatle = IntTatle + AdoRecordSet3.Fields(1)
'    End If
'    If Not IsNull(AdoRecordSet3.Fields(2)) Then
'        IntTatle = IntTatle + AdoRecordSet3.Fields(2)
'    End If
    If Not IsNull(AdoRecordSet3.Fields(0)) Then
        IntTatle = IntTatle + AdoRecordSet3.Fields(0)
    End If
    GetPrjGoBackMoney = str(IntTatle)
Else
    GetPrjGoBackMoney = ""
End If
CheckOC3
End Function

 '代理人名稱
Public Function GetPrjName1(ByRef Strindex As String) As String               '代理人名稱
If Len(Strindex) = 8 Then
    strSql = "SELECT NVL(FA04,NVL(FA05||FA63||FA64||FA65,FA06)) FROM FAGENT WHERE FA01='" & Strindex & "' AND FA02='0' "
Else
    strSql = "SELECT NVL(FA04,NVL(FA05||FA63||FA64||FA65,FA06)) FROM FAGENT WHERE FA01='" & Mid(Strindex, 1, 8) & "' AND FA02='" & Mid(Strindex, 9, 1) & "'"
End If
CheckOC3
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly

If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
    If Not IsNull(AdoRecordSet3.Fields(0)) Then
        GetPrjName1 = AdoRecordSet3.Fields(0)
    Else
        GetPrjName1 = ""
    End If
Else
    GetPrjName1 = ""
End If
CheckOC3
End Function

'代理人國籍代號
Public Function GetPrjNationNumber(ByRef Strindex As String) As String               '代理人國籍代號
If Len(Strindex) = 8 Then
    strSql = "SELECT FA10 FROM FAGENT WHERE FA01='" & Strindex & "' AND FA02='0' "
Else
    strSql = "SELECT FA10 FROM FAGENT WHERE FA01='" & Mid(Strindex, 1, 8) & "' AND FA02='" & Mid(Strindex, 9, 1) & "'"
End If
CheckOC3
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
    If Not IsNull(AdoRecordSet3.Fields(0)) Then
        GetPrjNationNumber = AdoRecordSet3.Fields(0)
    Else
        GetPrjNationNumber = ""
    End If
Else
    GetPrjNationNumber = ""
End If
CheckOC3
End Function

'國家名稱
'Modify by Sindy 2017/11/14 +StField可抓NA81
'Modify By Sindy 2019/7/16 + Optional ByVal stCP01 As String = "".系統別
Public Function GetPrjNationName(ByRef Strindex As String, _
   Optional ByVal stField As String = "NA03", _
   Optional ByVal stCP01 As String = "") As String
strSql = "SELECT " & stField & " FROM NATION WHERE NA01='" & Strindex & "' "
CheckOC3
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
    If Not IsNull(AdoRecordSet3.Fields(0)) Then
        GetPrjNationName = AdoRecordSet3.Fields(0)
    Else
        GetPrjNationName = ""
    End If
Else
    GetPrjNationName = ""
End If

'Added by Lydia 2019/07/11 遵照桂所長指示：台灣案申請書之申請人名稱欄，國外客戶之國籍標示方式統一 ; 在國籍xx商與申請人名稱之間 , 固定都加•區隔
               '因為外商日文組所有的申請書皆以下列方式表示(例：日商．黛怡茜股份有限公司)，皆是由客戶指示標示的方式，偶有客戶（約1%）會要求不加一點， 蓋因日商後有無一點，有些代理人非常的在意
'Modified by Lydia 2019/07/12 排除台灣
'Remove by Lydia 2019/07/30 改在各程式判斷
'If stField = "NA81" And Strindex > "010" Then
'   'Modify By Sindy 2019/7/16 內外專均不加.
'   If stCP01 <> "FCP" And stCP01 <> "FG" And stCP01 <> "P" And stCP01 <> "PS" Then
'   '2019/7/16 END
'      GetPrjNationName = GetPrjNationName & "．"
'   End If
'End If
'end 2019/07/30

CheckOC3
End Function

'國家名稱
Public Function GetPrjNationNameHM(ByRef Strindex As String) As String               '國家名稱
strSql = "SELECT NA03 FROM NATION WHERE NA01='" & Strindex & "' "
CheckOC3
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
    If Not IsNull(AdoRecordSet3.Fields(0)) Then
        GetPrjNationNameHM = AdoRecordSet3.Fields(0)
    Else
        GetPrjNationNameHM = ""
    End If
Else
    GetPrjNationNameHM = ""
End If
CheckOC3
End Function

'申請人國籍代號
'Modify by Amy 2015/12/31 +StField可抓cu87
'Modify By Sindy 2019/7/17 只想取公司的國籍 + , Optional ByVal stCU15 As String = ""
Public Function GetPrjNationNumber1(ByRef Strindex As String, _
   Optional ByVal stField As String = "CU10", Optional ByVal stCU15 As String = "") As String

If Len(Strindex) = 9 Then
    strSql = "SELECT " & stField & " FROM CUSTOMER WHERE CU01='" & Mid(Strindex, 1, 8) & "' AND CU02='" & Mid(Strindex, 9, 1) & "'"
Else
    strSql = "SELECT " & stField & " FROM CUSTOMER WHERE CU01='" & Mid(Strindex, 1, 8) & "' AND CU02='0'"
End If
'Add By Sindy 2019/7/17
If Trim(stCU15) <> "" Then
   strSql = strSql & " AND CU15='" & Trim(stCU15) & "'"
End If
'2019/7/17 END
CheckOC3
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
    If Not IsNull(AdoRecordSet3.Fields(0)) Then
        GetPrjNationNumber1 = AdoRecordSet3.Fields(0)
    Else
        GetPrjNationNumber1 = ""
    End If
Else
    GetPrjNationNumber1 = ""
End If
CheckOC3
End Function

'代理人名稱
Public Function GetPrjName2(ByRef Strindex As String) As String               '代理人名稱
If Len(Strindex) = 8 Then
    strSql = "SELECT NVL(FA05||FA63||FA64||FA65,NVL(FA04,FA06)) FROM FAGENT WHERE FA01='" & Strindex & "' and FA02='0' "
Else
    strSql = "SELECT NVL(FA05||FA63||FA64||FA65,NVL(FA04,FA06)) FROM FAGENT WHERE FA01='" & Mid(Strindex, 1, 8) & "' AND FA02='" & Mid(Strindex, 9, 1) & "'"
End If
CheckOC3
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly

If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
    If Not IsNull(AdoRecordSet3.Fields(0)) Then
        GetPrjName2 = AdoRecordSet3.Fields(0)
    Else
        GetPrjName2 = ""
    End If
Else
    GetPrjName2 = ""
End If
CheckOC3
End Function

'抓申請人1代碼
Public Function GetPrjPeopleNum1(ByRef Strindex As String) As String            '抓申請人1代碼
If UCase(Left(Strindex, 1)) = "N" Then
    Strindex = Right(Strindex, Len(Strindex) - 1)
End If
strSql = "SELECT TM23 FROM  TRADEMARK WHERE TM01='" & SystemNumber(Strindex, 1) & "'  AND TM02='" & SystemNumber(Strindex, 2) & "' AND TM03='" & SystemNumber(Strindex, 3) & "' AND TM04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select PA26 FROM PATENT WHERE PA01='" & SystemNumber(Strindex, 1) & "'  AND PA02='" & SystemNumber(Strindex, 2) & "' AND PA03='" & SystemNumber(Strindex, 3) & "' AND PA04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select SP08 FROM SERVICEPRACTICE WHERE SP01='" & SystemNumber(Strindex, 1) & "'  AND SP02='" & SystemNumber(Strindex, 2) & "' AND SP03='" & SystemNumber(Strindex, 3) & "' AND SP04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select LC11 FROM LAWCASE WHERE LC01='" & SystemNumber(Strindex, 1) & "'  AND LC02='" & SystemNumber(Strindex, 2) & "' AND LC03='" & SystemNumber(Strindex, 3) & "' AND LC04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select HC05 FROM HIRECASE WHERE HC01='" & SystemNumber(Strindex, 1) & "'  AND HC02='" & SystemNumber(Strindex, 2) & "' AND HC03='" & SystemNumber(Strindex, 3) & "' AND HC04='" & SystemNumber(Strindex, 4) & "' "
CheckOC3
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
    If Not IsNull(AdoRecordSet3.Fields(0)) Then
        GetPrjPeopleNum1 = AdoRecordSet3.Fields(0)
    Else
        GetPrjPeopleNum1 = ""
    End If
Else
    GetPrjPeopleNum1 = ""
End If
CheckOC3
End Function

'抓申請人2代碼
Public Function GetPrjPeopleNum2(ByRef Strindex As String) As String            '抓申請人2代碼
If UCase(Left(Strindex, 1)) = "N" Then
    Strindex = Right(Strindex, Len(Strindex) - 1)
End If
'Modify by Morgan 2008/11/13 語法有錯
strSql = "SELECT TM78 FROM  TRADEMARK WHERE TM01='" & SystemNumber(Strindex, 1) & "'  AND TM02='" & SystemNumber(Strindex, 2) & "' AND TM03='" & SystemNumber(Strindex, 3) & "' AND TM04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select PA27 FROM PATENT WHERE PA01='" & SystemNumber(Strindex, 1) & "'  AND PA02='" & SystemNumber(Strindex, 2) & "' AND PA03='" & SystemNumber(Strindex, 3) & "' AND PA04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select SP58 FROM SERVICEPRACTICE WHERE SP01='" & SystemNumber(Strindex, 1) & "'  AND SP02='" & SystemNumber(Strindex, 2) & "' AND SP03='" & SystemNumber(Strindex, 3) & "' AND SP04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select LC43 FROM LAWCASE WHERE LC01='" & SystemNumber(Strindex, 1) & "'  AND LC02='" & SystemNumber(Strindex, 2) & "' AND LC03='" & SystemNumber(Strindex, 3) & "' AND LC04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select HC24 FROM HIRECASE WHERE HC01='" & SystemNumber(Strindex, 1) & "'  AND HC02='" & SystemNumber(Strindex, 2) & "' AND HC03='" & SystemNumber(Strindex, 3) & "' AND HC04='" & SystemNumber(Strindex, 4) & "' "
CheckOC3
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
    If Not IsNull(AdoRecordSet3.Fields(0)) Then
        GetPrjPeopleNum2 = AdoRecordSet3.Fields(0)
    Else
        GetPrjPeopleNum2 = ""
    End If
Else
    GetPrjPeopleNum2 = ""
End If
CheckOC3
End Function

'抓申請人3代碼
Public Function GetPrjPeopleNum3(ByRef Strindex As String) As String            '抓申請人3代碼
If UCase(Left(Strindex, 1)) = "N" Then
    Strindex = Right(Strindex, Len(Strindex) - 1)
End If
'Modify by Morgan 2008/11/13 語法有錯
strSql = "SELECT TM79 FROM  TRADEMARK WHERE TM01='" & SystemNumber(Strindex, 1) & "'  AND TM02='" & SystemNumber(Strindex, 2) & "' AND TM03='" & SystemNumber(Strindex, 3) & "' AND TM04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select PA28 FROM PATENT WHERE PA01='" & SystemNumber(Strindex, 1) & "'  AND PA02='" & SystemNumber(Strindex, 2) & "' AND PA03='" & SystemNumber(Strindex, 3) & "' AND PA04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select SP59 FROM SERVICEPRACTICE WHERE SP01='" & SystemNumber(Strindex, 1) & "'  AND SP02='" & SystemNumber(Strindex, 2) & "' AND SP03='" & SystemNumber(Strindex, 3) & "' AND SP04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select LC44 FROM LAWCASE WHERE LC01='" & SystemNumber(Strindex, 1) & "'  AND LC02='" & SystemNumber(Strindex, 2) & "' AND LC03='" & SystemNumber(Strindex, 3) & "' AND LC04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select HC25 FROM HIRECASE WHERE HC01='" & SystemNumber(Strindex, 1) & "'  AND HC02='" & SystemNumber(Strindex, 2) & "' AND HC03='" & SystemNumber(Strindex, 3) & "' AND HC04='" & SystemNumber(Strindex, 4) & "' "
CheckOC3
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
    If Not IsNull(AdoRecordSet3.Fields(0)) Then
        GetPrjPeopleNum3 = AdoRecordSet3.Fields(0)
    Else
        GetPrjPeopleNum3 = ""
    End If
Else
    GetPrjPeopleNum3 = ""
End If
CheckOC3
End Function

'抓申請人4代碼
Public Function GetPrjPeopleNum4(ByRef Strindex As String) As String            '抓申請人4代碼
If UCase(Left(Strindex, 1)) = "N" Then
    Strindex = Right(Strindex, Len(Strindex) - 1)
End If
'Modify by Morgan 2008/11/13 語法有錯
strSql = "SELECT TM80 FROM  TRADEMARK WHERE TM01='" & SystemNumber(Strindex, 1) & "'  AND TM02='" & SystemNumber(Strindex, 2) & "' AND TM03='" & SystemNumber(Strindex, 3) & "' AND TM04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select PA29 FROM PATENT WHERE PA01='" & SystemNumber(Strindex, 1) & "'  AND PA02='" & SystemNumber(Strindex, 2) & "' AND PA03='" & SystemNumber(Strindex, 3) & "' AND PA04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select SP65 FROM SERVICEPRACTICE WHERE SP01='" & SystemNumber(Strindex, 1) & "'  AND SP02='" & SystemNumber(Strindex, 2) & "' AND SP03='" & SystemNumber(Strindex, 3) & "' AND SP04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select LC45 FROM LAWCASE WHERE LC01='" & SystemNumber(Strindex, 1) & "'  AND LC02='" & SystemNumber(Strindex, 2) & "' AND LC03='" & SystemNumber(Strindex, 3) & "' AND LC04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select HC26 FROM HIRECASE WHERE HC01='" & SystemNumber(Strindex, 1) & "'  AND HC02='" & SystemNumber(Strindex, 2) & "' AND HC03='" & SystemNumber(Strindex, 3) & "' AND HC04='" & SystemNumber(Strindex, 4) & "' "
CheckOC3
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
    If Not IsNull(AdoRecordSet3.Fields(0)) Then
        GetPrjPeopleNum4 = AdoRecordSet3.Fields(0)
    Else
        GetPrjPeopleNum4 = ""
    End If
Else
    GetPrjPeopleNum4 = ""
End If
CheckOC3
End Function

'抓申請人5代碼
Public Function GetPrjPeopleNum5(ByRef Strindex As String) As String            '抓申請人5代碼
If UCase(Left(Strindex, 1)) = "N" Then
    Strindex = Right(Strindex, Len(Strindex) - 1)
End If
'Modify by Morgan 2008/11/13 語法有錯
strSql = "SELECT TM81 FROM  TRADEMARK WHERE TM01='" & SystemNumber(Strindex, 1) & "'  AND TM02='" & SystemNumber(Strindex, 2) & "' AND TM03='" & SystemNumber(Strindex, 3) & "' AND TM04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select PA30 FROM PATENT WHERE PA01='" & SystemNumber(Strindex, 1) & "'  AND PA02='" & SystemNumber(Strindex, 2) & "' AND PA03='" & SystemNumber(Strindex, 3) & "' AND PA04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select SP66 FROM SERVICEPRACTICE WHERE SP01='" & SystemNumber(Strindex, 1) & "'  AND SP02='" & SystemNumber(Strindex, 2) & "' AND SP03='" & SystemNumber(Strindex, 3) & "' AND SP04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select LC46 FROM LAWCASE WHERE LC01='" & SystemNumber(Strindex, 1) & "'  AND LC02='" & SystemNumber(Strindex, 2) & "' AND LC03='" & SystemNumber(Strindex, 3) & "' AND LC04='" & SystemNumber(Strindex, 4) & "' "
strSql = strSql + " union all select HC27 FROM HIRECASE WHERE HC01='" & SystemNumber(Strindex, 1) & "'  AND HC02='" & SystemNumber(Strindex, 2) & "' AND HC03='" & SystemNumber(Strindex, 3) & "' AND HC04='" & SystemNumber(Strindex, 4) & "' "
CheckOC3
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
    If Not IsNull(AdoRecordSet3.Fields(0)) Then
        GetPrjPeopleNum5 = AdoRecordSet3.Fields(0)
    Else
        GetPrjPeopleNum5 = ""
    End If
Else
    GetPrjPeopleNum5 = ""
End If
CheckOC3
End Function

'抓代理人代碼
'Modify By Sindy 2020/4/29 + 抓國家檔,是否停止郵務 Optional strCol As String = "NA03", Optional ByRef strVal As String = ""
Public Function GetPrjPeopleNum6(ByRef Strindex As String, _
   Optional strCol As String = "NA03", Optional ByRef strVal As String = "") As String '抓代理人代碼

If UCase(Left(Strindex, 1)) = "N" Then
    Strindex = Right(Strindex, Len(Strindex) - 1)
End If
'Moidyf By Sindy 2020/4/29 + ," & strCol & "
strSql = "SELECT TM44," & strCol & " FROM TRADEMARK,fagent,nation WHERE TM01='" & SystemNumber(Strindex, 1) & "'  AND TM02='" & SystemNumber(Strindex, 2) & "' AND TM03='" & SystemNumber(Strindex, 3) & "' AND TM04='" & SystemNumber(Strindex, 4) & "' and substr(TM44,1,8)=fa01(+) and substr(TM44,9,1)=fa02(+) and fa10=na01(+) "
strSql = strSql + " union all select PA75," & strCol & " FROM PATENT,fagent,nation WHERE PA01='" & SystemNumber(Strindex, 1) & "'  AND PA02='" & SystemNumber(Strindex, 2) & "' AND PA03='" & SystemNumber(Strindex, 3) & "' AND PA04='" & SystemNumber(Strindex, 4) & "' and substr(PA75,1,8)=fa01(+) and substr(PA75,9,1)=fa02(+) and fa10=na01(+) "
strSql = strSql + " union all select SP26," & strCol & " FROM SERVICEPRACTICE,fagent,nation WHERE SP01='" & SystemNumber(Strindex, 1) & "'  AND SP02='" & SystemNumber(Strindex, 2) & "' AND SP03='" & SystemNumber(Strindex, 3) & "' AND SP04='" & SystemNumber(Strindex, 4) & "' and substr(SP26,1,8)=fa01(+) and substr(SP26,9,1)=fa02(+) and fa10=na01(+) "
strSql = strSql + " union all select LC22," & strCol & " FROM LAWCASE,fagent,nation WHERE LC01='" & SystemNumber(Strindex, 1) & "'  AND LC02='" & SystemNumber(Strindex, 2) & "' AND LC03='" & SystemNumber(Strindex, 3) & "' AND LC04='" & SystemNumber(Strindex, 4) & "' and substr(LC22,1,8)=fa01(+) and substr(LC22,9,1)=fa02(+) and fa10=na01(+) "
CheckOC3
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
strVal = "" 'Add By Sindy 2020/4/29
If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
    If Not IsNull(AdoRecordSet3.Fields(0)) Then
        GetPrjPeopleNum6 = AdoRecordSet3.Fields(0)
        strVal = "" & AdoRecordSet3.Fields(strCol) 'Add By Sindy 2020/4/29
    Else
        GetPrjPeopleNum6 = ""
    End If
Else
    GetPrjPeopleNum6 = ""
End If
CheckOC3
End Function

'取得結清
Public Function GetPrjTotleByEnd(ByRef Strindex As String) As Long               '取得結清
Dim IntTemp1() As Variant, IntTemp2() As Long, IntTemp3() As Long
Dim i As Integer

strSql = "SELECT A0Z01,A0Z04 FROM ACC0Z0 WHERE A0Z02='" & Strindex & "'"
CheckOC3
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
    ReDim IntTemp1(AdoRecordSet3.RecordCount) As Variant
    ReDim IntTemp2(AdoRecordSet3.RecordCount) As Long
    ReDim IntTemp3(AdoRecordSet3.RecordCount) As Long
    For i = 0 To AdoRecordSet3.RecordCount - 1
        If Not IsNull(AdoRecordSet3.Fields(0)) Then
            IntTemp1(i) = AdoRecordSet3.Fields(0)
        Else
            IntTemp1(i) = ""
        End If
        If Not IsNull(AdoRecordSet3.Fields(1)) Then
            IntTemp2(i) = AdoRecordSet3.Fields(1)
        Else
            IntTemp2(i) = 0
        End If
    Next i
Else
    GetPrjTotleByEnd = 0
    Exit Function
End If
CheckOC3
For i = 0 To UBound(IntTemp1())
    strSql = "SELECT A0Y04 FROM ACC0Y0 WHERE A0Y01='" & IntTemp1(i) & "'"
    CheckOC3
    AdoRecordSet3.CursorLocation = adUseClient
    AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
    If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
        If Not IsNull(AdoRecordSet3.Fields(0)) Then
            IntTemp3(i) = AdoRecordSet3.Fields(0)
        Else
            IntTemp3(i) = 0
        End If
    Else
        IntTemp3(i) = 0
    End If
    CheckOC3
Next i
Dim IntTotle As Long
IntTotle = 0
For i = 0 To UBound(IntTemp1())
IntTotle = IntTotle + (IntTemp2(i) * IntTemp3(i))
Next i
GetPrjTotleByEnd = IntTotle
End Function

'取得外幣金額
Public Function GetPrjUSTotleByNick(ByRef Strindex As String) As Integer         '外幣金額
Dim IntTestTemp As Integer
strSql = "SELECT A0Z04,A0Y04 FROM ACC0Z0,ACC0Y0 WHERE A0Z01='" & Strindex & "' AND A0Y01=A0Z01 "
CheckOC3
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
    IntTestTemp = 0
    Do While AdoRecordSet3.EOF = False
        IntTestTemp = IntTestTemp + (AdoRecordSet3.Fields(0) * AdoRecordSet3.Fields(1))
        AdoRecordSet3.MoveNext
    Loop
    GetPrjUSTotleByNick = IntTestTemp
Else
    GetPrjUSTotleByNick = 0
End If
CheckOC3
End Function

'將不同型態轉為字串
Public Function CheckStr(ByRef Strindex As Variant) As String
If IsNull(Strindex) Then
    CheckStr = ""
Else
    Select Case VarType(Strindex)
    Case 2, 3, 4, 5
         'edit by nickc 2005/07/01 修正有造字的問題
         'CheckStr = Trim(str(Strindex))
         CheckStr = LTrim(str(Strindex))
    Case Else
         'edit by nickc 2005/07/01 修正有造字的問題
         'CheckStr = Trim(Strindex)
         CheckStr = LTrim(Strindex)
    End Select
End If
End Function

'將不同型態轉為字串
Public Function CheckNum(ByRef Strindex As Variant) As String
If IsNull(Strindex) Then
    CheckNum = "0"
Else
    Select Case VarType(Strindex)
    Case 2, 3, 4, 5
         CheckNum = Trim(str(Strindex))
    Case Else
         CheckNum = Trim(Strindex)
    End Select
End If
End Function

'Add by Morgan 2005/10/13
'限定字串長度
'Modified by Morgan 2018/8/24 合併frmAutoBatchDay, 並且修正截取字串造成"?"的問題
'Public Function convForm(ByVal p_InStr As String, ByVal p_Num As Integer, Optional ByVal p_Char As String = " ") As String
'   convForm = StrConv(LeftB(StrConv(p_InStr & String(p_Num, p_Char), vbFromUnicode), p_Num), vbUnicode)
'End Function

Public Function convForm(ByVal p_InStr As String, ByVal p_Num As Integer, Optional ByVal p_Char As String = " ", Optional p_AlignRight As Boolean = False) As String
   Dim iLenBig5 As Long 'Modified by Lydia 2020/02/17 Integer改成Long
   Dim strToBig5 As String
   Dim strRtn As String
   
   'Modified by Morgan 2018/8/24 中英混合時,以byte數切割後最先/後一個中文可能會只抓到1個byte而顯示異常("?"),改換成 p_Char
   'Modified by Morgan 2024/9/25 修正Unicode會變?問題
'   strToBig5 = StrConv(p_InStr, vbFromUnicode)
'   iLenBig5 = LenB(strToBig5)
'   If iLenBig5 > p_Num Then
'      If p_AlignRight Then
'         strRtn = StrConv(RightB(strToBig5, p_Num), vbUnicode)
'         If Right(p_InStr, Len(strRtn)) <> strRtn Then
'            strRtn = p_Char & StrConv(RightB(strToBig5, p_Num - 1), vbUnicode)
'         End If
'      Else
'         strRtn = StrConv(LeftB(strToBig5, p_Num), vbUnicode)
'         If Left(p_InStr, Len(strRtn)) <> strRtn Then
'            strRtn = StrConv(LeftB(strToBig5, p_Num - 1), vbUnicode) & p_Char
'         End If
'      End If
'   ElseIf p_Num = iLenBig5 Then
'      strRtn = p_InStr
'   ElseIf p_AlignRight Then
'      strRtn = String(p_Num - iLenBig5, p_Char) & p_InStr
'   Else
'      strRtn = p_InStr & String(p_Num - iLenBig5, p_Char)
'   End If
   
   strRtn = PUB_StrToStr(p_InStr, p_Num + 0)
   If p_Char <> "" Then
      iLenBig5 = GetTextLength(strRtn)
      If iLenBig5 < p_Num Then
         If p_AlignRight Then
            strRtn = String(p_Num - iLenBig5, p_Char) & strRtn
         Else
            strRtn = strRtn & String(p_Num - iLenBig5, p_Char)
         End If
      End If
   End If
   'end 2024/9/25
   
   convForm = strRtn
End Function

'取的新字串長度(StrIndex2=全形字數)
Public Function StrToStr(ByRef Strindex As String, ByRef StrIndex2 As Single) As String
'Modified by Morgan 2022/1/17 函數重複,改呼叫另一個已經有修正Unicode問題的
'Dim ii As Integer
''edit by nickc 2006/07/06
''StrToStr = StrConv(MidB(StrConv(Strindex, vbFromUnicode), 1, StrIndex2 * 2), vbUnicode)
'If Strindex <> "" Then
'    For ii = 1 To Len(Strindex)
'        If LenB(StrConv(StrToStr & Mid(Strindex, ii, 1), vbFromUnicode)) <= (StrIndex2 * 2) Then
'            'Modified by Morgan 2020/4/15 +LocalID : May CFT-020834 領證定稿會錯誤,”股份”二字會傳回”股?”
'            StrToStr = StrToStr & StrConv(MidB(StrConv(Mid(Strindex, ii, 1), vbFromUnicode, 1028), 1, 2), vbUnicode, 1028)
'        Else
'            Exit For
'        End If
'    Next ii
'End If
StrToStr = PUB_StrToStr(Strindex, StrIndex2 * 2)
'end 2022/1/17
End Function

'Add By Cheng 2003/12/16
'取的新字串長度(StrIndex2=byte數)
'Modify by Morgan 2010/1/19 +bolAddSpace:是否補空白,bolAddLeft:空白補左邊
Public Function PUB_StrToStr(ByRef Strindex As String, ByRef StrIndex2 As Single, Optional bolAddSpace As Boolean = False, Optional bolAddLeft As Boolean = False) As String
Dim ii As Long, LLen As Long 'Modified by Lydia 2025/07/24 ii從Integer改成長整數

PUB_StrToStr = ""
'若傳入的字串非空字串
If Strindex <> "" Then
    LLen = 0 'Added by Morgan 2021/4/21
    For ii = 1 To Len(Strindex)
        'Modified by Morgan 2021/4/21 修正Unicode字無法轉成系統的預設字元碼對應頁(會變成?號，長度為1)問題
        'If LenB(StrConv(PUB_StrToStr & Mid(Strindex, ii, 1), vbFromUnicode)) <= StrIndex2 Then
        '    PUB_StrToStr = PUB_StrToStr & StrConv(MidB(StrConv(Mid(Strindex, ii, 1), vbFromUnicode), 1, 2), vbUnicode)
        If LLen + GetTextLength(Mid(Strindex, ii, 1)) <= StrIndex2 Then
            LLen = LLen + GetTextLength(Mid(Strindex, ii, 1))
            PUB_StrToStr = PUB_StrToStr & Mid(Strindex, ii, 1)
        'end 2021/4/21
        Else
            Exit For
        End If
    Next ii
    'Add by Morgan 2010/1/19
    If bolAddSpace Then
      If bolAddLeft Then
         'Modified by Morgan 2021/4/21
         'PUB_StrToStr = String(StrIndex2 - LenB(StrConv(PUB_StrToStr, vbFromUnicode)), " ") & PUB_StrToStr
         PUB_StrToStr = String(StrIndex2 - LLen, " ") & PUB_StrToStr
      Else
         'Modified by Morgan 2021/4/21
         'PUB_StrToStr = PUB_StrToStr & String(StrIndex2 - LenB(StrConv(PUB_StrToStr, vbFromUnicode)), " ")
         PUB_StrToStr = PUB_StrToStr & String(StrIndex2 - LLen, " ")
      End If
   End If
End If
End Function

'add by nick 2004/07/20
Public Function PUB_StrToStr_byVal(ByVal Strindex As String, ByVal StrIndex2 As Single) As String
'Modified by Morgan 2022/3/2 舊程式遇Unicode會有問題
PUB_StrToStr_byVal = PUB_StrToStr(Strindex, StrIndex2)
'Dim ii As Integer
'
'PUB_StrToStr_byVal = ""
''若傳入的字串非空字串
'If Strindex <> "" Then
'    For ii = 1 To Len(Strindex)
'        If LenB(StrConv(PUB_StrToStr_byVal & Mid(Strindex, ii, 1), vbFromUnicode)) <= StrIndex2 Then
'            PUB_StrToStr_byVal = PUB_StrToStr_byVal & StrConv(MidB(StrConv(Mid(Strindex, ii, 1), vbFromUnicode), 1, 2), vbUnicode)
'        Else
'            Exit For
'        End If
'    Next ii
'End If
'end 2022/3/2
End Function

'取得系統類別商標
Public Function GetSystemKindByNickT() As String                'NICK
Dim StrTempGroup As String, i As Integer, strTemp As String
Dim StrTempKind As String, strTemp1 As Variant
bolFNation = False
CheckOC3
strSql = "SELECT ST11,ST03 FROM STAFF WHERE ST01='" & strUserNum & "'"
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
     If Not IsNull(AdoRecordSet3.Fields(0)) Then
         StrTempGroup = AdoRecordSet3.Fields(0)
         'Modified by Lydia 2021/12/15 統一判斷S部門及P11部門人員bolFNation = False => +Or AdoRecordSet3.Fields(1) = "P11"
         If UCase(Left(CheckStr(AdoRecordSet3.Fields(1).Value), 1)) = "S" Or AdoRecordSet3.Fields(1) = "P11" Then
            bolFNation = False
         Else
            bolFNation = True
         End If
         '2009/11/13 ADD BY SONIA 開放94007林景郁可查國外代理人資料
         Select Case strUserNum
            Case "94007"
               bolFNation = True
         End Select
         '2009/11/13 END
     Else
         StrTempGroup = ""
         GetSystemKindByNickT = ""
         Exit Function
     End If
End If
CheckOC3
GetSystemKindByNickT = ""
strTemp = ""


'Add by Morgan 2003/12/31
strSql = "select sk01 from systemkind where (sk02=2 or sk02=6) AND SK01 IN (SELECT SG02 FROM STAFF_GROUP WHERE SG01='" & StrTempGroup & "')"
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount > 0 Then
   GetSystemKindByNickT = AdoRecordSet3.GetString(adClipString, , , ",")
End If
CheckOC3
If GetSystemKindByNickT <> "" Then GetSystemKindByNickT = Left(GetSystemKindByNickT, Len(GetSystemKindByNickT) - 1)

Exit Function
'Add end ------------------

'***********以下無效**************

'Modify By Cheng 2003/06/17
'strSQL = "SELECT SG02 FROM STAFF_GROUP WHERE SG01='" & StrTempGroup & "' ORDER BY SG02"
strSql = "SELECT Distinct SG02 FROM STAFF_GROUP WHERE SG01='" & StrTempGroup & "' ORDER BY SG02"
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
    AdoRecordSet3.MoveFirst
     Do While AdoRecordSet3.EOF = False
        If Not IsNull(AdoRecordSet3.Fields(0)) Then
           If strTemp <> AdoRecordSet3.Fields(0) Then
              strTemp = AdoRecordSet3.Fields(0)
              GetSystemKindByNickT = GetSystemKindByNickT + AdoRecordSet3.Fields(0) + ","
           End If
        End If
        AdoRecordSet3.MoveNext
     Loop
Else
    GetSystemKindByNickT = ""
End If
CheckOC3
strTemp1 = Split(Replace(GetSystemKindByNickT, ",,", ""), ",")
'Add By Cheng 2003/06/17
GetSystemKindByNickT = ""
For i = 0 To UBound(strTemp1)
    strSql = "select sk01 from systemkind where (sk02=2 or sk02=6) AND SK01='" & strTemp1(i) & "' "
    CheckOC3
    AdoRecordSet3.CursorLocation = adUseClient
    AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
    If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
        'Add By Cheng 2003/06/17
        GetSystemKindByNickT = GetSystemKindByNickT & strTemp1(i) & ","
    Else
        If Len(Trim(strTemp1(i))) <> 0 Then
            'Modify By Cheng 2003/06/17
'            GetSystemKindByNickT = Replace(GetSystemKindByNickT, strTemp1(i) & ",", "")
        End If
    End If
    CheckOC3
Next i
'Add By Cheng 2003/06/17
If GetSystemKindByNickT <> "" Then GetSystemKindByNickT = Left(GetSystemKindByNickT, Len(GetSystemKindByNickT) - 1)
End Function

Public Function GetSystemKindByNickP() As String                'NICK
Dim StrTempGroup As String, i As Integer, strTemp As String
Dim StrTempKind As String, strTemp1 As Variant
bolFNation = False
CheckOC3
strSql = "SELECT ST11,ST03 FROM STAFF WHERE ST01='" & strUserNum & "'"
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
     If Not IsNull(AdoRecordSet3.Fields(0)) Then
         StrTempGroup = AdoRecordSet3.Fields(0)
         If UCase(Left(CheckStr(AdoRecordSet3.Fields(1).Value), 1)) = "S" Or AdoRecordSet3.Fields(1) = "P11" Then
            bolFNation = False
         Else
            bolFNation = True
         End If
         '2009/11/13 ADD BY SONIA 開放94007林景郁可查國外代理人資料
         Select Case strUserNum
            'modify by sonia 2021/10/26 王副總專利案說要加開李柏翰99050
            Case "94007", "99050"
               bolFNation = True
         End Select
         '2009/11/13 END
     Else
         StrTempGroup = ""
         GetSystemKindByNickP = ""
         Exit Function
     End If
End If
CheckOC3
GetSystemKindByNickP = ""
strTemp = ""

'Add by Morgan 2003/12/31
strSql = "select sk01 from systemkind where (sk02=1 or sk02=5) AND SK01 IN (SELECT SG02 FROM STAFF_GROUP WHERE SG01='" & StrTempGroup & "')"
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount > 0 Then
   GetSystemKindByNickP = AdoRecordSet3.GetString(adClipString, , , ",")
End If
CheckOC3
If GetSystemKindByNickP <> "" Then GetSystemKindByNickP = Left(GetSystemKindByNickP, Len(GetSystemKindByNickP) - 1)

Exit Function
'Add end ------------------

'***********以下無效**************

'Modify By Cheng 2003/06/17
'strSQL = "SELECT SG02 FROM STAFF_GROUP WHERE SG01='" & StrTempGroup & "' ORDER BY SG02"
strSql = "SELECT Distinct SG02 FROM STAFF_GROUP WHERE SG01='" & StrTempGroup & "' ORDER BY SG02"
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
    AdoRecordSet3.MoveFirst
     Do While AdoRecordSet3.EOF = False
        If Not IsNull(AdoRecordSet3.Fields(0)) Then
           If strTemp <> AdoRecordSet3.Fields(0) Then
              strTemp = AdoRecordSet3.Fields(0)
              GetSystemKindByNickP = GetSystemKindByNickP + AdoRecordSet3.Fields(0) + ","
           End If
        End If
        AdoRecordSet3.MoveNext
     Loop
Else
    GetSystemKindByNickP = ""
End If
CheckOC3
strTemp1 = Split(Replace(GetSystemKindByNickP, ",,", ""), ",")
'Add By Cheng 2003/06/17
GetSystemKindByNickP = ""
For i = 0 To UBound(strTemp1)
    strSql = "select sk01 from systemkind where (sk02=1 or sk02=5) AND SK01='" & strTemp1(i) & "' "
    CheckOC3
    AdoRecordSet3.CursorLocation = adUseClient
    AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
    If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
        GetSystemKindByNickP = GetSystemKindByNickP & strTemp1(i) & ","
    Else
        If Len(Trim(strTemp1(i))) <> 0 Then
            'Modify By Cheng 2003/06/17
'            GetSystemKindByNickP = Replace(GetSystemKindByNickP, strTemp1(i) & " , ", "")
        End If
    End If
    CheckOC3
Next i
If GetSystemKindByNickP <> "" Then GetSystemKindByNickP = Left(GetSystemKindByNickP, Len(GetSystemKindByNickP) - 1)
End Function

'取得系統類別商標、但不含s
Public Function GetSystemKindByNickTnoS() As String                'NICK
Dim StrTempGroup As String, i As Integer, strTemp As String
Dim StrTempKind As String, strTemp1 As Variant
bolFNation = False
CheckOC3
strSql = "SELECT ST11,ST03 FROM STAFF WHERE ST01='" & strUserNum & "'"
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
     If Not IsNull(AdoRecordSet3.Fields(0)) Then
         StrTempGroup = AdoRecordSet3.Fields(0)
         'Modified by Lydia 2021/12/15 統一判斷S部門及P11部門人員bolFNation = False => +Or AdoRecordSet3.Fields(1) = "P11"
         If UCase(Left(StrTempGroup, 1)) = "S" Or AdoRecordSet3.Fields(1) = "P11" Then
            bolFNation = False
         Else
            bolFNation = True
         End If
         '2009/11/13 ADD BY SONIA 開放94007林景郁可查國外代理人資料
         Select Case strUserNum
            Case "94007"
               bolFNation = True
         End Select
         '2009/11/13 END
     Else
         StrTempGroup = ""
         GetSystemKindByNickTnoS = ""
         Exit Function
     End If
End If
CheckOC3
GetSystemKindByNickTnoS = ""
strTemp = ""

'Add by Morgan 2003/12/31
strSql = "select sk01 from systemkind where sk02=2 AND SK01 IN (SELECT SG02 FROM STAFF_GROUP WHERE SG01='" & StrTempGroup & "')"
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount > 0 Then
   GetSystemKindByNickTnoS = AdoRecordSet3.GetString(adClipString, , , ",")
End If
CheckOC3
If GetSystemKindByNickTnoS <> "" Then GetSystemKindByNickTnoS = Left(GetSystemKindByNickTnoS, Len(GetSystemKindByNickTnoS) - 1)

Exit Function
'Add end ------------------

'***********以下無效**************

strSql = "SELECT SG02 FROM STAFF_GROUP WHERE SG01='" & StrTempGroup & "' ORDER BY SG02"
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
    AdoRecordSet3.MoveFirst
     Do While AdoRecordSet3.EOF = False
        If Not IsNull(AdoRecordSet3.Fields(0)) Then
           If strTemp <> AdoRecordSet3.Fields(0) Then
              strTemp = AdoRecordSet3.Fields(0)
              GetSystemKindByNickTnoS = GetSystemKindByNickTnoS + AdoRecordSet3.Fields(0) + ","
           End If
        End If
        AdoRecordSet3.MoveNext
     Loop
Else
    GetSystemKindByNickTnoS = ""
End If
CheckOC3
strTemp1 = Split(Replace(GetSystemKindByNickTnoS, ",,", ""), ",")
For i = 0 To UBound(strTemp1)
    strSql = "select sk01 from systemkind where sk02=2 AND SK01='" & strTemp1(i) & "' "
    CheckOC3
    AdoRecordSet3.CursorLocation = adUseClient
    AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
    If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
    Else
        If Len(Trim(strTemp1(i))) <> 0 Then
            GetSystemKindByNickTnoS = Replace(GetSystemKindByNickTnoS, strTemp1(i) & ",", "")
        End If
    End If
    CheckOC3
Next i
End Function

'取得系統類別專利、但不含s
'Public Function GetSystemKindByNickPnoS() As String                'NICK
'Dim StrTempGroup As String, i As Integer, strTemp As String
'Dim StrTempKind As String, strTemp1 As Variant
'bolFNation = False
'CheckOC3
'strSQL = "SELECT ST11ST03 FROM STAFF WHERE ST01='" & strUserNum & "'"
'AdoRecordSet3.CursorLocation = adUseClient
'AdoRecordSet3.Open strSQL, cnnConnection, adOpenStatic, adLockReadOnly
'If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
'     If Not IsNull(AdoRecordSet3.Fields(0)) Then
'         StrTempGroup = AdoRecordSet3.Fields(0)
'         If UCase(Left(CheckStr(AdoRecordSet3.Fields(1).Value), 1)) = "S" Then
'            bolFNation = False
'         Else
'            bolFNation = True
'         End If
'     Else
'         StrTempGroup = ""
'         GetSystemKindByNickPnoS = ""
'         Exit Function
'     End If
'End If
'CheckOC3
'GetSystemKindByNickPnoS = ""
'strTemp = ""
'strSQL = "SELECT SG02 FROM STAFF_GROUP WHERE SG01='" & StrTempGroup & "' ORDER BY SG02"
'AdoRecordSet3.CursorLocation = adUseClient
'AdoRecordSet3.Open strSQL, cnnConnection, adOpenStatic, adLockReadOnly
'If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
 '   AdoRecordSet3.MoveFirst
 '    Do While AdoRecordSet3.EOF = False
'        If Not IsNull(AdoRecordSet3.Fields(0)) Then
'           If strTemp <> AdoRecordSet3.Fields(0) Then
'              strTemp = AdoRecordSet3.Fields(0)
 '             GetSystemKindByNickPnoS = GetSystemKindByNickPnoS + AdoRecordSet3.Fields(0) + ","
'           End If
'        End If
'        AdoRecordSet3.MoveNext
'     Loop
'Else
'    GetSystemKindByNickPnoS = ""
'End If
'CheckOC3
'strTemp1 = Split(Replace(GetSystemKindByNickPnoS, ",,", ""), ",")
'For i = 0 To UBound(strTemp1)
'    strSQL = "select sk01 from systemkind where sk02=2 AND SK01='" & strTemp1(i) & "' "
'    CheckOC3
'    AdoRecordSet3.CursorLocation = adUseClient
'    AdoRecordSet3.Open strSQL, cnnConnection, adOpenStatic, adLockReadOnly
'    If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
'    Else
'        If Len(Trim(strTemp1(i))) <> 0 Then
'            GetSystemKindByNickPnoS = Replace(GetSystemKindByNickPnoS, strTemp1(i) & ",", "")
'        End If
'    End If
'    CheckOC3
'Next i
'End Function

'暫停
'Remove by Morgan 2011/8/9 改用API
'Public Sub Sleep(Strindex As Integer)
'Dim TInt1 As Long, TInt2 As Long
'TInt1 = Timer
'TInt2 = TInt1
'Do While TInt2 - TInt1 < Strindex
'    TInt2 = Timer
'Loop
'End Sub

Public Function GetPerformanceByNickPE06(StrIndexY1 As Long, StrIndexY2 As Long, StrIndexM As String, StrIndexS As String) As Long
'StrIndexY    目標年月
'StrIndexM    系統類別
'StrIndexS    員工代號
Dim strSQL1 As String

CheckOC3
strSQL1 = " AND ("
'strTemp1 = Split(Replace(StrIndexM, ",,", ""), ",")
'For i = 0 To UBound(strTemp1)
'    strSQL1 = strSQL1 + " PE02='" & strTemp1(i) & "' "
'    If i <> UBound(strTemp1) Then
'        strSQL1 = strSQL1 + " OR "
'    End If
'Next i
strSQL1 = strSQL1 + " pe02 in ('" & Replace(Replace(StrIndexM, ",,", ""), ",", "','") & "') "
strSQL1 = strSQL1 + ") "
strSql = "SELECT SUM(decode(PE06,NULL,0,PE06)) FROM PERFORMANCE WHERE PE01='" & StrIndexS & "' AND PE03>=" & StrIndexY1 & " AND PE03<=" & StrIndexY2 & " " & strSQL1
CheckOC3
With AdoRecordSet3
    .CursorLocation = adUseClient
    .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
    If .RecordCount <> 0 And .RecordCount > 0 Then
        GetPerformanceByNickPE06 = Val(CheckStr(.Fields(0)))
    Else
        GetPerformanceByNickPE06 = 0
    End If
End With
CheckOC3

End Function
'Add By Cheng 2002/04/10
Public Function GetPerformanceByNickPE06_1(StrIndexY1 As Long, StrIndexY2 As Long) As Long
'StrIndexY    目標年月
CheckOC3
strSql = "SELECT SUM(decode(PE06,NULL,0,PE06)) FROM PERFORMANCE,STAFF WHERE PE01=ST01(+) AND PE03>=" & StrIndexY1 & " AND PE03<=" & StrIndexY2 & " AND PE02>='T' AND PE02<'U' AND ST05>='91' AND ST05<='99'"
CheckOC3
With AdoRecordSet3
    .CursorLocation = adUseClient
    .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
    If .RecordCount <> 0 And .RecordCount > 0 Then
        GetPerformanceByNickPE06_1 = Val(CheckStr(.Fields(0)))
    Else
        GetPerformanceByNickPE06_1 = 0
    End If
End With
CheckOC3

End Function

Public Function GetPerformanceByNick(StrIndexY1 As Long, StrIndexY2 As Long, StrIndexM As String, StrIndexS As String) As Long
'StrIndexY    目標年月
'StrIndexM    系統類別
'StrIndexS    員工代號
Dim strSQL1 As String

CheckOC3
strSQL1 = " AND ("
'strTemp1 = Split(Replace(StrIndexM, ",,", ""), ",")
'For i = 0 To UBound(strTemp1)
'    strSQL1 = strSQL1 + " PE02='" & strTemp1(i) & "' "
'    If i <> UBound(strTemp1) Then
'        strSQL1 = strSQL1 + " OR "
'    End If
'Next i
strSQL1 = strSQL1 & " pe02 in ('" & Replace(Replace(StrIndexM, ",,", ""), ",", "','") & "')"
strSQL1 = strSQL1 + " ) "
If StrIndexY2 = Val(Format(ChangeWStringToWDateString(GetTodayDate), "YYYYMM")) Or StrIndexY2 = Val(Format(ChangeWStringToWDateString(GetTodayDate), "MM")) Then
    strSql = "SELECT SUM(PE07) FROM PERFORMANCE WHERE PE01='" & StrIndexS & "' AND PE03>=" & StrIndexY1 & " AND PE03<=" & StrIndexY2 & " " & strSQL1
    With AdoRecordSet3
        .CursorLocation = adUseClient
        .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
        If .RecordCount <> 0 And .RecordCount > 0 Then
            GetPerformanceByNick = Val(CheckStr(.Fields(0)))
        Else
            GetPerformanceByNick = 0
        End If
    End With
    CheckOC3
    strSql = "SELECT SUM(PE07) FROM PERFORMANCE WHERE PE01='" & StrIndexS & "' AND PE03=" & StrIndexY2 & " " & strSQL1
    With AdoRecordSet3
        .CursorLocation = adUseClient
        .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
        If .RecordCount <> 0 And .RecordCount > 0 Then
            GetPerformanceByNick = GetPerformanceByNick - (Val(CheckStr(.Fields(0))) * (30 - Val(Format(ChangeWStringToWDateString(GetTodayDate), "DD"))) / 30)
        Else
            GetPerformanceByNick = 0
        End If
    End With
    CheckOC3
Else
    strSql = "SELECT SUM(decode(PE07,NULL,0,PE07)) FROM PERFORMANCE WHERE PE01='" & StrIndexS & "' AND PE03>=" & StrIndexY1 & " AND PE03<=" & StrIndexY2 & " " & strSQL1
    CheckOC3
    With AdoRecordSet3
        .CursorLocation = adUseClient
        .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
        If .RecordCount <> 0 And .RecordCount > 0 Then
            GetPerformanceByNick = Val(CheckStr(.Fields(0)))
        Else
            GetPerformanceByNick = 0
        End If
    End With
    CheckOC3
End If
End Function
'Add By Cheng 2002/02/20
Public Function GetPerformanceByNick_1(StrIndexY1 As Long, StrIndexY2 As Long, StrIndexM As String, StrIndexS As String) As Long
'StrIndexY    目標年月
'StrIndexM    系統類別
'StrIndexS    部門代號
Dim strSQL1 As String
Dim strTemp1
Dim i As Integer

CheckOC3
strSQL1 = " AND ("
strTemp1 = Split(Replace(StrIndexM, ",,", ""), ",")
For i = 0 To UBound(strTemp1)
    strSQL1 = strSQL1 + " PE02='" & strTemp1(i) & "' "
    If i <> UBound(strTemp1) Then
        strSQL1 = strSQL1 + " OR "
    End If
Next i
strSQL1 = strSQL1 + " ) "
'Modify By Cheng 2002/11/27
'strSQL = "SELECT SUM(decode(PE05,NULL,0,PE05)) FROM PERFORMANCE,STAFF WHERE PE01=ST01 AND ST03='" & StrIndexS & "' AND PE03>=" & StrIndexY1 & " AND PE03<=" & StrIndexY2 & " " & strSQL1
strSql = "SELECT SUM(decode(PE05,NULL,0,PE05)) FROM PERFORMANCE,STAFF WHERE PE01=ST01 AND ST15='" & StrIndexS & "' AND PE03>=" & StrIndexY1 & " AND PE03<=" & StrIndexY2 & " " & strSQL1
CheckOC3
With AdoRecordSet3
    .CursorLocation = adUseClient
    .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
    If .RecordCount <> 0 And .RecordCount > 0 Then
        GetPerformanceByNick_1 = Val(CheckStr(.Fields(0)))
    Else
        GetPerformanceByNick_1 = 0
    End If
End With
CheckOC3
End Function

'Add By Cheng 2002/04/10
Public Function GetPerformanceByNick_2(StrIndexY1 As Long, StrIndexY2 As Long, StrIndexM As String, StrIndexS As String) As Long
'StrIndexY    目標年月
'StrIndexM    系統類別
'StrIndexS    部門代號
Dim strSQL1 As String
Dim strTemp1
Dim i As Integer

CheckOC3
strSQL1 = " AND ("
strTemp1 = Split(Replace(StrIndexM, ",,", ""), ",")
For i = 0 To UBound(strTemp1)
    strSQL1 = strSQL1 + " PE02='" & strTemp1(i) & "' "
    If i <> UBound(strTemp1) Then
        strSQL1 = strSQL1 + " OR "
    End If
Next i
strSQL1 = strSQL1 + " ) "
'Modify By Cheng 2002/11/27
'strSQL = "SELECT SUM(decode(PE05,NULL,0,PE05)) FROM PERFORMANCE,STAFF WHERE PE01=ST01 AND ST03 like'" & StrIndexS & "%' AND PE03>=" & StrIndexY1 & " AND PE03<=" & StrIndexY2 & " " & strSQL1
strSql = "SELECT SUM(decode(PE05,NULL,0,PE05)) FROM PERFORMANCE,STAFF WHERE PE01=ST01 AND ST15 like'" & StrIndexS & "%' AND PE03>=" & StrIndexY1 & " AND PE03<=" & StrIndexY2 & " " & strSQL1
CheckOC3
With AdoRecordSet3
    .CursorLocation = adUseClient
    .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
    If .RecordCount <> 0 And .RecordCount > 0 Then
        GetPerformanceByNick_2 = Val(CheckStr(.Fields(0)))
    Else
        GetPerformanceByNick_2 = 0
    End If
End With
CheckOC3
End Function

'Modify By Sindy 2020/8/13 + Optional ByRef strCF10 As String = ""
Public Function GetCaseFeeByNick(Strindex As String, StrIndex1 As String, StrIndex2 As String, _
   Optional ByRef strCF10 As String = "") As Integer    '取得標準價
CheckOC3
strSql = "SELECT CF13,CF10 FROM CASEFEE WHERE CF01='" & Strindex & "' AND CF02='" & StrIndex1 & "' AND CF03='" & StrIndex2 & "' "
With AdoRecordSet3
    .CursorLocation = adUseClient
    .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
    If .RecordCount <> 0 And .RecordCount > 0 Then
        GetCaseFeeByNick = Val(CheckStr(.Fields(0)))
        strCF10 = "" & .Fields("CF10") 'Modify By Sindy 2020/8/13
    Else
        GetCaseFeeByNick = 0
        strCF10 = "" 'Modify By Sindy 2020/8/13
    End If
End With
CheckOC3
End Function

'補0
'適用  申請人代號或代理人代號
Public Function GetNewFagent(Strindex As String) As String
Dim ll As Integer
For ll = Len(Strindex) To 8
   Strindex = Strindex & "0"
Next ll
GetNewFagent = Strindex
End Function

'補0
'適用  發明人代號
Public Function GetNewFagent2(Strindex As String) As String
Dim ll As Integer
For ll = Len(Strindex) To 9
   Strindex = Strindex & "0"
Next ll
GetNewFagent2 = Strindex
End Function

'判斷range 前面是否錯誤
'前小後大
Public Function RunNick(Strindex As Variant, StrIndex2 As Variant) As Boolean
Dim TmpInttmp As Integer
Dim s As Integer

For TmpInttmp = 1 To Len(Strindex)
   If InStr(1, "0123456789", Mid(Strindex, TmpInttmp, 1)) = 0 Then
      '字串
      If Strindex <= StrIndex2 Then
         RunNick = False
         Exit Function
      Else
         RunNick = True
         s = MsgBox("Range 前面必須小於後面!!", , "USER 輸入錯誤")
         Exit Function
      End If
   End If
Next TmpInttmp
For TmpInttmp = 1 To Len(StrIndex2)
   If InStr(1, "0123456789", Mid(StrIndex2, TmpInttmp, 1)) = 0 Then
      '字串
      If Strindex <= StrIndex2 Then
         RunNick = False
         Exit Function
      Else
         RunNick = True
         s = MsgBox("Range 前面必須小於後面!!", , "USER 輸入錯誤")
         Exit Function
      End If
   End If
Next TmpInttmp
'數字
If Val(Strindex) <= Val(StrIndex2) Then
   RunNick = False
   Exit Function
Else
   RunNick = True
End If
s = MsgBox("Range 前面必須小於後面!!", , "USER 輸入錯誤")
End Function

'判斷range 前面是否錯誤
'前小後大
Public Function RunNick2(Strindex As Variant, StrIndex2 As Variant) As Boolean
Dim TmpInttmp As Integer
Dim s As Integer
For TmpInttmp = 1 To Len(Strindex)
   If InStr(1, "0123456789", Mid(Strindex, TmpInttmp, 1)) = 0 Then
      '字串
      If Strindex <= StrIndex2 Then
         RunNick2 = False
         Exit Function
      Else
         RunNick2 = True
         s = MsgBox("日期前面必須小於後面!!", , "USER 輸入錯誤")
         Exit Function
      End If
   End If
Next TmpInttmp
For TmpInttmp = 1 To Len(StrIndex2)
   If InStr(1, "0123456789", Mid(StrIndex2, TmpInttmp, 1)) = 0 Then
      '字串
      If Strindex <= StrIndex2 Then
         RunNick2 = False
         Exit Function
      Else
         RunNick2 = True
         s = MsgBox("日期前面必須小於後面!!", , "USER 輸入錯誤")
         Exit Function
      End If
   End If
Next TmpInttmp
'數字
If Val(Strindex) <= Val(StrIndex2) Then
   RunNick2 = False
   Exit Function
Else
   RunNick2 = True
End If
s = MsgBox("日期前面必須小於後面!!", , "USER 輸入錯誤")
End Function

'取得報表類別抬頭
Public Function GetTitleNick() As String
Select Case intPCaseKind
Case 1
     Select Case intPWhere
     Case 0
          GetTitleNick = "內專"
     Case 1
          GetTitleNick = "CFP"
     Case 2
          GetTitleNick = "FCP"
     Case Else
          GetTitleNick = ""
     End Select
Case 2
     Select Case intPWhere
     Case 0
          GetTitleNick = "內商"
     Case 1, 2
          GetTitleNick = "外商"
     Case Else
     End Select
Case 3
     Select Case intPWhere
     Case 0
          GetTitleNick = "內法"
     Case 1, 2
          GetTitleNick = "投資法務"
     Case Else
     End Select
Case 4
     GetTitleNick = "顧問"
End Select
End Function

Sub ShowNoData()
    Dim s As Integer
    
    s = MsgBox("資料庫中搜尋不到符合資料!!", , "沒有資料")
End Sub

Sub ShowPrintOk()
    Dim s As Integer
   
   s = MsgBox("列印完成!!", , "列印成功")
End Sub

'*********************
'   傳出列印點數
'   傳入寬度
'傳入所要印字串
'**********************
Public Function GetPrPosX(Strindex As Integer, StrIndex1 As String) As Integer
   GetPrPosX = Strindex / 2 - Printer.TextWidth(StrIndex1) / 2
End Function


Public Function SqlDateT(Strindex As String) As String
'Modify by Morgan 2011/2/25 修正百年排序問題(改呼叫db function sqldatet)
'SqlDateT = "DECODE(" & Strindex & ",NULL,'',DECODE(LENGTH(" & Strindex & "),6,SUBSTR(" & Strindex & ",1,2)||'/'||SUBSTR(" & Strindex & ",3,2)||'/'||SUBSTR(" & Strindex & ",5,2),SUBSTR(" & Strindex & ",1,3)||'/'||SUBSTR(" & Strindex & ",4,2)||'/'||SUBSTR(" & Strindex & ",6,2))) "
SqlDateT = "substrb(sqldatet(" & Strindex & "),1,9) "
End Function

'****************************
'組合系統類別字串
' IN
'    Strindex      USER 可使用之全部系統類別
'    若Strindex 為空字串   則為全部
'    Intindex      系統種類(1-->專  2-->商  3-->法  4-->顧  5-->服)
' OUT
'    SQLGrpStr     該系統種類USER 可使用之系統類別
'********************************
Public Function SQLGrpStr(Strindex As String, intIndex As Integer) As String
If intIndex > 5 Then
   SQLGrpStr = ""
   Exit Function
End If
Dim SQLSTRING As String
If Len(Trim(Strindex)) = 0 Then
    Select Case Val(intIndex)
    Case 1, 2, 3, 4
        SQLSTRING = "select sk01 from systemkind where sk02=" & intIndex & " "
    Case 5
        SQLSTRING = "select sk01 from systemkind where sk02>=" & intIndex & " "
    Case Else
    End Select
Else
    Select Case Val(intIndex)
    Case 1, 2, 3, 4
       SQLSTRING = "SELECT SK01 FROM SYSTEMKIND WHERE SK02=" & intIndex & " AND SK01 IN (" & GetAddStr(Strindex) & ")"
    Case 5
       SQLSTRING = "SELECT SK01 FROM SYSTEMKIND WHERE SK02>=" & intIndex & " AND SK01 IN (" & GetAddStr(Strindex) & ")"
    Case Else
    End Select
End If
CheckOC3
With AdoRecordSet3
   .CursorLocation = adUseClient
   .Open SQLSTRING, cnnConnection, adOpenStatic, adLockReadOnly
   If .RecordCount <> 0 Then
      .MoveFirst
      SQLGrpStr = ""
      Do While .EOF = False
         If Len(Trim(CheckStr(.Fields(0)))) <> 0 Then
            SQLGrpStr = SQLGrpStr & "'" & ChgSQL(CheckStr(.Fields(0))) & "'"
         End If
         .MoveNext
         If .EOF = False Then
            SQLGrpStr = SQLGrpStr & ","
         End If
      Loop
   Else
      SQLGrpStr = "' '"
      Exit Function
   End If
End With
SQLGrpStr = SQLGrpStr & ",' '"
End Function

'****************************
'      陣列字串加單引號
'  IN
'     Strindex    未加單引號之陣列字串
'  OUT
'     GetAddStr   加單引號之陣列字串
'*****************************
Public Function GetAddStr(Strindex As String) As String
Dim StrSeekTemp As Variant, StrTempNewStr As String
Dim i As Integer

StrSeekTemp = Split(Strindex, ",")
StrTempNewStr = ""
For i = 0 To UBound(StrSeekTemp)
   If Len(Trim(StrSeekTemp(i))) <> 0 Then
      StrTempNewStr = StrTempNewStr & "'" & StrSeekTemp(i) & "'"
      If i <> UBound(StrSeekTemp) Then
         StrTempNewStr = StrTempNewStr & ","
      End If
   End If
Next i
If Right(StrTempNewStr, 1) = "," Then StrTempNewStr = Left(StrTempNewStr, Len(StrTempNewStr) - 1)
If Left(StrTempNewStr, 1) = "," Then StrTempNewStr = Right(StrTempNewStr, Len(StrTempNewStr) - 1)
GetAddStr = StrTempNewStr
End Function

'***************************
'    去頭尾,
'  IN
'   STRINDEX
'  OUT
'   CHGNEWSTR
'**************************
Public Function ChgNewStr(Strindex As String) As String
Dim StrSeekTemp As Variant, StrTempNewStr As String
Dim i As Integer

StrSeekTemp = Split(Strindex, ",")
StrTempNewStr = ""
For i = 0 To UBound(StrSeekTemp)
   If Len(Trim(StrSeekTemp(i))) <> 0 Then
      StrTempNewStr = StrTempNewStr & StrSeekTemp(i)
      If i <> UBound(StrSeekTemp) Then
         StrTempNewStr = StrTempNewStr & ","
      End If
   End If
Next i
If Right(StrTempNewStr, 1) = "," Then StrTempNewStr = Left(StrTempNewStr, Len(StrTempNewStr) - 1)
If Left(StrTempNewStr, 1) = "," Then StrTempNewStr = Right(StrTempNewStr, Len(StrTempNewStr) - 1)
ChgNewStr = StrTempNewStr
End Function

'**************
' 秀錯誤的工作天
'****************
Sub ShowDateErr()
    Dim s As Integer
    
    s = MsgBox("輸入之日期不是工作天!!", , "日期錯誤")
End Sub

Sub ShowDateRanErr()
    Dim s As Integer
    'Modify By Cheng 2003/05/06
'   s = MsgBox("日期順序錯誤")
   s = MsgBox("日期欄位錯誤或漏填!!!")
End Sub

'**********************************************************************************************************
'*      檢查是否符合規則   (承辦人, 繪圖人員)                                                             *
'**********************************************************************************************************
'*  TYPE  *   DESCRIPTION      *  DATE1                        *    DATE2                                 *
'**********************************************************************************************************
'*  1     *  輸入齊備日時      *  [收文日]   -   3 個工作天 <= *    {齊備日}                              *
'*  2     *  輸入完稿日時      *  [齊備日]                  <= *    {完稿日}       <= 系統日 + 3 個工作天 *
'*  3     *  輸入會稿日時      *  [完稿日]                  <= *    {會稿日}       <= 系統日 + 3 個工作天 *
'*  4     *  輸入會稿完成日時  *  [會稿日]                  <= *    {會稿完成日}   <= 系統日 + 3 個工作天 *
'*  5     *  輸入發文日時      *  [完稿完成日]              <= *    {發文日}       <= 系統日              *
'**********************************************************************************************************
'*   input                                                                                                *
'*        StrIndex1      date1[]                                                                          *
'*        StrIndex2      date2{}                                                                          *
'*        StrIndex3      type                                                                             *
'*   output   符合規則 = true  , 不符合規則 = false              日期為皆為西元 ,但 INPUT 為民國          *
'**********************************************************************************************************
Public Function ChkDateRanPro(StrIndex1 As String, StrIndex2 As String, StrIndex3 As Integer) As Boolean
Dim s As Integer

If Len(StrIndex1) = 0 Or Len(StrIndex2) = 0 Then
   Exit Function
End If
StrIndex1 = ChangeTStringToWString(StrIndex1)
StrIndex2 = ChangeTStringToWString(StrIndex2)
Select Case StrIndex3
Case 1
     'Modified by Morgan 2022/6/14 當天都不算--王副總
     'If CompWorkDay(3, StrIndex1, 1) <= StrIndex2 Then
     If CompWorkDay(3, CompDate(2, -1, StrIndex1), 1) <= StrIndex2 Then
     'end 2022/6/14
         ChkDateRanPro = True
     Else
         ChkDateRanPro = False
     End If
Case 2, 3, 4
     'Modified by Morgan 2022/6/14 當天都不算--王副總
     'If StrIndex1 <= StrIndex2 And StrIndex2 <= CompWorkDay(3, GetTodayDate) Then
     If StrIndex1 <= StrIndex2 And StrIndex2 <= CompWorkDay(3, CompDate(2, 1, strSrvDate(1))) Then
     'end 2022/6/14
         ChkDateRanPro = True
     Else
         ChkDateRanPro = False
     End If
Case 5
     If StrIndex1 <= StrIndex2 And StrIndex2 <= GetTodayDate Then
         ChkDateRanPro = True
     Else
         ChkDateRanPro = False
     End If
Case Else
End Select
If ChkDateRanPro = False Then
    Select Case StrIndex3
    Case 1
         s = MsgBox("齊備日須 >= 收文日 - 3 工作天", , "日期錯誤!!")
    Case 2
         s = MsgBox("完稿日須 >= 齊備日, 且 <= 系統日 + 3 工作天", , "日期錯誤!!")
    Case 3
         s = MsgBox("會稿日須 >= 完稿日, 且 <= 系統日 + 3 工作天", , "日期錯誤!!")
    Case 4
        'Modify By Cheng 2003/05/13
'         s = MsgBox("會稿完成日須 <= 會稿日, 且 <= 系統日 + 3 工作天", , "日期錯誤!!")
         s = MsgBox("會稿完成日須 >= 會稿日, 且 <= 系統日 + 3 工作天", , "日期錯誤!!")
    Case 5
         s = MsgBox("發文日須 >= 會稿完成日, 且 <= 系統日", , "日期錯誤!!")
    Case Else
    End Select
End If
End Function

'************
'    組 加總的 SQL 字串
'************
Public Function SQLSum(Strindex As String) As String
SQLSum = " SUM(DECODE(" & Strindex & ",NULL,0," & Strindex & "))"
End Function
'2位小數點
Public Function SQLSum2(Strindex As String) As String
SQLSum2 = " ROUND(SUM(DECODE(" & Strindex & ",0,0,NULL,0," & Strindex & ")),2) "
End Function


'*************
'   組 客戶或代理人串基本檔的SQL 語法
'    STRINDEX  基本檔
'    STRINDEX2 客戶或代理人檔(FA  OR CU)
'   範例
'   SQLNEWFAG("PA26","FA")
'   結果
'   SUBSTR(PA26,1,8)=FA01(+) AND DECODE(SUBSTR(PA26,9,1),NULL,'0',SUBSTR(PA26,9,1))=FA02(+)
'*************
Public Function SQLNewFag(ByVal Strindex As String, ByVal StrIndex2 As String) As String
SQLNewFag = " SUBSTR(" & Strindex & ",1,8)=" & StrIndex2 & "01(+) AND DECODE(SUBSTR(" & Strindex & ",9,1),NULL,'0',SUBSTR(" & Strindex & ",9,1))=" & StrIndex2 & "02(+) "
End Function

'*************
'   組 客戶或代理人串基本檔的SQL 語法( 相反)
'    STRINDEX  基本檔
'    STRINDEX2 客戶或代理人檔(FA  OR CU)
'   範例
'   SQLNEWFAG("PA26","FA")
'   結果
'   SUBSTR(PA26,1,8)=FA01(+) AND DECODE(SUBSTR(PA26,9,1),NULL,'0',SUBSTR(PA26,9,1))=FA02(+)
'*************
Public Function SQLNewFag2(ByVal Strindex As String, ByVal StrIndex2 As String) As String
SQLNewFag2 = " " & Strindex & "=" & StrIndex2 & "01||" & StrIndex2 & "02 "
End Function

'******************
'   將一位數字變成兩位
'*******************
Public Function ChgNumByNick(Strindex As String) As String
ChgNumByNick = Right("0000000" & Trim(Strindex), 2)
End Function

Public Function ChkWork(Strindex As String) As Boolean
If ChkWorkDay(Strindex) = False Then
   ShowDateErr
   ChkWork = False
Else
   ChkWork = True
End If
End Function

''iSitu 0:+  1:-
'Public Function CompWorkDay(ByVal iAddDay As Integer, strDay As String, Optional iSitu As Integer = 0) As String
'   Dim i As Integer, stSQL As String
'   Dim rsTemp1 As ADODB.Recordset
'
'On Error GoTo ErrHand
'   Select Case iSitu
'      Case 0
'         'edit by nickc 2005/09/02 因為提申日在算時，要往後推 40 個工作天，所以不足，改為 3 個月
'         'strExc(0) = "SELECT WD01 FROM WORKDAY WHERE WD01>=" & strDay & _
'            " AND wd01<=" & ChangeWDateStringToWString(DateAdd("m", 1, Format(strDay, "####/##/##"))) & " ORDER BY WD01"
'         stSQL = "SELECT WD01 FROM WORKDAY WHERE WD01>=" & strDay & _
'            " AND wd01<=" & ChangeWDateStringToWString(DateAdd("m", 3, Format(strDay, "####/##/##"))) & " ORDER BY WD01"
'
'      Case 1
'         'edit by nickc 2007/12/25 因為抓太多會掛，所以專用期20年，僅要抓 21 年 ，但是還是有問題，因此秀玲說抓三年
'         'stSQL = "SELECT WD01 FROM WORKDAY WHERE WD01<=" & strDay & " ORDER BY WD01 DESC"
'         stSQL = "SELECT WD01 FROM WORKDAY WHERE WD01<=" & strDay & _
'            " AND wd01>=" & ChangeWDateStringToWString(DateAdd("yyyy", -3, Format(strDay, "####/##/##"))) & " ORDER BY WD01 DESC"
'   End Select
'   intI = 1
'   Set rsTemp1 = ClsLawReadRstMsg(intI, stSQL)
'   If intI = 1 Then
'        'Add By Cheng 2003/01/03
'        '若有設定工作天數
'        If iAddDay > 0 Then
'            rsTemp1.Move iAddDay - 1
'        End If
'      CompWorkDay = rsTemp1.Fields(0)
'   '92.7.4 add by sonia
'   Else
'      CompWorkDay = strDay
'   '92.7.4 END
'   End If
'   Set rsTemp1 = Nothing
'   Exit Function
'ErrHand:
'   CompWorkDay = ""
'   MsgBox "無此工作天記錄 !", vbCritical
'   Set rsTemp1 = Nothing
'End Function
'iSitu 0:+  1:-

'2011/9/16 因AutoBatchDay要共用basQuery而異動該函數
'Modified by Lydia 2017/09/08 傳入星期X,抓特定星期X
'Modified by Morgan 2024/11/1 北所颱風假也不算工作天 +WD02 is null
Public Function CompWorkDay(ByVal iAddDay As Integer, strDay As String, Optional iSitu As Integer = 0, Optional strChiWeek As String) As String
 Dim i As Integer
 Dim intI As Integer
 'Modified by Lydia 2019/07/30 更換變數名稱
 'Dim strExc(0) As String
 'Dim RsTemp As New ADODB.Recordset
 Dim strMid As String
 Dim rsAD As New ADODB.Recordset
 'end 2019/07/30
 'Add by Morgan 2010/11/5
 Dim stDateBoundry As String
 
On Error GoTo Err

   If strDay = "" Then Exit Function 'Add By Sindy 2015/12/29
   
   Select Case iSitu
      Case 0 'Memo by Lydia 2015/07/23 工作日 + ？天 (往後推)
         'Add by Morgan 2010/11/5
         '改上下限抓2倍天數,固定3個月有可能不夠
         'stDateBoundry =  ChangeWDateStringToWString(DateAdd("m", 12, Format(strDay, "####/##/##")))
         stDateBoundry = CompDate(2, 2 * iAddDay + 30, strDay)
         
         'Modified by Lydia 2017/09/08 傳入星期X,抓特定星期X
         'strExc(0) = "SELECT WD01 FROM WORKDAY WHERE WD01>=" & strDay & _
            " AND wd01<=" & stDateBoundry & " ORDER BY WD01"
         'Modified by Lydia 2019/07/30 更換變數名稱strMid
         'Modified by Morgan 2024/11/1 北所颱風假也不算工作天 +WD02 is null
         strMid = "SELECT WD01 FROM WORKDAY WHERE WD02 is null and WD01>=" & strDay & _
            IIf(strChiWeek <> "", "and to_char(to_date(wd01,'yyyy-mm-dd'),'day')='" & strChiWeek & "'", "") & _
            " AND wd01<=" & stDateBoundry & " ORDER BY WD01"
      Case 1  'Memo by Lydia 2015/07/23 工作日 - ？天　(往前推)
         'Add by Morgan 2010/11/5
         '改上下限抓2倍天數,固定3個月有可能不夠
         'stDateBoundry =  ChangeWDateStringToWString(DateAdd("m", 12, Format(strDay, "####/##/##")))
         'Modify by Amy 2025/02/03 雅雯進分案作業畫面預帶收文日-起日變空,因抓TransDate(CompWorkDay(-7, strSrvDate(1), 1), 1),rsAD.Move 6資料不夠會跑至Err
         'stDateBoundry = CompDate(2, -1 * 2 * iAddDay - 30, strDay)
         stDateBoundry = CompDate(2, -1 * 2 * iAddDay - 60, strDay)
         'Modified by Lydia 2017/09/08 傳入星期X,抓特定星期X
         'strExc(0) = "SELECT WD01 FROM WORKDAY WHERE WD01<=" & strDay & " AND wd01>=" & stDateBoundry & " ORDER BY WD01 DESC"
         'Modified by Lydia 2019/07/30 更換變數名稱strMid
         'Modified by Morgan 2024/11/1 北所颱風假也不算工作天 +WD02 is null
         strMid = "SELECT WD01 FROM WORKDAY WHERE WD02 is null and  WD01<=" & strDay & _
         IIf(strChiWeek <> "", "and to_char(to_date(wd01,'yyyy-mm-dd'),'day')='" & strChiWeek & "'", "") & _
         " AND wd01>=" & stDateBoundry & " ORDER BY WD01 DESC"
   End Select
   intI = 1
    'Modified by Lydia 2019/07/30 更換變數名稱rsAd,strMid
   Set rsAD = New ADODB.Recordset
   rsAD.CursorLocation = adUseClient
   rsAD.Open strMid, cnnConnection, adOpenStatic, adLockReadOnly
   'If rsad.RecordCount <> 0 Then
   If Not rsAD.EOF And Not rsAD.BOF Then
        '若有設定工作天數
        'modify by sonia 2018/8/17 改用絕對值Abs,否則往前推工作天的會錯
        If Abs(iAddDay) > 0 Then
            rsAD.Move Abs(iAddDay) - 1
        End If
      CompWorkDay = rsAD.Fields(0)
   Else
      CompWorkDay = strDay
   End If
   Set rsAD = Nothing 'Added by Lydia 2019/07/30
   
   Exit Function
Err:
   CompWorkDay = ""
   'Modify By Sindy 2011/9/16
   If strUserNum = "" Then
      WLog "CompWorkDay ,無此記錄，請重新輸入 !"
   Else
      MsgBox "無此記錄，請重新輸入 !", vbCritical
   End If
End Function

'Modify By Sindy 2012/8/15 + , Optional strUserID As String = "", Optional bolTyphoonVact As Boolean = False
'Modify By Sindy 2018/8/27 + , Optional strST06 As String = ""
Public Function ChkWorkDay(ByVal strTemp As String, Optional strUserId As String = "", _
   Optional bolTyphoonVact As Boolean = False, Optional strST06 As String = "") As Boolean
Dim rsTemp1 As New ADODB.Recordset
'Dim strST06 As String
'Added by Lydia 2019/07/30
Dim strA01 As String, intA As Integer

   ChkWorkDay = False
   'Modified by Lydia 2019/07/30 變更變數
   'strExc(0) = "SELECT * FROM WORKDAY WHERE WD01=" & strTemp
   'intI = 1
   'Set rsTemp1 = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
   'If intI = 1 Then
   strA01 = "SELECT * FROM WORKDAY WHERE WD01=" & strTemp
   intA = 1
   Set rsTemp1 = ClsLawReadRstMsg(intA, strA01) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
   If intA = 1 Then
   'end 2019/07/30
      ChkWorkDay = True
      'Add By Sindy 2012/8/15 檢查是否有颱風假
      If bolTyphoonVact = True Then
         'Modify By Sindy 2018/8/27
         'strST06 = PUB_GetST06(strUserId)
         If strST06 = "" Then strST06 = PUB_GetST06(strUserId)
         '2018/8/27 END
         If strST06 = "2" Then
            If "" & rsTemp1.Fields("wd03") = "Y" Then
               ChkWorkDay = False
            End If
         ElseIf strST06 = "3" Then
            If "" & rsTemp1.Fields("wd04") = "Y" Then
               ChkWorkDay = False
            End If
         ElseIf strST06 = "4" Then
            If "" & rsTemp1.Fields("wd05") = "Y" Then
               ChkWorkDay = False
            End If
         Else
            If "" & rsTemp1.Fields("wd02") = "Y" Then
               ChkWorkDay = False
            End If
         End If
      End If
      '2012/8/15 End
   End If
   rsTemp1.Close
End Function

'Modify by Morgan 2008/11/21 +strSYS,允許傳字串參數
'Modify By Sindy 2021/7/16 改為用 Object 型態
'Public Function GetAllSysKind(Optional Strindex As TextBox, Optional strSys As String) As String
Public Function GetAllSysKind(Optional Strindex As Object, Optional strSys As String) As String
Dim StrNewSys As String
Dim strInput As String
Dim strSql As String 'Added by Morgan 2022/4/15 改區域變數，否則呼叫此函數時會影響全域變數的內容
'Add by Morgan 2008/11/21
If strSys <> "" Then
   strInput = UCase(Trim(strSys))
Else
   strInput = UCase(Trim(Strindex.Text))
End If
Select Case strInput
Case "ALL"
      'Modify By Cheng 2002/01/07
'      strSQL = "select sk01 from systemkind "
      strSql = "select Distinct sk01 from systemkind Order By SK01"
      CheckOC3
      AdoRecordSet3.CursorLocation = adUseClient
      AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      If AdoRecordSet3.RecordCount <> 0 Then
         StrNewSys = ""
         Do While AdoRecordSet3.EOF = False
            StrNewSys = StrNewSys & CheckStr(AdoRecordSet3.Fields(0))
            AdoRecordSet3.MoveNext
            If AdoRecordSet3.EOF = False Then
               StrNewSys = StrNewSys & ","
            End If
         Loop
         GetAllSysKind = StrNewSys
      Else
         GetAllSysKind = strInput
      End If
Case Else
      GetAllSysKind = strInput
End Select
End Function

'*************************************************************************************************************
'*************************************************************************************************************
'*************************************************************************************************************
'*************************************************************************************************************
'*************************************************************************************************************
'  以下為轉檔(上傳，下載)
'*************************************************************************************************************
'*************************************************************************************************************
'*************************************************************************************************************
'*************************************************************************************************************
'*************************************************************************************************************

'*************************************************************************************************************
'     北所       ----------->        分所(中，南，高)
'     Strindex1   -->     Oracle  Table  Name
'     Strindex2   -->     MDB     Table  Name
'     StrConn     -->     Connection
'*************************************************************************************************************
Public Function OraToMDB(StrIndex1 As String, StrIndex2 As String, StrConn As Connection) As Boolean
   

End Function

'*************************************************************************************************************
'     分所(中，南，高)       ----------->        北所
'     Strindex1   -->     Oracle  Table  Name
'     Strindex2   -->     MDB     Table  Name
'     StrConn     -->     Connection
'*************************************************************************************************************
Public Function MDBToOra(StrIndex1 As String, StrIndex2 As String, StrConn As Connection) As Boolean


End Function

'*************************************************************************************************************
'     北所 File       ----------->        分所(中，南，高)  File
'     Strindex1   -->     Source  File
'     Strindex2   -->     Target  File
'*************************************************************************************************************
Public Function SerToCli(StrIndex1 As String, StrIndex2 As String) As Boolean


End Function

'*************************************************************************************************************
'     分所(中，南，高) File       ----------->        北所 File
'     Strindex1   -->     Source  File
'     Strindex2   -->     Target  Fiel
'*************************************************************************************************************
Public Function CliToSer(StrIndex1 As String, StrIndex2 As String) As Boolean


End Function

'*************************************************************************************************************
'     北所       ----------->        分所(中，南，高)
'     Strindex1   -->     MDB     Table  Name   Source
'     Strindex2   -->     MDB     Table  Name   Target
'     StrConn     -->     Connection
'*************************************************************************************************************
Public Function MDBToMDB(StrIndex1 As String, StrIndex2 As String, StrConn As Connection) As Boolean


End Function

'*********************************
'   尋找檔案
' StrIndex     路徑
' Strindex2    檔案類型
'*********************************
Public Function SearchFile(Strindex As String, StrIndex2 As String) As Variant
Dim MyPath As String, MyName As String, MyTmp As String
MyPath = Strindex   ' 指定路徑。
MyTmp = ""
MyName = Dir(MyPath & "\" & StrIndex2)
Do While MyName <> ""   ' 執行迴圈。
   ' 跳過目前的目錄及上層目錄。
   If MyName <> "." And MyName <> ".." Then
      ' 使用位元比對來確定 MyName 代表一目錄。
      'If (GetAttr(MyPath & MyName) And vbDirectory) = vbDirectory Then
      MyTmp = MyTmp & MyName & ",,"    ' 將目錄名稱顯示出來。
      'End If
   End If
   MyName = Dir   ' 尋找下一個目錄。
Loop
SearchFile = ChgNewStr(MyTmp)
End Function

'*************************************
'將欄位加上table name
'   Strindex     欄位
'   Strindex2    table name
'*************************************
Public Function MdbSQL(Strindex As String, StrIndex2 As String) As String
Strindex = StrIndex2 & "." & Strindex
MdbSQL = Replace(Strindex, ",", "," & StrIndex2 & ".")
End Function

'*************************************
'檢查 員工是否離職
'   StrIndex     員工編號
'*************************************
Public Function ChkStaff(Strindex As String) As Boolean
Dim s As Integer

CheckOC3
strSql = "select st01 from staff where st01='" & Strindex & "' and st04='1' "
With AdoRecordSet3
   .CursorLocation = adUseClient
   .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If .RecordCount <> 0 Then
      ChkStaff = False
   Else
      ChkStaff = True
      s = MsgBox("此 LOGIN 人員不存在！！", , "LOGIN 人員錯誤！！")
   End If
End With
CheckOC3
End Function

''*************************************
''
''
''*************************************
'Public Sub ShowStaffErr(strST01 As String)
'   Dim s As Integer
'
'   'Modify By Sindy 2022/12/2 增加判斷是否留職停薪中
'   's = MsgBox("查無此員工，或此員工已離職！！", , "User 輸入錯誤！！")
'   s = MsgBox("查無此員工，或此員工" & IIf(PUB_StaffChange04(strST01) = True, "留職停薪中", "已離職") & "！！", , "User 輸入錯誤！！")
'End Sub

'*************************************************
' 權限檢核
'
' 傳入參數: strProgId 程式編號
'           strFunc 功能別
'
' 傳出參數: CheckUse True or False
'
'*************************************************
'add by nick 2005/02/05 加入 ShowMsg 參數，判斷要不要秀錯誤訊息
'Public Function CheckUse(ByVal strProgId As String, ByVal strFunc As String) As Boolean
Public Function CheckUse(ByVal strProgId As String, ByVal strFunc As String, Optional ShowMsg As Boolean = True) As Boolean

Dim adoData As New ADODB.Recordset
Dim adoExecute As New ADODB.Recordset
Dim strSql As String

On Error GoTo Checking
   'Modified by Lydia 2014/10/31

'   adoData.CursorLocation = adUseClient
'   strSql = "SELECT st05 FROM staff WHERE st01 = '" & Trim(strUserNum) & "'"
'   adoData.Open strSql, adoTaie, adOpenStatic, adLockReadOnly
'   If adoData.RecordCount <> 0 Then
      If IsNull(Pub_strUserST05) Then
         CheckUse = False
      Else
         '原判斷只要是Pub_strUserST05 = "00"人員一律有權限可以執行任何程式
         If Pub_strUserST05 = "00" Then
            CheckUse = True
            'Add By Sindy 2021/2/2
            '若操作人員非M51部門人員請再加入以下判斷
            '以程式名稱Mid(strProgId, 1, 5) = "frm17"者，再以strProgId讀form檔之fo03及FO06，
            '若fo06='Y'者，則必須是「年終獎金作業可操作人員」的人員才可操作。
            '若fo03是'薪資系統'開頭者，則必須是「薪資系統可操作人員」的人員才可操作。
            If Pub_StrUserSt03 <> "M51" Then
               If Mid(UCase(strProgId), 1, 5) = UCase("frm17") Then
                  adoExecute.CursorLocation = adUseClient
                  strSql = "SELECT * FROM FORM WHERE upper(FO01) = '" & UCase(strProgId) & "'"
                  adoExecute.Open strSql, adoTaie, adOpenStatic, adLockReadOnly
                  If adoExecute.RecordCount <> 0 Then
                     If "" & adoExecute.Fields("FO06").Value = "Y" And _
                        InStr(Pub_GetSpecMan("年終獎金作業可操作人員"), strUserNum) = 0 Then
                        CheckUse = False
                     ElseIf Left("" & adoExecute.Fields("FO03").Value, 4) = "薪資系統" And _
                        InStr(Pub_GetSpecMan("薪資系統可操作人員"), strUserNum) = 0 Then
                        CheckUse = False
                     End If
                  End If
               End If
            End If
            If CheckUse = False Then
               If ShowMsg = True Then
                  MsgBox "無此使用權限...", , "警告!!"
               End If
            End If
            '2021/2/2 END
            'CheckUse = True
            Set adoExecute = Nothing
            Set adoData = Nothing
            Exit Function
         End If
                  
         adoExecute.CursorLocation = adUseClient
         'Modify by Morgan 2008/9/18 改先抓個人設定
         strSql = "SELECT 2,SR.* FROM staff_right SR WHERE sr01 = '" & Pub_strUserST05 & "' AND sr02 = '" & strProgId & "'"
         strSql = strSql & " UNION ALL SELECT 1,SR.* FROM staff_right SR WHERE sr01 = '" & Trim(strUserNum) & "' AND sr02 = '" & strProgId & "' order by 1"
         
         If adoTaie.ConnectionString = "" Then Set adoTaie = cnnConnection 'Added by Lydia 2018/10/18
         adoExecute.Open strSql, adoTaie, adOpenStatic, adLockReadOnly
         If adoExecute.RecordCount <> 0 Then
            Select Case strFunc
               Case strAdd
                  If adoExecute.Fields("sr03").Value = "Y" Then
                     CheckUse = True
                  Else
                     CheckUse = False
                  End If
               Case strEdit
                  If adoExecute.Fields("sr04").Value = "Y" Then
                     CheckUse = True
                  Else
                     CheckUse = False
                  End If
               Case strDel
                  If adoExecute.Fields("sr05").Value = "Y" Then
                     CheckUse = True
                  Else
                     CheckUse = False
                  End If
               Case strFind
                  If adoExecute.Fields("sr06").Value = "Y" Then
                     CheckUse = True
                  Else
                     CheckUse = False
                  End If
               Case strPrint
                  If adoExecute.Fields("sr07").Value = "Y" Then
                     CheckUse = True
                  Else
                     CheckUse = False
                  End If
               Case strExec
                  If adoExecute.Fields("sr08").Value = "Y" Then
                     CheckUse = True
                  Else
                     CheckUse = False
                  End If
            End Select
            
         Else
            CheckUse = False
         End If
      End If
'   Else
'      CheckUse = False
'   End If
   
   '仍要先抓個人的權限,因為林總94007還有特殊權限
   'add by sonia 2014/4/24 加入總經理權限(等級01)可使用所有程式,但維護程式只有查詢功能,不可新增刪除修改
   If Pub_strUserST05 = "01" And CheckUse = False Then
      adoExecute.Close
      adoExecute.CursorLocation = adUseClient
      strSql = "SELECT Fo04,Fo06 FROM FORM WHERE FO01 = '" & strProgId & "'"
      adoExecute.Open strSql, adoTaie, adOpenStatic, adLockReadOnly
      If adoExecute.RecordCount <> 0 Then
         'Add By Sindy 2021/2/2
         '以程式名稱Mid(strProgId, 1, 5) = "frm17"者，再以strProgId讀form檔之Fo06，
         '若fo06='Y'者，則必須是「年終獎金作業可操作人員」的人員才可操作。
         If Mid(UCase(strProgId), 1, 5) = UCase("frm17") And _
            "" & adoExecute.Fields("FO06").Value = "Y" Then
            If InStr(Pub_GetSpecMan("年終獎金作業可操作人員"), strUserNum) > 0 Then
               CheckUse = True
               Set adoExecute = Nothing
               Set adoData = Nothing
               Exit Function
            End If
         Else
         '2021/2/2 END
            If "" & adoExecute.Fields("Fo04").Value = "Y" Then
            Else
               CheckUse = True
               Set adoExecute = Nothing
               Set adoData = Nothing
               Exit Function
            End If
         End If
      Else
         CheckUse = True
         Set adoExecute = Nothing
         Set adoData = Nothing
         Exit Function
      End If
      adoExecute.Close
   End If
   '2014/4/24 end
         
   'If CheckUse = False Then
   If CheckUse = False And ShowMsg = True Then
      MsgBox "無此使用權限...", , "警告!!"
   End If
   Set adoExecute = Nothing
   Set adoData = Nothing
   Exit Function
Checking:
   CheckUse = False
   Exit Function
End Function

'************************************************
'檢查系統別屬於哪各系統
'  STRINDEX   =====    系統別
'  STRINDEX2  =====    0 不分國內外   1 分國內外
'  OUTPUT      PATENT                     1
'              TRADEMARK                  2
'              LAWCASE                    3
'              HIRECASE                   4
'              SERVICEPRACTICE_PATENT     5
'              SERVICEPRACTICE_TRADEMARK  6
'              SERVICEPRACTICE_LAWCASE    7
'              SERVICEPRACTICE_HIRECASE   8
'************************************************
Public Function CheckSys(ByRef Strindex As Variant, Optional StrIndex2 As Integer = 0) As String
CheckOC3
strSql = "select sk02,sk03,sk04 from systemkind where sk01='" & Strindex & "' "
With AdoRecordSet3
   .CursorLocation = adUseClient
   .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If .RecordCount <> 0 Then
      CheckSys = CheckStr(.Fields(0))
      If StrIndex2 <> 0 Then
         CheckSys = CheckSys & CheckStr(.Fields(1))
      End If
   Else
      CheckSys = ""
   End If
End With
CheckOC3

End Function

'*************************************************
' 檢核字串是否包含單引號
'
'*************************************************
Public Function ChgSQL(ByVal CSQL As String) As String
Dim Pos As Integer, lPos As Integer, TmpSt As String
 
    Pos = 1
    TmpSt = ""
    While InStr(Pos, CSQL, "'") <> 0
        lPos = Pos
        Pos = InStr(Pos, CSQL, "'")
        TmpSt = TmpSt & Mid(CSQL, lPos, Pos - lPos) & "''"
        Pos = Pos + 1
    Wend
    ChgSQL = TmpSt & Right(CSQL, Len(CSQL) - Pos + 1)
    
End Function

'strStart 大 strEnd 小
Public Function GetWorkDay(ByVal strStart As String, ByVal strEnd As String) As Integer
'Added by Lydia 2019/07/30
Dim strM01 As String, intM As Integer
Dim rsRD As New ADODB.Recordset

   'Modified by Lydia 2019/07/30 變更變數strM01,rsRd
'   strExc(0) = "SELECT COUNT(*) FROM WORKDAY WHERE WD01 BETWEEN " & strEnd & " AND " & strStart
'   intI = 1
'   Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
'   If intI = 1 Then
'      If RsTemp.Fields(0) = 0 Then
   strM01 = "SELECT COUNT(*) FROM WORKDAY WHERE WD01 BETWEEN " & strEnd & " AND " & strStart
   intM = 1
   Set rsRD = ClsLawReadRstMsg(intM, strM01)
   If intM = 1 Then
      If rsRD.Fields(0) = 0 Then
   'end 2019/07/30
         GetWorkDay = 0
      Else
         'Modify By Cheng 2002/04/11
'         If Not ChkWorkDay(strStart) Or Not ChkWorkDay(strEnd) Then
'            GetWorkDay = rsTemp.Fields(0) + 1
'         Else
            'Modified by Lydia 2019/07/30 變更變數
            'GetWorkDay = RsTemp.Fields(0)
            GetWorkDay = rsRD.Fields(0)
'         End If
      End If
   End If
   Set rsRD = Nothing 'Added by Lydia 2019/07/30
End Function

Public Function ChangeNewSQLStr(ByRef Strindex As Variant, ByRef StrIndex2 As String) As String
ChangeNewSQLStr = IIf(Len(CheckStr(Strindex)) = 0, " " & StrIndex2 & " is null ", StrIndex2 & "='" & CheckStr(Strindex) & "' ")
End Function

'取得下次期限天數
Public Function GetCaseFeeNextDays(ByRef cp01 As String, ByRef NA01 As String, ByRef NP07 As String) As String
CheckOC3
With AdoRecordSet3
   .CursorLocation = adUseClient
   .Open "SELECT CF12 FROM CASEFEE WHERE CF01='" & cp01 & "' AND CF02='" & NA01 & "' AND CF03='" & NP07 & "' ", cnnConnection, adOpenStatic, adLockReadOnly
   If .RecordCount <> 0 Then
      GetCaseFeeNextDays = CheckStr(.Fields(0))
   Else
      GetCaseFeeNextDays = ""
   End If
End With
CheckOC3
End Function

'解析檔案應該放在哪一個目錄
'Strindex 不含副檔名
Public Function GetDocFilePath(ByRef Strindex As String) As String

Dim strTempFile As Variant
Dim strCP01 As String, strCP02 As String, strCP03 As String, strCP04 As String
Dim strCP10 As String, strCP09 As String, StrIndex2
Dim FilePathOK As String '檔案應歸檔位置
If InStr(1, Strindex, ".") <> 0 Then
    StrIndex2 = Mid(Strindex, 1, InStr(Strindex, ".") - 1)
Else
   StrIndex2 = Strindex
End If
strTempFile = Split(StrIndex2, "-")
If UBound(strTempFile) <> 5 Then
    If Dir(DOCLOGPath, vbDirectory) = "" Then
        MkDir (DOCLOGPath)
    End If
    GetDocFilePath = ""
    Exit Function
End If
strCP01 = strTempFile(0)
strCP02 = strTempFile(1)
strCP03 = strTempFile(2)
strCP04 = strTempFile(3)
strCP10 = strTempFile(4)
strCP09 = strTempFile(5)
If Len(strCP01) = 0 Or Len(strCP02) = 0 Or Len(strCP03) = 0 Or Len(strCP04) = 0 Or Len(strCP09) = 0 Or Len(strCP10) = 0 Then
    If Dir(DOCLOGPath, vbDirectory) = "" Then
        MkDir (DOCLOGPath)
    End If
    GetDocFilePath = ""
    Exit Function
End If
FilePathOK = DOCPathOut & "\" & strCP01 & "\" & Mid(strCP02, 1, 3)
GetDocFilePath = CheckPath(FilePathOK, strCP01, strCP02, strCP03, strCP04)
End Function

'filepathok 檔案應歸檔位置
'strcp01,strcp02,strcp03,strcp04 本所案號
'若該路徑不存在則自動建立
Public Function CheckPath(FilePathOK As String, strCP01 As String, strCP02 As String, strCP03 As String, strCP04 As String) As String
Dim s As Integer

'檢查路徑是否存在
If Dir(FilePathOK, vbDirectory) = "" Then
    If Dir(DOCPathOut, vbDirectory) = "" Then
        s = MsgBox(DriveShield & "：路徑錯誤請檢核！", , "程式預設目錄錯誤！")
        If Dir(DOCLOGPath, vbDirectory) = "" Then
            MkDir (DOCLOGPath)
        End If
        CheckPath = ""
        Exit Function
    End If
    If Dir(DOCPathOut & "\" & strCP01, vbDirectory) = "" Then
        MkDir (DOCPathOut & "\" & strCP01)
    End If
    If Dir(DOCPathOut & "\" & strCP01 & "\" & Mid(strCP02, 1, 3), vbDirectory) = "" Then
        MkDir (FilePathOK)
    End If
End If
CheckPath = FilePathOK
End Function

'改成新的檔名格式
Public Function ChangeFileName(StrCp01020304 As String, strCP10 As String, strCP09 As String) As String
'Trim(lbl1(7).Caption) & "-" & Trim(lbl1(15).Caption) & "-" & Trim(lbl1(3).Caption) & ".DOC")
ChangeFileName = StrCp01020304 & "-" & strCP10 & "-" & strCP09
End Function

'Modify By Sindy 2021/7/16 改為用 Object 型態
'Public Function nickChgRan(txt1 As TextBox, txt2 As TextBox, St As String) As Boolean
Public Function nickChgRan(txt1 As Object, txt2 As Object, St As String) As Boolean
Dim sss
'edit by nickc 2005/05/05
'If txt1.Text > txt2.Text And txt2.Text <> "" Then
If Val(txt1.Text) > Val(txt2.Text) And txt2.Text <> "" Then
   sss = MsgBox(St & "區間錯誤", , "錯誤！")
   nickChgRan = False
Else
   nickChgRan = True
End If
End Function

'Add By Cheng 2002/07/05
'以系統類別的SK03判斷顯示代理人名稱順序
'若SK03=0, 則中-->英-->日, 否則英-->中-->日
Public Function PUB_GetAgentName(strSK01 As String, strFA0102 As String, strTempName As String) As Boolean
Dim rsA As New ADODB.Recordset
Dim StrSQLa As String
Dim strSK03 As String

PUB_GetAgentName = True
strSK03 = ""
If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing
StrSQLa = "Select SK03 From SystemKind Where SK01='" & strSK01 & "'"
rsA.CursorLocation = adUseClient
rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
If rsA.RecordCount > 0 Then
   strSK03 = "" & rsA.Fields(0).Value
End If
If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing
If strSK03 = "0" Then
   StrSQLa = "Select DECODE(FA04,NULL,DECODE(FA05,NULL,FA06,FA05||' '||FA63||' '||FA64||' '||FA65),FA04) FROM FAGENT WHERE FA01='" & Mid(strFA0102 & "000000000", 1, 8) & "' AND FA02='" & Mid(strFA0102 & "000000000", 9, 1) & "'"
Else
   StrSQLa = "Select DECODE(FA05,NULL,NVL(FA04,FA06),FA05||' '||FA63||' '||FA64||' '||FA65) FROM FAGENT WHERE FA01='" & Mid(strFA0102 & "000000000", 1, 8) & "' AND FA02='" & Mid(strFA0102 & "000000000", 9, 1) & "'"
End If
rsA.CursorLocation = adUseClient
rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
If rsA.RecordCount > 0 Then
   strTempName = "" & rsA.Fields(0).Value
Else
   strTempName = ""
   PUB_GetAgentName = False
End If
If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing

End Function

'910710 Sieg 107
Public Function GetFCPSales(strCaseNo As String, strSalesName As String, Optional strSalesID As String) As Boolean
Dim strBCase(1 To 4) As String 'Added by Lydia 2024/04/02

   GetFCPSales = False
   strSalesName = ""
   strSalesID = ""
   ChgCaseNo strCaseNo, strBCase 'Modified by Lydia 2024/04/02 改變數

'modify by sonia 2013/12/30 改用PUB_GetFCPSalesNo
'   strExc(0) = "select decode(pa75,'',s1.st02,s2.st02),decode(pa75,'',s1.st01,s2.st01) " & _
'      "from patent,customer,fagent," & _
'      "staff s1,staff s2,acc090 a1,acc090 a2,nation n1,nation n2 " & _
'      "where pa01='" & strExc(1) & "' and pa02='" & strExc(2) & "' and " & _
'      "pa03='" & strExc(3) & "' and pa04='" & strExc(4) & "' and " & _
'      "substr(pa26,1,8)=cu01(+) and substr(pa26,9,1)=cu02(+) and " & _
'      "cu10=n1.na01(+) and n1.na51=s1.st01(+) and s1.st03=a1.a0901(+) and " & _
'      "substr(pa75,1,8)=fa01(+) and substr(pa75,9,1)=fa02(+) and " & _
'      "fa10=n2.na01(+) and n2.na51=s2.st01(+) and s2.st03=a2.a0901(+) "
'
'   Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
'   If intI = 1 Then
'      If Not IsNull(RsTemp.Fields(0)) Then strSalesName = RsTemp.Fields(0)
'      If Not IsNull(RsTemp.Fields(1)) Then strSalesID = RsTemp.Fields(1)
'   End If
   strSalesID = PUB_GetFCPSalesNo(strBCase(1), strBCase(2), strBCase(3), strBCase(4)) 'Modified by Lydia 2024/04/02 改變數
   strSalesName = GetPrjSalesNM(strSalesID)
'end 2013/12/30

   GetFCPSales = True
End Function

'910711 Sieg 107
Public Function GetFGSales(strCaseNo As String, strSalesName As String, Optional strSalesID As String) As Boolean
Dim strBCase(1 To 4) As String 'Added by Lydia 2024/04/02
   GetFGSales = False
   strSalesName = ""
   strSalesID = ""
   ChgCaseNo strCaseNo, strBCase 'Modified by Lydia 2024/04/02 改變數

'modify by sonia 2013/12/30 改用PUB_GetFCPSalesNo
'   strExc(0) = "select decode(sp26,'',s1.st02,s2.st02),decode(sp26,'',s1.st01,s2.st01) " & _
'      "from servicepractice,customer,fagent," & _
'      "staff s1,staff s2,acc090 a1,acc090 a2,nation n1,nation n2 " & _
'      "where sp01='" & strExc(1) & "' and sp02='" & strExc(2) & "' and " & _
'      "sp03='" & strExc(3) & "' and sp04='" & strExc(4) & "' and " & _
'      "substr(sp08,1,8)=cu01(+) and substr(sp08,9,1)=cu02(+) and " & _
'      "cu10=n1.na01(+) and n1.na51=s1.st01(+) and s1.st03=a1.a0901(+) and " & _
'      "substr(sp26,1,8)=fa01(+) and substr(sp26,9,1)=fa02(+) and " & _
'      "fa10=n2.na01(+) and n2.na51=s2.st01(+) and s2.st03=a2.a0901(+) "
'
'   Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
'   If intI = 1 Then
'      If Not IsNull(RsTemp.Fields(0)) Then strSalesName = RsTemp.Fields(0)
'      If Not IsNull(RsTemp.Fields(1)) Then strSalesID = RsTemp.Fields(1)
'   End If
   strSalesID = PUB_GetFCPSalesNo(strBCase(1), strBCase(2), strBCase(3), strBCase(4)) 'Modified by Lydia 2024/04/02 改變數
   strSalesName = GetPrjSalesNM(strSalesID)
'end 2013/12/30
   
   GetFGSales = True
End Function

'Add By Cheng 2002/08/09
'讀取NextProgress的資料
Public Function PUB_ReadNextProgressData( _
   ByRef np() As String, _
   ByVal strNP01 As String, _
   ByVal strNP07 As String, _
   ByVal strNP22 As String) As Boolean

'NP():欲傳回的NextProgree欄位值
'strNP01,strNP07,strNP22:NextProgress的PK值

   Dim StrSQLa As String
   Dim rsA As New ADODB.Recordset
   Dim ii As Integer
   
   StrSQLa = "SELECT * FROM NEXTPROGRESS WHERE " & _
            "NP01='" & strNP01 & "'" & _
            " AND NP07 ='" & strNP07 & "'" & _
            " AND NP22 ='" & strNP22 & "'"
   rsA.CursorLocation = adUseClient
   rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
   If rsA.RecordCount > 0 Then
      For ii = 0 To TF_NP - 1 'edit by nickc 2007/02/06 T_NP - 1
             np(ii + 1) = IIf(IsNull(rsA.Fields(ii)), "", rsA.Fields(ii))
      Next ii
      PUB_ReadNextProgressData = True
   Else
      PUB_ReadNextProgressData = False
   End If
   If rsA.State <> adStateClosed Then rsA.Close
   Set rsA = Nothing
End Function

'Add By Cheng 2002/08/09
'更新下一程序檔的資料
Public Function PUB_UpdateNextProgress( _
   ByRef np() As String, _
   ByVal strNP01 As String, _
   ByVal strNP07 As String, _
   ByVal strNP22 As String) As Boolean

'NP():欲更新NextProgress的欄位值(注意:PK值是無法被更新的)
'strNP01,strNP07,strNP22:NextProgress的PK值
   
   Dim StrSQLa As String
   Dim ii As Integer
   
   On Error GoTo ErrorHandler
   
   PUB_UpdateNextProgress = False
   StrSQLa = "Update NextProgress Set "
   For ii = 0 To TF_NP - 1 'edit by nickc 2007/02/06 T_NP - 1
      StrSQLa = StrSQLa & "NP" & Format(ii + 1, "00") & "=" & CNULL(ChgSQL(np(ii + 1))) & ","
   Next ii
   StrSQLa = Left(StrSQLa, Len(StrSQLa) - 1)
   StrSQLa = StrSQLa & " WHERE NP01='" & strNP01 & "' AND NP07=" & Val(strNP07) & " AND NP22= " & Val(strNP22)
   cnnConnection.Execute StrSQLa
   PUB_UpdateNextProgress = True
   Exit Function
ErrorHandler:
   PUB_UpdateNextProgress = False
   MsgBox "(" & Err.Number & ")" & Err.Description, vbExclamation + vbOKOnly, "更新下一程序檔動作失敗"
End Function

'Add By Cheng 2002/08/09
'新增下一程序檔的資料
Public Function PUB_AddNewNextProgress( _
   ByRef np() As String) As Boolean

'NP():傳入欲新增NextProgress的欄位值

   Dim StrSQLa As String
   Dim ii As Integer
   'add by nick 2004/08/06 加入控制指定欄位
   Dim oStrSQL930806 As String
   
   On Error GoTo ErrorHandler
   
   'add by nick 2004/08/06
   oStrSQL930806 = "("
   For ii = 0 To TF_NP - 1 'edit by nickc 2007/02/06 T_NP - 1
        'edit by nickc 2007/02/13
        'oStrSQL930806 = oStrSQL930806 & "NP" & Right("000" & Trim(ii + 1), 2) & ","
        oStrSQL930806 = oStrSQL930806 & "NP" & Format(ii + 1, "00") & ","
   Next ii
   oStrSQL930806 = Left(oStrSQL930806, Len(oStrSQL930806) - 1)
   oStrSQL930806 = oStrSQL930806 & ")"
   
   PUB_AddNewNextProgress = False
   'edit by nick 2004/08/06
   'strSQLA = "INSERT INTO NextProgress values ( "
   StrSQLa = "INSERT INTO NextProgress " & oStrSQL930806 & " values ( "
   For ii = 0 To TF_NP - 1 'edit by nickc 2007/02/06 T_NP - 1
      StrSQLa = StrSQLa & CNULL(ChgSQL(np(ii + 1))) & ","
   Next ii
   StrSQLa = Left(StrSQLa, Len(StrSQLa) - 1)
   StrSQLa = StrSQLa & " )"
   cnnConnection.Execute StrSQLa
   PUB_AddNewNextProgress = True
   Exit Function
ErrorHandler:
   PUB_AddNewNextProgress = False
   MsgBox "(" & Err.Number & ")" & Err.Description, vbExclamation + vbOKOnly, "新增下一程序檔動作失敗"
End Function

'Add By Cheng 2002/08/13
'取得小於等於系統日且日期最大者的美金匯率
Public Function PUB_GetUSXRate() As Double
   Dim StrSQLa As String
   Dim rsA As New ADODB.Recordset

   PUB_GetUSXRate = 1
   StrSQLa = "SELECT USXR02 FROM USXRATE WHERE USXR01=(SELECT MAX(USXR01) FROM USXRATE WHERE USXR01 <=" & strSrvDate(2) & " )"
   rsA.CursorLocation = adUseClient
   rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
   If rsA.RecordCount > 0 Then
      PUB_GetUSXRate = Val(rsA.Fields(0).Value)
   End If
   '當匯率為 0 時預設為1, 以避免當除數時出錯
   If PUB_GetUSXRate = 0 Then PUB_GetUSXRate = 1
   If rsA.State <> adStateClosed Then rsA.Close
   Set rsA = Nothing
   
End Function

'Add By Cheng 2002/08/13
'取得小於等於且最接近傳入日期的美金匯率
'2009/4/24 MODIFY BY SONIA 加請款幣別參數
Public Function PUB_GetUSXRate_1(strBasicDate As String, strCurrency As String) As Double
'strBasicDate : 民國日期
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset

   PUB_GetUSXRate_1 = 1
   '2009/4/24 MODIFY BY SONIA 加其他請款幣別
   'StrSQLa = "SELECT USXR02 FROM USXRATE WHERE USXR01<=" & Val(strBasicDate) & " Order By USXR01 Desc "
   If strCurrency <> "USD" Then
      StrSQLa = "SELECT DNR03 FROM DEBITNOTERATE WHERE DNR01='" & strCurrency & "' AND DNR02<=" & Val(strBasicDate) & " Order By DNR02 Desc "
   Else
      StrSQLa = "SELECT USXR02 FROM USXRATE WHERE USXR01<=" & Val(strBasicDate) & " Order By USXR01 Desc "
   End If
   '2009/4/24 END
   rsA.MaxRecords = 1
   rsA.CursorLocation = adUseClient
   rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
   If rsA.RecordCount > 0 Then
      PUB_GetUSXRate_1 = Val(rsA.Fields(0).Value)
   End If
   '當匯率為 0 時預設為1, 以避免當除數時出錯
   If PUB_GetUSXRate_1 = 0 Then PUB_GetUSXRate_1 = 1
   If rsA.State <> adStateClosed Then rsA.Close
   Set rsA = Nothing
   
End Function

'2009/4/24 ADD BY SONIA 抓請款幣別對美金匯率
Public Function PUB_GetDNRate(strBasicDate As String, strCurrency As String) As Double
'strBasicDate : 民國日期
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset

   PUB_GetDNRate = 1
   StrSQLa = "SELECT DNR04 FROM DEBITNOTERATE WHERE DNR01='" & strCurrency & "' AND DNR02<=" & Val(strBasicDate) & " Order By DNR02 Desc "
   rsA.MaxRecords = 1
   rsA.CursorLocation = adUseClient
   rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
   If rsA.RecordCount > 0 Then
      PUB_GetDNRate = Val(rsA.Fields(0).Value)
   End If
   '當匯率為 0 時預設為1, 以避免當除數時出錯
   If PUB_GetDNRate = 0 Then PUB_GetDNRate = 1
   If rsA.State <> adStateClosed Then rsA.Close
   Set rsA = Nothing
   
End Function
'2009/4/24 END

'Add By Cheng 2002/08/14
'新增案件進度檔的資料
Public Function PUB_AddNewCaseProgress( _
   ByRef cp() As String) As Boolean
   
'CP():傳入欲新增CaseProgress的欄位值

   Dim StrSQLa As String
   Dim ii As Integer
   'add by nick 2004/08/06 加入控制指定欄位
   Dim oStrSQL930806 As String
      
   On Error GoTo ErrorHandler
   
   'add by nick 2004/08/06
   oStrSQL930806 = "("
   For ii = 0 To TF_CP - 1 'edit by nickc 2007/02/06 T_CP - 1
      'Modify by Morgan 2007/2/12 欄位超過100
      'oStrSQL930806 = oStrSQL930806 & "CP" & Right("000" & Trim(ii + 1), 2) & ","
      oStrSQL930806 = oStrSQL930806 & "CP" & Format(ii + 1, "00") & ","
      'end 2007/2/12
   Next ii
   oStrSQL930806 = Left(oStrSQL930806, Len(oStrSQL930806) - 1)
   oStrSQL930806 = oStrSQL930806 & ")"
   
   PUB_AddNewCaseProgress = False
   'edit by nick 2004/08/06
   'strSQLA = "INSERT INTO CaseProgress values ( "
   StrSQLa = "INSERT INTO CaseProgress " & oStrSQL930806 & " values ( "
   For ii = 0 To TF_CP - 1 'edit by nickc 2007/02/06 T_CP - 1
      StrSQLa = StrSQLa & CNULL(ChgSQL(cp(ii + 1))) & ","
   Next ii
   StrSQLa = Left(StrSQLa, Len(StrSQLa) - 1)
   StrSQLa = StrSQLa & " )"
   cnnConnection.Execute StrSQLa
   PUB_AddNewCaseProgress = True
   Exit Function
ErrorHandler:
   PUB_AddNewCaseProgress = False
   MsgBox "(" & Err.Number & ")" & Err.Description, vbExclamation + vbOKOnly, "新增案件進度檔動作失敗"
End Function

'Add By Cheng 2002/08/22
'檢查是否可修改申請人
Public Function PUB_EditCustOk(ByVal strCP09 As String, ByVal strCP01 As String, ByVal strCP02 As String, ByVal strCP03 As String, ByVal strCP04 As String) As Boolean
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset

   PUB_EditCustOk = False
   StrSQLa = "Select * From CaseProgress WHERE CP09='" & strCP09 & "'"
   rsA.CursorLocation = adUseClient
   rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
   If rsA.RecordCount > 0 Then
      If "" & rsA("CP31").Value = "Y" Then
         '92.9.23 MODIFY BY SONIA
         'If rsA.State <> adStateClosed Then rsA.Close
         'Set rsA = Nothing
         'strSQLA = "SELECT * FROM CASEPROGRESS WHERE CP01='" & strCP01 & "' AND CP02='" & strCP02 & "' AND CP03='" & strCP03 & "' AND CP04='" & strCP04 & "' "
         'rsA.CursorLocation = adUseClient
         'rsA.Open strSQLA, cnnConnection, adOpenStatic, adLockReadOnly
         'Do While Not rsA.EOF
         '   PUB_EditCustOk = True
         '   If Not IsNull(rsA("CP27")) Then
         '      PUB_EditCustOk = False
         '      Exit Do
         '   End If
         '   rsA.MoveNext
         'Loop
         PUB_EditCustOk = True
         '92.9.23 END
      Else
         PUB_EditCustOk = False
      End If
   Else
      PUB_EditCustOk = False
   End If
   If rsA.State <> adStateClosed Then rsA.Close
   Set rsA = Nothing
   If PUB_EditCustOk = False Then
        'Modify By Cheng 2002/12/25
'      MsgBox "不可修改申請人!!!", vbExclamation + vbOKOnly
      MsgBox "非新案或新案已發文者，不可修改申請人!!!", vbExclamation + vbOKOnly
   End If
End Function
'2005/4/19 ADD BY SONIA
'm_OLD01~(4)原查名本所案號,m_NEW01~(8)新商標本所案號
Public Function PUB_UpdOther(m_OLD01 As String, m_OLD02 As String, m_OLD03 As String, m_OLD04 As String, m_NEW01 As String, m_NEW02 As String, m_NEW03 As String, m_NEW04 As String) As Boolean
Dim strSql As String
On Error GoTo ErrHand
   PUB_UpdOther = False
   
   ' 更新下一程序檔
   strSql = "UPDATE NEXTPROGRESS SET NP02 = '" & m_NEW01 & "', " & _
                                    "NP03 = '" & m_NEW02 & "', " & _
                                    "NP04 = '" & m_NEW03 & "', " & _
                                    "NP05 = '" & m_NEW04 & "' " & _
                  "WHERE NP02 = '" & m_OLD01 & "' AND " & _
                        "NP03 = '" & m_OLD02 & "' AND " & _
                        "NP04 = '" & m_OLD03 & "' AND " & _
                        "NP05 = '" & m_OLD04 & "' "
   cnnConnection.Execute strSql
   
   ' 更新相關卷號檔
   'Modified by Lydia 2020/08/18 若T和TS之間有關聯又執行查名本所案號,刪除關聯 ; 避免重複資料
   'strSql = "UPDATE CASERELATION1 SET CR01 = '" & m_NEW01 & "', " & _
                                    "CR02 = '" & m_NEW02 & "', " & _
                                    "CR03 = '" & m_NEW03 & "', " & _
                                    "CR04 = '" & m_NEW04 & "' " & _
                  "WHERE CR01 = '" & m_OLD01 & "' AND " & _
                        "CR02 = '" & m_OLD02 & "' AND " & _
                        "CR03 = '" & m_OLD03 & "' AND " & _
                        "CR04 = '" & m_OLD04 & "' "
   'cnnConnection.Execute strSql
   strSql = "delete from CaseRelation1 where cr01='" & m_OLD01 & "' and cr02='" & m_OLD02 & "' and cr03='" & m_OLD03 & "' and cr04='" & m_OLD04 & "' " & _
             "and cr05='" & m_NEW01 & "' and cr06='" & m_NEW02 & "' and cr07='" & m_NEW03 & "' and cr08='" & m_NEW04 & "' "
   cnnConnection.Execute strSql
   strSql = "delete from CaseRelation1 where cr01='" & m_NEW01 & "' and cr02='" & m_NEW02 & "' and cr03='" & m_NEW03 & "' and cr04='" & m_NEW04 & "' " & _
             "and cr05='" & m_OLD01 & "' and cr06='" & m_OLD02 & "' and cr07='" & m_OLD03 & "' and cr08='" & m_OLD04 & "' "
   cnnConnection.Execute strSql
   'end 2020/08/18
   
   ' 更新來函記錄檔
   strSql = "UPDATE MAILREC SET MR12 = '" & m_NEW01 & "', " & _
                               "MR13 = '" & m_NEW02 & "', " & _
                               "MR14 = '" & m_NEW03 & "', " & _
                               "MR15 = '" & m_NEW04 & "' " & _
                  "WHERE MR12 = '" & m_OLD01 & "' AND " & _
                        "MR13 = '" & m_OLD02 & "' AND " & _
                        "MR14 = '" & m_OLD03 & "' AND " & _
                        "MR15 = '" & m_OLD04 & "' "
   cnnConnection.Execute strSql
   
   ' 更新資料刪除記錄檔
   strSql = "UPDATE DATADELETERECORD SET DD01 = '" & m_NEW01 & "', " & _
                                        "DD02 = '" & m_NEW02 & "', " & _
                                        "DD03 = '" & m_NEW03 & "', " & _
                                        "DD04 = '" & m_NEW04 & "' " & _
                  "WHERE DD01 = '" & m_OLD01 & "' AND " & _
                        "DD02 = '" & m_OLD02 & "' AND " & _
                        "DD03 = '" & m_OLD03 & "' AND " & _
                        "DD04 = '" & m_OLD04 & "' "
   cnnConnection.Execute strSql
   
   ' 更新轉傳票分錄資料
   strSql = "UPDATE ACC1P0 SET A1P17 = '" & m_NEW01 & m_NEW02 & m_NEW03 & m_NEW04 & "' " & _
                  "WHERE A1P17 = '" & m_OLD01 & m_OLD02 & m_OLD03 & m_OLD04 & "' "
   cnnConnection.Execute strSql

   '2007/12/17 ADD BY SONIA
   ' 更新國外請款資料(明細檔)
   strSql = "UPDATE ACC1L0 SET A1L03 = '" & m_NEW01 & "'  WHERE A1L01 IN ( " & _
                  "SELECT A1K01 FROM ACC1K0 " & _
                  "WHERE A1K13 = '" & m_OLD01 & "' AND " & _
                        "A1K14 = '" & m_OLD02 & "' AND " & _
                        "A1K15 = '" & m_OLD03 & "' AND " & _
                        "A1K16 = '" & m_OLD04 & "') "
   cnnConnection.Execute strSql
   '2007/12/17 END
   
   ' 更新國外請款資料(主檔)
   '2013/10/17 MODIFY BY SONIA A1K05改為A1K34
   strSql = "UPDATE ACC1K0 SET A1K13 = '" & m_NEW01 & "', " & _
                              "A1K14 = '" & m_NEW02 & "', " & _
                              "A1K15 = '" & m_NEW03 & "', " & _
                              "A1K16 = '" & m_NEW04 & "', " & _
                              "A1K34 = A1K34 || '原本所案號" & m_OLD01 & "-" & m_OLD02 & "-" & m_OLD03 & "-" & m_OLD04 & "' " & _
                  "WHERE A1K13 = '" & m_OLD01 & "' AND " & _
                        "A1K14 = '" & m_OLD02 & "' AND " & _
                        "A1K15 = '" & m_OLD03 & "' AND " & _
                        "A1K16 = '" & m_OLD04 & "' "
   cnnConnection.Execute strSql
   
   ' 更新國外抵帳單資料(交易檔)
   strSql = "UPDATE ACC161 SET AXG03 = '" & m_NEW01 & m_NEW02 & m_NEW03 & m_NEW04 & "' " & _
                  "WHERE AXG03 = '" & m_OLD01 & m_OLD02 & m_OLD03 & m_OLD04 & "' "
   cnnConnection.Execute strSql
   
   ' 更新國外帳單資料(交易檔)
   strSql = "UPDATE ACC151 SET AXF03 = '" & m_NEW01 & m_NEW02 & m_NEW03 & m_NEW04 & "' " & _
                  "WHERE AXF03 = '" & m_OLD01 & m_OLD02 & m_OLD03 & m_OLD04 & "' "
   cnnConnection.Execute strSql
   
   ' 更新國外暫收款資料
   strSql = "UPDATE ACC120 SET A1208 = '" & m_NEW01 & m_NEW02 & m_NEW03 & m_NEW04 & "' " & _
                  "WHERE A1208 = '" & m_OLD01 & m_OLD02 & m_OLD03 & m_OLD04 & "' "
   cnnConnection.Execute strSql
   
   ' 更新國內未開收據案件資料(暫存檔)
   strSql = "UPDATE ACC0J0 SET A0J02 = '" & m_NEW01 & m_NEW02 & m_NEW03 & m_NEW04 & "' " & _
                  "WHERE A0J02 = '" & m_OLD01 & m_OLD02 & m_OLD03 & m_OLD04 & "' "
   cnnConnection.Execute strSql
   
   ' 更新傳票資料(交易檔-財務)
   strSql = "UPDATE ACC021 SET AX214 = '" & m_NEW01 & m_NEW02 & m_NEW03 & m_NEW04 & "' " & _
                  "WHERE AX214 = '" & m_OLD01 & m_OLD02 & m_OLD03 & m_OLD04 & "' "
   cnnConnection.Execute strSql
   
   ' 更新傳票資料(交易檔-帳務)
   strSql = "UPDATE ACC031 SET AX314 = '" & m_NEW01 & m_NEW02 & m_NEW03 & m_NEW04 & "' " & _
                  "WHERE AX314 = '" & m_OLD01 & m_OLD02 & m_OLD03 & m_OLD04 & "' "
   cnnConnection.Execute strSql
   
   ' 更新國外結匯資料
   strSql = "UPDATE ACC170 SET A1707 = '" & m_NEW01 & m_NEW02 & m_NEW03 & m_NEW04 & "' " & _
                  "WHERE A1707 = '" & m_OLD01 & m_OLD02 & m_OLD03 & m_OLD04 & "' "
   cnnConnection.Execute strSql
   
   ' 更新結餘資料
   strSql = "UPDATE ACC240 SET A240005 = '" & m_NEW01 & "', " & _
                              "A240006 = '" & m_NEW02 & "', " & _
                              "A240007 = '" & m_NEW03 & "', " & _
                              "A240008 = '" & m_NEW04 & "'  " & _
                  "WHERE A240005 = '" & m_OLD01 & "' AND " & _
                        "A240006 = '" & m_OLD02 & "' AND " & _
                        "A240007 = '" & m_OLD03 & "' AND " & _
                        "A240008 = '" & m_OLD04 & "' "
   cnnConnection.Execute strSql
   
   PUB_UpdOther = True
   Exit Function
ErrHand:
   MsgBox "錯誤 : " & Err.Description, vbCritical
End Function
'2005/4/19 END

'Add By Cheng 2002/09/09
'讀取TRADEMARK的資料
Public Function PUB_ReadTradeMarkData( _
   ByRef tm() As String, _
   ByVal strTM01 As String, _
   ByVal strTM02 As String, _
   ByVal strTM03 As String, _
   ByVal strTM04 As String) As Boolean

'tm():欲傳回的TradeMark欄位值
'strTM01,strTM02,strTM03,strTM04:TradeMark的PK值

   Dim StrSQLa As String
   Dim rsA As New ADODB.Recordset
   Dim ii As Integer
   
   StrSQLa = "SELECT * FROM TradeMark WHERE " & _
            ChgTradeMark(strTM01 & strTM02 & strTM03 & strTM04)
   rsA.CursorLocation = adUseClient
   rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
   If rsA.RecordCount > 0 Then
        'Modify By Cheng 2002/12/02
'      For ii = 0 To T_TM
      For ii = 0 To TF_TM - 1 'edit by nickc 2006/07/12 T_TM - 1
         tm(ii + 1) = IIf(IsNull(rsA.Fields(ii)), "", rsA.Fields(ii))
      Next ii
      PUB_ReadTradeMarkData = True
   Else
      PUB_ReadTradeMarkData = False
   End If
   If rsA.State <> adStateClosed Then rsA.Close
   Set rsA = Nothing
End Function

'Add By Cheng 2002/09/09
'新增商標基本檔的資料
Public Function PUB_AddNewTradeMark( _
   ByRef tm() As String) As Boolean

'tm():傳入欲新增TradeMark的欄位值

   Dim StrSQLa As String
   Dim ii As Integer
   
   On Error GoTo ErrorHandler
       
   PUB_AddNewTradeMark = False
    StrSQLa = ""
    For ii = 1 To TF_TM 'edit by nickc 2006/07/12 T_TM
        If ii < 100 Then
            StrSQLa = StrSQLa & "TM" & Format(ii, "00") & ","
        Else
            StrSQLa = StrSQLa & "TM" & Format(ii, "000") & ","
        End If
    Next ii
    StrSQLa = Left(StrSQLa, Len(StrSQLa) - 1)
   StrSQLa = "INSERT INTO TradeMark (" & StrSQLa & ") values ( "
   For ii = 0 To TF_TM - 1 'edit by nickc 2006/07/12  T_TM - 1
      StrSQLa = StrSQLa & CNULL(tm(ii + 1)) & ","
   Next ii
   StrSQLa = Left(StrSQLa, Len(StrSQLa) - 1)
   StrSQLa = StrSQLa & " )"
   cnnConnection.Execute StrSQLa
   PUB_AddNewTradeMark = True
   Exit Function
ErrorHandler:
   PUB_AddNewTradeMark = False
   MsgBox "(" & Err.Number & ")" & Err.Description, vbExclamation + vbOKOnly, "新增商標基本檔動作失敗"
End Function

'Add By Cheng 2002/09/09
'讀取ServicePractice的資料
Public Function PUB_ReadServicePracticeData( _
   ByRef sp() As String, _
   ByVal strSP01 As String, _
   ByVal strSP02 As String, _
   ByVal strSP03 As String, _
   ByVal strSP04 As String) As Boolean

'sp():欲傳回的ServicePractice欄位值
'strSP01,strSP02,strSP03,strSP04:ServicePractice的PK值

   Dim StrSQLa As String
   Dim rsA As New ADODB.Recordset
   Dim ii As Integer
   
   StrSQLa = "SELECT * FROM ServicePractice WHERE " & _
            ChgService(strSP01 & strSP02 & strSP03 & strSP04)
   rsA.CursorLocation = adUseClient
   rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
   If rsA.RecordCount > 0 Then
        'Modify By Cheng 2002/12/02
'      For ii = 0 To T_SP
      For ii = 0 To tf_SP - 1 'edit by nickc 2006/07/12 tf_sp-1 'edit by nickc 2006/07/12 T_SP - 1
         sp(ii + 1) = IIf(IsNull(rsA.Fields(ii)), "", rsA.Fields(ii))
      Next ii
      PUB_ReadServicePracticeData = True
   Else
      PUB_ReadServicePracticeData = False
   End If
   If rsA.State <> adStateClosed Then rsA.Close
   Set rsA = Nothing
End Function

'Add By Cheng 2002/09/09
'新增服務業務基本檔的資料
Public Function PUB_AddNewServicePractice( _
   ByRef sp() As String) As Boolean

'sp():傳入欲新增ServicePractice的欄位值

   Dim StrSQLa As String
   Dim ii As Integer
   'add by nick 2004/08/06 加入控制指定欄位
   Dim oStrSQL930806 As String
   
   On Error GoTo ErrorHandler
   
   'add by nick 2004/08/06
   oStrSQL930806 = "("
   For ii = 0 To tf_SP - 1 'edit by nickc 2006/07/12 tf_sp-1 'edit by nickc 2006/07/12 T_SP - 1
        'edit by nickc 2007/02/13
        'oStrSQL930806 = oStrSQL930806 & "SP" & Right("000" & Trim(ii + 1), 2) & ","
        oStrSQL930806 = oStrSQL930806 & "SP" & Format(ii + 1, "00") & ","
   Next ii
   oStrSQL930806 = Left(oStrSQL930806, Len(oStrSQL930806) - 1)
   oStrSQL930806 = oStrSQL930806 & ")"
   
   
   PUB_AddNewServicePractice = False
   'edit by nick 2004/08/06
   'strSQLA = "INSERT INTO ServicePractice  values ( "
   StrSQLa = "INSERT INTO ServicePractice " & oStrSQL930806 & " values ( "
   For ii = 0 To tf_SP - 1 'edit by nickc 2006/07/12 tf_sp-1 'edit by nickc 2006/07/12 T_SP - 1
      StrSQLa = StrSQLa & CNULL(sp(ii + 1)) & ","
   Next ii
   StrSQLa = Left(StrSQLa, Len(StrSQLa) - 1)
   StrSQLa = StrSQLa & " )"
   cnnConnection.Execute StrSQLa
   PUB_AddNewServicePractice = True
   Exit Function
ErrorHandler:
   PUB_AddNewServicePractice = False
   MsgBox "(" & Err.Number & ")" & Err.Description, vbExclamation + vbOKOnly, "新增服務業務基本檔動作失敗"
End Function

'Add By Cheng 2002/09/09
'新增專利基本檔的資料
Public Function PUB_AddNewPatent( _
   ByRef pa() As String) As Boolean

'pa():傳入欲新增Patent的欄位值

   Dim StrSQLa As String
   Dim ii As Integer
   
   On Error GoTo ErrorHandler
   
   PUB_AddNewPatent = False
    StrSQLa = ""
    For ii = 1 To TF_PA 'edit by nickc 2006/07/12 T_PA
        If ii < 100 Then
            StrSQLa = StrSQLa & "PA" & Format(ii, "00") & ","
        Else
            StrSQLa = StrSQLa & "PA" & Format(ii, "000") & ","
        End If
    Next ii
    StrSQLa = Left(StrSQLa, Len(StrSQLa) - 1)
   StrSQLa = "INSERT INTO Patent(" & StrSQLa & ") values ( "
   For ii = 0 To TF_PA - 1 'edit by nickc 2006/07/12 T_PA - 1
      StrSQLa = StrSQLa & CNULL(pa(ii + 1)) & ","
   Next ii
   StrSQLa = Left(StrSQLa, Len(StrSQLa) - 1)
   StrSQLa = StrSQLa & " )"
   cnnConnection.Execute StrSQLa
   PUB_AddNewPatent = True
   Exit Function
ErrorHandler:
   PUB_AddNewPatent = False
   MsgBox "(" & Err.Number & ")" & Err.Description, vbExclamation + vbOKOnly, "新增專利基本檔動作失敗"
End Function

'Add By Cheng 2002/09/09
'讀取Patent的資料
Public Function PUB_ReadPatentData( _
   ByRef pa() As String, _
   ByVal strPA01 As String, _
   ByVal strPA02 As String, _
   ByVal strPA03 As String, _
   ByVal strPA04 As String) As Boolean

'pa():欲傳回的Patent欄位值
'strPA01,strPA02,strPA03,strPA04:Patent的PK值

   Dim StrSQLa As String
   Dim rsA As New ADODB.Recordset
   Dim ii As Integer
   
   StrSQLa = "SELECT * FROM Patent WHERE " & _
            ChgPatent(strPA01 & strPA02 & strPA03 & strPA04)
   rsA.CursorLocation = adUseClient
   rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
   If rsA.RecordCount > 0 Then
        'Modify By Cheng 2002/12/02
'      For ii = 0 To T_PA
      For ii = 0 To TF_PA - 1 'edit by nickc 2006/07/12 T_PA - 1
         pa(ii + 1) = IIf(IsNull(rsA.Fields(ii)), "", rsA.Fields(ii))
      Next ii
      PUB_ReadPatentData = True
   Else
      PUB_ReadPatentData = False
   End If
   If rsA.State <> adStateClosed Then rsA.Close
   Set rsA = Nothing
End Function

'Add By Cheng 2002/09/09
'讀取HireCase的資料
Public Function PUB_ReadHireCaseData( _
   ByRef hc() As String, _
   ByVal strHC01 As String, _
   ByVal strHC02 As String, _
   ByVal strHC03 As String, _
   ByVal strHC04 As String) As Boolean

'hc():欲傳回的HireCase欄位值
'strHC01,strHC02,strHC03,strHC04:HireCase的PK值

   Dim StrSQLa As String
   Dim rsA As New ADODB.Recordset
   Dim ii As Integer
   
   StrSQLa = "SELECT * FROM HireCase WHERE " & _
            ChgHirecase(strHC01 & strHC02 & strHC03 & strHC04)
   rsA.CursorLocation = adUseClient
   rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
   If rsA.RecordCount > 0 Then
        'Modify By Cheng 2002/12/02
'      For ii = 0 To T_PA
      For ii = 0 To TF_HC - 1 'edit by nickc 2006/07/12 T_PA - 1
         hc(ii + 1) = IIf(IsNull(rsA.Fields(ii)), "", rsA.Fields(ii))
      Next ii
      PUB_ReadHireCaseData = True
   Else
      PUB_ReadHireCaseData = False
   End If
   If rsA.State <> adStateClosed Then rsA.Close
   Set rsA = Nothing
End Function

'Add By Cheng 2002/09/09
'新增顧問基本檔的資料
Public Function PUB_AddNewHireCase( _
   ByRef hc() As String) As Boolean

'hc():傳入欲新增HireCase的欄位值

   Dim StrSQLa As String
   Dim ii As Integer
   'add by nick 2004/08/06 加入控制指定欄位
   Dim oStrSQL930806 As String
   
   On Error GoTo ErrorHandler
   
   'add by nick 2004/08/06
   oStrSQL930806 = "("
   For ii = 0 To TF_HC - 1 'edit by nickc 2006/07/12 T_HC - 1
        'edit by nickc 2007/02/13
        'oStrSQL930806 = oStrSQL930806 & "HC" & Right("000" & Trim(ii + 1), 2) & ","
        oStrSQL930806 = oStrSQL930806 & "HC" & Format(ii + 1, "00") & ","
   Next ii
   oStrSQL930806 = Left(oStrSQL930806, Len(oStrSQL930806) - 1)
   oStrSQL930806 = oStrSQL930806 & ")"
   
   PUB_AddNewHireCase = False
   'edit by nick 2004/08/06
   'strSQLA = "INSERT INTO HireCase values ( "
   StrSQLa = "INSERT INTO HireCase " & oStrSQL930806 & " values ( "
   For ii = 0 To TF_HC - 1 'edit by nickc 2006/07/12 T_HC - 1
      StrSQLa = StrSQLa & CNULL(hc(ii + 1)) & ","
   Next ii
   StrSQLa = Left(StrSQLa, Len(StrSQLa) - 1)
   StrSQLa = StrSQLa & " )"
   cnnConnection.Execute StrSQLa
   PUB_AddNewHireCase = True
   Exit Function
ErrorHandler:
   PUB_AddNewHireCase = False
   MsgBox "(" & Err.Number & ")" & Err.Description, vbExclamation + vbOKOnly, "新增顧問基本檔動作失敗"
End Function

'Add By Cheng 2002/09/09
'讀取LawCase的資料
Public Function PUB_ReadLawCaseData( _
   ByRef lC() As String, _
   ByVal strLC01 As String, _
   ByVal strLC02 As String, _
   ByVal strLC03 As String, _
   ByVal strLC04 As String) As Boolean

'lc():欲傳回的LawCase欄位值
'strLC01,strLC02,strLC03,strLC04:LawCase的PK值

   Dim StrSQLa As String
   Dim rsA As New ADODB.Recordset
   Dim ii As Integer
   
   StrSQLa = "SELECT * FROM LawCase WHERE " & _
            ChgLawcase(strLC01 & strLC02 & strLC03 & strLC04)
   rsA.CursorLocation = adUseClient
   rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
   If rsA.RecordCount > 0 Then
        'Modify By Cheng 2002/12/02
'      For ii = 0 To T_LC
      For ii = 0 To TF_LC - 1 'edit by nickc 2006/07/12 T_LC - 1
         lC(ii + 1) = IIf(IsNull(rsA.Fields(ii)), "", rsA.Fields(ii))
      Next ii
      PUB_ReadLawCaseData = True
   Else
      PUB_ReadLawCaseData = False
   End If
   If rsA.State <> adStateClosed Then rsA.Close
   Set rsA = Nothing
End Function

'Add By Cheng 2002/09/09
'新增顧問基本檔的資料
Public Function PUB_AddNewLawCase( _
   ByRef lC() As String) As Boolean

'lc():傳入欲新增LawCase的欄位值

   Dim StrSQLa As String
   Dim ii As Integer
   'add by nick 2004/08/06 加入控制指定欄位
   Dim oStrSQL930806 As String
   
   On Error GoTo ErrorHandler
   
   'add by nick 2004/08/06
   oStrSQL930806 = "("
   For ii = 0 To TF_LC - 1 'edit by nickc 2006/07/12 T_LC - 1
        'edit by nickc 2007/02/13
        'oStrSQL930806 = oStrSQL930806 & "LC" & Right("000" & Trim(ii + 1), 2) & ","
        oStrSQL930806 = oStrSQL930806 & "LC" & Format(ii + 1, "00") & ","
   Next ii
   oStrSQL930806 = Left(oStrSQL930806, Len(oStrSQL930806) - 1)
   oStrSQL930806 = oStrSQL930806 & ")"
   
   PUB_AddNewLawCase = False
   'edit by nick 2004/08/06
   'strSQLA = "INSERT INTO LawCase values ( "
   StrSQLa = "INSERT INTO LawCase " & oStrSQL930806 & " values ( "
   For ii = 0 To TF_LC - 1 'edit by  nickc 2006/07/12  T_LC - 1
      StrSQLa = StrSQLa & CNULL(lC(ii + 1)) & ","
   Next ii
   StrSQLa = Left(StrSQLa, Len(StrSQLa) - 1)
   StrSQLa = StrSQLa & " )"
   cnnConnection.Execute StrSQLa
   PUB_AddNewLawCase = True
   Exit Function
ErrorHandler:
   PUB_AddNewLawCase = False
   MsgBox "(" & Err.Number & ")" & Err.Description, vbExclamation + vbOKOnly, "新增法律基本檔動作失敗"
End Function

'Add By Cheng 2002/10/02
'取得國家英文名稱
Public Function PUB_GetNationEngName(ByVal strNA01 As String) As String
Dim rsA As New ADODB.Recordset
Dim StrSQLa As String

   StrSQLa = "Select NA04 From NATION WHERE NA01='" & strNA01 & "'"
   If rsA.State <> adStateClosed Then rsA.Close
   Set rsA = Nothing
   rsA.CursorLocation = adUseClient
   rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
   If rsA.RecordCount > 0 Then
      PUB_GetNationEngName = "" & rsA.Fields(0).Value
   Else
      PUB_GetNationEngName = ""
   End If
   If rsA.State <> adStateClosed Then rsA.Close
   Set rsA = Nothing
End Function

'Add By Cheng 2002/10/25
'取得第幾年至第幾年的服務費
'Public Function PUB_GetYF06(strYF01 As String, strYF02 As String, strYF03 As String, strYF04 As String, strYF05From As String, strYF05To As String) As String
'Modified by Lydia 2015/01/15 增加年費報價(不限國別)
Public Function PUB_GetYF06(strYF01 As String, strYF02 As String, strYF03 As String, strYF04 As String, strYF05From As String, strYF05To As String, Optional ByVal PAgent As String) As String
'strYF01 : 申請國家
'strYF02 : 專利種類
'strYF03 : 代理人
'strYF04 : 案件性質
'strYF05From : 年度(起)
'strYF05To : 年度(迄)

Dim StrSQLa As String
Dim rsA As New ADODB.Recordset
Dim strYF03New As String

strYF03New = strYF03

'Add by Morgan 2010/4/9
'客戶考慮更名問題,一律抓0編號
If Left(strYF03, 1) = "X" Then
   strYF03New = Left(strYF03, 8) & "0"
End If

PUB_GetYF06 = "0"
'Modified by Lydia 2015/01/15
'StrSQLa = "Select SUM(nvl(YF06,0)) From PatentYearFee Where YF01='" & strYF01 & "' AND YF02='" & strYF02 & "' AND YF03='" & strYF03New & "' AND YF04='" & strYF04 & "' AND YF05 >= " & Val(strYF05From) & " AND YF05 <= " & Val(strYF05To)
'If rsA.State <> adStateClosed Then rsA.Close
'Set rsA = Nothing
'rsA.CursorLocation = adUseClient
'rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
'If rsA.RecordCount > 0 Then
'   PUB_GetYF06 = "" & rsA.Fields(0).Value
'End If
'Added by Lydia 2015/03/27 +系統別,改用共用變數
'If PAgent = "1" Then
'   PAgent = "Y00000001" 'P案
'Else
'   PAgent = "Y00000000" '非P案
'End If
If PAgent = "1" Or PAgent = "P" Then
   PAgent = YF0607PAgent1 'P案
Else
   PAgent = YF0607PAgent2 '非P案
End If

'Modified by Lydia 2023/10/02 加入專利年費特殊設定檔PatentYearSpec
'StrSQLa = "Select 0 od1,count(*) cnt, SUM(nvl(YF06,0)) YF06 From PatentYearFee Where YF01='" & strYF01 & "' AND YF02='" & strYF02 & "' AND YF03='" & strYF03New & "' AND YF04='" & strYF04 & "' AND YF05 >= " & Val(strYF05From) & " AND YF05 <= " & Val(strYF05To) & _
          " union " & _
          "Select 1 od1,count(*) cnt, SUM(nvl(YF06,0)) YF06 From PatentYearFee Where YF01='" & strYF01 & "' AND YF02='" & strYF02 & "' AND YF03='" & PAgent & "' AND YF04='" & strYF04 & "' AND YF05 >= " & Val(strYF05From) & " AND YF05 <= " & Val(strYF05To) & _
          " order by od1"
StrSQLa = " SELECT 0 OD1,DECODE(YS07,NULL,0,1) CNT, YS07 AS YF06 FROM PATENTYEARSPEC WHERE YS01='" & strYF01 & "' AND YS02='" & strYF02 & "' AND YS03='" & strYF03New & "' AND YS04='" & strYF04 & "' AND YS05 = " & Val(strYF05From) & " AND YS06 = " & Val(strYF05To) & _
          " Union Select 1 od1,count(*) cnt, SUM(nvl(YF06,0)) YF06 From PatentYearFee Where YF01='" & strYF01 & "' AND YF02='" & strYF02 & "' AND YF03='" & strYF03New & "' AND YF04='" & strYF04 & "' AND YF05 >= " & Val(strYF05From) & " AND YF05 <= " & Val(strYF05To) & _
          " Union Select 2 od1,count(*) cnt, SUM(nvl(YF06,0)) YF06 From PatentYearFee Where YF01='" & strYF01 & "' AND YF02='" & strYF02 & "' AND YF03='" & PAgent & "' AND YF04='" & strYF04 & "' AND YF05 >= " & Val(strYF05From) & " AND YF05 <= " & Val(strYF05To)
StrSQLa = "select * from (" & StrSQLa & ") where cnt > 0 order by od1"
'end 2023/10/02
If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing
rsA.CursorLocation = adUseClient
rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
If rsA.RecordCount > 0 Then
   rsA.MoveFirst
   Do While Not rsA.EOF
      If rsA.Fields("cnt") > 0 Then
         PUB_GetYF06 = "" & rsA.Fields("YF06")
         If Val(PUB_GetYF06) > 0 Then Exit Do
      End If
      rsA.MoveNext
   Loop
End If

If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing
If PUB_GetYF06 = "" Then PUB_GetYF06 = "0"

End Function

'Add By Cheng 2002/10/24
'取得第幾年至第幾年的規費
'Public Function PUB_GetYF07(strYF01 As String, strYF02 As String, strYF03 As String, strYF04 As String, strYF05From As String, strYF05To As String) As String
'Modified by Lydia 2015/01/15 增加年費報價(不限國別)
'Modified by Lydia 2024/04/30 是否不含特殊設定bolNotSpec
Public Function PUB_GetYF07(strYF01 As String, strYF02 As String, strYF03 As String, strYF04 As String, strYF05From As String, strYF05To As String, Optional ByVal PAgent As String, Optional bolNotSpec As Boolean) As String
'strYF01 : 申請國家
'strYF02 : 專利種類
'strYF03 : 代理人
'strYF04 : 案件性質
'strYF05From : 年度(起)
'strYF05To : 年度(迄)

Dim StrSQLa As String
Dim rsA As New ADODB.Recordset
Dim strYF03New As String

strYF03New = strYF03

'Add by Morgan 2010/4/9
'客戶考慮更名問題,一律抓0編號
If Left(strYF03, 1) = "X" Then
   strYF03New = Left(strYF03, 8) & "0"
End If

PUB_GetYF07 = "0"
'Modified by Lydia 2015/01/15
'StrSQLa = "Select SUM(nvl(YF07,0)) From PatentYearFee Where YF01='" & strYF01 & "' AND YF02='" & strYF02 & "' AND YF03='" & strYF03New & "' AND YF04='" & strYF04 & "' AND YF05 >= " & Val(strYF05From) & " AND YF05 <= " & Val(strYF05To)
'If rsA.State <> adStateClosed Then rsA.Close
'Set rsA = Nothing
'rsA.CursorLocation = adUseClient
'rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
'If rsA.RecordCount > 0 Then
'   PUB_GetYF07 = "" & rsA.Fields(0).Value
'End If
'Added by Lydia 2015/03/27 +系統別,改用共用變數
'If PAgent = "1" Then
'   PAgent = "Y00000001" 'P案
'Else
'   PAgent = "Y00000000" '非P案
'End If
If PAgent = "1" Or PAgent = "P" Then
   PAgent = YF0607PAgent1 'P案
Else
   PAgent = YF0607PAgent2 '非P案
End If

'Modified by Lydia 2023/10/02 加入專利年費特殊設定檔PatentYearSpec
'StrSQLa = "Select 0 od1,count(*) cnt, SUM(nvl(YF07,0)) YF07 From PatentYearFee Where YF01='" & strYF01 & "' AND YF02='" & strYF02 & "' AND YF03='" & strYF03New & "' AND YF04='" & strYF04 & "' AND YF05 >= " & Val(strYF05From) & " AND YF05 <= " & Val(strYF05To) & _
          " union " & _
          "Select 1 od1,count(*) cnt, SUM(nvl(YF07,0)) YF07 From PatentYearFee Where YF01='" & strYF01 & "' AND YF02='" & strYF02 & "' AND YF03='" & PAgent & "' AND YF04='" & strYF04 & "' AND YF05 >= " & Val(strYF05From) & " AND YF05 <= " & Val(strYF05To) & _
          " order by od1"
'Modified by Lydia 2024/04/30
'StrSQLa = " SELECT 0 OD1,DECODE(YS08,NULL,0,1) CNT, YS08 AS YF07 FROM PATENTYEARSPEC WHERE YS01='" & strYF01 & "' AND YS02='" & strYF02 & "' AND YS03='" & strYF03New & "' AND YS04='" & strYF04 & "' AND YS05 = " & Val(strYF05From) & " AND YS06 = " & Val(strYF05To) & _
          " Union Select 1 od1,count(*) cnt, SUM(nvl(YF07,0)) YF07 From PatentYearFee Where YF01='" & strYF01 & "' AND YF02='" & strYF02 & "' AND YF03='" & strYF03New & "' AND YF04='" & strYF04 & "' AND YF05 >= " & Val(strYF05From) & " AND YF05 <= " & Val(strYF05To) & _
          " Union Select 2 od1,count(*) cnt, SUM(nvl(YF07,0)) YF07 From PatentYearFee Where YF01='" & strYF01 & "' AND YF02='" & strYF02 & "' AND YF03='" & PAgent & "' AND YF04='" & strYF04 & "' AND YF05 >= " & Val(strYF05From) & " AND YF05 <= " & Val(strYF05To)
StrSQLa = ""
If bolNotSpec = False Then
   StrSQLa = " Union SELECT 0 OD1,DECODE(YS08,NULL,0,1) CNT, YS08 AS YF07 FROM PATENTYEARSPEC WHERE YS01='" & strYF01 & "' AND YS02='" & strYF02 & "' AND YS03='" & strYF03New & "' AND YS04='" & strYF04 & "' AND YS05 = " & Val(strYF05From) & " AND YS06 = " & Val(strYF05To)
End If
StrSQLa = StrSQLa & " Union Select 1 od1,count(*) cnt, SUM(nvl(YF07,0)) YF07 From PatentYearFee Where YF01='" & strYF01 & "' AND YF02='" & strYF02 & "' AND YF03='" & strYF03New & "' AND YF04='" & strYF04 & "' AND YF05 >= " & Val(strYF05From) & " AND YF05 <= " & Val(strYF05To) & _
          " Union Select 2 od1,count(*) cnt, SUM(nvl(YF07,0)) YF07 From PatentYearFee Where YF01='" & strYF01 & "' AND YF02='" & strYF02 & "' AND YF03='" & PAgent & "' AND YF04='" & strYF04 & "' AND YF05 >= " & Val(strYF05From) & " AND YF05 <= " & Val(strYF05To)
StrSQLa = Mid(StrSQLa, 7)
'end 2024/04/30
StrSQLa = "select * from (" & StrSQLa & ") where cnt > 0 order by od1"
'end 2023/10/02
If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing
rsA.CursorLocation = adUseClient
rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
If rsA.RecordCount > 0 Then
   rsA.MoveFirst
   Do While Not rsA.EOF
      If rsA.Fields("cnt") > 0 Then
         PUB_GetYF07 = "" & rsA.Fields("YF07")
         If Val(PUB_GetYF07) > 0 Then Exit Do
      End If
      rsA.MoveNext
   Loop
End If

If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing
If PUB_GetYF07 = "" Then PUB_GetYF07 = "0"

End Function

'Add By Cheng 2002/10/24
'取得第幾年至第幾年的費用(服務費+規費)
Public Function PUB_GetYF0607(strYF01 As String, strYF02 As String, strYF03 As String, strYF04 As String, strYF05From As String, strYF05To As String, Optional ByVal PAgent As String, Optional strYF06 As String, Optional strYF07 As String) As String
'strYF01 : 申請國家
'strYF02 : 專利種類
'strYF03 : 代理人
'strYF04 : 案件性質
'strYF05From : 年度(起)
'strYF05To : 年度(迄)
'Modified by Lydia 2015/01/07 配合大陸年費維護,分別傳回服務費和規費
'strYF06 :服務費
'strYF07 :規費
'PAgent:預設代理人
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset
Dim strYF03New As String

strYF03New = strYF03

'Add by Morgan 2010/4/9
'客戶考慮更名問題,一律抓0編號
If Left(strYF03, 1) = "X" Then
   strYF03New = Left(strYF03, 8) & "0"
End If

PUB_GetYF0607 = "0"
'Modified by Lydia 2015/01/07 配合大陸年費維護,分別傳回服務費和規費
'StrSQLa = "Select SUM(nvl(YF06,0) + nvl(YF07,0)) From PatentYearFee Where YF01='" & strYF01 & "' AND YF02='" & strYF02 & "' AND YF03='" & strYF03New & "' AND YF04='" & strYF04 & "' AND YF05 >= " & Val(strYF05From) & " AND YF05 <= " & Val(strYF05To)
'If rsA.State <> adStateClosed Then rsA.Close
'Set rsA = Nothing
'rsA.CursorLocation = adUseClient
'rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
'If rsA.RecordCount > 0 Then
'   PUB_GetYF0607 = "" & rsA.Fields(0).Value
'End If
'Added by Lydia 2015/03/27 +系統別,改用共用變數
'If PAgent = "1" Then
'   PAgent = "Y00000001" 'P案
'Else
'   PAgent = "Y00000000" '非P案
'End If
If PAgent = "1" Or PAgent = "P" Then
   PAgent = YF0607PAgent1 'P案
Else
   PAgent = YF0607PAgent2 '非P案
End If

'Modified by Lydia 2023/10/02 加入專利年費特殊設定檔PatentYearSpec
'StrSQLa = "Select 0 od1,count(*) cnt,nvl(SUM(nvl(YF06,0)),0) YF06,nvl(SUM(nvl(YF07,0)),0) YF07,nvl(SUM(nvl(YF06,0) + nvl(YF07,0)),0) YF0607 From PatentYearFee " & _
          "Where YF01='" & strYF01 & "' AND YF02='" & strYF02 & "' AND YF03='" & strYF03New & "' AND YF04='" & strYF04 & "' AND YF05 >= " & Val(strYF05From) & " AND YF05 <= " & Val(strYF05To) & _
          " union " & _
          "Select 1 od1,count(*) cnt,nvl(SUM(nvl(YF06,0)),0) YF06,nvl(SUM(nvl(YF07,0)),0) YF07,nvl(SUM(nvl(YF06,0) + nvl(YF07,0)),0) YF0607 From PatentYearFee " & _
          "Where YF01='" & strYF01 & "' AND YF02='" & strYF02 & "' AND YF03='" & PAgent & "' AND YF04='" & strYF04 & "' AND YF05 >= " & Val(strYF05From) & " AND YF05 <= " & Val(strYF05To) & _
          " order by od1"
StrSQLa = " SELECT 0 OD1,DECODE(YS07,NULL,0,1) CNT, YS07 AS YF06, YS08 AS YF07, NVL(YS07,0)+NVL(YS08,0) AS YF0607 FROM PATENTYEARSPEC " & _
          " WHERE YS01='" & strYF01 & "' AND YS02='" & strYF02 & "' AND YS03='" & strYF03New & "' AND YS04='" & strYF04 & "' AND YS05 = " & Val(strYF05From) & " AND YS06 = " & Val(strYF05To) & _
          " union Select 1 od1,count(*) cnt,nvl(SUM(nvl(YF06,0)),0) YF06,nvl(SUM(nvl(YF07,0)),0) YF07,nvl(SUM(nvl(YF06,0) + nvl(YF07,0)),0) YF0607 From PatentYearFee " & _
          " Where YF01='" & strYF01 & "' AND YF02='" & strYF02 & "' AND YF03='" & strYF03New & "' AND YF04='" & strYF04 & "' AND YF05 >= " & Val(strYF05From) & " AND YF05 <= " & Val(strYF05To) & _
          " union Select 2 od1,count(*) cnt,nvl(SUM(nvl(YF06,0)),0) YF06,nvl(SUM(nvl(YF07,0)),0) YF07,nvl(SUM(nvl(YF06,0) + nvl(YF07,0)),0) YF0607 From PatentYearFee " & _
          " Where YF01='" & strYF01 & "' AND YF02='" & strYF02 & "' AND YF03='" & PAgent & "' AND YF04='" & strYF04 & "' AND YF05 >= " & Val(strYF05From) & " AND YF05 <= " & Val(strYF05To)
StrSQLa = "select * from (" & StrSQLa & ") where cnt > 0 order by od1"
'end 2023/10/02
If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing
rsA.CursorLocation = adUseClient
rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
If rsA.RecordCount > 0 Then
   rsA.MoveFirst
   Do While Not rsA.EOF
      If rsA.Fields("cnt") > 0 Then
         strYF06 = "" & rsA.Fields("YF06")
         strYF07 = "" & rsA.Fields("YF07")
         PUB_GetYF0607 = "" & rsA.Fields("YF0607")
         If Val(PUB_GetYF0607) > 0 Then Exit Do
      End If
      rsA.MoveNext
   Loop
End If
If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing
If PUB_GetYF0607 = "" Then PUB_GetYF0607 = "0": strYF06 = "0": strYF07 = "0"

End Function

'Add By Cheng 2002/10/31
'新增國外帳單資料
'Modify by Morgan 2008/5/13 +strNA52 可傳入
'Modify by Morgan 2009/10/2 +bShowMsg 錯誤訊息是否顯示,預設 True:顯示
Public Function PUB_AddNewFBillData(strCP09 As String, strDnNo As String, strBillDate As String, strBillAmount, ByRef strBillNo As String, Optional ByVal strNA52 As String, Optional bShowMsg As Boolean = True) As Boolean
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset
Dim strCP44 As String
'Dim strNA52 As String
Dim strA1501 As String
Dim strCP0104 As String
Dim strPA26 As String
Dim strPA0507 As String
Dim strPA161 As String    'ADD BY SONIA 2014/4/8
Dim strCP60 As String
Dim strA0K04 As String
Dim strAXF15 As String
Dim lngEff As Long
    
    On Error GoTo ErrorHandler
    strBillNo = ""
    PUB_AddNewFBillData = False
    strA1501 = AutoNo(MsgText(812), 5)
    strBillNo = "" & strA1501
    
    strPA161 = ""    'ADD BY SONIA 2014/4/8
    StrSQLa = "Select * From CaseProgress,Patent ,Nation Where CP01=PA01(+) AND CP02=PA02(+) AND CP03=PA03(+) AND CP04=PA04(+) AND PA09=NA01(+) AND CP09='" & strCP09 & "' "
    If rsA.State <> adStateClosed Then rsA.Close
    Set rsA = Nothing
    rsA.CursorLocation = adUseClient
    rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
    If rsA.RecordCount > 0 Then
        strCP44 = "" & rsA("CP44").Value
        'Add by Morgan 2006/4/26 原由Trigger控制
        If strCP44 = "Y51469000" Then
            strCP44 = "Y51566000"
        End If
        '2006/4/26 end
        'Modify by Morgan 2008/5/13
        'strNA52 = "" & rsA("NA52").Value
        'Add By Sindy 2012/6/5 改為先抓該代理人是否有設定帳單幣別,若有,則抓代理人的帳單幣別,若沒有才抓NA52
        If strCP44 <> "" Then
            strSql = "select fa113 from fagent where fa01 = '" & Mid(strCP44, 1, 8) & "' and fa02 = '" & Mid(strCP44, 9, 1) & "'"
            intI = 1
            Set AdoRecordSet3 = ClsLawReadRstMsg(intI, strSql)
            If intI = 1 Then
               If IsNull(AdoRecordSet3("fa113")) = False Then
                  strNA52 = AdoRecordSet3("fa113")
               End If
            End If
        End If
        '2012/6/5 End
        If strNA52 = "" Then
            strNA52 = "" & rsA("NA52").Value
        End If
        'end 2008/5/13
        strCP0104 = "" & rsA("CP01").Value & rsA("CP02").Value & rsA("CP03").Value & rsA("CP04").Value
        strPA26 = "" & rsA("PA26").Value
        strPA0507 = IIf("" & rsA("PA05").Value <> "", rsA("PA05").Value, IIf("" & rsA("PA06").Value <> "", rsA("PA06"), "" & rsA("PA07").Value))
        strCP60 = "" & rsA("CP60").Value
        strPA161 = "" & rsA("PA161").Value             'ADD BY SONIA 2014/4/8
    Else
        If rsA.State <> adStateClosed Then rsA.Close
        Set rsA = Nothing
        If bShowMsg Then
            MsgBox "無新增國外帳單的所需相關基本資料!!!", vbExclamation + vbOKOnly
        End If
        PUB_AddNewFBillData = False
        Exit Function
    End If
    If rsA.State <> adStateClosed Then rsA.Close
    Set rsA = Nothing
    
    StrSQLa = "Select A0K04 From ACC0K0 Where A0K01 = '" & strCP09 & "'"
    rsA.CursorLocation = adUseClient
    rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
    If rsA.RecordCount > 0 Then
        strA0K04 = "" & rsA("A0K04").Value
    Else
        strA0K04 = ""
    End If
    If rsA.State <> adStateClosed Then rsA.Close
    Set rsA = Nothing
    
    'Modify By Cheng 2002/11/05
'    strSQLA = "Select A2103 From ACC210 Where A2101 = " & ServerDate & " AND A2102 = '" & strNA52 & "' "
    'Modify By Cheng 2003/04/18
    '抓預估匯率時應抓不大於系統日且最近系統日的匯率, 若無則匯率預設為1
'    strSQLA = "Select A2103 From ACC210 Where A2101 = " & ServerDate - 19110000 & " AND A2102 = '" & strNA52 & "' "
    StrSQLa = "Select A2103 From ACC210 Where A2101 <= " & strSrvDate(2) & " AND A2102 = '" & strNA52 & "' Order By A2101 Desc "
    rsA.CursorLocation = adUseClient
    rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
    If rsA.RecordCount > 0 Then
        'Modify By Cheng 2003/04/18
'        strAXF15 = Format(strBillAmount * Val("" & rsA("A2103").Value), "##0")
        strAXF15 = Format(strBillAmount * Val("" & rsA("A2103").Value), "##0.00")
    Else
        'Modify By Cheng 2003/04/18
'        strAXF15 = 0
'        strAXF15 = Format(strBillAmount * 1, "##0")
        strAXF15 = Format(strBillAmount * 1, "##0.00")
    End If
    If rsA.State <> adStateClosed Then rsA.Close
    Set rsA = Nothing
    'Modify By Cheng 2002/11/05
'    strSQLA = "INSERT INTO ACC150 (A1501,A1502,A1503,A1504,A1505,A1506) values ('" & strA1501 & "'," & DBDATE(strBillDate) & ",'" & strCP44 & "','" & strDNNO & "','" & strNA52 & "'," & Val(strBillAmount) & " )"
    'Modify By Cheng 2002/11/26
'    strSQLA = "INSERT INTO ACC150 (A1501,A1502,A1503,A1504,A1505,A1506) values ('" & strA1501 & "'," & DBDATE(strBillDate) - 19110000 & ",'" & strCP44 & "','" & strDNNO & "','" & strNA52 & "'," & Val(strBillAmount) & " )"
    StrSQLa = "INSERT INTO ACC150 (A1501,A1502,A1503,A1504,A1505,A1506,A1514,A1515,A1516,A1520) values ('" & strA1501 & "'," & DBDATE(strBillDate) - 19110000 & ",'" & strCP44 & "','" & strDnNo & "','" & strNA52 & "'," & Val(strBillAmount) & "," & strSrvDate(2) & "," & ServerTime & ",'" & strUserNum & "',0 )"
    cnnConnection.Execute StrSQLa
    'Modify By Cheng 2002/11/26
'    strSQLA = "INSERT INTO ACC151 (AXF01,AXF02,AXF03,AXF04,AXF05,AXF12,AXF13,AXF15) " & _
'                        " VALUES ( '" & strA1501 & "','" & strCP09 & "','" & strCP0104 & "'," & Val(strBillAmount) & ",'" & strPA26 & "','" & strPA0507 & "','" & strA0K04 & "'," & Val(strAXF15) & " ) "
    StrSQLa = "INSERT INTO ACC151 (AXF01,AXF02,AXF03,AXF04,AXF05,AXF12,AXF13,AXF15,AXF06,AXF07,AXF08) " & _
                        " VALUES ( '" & strA1501 & "','" & strCP09 & "','" & strCP0104 & "'," & Val(strBillAmount) & ",'" & strPA26 & "','" & strPA0507 & "','" & strA0K04 & "'," & Val(strAXF15) & "," & strSrvDate(2) & "," & ServerTime & ",'" & strUserNum & "' ) "
    cnnConnection.Execute StrSQLa
    'Add By Cheng 2002/11/26
    'Modify by Morgan 2005/8/25 判斷若cp61有值則更新cp62,cp62...cp63,cp63...cp87,cp87...cp88,cp88...none
    'StrSQLa = "Update CaseProgress Set CP61 = '" & strA1501 & "' Where CP09='" & strCP09 & "' "
    StrSQLa = "Update CaseProgress Set CP61 = '" & strA1501 & "' Where CP09='" & strCP09 & "' and CP61 IS NULL"
    cnnConnection.Execute StrSQLa, lngEff
    If lngEff = 0 Then
      StrSQLa = "Update CaseProgress Set CP62 = '" & strA1501 & "' Where CP09='" & strCP09 & "' and CP62 IS NULL"
      cnnConnection.Execute StrSQLa, lngEff
      If lngEff = 0 Then
        StrSQLa = "Update CaseProgress Set CP63 = '" & strA1501 & "' Where CP09='" & strCP09 & "' and CP63 IS NULL"
        cnnConnection.Execute StrSQLa, lngEff
        If lngEff = 0 Then
           StrSQLa = "Update CaseProgress Set CP87 = '" & strA1501 & "' Where CP09='" & strCP09 & "' and CP87 IS NULL"
           cnnConnection.Execute StrSQLa, lngEff
           If lngEff = 0 Then
              StrSQLa = "Update CaseProgress Set CP88 = '" & strA1501 & "' Where CP09='" & strCP09 & "' and CP88 IS NULL"
              cnnConnection.Execute StrSQLa, lngEff
            End If
         End If
      End If
    End If
    
    PUB_AddNewFBillData = True
    
   'ADD BY SONIA 2014/4/2 顏永堅3/25郵件所列大學及其關係企業都要彈訊息提醒操作人員
   'Modified by Lydia 2016/03/18 王副總的華碩客戶(X69011)
   'modify by sonia 2017/4/10 婉莘要求加X69534彩豐精技  2017/5/15陳德發及郭雅娟要求取消
   'modify by sonia 2017/4/14 王副總的華碩客戶(X69011010)移到下面,因為只有X6901101(母號不要)
   'modify by sonia 2017/4/27 高國碩要求X60149改為只要母號,關係企業不要,'modify by sonia 2017/10/11 張詠翔要求取消X6014900
   Select Case Left(strPA26, 6)
      Case "X44551", "X62079", "X43988", "X63219", "X60498", "X62319", "X62702", "X63838"
         MsgBox "客戶為 " & strPA26 & GetCustomerName(strPA26) & " , 請影印代理人帳單交客戶 !", , MsgText(5)
      Case Else
   End Select
   '2014/4/2 END
   
   'add by sonia 2017/4/14 單獨編號而關係企業不要的
   Select Case Left(strPA26, 8)
      'modify by sonia 2017/4/27 高國碩要求X60149改為只要母號,關係企業不要
      'modify by sonia 2017/10/11 張詠翔要求取消X6014900
      'modify by sonia 2017/10/26 郭雅娟要求加X60738010國立清華大學
      'modify by sonia 2020/7/20 茹曣加X79919000
      'modify by sonia 2020/11/24 魏裕仁加X43714050  '2021/1/5取消   '2021/4/19再次加入
      'modify by sonia 2021/3/17 顧服組黃教威加5編號X69365010(長庚醫療財團法人嘉義長庚紀念醫院),X54243070(國立台灣大學),X80847020(財團法人國家實驗研究院),X83983000(盧彥蓓),X83984000(林致廷)
      'modify by sonia 2021/9/28 顧服組的客戶X38805030資策會--郭雅娟
      'Modified by Morgan 2024/5/16 補+X69365000、X69365020、X69365050、X69365060、X69365070、X69365080--黃教威
      'Modified by Morgan 2024/5/16 +X82532010、X82504030、X82504040、X69365110、X69365090、X87287010、X87287000--茹曣
      Case "X6901101", "X6073801", "X7991900", "X6936501", "X5424307", "X6936500", "X6936502", "X6936505", "X6936506", "X6936507", "X6936508", "X8084702", "X8398300", "X8398400", "X4371405", "X3880503", "X8253201", "X8250403", "X8250404", "X6936511", "X6936509", "X8728701", "X8728700"
         MsgBox "客戶為 " & strPA26 & GetCustomerName(strPA26) & " , 請影印代理人帳單交客戶 !", , MsgText(5)
      Case Else
   End Select
   'end 2017/4/14
    
   'ADD BY SONIA 2014/4/8 特殊出名公司提醒
   If strPA161 = "J" Then
      MsgBox "此案為智權公司出名案件, 請注意代理人帳單是否有開台一智權公司 !", , MsgText(5)
   End If
   '2014/4/8 END
   
   Exit Function
ErrorHandler:
    PUB_AddNewFBillData = False
End Function

'Add By Cheng 2002/11/01
'從basQuery移來
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' 取得西元的日數
' Input : strDate ==> 輸入的日期
' Output : 傳回西元的日數 DD
' Description : 此功能會傳回日期字串中的年, 不管輸入的日期
'   是西元日期還是民國日期, 或是字串中有/的字元, 均會自動轉換
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Public Function DBDAY(ByVal strDate As String) As String
   Dim nTemp As Integer
   Dim nIndex As Integer
   Dim strTemp As String
   DBDAY = "00"
   ' 若日期中有/表示這是日期格式的字串如 YY/MM/DD 或 YYYY/MM/DD
   If InStr(1, strDate, "/") Then
      nTemp = InStr(1, strDate, "/")
      nIndex = InStr(nTemp + 1, strDate, "/")
      strTemp = Mid(strDate, nIndex + 1, Len(strDate) - nIndex)
      If Len(strTemp) = 1 Then
         DBDAY = "0" & strTemp
      Else
         DBDAY = strTemp
      End If
   Else
      If Len(strDate) > 7 Then
         DBDAY = Mid(strDate, 7, 2)
      Else
         strTemp = strDate
         DBDAY = Mid(ChangeTStringToWString(strTemp), 7, 2)
      End If
   End If
End Function

'Add By Cheng 2002/11/01
'從basQuery移來
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' 取得西元的月份
' Input : strDate ==> 輸入的日期
' Output : 傳回西元的月份 MM
' Description : 此功能會傳回日期字串中的年, 不管輸入的日期
'   是西元日期還是民國日期, 或是字串中有/的字元, 均會自動轉換
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Public Function DBMONTH(ByVal strDate As String) As String
   Dim nBegin As Integer
   Dim nEnd As Integer
   Dim strTemp As String
   DBMONTH = "00"
   ' 若日期中有/表示這是日期格式的字串如 YY/MM/DD 或 YYYY/MM/DD
   If InStr(1, strDate, "/") Then
      nBegin = InStr(1, strDate, "/")
      nEnd = InStr(nBegin + 1, strDate, "/")
      strTemp = Mid(strDate, nBegin + 1, nEnd - nBegin - 1)
      If Len(strTemp) = 1 Then
         DBMONTH = "0" & strTemp
      Else
         DBMONTH = strTemp
      End If
   Else
      If Len(strDate) > 7 Then
         DBMONTH = Mid(strDate, 5, 2)
      Else
         strTemp = strDate
         DBMONTH = Mid(ChangeTStringToWString(strTemp), 5, 2)
      End If
   End If
End Function

'Add By Cheng 2002/11/01
'從basQuery移來
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' 取得西元的年份
' Input : strDate ==> 輸入的日期
' Output : 傳回西元的年份 YYYY
' Description : 此功能會傳回日期字串中的年, 不管輸入的日期
'   是西元日期還是民國日期, 或是字串中有/的字元, 均會自動轉換
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Public Function DBYEAR(ByVal strDate As String) As String
   Dim nIndex As Integer
   Dim strTemp As String
   ' 若日期中有/表示這是日期格式的字串如 YY/MM/DD 或 YYYY/MM/DD
   DBYEAR = "0000"
   If InStr(1, strDate, "/") Then
      nIndex = InStr(1, strDate, "/")
      strTemp = Mid(strDate, 1, nIndex - 1)
      If Len(strTemp) < 4 Then
         'Modify by Morgan 2011/6/1前面會多空白
         'strTemp = str(Val(strTemp) + 1911)
         strTemp = CStr(Val(strTemp) + 1911)
      End If
      DBYEAR = strTemp
   Else
      If Len(strDate) > 7 Then
         DBYEAR = Mid(strDate, 1, 4)
      Else
         strTemp = strDate
         DBYEAR = Mid(ChangeTStringToWString(strTemp), 1, 4)
      End If
   End If
End Function

'Add By Cheng 2002/11/21
Public Function PUB_ChgNumber2Chinese(strNum As String) As String
Select Case strNum
Case "1"
    PUB_ChgNumber2Chinese = "一"
Case "2"
    PUB_ChgNumber2Chinese = "二"
Case "3"
    PUB_ChgNumber2Chinese = "三"
Case "4"
    PUB_ChgNumber2Chinese = "四"
Case "5"
    PUB_ChgNumber2Chinese = "五"
Case "6"
    PUB_ChgNumber2Chinese = "六"
Case "7"
    PUB_ChgNumber2Chinese = "七"
Case "8"
    PUB_ChgNumber2Chinese = "八"
Case "9"
    PUB_ChgNumber2Chinese = "九"
Case "10"
    PUB_ChgNumber2Chinese = "十"
Case "11"
    PUB_ChgNumber2Chinese = "十一"
Case "12"
    PUB_ChgNumber2Chinese = "十二"
Case "13"
    PUB_ChgNumber2Chinese = "十三"
Case "14"
    PUB_ChgNumber2Chinese = "十四"
Case "15"
    PUB_ChgNumber2Chinese = "十五"
Case "16"
    PUB_ChgNumber2Chinese = "十六"
Case "17"
    PUB_ChgNumber2Chinese = "十七"
Case "18"
    PUB_ChgNumber2Chinese = "十八"
Case "19"
    PUB_ChgNumber2Chinese = "十九"
Case "20"
    PUB_ChgNumber2Chinese = "二十"
' 2009/01/15 Add BY Sindy
Case "25"
    PUB_ChgNumber2Chinese = "二十五"
Case "30"
    PUB_ChgNumber2Chinese = "三十"
Case "35"
    PUB_ChgNumber2Chinese = "三十五"
Case "40"
    PUB_ChgNumber2Chinese = "四十"
Case "45"
    PUB_ChgNumber2Chinese = "四十五"
Case "50"
    PUB_ChgNumber2Chinese = "五十"
' 2009/01/15 END
Case Else
    PUB_ChgNumber2Chinese = strNum
End Select
End Function

'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' 檢查字串是否為空白
' Input : strData ==> 所要檢查的字串
' Output : 若輸入的字串中沒有非空白的字元存在時, 則傳回True
'          否則傳回 False
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Public Function IsEmptyText(ByVal strData As String) As Boolean
   Dim nIndex As Integer
   IsEmptyText = False
   
   If Len(strData) <= 0 Then
      IsEmptyText = True
   Else
      IsEmptyText = True
      For nIndex = 1 To Len(strData)
         If Mid(strData, nIndex, 1) <> " " Then
            IsEmptyText = False
            Exit For
         End If
      Next nIndex
   End If
End Function

''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' 設定該控制項(TextBox)為惟讀或可讀寫
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
'Modify By Sindy 2021/7/16 改為用 Object 型態
'Public Sub EnableTextBox(ByVal ctrl As TextBox, ByVal bEnable As Boolean)
Public Sub EnableTextBox(ByVal ctrl As Object, ByVal bEnable As Boolean)
   If bEnable = True Then
      ctrl.Locked = False
      ctrl.BackColor = &H80000005
      ctrl.TabStop = True
   Else
      ctrl.Locked = True
      ctrl.BackColor = &H8000000F
      ctrl.TabStop = False
   End If
End Sub

''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' 取得民國日期
' Input : strDate ==> 輸入的日期
' Output : 傳回民國的日期 YYMMDD
' Description : 此功能會傳回民國的日期, 不管輸入的日期
'   是西元日期還是民國日期, 或是字串中有/的字元, 均會自動轉換
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Public Function TAIWANDATE(ByVal strDate As String) As String
   Dim strTemp As String
   strTemp = DBDATE(strDate)
   TAIWANDATE = ChangeWStringToTString(strTemp)
End Function

''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' 由客戶代碼取得客戶名稱
' Input : strCustomer ==> 客戶代碼
'         nLanguage ==> 0 : 表取得的是中文名稱(無中文取英文, 無英文取日文)
'                       1 : 表取得的是英文名稱(無英文取中文, 無中文取日文)
'                       (預設值為0)
' Output : 傳回客戶的名稱
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
'Modify By Sindy 2020/3/2 + Optional ByRef strCU149 As String = ""
'Modify By Sindy 2022/3/16 + Optional ByRef strCU126 As String = ""
Public Function GetCustomerName(ByVal strCustomer As String, Optional ByVal nLanguage As String = 0, _
                                Optional ByRef strCU58 As String = "", Optional ByRef strCU59 As String = "", Optional ByRef strCU60 As String = "", _
                                Optional ByRef strCU61 As String = "", Optional ByRef strCU62 As String = "", Optional ByRef strCU63 As String = "", _
                                Optional ByRef strCU146 As String = "", Optional ByRef strCU147 As String = "", Optional ByRef strCU151 As String = "", _
                                Optional ByRef strCU149 As String = "", Optional ByRef strCU126 As String = "") As String
   Dim rsTmp As New ADODB.Recordset
   Dim strKey As String
   Dim strSql As String
   
   ' 檢查取得中文還是英文名稱的範圍
   If nLanguage < 0 Or nLanguage > 1 Then: nLanguage = 0
   
   GetCustomerName = Empty
   
   If Len(strCustomer) < 9 Then: strCustomer = strCustomer & String(9 - Len(strCustomer), "0")
   
   If Len(strCustomer) > 8 Then
      strSql = "SELECT * FROM Customer " & _
               "WHERE CU01 = '" & Mid(strCustomer, 1, 8) & "' AND " & _
                     "CU02 = '" & Mid(strCustomer, 9, 1) & "'"
   Else
      strSql = "SELECT * FROM Customer " & _
               "WHERE CU01 = '" & Mid(strCustomer, 1, 8) & "' AND " & _
                     "CU02 = '0' "
   End If
   rsTmp.CursorLocation = adUseClient
   rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   'Add By Sindy 2014/2/14
   strCU58 = ""
   strCU59 = ""
   strCU60 = ""
   strCU61 = ""
   strCU62 = ""
   strCU63 = ""
   strCU146 = ""
   strCU147 = ""
   strCU151 = ""
   '2014/2/14 END
   strCU149 = "" 'Add By Sindy 2020/3/4
   strCU126 = "" 'Add By Sindy 2022/3/16
   If rsTmp.RecordCount > 0 Then
      rsTmp.MoveFirst
      'Add By Sindy 2014/2/14
      strCU58 = "" & rsTmp.Fields("CU58")
      strCU59 = "" & rsTmp.Fields("CU59")
      strCU60 = "" & rsTmp.Fields("CU60")
      strCU61 = "" & rsTmp.Fields("CU61")
      strCU62 = "" & rsTmp.Fields("CU62")
      strCU63 = "" & rsTmp.Fields("CU63")
      strCU146 = "" & rsTmp.Fields("CU146")
      strCU147 = "" & rsTmp.Fields("CU147")
      strCU151 = "" & rsTmp.Fields("CU151")
      '2014/2/14 END
      strCU149 = "" & rsTmp.Fields("CU149") 'Add By Sindy 2020/3/4
      strCU126 = "" & rsTmp.Fields("CU126") 'Add By Sindy 2022/3/16
      Select Case nLanguage
         Case 0:
            If IsNull(rsTmp.Fields("CU04")) = False Then
               GetCustomerName = rsTmp.Fields("CU04")
            ElseIf IsNull(rsTmp.Fields("CU05")) = False Then
               GetCustomerName = rsTmp.Fields("CU05")
               '92.10.15 add by sonia
               If IsNull(rsTmp.Fields("CU88")) = False Then
                  GetCustomerName = GetCustomerName & " " & rsTmp.Fields("CU88")
               End If
               If IsNull(rsTmp.Fields("CU89")) = False Then
                  GetCustomerName = GetCustomerName & " " & rsTmp.Fields("CU89")
               End If
               If IsNull(rsTmp.Fields("CU90")) = False Then
                  GetCustomerName = GetCustomerName & " " & rsTmp.Fields("CU90")
               End If
               '92.10.15 end
            ElseIf IsNull(rsTmp.Fields("CU06")) = False Then
               GetCustomerName = rsTmp.Fields("CU06")
            End If
         Case 1:
            If IsNull(rsTmp.Fields("CU05")) = False Then
               GetCustomerName = rsTmp.Fields("CU05")
               '92.10.15 add by sonia
               If IsNull(rsTmp.Fields("CU88")) = False Then
                  GetCustomerName = GetCustomerName & " " & rsTmp.Fields("CU88")
               End If
               If IsNull(rsTmp.Fields("CU89")) = False Then
                  GetCustomerName = GetCustomerName & " " & rsTmp.Fields("CU89")
               End If
               If IsNull(rsTmp.Fields("CU90")) = False Then
                  GetCustomerName = GetCustomerName & " " & rsTmp.Fields("CU90")
               End If
               '92.10.15 end
            ElseIf IsNull(rsTmp.Fields("CU04")) = False Then
               GetCustomerName = rsTmp.Fields("CU04")
            ElseIf IsNull(rsTmp.Fields("CU06")) = False Then
               GetCustomerName = rsTmp.Fields("CU06")
            End If
      End Select
   End If
   rsTmp.Close
   Set rsTmp = Nothing
End Function


''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' 取得商標種類名稱
' Input : strKey ==> 商標代碼
'         nLanguage ==> 0 表取國內名稱
'                       1 表取得大陸名稱
'                       2 表取得英文名稱
'                       3 表取得日文名稱
' Output : 傳回商標種類的名稱
' 說明 : 當nCountry不輸入時, 預設值為取得國內的名稱
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Public Function GetTradeMarkName(ByVal strKey As String, Optional ByVal nLanguage As Integer = 0) As String
   Dim rsTmp As New ADODB.Recordset
   Dim strSql As String
   
   ' 檢查取得國內還是大陸名稱的範圍
   If nLanguage < 0 Or nLanguage > 3 Then: nLanguage = 0
   
   GetTradeMarkName = Empty
   ' 若要取得商標的名稱其檔案中欄位PTM01的值必須為2
   strSql = "SELECT * FROM PatentTradeMarkMap " & _
            "WHERE PTM01 = '2' AND " & _
                  "PTM02 = '" & strKey & "'"
   rsTmp.CursorLocation = adUseClient
   rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If rsTmp.RecordCount > 0 Then
      rsTmp.MoveFirst
      Select Case nLanguage
         ' 取得國內的名稱
         Case 0:
            If IsNull(rsTmp.Fields("PTM03")) = False Then
               GetTradeMarkName = rsTmp.Fields("PTM03")
            End If
         ' 取得大陸的名稱
         Case 1:
            If IsNull(rsTmp.Fields("PTM04")) = False Then
               GetTradeMarkName = rsTmp.Fields("PTM04")
            End If
         ' 取得英文的名稱
         Case 2:
            If IsNull(rsTmp.Fields("PTM05")) = False Then
               GetTradeMarkName = rsTmp.Fields("PTM05")
            End If
         ' 取得日文的名稱
         Case 3:
            If IsNull(rsTmp.Fields("PTM06")) = False Then
               GetTradeMarkName = rsTmp.Fields("PTM06")
            End If
      End Select
   End If
   rsTmp.Close
   Set rsTmp = Nothing
End Function

''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' 取得專利種類名稱
' Input : strKey ==> 專利代碼
'         nLanguage ==> 0 表取國內名稱
'                       1 表取得大陸名稱
'                       2 表取得英文名稱
'                       3 表取得日文名稱
' Output : 傳回專利種類的名稱
' 說明 : 當nCountry不輸入時, 預設值為取得國內的名稱
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Public Function GetPatentName(ByVal strKey As String, Optional ByVal nLanguage As Integer = 0) As String
   Dim rsTmp As New ADODB.Recordset
   Dim strSql As String
   
   ' 檢查取得國內還是大陸名稱的範圍
   If nLanguage < 0 Or nLanguage > 3 Then: nLanguage = 0
   
   GetPatentName = Empty
   ' 若要取得商標的名稱其檔案中欄位PTM01的值必須為2
   strSql = "SELECT * FROM PatentTradeMarkMap " & _
            "WHERE PTM01 = '1' AND " & _
                  "PTM02 = '" & strKey & "'"
   rsTmp.CursorLocation = adUseClient
   rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If rsTmp.RecordCount > 0 Then
      rsTmp.MoveFirst
      Select Case nLanguage
         ' 取得國內的名稱
         Case 0:
            If IsNull(rsTmp.Fields("PTM03")) = False Then
               GetPatentName = rsTmp.Fields("PTM03")
            End If
         ' 取得大陸的名稱
         Case 1:
            If IsNull(rsTmp.Fields("PTM04")) = False Then
               GetPatentName = rsTmp.Fields("PTM04")
            End If
         ' 取得英文的名稱
         Case 2:
            If IsNull(rsTmp.Fields("PTM05")) = False Then
               GetPatentName = rsTmp.Fields("PTM05")
            End If
         ' 取得日文的名稱
         Case 3:
            If IsNull(rsTmp.Fields("PTM06")) = False Then
               GetPatentName = rsTmp.Fields("PTM06")
            End If
      End Select
   End If
   rsTmp.Close
   Set rsTmp = Nothing
End Function

'Add By Cheng 2002/12/11
'Modified by Morgan 2021/5/31 +bolChkST04
'Modified by Morgan 2022/10/25 -bolChkST04
'Memo by Lydia 2024/01/05 外專：中說性質之承辦人／核稿人
Public Function PUB_GetSpecCP14(strCP0104 As String) As String
   'Added by Morgan 2012/8/7 重寫規則與FMP可共用
   '新案翻譯的在職1.所內承辦人,2.核稿人
   Dim stSQL As String, adoRst As ADODB.Recordset, iR As Integer, strCpCon As String
     
   'Modified by Morgan 2012/10/29 +判斷F部門因為其他有可能是內專程序承辦 Ex.P096639
   If Left(strCP0104, 1) = "P" Then
      'Modified by Morgan 2013/11/6 +235核對中說格式
      strCpCon = " and cp10 IN ('201','209','235','210','910','942')"
   Else
      'Modified by Morgan 2013/11/6 +235核對中說格式
      strCpCon = " and cp10 IN ('201','209','235','210')"
   End If
   'Modified by Morgan 2020/5/21 改只抓外專工程師,否則中間來所案件會抓到程序 Ex:FCP-061492 --淑華,敏莉
   'Modified by Morgan 2021/12/24 王協理(88003、F5313)翻譯案件要改抓核稿人(語法會抓所內編號,只需判斷88003就好)--淑華
   'Modified by Morgan 2022/10/25 +C1~C5
   'Modified by Morgan 2025/7/9 所內編號要排除 XXX9A~Z -> and substr(sim01(+),-2)<'9A'
   stSQL = "select nvl(decode(s1.st01,'88003','',s1.st01),nvl(decode(s2.st01,'88003','',s2.st01),s3.st01)) C0" & _
      ",s1.st01 C1,s1.st04 C2,s2.st01 C3,s2.st04 C4,s3.st01 C5" & _
      " from caseprogress,engineerprogress,staff_idmap,staff s1,staff s2,staff s3" & _
      " where " & ChgCaseprogress(strCP0104) & strCpCon & _
      " and cp57 is null and ep02(+)=cp09 and sim02(+)=cp14 and substr(sim01(+),-2)<'9A'" & _
      " and s1.st01(+)=sim01 and s1.st03(+)='F21'" & _
      " and s2.st01(+)=cp14 and s2.st03(+)='F21'" & _
      " and s3.st01(+)=ep04 and s3.st03(+)='F21'" & _
      " and nvl(decode(s1.st01,'88003','',s1.st01),nvl(decode(s2.st01,'88003','',s2.st01),s3.st01)) is not null"
  'Modified by Morgan 2021/5/31
  'stSQL = stSQL & "  and s1.st04(+)='1' and s2.st04(+)='1' and s3.st04(+)='1'"
  'Removed by Morgan 2022/10/25
  'If bolChkST04 = True Then
  '    stSQL = stSQL & "  and s1.st04(+)='1' and s2.st04(+)='1' and s3.st04(+)='1'"
  'End If
  'end 2022/10/25
  'end 2021/5/31
  
   stSQL = stSQL & " order by cp05 desc"
   iR = 1
   Set adoRst = ClsLawReadRstMsg(iR, stSQL)
   If iR = 1 Then
      'Modified by Morgan 2022/10/25 工程師離職時抓核稿人 Ex:FCP-065904--淑華
      'PUB_GetSpecCP14 = "" & adoRst(0)
      If Not IsNull(adoRst("C5")) And "" & adoRst("C2") <> "1" And "" & adoRst("C4") <> "1" Then
         PUB_GetSpecCP14 = adoRst("C5")
      Else
         PUB_GetSpecCP14 = "" & adoRst(0)
      End If
      
   'FMP再抓國內案
   ElseIf Left(strCP0104, 1) = "P" Then
      'Modified by Morgan 2013/11/6 +235核對中說格式
      'Modified by Morgan 2020/5/21 改只抓外專工程師,否則中間來所案件會抓到程序 Ex:FCP-061492 --淑華,敏莉
      'Modified by Morgan 2022/10/25 +C1~C5
      stSQL = "select nvl(s1.st01,nvl(s2.st01,s3.st01)) C0" & _
         ",s1.st01 C1,s1.st04 C2,s2.st01 C3,s2.st04 C4,s3.st01 C5" & _
         " from casemap,caseprogress,engineerprogress,staff_idmap,staff s1,staff s2,staff s3" & _
         " where " & ChgCaseMap(strCP0104) & " and cm10='0'" & _
         " and cp01(+)=cm05 and cp02(+)=cm06 and cp03(+)=cm07 and cp04(+)=cm08" & _
         " and cp57 is null" & strCpCon & _
         " and ep02(+)=cp09 and sim02(+)=cp14" & _
         " and s1.st01(+)=sim01 and s1.st03(+)='F21'" & _
         " and s2.st01(+)=cp14 and s2.st03(+)='F21'" & _
         " and s3.st01(+)=ep04 and s3.st03(+)='F21'" & _
         " and nvl(s1.st01,nvl(s2.st01,s3.st01)) is not null"
         
      'Modified by Morgan 2021/5/31
      'bolChkST04 = bolChkST04 & "  and s1.st04(+)='1' and s2.st04(+)='1' and s3.st04(+)='1'"
      'Removed by Morgan 2022/10/25
      'If bolChkST04 = True Then
      '    stSQL = stSQL & "  and s1.st04(+)='1' and s2.st04(+)='1' and s3.st04(+)='1'"
      'End If
      'end 2022/10/25
      'end 2021/5/31
      
      stSQL = stSQL & " order by cp05 desc"
  
      iR = 1
      Set adoRst = ClsLawReadRstMsg(iR, stSQL)
      If iR = 1 Then
         'Modified by Morgan 2022/10/25 工程師離職時抓核稿人--淑華
         'PUB_GetSpecCP14 = "" & adoRst(0)
         If Not IsNull(adoRst("C5")) And "" & adoRst("C2") <> "1" And "" & adoRst("C4") <> "1" Then
            PUB_GetSpecCP14 = adoRst("C5")
         Else
            PUB_GetSpecCP14 = "" & adoRst(0)
         End If
         'end 2022/10/25
      End If
   End If
   Set adoRst = Nothing
   'end 2012/8/7

'Removed by Morgan 2012/8/7
'Dim StrSQLa As String
'Dim rsA As New ADODB.Recordset
'
'PUB_GetSpecCP14 = ""
''取得翻譯收文號的核稿人
'StrSQLa = "Select EP04 From  CaseProgress, EngineerProgress Where  CP09=EP02 And " & ChgCaseprogress(strCP0104) & " And CP10='" & 翻譯 & "' And EP04 Is Not NULL "
'rsA.CursorLocation = adUseClient
'rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
'If rsA.RecordCount > 0 Then
'    PUB_GetSpecCP14 = "" & rsA.Fields(0).Value
'End If
'If rsA.State <> adStateClosed Then rsA.Close
'Set rsA = Nothing
'If PUB_GetSpecCP14 <> "" Then Exit Function
'
''取得製作中說收文號相對的核稿人
'StrSQLa = "Select EP04 From  CaseProgress, EngineerProgress Where  CP09=EP02 And " & ChgCaseprogress(strCP0104) & " And CP10='" & 製作中說 & "' And EP04 Is Not NULL "
'rsA.CursorLocation = adUseClient
'rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
'If rsA.RecordCount > 0 Then
'    PUB_GetSpecCP14 = "" & rsA.Fields(0).Value
'End If
'If rsA.State <> adStateClosed Then rsA.Close
'Set rsA = Nothing
'If PUB_GetSpecCP14 <> "" Then Exit Function
'
''取得檢視中說收文號相對的核稿人
'StrSQLa = "Select EP04 From  CaseProgress, EngineerProgress Where  CP09=EP02 And " & ChgCaseprogress(strCP0104) & " And CP10='" & 檢視中說 & "' And EP04 Is Not NULL "
'rsA.CursorLocation = adUseClient
'rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
'If rsA.RecordCount > 0 Then
'    PUB_GetSpecCP14 = "" & rsA.Fields(0).Value
'End If
'If rsA.State <> adStateClosed Then rsA.Close
'Set rsA = Nothing
'If PUB_GetSpecCP14 <> "" Then Exit Function
'
''取得翻譯收文號的承辦人
'StrSQLa = "Select CP14 From  CaseProgress Where " & ChgCaseprogress(strCP0104) & " And CP10='" & 翻譯 & "' "
'rsA.CursorLocation = adUseClient
'rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
'If rsA.RecordCount > 0 Then
'    PUB_GetSpecCP14 = "" & rsA.Fields(0).Value
'End If
'If rsA.State <> adStateClosed Then rsA.Close
'Set rsA = Nothing
'If PUB_GetSpecCP14 <> "" Then Exit Function
'
''取得製作中說收文號的承辦人
'StrSQLa = "Select CP14 From  CaseProgress Where " & ChgCaseprogress(strCP0104) & " And CP10='" & 製作中說 & "' "
'rsA.CursorLocation = adUseClient
'rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
'If rsA.RecordCount > 0 Then
'    PUB_GetSpecCP14 = "" & rsA.Fields(0).Value
'End If
'If rsA.State <> adStateClosed Then rsA.Close
'Set rsA = Nothing
'If PUB_GetSpecCP14 <> "" Then Exit Function
'
''取得檢視中說收文號的承辦人
'StrSQLa = "Select CP14 From  CaseProgress Where " & ChgCaseprogress(strCP0104) & " And CP10='" & 製作中說 & "' "
'rsA.CursorLocation = adUseClient
'rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
'If rsA.RecordCount > 0 Then
'    PUB_GetSpecCP14 = "" & rsA.Fields(0).Value
'End If
'If rsA.State <> adStateClosed Then rsA.Close
'Set rsA = Nothing
'If PUB_GetSpecCP14 <> "" Then Exit Function
'
End Function

'Add By Cheng 2002/12/18
'取得申請人的代表人
Public Function PUB_GetCustomerRPSTTV(strCU0102 As String, intii As Integer) As String
Dim rsA As New ADODB.Recordset
Dim StrSQLa As String

PUB_GetCustomerRPSTTV = ""
strCU0102 = Left(strCU0102 & "000000000", 9)
StrSQLa = "Select * From CUSTOMER WHERE CU01='" & Left(strCU0102, 8) & "' AND CU02='" & Right(strCU0102, 1) & "' "
rsA.CursorLocation = adUseClient
rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
If rsA.RecordCount > 0 Then
    Select Case intii
    Case 1
        PUB_GetCustomerRPSTTV = "" & rsA("CU39").Value & "，" & rsA("CU40").Value & "，" & rsA("CU41").Value
    Case 2
        PUB_GetCustomerRPSTTV = "" & rsA("CU42").Value & "，" & rsA("CU43").Value & "，" & rsA("CU44").Value
    Case 3
        PUB_GetCustomerRPSTTV = "" & rsA("CU45").Value & "，" & rsA("CU46").Value & "，" & rsA("CU47").Value
    Case 4
        PUB_GetCustomerRPSTTV = "" & rsA("CU48").Value & "，" & rsA("CU49").Value & "，" & rsA("CU50").Value
    Case 5
        PUB_GetCustomerRPSTTV = "" & rsA("CU51").Value & "，" & rsA("CU52").Value & "，" & rsA("CU53").Value
    Case 6
        PUB_GetCustomerRPSTTV = "" & rsA("CU54").Value & "，" & rsA("CU55").Value & "，" & rsA("CU56").Value
    End Select
End If
If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing
End Function

'Add By Cheng 2003/01/29
'刪除地址條列表資料
Public Sub PUB_DeleteAddressList(strUserNumber As String)
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset

'Modified by Lydia 2019/04/02 PK: 使用者帳號@電腦名稱(pub_HostName)
'StrSQLa = "Delete From AddressList Where AL01='" & strUserNumber & "' "
StrSQLa = "Delete From AddressList Where AL01='" & strUserNumber & "@" & pub_HostName & "' "
cnnConnection.Execute StrSQLa

End Sub

'Add By Cheng 2003/01/29
'新增地址條列表資料
'Modify By Cheng 2003/02/07
'加傳入參數--綠皮貼紙份數
'Public Sub PUB_AddNewAddressList(strAL01 As String, strAL02 As String, strAL03 As String, strAL04 As String, strAL05 As String, strAL06 As String)
'Modify By Sindy 2021/3/30 + , Optional strToID As String = "", Optional strToNm As String = ""
Public Sub PUB_AddNewAddressList( _
    strAL01 As String, strAL02 As String, strAL03 As String, strAL04 As String, _
    strAL05 As String, strAL06 As String, strAL07 As String, Optional strAL08 As String = "", _
    Optional strToID As String = "", Optional strToNm As String = "")
'strAL01:使用者代號
'strAL02, strAL03, strAL04, strAL05:本所案號
'strAL06:流水號
'strAL07:綠皮貼紙份數
'strAL08:案件性質
'AL09=strToID:指定收件人
'AL10=strToNm:聯絡人名稱
Dim StrSQLa As String, intA As Integer
Dim rsA As New ADODB.Recordset
Dim strLetterLanguage As String 'Add By Sindy 2016/1/26

'Add By Sindy 2016/1/26 外專為日文定稿或代理人國籍為美國時,才需列印地址條
If strAL02 = "P" Or strAL02 = "FCP" Then
   '檢查是否為外專案件
   StrSQLa = "select cp12 from caseprogress" & _
               " where cp01='" & strAL02 & "' and cp02='" & strAL03 & "' and cp03='" & strAL04 & "' and cp04='" & strAL05 & "'" & _
               " and cp09=(select min(cp09) from caseprogress" & _
                           " where cp01='" & strAL02 & "' and cp02='" & strAL03 & "' and cp03='" & strAL04 & "' and cp04='" & strAL05 & "'" & _
                           " and cp05=(select max(cp05) from caseprogress" & _
                                     " where cp01='" & strAL02 & "' and cp02='" & strAL03 & "' and cp03='" & strAL04 & "' and cp04='" & strAL05 & "'))"
   intA = 1
   Set rsA = ClsLawReadRstMsg(intA, StrSQLa)
   If intA = 1 Then
      If Left("" & rsA.Fields("cp12"), 2) = "F2" Then '外專
         strLetterLanguage = PUB_GetLanguage(strAL02, strAL03, strAL04, strAL05)
         If strLetterLanguage <> "3" Then '外專為日文定稿時,要列印地址條
            StrSQLa = "select pa75,fa10 from patent,fagent" & _
                        " where pa01='" & strAL02 & "' and pa02='" & strAL03 & "' and pa03='" & strAL04 & "' and pa04='" & strAL05 & "'" & _
                        " and pa75 is not null" & _
                        " and substr(pa75,1,8)=fa01(+) and substr(pa75,9,1)=fa02(+)"
            intA = 1
            Set rsA = ClsLawReadRstMsg(intA, StrSQLa)
            If intA = 1 Then
               If Left("" & rsA.Fields("fa10"), 3) <> "101" Then '外專代理人國籍為美國時,要列印地址條
                  Set rsA = Nothing
                  Exit Sub
               End If
            End If
         End If
      End If
   End If
End If
'2016/1/26 END

'Modify By Cheng 2003/02/07
'strSQLA = "Insert Into AddressList Values ('" & strAL01 & "','" & strAL02 & "','" & strAL03 & "','" & strAL04 & "','" & strAL05 & "','" & Val(strAL06) & "')"
'strSQLA = "Insert Into AddressList Values ('" & strAL01 & "','" & strAL02 & "','" & strAL03 & "','" & strAL04 & "','" & strAL05 & "'," & Val(strAL06) & "," & Val(strAL07) & " )"
'edit by nick 2004/08/06 指定欄位
'strSQLA = "Insert Into AddressList Values ('" & strAL01 & "','" & strAL02 & "','" & strAL03 & "','" & strAL04 & "','" & strAL05 & "'," & Val(strAL06) & "," & Val(strAL07) & ",'" & strAL08 & "' )"
'edit by nick 2004/10/20 檢查重複
CheckOC3
'edit by nick 2004/11/10
'strSQL = "select count(*) from addresslist where al01='" & strAL01 & "' " & IIf(Trim(strAL02) = "", " and al02 is null ", " and al02='" & strAL02 & "' ") & _
                IIf(Trim(strAL03) = "", " and al03 is null ", " and al03='" & strAL03 & "' ") & _
                IIf(Trim(strAL04) = "", " and al04 is null ", " and al04='" & strAL04 & "' ") & _
                IIf(Trim(strAL05) = "", " and al05 is null ", " and al05='" & strAL05 & "' ") & _
                IIf(Trim(strAL06) = "", " and (al06 is null or al06=0) ", " and al06=" & strAL06 & " ") & _
                IIf(Trim(strAL07) = "", " and (al07 is null or al07=0) ", " and al07=" & strAL07 & " ") & _
                IIf(Trim(strAL08) = "", " and al08 is null ", " and al08='" & strAL08 & "' ")
'Modified by Lydia 2019/04/02 PK: 使用者帳號@電腦名稱(pub_HostName)
'Modify By Sindy 2021/3/30 + ,AL09,AL10
StrSQLa = "select count(*) from addresslist where al01='" & strAL01 & "@" & pub_HostName & "' " & IIf(Trim(strAL02) = "", " and al02 is null ", " and al02='" & strAL02 & "' ") & _
                IIf(Trim(strAL03) = "", " and al03 is null ", " and al03='" & strAL03 & "' ") & _
                IIf(Trim(strAL04) = "", " and al04 is null ", " and al04='" & strAL04 & "' ") & _
                IIf(Trim(strAL05) = "", " and al05 is null ", " and al05='" & strAL05 & "' ") & _
                IIf(Trim(strAL07) = "", " and (al07 is null or al07=0) ", " and al07=" & strAL07 & " ") & _
                IIf(Trim(strAL08) = "", " and al08 is null ", " and al08='" & strAL08 & "' ") & _
                IIf(Trim(strToID) = "", " and al09 is null ", " and al09='" & strToID & "' ") & _
                IIf(Trim(strToNm) = "", " and al10 is null ", " and al10='" & strToNm & "' ")
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.Fields(0).Value = 0 Then
    'Modified by Lydia 2019/04/02 PK: 使用者帳號@電腦名稱(pub_HostName)
    'StrSQLa = "Insert Into AddressList (AL01,AL02,AL03,AL04,AL05,AL06,AL07,AL08) Values ('" & strAL01 & "','" & strAL02 & "','" & strAL03 & "','" & strAL04 & "','" & strAL05 & "'," & Val(strAL06) & "," & Val(strAL07) & ",'" & strAL08 & "' )"
    'Modify By Sindy 2021/3/30 + ,AL09,AL10
    StrSQLa = "Insert Into AddressList (AL01,AL02,AL03,AL04,AL05,AL06,AL07,AL08,AL09,AL10) Values ('" & strAL01 & "@" & pub_HostName & "','" & strAL02 & "','" & strAL03 & "','" & strAL04 & "','" & strAL05 & "'," & Val(strAL06) & "," & Val(strAL07) & ",'" & strAL08 & "','" & strToID & "','" & strToNm & "')"
    cnnConnection.Execute StrSQLa
End If
CheckOC3

Set rsA = Nothing
End Sub

'Move By Cheng 2003/01/28
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' 取定稿語文
' Input : strTM01 == 本所案號的第一個欄位
'         strTM02 == 本所案號的第二個欄位
'         strTM03 == 本所案號的第三個欄位
'         strTM04 == 本所案號的第四個欄位
' Output : 傳回定稿語文
'          1:中文 2:英文 3:日文
' 說明 : 若資料庫中無定義時傳回中文
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Public Function GetLetterLanguage(ByVal strTM01 As String, ByVal strTM02 As String, ByVal strTM03 As String, ByVal strTM04 As String) As Integer
   Dim strSql As String
   Dim rsTmp As New ADODB.Recordset
   Dim strFC As String
   Dim strCus As String
   ' 預設定稿語文為中文
'   GetLetterLanguage = 2
   GetLetterLanguage = 1
   
   
   Select Case strTM01
      Case "T", "TF", "CFT", "FCT":
         strSql = "SELECT * FROM TradeMark " & _
                  "WHERE TM01 = '" & strTM01 & "' AND " & _
                        "TM02 = '" & strTM02 & "' AND " & _
                        "TM03 = '" & strTM03 & "' AND " & _
                        "TM04 = '" & strTM04 & "' "
         rsTmp.CursorLocation = adUseClient
         rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
         If rsTmp.RecordCount > 0 Then
            rsTmp.MoveFirst
            If IsNull(rsTmp.Fields("TM53")) = False Then
               If IsEmptyText(rsTmp.Fields("TM53")) = False Then
                  GetLetterLanguage = rsTmp.Fields("TM53")
                  rsTmp.Close
                  GoTo EXITSUB
               End If
            End If
            ' FC代理人
            If IsNull(rsTmp.Fields("TM44")) = False Then
               strFC = rsTmp.Fields("TM44")
            End If
            ' 申請人
            If IsNull(rsTmp.Fields("TM23")) = False Then
               strCus = rsTmp.Fields("TM23")
            End If
         End If
         rsTmp.Close
        'Modify By Cheng 2002/12/27
'      Case "P", "FCT", "CFP":
      Case "P", "FCP", "CFP":
         strSql = "SELECT * FROM PATENT " & _
                  "WHERE PA01 = '" & strTM01 & "' AND " & _
                        "PA02 = '" & strTM02 & "' AND " & _
                        "PA03 = '" & strTM03 & "' AND " & _
                        "PA04 = '" & strTM04 & "' "
         rsTmp.CursorLocation = adUseClient
         rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
         If rsTmp.RecordCount > 0 Then
            rsTmp.MoveFirst
            If IsNull(rsTmp.Fields("PA85")) = False Then
               If IsEmptyText(rsTmp.Fields("PA85")) = False Then
                  GetLetterLanguage = rsTmp.Fields("PA85")
                  rsTmp.Close
                  GoTo EXITSUB
               End If
            End If
            ' FC代理人
            If IsNull(rsTmp.Fields("PA75")) = False Then
               strFC = rsTmp.Fields("PA75")
            End If
            ' 申請人
            If IsNull(rsTmp.Fields("PA26")) = False Then
               strCus = rsTmp.Fields("PA26")
            End If
         End If
         rsTmp.Close
      Case Else
         strSql = "SELECT * FROM ServicePractice " & _
                  "WHERE SP01 = '" & strTM01 & "' AND " & _
                        "SP02 = '" & strTM02 & "' AND " & _
                        "SP03 = '" & strTM03 & "' AND " & _
                        "SP04 = '" & strTM04 & "' "
         rsTmp.CursorLocation = adUseClient
         rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
         If rsTmp.RecordCount > 0 Then
            rsTmp.MoveFirst
            If IsNull(rsTmp.Fields("SP34")) = False Then
               If IsEmptyText(rsTmp.Fields("SP34")) = False Then
                  GetLetterLanguage = rsTmp.Fields("SP34")
                  rsTmp.Close
                  GoTo EXITSUB
               End If
            End If
            ' FC代理人
            If IsNull(rsTmp.Fields("SP26")) = False Then
               strFC = rsTmp.Fields("SP26")
            End If
            ' 申請人
            If IsNull(rsTmp.Fields("SP08")) = False Then
               strCus = rsTmp.Fields("SP08")
            End If
            If IsEmptyText(strCus) = True Then
               If IsNull(rsTmp.Fields("SP58")) = False Then
                  strCus = rsTmp.Fields("SP58")
               End If
            End If
            If IsEmptyText(strCus) = True Then
               If IsNull(rsTmp.Fields("SP59")) = False Then
                  strCus = rsTmp.Fields("SP59")
               End If
            End If
            'Modify By Sindy 2011/2/22 增加SP65,SP66
            If IsEmptyText(strCus) = True Then
               If IsNull(rsTmp.Fields("SP65")) = False Then
                  strCus = rsTmp.Fields("SP65")
               End If
            End If
            If IsEmptyText(strCus) = True Then
               If IsNull(rsTmp.Fields("SP66")) = False Then
                  strCus = rsTmp.Fields("SP66")
               End If
            End If
            '2011/2/22 End
         End If
         rsTmp.Close
   End Select
   
   If IsEmptyText(strFC) = False Then
      ' 取FC代理人檔的定稿語文
'      strSQL = "SELECT * FROM FAGENT " & _
'               "WHERE FA01 = '" & strFC & "' "
      strSql = "SELECT * FROM FAGENT " & _
               "WHERE FA01 = '" & Left(strFC, 8) & "' And FA02='" & Mid(strFC, 9, 1) & "' "
      rsTmp.CursorLocation = adUseClient
      rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      If rsTmp.RecordCount > 0 Then
         rsTmp.MoveFirst
         If IsNull(rsTmp.Fields("FA31")) = False Then
            GetLetterLanguage = rsTmp.Fields("FA31")
         End If
      End If
      rsTmp.Close
   Else
      ' 取客戶檔的定稿語文
        'Modify By Cheng 2003/02/04
'      strSQL = "SELECT * FROM CUSTOMER " & _
'               "WHERE CU01 = '" & strCus & "' "
      strSql = "SELECT * FROM CUSTOMER " & _
               "WHERE CU01 = '" & Left(strCus, 8) & "' And CU02='" & Mid(strCus, 9, 1) & "' "
      rsTmp.CursorLocation = adUseClient
      rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      If rsTmp.RecordCount > 0 Then
         rsTmp.MoveFirst
         If IsNull(rsTmp.Fields("CU64")) = False Then
            GetLetterLanguage = rsTmp.Fields("CU64")
         End If
      End If
      rsTmp.Close
   End If
   
EXITSUB:
   Set rsTmp = Nothing
End Function

'Add By Cheng 2003/01/30
'更新列印起點設定
Public Sub PUB_UpdatePrintStartPoint(strPSP01 As String, strPSP02 As String, strPSP03 As String, strPSP04 As String, strPSP05 As String, strPSP06 As String)
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset

'Modified by Morgan 2017/10/24 strPSP01 -> strPSP01+@+電腦名稱
StrSQLa = "Select * From PrintStartPoint Where PSP01='" & strPSP01 & "@" & pub_HostName & "' And PSP02='" & strPSP02 & "' And PSP03='" & strPSP03 & "' "
rsA.CursorLocation = adUseClient
rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
'若有資料, 則修改資料
If rsA.RecordCount > 0 Then
    StrSQLa = "Update PrintStartpoint Set PSP04=" & IIf(strPSP04 = "", "0", CDbl(strPSP04)) & ",PSP05=" & IIf(strPSP05 = "", "0", CDbl(strPSP05)) & ",PSP06='" & strPSP06 & "' Where PSP01='" & rsA("PSP01") & "' And PSP02='" & rsA("PSP02") & "' And PSP03='" & rsA("PSP03") & "' "
    cnnConnection.Execute StrSQLa
'若無資料, 則新增資料
Else
    'EDIT BY NICK 2004/08/06 指定欄位
    'strSQLA = "Insert Into PrintStartpoint Values ('" & strPSP01 & "','" & strPSP02 & "','" & strPSP03 & "'," & IIf(strPSP04 = "", "0", CDbl(strPSP04)) & "," & IIf(strPSP05 = "", "0", CDbl(strPSP05)) & ",'" & strPSP06 & "' )"
    StrSQLa = "Insert Into PrintStartpoint (PSP01,PSP02,PSP03,PSP04,PSP05,PSP06) Values ('" & strPSP01 & "@" & pub_HostName & "','" & strPSP02 & "','" & strPSP03 & "'," & IIf(strPSP04 = "", "0", CDbl(strPSP04)) & "," & IIf(strPSP05 = "", "0", CDbl(strPSP05)) & ",'" & strPSP06 & "' )"
    cnnConnection.Execute StrSQLa
End If
If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing
End Sub

'Add By Cheng 2003/02/24
'新增 DEBIT NOTE 列表資料
'Modify by Morgan 2008/3/28 +strDNL04 是否以EMail通知 Y
'Modify by Morgan 2009/10/19 +strDNL05 是否同時寄紙本 Y
'Modified by Lydia 2020/06/24 +strDNL06 已收款
Public Sub PUB_AddNewDebitNoteList( _
    strDNL01 As String, strDNL02 As String, strDNL03 As String, Optional strDNL04 As String, Optional strDNL05 As String, Optional strDNL06 As String)
'strDNL01 : 使用者代號
'strDNL02 : 請款編號
'strDNL03 : 序號
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset

'EDIT BY NICK 加入指定欄位
'strSQLA = "Insert Into DebitNoteList Values ('" & strDNL01 & "','" & strDNL02 & "'," & Val(strDNL03) & " ) "
'Modified by Lydia 2019/04/02 PK: 使用者帳號@電腦名稱(pub_HostName)
'StrSQLa = "Insert Into DebitNoteList (DNL01,DNL02,DNL03,DNL04,DNL05 ) Values ('" & strDNL01 & "','" & strDNL02 & "'," & Val(strDNL03) & ",'" & strDNL04 & "','" & strDNL05 & "' ) "
'Modified by Lydia 2020/06/24 +strDNL06 已收款
StrSQLa = "Insert Into DebitNoteList (DNL01,DNL02,DNL03,DNL04,DNL05,DNL06 ) Values ('" & strDNL01 & "@" & pub_HostName & "','" & strDNL02 & "'," & Val(strDNL03) & ",'" & strDNL04 & "','" & strDNL05 & "','" & strDNL06 & "' ) "
cnnConnection.Execute StrSQLa

End Sub

'Add By Cheng 2003/02/
'刪除 DebitNote 列表資料
Public Sub PUB_DeleteDebitNoteList(strDNL01 As String)
'strDNL01 : 使用者代號
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset

'Modified by Lydia 2019/04/02 PK: 使用者帳號@電腦名稱(pub_HostName)
'StrSQLa = "Delete From DebitNoteList Where DNL01='" & strDNL01 & "' "
StrSQLa = "Delete From DebitNoteList Where DNL01='" & strDNL01 & "@" & pub_HostName & "' "
cnnConnection.Execute StrSQLa

End Sub

'Add By Cheng 2003/03/04
'以本所案號來查詢案件是否閉卷
Public Function PUB_CaseClosed_1(Str01 As String, Str02 As String, Str03 As String, Str04 As String) As Boolean
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset

'預設本案尚未閉卷
PUB_CaseClosed_1 = False
If Str03 = "" Then Str03 = "0"
If Str04 = "" Then Str04 = "00"
StrSQLa = "SELECT PA57 FROM PATENT WHERE PA01='" & Str01 & "' AND PA02='" & Str02 & "' AND PA03='" & Str03 & "' AND PA04='" & Str04 & "'" & _
         " UNION SELECT TM29 FROM TRADEMARK WHERE TM01='" & Str01 & "' AND TM02='" & Str02 & "' AND TM03='" & Str03 & "' AND TM04='" & Str04 & "'" & _
         " UNION SELECT LC08 FROM LAWCASE WHERE LC01='" & Str01 & "' AND LC02='" & Str02 & "' AND LC03='" & Str03 & "' AND LC04='" & Str04 & "'" & _
         " UNION SELECT HC09 FROM HIRECASE WHERE HC01='" & Str01 & "' AND HC02='" & Str02 & "' AND HC03='" & Str03 & "' AND HC04='" & Str04 & "'" & _
         " UNION SELECT SP15 FROM SERVICEPRACTICE WHERE SP01='" & Str01 & "' AND SP02='" & Str02 & "' AND SP03='" & Str03 & "' AND SP04='" & Str04 & "'"
rsA.CursorLocation = adUseClient
rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
'若基本檔有資料
If rsA.RecordCount > 0 Then
   If "" & rsA.Fields(0).Value = "Y" Then
      PUB_CaseClosed_1 = True
   End If
'若基本檔無資料
Else
   PUB_CaseClosed_1 = True
End If
If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing

End Function

'Add By Cheng 2003/03/26
'新增接洽結案單資料
Public Sub PUB_AddNewCaseCloseSheet( _
    strCCS01 As String, strCCS02 As String, strCCS03 As String, strCCS04 As String, _
    strCCS05 As String, strCCS06 As String, strCCS07 As String, Optional strCCS08 As String = Empty)
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset

'EDIT BY NICK 2004/08/06 指定欄位
'strSQLA = "Insert Into CaseCloseSheet Values ('" & strCCS01 & "'," & Val(strCCS02) & "," & Val(strCCS03) & ",'" & strCCS04 & "','" & strCCS05 & "','" & strCCS06 & "','" & strCCS07 & "' )"
'Modify by Morgan 2005/5/18 加CCS08
'strSQLA = "Insert Into CaseCloseSheet (CCS01,CCS02,CCS03,CCS04,CCS05,CCS06,CCS07) Values ('" & strCCS01 & "'," & Val(strCCS02) & "," & Val(strCCS03) & ",'" & strCCS04 & "','" & strCCS05 & "','" & strCCS06 & "','" & strCCS07 & "' )"
StrSQLa = "Insert Into CaseCloseSheet (CCS01,CCS02,CCS03,CCS04,CCS05,CCS06,CCS07,CCS08) Values ('" & strCCS01 & "'," & Val(strCCS02) & "," & Val(strCCS03) & ",'" & strCCS04 & "','" & strCCS05 & "','" & strCCS06 & "','" & strCCS07 & "','" & strCCS08 & "')"
cnnConnection.Execute StrSQLa

End Sub

'Add By Cheng 2003/02/26
'刪除接洽結案單資料
Public Sub PUB_DeleteCaseCloseSheet(strUserNumber As String)
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset

StrSQLa = "Delete From CaseCloseSheet Where CCS01='" & strUserNumber & "' "
cnnConnection.Execute StrSQLa

End Sub

'Add By Cheng 2003/03/26
'整批列印接洽結案單
'Modify By Cheng 2003/03/31
'Public Sub PUB_PrintCaseCloseSheet(strCCS01 As String)
'Public Sub PUB_PrintCaseCloseSheet(strCCS01 As String, Optional strKind As String = "0")
Public Sub PUB_PrintCaseCloseSheet(strCCS01 As String, Optional strKind As String = "0", Optional blnShowRePrintMsg As Boolean = True, Optional blnShowPrintMsg As Boolean = True)
'strCCS01 : 使用者名稱
'strKind : 區別列印接洽結案單的程式
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset
    
    '2010/5/5 MODIFY BY SONIA FCT,S案仍要印,故外商部門要印但CF案不印
    'If strSrvDate(1) >= 20100501 Then Exit Sub '2010/4/23 ADD BY SONIA 99/5/1起不再列印
    If strSrvDate(1) >= 20100501 And Mid(Pub_StrUserSt03, 1, 2) <> "F1" Then Exit Sub
    
    '2010/5/5 MODIFY BY SONIA 外商FCT,S案仍要印
    'StrSQLa = "Select * From CaseCloseSheet Where CCS01='" & strCCS01 & "' Order By CCS02 "
    StrSQLa = "Select * From CaseCloseSheet Where CCS01='" & strCCS01 & "' AND CCS04 IN ('FCT','S') Order By CCS02 "
    '2010/5/5 END
    rsA.CursorLocation = adUseClient
    rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
    '若有接洽結案單資料
    If rsA.RecordCount > 0 Then
        If blnShowPrintMsg = False Then GoTo RePrint
        'Modify By Cheng 2003/12/03
        '設確定取消按鈕
'        MsgBox "準備列印接洽結案單!!!", vbExclamation + vbOKOnly
        If MsgBox("準備列印接洽結案單!!!", vbExclamation + vbOKCancel) = vbOK Then
RePrint:
            '移至第一筆資料
            rsA.MoveFirst
            While Not rsA.EOF
                ' 列印國內案件接洽及結案記錄單
                If strKind = "0" Then
                  'Modify by Morgan 2005/5/18
                  'g_PrtForm001.PrintForm "" & rsA("CCS03").Value, "" & rsA("CCS04").Value, "" & rsA("CCS05").Value, "" & rsA("CCS06").Value, "" & rsA("CCS07").Value
                  g_PrtForm001.PrintForm "" & rsA("CCS03").Value, "" & rsA("CCS04").Value, "" & rsA("CCS05").Value, "" & rsA("CCS06").Value, "" & rsA("CCS07").Value, , "" & rsA("CCS08").Value, True
                ElseIf strKind = "1" Then
                    g_PrtForm001.PrintFormCPLA "" & rsA("CCS04").Value, "" & rsA("CCS05").Value, "" & rsA("CCS06").Value, "" & rsA("CCS07").Value, True
                End If
                rsA.MoveNext
            Wend
            Printer.EndDoc 'Add by Morgan 2009/5/27 改單一文件以免被其他列印文件插入
            
            If blnShowRePrintMsg = True Then
                '可重覆列接洽結案單
                If MsgBox("接洽結案單已列印完畢，您是否要重新列印???", vbExclamation + vbYesNo + vbDefaultButton2) = vbYes Then
                    GoTo RePrint
                End If
            End If
        End If
    End If
    If rsA.State <> adStateClosed Then rsA.Close
    Set rsA = Nothing
End Sub

'Remove by Morgan 2009/8/20 國外部業務改可收所內信件
''2008/12/3 ADD BY SONIA
''檢查是否都是國外部的客戶
'Public Function PUB_CHKcusales(strCustomer As String) As Boolean
'Dim i As Integer, varTmp As Variant
'Dim j As Integer   '客戶數
'Dim k As Integer   '國外部客戶數
'Dim CuNo As String
'
'   PUB_CHKcusales = True
'   j = 0: k = 0
'   varTmp = Split(strCustomer, ",")
'   For i = 0 To UBound(varTmp)
'      If varTmp(i) <> "" Then
'         CuNo = varTmp(i)
'         j = j + 1
'         If Mid(GetCuSales(CuNo), 1, 1) = "F" Then
'            k = k + 1
'         End If
'      End If
'   Next
'
'   If j = k Then
'      PUB_CHKcusales = False
'   End If
'
'End Function
''2008/12/3 END

'Removed by Morgan 2012/8/20 取消改用 PUB_GetFmpCP14
''2008/12/3 ADD BY SONIA
''取得FMP,FMT主管機關來函承辦人預設
'Public Function PUB_GetFMCASECP14(strCP01 As String, strCP02 As String, strCP03 As String, strCP04 As String) As String
'Dim StrSQLa As String
'Dim rsA As New ADODB.Recordset
'Dim m_FA10 As String
'Dim m_CU12 As String
'
'   PUB_GetFMCASECP14 = "": m_FA10 = "": m_CU12 = ""
'   StrSQLa = "Select CU12,nvl(FA10,CU10) FA10 From Patent, Customer, Fagent Where substr(PA26,1,8)=CU01(+) And substr(PA26,9,1)=CU02(+) And substr(PA75,1,8)=FA01(+) And substr(PA75,9,1)=FA02(+) And PA01='" & strCP01 & "' And PA02='" & strCP02 & "' And PA03='" & strCP03 & "' And PA04='" & strCP04 & "' "
'   StrSQLa = StrSQLa & " union Select CU12,nvl(FA10,CU10) FA10 From Trademark, Customer, Fagent Where substr(TM23,1,8)=CU01(+) And substr(TM23,9,1)=CU02(+) And substr(TM44,1,8)=FA01(+) And substr(TM44,9,1)=FA02(+) And TM01='" & strCP01 & "' And TM02='" & strCP02 & "' And TM03='" & strCP03 & "' And TM04='" & strCP04 & "' "
'   StrSQLa = StrSQLa & " union Select CU12,nvl(FA10,CU10) FA10 From Lawcase, Customer, Fagent Where substr(LC11,1,8)=CU01(+) And substr(LC11,9,1)=CU02(+) And substr(LC22,1,8)=FA01(+) And substr(LC22,9,1)=FA02(+) And LC01='" & strCP01 & "' And LC02='" & strCP02 & "' And LC03='" & strCP03 & "' And LC04='" & strCP04 & "' "
'   StrSQLa = StrSQLa & " union Select CU12,CU10 AS FA10 From Hirecase, Customer, Fagent Where substr(HC05,1,8)=CU01(+) And substr(HC05,9,1)=CU02(+) And HC01='" & strCP01 & "' And HC02='" & strCP02 & "' And HC03='" & strCP03 & "' And HC04='" & strCP04 & "' "
'   StrSQLa = StrSQLa & " union Select CU12,nvl(FA10,CU10) FA10 From ServicePractice, Customer, Fagent Where substr(SP08,1,8)=CU01(+) And substr(SP08,9,1)=CU02(+) And substr(SP26,1,8)=FA01(+) And substr(SP26,9,1)=FA02(+) And SP01='" & strCP01 & "' And SP02='" & strCP02 & "' And SP03='" & strCP03 & "' And SP04='" & strCP04 & "' "
'   rsA.CursorLocation = adUseClient
'   rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
'   If rsA.RecordCount > 0 Then
'      m_CU12 = "" & rsA("CU12").Value
'      m_FA10 = "" & rsA("FA10").Value
'   End If
'   If rsA.State <> adStateClosed Then rsA.Close
'   Set rsA = Nothing
'
'   '智權人員為國外部員工者依FC代理人國籍設定
'   If Mid(m_CU12, 1, 1) = "F" Then
'      If Mid(m_FA10, 1, 3) = "011" Then     '日本預設王文安
'         PUB_GetFMCASECP14 = "88003"
'      Else                                  '非日本預設阮威立
'         'Modify by Morgan 2011/2/25 85030 留職停薪半年,改 88003
'         PUB_GetFMCASECP14 = "88003"
'      End If
'   Else
'      PUB_GetFMCASECP14 = ""
'   End If
'End Function
''2008/12/3 END

'Add By Cheng 2003/04/03
'取得最近收文的A類接洽單之智權人員
Public Function PUB_GetAKindSalesNo(strCP01 As String, strCP02 As String, strCP03 As String, strCP04 As String) As String
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset
Dim strST04 As String '在職, 離職
Dim strCU12 As String '業務區
'92.11.20 ADD BY SONIA
Dim strST15 As String '收文目前業務區
Dim strCP13 As String 'Added by Morgan 2020/3/24

   'Added by Morgan 2023/5/2
   'modify by sonia 2025/7/30 +LIN
   If strCP01 = "FCL" Or strCP01 = "LIN" Then
      PUB_GetAKindSalesNo = PUB_GetFCLSalesNo(strCP01, strCP02, strCP03, strCP04)
      Exit Function
   End If
   'end 2023/5/2
   
   PUB_GetAKindSalesNo = ""
   
   '2009/12/30 add by sonia 先抓進度檔的業務區判斷是否國外部收文P-093541
   strST04 = "": strCU12 = ""
   'modify by sonia 2024/10/8 再加專利商標之案件性質993改系統類別，FCT-052568
   'StrSQLa = "Select * From CaseProgress, Staff Where CP13=ST01(+) And CP01='" & strCP01 & "' And CP02='" & strCP02 & "' And CP03='" & strCP03 & "' And CP04='" & strCP04 & "' And CP05 Is Not Null And CP09 <'B' And CP57 Is Null  Order By CP05 Desc, CP09 Desc "
   StrSQLa = "Select * From CaseProgress, Staff Where CP13=ST01(+) And CP01='" & strCP01 & "' And CP02='" & strCP02 & "' And CP03='" & strCP03 & "' And CP04='" & strCP04 & "' And CP05 Is Not Null And (CP09 <'B' or cp01||cp10 in (select cpm01||cpm02 from casepropertymap where cpm03='改系統類別')) And CP57 Is Null  Order By CP05 Desc, CP09 Desc "
   rsA.CursorLocation = adUseClient
   rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
   If rsA.RecordCount > 0 Then
      strCP13 = "" & rsA("CP13").Value 'Added by Morgan 2020/3/24
      PUB_GetAKindSalesNo = "" & rsA("CP13").Value
      'Modified by Morgan 2018/3/15 改抓原業務區　Ex.A4024 陳增廣 案件
      'strCU12 = "" & rsA("ST15").Value
      strCU12 = "" & rsA("CP12").Value
      'end 2018/3/15
      strST04 = "" & rsA("ST04").Value
      strST15 = "" & rsA("ST15").Value
   Else
      'Add By Sindy 2012/10/23 有沒有A類智權人員改抓B類智權人員
      If rsA.State <> adStateClosed Then rsA.Close
      Set rsA = Nothing
      StrSQLa = "Select * From CaseProgress, Staff Where CP13=ST01(+) And CP01='" & strCP01 & "' And CP02='" & strCP02 & "' And CP03='" & strCP03 & "' And CP04='" & strCP04 & "' And CP05 Is Not Null And CP09 <'C' And CP57 Is Null  Order By CP05 Desc, CP09 Desc "
      rsA.CursorLocation = adUseClient
      rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
      If rsA.RecordCount > 0 Then
         strCP13 = "" & rsA("CP13").Value 'Added by Morgan 2020/3/24
         PUB_GetAKindSalesNo = "" & rsA("CP13").Value
         'Modified by Morgan 2018/3/15 改抓原業務區　Ex.A4024 陳增廣 案件
         'strCU12 = "" & rsA("ST15").Value
         strCU12 = "" & rsA("CP12").Value
         'end 2018/3/15
         strST04 = "" & rsA("ST04").Value
         strST15 = "" & rsA("ST15").Value
      End If
      '2012/10/23 End
   End If
   If rsA.State <> adStateClosed Then rsA.Close
   Set rsA = Nothing
   If Mid(strCU12, 1, 1) = "F" Then
      '2010/7/28 add by sonia 外專收文之所有案件(FMP)改以FCP案件方式處理
      If Mid(strCU12, 1, 2) = "F2" Then
         PUB_GetAKindSalesNo = PUB_GetFCPSalesNo(strCP01, strCP02, strCP03, strCP04)
         strST04 = "1"
      End If
      '2010/7/28 end
      '2011/4/28 add by sonia 外商收文之所有案件改以FCT案件方式處理
      If Mid(strCU12, 1, 2) = "F1" Then
         'add by sonia 2020/11/13 FCT轉T案(T台灣案改用國內規則)X66817案件FCT轉T但內商尚未收文T-224348催期限會帶錯智權人員
         If strCP01 = "T" Then
            StrSQLa = "Select TM10 From Trademark Where TM01='" & strCP01 & "' And TM02='" & strCP02 & "' And TM03='" & strCP03 & "' And TM04='" & strCP04 & "' "
            rsA.CursorLocation = adUseClient
            rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
            If rsA.RecordCount > 0 Then
               If "" & rsA("TM10").Value = "000" Then
                  If rsA.State <> adStateClosed Then rsA.Close
                  Set rsA = Nothing
                  GoTo TAG1
               End If
            End If
            If rsA.State <> adStateClosed Then rsA.Close
            Set rsA = Nothing
         End If
         'end 2020/11/13
         PUB_GetAKindSalesNo = PUB_GetFCTSalesNo(strCP01, strCP02, strCP03, strCP04)
         strST04 = "1"
      End If
      '2011/4/28 end
      GoTo NextStop
      
   'Added by Morgan 2020/3/24
   '系統類別有L之案件，不抓客戶檔智權人員，直接抓最後收文之智權人員
   ElseIf strSrvDate(1) >= 智慧所更名日 And InStr(strCP01, "L") > 0 Then
      '若離職改抓該員工之ST52~ST55,若沒有或都離職改抓最後收文智權人員的 ST15 之 A0909
      If strST04 <> "1" Then
         'Modified by Morgan 2020/4/8 +A0909
         StrSQLa = "select s1.st52,s1.st53,s1.st54,s1.st55,s2.st04 x2,s3.st04 x3,s4.st04 x4,s5.st04 x5,A0909" & _
            " from staff s1,staff s2,staff s3,staff s4,staff s5,acc090" & _
            " where s1.st01='" & strCP13 & "' and s2.st01(+)=s1.st52 and s3.st01(+)=s1.st53 and s4.st01(+)=s1.st54 and s5.st01(+)=s1.st55 and a0901(+)=s1.st15"
         rsA.CursorLocation = adUseClient
         rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
         If rsA.RecordCount > 0 Then
            If rsA("x2") = "1" Then
               PUB_GetAKindSalesNo = rsA("st52")
            ElseIf rsA("x3") = "1" Then
               PUB_GetAKindSalesNo = rsA("st53")
            ElseIf rsA("x4") = "1" Then
               PUB_GetAKindSalesNo = rsA("st54")
            ElseIf rsA("x5") = "1" Then
               PUB_GetAKindSalesNo = rsA("st55")
            'Added by Morgan 2020/4/8
            Else
               PUB_GetAKindSalesNo = rsA("A0909")
            'end 2020/4/8
            End If
         End If
         If rsA.State <> adStateClosed Then rsA.Close
         Set rsA = Nothing
      End If
      'Modified by Morgan 2020/4/8
      'GoTo NextStop
      Exit Function
      'end 2020/4/8
   'end 2020/3/24
   End If
   '2009/12/30 END
   
TAG1: 'add by sonia 2020/11/13
   strST04 = "": strCU12 = ""
   
   '****抓申請人所屬智權人員
   StrSQLa = "Select CU13, CU12, ST04 From Patent, Customer, Staff Where substr(PA26,1,8)=CU01 And substr(PA26,9,1)=CU02 And CU13=ST01 And PA01='" & strCP01 & "' And PA02='" & strCP02 & "' And PA03='" & strCP03 & "' And PA04='" & strCP04 & "' "
   StrSQLa = StrSQLa & " union Select CU13, CU12, ST04 From Trademark, Customer, Staff Where substr(TM23,1,8)=CU01 And substr(TM23,9,1)=CU02 And CU13=ST01 And TM01='" & strCP01 & "' And TM02='" & strCP02 & "' And TM03='" & strCP03 & "' And TM04='" & strCP04 & "' "
   StrSQLa = StrSQLa & " union Select CU13, CU12, ST04 From Lawcase, Customer, Staff Where substr(LC11,1,8)=CU01 And substr(LC11,9,1)=CU02 And CU13=ST01 And LC01='" & strCP01 & "' And LC02='" & strCP02 & "' And LC03='" & strCP03 & "' And LC04='" & strCP04 & "' "
   StrSQLa = StrSQLa & " union Select CU13, CU12, ST04 From Hirecase, Customer, Staff Where substr(HC05,1,8)=CU01 And substr(HC05,9,1)=CU02 And CU13=ST01 And HC01='" & strCP01 & "' And HC02='" & strCP02 & "' And HC03='" & strCP03 & "' And HC04='" & strCP04 & "' "
   StrSQLa = StrSQLa & " union Select CU13, CU12, ST04 From ServicePractice, Customer, Staff Where substr(SP08,1,8)=CU01 And substr(SP08,9,1)=CU02 And CU13=ST01 And SP01='" & strCP01 & "' And SP02='" & strCP02 & "' And SP03='" & strCP03 & "' And SP04='" & strCP04 & "' "
   rsA.CursorLocation = adUseClient
   rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
   If rsA.RecordCount > 0 Then
       PUB_GetAKindSalesNo = "" & rsA("CU13").Value
       strCU12 = "" & rsA("CU12").Value
       strST04 = "" & rsA("ST04").Value
   End If
   If rsA.State <> adStateClosed Then rsA.Close
   Set rsA = Nothing
   
  'add by sonia 2021/12/23
  If PUB_GetAKindSalesNo = "96029" Or PUB_GetAKindSalesNo = "96030" Then GoTo NextStop
  'end 2021/12/23
  
   'add by sonia 2021/12/20 從下面移上來,先判斷是不是MCT案件 T-237213，否則申請人非MCT者會有錯
   StrSQLa = "Select tm01,tm02,tm03,tm04,tm44,fa120 From fagent," & _
             "(select tm01,tm02,tm03,tm04,tm44 from trademark where tm01='" & strCP01 & "' and tm02='" & strCP02 & "' and tm03='" & strCP03 & "' and tm04='" & strCP04 & "' union " & _
             " select pa01,pa02,pa03,pa04,pa75 from patent where pa01='" & strCP01 & "' and pa02='" & strCP02 & "' and pa03='" & strCP03 & "' and pa04='" & strCP04 & "' union " & _
             " select sp01,sp02,sp03,sp04,sp26 from servicepractice where sp01='" & strCP01 & "' and sp02='" & strCP02 & "' and sp03='" & strCP03 & "' and sp04='" & strCP04 & "' union " & _
             " select lc01,lc02,lc03,lc04,lc22 from lawcase where lc01='" & strCP01 & "' and lc02='" & strCP02 & "' and lc03='" & strCP03 & "' and lc04='" & strCP04 & "') " & _
             "  where tm44 is not null and substr(tm44,1,8)=fa01(+) and substr(tm44,9)=fa02(+)"
   rsA.CursorLocation = adUseClient
   rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
   If rsA.RecordCount > 0 Then
      If InStr(strCP01, "T") > 0 Then
         PUB_GetAKindSalesNo = "" & rsA("FA120").Value
         strST15 = "P21": strCU12 = "P21"
      End If
   End If
   If rsA.State <> adStateClosed Then rsA.Close
   Set rsA = Nothing
   'modify by sonia 2022/8/16 T-124844
   'If Mid(PUB_GetAKindSalesNo, 1, 4) = "MCTF" Then GoTo NextStop
   If Mid(PUB_GetAKindSalesNo, 1, 4) = "MCTF" Then Exit Function
   'end 2022/8/16
   'end 2021/12/20
   
   '若已離職或為虛建ID
   '2008/12/2 modify by sonia 加控制智權人員為國外部員工者
   'If strST04 <> "1" Or PUB_GetAKindSalesNo < "63001" Then
   '2010/8/24 MODIFY BY SONIA 國外部員工已改於上方處理故取消但要控制智權部客戶轉至國外部後離職X56657(P-077399)
   'If strST04 <> "1" Or PUB_GetAKindSalesNo < "63001" Or Mid(strCU12, 1, 1) = "F" Then
   If Mid(strCU12, 1, 1) = "F" Then
      Select Case strCP01
         Case "P", "PS", "FCP", "FG", "CFP", "CPS"
            PUB_GetAKindSalesNo = PUB_GetFCPSalesNo(strCP01, strCP02, strCP03, strCP04)
            strST04 = "1"
         'modify by sonia 2019/7/31 +ACS系統類別
         Case "L", "LA", "FCL", "LIN", "CFL", "ACS"
         Case Else
            PUB_GetAKindSalesNo = PUB_GetFCTSalesNo(strCP01, strCP02, strCP03, strCP04)
            strST04 = "1"
      End Select
      GoTo NextStop
      
'cancel by sonia 2021/12/20 移到上面去
'   'add by sonia 2019/3/28 CU13為MCTF人員改抓案件FC代理人之FA120
'   'modify by sonia 2019/6/27 無申請人時最後收文為MCTF小組人員TS-001672
'   ElseIf Mid(PUB_GetAKindSalesNo, 1, 4) = "MCTF" Or InStr(Pub_GetSpecMan("MCTMember"), PUB_GetAKindSalesNo) > 0 Then
'      StrSQLa = "Select tm01,tm02,tm03,tm04,tm44,fa120 From fagent," & _
'                "(select tm01,tm02,tm03,tm04,tm44 from trademark where tm01='" & strCP01 & "' and tm02='" & strCP02 & "' and tm03='" & strCP03 & "' and tm04='" & strCP04 & "' union " & _
'                " select pa01,pa02,pa03,pa04,pa75 from patent where pa01='" & strCP01 & "' and pa02='" & strCP02 & "' and pa03='" & strCP03 & "' and pa04='" & strCP04 & "' union " & _
'                " select sp01,sp02,sp03,sp04,sp26 from servicepractice where sp01='" & strCP01 & "' and sp02='" & strCP02 & "' and sp03='" & strCP03 & "' and sp04='" & strCP04 & "' union " & _
'                " select lc01,lc02,lc03,lc04,lc22 from lawcase where lc01='" & strCP01 & "' and lc02='" & strCP02 & "' and lc03='" & strCP03 & "' and lc04='" & strCP04 & "') " & _
'                "  where tm44 is not null and substr(tm44,1,8)=fa01(+) and substr(tm44,9)=fa02(+)"
'      rsA.CursorLocation = adUseClient
'      rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
'      If rsA.RecordCount > 0 Then
'         PUB_GetAKindSalesNo = "" & rsA("FA120").Value
'         strST15 = "P21"
'      End If
'      If rsA.State <> adStateClosed Then rsA.Close
'      Set rsA = Nothing
'   'end 2019/3/28
'end 2021/12/20
   
   Else
      'add by sonia 2024/8/12 客戶檔智權人員小於6字頭或大於G，可能是特殊之共用帳號，若有系統特殊設定人員時，則案件智權人員維持為客戶檔的智權人員
      If PUB_GetAKindSalesNo < "63001" Or PUB_GetAKindSalesNo > "G" Then
         If Pub_GetSpecMan("" & PUB_GetAKindSalesNo & "業績人員") <> "" Then
            Exit Function
         End If
      End If
      'end 2024/8/12
      
      'Modify by Amy 2022/11/03 +名字不是「無效」ex:T-186173 客戶檔及下一程序都掛 北三無效,進度產生的智權人員卻是進度最後一個的智權人員
      'modify by sonia 2022/12/28 +名字也不是「備用」CFT-014954
      If strST04 <> "1" Or (PUB_GetAKindSalesNo < "63001" And InStr(GetPrjSalesNM(PUB_GetAKindSalesNo), "無效") = 0 And InStr(GetPrjSalesNM(PUB_GetAKindSalesNo), "備用") = 0) Then
   '2010/8/24 END
      '2008/12/2 end
          strST04 = ""
          '****抓進度檔的智權人員
          'Modify By Cheng 2003/04/11
          'strSQLA = "Select * From CaseProgress Where CP01='" & strCP01 & "' And CP02='" & strCP02 & "' And CP03='" & strCP03 & "' And CP04='" & strCP04 & "' And CP05 Is Not Null And CP09 <'B' And CP57 Is Null  Order By CP05 Desc, CP09 Desc "
          StrSQLa = "Select * From CaseProgress, Staff Where CP13=ST01(+) And CP01='" & strCP01 & "' And CP02='" & strCP02 & "' And CP03='" & strCP03 & "' And CP04='" & strCP04 & "' And CP05 Is Not Null And CP09 <'B' And CP57 Is Null  Order By CP05 Desc, CP09 Desc "
          rsA.CursorLocation = adUseClient
          rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
          If rsA.RecordCount > 0 Then
              PUB_GetAKindSalesNo = "" & rsA("CP13").Value
      '        'Modify By Cheng 2003/08/12
      '        '業務區用ST15
      ''        strCU12 = "" & rsA("CP12").Value
      '        strCU12 = "" & rsA("ST15").Value
              strST04 = "" & rsA("ST04").Value
              '92.11.20 ADD BY SONIA
              strST15 = "" & rsA("ST15").Value
              '92.11.20 END
          Else
               'Add By Sindy 2012/10/23 有沒有A類智權人員改抓B類智權人員
               If rsA.State <> adStateClosed Then rsA.Close
               Set rsA = Nothing
               StrSQLa = "Select * From CaseProgress, Staff Where CP13=ST01(+) And CP01='" & strCP01 & "' And CP02='" & strCP02 & "' And CP03='" & strCP03 & "' And CP04='" & strCP04 & "' And CP05 Is Not Null And CP09 <'C' And CP57 Is Null  Order By CP05 Desc, CP09 Desc "
               rsA.CursorLocation = adUseClient
               rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
               If rsA.RecordCount > 0 Then
                  PUB_GetAKindSalesNo = "" & rsA("CP13").Value
                  strST04 = "" & rsA("ST04").Value
                  strST15 = "" & rsA("ST15").Value
               'add by sonia 2013/11/14 S-003557 A及B類都已取消收文則抓最後一道進度
               Else
                 If rsA.State <> adStateClosed Then rsA.Close
                 Set rsA = Nothing
                 StrSQLa = "Select * From CaseProgress, Staff Where CP13=ST01(+) And CP01='" & strCP01 & "' And CP02='" & strCP02 & "' And CP03='" & strCP03 & "' And CP04='" & strCP04 & "' And CP05 Is Not Null And CP09 <'C' Order By CP05 Desc, CP09 Desc "
                 rsA.CursorLocation = adUseClient
                 rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
                 If rsA.RecordCount > 0 Then
                    PUB_GetAKindSalesNo = "" & rsA("CP13").Value
                    strCU12 = "" & rsA("ST15").Value
                    strST04 = "" & rsA("ST04").Value
                    strST15 = "" & rsA("ST15").Value
                 End If
               '2013/11/14 end
               End If
               '2012/10/23 End
          End If
          If rsA.State <> adStateClosed Then rsA.Close
          Set rsA = Nothing
      '92.11.21 ADD BY SONIA
      Else
         Exit Function
      '92.11.21 END
      End If
   End If   '2010/8/24 ADD BY SONIA
   
NextStop:
   '若已離職
   If strST04 <> "1" Then
       'Added by Lydia 2021/11/11 若為內商離職人員特別區分通知人員
       If Left(strCU12, 2) = "P2" Then
          StrSQLa = PUB_GetManP2(PUB_GetAKindSalesNo)
          PUB_GetAKindSalesNo = StrSQLa
       Else
       'end 2021/11/11
          '****抓業務區在職最小員工編號(2007/08/16 改抓部門檔的主管)
          'edit by nickc 2007/08/16 改抓部門檔的主管
          'StrSQLa = "Select * From Staff Where ST04='1' And ST15='" & strCU12 & "' Order By ST01 "
          StrSQLa = "Select * From acc090 Where a0901='" & strCU12 & "'  "
          rsA.CursorLocation = adUseClient
          rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
          If rsA.RecordCount > 0 Then
              'edit by nickc 2007/08/16 改抓部門檔的主管
              'PUB_GetAKindSalesNo = "" & rsA("ST01").Value
              PUB_GetAKindSalesNo = "" & rsA("A0909").Value
          End If
          If rsA.State <> adStateClosed Then rsA.Close
          Set rsA = Nothing
       End If 'Added by Lydia 2021/11/11
   '92.11.20 ADD BY SONIA
   '未離職但已調區
   Else
      '2008/12/2 modify by sonia 調區控制不管智權人員為國外部員工者
      'If strCU12 <> strST15 Then
      If strCU12 <> strST15 And Mid(strCU12, 1, 1) <> "F" Then
      '2008/12/2 end
         '****抓原業務區在職最小員工編號(2007/08/16 改抓部門檔的主管)
         'edit by nickc 2007/08/16 改抓部門檔的主管
         'StrSQLa = "Select * From Staff Where ST04='1' And ST15='" & strCU12 & "' Order By ST01 "
         StrSQLa = "Select * From acc090 Where  a0901='" & strCU12 & "' "
         rsA.CursorLocation = adUseClient
         rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
         If rsA.RecordCount > 0 Then
             'edit by nickc 2007/08/16 改抓部門檔的主管
             'PUB_GetAKindSalesNo = "" & rsA("ST01").Value
             PUB_GetAKindSalesNo = "" & rsA("A0909").Value
         End If
         If rsA.State <> adStateClosed Then rsA.Close
         Set rsA = Nothing
      End If
   '92.11.20 END
   End If
   
End Function

'Add By Cheng 2003/04/07
'取得FCP承辦智權人員
'Modify By Sindy 2017/2/17 + , Optional ByVal strCP10 As String = "", Optional ByRef strNa01 As String
Public Function PUB_GetFCPSalesNo(ByVal strPA01 As String, ByVal strPA02 As String, ByVal strPA03 As String, _
   ByVal strPA04 As String, Optional ByVal strCP10 As String = "", Optional ByRef strNA01 As String) As String
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset
 
   PUB_GetFCPSalesNo = ""
   'Add By Sindy 2017/2/17 取得代理人國籍
   strNA01 = ""
   If strCP10 = 年費 Then
      StrSQLa = "Select NA51,PA76,NA01 From Patent, Fagent, Nation Where " & ChgPatent(strPA01 & strPA02 & strPA03 & strPA04) & " AND PA76 is not null And substr(PA76,1,8)=FA01 And substr(PA76,9,1)=FA02 And FA10=NA01 "
      If rsA.State <> adStateClosed Then rsA.Close
      rsA.CursorLocation = adUseClient
      rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
      '有年費代理人資料
      If rsA.RecordCount > 0 Then
         If strNA01 = "" Then strNA01 = "" & rsA.Fields("NA01").Value
      End If
   End If
   '2017/2/17 END
   
   'modify BY SONIA 2013/12/30 Y51333010東京銀龍轉北京銀龍但指定業務,故加代理人欄
   'Modify By Sindy 2017/2/17 + ,NA01
   StrSQLa = "Select NA51,PA75,NA01 From Patent, Fagent, Nation Where " & ChgPatent(strPA01 & strPA02 & strPA03 & strPA04) & " And substr(PA75,1,8)=FA01 And substr(PA75,9,1)=FA02 And FA10=NA01 "
   StrSQLa = StrSQLa & " Union Select NA51,SP26,NA01 From ServicePractice, Fagent, Nation Where " & ChgService(strPA01 & strPA02 & strPA03 & strPA04) & " And substr(SP26,1,8)=FA01 And substr(SP26,9,1)=FA02 And FA10=NA01 "
   'Add By Sindy 2019/4/15 + lawcase
   StrSQLa = StrSQLa & " Union Select NA51,LC22,NA01 From lawcase, Fagent, Nation Where " & ChgLawcase(strPA01 & strPA02 & strPA03 & strPA04) & " And substr(LC22,1,8)=FA01 And substr(LC22,9,1)=FA02 And FA10=NA01 "
   If rsA.State <> adStateClosed Then rsA.Close
   rsA.CursorLocation = adUseClient
   rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
   '若代理人有資料
   If rsA.RecordCount > 0 Then
      'Add By Sindy 2017/2/17 取得代理人國籍
      If strNA01 = "" Then strNA01 = "" & rsA.Fields("NA01").Value
      '2017/2/17 END
      
      PUB_GetFCPSalesNo = "" & rsA.Fields(0).Value
      'Modified by Lydia 2024/05/27 改成用Y編號+日文承辦業務
      ''ADD BY SONIA 2013/12/30 Y51333010東京銀龍轉北京銀龍但指定業務承辦
      'If "" & rsA.Fields(1).Value = "Y51333010" Then
      '   PUB_GetFCPSalesNo = "" & Pub_GetSpecMan("北京銀龍FCP案承辦業務")
      'End If
      ''END 2013/12/30
      ''Added by Lydia 2016/02/03 Y51817040設定日文承辦
      'If "" & rsA.Fields(1).Value = "Y51817040" Then
      '   PUB_GetFCPSalesNo = "" & Pub_GetSpecMan("金杜FCP案日文承辦業務")
      'End If
      ''end 2016/02/03
      ''Added by Lydia 2023/02/19 Y55856000申請人為日本大金的中國相關企業，設定日文承辦
      'If "" & rsA.Fields(1).Value = "Y55856000" Then
      '   PUB_GetFCPSalesNo = "" & Pub_GetSpecMan("大金FCP案日文承辦業務")
      'End If
      ''end 2023/02/19
      StrSQLa = Pub_GetSpecMan(rsA.Fields(1).Value & "日文承辦業務")
      If StrSQLa <> "" Then
         PUB_GetFCPSalesNo = StrSQLa
      End If
      'end 2024/05/27
      
   '若代理人無資料
   Else
      'Modify By Sindy 2017/2/17 + ,NA01
      StrSQLa = "Select NA51,NA01 From Patent, Customer, Nation Where " & ChgPatent(strPA01 & strPA02 & strPA03 & strPA04) & " And substr(PA26,1,8)=CU01 And substr(PA26,9,1)=CU02 And CU10=NA01 "
      StrSQLa = StrSQLa & " Union Select NA51,NA01 From ServicePractice, Customer, Nation Where " & ChgService(strPA01 & strPA02 & strPA03 & strPA04) & " And substr(SP08,1,8)=CU01 And substr(SP08,9,1)=CU02 And CU10=NA01 "
      'Add By Sindy 2019/4/15 + lawcase
      StrSQLa = StrSQLa & " Union Select NA51,NA01 From lawcase, Customer, Nation Where " & ChgLawcase(strPA01 & strPA02 & strPA03 & strPA04) & " And substr(LC11,1,8)=CU01 And substr(LC11,9,1)=CU02 And CU10=NA01 "
      If rsA.State <> adStateClosed Then rsA.Close
      rsA.CursorLocation = adUseClient
      rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
      '若申請人有資料
      If rsA.RecordCount > 0 Then
         'Add By Sindy 2017/2/17 取得申請人國籍
         If strNA01 = "" Then strNA01 = "" & rsA.Fields("NA01").Value
         '2017/2/17 END
         
         PUB_GetFCPSalesNo = "" & rsA.Fields(0).Value
      End If
   End If
   
   If rsA.State <> adStateClosed Then rsA.Close
   Set rsA = Nothing
End Function

'Add By Cheng 2003/09/04
'取得FCT承辦智權人員
'Modified by Lydia 2018/02/06 + strCP10 案件性質
Public Function PUB_GetFCTSalesNo(strTM01 As String, strTM02 As String, strTM03 As String, strTM04 As String, Optional ByVal strCP10 As String = "") As String
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset
Dim strCase(1 To 4) As String
Dim strTM10 As String 'Added by Lydia 2018/02/06 代理人/客戶國別
Dim strNotCP10 As String 'Added by Lydia 2022/04/08 要排除的案件性質

PUB_GetFCTSalesNo = ""
'Added by Lydia 2022/04/08 要排除的案件性質: 剔除726更換代理人 (from 111/4/1 陳金蓮)
'Mark by Lydia 2023/02/14 不限制，參考FCT-008718 --- 陳金蓮
'strNotCP10 = " and CP10 not in ('726') "

' Modify By Sindy 98/02/26 *****
'StrSQLa = "Select NA55 From Trademark, Fagent, Nation Where " & ChgTradeMark(strTM01 & strTM02 & strTM03 & strTM04) & " And substr(TM44,1,8)=FA01 And substr(TM44,9,1)=FA02 And FA10=NA01 "
'rsA.CursorLocation = adUseClient
'rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
''若代理人有資料
'If rsA.RecordCount > 0 Then
'    PUB_GetFCTSalesNo = "" & rsA.Fields(0).Value
''若代理人無資料
'Else
'    If rsA.State <> adStateClosed Then rsA.Close
'    Set rsA = Nothing
'    StrSQLa = "Select NA55 From Trademark, Customer, Nation Where " & ChgTradeMark(strTM01 & strTM02 & strTM03 & strTM04) & " And substr(TM23,1,8)=CU01 And substr(TM23,9,1)=CU02 And CU10=NA01 "
'    rsA.CursorLocation = adUseClient
'    rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
'    '若申請人有資料
'    If rsA.RecordCount > 0 Then
'        PUB_GetFCTSalesNo = "" & rsA.Fields(0).Value
'    End If
'End If
'以每案上一程序填寫接洽紀錄單之智權人員為管制案件期限之對象
'此智權人員必須為在職並且為F1相關部門人員
'Modify By Sindy 2012/2/7 不判斷智權人員必須為F1相關部門人員的條件
ChgCaseNo strTM01 & strTM02 & strTM03 & strTM04, strCase

'Mark by Lydia 2020/05/08 外商: 統一抓最新一道收文之承辦; 之前"英文組和非通知申請案號走新規則NA55",現在還原
'''Added by Lydia 2017/12/27 預設國家檔FCT承辦業務員
''If strSrvDate(1) >= "20180101" And strCase(1) = "FCT" Then
''     'Added by Lydia 2018/02/06 英文組和非通知申請案號,走新規則
''     If strCP10 = "1101" Then
''           GoTo JumpExec '舊規則 (通知申請案號(1101)之智權人員與申請(101)之智權人員相同)
''     End If
''     'end 2018/02/06
''
''     'Modified by Lydia 2018/02/06 + nvl(n1.na01,n2.na01) na01
''     StrSQLa = "select nvl(n1.na55,n2.na55) na55,nvl(n1.na01,n2.na01) na01 " & _
''                      "from trademark,fagent,customer,nation n1,nation n2 " & _
''                      "where tm01='" & strCase(1) & "' and tm02='" & strCase(2) & "' and tm03='" & strCase(3) & "' and tm04='" & strCase(4) & "' " & _
''                      "and substr(tm44,1,8)=fa01(+) and substr(tm44,9,1)=fa02(+) and fa10=n1.na01(+) and substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+) and cu10=n2.na01(+) "
''     'Add By Sindy 2019/4/15 + lawcase
''     StrSQLa = StrSQLa & " Union select nvl(n1.na55,n2.na55) na55,nvl(n1.na01,n2.na01) na01 " & _
''                      "from lawcase,fagent,customer,nation n1,nation n2 " & _
''                      "where lc01='" & strCase(1) & "' and lc02='" & strCase(2) & "' and lc03='" & strCase(3) & "' and lc04='" & strCase(4) & "' " & _
''                      "and substr(lc22,1,8)=fa01(+) and substr(lc22,9,1)=fa02(+) and fa10=n1.na01(+) and substr(lc11,1,8)=cu01(+) and substr(lc11,9,1)=cu02(+) and cu10=n2.na01(+) "
''     rsA.CursorLocation = adUseClient
''     rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
''     If rsA.RecordCount > 0 Then
''        If "" & rsA.Fields("na55") <> "" Then
''             PUB_GetFCTSalesNo = "" & rsA.Fields("na55").Value
''        End If
''        'Added by Lydia 2018/02/06 日文組用舊規則
''        strTM10 = "" & rsA.Fields("na01")
''        If Mid(strTM10, 1, 3) = "011" Then
''           PUB_GetFCTSalesNo = ""
''        End If
''        'end 2018/02/06
''     End If
''    If rsA.State <> adStateClosed Then rsA.Close
''    If PUB_GetFCTSalesNo <> "" Then Exit Function
''End If
'''end 2017/12/27
'end 2020/05/08

JumpExec: 'Added by Lydia 2018/02/06 走舊規則

'Modified by Lydia 2019/07/05 抓AB類最新收文的智權人員;因為阿蓮反應聯絡單frm1106預設都通知到區主管,希望改成包含B類,ex.FCT-42043,FCT-42121
'                                               檢查目前走舊規則(1101)的只有通知申請案號(frm030203_02) 和聯絡單(frm1106),所以一併修改
'StrSQLa = "SELECT CP13,st04 FROM caseprogress,staff " & _
                  "WHERE CP01='" & strCase(1) & "' and CP02='" & strCase(2) & "' and CP03='" & strCase(3) & "' and CP04='" & strCase(4) & "' " & _
                          "and CP09 like 'A%' and CP05=" & _
                  "(SELECT max(CP05) FROM caseprogress " & _
                  "WHERE CP01='" & strCase(1) & "' and CP02='" & strCase(2) & "' and CP03='" & strCase(3) & "' and CP04='" & strCase(4) & "' " & _
                          "and CP09 like 'A%') " & _
                          "and ST01=CP13 "
                          '"and ST01=CP13 and ST04='1' and ST03 like 'F1%' " 'Modify By Sindy 2012/2/6
'Modified by Lydia 2022/04/08 判斷要排除的案件性質 strNotCP10
'Modified by Lydia 2022/11/16 請再改為不限制A或B類收文號。
'StrSQLa = "SELECT CP13,st04 FROM caseprogress,staff " & _
                  "WHERE CP01='" & strCase(1) & "' and CP02='" & strCase(2) & "' and CP03='" & strCase(3) & "' and CP04='" & strCase(4) & "' " & _
                          "and CP09 < 'C' " & strNotCP10 & " and CP05=" & _
                  "(SELECT max(CP05) FROM caseprogress " & _
                  "WHERE CP01='" & strCase(1) & "' and CP02='" & strCase(2) & "' and CP03='" & strCase(3) & "' and CP04='" & strCase(4) & "' " & _
                          "and CP09 < 'C' " & strNotCP10 & " ) " & _
                          "and ST01=CP13 "
'Modified by Lydia 2023/05/19 改為收文日最大且CREATE DATE、TIME最大 CP05=>(CP05||CP66||LPAD(CP67,4,0)) ;  ex.FCT-45859
StrSQLa = "SELECT CP13,st04 FROM caseprogress,staff " & _
                  "WHERE CP01='" & strCase(1) & "' and CP02='" & strCase(2) & "' and CP03='" & strCase(3) & "' and CP04='" & strCase(4) & "' " & strNotCP10 & " and (CP05||CP66||LPAD(CP67,4,0))=" & _
                  "(SELECT max((CP05||CP66||LPAD(CP67,4,0))) FROM caseprogress " & _
                  "WHERE CP01='" & strCase(1) & "' and CP02='" & strCase(2) & "' and CP03='" & strCase(3) & "' and CP04='" & strCase(4) & "' " & strNotCP10 & " ) and ST01=CP13 "
StrSQLa = StrSQLa & "ORDER BY CP09 DESC "
'end 2019/07/05
rsA.CursorLocation = adUseClient
rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
'有資料
If rsA.RecordCount > 0 Then
   'Modify By Sindy 2012/2/6
'   PUB_GetFCTSalesNo = "" & rsA.Fields(0).Value
   If "" & rsA.Fields(1) = "1" Then
      PUB_GetFCTSalesNo = "" & rsA.Fields(0).Value
   End If
   '2012/2/6 End
Else
   'Add By Sindy 2012/10/23 有沒有A類智權人員改抓B類智權人員
   If rsA.State <> adStateClosed Then rsA.Close
   Set rsA = Nothing
   'Modified by Lydia 2022/04/08 判斷要排除的案件性質 strNotCP10
   'Modified by Lydia 2023/05/19 改為收文日最大且CREATE DATE、TIME最大 CP05=>(CP05||CP66||LPAD(CP67,4,0)) ;  ex.FCT-45859
   StrSQLa = "SELECT CP13,st04 FROM caseprogress,staff " & _
                     "WHERE CP01='" & strCase(1) & "' and CP02='" & strCase(2) & "' and CP03='" & strCase(3) & "' and CP04='" & strCase(4) & "' " & _
                             "and CP09 like 'B%'  " & strNotCP10 & " and (CP05||CP66||LPAD(CP67,4,0))=" & _
                     "(SELECT max((CP05||CP66||LPAD(CP67,4,0))) FROM caseprogress " & _
                     "WHERE CP01='" & strCase(1) & "' and CP02='" & strCase(2) & "' and CP03='" & strCase(3) & "' and CP04='" & strCase(4) & "' " & _
                             "and CP09 like 'B%' " & strNotCP10 & " ) " & _
                             "and ST01=CP13 "
   rsA.CursorLocation = adUseClient
   rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
   '有資料
   If rsA.RecordCount > 0 Then
      If "" & rsA.Fields(1) = "1" Then
         PUB_GetFCTSalesNo = "" & rsA.Fields(0).Value
      End If
   End If
   '2012/10/23 End
End If
If PUB_GetFCTSalesNo = "" Then
'   PUB_GetFCTSalesNo = "F4103" '若無智權人員, 改給一虛擬智權人員編號
   'Modify By Sindy 2012/2/4
   '原控制抓該案件最後收文A類且在職的智權人員, 若無則掛 F4103
   '改為抓該案件最後收文A類智權人員 , 若該智權人員為離職時則改抓該智權人員的第二級主管, 第二級離職抓第三級, 依此類推...
   If rsA.RecordCount > 0 Then
      If Trim("" & rsA.Fields(0).Value) <> "" Then
         'Modified by Lydia 2023/07/24 ST55改抓ACC090的A0909,案例：FCT-010805應抓出80030。
         'strSql = "select 2 sort,s1.ST01 A1,s1.ST02 A2,s1.ST52 A3,s2.ST01 A4,s2.ST02 A5,s2.ST04 A6 from staff s1,staff s2 where s1.st01='" & rsA.Fields(0).Value & "' and s1.ST52 is not null and s1.ST52=s2.st01 and s2.st04='1' " & _
                  "Union All " & _
                  "select 3,s1.ST01,s1.ST02,s1.ST53,s2.ST01,s2.ST02,s2.ST04 from staff s1,staff s2 where s1.st01='" & rsA.Fields(0).Value & "' and s1.ST53 is not null and s1.ST53=s2.st01 and s2.st04='1' " & _
                  "Union All " & _
                  "select 4,s1.ST01,s1.ST02,s1.ST54,s2.ST01,s2.ST02,s2.ST04 from staff s1,staff s2 where s1.st01='" & rsA.Fields(0).Value & "' and s1.ST54 is not null and s1.ST54=s2.st01 and s2.st04='1' " & _
                  "Union All " & _
                  "select 5,s1.ST01,s1.ST02,s1.ST55,s2.ST01,s2.ST02,s2.ST04 from staff s1,staff s2 where s1.st01='" & rsA.Fields(0).Value & "' and s1.ST55 is not null and s1.ST55=s2.st01 and s2.st04='1' "
         strSql = "select 2 sort,s1.ST01 A1,s1.ST02 A2,s1.ST52 A3,s2.ST01 A4,s2.ST02 A5,s2.ST04 A6 from staff s1,staff s2 where s1.st01='" & rsA.Fields(0).Value & "' and s1.ST52 is not null and s1.ST52=s2.st01 and s2.st04='1' " & _
                  "Union All " & _
                  "select 3,s1.ST01,s1.ST02,s1.ST53,s2.ST01,s2.ST02,s2.ST04 from staff s1,staff s2 where s1.st01='" & rsA.Fields(0).Value & "' and s1.ST53 is not null and s1.ST53=s2.st01 and s2.st04='1' " & _
                  "Union All " & _
                  "select 4,s1.ST01,s1.ST02,s1.ST54,s2.ST01,s2.ST02,s2.ST04 from staff s1,staff s2 where s1.st01='" & rsA.Fields(0).Value & "' and s1.ST54 is not null and s1.ST54=s2.st01 and s2.st04='1' " & _
                  "Union All " & _
                  "select 5,s1.ST01,s1.ST02,a0909,s2.ST01,s2.ST02,s2.ST04 from staff s1,acc090,staff s2 where s1.st01='" & rsA.Fields(0).Value & "' and s1.st15=a0901 and a0909=s2.st01 and s2.st04='1' "
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strSql)
         If intI = 1 Then
            PUB_GetFCTSalesNo = "" & RsTemp.Fields(4)
         End If
      End If
   End If
   '2012/2/4 End
End If
' 98/02/26 End

'Add By Sindy 2017/2/15 未抓到智權人員時,則取FC代理人的國籍檔FCT業務員
If PUB_GetFCTSalesNo = "" Then
   If rsA.State <> adStateClosed Then rsA.Close
   Set rsA = Nothing
   StrSQLa = "Select ST01, ST15, ST04 From Patent, fagent, Nation, Staff Where substr(PA75,1,8)=FA01 And substr(PA75,9,1)=FA02 And FA10=NA01(+) And NA55=ST01 And PA01='" & strCase(1) & "' And PA02='" & strCase(2) & "' And PA03='" & strCase(3) & "' And PA04='" & strCase(4) & "' "
   StrSQLa = StrSQLa & " union Select ST01, ST15, ST04 From Trademark, fagent, Nation, Staff Where substr(TM44,1,8)=FA01 And substr(TM44,9,1)=FA02 And FA10=NA01(+) And NA55=ST01 And TM01='" & strCase(1) & "' And TM02='" & strCase(2) & "' And TM03='" & strCase(3) & "' And TM04='" & strCase(4) & "' "
   StrSQLa = StrSQLa & " union Select ST01, ST15, ST04 From Lawcase, fagent, Nation, Staff Where substr(LC22,1,8)=FA01 And substr(LC22,9,1)=FA02 And FA10=NA01(+) And NA55=ST01 And LC01='" & strCase(1) & "' And LC02='" & strCase(2) & "' And LC03='" & strCase(3) & "' And LC04='" & strCase(4) & "' "
   StrSQLa = StrSQLa & " union Select ST01, ST15, ST04 From ServicePractice, fagent, Nation, Staff Where substr(SP26,1,8)=FA01 And substr(SP26,9,1)=FA02 And FA10=NA01(+) And NA55=ST01 And SP01='" & strCase(1) & "' And SP02='" & strCase(2) & "' And SP03='" & strCase(3) & "' And SP04='" & strCase(4) & "' "
   rsA.CursorLocation = adUseClient
   rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
   If rsA.RecordCount > 0 Then
       PUB_GetFCTSalesNo = "" & rsA("ST01").Value
   End If
End If
'2017/2/15 END

'Mark by Amy 2021/06/22 秀玲:Mark
'If PUB_GetFCTSalesNo = "89037" Then PUB_GetFCTSalesNo = "68005" 'Modify By Sindy 2012/2/7 89037蘇月星-->68005陳鳳英
If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing
End Function

'2009/9/8 ADD BY SONIA
'取得FCL承辦智權人員
Public Function PUB_GetFCLSalesNo(strTM01 As String, strTM02 As String, strTM03 As String, strTM04 As String) As String
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset
Dim strCase(1 To 4) As String

   PUB_GetFCLSalesNo = ""
   '以每案最後填寫接洽紀錄單之智權人員為管制案件期限之對象
   '此智權人員必須為在職並且為F3,F4相關部門人員
   'Modify By Sindy 2016/1/18 取消 and substr(ST03,1,2) in ('F3','F4')
   'Modify By Sindy 2019/4/10 取消 and ST04='1'
   ChgCaseNo strTM01 & strTM02 & strTM03 & strTM04, strCase
   StrSQLa = "SELECT CP13,st04,CP12 FROM caseprogress,staff " & _
                     "WHERE CP01='" & strCase(1) & "' and CP02='" & strCase(2) & "' and CP03='" & strCase(3) & "' and CP04='" & strCase(4) & "' " & _
                             "and CP09 like 'A%' and CP05=" & _
                     "(SELECT max(CP05) FROM caseprogress " & _
                     "WHERE CP01='" & strCase(1) & "' and CP02='" & strCase(2) & "' and CP03='" & strCase(3) & "' and CP04='" & strCase(4) & "' " & _
                             "and CP09 like 'A%') " & _
                             "and ST01=CP13"
   rsA.CursorLocation = adUseClient
   rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
   '有資料
   If rsA.RecordCount > 0 Then
      If rsA.Fields("st04") = "1" Then
         PUB_GetFCLSalesNo = "" & rsA.Fields(0).Value
      'Modify By Sindy 2019/4/10 增加判斷人員若離職,抓其主管 EX:LIN-000229
      Else
         If Left(rsA.Fields("cp12"), 2) = "F1" Then '外商
            PUB_GetFCLSalesNo = PUB_GetFCTSalesNo(strCase(1), strCase(2), strCase(3), strCase(4))
         ElseIf Left(rsA.Fields("cp12"), 2) = "F2" Then '外專
            PUB_GetFCLSalesNo = PUB_GetFCPSalesNo(strCase(1), strCase(2), strCase(3), strCase(4))
         End If
      End If
      '2019/4/10 END
   End If
   '若無智權人員, 改給一虛擬智權人員編號
   If PUB_GetFCLSalesNo = "" Then PUB_GetFCLSalesNo = "F4101"
   
   If rsA.State <> adStateClosed Then rsA.Close
   Set rsA = Nothing
End Function
'2009/9/8 END

'Add By Cheng 2003/04/08
'取得FCP案件來函新增至進度或下一程序的承辦人
'Modified by Morgan 2022/10/25 strCP14 實際沒用，改為Optional
Public Function PUB_GetFCPPromoterNo(strCP09 As String, strCKindCP10 As String, Optional strCP14 As String) As String
Dim StrSQLa As String, iR As Integer
Dim rsA As New ADODB.Recordset
Dim strCP01 As String '本所案號
Dim strCP02 As String '本所案號
Dim strCP03 As String '本所案號
Dim strCP04 As String '本所案號
Dim strCP10 As String '案件性質
Dim m_CP14 As String '原承辦人   2006/3/28 ADD BY SONIA
Dim strTmpCP14 As String 'Add by Morgan 2007/5/24
Dim strOCP14 As String 'Added by Morgan 2021/5/31 職離承辦工程師
Dim strEP04 As String 'Added by Lydia 2023/12/19

   PUB_GetFCPPromoterNo = ""
   strCP01 = "": strCP02 = "": strCP03 = "": strCP04 = "": strCP10 = "": m_CP14 = ""
   'Modified by Lydia 2023/12/19
   'StrSQLa = "Select * From CaseProgress Where CP09='" & strCP09 & "' "
   StrSQLa = "Select c1.*, EP04 From CaseProgress c1, engineerprogress " & _
             "Where c1.CP09='" & strCP09 & "' and c1.cp09=ep04(+) "
   rsA.CursorLocation = adUseClient
   rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
   If rsA.RecordCount > 0 Then
      strCP01 = "" & rsA("CP01").Value
      strCP02 = "" & rsA("CP02").Value
      strCP03 = "" & rsA("CP03").Value
      strCP04 = "" & rsA("CP04").Value
      strCP10 = "" & rsA("CP10").Value
      m_CP14 = "" & rsA("CP14").Value  '2006/3/28 ADD BY SONIA
      strEP04 = "" & rsA.Fields("ep04") 'Added by Lydia 2023/12/19
   End If
   If rsA.State <> adStateClosed Then rsA.Close
   Set rsA = Nothing
   '若無案件性質, 則退出函式
   If strCP10 = "" Then Exit Function
   '判斷來函性質
   Select Case strCKindCP10
   '2005/9/8 MODIFY BY SONIA 加 1402 '2005/12/8 再加1210,1211,1508
   'Modify by Morgan 2006/5/5 加1007
   'Modify by Morgan 2007/10/24 加1503
   '2010/11/26 MODIFY BY SONIA 加1225依職權電話通知修正
   'MODIFY BY SONIA 2014/5/15  加1227最後通知
   'Modified by Lydia 2016/02/05 +1232通知擇一申復
   'Modified by Morgan 2017/10/11 +1224代理人通知修正,936回覆委任代理人(FMP案會有)--敏莉
   'Modified by Morgan 2024/4/27 +1809對方補充答辯狀 --Sharon
   'Modified by Morgan 2024/5/16 +1815第三方意見 --敏莉
   'modify by sonia 2025/4/22 +1009部分准駁
   'Modify By Sindy 2025/6/19 +1221通知申復
   Case "1001", "1002", "1009", "1201", "1202", "1203", "1301", "1302", "1303", "1304", "1305", "1306", "1307", "1401", "1402", "1502", "1504", "1505", "1506", "1507", _
        "1801", "1802", "1805", "1806", "1807", "1808", "1809", "1815", "1903", "1210", "1211", "1508", "1007", "1503", "1224", "1225", "1227", "1232", "936", "1221"
      Select Case strCP10
         'Modified by Lydia 2025/10/13 +201新案翻譯；ex.FCP-073988在10/9通知修正1201選新案翻譯無法帶出核稿人
         Case "101", "102", "103", "104", "105", "201" '若為新案
            '2009/12/14 ADD BY SONIA 靜芳說改為若有通知實審日後則抓通知實審日後最一道A,B,C類發文之工程師,否則維持原規則
            'Modified by Morgan 2017/6/20 不必限定通知實審日後,依樣要排除其他翻譯--敏莉
            'StrSQLa = "Select * From CASEPROGRESS WHERE CP01='" & strCP01 & "' AND CP02='" & strCP02 & "'" & _
                      " AND CP03='" & strCP03 & "' AND CP04='" & strCP04 & "'" & _
                      " AND CP10 in ('1204','1217') AND CP27 IS NOT NULL AND CP57 IS NULL "
            'modify by sonia 2018/9/11 +外翻F51也要考慮FCP-057256新案翻譯
            StrSQLa = "Select * From CASEPROGRESS,staff WHERE CP01='" & strCP01 & "' AND CP02='" & strCP02 & "'" & _
                      " AND CP03='" & strCP03 & "' AND CP04='" & strCP04 & "'" & _
                      " AND CP10<>'927' AND CP27>0 AND CP57 IS NULL and st01(+)=cp14 and st15 in ('F21','F51') order by cp27 desc"
            'end 2017/6/20
            'end 2007/5/24
            rsA.CursorLocation = adUseClient
            rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
            '有通知實審日
            If rsA.RecordCount > 0 Then
               'Modified by Morgan 2017/6/20
               ''Modified by Morgan 2012/10/9 排除其他翻譯--靜芳
               'StrSQLa = "SELECT CP14,Max(CP27||CP09) Srt FROM CASEPROGRESS,STAFF" & _
                   " WHERE CP01='" & strCP01 & "' AND CP02='" & strCP02 & "'" & _
                   " AND CP03='" & strCP03 & "' AND CP04='" & strCP04 & "'" & _
                   " AND CP27>=" & rsA("CP27").Value & " AND CP14 IS NOT NULL AND CP14=ST01(+) AND ST15='F21' " & _
                   " AND CP10<>'927' Group By CP14 Order By Srt desc "
               'If rsA.State <> adStateClosed Then rsA.Close
               'Set rsA = Nothing
               'rsA.CursorLocation = adUseClient
               'rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
               'If rsA.RecordCount > 0 Then
               '   PUB_GetFCPPromoterNo = "" & rsA("CP14").Value
               'End If
               PUB_GetFCPPromoterNo = "" & rsA("CP14").Value
               'end 2017/6/20
               
               If GetStaffDepartment(PUB_GetFCPPromoterNo) = "F51" Then PUB_GetFCPPromoterNo = "" 'add by sonia 2018/9/11 FCP-057256最大發文日之承辦人為外翻時則改用PUB_GetSpecCP14
            End If
            
            If PUB_GetFCPPromoterNo = "" Then
            '2009/12/14 END
               'Modify by Morgan 2007/5/24
               'StrSQLa = "Select * From Staff Where ST01='" & PUB_GetSpecCP14(strCP01 & strCP02 & strCP03 & strCP04) & "' And ST03<>'F51' And ST04='1' "
               'Modified by Morgan 2021/5/31
               'strTmpCP14 = PUB_GetSpecCP14(strCP01 & strCP02 & strCP03 & strCP04)
               'Modified by Morgan 2022/10/25
               'strTmpCP14 = PUB_GetSpecCP14(strCP01 & strCP02 & strCP03 & strCP04, False)
               strTmpCP14 = PUB_GetSpecCP14(strCP01 & strCP02 & strCP03 & strCP04)
               'end 2022/10/25
               'end 2021/5/31
               '若為內翻編號時抓對照檔的員工編號
               If Left(strTmpCP14, 1) = "F" Then
                  strTmpCP14 = PUB_GetMapID(strTmpCP14)
               End If
               If strTmpCP14 <> "" Then 'Added by Morgan 2022/10/25
                  'Modified by Morgan 2021/5/31
                  'StrSQLa = "Select * From Staff Where ST01='" & strTmpCP14 & "' And ST03<>'F51' And ST04='1' "
                  StrSQLa = "Select * From Staff Where ST01='" & strTmpCP14 & "' And ST03<>'F51'"
                  'end 2007/5/24
                  If rsA.State <> adStateClosed Then rsA.Close
                  Set rsA = Nothing
                  rsA.CursorLocation = adUseClient
                  rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
                  If rsA.RecordCount > 0 Then
                  'Modified by Morgan 2021/5/31 承辦工程師離職改抓該工程師組別的主管
                  '   PUB_GetFCPPromoterNo = "" & rsA("ST01").Value
                  'Else
                     If rsA("st04") = "1" Then
                        PUB_GetFCPPromoterNo = "" & rsA("ST01").Value
                     Else
                        strOCP14 = "" & rsA("ST01").Value
                     End If
                  End If
               End If
               If PUB_GetFCPPromoterNo = "" Then
               'end 2021/5/31
               
                  '2008/11/13 add by sonia 若離職則抓該案最一道A,B,C類發文之工程師
                  'Modified by Morgan 2012/10/9 排除其他翻譯--靜芳
                  StrSQLa = "SELECT CP14,Max(CP27||CP09) Srt FROM CASEPROGRESS,STAFF" & _
                      " WHERE CP01='" & strCP01 & "' AND CP02='" & strCP02 & "'" & _
                      " AND CP03='" & strCP03 & "' AND CP04='" & strCP04 & "'" & _
                      " AND CP27 IS NOT NULL AND CP14 IS NOT NULL AND CP14=ST01(+) AND ST15='F21' " & _
                      " AND CP10<>'927' Group By CP14 Order By Srt desc "
                  If rsA.State <> adStateClosed Then rsA.Close
                  Set rsA = Nothing
                  rsA.CursorLocation = adUseClient
                  rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
                  If rsA.RecordCount > 0 Then
                     '2009/12/11 MODIFY BY SONIA 離職則不預設放到下面做
                     'StrSQLa = "Select * From Staff Where ST01='" & rsA("CP14").Value & "' And ST04='1' "
                     'If rsA.State <> adStateClosed Then rsA.Close
                     'Set rsA = Nothing
                     'rsA.CursorLocation = adUseClient
                     'rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
                     'If rsA.RecordCount > 0 Then
                     '   PUB_GetFCPPromoterNo = "" & rsA("ST01").Value
                     'End If
                     PUB_GetFCPPromoterNo = "" & rsA("CP14").Value
                     '2009/12/11 END
                  End If
               '2008/11/13 END
               End If
               If rsA.State <> adStateClosed Then rsA.Close
               Set rsA = Nothing
            End If
         '2006/3/28 ADD BY SONIA
         'Modify by Morgan 2007/8/31 加807
         Case "421", "801", "802", "803", "804", "807"
            PUB_GetFCPPromoterNo = m_CP14
         '2006/3/28 END
         Case Else '若非新案
            '2008/11/27 MODIFY BY SONIA 改抓該案最一道A,B,C類發文之工程師,若離職則不預設
            'StrSQLa = "Select * From Staff Where ST01='" & strCP14 & "' And ST03<>'F51' And ST04='1' "
            '2009/8/26 MODIFY BY SONIA 某些程序辦的案件性質之核准函依各區管制人設定
            'StrSQLa = "SELECT CP14,Max(CP27||CP09) Srt FROM CASEPROGRESS,STAFF" & _
            '     " WHERE CP01='" & strCP01 & "' AND CP02='" & strCP02 & "'" & _
            '     " AND CP03='" & strCP03 & "' AND CP04='" & strCP04 & "'" & _
            '     " AND CP27 IS NOT NULL AND CP14 IS NOT NULL AND CP14=ST01(+) AND ST15='F21' " & _
            '     " Group By CP14 Order By Srt desc "
            'Modify by Morgan 2009/10/16 +908
            'modify by sonia 2019/11/25 +414申請復權FCP-058616
            'modify by sonia 2025/8/12 +124回復優先權主張
            If strCKindCP10 = "1001" And (strCP10 = "413" Or (strCP10 >= "701" And strCP10 <= "708") Or strCP10 = "401" Or strCP10 = "414" Or strCP10 = "928" Or strCP10 = "908" Or strCP10 = "124") Then
               StrSQLa = "SELECT NA16 AS CP14 FROM PATENT,FAGENT,NATION" & _
                   " WHERE PA01='" & strCP01 & "' AND PA02='" & strCP02 & "'" & _
                   " AND PA03='" & strCP03 & "' AND PA04='" & strCP04 & "'" & _
                   " AND SUBSTR(PA75,1,8)=FA01(+) AND SUBSTR(PA75,9,1)=FA02(+) AND FA10=NA01(+) "
            Else
               'Modified by Morgan 2015/10/7 排除其他翻譯--靜芳
               'Modified by Lydia 2019/08/02 排除F4102 (FCP年費不續辦)
               StrSQLa = "SELECT CP14,Max(CP27||CP09) Srt FROM CASEPROGRESS,STAFF" & _
                   " WHERE CP01='" & strCP01 & "' AND CP02='" & strCP02 & "'" & _
                   " AND CP03='" & strCP03 & "' AND CP04='" & strCP04 & "'" & _
                   " AND CP10<>'927' and cp14<>'F4102' AND CP27 IS NOT NULL AND CP14 IS NOT NULL AND CP14=ST01(+) AND ST15='F21' " & _
                   " Group By CP14 Order By Srt desc "
            End If
            '2009/8/26 END
            If rsA.State <> adStateClosed Then rsA.Close
            Set rsA = Nothing
            rsA.CursorLocation = adUseClient
            rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
            If rsA.RecordCount > 0 Then
               '2009/12/11 MODIFY BY SONIA 離職則不預設放到下面做
               'StrSQLa = "Select * From Staff Where ST01='" & rsA("CP14").Value & "' And ST04='1' "
               'If rsA.State <> adStateClosed Then rsA.Close
               'Set rsA = Nothing
            '2008/11/27 END
               'rsA.CursorLocation = adUseClient
               'rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
               'If rsA.RecordCount > 0 Then
               '   PUB_GetFCPPromoterNo = "" & rsA("ST01").Value
               'End If
               'If rsA.State <> adStateClosed Then rsA.Close
               'Set rsA = Nothing
               PUB_GetFCPPromoterNo = "" & rsA("CP14").Value
               '2009/12/11 END
            End If
      End Select
   Case Else '其他來函性質
      PUB_GetFCPPromoterNo = "" & strUserNum
      'Added by Lydia 2023/12/19 判斷一般來函之相關總收文號為中說預設承辦人; 參考frm06010604_3
      If InStr("201,209,210,235", strCP10) > 0 And strCP10 <> "" Then
         If strCP10 = "201" And strEP04 <> "" Then
             PUB_GetFCPPromoterNo = strEP04
         Else
             PUB_GetFCPPromoterNo = m_CP14
         End If
      End If
      'end 2023/12/19
   End Select
   
'2009/12/11 ADD BY SONIA 靜芳說依上述規則抓出之承辦人若為離職則不預設
CheckOFF:
   'Modify by Morgan 2010/6/3 核准例外
   'If PUB_GetFCPPromoterNo <> "" Then
   'Modified by Lydia 2015/10/05 + 1008
   If PUB_GetFCPPromoterNo <> "" And strCKindCP10 <> "1001" And strCKindCP10 <> "1008" Then
   'end 2010/6/3
      If rsA.State <> adStateClosed Then rsA.Close
      Set rsA = Nothing
      rsA.CursorLocation = adUseClient
      StrSQLa = "Select * From Staff Where ST01='" & PUB_GetFCPPromoterNo & "' And ST04='1' "
      rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
      If rsA.RecordCount = 0 Then
         PUB_GetFCPPromoterNo = ""
      End If
   End If
   
   Set rsA = Nothing 'Added by Lydia 2022/02/15
   
   'Added by Morgan 2017/10/11
   '離職改抓案件工程師組別的主管 , 若案件無則抓工程師主管(參考PUB_GetFmpCP14)
   If PUB_GetFCPPromoterNo = "" Then
      'Modified by Lydia 2019/08/02 排除F4102 (FCP年費不續辦)
      'Modified by Lydia 2022/02/15 FCP-61241的其他翻譯=97031造成110/2/10再審核准通知97031,所以另外判斷「曾威誌A6013掛林軒吉94012」;
      'StrSQLa = "select cp14,st04,st16 from caseprogress,staff where cp01='" & strCP01 & "' and cp02='" & strCP02 & "'" & _
              " and cp03='" & strCP03 & "' and cp04='" & strCP04 & "' and st01(+)=cp14 and st03 in ('F21','F81') and cp14<>'F4102' " & _
              " and cp57 is null order by cp05 desc"
      '另外抓「曾威誌A6013掛林軒吉94012」
      StrSQLa = "select cp05,'94012' as cp14,st04,st16 from caseprogress,staff where cp01='" & strCP01 & "' and cp02='" & strCP02 & "' and cp03='" & strCP03 & "' and cp04='" & strCP04 & "' and st01(+)=cp14 and cp14='A6013' and cp57 is null "
      StrSQLa = StrSQLa & " union select ep39 as cp05,'94012' as cp14,st04,st16 from caseprogress,engineerprogress,staff where cp01='" & strCP01 & "' and cp02='" & strCP02 & "' and cp03='" & strCP03 & "' and cp04='" & strCP04 & "' and cp10='201' and ep02(+)=cp09 and ep04='A6013' and ep04=st01(+)"
      StrSQLa = StrSQLa & " union select cp05, cp14,st04,st16 from caseprogress,staff where cp01='" & strCP01 & "' and cp02='" & strCP02 & "'" & _
              " and cp03='" & strCP03 & "' and cp04='" & strCP04 & "' and st01(+)=cp14 and st03 in ('F21','F81') and cp14<>'F4102' " & _
              " and cp57 is null order by cp05 desc"
      iR = 1
      Set rsA = ClsLawReadRstMsg(iR, StrSQLa)
      If iR = 1 Then
'         'Added by Lydia 2022/02/15
'         If "" & rsA.Fields("cp14") = "A6013" Then
'            PUB_GetFCPPromoterNo = "94012"
'            StrSQLa = GetStaffName(PUB_GetFCPPromoterNo)
'            If StrSQLa = "" Then PUB_GetFCPPromoterNo = ""
'         Else
'         'end 2022/02/15
            If rsA.Fields("st04") = "1" Then
               PUB_GetFCPPromoterNo = rsA.Fields("cp14")
            End If
'         End If 'Added by Lydia 2022/02/15
      End If
      If PUB_GetFCPPromoterNo = "" Then
         'Modified by Morgan 2021/5/31 承辦工程師離職改抓該工程師組別的主管
          'StrSQLa = "select '1',oman from setspecman,patent where pa01='" & strCP01 & "' and pa02='" & strCP02 & "'" & _
                 " and pa03='" & strCP03 & "' and pa04='" & strCP04 & "' and pa150 is not null and decode(pa150,'1','T','2','R','3','S','4','T1',pa150)=OCODE(+) "
         'If rsA.RecordCount > 0 Then
         '   StrSQLa = StrSQLa & " union " & _
                    " select '2',oman from setspecman where decode(" & rsA.Fields("st16") & ",'1','T','2','R','3','S','4','T1'," & rsA.Fields("st16") & ")=OCODE(+) " & _
                    " order by 1,2 "
         'End If
         If rsA.RecordCount > 0 Then
            strOCP14 = rsA.Fields("cp14")
         End If
         
         If strOCP14 <> "" Then
            'Modified by Lydia 2023/01/12 日文組只需單純回傳離職人員的主管
            'PUB_GetFCPPromoterNo = PUB_GetFCPEngSup(strOCP14, True)
            PUB_GetFCPPromoterNo = PUB_GetFCPEngSup(strOCP14, True, True)
         'Modified by Morgan 2022/2/10 若承辦人為王協理88003時比照中間來所案件 Ex:FCP-057501--何淑華
         'Else
            If PUB_GetFCPPromoterNo = "88003" Then PUB_GetFCPPromoterNo = ""
         End If
         If PUB_GetFCPPromoterNo = "" Then
         'end 2022/2/10
            'Modified by Morgan 2021/6/2 日本部中間轉案進來案子承辦人先掛Owen(99037),曾威誌A6013掛林軒吉94012
            StrSQLa = "select cp14 from caseprogress where cp01='" & strCP01 & "' and cp02='" & strCP02 & "' and cp03='" & strCP03 & "' and cp04='" & strCP04 & "' and cp14='A6013'" & _
               " union select ep04 from caseprogress,engineerprogress where cp01='" & strCP01 & "' and cp02='" & strCP02 & "' and cp03='" & strCP03 & "' and cp04='" & strCP04 & "' and cp10='201' and ep02(+)=cp09 and ep04='A6013'"
            iR = 1
            Set rsA = ClsLawReadRstMsg(iR, StrSQLa)
            If iR = 1 Then
               PUB_GetFCPPromoterNo = "94012"
            Else
               StrSQLa = "select '1',decode(pa150,'3','99037',oman) from setspecman,patent where pa01='" & strCP01 & "' and pa02='" & strCP02 & "'" & _
                  " and pa03='" & strCP03 & "' and pa04='" & strCP04 & "' and pa150 is not null and decode(pa150,'1','T','2','R','3','S','4','T1',pa150)=OCODE(+) "
               iR = 1
               Set rsA = ClsLawReadRstMsg(iR, StrSQLa)
               If iR = 1 Then
                  PUB_GetFCPPromoterNo = "" & rsA(1)
               End If
            End If
            'end 2021/6/2
         End If
      End If
   End If
   'end 2017/10/11
   
   'Added by Morgan 2024/2/27
   '承辦人若組別ST16為機械設計組時，請改為鄭光益87003
   PUB_GetFCPPromoterNo = PUB_SetEng(PUB_GetFCPPromoterNo)
   'end 2024/2/27
   
   If rsA.State <> adStateClosed Then rsA.Close
   Set rsA = Nothing
'2009/12/11 END
End Function

'Added by Morgan 2024/2/29
'機械設計組承辦人改為鄭光益87003(收文,分案,來函)
'蔡昀甫(B2042)案件仍維持 --Wilson
'Modified by Morgan 2024/4/11 +黃冠傑(B3018)也不必經Wilson重新分案 --Winfrey(Wilson確認)
Public Function PUB_SetEng(pCP14 As String) As String
   Dim rsA As ADODB.Recordset
   Dim strSql As String, iR As Integer
   Dim strCP14 As String
   
   'Modified by Lydia 2025/04/11 經過Wilison同意取消[機械設計組承辦人需經過Wilson分案]的設定
   'strCP14 = pCP14
   ''Modified by Lydia 2025/02/13 +B4001 Henry
   'If pCP14 <> "B2042" And pCP14 <> "B3018" And pCP14 <> "B4001" And pCP14 <> "87003" And Mid(pCP14, 4, 1) <> "9" Then
   '   strSql = "select st01 from staff where st01='" & pCP14 & "' and st16='4'"
   '   iR = 1
   '   Set rsA = ClsLawReadRstMsg(iR, strSql)
   '   If iR = 1 Then
   '      strCP14 = "87003"
   '   End If
   'End If
   'PUB_SetEng = strCP14
   PUB_SetEng = pCP14
   'end 2025/02/11
   Set rsA = Nothing
End Function


'Add By Cheng 2003/04/09
'以本所案號取得客戶名稱
'Modify By Sindy 2014/10/9
'Public Function PUB_GetCustName(strCP0104 As String) As String
Public Function PUB_GetCustName(strCP0104 As String, Optional bolShowAll As Boolean = False) As String
'2014/10/9 END
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset

PUB_GetCustName = ""
StrSQLa = "Select Decode(CU04, Null, Decode(CU05, Null, CU06, CU05|| ' '||CU88||' '||CU89||' '||CU90), CU04 ) From Customer, Patent Where CU01=substr(PA26,1,8) And CU02=substr(PA26,9,1) And " & ChgPatent(strCP0104)
StrSQLa = StrSQLa & " union Select Decode(CU04, Null, Decode(CU05, Null, CU06, CU05|| ' '||CU88||' '||CU89||' '||CU90), CU04 ) From Customer, Patent Where CU01=substr(PA27,1,8) And CU02=substr(PA27,9,1) And " & ChgPatent(strCP0104)
StrSQLa = StrSQLa & " union Select Decode(CU04, Null, Decode(CU05, Null, CU06, CU05|| ' '||CU88||' '||CU89||' '||CU90), CU04 ) From Customer, Patent Where CU01=substr(PA28,1,8) And CU02=substr(PA28,9,1) And " & ChgPatent(strCP0104)
StrSQLa = StrSQLa & " union Select Decode(CU04, Null, Decode(CU05, Null, CU06, CU05|| ' '||CU88||' '||CU89||' '||CU90), CU04 ) From Customer, Patent Where CU01=substr(PA29,1,8) And CU02=substr(PA29,9,1) And " & ChgPatent(strCP0104)
StrSQLa = StrSQLa & " union Select Decode(CU04, Null, Decode(CU05, Null, CU06, CU05|| ' '||CU88||' '||CU89||' '||CU90), CU04 ) From Customer, Patent Where CU01=substr(PA30,1,8) And CU02=substr(PA30,9,1) And " & ChgPatent(strCP0104)
StrSQLa = StrSQLa & " union Select Decode(CU04, Null, Decode(CU05, Null, CU06, CU05|| ' '||CU88||' '||CU89||' '||CU90), CU04 ) From Customer, Trademark Where CU01=substr(TM23,1,8) And CU02=substr(TM23,9,1) And " & ChgTradeMark(strCP0104)
'Modify By Sindy 2011/2/22 增加TM78,TM79,TM80,TM81
StrSQLa = StrSQLa & " union Select Decode(CU04, Null, Decode(CU05, Null, CU06, CU05|| ' '||CU88||' '||CU89||' '||CU90), CU04 ) From Customer, Trademark Where CU01=substr(TM78,1,8) And CU02=substr(TM78,9,1) And " & ChgTradeMark(strCP0104)
StrSQLa = StrSQLa & " union Select Decode(CU04, Null, Decode(CU05, Null, CU06, CU05|| ' '||CU88||' '||CU89||' '||CU90), CU04 ) From Customer, Trademark Where CU01=substr(TM79,1,8) And CU02=substr(TM79,9,1) And " & ChgTradeMark(strCP0104)
StrSQLa = StrSQLa & " union Select Decode(CU04, Null, Decode(CU05, Null, CU06, CU05|| ' '||CU88||' '||CU89||' '||CU90), CU04 ) From Customer, Trademark Where CU01=substr(TM80,1,8) And CU02=substr(TM80,9,1) And " & ChgTradeMark(strCP0104)
StrSQLa = StrSQLa & " union Select Decode(CU04, Null, Decode(CU05, Null, CU06, CU05|| ' '||CU88||' '||CU89||' '||CU90), CU04 ) From Customer, Trademark Where CU01=substr(TM81,1,8) And CU02=substr(TM81,9,1) And " & ChgTradeMark(strCP0104)
'2011/2/22 End
StrSQLa = StrSQLa & " union Select Decode(CU04, Null, Decode(CU05, Null, CU06, CU05|| ' '||CU88||' '||CU89||' '||CU90), CU04 ) From Customer, Lawcase Where CU01=substr(LC11,1,8) And CU02=substr(LC11,9,1) And " & ChgLawcase(strCP0104)
'Modify By Sindy 2011/2/22 增加LC43,LC44,LC45,LC46
StrSQLa = StrSQLa & " union Select Decode(CU04, Null, Decode(CU05, Null, CU06, CU05|| ' '||CU88||' '||CU89||' '||CU90), CU04 ) From Customer, Lawcase Where CU01=substr(LC43,1,8) And CU02=substr(LC43,9,1) And " & ChgLawcase(strCP0104)
StrSQLa = StrSQLa & " union Select Decode(CU04, Null, Decode(CU05, Null, CU06, CU05|| ' '||CU88||' '||CU89||' '||CU90), CU04 ) From Customer, Lawcase Where CU01=substr(LC44,1,8) And CU02=substr(LC44,9,1) And " & ChgLawcase(strCP0104)
StrSQLa = StrSQLa & " union Select Decode(CU04, Null, Decode(CU05, Null, CU06, CU05|| ' '||CU88||' '||CU89||' '||CU90), CU04 ) From Customer, Lawcase Where CU01=substr(LC45,1,8) And CU02=substr(LC45,9,1) And " & ChgLawcase(strCP0104)
StrSQLa = StrSQLa & " union Select Decode(CU04, Null, Decode(CU05, Null, CU06, CU05|| ' '||CU88||' '||CU89||' '||CU90), CU04 ) From Customer, Lawcase Where CU01=substr(LC46,1,8) And CU02=substr(LC46,9,1) And " & ChgLawcase(strCP0104)
'2011/2/22 End
StrSQLa = StrSQLa & " union Select Decode(CU04, Null, Decode(CU05, Null, CU06, CU05|| ' '||CU88||' '||CU89||' '||CU90), CU04 ) From Customer, Hirecase Where CU01=substr(HC05,1,8) And CU02=substr(HC05,9,1) And " & ChgHirecase(strCP0104)
'Modify By Sindy 2011/2/22 增加HC24,HC25,HC26,HC27
StrSQLa = StrSQLa & " union Select Decode(CU04, Null, Decode(CU05, Null, CU06, CU05|| ' '||CU88||' '||CU89||' '||CU90), CU04 ) From Customer, Hirecase Where CU01=substr(HC24,1,8) And CU02=substr(HC24,9,1) And " & ChgHirecase(strCP0104)
StrSQLa = StrSQLa & " union Select Decode(CU04, Null, Decode(CU05, Null, CU06, CU05|| ' '||CU88||' '||CU89||' '||CU90), CU04 ) From Customer, Hirecase Where CU01=substr(HC25,1,8) And CU02=substr(HC25,9,1) And " & ChgHirecase(strCP0104)
StrSQLa = StrSQLa & " union Select Decode(CU04, Null, Decode(CU05, Null, CU06, CU05|| ' '||CU88||' '||CU89||' '||CU90), CU04 ) From Customer, Hirecase Where CU01=substr(HC26,1,8) And CU02=substr(HC26,9,1) And " & ChgHirecase(strCP0104)
StrSQLa = StrSQLa & " union Select Decode(CU04, Null, Decode(CU05, Null, CU06, CU05|| ' '||CU88||' '||CU89||' '||CU90), CU04 ) From Customer, Hirecase Where CU01=substr(HC27,1,8) And CU02=substr(HC27,9,1) And " & ChgHirecase(strCP0104)
'2011/2/22 End
StrSQLa = StrSQLa & " union Select Decode(CU04, Null, Decode(CU05, Null, CU06, CU05|| ' '||CU88||' '||CU89||' '||CU90), CU04 ) From Customer, Servicepractice Where CU01=substr(SP08,1,8) And CU02=substr(SP08,9,1) And " & ChgService(strCP0104)
'Modify By Sindy 2011/2/22 增加SP58,SP59,SP65,SP66
StrSQLa = StrSQLa & " union Select Decode(CU04, Null, Decode(CU05, Null, CU06, CU05|| ' '||CU88||' '||CU89||' '||CU90), CU04 ) From Customer, Servicepractice Where CU01=substr(SP58,1,8) And CU02=substr(SP58,9,1) And " & ChgService(strCP0104)
StrSQLa = StrSQLa & " union Select Decode(CU04, Null, Decode(CU05, Null, CU06, CU05|| ' '||CU88||' '||CU89||' '||CU90), CU04 ) From Customer, Servicepractice Where CU01=substr(SP59,1,8) And CU02=substr(SP59,9,1) And " & ChgService(strCP0104)
StrSQLa = StrSQLa & " union Select Decode(CU04, Null, Decode(CU05, Null, CU06, CU05|| ' '||CU88||' '||CU89||' '||CU90), CU04 ) From Customer, Servicepractice Where CU01=substr(SP65,1,8) And CU02=substr(SP65,9,1) And " & ChgService(strCP0104)
StrSQLa = StrSQLa & " union Select Decode(CU04, Null, Decode(CU05, Null, CU06, CU05|| ' '||CU88||' '||CU89||' '||CU90), CU04 ) From Customer, Servicepractice Where CU01=substr(SP66,1,8) And CU02=substr(SP66,9,1) And " & ChgService(strCP0104)
'2011/2/22 End

rsA.CursorLocation = adUseClient
rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
If rsA.RecordCount > 0 Then
   'PUB_GetCustName = "" & rsA.Fields(0).Value
   'Modify By Sindy 2014/10/9
   rsA.MoveFirst
   Do While Not rsA.EOF
      PUB_GetCustName = PUB_GetCustName & "," & rsA.Fields(0).Value
      If bolShowAll = False Then Exit Do
      rsA.MoveNext
   Loop
   '2014/10/9 END
End If
'Add By Sindy 2014/10/9
If PUB_GetCustName <> "" Then
   PUB_GetCustName = Mid(PUB_GetCustName, 2)
End If
'2014/10/9 END
If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing
End Function

'Add By Cheng 2003/04/09
'以本所案號取得客戶代號
Public Function PUB_GetCustNo(strCP0104 As String) As String
'Added by Morgan 2021/3/17 程式重複也有疑問(不確定會回傳第幾申請人)，改呼叫 GetPrjPeopleNum1
   Dim strCase(1 To 4) As String
   ChgCaseNo strCP0104, strCase
   PUB_GetCustNo = GetPrjPeopleNum1(strCase(1) & "-" & strCase(2) & "-" & strCase(3) & "-" & strCase(4))
'end 2021/3/17

'Removed by Morgan 2021/3/17
'Dim StrSQLa As String
'Dim rsA As New ADODB.Recordset
'
'PUB_GetCustNo = ""
'StrSQLa = "Select PA26 From Patent Where " & ChgPatent(strCP0104)
'StrSQLa = StrSQLa & " union Select PA27 From Patent Where " & ChgPatent(strCP0104)
'StrSQLa = StrSQLa & " union Select PA28 From Patent Where " & ChgPatent(strCP0104)
'StrSQLa = StrSQLa & " union Select PA29 From Patent Where " & ChgPatent(strCP0104)
'StrSQLa = StrSQLa & " union Select PA30 From Patent Where " & ChgPatent(strCP0104)
'StrSQLa = StrSQLa & " union Select TM23 From Trademark Where " & ChgTradeMark(strCP0104)
''add by nickc 2007/01/02
'StrSQLa = StrSQLa & " union Select TM78 From Trademark Where " & ChgTradeMark(strCP0104)
'StrSQLa = StrSQLa & " union Select TM79 From Trademark Where " & ChgTradeMark(strCP0104)
'StrSQLa = StrSQLa & " union Select TM80 From Trademark Where " & ChgTradeMark(strCP0104)
'StrSQLa = StrSQLa & " union Select TM81 From Trademark Where " & ChgTradeMark(strCP0104)
''2007/01/02 End
'StrSQLa = StrSQLa & " union Select LC11 From Lawcase Where " & ChgLawcase(strCP0104)
''Modify By Sindy 2011/2/22 增加LC43,LC44,LC45,LC46
'StrSQLa = StrSQLa & " union Select LC43 From Lawcase Where " & ChgLawcase(strCP0104)
'StrSQLa = StrSQLa & " union Select LC44 From Lawcase Where " & ChgLawcase(strCP0104)
'StrSQLa = StrSQLa & " union Select LC45 From Lawcase Where " & ChgLawcase(strCP0104)
'StrSQLa = StrSQLa & " union Select LC46 From Lawcase Where " & ChgLawcase(strCP0104)
''2011/2/22 End
'StrSQLa = StrSQLa & " union Select HC05 From Hirecase Where " & ChgHirecase(strCP0104)
''Modify By Sindy 2011/2/22 增加HC24,HC25,HC26,HC27
'StrSQLa = StrSQLa & " union Select HC24 From Hirecase Where " & ChgHirecase(strCP0104)
'StrSQLa = StrSQLa & " union Select HC25 From Hirecase Where " & ChgHirecase(strCP0104)
'StrSQLa = StrSQLa & " union Select HC26 From Hirecase Where " & ChgHirecase(strCP0104)
'StrSQLa = StrSQLa & " union Select HC27 From Hirecase Where " & ChgHirecase(strCP0104)
''2011/2/22 End
'StrSQLa = StrSQLa & " union Select SP08 From Servicepractice Where " & ChgService(strCP0104)
''add by nickc 2007/01/02
'StrSQLa = StrSQLa & " union Select SP58 From Servicepractice Where " & ChgService(strCP0104)
'StrSQLa = StrSQLa & " union Select SP59 From Servicepractice Where " & ChgService(strCP0104)
'StrSQLa = StrSQLa & " union Select SP65 From Servicepractice Where " & ChgService(strCP0104)
'StrSQLa = StrSQLa & " union Select SP66 From Servicepractice Where " & ChgService(strCP0104)
''2007/01/02 End
'
'rsA.CursorLocation = adUseClient
'rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
'If rsA.RecordCount > 0 Then
'    PUB_GetCustNo = "" & rsA.Fields(0).Value
'End If
'If rsA.State <> adStateClosed Then rsA.Close
'Set rsA = Nothing
'end 2021/3/17
End Function

'***************************************************************************************************************************
'92.04.16 nick 撰寫
'原因     改善 loop
'架構變動，因為要改善 loop
'start
'***************************************************************************************************************************
'92.04.16 nick
'將字串對應回 form
Public Function fnStrToForm(oStr As String) As Boolean
'Add by Morgan 2007/5/22
Dim oForm As Form, bFound As Boolean

On Error GoTo ChkErr:
   bFound = False
   For Each oForm In Forms
      If UCase(oForm.Name) = UCase(oStr) Then
         oForm.Show
         'Modify by Amy 2018/02/27 +FRM050204_1
         'Modify by Amy 2019/11/22 +FRM140113
         'Modified by Lydia 2023/01/05 +FRM210156
         'Modify by Amy 2023/09/14 +FRM100137
         If UCase(oStr) <> "FRM010014" And UCase(oStr) <> "FRM050204_1" And UCase(oStr) <> "FRM140113" And UCase(oStr) <> "FRM210156" And UCase(oStr) <> "FRM100137" Then
            oForm.PubShowNextData
         End If
         bFound = True
         Exit For
      End If
   Next
   If bFound = False Then
      MsgBox "錯誤！請通知程式設計師，母層錯誤！", , "共同查詢！"
      Exit Function
   End If
'end 2007/5/22

   fnStrToForm = True
   Exit Function
    
ChkErr:
    MsgBox Err.Description
    
End Function

'92.04.16 nick
'紀錄母層
'Modified by Morgan 2021/7/23 +pNoHide
Public Function fnSaveParentForm(oForm As Form, Optional pNoHide As Boolean = False) As Boolean
On Error GoTo ChkErr:
fnSaveParentForm = True
If InStr(1, ArrFormByNick, Trim(oForm.Name)) = 0 Then
    ArrFormByNick = ArrFormByNick & ";" & Trim(oForm.Name)
    If Left(ArrFormByNick, 1) = ";" Then
        ArrFormByNick = Mid(ArrFormByNick, 2)
    End If
    'Debug.Print ArrFormByNick & Time
End If

'Modified by Morgan 2021/7/23
'oForm.Hide
If pNoHide = False Then oForm.Hide
'end 2021/7/23

Exit Function
ChkErr:
    fnSaveParentForm = False
    MsgBox ("儲存母層資料時失敗！")
End Function

'92.04.16 nick
'關閉作用視窗，開啟母層視窗......共同查詢專用
Public Function fnCancelNowFormAndShowParentForm(oForm As Form) As Boolean
Dim Arr920416 As Variant
Dim int920416 As Integer
Dim str920416 As String
Arr920416 = Split(ArrFormByNick, ";")
int920416 = UBound(Arr920416)
On Error GoTo ChkErr:
fnCancelNowFormAndShowParentForm = True
If ArrFormByNick = "" Then
    If fnCloseAllFrm100 = False Then
        fnCancelNowFormAndShowParentForm = False
        Exit Function
    End If
    ArrFormByNick = ""
Else
    oForm.Hide
    Unload oForm
    
   'Modified by Morgan 2021/4/28 改母層不存在時直接回到再上一層(避免同畫面開2次造成錯誤)
   'str920416 = Arr920416(int920416)
   'ArrFormByNick = ""
   'If UBound(Arr920416) > 0 Then
   '    For intI = 0 To UBound(Arr920416) - 1
   '        ArrFormByNick = ArrFormByNick & Arr920416(intI) & ";"
   '    Next intI
   '    ArrFormByNick = Mid(ArrFormByNick, 1, Len(ArrFormByNick) - 1)
   'End If
   For int920416 = UBound(Arr920416) To LBound(Arr920416) Step -1
     str920416 = Arr920416(int920416)
     If PUB_CheckFormExist(str920416) = True Then
        Exit For
     End If
     str920416 = ""
   Next
    
   ArrFormByNick = ""
   If int920416 > 0 Then
       For intI = 0 To int920416 - 1
           ArrFormByNick = ArrFormByNick & Arr920416(intI) & ";"
       Next intI
       ArrFormByNick = Mid(ArrFormByNick, 1, Len(ArrFormByNick) - 1)
   End If
   'end 2021/4/28
    
    
    If fnStrToForm(str920416) = True Then
    Else
        fnCancelNowFormAndShowParentForm = False
        oForm.Show
        Exit Function
    End If
End If

Exit Function
ChkErr:
    fnCancelNowFormAndShowParentForm = False
    MsgBox Err.Description
    'MsgBox ("開啟母層資料時失敗！")
End Function

'92.04.16 nick
'關閉所有共同查詢視窗
Public Function fnCloseAllFrm100() As Boolean
'Add By Cheng 2003/12/05
Dim frm As Form
'End
Dim aryForm As Variant
Dim nPos As Integer
Dim ShowFormNm As String
 
fnCloseAllFrm100 = True
On Error GoTo ChkErr:
'Add By Sindy 2013/9/18 因有作業並非共同查詢的,但作業中會呼叫frm100,增加檢查基底frm應該那一個要亮起來
If ArrFormByNick <> "" Then
   aryForm = Split(ArrFormByNick, ";")
   For nPos = UBound(aryForm) To 0 Step -1
      If Left(aryForm(nPos), 6) <> "frm100" And aryForm(nPos) <> "frm140407" And aryForm(nPos) <> "frm140408" And _
         aryForm(nPos) <> "frm210130" And aryForm(nPos) <> "frm210131" And aryForm(nPos) <> "frm210137_1" Then
         ShowFormNm = aryForm(nPos)
         Exit For
      End If
   Next nPos
End If
'2013/9/18 END
For Each frm In Forms
    '2010/8/20 MODIFY BY SONIA 國內外潛在客戶及往來查詢的子畫面結束,母畫面也要結束
    'If Left(frm.Name, 6) = "frm100" Then
    'Modified by Morgan 2014/7/17 +frm100123 不必結束
    'Modify by Amy 2015/09/21 +frm090638及frm090638_1
    If (Left(frm.Name, 6) = "frm100" And frm.Name <> "frm100123") Or frm.Name = "frm140407" Or frm.Name = "frm140408" Or _
      frm.Name = "frm210130" Or frm.Name = "frm210131" Or frm.Name = "frm210137_1" Or frm.Name = "frm090638" Or frm.Name = "frm090638_1" Then
        Unload frm
    End If
Next
'Add By Sindy 2013/9/18
For Each frm In Forms
   If frm.Name = ShowFormNm Then
      frm.Show
   End If
Next
'2013/9/18 END
ArrFormByNick = ""
Exit Function
ChkErr:
    fnCloseAllFrm100 = False
    MsgBox ("關閉共同查詢時失敗！")
End Function
'***************************************************************************************************************************
'end
'***************************************************************************************************************************

'Add By Cheng 2003/04/24
'判斷表單是否存在
'Modify By Sindy 2023/1/4 + , Optional ByRef tmpfrm As Form
Public Function PUB_CheckFormExist(strFormName As String, Optional ByRef tmpfrm As Form) As Boolean
Dim frm As Form
    
PUB_CheckFormExist = False
    For Each frm In Forms
        If frm.Name = strFormName Then
            Set tmpfrm = frm 'Add By Sindy 2023/1/4
            PUB_CheckFormExist = True
            Exit For
        End If
    Next
End Function

''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' 檢查是否有執行該項作業的權限
'
' Input : strFormName ==> 程式畫面的名稱 (Form Name)
'         strFunc ==> "A" 新增功能
'                     "E" 修改功能
'                     "D" 刪除功能
'                     "F" 查詢功能
'                     "P" 列印功能
'                     "X" 執行功能
'                     "Y" 跨部門權限(Cross Dept)
'         bShowMsg ==> 當沒有權限執行該項作業的功能時, 是否顯示訊息
'                     True : 顯示訊息
'                     False : 不顯示訊息 (Default)
' Output : True : 使用者有使用該程式的該項功能的權限
'          False : 使用者沒有使用該程式的該項功能的權限
' 說明 : 以員工的等級編號檢查員工權限檔, 是否該員工有執行該項作業的功能
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Public Function IsUserHasRightOfFunction(ByVal strFormName As String, ByVal strFunc As String, Optional ByVal bShowMsg As Boolean = False, Optional strCP01 As String, Optional strCP02 As String, Optional strCP03 As String, Optional strCP04 As String) As Boolean
' 讀取員工檔的Recordset
Dim rsStaff As ADODB.Recordset
' 讀取員工權限檔的Recordset
Dim rsRight As ADODB.Recordset
' 查詢資料庫的SQL字串
Dim strSql As String
Dim strST06 As String, strTmp As String
'最後收文智權人員
Dim stKeySales As String
'最後收文承辦人
Dim stRcvEmp As String
Dim strCUID As String 'Add By Sindy 2015/3/25
Dim stUsers As String 'add by sonia 2018/5/23

   ' 預設值為False
   IsUserHasRightOfFunction = False
   
On Error GoTo ERRORSECTION
   ' 讀取員工檔的等級編號
   strSql = "SELECT ST05,ST06 FROM STAFF WHERE ST01 = '" & Trim(strUserNum) & "'"
   Set rsStaff = New ADODB.Recordset
   rsStaff.CursorLocation = adUseClient
   rsStaff.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If rsStaff.RecordCount > 0 Then
      If Not IsNull(rsStaff.Fields("ST06").Value) Then strST06 = rsStaff.Fields("ST06").Value
      If IsNull(rsStaff.Fields("ST05").Value) Then
         IsUserHasRightOfFunction = False
      Else
         ' 等級編號為00的員工擁有執行所有作業及功能的權限
         If rsStaff.Fields("ST05").Value = "00" Then
            IsUserHasRightOfFunction = True
            rsStaff.Close
            Set rsStaff = Nothing
            Set rsRight = Nothing
            Exit Function
         End If
         
         ' 讀取權限檔
         'Modify by Morgan 2008/9/28 改先抓個人設定
         strSql = "SELECT 2,SR.* FROM STAFF_RIGHT SR WHERE SR01 = '" & rsStaff.Fields("ST05").Value & "' AND SR02 = '" & strFormName & "'"
         strSql = strSql & " union all SELECT 1,SR.* FROM STAFF_RIGHT SR WHERE SR01 = '" & Trim(strUserNum) & "' AND SR02 = '" & strFormName & "' order by 1"
         
         Set rsRight = New ADODB.Recordset
         rsRight.CursorLocation = adUseClient
         rsRight.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
         If rsRight.RecordCount > 0 Then
            Select Case strFunc
               ' 新增
               Case strAdd:
                  If IsNull(rsRight.Fields("SR03")) = False Then
                     If rsRight.Fields("SR03").Value = "Y" Then
                        IsUserHasRightOfFunction = True
                     End If
                  End If
               ' 修改
               Case strEdit:
                  If IsNull(rsRight.Fields("SR04")) = False Then
                     If rsRight.Fields("SR04").Value = "Y" Then
                        IsUserHasRightOfFunction = True
                     End If
                  End If
               ' 刪除
               Case strDel:
                  If IsNull(rsRight.Fields("SR05")) = False Then
                     If rsRight.Fields("SR05").Value = "Y" Then
                        IsUserHasRightOfFunction = True
                     End If
                  End If
               ' 查詢
               Case strFind:
                  If IsNull(rsRight.Fields("SR06")) = False Then
                     If rsRight.Fields("SR06").Value = "Y" Then
                        IsUserHasRightOfFunction = True
                     End If
                  End If
               ' 列印
               Case strPrint:
                  If IsNull(rsRight.Fields("SR07")) = False Then
                     If rsRight.Fields("SR07").Value = "Y" Then
                        IsUserHasRightOfFunction = True
                     End If
                  End If
               ' 執行
               Case strExec:
                  If IsNull(rsRight.Fields("SR08")) = False Then
                     If rsRight.Fields("SR08").Value = "Y" Then
                        IsUserHasRightOfFunction = True
                     End If
                  End If
               ' 跨部門權限
               Case strCrossDept:
                  If IsNull(rsRight.Fields("SR09")) = False Then
                     If rsRight.Fields("SR09").Value = "Y" Then
                        '2011/5/17 modify by sonia 專利非外專收文之案件,外專人員不可查詢
                        'IsUserHasRightOfFunction = True
                        If InStr(1, strCP01, "P") > 0 And (Mid(GetStaffDepartment(strUserNum), 1, 2) = "F2" Or Mid(GetStaffDepartment(strUserNum), 1, 2) = "F8") Then
                           strSql = "Select * From CASEPROGRESS Where CP01='" & strCP01 & "' AND CP02='" & strCP02 & "' AND CP03='" & strCP03 & "' AND CP04='" & strCP04 & "' AND SUBSTR(CP12,1,2)='F2' "
                           intI = 1
                           Set RsTemp = ClsLawReadRstMsg(intI, strSql)
                           If intI = 1 Then
                              IsUserHasRightOfFunction = True
                           'add by sonia 2018/5/23 新增特殊人員'外專工程師專利處核稿人'協助專利處核稿,要開放所有P,CFP案查詢權限
                           Else
                              stUsers = Pub_GetSpecMan("外專工程師專利處核稿人")
                              If InStr(stUsers, strUserNum) > 0 Then IsUserHasRightOfFunction = True
                           'end 2018/5/22
                           End If
                        Else
                           IsUserHasRightOfFunction = True
                        End If
                        '2011/5/17 END
                     End If
                  End If
               'Add By Sindy 2010/12/30 跨所別權限
               Case strBranch:
                  If IsNull(rsRight.Fields("SR11")) = False Then
                     If rsRight.Fields("SR11").Value = "Y" Then
                        IsUserHasRightOfFunction = True
                     End If
                  Else
                     '2011/7/13 modify by sonia 加檢查其他申請人FCP-043943外專其他承辦人都可以看
                     'Modify By Sindy 2015/3/25 +,c1.cu11,c2.cu11,c3.cu11,c4.cu11,c5.cu11
                     strSql = "select s1.st06,s2.st06,s3.st06,s4.st06,s5.st06,c1.cu11,c2.cu11,c3.cu11,c4.cu11,c5.cu11 from trademark,customer c1,staff s1,customer c2,staff s2,customer c3,staff s3,customer c4,staff s4,customer c5,staff s5 where tm01='" & strCP01 & "' and tm02='" & strCP02 & "' and tm03='" & strCP03 & "' and tm04='" & strCP04 & "' and c1.cu01(+)=substr(tm23,1,8) and c1.cu02(+)=substr(tm23,9,1) and c1.cu13=s1.st01(+) and c2.cu01(+)=substr(tm78,1,8) and c2.cu02(+)=substr(tm78,9,1) and c2.cu13=s2.st01(+) and c3.cu01(+)=substr(tm79,1,8) and c3.cu02(+)=substr(tm79,9,1) and c3.cu13=s3.st01(+) and c4.cu01(+)=substr(tm80,1,8) and c4.cu02(+)=substr(tm80,9,1) and c4.cu13=s4.st01(+) and c5.cu01(+)=substr(tm81,1,8) and c5.cu02(+)=substr(tm81,9,1) and c5.cu13=s5.st01(+) " & _
                              "union all " & _
                              "select s1.st06,s2.st06,s3.st06,s4.st06,s5.st06,c1.cu11,c2.cu11,c3.cu11,c4.cu11,c5.cu11 from patent,customer c1,staff s1,customer c2,staff s2,customer c3,staff s3,customer c4,staff s4,customer c5,staff s5 where pa01='" & strCP01 & "' and pa02='" & strCP02 & "' and pa03='" & strCP03 & "' and pa04='" & strCP04 & "' and c1.cu01(+)=substr(pa26,1,8) and c1.cu02(+)=substr(pa26,9,1) and c1.cu13=s1.st01(+) and c2.cu01(+)=substr(pa27,1,8) and c2.cu02(+)=substr(pa27,9,1) and c2.cu13=s2.st01(+) and c3.cu01(+)=substr(pa28,1,8) and c3.cu02(+)=substr(pa28,9,1) and c3.cu13=s3.st01(+) and c4.cu01(+)=substr(pa29,1,8) and c4.cu02(+)=substr(pa29,9,1) and c4.cu13=s4.st01(+) and c5.cu01(+)=substr(pa30,1,8) and c5.cu02(+)=substr(pa30,9,1) and c5.cu13=s5.st01(+) " & _
                              "union all " & _
                              "select s1.st06,s2.st06,s3.st06,s4.st06,s5.st06,c1.cu11,c2.cu11,c3.cu11,c4.cu11,c5.cu11 from servicepractice,customer c1,staff s1,customer c2,staff s2,customer c3,staff s3,customer c4,staff s4,customer c5,staff s5 where sp01='" & strCP01 & "' and sp02='" & strCP02 & "' and sp03='" & strCP03 & "' and sp04='" & strCP04 & "' and c1.cu01(+)=substr(sp08,1,8) and c1.cu02(+)=substr(sp08,9,1) and c1.cu13=s1.st01(+) and c2.cu01(+)=substr(sp58,1,8) and c2.cu02(+)=substr(sp58,9,1) and c2.cu13=s2.st01(+) and c3.cu01(+)=substr(sp59,1,8) and c3.cu02(+)=substr(sp59,9,1) and c3.cu13=s3.st01(+) and c4.cu01(+)=substr(sp65,1,8) and c4.cu02(+)=substr(sp65,9,1) and c4.cu13=s4.st01(+) and c5.cu01(+)=substr(sp66,1,8) and c5.cu02(+)=substr(sp66,9,1) and c5.cu13=s5.st01(+) " & _
                              "union all " & _
                              "select s1.st06,s2.st06,s3.st06,s4.st06,s5.st06,c1.cu11,c2.cu11,c3.cu11,c4.cu11,c5.cu11 from lawcase,customer c1,staff s1,customer c2,staff s2,customer c3,staff s3,customer c4,staff s4,customer c5,staff s5 where lc01='" & strCP01 & "' and lc02='" & strCP02 & "' and lc03='" & strCP03 & "' and lc04='" & strCP04 & "' and c1.cu01(+)=substr(lc11,1,8) and c1.cu02(+)=substr(lc11,9,1) and c1.cu13=s1.st01(+) and c2.cu01(+)=substr(lc43,1,8) and c2.cu02(+)=substr(lc43,9,1) and c2.cu13=s2.st01(+) and c3.cu01(+)=substr(lc44,1,8) and c3.cu02(+)=substr(lc44,9,1) and c3.cu13=s3.st01(+) and c4.cu01(+)=substr(lc45,1,8) and c4.cu02(+)=substr(lc45,9,1) and c4.cu13=s4.st01(+) and c5.cu01(+)=substr(lc46,1,8) and c5.cu02(+)=substr(lc46,9,1) and c5.cu13=s5.st01(+) " & _
                              "union all " & _
                              "select s1.st06,s2.st06,s3.st06,s4.st06,s5.st06,c1.cu11,c2.cu11,c3.cu11,c4.cu11,c5.cu11 from hirecase,customer c1,staff s1,customer c2,staff s2,customer c3,staff s3,customer c4,staff s4,customer c5,staff s5 where hc01='" & strCP01 & "' and hc02='" & strCP02 & "' and hc03='" & strCP03 & "' and hc04='" & strCP04 & "' and c1.cu01(+)=substr(hc05,1,8) and c1.cu02(+)=substr(hc05,9,1) and c1.cu13=s1.st01(+) and c2.cu01(+)=substr(hc24,1,8) and c2.cu02(+)=substr(hc24,9,1) and c2.cu13=s2.st01(+) and c3.cu01(+)=substr(hc25,1,8) and c3.cu02(+)=substr(hc25,9,1) and c3.cu13=s3.st01(+) and c4.cu01(+)=substr(hc26,1,8) and c4.cu02(+)=substr(hc26,9,1) and c4.cu13=s4.st01(+) and c5.cu01(+)=substr(hc27,1,8) and c5.cu02(+)=substr(hc27,9,1) and c5.cu13=s5.st01(+) "
                     intI = 1: strTmp = ""
                     Set RsTemp = ClsLawReadRstMsg(intI, strSql)
                     If intI = 1 Then
                        strTmp = "" & RsTemp.Fields(0)
                        If "" & RsTemp.Fields(0) = strST06 Then
                           IsUserHasRightOfFunction = True
                        '2011/7/12 add by sonia 加檢查其他申請人業務所別
                        ElseIf "" & RsTemp.Fields(1) = strST06 Or "" & RsTemp.Fields(2) = strST06 Or "" & RsTemp.Fields(3) = strST06 Or "" & RsTemp.Fields(4) = strST06 Then
                           IsUserHasRightOfFunction = True
                        '2011/7/12 end
                        '2011/5/12 ADD BY SONIA 若曾為案件收文業務則仍可查詢
                        Else
                           '2011/5/19 MODIFY BY SONIA 收文業務可查詢,但收文業務離職則其主管才能看 T-143263
                           'strSql = "select * from caseprogress where cp01='" & strCP01 & "' and cp02='" & strCP02 & "' and cp03='" & strCP03 & "' and cp04='" & strCP04 & "' and cp13='" & Trim(strUserNum) & "'"
                           'intI = 1
                           'Set RsTemp = ClsLawReadRstMsg(intI, strSql)
                           'If intI = 1 Then
                           '   IsUserHasRightOfFunction = True
                           'End If
                           strSql = "select DISTINCT CP13,ST04,A0908 from caseprogress,ACC090,STAFF where cp01='" & strCP01 & "' and cp02='" & strCP02 & "' and cp03='" & strCP03 & "' and cp04='" & strCP04 & "' AND CP12=A0901 AND CP13=ST01 "
                           CheckOC
                           adoRecordset.CursorLocation = adUseClient
                           adoRecordset.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
                           If adoRecordset.RecordCount > 0 Then
                              Do While Not adoRecordset.EOF
                                 If "" & adoRecordset.Fields(0) = strUserNum Then   '收文業務
                                    IsUserHasRightOfFunction = True
                                    Exit Do
                                 End If
                                 If "" & adoRecordset.Fields(1) = "2" And "" & adoRecordset.Fields(2) = strUserNum Then  '收文業務離職則抓其主管
                                    IsUserHasRightOfFunction = True
                                    Exit Do
                                 End If
                                 adoRecordset.MoveNext
                              Loop
                           End If
                           '2011/5/19 END
                           
                           'Add By Sindy 2015/3/25 檢查相同統一編號的客戶，若操作人員為其智權人員，或為該智權人員的主管，即使跨所也開放可查詢案件資料及進度資料。
                           '                       例如:余政興及簡協理可以看高所張偉城客戶'義隆電子'的資料。
                           If IsUserHasRightOfFunction = False Then
                              strCUID = ""
                              If "" & RsTemp.Fields(5) <> "" Then strCUID = strCUID & ",'" & RsTemp.Fields(5) & "'"
                              If "" & RsTemp.Fields(6) <> "" Then strCUID = strCUID & ",'" & RsTemp.Fields(6) & "'"
                              If "" & RsTemp.Fields(7) <> "" Then strCUID = strCUID & ",'" & RsTemp.Fields(7) & "'"
                              If "" & RsTemp.Fields(8) <> "" Then strCUID = strCUID & ",'" & RsTemp.Fields(8) & "'"
                              If "" & RsTemp.Fields(9) <> "" Then strCUID = strCUID & ",'" & RsTemp.Fields(9) & "'"
                              If strCUID <> "" Then
                                 strCUID = Mid(strCUID, 2)
                                 strSql = "select cu13,s1.st02,a0908,s2.st02 from customer,acc090,staff s1,staff s2 where cu11 in(" & strCUID & ")" & _
                                          " and cu12=a0901(+)" & _
                                          " and cu13=s1.st01(+)" & _
                                          " and a0908=s2.st01(+)" & _
                                          " and (cu13='" & strUserNum & "' or a0908='" & strUserNum & "')"
                                 CheckOC
                                 adoRecordset.CursorLocation = adUseClient
                                 adoRecordset.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
                                 If adoRecordset.RecordCount > 0 Then
                                    IsUserHasRightOfFunction = True
                                 End If
                              End If
                           End If
                           '2015/3/25 END
                           
                        '2011/5/12 END
                        End If
                     End If
                     
                     'modify by sonia 2024/2/2 中所P-125950轉FCP-071081，外專承辦組除了最後收文智權人員因為沒有跨所權限都不能看,故加IsUserHasRightOfFunction = False
                     If intI <> 1 Or strTmp = "" Or IsUserHasRightOfFunction = False Then
                        '讀取最後收文智權人員
                        If strCP01 = "FCP" Or strCP01 = "FG" Then
                           stKeySales = PUB_GetFCPSalesNo(strCP01, strCP02, strCP03, strCP04)
                        ElseIf strCP01 = "FCL" Or strCP01 = "LIN" Then
                           stKeySales = PUB_GetFCLSalesNo(strCP01, strCP02, strCP03, strCP04)
                        ElseIf strCP01 = "FCT" Then
                           stKeySales = PUB_GetFCTSalesNo(strCP01, strCP02, strCP03, strCP04)
                        ElseIf strCP01 = "S" Then
                           If GetPrjNation1(strCP01 & "-" & strCP02 & "-" & strCP03 & "-" & strCP04) = "000" Then
                              stKeySales = PUB_GetFCTSalesNo(strCP01, strCP02, strCP03, strCP04)
                           Else
                              stKeySales = PUB_GetAKindSalesNo(strCP01, strCP02, strCP03, strCP04)
                           End If
                        Else
                           stKeySales = PUB_GetAKindSalesNo(strCP01, strCP02, strCP03, strCP04)
                        End If
                        strSql = "select st06 from staff where st01='" & stKeySales & "' "
                        intI = 1
                        Set RsTemp = ClsLawReadRstMsg(intI, strSql)
                        If intI = 1 Then
                           If "" & RsTemp.Fields("st06") = strST06 Then
                              IsUserHasRightOfFunction = True
                           End If
                        Else
                           '讀取最後收文承辦人
                           stRcvEmp = ""
                           strSql = "SELECT * FROM CaseProgress WHERE CP01='" & strCP01 & "' AND CP02='" & strCP02 & "' AND CP03='" & strCP03 & "' AND CP04='" & strCP04 & "' AND CP14 is not null ORDER BY cp05 desc,cp09 desc"
                           intI = 1
                           Set RsTemp = ClsLawReadRstMsg(intI, strSql)
                           If intI = 1 Then
                              stRcvEmp = RsTemp.Fields("cp14")
                           End If
                           strSql = "select st06 from staff where st01='" & stRcvEmp & "' "
                           intI = 1
                           Set RsTemp = ClsLawReadRstMsg(intI, strSql)
                           If intI = 1 Then
                              If "" & RsTemp.Fields("st06") = strST06 Then
                                 IsUserHasRightOfFunction = True
                              End If
                           End If
                        End If
                     End If
                  End If
               ' 其它
               Case Else:
            End Select
         End If
         rsRight.Close
         
         'add by sonia 2014/4/24 加入總經理權限(等級01),可使用所有程式,但維護程式只有查詢功能,不可新增刪除修改)
         If rsStaff.Fields("ST05").Value = "01" And IsUserHasRightOfFunction = False Then
            If strFunc = strAdd Or strFunc = strEdit Or strFunc = strDel Then
               IsUserHasRightOfFunction = False
            Else
               IsUserHasRightOfFunction = True
            End If
            rsStaff.Close
            Set rsStaff = Nothing
            Set rsRight = Nothing
            Exit Function
         End If
         '2014/4/24 end
         
         'add by sonia 2024/3/20 30015顧服智權專利的客戶開放'30015客戶可查閱人員'可打破跨所查詢權限
         If strFunc = strBranch And IsUserHasRightOfFunction = False Then
            strSql = "select distinct c1.cu13,c2.cu13,c3.cu13,c4.cu13,c5.cu13 from caseprogress,patent,trademark,servicepractice,lawcase,hirecase,customer c1,customer c2,customer c3,customer c4,customer c5 " & _
                     "where cp01='" & strCP01 & "' AND CP02='" & strCP02 & "' AND CP03='" & strCP03 & "' AND CP04='" & strCP04 & "' and cp01=pa01(+) and cp02=pa02(+) and cp03=pa03(+) and cp04=pa04(+) " & _
                     "and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+) and cp01=sp01(+) and cp02=sp02(+) and cp03=sp03(+) and cp04=sp04(+) " & _
                     "and cp01=lc01(+) and cp02=lc02(+) and cp03=lc03(+) and cp04=lc04(+) and cp01=hc01(+) and cp02=hc02(+) and cp03=hc03(+) and cp04=hc04(+) " & _
                     "and substr(nvl(nvl(nvl(nvl(pa26,tm23),sp08),lc11),hc05),1,8)=c1.cu01(+) and substr(nvl(nvl(nvl(nvl(pa26,tm23),sp08),lc11),hc05),9,1)=c1.cu02(+) " & _
                     "and substr(nvl(nvl(nvl(nvl(pa27,tm78),sp58),lc11),hc05),1,8)=c2.cu01(+) and substr(nvl(nvl(nvl(nvl(pa27,tm78),sp58),lc11),hc05),9,1)=c2.cu02(+) " & _
                     "and substr(nvl(nvl(nvl(nvl(pa28,tm79),sp59),lc11),hc05),1,8)=c3.cu01(+) and substr(nvl(nvl(nvl(nvl(pa28,tm79),sp59),lc11),hc05),9,1)=c3.cu02(+) " & _
                     "and substr(nvl(nvl(nvl(nvl(pa29,tm80),sp65),lc11),hc05),1,8)=c4.cu01(+) and substr(nvl(nvl(nvl(nvl(pa29,tm80),sp65),lc11),hc05),9,1)=c4.cu02(+) " & _
                     "and substr(nvl(nvl(nvl(nvl(pa30,tm81),sp66),lc11),hc05),1,8)=c5.cu01(+) and substr(nvl(nvl(nvl(nvl(pa30,tm80),sp66),lc11),hc05),9,1)=c5.cu02(+) " & _
                     "and (c1.cu13='30015' or c2.cu13='30015' and c3.cu13='30015' and c4.cu13='30015' and c5.cu13='30015') "
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strSql)
            If intI = 1 Then
               stUsers = Pub_GetSpecMan("30015客戶可查閱人員")
               If InStr(stUsers, strUserNum) > 0 Then IsUserHasRightOfFunction = True
            End If
         End If
         'end 2024/3/20
         
      End If
   End If
   rsStaff.Close
   
   ' 顯示訊息提示使用者
   If IsUserHasRightOfFunction = False Then
      If bShowMsg Then
         MsgBox "您沒有使用該項作業的權限...", vbOKOnly + vbCritical, "警告!!"
      End If
   End If
   
   ' 清除所佔用的資源
   Set rsStaff = Nothing
   Set rsRight = Nothing
   Exit Function

' 發生錯誤時設定回傳為False
ERRORSECTION:
   IsUserHasRightOfFunction = False
   Exit Function
End Function

'2008/12/9 ADD BY SONIA 讀取員工SR10語文權限
Public Function IsUserHasRightOfLanguage() As String
' 讀取員工權限檔的Recordset
Dim rsRight As ADODB.Recordset
' 查詢資料庫的SQL字串
Dim strSql As String
      
   IsUserHasRightOfLanguage = ""

On Error GoTo ERRORSECTION
   ' 讀取權限檔
   'Modify by Morgan 2008/9/28 改先抓個人設定
   strSql = "SELECT 2,SR10,ST05 FROM STAFF_RIGHT SR,STAFF WHERE ST01 = '" & Trim(strUserNum) & "' AND ST05=SR01(+) AND SR02(+) = 'frm140404'"
   strSql = strSql & " union all SELECT 1,SR10,ST05 FROM STAFF_RIGHT SR,STAFF WHERE ST01 = '" & Trim(strUserNum) & "' AND ST01=SR01 AND SR02 = 'frm140404' order by 1"
   
   Set rsRight = New ADODB.Recordset
   rsRight.CursorLocation = adUseClient
   rsRight.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If rsRight.RecordCount > 0 Then
      ' 等級編號為00的員工擁有執行所有作業及功能的權限
      If rsRight.Fields("ST05").Value = "00" Or rsRight.Fields("ST05").Value = "01" Then
         IsUserHasRightOfLanguage = "Y"
         rsRight.Close
         Set rsRight = Nothing
         Exit Function
      End If
      If IsNull(rsRight.Fields("SR10")) = False Then
         IsUserHasRightOfLanguage = rsRight.Fields("SR10").Value
      End If
   End If
   rsRight.Close
   
   ' 清除所佔用的資源
   Set rsRight = Nothing
   Exit Function

' 發生錯誤時設定回傳為False
ERRORSECTION:
   Exit Function
End Function
'2008/12/9 END

'ADD BY Sindy 2011/01/03 讀取員工SR12國內外權限
Public Function IsUserHasRightOfSR12() As String
' 讀取員工權限檔的Recordset
Dim rsRight As ADODB.Recordset
' 查詢資料庫的SQL字串
Dim strSql As String
   
   IsUserHasRightOfSR12 = ""
   
On Error GoTo ERRORSECTION
   ' 讀取權限檔
   ' 先抓個人設定
   strSql = "SELECT 2,SR12,ST05 FROM STAFF_RIGHT SR,STAFF WHERE ST01 = '" & Trim(strUserNum) & "' AND ST05=SR01(+) AND SR02(+) = 'frm100101_1'"
   strSql = strSql & " union all SELECT 1,SR12,ST05 FROM STAFF_RIGHT SR,STAFF WHERE ST01 = '" & Trim(strUserNum) & "' AND ST01=SR01 AND SR02 = 'frm100101_1' order by 1"
   
   Set rsRight = New ADODB.Recordset
   rsRight.CursorLocation = adUseClient
   rsRight.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If rsRight.RecordCount > 0 Then
      ' 等級編號為00的員工擁有執行所有作業及功能的權限
      If rsRight.Fields("ST05").Value = "00" Or rsRight.Fields("ST05").Value = "01" Then
         IsUserHasRightOfSR12 = ""
         rsRight.Close
         Set rsRight = Nothing
         Exit Function
      End If
      If IsNull(rsRight.Fields("SR12")) = False Then
         IsUserHasRightOfSR12 = rsRight.Fields("SR12").Value
      End If
   End If
   rsRight.Close
   
   ' 清除所佔用的資源
   Set rsRight = Nothing
   Exit Function

' 發生錯誤時設定回傳為False
ERRORSECTION:
   Exit Function
End Function
'2011/01/03 END

'Add By Cheng 2003/08/12
'**********
'注意：資料庫DB中的函數 (GetRelateCasePropertyName) 與此相同，修改時要一併調整 Sindy 2019/1/30
'**********
Public Function PUB_GetRelateCasePropertyName(strCP09 As String, strLang As String) As String
'strLang : 1中文 2英文 3日文
Dim StrSQLa As String, StrSqlB As String
Dim rsA As New ADODB.Recordset
Dim rsB As New ADODB.Recordset
Dim intR As Integer
Dim strCP30 As String
 
PUB_GetRelateCasePropertyName = ""
 
'Modify by Morgan 2007/10/17
'If strCP09 > "C" Then
'    StrSQLa = "Select Decode(PA09,'000',CPM03,CPM04), CPM10, CPM13 From CaseProgress, Patent, CasePropertyMap Where CP01=PA01 And CP02=PA02 And CP03=PA03 And CP04=PA04 And CP01=CPM01 And CP10=CPM02 And CP09=(Select CP43 From CaseProgress Where CP01 In ('CFP','FCP','P',' ') And CP10 In ('1001','1002',' ') And CP09='" & strCP09 & "' ) "
'    StrSQLa = StrSQLa & " Union Select Decode(TM10,'000',CPM03,CPM04), CPM10, CPM13 From CaseProgress, Trademark, CasePropertyMap Where CP01=TM01 And CP02=TM02 And CP03=TM03 And CP04=TM04 And CP01=CPM01 And CP10=CPM02 And CP09=(Select CP43 From CaseProgress Where CP01 In ('CFT','FCT','T','TF',' ') And CP10 In ('1001','1002','1003','1004',' ') And CP09='" & strCP09 & "' ) "
'    rsA.CursorLocation = adUseClient
'    rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
'    If rsA.RecordCount > 0 Then
'        Select Case strLang
'        Case "1" '中文
'            PUB_GetRelateCasePropertyName = "-" & rsA.Fields(0).Value
'        Case "2" '英文
'            PUB_GetRelateCasePropertyName = "-" & rsA.Fields(1).Value
'        Case "3" '日文
'            PUB_GetRelateCasePropertyName = "-" & rsA.Fields(2).Value
'        End Select
'    End If
'    If rsA.State <> adStateClosed Then rsA.Clone
'    Set rsA = Nothing
'End If
''add by nickc 2006/09/01 加入不續辦、取消收文、閉卷也要
'If PUB_GetRelateCasePropertyName = "" Then PUB_GetRelateCasePropertyName = PUB_GetRelateNPCPName(strCP09, strLang)
 
   '2007/10/22 MODIFY BY SONIA 控制B類延期檢視中說FCP-035550,延期補文件FCP-036100
   'StrSQLa = "select cp01,cp10,cp43 from caseprogress where cp09='" & strCP09 & "'"
   'Modify by Morgan 2011/4/22 +CP30 延期判斷用
   StrSQLa = "select cp01,cp10,cp43,CP27,CP30 from caseprogress where cp09='" & strCP09 & "'"
   '2007/10/22 END
   intR = 1
   Set rsA = ClsLawReadRstMsg(intR, StrSQLa)
   If intR = 1 Then
      StrSQLa = "": StrSqlB = ""
      With rsA
      
      '有相關總收文號
      If Not IsNull(.Fields("cp43")) Then
         '依系統別分類
         Select Case .Fields("cp01")
            Case "CFP", "FCP", "P"
               '依案件性質分類
               Select Case .Fields("cp10")
                  '核准、核駁、自請撤回
                  '2010/3/23 MODIFY BY SONIA 加908退費及911補收款
                  'modify by sonia 2015/9/18 加411催審
                  'Modified by Lydia 2015/10/02 +1008核發
                  'Modified by Morgan 2016/5/11 +1909已提申
                  'Modified by Morgan 2016/5/17 +952催收達 953催提申
                  Case "1001", "1002", "413", "908", "911", "411", "1008", "1909", "952", "953"
                     StrSQLa = "Select Decode(PA09,'000',CPM03,CPM04), CPM10, CPM13 From CaseProgress, Patent, CasePropertyMap Where CP01=PA01 And CP02=PA02 And CP03=PA03 And CP04=PA04 And CP01=CPM01 And CP10=CPM02 And CP09='" & .Fields("cp43") & "'"
                  '延期、通知期限
                  Case "404", "1913" 'Modified by Morgan 2013/8/7 +1913通知期限
                     strCP30 = Val("" & .Fields("cp30")) 'Add by Morgan 2011/4/26
                     'Add by Morgan 2011/4/22 +延期改分案若點 NP 時寫 NP22 -> CP30
                     If Val(strCP30) > 0 Then
                        StrSQLa = "Select Decode(PA09,'000',CPM03,CPM04), CPM10, CPM13 From nextProgress, Patent, CasePropertyMap Where nP02=PA01 And nP03=PA02 And nP04=PA03 And nP05=PA04 And nP02=CPM01 And to_char(nP07)=CPM02 And np01='" & .Fields("cp43") & "' and np22=" & strCP30
                     Else
                     '資料若能修正則下面程式可改固定抓 CP
                     'end 2011/4/22
                        'A類收文
                        '2010/10/8 MODIFY BY SONIA A類收文但相關總收文號為A類者仍走下面B類收文抓進度資料 P-091305的99/8/2延期
                        'If Left(strCP09, 1) = "A" Then
                        If Left(strCP09, 1) = "A" And Left(.Fields("cp43"), 1) <> "A" Then
                        '2010/10/8 END
                           StrSQLa = "Select Decode(PA09,'000',CPM03,CPM04), CPM10, CPM13 From nextProgress, Patent, CasePropertyMap Where nP02=PA01 And nP03=PA02 And nP04=PA03 And nP05=PA04 And nP02=CPM01 And to_char(nP07)=CPM02 And np01='" & .Fields("cp43") & "'"
                        'B類收文
                        Else
                           '2007/10/22 MODIFY BY SONIA 控制B類延期檢視中說FCP-035550,延期補文件FCP-036100
                           'StrSQLa = "Select Decode(PA09,'000',CPM03,CPM04), CPM10, CPM13 From CaseProgress, Patent, CasePropertyMap Where CP01=PA01 And CP02=PA02 And CP03=PA03 And CP04=PA04 And CP01=CPM01 And CP10=CPM02 And CP09='" & .Fields("cp43") & "'"
                           StrSQLa = "Select Decode(PA09,'000',CPM03,CPM04), CPM10, CPM13,CP27 From CaseProgress, Patent, CasePropertyMap Where CP01=PA01 And CP02=PA02 And CP03=PA03 And CP04=PA04 And CP01=CPM01 And CP10=CPM02 And CP09='" & .Fields("cp43") & "'"
                           StrSqlB = "Select Decode(PA09,'000',CPM03,CPM04), CPM10, CPM13 From nextProgress, Patent, CasePropertyMap Where nP02=PA01 And nP03=PA02 And nP04=PA03 And nP05=PA04 And nP02=CPM01 And to_char(nP07)=CPM02 And np01='" & .Fields("cp43") & "'"
                           '2007/10/22 END
                        End If
                     End If 'Add by Morgan 2011/4/22
                  '不續辦、閉卷
                  Case "907", "913"
                     StrSQLa = "Select Decode(PA09,'000',CPM03,CPM04), CPM10, CPM13 From nextProgress, Patent, CasePropertyMap Where nP02=PA01 And nP03=PA02 And nP04=PA03 And nP05=PA04 And nP02=CPM01 And to_char(nP07)=CPM02 And (np01,np11,NP22) in (Select CP43,DECODE(CP05,CP57,cp05,CP57),CP30 From CaseProgress Where CP09='" & strCP09 & "' ) "
                     StrSqlB = "Select Decode(PA09,'000',CPM03,CPM04), CPM10, CPM13 From CaseProgress, Patent, CasePropertyMap Where CP01=PA01 And CP02=PA02 And CP03=PA03 And CP04=PA04 And CP01=CPM01 And CP10=CPM02 And (CP09,cp57) in (Select CP43,DECODE(cp05,CP57,CP05,CP57) From CaseProgress Where CP09='" & strCP09 & "' ) "
                  '取消收文
                  Case "925"
                     StrSQLa = "Select Decode(PA09,'000',CPM03,CPM04), CPM10, CPM13 From CaseProgress, Patent, CasePropertyMap Where CP01=PA01 And CP02=PA02 And CP03=PA03 And CP04=PA04 And CP01=CPM01 And CP10=CPM02 And (CP09,cp57) in (Select CP43,DECODE(cp05,CP57,CP05,CP57) From CaseProgress Where CP09='" & strCP09 & "' ) "
               End Select
               
            Case "CFT", "FCT", "T", "TF"
               Select Case .Fields("cp10")
                  '核准、核駁、勝訴、敗訴、自請撤回、自請撤銷
                  '2010/3/23 MODIFY BY SONIA 加725退費及705補收款
                  'modify by sonia 2015/9/18 加305催審
                  'modify by sonia 2023/11/23 加1909已提申
                  Case "1001", "1002", "1003", "1004", "306", "307", "725", "705", "305", "1909"
                     StrSQLa = "Select Decode(TM10,'000',CPM03,CPM04), CPM10, CPM13 From CaseProgress, Trademark, CasePropertyMap Where CP01=TM01 And CP02=TM02 And CP03=TM03 And CP04=TM04 And CP01=CPM01 And CP10=CPM02 And CP09='" & .Fields("cp43") & "'"
                  '延期、通知期限
                  Case "303", "1725" 'Modify By Sindy 2015/3/2 +1725通知期限
                     strCP30 = Val("" & .Fields("cp30")) 'Add by Morgan 2011/4/26
                     'Add by Morgan 2011/4/22 +延期改分案若點 NP 時寫 NP22 -> CP30
                     If Val(strCP30) > 0 Then
                        StrSQLa = "Select Decode(TM10,'000',CPM03,CPM04), CPM10, CPM13 From nextProgress, Trademark, CasePropertyMap Where nP02=TM01 And nP03=TM02 And nP04=TM03 And nP05=TM04 And nP02=CPM01 And to_char(nP07)=CPM02 And np01='" & .Fields("cp43") & "' and np22=" & strCP30
                     Else
                     
                        '2010/10/8 MODIFY BY SONIA A類收文但相關總收文號為A類者仍走下面B類收文抓進度資料 P-091305的99/8/2延期
                        'If Left(strCP09, 1) = "A" Then
                        If Left(strCP09, 1) = "A" And Left(.Fields("cp43"), 1) <> "A" Then
                        '2010/10/8 END
                           StrSQLa = "Select Decode(TM10,'000',CPM03,CPM04), CPM10, CPM13 From nextProgress, Trademark, CasePropertyMap Where nP02=TM01 And nP03=TM02 And nP04=TM03 And nP05=TM04 And nP02=CPM01 And to_char(nP07)=CPM02 And np01='" & .Fields("cp43") & "'"
                        Else
                           '2007/10/22 MODIFY BY SONIA 控制B類延期是按延期按鈕或內部收文延下一程序
                           'StrSQLa = "Select Decode(TM10,'000',CPM03,CPM04), CPM10, CPM13 From CaseProgress, Trademark, CasePropertyMap Where CP01=TM01 And CP02=TM02 And CP03=TM03 And CP04=TM04 And CP01=CPM01 And CP10=CPM02 And CP09='" & .Fields("cp43") & "'"
                           StrSQLa = "Select Decode(TM10,'000',CPM03,CPM04), CPM10, CPM13,CP27 From CaseProgress, Trademark, CasePropertyMap Where CP01=TM01 And CP02=TM02 And CP03=TM03 And CP04=TM04 And CP01=CPM01 And CP10=CPM02 And CP09='" & .Fields("cp43") & "'"
                           StrSqlB = "Select Decode(TM10,'000',CPM03,CPM04), CPM10, CPM13 From nextProgress, Trademark, CasePropertyMap Where nP02=TM01 And nP03=TM02 And nP04=TM03 And nP05=TM04 And nP02=CPM01 And to_char(nP07)=CPM02 And np01='" & .Fields("cp43") & "'"
                           '2007/10/22 END
                        End If
                     End If
                  'add by sonia 2016/9/1 T因大陸案故+通知申請案號1101
                  Case "1101"
                     If .Fields("cp01") = "T" Then
                        StrSQLa = "Select Decode(TM10,'000',CPM03,CPM04), CPM10, CPM13 From CaseProgress, Trademark, CasePropertyMap Where CP01=TM01 And CP02=TM02 And CP03=TM03 And CP04=TM04 And CP01=CPM01 And CP10=CPM02 And CP09='" & .Fields("cp43") & "'"
                     End If
                  'end 2016/9/1
                  '不續辦、閉卷
                  Case "703", "704"
                     StrSQLa = "Select Decode(TM10,'000',CPM03,CPM04), CPM10, CPM13 From nextProgress, Trademark, CasePropertyMap Where nP02=TM01 And nP03=TM02 And nP04=TM03 And nP05=TM04 And nP02=CPM01 And to_char(nP07)=CPM02 And (np01,np11,NP22) in (Select CP43,DECODE(CP05,CP57,cp05,CP57),CP30 From CaseProgress Where CP09='" & strCP09 & "' ) "
                     StrSqlB = "Select Decode(TM10,'000',CPM03,CPM04), CPM10, CPM13 From CaseProgress, Trademark, CasePropertyMap Where CP01=TM01 And CP02=TM02 And CP03=TM03 And CP04=TM04 And CP01=CPM01 And CP10=CPM02 And (CP09,cp57) in (Select CP43,DECODE(cp05,CP57,CP05,CP57) From CaseProgress Where CP09='" & strCP09 & "' ) "
                  '取消收文
                  Case "718"
                     StrSQLa = "Select Decode(TM10,'000',CPM03,CPM04), CPM10, CPM13 From CaseProgress, Trademark, CasePropertyMap Where CP01=TM01 And CP02=TM02 And CP03=TM03 And CP04=TM04 And CP01=CPM01 And CP10=CPM02 And (CP09,cp57) in (Select CP43,DECODE(cp05,CP57,CP05,CP57) From CaseProgress Where CP09='" & strCP09 & "' ) "
               End Select
            
            'Modify By Sindy 2009/07/24 增加LIN系統類別
            'modify by sonia 2019/7/31 +ACS系統類別
            Case "L", "FCL", "CFL", "LIN", "ACS"
               Select Case .Fields("cp10")
                  '不續辦、閉卷
                  Case "991", "993"
                     StrSQLa = "Select Decode(lc15,'000',CPM03,CPM04), CPM10, CPM13 From nextProgress, lawcase, CasePropertyMap Where nP02=lc01 And nP03=lc02 And nP04=lc03 And nP05=lc04 And nP02=CPM01 And to_char(nP07)=CPM02 And (np01,np11,NP22) in (Select CP43,DECODE(CP05,CP57,cp05,CP57),CP30 From CaseProgress Where CP09='" & strCP09 & "' ) "
                     StrSqlB = "Select Decode(lc15,'000',CPM03,CPM04), CPM10, CPM13 From CaseProgress, lawcase, CasePropertyMap Where CP01=lc01 And CP02=lc02 And CP03=lc03 And CP04=lc04 And CP01=CPM01 And CP10=CPM02 And (CP09,cp57) in (Select CP43,DECODE(cp05,CP57,CP05,CP57) From CaseProgress Where CP09='" & strCP09 & "' ) "
                  '取消收文
                  Case "992"
                     StrSQLa = "Select Decode(lc15,'000',CPM03,CPM04), CPM10, CPM13 From CaseProgress, lawcase, CasePropertyMap Where CP01=lc01 And CP02=lc02 And CP03=lc03 And CP04=lc04 And CP01=CPM01 And CP10=CPM02 And (CP09,cp57) in (Select CP43,DECODE(cp05,CP57,CP05,CP57) From CaseProgress Where CP09='" & strCP09 & "' ) "
               End Select
               
            Case "LA"
               Select Case .Fields("cp10")
                  '不續辦、閉卷
                  Case "991", "993"
                     StrSQLa = "Select CPM03, CPM10, CPM13 From nextProgress, hirecase, CasePropertyMap Where nP02=hc01 And nP03=hc02 And nP04=hc03 And nP05=hc04 And nP02=CPM01 And to_char(nP07)=CPM02 And (np01,np11,NP22) in (Select CP43,DECODE(CP05,CP57,cp05,CP57),CP30 From CaseProgress Where CP09='" & strCP09 & "' ) "
                     StrSqlB = "Select CPM03, CPM10, CPM13 From CaseProgress, hirecase, CasePropertyMap Where CP01=hc01 And CP02=hc02 And CP03=hc03 And CP04=hc04 And CP01=CPM01 And CP10=CPM02 And (CP09,cp57) in (Select CP43,DECODE(cp05,CP57,CP05,CP57) From CaseProgress Where CP09='" & strCP09 & "' ) "
                  '取消收文
                  Case "992"
                     StrSQLa = "Select CPM03, CPM10, CPM13 From CaseProgress, hirecase, CasePropertyMap Where CP01=hc01 And CP02=hc02 And CP03=hc03 And CP04=hc04 And CP01=CPM01 And CP10=CPM02 And (CP09,cp57) in (Select CP43,DECODE(cp05,CP57,CP05,CP57) From CaseProgress Where CP09='" & strCP09 & "' ) "
               End Select
               
            Case "PS", "FG", "CPS"
               Select Case .Fields("cp10")
                  'end 2025/3/20
                  'add by sonia 2015/9/18 加908退費,911補收款,411催審
                  'modify by sonia 2023/11/22 加952催收達 953催提申
                  'Modified by Morgan 2025/3/20 +1001,1002
                  Case "908", "911", "411", "952", "953", "1001", "1002"
                     StrSQLa = "Select Decode(sp09,'000',CPM03,CPM04), CPM10, CPM13 From CaseProgress, servicepractice, CasePropertyMap Where CP01=sp01 And CP02=sp02 And CP03=sp03 And CP04=sp04 And CP01=CPM01 And CP10=CPM02 And CP09='" & .Fields("cp43") & "'"
                  'add by sonia 2023/11/22 加延期
                  '延期
                  Case "404"
                     strCP30 = Val("" & .Fields("cp30"))
                     If Val(strCP30) > 0 Then
                        StrSQLa = "Select Decode(sp09,'000',CPM03,CPM04), CPM10, CPM13 From nextProgress, servicepractice, CasePropertyMap Where nP02=SP01 And nP03=SP02 And nP04=SP03 And nP05=SP04 And nP02=CPM01 And to_char(nP07)=CPM02 And np01='" & .Fields("cp43") & "' and np22=" & strCP30
                     Else
                        'A類收文
                        If Left(strCP09, 1) = "A" And Left(.Fields("cp43"), 1) <> "A" Then
                           StrSQLa = "Select Decode(sp09,'000',CPM03,CPM04), CPM10, CPM13 From nextProgress, servicepractice, CasePropertyMap Where nP02=SP01 And nP03=SP02 And nP04=SP03 And nP05=SP04 And nP02=CPM01 And to_char(nP07)=CPM02 And np01='" & .Fields("cp43") & "'"
                        'B類收文
                        Else
                           StrSQLa = "Select Decode(sp09,'000',CPM03,CPM04), CPM10, CPM13,CP27 From CaseProgress, servicepractice, CasePropertyMap Where CP01=SP01 And CP02=SP02 And CP03=SP03 And CP04=SP04 And CP01=CPM01 And CP10=CPM02 And CP09='" & .Fields("cp43") & "'"
                           StrSqlB = "Select Decode(sp09,'000',CPM03,CPM04), CPM10, CPM13 From nextProgress, servicepractice, CasePropertyMap Where nP02=SP01 And nP03=SP02 And nP04=SP03 And nP05=SP04 And nP02=CPM01 And to_char(nP07)=CPM02 And np01='" & .Fields("cp43") & "'"
                        End If
                     End If
                  'end 2023/11/22
                  '不續辦、閉卷
                  Case "907", "913"
                     StrSQLa = "Select Decode(sp09,'000',CPM03,CPM04), CPM10, CPM13 From nextProgress, servicepractice, CasePropertyMap Where nP02=sp01 And nP03=sp02 And nP04=sp03 And nP05=sp04 And nP02=CPM01 And to_char(nP07)=CPM02 And (np01,np11,NP22) in (Select CP43,DECODE(CP05,CP57,cp05,CP57),CP30 From CaseProgress Where CP09='" & strCP09 & "' ) "
                     StrSqlB = "Select Decode(sp09,'000',CPM03,CPM04), CPM10, CPM13 From CaseProgress, servicepractice, CasePropertyMap Where CP01=sp01 And CP02=sp02 And CP03=sp03 And CP04=sp04 And CP01=CPM01 And CP10=CPM02 And (CP09,cp57) in (Select CP43,DECODE(cp05,CP57,CP05,CP57) From CaseProgress Where CP09='" & strCP09 & "' ) "
                  '取消收文
                  Case "925"
                     StrSQLa = "Select Decode(sp09,'000',CPM03,CPM04), CPM10, CPM13 From CaseProgress, servicepractice, CasePropertyMap Where CP01=sp01 And CP02=sp02 And CP03=sp03 And CP04=sp04 And CP01=CPM01 And CP10=CPM02 And (CP09,cp57) in (Select CP43,DECODE(cp05,CP57,CP05,CP57) From CaseProgress Where CP09='" & strCP09 & "' ) "
               End Select
               
            Case "CFC", "S", "TB", "TC", "TD", "TF", "TM", "TR", "TS", "TT"
               Select Case .Fields("cp10")
                  'add by sonia 2015/9/18
                  '核准、核駁、勝訴、敗訴、自請撤回、自請撤銷、退費、補收款、催審
                  'modify by sonia 2023/11/23 加1909已提申
                  Case "1001", "1002", "1003", "1004", "306", "307", "725", "705", "305", "1909"
                     StrSQLa = "Select Decode(sp10,'000',CPM03,CPM04), CPM10, CPM13 From CaseProgress, servicepractice, CasePropertyMap Where CP01=sp01 And CP02=sp02 And CP03=sp03 And CP04=sp04 And CP01=CPM01 And CP10=CPM02 And CP09='" & .Fields("cp43") & "'"
                  'end 2015/9/18
                  'add by sonia 2023/11/22 加通知期限1725及通知申請案號1101
                  '通知期限
                  Case "1725" 'Modify By Sindy
                     strCP30 = Val("" & .Fields("cp30"))
                     If Val(strCP30) > 0 Then
                        StrSQLa = "Select Decode(sp09,'000',CPM03,CPM04), CPM10, CPM13 From nextProgress, servicepractice, CasePropertyMap Where nP02=sp01 And nP03=sp02 And nP04=sp03 And nP05=sp04 And nP02=CPM01 And to_char(nP07)=CPM02 And np01='" & .Fields("cp43") & "' and np22=" & strCP30
                     Else
                        If Left(strCP09, 1) = "A" And Left(.Fields("cp43"), 1) <> "A" Then
                           StrSQLa = "Select Decode(sp09,'000',CPM03,CPM04), CPM10, CPM13 From nextProgress, servicepractice, CasePropertyMap Where nP02=sp01 And nP03=sp02 And nP04=sp03 And nP05=sp04 And nP02=CPM01 And to_char(nP07)=CPM02 And np01='" & .Fields("cp43") & "'"
                        Else
                           StrSQLa = "Select Decode(sp09,'000',CPM03,CPM04), CPM10, CPM13,CP27 From CaseProgress, servicepractice, CasePropertyMap Where CP01=sp01 And CP02=sp02 And CP03=sp03 And CP04=sp04 And CP01=CPM01 And CP10=CPM02 And CP09='" & .Fields("cp43") & "'"
                           StrSqlB = "Select Decode(sp09,'000',CPM03,CPM04), CPM10, CPM13 From nextProgress, servicepractice, CasePropertyMap Where nP02=sp01 And nP03=sp02 And nP04=sp03 And nP05=sp04 And nP02=CPM01 And to_char(nP07)=CPM02 And np01='" & .Fields("cp43") & "'"
                        End If
                     End If
                  '通知申請案號
                  Case "1101"
                     StrSQLa = "Select Decode(sp09,'000',CPM03,CPM04), CPM10, CPM13 From CaseProgress, servicepractice, CasePropertyMap Where CP01=sp01 And CP02=sp02 And CP03=sp03 And CP04=sp04 And CP01=CPM01 And CP10=CPM02 And CP09='" & .Fields("cp43") & "'"
                  'end 2023/11/22
                  '不續辦、閉卷
                  Case "703", "704"
                     StrSQLa = "Select Decode(sp09,'000',CPM03,CPM04), CPM10, CPM13 From nextProgress, servicepractice, CasePropertyMap Where nP02=sp01 And nP03=sp02 And nP04=sp03 And nP05=sp04 And nP02=CPM01 And to_char(nP07)=CPM02 And (np01,np11,NP22) in (Select CP43,DECODE(CP05,CP57,cp05,CP57),CP30 From CaseProgress Where CP09='" & strCP09 & "' ) "
                     StrSqlB = "Select Decode(sp09,'000',CPM03,CPM04), CPM10, CPM13 From CaseProgress, servicepractice, CasePropertyMap Where CP01=sp01 And CP02=sp02 And CP03=sp03 And CP04=sp04 And CP01=CPM01 And CP10=CPM02 And (CP09,cp57) in (Select CP43,DECODE(cp05,CP57,CP05,CP57) From CaseProgress Where CP09='" & strCP09 & "' ) "
                  '取消收文
                  Case "718"
                     StrSQLa = "Select Decode(sp09,'000',CPM03,CPM04), CPM10, CPM13 From CaseProgress, servicepractice, CasePropertyMap Where CP01=sp01 And CP02=sp02 And CP03=sp03 And CP04=sp04 And CP01=CPM01 And CP10=CPM02 And (CP09,cp57) in (Select CP43,DECODE(cp05,CP57,CP05,CP57) From CaseProgress Where CP09='" & strCP09 & "' ) "
               End Select
               
         End Select
      'add by sonia 2016/7/14 加'本所信函'同時顯示進度備註
      Else
         Select Case .Fields("cp01")
            Case "CFP", "FCP", "P"
               '依案件性質分類
               Select Case .Fields("cp10")
                  Case "1999"
                      StrSQLa = "Select CP64 From CaseProgress, Patent, CasePropertyMap Where CP01=PA01 And CP02=PA02 And CP03=PA03 And CP04=PA04 And CP01=CPM01 And CP10=CPM02 And CP09='" & strCP09 & "'"
               End Select
            Case "CFT", "FCT", "T", "TF"
               Select Case .Fields("cp10")
                  Case "1799"
                      StrSQLa = "Select CP64 From CaseProgress, Trademark, CasePropertyMap Where CP01=TM01 And CP02=TM02 And CP03=TM03 And CP04=TM04 And CP01=CPM01 And CP10=CPM02 And CP09='" & strCP09 & "'"
               End Select
         End Select
      'end 2016/7/14
      End If
      End With
      If StrSQLa <> "" Then
         intR = 1
         Set rsB = ClsLawReadRstMsg(intR, StrSQLa)
         If intR <> 1 Then
            If StrSqlB <> "" Then
               intR = 1
               Set rsB = ClsLawReadRstMsg(intR, StrSqlB)
            End If
         'Modify by Morgan 2011/4/26
         'Else
         ElseIf Val(strCP30) = 0 Then
         'end 2011/4/26
         
'MODIFY BY SONIA 2014/7/4 FCT-033153 審查報告未發文先延期補正
'            '2007/10/22 ADD BY SONIA 判斷專利B類延期404或商標延期303之發文日與CP43之發文日
'            If (rsA.Fields("cp10") = "404" Or rsA.Fields("cp10") = "303") And strCP09 > "B" Then
'               If IsNull(rsB.Fields("CP27").Value) Then                   'CP43未發文時抓CP43之案件性質
'                  intR = 1
'                  Set rsB = ClsLawReadRstMsg(intR, StrSQLa)
'               '2013/10/31 add by sonia FCT-35205
'               ElseIf "" & rsB.Fields("CP27").Value = 19221111 Then       'CP43假發文11/11/11時抓CP43之案件性質
'                  intR = 1
'                  Set rsB = ClsLawReadRstMsg(intR, StrSQLa)
'               '2013/10/31 end
'               ElseIf rsA.Fields("cp27") <= rsB.Fields("CP27").Value Then 'B類延期發文日<=CP43之發文時抓CP43之案件性質
'                  intR = 1
'                  Set rsB = ClsLawReadRstMsg(intR, StrSQLa)
'               '2010/5/6 MODIFY BY SONIA 內部收文未發文前應帶NP之案件性質 FCT-029417
'               'ElseIf rsA.Fields("cp27") > rsB.Fields("CP27").Value Then  'B類延期發文日>CP43之發文時抓NP之案件性質
'               ElseIf IsNull(rsA.Fields("cp27")) Or (rsA.Fields("cp27") > rsB.Fields("CP27").Value) Then  'B類延期發文日>CP43之發文時抓NP之案件性質
'                  intR = 1
'                  Set rsB = ClsLawReadRstMsg(intR, StrSqlB)
'               End If
'            End If
'            '2007/10/22 END
            If (rsA.Fields("cp10") = "404" Or rsA.Fields("cp10") = "303") And strCP09 > "B" Then
               If "" & rsA.Fields("cp43") < "C" Then                         'CP43為A,B類時抓CP43之案件性質
                  intR = 1
                  Set rsB = ClsLawReadRstMsg(intR, StrSQLa)
               Else                                                          'CP43為C類時抓NP之案件性質
                  intR = 1
                  Set rsB = ClsLawReadRstMsg(intR, StrSqlB)
               End If
            End If
'END 2014/7/4
         End If
         If intR = 1 Then
            Select Case strLang
                Case "1" '中文
                    PUB_GetRelateCasePropertyName = "-" & rsB.Fields(0).Value
                Case "2" '英文
                    PUB_GetRelateCasePropertyName = "-" & rsB.Fields(1).Value
                Case "3" '日文
                    PUB_GetRelateCasePropertyName = "-" & rsB.Fields(2).Value
            End Select
         End If
      End If
   End If
'end 2007/10/17
End Function

''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' 取得員工的姓名
' Input : strStuff ==> 員工的代碼
'         bAll ==> 是否包含已離職的員工 (不輸入此參數時預設為False)
'                  True : 表包含所有已離職的員工
'                  False : 只查詢在職的員工 (預設值)
' Output : 傳回員工的姓名
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
'Modified by Lydia 2016/08/17 +取得部門別名稱strDeptName
'Modified by Lydia 2016/10/26 +取得部門別strST03
'Modified by Lydia 2020/04/10 +取得員工在職／離職 strST04
Public Function GetStaffName(ByVal strStuff As String, Optional ByVal bAll As Boolean = False, Optional ByRef strDeptName As String, Optional ByRef strST03 As String, _
                                      Optional ByRef strST04 As String) As String
   Dim rsTmp As New ADODB.Recordset
   Dim strSql As String
   
   GetStaffName = Empty
   'Modified by Lydia 2016/08/17
   'strSql = "SELECT * FROM Staff " & _
            "WHERE ST01 = '" & strStuff & "' "
   strDeptName = Empty
   strST03 = Empty 'Added by Lydia 2016/10/26
   'Added by Lydia 2024/01/05
   If strSrvDate(1) >= 新部門啟用日 Then
      strSql = "SELECT ST02,ST04,NVL(A0922,A0902) AS A0902,ST03 FROM STAFF,ACC090,ACC090NEW WHERE ST01='" & strStuff & "' And ST03=A0901(+) AND ST93=A0921(+) "
   Else
   'end 2024/01/05
      'Modified by Lydia 2016/10/26 +ST03
      strSql = "SELECT ST02,ST04,A0902,ST03 FROM STAFF,ACC090 WHERE ST01='" & strStuff & "' And ST03=A0901(+) "
   End If
   rsTmp.CursorLocation = adUseClient
   rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If rsTmp.RecordCount > 0 Then
      rsTmp.MoveFirst
      If IsNull(rsTmp.Fields("ST02")) = False Then
         GetStaffName = rsTmp.Fields("ST02")
         strST03 = "" & rsTmp.Fields("ST03") 'Added by Lydia 2016/10/26
         If "" & rsTmp.Fields("A0902") <> "" Then strDeptName = "" & rsTmp.Fields("A0902") 'Added by Lydia 2016/08/17
         strST04 = "" & rsTmp.Fields("ST04") 'Added by Lydia 2020/04/10
      End If
      If bAll = False Then
         If IsNull(rsTmp.Fields("ST04")) = False Then
            If rsTmp.Fields("ST04") = "2" Then
               GetStaffName = Empty
               strDeptName = Empty 'Added by Lydia 2016/08/17
               strST03 = Empty 'Added by Lydia 2016/10/26
            End If
         End If
      End If
   End If
   rsTmp.Close
   Set rsTmp = Nothing
End Function
'Add By Cheng 2003/09/01
'判斷下一程序是否有年費(605)期限
Public Function PUB_ChkNP605(strCaseNo As String) As Boolean
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset

PUB_ChkNP605 = False
StrSQLa = "Select * From NextProgress Where " & ChgNextProgress(strCaseNo) & " And NP06 Is Null And NP07='605' "
rsA.CursorLocation = adUseClient
rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
If rsA.RecordCount > 0 Then
    PUB_ChkNP605 = True
End If
If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing

End Function

'Add By Cheng 2003/09/10
'新增定稿整批列印清單資料
'Modify by Morgan 2009/8/19 +strSign:特殊標示
'Modify by Morgan 2014/5/29 +strCtMan:管制人,strReceiver收件人
Public Sub PUB_AddNewLetterList(strLetterName As String, strCondition As String, strPA01 As String, strPA02 As String, strPA03 As String, strPA04 As String, Optional strSign As String, Optional strCtMan As String, Optional strReceiver As String)
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset
Dim strFagentNo As String

strFagentNo = ""
StrSQLa = "Select Nvl(PA75, PA26) From Patent Where " & ChgPatent(strPA01 & strPA02 & strPA03 & strPA04)
rsA.CursorLocation = adUseClient
rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
If rsA.RecordCount > 0 Then
    strFagentNo = "" & rsA.Fields(0).Value
End If
If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing

'strSQLA = "Insert Into LetterList Values ('" & strUserNum & "','" & strLetterName & "','" & strCondition & "','" & strPA01 & "-" & strPA02 & "-" & strPA03 & "-" & strPA04 & "','" & strFagentNo & "') "
'EDIT BY NICK 2004/08/06 加入指定欄位
'strSQLA = "Insert Into LetterList Values ('" & strUserNum & "','" & strLetterName & "','" & strCondition & "','" & strPA01 & "','" & strPA02 & "','" & strPA03 & "','" & strPA04 & "','" & strFagentNo & "') "
'Modified by Lydia 2019/04/02 PK: 使用者帳號@電腦名稱(pub_HostName)
'StrSQLa = "Insert Into LetterList (LL01,LL02,LL03,LL04,LL05,LL06,LL07,LL08,LL09,LL10,LL11) Values ('" & strUserNum & "','" & strLetterName & "','" & strCondition & "','" & strPA01 & "','" & strPA02 & "','" & strPA03 & "','" & strPA04 & "','" & strFagentNo & "','" & strSign & "','" & strCtMan & "','" & strReceiver & "') "
StrSQLa = "Insert Into LetterList (LL01,LL02,LL03,LL04,LL05,LL06,LL07,LL08,LL09,LL10,LL11) Values ('" & strUserNum & "@" & pub_HostName & "','" & strLetterName & "','" & strCondition & "','" & strPA01 & "','" & strPA02 & "','" & strPA03 & "','" & strPA04 & "','" & strFagentNo & "','" & strSign & "','" & strCtMan & "','" & strReceiver & "') "
cnnConnection.Execute StrSQLa

End Sub

'Add By Cheng 2003/09/10
'刪除定稿整批列印清單資料
'Modified by Lydia 2020/09/24 +傳入刪除條件
Public Sub PUB_DeleteLetterList(strUserNumber As String, Optional ByVal strConSql As String = "")
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset

'Modified by Lydia 2019/04/02 PK: 使用者帳號@電腦名稱(pub_HostName)
'StrSQLa = "Delete From LetterList Where LL01='" & strUserNumber & "' "
'Modified by Lydia 2020/09/24 +傳入刪除條件 strConSql
StrSQLa = "Delete From LetterList Where LL01='" & strUserNumber & "@" & pub_HostName & "' " & strConSql
cnnConnection.Execute StrSQLa
End Sub

'Add by Morgan 2004/12/2 抽自 PUB_PrintLetterList
Private Sub PrintLetterListHead(ByVal strLetterName As String, ByVal strCondition As String, ByRef iPrint As Long, ByRef intPage As Integer, Optional strRptNo As String)
   Dim lngX As Long
   
   iPrint = 500
   Printer.Font.Size = 22
   Printer.Font.Bold = True
   Printer.Font.Underline = True
   Printer.CurrentX = 4200
   Printer.CurrentY = iPrint
   Printer.Print "整批定稿列印清單"
   
   iPrint = iPrint + 500
   Printer.Font.Size = 12
   Printer.Font.Bold = False
   Printer.Font.Underline = False
   Printer.CurrentX = 500
   Printer.CurrentY = iPrint
   Printer.Print "列印人：" & strUserName
   Printer.CurrentX = 8500
   Printer.CurrentY = iPrint
   Printer.Print "列印日期：" & Format(strSrvDate(2), "###/##/##")
   
   iPrint = iPrint + 300
   Printer.CurrentX = 500
   Printer.CurrentY = iPrint
   'Modify by Morgan 2007/4/3
   strExc(1) = "定稿名稱：" & strLetterName & "　　條件：" & strCondition
   '公告通知函△附寄件清單
   'Remove by Morgan 2010/5/3 併入下面程式
   'If strRptNo = "4" Then
   '   strExc(1) = strExc(1) & "　　◎不調卷"
   'End If
   Printer.Print strExc(1)
   'end 2007/4/3
   
   If strRptNo = "4-1" Then Exit Sub 'Added by Morgan 2016/3/22

   Printer.CurrentX = 8500
   Printer.CurrentY = iPrint
   Printer.Print "頁　　次：" & str(intPage)
   
   '2008/11/10 ADD BY SONIA
   iPrint = iPrint + 300
   Printer.CurrentX = 500
   Printer.CurrentY = iPrint
   'Modify by Morgan 2009/8/19
   'Printer.Print "△附寄件清單"
   'Modify by Morgan 2010/5/3
   'Printer.Print "△附寄件清單  ○有附檢索字樣"
   strExc(1) = "△附寄件清單  ＊交由承辦傳送"
   If strRptNo = "2" Then
      'Modify By Sindy 2015/7/14 +  ■優先請款"
      strExc(1) = strExc(1) & "  ○有附檢索字樣  ★有分割建議  ■優先請款"
      Printer.Print strExc(1)
      strExc(1) = ""
      iPrint = iPrint + 300
      Printer.CurrentX = 500
      Printer.CurrentY = iPrint
      '2015/7/14 END
   ElseIf strRptNo = "4" Then
      strExc(1) = strExc(1) & "  ◎不調卷"
      
   'End If 'Removed by Morgan 2020/5/7
   
      'Modified by Morgan 2015/4/14
      'strExc(1) = strExc(1) & "  ＃直接上傳客戶EPMS之電腦系統"
      'Modify By Sindy 2018/3/2
      'strExc(1) = strExc(1) & "  ＃先FAX證書影本後10天內寄發二次核對報告+證書+公報+帳單"
      strExc(1) = strExc(1) & "  ＃證書優先發文／優先分案二次核對"
      '2018/3/2 END
      'end 2015/4/14
   
   End If 'Added by Morgan 2020/5/6 "＃"號只在公告清單有意義--Sharon
   
   'Added by Morgan 2017/3/13 公開與核准通知加 □請在14天內完成通知(公開在自己的Form內)
   If strRptNo = "2" Then
      strExc(1) = strExc(1) & "  □請在14天內完成通知"
   'Added by Morgan 2019/1/17
   ElseIf strRptNo = "8" Then  '年費逾期補繳通知函
      'Modified by Lydia 2022/12/01  + ◎請在三天內完成
      strExc(1) = strExc(1) & "  Ｘ期滿不通知  ◎請在三天內完成"
   'end 2019/1/17
   End If
   'end 2017/3/13
   
   Printer.Print IIf(strRptNo = "2", Trim(strExc(1)), strExc(1))
   
   'Added by Morgan 2014/9/9
   iPrint = iPrint + 300
   Printer.CurrentX = 500
   Printer.CurrentY = iPrint
   strExc(1) = "◇Email+傳真通知客戶Email內容 ◆Email後，須FAX報告信or寄件備份通知日代"
   
   'Added by Morgan 2014/5/29
   'Modified by Morgan 2014/9/22 +公告通知函(4)
   'Modified by Morgan 2014/9/26 +核准函(2)
   'Modified by Sindy 2015/7/6 +繳年費通知函(5)
   'Modified by Sindy 2015/9/25 +專利權消滅函(3)
   'Modified by Sindy 2015/10/6 +年費逾期補繳通知函(8)
   'Mofified by Morgan 2015/10/20 +寰華繳年費通知函(9)
   'Mofified by Sindy 2015/11/2 +催實審通知函(6)
   If strRptNo = "7" Or strRptNo = "4" Or strRptNo = "2" Or strRptNo = "5" Or strRptNo = "3" Or _
      strRptNo = "8" Or strRptNo = "9" Or strRptNo = "6" Then
      strExc(1) = strExc(1) & " ｅE化案件  ＥE化加紙本"
   End If
   'Add By Sindy 2015/10/6
   If strRptNo = "8" Then
      strExc(1) = strExc(1) & "  Ν不寄逾繳函"
   'Added by Morgan 2018/12/19
   ElseIf strRptNo = "5" Or strRptNo = "9" Then
      'Modified by Lydia 2025/03/13　增加PA156=Y的設定
      strExc(1) = strExc(1) & "  Ν寄證書後年費不續辦  Ｙ年費續辦"
   'end 2018/12/19
   End If
   '2015/10/6 END
     
   Printer.Print strExc(1)
   'end 2014/9/9
   
   iPrint = iPrint + 300
   Printer.CurrentX = 500
   Printer.CurrentY = iPrint
   Printer.Print String(200, "-")
   iPrint = iPrint + 300
   
   lngX = 500
   Printer.CurrentX = lngX
   Printer.CurrentY = iPrint
   Printer.Print "　　　　本所案號"
   
   'Modify by Morgan 2009/8/19 本所案號前加一個符號所有欄位後移100
   'Modify by Morgan 2011/5/27 本所案號前再加一個符號所有欄位再後移100
   'Modify by Morgan 2012/12/12 本所案號前再加2個符號所有欄位再後移200
   'Modify By Sindy 2015/9/24 年證費請款函不印准駁日和證書號
   'Modified by Morgan 2015/10/20 +<>10
   'Modified by Lydia 2019/11/26 排除催實審通知函strRptNo=6
   If strRptNo <> "7" And strRptNo <> "8" And strRptNo <> "6" Then
      'Modify by Morgan 2006/9/29
      'Printer.Print "准駁日"
      'Modify By Sindy 2017/1/12
      If strRptNo = "2" Then '核准函
         lngX = lngX + 2500
         Printer.CurrentX = lngX
         Printer.CurrentY = iPrint
         Printer.Print "核准函發文日"
         lngX = lngX + 200
      '2017/1/12 END
      ElseIf strRptNo = "3" Then
         lngX = lngX + 2700
         Printer.CurrentX = lngX
         Printer.CurrentY = iPrint
         Printer.Print "消滅日"
      Else
         lngX = lngX + 2700
         Printer.CurrentX = lngX
         Printer.CurrentY = iPrint
         Printer.Print "准駁日"
      End If
      
      'Modify By Sindy 2015/9/24 消滅函不印證書號
      'Modify By Sindy 2017/1/12
      If strRptNo = "2" Then '核准函
         lngX = lngX + 1300
         Printer.CurrentX = lngX
         Printer.CurrentY = iPrint
         Printer.Print "承辦期限"
      Else
      '2017/1/12 END
         If strRptNo <> "3" Then
            lngX = lngX + 1300
            Printer.CurrentX = lngX
            Printer.CurrentY = iPrint
            Printer.Print "證書號"
         End If
      End If
      '2015/9/24 END
   End If
   
   'Modify By Sindy 2015/9/24
   'Modified by Morgan 2015/10/20 +10
   If strRptNo = "7" Or strRptNo = "8" Or strRptNo = "10" Then
      lngX = lngX + 2700
      
   'Added by Morgan 2015/10/20
   'Modified by Lydia 2019/11/26 +催實審通知函strRptNo=6
   ElseIf strRptNo = "9" Or strRptNo = "6" Then
      lngX = lngX + 2300
   Else
   '2015/9/24 END
      lngX = lngX + 1300
   End If
   Printer.CurrentX = lngX
   Printer.CurrentY = iPrint
   Printer.Print "代理人"
   
   'Modified by Lydia 2019/11/26 催實審通知函改列印欄位：本所案號、代理人、實審自動代繳、下一程序備註
   If strRptNo = "6" Then
         lngX = lngX + 3000
         Printer.CurrentX = lngX
         Printer.CurrentY = iPrint
         Printer.Print "實審自動代繳"
         lngX = lngX + 1600
         Printer.CurrentX = lngX
         Printer.CurrentY = iPrint
         Printer.Print "下一程序備註"
   End If
   'end 2019/11/26
   
   '2008/10/13 ADD BY SONIA
   'Modified by Morgan 2015/10/20 +9,10
   'If strLetterName = "繳年費通知函" Or strLetterName = "催實審通知函" Then
   'Modified by Lydia 2019/11/26 排除催實審通知函strRptNo=6,10
   'If strRptNo = "5" Or strRptNo = "6" Or strRptNo = "9" Or strRptNo = "10" Then
   'end 2015/10/20
   If strRptNo = "5" Or strRptNo = "9" Or strRptNo = "10" Then
      lngX = lngX + 3000
      Printer.CurrentX = lngX
      Printer.CurrentY = iPrint
      Printer.Print "下一程序備註"
   'Add By Sindy 2015/10/1 消滅函增加顯示案件備註
   ElseIf strRptNo = "3" Or strRptNo = "8" Then
      lngX = lngX + 6000
      Printer.CurrentX = lngX
      Printer.CurrentY = iPrint
      Printer.Print "案件備註"
   '2015/10/1 END
   End If
   '2008/10/13 END
   
   iPrint = iPrint + 300
   Printer.CurrentX = 500
   Printer.CurrentY = iPrint
   Printer.Print String(200, "-")
End Sub

'列印定稿清單
'strSortColumn:排序欄位
'Modify by Morgan 2004/12/2 程式重整，部分註解刪除
'Modify By Sindy 2015/6/26 +Optional ByVal strNewPrinter As String = "", Optional ByVal strOldPrinter As String = ""
'Modify By Sindy 2015/7/6 +Optional ByVal strConSql As String = ""
'Modify By Sindy 2015/10/30 + Optional ByVal bolShowMsg As Boolean = True
'Modified by Lydia 2019/03/05 +列印份數(pCopys)
'Modified by Lydia 2019/04/02 strUserNumber=> strLL01
Public Sub PUB_PrintLetterList(strLL01 As String, Optional ByVal stSortMode As String = "1", _
                               Optional ByVal strNewPrinter As String = "", Optional ByVal strOldPrinter As String = "", _
                               Optional ByVal strConSql As String = "", Optional ByVal bolShowMsg As Boolean = True, _
                               Optional ByVal pCopys As Integer = 1)
                               
   Dim StrSQLa As String
   Dim rsA As New ADODB.Recordset
   Dim iPrint As Long '行數
   Dim intPage As Integer '頁數
   Dim intCnt As Integer '筆數
   Dim strLetterName As String '定稿名稱
   Dim strCondition As String '條件
   Dim arrList() As String '調卷清單
   Dim arrCnt As Integer '調卷筆數
   Dim ii As Integer, jj As Integer
   Dim lngX As Long
   Dim stLL10 As String, bolCtLine As Boolean, iSubCnt As Integer
   Dim strTemp As String, strPrint As String
   Dim intStar As Integer, intEnd As Integer
   Dim iCopys As Integer 'Added by Lydia 2019/03/05
   Dim bolE926 As Boolean 'Add by Lydia 2019/03/05
   Dim strDate926 As String 'Added by Lydia 2019/04/02 記錄公告期別
   
On Error GoTo ErrHnd:

   'Modify by Morgan 2004/12/2 加核准日
   'Modify by Morgan 2004/12/24 FCP 核准函的清單要用收文日排序
   'MODIFY BY SONIA  2008/11/10 加FC代理人
   'Modify by Morgan 2011/5/27 +pa26,pa27,pa28,pa29,pa30 判斷特定申請人要加註記
   'Modified by Morgan 2014/5/529 +LL10,LL11
   Select Case stSortMode
      '預設
      Case "1"
         'Modified by Lydia 2019/04/02 PK: 使用者帳號@電腦名稱(pub_HostName)
         'StrSQLa = "Select LL02, LL03, LL04, LL05, LL06, LL07, PA22, Decode(FA05, Null, Nvl(FA04, FA06), FA05||' '||FA63||' '||FA64||' '||FA65), PA20, PA75, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11 From LetterList, Fagent, Patent Where substr(LL08,1,8)=FA01 And substr(LL08,9,1)=FA02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strUserNum & "' "
         'StrSQLa = StrSQLa & " Union Select LL02, LL03, LL04, LL05, LL06, LL07, PA22, Decode(CU05, Null, Nvl(CU04, CU06), CU05||' '||CU88||' '||CU89||' '||CU90), PA20, PA75, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11 From LetterList, Customer, Patent Where substr(LL08,1,8)=CU01 And substr(LL08,9,1)=CU02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strUserNum & "' "
         'Modified by Lydia 2020/09/24 +strConSql
         StrSQLa = "Select LL02, LL03, LL04, LL05, LL06, LL07, PA22, Decode(FA05, Null, Nvl(FA04, FA06), FA05||' '||FA63||' '||FA64||' '||FA65), PA20, PA75, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11 From LetterList, Fagent, Patent Where substr(LL08,1,8)=FA01 And substr(LL08,9,1)=FA02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strLL01 & "@" & pub_HostName & "' " & strConSql
         StrSQLa = StrSQLa & " Union Select LL02, LL03, LL04, LL05, LL06, LL07, PA22, Decode(CU05, Null, Nvl(CU04, CU06), CU05||' '||CU88||' '||CU89||' '||CU90), PA20, PA75, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11 From LetterList, Customer, Patent Where substr(LL08,1,8)=CU01 And substr(LL08,9,1)=CU02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strLL01 & "@" & pub_HostName & "' " & strConSql
         StrSQLa = StrSQLa & " Order By 1, 2, 3, 4"
         
      '核准函
      Case "2"
         'Add By Sindy 2017/1/12 准駁日欄改核准函發文日，證書號欄改承辦期限
'         StrSQLa = "Select LL02, SUBSTR(LL03,9) LL03, LL04, LL05, LL06, LL07, PA22, Decode(FA05, Null, Nvl(FA04, FA06), FA05||' '||FA63||' '||FA64||' '||FA65), PA20, PA75, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11 From LetterList, Fagent, Patent Where substr(LL08,1,8)=FA01 And substr(LL08,9,1)=FA02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strUserNum &   "'"
'         StrSQLa = StrSQLa & " Union Select LL02, SUBSTR(LL03,9) LL03, LL04, LL05, LL06, LL07, PA22, Decode(CU05, Null, Nvl(CU04, CU06), CU05||' '||CU88||' '||CU89||' '||CU90), PA20, PA75, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11 From LetterList, Customer, Patent Where substr(LL08,1,8)=CU01 And substr(LL08,9,1)=CU02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strUserNum &   "' "
         'Modified by Lydia 2019/04/02 PK: 使用者帳號@電腦名稱(pub_HostName)
         'StrSQLa = "Select LL02, SUBSTR(LL03,20) LL03, LL04, LL05, LL06, LL07, decode(SUBSTR(LL03,11,8),'00000000','',sqldatet(SUBSTR(LL03,11,8))), Decode(FA05, Null, Nvl(FA04, FA06), FA05||' '||FA63||' '||FA64||' '||FA65), cp27, PA75, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11 From LetterList,Fagent,Patent,CASEPROGRESS Where substr(LL08,1,8)=FA01 And substr(LL08,9,1)=FA02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strUserNum & "' and SUBSTR(LL03,1,9)=cp09(+)"
         'StrSQLa = StrSQLa & " Union Select LL02, SUBSTR(LL03,20) LL03, LL04, LL05, LL06, LL07, decode(SUBSTR(LL03,11,8),'00000000','',sqldatet(SUBSTR(LL03,11,8))), Decode(CU05, Null, Nvl(CU04, CU06), CU05||' '||CU88||' '||CU89||' '||CU90), cp27, PA75, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11 From LetterList,Customer,Patent,CASEPROGRESS Where substr(LL08,1,8)=CU01 And substr(LL08,9,1)=CU02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strUserNum & "' and SUBSTR(LL03,1,9)=cp09(+)"
          'Modified by Lydia 2020/09/24 +程式名稱 and LL02='核准函'
         StrSQLa = "Select LL02, SUBSTR(LL03,20) LL03, LL04, LL05, LL06, LL07, decode(SUBSTR(LL03,11,8),'00000000','',sqldatet(SUBSTR(LL03,11,8))), Decode(FA05, Null, Nvl(FA04, FA06), FA05||' '||FA63||' '||FA64||' '||FA65), cp27, PA75, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11 From LetterList,Fagent,Patent,CASEPROGRESS Where substr(LL08,1,8)=FA01 And substr(LL08,9,1)=FA02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strLL01 & "@" & pub_HostName & "' and LL02='核准函' and SUBSTR(LL03,1,9)=cp09(+)"
         StrSQLa = StrSQLa & " Union Select LL02, SUBSTR(LL03,20) LL03, LL04, LL05, LL06, LL07, decode(SUBSTR(LL03,11,8),'00000000','',sqldatet(SUBSTR(LL03,11,8))), Decode(CU05, Null, Nvl(CU04, CU06), CU05||' '||CU88||' '||CU89||' '||CU90), cp27, PA75, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11 From LetterList,Customer,Patent,CASEPROGRESS Where substr(LL08,1,8)=CU01 And substr(LL08,9,1)=CU02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strLL01 & "@" & pub_HostName & "' and LL02='核准函' and SUBSTR(LL03,1,9)=cp09(+)"
         StrSQLa = StrSQLa & " Order By 1, 2, 3, LL03, 4"
         
      '專利權消滅函
      Case "3"
         'Modify By Sindy 2015/10/1 +PA91.案件備註
         'Modify By Sindy 2015/10/30 +eMail
         'Modified by Lydia 2019/04/02 PK: 使用者帳號@電腦名稱(pub_HostName)
         'StrSQLa = "Select LL02, LL03, LL04, LL05, LL06,LL07||DECODE(PA59,'89',NULL,'*') LL07, PA22, Decode(FA05, Null, Nvl(FA04, FA06), FA05||' '||FA63||' '||FA64||' '||FA65), CP25, PA75, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11,PA91,FA29,GetEmailFlag(CP09) eMail From LetterList, Fagent, Patent,CASEPROGRESS Where substr(LL08,1,8)=FA01 And substr(LL08,9,1)=FA02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strUserNum & "' AND CP01(+)=PA01 AND CP02(+)=PA02 AND CP03(+)=PA03 AND CP04(+)=PA04 AND CP10(+)='1604' AND CP57 IS NULL"
         'StrSQLa = StrSQLa & " Union Select LL02, LL03, LL04, LL05, LL06,LL07||DECODE(PA59,'89',NULL,'*') LL07, PA22, Decode(CU05, Null, Nvl(CU04, CU06), CU05||' '||CU88||' '||CU89||' '||CU90), CP25, PA75, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11,PA91,CU79 FA29,GetEmailFlag(CP09) eMail From LetterList, Customer, Patent,CASEPROGRESS Where substr(LL08,1,8)=CU01 And substr(LL08,9,1)=CU02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strUserNum & "' AND CP01(+)=PA01 AND CP02(+)=PA02 AND CP03(+)=PA03 AND CP04(+)=PA04 AND CP10(+)='1604' AND CP57 IS NULL "
         'Modified by Lydia 2020/09/24 +程式名稱 and LL02='專利權消滅函'
         StrSQLa = "Select LL02, LL03, LL04, LL05, LL06,LL07||DECODE(PA59,'89',NULL,'*') LL07, PA22, Decode(FA05, Null, Nvl(FA04, FA06), FA05||' '||FA63||' '||FA64||' '||FA65), CP25, PA75, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11,PA91,FA29,GetEmailFlag(CP09) eMail From LetterList, Fagent, Patent,CASEPROGRESS Where substr(LL08,1,8)=FA01 And substr(LL08,9,1)=FA02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strLL01 & "@" & pub_HostName & "' and LL02='專利權消滅函' AND CP01(+)=PA01 AND CP02(+)=PA02 AND CP03(+)=PA03 AND CP04(+)=PA04 AND CP10(+)='1604' AND CP57 IS NULL"
         StrSQLa = StrSQLa & " Union Select LL02, LL03, LL04, LL05, LL06,LL07||DECODE(PA59,'89',NULL,'*') LL07, PA22, Decode(CU05, Null, Nvl(CU04, CU06), CU05||' '||CU88||' '||CU89||' '||CU90), CP25, PA75, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11,PA91,CU79 FA29,GetEmailFlag(CP09) eMail From LetterList, Customer, Patent,CASEPROGRESS Where substr(LL08,1,8)=CU01 And substr(LL08,9,1)=CU02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strLL01 & "@" & pub_HostName & "' and LL02='專利權消滅函' AND CP01(+)=PA01 AND CP02(+)=PA02 AND CP03(+)=PA03 AND CP04(+)=PA04 AND CP10(+)='1604' AND CP57 IS NULL "
         StrSQLa = StrSQLa & " Order By eMail, 1, 2, 3, 4"
      
      '公告通知函
      Case "4"
         'Modified by Lydia 2019/04/02 PK: 使用者帳號@電腦名稱(pub_HostName)
         'StrSQLa = "Select LL02, LL03, LL04, LL05, LL06, LL07, PA22, Decode(FA05, Null, Nvl(FA04, FA06), FA05||' '||FA63||' '||FA64||' '||FA65), PA20, PA75, PA11, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11 From LetterList, Fagent, Patent Where substr(LL08,1,8)=FA01 And substr(LL08,9,1)=FA02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strUserNum & "' "
         'StrSQLa = StrSQLa & " Union Select LL02, LL03, LL04, LL05, LL06, LL07, PA22, Decode(CU05, Null, Nvl(CU04, CU06), CU05||' '||CU88||' '||CU89||' '||CU90), PA20, PA75, PA11, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11 From LetterList, Customer, Patent Where substr(LL08,1,8)=CU01 And substr(LL08,9,1)=CU02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strUserNum & "' "
         'Modified by Lydia 2020/09/24 +程式名稱 and LL02='公告通知函' ; 因為最近發生"7-年證費請款函"的清單未刪，後面輸入證書號執行公告通知函列印，觸發清單列印
         StrSQLa = "Select LL02, LL03, LL04, LL05, LL06, LL07, PA22, Decode(FA05, Null, Nvl(FA04, FA06), FA05||' '||FA63||' '||FA64||' '||FA65), PA20, PA75, PA11, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11 From LetterList, Fagent, Patent Where substr(LL08,1,8)=FA01 And substr(LL08,9,1)=FA02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strLL01 & "@" & pub_HostName & "' and LL02='公告通知函' "
         StrSQLa = StrSQLa & " Union Select LL02, LL03, LL04, LL05, LL06, LL07, PA22, Decode(CU05, Null, Nvl(CU04, CU06), CU05||' '||CU88||' '||CU89||' '||CU90), PA20, PA75, PA11, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11 From LetterList, Customer, Patent Where substr(LL08,1,8)=CU01 And substr(LL08,9,1)=CU02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strLL01 & "@" & pub_HostName & "' and LL02='公告通知函' "
         StrSQLa = StrSQLa & " Order By 1, 2, 3, 4"
         
      '2008/10/13 ADD BY SONIA 繳年費通知函,催實審通知函加印下一程序年費期限備註
      '繳年費通知函
      Case "5"
         'Modify By Sindy 2015/7/6 +strConSql E化與非E化清單分開列印
         'Modified by Morgan 2015/10/20 +FCP系統別條件以排除寰華案
         'Modify By Sindy 2015/10/30 +eMail
         'Modified by Morgan 2018/12/19 +decode(instr(pa70||fa41||cu74||' ','N'),0,'','N') flgN => N=寄證書後年費不續辦
         'Modified by Lydia 2019/04/02 PK: 使用者帳號@電腦名稱(pub_HostName)
         'StrSQLa = "Select LL02, LL03, LL04, LL05, LL06, LL07, PA22, SUBSTR(Decode(FA05, Null, Nvl(FA04, FA06), FA05||' '||FA63||' '||FA64||' '||FA65),1,24), PA20, PA75, NP15,NVL(PA76,LL08) PA76, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11,GetEmailFlag(pa01||pa02||pa03||pa04) eMail,decode(instr(pa70||fa41||cu74||' ','N'),0,'','N') flgN From LetterList, Fagent, Patent, NEXTPROGRESS, Customer Where substr(LL08,1,8)=FA01 And substr(LL08,9,1)=FA02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04  And LL01='" & strUserNum & "' AND LL04='FCP' AND PA01=NP02 AND PA02=NP03 AND PA03=NP04 AND PA04=NP05 AND NP07='605' AND NP06 IS NULL and cu01(+)=substr(pa26,1,8) and cu02(+)=substr(pa26,9) " & strConSql
         'StrSQLa = StrSQLa & " Union Select LL02, LL03, LL04, LL05, LL06, LL07, PA22, SUBSTR(Decode(CU05, Null, Nvl(CU04, CU06), CU05||' '||CU88||' '||CU89||' '||CU90),1,24), PA20, PA75, NP15,NVL(PA76,LL08) PA76, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11,GetEmailFlag(pa01||pa02||pa03||pa04) eMail,decode(instr(pa70||cu74||' ','N'),0,'','N') flgN From LetterList, Customer, Patent, NEXTPROGRESS Where substr(LL08,1,8)=CU01 And substr(LL08,9,1)=CU02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strUserNum & "' AND LL04='FCP' AND PA01=NP02 AND PA02=NP03 AND PA03=NP04 AND PA04=NP05 AND NP07='605' AND NP06 IS NULL " & strConSql
         'Modified by Lydia 2019/11/26 個案PA70=N寄證書後年費不續辦，改為PA156(FCP年費特殊管制)
         'StrSQLa = "Select LL02, LL03, LL04, LL05, LL06, LL07, PA22, SUBSTR(Decode(FA05, Null, Nvl(FA04, FA06), FA05||' '||FA63||' '||FA64||' '||FA65),1,24), PA20, PA75, NP15,NVL(PA76,LL08) PA76, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11,GetEmailFlag(pa01||pa02||pa03||pa04) eMail,decode(instr(pa70||fa41||cu74||' ','N'),0,'','N') flgN From LetterList, Fagent, Patent, NEXTPROGRESS, Customer Where substr(LL08,1,8)=FA01 And substr(LL08,9,1)=FA02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04  And LL01='" & strLL01 & "@" & pub_HostName & "' AND LL04='FCP' AND PA01=NP02 AND PA02=NP03 AND PA03=NP04 AND PA04=NP05 AND NP07='605' AND NP06 IS NULL and cu01(+)=substr(pa26,1,8) and cu02(+)=substr(pa26,9) " & strConSql
         'StrSQLa = StrSQLa & " Union Select LL02, LL03, LL04, LL05, LL06, LL07, PA22, SUBSTR(Decode(CU05, Null, Nvl(CU04, CU06), CU05||' '||CU88||' '||CU89||' '||CU90),1,24), PA20, PA75, NP15,NVL(PA76,LL08) PA76, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11,GetEmailFlag(pa01||pa02||pa03||pa04) eMail,decode(instr(pa70||cu74||' ','N'),0,'','N') flgN From LetterList, Customer, Patent, NEXTPROGRESS Where substr(LL08,1,8)=CU01 And substr(LL08,9,1)=CU02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strLL01 & "@" & pub_HostName & "' AND LL04='FCP' AND PA01=NP02 AND PA02=NP03 AND PA03=NP04 AND PA04=NP05 AND NP07='605' AND NP06 IS NULL " & strConSql
         'Modified by Lydia 2020/09/24 +程式名稱and LL02='繳年費通知函' ;
         'Modified by Lydia 2025/03/13 判斷PA156='Y' ; Ex:FCP-55422
         'StrSQLa = "Select LL02, LL03, LL04, LL05, LL06, LL07, PA22, SUBSTR(Decode(FA05, Null, Nvl(FA04, FA06), FA05||' '||FA63||' '||FA64||' '||FA65),1,24), PA20, PA75, NP15,NVL(PA76,LL08) PA76, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11,GetEmailFlag(pa01||pa02||pa03||pa04) eMail,decode(instr(pa156||fa41||cu74||' ','N'),0,'','N') flgN From LetterList, Fagent, Patent, NEXTPROGRESS, Customer Where substr(LL08,1,8)=FA01 And substr(LL08,9,1)=FA02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04  And LL01='" & strLL01 & "@" & pub_HostName & "' AND LL04='FCP' AND PA01=NP02 AND PA02=NP03 AND PA03=NP04 AND PA04=NP05 AND NP07='605' AND NP06 IS NULL and cu01(+)=substr(pa26,1,8) and cu02(+)=substr(pa26,9) and LL02='繳年費通知函' " & strConSql
         'StrSQLa = StrSQLa & " Union Select LL02, LL03, LL04, LL05, LL06, LL07, PA22, SUBSTR(Decode(CU05, Null, Nvl(CU04, CU06), CU05||' '||CU88||' '||CU89||' '||CU90),1,24), PA20, PA75, NP15,NVL(PA76,LL08) PA76, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11,GetEmailFlag(pa01||pa02||pa03||pa04) eMail,decode(instr(pa156||cu74||' ','N'),0,'','N') flgN From LetterList, Customer, Patent, NEXTPROGRESS Where substr(LL08,1,8)=CU01 And substr(LL08,9,1)=CU02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strLL01 & "@" & pub_HostName & "' AND LL04='FCP' AND PA01=NP02 AND PA02=NP03 AND PA03=NP04 AND PA04=NP05 AND NP07='605' AND NP06 IS NULL and LL02='繳年費通知函' " & strConSql
         StrSQLa = "Select LL02, LL03, LL04, LL05, LL06, LL07, PA22, SUBSTR(Decode(FA05, Null, Nvl(FA04, FA06), FA05||' '||FA63||' '||FA64||' '||FA65),1,24), PA20, PA75, NP15,NVL(PA76,LL08) PA76, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11,GetEmailFlag(pa01||pa02||pa03||pa04) eMail,rtrim(substr(pa156||fa41||cu74,1,1)) as flgn From LetterList, Fagent, Patent, NEXTPROGRESS, Customer Where substr(LL08,1,8)=FA01 And substr(LL08,9,1)=FA02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04  And LL01='" & strLL01 & "@" & pub_HostName & "' AND LL04='FCP' AND PA01=NP02 AND PA02=NP03 AND PA03=NP04 AND PA04=NP05 AND NP07='605' AND NP06 IS NULL and cu01(+)=substr(pa26,1,8) and cu02(+)=substr(pa26,9) and LL02='繳年費通知函' " & strConSql
         StrSQLa = StrSQLa & " Union Select LL02, LL03, LL04, LL05, LL06, LL07, PA22, SUBSTR(Decode(CU05, Null, Nvl(CU04, CU06), CU05||' '||CU88||' '||CU89||' '||CU90),1,24), PA20, PA75, NP15,NVL(PA76,LL08) PA76, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11,GetEmailFlag(pa01||pa02||pa03||pa04) eMail,rtrim(substr(pa156||cu74,1,1)) flgN From LetterList, Customer, Patent, NEXTPROGRESS Where substr(LL08,1,8)=CU01 And substr(LL08,9,1)=CU02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strLL01 & "@" & pub_HostName & "' AND LL04='FCP' AND PA01=NP02 AND PA02=NP03 AND PA03=NP04 AND PA04=NP05 AND NP07='605' AND NP06 IS NULL and LL02='繳年費通知函' " & strConSql
         StrSQLa = StrSQLa & " Order By eMail, 1, 2, 3, 4"
      
      '催實審通知函
      Case "6"
         'Modified by Morgan 2015/10/20 +FCP系統別條件以排除寰華案
         'Modify By Sindy 2015/10/30 +eMail
         'Modified by Lydia 2019/04/02 PK: 使用者帳號@電腦名稱(pub_HostName)
         'StrSQLa = "Select LL02, LL03, LL04, LL05, LL06, LL07, PA22, SUBSTR(Decode(FA05, Null, Nvl(FA04, FA06), FA05||' '||FA63||' '||FA64||' '||FA65),1,24), PA20, PA75, NP15, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11,GetEmailFlag(pa01||pa02||pa03||pa04) eMail From LetterList, Fagent, Patent, NEXTPROGRESS Where substr(LL08,1,8)=FA01 And substr(LL08,9,1)=FA02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strUserNum & "' AND LL04='FCP' AND PA01=NP02 AND PA02=NP03 AND PA03=NP04 AND PA04=NP05 AND NP07='416' AND NP06 IS NULL "
         'StrSQLa = StrSQLa & " Union Select LL02, LL03, LL04, LL05, LL06, LL07, PA22, SUBSTR(Decode(CU05, Null, Nvl(CU04, CU06), CU05||' '||CU88||' '||CU89||' '||CU90),1,24), PA20, PA75, NP15, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11,GetEmailFlag(pa01||pa02||pa03||pa04) eMail From LetterList, Customer, Patent, NEXTPROGRESS Where substr(LL08,1,8)=CU01 And substr(LL08,9,1)=CU02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strUserNum & "' AND LL04='FCP' AND PA01=NP02 AND PA02=NP03 AND PA03=NP04 AND PA04=NP05 AND NP07='416' AND NP06 IS NULL "
         'Modified by Lydia 2019/05/29 FCP案和寰華案的整批清單併在一起; 繳年費通知函因為分不同區負責人催,所以不併在一起
         'StrSQLa = "Select LL02, LL03, LL04, LL05, LL06, LL07, PA22, SUBSTR(Decode(FA05, Null, Nvl(FA04, FA06), FA05||' '||FA63||' '||FA64||' '||FA65),1,24), PA20, PA75, NP15, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11,GetEmailFlag(pa01||pa02||pa03||pa04) eMail From LetterList, Fagent, Patent, NEXTPROGRESS Where substr(LL08,1,8)=FA01 And substr(LL08,9,1)=FA02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strLL01 & "@" & pub_HostName & "' AND LL04='FCP' AND PA01=NP02 AND PA02=NP03 AND PA03=NP04 AND PA04=NP05 AND NP07='416' AND NP06 IS NULL "
         'StrSQLa = StrSQLa & " Union Select LL02, LL03, LL04, LL05, LL06, LL07, PA22, SUBSTR(Decode(CU05, Null, Nvl(CU04, CU06), CU05||' '||CU88||' '||CU89||' '||CU90),1,24), PA20, PA75, NP15, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11,GetEmailFlag(pa01||pa02||pa03||pa04) eMail From LetterList, Customer, Patent, NEXTPROGRESS Where substr(LL08,1,8)=CU01 And substr(LL08,9,1)=CU02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strLL01 & "@" & pub_HostName & "' AND LL04='FCP' AND PA01=NP02 AND PA02=NP03 AND PA03=NP04 AND PA04=NP05 AND NP07='416' AND NP06 IS NULL "
         'StrSQLa = StrSQLa & " Order By eMail, 1, 2, 3, 4"
         'Modified by Lydia 2019/11/26 +FCP實審自動代繳(PA69)
         'Modified by Lydia 2020/06/09 FCP實審自動代繳=> 先抓Y/X編號,
         'Modified by Lydia 2020/07/06 不用LetterList的代理人/客戶編號,直接用案號抓FCP實審自動代繳(個案 > Y > X)
         'StrSQLa = "Select LL02, LL03, LL04, LL05, LL06, LL07, PA22, SUBSTR(Decode(FA05, Null, Nvl(FA04, FA06), FA05||' '||FA63||' '||FA64||' '||FA65),1,24) XNAME, PA20, PA75, NP15,NVL(PA76,LL08) PA76, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11,GetEmailFlag(pa01||pa02||pa03||pa04) eMail,pa01||pa02||pa03||pa04 as CaseNo,NVL(FA124,PA69) PA69 From LetterList, Fagent, Patent, NEXTPROGRESS Where substr(LL08,1,8)=FA01 And substr(LL08,9,1)=FA02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strLL01 & "@" & pub_HostName & "' AND LL04='FCP' AND PA01=NP02 AND PA02=NP03 AND PA03=NP04 AND PA04=NP05 AND NP07='416' AND NP06 IS NULL "
         'StrSQLa = StrSQLa & " Union Select LL02, LL03, LL04, LL05, LL06, LL07, PA22, SUBSTR(Decode(CU05, Null, Nvl(CU04, CU06), CU05||' '||CU88||' '||CU89||' '||CU90),1,24) XNAME, PA20, PA75, NP15,NVL(PA76,LL08) PA76, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11,GetEmailFlag(pa01||pa02||pa03||pa04) eMail,pa01||pa02||pa03||pa04 as CaseNo,NVL(CU177,PA69) PA69 From LetterList, Customer, Patent, NEXTPROGRESS Where substr(LL08,1,8)=CU01 And substr(LL08,9,1)=CU02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strLL01 & "@" & pub_HostName & "' AND LL04='FCP' AND PA01=NP02 AND PA02=NP03 AND PA03=NP04 AND PA04=NP05 AND NP07='416' AND NP06 IS NULL "
         'StrSQLa = StrSQLa & " Union Select LL02, LL03, LL04, LL05, LL06, LL07, PA22, SUBSTR(Decode(FA05, Null, Nvl(FA04, FA06), FA05||' '||FA63||' '||FA64||' '||FA65),1,24) XNAME, PA20, PA75, NP15,NVL(PA76,LL08) PA76, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11,'' as eMail,pa01||pa02||pa03||pa04 as CaseNo,NVL(FA124,PA69) PA69 From LetterList, Fagent, Patent, NEXTPROGRESS Where substr(LL08,1,8)=FA01 And substr(LL08,9,1)=FA02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strLL01 & "@" & pub_HostName & "' AND LL04='P' AND PA01=NP02 AND PA02=NP03 AND PA03=NP04 AND PA04=NP05 AND NP07='416' AND NP06 IS NULL "
         'StrSQLa = StrSQLa & " Union Select LL02, LL03, LL04, LL05, LL06, LL07, PA22, SUBSTR(Decode(CU05, Null, Nvl(CU04, CU06), CU05||' '||CU88||' '||CU89||' '||CU90),1,24) XNAME, PA20, PA75, NP15,NVL(PA76,LL08) PA76, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11,'' as eMail,pa01||pa02||pa03||pa04 as CaseNo,NVL(CU177,PA69) PA69 From LetterList, Customer, Patent, NEXTPROGRESS Where substr(LL08,1,8)=CU01 And substr(LL08,9,1)=CU02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strLL01 & "@" & pub_HostName & "' AND LL04='P' AND PA01=NP02 AND PA02=NP03 AND PA03=NP04 AND PA04=NP05 AND NP07='416' AND NP06 IS NULL "
         'Modified by Lydia 2020/09/24 +程式名稱and LL02='催實審通知函'
         StrSQLa = "SELECT LL02, LL03, LL04, LL05, LL06, LL07, PA22,DECODE(PA75,NULL,SUBSTR(DECODE(CU05, NULL, NVL(CU04, CU06), CU05||' '||CU88||' '||CU89||' '||CU90),1,24) ,SUBSTR(DECODE(FA05, NULL, NVL(FA04, FA06), FA05||' '||FA63||' '||FA64||' '||FA65),1,24)) XNAME " & _
                          ",PA20, PA75, NP15,NVL(PA76,LL08) PA76, LL09,PA26,PA27,PA28,PA29,PA30,LL10,LL11,GETEMAILFLAG(PA01||PA02||PA03||PA04) EMAIL,PA01||PA02||PA03||PA04 AS CASENO,NVL(PA69,NVL(FA124,CU177)) PA69 " & _
                          "FROM LETTERLIST, FAGENT, PATENT, NEXTPROGRESS,CUSTOMER WHERE LL04=PA01 AND LL05=PA02 AND LL06=PA03 AND LL07=PA04 AND LL01='" & strLL01 & "@" & pub_HostName & "' and LL02='催實審通知函' AND LL04='FCP' AND PA01=NP02 AND PA02=NP03 AND PA03=NP04 AND PA04=NP05 AND NP07='416' AND NP06 IS NULL " & _
                           "AND SUBSTR(PA75,1,8)=FA01(+) AND SUBSTR(PA75,9,1)=FA02(+) AND SUBSTR(PA26,1,8)=CU01(+) AND SUBSTR(PA26,9,1)=CU02(+) "
         StrSQLa = StrSQLa & " Union SELECT LL02, LL03, LL04, LL05, LL06, LL07, PA22,DECODE(PA75,NULL,SUBSTR(DECODE(CU05, NULL, NVL(CU04, CU06), CU05||' '||CU88||' '||CU89||' '||CU90),1,24) ,SUBSTR(DECODE(FA05, NULL, NVL(FA04, FA06), FA05||' '||FA63||' '||FA64||' '||FA65),1,24)) XNAME " & _
                          ",PA20, PA75, NP15,NVL(PA76,LL08) PA76, LL09,PA26,PA27,PA28,PA29,PA30,LL10,LL11,GETEMAILFLAG(PA01||PA02||PA03||PA04) EMAIL,PA01||PA02||PA03||PA04 AS CASENO,NVL(PA69,NVL(FA124,CU177)) PA69 " & _
                          "FROM LETTERLIST, FAGENT, PATENT, NEXTPROGRESS,CUSTOMER WHERE LL04=PA01 AND LL05=PA02 AND LL06=PA03 AND LL07=PA04 AND LL01='" & strLL01 & "@" & pub_HostName & "' and LL02='催實審通知函' AND LL04='P' AND PA01=NP02 AND PA02=NP03 AND PA03=NP04 AND PA04=NP05 AND NP07='416' AND NP06 IS NULL " & _
                           "AND SUBSTR(PA75,1,8)=FA01(+) AND SUBSTR(PA75,9,1)=FA02(+) AND SUBSTR(PA26,1,8)=CU01(+) AND SUBSTR(PA26,9,1)=CU02(+) "
         
         StrSQLa = StrSQLa & " Order By eMail, CaseNo, 1, 2, 3, 4"
         'end 2019/05/29
      '2008/10/13 END
      
      'Added by Morgan 2014/5/29
      '年證費請款函
      Case "7"
         'Modify By Sindy 2017/2/13
'         StrSQLa = "Select LL02, LL03, LL04, LL05, LL06, LL07, PA22,DECODE(FA01,NULL,Decode(CU05, Null, Nvl(CU04, CU06), CU05||' '||CU88||' '||CU89||' '||CU90),Decode(FA05, Null, Nvl(FA04, FA06), FA05||' '||FA63||' '||FA64||' '||FA65)), PA20, PA75, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11 From LetterList, Patent, Fagent, Customer Where LL04=PA01(+) And LL05=PA02(+) And LL06=PA03(+) And LL07=PA04(+) AND substr(LL11,1,8)=FA01(+) And substr(LL11,9,1)=FA02(+) AND substr(LL11,1,8)=CU01(+) And substr(LL11,9,1)=CU02(+) And LL01='" & strUserNum &   "' "
'         StrSQLa = StrSQLa & " Order By LL10, LL11, 3, 4, 5 ,6"
         'Modify By Sindy 2017/2/13
         If strConSql <> "" Then '領證及繳年費清單 : 要依承辦組區別排序
            'Modified by Lydia 2019/04/02 PK: 使用者帳號@電腦名稱(pub_HostName)
            'StrSQLa = "Select LL02, LL03, LL04, LL05, LL06, LL07, PA22,Decode(CU05, Null, Nvl(CU04, CU06), CU05||' '||CU88||' '||CU89||' '||CU90), PA20, PA75, LL09,pa26,pa27,pa28,pa29,pa30,nvl(st01,LL10) LL10,LL11,CU10,NA51,NA01 From LetterList,Patent,Customer,Nation,staff Where LL04=PA01(+) And LL05=PA02(+) And LL06=PA03(+) And LL07=PA04(+) AND substr(LL11,1,8)=CU01 And substr(LL11,9,1)=CU02 And LL01='" & strUserNum & "' and CU10=na01(+) and na51=st01(+) "
            'StrSQLa = StrSQLa & " Union Select LL02, LL03, LL04, LL05, LL06, LL07, PA22,Decode(FA05, Null, Nvl(FA04, FA06), FA05||' '||FA63||' '||FA64||' '||FA65), PA20, PA75, LL09,pa26,pa27,pa28,pa29,pa30,nvl(st01,LL10) LL10,LL11,FA10,NA51,NA01 From LetterList,Patent,Fagent,Nation,staff Where LL04=PA01(+) And LL05=PA02(+) And LL06=PA03(+) And LL07=PA04(+) AND substr(LL11,1,8)=FA01 And substr(LL11,9,1)=FA02 And LL01='" & strUserNum & "' and FA10=na01(+) and na51=st01(+) "
            'Modified by Lydia 2020/09/24 +程式名稱and LL02='年證費請款函'
            StrSQLa = "Select LL02, LL03, LL04, LL05, LL06, LL07, PA22,Decode(CU05, Null, Nvl(CU04, CU06), CU05||' '||CU88||' '||CU89||' '||CU90), PA20, PA75, LL09,pa26,pa27,pa28,pa29,pa30,nvl(st01,LL10) LL10,LL11,CU10,NA51,NA01 From LetterList,Patent,Customer,Nation,staff Where LL04=PA01(+) And LL05=PA02(+) And LL06=PA03(+) And LL07=PA04(+) AND substr(LL11,1,8)=CU01 And substr(LL11,9,1)=CU02 And LL01='" & strLL01 & "@" & pub_HostName & "' and LL02='年證費請款函' and CU10=na01(+) and na51=st01(+) "
            StrSQLa = StrSQLa & " Union Select LL02, LL03, LL04, LL05, LL06, LL07, PA22,Decode(FA05, Null, Nvl(FA04, FA06), FA05||' '||FA63||' '||FA64||' '||FA65), PA20, PA75, LL09,pa26,pa27,pa28,pa29,pa30,nvl(st01,LL10) LL10,LL11,FA10,NA51,NA01 From LetterList,Patent,Fagent,Nation,staff Where LL04=PA01(+) And LL05=PA02(+) And LL06=PA03(+) And LL07=PA04(+) AND substr(LL11,1,8)=FA01 And substr(LL11,9,1)=FA02 And LL01='" & strLL01 & "@" & pub_HostName & "' and LL02='年證費請款函' and FA10=na01(+) and na51=st01(+) "
            StrSQLa = StrSQLa & " Order By NA51, NA01, 3, 4, 5 ,6"
         Else
         '2017/2/13 END
            'Modified by Lydia 2019/04/02 PK: 使用者帳號@電腦名稱(pub_HostName)
            'StrSQLa = "Select LL02, LL03, LL04, LL05, LL06, LL07, PA22,Decode(CU05, Null, Nvl(CU04, CU06), CU05||' '||CU88||' '||CU89||' '||CU90), PA20, PA75, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11,CU10,NA51,NA01 From LetterList,Patent,Customer,Nation,staff Where LL04=PA01(+) And LL05=PA02(+) And LL06=PA03(+) And LL07=PA04(+) AND substr(LL11,1,8)=CU01 And substr(LL11,9,1)=CU02 And LL01='" & strUserNum & "' and CU10=na01(+) and na51=st01(+) "
            'StrSQLa = StrSQLa & " Union Select LL02, LL03, LL04, LL05, LL06, LL07, PA22,Decode(FA05, Null, Nvl(FA04, FA06), FA05||' '||FA63||' '||FA64||' '||FA65), PA20, PA75, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11,FA10,NA51,NA01 From LetterList,Patent,Fagent,Nation,staff Where LL04=PA01(+) And LL05=PA02(+) And LL06=PA03(+) And LL07=PA04(+) AND substr(LL11,1,8)=FA01 And substr(LL11,9,1)=FA02 And LL01='" & strUserNum & "' and FA10=na01(+) and na51=st01(+) "
            'Modified by Lydia 2020/09/24 +程式名稱and LL02='年證費請款函'
            StrSQLa = "Select LL02, LL03, LL04, LL05, LL06, LL07, PA22,Decode(CU05, Null, Nvl(CU04, CU06), CU05||' '||CU88||' '||CU89||' '||CU90), PA20, PA75, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11,CU10,NA51,NA01 From LetterList,Patent,Customer,Nation,staff Where LL04=PA01(+) And LL05=PA02(+) And LL06=PA03(+) And LL07=PA04(+) AND substr(LL11,1,8)=CU01 And substr(LL11,9,1)=CU02 And LL01='" & strLL01 & "@" & pub_HostName & "' and LL02='年證費請款函' and CU10=na01(+) and na51=st01(+) "
            StrSQLa = StrSQLa & " Union Select LL02, LL03, LL04, LL05, LL06, LL07, PA22,Decode(FA05, Null, Nvl(FA04, FA06), FA05||' '||FA63||' '||FA64||' '||FA65), PA20, PA75, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11,FA10,NA51,NA01 From LetterList,Patent,Fagent,Nation,staff Where LL04=PA01(+) And LL05=PA02(+) And LL06=PA03(+) And LL07=PA04(+) AND substr(LL11,1,8)=FA01 And substr(LL11,9,1)=FA02 And LL01='" & strLL01 & "@" & pub_HostName & "' and LL02='年證費請款函' and FA10=na01(+) and na51=st01(+) "
            StrSQLa = StrSQLa & " Order By LL10, LL11, 3, 4, 5 ,6"
         End If
         
      'Add By Sindy 2015/10/5
      '年費逾期補繳通知函
      Case "8"
         'Modify By Sindy 2015/10/30 +eMail
         'Modified by Lydia 2019/04/02 PK: 使用者帳號@電腦名稱(pub_HostName)
         'StrSQLa = "Select LL02, LL03, LL04, LL05, LL06,LL07||DECODE(PA57,'Y','*',NULL) LL07, PA22, Decode(FA05, Null, Nvl(FA04, FA06), FA05||' '||FA63||' '||FA64||' '||FA65), CP25, PA75, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11,PA91,FA29,GetEmailFlag(CP09) eMail From LetterList, Fagent, Patent,CASEPROGRESS Where substr(LL08,1,8)=FA01 And substr(LL08,9,1)=FA02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strUserNum & "' AND CP01(+)=PA01 AND CP02(+)=PA02 AND CP03(+)=PA03 AND CP04(+)=PA04 AND CP10(+)='1605'"
         'StrSQLa = StrSQLa & " Union Select LL02, LL03, LL04, LL05, LL06,LL07||DECODE(PA57,'Y','*',NULL) LL07, PA22, Decode(CU05, Null, Nvl(CU04, CU06), CU05||' '||CU88||' '||CU89||' '||CU90), CP25, PA75, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11,PA91,CU79 FA29,GetEmailFlag(CP09) eMail From LetterList, Customer, Patent,CASEPROGRESS Where substr(LL08,1,8)=CU01 And substr(LL08,9,1)=CU02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strUserNum & "' AND CP01(+)=PA01 AND CP02(+)=PA02 AND CP03(+)=PA03 AND CP04(+)=PA04 AND CP10(+)='1605'"
         'Modified by Lydia 2020/09/24 +程式名稱and LL02='年費逾期補繳通知函'
         StrSQLa = "Select LL02, LL03, LL04, LL05, LL06,LL07||DECODE(PA57,'Y','*',NULL) LL07, PA22, Decode(FA05, Null, Nvl(FA04, FA06), FA05||' '||FA63||' '||FA64||' '||FA65), CP25, PA75, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11,PA91,FA29,GetEmailFlag(CP09) eMail From LetterList, Fagent, Patent,CASEPROGRESS Where substr(LL08,1,8)=FA01 And substr(LL08,9,1)=FA02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strLL01 & "@" & pub_HostName & "' and LL02='年費逾期補繳通知函' AND CP01(+)=PA01 AND CP02(+)=PA02 AND CP03(+)=PA03 AND CP04(+)=PA04 AND CP10(+)='1605'"
         StrSQLa = StrSQLa & " Union Select LL02, LL03, LL04, LL05, LL06,LL07||DECODE(PA57,'Y','*',NULL) LL07, PA22, Decode(CU05, Null, Nvl(CU04, CU06), CU05||' '||CU88||' '||CU89||' '||CU90), CP25, PA75, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11,PA91,CU79 FA29,GetEmailFlag(CP09) eMail From LetterList, Customer, Patent,CASEPROGRESS Where substr(LL08,1,8)=CU01 And substr(LL08,9,1)=CU02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strLL01 & "@" & pub_HostName & "' and LL02='年費逾期補繳通知函' AND CP01(+)=PA01 AND CP02(+)=PA02 AND CP03(+)=PA03 AND CP04(+)=PA04 AND CP10(+)='1605'"
         StrSQLa = StrSQLa & " Order By eMail, 1, 2, 3, 4"
         
      'Added by Morgan 2015/10/20
      '寰華案繳年費通知函
      Case "9"
         'Modified by Lydia 2019/04/02 PK: 使用者帳號@電腦名稱(pub_HostName)
         'StrSQLa = "Select LL02, LL03, LL04, LL05, LL06, LL07, PA22, SUBSTR(Decode(FA05, Null, Nvl(FA04, FA06), FA05||' '||FA63||' '||FA64||' '||FA65),1,24), PA20, PA75, NP15,NVL(PA76,LL08) PA76, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11,decode(instr(pa70||fa41||cu74||' ','N'),0,'','N') flgN From LetterList, Fagent, Patent, Customer, NEXTPROGRESS Where substr(LL08,1,8)=FA01 And substr(LL08,9,1)=FA02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strUserNum & "' AND LL04='P' AND PA01=NP02 AND PA02=NP03 AND PA03=NP04 AND PA04=NP05 AND NP07='605' AND NP06 IS NULL and cu01(+)=substr(pa26,1,8) and cu02(+)=substr(pa26,9) "
         'StrSQLa = StrSQLa & " Union Select LL02, LL03, LL04, LL05, LL06, LL07, PA22, SUBSTR(Decode(CU05, Null, Nvl(CU04, CU06), CU05||' '||CU88||' '||CU89||' '||CU90),1,24), PA20, PA75, NP15,NVL(PA76,LL08) PA76, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11,decode(instr(pa70||cu74||' ','N'),0,'','N') flgN From LetterList, Customer, Patent, NEXTPROGRESS Where substr(LL08,1,8)=CU01 And substr(LL08,9,1)=CU02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strUserNum & "' AND LL04='P' AND PA01=NP02 AND PA02=NP03 AND PA03=NP04 AND PA04=NP05 AND NP07='605' AND NP06 IS NULL "
         'Modified by Lydia 2019/11/26 個案PA70=N寄證書後年費不續辦，改為PA156(FCP年費特殊管制)
         'StrSQLa = "Select LL02, LL03, LL04, LL05, LL06, LL07, PA22, SUBSTR(Decode(FA05, Null, Nvl(FA04, FA06), FA05||' '||FA63||' '||FA64||' '||FA65),1,24), PA20, PA75, NP15,NVL(PA76,LL08) PA76, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11,decode(instr(pa70||fa41||cu74||' ','N'),0,'','N') flgN From LetterList, Fagent, Patent, Customer, NEXTPROGRESS Where substr(LL08,1,8)=FA01 And substr(LL08,9,1)=FA02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strLL01 & "@" & pub_HostName & "' AND LL04='P' AND PA01=NP02 AND PA02=NP03 AND PA03=NP04 AND PA04=NP05 AND NP07='605' AND NP06 IS NULL and cu01(+)=substr(pa26,1,8) and cu02(+)=substr(pa26,9) "
         'StrSQLa = StrSQLa & " Union Select LL02, LL03, LL04, LL05, LL06, LL07, PA22, SUBSTR(Decode(CU05, Null, Nvl(CU04, CU06), CU05||' '||CU88||' '||CU89||' '||CU90),1,24), PA20, PA75, NP15,NVL(PA76,LL08) PA76, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11,decode(instr(pa70||cu74||' ','N'),0,'','N') flgN From LetterList, Customer, Patent, NEXTPROGRESS Where substr(LL08,1,8)=CU01 And substr(LL08,9,1)=CU02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strLL01 & "@" & pub_HostName & "' AND LL04='P' AND PA01=NP02 AND PA02=NP03 AND PA03=NP04 AND PA04=NP05 AND NP07='605' AND NP06 IS NULL "
         'Modified by Lydia 2025/03/13 判斷PA156='Y' ; Ex:FCP-55422
         'StrSQLa = "Select LL02, LL03, LL04, LL05, LL06, LL07, PA22, SUBSTR(Decode(FA05, Null, Nvl(FA04, FA06), FA05||' '||FA63||' '||FA64||' '||FA65),1,24), PA20, PA75, NP15,NVL(PA76,LL08) PA76, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11,decode(instr(pa156||fa41||cu74||' ','N'),0,'','N') flgN From LetterList, Fagent, Patent, Customer, NEXTPROGRESS Where substr(LL08,1,8)=FA01 And substr(LL08,9,1)=FA02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strLL01 & "@" & pub_HostName & "' AND LL04='P' AND PA01=NP02 AND PA02=NP03 AND PA03=NP04 AND PA04=NP05 AND NP07='605' AND NP06 IS NULL and cu01(+)=substr(pa26,1,8) and cu02(+)=substr(pa26,9) "
         'StrSQLa = StrSQLa & " Union Select LL02, LL03, LL04, LL05, LL06, LL07, PA22, SUBSTR(Decode(CU05, Null, Nvl(CU04, CU06), CU05||' '||CU88||' '||CU89||' '||CU90),1,24), PA20, PA75, NP15,NVL(PA76,LL08) PA76, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11,decode(instr(pa156||cu74||' ','N'),0,'','N') flgN From LetterList, Customer, Patent, NEXTPROGRESS Where substr(LL08,1,8)=CU01 And substr(LL08,9,1)=CU02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strLL01 & "@" & pub_HostName & "' AND LL04='P' AND PA01=NP02 AND PA02=NP03 AND PA03=NP04 AND PA04=NP05 AND NP07='605' AND NP06 IS NULL "
         StrSQLa = "Select LL02, LL03, LL04, LL05, LL06, LL07, PA22, SUBSTR(Decode(FA05, Null, Nvl(FA04, FA06), FA05||' '||FA63||' '||FA64||' '||FA65),1,24), PA20, PA75, NP15,NVL(PA76,LL08) PA76, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11,rtrim(substr(pa156||fa41||cu74,1,1)) flgN From LetterList, Fagent, Patent, Customer, NEXTPROGRESS Where substr(LL08,1,8)=FA01 And substr(LL08,9,1)=FA02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strLL01 & "@" & pub_HostName & "' AND LL04='P' AND PA01=NP02 AND PA02=NP03 AND PA03=NP04 AND PA04=NP05 AND NP07='605' AND NP06 IS NULL and cu01(+)=substr(pa26,1,8) and cu02(+)=substr(pa26,9) "
         StrSQLa = StrSQLa & " Union Select LL02, LL03, LL04, LL05, LL06, LL07, PA22, SUBSTR(Decode(CU05, Null, Nvl(CU04, CU06), CU05||' '||CU88||' '||CU89||' '||CU90),1,24), PA20, PA75, NP15,NVL(PA76,LL08) PA76, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11,rtrim(substr(pa156||cu74,1,1)) flgN From LetterList, Customer, Patent, NEXTPROGRESS Where substr(LL08,1,8)=CU01 And substr(LL08,9,1)=CU02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strLL01 & "@" & pub_HostName & "' AND LL04='P' AND PA01=NP02 AND PA02=NP03 AND PA03=NP04 AND PA04=NP05 AND NP07='605' AND NP06 IS NULL "
         StrSQLa = StrSQLa & " Order By 1, 2, 3, 4"
         
      '寰華案實審通知函
      Case "10"
         'Modified by Lydia 2019/04/02 PK: 使用者帳號@電腦名稱(pub_HostName)
         'StrSQLa = "Select LL02, LL03, LL04, LL05, LL06, LL07, PA22, SUBSTR(Decode(FA05, Null, Nvl(FA04, FA06), FA05||' '||FA63||' '||FA64||' '||FA65),1,24), PA20, PA75, NP15,NVL(PA76,LL08) PA76, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11 From LetterList, Fagent, Patent, NEXTPROGRESS Where substr(LL08,1,8)=FA01 And substr(LL08,9,1)=FA02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strUserNum & "' AND LL04='P' AND PA01=NP02 AND PA02=NP03 AND PA03=NP04 AND PA04=NP05 AND NP07='416' AND NP06 IS NULL "
         'StrSQLa = StrSQLa & " Union Select LL02, LL03, LL04, LL05, LL06, LL07, PA22, SUBSTR(Decode(CU05, Null, Nvl(CU04, CU06), CU05||' '||CU88||' '||CU89||' '||CU90),1,24), PA20, PA75, NP15,NVL(PA76,LL08) PA76, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11 From LetterList, Customer, Patent, NEXTPROGRESS Where substr(LL08,1,8)=CU01 And substr(LL08,9,1)=CU02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strUserNum & "' AND LL04='P' AND PA01=NP02 AND PA02=NP03 AND PA03=NP04 AND PA04=NP05 AND NP07='416' AND NP06 IS NULL "
         StrSQLa = "Select LL02, LL03, LL04, LL05, LL06, LL07, PA22, SUBSTR(Decode(FA05, Null, Nvl(FA04, FA06), FA05||' '||FA63||' '||FA64||' '||FA65),1,24), PA20, PA75, NP15,NVL(PA76,LL08) PA76, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11 From LetterList, Fagent, Patent, NEXTPROGRESS Where substr(LL08,1,8)=FA01 And substr(LL08,9,1)=FA02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strLL01 & "@" & pub_HostName & "' AND LL04='P' AND PA01=NP02 AND PA02=NP03 AND PA03=NP04 AND PA04=NP05 AND NP07='416' AND NP06 IS NULL "
         StrSQLa = StrSQLa & " Union Select LL02, LL03, LL04, LL05, LL06, LL07, PA22, SUBSTR(Decode(CU05, Null, Nvl(CU04, CU06), CU05||' '||CU88||' '||CU89||' '||CU90),1,24), PA20, PA75, NP15,NVL(PA76,LL08) PA76, LL09,pa26,pa27,pa28,pa29,pa30,LL10,LL11 From LetterList, Customer, Patent, NEXTPROGRESS Where substr(LL08,1,8)=CU01 And substr(LL08,9,1)=CU02 And LL04=PA01 And LL05=PA02 And LL06=PA03 And LL07=PA04 And LL01='" & strLL01 & "@" & pub_HostName & "' AND LL04='P' AND PA01=NP02 AND PA02=NP03 AND PA03=NP04 AND PA04=NP05 AND NP07='416' AND NP06 IS NULL "
         StrSQLa = StrSQLa & " Order By 1, 2, 3, 4"
      'END 2015/10/20
         
   End Select
   
   If rsA.State = 1 Then rsA.Close
   rsA.CursorLocation = adUseClient
   rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
   '若有整批定稿清單資料
   If rsA.RecordCount > 0 Then
      'Add By Sindy 2015/6/26
      If strNewPrinter <> "" Then
         PUB_RestorePrinter strNewPrinter
      End If
      '2015/6/26 END
      
      If bolShowMsg = True Then 'Add By Sindy 2015/10/30 +if
         MsgBox "準備列印" & rsA.Fields(0).Value & "整批定稿清單!!!", vbExclamation + vbOKOnly
      End If
RePrint:
      For iCopys = 1 To pCopys 'Added by Lydia 2019/03/05 +列印份數
          '移至第一筆資料
          rsA.MoveFirst
          
          stLL10 = "" & rsA.Fields("LL10") 'Added by Morgan 2014/5/29
          iSubCnt = 0
          arrCnt = 0
          intPage = 1
          intCnt = 0
          'Modified by Morgan 2013/9/11 催年費及催實審改橫印
          'Printer.Orientation = 1
          'Modify by Sindy 2015/10/1 消滅函改橫印
          'Modify by Sindy 2015/10/1 年費逾繳函為橫印
          'Modifiedby Morgan 2015/10/20 +9,10
          If stSortMode = 5 Or stSortMode = 6 Or stSortMode = 3 Or stSortMode = 8 Or stSortMode = 9 Or stSortMode = 10 Then
             Printer.Orientation = 2
          Else
             Printer.Orientation = 1
          End If
          Printer.Font.Name = "細明體"
          strLetterName = "" & rsA.Fields(0).Value
          strCondition = "" & rsA.Fields(1).Value
    
          Call PrintLetterListHead(strLetterName, strCondition, iPrint, intPage, stSortMode)
            
          While Not rsA.EOF
             'Added by Morgan 2014/5/29 不同管制人要加分隔線
             bolCtLine = False
             '還有一行空間時先印否則跳頁後再印
             If stLL10 <> "" & rsA.Fields("LL10") Then
                If iPrint >= Printer.ScaleHeight - 1300 Then
                   iPrint = iPrint + 300
                   Printer.CurrentX = 500
                   Printer.CurrentY = iPrint
                   intI = Printer.FontSize
                   Printer.FontSize = 10
                   'Modify By Sindy 2017/2/16
                   If stSortMode = "7" And strConSql <> "" Then '領證及繳年費清單
                      Printer.Print String(40, "-") & "承辦人：" & stLL10 & " " & GetPrjSales(stLL10) & " (共" & iSubCnt & "筆)" & String(40, "-")
                   Else
                   '2017/2/16 END
                      Printer.Print String(40, "-") & "管制人：" & stLL10 & " " & GetPrjSales(stLL10) & " (共" & iSubCnt & "筆)" & String(40, "-")
                   End If
                   Printer.FontSize = intI
                   iSubCnt = 0
                   bolCtLine = True
                End If
             End If
             'end 2014/5/29
             
             'Modified by Morgan 2013/11/19 修正橫印跳頁問題,改預留 1000
             If strLetterName <> "" & rsA.Fields(0).Value _
                   Or strCondition <> "" & rsA.Fields(1).Value _
                   Or iPrint >= Printer.ScaleHeight - 1000 Then
                '印頁尾線
                iPrint = iPrint + 300
                Printer.CurrentX = 500
                Printer.CurrentY = iPrint
                Printer.Print String(200, "-")
                '跳頁印表頭
                strLetterName = "" & rsA.Fields(0).Value
                strCondition = "" & rsA.Fields(1).Value
                Printer.NewPage
                intPage = intPage + 1
                Call PrintLetterListHead(strLetterName, strCondition, iPrint, intPage, stSortMode)
                intCnt = 0
             End If
             
             'Added by Morgan 2014/5/29 不同管制人要加分隔線
             If stLL10 <> "" & rsA.Fields("LL10") Then
                If bolCtLine = False Then
                   iPrint = iPrint + 300
                   Printer.CurrentX = 500
                   Printer.CurrentY = iPrint
                   intI = Printer.FontSize
                   Printer.FontSize = 10
                   'Modify By Sindy 2017/2/16
                   If stSortMode = "7" And strConSql <> "" Then '領證及繳年費清單
                      Printer.Print String(40, "-") & "承辦人：" & stLL10 & " " & GetPrjSales(stLL10) & " (共" & iSubCnt & "筆)" & String(40, "-")
                   Else
                   '2017/2/16 END
                      Printer.Print String(40, "-") & "管制人：" & stLL10 & " " & GetPrjSales(stLL10) & " (共" & iSubCnt & "筆)" & String(40, "-")
                   End If
                   Printer.FontSize = intI
                   iSubCnt = 0
                End If
                stLL10 = "" & rsA.Fields("LL10")
             End If
             iSubCnt = iSubCnt + 1
             'end 2014/5/29
             
             iPrint = iPrint + 300
             lngX = 500
             Printer.CurrentX = lngX
             Printer.CurrentY = iPrint
             
             strExc(1) = "　"
             'Modify by Morgan 2007/4/4
             '2008/11/10 MODIFY BY SONIA 寄件時要附寄件清單
             'strExc(1) = "" & rsA.Fields(2).Value & "-" & rsA.Fields(3).Value & "-" & rsA.Fields(4).Value & "-" & rsA.Fields(5).Value
             '2008/11/10 ADD BY SONIA 寄件時要附寄件清單
             'Modify by Morgan 2009/2/9
             'If rsA.Fields("PA75").Value = "Y45148000" Or rsA.Fields(8).Value = "Y51774000" Then
             'Modify by Morgan 2010/10/27 --Susan
             'If "" & rsA.Fields("PA75").Value = "Y45148000" Or "" & rsA.Fields("PA75").Value = "Y51774000" Then
             If "" & rsA.Fields("PA75").Value = "Y45148000" Then
                strExc(1) = "＊"
             ElseIf "" & rsA.Fields("PA75").Value = "Y51774000" Then
             'end 2010/10/27
             'end 2009/2/9
                strExc(1) = "△"
             'Added by Morgan 2014/9/9
             ElseIf "" & rsA.Fields("PA75").Value = "Y48804000" Then
                strExc(1) = "◇"
             
             'Added by Morgan 2014/10/29 --吳彩菱
             ElseIf "" & rsA.Fields("PA75").Value = "Y51622000" Then
                If InStr(rsA.Fields("pa26") & "," & rsA.Fields("pa27") & "," & rsA.Fields("pa28") & "," & rsA.Fields("pa29") & "," & rsA.Fields("pa30"), "X4561400") > 0 Or _
                 InStr(rsA.Fields("pa26") & "," & rsA.Fields("pa27") & "," & rsA.Fields("pa28") & "," & rsA.Fields("pa29") & "," & rsA.Fields("pa30"), "X2110000") > 0 Then
                   strExc(1) = "◆"
                End If
             'end 2014/10/29
             'Add by Morgan 2010/5/4
             '繳年費前通知函
             ElseIf rsA("PA75") = "Y51774010" And stSortMode <> "5" And InStr("" & rsA("LL09"), "△") = 0 Then
                strExc(1) = "＊"
             '繳年費通知函
             ElseIf stSortMode = "5" Then
                If PUB_GetReceiver(rsA(2), rsA(3), rsA(4), rsA(5), "605") = "Y51774000" Then
                   strExc(1) = "△"
                End If
             'end 2010/5/4
             End If
             '2008/11/10 END
             
             'Add by Morgan 2017/3/13 公開與核准通知加 □請在14天內完成通知(公開在自己的Form內)
             If stSortMode = "2" Then
                If InStr("Y27856000,Y27856B30", "" & rsA.Fields("pa75")) > 0 And (InStr(rsA.Fields("pa26") & "," & rsA.Fields("pa27") & "," & rsA.Fields("pa28") & "," & rsA.Fields("pa29") & "," & rsA.Fields("pa30"), "X72643000") > 0 Or InStr(rsA.Fields("pa26") & "," & rsA.Fields("pa27") & "," & rsA.Fields("pa28") & "," & rsA.Fields("pa29") & "," & rsA.Fields("pa30"), "X74976000") > 0) Then
                   strExc(1) = strExc(1) & "□"
                End If
             End If
             'end 2017/3/13
             
             'Added by Morgan 2018/12/19
             If stSortMode = "5" Or stSortMode = "9" Then
                If "" & rsA.Fields("flgN") = "N" Then
                   strExc(1) = strExc(1) & "Ν"
                End If
                'Added by Lydia 2025/03/13
                If "" & rsA.Fields("flgN") = "Y" Then
                   strExc(1) = strExc(1) & "Ｙ"
                End If
                'end 2025/03/13
             End If
             'end 2018/12/19
             
             'Added by Lydia 2022/12/01 年費逾期補繳通知函
             If stSortMode = "8" Then
                 '◎請在三天內完成: Y54047(The Boeing Company)、Y54339(Metis IP)+ X85549(SHENZHEN)  --- Teresa
                 If InStr("Y54047000,Y27856B30", "" & rsA.Fields("pa75")) > 0 Or ("" & rsA.Fields("pa75") = "Y54339000" And InStr(rsA.Fields("pa26") & "," & rsA.Fields("pa27") & "," & rsA.Fields("pa28") & "," & rsA.Fields("pa29") & "," & rsA.Fields("pa30"), "X85549000") > 0) Then
                    strExc(1) = strExc(1) & "◎"
                 End If
             End If
             'end 2022/12/01
             
             'Modify by Morgan 2011/6/23 rsA(5) 可能會有 * 號
             'strExc(2) = rsA(2) & "-" & rsA(3) & IIf(rsA(4) & rsA(5) = "000", "", "-" & rsA(4) & "-" & rsA(5))
             strExc(2) = rsA(2) & "-" & rsA(3) & IIf(rsA(4) & Left(rsA(5), 2) = "000", Mid(rsA(5), 3), "-" & rsA(4) & "-" & rsA(5))
             
             'FCP公告通知函定稿不必調卷的案號前加印◎
             If stSortMode = "4" Then
               'Modified by Morgan 2020/5/7 從外層移進來,"＃"號只在公告清單有意義--Sharon
               'Add by Morgan 2011/5/27
               'Modified by Morgan 2015/4/14
               'If InStr(rsA.Fields("pa26") & "," & rsA.Fields("pa27") & ","  & rsA.Fields("pa28") & ","  & rsA.Fields("pa29") & ","  & rsA.Fields("pa30"), "X4783301") > 0 Then
               'Modify By Sindy 2018/3/2 取消 Y4580901, 新增 X2166000
               'If InStr("Y20511000,Y45809010", "" & rsA.Fields("PA75").Value) > 0 Then
               'Modified by Morgan 2020/5/7 + Y20412(Novo),Y4549300 (Lundbeck)
               If InStr("Y20511000,Y20412000,Y45493000", "" & rsA.Fields("PA75").Value) > 0 Or _
                  InStr(rsA.Fields("pa26") & "," & rsA.Fields("pa27") & "," & rsA.Fields("pa28") & "," & rsA.Fields("pa29") & "," & rsA.Fields("pa30"), "X2166000") > 0 Then
               'end 2015/4/14
                  strExc(1) = strExc(1) & "＃"
               Else
                  'Added by Morgan 2020/5/7
                  strExc(0) = "select 1 from caseprogress A where cp01='" & rsA(2) & "' and cp02='" & rsA(3) & "' and cp03='" & rsA(4) & "' and cp04='" & rsA(5) & "' and cp10='959' and cp159=0 and cp158<>19221111"
                  intI = 1
                  Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
                  If intI = 1 Then
                     strExc(1) = strExc(1) & "＃"
                  Else
                  'end 2020/5/7
                  
                     strExc(1) = strExc(1) & "　"
                     
                  End If 'Added by Morgan 2020/5/7
               End If
               'end 2020/5/7
             
                '核准函來函收文日>20070415 & 沒有 926 取消收文 則要調卷
                '2007/12/14 MODIFY BY SONIA 原只抓1001核准之來函,加入1503改變原處分且為准之來函
                'strExc(0) = "select 1 from caseprogress A where cp01='" & rsA(2) & "' and cp02='" & rsA(3) & "' and cp03='" & rsA(4) & "' and cp04='" & rsA(5) & "' and cp10='1001'" & _
                '   " and cp57 IS NULL and cp05>20070415 and exists(select * from caseprogress B where B.cp09=A.cp43" & _
                '   " and B.CP10 IN ('101','102','103','104','105','107','301','302','303','304','305','306','307'))"
    
                'Modified by Morgan 2014/4/3 改只要判斷有收文926且未取消收文的才要調卷,否則增加案件性質時可能會漏掉Ex.FCP-047144(改請衍生設計 308)--靜芳
                'strExc(0) = "select 1 from caseprogress A where cp01='" & rsA(2) & "' and cp02='" & rsA(3) & "' and cp03='" & rsA(4) & "' and cp04='" & rsA(5) & "' and (cp10='1001' OR (cp10='1503' and cp24='1'))" & _
                '   " and cp57 IS NULL and cp05>20070415 and exists(select * from caseprogress B where B.cp09=A.cp43" & _
                '   " and B.CP10 IN ('101','102','103','104','105','125','107','301','302','303','304','305','306','307'))"
                ''2007/12/14 END
                '
                ''Modify by Morgan 2007/10/31 改判斷有收文926且未取消收文的才要調卷
                ''strExc(0) = strExc(0) & " and not exists(select * from caseprogress C where C.cp01=A.cp01 and C.cp02=A.cp02 and C.cp03=A.cp03 and C.cp04=A.cp04 and C.cp10='926' and C.cp57>0)"
                'strExc(0) = strExc(0) & " and exists(select * from caseprogress C where C.cp01=A.cp01 and C.cp02=A.cp02 and C.cp03=A.cp03 and C.cp04=A.cp04 and C.cp10='926' and C.cp57 is null)"
                'Added by Morgan 2017/12/28 排除發文日為111111者--江如玉
                strExc(0) = "select 1 from caseprogress A where cp01='" & rsA(2) & "' and cp02='" & rsA(3) & "' and cp03='" & rsA(4) & "' and cp04='" & rsA(5) & "' and cp10='926' and cp159=0 and cp158<>19221111"
                'end 2014/4/3
                intI = 1
                Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
                If intI = 1 Then
                   arrCnt = arrCnt + 1
                   ReDim Preserve arrList(arrCnt)
                   'Modify by Morgan 2007/5/11
                   'arrList(arrCnt) = strExc(1) & "    " & rsA("PA11") & "(公告號" & rsA("PA22") & ")"
                   arrList(arrCnt) = rsA("PA11") & "(" & rsA("PA22") & ")" & "    " & strExc(2)
                   strExc(1) = "　" & strExc(1)
                Else
                   strExc(1) = "◎" & strExc(1)
                End If
                'Added by Lydia 2019/04/02 記錄公告日
                If Val("" & rsA.Fields("LL03")) >= 1080401 Then
                    If strDate926 = "" Then
                         strDate926 = "" & rsA.Fields("LL03")
                    ElseIf InStr(strDate926, "" & rsA.Fields("LL03")) = 0 Then
                         strDate926 = strDate926 & "," & rsA.Fields("LL03")
                    End If
                End If
                'end 2019/04/02
             End If
             
             
             'Modified by Morgan 2014/5/29 改最後再控制補空白
             'If IsNull(rsA("LL09")) Then
             '   strExc(1) = "　　　" & strExc(1)
             'Else
             '   'Modified by Morgan 2012/12/12 +日文案件標記,有分割建議標記
             '   If Len(rsA("LL09")) = 3 Then
             '      strExc(1) = rsA("LL09") & strExc(1)
             '   Else
             '      strExc(1) = rsA("LL09") & Left(strExc(1) & "　　", 3)
             '   End If
             'End If
             strExc(1) = rsA("LL09") & strExc(1)
             strExc(1) = RTrim(strExc(1)) 'Added by Morgan 2015/4/14
             If Len(strExc(1)) < 4 Then
                strExc(1) = Left(strExc(1) & "　　　　", 4)
             'Removed by Morgan 2015/4/14
             'Else
             '   strExc(1) = RTrim(strExc(1))
             'end 2015/4/14
             End If
             'end 2014/5/29
             
             strExc(1) = strExc(1) & strExc(2)
             Printer.Print strExc(1)
             'end 2007/4/4
             
             'Modify by Morgan 2009/8/19 本所案號前加一個符號所有欄位後移100
             'Modify by Morgan 2011/5/27 本所案號前再加一個符號所有欄位再後移100
             'Modify by Morgan 2012/12/7 本所案號前再加2個符號所有欄位再後移200
             'Modify By Sindy 2015/9/24 年證費請款函不印准駁日和證書號
             'Modified by Morgan 2015/10/20 +10
             'Modified by Lydia 2019/11/26 排除催實審通知函stSortMode=6 ,寰華案催實審10
             If stSortMode <> "7" And stSortMode <> "8" And stSortMode <> "6" Then
             '2015/9/24 END
                lngX = lngX + 2700
                Printer.CurrentX = lngX
                Printer.CurrentY = iPrint
                Printer.Print ChangeWStringToTDateString("" & rsA.Fields(8).Value)
                
                'Modify By Sindy 2015/9/24 消滅函不印證書號
                If stSortMode <> "3" Then
                '2015/9/24 END
                   lngX = lngX + 1300
                   Printer.CurrentX = lngX
                   Printer.CurrentY = iPrint
                   Printer.Print "" & rsA.Fields(6).Value
                End If
             End If
             
             'Modify By Sindy 2015/9/24
             'Modified by Morgan 2015/10/20 +10
             If stSortMode = "7" Or stSortMode = "8" Or stSortMode = "10" Then
                lngX = lngX + 2700
                
             'Added by Morgan 2015/10/20
             'Modified by Lydia 2019/11/26 +催實審通知函strRptNo=6
             ElseIf stSortMode = "9" Or stSortMode = "6" Then
                lngX = lngX + 2300
             'end 2015/10/20
             Else
             '2015/9/24 END
                lngX = lngX + 1300
             End If
             Printer.CurrentX = lngX
             Printer.CurrentY = iPrint
             'Modify By Sindy 2015/10/1
             'Printer.Print "" & rsA.Fields(7).Value
             Printer.Print Left("" & rsA.Fields(7).Value, 50)
             '2015/10/1 END
             
            'Added by Lydia 2019/11/26 催實審通知函改列印欄位：本所案號、代理人、實審自動代繳、下一程序備註
            If stSortMode = "6" Then
                  lngX = lngX + 3000
                  Printer.CurrentX = lngX + 800
                  Printer.CurrentY = iPrint
                  Printer.Print "" & rsA.Fields("PA69").Value '實審自動代繳
                  lngX = lngX + 1600
                  Printer.CurrentX = lngX
                  Printer.CurrentY = iPrint
                  Printer.Print "" & rsA.Fields("NP15").Value '下一程序備註
            End If
            'end 2019/11/26
            
             '2008/10/13 ADD BY SONIA
             If stSortMode = "5" Then '繳年費通知函
                lngX = lngX + 3000
                Printer.CurrentX = lngX
                Printer.CurrentY = iPrint
                Printer.Print "" & rsA.Fields("NP15").Value
             End If

             'Modified by Morgan 2015/10/20 +10
             'Remove by Lydia 2019/11/26 催實審改格式;2019/05/29 FCP案和寰華案的整批清單併在一起
             'If strLetterName = "催實審通知函" Or stSortMode = "10" Then
             '   lngX = lngX + 3000
             '   Printer.CurrentX = lngX
             '   Printer.CurrentY = iPrint
             '   Printer.Print "" & rsA.Fields("NP15").Value
             'End If
             '2008/10/13 END
             
             'Add By Sindy 2015/10/1 消滅函增加顯示案件備註
             If stSortMode = "3" Then
                '年費 或 消滅函 關鍵字者,取前後10個字出來
                '個案設定
                strTemp = "" & rsA.Fields("PA91").Value
                strPrint = ""
                If strTemp <> "" Then
                   If InStr(strTemp, "年費") > 0 Then
                      intStar = InStr(strTemp, "年費") - 10
                      If intStar < 1 Then intStar = 1
                      intEnd = Len("年費") + 20
                      strPrint = Mid(strTemp, intStar, intEnd)
                   End If
                   If InStr(strTemp, "消滅函") > 0 Then
                      intStar = InStr(strTemp, "消滅函") - 10
                      If intStar < 1 Then intStar = 1
                      intEnd = Len("消滅函") + 20
                      If strPrint <> Mid(strTemp, intStar, intEnd) Then
                         strPrint = IIf(strPrint <> "", strPrint & ";", "") & Mid(strTemp, intStar, intEnd)
                      End If
                   End If
                End If
                If strPrint = "" Then
                   '代理人設定
                   strTemp = "" & rsA.Fields("FA29").Value
                   If strTemp <> "" Then
                      If InStr(strTemp, "年費") > 0 Then
                         intStar = InStr(strTemp, "年費") - 10
                         If intStar < 1 Then intStar = 1
                         intEnd = Len("年費") + 20
                         strPrint = Mid(strTemp, intStar, intEnd)
                      End If
                      If InStr(strTemp, "消滅函") > 0 Then
                         intStar = InStr(strTemp, "消滅函") - 10
                         If intStar < 1 Then intStar = 1
                         intEnd = Len("消滅函") + 20
                         If strPrint <> Mid(strTemp, intStar, intEnd) Then
                            strPrint = IIf(strPrint <> "", strPrint & ";", "") & Mid(strTemp, intStar, intEnd)
                         End If
                      End If
                   End If
                End If
                If strPrint = "" Then
                   '申請人設定
                   strExc(0) = "select pa26,cu79 from patent,customer" & _
                               " where pa01='" & rsA(2) & "' and pa02='" & rsA(3) & "' and pa03='" & rsA(4) & "' and pa04='" & rsA(5) & "'" & _
                               " and substr(pa26,1,8)=cu01(+) and substr(pa26,9,1)=cu02(+)"
                   intI = 1
                   Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
                   If intI = 1 Then
                      strTemp = "" & RsTemp.Fields("cu79").Value
                   End If
                   If strTemp <> "" Then
                      If InStr(strTemp, "年費") > 0 Then
                         intStar = InStr(strTemp, "年費") - 10
                         If intStar < 1 Then intStar = 1
                         intEnd = Len("年費") + 20
                         strPrint = Mid(strTemp, intStar, intEnd)
                      End If
                      If InStr(strTemp, "消滅函") > 0 Then
                         intStar = InStr(strTemp, "消滅函") - 10
                         If intStar < 1 Then intStar = 1
                         intEnd = Len("消滅函") + 20
                         If strPrint <> Mid(strTemp, intStar, intEnd) Then
                            strPrint = IIf(strPrint <> "", strPrint & ";", "") & Mid(strTemp, intStar, intEnd)
                         End If
                      End If
                   End If
                End If
                lngX = lngX + 6000
                Printer.CurrentX = lngX
                Printer.CurrentY = iPrint
                'Modified by Morgan 2019/12/20 去除跳行否則會印到其他欄位
                'Printer.Print strPrint
                Printer.Print Replace(strPrint, vbCrLf, "")
             End If
             '2015/10/1 END
             'Add By Sindy 2015/10/6 年費逾繳增加顯示案件備註
             If stSortMode = "8" Then
                '年費 或 逾繳函 關鍵字者,取前後10個字出來
                '個案設定
                strTemp = "" & rsA.Fields("PA91").Value
                strPrint = ""
                If strTemp <> "" Then
                   If InStr(strTemp, "年費") > 0 Then
                      intStar = InStr(strTemp, "年費") - 10
                      If intStar < 1 Then intStar = 1
                      intEnd = Len("年費") + 20
                      strPrint = Mid(strTemp, intStar, intEnd)
                   End If
                   If InStr(strTemp, "逾繳函") > 0 Then
                      intStar = InStr(strTemp, "逾繳函") - 10
                      If intStar < 1 Then intStar = 1
                      intEnd = Len("逾繳函") + 20
                      If strPrint <> Mid(strTemp, intStar, intEnd) Then
                         strPrint = IIf(strPrint <> "", strPrint & ";", "") & Mid(strTemp, intStar, intEnd)
                      End If
                   End If
                End If
                If strPrint = "" Then
                   '代理人設定
                   strTemp = "" & rsA.Fields("FA29").Value
                   If strTemp <> "" Then
                      If InStr(strTemp, "年費") > 0 Then
                         intStar = InStr(strTemp, "年費") - 10
                         If intStar < 1 Then intStar = 1
                         intEnd = Len("年費") + 20
                         strPrint = Mid(strTemp, intStar, intEnd)
                      End If
                      If InStr(strTemp, "逾繳函") > 0 Then
                         intStar = InStr(strTemp, "逾繳函") - 10
                         If intStar < 1 Then intStar = 1
                         intEnd = Len("逾繳函") + 20
                         If strPrint <> Mid(strTemp, intStar, intEnd) Then
                            strPrint = IIf(strPrint <> "", strPrint & ";", "") & Mid(strTemp, intStar, intEnd)
                         End If
                      End If
                   End If
                End If
                If strPrint = "" Then
                   '申請人設定
                   strExc(0) = "select pa26,cu79 from patent,customer" & _
                               " where pa01='" & rsA(2) & "' and pa02='" & rsA(3) & "' and pa03='" & rsA(4) & "' and pa04='" & rsA(5) & "'" & _
                               " and substr(pa26,1,8)=cu01(+) and substr(pa26,9,1)=cu02(+)"
                   intI = 1
                   Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
                   If intI = 1 Then
                      strTemp = "" & RsTemp.Fields("cu79").Value
                   End If
                   If strTemp <> "" Then
                      If InStr(strTemp, "年費") > 0 Then
                         intStar = InStr(strTemp, "年費") - 10
                         If intStar < 1 Then intStar = 1
                         intEnd = Len("年費") + 20
                         strPrint = Mid(strTemp, intStar, intEnd)
                      End If
                      If InStr(strTemp, "逾繳函") > 0 Then
                         intStar = InStr(strTemp, "逾繳函") - 10
                         If intStar < 1 Then intStar = 1
                         intEnd = Len("逾繳函") + 20
                         If strPrint <> Mid(strTemp, intStar, intEnd) Then
                            strPrint = IIf(strPrint <> "", strPrint & ";", "") & Mid(strTemp, intStar, intEnd)
                         End If
                      End If
                   End If
                End If
                lngX = lngX + 6000
                Printer.CurrentX = lngX
                Printer.CurrentY = iPrint
                Printer.Print Replace(strPrint, vbCrLf, "")
             End If
             '2015/10/1 END
             
             intCnt = intCnt + 1
             rsA.MoveNext
          Wend
                
          '印表尾
          iPrint = iPrint + 300
          Printer.CurrentX = 500
          Printer.CurrentY = iPrint
          'Modified by Morgan 2014/5/29 若有管制人時加印
          'Printer.Print String(200, "-")
          If stLL10 <> "" Then
             intI = Printer.FontSize
             Printer.FontSize = 10
             'Modify By Sindy 2017/2/16
             If stSortMode = "7" And strConSql <> "" Then '領證及繳年費清單
                Printer.Print String(40, "-") & "承辦人：" & stLL10 & " " & GetPrjSales(stLL10) & " (共" & iSubCnt & "筆)" & String(40, "-")
             Else
             '2017/2/16 END
                Printer.Print String(40, "-") & "管制人：" & stLL10 & " " & GetPrjSales(stLL10) & " (共" & iSubCnt & "筆)" & String(40, "-")
             End If
             Printer.FontSize = intI
          Else
             Printer.Print String(200, "-")
          End If
          'end 2014/5/29
          
          'Add By Sindy 2015/7/14
          If stSortMode = "2" Then '核准函
             'Modified by Lydia 2019/04/02 PK: 使用者帳號@電腦名稱(pub_HostName)
             'strExc(0) = "select count(*) from LetterList where LL01='" & strUserNum & "' and LL09='■'"
             strExc(0) = "select count(*) from LetterList where LL01='" & strLL01 & "@" & pub_HostName & "' and LL09='■'"
             intI = 1
             Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
             If intI = 1 Then
                strExc(1) = RsTemp.Fields(0)
             End If
             iPrint = iPrint + 300
             Printer.CurrentX = 500
             Printer.CurrentY = iPrint
             Printer.Print "筆數：共" & Format(rsA.RecordCount - strExc(1), "#,##0") & "筆(非優先請款)　　有" & Format(strExc(1), "#,##0") & "筆優先請款!!!"
          '2015/7/14 END
          'Add By Sindy 2015/10/6
          ElseIf stSortMode = "8" Then '年費逾期補繳通知函
             'Modified by Lydia 2019/04/02 PK: 使用者帳號@電腦名稱(pub_HostName)
             'strExc(0) = "select count(*) from LetterList,Patent where LL01='" & strUserNum & "' And LL04=PA01(+) And LL05=PA02(+) And LL06=PA03(+) And LL07=PA04(+) And PA57='Y'"
             strExc(0) = "select count(*) from LetterList,Patent where LL01='" & strLL01 & "@" & pub_HostName & "' And LL04=PA01(+) And LL05=PA02(+) And LL06=PA03(+) And LL07=PA04(+) And PA57='Y'"
             intI = 1
             Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
             If intI = 1 Then
                strExc(1) = RsTemp.Fields(0)
             End If
             iPrint = iPrint + 300
             Printer.CurrentX = 500
             Printer.CurrentY = iPrint
             'Modify By Sindy 2015/10/30
             Printer.Print "筆數：共" & Format(rsA.RecordCount, "#,##0") & "筆　　有" & Format(strExc(1), "#,##0") & "筆閉卷　　應寄" & Format(Val(rsA.RecordCount) - Val(strExc(1)), "#,##0") & "筆!!!"
          '2015/10/6 END
          
          'Add By Sindy 2015/10/30
          ElseIf stSortMode = "3" Then '專利權消滅函
             'Modified by Lydia 2019/04/02 PK: 使用者帳號@電腦名稱(pub_HostName)
             'strExc(0) = "select count(*) from LetterList,Patent where LL01='" & strUserNum & "' And LL04=PA01(+) And LL05=PA02(+) And LL06=PA03(+) And LL07=PA04(+) And DECODE(PA59,'89',NULL,'*')='*'"
             strExc(0) = "select count(*) from LetterList,Patent where LL01='" & strLL01 & "@" & pub_HostName & "' And LL04=PA01(+) And LL05=PA02(+) And LL06=PA03(+) And LL07=PA04(+) And DECODE(PA59,'89',NULL,'*')='*'"
             intI = 1
             Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
             If intI = 1 Then
                strExc(1) = RsTemp.Fields(0)
             End If
             iPrint = iPrint + 300
             Printer.CurrentX = 500
             Printer.CurrentY = iPrint
             Printer.Print "筆數：共" & Format(rsA.RecordCount, "#,##0") & "筆　　有*(不通知)" & Format(strExc(1), "#,##0") & "筆　　應通知" & Format(Val(rsA.RecordCount) - Val(strExc(1)), "#,##0") & "筆!!!　　（1.呈判：" & Format(Val(rsA.RecordCount) - Val(strExc(1)), "#,##0") & "件　2.信封另外發文　3.留底信退Teresa）"
          '2015/10/30 END
          
          Else
             iPrint = iPrint + 300
             Printer.CurrentX = 500
             Printer.CurrentY = iPrint
             Printer.Print "筆數：共" & Format(rsA.RecordCount, "#,##0") & "筆!!!"
          End If
          Printer.EndDoc
        
          'Added by Lydia 2019/03/05  公告本整批匯入(frm010038)啟用後,不印調卷清單(保留)
          'Modified by Lydia 2019/03/26 108/4/1啟用
          'If strSrvDate(1) >= "20200101" Then
          'Modified by Lydia 2019/04/01 公告通知函才通知
          'If strSrvDate(1) >= "20190401" Then
          'Modified by Lydia 2019/04/02 原本主旨用系統日,現在改為公告日
          'If strSrvDate(1) >= "20190401" And stSortMode = "4" Then
          If strDate926 <> "" And stSortMode = "4" Then
                arrCnt = 0
                If bolE926 = False Then
                    strExc(1) = Pub_GetSpecMan("總務下載公告本人員")
                    If strExc(1) <> "" Then
                        strExc(2) = Replace(strExc(1), ";", ",")
                        strSql = "select st02 from staff where st01 in (" & GetAddStr(strExc(2)) & " ) order by st01"
                        intI = 1
                        Set RsTemp = ClsLawReadRstMsg(intI, strSql)
                        If intI = 1 Then
                             strExc(2) = Replace("" & RsTemp.GetString(, , , ","), ",", "/")
                             strExc(3) = Mid(strExc(2), 1, Len(strExc(2)) - 1) & ", 您好," & vbCrLf & _
                                             "請到智慧局網站下載公告本:" & vbCrLf & vbCrLf & _
                                             "1.  詳細清單請到檔案室系統->公告本整批匯入，查詢列表清單；" & vbCrLf & _
                                             "2.  請逐筆用公告號/申請案號到智慧局網站下載公告本到資料夾；" & vbCrLf & _
                                             "3.  全部檔案下載完成後，請在公告本整批匯入的畫面按下匯入按鈕。"
                             'Modified by Lydia 2019/04/01 +CC給操作者
                             'Modified by Lydia 2019/04/02 原本主旨用系統日,現在改為公告日
                             'PUB_SendMail strUserNum, strExc(1), "", "請下載" & ChangeTStringToTDateString(strSrvDate(2)) & "公告本", strExc(3), , , , , , strUserNum
                             PUB_SendMail strUserNum, strExc(1), "", "請下載" & strDate926 & "公告本", strExc(3), , , , , , strUserNum
                             bolE926 = True '避免重複列印,造成重覆email
                        End If
                    End If
                End If
          End If
          'end 2019/03/05

          
          'Add by Morgan 2007//4/3 調卷清單
          If stSortMode = "4" And arrCnt > 0 Then
             'Add by Morgan 2007/5/11
             '依申請號重新排序
             For ii = 1 To arrCnt
                For jj = ii + 1 To arrCnt
                   'Modify by Morgan 2007/10/24 改先發明新型後設計+申請號
                   'If arrList(ii) > arrList(jj) Then
                   'Modify by Morgan 2010/12/28 申請案號改碼數
                   'If Mid(arrList(ii), 3, 1) = "3" Then
                   If Mid(arrList(ii), 4, 1) = "3" Then
                      strExc(2) = "1" & arrList(ii)
                   Else
                      strExc(2) = "0" & arrList(ii)
                   End If
                   'Modify by Morgan 2010/12/28 申請案號改碼數
                   'If Mid(arrList(jj), 3, 1) = "3" Then
                   If Mid(arrList(jj), 4, 1) = "3" Then
                      strExc(3) = "1" & arrList(jj)
                   Else
                      strExc(3) = "0" & arrList(jj)
                   End If
                   If strExc(2) > strExc(3) Then
                   'end 2007/10/24
                      strExc(1) = arrList(ii)
                      arrList(ii) = arrList(jj)
                      arrList(jj) = strExc(1)
                   End If
                Next
             Next
                
             'Modified by Morgan 2014/6/27 改印3份--靜芳
             For intPage = 1 To 3
                If intPage > 1 Then
                   Printer.NewPage
                End If
                
                'Modified by Morgan 2016/3/22 加印表頭
                'iPrint = 500
                'Printer.CurrentX = 500
                'Printer.CurrentY = iPrint
                'Printer.Print "調卷清單："
                'iPrint = iPrint + 200
                Call PrintLetterListHead(strLetterName & "-調卷清單", strCondition, iPrint, 0, "4-1")
                iPrint = iPrint + 300
                Printer.CurrentX = 500
                Printer.CurrentY = iPrint
                Printer.Print String(200, "-")
                'end 2016/3/22
                
                For intI = 1 To arrCnt
                   iPrint = iPrint + 300
                   'Modified by Morgan 2016/3/22
                   'If iPrint > 13000 Then
                   If iPrint > Printer.ScaleHeight - 1000 Then
                   'end 2016/3/22
                      Printer.NewPage
                      iPrint = 1000
                   End If
                   Printer.CurrentX = 500
                   Printer.CurrentY = iPrint
                   Printer.Print Format(intI, "@@") & "." & arrList(intI) & "." & Format(intI, "@@")
                Next
             Next
             Printer.EndDoc
          End If
          'end 2007/4/3
      Next iCopys 'Added by Lydia 2019/03/05 +列印份數
      
      '可重覆列整批定清單資料
      If MsgBox("整批定稿清單已列印完畢，您是否要重新列印???", vbExclamation + vbYesNo + vbDefaultButton2) = vbYes Then
          GoTo RePrint
      End If
      
      'Add By Sindy 2015/6/26
      If strOldPrinter <> "" Then
         PUB_RestorePrinter strOldPrinter
      End If
      '2015/6/26 END
   End If
   If rsA.State <> adStateClosed Then rsA.Close
   Set rsA = Nothing
   
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description
End Sub


'Add By Cheng 2003/09/23
'取得所別
Public Function PUB_GetST06(strUserNum As String) As String
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset

PUB_GetST06 = ""
StrSQLa = "Select ST06 From Staff Where ST01='" & strUserNum & "' "
rsA.CursorLocation = adUseClient
rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
If rsA.RecordCount > 0 Then
    PUB_GetST06 = "" & rsA.Fields(0).Value
End If
If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing
End Function

'是否列印申請人預設抓1.基本檔,2.請款對象,3.客戶檔
Public Function PUB_GetA1K04(strCP01 As String, strCP02 As String, strCP03 As String, strCP04 As String, Optional ByVal strA1K28 As String, Optional ByVal strCP10 As String) As String

'Removed by Morgan 2015/7/24 條件已改Y34271000都要,故直接設FA44即可
'   'Add by Morgan 2005/3/1 檢查是否為例外情形
'   If CheckFCPExecept(strCP01, strCP02, strCP03, strCP04, strA1K28) = True Then
'      PUB_GetA1K04 = "Y"
'      Exit Function
'   End If

   Dim stReturn As String
   
On Error GoTo ErrHnd

   strSql = "Select PA78 From Patent where PA01='" & strCP01 & "' AND PA02='" & strCP02 & "' AND PA03='" & strCP03 & "' AND PA04='" & strCP04 & "'"
   strSql = strSql & " Union Select TM46 From Trademark where TM01='" & strCP01 & "' AND TM02='" & strCP02 & "' AND TM03='" & strCP03 & "' AND TM04='" & strCP04 & "' "
   strSql = strSql & " Union Select LC25 From Lawcase where LC01='" & strCP01 & "' AND LC02='" & strCP02 & "' AND LC03='" & strCP03 & "' AND LC04='" & strCP04 & "' "
   strSql = strSql & " Union Select SP33 From Servicepractice where SP01='" & strCP01 & "' AND SP02='" & strCP02 & "' AND SP03='" & strCP03 & "' AND SP04='" & strCP04 & "' "
   
   CheckOC3
   With AdoRecordSet3
      .CursorLocation = adUseClient
      .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      If .RecordCount > 0 Then
         stReturn = "" & .Fields(0)
      End If
      If stReturn = "" Then
         If strA1K28 = "" And strCP10 <> "" Then
            strA1K28 = PUB_GetA1K28(strCP01, strCP02, strCP03, strCP04, strCP10)
         End If
         
         If Left(strA1K28, 1) = "Y" Then
            'Modify By Sindy 2011/3/3
            If CheckSys(strCP01) = "2" Or CheckSys(strCP01) = "6" Then
               strSql = "select FA109 FROM Fagent WHERE FA01='" & Left(strA1K28, 8) & "' AND FA02='" & Right(strA1K28, 1) & "'"
            '2011/3/3 End
            Else
               strSql = "select FA44 FROM Fagent WHERE FA01='" & Left(strA1K28, 8) & "' AND FA02='" & Right(strA1K28, 1) & "'"
            End If
            CheckOC3
            .CursorLocation = adUseClient
            .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
            If .RecordCount > 0 Then
               stReturn = "" & .Fields(0)
            End If
         ElseIf Left(strA1K28, 1) = "X" Then
            'Modify By Sindy 2011/3/3
            If CheckSys(strCP01) = "2" Or CheckSys(strCP01) = "6" Then
               strSql = "select CU149 FROM Customer WHERE CU01='" & Left(strA1K28, 8) & "' AND CU02='" & Right(strA1K28, 1) & "'"
            '2011/3/3 End
            Else
               strSql = "select CU77 FROM Customer WHERE CU01='" & Left(strA1K28, 8) & "' AND CU02='" & Right(strA1K28, 1) & "'"
            End If
            CheckOC3
            .CursorLocation = adUseClient
            .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
            If .RecordCount > 0 Then
               stReturn = "" & .Fields(0)
            End If
         End If
      End If
      PUB_GetA1K04 = stReturn
   End With
   
ErrHnd:

   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
   
End Function
'2004/12/16 end

'Removed by Morgan 2015/7/24 條件已改Y34271000都要,故直接設FA44即可
''Add by Morgan 2005/3/1 檢查FCP案件請款對象為 Y34271000 且申請人為 X18031000
'Private Function CheckFCPExecept(p_stPA01 As String, p_stPA02 As String, p_stPA03 As String, p_stPA04 As String, Optional ByVal p_stA1K28 As String) As Boolean
'On Error GoTo ErrHnd
'   If p_stPA01 = "FCP" Then
'      strSql = "Select pa26,pa27,pa28,pa29,pa30 FROM Patent WHERE PA01='" & p_stPA01 & "' and PA02='" & p_stPA02 & "' and PA03='" & p_stPA03 & "' and PA04='" & p_stPA04 & "'"
'      CheckOC3
'      With AdoRecordSet3
'         .CursorLocation = adUseClient
'         .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
'         If .RecordCount > 0 Then
'            If "" & .Fields(0) = "X18031000" And p_stA1K28 = "Y34271000" Then
'               CheckFCPExecept = True
'            'Remove by Morgan 2006/7/21 應為列印對象固定
''            'Add by Morgan 2006/7/5 申請人X54905固定要印申請人
''            ElseIf "" & .Fields(0) = "X54905000" Then
''               CheckFCPExecept = True
'            End If
'         End If
'      End With
'
'   End If
'ErrHnd:
'   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
'End Function

'2006/3/29 ADD BY SONIA 已發文請求面詢407但無通知面詢1401且無面詢408之收文者提示訊息
Public Function CHECKFCP407(strCP01 As String, strCP02 As String, strCP03 As String, strCP04 As String) As String
Dim StrSqlB As String
   
   '2007/9/20 MODIFY BY SONIA 有收費的才要檢查
   'StrSqlB = "SELECT A.CP09,B.CP09,C.CP09 FROM CASEPROGRESS A,CASEPROGRESS B,CASEPROGRESS C " & _
   '          "WHERE A.CP01='" & strCP01 & "' AND A.CP02='" & strCP02 & "' AND A.CP03='" & strCP03 & "' AND A.CP04='" & strCP04 & "' AND A.CP10='407' AND A.CP27 IS NOT NULL AND A.CP57 IS NULL " & _
   '          "AND A.CP01=B.CP01(+) AND A.CP02=B.CP02(+) AND A.CP03=B.CP03(+) AND A.CP04=B.CP04(+) AND '1401'=B.CP10(+) AND B.CP57 IS NULL " & _
   '          "AND A.CP01=C.CP01(+) AND A.CP02=C.CP02(+) AND A.CP03=C.CP03(+) AND A.CP04=C.CP04(+) AND '408'=C.CP10(+) AND C.CP57 IS NULL "
   'Modify by Morgan 2008/4/28 請求面詢加判斷有發文規費的
   StrSqlB = "SELECT A.CP09,B.CP09,C.CP09 FROM CASEPROGRESS A,CASEPROGRESS B,CASEPROGRESS C " & _
             "WHERE A.CP01='" & strCP01 & "' AND A.CP02='" & strCP02 & "' AND A.CP03='" & strCP03 & "' AND A.CP04='" & strCP04 & "' AND A.CP10='407' AND A.CP27 IS NOT NULL AND A.CP57 IS NULL AND A.CP16>0 AND A.CP84>0" & _
             "AND A.CP01=B.CP01(+) AND A.CP02=B.CP02(+) AND A.CP03=B.CP03(+) AND A.CP04=B.CP04(+) AND '1401'=B.CP10(+) AND B.CP57 IS NULL " & _
             "AND A.CP01=C.CP01(+) AND A.CP02=C.CP02(+) AND A.CP03=C.CP03(+) AND A.CP04=C.CP04(+) AND '408'=C.CP10(+) AND C.CP57 IS NULL "
   '2007/9/20 END
   CheckOC3
   With AdoRecordSet3
      .CursorLocation = adUseClient
      .Open StrSqlB, cnnConnection, adOpenStatic, adLockReadOnly
      If .RecordCount <> 0 Then
         If "" & .Fields(0) <> "" And "" & .Fields(1) = "" And "" & .Fields(2) = "" Then
            MsgBox "注意 ! 此案須辦理面詢規費退費!!!", vbExclamation + vbOKOnly
         End If
      End If
   End With
   CheckOC3

End Function
'2006/3/29 END

'Add By Cheng 2003/09/25
'列印對象
Public Function PUB_GetA1K27(strCP01 As String, strCP02 As String, strCP03 As String, strCP04 As String, strCP10 As String) As String
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset
Dim strA1K28 As String

PUB_GetA1K27 = ""
'系統類別
Select Case strCP01
Case "P", "CFP", "FCP"
   'Add by Morgan 2006/7/21 申請人有X54905時,列印對象固定為自己
   If strCP01 = "FCP" Then
      strExc(0) = "select pa26,pa27,pa28,pa29,PA30 from patent where PA01='" & strCP01 & "' AND PA02='" & strCP02 & "' AND PA03='" & strCP03 & "' AND PA04='" & strCP04 & "'"
      intI = 1
      Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
      If intI = 1 Then
         
         'Modify by Morgan 2006/10/16 X54905xxx的都要
         'If "" & rsTemp.Fields(0) = "X54905000" Or "" & rsTemp.Fields(1) = "X54905000" Or "" & rsTemp.Fields(2) = "X54905000" Or "" & rsTemp.Fields(3) = "X54905000" Or "" & rsTemp.Fields(4) = "X54905000" Then
         '   PUB_GetA1K27 = "X54905000"
         'Modify by Morgan 2006/11/3 X54905xxx 的都要設 X54905000
         If Left("" & RsTemp.Fields(0), 6) = "X54905" Then
            'PUB_GetA1K27 = rsTemp.Fields(0)
            PUB_GetA1K27 = "X54905000"
         ElseIf Left("" & RsTemp.Fields(1), 6) = "X54905" Then
            'PUB_GetA1K27 = rsTemp.Fields(1)
            PUB_GetA1K27 = "X54905000"
         ElseIf Left("" & RsTemp.Fields(2), 6) = "X54905" Then
            'PUB_GetA1K27 = rsTemp.Fields(2)
            PUB_GetA1K27 = "X54905000"
         ElseIf Left("" & RsTemp.Fields(3), 6) = "X54905" Then
            'PUB_GetA1K27 = rsTemp.Fields(3)
            PUB_GetA1K27 = "X54905000"
         ElseIf Left("" & RsTemp.Fields(4), 6) = "X54905" Then
            'PUB_GetA1K27 = rsTemp.Fields(4)
            PUB_GetA1K27 = "X54905000"
         End If
         If PUB_GetA1K27 <> "" Then
         'end 2006/10/16
            Set rsA = Nothing
            Exit Function
         End If
      End If
   End If
   'end 2006/7/21
   
    '若案件性質為年費
    If strCP10 = "605" Then
        'Modified by Morgan 2012/6/30 順序改和信函收件人一致(已檢查無資料受影響) Nvl(FA72,Nvl(FA71, Nvl(FA30, Nvl(CU106, Nvl(CU97, Nvl(CU96,  --> Nvl(CU106, Nvl(CU97, Nvl(CU96, Nvl(FA72, Nvl(FA71, Nvl(FA30,
        StrSQLa = "Select Nvl(PA134,Nvl(PA105, Nvl(PA76, Nvl(PA133, Nvl(PA88, Nvl(CU106, Nvl(CU97, Nvl(CU96, Nvl(FA72, Nvl(FA71, Nvl(FA30, Nvl(CU105, Nvl(CU57, Nvl(PA75, PA26)))))))))))))) From Patent, Fagent, Customer " & _
                        " Where substr(PA75,1,8)=FA01(+) And substr(PA75,9,1)=FA02(+) And substr(PA26,1,8)=CU01(+) And substr(PA26,9,1)=CU02(+) " & _
                        " And PA01='" & strCP01 & "' AND PA02='" & strCP02 & "' AND PA03='" & strCP03 & "' AND PA04='" & strCP04 & "' "
        rsA.CursorLocation = adUseClient
        rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
        If rsA.RecordCount > 0 Then
            PUB_GetA1K27 = "" & rsA.Fields(0).Value
        End If
        If rsA.State <> adStateClosed Then rsA.Close
        Set rsA = Nothing
        Exit Function
    End If
Case "T", "FCT", "CFT", "TF"
    '若案件性質為延展
    If strCP10 = "102" Then
        'Modify By Sindy 2011/3/3 cu106改抓cu152; fa72改抓fa112; CU57改抓CU147; FA30改抓FA107; CU105改抓CU151; FA71改抓FA111
'        StrSQLa = "Select Nvl(TM70, Nvl(TM66, Nvl(TM33, Nvl(TM69, Nvl(TM56, Nvl(FA72, Nvl(FA67, Nvl(FA66, Nvl(FA71, Nvl(FA30, Nvl(CU106, Nvl(CU99, Nvl(CU98, Nvl(CU105, Nvl(CU57, Nvl(TM44, TM23)))))))))))))))) From Trademark, Fagent, Customer " & _
'                        " Where substr(TM44,1,8)=FA01(+) And substr(TM44,9,1)=FA02(+) And substr(TM23,1,8)=CU01(+) And substr(TM23,9,1)=CU02(+) " & _
'                        " And TM01='" & strCP01 & "' AND TM02='" & strCP02 & "' AND TM03='" & strCP03 & "' AND TM04='" & strCP04 & "' "
        StrSQLa = "Select Nvl(TM70, Nvl(TM66, Nvl(TM33, Nvl(TM69, Nvl(TM56, Nvl(FA112, Nvl(FA67, Nvl(FA66, Nvl(FA111, Nvl(FA107, Nvl(CU152, Nvl(CU99, Nvl(CU98, Nvl(CU151, Nvl(CU147, Nvl(TM44, TM23)))))))))))))))) From Trademark, Fagent, Customer " & _
                        " Where substr(TM44,1,8)=FA01(+) And substr(TM44,9,1)=FA02(+) And substr(TM23,1,8)=CU01(+) And substr(TM23,9,1)=CU02(+) " & _
                        " And TM01='" & strCP01 & "' AND TM02='" & strCP02 & "' AND TM03='" & strCP03 & "' AND TM04='" & strCP04 & "' "
        rsA.CursorLocation = adUseClient
        rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
        If rsA.RecordCount > 0 Then
            PUB_GetA1K27 = "" & rsA.Fields(0).Value
        End If
        If rsA.State <> adStateClosed Then rsA.Close
        Set rsA = Nothing
        Exit Function
    End If
End Select

'Modify By Sindy 2011/3/3
If CheckSys(strCP01) = "2" Or CheckSys(strCP01) = "6" Then
   '商標一般固定列印對象; CU57改抓CU147; FA30改抓FA107; CU105改抓CU151; FA71改抓FA111
   StrSQLa = "Select Nvl(TM69, Nvl(TM56, Nvl(FA111, Nvl(FA107, Nvl(CU151, Nvl(CU147, Nvl(TM44, TM23))))))) From Trademark, Fagent, Customer " & _
                       " Where substr(TM44,1,8)=FA01(+) And substr(TM44,9,1)=FA02(+) And substr(TM23,1,8)=CU01(+) And substr(TM23,9,1)=CU02(+) " & _
                       " And TM01='" & strCP01 & "' AND TM02='" & strCP02 & "' AND TM03='" & strCP03 & "' AND TM04='" & strCP04 & "' "
   StrSQLa = StrSQLa & " Union Select Nvl(SP67, Nvl(SP37, Nvl(FA111, Nvl(FA107, Nvl(CU151, Nvl(CU147, Nvl(SP26, SP08))))))) From Servicepractice, Fagent, Customer " & _
                       " Where substr(SP26,1,8)=FA01(+) And substr(SP26,9,1)=FA02(+) And substr(SP08,1,8)=CU01(+) And substr(SP08,9,1)=CU02(+) " & _
                       " And SP01='" & strCP01 & "' AND SP02='" & strCP02 & "' AND SP03='" & strCP03 & "' AND SP04='" & strCP04 & "' "
'2011/3/3 End
Else
   '一般固定列印對象
   StrSQLa = "Select Nvl(PA133, Nvl(PA88, Nvl(FA71, Nvl(FA30, Nvl(CU105, Nvl(CU57, Nvl(PA75, PA26))))))) From Patent, Fagent, Customer " & _
                       " Where substr(PA75,1,8)=FA01(+) And substr(PA75,9,1)=FA02(+) And substr(PA26,1,8)=CU01(+) And substr(PA26,9,1)=CU02(+) " & _
                       " And PA01='" & strCP01 & "' AND PA02='" & strCP02 & "' AND PA03='" & strCP03 & "' AND PA04='" & strCP04 & "' "
   StrSQLa = StrSQLa & " Union Select Nvl(LC35, Nvl(LC26, Nvl(FA71, Nvl(FA30, Nvl(CU105, Nvl(CU57, Nvl(LC22, LC11))))))) From Lawcase, Fagent, Customer " & _
                       " Where substr(LC22,1,8)=FA01(+) And substr(LC22,9,1)=FA02(+) And substr(LC11,1,8)=CU01(+) And substr(LC11,9,1)=CU02(+) " & _
                       " And LC01='" & strCP01 & "' AND LC02='" & strCP02 & "' AND LC03='" & strCP03 & "' AND LC04='" & strCP04 & "' "
   StrSQLa = StrSQLa & " Union Select Nvl(SP67, Nvl(SP37, Nvl(FA71, Nvl(FA30, Nvl(CU105, Nvl(CU57, Nvl(SP26, SP08))))))) From Servicepractice, Fagent, Customer " & _
                       " Where substr(SP26,1,8)=FA01(+) And substr(SP26,9,1)=FA02(+) And substr(SP08,1,8)=CU01(+) And substr(SP08,9,1)=CU02(+) " & _
                       " And SP01='" & strCP01 & "' AND SP02='" & strCP02 & "' AND SP03='" & strCP03 & "' AND SP04='" & strCP04 & "' "
End If
rsA.CursorLocation = adUseClient
rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
If rsA.RecordCount > 0 Then
   PUB_GetA1K27 = "" & rsA.Fields(0).Value
End If
If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing
End Function

'Add By Cheng 2003/09/25
'請款對象
Public Function PUB_GetA1K28(strCP01 As String, strCP02 As String, strCP03 As String, strCP04 As String, strCP10 As String) As String
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset

PUB_GetA1K28 = ""
'系統類別
Select Case strCP01
Case "P", "CFP", "FCP"
    '若案件性質為年費
    If strCP10 = "605" Then
        'Modified by Morgan 2012/6/30 順序改和信函收件人一致(已檢查無資料受影響) Nvl(FA30, Nvl(CU97, Nvl(CU96,-->Nvl(CU97, Nvl(CU96, Nvl(FA30,
        StrSQLa = "Select Nvl(PA105, Nvl(PA76, Nvl(PA88,Nvl(CU97, Nvl(CU96, Nvl(FA30, Nvl(CU57, Nvl(PA75, PA26)))))))) From Patent, Fagent, Customer " & _
                        " Where substr(PA75,1,8)=FA01(+) And substr(PA75,9,1)=FA02(+) And substr(PA26,1,8)=CU01(+) And substr(PA26,9,1)=CU02(+) " & _
                        " And PA01='" & strCP01 & "' AND PA02='" & strCP02 & "' AND PA03='" & strCP03 & "' AND PA04='" & strCP04 & "' "
        rsA.CursorLocation = adUseClient
        rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
        If rsA.RecordCount > 0 Then
            PUB_GetA1K28 = "" & rsA.Fields(0).Value
        End If
        If rsA.State <> adStateClosed Then rsA.Close
        Set rsA = Nothing
        Exit Function
    End If
Case "T", "FCT", "CFT", "TF"
    '若案件性質為延展
    If strCP10 = "102" Then
        'Modify By Sindy 2011/3/3 CU57改抓CU147; FA30改抓FA107
'        StrSQLa = "Select Nvl(TM66, Nvl(TM33, Nvl(TM56, Nvl(FA67, Nvl(FA66, Nvl(FA30, Nvl(CU99, Nvl(CU98, Nvl(CU57, Nvl(TM44, TM23)))))))))) From Trademark, Fagent, Customer " & _
'                        " Where substr(TM44,1,8)=FA01(+) And substr(TM44,9,1)=FA02(+) And substr(TM23,1,8)=CU01(+) And substr(TM23,9,1)=CU02(+) " & _
'                        " And TM01='" & strCP01 & "' AND TM02='" & strCP02 & "' AND TM03='" & strCP03 & "' AND TM04='" & strCP04 & "' "
        StrSQLa = "Select Nvl(TM66, Nvl(TM33, Nvl(TM56, Nvl(FA67, Nvl(FA66, Nvl(FA107, Nvl(CU99, Nvl(CU98, Nvl(CU147, Nvl(TM44, TM23)))))))))) From Trademark, Fagent, Customer " & _
                        " Where substr(TM44,1,8)=FA01(+) And substr(TM44,9,1)=FA02(+) And substr(TM23,1,8)=CU01(+) And substr(TM23,9,1)=CU02(+) " & _
                        " And TM01='" & strCP01 & "' AND TM02='" & strCP02 & "' AND TM03='" & strCP03 & "' AND TM04='" & strCP04 & "' "
        rsA.CursorLocation = adUseClient
        rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
        If rsA.RecordCount > 0 Then
            PUB_GetA1K28 = rsA.Fields(0).Value
        End If
        If rsA.State <> adStateClosed Then rsA.Close
        Set rsA = Nothing
        Exit Function
    End If
End Select

'Modify By Sindy 2011/3/3
If CheckSys(strCP01) = "2" Or CheckSys(strCP01) = "6" Then
   '商標一般固定請款對象; CU57改抓CU147; FA30改抓FA107
   StrSQLa = " Select Nvl(TM56, Nvl(FA107, Nvl(CU147, Nvl(TM44, TM23)))) From Trademark, Fagent, Customer " & _
                       " Where substr(TM44,1,8)=FA01(+) And substr(TM44,9,1)=FA02(+) And substr(TM23,1,8)=CU01(+) And substr(TM23,9,1)=CU02(+) " & _
                       " And TM01='" & strCP01 & "' AND TM02='" & strCP02 & "' AND TM03='" & strCP03 & "' AND TM04='" & strCP04 & "' "
   StrSQLa = StrSQLa & " Union Select Nvl(SP37, Nvl(FA107, Nvl(CU147, Nvl(SP26, SP08)))) From Servicepractice, Fagent, Customer " & _
                       " Where substr(SP26,1,8)=FA01(+) And substr(SP26,9,1)=FA02(+) And substr(SP08,1,8)=CU01(+) And substr(SP08,9,1)=CU02(+) " & _
                       " And SP01='" & strCP01 & "' AND SP02='" & strCP02 & "' AND SP03='" & strCP03 & "' AND SP04='" & strCP04 & "' "
Else
   '一般固定請款對象
   StrSQLa = "Select Nvl(PA88, Nvl(FA30, Nvl(CU57, Nvl(PA75, PA26)))) From Patent, Fagent, Customer " & _
                       " Where substr(PA75,1,8)=FA01(+) And substr(PA75,9,1)=FA02(+) And substr(PA26,1,8)=CU01(+) And substr(PA26,9,1)=CU02(+) " & _
                       " And PA01='" & strCP01 & "' AND PA02='" & strCP02 & "' AND PA03='" & strCP03 & "' AND PA04='" & strCP04 & "' "
   StrSQLa = StrSQLa & " Union Select Nvl(LC26, Nvl(FA30, Nvl(CU57, Nvl(LC22, LC11)))) From Lawcase, Fagent, Customer " & _
                       " Where substr(LC22,1,8)=FA01(+) And substr(LC22,9,1)=FA02(+) And substr(LC11,1,8)=CU01(+) And substr(LC11,9,1)=CU02(+) " & _
                       " And LC01='" & strCP01 & "' AND LC02='" & strCP02 & "' AND LC03='" & strCP03 & "' AND LC04='" & strCP04 & "' "
   StrSQLa = StrSQLa & " Union Select Nvl(SP37, Nvl(FA30, Nvl(CU57, Nvl(SP26, SP08)))) From Servicepractice, Fagent, Customer " & _
                       " Where substr(SP26,1,8)=FA01(+) And substr(SP26,9,1)=FA02(+) And substr(SP08,1,8)=CU01(+) And substr(SP08,9,1)=CU02(+) " & _
                       " And SP01='" & strCP01 & "' AND SP02='" & strCP02 & "' AND SP03='" & strCP03 & "' AND SP04='" & strCP04 & "' "
End If
rsA.CursorLocation = adUseClient
rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
If rsA.RecordCount > 0 Then
    PUB_GetA1K28 = "" & rsA.Fields(0).Value
End If
If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing
End Function

'Add by Morgan 2011/1/17
'是否國外部案件
Private Function CheckFCase(pa01 As String, pa02 As String, pa03 As String, pa04 As String) As Boolean
   Dim stSQL As String, iR As Integer
   stSQL = "select cp12 from caseprogress where cp01='" & pa01 & "'" & _
      " and cp02='" & pa02 & "' and cp03='" & pa03 & "' and cp04='" & pa04 & "' order by cp05 desc"
   iR = 1
   Set AdoRecordSet3 = ClsLawReadRstMsg(iR, stSQL)
   If iR = 1 Then
      If Left("" & AdoRecordSet3.Fields("cp12"), 1) = "F" Then
         CheckFCase = True
      End If
   End If
End Function

'Add By Cheng 2003/09/25
'取得D/N折扣
Public Function PUB_GetA1L07Disc(strCP01 As String, strCP02 As String, strCP03 As String, strCP04 As String, strCP10 As String, strDNDate As String) As String
'strCP01, strCP02, strCP03, strCP04:本所案號
'strCP10:案件性質
'strDNDate:請款日期
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset
'Add by Morgan 2011/1/17
Dim bolFCase As Boolean '是否適用(個案,代理人,申請人)取較低折扣數規則
Dim stLowestDisc As String, stDisc As String '最低折扣,折扣
'end 2011/1/17
Dim strFAStarDate As String, strCUStarDate As String, strFAEndDate As String, strCUEndDate As String 'Add By Sindy 2025/3/4 全部折扣起始日,終止日
   
   PUB_GetA1L07Disc = ""
   
   'Modify by Morgan 2005/1/21 服務業務 PS,CPS抓專利折扣其他抓商標折扣
   '系統類別
   Select Case strCP01
      Case "P", "CFP", "FCP"
         'Modify by Morgan 2008/11/11 +領證年費折扣 PA151,PA152,FA95,FA96,CU130,CU131
         'Modify By Sindy 2025/3/4 因商標加全部折扣終止日,為在下方程式欄位數一樣加空白 ,'' as FaEndDt,'' as CuEndDt
         StrSQLa = "Select PA49, PA50, PA75, FA25, FA26, FA27, PA26, CU36, CU37, CU38" & _
                   ",PA151,PA152,FA95,FA96,CU130,CU131,'' as FaEndDt,'' as CuEndDt From Patent, Fagent, Customer Where substr(PA75,1,8)=FA01(+) And substr(PA75,9,1)=FA02(+) And substr(PA26,1,8)=CU01(+) And substr(PA26,9,1)=CU02(+) And PA01='" & strCP01 & "' And PA02='" & strCP02 & "' And PA03='" & strCP03 & "' And PA04='" & strCP04 & "' "
      Case "T", "CFT", "FCT", "TF"
         'Modify By Sindy 2025/3/4 +繳註冊費,延展折扣,商標全部折扣終止日 TM140,TM141,FA137,FA138,FA139 as FaEndDt,CU203,CU204,CU205 as CuEndDt
         StrSQLa = "Select TM36, TM37, TM44, FA73, FA74, FA75, TM23, CU107, CU108, CU109" & _
                   ",TM140,TM141,FA137,FA138,FA139 as FaEndDt,CU203,CU204,CU205 as CuEndDt From Trademark, Fagent, Customer Where substr(TM44,1,8)=FA01(+) And substr(TM44,9,1)=FA02(+) And substr(TM23,1,8)=CU01(+) And substr(TM23,9,1)=CU02(+) And TM01='" & strCP01 & "' And TM02='" & strCP02 & "' And TM03='" & strCP03 & "' And TM04='" & strCP04 & "' "
      Case "PS", "CPS", "FG"
         'Modify By Sindy 2025/3/4 因商標加全部折扣終止日,為在下方程式欄位數一樣加空白 ,'' as FaEndDt,'' as CuEndDt
         StrSQLa = "Select SP31, 100,  SP26, FA25, FA26, FA27, SP08, CU36, CU37, CU38,'' as FaEndDt,'' as CuEndDt" & _
                   " From Servicepractice, Fagent, Customer Where substr(SP26,1,8)=FA01(+) And substr(SP26,9,1)=FA02(+) And substr(SP08,1,8)=CU01(+) And substr(SP08,9,1)=CU02(+) And SP01='" & strCP01 & "' And SP02='" & strCP02 & "' And SP03='" & strCP03 & "' And SP04='" & strCP04 & "'"
      Case Else
         'Modify By Sindy 2025/3/4 +商標全部折扣終止日 ,FA139 as FaEndDt,CU205 as CuEndDt
         StrSQLa = "Select SP31, 100,  SP26, FA73, FA74, FA75, SP08, CU107, CU108, CU109,FA139 as FaEndDt,CU205 as CuEndDt" & _
                   " From Servicepractice, Fagent, Customer Where substr(SP26,1,8)=FA01(+) And substr(SP26,9,1)=FA02(+) And substr(SP08,1,8)=CU01(+) And substr(SP08,9,1)=CU02(+) And SP01='" & strCP01 & "' And SP02='" & strCP02 & "' And SP03='" & strCP03 & "' And SP04='" & strCP04 & "'"
   End Select
   
   rsA.CursorLocation = adUseClient
   rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
   If rsA.RecordCount > 0 Then
      'Add By Sindy 2025/3/4 全部折扣起始日,終止日
      strFAStarDate = "" & rsA.Fields(5).Value
      strCUStarDate = "" & rsA.Fields(9).Value
      strFAEndDate = "" & rsA.Fields("FaEndDt")
      If strFAEndDate = "" Then strFAEndDate = "99991231"
      strCUEndDate = "" & rsA.Fields("CuEndDt")
      If strCUEndDate = "" Then strCUEndDate = "99991231"
      '2025/3/4 END
      
      '系統類別
      Select Case strCP01
         Case "P", "CFP", "FCP"
            'Add by Morgan 2011/1/17
            If strCP01 = "FCP" Then
               bolFCase = True
            Else
               bolFCase = CheckFCase(strCP01, strCP02, strCP03, strCP04)
            End If
            
            Select Case strCP10
               Case "101", "102", "103", "104", "105", "201" '申請或翻譯
                  'Add by Morgan 2011/1/17
                  If bolFCase = True Then
                     stLowestDisc = "100"
                     stDisc = "100"
                     '個案
                     If rsA.Fields("PA50").Value > 0 Then 'PA50
                        stDisc = rsA.Fields("PA50").Value
                     ElseIf rsA.Fields("PA49").Value > 0 Then 'PA49
                        stDisc = rsA.Fields("PA49").Value
                     End If
                     '取低者
                     If Val(stDisc) < Val(stLowestDisc) Then
                        stLowestDisc = stDisc
                     End If
                     
                     '代理人
                     If rsA.Fields("FA26").Value > 0 Then 'FA26
                         stDisc = rsA.Fields("FA26").Value
                     ElseIf rsA.Fields("FA25").Value > 0 Then 'FA25
                        '若有全部折扣起始日
                        If rsA.Fields("FA27").Value > 0 Then  'FA27
                           If DBDATE(rsA.Fields("FA27").Value) <= Val(DBDATE(strDNDate)) Then
                              stDisc = rsA.Fields("FA25").Value
                           End If
                        '若無全部折扣起始日
                        Else
                           stDisc = rsA.Fields("FA25").Value
                        End If
                     End If
                     
                     '取低者
                     If Val(stDisc) < Val(stLowestDisc) Then
                        stLowestDisc = stDisc
                     End If
                     
                     If rsA.Fields("CU37").Value > 0 Then  'CU37
                         stDisc = rsA.Fields("CU37").Value
                     ElseIf rsA.Fields("CU36").Value > 0 Then 'CU36
                        '若有全部折扣起始日
                        If rsA.Fields("CU38").Value > 0 Then 'CU38
                            If DBDATE(rsA.Fields("CU38").Value) <= Val(DBDATE(strDNDate)) Then
                                stDisc = rsA.Fields("CU36").Value
                            End If
                        '若無全部折扣起始日
                        Else
                            stDisc = rsA.Fields("CU36").Value
                        End If
                     End If
                     
                     '取低者
                     If Val(stDisc) < Val(stLowestDisc) Then
                        stLowestDisc = stDisc
                     End If
                     PUB_GetA1L07Disc = stLowestDisc
                  Else
                  'end 2011/1/17
                     
                     '個案
                     If "" & rsA.Fields(1).Value <> "" Then 'PA50
                        PUB_GetA1L07Disc = "" & rsA.Fields(1).Value
                     ElseIf "" & rsA.Fields(0).Value <> "" Then 'PA49
                         PUB_GetA1L07Disc = "" & rsA.Fields(0).Value
                     '代理人
                     ElseIf "" & rsA.Fields(4).Value <> "" Then 'FA26
                         PUB_GetA1L07Disc = "" & rsA.Fields(4).Value
'                     ElseIf "" & rsA.Fields(3).Value <> "" Then 'FA25
'                        '若有全部折扣起始日
'                        If "" & rsA.Fields(5).Value <> "" Then 'FA27
'                           If DBDATE(rsA.Fields(5).Value) <= Val(DBDATE(strDNDate)) Then    '2009/6/22 加=條件
'                              PUB_GetA1L07Disc = "" & rsA.Fields(3).Value
'                           End If
'                        '若無全部折扣起始日
'                        Else
'                           PUB_GetA1L07Disc = "" & rsA.Fields(3).Value
'                        End If
'                     ElseIf "" & rsA.Fields(8).Value <> "" Then 'CU37
'                         PUB_GetA1L07Disc = "" & rsA.Fields(8).Value
'                     ElseIf "" & rsA.Fields(7).Value <> "" Then 'CU36
'                        '若有全部折扣起始日
'                        If "" & rsA.Fields(9).Value <> "" Then 'CU38
'                            If DBDATE(rsA.Fields(9).Value) <= Val(DBDATE(strDNDate)) Then    '2009/6/22 加=條件
'                                PUB_GetA1L07Disc = "" & rsA.Fields(7).Value
'                            End If
'                        '若無全部折扣起始日
'                        Else
'                            PUB_GetA1L07Disc = "" & rsA.Fields(7).Value
'                        End If
                     End If
                     'Modify By Sindy 2025/3/4 有折扣起始日未生效時,往下抓申請人
                     If PUB_GetA1L07Disc = "" And "" & rsA.Fields(3).Value <> "" Then 'FA25
'                        '若有全部折扣起始日
'                        If "" & rsA.Fields(5).Value <> "" Then 'FA27
'                           If DBDATE(rsA.Fields(5).Value) <= Val(DBDATE(strDNDate)) Then    '2009/6/22 加=條件
'                              PUB_GetA1L07Disc = "" & rsA.Fields(3).Value
'                           End If
'                        '若無全部折扣起始日
'                        Else
                        If Val(strFAStarDate) <= Val(DBDATE(strDNDate)) And Val(strFAEndDate) >= Val(DBDATE(strDNDate)) Then
                           PUB_GetA1L07Disc = "" & rsA.Fields(3).Value
                        End If
                     End If
                     '申請人
                     If PUB_GetA1L07Disc = "" And "" & rsA.Fields(8).Value <> "" Then 'CU37
                         PUB_GetA1L07Disc = "" & rsA.Fields(8).Value
                     End If
                     If PUB_GetA1L07Disc = "" And "" & rsA.Fields(7).Value <> "" Then  'CU36
'                        '若有全部折扣起始日
'                        If "" & rsA.Fields(9).Value <> "" Then 'CU38
'                            If DBDATE(rsA.Fields(9).Value) <= Val(DBDATE(strDNDate)) Then    '2009/6/22 加=條件
'                                PUB_GetA1L07Disc = "" & rsA.Fields(7).Value
'                            End If
'                        '若無全部折扣起始日
'                        Else
                        If Val(strCUStarDate) <= Val(DBDATE(strDNDate)) And Val(strCUEndDate) >= Val(DBDATE(strDNDate)) Then
                            PUB_GetA1L07Disc = "" & rsA.Fields(7).Value
                        End If
                     End If
                     '2025/3/4 END
                  End If 'Add by Morgan 2011/1/17
                  
                  If rsA.State <> adStateClosed Then rsA.Close
                  Set rsA = Nothing
                  Exit Function
                     
               'Modify by Morgan 2008/11/11 領證,年費也要抓折扣
               'Case "601", "605" '領證, 年費
                  'PUB_GetA1L07Disc = "100"
                  'If rsA.State <> adStateClosed Then rsA.Close
                  'Set rsA = Nothing
                  'Exit Function
                  
               Case "601" '領證
               
                  'Add by Morgan 2011/1/17
                  If bolFCase = True Then
                     stLowestDisc = "100"
                     stDisc = "100"
                     '個案
                     If rsA.Fields("PA151") > 0 Then
                        stDisc = rsA.Fields("PA151")
                     End If
                     '取低者
                     If Val(stDisc) < Val(stLowestDisc) Then
                        stLowestDisc = stDisc
                     End If
                     
                     '代理人
                     If rsA.Fields("FA95") > 0 Then
                        stDisc = rsA.Fields("FA95")
                     End If
                     '取低者
                     If Val(stDisc) < Val(stLowestDisc) Then
                        stLowestDisc = stDisc
                     End If
                     
                     '申請人
                     If rsA.Fields("CU130") > 0 Then
                        stDisc = rsA.Fields("CU130")
                     End If
                     '取低者
                     If Val(stDisc) < Val(stLowestDisc) Then
                        stLowestDisc = stDisc
                     End If
                     PUB_GetA1L07Disc = stLowestDisc
                  Else
                  'end 2011/1/17
                  
                     If Not IsNull(rsA.Fields("PA151")) Then
                        PUB_GetA1L07Disc = rsA.Fields("PA151")
                     ElseIf Not IsNull(rsA.Fields("FA95")) Then
                        PUB_GetA1L07Disc = rsA.Fields("FA95")
                     ElseIf Not IsNull(rsA.Fields("CU130")) Then
                        PUB_GetA1L07Disc = rsA.Fields("CU130")
                     Else
                        PUB_GetA1L07Disc = "100"
                     End If
                     
                  End If 'Add by Morgan 2011/1/17
                  
                  If rsA.State <> adStateClosed Then rsA.Close
                  Set rsA = Nothing
                  Exit Function
                  
               Case "605" '年費
                  'Add by Morgan 2011/1/17
                  If bolFCase = True Then
                     stLowestDisc = "100"
                     stDisc = "100"
                     '個案
                     If rsA.Fields("PA152") > 0 Then
                        stDisc = rsA.Fields("PA152")
                     End If
                     '取低者
                     If Val(stDisc) < Val(stLowestDisc) Then
                        stLowestDisc = stDisc
                     End If
                     
                     '代理人
                     If rsA.Fields("FA96") > 0 Then
                        stDisc = rsA.Fields("FA96")
                     End If
                     '取低者
                     If Val(stDisc) < Val(stLowestDisc) Then
                        stLowestDisc = stDisc
                     End If
                     
                     '申請人
                     If rsA.Fields("CU131") > 0 Then
                        stDisc = rsA.Fields("CU131")
                     End If
                     '取低者
                     If Val(stDisc) < Val(stLowestDisc) Then
                        stLowestDisc = stDisc
                     End If
                     PUB_GetA1L07Disc = stLowestDisc
                  Else
                  'end 2011/1/17
                  
                     If Not IsNull(rsA.Fields("PA152")) Then
                        PUB_GetA1L07Disc = rsA.Fields("PA152")
                     ElseIf Not IsNull(rsA.Fields("FA96")) Then
                        PUB_GetA1L07Disc = rsA.Fields("FA96")
                     ElseIf Not IsNull(rsA.Fields("CU131")) Then
                        PUB_GetA1L07Disc = rsA.Fields("CU131")
                     Else
                        PUB_GetA1L07Disc = "100"
                     End If
                     
                  End If 'Add by Morgan 2011/1/17
                  
                  If rsA.State <> adStateClosed Then rsA.Close
                  Set rsA = Nothing
                  Exit Function
               'end 2008/11/11
            End Select
              
         Case "T", "CFT", "FCT", "TF"
            Select Case strCP10
               'Add By Sindy 2025/3/5
               Case "717" '註冊費
                  '個案
                  If "" & rsA.Fields("TM140").Value <> "" Then
                     PUB_GetA1L07Disc = "" & rsA.Fields("TM140").Value
                  '代理人
                  ElseIf "" & rsA.Fields("FA137").Value <> "" Then
                     PUB_GetA1L07Disc = "" & rsA.Fields("FA137").Value
                  '申請人
                  ElseIf "" & rsA.Fields("CU203").Value <> "" Then
                     PUB_GetA1L07Disc = "" & rsA.Fields("CU203").Value
                  End If
               Case "102" '延展
                  '個案
                  If "" & rsA.Fields("TM141").Value <> "" Then
                     PUB_GetA1L07Disc = "" & rsA.Fields("TM141").Value
                  '代理人
                  ElseIf "" & rsA.Fields("FA138").Value <> "" Then
                     PUB_GetA1L07Disc = "" & rsA.Fields("FA138").Value
                  '申請人
                  ElseIf "" & rsA.Fields("CU204").Value <> "" Then
                     PUB_GetA1L07Disc = "" & rsA.Fields("CU204").Value
                  End If
               '2025/3/5 END
               
               Case "101" '申請
                  '個案
                  If "" & rsA.Fields(1).Value <> "" Then 'TM37
                     PUB_GetA1L07Disc = "" & rsA.Fields(1).Value
'                  ElseIf "" & rsA.Fields(0).Value <> "" Then 'TM36
'                     PUB_GetA1L07Disc = "" & rsA.Fields(0).Value
                  '代理人
                  ElseIf "" & rsA.Fields(4).Value <> "" Then 'FA74
                     PUB_GetA1L07Disc = "" & rsA.Fields(4).Value
                  '申請人
                  ElseIf "" & rsA.Fields(8).Value <> "" Then 'CU108
                      PUB_GetA1L07Disc = "" & rsA.Fields(8).Value
'                  ElseIf "" & rsA.Fields(3).Value <> "" Then 'FA73
'                      '若有全部折扣起始日
'                      If "" & rsA.Fields(5).Value <> "" Then 'FA75
'                          If DBDATE(rsA.Fields(5).Value) <= Val(DBDATE(strDNDate)) Then    '2009/6/22 加=條件
'                              PUB_GetA1L07Disc = "" & rsA.Fields(3).Value
'                          End If
'                      '若無全部折扣起始日
'                      Else
'                          PUB_GetA1L07Disc = "" & rsA.Fields(3).Value
'                      End If
'                  ElseIf "" & rsA.Fields(8).Value <> "" Then 'CU108
'                      PUB_GetA1L07Disc = "" & rsA.Fields(8).Value
'                  ElseIf "" & rsA.Fields(7).Value <> "" Then 'CU107
'                      '若有全部折扣起始日
'                      If "" & rsA.Fields(9).Value <> "" Then 'CU109
'                          If DBDATE(rsA.Fields(9).Value) <= Val(DBDATE(strDNDate)) Then    '2009/6/22 加=條件
'                              PUB_GetA1L07Disc = "" & rsA.Fields(7).Value
'                          End If
'                      '若無全部折扣起始日
'                      Else
'                          PUB_GetA1L07Disc = "" & rsA.Fields(7).Value
'                      End If
                  End If
                  
                  
'                  'Modify By Sindy 2025/3/4
'                  If PUB_GetA1L07Disc = "" And "" & rsA.Fields(3).Value <> "" Then 'FA73
''                      '若有全部折扣起始日
''                      If "" & rsA.Fields(5).Value <> "" Then 'FA75
''                          If DBDATE(rsA.Fields(5).Value) <= Val(DBDATE(strDNDate)) Then    '2009/6/22 加=條件
''                              PUB_GetA1L07Disc = "" & rsA.Fields(3).Value
''                          End If
''                      '若無全部折扣起始日
''                      Else
'                      If Val(strFAStarDate) <= Val(DBDATE(strDNDate)) And Val(strFAEndDate) >= Val(DBDATE(strDNDate)) Then
'                          PUB_GetA1L07Disc = "" & rsA.Fields(3).Value
'                      End If
'                  End If
'                  '申請人
'                  If PUB_GetA1L07Disc = "" And "" & rsA.Fields(8).Value <> "" Then 'CU108
'                      PUB_GetA1L07Disc = "" & rsA.Fields(8).Value
'                  End If
'                  If PUB_GetA1L07Disc = "" And "" & rsA.Fields(7).Value <> "" Then 'CU107
''                      '若有全部折扣起始日
''                      If "" & rsA.Fields(9).Value <> "" Then 'CU109
''                          If DBDATE(rsA.Fields(9).Value) <= Val(DBDATE(strDNDate)) Then    '2009/6/22 加=條件
''                              PUB_GetA1L07Disc = "" & rsA.Fields(7).Value
''                          End If
''                      '若無全部折扣起始日
''                      Else
'                      If Val(strCUStarDate) <= Val(DBDATE(strDNDate)) And Val(strCUEndDate) >= Val(DBDATE(strDNDate)) Then
'                          PUB_GetA1L07Disc = "" & rsA.Fields(7).Value
'                      End If
'                  End If
'                  '2025/3/4 END


'                  If rsA.State <> adStateClosed Then rsA.Close
'                  Set rsA = Nothing
'                  Exit Function
            End Select
            'Add By Sindy 2025/3/5
            If PUB_GetA1L07Disc <> "" Then
               If rsA.State <> adStateClosed Then rsA.Close
               Set rsA = Nothing
               Exit Function
            End If
            '2025/3/5 END
      End Select
      
      '其他案件性質
      'Add by Morgan 2011/1/17
      If strCP01 = "FG" Then bolFCase = True
      If bolFCase = True Then
         stLowestDisc = "100"
         stDisc = "100"
         If rsA.Fields(0).Value > 0 Then 'PA49
            stDisc = rsA.Fields(0).Value
         End If
         '取低者
         If Val(stDisc) < Val(stLowestDisc) Then
            stLowestDisc = stDisc
         End If
         
         '代理人
         If rsA.Fields(3).Value > 0 Then 'FA25 FA73
            '若有全部折扣起始日
            If rsA.Fields(5).Value > 0 Then  'FA27 FA75
               If DBDATE(rsA.Fields(5).Value) <= Val(DBDATE(strDNDate)) Then    '2009/6/22 加=條件
                  stDisc = rsA.Fields(3).Value
               End If
            '若無全部折扣起始日
            Else
               stDisc = rsA.Fields(3).Value
            End If
         End If
         '取低者
         If Val(stDisc) < Val(stLowestDisc) Then
            stLowestDisc = stDisc
         End If
         
         '申請人
         If rsA.Fields(7).Value > 0 Then 'CU36 CU107
            '若有全部折扣起始日
            If rsA.Fields(9).Value > 0 Then  'CU38 CU109
               If DBDATE(rsA.Fields(9).Value) <= Val(DBDATE(strDNDate)) Then    '2009/6/22 加=條件
                  stDisc = rsA.Fields(7).Value
               End If
            '若無全部折扣起始日
            Else
               stDisc = rsA.Fields(7).Value
            End If
         End If
         '取低者
         If Val(stDisc) < Val(stLowestDisc) Then
            stLowestDisc = stDisc
         End If
         PUB_GetA1L07Disc = stLowestDisc
      Else
      'end 2011/1/17
         
         'Modify By Sindy 2025/3/4 增加終止日檢查
         '個案全部折扣
         If "" & rsA.Fields(0).Value <> "" Then 'PA49
            PUB_GetA1L07Disc = "" & rsA.Fields(0).Value
         End If
         '代理人全部折扣
         If PUB_GetA1L07Disc = "" And "" & rsA.Fields(3).Value <> "" Then 'FA25 FA73
            '若有全部折扣起始日
'            If "" & rsA.Fields(5).Value <> "" Then 'FA27 FA75
'               If DBDATE(rsA.Fields(5).Value) <= Val(DBDATE(strDNDate)) Then    '2009/6/22 加=條件
'                  PUB_GetA1L07Disc = "" & rsA.Fields(3).Value
'               End If
'            '若無全部折扣起始日
'            Else
            If Val(strFAStarDate) <= Val(DBDATE(strDNDate)) And Val(strFAEndDate) >= Val(DBDATE(strDNDate)) Then
               PUB_GetA1L07Disc = "" & rsA.Fields(3).Value
            End If
         End If
         '申請人全部折扣
         If PUB_GetA1L07Disc = "" And "" & rsA.Fields(7).Value <> "" Then 'CU36 CU107
            '若有全部折扣起始日
'            If "" & rsA.Fields(9).Value <> "" Then 'CU38 CU109
'               If DBDATE(rsA.Fields(9).Value) <= Val(DBDATE(strDNDate)) Then    '2009/6/22 加=條件
'                  PUB_GetA1L07Disc = "" & rsA.Fields(7).Value
'               End If
'            '若無全部折扣起始日
'            Else
            If Val(strCUStarDate) <= Val(DBDATE(strDNDate)) And Val(strCUEndDate) >= Val(DBDATE(strDNDate)) Then
               PUB_GetA1L07Disc = "" & rsA.Fields(7).Value
            End If
         End If
         '2025/3/4 END
      End If
      
   End If 'Add by Morgan 2011/1/17
   
   If rsA.State <> adStateClosed Then rsA.Close
   Set rsA = Nothing
   If PUB_GetA1L07Disc = "" Then PUB_GetA1L07Disc = "100"

End Function

'Add By Cheng 2003/09/26
'基本檔FC代理人-->基本檔申請人
Public Function PUB_GetA1K03(strCP01 As String, strCP02 As String, strCP03 As String, strCP04 As String) As String
Dim rsA As New ADODB.Recordset
Dim StrSQLa As String

PUB_GetA1K03 = ""
StrSQLa = "Select Nvl(PA75, PA26) From PATENT WHERE PA01='" & strCP01 & "' AND PA02='" & strCP02 & "' AND PA03='" & strCP03 & "' AND PA04='" & strCP04 & "' "
StrSQLa = StrSQLa & " Union Select Nvl(TM44, TM23) From Trademark WHERE TM01='" & strCP01 & "' AND TM02='" & strCP02 & "' AND TM03='" & strCP03 & "' AND TM04='" & strCP04 & "' "
StrSQLa = StrSQLa & " Union Select Nvl(LC22, LC11) From Lawcase WHERE LC01='" & strCP01 & "' AND LC02='" & strCP02 & "' AND LC03='" & strCP03 & "' AND LC04='" & strCP04 & "' "
StrSQLa = StrSQLa & " Union Select Nvl(SP26, SP08) From Servicepractice WHERE SP01='" & strCP01 & "' AND SP02='" & strCP02 & "' AND SP03='" & strCP03 & "' AND SP04='" & strCP04 & "' "
rsA.CursorLocation = adUseClient
rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
If rsA.RecordCount > 0 Then
    PUB_GetA1K03 = "" & rsA.Fields(0).Value
End If
If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing
End Function

'Add By Cheng 2003/09/26
Public Function PUB_GetA1L06Text(strA1L06 As String) As String
    Select Case strA1L06
    Case "1"
        PUB_GetA1L06Text = ", including Extension fee"
    Case "2"
        PUB_GetA1L06Text = ", including Amendment fee"
    Case "3"
        PUB_GetA1L06Text = ", including Deposition fee"
    Case "4"
        PUB_GetA1L06Text = ", including Priority fee"
    Case "5"
        PUB_GetA1L06Text = ", including Extension fee, Amendment fee"
    Case "6"
        PUB_GetA1L06Text = ", including Extension fee, Deposition fee"
    Case "7"
        PUB_GetA1L06Text = ", including Extension fee, Priority fee"
    Case "8"
        PUB_GetA1L06Text = ", including Amendment fee, Deposition fee"
    Case "9"
        PUB_GetA1L06Text = ", including Amendment fee, Priority fee"
    Case "A"
        PUB_GetA1L06Text = ", including Deposition fee, Priority fee"
    Case "B"
        PUB_GetA1L06Text = ", including Extension fee, Amendment fee, Deposition fee"
    Case "C"
        PUB_GetA1L06Text = ", including Extension fee, Amendment fee, Priority fee"
    Case "D"
        PUB_GetA1L06Text = ", including Extension fee, Deposition fee, Priority fee"
    Case "E"
        PUB_GetA1L06Text = ", including Amendment fee, Deposition fee, Priority fee"
    Case Else
        PUB_GetA1L06Text = ""
    End Select
End Function

'Add By Cheng 2003/10/20
'判斷進度檔是否有承辦人
Public Function PUB_ChkCP14IsNull(strCP09 As String) As Boolean
Dim StrSQLa As String
Dim rsA  As New ADODB.Recordset

StrSQLa = "Select * From CaseProgress Where CP09='" & strCP09 & "' And CP14 Is Null "
rsA.CursorLocation = adUseClient
rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
If rsA.RecordCount > 0 Then
    PUB_ChkCP14IsNull = True
Else
    PUB_ChkCP14IsNull = False
End If
If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing
If PUB_ChkCP14IsNull = True Then
    MsgBox "未輸入承辦人，不可發文!!!", vbExclamation + vbOKOnly
End If
End Function

'Add By Cheng 2003/11/12
'取得特殊
Public Function PUB_GetSpecialPTName(strSPT01 As String, strSPT02 As String) As String
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset

PUB_GetSpecialPTName = ""
StrSQLa = "Select * From SpecialPatentTrademark Where SPT01='" & strSPT01 & "' And SPT02='" & strSPT02 & "' "
rsA.CursorLocation = adUseClient
rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
If rsA.RecordCount > 0 Then
    PUB_GetSpecialPTName = "" & rsA("SPT03").Value
End If
If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing
End Function
'Add By Morgan 2003/11/18
'密碼加減密
Public Function Encrypt(strInput As String, bolOn As Boolean) As String
   
   Dim strOutput As String, i As Integer, iSign As Integer, ICode As Integer
   iSign = IIf(bolOn, 1, -1)
   For i = 1 To Len(strInput)
      'Modified by Morgan 2012/3/15
      'strOutput = strOutput & Chr(Asc(Mid(strInput, i, 1)) + iSign * i)
      ICode = Asc(Mid(strInput, i, 1)) + iSign * i
      If ICode < 32 Then
         ICode = ICode + 95
      ElseIf ICode > 126 Then
         ICode = ICode - 95
      End If
      strOutput = strOutput & Chr(ICode)
   Next i
   Encrypt = strOutput
            
End Function

'Add By Cheng 2003/11/21
'取得服務專線
Public Function PUB_GetServiceLine(strSalesNo As String) As String
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset
'Add by Amy 2018/09/07
Dim RsQ As New ADODB.Recordset, strQ As String
Dim strExt As String '分機

'預設台北電話
'Modified by Lydia 2017/07/27 拿掉"轉"
'PUB_GetServiceLine = "02-25061023 轉"
PUB_GetServiceLine = "02-25061023"
StrSQLa = "Select * From Staff Where ST01='" & strSalesNo & "' "
rsA.CursorLocation = adUseClient
rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
If rsA.RecordCount > 0 Then
    'Add by Amy 2018/09/07 +分機
    strQ = "Select ed01 From ExtensionData Where ed02='" & strSalesNo & "' Order by ed01"
    RsQ.CursorLocation = adUseClient
    RsQ.Open strQ, cnnConnection, adOpenStatic, adLockReadOnly
    If RsQ.RecordCount > 0 Then
        Do While RsQ.EOF = False
            strExt = strExt & "," & RsQ.Fields("ed01")
            RsQ.MoveNext
        Loop
    End If
    RsQ.Close
    If strExt <> MsgText(601) Then strExt = " 分機" & Mid(strExt, 2)
    'end 2018/09/07
'2008/2/26 modify by sonia 改依員工所屬所別判斷
'    If "" & rsA("ST15").Value >= "S2" And "" & rsA("ST15").Value <= "S29" Then
'        PUB_GetServiceLine = "04-23270288"
'    ElseIf "" & rsA("ST15").Value >= "S3" And "" & rsA("ST15").Value <= "S39" Then
'        PUB_GetServiceLine = "06-2743866"
'    ElseIf "" & rsA("ST15").Value >= "S4" And "" & rsA("ST15").Value <= "S49" Then
'        PUB_GetServiceLine = "07-2363602"
'    Else
'        PUB_GetServiceLine = "02-25061023 轉"
'    End If
    Select Case rsA("st06").Value
      Case "2"
         PUB_GetServiceLine = "04-23270288"
      Case "3"
        PUB_GetServiceLine = "06-2743866"
      Case "4"
        PUB_GetServiceLine = "07-2363602"
      Case Else
        'Modified by Lydia 2017/07/27 拿掉"轉"
        'PUB_GetServiceLine = "02-25061023 轉"
        PUB_GetServiceLine = "02-25061023"
    End Select
    PUB_GetServiceLine = PUB_GetServiceLine & strExt 'Add by Amy 2018/09/07
'2008/2/26 end
End If
If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing

End Function

'Add By Cheng 2003/11/27
'檢查是否有未發文資料
Public Function PUB_ChkUnissueDatas(strCaseNo As String) As Boolean
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset
    
strCaseNo = Replace(strCaseNo, " ", "")
strCaseNo = Replace(strCaseNo, "-", "")
'Modify by Morgan 2004/2/20
'加控制 CFP 包括 C 類收文
If InStr(strCaseNo, "CFP") > 0 Then
    StrSQLa = "Select * From CaseProgress Where " & ChgCaseprogress(strCaseNo) & " And CP27 Is Null And CP57 Is Null"
Else
    StrSQLa = "Select * From CaseProgress Where " & ChgCaseprogress(strCaseNo) & " And CP27 Is Null And CP57 Is Null And CP09<'C' "
End If
rsA.CursorLocation = adUseClient
rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
If rsA.RecordCount > 0 Then
    PUB_ChkUnissueDatas = True
Else
    PUB_ChkUnissueDatas = False
End If
If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing
End Function

'Add by Morgan 2003/12/07
'檢查目前收文之智權人員是否與 'A' 類前一筆不同
Public Sub PUB_CheckSales(stCP01 As String, stCP02 As String, stCP03 As String, stCP04 As String, stCP05 As String _
   , stCP13 As String, stSales As String)

   Dim strSql As String, adoquery As New ADODB.Recordset
   
   strSql = " select st02 From caseprogress, staff" & _
            " where cp01='" & stCP01 & "' and cp02='" & stCP02 & "' and cp03='" & stCP03 & "' and cp04='" & stCP04 & "'" & _
            " and cp05<" & Val(stCP05) + 19110000 & " and substr(cp09,1)='A' and cp13<>'" & stCP13 & "' and st01=cp13 and st04='1'" & _
            " order by cp05 desc"
   
   adoquery.CursorLocation = adUseClient
   adoquery.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If adoquery.RecordCount > 0 Then
      MsgBox "此客戶本案收文之智權人員為〔" & stSales & "〕，以前負責智權人員為〔" & adoquery.Fields(0).Value & "〕！", vbInformation
   End If
   adoquery.Close
   Set adoquery = Nothing

End Sub

''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' 取得員工的部門別
' Input : strStuff ==> 員工的代碼
' Output : 傳回員工所屬的部門別
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
'Modify by Amy 2020/12/23 +bolST15回傳st15
'Modify By Sindy 2025/2/25 +, Optional bolST93 As Boolean = False: True=回傳st93,但若無值則回傳st03
Public Function GetStaffDepartment(ByVal strStuff As String, Optional bolST15 As Boolean = False _
   , Optional bolST93 As Boolean = False) As String
   Dim rsTmp As New ADODB.Recordset
   Dim strSql As String
   
   GetStaffDepartment = Empty
   strSql = "SELECT * FROM Staff " & _
            "WHERE ST01 = '" & strStuff & "' "
   rsTmp.CursorLocation = adUseClient
   rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If rsTmp.RecordCount > 0 Then
      rsTmp.MoveFirst
      'Modify By Sindy 2025/2/25
      If bolST93 = True Then
         If "" & rsTmp.Fields("ST93") <> "" Then
            GetStaffDepartment = "" & rsTmp.Fields("ST93")
         Else
            GetStaffDepartment = rsTmp.Fields("ST03")
         End If
      Else
      '2025/2/25 END
         'Modify by Amy 2020/12/23
         If bolST15 = True Then
            GetStaffDepartment = "" & rsTmp.Fields("ST15")
         ElseIf IsNull(rsTmp.Fields("ST03")) = False Then
         'end 2020/12/23
            GetStaffDepartment = rsTmp.Fields("ST03")
         End If
      End If
   End If
   rsTmp.Close
   Set rsTmp = Nothing
End Function
'Move from basPublic by Morgan 2004/3/12
'秀出錯誤訊息
Public Sub ErrorMsg()
If Err.Number Then
   ShowMsg MsgText(9207) + Format(Err.Number) + vbLf + MsgText(9208) + Err.Description
End If
End Sub
'Move from basPublic by Morgan 2004/3/12
'將中英文名稱設給Combo
'Modified by Morgan 2021/5/6
'Public Sub SetNameToCombo(ByRef cboTemp As ComboBox, strTemp1 As String, strTemp2 As String, strTemp3 As String)
Public Sub SetNameToCombo(ByRef cboTemp, strTemp1 As String, strTemp2 As String, strTemp3 As String)
cboTemp.Clear

If strTemp1 <> "" Then
   cboTemp.AddItem "中：" + strTemp1
End If
If strTemp2 <> "" Then
   cboTemp.AddItem "英：" + strTemp2
End If
If strTemp3 <> "" Then
   cboTemp.AddItem "日：" + strTemp3
End If
If cboTemp.ListCount > 0 Then cboTemp.ListIndex = 0
End Sub

'Add By Cheng 2004/04/14
'更新分割案件關係資料
Public Function PUB_UpdateDivisionCase(strDC01 As String, strDC02 As String, strDC03 As String, strDC04 As String, strDC05 As String, strDC06 As String, strDC07 As String, strDC08 As String) As Boolean
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset

On Error GoTo ErrorHandler
PUB_UpdateDivisionCase = False
'若未傳母案資料
If strDC05 = "" Then
    StrSQLa = "Delete From DivisionCase Where DC01='" & strDC01 & "' And DC02='" & strDC02 & "' And DC03='" & strDC03 & "' And DC04='" & strDC04 & "' "
    cnnConnection.Execute StrSQLa
    PUB_UpdateDivisionCase = True
'若有傳母案資料
Else
    StrSQLa = "Select * From DivisionCase Where DC01='" & strDC01 & "' And DC02='" & strDC02 & "' And DC03='" & strDC03 & "' And DC04='" & strDC04 & "' "
    rsA.CursorLocation = adUseClient
    rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
    If rsA.RecordCount > 0 Then
        StrSQLa = "Update DivisionCase Set DC05='" & strDC05 & "', DC06='" & strDC06 & "', DC07='" & strDC07 & "', DC08='" & strDC08 & "' Where  DC01='" & strDC01 & "' And DC02='" & strDC02 & "' And DC03='" & strDC03 & "' And DC04='" & strDC04 & "' "
        cnnConnection.Execute StrSQLa
        PUB_UpdateDivisionCase = True
    Else
        StrSQLa = "Insert Into DivisionCase (DC01,DC02,DC03,DC04,DC05,DC06,DC07,DC08,DC09,DC10,DC11) values ('" & strDC01 & "','" & strDC02 & "','" & strDC03 & "','" & strDC04 & "','" & strDC05 & "','" & strDC06 & "','" & strDC07 & "','" & strDC08 & "','" & strUserNum & "','" & strSrvDate(1) & "','" & ServerTime & "')"
        cnnConnection.Execute StrSQLa
        PUB_UpdateDivisionCase = True
    End If
    If rsA.State <> adStateClosed Then rsA.Close
    Set rsA = Nothing
End If
Exit Function
ErrorHandler:
    If rsA.State <> adStateClosed Then rsA.Close
    Set rsA = Nothing
    PUB_UpdateDivisionCase = False
End Function

'Add By Cheng 2004/04/23
Public Function PUB_ChgFormat(strDollar As String, blnComma As Boolean) As String
'strDollar : 傳入的金額
'blnComma : 格式是否加Comma

If Val(strDollar) = 0 Then
    PUB_ChgFormat = "0"
Else
    '若小數位為0
    If Val(strDollar) - Fix(Val(strDollar)) = 0 Then
        PUB_ChgFormat = Format(strDollar, IIf(blnComma = True, "#,##0", "##0"))
    '若小數位非0
    Else
        PUB_ChgFormat = Format(strDollar, IIf(blnComma = True, "#,##0.00", "##0.00"))
    End If
End If

End Function

'Add by Morgan 2004/6/29 檢查改請案是否已核准或逾核駁日60天
Public Function PUB_Check301(strCP01 As String, strCP02 As String, strCP03 As String, strCP04 As String) As Boolean

   PUB_Check301 = False
   strSql = "Select PA09, PA16, PA20, TO_CHAR(SYSDATE-60,'YYYYMMDD') DL  From Patent Where " & ChgPatent(strCP01 & strCP02 & strCP03 & strCP04)
   
On Error GoTo ErrHnd
   
   CheckOC
   With adoRecordset
      .CursorLocation = adUseClient
      .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      '若有資料
      If .RecordCount > 0 Then
         If ("" & .Fields("PA09")) = "000" Then
            '未有准駁日
            If IsNull(.Fields("PA20")) Then
               PUB_Check301 = True
            ElseIf "" & (.Fields("PA16")) = "1" Then
               MsgBox "原案已核准，改請案不可收發文！", vbCritical
            '逾准駁日60天
            ElseIf Val(.Fields("DL")) > Val(.Fields("PA20")) Then
               'Modified by Morgan 2011/12/21 無法判斷是否為核駁確認改提醒 P-83012--玲玲
               'MsgBox "原案核駁日為 " & ChangeTStringToTDateString(.Fields("PA20") - 19110000) & " 已逾 60 天，改請案不可收發文！", vbCritical
               If MsgBox("原案核駁日為 " & ChangeTStringToTDateString(.Fields("PA20") - 19110000) & " 已逾 60 天，因系統無法判斷是否為核駁確認請人工檢查！" & vbCrLf & "是否要繼續??", vbYesNo + vbDefaultButton2, vbCritical) = vbYes Then
                  PUB_Check301 = True
               End If
            Else
               PUB_Check301 = True
            End If
         '非台灣案
         Else
            PUB_Check301 = True
         End If
      End If
      
   End With
   CheckOC
   
ErrHnd:

   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
   
End Function

'Add by Morgan 2004/6/8
'檢查一案二申請
Public Function PUB_DualCaseExist(ByRef stPA1() As String, ByRef stPA2 As String) As Boolean
   Dim stCon As String
On Error GoTo ErrHnd
   'Modified by Morgan 2013/7/9
   'FCP不必管案件名稱
   If stPA1(1) <> "FCP" Then
      stCon = " AND PA1.PA05=PA2.PA05(+) AND PA1.PA06=PA2.PA06(+) AND PA1.PA07=PA2.PA07(+) "
   End If
   'end 2013/7/9
   
   'Modified by Morgan 2014/2/19 +專利種類為發明或新型
   strSql = "SELECT PA2.PA01,PA2.PA02,PA2.PA03,PA2.PA04 FROM PATENT PA1, CASEPROGRESS CP1, PATENT PA2, CASEPROGRESS CP2" & _
      " WHERE PA1.PA01='" & stPA1(1) & "' AND PA1.PA02='" & stPA1(2) & "' AND PA1.PA03='" & stPA1(3) & "' AND PA1.PA04='" & stPA1(4) & "'" & _
      " AND PA1.PA01=CP1.CP01(+) AND PA1.PA02=CP1.CP02(+) AND PA1.PA03=CP1.CP03(+) AND PA1.PA04=CP1.CP04(+) AND CP1.CP31='Y'" & _
      " AND PA1.PA26=PA2.PA26(+) AND PA1.PA09=PA2.PA09(+)" & stCon & _
      " AND PA2.PA01=CP2.CP01(+) AND PA2.PA02=CP2.CP02(+) AND PA2.PA03=CP2.CP03(+) AND PA2.PA04=CP2.CP04(+) AND CP2.CP31='Y'" & _
      " AND CP2.CP05=CP1.CP05 AND PA1.PA08<>PA2.PA08 AND (PA1.PA08='1' OR PA1.PA08='2') AND (PA2.PA08='1' OR PA2.PA08='2')"
      
   CheckOC
   adoRecordset.CursorLocation = adUseClient
   adoRecordset.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If adoRecordset.RecordCount > 0 Then
      stPA2 = "" & adoRecordset.Fields("PA01") & "-" & adoRecordset.Fields("PA02") & "-" & adoRecordset.Fields("PA03") & "-" & adoRecordset.Fields("PA04")
      PUB_DualCaseExist = True
   End If
   
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
   CheckOC
End Function
'Add by Morgan 2004/6/8
'檢查一案二申請關聯
Public Function PUB_DualCaseRelationExist(ByRef stPA1() As String) As Boolean
On Error GoTo ErrHnd
   strSql = "SELECT 1 FROM CASEMAP" & _
      " WHERE CM10='3'" & _
      " AND ( ( CM01='" & stPA1(1) & "' AND CM02='" & stPA1(2) & "' AND CM03='" & stPA1(3) & "' AND CM04='" & stPA1(4) & "') " & _
      " OR ( CM05='" & stPA1(1) & "' AND CM06='" & stPA1(2) & "' AND CM07='" & stPA1(3) & "' AND CM08='" & stPA1(4) & "') )"
      
   CheckOC
   adoRecordset.CursorLocation = adUseClient
   adoRecordset.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If adoRecordset.RecordCount > 0 Then
      PUB_DualCaseRelationExist = True
   End If
   
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
   CheckOC
End Function


'Move from Cls003.ChkExist by Morgan 2004/6/11
Public Function PUB_ChkExist(ByRef strCode() As String, ByVal iSitu As Integer, Optional ByVal bolMsg As Boolean = True) As Boolean

On Error GoTo ErrHnd
   strCode(2) = IIf(strCode(2) = "", "0", strCode(2))
   strCode(3) = IIf(strCode(3) = "", "00", strCode(3))
   strCode(6) = IIf(strCode(6) = "", "0", strCode(6))
   strCode(7) = IIf(strCode(7) = "", "00", strCode(7))
   strSql = "select count(*) from casemap where cm01=" + CNULL(strCode(0)) + " and cm02=" + CNULL(strCode(1)) + _
      " and cm03=" + CNULL(strCode(2)) + " and cm04=" + CNULL(strCode(3)) + " and cm05=" + CNULL(strCode(4)) + _
      " and cm06=" + CNULL(strCode(5)) + " and cm07=" + CNULL(strCode(6)) + " and cm08=" + CNULL(strCode(7)) + _
      " and cm10='" & iSitu & "'"
   CheckOC
   adoRecordset.CursorLocation = adUseClient
   adoRecordset.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If adoRecordset.Fields(0) = 0 Then
      If bolMsg Then ShowMsg "案件關聯資料不存在，請重新輸入 !"
   Else
      PUB_ChkExist = True
   End If
   
ErrHnd:

   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
   
   
End Function
'Move from Cls003.DeleteCaseRelation by Morgan 2004/6/11
'刪除國內外案件關聯表之資料
'iSitu 0 國內外案件資料維護資料 1 讀取美國IDS資料 2 大陸發明
'Modified by Morgan 2017/10/13 +pInTrans
Public Function PUB_DeleteCaseRelation(ByRef strCode() As String, ByVal iSitu As Integer, Optional pInTrans As Boolean = True) As Boolean
'Added by Lydia 2016/10/19
Dim tmpCM1(1 To 4) As String '發明案號
Dim tmpCM2(1 To 4) As String '新型案號
Dim rsTmp As New ADODB.Recordset
Dim strQ1 As String
Dim bolNewTrans As Boolean 'Added by Morgan 2017/8/17

On Error GoTo ErrHnd

   Dim i As Integer
   
   'Added by Lydia 2016/10/19 一案兩請的關聯取消時,將新型之加乘註記自動恢復為原有的加乘註記"1"。(frm040109_2 新增一案兩請之新型的加乘註記為0.5 )
   If iSitu = 3 Then
      tmpCM1(1) = strCode(0): tmpCM1(2) = strCode(1): tmpCM1(3) = strCode(2): tmpCM1(4) = strCode(3)
      '抓新型案號
      If Trim(strCode(4) & strCode(5)) = "" Then
         If PUB_IsDualApply(tmpCM1, tmpCM2) Then
         End If
      Else
         If PUB_IsDualApply(tmpCM1, tmpCM2) Then
         Else
            tmpCM1(1) = strCode(4): tmpCM1(2) = strCode(5): tmpCM1(3) = strCode(6): tmpCM1(4) = strCode(7)
            If PUB_IsDualApply(tmpCM1, tmpCM2) Then
            End If
         End If
      End If
      
      '一案兩請的發明案關聯取消,將未發文新型案之加乘註記恢復
      If Trim(tmpCM2(1) & tmpCM2(2) & tmpCM2(3) & tmpCM2(4)) <> "" Then
         '承辦人加乘註記 , 還原log檔的加乘註記
         'Modified by Morgan 2022/5/27 改判斷最後修改紀錄是 "@一案兩請" 開頭
         'strQ1 = "select cp09,cp98,fs05 as oflag from patent,caseprogress,flagstory where pa01='" & tmpCM2(1) & "' and pa02='" & tmpCM2(2) & "' and pa03='" & tmpCM2(3) & "' and pa04='" & tmpCM2(4) & "' " & _
                 "and pa01=cp01(+) and pa02=cp02(+) and pa03=cp03(+) and pa04=cp04(+) and cp10='102' and cp158=0 " & _
                 "and cp09=fs01(+) and fs04='1' and nvl(fs06,0) > 0 and nvl(fs07,'0')='0' " & _
                 "and not exists(select b.* from flagstory b where b.fs01=cp09 and b.fs04='1' and nvl(b.fs07,'0')<>'0') "
         strQ1 = "select cp09,cp98,fs05 as oflag,fs01,fs02,fs03,fs04 from patent,caseprogress,flagstory a where pa01='" & tmpCM2(1) & "' and pa02='" & tmpCM2(2) & "' and pa03='" & tmpCM2(3) & "' and pa04='" & tmpCM2(4) & "' " & _
                 "and pa01=cp01(+) and pa02=cp02(+) and pa03=cp03(+) and pa04=cp04(+) and cp10='102' and cp158=0 " & _
                 "and cp09=fs01(+) and fs04='1' and nvl(fs06,0) > 0 and instr(fs07,'@一案兩請')=1 " & _
                 "and not exists(select b.* from flagstory b where b.fs01=cp09 and b.fs04='1' and fs02||lpad(fs03,6,'0')>a.fs02||lpad(a.fs03,6,'0')) "
         i = 1
         Set rsTmp = ClsLawReadRstMsg(i, strQ1)
         If i = 1 Then
            strSql = "update caseprogress set cp98=" & rsTmp.Fields("oflag") & " where cp09='" & rsTmp.Fields("cp09") & "'"
            cnnConnection.Execute strSql
            'Modified by Morgan 2022/5/27 還原應該要刪除註記，否則重建或刪除他案關聯時會判斷錯誤
            'Call PUB_InsFlagStory(rsTmp.Fields("cp09"), "1", rsTmp.Fields("cp98"), rsTmp.Fields("oflag"), "")
            strSql = "delete flagstory where fs01='" & rsTmp("fs01") & "' and fs02=" & rsTmp("fs02") & " and fs03=" & rsTmp("fs03") & " and fs04='" & rsTmp("fs04") & "'"
            cnnConnection.Execute strSql, i
            'end 2022/5/27
         End If
         '草圖加乘註記 , 還原log檔的加乘註記
         'Modified by Morgan 2022/5/27 改判斷最後修改紀錄是 "@一案兩請" 開頭
         'strQ1 = "select cp09,cp101,fs05 as oflag from patent,caseprogress,flagstory where pa01='" & tmpCM2(1) & "' and pa02='" & tmpCM2(2) & "' and pa03='" & tmpCM2(3) & "' and pa04='" & tmpCM2(4) & "' " & _
                 "and pa01=cp01(+) and pa02=cp02(+) and pa03=cp03(+) and pa04=cp04(+) and cp10='102' and cp158=0 " & _
                 "and cp09=fs01(+) and fs04='2' and nvl(fs06,0) > 0 and nvl(fs07,'0')='0' " & _
                 "and not exists(select b.* from flagstory b where b.fs01=cp09 and b.fs04='2' and nvl(b.fs07,'0')<>'0') "
         strQ1 = "select cp09,cp101,fs05 as oflag,fs01,fs02,fs03,fs04  from patent,caseprogress,flagstory a where pa01='" & tmpCM2(1) & "' and pa02='" & tmpCM2(2) & "' and pa03='" & tmpCM2(3) & "' and pa04='" & tmpCM2(4) & "' " & _
                 "and pa01=cp01(+) and pa02=cp02(+) and pa03=cp03(+) and pa04=cp04(+) and cp10='102' and cp158=0 " & _
                 "and cp09=fs01(+) and fs04='2' and nvl(fs06,0) > 0 and instr(fs07,'@一案兩請')=1 " & _
                 "and not exists(select b.* from flagstory b where b.fs01=cp09 and b.fs04='2' and fs02||lpad(fs03,6,'0')>a.fs02||lpad(a.fs03,6,'0')) "
         i = 1
         Set rsTmp = ClsLawReadRstMsg(i, strQ1)
         If i = 1 Then
            strSql = "update caseprogress set cp101=" & rsTmp.Fields("oflag") & " where cp09='" & rsTmp.Fields("cp09") & "'"
            cnnConnection.Execute strSql
            'Modified by Morgan 2022/5/27 還原應該要刪除註記，否則重建或刪除他案關聯時會判斷錯誤
            'Call PUB_InsFlagStory(rsTmp.Fields("cp09"), "2", rsTmp.Fields("cp101"), rsTmp.Fields("oflag"), "")
            strSql = "delete flagstory where fs01='" & rsTmp("fs01") & "' and fs02=" & rsTmp("fs02") & " and fs03=" & rsTmp("fs03") & " and fs04='" & rsTmp("fs04") & "'"
            cnnConnection.Execute strSql, i
            'end 2022/5/27
         End If
         '墨圖加乘註記 , 還原log檔的加乘註記
         'Modified by Morgan 2022/5/27 改判斷最後修改紀錄是 "@一案兩請" 開頭
         'strQ1 = "select cp09,cp104,fs05 as oflag from patent,caseprogress,flagstory where pa01='" & tmpCM2(1) & "' and pa02='" & tmpCM2(2) & "' and pa03='" & tmpCM2(3) & "' and pa04='" & tmpCM2(4) & "' " & _
                 "and pa01=cp01(+) and pa02=cp02(+) and pa03=cp03(+) and pa04=cp04(+) and cp10='102' and cp158=0 " & _
                 "and cp09=fs01(+) and fs04='3' and nvl(fs06,0) > 0 and nvl(fs07,'0')='0' " & _
                 "and not exists(select b.* from flagstory b where b.fs01=cp09 and b.fs04='3' and nvl(b.fs07,'0')<>'0') "
         strQ1 = "select cp09,cp104,fs05 as oflag,fs01,fs02,fs03,fs04 from patent,caseprogress,flagstory a where pa01='" & tmpCM2(1) & "' and pa02='" & tmpCM2(2) & "' and pa03='" & tmpCM2(3) & "' and pa04='" & tmpCM2(4) & "' " & _
                 "and pa01=cp01(+) and pa02=cp02(+) and pa03=cp03(+) and pa04=cp04(+) and cp10='102' and cp158=0 " & _
                 "and cp09=fs01(+) and fs04='3' and nvl(fs06,0) > 0 and instr(fs07,'@一案兩請')=1 " & _
                 "and not exists(select b.* from flagstory b where b.fs01=cp09 and b.fs04='3' and fs02||lpad(fs03,6,'0')>a.fs02||lpad(a.fs03,6,'0')) "
         i = 1
         Set rsTmp = ClsLawReadRstMsg(i, strQ1)
         If i = 1 Then
            strSql = "update caseprogress set cp104=" & rsTmp.Fields("oflag") & " where cp09='" & rsTmp.Fields("cp09") & "'"
            cnnConnection.Execute strSql
            'Modified by Morgan 2022/5/27 還原應該要刪除註記，否則重建或刪除他案關聯時會判斷錯誤
            'Call PUB_InsFlagStory(rsTmp.Fields("cp09"), "3", rsTmp.Fields("cp104"), rsTmp.Fields("oflag"), "")
            strSql = "delete flagstory where fs01='" & rsTmp("fs01") & "' and fs02=" & rsTmp("fs02") & " and fs03=" & rsTmp("fs03") & " and fs04='" & rsTmp("fs04") & "'"
            cnnConnection.Execute strSql, i
            'end 2022/5/27
         End If
      End If
   End If
   'end 2016/10/19
   
   strCode(2) = IIf(strCode(2) = "", "0", strCode(2))
   strCode(3) = IIf(strCode(3) = "", "00", strCode(3))
   strCode(6) = IIf(strCode(6) = "", "0", strCode(6))
   strCode(7) = IIf(strCode(7) = "", "00", strCode(7))
   
   'Added by Lydia 2016/10/19 新案(101,102)銷案時,取消一案兩請關聯
   If Trim(strCode(4) & strCode(5)) = "" Then
      strSql = "delete from casemap where ((cm01=" + CNULL(strCode(0)) + " and cm02=" + CNULL(strCode(1)) + " and cm03=" + CNULL(strCode(2)) + " and cm04=" + CNULL(strCode(3)) + ") or (cm05=" + CNULL(strCode(0)) + " and cm06=" + CNULL(strCode(1)) + " and cm07=" + CNULL(strCode(2)) + " and cm08=" + CNULL(strCode(3)) + ")) and cm10='" & iSitu & "'"
   Else
   'end 2016/10/19
      strSql = "delete from casemap where cm01=" + CNULL(strCode(0)) + " and cm02=" + CNULL(strCode(1)) + " and cm03=" + CNULL(strCode(2)) + " and cm04=" + CNULL(strCode(3)) + " and cm05=" + CNULL(strCode(4)) + " and cm06=" + CNULL(strCode(5)) + " and cm07=" + CNULL(strCode(6)) + " and cm08=" + CNULL(strCode(7)) + " and cm10='" & iSitu & "'"
   End If
   
   'Modified by Morgan 2017/8/17 FCP一案兩請解除關聯要檢查發明是否有"非屬相同創作來"函,若有則須於基本檔加案件備註
   'cnnConnection.Execute strSql, i
   If Not pInTrans Then 'Added by Morgan 2017/10/13 需判斷外層沒有 Transaction
      cnnConnection.BeginTrans
      bolNewTrans = True
   End If
   
   cnnConnection.Execute strSql, i
   'Modified by Morgan 2020/2/24 +寰華案(外專人員操作)--敏莉
   'If iSitu = 3 And strCode(0) = "FCP" Then
   If iSitu = 3 And (strCode(0) = "FCP" Or (strCode(0) = "P" And Left(Pub_StrUserSt03, 1) = "F")) Then
   'end 2020/2/24
      strQ1 = "select SNO" & _
         " from (select '1' SNO,pa01,pa02,pa03,pa04 from patent where pa01='" & strCode(0) & "' and pa02='" & strCode(1) & "' and pa03='" & strCode(2) & "' and pa04='" & strCode(3) & "' and pa08='1'" & _
         " union all select '2' SNO,pa01,pa02,pa03,pa04 from patent where pa01='" & strCode(4) & "' and pa02='" & strCode(5) & "' and pa03='" & strCode(6) & "' and pa04='" & strCode(7) & "' and pa08='1')"
      'Added by Morgan 2020/2/24 大陸案要有陳述意見發文--敏莉
      If strCode(0) = "P" And Left(Pub_StrUserSt03, 1) = "F" Then
         strQ1 = strQ1 & " where exists(select * from caseprogress where cp01=pa01 and cp02=pa02 and cp03=pa03 and cp04=pa04 and cp10='205' and cp27>0 and cp159=0)"
      Else
         strQ1 = strQ1 & " where exists(select * from caseprogress where cp01=pa01 and cp02=pa02 and cp03=pa03 and cp04=pa04 and cp10='1919')"
      End If 'Added by Morgan 2020/2/24
      intI = 1
      Set rsTmp = ClsLawReadRstMsg(intI, strQ1)
      If intI = 1 Then
         If rsTmp(0) = "1" Then
            strExc(1) = "新型" & strCode(4) & "-" & strCode(5) & IIf(strCode(6) & strCode(7) = "000", "", "-" & strCode(6) & "-" & strCode(7))
            strExc(2) = "發明" & strCode(0) & "-" & strCode(1) & IIf(strCode(2) & strCode(3) = "000", "", "-" & strCode(2) & "-" & strCode(3))
         Else
            strExc(1) = "發明" & strCode(4) & "-" & strCode(5) & IIf(strCode(6) & strCode(7) = "000", "", "-" & strCode(6) & "-" & strCode(7))
            strExc(2) = "新型" & strCode(0) & "-" & strCode(1) & IIf(strCode(2) & strCode(3) = "000", "", "-" & strCode(2) & "-" & strCode(3))
         End If
         
         strSql = "update patent set pa91=to_char(sysdate,'yyyy/mm/dd')||'解除與" & strExc(1) & "一案兩請關聯; '||pa91" & _
            " where pa01='" & strCode(0) & "' and pa02='" & strCode(1) & "' and pa03='" & strCode(2) & "' and pa04='" & strCode(3) & "'"
         cnnConnection.Execute strSql, intI
            
         strSql = "update patent set pa91=to_char(sysdate,'yyyy/mm/dd')||'解除與" & strExc(2) & "一案兩請關聯; '||pa91" & _
            " where pa01='" & strCode(4) & "' and pa02='" & strCode(5) & "' and pa03='" & strCode(6) & "' and pa04='" & strCode(7) & "'"
         cnnConnection.Execute strSql, intI
      End If
   End If
   
   If bolNewTrans Then
      cnnConnection.CommitTrans
      bolNewTrans = False
   End If
   'end 2017/8/17
   
   If i = 0 Then
      'Modified by Lydia 2016/10/19
      'ShowMsg MsgText(1007)
      Select Case iSitu
          Case 0: strQ1 = "國內外案件關聯不存在"
          Case 1: strQ1 = "美國IDS案件關聯不存在"
          Case 2: strQ1 = "大陸發明案件關聯不存在"
          Case 3: strQ1 = "一案二申請案件關聯不存在"
          Case 4: strQ1 = "香港大陸案件關聯不存在"
          Case 5: strQ1 = "澳門大陸案件關聯不存在"
          Case 6: strQ1 = "擬制喪失新穎性案件關聯不存在"
          Case Else: strQ1 = "案件關聯不存在"
      End Select
      MsgBox strQ1 + "!", vbCritical + vbOKOnly, MsgText(9001)
      'end 2016/10/19
   Else
      PUB_DeleteCaseRelation = True
   End If

ErrHnd:
   If bolNewTrans Then cnnConnection.RollbackTrans 'Added by Morgan 2017/8/17
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
   
End Function
'Move from Cls003.ChkCaseMap by Morgan 2004/6/11
Public Function PUB_ChkCaseMap(ByRef strCode() As String, Optional ByVal iSitu As Integer = 3) As Boolean

On Error GoTo ErrHnd

   Dim strWhich As String
   Dim strTmp1(0 To 3) As String, strTmp2(0 To 3) As String, i As Integer
   
   PUB_ChkCaseMap = False
   
   strCode(2) = IIf(strCode(2) = "", "0", strCode(2))
   strCode(3) = IIf(strCode(3) = "", "00", strCode(3))
   strCode(6) = IIf(strCode(6) = "", "0", strCode(6))
   strCode(7) = IIf(strCode(7) = "", "00", strCode(7))
   Select Case iSitu
      Case 0
         strWhich = "國內外"
      Case 1
         strWhich = "美國 IDS"
      Case 2
         strWhich = "CF"
      Case 3
         strWhich = "一案兩申請"
      'Added by Morgan 2015/9/10
      Case 6
         strWhich = "擬制喪失新穎性"
   End Select
   strSql = "select cm10 from casemap where cm01=" + CNULL(strCode(0)) + " and cm02=" + CNULL(strCode(1)) + _
      " and cm03=" + CNULL(strCode(2)) + " and cm04=" + CNULL(strCode(3)) + " and cm05=" + CNULL(strCode(4)) + _
      " and cm06=" + CNULL(strCode(5)) + " and cm07=" + CNULL(strCode(6)) + " and cm08=" + CNULL(strCode(7)) + _
      " and cm10='" & iSitu & "'"
   
   strSql = strSql & " union all " & _
      " select cm10 from casemap where cm01=" + CNULL(strCode(4)) + " and cm02=" + CNULL(strCode(5)) + _
      " and cm03=" + CNULL(strCode(6)) + " and cm04=" + CNULL(strCode(7)) + " and cm05=" + CNULL(strCode(0)) + _
      " and cm06=" + CNULL(strCode(1)) + " and cm07=" + CNULL(strCode(2)) + " and cm08=" + CNULL(strCode(3)) + _
      " and cm10='" & iSitu & "'"
      
   CheckOC
   adoRecordset.CursorLocation = adUseClient
   adoRecordset.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If adoRecordset.RecordCount > 0 Then
      ShowMsg strWhich & "案件關聯資料已存在，請重新輸入 !"
   'Added by Morgan 2018/6/13
   ElseIf strCode(0) = strCode(4) And strCode(1) = strCode(5) And strCode(2) = strCode(6) And strCode(3) = strCode(7) Then
      MsgBox "相同案號不可建關聯！", vbCritical
   'end 2018/6/13
   Else
      For i = 0 To 3
         strTmp1(i) = strCode(i)
      Next
      For i = 0 To 3
         strTmp2(i) = strCode(i + 4)
      Next
      Select Case iSitu
         'Case 0, 1, 2  先不COPY
         'Modified by Morgan 2015/9/10 +擬制喪失新穎性 6
         Case 3, 6
            'Modify by Morgan 2005/11/23 不同申請人也要可以
            strSql = "select PA1.PA08 A1,PA1.PA09 A2,PA1.PA26 A3,PA2.PA08 B1,PA2.PA09 B2,PA2.PA26 B3" & _
               " from patent PA1, PATENT PA2" & _
               " where PA1.pa01=" + CNULL(strCode(0)) + " and PA1.pa02=" + CNULL(strCode(1)) + _
               " and PA1.pa03=" + CNULL(strCode(2)) + " and PA1.pa04=" + CNULL(strCode(3)) & _
               " AND PA2.pa01=" + CNULL(strCode(4)) + " and PA2.pa02=" + CNULL(strCode(5)) + _
               " and PA2.pa03=" + CNULL(strCode(6)) + " and PA2.pa04=" + CNULL(strCode(7))
            CheckOC
            adoRecordset.CursorLocation = adUseClient
            adoRecordset.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
            If adoRecordset.Fields(0) > 0 Then
               If adoRecordset.Fields("A2") <> adoRecordset.Fields("B2") Then
                  MsgBox "兩案必須相同申請國家才可建關聯！", vbCritical
               ElseIf iSitu = 3 And adoRecordset.Fields("A1") = adoRecordset.Fields("B1") Then
                  MsgBox "兩案必須不同專利種類才可建關聯！", vbCritical
               'Modified by Morgan 2018/10/16 取消--玲玲 Ex: P-121271,P-119897
               'ElseIf iSitu = 6 And adoRecordset.Fields("A1") <> adoRecordset.Fields("B1") Then
               '   MsgBox "兩案必須相同專利種類才可建關聯！", vbCritical
               'end 2018/10/16
               ElseIf adoRecordset.Fields("A3") <> adoRecordset.Fields("B3") Then
                  If MsgBox("兩案申請人不同，是否確定要建關聯？", vbQuestion + vbYesNo + vbDefaultButton2) = vbYes Then
                     PUB_ChkCaseMap = True
                  End If
               Else
                  PUB_ChkCaseMap = True
               End If
            End If
            '2005/11/23 END
      End Select
   End If
   
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
   CheckOC
End Function

'Add by Morgan 2004/6/15
'檢查案件性質是否已收文
'iState:0=不控制,1=未發文, 2=已發文
'Modified by Lydia 2018/03/01 + cKind : 區分收文類別
'Modify by Sindy 2018/8/14 + Optional ByRef stCP27 As String:回傳發文日
Public Function PUB_ChkCPExist(ByRef cp() As String, ByVal stCP10 As String, Optional ByVal iState As Integer = 0, _
   Optional ByRef stCP09 As String, Optional ByRef stCP14 As String, Optional ByRef cKind As String = "", _
   Optional ByRef stCP27 As String, Optional ByVal stCP43 As String) As Boolean
   
   'Added by Morgan 2025/8/7
   Dim strSql As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   'end 2025/8/7

   'Add by Morgan 2004/8/11
   stCP09 = "": stCP14 = ""
   stCP27 = "" 'Add By Sindy 2018/8/14
   
On Error GoTo ErrHnd
   'Modify by Morgan 2006/9/18 加控制未取消收文
   strSql = "select cp09,cp14,cp27 from caseprogress a where cp01='" & cp(1) & "' and cp02='" & cp(2) & "' and cp03='" & cp(3) & "' and cp04='" & cp(4) & "' and cp10='" & stCP10 & "' and cp57 is null"

   If iState = 1 Then
      strSql = strSql & " and CP27 IS NULL"
   'Add by Morgan 2004/8/5
   ElseIf iState = 2 Then
      strSql = strSql & " and CP27 IS NOT NULL"
   End If
   
   'Added by Lydia 2018/03/01 區分收文類別
   If cKind <> "" Then
        strSql = strSql & " and substr(cp09,1,1)='" & cKind & "' "
   End If
   'end 2018/03/01
   
   'Added by Morgan 2023/12/7
   If stCP43 <> "" Then
      strSql = strSql & " and CP43='" & stCP43 & "' "
   End If
   'end 2023/12/7
   
   'Modified by Morgan 2025/8/7
   'CheckOC
   'adoRecordset.CursorLocation = adUseClient
   'adoRecordset.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   'If adoRecordset.RecordCount > 0 Then
   '   stCP09 = "" & adoRecordset.Fields("cp09")
   '   stCP14 = "" & adoRecordset.Fields("cp14")
   '   stCP27 = "" & adoRecordset.Fields("cp27") 'Add By Sindy 2018/8/14
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, strSql)
   If intQ = 1 Then
      stCP09 = "" & rsQuery("cp09")
      stCP14 = "" & rsQuery("cp14")
      stCP27 = "" & rsQuery("cp27")
   'end 2025/8/7
   
      PUB_ChkCPExist = True
   End If
   
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
   
   'Modified by Morgan 2025/8/7
   'CheckOC
   Set rsQuery = Nothing
   'end 2025/8/7
End Function
'Add by Morgan 2004/6/15
'檢查是否已被主張國內優先權
'stPD06:優先權號(申請案號), stCaseNo(回傳):主張優先權的本所案號, bolOver:是否自優先權日起逾15個月
'Modified by Modified by Morgan 2014/12/17 +bolAppled:已送件
Public Function PUB_ChkPriDate(ByVal stPD06 As String, Optional ByRef stCaseNo As String, Optional ByVal bolOver As Boolean = True, Optional bolAppled As Boolean = True) As Boolean

On Error GoTo ErrHnd
   
'Removed by Morgan 2012/12/27 資料早更新，不用再補
'   'Add by Morgan 2007/3/9 台灣案的基本檔申請號第一碼沒有存 '0'
'   If Left(stPD06, 1) <> "0" Then
'      stPD06 = "0" & stPD06
'   End If
'   'end 2007/3/9

   
   'Modify by Morgan 2008/10/21 +控制已送件--敏惠
   'Modified by Morgan 2019/1/18 無申請日且已閉卷的案子除外--茹曣 Ex:106125944->P-120227
   strSql = "SELECT PD01||'-'||PD02||PD03||PD04 FROM PRIDATE, PATENT" & _
      " WHERE PD06='" & stPD06 & "' AND PD07='000'" & _
      " AND PA01(+)=PD01 AND PA02(+)=PD02 AND PA03(+)=PD03 AND PA04(+)=PD04" & _
      " AND PA09='000' AND NOT (pa10 is null and pa57 is not null)" & IIf(bolAppled, " and pa10>0", "")
      
   If bolOver = True Then
      strSql = strSql & " AND PD05<TO_NUMBER(TO_CHAR(ADD_MONTHS(SYSDATE,-15),'YYYYMMDD'))"
   End If
   CheckOC
   adoRecordset.CursorLocation = adUseClient
   adoRecordset.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If adoRecordset.RecordCount > 0 Then
      stCaseNo = adoRecordset.Fields(0)
      PUB_ChkPriDate = True
   End If
   
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
   CheckOC

End Function
'Add by Morgan 2004/6/16
'取得更新或新增客戶減免資料語法
Public Function PUB_GetADSQL(ByVal stAD01 As String, ByVal stAD02 As String, ByVal stAD03 As String, Optional ByVal stAD10 As String, Optional ByVal stAD11 As String, Optional ByVal stAD12 As String, Optional ByVal stAD13 As String, Optional ByVal stAD14 As String) As String
   Dim stCol As String

      PUB_GetADSQL = "BEGIN" & _
         " update applicantdiscount set ad03='" & stAD03 & "', AD07='" & strUserNum & "',AD08=TO_NUMBER(TO_CHAR(SYSDATE,'YYYYMMDD')),AD09=TO_NUMBER(TO_CHAR(SYSDATE,'HH24MI'))" & _
         " , AD10=NVL(" & CNULL(stAD10) & ",AD10), AD11=NVL(" & CNULL(stAD11) & ",AD11), AD12=NVL(" & CNULL(stAD12) & ",AD12), AD13=NVL(" & CNULL(stAD13) & ",AD13), AD14=NVL(" & CNULL(stAD14) & ",AD14)" & _
         " where ad01='" & Left(stAD01 & "000", 8) & "' and ad02='" & stAD02 & "';" & _
         " if SQL%NOTFOUND then" & _
         " INSERT INTO applicantdiscount(AD01,AD02,AD03,AD04,AD05,AD06,AD10,AD11,AD12,AD13,AD14)" & _
         " VALUES ('" & Left(stAD01 & "000", 8) & "','" & stAD02 & "','" & stAD03 & "','" & strUserNum & "',TO_NUMBER(TO_CHAR(SYSDATE,'YYYYMMDD')),TO_NUMBER(TO_CHAR(SYSDATE,'HH24MI'))" & _
         " ," & CNULL(stAD10) & "," & CNULL(stAD11) & "," & CNULL(stAD12) & "," & CNULL(stAD13) & "," & CNULL(stAD14) & ");" & _
         " end if;end;"

End Function
'Add by Morgan 2004/6/21'檢查技術報告
'iChkType:1=收文；2=發文
Public Function PUB_Check421(strCP01 As String, strCP02 As String, strCP03 As String, strCP04 As String, Optional ByVal iChkType As Integer = 2, Optional ByVal strCP10 As String) As Boolean

   PUB_Check421 = False
   
On Error GoTo ErrHnd

   'Modify by Morgan 2005/8/26 改判斷領證已發文或有公告日(第三人提)
   'strSQL = "Select PA14,PA22,PA11 From Patent Where " & ChgPatent(strCP01 & strCP02 & strCP03 & strCP04)
   strSql = "Select PA14,PA22,PA11,CP27,pa23 From Patent,caseprogress" & _
      " Where " & ChgPatent(strCP01 & strCP02 & strCP03 & strCP04) & _
      " and cp01(+)=pa01 and cp02(+)=pa02 and cp03(+)=pa03 and cp04(+)=pa04 and cp10(+)='601' AND CP57(+) IS NULL"
   
   CheckOC
   With adoRecordset
      .CursorLocation = adUseClient
      .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      '若有資料
      If .RecordCount > 0 Then
         'Add by Morgan 2007/8/29
         If strCP10 = "421" And "" & .Fields("pa23") <> "1" Then
            MsgBox "技術報告必須為申請案！", vbCritical
         ElseIf strCP10 = "807" And "" & .Fields("pa23") <> "3" Then
            MsgBox "第三人申請技術報告必須為舉發案！", vbCritical
         'end 2007/8/29
         ElseIf Val("" & .Fields(0)) > 0 And Val("" & .Fields(0)) < 20040701 Then
            MsgBox "收發文技術報告公告日不可小於93/7/1！", vbCritical
         Else
            If iChkType = 2 Then
               'Add by Morgan 2005/7/21 --玲玲請作單
               If "" & .Fields("PA11") = "" Then
                  MsgBox "發文技術報告不可無申請號！", vbExclamation
                  
               'Modify by Morgan 2005/8/26 改判斷領證已發文或有公告日(第三人提)
'               ElseIf Val("" & .Fields(0)) = 0 Then
'                  'Modify by Morgan 2005/7/21 --玲玲請作單
'                  'MsgBox "發文技術報告不可無公告日！", vbCritical
'                  If MsgBox("本案未公告是否發文？", vbYesNo + vbDefaultButton2 + vbExclamation) = vbYes Then
'                     PUB_Check421 = True
'                  End If
'               'Add by Morgan 2005/5/10
'               ElseIf "" & .Fields(1) = "" Then
'                  'Modify by Morgan 2005/7/21 --玲玲請作單
'                  'MsgBox "發文技術報告不可無證書號！", vbCritical
'                  If MsgBox("本案無證書號是否發文？", vbYesNo + vbDefaultButton2 + vbExclamation) = vbYes Then
'                     PUB_Check421 = True
'                  End If
               ElseIf Val("" & .Fields("CP27")) = 0 And Val("" & .Fields("PA14")) = 0 Then
                  MsgBox "未發文領證且無公告日不可發文技術報告！", vbExclamation
               Else
                  PUB_Check421 = True
               End If
            Else
               PUB_Check421 = True
            End If
         End If
      End If
      
   End With
   CheckOC
   
ErrHnd:

   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
   
End Function
'Add by Morgan 2004/6/23
'讀取最新發文減免身分
'Modified by Lydia 2016/12/02 + p_Date
Public Function PUB_GetCP81(ByRef pa() As String, Optional ByRef p_Date As String) As String

On Error GoTo ErrHnd
   
   p_Date = "" 'Added by Lydia 2016/12/02
   'Modified by Lydia 2016/12/02 + CP27
   strSql = "SELECT CP81,CP27 FROM CASEPROGRESS WHERE " & ChgCaseprogress(pa(1) & pa(2) & pa(3) & pa(4)) & _
      " AND CP10 IN ('101','102','103','104','105','125','601','605','919') AND CP27 IS NOT NULL ORDER BY CP27 DESC"
   CheckOC
   adoRecordset.CursorLocation = adUseClient
   adoRecordset.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If adoRecordset.RecordCount > 0 Then
      PUB_GetCP81 = "" & adoRecordset.Fields(0)
      p_Date = "" & adoRecordset.Fields(1) 'Added by Lydia 2016/12/02
   End If
   
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
   CheckOC

End Function

'Add by Morgan 2004/6/23
'讀取申請人最新減免身分
'回傳是否符合件免Y,N
'其他回傳值stAD10=減免身分別(1=自然人2=學校3=中小企業),stCU15=申請人別(0=個人,1=公司)
'Modify By Sindy 2012/5/24
'其他回傳值stAD10=減免身分別(1=自然人2=學校3=中小企業),stCU15=申請人別(0=個人,1=公司,2=學校,3=特殊機構)
'Modified by Morgan 2013/4/2 +stAD15,stAD16
Public Function PUB_GetAD03(ByVal stAD01 As String, Optional ByVal stAD02 As String = "000", Optional ByRef stAD10 As String, Optional ByRef stCU15 As String, Optional ByRef stAD15 As String, Optional ByRef stAD16 As String) As String
   
   stAD01 = stAD01 & "000"
   
On Error GoTo ErrHnd

   strSql = "SELECT AD03, AD10, CU15,AD15,AD16 FROM CUSTOMER,applicantdiscount WHERE CU01='" & Left(stAD01, 8) & "' AND CU02='" & Mid(stAD01, 9, 1) & "' AND AD01(+)=CU01 AND AD02(+)='" & stAD02 & "'"
   CheckOC
   adoRecordset.CursorLocation = adUseClient
   adoRecordset.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If adoRecordset.RecordCount > 0 Then
      'Modify by Morgan 2004/9/23
'      'Modify by Morgan 2004/8/4
'      '若為個人固定回傳 Y, 1
'      If stCU15 = "0" Then
'         stAD10 = "1"
'         PUB_GetAD03 = "Y"
'      Else
'         stAD10 = "" & adoRecordset.Fields("AD10")
'         PUB_GetAD03 = "" & adoRecordset.Fields("AD03")
'      End If
      stAD10 = "" & adoRecordset.Fields("AD10")
      stAD15 = "" & adoRecordset.Fields("AD15") 'Added by Morgan 2013/4/2
      stAD16 = "" & adoRecordset.Fields("AD16") 'Added by Morgan 2013/4/2
      stCU15 = "" & adoRecordset.Fields("CU15")
      PUB_GetAD03 = "" & adoRecordset.Fields("AD03")
      '個人未設定減免身分的回傳'Y'(考慮美國有可能會有個人不減免的狀況)
      'modify by sonia 2018/12/28 加入學校未設定減免身分的回傳'Y',但有些大陸學校台灣不承認則自行設定P-120224
      'If stCU15 = "0" And PUB_GetAD03 = "" Then
      'Modified by Morgan 2019/4/23 日本都不要預設(個人不一定可減免)
      'If (stCU15 = "0" Or stCU15 = "2") And PUB_GetAD03 = "" Then
      'Modify By Sindy 2020/4/10 PUB_GetAD03 = "" => PUB_GetAD03 <> "N" And stAD10 = "" '有減免無減免身分者
      If (stCU15 = "0" Or stCU15 = "2") And PUB_GetAD03 <> "N" And stAD10 = "" And stAD02 <> "011" Then
         'Added by Morgan 2019/1/11
         If stCU15 = "0" Then
            stAD10 = "1"
         ElseIf stCU15 = "2" Then
            stAD10 = "2"
         End If
         'end 2019/1/11
         PUB_GetAD03 = "Y"
      End If
   End If
   
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
   CheckOC

End Function

'Add by Morgan 2004/6/24 檢查是否有延緩公告未發文
Public Function PUB_Get412Data(ByRef pa() As String, ByRef stCP09 As String, ByRef stCP71 As String) As Boolean

On Error GoTo ErrHnd
   
   stCP09 = "": stCP71 = ""
   strSql = "SELECT CP09, CP71 FROM CASEPROGRESS WHERE CP01='" & pa(1) & "' AND CP02='" & pa(2) & "' AND CP03='" & pa(3) & "' AND CP04='" & pa(4) & "'" & _
      " AND CP10='412' AND CP27 IS NULL AND CP57 IS NULL"
      
   CheckOC
   adoRecordset.CursorLocation = adUseClient
   adoRecordset.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If adoRecordset.RecordCount > 0 Then
      stCP09 = adoRecordset.Fields("CP09")
      stCP71 = "" & adoRecordset.Fields("CP71")
      PUB_Get412Data = True
   End If
   
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
   CheckOC
End Function

'Add by Morgan 2004/6/24
'Modified by Morgan 2014/11/20 +stPA01
'設定下次繳年費期限
'stPA01=系統別,stCP27=領證發文日,stYear=已繳年度,stDate()=1.法定期限2.本所期限3.預估公告日4,約定期限,stCP71=延緩月數/日期
Public Sub PUB_Get605NP(ByVal stPA01 As String, ByVal stCP27 As String, ByVal stYear As String, ByRef stDate() As String, Optional ByVal stCP71 As String)
   Dim iDay As Integer
   '預估公告日=發文日+延緩月數+35天
   'Modify by Morgan 2004/10/5 當stCP71 為延緩公告日時不用估算
   If Len(stCP71) > 1 Then
      stDate(3) = TransDate(stCP71, 2)
   Else
      'Modify by Morgan 2005/8/24 改用常數以便修改
      'stDate(3) = CompDate(2, 35, DBDATE(stCP27))
      stDate(3) = CompDate(2, 預估公告天數, DBDATE(stCP27))
   
      '抓第一個1,11,21
      iDay = Val(Right(stDate(3), 2))
      'Add by Morgan 2007/1/30 剛好1號時不必再推否則會多1個月
      If iDay = 1 Then
         stDate(3) = stDate(3)
      'end 2007/1/30
      ElseIf iDay <= 11 Then
         stDate(3) = Left(stDate(3), 6) & "11"
      ElseIf iDay <= 21 Then
         stDate(3) = Left(stDate(3), 6) & "21"
      'iDay>21
      Else
         stDate(3) = CompDate(1, 1, stDate(3))
         stDate(3) = Left(stDate(3), 6) & "01"
      End If
      
      '有延緩公告
      If Val(stCP71) > 0 Then
         stDate(3) = CompDate(1, Val(stCP71), stDate(3))
      End If
      
   End If
   '法定期限=預估公告日+已繳年度-1天
   stDate(1) = CompDate(0, Val(stYear), stDate(3))
   stDate(1) = CompDate(2, -1, stDate(1))
   'Added by Morgan 2014/10/28
   'Modified by Morgan 2014/11/20 外專改回舊規則
   If strSrvDate(1) >= 台灣案所限新規則啟用日 And stPA01 <> "FCP" Then
      stDate(2) = PUB_GetOurDeadline(stDate(1))
      
   'Added by Morgan 2019/7/11 外專台灣案所限以改工作天計算
   ElseIf strSrvDate(1) >= 外專台灣案所限新規則啟用日 And stPA01 = "FCP" Then
      'Modify By Sindy 2021/8/17 + , , stDate(4)
      stDate(2) = PUB_GetFCPOurDeadline(stDate(1), 2, , stDate(4))
   
   'end 2019/7/11
   Else
   'end 2014/10/28
      '本所期限=法定期限-2天
      stDate(2) = CompDate(2, -2, stDate(1))
   End If
End Sub
'Add by Morgan 2004/6/24 檢查是否同時發文延緩公告
Public Function PUB_Check412(ByRef pa() As String) As Boolean

On Error GoTo ErrHnd
   
   strSql = "SELECT 1 FROM CASEPROGRESS WHERE CP01='" & pa(1) & "' AND CP02='" & pa(2) & "' AND CP03='" & pa(3) & "' AND CP04='" & pa(4) & "'" & _
      " AND CP10='412' AND CP27 IS NOT NULL AND CP57 IS NULL"
      
   CheckOC
   adoRecordset.CursorLocation = adUseClient
   adoRecordset.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If adoRecordset.RecordCount > 0 Then
      PUB_Check412 = True
   End If
   
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
   CheckOC
End Function
'Add by Morgan 2004/6/30
'檢查案件最新減免狀態
'回傳：不符合減免="N"(預設值)，符合減免="Y"
'Modify by Morgan 2004/8/18 若有任一申請人未設定減免身分則回傳空白
Public Function PUB_GetCaseDiscStat(ByVal stPA1234 As String, Optional stDiscType As String) As String

   Dim stPA(27 To 30) As String, stPA09 As String, iIdx As Integer, stAD03 As String, stAD03s As String
   Dim stAD10 As String   '2010/7/6 add by sonia
   
   PUB_GetCaseDiscStat = ""
   
On Error GoTo ErrHnd
   
   strSql = "SELECT PA09,PA26,PA27,PA28,PA29,PA30,CU15,AD03,AD10 FROM PATENT, CUSTOMER, APPLICANTDISCOUNT" & _
      " WHERE " & ChgPatent(stPA1234) & " AND CU01(+)=SUBSTR(PA26,1,8) AND AD01(+)=SUBSTR(PA26,1,8) AND AD02(+)=PA09"
   
   CheckOC
   adoRecordset.CursorLocation = adUseClient
   adoRecordset.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If adoRecordset.RecordCount > 0 Then
      stPA09 = "" & adoRecordset("PA09")
      stPA(27) = Left("" & adoRecordset("PA27"), 8)
      stPA(28) = Left("" & adoRecordset("PA28"), 8)
      stPA(29) = Left("" & adoRecordset("PA29"), 8)
      stPA(30) = Left("" & adoRecordset("PA30"), 8)
      '個人自動設定為 Y
      'modify by sonia 2018/12/28 加入學校未設定減免身分的回傳'Y'
      'Modified by Morgan 2019/1/4 改都呼叫 PUB_GetAD03
      'If ("" & adoRecordset("CU15") = "0" Or "" & adoRecordset("CU15") = "2") Then
      '   stAD03 = "Y"
      '   stDiscType = "1"
      'Else
      '   stAD03 = "" & adoRecordset("AD03")
      '   stDiscType = "" & adoRecordset("AD10")
      'End If
      stAD03 = PUB_GetAD03(Left("" & adoRecordset("PA26"), 8), stPA09, stDiscType)
      'end 2019/1/4
      '若有任一申請人未設定減免身分則回傳空白
      If stAD03 <> "" Then
         stAD03s = stAD03s & stAD03
         For iIdx = 27 To 30
            If stPA(iIdx) <> "" Then
               '2010/7/6 modify by sonia 內專催年費會錯
               'stAD03 = PUB_GetAD03(stPA(iIdx), stPA09)
               stAD03 = PUB_GetAD03(stPA(iIdx), stPA09, stAD10)
               If stAD03 = "" Then
                  Exit For
               Else
                  stAD03s = stAD03s & stAD03
                  '2010/7/6 modify by sonia 內專催年費會出現 物件已關閉....
                  'stDiscType = stDiscType & "" & adoRecordset("AD10")
                  stDiscType = stDiscType & "" & stAD10
               End If
            End If
         Next
         '若都有設定減免身分
         If iIdx = 31 Then
            If InStr(stAD03s, "N") > 0 Then
               PUB_GetCaseDiscStat = "N"
            Else
               PUB_GetCaseDiscStat = "Y"
            End If
         End If
      End If
   End If
   
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
   CheckOC
End Function

'Add by Morgan 2004/6/24
'取得專業代號
Public Function PUB_GetST07(ByVal stUserNo As String) As String

On Error GoTo ErrHnd
   strSql = "SELECT ST07 FROM STAFF WHERE ST01='" & stUserNo & "'"
      
   CheckOC
   adoRecordset.CursorLocation = adUseClient
   adoRecordset.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If adoRecordset.RecordCount > 0 Then
      PUB_GetST07 = "" & adoRecordset.Fields("ST07")
   End If
   
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
   CheckOC
End Function
'Add by Morgan 2004/7/1
Public Function PUB_GetCopys(ByRef stPA() As String, ByRef stSales As String) As Integer
    stSales = PUB_GetAKindSalesNo(stPA(1), stPA(2), stPA(3), stPA(4))
    If PUB_GetST06(stSales) = "1" Then
        PUB_GetCopys = 3
    Else
        PUB_GetCopys = 4
    End If
   
End Function

'Remove by Morgan 2007/10/12 不再使用,測試無誤後刪除
''Add by Morgan 2004/7/14
''計算承辦期限
''stEP06:文件齊備日(西元),stCP10:案件性質
'Public Function PUB_GetEngDueDate(ByVal stEP06 As String, ByVal stPA01 As String, ByVal stPA10 As String, ByVal stCP10 As String) As String
'
'   Dim strPromoteDate As String
'
'On Error GoTo ErrHnd
'
'   strSQL = "Select NVL(CF04,0) From Casefee Where cf01='" & stPA01 & "' and cf02='" & stPA10 & "' and cf03='" & stCP10 & "'"
'    CheckOC
'    adoRecordset.CursorLocation = adUseClient
'    adoRecordset.Open strSQL, cnnConnection, adOpenStatic, adLockReadOnly
'    If adoRecordset.RecordCount > 0 Then
'       If Val("" & adoRecordset.Fields(0).Value) > 0 Then
'          strPromoteDate = CompWorkDay(adoRecordset.Fields(0).Value, stEP06, 0)
'       End If
'    End If
'   PUB_GetEngDueDate = strPromoteDate
'
'ErrHnd:
'   If Err.NUMBER <> 0 Then MsgBox Err.Description, vbCritical
'   CheckOC
'
'End Function

'Add by Morgan 2004/7/16
'檢查申請人是否為非個人且未建立減免資料
Public Function PUB_IfCompAppNotExist(ByVal stAppNo As String, Optional ByVal stAD02 As String = "000") As Boolean
   
On Error GoTo ErrHnd
   strSql = "SELECT CU15,AD01 FROM CUSTOMER,APPLICANTDISCOUNT WHERE CU01='" & Left(stAppNo & "000", 8) & "' AND AD01(+)=CU01 AND AD02(+)='" & stAD02 & "'"
      
   CheckOC
   adoRecordset.CursorLocation = adUseClient
   adoRecordset.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If adoRecordset.RecordCount > 0 Then
      'Modify By Sindy 2012/5/24
      'If "" & adoRecordset.Fields("CU15") = "1" And "" & adoRecordset.Fields("AD01") = "" Then
      If "" & adoRecordset.Fields("CU15") <> "0" And "" & adoRecordset.Fields("AD01") = "" Then
         PUB_IfCompAppNotExist = True
      End If
   End If
   
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
   CheckOC
End Function

'Refer to prjTaieDll003.Cls003 by Morgan 2004/7/27
'Modify By Sindy 2016/12/7 + , ByRef strInventorID() As String
'讀取客戶發明人檔,國籍
Public Function PUB_ReadInventor(ByRef strPetition() As String, ByRef strInventorNo1() As String, _
      ByRef strInventorNo2() As String, ByRef strInventorName() As String, _
      ByRef strInventorNation() As String, ByRef strInventorID() As String) As Boolean

   Dim i As Integer

On Error GoTo ErrHnd

   For i = 0 To 4
      strPetition(i) = Left(ChangeCustomerL(strPetition(i)), 8)
   Next
   'Modify By Sindy 2010/3/8
   'strSql = "select in01,in02,in04,NA03 from inventor, NATION where NA01(+)=IN11 AND ( in01=" + CNULL(strPetition(0)) + " or in01=" + CNULL(strPetition(1)) + " or in01=" + CNULL(strPetition(2)) + " or in01=" + CNULL(strPetition(3)) + " or in01=" + CNULL(strPetition(4)) & ") "
   'Modify By Sindy 2010/5/14
   'strSql = "select in01,in02,in04,NA03 from inventor, NATION where NA01(+)=IN11 AND ( in01=" + CNULL(strPetition(0)) + " or in01=" + CNULL(strPetition(1)) + " or in01=" + CNULL(strPetition(2)) + " or in01=" + CNULL(strPetition(3)) + " or in01=" + CNULL(strPetition(4)) & ") order by in04 asc "
   'Modify By Sindy 2016/12/7 + ,in03
   strSql = "select in01,in02,in04||in05||in06,NA03,in03 from inventor, NATION where NA01(+)=IN11 AND ( in01=" + CNULL(strPetition(0)) + " or in01=" + CNULL(strPetition(1)) + " or in01=" + CNULL(strPetition(2)) + " or in01=" + CNULL(strPetition(3)) + " or in01=" + CNULL(strPetition(4)) & ") order by in04 asc "
   '2010/3/8 End
   CheckOC
   adoRecordset.CursorLocation = adUseClient
   adoRecordset.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If adoRecordset.RecordCount > 0 Then
      i = 0
      Do While Not adoRecordset.EOF
            ReDim Preserve strInventorNo1(i)
            ReDim Preserve strInventorNo2(i)
            ReDim Preserve strInventorName(i)
            ReDim Preserve strInventorNation(i)
            ReDim Preserve strInventorID(i) 'Add By Sindy 2016/12/7
            strInventorNo1(i) = adoRecordset.Fields(0)
            strInventorNo2(i) = adoRecordset.Fields(1)
            strInventorName(i) = IIf(IsNull(adoRecordset.Fields(2)), "", adoRecordset.Fields(2))
            strInventorNation(i) = "" & adoRecordset.Fields("NA03")
            strInventorID(i) = "" & adoRecordset.Fields("in03") 'Add By Sindy 2016/12/7
            adoRecordset.MoveNext
            i = i + 1
      Loop
      PUB_ReadInventor = True
   Else
      ShowMsg MsgText(1002)
   End If

ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
   CheckOC
End Function

'Remove from public by Morgan 2004/7/28
'傳回長的客戶代號
Public Function ChangeCustomerL(ByVal strTemp As String, Optional IsAgent As Boolean) As String
'   If IsAgent Then
'      If StrTemp <> "" Then ChangeCustomerL = StrTemp + String(8 - Len(StrTemp), "0")
'   Else
      strTemp = Trim(strTemp) 'Added by Morgan 2012/11/8
      'Added by Lydia 2019/12/23 判斷"-" ; ex.接洽人
      If strTemp <> "" And InStr(strTemp, "-") > 0 Then
          strTemp = Mid(strTemp, 1, InStr(strTemp, "-") - 1)
      End If
      'end 2019/12/23
      If strTemp <> "" Then ChangeCustomerL = strTemp + String(9 - Len(strTemp), "0")
'   End If
End Function

'Remove from public by Morgan 2004/7/28
'傳回短的客戶代號
Public Function ChangeCustomerS(ByRef strTemp As String) As String
   If strTemp <> "" Then
      'Added by Lydia 2015/12/15 補成9碼
      If Len(strTemp) < 9 Then 'Add By Sindy 2016/6/21 + if判斷 ex.strTemp=Y51399000-01
         strTemp = strTemp + String(9 - Len(strTemp), "0")
      End If
      ChangeCustomerS = IIf(Right(strTemp, 3) = "000", Mid(strTemp, 1, 6), IIf(Right(strTemp, 1) = "0", Mid(strTemp, 1, 8), strTemp))
   Else
      ChangeCustomerS = ""
   End If
End Function

'add by nick 2004/07/29 將關閉鈕失效
Public Sub DisableControl(MeForm As Form)
hMenu = GetSystemMenu(MeForm.hWnd, 0)
MII.cbSize = Len(MII)
MII.dwTypeData = String(80, 0)
MII.cch = Len(MII.dwTypeData)
MII.fMask = MIIM_STATE
MII.wID = SC_CLOSE
GetMenuItemInfo hMenu, SC_CLOSE, False, MII
MII.wID = xMenuID
MII.fMask = MIIM_ID
SetMenuItemInfo hMenu, SC_CLOSE, False, MII
MII.fState = MII.fState Or MFS_GRAYED
MII.fMask = MIIM_STATE
SetMenuItemInfo hMenu, MII.wID, False, MII
SendMessage MeForm.hWnd, WM_NCACTIVATE, True, ByVal 0&

End Sub
'Add by Morgan 2004/8/9
'檢查繳年費費期限是否延期過
Public Function PUB_IfCtrlDateExtended(ByRef pa() As String, ByVal np09 As String) As Boolean
   
   Dim adoRst As New ADODB.Recordset
   
On Error GoTo ErrHnd
   '93.11.30 MODIBY BY SONIA
   'strSQL = " SELECT 1 FROM NEXTPROGRESS WHERE NP02='" & pa(1) & "' AND NP03='" & pa(2) & "' AND NP04='" & pa(3) & "' AND NP05='" & pa(4) & "' AND NP06='N' AND NP07 BETWEEN 605 AND 607 AND TO_NUMBER(TO_CHAR(ADD_MONTHS(TO_DATE(NP09,'YYYYMMDD'),9),'YYYYMMDD'))>" & NP09
   'Modified by Morgan 2025/10/28 +原規則遇延半年仍不辦但過期後又要辦時會誤判，故改判斷不續辦管制的期限才是延期後的期限 Ex:FCP-061556
   'strSql = " SELECT 1 FROM NEXTPROGRESS WHERE NP02='" & pa(1) & "' AND NP03='" & pa(2) & "' AND NP04='" & pa(3) & "' AND NP05='" & pa(4) & "' AND NP06='N' AND NP07 BETWEEN 605 AND 607 AND TO_NUMBER(TO_CHAR(ADD_MONTHS(TO_DATE(NP09,'YYYYMMDD'),9),'YYYYMMDD'))>" & np09 & " AND NP09<" & np09
   strSql = " SELECT 1 FROM NEXTPROGRESS,CASEPROGRESS WHERE NP02='" & pa(1) & "' AND NP03='" & pa(2) & "' AND NP04='" & pa(3) & "' AND NP05='" & pa(4) & "' AND NP07 BETWEEN 605 AND 607 AND NP09=" & np09 & " AND CP09(+)=NP01 AND CP10='907'"
   'end 2025/10/28
   '93.11.30 END
   
   adoRst.CursorLocation = adUseClient
   adoRst.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If adoRst.RecordCount > 0 Then
      PUB_IfCtrlDateExtended = True
   End If
   
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
   Set adoRst = Nothing
   
End Function

''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' 由系統別及案件性質代碼取得案件性質名稱
' Input : strSysKind ==> 本所案號中的系統別
'         strCaseNo ==> 案件性質代碼
'         nLanguage ==> 0 表取得國內案件性質名稱
'                       1 表取得大陸件性質名稱
' Output : 傳回案件性質名稱
' 說明 : 當nCountry不輸入時, 預設值為取得國內的案件性質名稱
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Public Function GetCaseTypeName(ByVal strSysKind As String, ByVal strCaseNo As String, Optional ByVal nLanguage As Integer = 0) As String
   Dim rsTmp As New ADODB.Recordset
   Dim strSql As String
   
   ' 檢查取得國內還是大陸名稱的範圍
   If nLanguage < 0 Or nLanguage > 1 Then: nLanguage = 0
   
   GetCaseTypeName = Empty
   strSql = "SELECT * FROM CasePropertyMap " & _
            "WHERE CPM01 = '" & strSysKind & "' AND " & _
                  "CPM02 = '" & strCaseNo & "' "
   rsTmp.CursorLocation = adUseClient
   rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If rsTmp.RecordCount > 0 Then
      rsTmp.MoveFirst
      Select Case nLanguage
         ' 表取得國內的名稱
         Case 0:
            If IsNull(rsTmp.Fields("CPM03")) = False Then
               GetCaseTypeName = rsTmp.Fields("CPM03")
            End If
         ' 表取得大陸的名稱
         Case 1:
            If IsNull(rsTmp.Fields("CPM04")) = False Then
               GetCaseTypeName = rsTmp.Fields("CPM04")
            End If
      End Select
   End If
   rsTmp.Close
   Set rsTmp = Nothing
End Function

''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' 取得部門別的名稱
' Input : strDepartment ==> 部門別的代碼
' Output : 傳回部門別的中文名稱
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Public Function GetDepartmentName(ByVal strDepartment As String) As String
   Dim rsTmp As New ADODB.Recordset
   Dim strSql As String
   
   GetDepartmentName = Empty
   strSql = "SELECT * FROM ACC090 " & _
            "WHERE A0901 = '" & strDepartment & "' "
   rsTmp.CursorLocation = adUseClient
   rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If rsTmp.RecordCount > 0 Then
      rsTmp.MoveFirst
      If IsNull(rsTmp.Fields("A0902")) = False Then
         GetDepartmentName = rsTmp.Fields("A0902")
      End If
   End If
   rsTmp.Close
   Set rsTmp = Nothing
End Function

'Add By Sindy 2023/12/20 依員工代碼取得部門的中文名稱
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' 取得新部門的中文名稱
' Input : strST01 ==> 員工代碼
' Output : 傳回部門的中文名稱
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Public Function GetDeptNameA0922(ByVal StrST01 As String) As String
   Dim rsTmp As New ADODB.Recordset
   Dim strSql As String
   
   GetDeptNameA0922 = Empty
   strSql = "SELECT nvl(a0922,a0902) A0922 FROM STAFF,ACC090,ACC090NEW " & _
            "WHERE ST01 = '" & StrST01 & "' AND ST03=A0901(+) AND ST93=A0921(+) "
   rsTmp.CursorLocation = adUseClient
   rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If rsTmp.RecordCount > 0 Then
      rsTmp.MoveFirst
      If IsNull(rsTmp.Fields("A0922")) = False Then
         GetDeptNameA0922 = rsTmp.Fields("A0922")
      End If
   End If
   rsTmp.Close
   Set rsTmp = Nothing
End Function

'Added by Lydia 2015/06/01 擷取部門別資料
'Modified by Lydia 2024/01/04 +是否抓新部門資料bolNew
Public Function GetDeptA09(ByVal strDept As String, ByVal strAn As String, Optional ByVal bolNew As Boolean) As String
'strDept 部門代號
'strAn 要擷取的欄位名稱
   Dim rsTmp As New ADODB.Recordset
   Dim strSql As String
   
   GetDeptA09 = Empty
   'Added by Lydia 2024/01/04
   If bolNew = True Then
      strSql = "SELECT * FROM ACC090NEW " & _
               "WHERE A0921 = '" & strDept & "' "
   Else
   'end 2024/01/04
      strSql = "SELECT * FROM ACC090 " & _
               "WHERE A0901 = '" & strDept & "' "
   End If
   rsTmp.CursorLocation = adUseClient
   rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If rsTmp.RecordCount > 0 Then
      rsTmp.MoveFirst
      If IsNull(rsTmp.Fields("A09" + Trim(strAn))) = False Then
         GetDeptA09 = rsTmp.Fields("A09" + Trim(strAn))
      End If
   End If
   rsTmp.Close
   Set rsTmp = Nothing
End Function
'Added by Morgan 2011/11/11
'依收文號取得發文規費
'pDelayCP09:延期收文號
Public Function PUB_GetDelayPayFee(ByVal pDelayCP09 As String) As Long
   Dim intR As Integer, stSQL As String
   Dim lngCP84 As Long
   
On Error GoTo ErrHnd
   
   '先抓延期的發文規費
   stSQL = " SELECT sum(cp84) FROM CASEPROGRESS B WHERE B.CP09='" & pDelayCP09 & "'" & _
      " AND ((B.CP01 IN ('P','FCP') AND B.CP10='404') OR (B.CP01 IN ('T','FCT') AND B.CP10='303')) AND CP27>0"
   
   Set AdoRecordSet3 = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      lngCP84 = Val("" & AdoRecordSet3.Fields(0))
      '再抓補收款的發文規費(不請款的)
      stSQL = " SELECT SUM(cp84) FROM CASEPROGRESS B WHERE CP43='" & pDelayCP09 & "' AND CP20='N' AND CP84>0" & _
         " AND ( (B.CP01 IN ('P','FCP') AND B.CP10='911') OR (B.CP01 IN ('T','FCT') AND B.CP10='705') )"
      Set AdoRecordSet3 = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         lngCP84 = lngCP84 + Val("" & AdoRecordSet3.Fields(0))
      End If
      PUB_GetDelayPayFee = lngCP84
   End If
   Exit Function
   
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
   
End Function
'Add by Morgan 2004/8/9
'依收文號取得預設發文規費
'Modify by Morgan 2004/9/24 加判斷CP43(A類延期)
'stCP09：發文收文號
'Modified by Morgan 2011/11/11 +pDelayCP09:延期收文號
'Modified by Morgan 2013/1/8 +pDelayCP27:延期發文日
Public Function PUB_ChkDelay(ByVal stCP09 As String, Optional ByRef pDelayCP09 As String, Optional ByRef pDelayCP27 As String) As Boolean
   Dim stSQL As String
   Dim intQ As Integer
   Dim rsQuery As ADODB.Recordset
      
   '2014/12/4 modify by sonia 加入有發文規費NVL(B.CP84,0)>0的條件 FCT-033327分割
   stSQL = " SELECT B.CP09,B.CP27 FROM CASEPROGRESS A,CASEPROGRESS B" & _
      " WHERE A.CP09='" & stCP09 & "' AND B.CP43 IN (A.CP09,A.CP43)" & _
      " AND ((B.CP01 IN ('P','FCP') AND B.CP10='404') OR (B.CP01 IN ('T','FCT') AND B.CP10='303'))" & _
      " AND B.CP27>0 AND NVL(B.CP84,0)>0 order by b.cp27 asc"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      With rsQuery
      PUB_ChkDelay = True
      pDelayCP09 = .Fields("cp09") 'Added by Morgan 2011/11/11
      pDelayCP27 = .Fields("cp27") 'Added by Morgan 2013/1/8
      End With
   End If
   
   Set rsQuery = Nothing
End Function

'檢查台灣新型主動修正期限 Add by Morgan 2004/9/13
'Modify by Morgan 2007/1/16 加 strChoose:0 收文 1 內部收文
Public Function PUB_Check203(strCP01 As String, strCP02 As String, strCP03 As String, strCP04 As String, Optional iChoose As Integer = 0) As Boolean

   PUB_Check203 = False
   
On Error GoTo ErrHnd
   
   strSql = "Select PA08,PA09,PA10,PA16  From Patent Where " & ChgPatent(strCP01 & strCP02 & strCP03 & strCP04)
   
   CheckOC3
   With AdoRecordSet3
      .CursorLocation = adUseClient
      .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      '若有資料
      If .RecordCount > 0 Then
         'Modify by Morgan 2007/7/17 加判斷台灣新型案
         If ("" & .Fields("PA09")) = "000" And ("" & .Fields("PA08")) = "2" Then
            'Add by Morgan 2007/1/16
            If "" & .Fields("PA16") = "1" Then
               MsgBox "台灣新型專利案已核准不可再收文【主動修正】應改收【更正】，請與智權部同仁確認！"
            '內部收文不用控制下面的條件
            ElseIf iChoose = 1 Then
               PUB_Check203 = True
            'end 2007/1/16
            'Modify by Morgan 2004/10/26 加判斷申請日>=93.7.1
            '2009/4/17 MODIFY BY SONIA DAVID說FCP不控管
            ElseIf strCP01 = "P" And Val("" & .Fields("PA10")) >= 20040701 And ("" & .Fields("PA09")) = "000" And ("" & .Fields("PA08")) = "2" And Val(CompDate(1, 2, "" & .Fields("PA10"))) < Val(strSrvDate(1)) Then
               MsgBox "台灣新型專利案提主動修正不可逾申請日起兩個月！", vbCritical
            Else
               PUB_Check203 = True
            End If
         Else
            PUB_Check203 = True
         End If
      Else
         MsgBox "基本檔資料讀取失敗！", vbCritical
      End If
   
ErrHnd:
      If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
   End With
   CheckOC3
   
End Function

'檢查代理人或申請人是否已不再使用 Add by Morgan 2004/9/14
Public Function PUB_CheckStatus(ByVal stCusNo As String) As Boolean

   If stCusNo = "" Then
      PUB_CheckStatus = True: Exit Function
   Else
      PUB_CheckStatus = False
   End If
   
On Error GoTo ErrHnd
   
   stCusNo = ChangeCustomerL(stCusNo)
   If Left(stCusNo, 1) = "X" Then
      strSql = "Select CU80  From Customer Where CU01='" & Left(stCusNo, 8) & "' AND CU02='" & Right(stCusNo, 1) & "'"
   Else
      strSql = "Select FA69  From FAgent Where FA01='" & Left(stCusNo, 8) & "' AND FA02='" & Right(stCusNo, 1) & "'"
   End If
   CheckOC3
   With AdoRecordSet3
      .CursorLocation = adUseClient
      .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      '若有資料
      If .RecordCount > 0 Then
         If ("" & .Fields(0)) = "不再使用" Then
            MsgBox "編號【" & stCusNo & "】的客戶/代理人資料已不再使用，請確認！", vbCritical
         Else
            PUB_CheckStatus = True
         End If
      Else
         MsgBox "編號【" & stCusNo & "】的客戶/代理人資料讀取失敗！", vbCritical
      End If
   
ErrHnd:
      If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
   End With
   CheckOC3
   
End Function


'判斷中英混雜字串之長度是否有超過最大長度
'Modify by Amy +是否秀訊息
'Modify By Sindy 2021/2/4 + 增加要顯示的欄位名稱
'Modified by Morgan 2021/5/12 +bolCountByChar:是否以字計算
'Modify by Amy 2023/01/18 原bolCountByChar預設False,因目前都要用Char計算,故改為True
Public Function CheckLengthIsOK(ByRef strTemp As String, ByRef intTemp As Integer, _
   Optional ByVal bolShowMsg As Boolean = True, _
   Optional ByVal strErrField As String = "", Optional ByVal bolCountByChar As Boolean = True) As Boolean
'edit by nickc 2007/11/15
If intTemp <> 0 Then
   'Added by Morgan 2021/5/12
   If bolCountByChar = True Then
      If Len(strTemp) > intTemp Then
         If bolShowMsg = True Then
            Beep
            ShowMsg IIf(Trim(strErrField) <> "", "【" & strErrField & "】欄位", "") & "輸入之資料過長，超過" & Format(intTemp) & "個字！"
         End If
         CheckLengthIsOK = False
      Else
         CheckLengthIsOK = True
      End If
   Else
   'end 2021/5/12
      If GetTextLength(strTemp) > intTemp Then
         If bolShowMsg = True Then
              Beep
              'Modify By Sindy 2021/2/4 + IIf(Trim(strErrField) <> "", "【" & strErrField & "】欄位", "")
              ShowMsg IIf(Trim(strErrField) <> "", "【" & strErrField & "】欄位", "") & MsgText(9205) & Format(intTemp) & MsgText(9206)
         End If
         CheckLengthIsOK = False
      Else
         CheckLengthIsOK = True
      End If
   End If 'Added by Morgan 2021/5/12
Else
   CheckLengthIsOK = True
End If
End Function

'取得中英混雜字串之長度
'Modified by Lydia 2020/02/17 改成長整數
'Public Function GetTextLength(ByRef strTemp As String) As Integer
Public Function GetTextLength(ByRef strTemp As String) As Long
'Modified by Morgan 2021/4/21 修正Unicode字無法轉成系統的預設字元碼對應頁(會變成?號，長度為1)，導致長度算錯問題
'GetTextLength = LenB(StrConv(strTemp, vbFromUnicode))
'Modified by Lydia 2022/06/22  ii 整數改為長整數
Dim ii As Long, LLen As Long
For ii = 1 To Len(strTemp)
   If Mid(strTemp, ii, 1) = StrConv(StrConv(Mid(strTemp, ii, 1), vbFromUnicode), vbUnicode) Then
      LLen = LLen + LenB(StrConv(Mid(strTemp, ii, 1), vbFromUnicode))
   Else
      LLen = LLen + LenB(Mid(strTemp, ii, 1))
   End If
Next
GetTextLength = LLen
End Function

'取得繳費起算日及繳費年度，
'InPut : intChoose 專利種類，strNation : 國家代碼，strTxt() 0:收文號 1-4:本所案號，strCP10:案件性質
'OutPut : strDate 正確起算日期/專用起始日，strYear 繳費年度，strEnd 專用結束日(固定減 1)，iFixNo:修法第次
'Modified by Morgan 2022/11/1 輸出的參數都改為 Optional
Public Function GetMoneyDate( _
   ByVal intChoose As Integer, _
   ByVal strNation As String, _
   ByRef strTxt() As String, _
   Optional ByRef strDate As String, _
   Optional ByRef strYear As String, _
   Optional ByRef strEnd As String, Optional ByVal strCP10 As String, Optional ByRef iFixNo As Integer) As Boolean
 Dim i As Integer, rsTemp1 As New ADODB.Recordset, bolChk As Boolean
'Add By Cheng 2002/06/18
Dim blnMonthAdd As Boolean '加月
Dim strPA10 As String '申請日-韓國新舊法判斷用
Dim strPA72 As String '已繳費年度-荷蘭修法判斷用
Dim strStartYear As String '繳年費起算年 Add by Morgan 2010/7/15
Dim strPA21 As String '發證日-越南新舊法判斷用 Add by Morgan 2010/9/30
Dim strTSQL As String 'Added by Morgan 2012/8/28 原先用共用變數 strExc(0) 但有可能發生覆蓋問題故改用區域變數
Dim StrPA11 As String 'Added by Morgan 2013/11/11
Dim stReduecOneDay As String 'Added by Morgan 2019/11/12 專用期止日是否減1天 N=不減

On Error GoTo ErrHand
   GetMoneyDate = False
   'Add By Cheng 2002/06/18
   blnMonthAdd = False
'   '92.9.10 add by sonia
    strDate = ""
'   If strNation = "013" And strTxt(8) = "1" Then
'   Else
'      strDate = ""
'   End If
'   '92.9.10 end
   strYear = ""
   strEnd = ""
   strTSQL = "0"
   iFixNo = 0
   bolChk = True
   
   'Modified by Morgan 2019/11/12 +na82,na83,na84
   Select Case intChoose
      Case 11
         strTSQL = "na41,NVL(na07,0),na82 as ROD"
      Case 12
         strTSQL = "na44,NVL(na09,0),na83 as ROD"
      Case 13
         strTSQL = "na47,NVL(na11,0),na84 as ROD"
      Case Else
         bolChk = False
   End Select
   
   If bolChk Then
      strTSQL = "SELECT " & strTSQL & " FROM NATION WHERE NA01=" + CNULL(strNation)
      intI = 1
      Set RsTemp = ClsLawReadRstMsg(intI, strTSQL) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strTSQL)
      If intI = 1 Then
         stReduecOneDay = "" & RsTemp("ROD") 'Added by Morgan 2019/11/12
         If Not IsNull(RsTemp.Fields(0)) Then
            i = 1
            Select Case RsTemp.Fields(0)
               Case 收文日
                  strTSQL = "CP05"
               Case 申請日
                  strTSQL = "PA10"
                  i = 2
               Case 發文日
                  strTSQL = "CP27"
               Case 准駁日
                  strTSQL = "CP25"
               Case 公告日
                  strTSQL = "PA14"
                  i = 2
               Case 發證日
                  strTSQL = "PA21"
                  i = 2
               Case 公開日
                  strTSQL = "PA12"
                  i = 2
            End Select
         Else
            strTSQL = "PA10"
            i = 2
         End If
         If i = 1 Then
            strTSQL = "SELECT " & strTSQL & " FROM CASEPROGRESS WHERE CP09='" & strTxt(0) & "'"
         Else
            strTSQL = "SELECT " & strTSQL & " FROM PATENT WHERE PA01='" & strTxt(1) & "' AND " & _
               "PA02='" & strTxt(2) & "' AND PA03='" & strTxt(3) & "' AND PA04='" & strTxt(4) & "'"
         End If
         intI = 1
         Set rsTemp1 = ClsLawReadRstMsg(intI, strTSQL) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strTSQL)
         If intI = 1 Then
            If Not IsNull(rsTemp1.Fields(0)) Then
'               '92.9.10 modify by sonia
               'Modify by Morgan 2008/12/24 閏年會錯
               'strEnd = Val(Left(rsTemp1.Fields(0), 4)) + RsTemp.Fields(1) & Right(rsTemp1.Fields(0), 4)
               'Modified by Morgan 2019/11/12 改用函數
               'strEnd = CompDate(0, RsTemp.Fields(1), rsTemp1.Fields(0))
               strEnd = PUB_GetEndDate(rsTemp1.Fields(0), RsTemp.Fields(1), stReduecOneDay, strNation)
               'end 2019/11/12
'               If strNation = "013" And strTxt(8) = "1" Then
'                  strEnd = Val(Left(strDate, 4)) + rsTemp.Fields(1) & Right(strDate, 4)
'               Else
'                  strEnd = Val(Left(rsTemp1.Fields(0), 4)) + rsTemp.Fields(1) & Right(rsTemp1.Fields(0), 4)
'               End If
'               '92.9.10 end
            Else
               strEnd = "0"
            End If
         Else
            strEnd = "0"
         End If
      End If
   End If
   
   
   Select Case intChoose
      Case 1
         'Modify by Morgan 2010/7/15 +考慮繳費年起算日
         'strTSQL = "na06,na21,0"
         strTSQL = "na06,na21,0,na42"
         
         'Added by Morgan 2025/8/7
         '澳洲植物新品種保護的專利權期間為自發證日起算25年，自發證日起第2年須逐年繳年費--禧佩
         If strNation = "015" Then
            If PUB_ChkCPExist(strTxt(), "120", "2") Then
               strTSQL = "'6' na06,'2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25' na21,0,'6' na42"
            End If
         End If
         'end 2025/8/7
      Case 2
         'Modify by Morgan 2010/7/15 +考慮繳費年起算日
         'strTSQL = "na08,na23,0"
         strTSQL = "na08,na23,0,na45"
      Case 3
         'Modify by Morgan 2010/7/15 +考慮繳費年起算日
         'strTSQL = "na10,na25,0"
         strTSQL = "na10,na25,0,na48"
      Case 4
         strTSQL = "na26,'',NVL(NA27,0)"
         blnMonthAdd = True
      Case 5
         strTSQL = "na28,'',NVL(na29,0)"
         blnMonthAdd = True
      Case 6
         strTSQL = "na30,'',NVL(na31,0)"
         blnMonthAdd = True
      Case 7
         strTSQL = "na32,'',NVL(na33,0)"
         blnMonthAdd = True
      Case 8
         strTSQL = "na34,'',NVL(na35,0)"
         blnMonthAdd = True
      Case 9
         strTSQL = "na36,'',NVL(na37,0)"
         blnMonthAdd = True
      Case 10
         strTSQL = "na12,'',NVL(na13,0)"
      Case 11
         strTSQL = "na40,'',''"
      Case 12
         strTSQL = "na43,'',''"
      Case 13
         strTSQL = "na46,'',''"
      Case Else
         strTSQL = "na06,na21,0"
   End Select
   strTSQL = "SELECT " & strTSQL & " FROM NATION WHERE NA01=" + CNULL(strNation)
   intI = 1
   Set RsTemp = ClsLawReadRstMsg(intI, strTSQL) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strTSQL)
   With RsTemp
   If intI = 1 Then
      'Add by Morgan 2010/7/15
      '年費
      strStartYear = ""
      If intChoose >= 1 And intChoose <= 3 Then
         '若年費起算日<>繳費年起算日時
         If Not IsNull(.Fields(3)) Then
            If .Fields(3) <> .Fields(0) Then
               '抓案件進度檔的i=1, 基本檔的i=2
               i = 1
               Select Case .Fields(3)
                  Case 收文日
                     strTSQL = "CP05"
                  Case 申請日
                     strTSQL = "PA10"
                     i = 2
                  Case 發文日
                     strTSQL = "CP27"
                  Case 准駁日
                     strTSQL = "PA20"
                     i = 2
                  Case 公告日
                     strTSQL = "PA14"
                     i = 2
                  Case 發證日
                     strTSQL = "PA21"
                     i = 2
                  Case 公開日
                     strTSQL = "PA12"
                     i = 2
               End Select
               If i = 1 Then
                  strTSQL = "SELECT " & strTSQL & " FROM CASEPROGRESS WHERE CP09='" & strTxt(0) & "'"
               Else
                  strTSQL = "SELECT " & strTSQL & " FROM PATENT WHERE PA01='" & strTxt(1) & "' AND " & _
                     "PA02='" & strTxt(2) & "' AND PA03='" & strTxt(3) & "' AND PA04='" & strTxt(4) & "'"
               End If
               intI = 1
               Set rsTemp1 = ClsLawReadRstMsg(intI, strTSQL)
               If intI = 1 Then
                  strStartYear = Left("" & rsTemp1(0), 4)
               End If
               i = 0
               strTSQL = ""
            End If
         End If
      End If
      'end 2010/7/15
   
      If Not IsNull(.Fields(1)) Then strYear = .Fields(1)
      If Not IsNull(.Fields(0)) Then
        '抓案件進度檔的i=1, 基本檔的i=2
         i = 1
         Select Case .Fields(0)
            Case 收文日
               strTSQL = "CP05"
            Case 申請日
               strTSQL = "PA10"
               i = 2
            Case 發文日
               strTSQL = "CP27"
            Case 准駁日
                'Modify By Cheng 2002/10/29
'               strTSQL = "CP25"
               strTSQL = "PA20"
                'Add By Cheng 2002/10/29
               i = 2
            Case 公告日
               strTSQL = "PA14"
               i = 2
            Case 發證日
               strTSQL = "PA21"
               i = 2
            Case 公開日
               strTSQL = "PA12"
               i = 2
         End Select
      Else
         GetMoneyDate = True
         Exit Function
'         strTSQL = "PA10"
'         i = 2
      End If
      '2010/4/21 MODIFY BY SONIA 加PA72因荷蘭修法發明新型在2008/6/5以前有繳過年費者，自申請日起第5年逐年繳交年費,未繳過者自申請日起第4年逐年繳交年費，准後繳
      If i = 1 Then
         strTSQL = "SELECT " & strTSQL & ",PA10 AD,PA72,PA21 RD,PA11 FROM CASEPROGRESS,PATENT WHERE CP09='" & strTxt(0) & "' AND PA01(+)=CP01 AND PA02(+)=CP02 AND PA03(+)=CP03 AND PA04(+)=CP04"
      Else
         strTSQL = "SELECT " & strTSQL & ",PA10 AD,PA72,PA21 RD,PA11 FROM PATENT WHERE PA01='" & strTxt(1) & "' AND " & _
            "PA02='" & strTxt(2) & "' AND PA03='" & strTxt(3) & "' AND PA04='" & strTxt(4) & "'"
      End If
      intI = 1
      Set rsTemp1 = ClsLawReadRstMsg(intI, strTSQL) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strTSQL)
      If intI = 1 Then
         strPA10 = "" & rsTemp1.Fields("AD") 'Add by Morgan 2008/2/27
         strPA72 = "" & rsTemp1.Fields("PA72")  '2010/4/21 add by sonia
         strPA21 = "" & rsTemp1.Fields("RD") 'Add by Morgan 2010/9/30
         StrPA11 = "" & rsTemp1.Fields("PA11") 'Add by Morgan 2013/11/11
         If Not IsNull(rsTemp1.Fields(0)) Then
            Select Case intChoose
               Case 11, 12, 13
                  strDate = rsTemp1.Fields(0)
               Case Else
                  strDate = rsTemp1.Fields(0)
'                  strDate = CompDate(2, -1, rsTemp1.Fields(0))
                  'Modify By Cheng 2002/06/18
'                  strEnd = Val(Left(strDate, 4)) + .Fields(2) & Right(strDate, 4)
                  If blnMonthAdd = True Then
                        'Modify By Cheng 2003/09/02
'                     strEnd = Val(DBDATE(DateSerial(DBYEAR(strDate), DBMONTH(strDate) + .Fields(2).Value, DBDAY(strDate))))
                     strEnd = Val(DBDATE(DateAdd("m", Val(.Fields(2).Value), ChangeWStringToWDateString(DBDATE(strDate)))))
                  Else
                     'Modify by Morgan 2008/12/24 閏年會錯
                     'strEnd = Val(Left(strDate, 4)) + .Fields(2) & Right(strDate, 4)
                     strEnd = CompDate(0, .Fields(2), strDate)
                  End If
                  'Add by Morgan 2010/7/15
                  If strStartYear <> "" Then
                     strDate = strStartYear & Mid(strDate, 5)
                  End If
                  'end 2010/7/15
            End Select
         End If
      End If
      
      'Modify by Morgan 2006/3/3 大陸不必減一天
      'If strEnd <> "0" Then strEnd = CompDate(2, -1, strEnd)
      'Modify by Morgan 2007/3/27 澳門也不必減一天
      '2008/11/6 modif by sonia 香港案也不必減一天,P-73430年費逾期
      'If strEnd <> "0" And strNation <> "020" And strNation <> "044" Then strEnd = CompDate(2, -1, strEnd)
      'modify by sonia 2017/8/11 郭雅娟說大陸的專用期止日要減一天但年費期限不可減一天
      'If strEnd <> "0" And strNation <> "020" And strNation <> "044" And strNation <> "013" Then
      'Modified by Morgan 2018/7/6 +澳門專用期止日也要減一天 --玲玲
      'Modified by Morgan 2019/12/11 專用期止日是否減1天改在上面計算時用函數控制
      'If strEnd <> "0" And (strNation = "020" Or strNation = "044") Then
      '   If intChoose >= 11 And intChoose <= 13 Then  '大陸案只有專用期止日要減一天
      '      strEnd = CompDate(2, -1, strEnd)
      '   End If
      'ElseIf strEnd <> "0" And strNation <> "044" And strNation <> "013" Then
      '   strEnd = CompDate(2, -1, strEnd)
      'End If
      If strEnd <> "0" And Not (intChoose >= 11 And intChoose <= 13) Then
         If strNation <> "020" And strNation <> "044" And strNation <> "013" Then
            strEnd = CompDate(2, -1, strEnd)
         End If
      End If
      'end 2019/12/11
      '2008/11/6 end
      
      'Added by Morgan 2021/5/28
      '大陸外觀設計案 2021/6/1以前申請的案件專用期為申請日起10年
      If intChoose = "13" And strTxt(1) = "P" And strNation = "020" And strPA10 < "20210601" Then
         If strPA10 > "0" Then
            strEnd = PUB_GetEndDate(strPA10, 10, stReduecOneDay, strNation)
         End If
      End If
      'end 2021/5/28
               
      'Added by Morgan 2013/11/11
      '台灣專利衍生設計專用期止日與母案相同
      If intChoose = 13 And (strTxt(1) = "P" Or strTxt(1) = "FCP") And strNation = "000" Then
         If Mid(StrPA11, 10, 1) = "D" Then
            strTSQL = "SELECT PA25 FROM PATENT WHERE PA11='" & Left(StrPA11, 9) & "' and PA25>0"
            intI = 1
            Set rsTemp1 = ClsLawReadRstMsg(intI, strTSQL)
            If intI = 1 Then
               strEnd = rsTemp1(0)
            End If
         End If
      End If
      'end 2013/11/11
      
'Modified by Morgan 2013/10/23
'
'      'Modify by Morgan 2009/11/5 將CFP年費發文之規則並入
'      '2005/9/23 ADD BY SONIA 各國修法
'      Select Case strNation
'         Case "000" '台灣
'            'Add by Morgan 2005/3/2 台灣新型舊法為12年
'            'Modify by Moragn 2005/7/19 判斷有公告日
'            'If intChoose = 2 And strNation = "000" And Val(strDate) <= 20040701 Then
'            If intChoose = 2 And strNation = "000" And Val(strDate) > 0 And Val(strDate) <= 20040701 Then
'               strYear = "1,2,3,4,5,6,7,8,9,10,11,12"
'               iFixNo = 1
'            End If
'
'         Case "011" '日本
'            '日本新型申請日在2005/3/31以前者，其專利期間為自申請日起算6年
'            If intChoose = 2 And Val(strPA10) > 0 Then
'               If Val(strPA10) < 20050331 Then
'                  strYear = "4,5,6"
'                  iFixNo = 1
'               End If
'            'Add by Morgan 2007/4/20
'            '日本設計自申請日2007/4/1起改用新法,舊法為發證日起15年,第4年起逐年繳交。
'            ElseIf intChoose = 3 And Val(strPA10) > 0 Then
'               If Val(strPA10) < 20070401 Then
'                  strYear = "4,5,6,7,8,9,10,11,12,13,14,15"
'                  iFixNo = 1
'               End If
'            End If
'
'         Case "012" '韓國
'            'Add by Morgan 2008/2/27 申請日20061001以後者自申請日起10年，自發證日起第4年須逐年繳交年費
'            If intChoose = 2 And Val(strPA10) > 0 Then
'               '申請日在1999/7/1以前者，自申請日起15年
'               If Val(strPA10) < 19990701 Then
'                  '2008/11/27 MODIFY BY SONIA
'                  'strYear = ",2,3,4,5,6,7,8,9,10,11,12,13,14,15"
'                  strYear = "2,3,4,5,6,7,8,9,10,11,12,13,14,15"
'                  iFixNo = 1
'               '2008/11/27 MODIFY BY SONIA 申請日在1999/7/1~20061001者，自申請日起10年，繳費年度自發證日起算第2，4，5，6，7，8，9，10年
'               ElseIf Val(strPA10) < 20061001 Then
'                  strYear = "2,4,5,6,7,8,9,10"
'                  iFixNo = 2
'               End If
'            End If
'            '設計申請日在1998/3/1以前者，自發證日起10年,無案件
'            '    申請日在1998/3/1以後者，自發證日起15年
'
'         Case "015" '澳洲
'            '2012/5/18 ADD BY SONIA 20080701以後申請者，專用期限自申請日起20年，惟自申請日第5年須逐年繳年費
'            If intChoose = 1 And Val(strPA10) > 0 Then
'               '申請日在20080701以前者,自申請日第6年須逐年繳年費
'               If Val(strPA10) < 20080701 Then
'                  strYear = "6,7,8,9,10,11,12,13,14,15,16,17,18,19,20"
'                  iFixNo = 1
'               End If
'            End If
'            '2012/5/18 END
'            '20040617以後申請者，專用期限自申請日起10年，繳費年度：5、延展費
'            If intChoose = 3 And Val(strPA10) > 0 Then
'               'Modify by Morgan 2009/11/5 第一次以發證日起算,其餘為申請日(目前尚有4個案件但都只剩第3次故起算日與目前設定相同不必再特別控制)
'               '專用期限自註冊日起1年，期滿可延自申請日起6年，期滿可再延2次，1次5年，總計16年。即自發證日起至申請日起16年，繳費年度：1，6，11、延展費
'               If Val(strPA10) < 20040617 Then
'                  strYear = "1,6,11"
'                  iFixNo = 1
'               End If
'            End If
'
'         'Add by Morgan 2006/8/21
'         Case "018" '馬來西亞
'            '2010/4/21 add by sonia
'            '2001/8/1以後提申者，自申請日起20年，自發證日起第2年逐年繳交年費
'            If intChoose = "1" And Val(strPA10) > 0 Then
'               '舊法：2001/8/1以前提申者，自發證日起15年，自發證日起第2年逐年繳交年費
'               If Val(strPA10) < 20010801 Then
'                  strYear = "2,3,4,5,6,7,8,9,10,11,12,13,14,15"
'                  iFixNo = 1
'               End If
'            End If
'            '2010/4/21 end
'            If intChoose = 2 And strCP10 = "607" And Val(strPA10) > 0 Then
'               'Modify by Morgan 2007/7/18 新型不管何時提申均適用上述新法(2003年8月14日實施)
'               ''舊法(發證日<2001/8/1)自發證日起5年，期滿可延展2次，每次5年；
'               'If Val(DBDATE(field(21))) < 20010801 Then
'               '   strFeeYears = "5,10"
'               '   strStartDate = DBDATE(field(21))
'               'Else
'               '新法自申請日起10年，期滿可延展2次，每次5年；
'               '   strFeeYears = "10,15"
'               '   strStartDate = DBDATE(field(10))
'               'End If
'               strYear = "10,15"
'               strDate = strPA10
'               'end 2007/7/18
'            End If
'
'         '2010/4/21 ADD BY SONIA
'         Case "030" '菲律賓
'            '申請日在1998/1/1以後者，申請日起20年，公開日起第5年逐年繳交年費
'            If intChoose = "1" And Val(strPA10) > 0 Then
'               '申請日在1998/1/1以前者，發證日起17年，發證日起第5年逐年繳交年費
'               If Val(strPA10) < 19980101 Then
'                  strDate = strPA21
'                  strYear = "5,6,7,8,9,10,11,12,13,14,15,16,17"
'                  iFixNo = 1
'               End If
'            End If
'            '申請日在1998/1/1以後者，申請日起7年，期滿不得延展，無須繳交年費
'            If intChoose = "2" And Val(strPA10) > 0 Then
'               '申請日在1998/1/1以前者，發證日起5年，期滿可延2次，每次5年
'               If Val(strPA10) < 19980101 Then
'                  strDate = strPA21
'                  strYear = "5,10"
'                  iFixNo = 1
'               End If
'            End If
'            '設計申請日在1998/1/1以前者，發證日起5年，期滿可延2次，每次5年, 共15年, 無案件
'            '    申請日在1998/1/1以後者，申請日起5年，期滿可延2次，每次5年, 共15年
'         '2010/4/21 end
'
'         'Add by Morgan 2010/9/30 補漏(自年費發文)
'         Case "042"   '越南
'            If Val(strPA21) > 0 Then
'               If Val(strPA21) < 20031127 Then
'                  If intChoose = "1" Or intChoose = "2" Then
'                     strDate = strPA10
'                  End If
'               End If
'            End If
'
'         '2010/2/22 add by sonia
'         Case "204" '義大利
'            '申請日在2006/1/1以後者，自申請日起第5年逐年繳交年費
'            If intChoose = 1 And Val(strPA10) > 0 Then
'               '2010/7/8 與慧汶確認
'               '申請日在2006/1/1以前者，自申請日起第4年逐年繳交年費,但第1次繳費日晚於20070101者仍自第5年開始繳交
'               If Val(strPA10) < 20060101 And (DBDATE(GetFeeNextDate(strDate, 3, strNation, intChoose)) < 20070101) Then
'                  strYear = "4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20"
'                  iFixNo = 1
'               End If
'            End If
'         '2010/2/22 end
'
'         '2010/4/21 ADD BY SONIA
'         Case "206" '奧地利 (無案件)
'            '發明案2010年1月1日起，自申請日第6年起每年須繳交年費(准後始須繳交)
'            '原自申請日第3年起每年繳年費,但下次繳費日未至第6年則該年不必繳(無案件)
'            If intChoose = 1 And strPA72 <> "" Then
'               strYear = "3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20"
'               iFixNo = 1
'            End If
'
'            '新型案2010年1月1日起，自申請日第4年起每年須繳交年費(准後始須繳交)
'            '原自申請日第2年起每年繳年費,但下次繳費日未至第4年則該年不必繳(無案件)
'            If intChoose = 2 And strPA72 <> "" Then
'               strYear = "2,3,4,5,6,7,8,9,10"
'               iFixNo = 1
'            End If
'
'         Case "207" '荷蘭發明新型
'            '在2008/6/5以前有繳過年費者，自申請日起第5年逐年繳交年費
'            '否則自申請日起第4年逐年繳交年費
'            '2010/4/22 ADD BY SONIA 修法雖自第4年起繳交,但若第4年已過期則仍自第5年起繳 CFP-016429
'            If intChoose = 1 Then
'               If strPA72 = "" And DBDATE(GetFeeNextDate(strDate, 3, strNation, intChoose)) < strSrvDate(1) Then
'                  strYear = "5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20"
'                  iFixNo = 1
'               ElseIf strPA72 <> "" Then
'                  If Mid(strPA72, 1, 1) <> "4" Then
'                     strYear = "5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20"
'                     iFixNo = 1
'                  End If
'               End If
'            End If
'            '2010/4/22 END
'            If intChoose = 2 Then
'               iFixNo = 1     '2010/7/12 ADD BY SONIA 荷蘭2008/6/5取消新型,故修法次數都為1
'               If strPA72 = "" And DBDATE(GetFeeNextDate(strDate, 3, strNation, intChoose)) < strSrvDate(1) Then
'                  strYear = "5,6"
'                  iFixNo = 1
'               ElseIf strPA72 <> "" Then
'                  If Mid(strPA72, 1, 1) <> "4" Then
'                     'Modify by Morgan 2010/6/8
'                     'strYear = "5,6"
'                     strYear = Replace(strYear, "4,", "")
'                     iFixNo = 1
'                  End If
'               End If
'            End If
'         '2010/4/21 END
'
'         Case "211" '西班牙
'            '申請日在2003/7/9以後者，其專利期間為自發證日起25年，繳費年度：5，10，15，20、延展費
'            If intChoose = 3 And Val(strPA10) > 0 Then
'               '申請日在2003/7/9以前者，其專利期間為自核准日起20年，繳費年度：5，10，15、延展費
'               If Val(strPA10) < 20030709 Then
'                  strYear = "5,10,15"
'                  iFixNo = 1
'               End If
'            End If
'
'         'Add by Morgan 2007/7/31
'         Case "233" '俄羅斯
'            '新型延展費:自申請日起5年,可延展3年
'            If intChoose = "2" And strCP10 = "607" And Val(strPA10) > 0 Then
'               '2008/10/6 MODIFY BY SONIA 2008/1/1修法改申請日起10年,2008/1/1日以後還有效的案件都適用
'               'strFeeYears = "5"
'               strYear = "10"
'               strDate = strPA10
'            End If
'
'      End Select
'
      'Added by Morgan 2022/6/13
      If strCP10 = "" And intChoose >= 1 And intChoose <= 3 Then
         strCP10 = PUB_GetNa20Na22Na24(strNation, intChoose, strPA10)
      End If
      'end 20222/6/13
      'Modified by Morgan 2025/8/7 +傳入本所案號
      PUB_GetSpecAnnuityRef strNation, intChoose, strPA10, strCP10, strPA21, strPA72, strYear, iFixNo, strDate
'end 2013/10/23
      
      GetMoneyDate = True
   End If
   End With
   Exit Function
ErrHand:
   MsgBox "錯誤 : " & Err.Description, vbCritical
End Function

''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' 設定控制項的內容為全部選取反白
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Public Sub InverseTextBox(ByRef txBox As Control)
   txBox.SelStart = 0
   txBox.SelLength = Len(txBox.Text)
End Sub
'取得員工收文所屬部門
Public Function PUB_GetStaffST15(StrST01 As String, strKind As String) As String
'strKind : 1.部門編號2.部門名稱
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset

PUB_GetStaffST15 = ""
StrSQLa = "Select ST15,A0902 From Staff, Acc090 Where ST15=A0901(+) And ST01='" & StrST01 & "' "
rsA.CursorLocation = adUseClient
rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
If rsA.RecordCount > 0 Then
   PUB_GetStaffST15 = IIf(strKind = "1", "" & rsA.Fields(0).Value, "" & rsA.Fields(1).Value)
End If
If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing

End Function

'Add by Morgan 2005/3/21
'取得員工等級
Public Function PUB_GetST05(ByVal p_User As String) As String
Dim RsQ As New ADODB.Recordset 'Add By Sindy 2021/12/14

   strSql = "select st05 from staff where st01='" & p_User & "'"

On Error GoTo ErrHnd

   'CheckOC3 'Modify By Sindy 2021/12/14 Mark
   With RsQ
      .CursorLocation = adUseClient
      .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      If .RecordCount > 0 Then
         PUB_GetST05 = "" & .Fields(0)
      End If
   End With
   
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
   Set RsQ = Nothing 'Add By Sindy 2021/12/14
End Function

'Add by Sindy 2009/05/12
'取得員工等級
'判斷操作人員的ST05為SA,並且在職員工的ST52有該編號存在,此類人員稱之為帶人主管
'modify by sonia 2016/6/7 不必限制st05='SA',因為72014可查S29,20012
'2009/9/15 modify by sonia 林協理要求開放離職之謝佩旻96024資料給葉招進85026看,故取消st04='1'
Public Function PUB_GetST05Limits(ByVal p_User As String) As Boolean
   PUB_GetST05Limits = False
   
   'Modify By Sindy 2014/8/28 ST53,ST54,ST55均為帶人主管
'   strSql = "select * from staff where st05='SA' " & _
'                   "and st01 in (select st52 from staff where st52='" & p_User & "')"
   'modify by sonia 2016/6/7 不必限制st05='SA',因為72014可查S29,20012,故改寫法
   'strSql = "select st01,st02 from staff where st05='SA' " & _
                   "and (st01 in(select st52 from staff where st52='" & p_User & "')" & _
                    " or st01 in(select st53 from staff where st53='" & p_User & "')" & _
                    " or st01 in(select st54 from staff where st54='" & p_User & "')" & _
                    " or st01 in(select st55 from staff where st55='" & p_User & "')" & _
                   ")"
   strSql = "select st01 from staff where instr(st52||st53||st54||st55,'" & p_User & "')>0"
   '2014/8/28 END
   
On Error GoTo ErrHnd
   
   CheckOC3
   With AdoRecordSet3
      .CursorLocation = adUseClient
      .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      If .RecordCount > 0 Then
         PUB_GetST05Limits = True
      End If
   End With
   
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
End Function

'Add by Sindy 2009/05/12
'取得第二級期限管制人
'Modify By Sindy 2014/8/28 ST53,ST54,ST55均為帶人主管
'Public Function PUB_GetST52(ByVal p_User As String) As String
Public Function PUB_GetST52(ByVal p_User As String, ByVal p_chkUser) As Boolean
   
   PUB_GetST52 = False
   strSql = "select st01 from staff where st01='" & p_User & "'" & _
            " and (st52='" & p_chkUser & "' or st53='" & p_chkUser & "' or st54='" & p_chkUser & "' or st55='" & p_chkUser & "')"
   
On Error GoTo ErrHnd

   CheckOC3
   With AdoRecordSet3
      .CursorLocation = adUseClient
      .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      If .RecordCount > 0 Then
         'PUB_GetST52 = "" & .Fields(0)
         PUB_GetST52 = True
      End If
   End With
   
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
End Function

'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' 取得主機上的系統日期
' Output : 傳回主機上的系統日期(西元)
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Public Function SystemDate() As String
   SystemDate = DBDATE(CStr(ServerDate()))
End Function
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' 傳回欲儲存到資料庫中正確的字串值
' Input : strData ==> 字串內容
' Output : 此函式會回傳即將存入資料庫SQL語法中的文字資料內容
'          若是有資料的情況, 回傳值自動會加上前後的單引號
'          若沒有資料時, 回傳值會是一個內容為NULL字樣的字串
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Public Function DBNullString(ByVal strData As String) As String
   If IsEmptyText(strData) = True Then
      DBNullString = "NULL"
   Else
      DBNullString = "'" & ChgSQL(strData) & "'"
   End If
End Function
'判斷是否回復或反白
Public Sub ShowBar(ByRef grdTemp As MSHFlexGrid, ByRef intLastRow As Integer, ByVal intCols As Integer)
Dim intLast As Integer

If grdTemp.row = 0 Then
   grdTemp.row = 1
ElseIf grdTemp.row > grdTemp.Rows Then
   grdTemp.row = grdTemp.Rows
End If
If intLastRow = grdTemp.row Then Exit Sub
intLast = grdTemp.row
grdTemp.Visible = False
If intLastRow <> 0 Then
   ShowNormal grdTemp, intLastRow, intCols
End If
grdTemp.row = intLast
ShowInverse grdTemp, intLastRow, intCols
grdTemp.Visible = True
'Modify By Sindy 2019/7/26 Mark:CFP發文作業標題會被反白
'If grdTemp.Visible Then grdTemp.SetFocus
End Sub
'回復
Private Sub ShowNormal(ByRef grdTemp As MSHFlexGrid, ByRef intLastRow As Integer, ByVal intCols As Integer)
Dim i As Integer

If grdTemp.Rows = 0 Then Exit Sub
grdTemp.row = intLastRow
For i = 0 To intCols
       grdTemp.col = i
       grdTemp.CellBackColor = grdTemp.BackColor
Next
End Sub
'反白
Private Sub ShowInverse(ByRef grdTemp As MSHFlexGrid, ByRef intLastRow As Integer, ByVal intCols As Integer)
Dim i As Integer

If grdTemp.Rows = 0 Then Exit Sub
For i = 0 To intCols
       grdTemp.col = i
       grdTemp.CellBackColor = &HFFC0C0
Next
grdTemp.col = 0
intLastRow = grdTemp.row
End Sub
'bolChooseGridList是否有勾選 即第一列是否要置中
Public Sub SetDataListVision(ByRef grdTemp As MSHFlexGrid, Optional bolChoose As Boolean = False, Optional bolMerge As Boolean = False)
Dim i As Integer, j As Integer

'grdTemp.Visible = False
If bolMerge Then
   grdTemp.MergeCells = flexMergeRestrictRows
   grdTemp.MergeRow(0) = True
'   For i = 0 To grdTemp.Rows - 1
'          grdTemp.MergeRow(i) = True
'   Next
End If
If bolChoose Then
   grdTemp.col = 0
   For i = 1 To grdTemp.Rows - 1
          grdTemp.row = i
          grdTemp.CellAlignment = flexAlignCenterCenter
   Next
End If
grdTemp.row = 0
For i = 0 To grdTemp.Cols - 1
       grdTemp.col = i
       grdTemp.CellAlignment = flexAlignCenterCenter
Next
'去除Bug
If grdTemp.Rows > 1 Then
   Dim intLastHeight As Integer
   
   intLastHeight = grdTemp.Height
   grdTemp.FixedRows = 0
   grdTemp.Height = 200
   grdTemp.TopRow = grdTemp.Rows - 1
   grdTemp.FixedRows = 1
   grdTemp.TopRow = 1
   grdTemp.Height = intLastHeight
   grdTemp.Enabled = True
Else
   grdTemp.Enabled = False
End If
grdTemp.Visible = True
End Sub

Public Sub GridGotFocus(ByRef grdTemp As MSHFlexGrid)
grdTemp.BackColorFixed = &H800000
grdTemp.ForeColorFixed = vbWhite
End Sub
Public Sub GridLostFocus(ByRef grdTemp As MSHFlexGrid)
grdTemp.BackColorFixed = vbButtonFace
grdTemp.ForeColorFixed = vbButtonText
End Sub
Public Sub SetGridDataListWidth(ByRef grdTemp As MSHFlexGrid, ByRef varGridWidth() As Variant)
Dim i As Integer
grdTemp.Visible = False
For i = 0 To UBound(varGridWidth)
       grdTemp.ColWidth(i) = varGridWidth(i)
Next
For i = i To grdTemp.Cols - 1
       grdTemp.ColWidth(i) = 0
Next
grdTemp.Visible = True
End Sub
'以總收文號來查詢案件是否閉卷
Public Function PUB_CaseClosedCP09(strCP09 As String) As Boolean
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset

PUB_CaseClosedCP09 = False

StrSQLa = "SELECT PA57 FROM PATENT,CASEPROGRESS WHERE CP01=PA01(+) AND CP02=PA02(+) AND CP03=PA03(+) AND CP04=PA04(+) AND CP09='" & strCP09 & "'" & _
         " UNION SELECT TM29 FROM TRADEMARK,CASEPROGRESS WHERE CP01=TM01(+) AND CP02=TM02(+) AND CP03=TM03(+) AND CP04=TM04(+) AND CP09='" & strCP09 & "'" & _
         " UNION SELECT LC08 FROM LAWCASE,CASEPROGRESS WHERE CP01=LC01(+) AND CP02=LC02(+) AND CP03=LC03(+) AND CP04=LC04(+) AND CP09='" & strCP09 & "'" & _
         " UNION SELECT HC09 FROM HIRECASE,CASEPROGRESS WHERE CP01=HC01(+) AND CP02=HC02(+) AND CP03=HC03(+) AND CP04=HC04(+) AND CP09='" & strCP09 & "'" & _
         " UNION SELECT SP15 FROM SERVICEPRACTICE,CASEPROGRESS WHERE CP01=SP01(+) AND CP02=SP02(+) AND CP03=SP03(+) AND CP04=SP04(+) AND CP09='" & strCP09 & "'"
rsA.CursorLocation = adUseClient
rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
If rsA.RecordCount > 0 Then
   If "" & rsA.Fields(0).Value = "Y" Then
      MsgBox "此案件已閉卷, 不可執行發文作業!!!", vbExclamation + vbOKOnly
      PUB_CaseClosedCP09 = True
   End If
Else
   MsgBox "無此案件基本資料, 請檢查是否案號輸入錯誤!!!", vbExclamation + vbOKOnly
   PUB_CaseClosedCP09 = True
End If
If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing

End Function

'Add By Cheng 2002/07/15
Public Function PUB_CPKindDelay(strCP09 As String, strKind As String) As Boolean
Dim rsA As New ADODB.Recordset
Dim StrSQLa As String
   
PUB_CPKindDelay = False
'Modify By Sindy 2013/4/11
'StrSQLa = "Select CP10 FROM CASEPROGRESS WHERE CP09='" & strCP09 & "' "
StrSQLa = "Select CP10,TM10,CP01,CP02,CP03,CP04 FROM CASEPROGRESS,Trademark WHERE CP09='" & strCP09 & "' and CP01=TM01 and CP02=TM02 and CP03=TM03 and CP04=TM04" & _
          " Union All" & _
          " Select CP10,PA09,CP01,CP02,CP03,CP04 FROM CASEPROGRESS,Patent WHERE CP09='" & strCP09 & "' and CP01=PA01 and CP02=PA02 and CP03=PA03 and CP04=PA04"
'2013/4/11 End
rsA.CursorLocation = adUseClient
rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
If rsA.RecordCount > 0 Then
   Select Case strKind
   Case "P" '專利
      'Modify By Sindy 2013/4/11 大陸復審案不可點選延期
      'If "" & rsA.Fields(0).Value = "404" Then
      If "" & rsA.Fields(0).Value = "404" Or _
         ("" & rsA.Fields(1).Value = "020" And "" & rsA.Fields(0).Value = "107") Then
      '2013/4/11 End
         MsgBox "所點選的案件性質不可為延期!!!", vbExclamation + vbOKOnly
         PUB_CPKindDelay = True
      End If
   Case "T" '商標
      If "" & rsA.Fields(0).Value = "303" Then
         MsgBox "所點選的案件性質不可為延期!!!", vbExclamation + vbOKOnly
         PUB_CPKindDelay = True
      End If
   Case Else
      '無動作
   End Select
End If
If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing
   
End Function
Public Function PUB_GetCPunIssueDatas(strCPNo As String) As Boolean
   Dim Rs As New ADODB.Recordset
   Dim strSql As String
   Dim arrCPNO
   Dim strOldCPNo As String
   Dim ii As Integer
   Dim strCP(1 To 4) As String
'Add By Cheng 2002/12/12
'預設本案件無未發文資料
PUB_GetCPunIssueDatas = False

   strOldCPNo = strCPNo
   arrCPNO = Split(strCPNo, "-")
   For ii = 0 To UBound(arrCPNO)
      strCP(ii + 1) = Trim(arrCPNO(ii))
   Next ii
   If UBound(arrCPNO) = 1 Then
      strCP(3) = "0"
      strCP(4) = "00"
   ElseIf UBound(arrCPNO) = 2 Then
      strCP(4) = "00"
   End If
   If Rs.State <> adStateClosed Then Rs.Close
   Set Rs = Nothing
   '2009/9/9 MODIFY BY SONIA 加CP10<>'0'條件
   strSql = "Select * From CaseProgress Where CP01='" & strCP(1) & "' And CP02='" & strCP(2) & "' And CP03='" & strCP(3) & "' And CP04='" & strCP(4) & "' " & _
            " And CP27 Is Null And CP57 Is Null AND CP10<>'0' And CP09<'C' "
   Rs.CursorLocation = adUseClient
   Rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If Rs.RecordCount > 0 Then
      MsgBox UCase(strOldCPNo) & " 尚有未發文的資料!!! ", vbExclamation + vbOKOnly
        'Add By Cheng 2002/12/12
        '預設本案件無未發文資料
        PUB_GetCPunIssueDatas = True
   End If
   If Rs.State <> adStateClosed Then Rs.Close
   Set Rs = Nothing

End Function

'取得部門
Public Function PUB_GetST03(strUserNum As String) As String
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset

PUB_GetST03 = ""
StrSQLa = "Select ST03 From Staff Where ST01='" & strUserNum & "' "
rsA.CursorLocation = adUseClient
rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
If rsA.RecordCount > 0 Then
    PUB_GetST03 = "" & rsA.Fields(0).Value
End If
If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing

End Function
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' 取得字串的位元組長度
' Input : strData ==> 所要處理的字串
' Output : 傳回字串的實際位元組長度
' 說明 : 此功能會將UNICODE的字串轉換成MBCS的字串再取其實際的長度
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Public Function StrLength(ByVal strData As String) As Long
   Dim strTemp As String
   strTemp = strData
   StrLength = LenB(StrConv(strTemp, vbFromUnicode))
End Function

'Modify by Amy 2017/10/13 +stSP01參數:有值先抓SP48部門
'Modified by Lydia 2019/09/16 +stST06 所別
Public Function GetST15(ByVal st01 As String, Optional a0902 As String, Optional ByVal stSP01 As String = "", Optional ByRef stST06 As String = "") As String
Dim intQ As Integer
Dim strQuery As String
Dim rsQuery As New ADODB.Recordset

   GetST15 = ""
   a0902 = ""
   stST06 = ""  'Added by Lydia 2019/09/16
   
   'Modify by Amy 2017/10/13
   If stSP01 = MsgText(601) Then
      'Modified by Lydia 2019/09/16 +ST06
      strQuery = "SELECT ST15,a0902,ST06 FROM STAFF,ACC090 WHERE ST01='" & st01 & "' AND ST15=a0901(+)"
   Else
      'Modified by Lydia 2019/09/16 +ST06
      strQuery = "SELECT Nvl(SP48,ST15) as ST15,a0902,ST06 FROM STAFF,ACC090,SalesPoint " & _
                  "WHERE ST01='" & st01 & "' AND Nvl(SP48,ST15)=a0901 " & _
                  "AND ST01=SP02(+) AND " & IIf(Val(stSP01) > 201601, stSP01, 201512) & "=SP01(+)"
   End If
   'end 2017/10/13
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, strQuery) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intq, strquery)
   If intQ = 1 Then
      If Not IsNull(rsQuery.Fields("ST15")) Then GetST15 = "" & rsQuery.Fields("ST15")
      If Not IsNull(rsQuery.Fields("a0902")) Then a0902 = "" & rsQuery.Fields("a0902")
      stST06 = "" & rsQuery.Fields("ST06") 'Added by Lydia 2019/09/16
   End If
   
   Set rsQuery = Nothing
End Function
'''''''''''''''''''''''''''''''''''''''''''''''''''''
' 檢查使用者是否有使用此系統類別的權利
' Input : strUser ==> 員工的代號
'         strSys ==> 本所案號的系統類別
' Output : 若該員工可以存取該系統類別的資料則傳回True
'          否則傳回False
'''''''''''''''''''''''''''''''''''''''''''''''''''''
Public Function IsUserHasRightOfSystem(ByVal strUser As String, ByVal strSys As String) As Boolean
   Dim rsTmp As New ADODB.Recordset
   Dim strSql As String
   
   IsUserHasRightOfSystem = False
   strSql = "SELECT ST11 FROM Staff " & _
            "WHERE ST01 = '" & strUser & "' "
   rsTmp.CursorLocation = adUseClient
   rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If rsTmp.RecordCount > 0 Then
      If IsNull(rsTmp.Fields("ST11")) = False Then
         strGroup = rsTmp.Fields("ST11")
      End If
   Else
      rsTmp.Close
      GoTo EXITSUB
   End If
   rsTmp.Close
   strSql = Empty

   strSql = "SELECT * FROM Staff_Group " & _
            "WHERE SG01 = '" & strGroup & "' AND " & _
                  "SG02 = '" & strSys & "' "
   rsTmp.CursorLocation = adUseClient
   rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If rsTmp.RecordCount > 0 Then
   Else
      rsTmp.Close
      GoTo EXITSUB
   End If
   IsUserHasRightOfSystem = True
   
EXITSUB:
End Function
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' 取得國家的名稱
' Input : strNation ==> 國家代碼
'         nLanguage ==> 0 表取得國內名稱
'                       1 表取得國外名稱
' Output : 傳回國家的名稱
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Public Function GetNationName(ByVal strNation As String, Optional ByVal nLanguage As Integer) As String
   Dim rsTmp As New ADODB.Recordset
   Dim strSql As String
   GetNationName = Empty
   
   ' 檢查取得國內還是國外名稱的範圍
   If nLanguage < 0 Or nLanguage > 1 Then: nLanguage = 0
   
   strSql = "SELECT * FROM NATION " & _
            "WHERE NA01 = '" & strNation & "'"
   rsTmp.CursorLocation = adUseClient
   rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If rsTmp.RecordCount > 0 Then
      rsTmp.MoveFirst
      Select Case nLanguage
         Case 0:
            If IsNull(rsTmp.Fields("NA03")) = False Then
               GetNationName = rsTmp.Fields("NA03")
            End If
         Case 1:
            If IsNull(rsTmp.Fields("NA04")) = False Then
               GetNationName = rsTmp.Fields("NA04")
            End If
      End Select
   End If
   rsTmp.Close
   Set rsTmp = Nothing
End Function

''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' 取得國外代理人的姓名
' Input : strAgent ==> 代理人的代碼
' Output : 傳回國外代理人的姓名
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
'Modify By Sindy 2014/2/14 +, Optional ByRef strFA03 As String = "", _
                              Optional ByRef strFA07 = "", Optional ByRef strFA08 = "", Optional ByRef strFA09 = "", _
                              Optional ByRef strFA52 = "", Optional ByRef strFA53 = "", Optional ByRef strFA54 = "", _
                              Optional ByRef strFA106 = "", Optional ByRef strFA107 = "", Optional ByRef strFA111 = ""
'Modify By Sindy 2022/3/16 + , Optional ByRef strFA91 As String = ""
'Add By Sindy 2025/7/22
'         nLanguage ==> 0 : 表取得的是中文名稱(無中文取英文, 無英文取日文)
'                       1 : 表取得的是英文名稱(無英文取中文, 無中文取日文)
'                       (預設值為0)
Public Function GetFAgentName(ByVal strAgent As String, Optional ByRef strFA03 As String = "", _
                              Optional ByRef strFA07 As String = "", Optional ByRef strFA08 As String = "", Optional ByRef strFA09 As String = "", _
                              Optional ByRef strFA52 As String = "", Optional ByRef strFA53 As String = "", Optional ByRef strFA54 As String = "", _
                              Optional ByRef strFA106 As String = "", Optional ByRef strFA107 As String = "", Optional ByRef strFA111 As String = "", _
                              Optional ByRef strFA109 As String = "", Optional ByRef strFA91 As String = "", Optional ByVal nLanguage As String = 1) As String
   Dim rsTmp As New ADODB.Recordset
   Dim strSql As String
   Dim strFA01 As String
   Dim strFA02 As String
   
   ' 設定 KEY 值
   strFA01 = Mid(strAgent, 1, 8)
   If Len(strFA01) < 8 Then: strFA01 = strFA01 & String(8 - Len(strFA01), "0")
   strFA02 = Mid(strAgent, 9, 1)
   If strFA02 = Empty Then: strFA02 = "0"
   
   'Add By Sindy 2025/7/22
   ' 檢查取得中文還是英文名稱的範圍
   If nLanguage < 0 Or nLanguage > 1 Then: nLanguage = 0
   '2025/7/22 END
   
   ' 設定初始值
   GetFAgentName = Empty
   
   ' 組成SQL語法
   strSql = "SELECT * FROM FAGENT " & _
            "WHERE FA01 = '" & strFA01 & "' AND " & _
                  "FA02 = '" & strFA02 & "' "
   rsTmp.CursorLocation = adUseClient
   rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   'Add By Sindy 2014/2/14
   strFA03 = ""
   strFA07 = ""
   strFA08 = ""
   strFA09 = ""
   strFA52 = ""
   strFA53 = ""
   strFA54 = ""
   strFA106 = ""
   strFA107 = ""
   strFA111 = ""
   '2014/2/14 END
   strFA109 = "" 'Add By Sindy 2020/3/4
   strFA91 = "" 'Add By Sindy 2022/3/16
   ' 判斷是否有資料
   If rsTmp.RecordCount > 0 Then
      'Add By Sindy 2014/2/14
      strFA03 = "" & rsTmp.Fields("FA03")
      strFA07 = "" & rsTmp.Fields("FA07")
      strFA08 = "" & rsTmp.Fields("FA08")
      strFA09 = "" & rsTmp.Fields("FA09")
      strFA52 = "" & rsTmp.Fields("FA52")
      strFA53 = "" & rsTmp.Fields("FA53")
      strFA54 = "" & rsTmp.Fields("FA54")
      strFA106 = "" & rsTmp.Fields("FA106")
      strFA107 = "" & rsTmp.Fields("FA107")
      strFA111 = "" & rsTmp.Fields("FA111")
      '2014/2/14 END
      strFA109 = "" & rsTmp.Fields("FA109") 'Add By Sindy 2020/3/4
      strFA91 = "" & rsTmp.Fields("FA91") 'Add By Sindy 2022/3/16
      'Add By Sindy 2025/7/22
      Select Case nLanguage
         Case 0:
            If IsNull(rsTmp.Fields("FA04")) = False Then
               GetFAgentName = rsTmp.Fields("FA04")
            End If
            If IsEmptyText(GetFAgentName) = True Then
               If IsNull(rsTmp.Fields("FA05")) = False Then
                  GetFAgentName = rsTmp.Fields("FA05")
               End If
            'If IsEmptyText(GetFAgentName) = True Then
               If IsNull(rsTmp.Fields("FA63")) = False Then
                  GetFAgentName = GetFAgentName & " " & rsTmp.Fields("FA63")
               End If
            'End If
            'If IsEmptyText(GetFAgentName) = True Then
               If IsNull(rsTmp.Fields("FA64")) = False Then
                  GetFAgentName = GetFAgentName & " " & rsTmp.Fields("FA64")
               End If
            'End If
            'If IsEmptyText(GetFAgentName) = True Then
               If IsNull(rsTmp.Fields("FA65")) = False Then
                  GetFAgentName = GetFAgentName & " " & rsTmp.Fields("FA65")
               End If
            'End If
            End If
            If IsEmptyText(GetFAgentName) = True Then
               If IsNull(rsTmp.Fields("FA06")) = False Then
                  GetFAgentName = rsTmp.Fields("FA06")
               End If
            End If
         Case 1:
      '2025/7/22 END
            If IsNull(rsTmp.Fields("FA05")) = False Then
               GetFAgentName = rsTmp.Fields("FA05")
            End If
            'If IsEmptyText(GetFAgentName) = True Then
               If IsNull(rsTmp.Fields("FA63")) = False Then
                  GetFAgentName = GetFAgentName & " " & rsTmp.Fields("FA63")
               End If
            'End If
            'If IsEmptyText(GetFAgentName) = True Then
               If IsNull(rsTmp.Fields("FA64")) = False Then
                  GetFAgentName = GetFAgentName & " " & rsTmp.Fields("FA64")
               End If
            'End If
            'If IsEmptyText(GetFAgentName) = True Then
               If IsNull(rsTmp.Fields("FA65")) = False Then
                  GetFAgentName = GetFAgentName & " " & rsTmp.Fields("FA65")
               End If
            'End If
            If IsEmptyText(GetFAgentName) = True Then
               If IsNull(rsTmp.Fields("FA04")) = False Then
                  GetFAgentName = rsTmp.Fields("FA04")
               End If
            End If
            If IsEmptyText(GetFAgentName) = True Then
               If IsNull(rsTmp.Fields("FA06")) = False Then
                  GetFAgentName = rsTmp.Fields("FA06")
               End If
            End If
      End Select
   End If
   rsTmp.Close
   Set rsTmp = Nothing
End Function

'Add by Morgan 2004/10/14 本函數只適用到發證，後續繳年費還需考慮年費代理人
'Modified by Morgan 2025/8/27 +年費代理人判斷並確認下列順序--Anny
'1.個案有設年費特殊管制時，抓個案年費自動代繳設定(空白表不自動代繳)。(年費特殊管制空白則往下)
'2.個案有設年費自動代繳。(自動代繳空白則往下)
'3.個案有設年費代理人，抓年費代理人年費自動代繳設定(空白表不自動代繳)。(年費代理人空白則往下)
'4.申請人有設年費代理人，抓年費代理人年費自動代繳設定(空白表不自動代繳)。(年費代理人空白則往下)
'5.代理人有設年費不續辦/自動代繳。(空白則往下)
'6.申請人有設年費不續辦/自動代繳。

''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' 取自動代繳設定
' Input : strPA01 == 本所案號的第一個欄位
'         strPA02 == 本所案號的第二個欄位
'         strPA03 == 本所案號的第三個欄位
'         strPA04 == 本所案號的第四個欄位
' Output : 傳自動代繳設定
'          Y:自動代繳
' 說明 : 若資料庫中無定義時傳回空白
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Public Function PUB_GetAutoPay(ByVal strPA01 As String, ByVal strPA02 As String, ByVal strPA03 As String, ByVal strPA04 As String) As String
   Dim strSql As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   Dim rsQuery2 As ADODB.Recordset
   
   'Modified by Morgan 2019/12/24 改為慣用原則比較不會混淆(舊原則為 2.當有代理人時用PA75抓代理人檔FA41,故申請人設定會無效,與慣用原則衝突)
   '判斷原則 1.基本檔PA70 2.用PA75抓代理人檔FA41 3.用PA26抓客戶檔CU74
   'Modified by Lydia 2019/12/11 +FCP年費特殊管制PA156
   'Modified by Morgan 2025/8/27 +AG605年費代理人
   strSql = "select PA156,PA70,PA75,FA41,CU74,NVL(PA76,CU96) AG605" & _
            " From patent, fagent, CUSTOMER" & _
            " WHERE PA01 = '" & strPA01 & "' AND " & "PA02 = '" & strPA02 & "' AND " & "PA03 = '" & strPA03 & "' AND " & "PA04 = '" & strPA04 & "' " & _
            " and fa01(+)=substr(pa75,1,8) and fa02(+)=substr(pa75,9,1)" & _
            " and cu01(+)=substr(pa26,1,8) and cu02(+)=substr(pa26,9,1)"
   
On Error GoTo ErrHnd
   
   'Modified by Morgan 2025/8/27
   'CheckOC3
   'With AdoRecordSet3
   '   .CursorLocation = adUseClient
   '   .Open strSQL, cnnConnection, adOpenStatic, adLockReadOnly
   '   '若有資料
   '   If .RecordCount > 0 Then
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, strSql)
   With rsQuery
      If intQ = 1 Then
   'end 2025/8/27
   
         'Modified by Lydia 2019/12/11 PA156判斷為年費續辦(或不設定)，才可判斷年費代繳
         'If "" & .Fields("PA70") = "Y" Then
         'Modified by Morgan 2019/12/24
         'If ("" & .Fields("PA156") = "" Or "" & .Fields("PA156") = "Y") And "" & .Fields("PA70") = "Y" Then
         '   PUB_GetAutoPay = "Y"
         'ElseIf "" & .Fields("PA75") <> "" Then
         '   PUB_GetAutoPay = "" & .Fields("FA41")
         'Else
         '   PUB_GetAutoPay = "" & .Fields("CU74")
         'End If
         If .Fields("PA156") <> "" Then '個案有設年費不續辦(N/Y)時年費代繳也要抓個案設定
            PUB_GetAutoPay = "" & .Fields("PA70")
         ElseIf "" & .Fields("PA70") <> "" Then '個案設年費自動代繳
            PUB_GetAutoPay = .Fields("PA70")
         'Added by Morgan 2025/8/27 個案或客戶有設年費代理人則抓該年費代理人設定--Anny
         ElseIf "" & .Fields("AG605") <> "" Then
            If Left(.Fields("AG605"), 1) = "Y" Then
               strSql = "select FA41 from fagent where fa01='" & Left(.Fields("AG605"), 8) & "' and fa02='" & Mid(.Fields("AG605"), 9) & "'"
            Else
               strSql = "select CU74 from customer where cu01='" & Left(.Fields("AG605"), 8) & "' and cu02='" & Mid(.Fields("AG605"), 9) & "'"
            End If
            intQ = 1
            Set rsQuery2 = ClsLawReadRstMsg(intQ, strSql)
            If intQ = 1 Then
               PUB_GetAutoPay = "" & rsQuery2.Fields(0)
            End If
         'end 2025/8/27
         ElseIf "" & .Fields("FA41") <> "" Then '代理人設年費不續辦/自動代繳
            PUB_GetAutoPay = .Fields("FA41")
         ElseIf "" & .Fields("CU74") <> "" Then '申請人設年費不續辦/自動代繳
            PUB_GetAutoPay = .Fields("CU74")
         Else
            PUB_GetAutoPay = ""
         End If
         'end 2019/12/24
      End If
   End With
   'CheckOC3 'Removed by Morgan 2025/8/27
   
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
   'Added by Morgan 2025/8/27
   Set rsQuery = Nothing
   Set rsQuery2 = Nothing
End Function

'add by nick 2004/10/15 傳入客戶編號，傳出客戶的智權人員的業務區
'Modify by Amy 2017/12/29 +stA0909:傳入值,回傳智權業務區主管員編
'Modify by Amy 2021/0701 stA0909變數改為 stA0908
'Modified by Lydia 2022/09/20 oCu + byVal
Public Function GetCuSales(ByVal oCu As String, Optional ByRef oCuSt01 As String, Optional ByRef stA0908 As String = "") As String
Dim rsTmp As New ADODB.Recordset 'Add By Sindy 2017/7/31
Dim bolShowA0908 As String 'Modify by Amy 2021/07/01 stA0909-> stA0908 'Add by Amy 2017/12/29
    
   'Add by Amy 2017/12/29
   'Modify by Amy  2021/07/01 stA0909-> stA0908
   bolShowA0908 = False
   If stA0908 <> MsgText(601) Then bolShowA0908 = True
   stA0908 = ""
   'end 2021/07/01
   'end 2017/12/29
   If oCu <> "" Then
      GetCuSales = ""
      oCuSt01 = ""
      strSql = "select cu12,cu13 " & _
               " From CUSTOMER" & _
               " WHERE " & ChgCustomer(oCu)
      'CheckOC3
      'With AdoRecordSet3
      With rsTmp
         .CursorLocation = adUseClient
         .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
         '若有資料
         If .RecordCount > 0 Then
            GetCuSales = "" & .Fields("cu12")
            oCuSt01 = "" & .Fields("cu13")
         End If
      End With
      'CheckOC3
      rsTmp.Close 'Modify By Sindy 2017/7/31
      'edit by nick 2004/11/08 若離職，就給該區主管
      strSql = "select st15,st04 from staff where st01='" & oCuSt01 & "' "
      'CheckOC3
      'With AdoRecordSet3
      With rsTmp
           .CursorLocation = adUseClient
           .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
           'edit by nickc 2006/04/28
           'If .RecordCount <> 0 Then
           If Not .BOF And Not .EOF Then
               'edit by nick 2004/12/08     加判斷，若是編號< 63001  也要抓該區主管
               'If CheckStr(.Fields(1).Value) <> "1" Then
               'Modify by Amy 2017/12/29 +bolShowA0909
               'Modify by Amy  2021/07/01 bolShowA0909-> bolShowA0908
               If CheckStr(.Fields(1).Value) <> "1" Or oCuSt01 < "63001" Or bolShowA0908 = True Then
                   'edit by nickc 2006/06/15 應該抓客戶的業務區
                   'strSQL = "select min(st01) from staff where st15='" & CheckStr(.Fields(0).Value) & "' and st01>'63001' and st04='1' "
                   'edit by nickc 2007/08/16 改抓部門檔的主管
                   'strSQL = "select min(st01) from staff where st15='" & GetCuSales & "' and st01>'63001' and st04='1' "
                   'Modify by Amy 2021/07/01 +a0908
                   strSql = "select a0909,a0908 from acc090 where a0901='" & GetCuSales & "'  "
                   'CheckOC3
                   rsTmp.Close 'Modify By Sindy 2017/7/31
                   .CursorLocation = adUseClient
                   .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
                   'edit by nickc 2006/06/20
                   'If .RecordCount <> 0 Then
                   If Not .EOF And Not .BOF Then
                       'Modify by Amy 2021/07/01 bolShowA0909-> bolShowA0908
                       If bolShowA0908 = True Then
                          stA0908 = "" & .Fields("a0908").Value
                       'Add by Amy 2021/11/15 林經理(69008)退休,改抓共用函數
                       ElseIf Left(GetCuSales, 2) = "P2" Then
                          oCuSt01 = PUB_GetManP2(oCuSt01)
                       Else
                          oCuSt01 = "" & .Fields(0).Value
                       End If
                   End If
               End If
           'add by nickc 2006/04/28
           Else
               oCuSt01 = ""
           End If
      End With
      'CheckOC3
      rsTmp.Close 'Modify By Sindy 2017/7/31
   End If
   
   Set rsTmp = Nothing 'Modify By Sindy 2017/7/31
End Function

'add by nick 2004/10/15 檢查專利案號是否存在
Public Function ChkPCode(oCode1 As String, oCode2 As String, oCode3 As String, oCode4 As String) As Boolean
ChkPCode = True
   strSql = "select count(*) " & _
            " From Patent " & _
            " WHERE pa01='" & oCode1 & "' and pa02='" & oCode2 & "' and pa03='" & oCode3 & "' and pa04='" & oCode4 & "' "
   CheckOC3
   With AdoRecordSet3
          .CursorLocation = adUseClient
          .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
          If .Fields(0).Value = 0 Then
              ChkPCode = False
          End If
   End With
   CheckOC3
End Function

'add by nick 2004/10/19 從 SQLGrpStr copy 修改
'****************************
'組合系統類別字串
' IN
'    Strindex      USER 可使用之全部系統類別
'    若Strindex 為空字串   則為全部
'    Intindex      系統種類(1-->專  2-->商  3-->法  4-->顧  5-->專服 6-->商服 7-->法服 8-->顧服)
' OUT
'    SQLGrpStr2     該系統種類USER 可使用之系統類別
'********************************
Public Function SQLGrpStr2(Strindex As String, intIndex As Integer) As String
If intIndex > 8 Then
   SQLGrpStr2 = ""
   Exit Function
End If
Dim SQLSTRING As String
If Len(Trim(Strindex)) = 0 Then
        SQLSTRING = "select sk01 from systemkind where sk02=" & intIndex & " "
Else
       SQLSTRING = "SELECT SK01 FROM SYSTEMKIND WHERE SK02=" & intIndex & " AND SK01 IN (" & GetAddStr(Strindex) & ")"
End If
CheckOC3
With AdoRecordSet3
   .CursorLocation = adUseClient
   .Open SQLSTRING, cnnConnection, adOpenStatic, adLockReadOnly
   If .RecordCount <> 0 Then
      .MoveFirst
      SQLGrpStr2 = ""
      Do While .EOF = False
         If Len(Trim(CheckStr(.Fields(0)))) <> 0 Then
            SQLGrpStr2 = SQLGrpStr2 & "'" & ChgSQL(CheckStr(.Fields(0))) & "'"
         End If
         .MoveNext
         If .EOF = False Then
            SQLGrpStr2 = SQLGrpStr2 & ","
         End If
      Loop
   Else
      SQLGrpStr2 = "' '"
      Exit Function
   End If
End With
SQLGrpStr2 = SQLGrpStr2 & ",' '"
End Function
'add by nick 2004/11/08 檢查商標委查的 Create ID 同一天只能有一個
Public Function CheckTMQ_User(oUserStr As String) As Boolean
Dim SQLSTRING  As String
If Pub_StrUserSt03 = "M51" Then
    CheckTMQ_User = True
    Exit Function
End If
CheckOC3
SQLSTRING = "select distinct tmq12 from trademarkquery where tmq13=" & strSrvDate(1) & " "
With AdoRecordSet3
    .CursorLocation = adUseClient
    .Open SQLSTRING, cnnConnection, adOpenStatic, adLockReadOnly
    If .RecordCount <> 0 Then
        If oUserStr = CheckStr(.Fields(0).Value) Then
            CheckTMQ_User = True
        Else
            CheckTMQ_User = False
        End If
    Else
        CheckTMQ_User = True
    End If
End With
End Function
'Add by Morgan 2004/11/9 取得國家名稱
'stNationID:國家代碼
'iLanguage:語言1=中文(預設),2=英文
'Modified by Morgan 2023/8/10 +pSortByStrPos:依照代碼字串先後排序(不要依代碼小到大排)
Public Function PUB_GetNationName(ByVal stNationID As String, Optional ByVal iLanguage As Integer = 1, Optional ByVal pSortByStrPos As Boolean = False) As String
   Dim stNationName As String
On Error GoTo ErrHnd
   strSql = "SELECT NA01," & IIf(iLanguage = 1, "NA03", "NA04") & " FROM NATION WHERE INSTR('" & stNationID & "',NA01)>0"
   'Modified by Morgan 2023/8/10
   'srtrsql = strSql & " order by NA01"
   If pSortByStrPos Then
      strSql = strSql & " order by INSTR('" & stNationID & "',NA01)"
   Else
      strSql = strSql & " order by NA01"
   End If
   'end 2023/8/11
   CheckOC3
   With AdoRecordSet3
      .CursorLocation = adUseClient
      .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      If .RecordCount <> 0 Then
         Do While Not .EOF
            stNationName = stNationName & IIf(stNationName <> "", ",", "") & .Fields(1)
            .MoveNext
         Loop
      End If
   End With
   PUB_GetNationName = stNationName
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description
   
End Function
'Add by Morgan 2004/11/9 檢查是否指定超過7個以上的EPC成員國
'stAssignCountry:指定國家,用","區隔
'stCaseNo:本所案號
'bolName:是否回寫國家
'回傳值:TRUE=7個以上
Public Function PUB_CheckEPC(ByVal stAssignCountry As String, ByVal stCaseNo As String, Optional ByRef stRestEPCMember As String) As Boolean
   Dim arrEPC 'EPC國家會員國陣列
   Dim ii As Integer
   Dim stPA10 As String '申請日
   Dim iEPCMemAssigned As Integer '有指定的EPC成員國數
   Dim stEPC_MEMBER As String 'EPC國家會員國字串
   
On Error GoTo ErrHnd
   stRestEPCMember = ""
   strSql = "SELECT PA10 FROM PATENT WHERE " & ChgPatent(stCaseNo)
   CheckOC3
   With AdoRecordSet3
      .CursorLocation = adUseClient
      .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      If .RecordCount <> 0 Then
         stPA10 = "" & .Fields(0)
      End If
   End With
   If stPA10 <> "" Then
   'Modify by Morgan 2005/4/29 改抓membercountry
'      arrEPC = Split(EPC_MEMBER, ",")
'      For ii = LBound(arrEPC) To UBound(arrEPC)
'         If Val(arrEPC(ii)) > 0 Then
'            Select Case arrEPC(ii)
'               '226保加利亞,223捷克,242愛沙尼亞,234斯洛伐克 2002.7.1加入成員國
'               Case "226", "223", "242", "234"
'                  If stPA10 >= "20020701" Then
'                     If InStr(stAssignCountry, arrEPC(ii)) > 0 Then
'                        iEPCMemAssigned = iEPCMemAssigned + 1
'                     Else
'                        stRestEPCMember = stRestEPCMember & IIf(stRestEPCMember <> "", ",", "") & arrEPC(ii)
'                     End If
'                  End If
'               '232斯洛維尼亞 2002.12.1加入成員國
'               Case "232"
'                  If stPA10 >= "20021201" Then
'                     If InStr(stAssignCountry, arrEPC(ii)) > 0 Then
'                        iEPCMemAssigned = iEPCMemAssigned + 1
'                     Else
'                        stRestEPCMember = stRestEPCMember & IIf(stRestEPCMember <> "", ",", "") & arrEPC(ii)
'                     End If
'                  End If
'               '219匈牙利 2003.1.1加入成員國
'               Case "219"
'                  If stPA10 >= "20030101" Then
'                     If InStr(stAssignCountry, arrEPC(ii)) > 0 Then
'                        iEPCMemAssigned = iEPCMemAssigned + 1
'                     Else
'                        stRestEPCMember = stRestEPCMember & IIf(stRestEPCMember <> "", ",", "") & arrEPC(ii)
'                     End If
'                  End If
'               '222波蘭 2004.4.1加入成員國
'               Case "222"
'                  If stPA10 >= "20040401" Then
'                     If InStr(stAssignCountry, arrEPC(ii)) > 0 Then
'                        iEPCMemAssigned = iEPCMemAssigned + 1
'                     Else
'                        stRestEPCMember = stRestEPCMember & IIf(stRestEPCMember <> "", ",", "") & arrEPC(ii)
'                     End If
'                  End If
'               Case Else
'                  If InStr(stAssignCountry, arrEPC(ii)) > 0 Then
'                     iEPCMemAssigned = iEPCMemAssigned + 1
'                  Else
'                     stRestEPCMember = stRestEPCMember & IIf(stRestEPCMember <> "", ",", "") & arrEPC(ii)
'                  End If
'            End Select
'
'         End If
'      Next
      stEPC_MEMBER = PUB_GetMemberCountry("1", stPA10)
      arrEPC = Split(stEPC_MEMBER, ",")
      For ii = LBound(arrEPC) To UBound(arrEPC)
         If arrEPC(ii) <> "" Then
            If InStr(stAssignCountry, arrEPC(ii)) > 0 Then
               iEPCMemAssigned = iEPCMemAssigned + 1
            'Add by Morgan 2009/2/20 若有指定瑞士205時列茲敦斯登227不必再列未指定國家
            ElseIf arrEPC(ii) = "227" And InStr(stAssignCountry, "205") > 0 Then
               stRestEPCMember = stRestEPCMember
            'end 2009/2/20
            Else
               stRestEPCMember = stRestEPCMember & IIf(stRestEPCMember <> "", ",", "") & arrEPC(ii)
            End If
         End If
      Next
      If iEPCMemAssigned >= 7 Then PUB_CheckEPC = True
   End If
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description
   
End Function

'Add by Morgan from basQuery 2004/11/12
'Add by Morgan 2004/2/18
'王協理(71011)分案通知
'    stUserNo      使用者(寄件者預設為 strUserNum, 改寄件者要傳 stFromID )
'    stReceiver    收件者
'    stReceiveNo   收文號
'    stSubject      主旨
'    stContent      內文
'    stPS             其他備註
'edit by nickc 2006/12/06
'Public Sub PUB_SendMail(ByVal stUserNo As String, ByVal stReceiver As String, ByVal stReceiveNo As String, ByVal stSubject As String, Optional ByVal stContent As String, Optional ByVal stPS As String)
'edit by nickc 2006/12/28
'Public Sub PUB_SendMail(ByVal stUserNo As String, ByVal stReceiver As String, ByVal stReceiveNo As String, ByVal stSubject As String, Optional ByVal stContent As String, Optional ByVal stPS As String, Optional ByVal stFilePath As String = "", Optional ByVal blHtml As Boolean = False)
'Modify by Morgan 2007/11/13 加 bolShowEngName:是否顯示英文名稱
'Modify By Sindy 2009/09/23 加 stCCReceiver:副本收件者
'Modify by Morgan 2011/4/22 + 回覆信箱
'Modify By Sindy 2012/1/10 +bolCaseDutyAgentMsg
'Modified by Morgan 2014/1/22 Html格式改預設True(若以純文字寄內文有含造字的信時,用 OUTLOOK 2007 收信可能會變亂碼)
'Modify by Sindy 2016/10/12 + bolInSpecialDuty:是否含特殊職代
'Modify by Sindy 2016/12/12 + Optional bolShowErrMsg As Boolean = True:是否顯示傳送失敗的訊息，預設顯示，不顯示則寫Log
'Modify By Sindy 2017/11/17 + Optional ByVal strUpdWhere As String = "", Optional ByVal strTableName As String = "":為了記錄寄送資訊
'Modify By Sindy 2017/11/23 + Optional ByVal bolShowDeBugMsg As Boolean = True
'Modified by Morgan 2018/9/12 + Optional ByVal bolImportant As Boolean = False
'Modify By Sindy 2019/4/25 因董事長無收到作業系統發的E-Mail，請協助處理。
'                          發現,因董事長在系統裡是設定不寄信 + Optional ByVal bol63001CanSend As Boolean = False
'Modified by Morgan 2019/8/27 +iSignatureID:簽名檔代碼
'Modified by Morgan 2021/4/9 +bolGetReceipt:是否要求讀取回條
'Modify by Amy Memo 2021/07/16 , Optional ByVal bolAbsenceSys As Boolean = False: 是否屬人事系統; False:非人事系統-發職代: True:人事系統-不發職代
'Modified by Morgan 2022/3/30 +bolByUTF8(預設True)
'Modify by Sindy 2023/6/2 + , Optional ByVal strDutyAgentKind As String = "": 指定職代種類; 1.人事職代 2.案件職代 A.指定抓全部職代(2021/11/12)
'Modify By Sindy 2023/7/12 + , Optional ByVal m_strMailKind As String = "": 寄信種類; 1.分信通知(F11分信通知信副本不加發主管為副本)
'Modified by Morgan 2024/4/17 +SMTP: 指定SMTP
'Modified by Lydia 2024/06/06 +bolDefCont：預設帶入收文性質Email內文
'Modified by Morgan 2025/6/27 +stSaveMailCP09 :寄信成功要存檔的收文號(卷宗區及寄件備份)
Public Sub PUB_SendMail(ByVal stUserNo As String, ByVal stReceiver As String, ByVal stReceiveNo As String, _
   ByVal stSubject As String, Optional ByVal stContent As String, Optional ByVal stPS As String, _
   Optional ByVal stFilePath As String = "", Optional ByVal blHtml As Boolean = True, _
   Optional ByVal IsByMsaIsp As Boolean = False, Optional ByVal bolShowEngName As Boolean = False, _
   Optional ByVal stCCReceiver As String = "", Optional ByVal stFromID As String = "", Optional ByVal stFromName As String = "", _
   Optional ByVal stReplyTo As String = "", Optional ByVal bolAbsenceSys As Boolean = False, _
   Optional ByVal bolCaseDutyAgentMsg As Boolean = True, Optional ByVal strBCC As String, _
   Optional ByVal bolInSpecialDuty As Boolean = False, Optional ByVal bolShowErrMsg As Boolean = True, _
   Optional ByVal strUpdWhere As String = "", Optional ByVal strTableName As String = "", _
   Optional ByVal bolShowDeBugMsg As Boolean = True, Optional ByVal bolImportant As Boolean = False, _
   Optional ByVal bol63001CanSend As Boolean = False, Optional ByVal iSignatureID As Integer = 0, _
   Optional ByVal bolGetReceipt As Boolean = False, Optional ByVal bolByUTF8 As Boolean = True, _
   Optional ByVal strDutyAgentKind As String = "", Optional ByVal m_strMailKind As String = "", _
   Optional ByVal SMTP As String = "", Optional ByVal bolDefCont As Boolean = False, Optional stSaveMailCP09 As String)
   
Dim stSQL As String, strOldName As String, intR As Integer
Dim rstQuery As ADODB.Recordset
Dim strRestKind As String 'Add By Sindy 2012/9/13 休假狀況:1.請假3.出差
Dim files
Dim stBCCr As String 'Added by Lydia 2015/08/03
Dim stTmp As String, stTmp2 As String 'Added by Morgan 2017/2/22
Dim bolShowPic As Boolean 'Added by Morgan 2017/11/2
'Added by Morgan 2020/9/24
Dim fs
Dim lngAttSize As Long
'end 2020/9/24
Dim m_Sender As String, tmpArr As Variant, j As Integer 'Add By Sindy 2021/10/19
Dim bol_TMdebate As Boolean 'Add By Sindy 2022/2/21
Dim lngAttSizeLimit As Long 'Added by Morgan 2024/3/4 系統寄信附件大小限制
   
   bolMailSendOk = False 'Add By Sindy 2016/4/28
   
   'Add By Sindy 2021/10/19
   'Modify By Sindy 2023/7/12 排除分信通知; m_strMailKind.寄信種類=1.分信通知
   If bolAbsenceSys = False And Trim(stReceiver) <> "" And m_strMailKind <> "1" Then
      '案件系統之收受者為外商英文組人員(st03=’F11’ and st16=’2’)
      '自動加入副本為該員之ST52~ST54。
      'Modify By Sindy 2022/2/21 內商歷程中發給林靖傑A6015(除送會歷程外)，都不必再發副本給其各級主管。
      '                          (需求人是江協理):T or FCT 爭議案不加發副本，但排除主旨送會歷程
      bol_TMdebate = False
      If stReceiveNo <> "" Then
         'Modify By Sindy 2025/7/28 FCT案727分析不屬於爭議案 + FCT_NotTMdebate
         stSQL = "Select * from caseprogress" & _
                 " where cp01 in('T','FCT') and cp09='" & stReceiveNo & "'" & _
                 " and instr('" & TMdebate & "',cp10)>0" & _
                 " and not(CP01='FCT' AND cp10 in (" & FCT_NotTMdebate & "))"
         intI = 1
         Set rstQuery = ClsLawReadRstMsg(intI, stSQL)
         If intI = 1 Then
            bol_TMdebate = True
         End If
      End If
      '2022/2/21 END
      stSQL = "Select st16,st70,st93,st01,st02,replace(st52||';'||st53||';'||st54,';;','') as STNo,st52,st53,st54 from staff" & _
              " where st03='F11' and st16='2' and st04='1' and replace(st52||';'||st53||';'||st54,';;','')<>st01 and instr('" & stReceiver & "',st01)>0"
      intR = 1
      Set rstQuery = ClsLawReadRstMsg(intR, stSQL)
      'Modify By Sindy 2022/2/21 + And (bol_TMdebate = False Or InStr(stSubject, "(核會流程)-->(送會") > 0)
'      If intR = 1 And (bol_TMdebate = False Or (InStr(stSubject, "(核會流程)-->") > 0 And InStr(stSubject, "送會，") > 0)) Then
      If intR = 1 And ((bol_TMdebate = True And InStr(stSubject, "(核會流程)-->") > 0 And InStr(stSubject, "送會，") > 0) _
                       Or (bol_TMdebate = False And InStr(stSubject, "(核會流程)-->") = 0) _
                       Or (bol_TMdebate = False And InStr(stSubject, "(核會流程)-->") > 0 And InStr(stSubject, "已送件") > 0)) Then
         rstQuery.MoveFirst
         Do While Not rstQuery.EOF
            'Modify By Sindy 2024/12/5 歷程通知信判斷同組員才發信
            If InStr(stSubject, "(核會流程)-->") > 0 Then
               If "" & rstQuery.Fields("st52") <> "" Then
                  If PUB_GetST93(rstQuery.Fields("st01")) = PUB_GetST93(rstQuery.Fields("st52")) Then
                     If Trim(stCCReceiver) <> "" Then stCCReceiver = stCCReceiver & ";"
                     stCCReceiver = stCCReceiver & rstQuery.Fields("st52")
                  End If
               End If
               If "" & rstQuery.Fields("st53") <> "" Then
                  If PUB_GetST93(rstQuery.Fields("st01")) = PUB_GetST93(rstQuery.Fields("st53")) Then
                     If Trim(stCCReceiver) <> "" Then stCCReceiver = stCCReceiver & ";"
                     stCCReceiver = stCCReceiver & rstQuery.Fields("st53")
                  End If
               End If
               If "" & rstQuery.Fields("st54") <> "" Then
                  If PUB_GetST93(rstQuery.Fields("st01")) = PUB_GetST93(rstQuery.Fields("st54")) Then
                     If Trim(stCCReceiver) <> "" Then stCCReceiver = stCCReceiver & ";"
                     stCCReceiver = stCCReceiver & rstQuery.Fields("st54")
                  End If
               End If
            Else
            '2024/12/5 END
               If Trim(stCCReceiver) <> "" Then stCCReceiver = stCCReceiver & ";"
               stCCReceiver = stCCReceiver & rstQuery.Fields("STNo")
            End If
            rstQuery.MoveNext
         Loop
      End If
   End If
   
   'Added by Morgan 2020/9/24
   '檢查附件大小不可超過20M(實際測試超過30M會出現記憶體不足錯誤導致附件無內容)
   'Modify By Sindy 2020/10/5 排除分信系統
   'Modified by Lydia 2020/10/08 排除財務系統
   If UCase(App.EXEName) <> UCase("TaRevOutLook") And UCase(App.EXEName) <> UCase("Teaccount") Then
   '2020/10/5 END
      If stFilePath <> "" Then
         'Added by Morgan 2024/3/4 改回要檢查且抓系統特殊設定--經理
         lngAttSizeLimit = Val(Pub_GetSpecMan("系統寄信附件大小限制"))
         If lngAttSizeLimit > 0 Then
         'end 2024/3/4
            files = Split(stFilePath, cAST)
            lngAttSize = 0
            Set fs = CreateObject("Scripting.FileSystemObject")
            For intR = LBound(files) To UBound(files)
               If files(intR) <> "" Then
                  lngAttSize = lngAttSize + fs.GetFile(files(intR)).Size
                  'Modified by Morgan 2024/3/4
                  'If lngAttSize > 20& * 1024 * 1024 Then
                  '   If bolShowErrMsg = True Then
                  '      MsgBox "附件大小超過 20MB，寄信取消！", vbCritical, "寄信錯誤"
                  '   Else
                  '      Pub_WriteSysLog "附件大小超過 20MB，寄信取消！(寄信錯誤)"
                  '   End If
                  If lngAttSize > lngAttSizeLimit * 1024 * 1024 Then
                     If bolShowErrMsg = True Then
                        MsgBox "附件大小超過 " & lngAttSizeLimit & "MB，寄信取消！", vbCritical, "寄信錯誤"
                     Else
                        Pub_WriteSysLog "附件大小超過 " & lngAttSizeLimit & "MB，寄信取消！(寄信錯誤)"
                     End If
                  'end 2024/3/4
                     Exit Sub
                  End If
               End If
            Next
         End If
      End If
   End If
   'end 2020/9/24
   
   'Added by Morgan 2016/5/13
   If PUB_IsFormExist("frm880005") Then
      'Modified by Morgan 2017/10/5
      'MsgBox "寄信中，不可重複執行！", vbCritical, Now
      'MsgBox "前次寄信作業尚未結束，本次寄信將被取消！", vbCritical, "寄信失敗！(" & Now & ")"
      'Modify By Sindy 2017/10/24
      stTmp = "前次寄信作業尚未結束，本次寄信將被取消！"
      If Pub_StrUserSt03 = "M51" Or strUserNum = "QPGMR" Then
         stTmp = stTmp & vbCrLf & vbCrLf & "【收件者：" & frm880005.txtEmail(0).Text & "　副本：" & frm880005.txtEmail(5).Text & "】？" & _
                 vbCrLf & vbCrLf & "主旨：" & frm880005.txtEmail(1).Text & _
                 vbCrLf & vbCrLf & "內容：" & vbCrLf & frm880005.txtEmail(2).Text
      End If
      'Add By Sindy 2017/11/23
      If bolShowDeBugMsg = True Then
      '2017/11/23 END
         MsgBox stTmp, vbCritical, "寄信失敗！(" & Now & ")"
      End If
      '2017/10/24 END
      'end 2017/10/5
      'Modify By Sindy 2025/7/9 + stTmp
      cnnConnection.Execute "insert into DebugLog(DL01,DL02,DL03,DL04)" & _
         " values('PUB_SendMail'," & CNULL(strUserNum) & ",sysdate,'重複執行 stReceiver=" & stReceiver & "; " & stTmp & "')"
      Exit Sub
   End If
   'end 2016/5/13
   
   strOldName = strUserName 'Add by Morgan 2007/11/13
   'Add By Sindy 2014/4/10 寄件者是QPGMR時,顯示別名為系統管理員(Administrator)
   If (UCase(stUserNo) = "QPGMR" Or UCase(stFromID) = "QPGMR") And stFromName = "" Then
      stFromID = "QPGMR"
      stFromName = "系統管理員"
   End If
   '2014/4/10 END
   
   'Added by Morgan 2014/1/24
   If stFilePath <> "" And blHtml = True Then
      files = Split(stFilePath, cAST)
      bolShowPic = True 'Added by Morgan 2017/11/2
      For intR = LBound(files) To UBound(files)
         If files(intR) <> "" Then
            If UCase(Right(files(intR), 4)) <> ".JPG" Then
               'Modified by Morgan 2017/11/2
               'blHtml = False
               bolShowPic = False
               'end 2017/11/2
               Exit For
            End If
         End If
      Next
   End If
   'end 2014/1/24
   
On Error GoTo ErrHnd
 
    Dim bolOk2Mail As Boolean
    
    'Modified by Lydia 2024/06/06 預設帶入收文性質Email內文 +Or (bolDefCont = True And stReceiveNo <> "")
    If stContent = "" Or (bolDefCont = True And stReceiveNo <> "") Then
        'modify by sonia 2019/8/28 cpm03改為decode(pa09,'000',cpm03,cpm04)
        'Modify by Amy 2020/09/07 原只抓Patent
        'Modified by Lydia 2023/10/06
        'stSQL = "Select cp01||'-'||cp02||'-'||cp03||'-'||cp04 as C01, pa05 as C02, cp10 as C03, decode(pa09,'000',cpm03,cpm04) C04, cp05 C05, cp14 as C06, st02 as C07, cp06 C08" & _
            " from Caseprogress, Patent,TradeMark, LawCase,HireCase,casepropertymap, staff" & _
            " where cp09='" & stReceiveNo & "' and cp27 is null" & _
            " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04" & _
            " and tm01(+)=cp01 and tm02(+)=cp02 and tm03(+)=cp03 and tm04(+)=cp04" & _
            " and lc01(+)=cp01 and lc02(+)=cp02 and lc03(+)=cp03 and lc04(+)=cp04" & _
            " and hc01(+)=cp01 and hc02(+)=cp02 and hc03(+)=cp03 and hc04(+)=cp04" & _
            " and cpm01(+)=cp01 and cpm02(+)=cp10" & _
            " and st01(+)=cp14"
        'Modified by Morgan 2024/1/5 +cp141,cp142,cp164
        stSQL = "Select cp01||'-'||cp02||'-'||cp03||'-'||cp04 as C01,cp10 as C03,cp05 C05, cp14 as C06, st02 as C07, cp06 C08,CP01,CP02,CP03,CP04,cp12,cp141,cp142,cp164 " & _
            " from Caseprogress, staff where cp09='" & stReceiveNo & "' and cp27 is null and st01(+)=cp14"
        intR = 1
        Set rstQuery = ClsLawReadRstMsg(intR, stSQL)
        If intR = 1 Then
            With rstQuery
               'Modified by Lydia 2023/10/06
               'stContent = "收文號：" & stReceiveNo & vbCrLf & _
                       "本所案號：" & .Fields("C01") & vbCrLf & _
                       "案件名稱：" & .Fields("C02") & vbCrLf & _
                       "案件性質：" & .Fields("C03") & " " & .Fields("C04") & vbCrLf & _
                       "收文日：" & (Left(.Fields("C05"), 4) - 1911) & " 年 " & DBMONTH("" & .Fields("C05")) & " 月 " & DBDAY("" & .Fields("C05")) & " 日 " & vbCrLf & _
                       "承辦人：" & .Fields("C06") & " " & .Fields("C07") & vbCrLf & _
                       "本所期限：" & IIf(IsNull(.Fields("C08")), "無", (Left(.Fields("C08"), 4) - 1911) & " 年 " & DBMONTH("" & .Fields("C08")) & " 月 " & DBDAY("" & .Fields("C08")) & " 日 ")
               'Modified by Lydia 2024/06/06 +iif(bolDefCont = True ...
               stContent = "收文號：" & stReceiveNo & vbCrLf & _
                       "本所案號：" & .Fields("C01") & vbCrLf & _
                       "案件名稱：" & GetPrjName(.Fields("C01")) & vbCrLf & _
                       "案件性質：" & .Fields("C03") & " " & GetPrjState4(.Fields("C01"), .Fields("C03")) & vbCrLf & _
                       "收文日：" & (Left(.Fields("C05"), 4) - 1911) & " 年 " & DBMONTH("" & .Fields("C05")) & " 月 " & DBDAY("" & .Fields("C05")) & " 日 " & vbCrLf & _
                       "承辦人：" & .Fields("C06") & " " & .Fields("C07") & vbCrLf & _
                       "本所期限：" & IIf(IsNull(.Fields("C08")), "無", (Left(.Fields("C08"), 4) - 1911) & " 年 " & DBMONTH("" & .Fields("C08")) & " 月 " & DBDAY("" & .Fields("C08")) & " 日 ") & _
                       IIf(bolDefCont = True And stContent <> "", vbCrLf & vbCrLf & stContent & vbCrLf, "")
               'Add By Sindy 2024/5/23
               If Mid(.Fields("cp12"), 1, 2) = "F2" And Mid(stUserNo, 4, 1) = "9" And Mid(stReceiver, 4, 1) = "9" And InStr(stSubject, "變更承辦人") > 0 Then
                  stContent = stContent & vbCrLf & vbCrLf & _
                       "※請外專主管確認本案OA如有不能請款之情形，則通知Wilson是否轉回外專處理，以及通知Sharon不分舜禹翻譯OA (1日以內)"
                  'Added by Lydia 2024/10/25 增加sharon為 副本收受者
                  stSQL = Pub_GetSpecMan("M")
                  If stSQL <> "" And InStr(stCCReceiver & ";", stSQL) = 0 Then
                     stCCReceiver = stCCReceiver & IIf(stCCReceiver <> "", ";", "") & stSQL
                  End If
                  'end 2024/10/25
               End If
               '2024/5/23 END
               'Added by Morgan 2024/1/5
               If .Fields("cp141") = "3" And .Fields("cp142") > 0 Then
                  stContent = stContent & vbCrLf & "指定日期：" & (Left(.Fields("cp142"), 4) - 1911) & " 年 " & DBMONTH(.Fields("cp142")) & " 月 " & DBDAY(.Fields("cp142")) & " 日"
                  If .Fields("cp164") = "2" Then
                     stContent = stContent & "之前"
                  ElseIf .Fields("cp164") = "3" Then
                     stContent = stContent & "之後"
                  End If
               End If
               'end 2024/1/5
               bolOk2Mail = True
            End With
         End If
    Else
        bolOk2Mail = True
    End If
    
    If bolOk2Mail = True Then
         'Add by Sindy 2019/9/4
         '副本 : 檢查特殊收信人員(收受者,副本,密件副本均可使用的共同條件)
         stCCReceiver = ChkSpecMailReciver(stCCReceiver, stReceiveNo, bolAbsenceSys, bol63001CanSend)
         
         'Add by Morgan 2007/11/13
         If bolShowEngName = True Then
            stSQL = "select st12 from staff where st01='" & strUserNum & "' and st12 is not null"
            intR = 1
            Set rstQuery = ClsLawReadRstMsg(intR, stSQL)
            If intR = 1 Then
               strUserName = rstQuery(0)
            End If
         End If
         'end 2007/11/13
         
         'Add by Morgan 2004/7/6
         If stPS <> "" Then
            stContent = stContent & vbCrLf & stPS
         End If
      
        Dim strOfficeKind As String
        'Add by Morgan 2004/10/15 考慮多收件者
        Dim arrReciverNo, ii As Integer, stReceivers As String
        'add by nickc 2008/01/30
        Dim m_ST14 As String
        
        '收受者
        'Modify By Sindy 2019/9/4 檢查特殊收信人員(收受者,副本,密件副本均可使用的共同條件)
        stReceiver = ChkSpecMailReciver(stReceiver, stReceiveNo, bolAbsenceSys, bol63001CanSend)
        arrReciverNo = Split(stReceiver, ";")
'edit by nickc 2005/03/17
'        strOfficeKind = PUB_GetST06(stUserNo)
        '若寄件者為北所人員, 則收件者後面不加@taie.com.tw
'edit by nickc 2005/03/17
'        If strOfficeKind = "1" Then
            For ii = LBound(arrReciverNo) To UBound(arrReciverNo)
               'Modify By Sindy 2019/9/4 Mark
'                'add by nickc 2008/03/28 原先僅外翻使用，現改通用
'                m_ST14 = PUB_GetST14(Replace(UCase(arrReciverNo(ii)), "@TAIE.COM.TW", ""))
'                If m_ST14 <> "" Then
'                  'Add By Sindy 2013/10/29
'                  'Modified by Lydia 2017/03/28 不只一人
'                  'If m_ST14 = "99997" Then
'                  If m_ST14 <> "" And InStr(m_ST14, "99997") > 0 Then
'                     'Modify By Sindy 2019/4/25 董事長指示蘇月星請假、出差及加班單在所長核准後應會知董事長,因此特別調整必寄
'                     If arrReciverNo(ii) = "63001" Then
'                        If bol63001CanSend = False Then
'                           arrReciverNo(ii) = ""
'                        End If
'                     Else
'                     '2019/4/25 END
'                        arrReciverNo(ii) = ""
'                     End If
'                  Else
'                  '2013/10/29 END
'                     arrReciverNo(ii) = m_ST14
'                  End If
'                End If
                
               'Add by Morgan 2006/7/31 外翻則寄給郭
               'Modify by Morgan 2007/5/16 排除非台一信箱
               'If Left(arrReciverNo(ii), 1) = "F" Then
               'Modified by Morgan 2019/12/3 外翻改判斷F5開頭,因為外專承辦的群組FCP_2也是F開頭
               'If Left(arrReciverNo(ii), 1) = "F" And (InStr(arrReciverNo(ii), "@") = 0 Or InStr(UCase(arrReciverNo(ii)), "@TAIE.COM.TW") > 0) Then
               If Left(arrReciverNo(ii), 2) = "F5" And (InStr(arrReciverNo(ii), "@") = 0 Or InStr(UCase(arrReciverNo(ii)), "@TAIE.COM.TW") > 0) Then
               'end 2019/12/3
               'end 2007/5/16
               
                  'Modify by Morgan 2006/10/12 改寄給劉又安95014
                  'arrReciverNo(ii) = "79075"
                  'edit by nickc 2007/10/17 改成抓 table
                  'arrReciverNo(ii) = "95014"
'edit by nickc 2008/03/28 改成 st14 有就先發st14 移到上一區塊
'                  'edit by nickc 2008/01/30   外翻，若是員工檔有設定代收人員，則發給代收人  ex:  偉城  收  蔣正偉 的
'                  m_ST14 = PUB_GetST14(Replace(UCase(arrReciverNo(ii)), "@TAIE.COM.TW", ""))
'                  If m_ST14 = "" Then

                        'Modified by Morgan 2017/2/22
                        '若是內翻人員改抓對應的所內編號
                        'arrReciverNo(ii) = Pub_GetSpecMan("H")
                        stTmp = PUB_GetMapID(CStr(arrReciverNo(ii)), 1)
                        If stTmp <> "" Then
                           arrReciverNo(ii) = stTmp
                        Else
                           arrReciverNo(ii) = Pub_GetSpecMan("H")
                        End If
                        'end 2017/2/22
                        
'                  Else
'                        arrReciverNo(ii) = m_ST14
'                  End If
                    
               End If
               'end 2006/7/31
               'add by nickc 2008/01/11 加入巨京 Mail  管制人
               'Modified by Lydia 2017/03/28 有可能一人以上
               'If Replace(UCase(arrReciverNo(ii)), "@TAIE.COM.TW", "") = "96029" Or Replace(UCase(arrReciverNo(ii)), "@TAIE.COM.TW", "") = "96030" Then      '商標
               If arrReciverNo(ii) <> "" Then
                  If InStr(Replace(UCase(arrReciverNo(ii)), "@TAIE.COM.TW", ""), "96029") > 0 Or InStr(Replace(UCase(arrReciverNo(ii)), "@TAIE.COM.TW", ""), "96030") > 0 Then
                     arrReciverNo(ii) = Pub_GetSpecMan("J")
                  End If
                  'Modified by Lydia 2017/03/28 有可能一人以上
                  'If Replace(UCase(arrReciverNo(ii)), "@TAIE.COM.TW", "") = "96031" Or Replace(UCase(arrReciverNo(ii)), "@TAIE.COM.TW", "") = "96032" Then      '專利
                  If InStr(Replace(UCase(arrReciverNo(ii)), "@TAIE.COM.TW", ""), "96031") > 0 Or InStr(Replace(UCase(arrReciverNo(ii)), "@TAIE.COM.TW", ""), "96032") > 0 Then
                     arrReciverNo(ii) = Pub_GetSpecMan("K")
                  End If
               End If
               'end 2017/03/28
                  'Modify By Sindy 2013/8/1 Mark
'                'add by nickc 2008/04/24
'                '分所寄給國外部的信 , 不寄, 改秀訊息
'                If pub_strUserOffice <> "1" Then
'                    If Mid(PUB_GetST03(Replace(UCase(arrReciverNo(ii)), "@TAIE.COM.TW", "")), 1, 1) = "F" Then
'                        MsgBox "國外部承辦人無外部電子郵件信箱，相關電子郵件通知無法寄達，請另行通知！！" & vbCrLf & vbCrLf & vbCrLf & "請通知：" & GetPrjSalesNM(Replace(UCase(arrReciverNo(ii)), "@TAIE.COM.TW", "")) & vbCrLf & vbCrLf & vbCrLf & stSubject & vbCrLf & vbCrLf & stContent, vbCritical, "嚴重警告！！！"
'                        arrReciverNo(ii) = ""
'                    End If
'                End If
                'add by nickc 2008/04/24
                '分所寄給國外部的信 , 不寄, 改秀訊息
                If arrReciverNo(ii) <> "" Then
                    stReceivers = stReceivers & arrReciverNo(ii) & ";"
                End If
            Next ii
            
         'Added by Lydia 2015/08/03 + 密件副本
         'Modify by Sindy 2019/9/4
         '密件副本 : 檢查特殊收信人員(收受者,副本,密件副本均可使用的共同條件)
         stBCCr = ChkSpecMailReciver(strBCC, stReceiveNo, bolAbsenceSys, bol63001CanSend)
'            If strBCC <> "" Then
'               arrReciverNo = Split(strBCC, ";")
'               For ii = LBound(arrReciverNo) To UBound(arrReciverNo)
'                   'add by nickc 2008/03/28 原先僅外翻使用，現改通用
'                   m_ST14 = PUB_GetST14(Replace(UCase(arrReciverNo(ii)), "@TAIE.COM.TW", ""))
'                   If m_ST14 <> "" Then
'                     'Modified by Lydia 2017/03/28 不只一人
'                     'If m_ST14 = "99997" Then
'                     If m_ST14 <> "" And InStr(m_ST14, "99997") > 0 Then
'                         'Modify By Sindy 2019/4/25 董事長指示蘇月星請假、出差及加班單在所長核准後應會知董事長,因此特別調整必寄
'                         If arrReciverNo(ii) = "63001" Then
'                            If bol63001CanSend = False Then
'                               arrReciverNo(ii) = ""
'                            End If
'                         Else
'                         '2019/4/25 END
'                            arrReciverNo(ii) = ""
'                         End If
'                     Else
'                         arrReciverNo(ii) = m_ST14
'                     End If
'                   End If
'
'                   If arrReciverNo(ii) <> "" Then
'                       stBCCr = stBCCr & arrReciverNo(ii) & ";"
'                   End If
'               Next ii
'            End If
            
            'Add By Sindy 2014/4/17 主旨後面+分機資訊
            'If Len(stUserNo) = 5 Then
            'Modify By Sindy 2014/4/28
            If Len(stUserNo) = 5 And (InStr(stReceivers, "@") = 0 Or InStr(UCase(stReceivers), "@TAIE.COM.TW") > 0) Then
            '2014/4/28 END
               If stUserNo > "6" And stUserNo < "F" Then
                  stSQL = "select ed01,decode(ed03,'1','北所','2','中所','3','南所','4','高所','其他') ed03,nvl(ed05,'') ed05 from extensiondata where ed02='" & stUserNo & "'"
                  intR = 1
                  Set rstQuery = ClsLawReadRstMsg(intR, stSQL)
                  If intR = 1 Then
                     stSubject = stSubject & " [寄件者：" & _
                                 rstQuery.Fields("ed03") & _
                                 IIf(Trim("" & rstQuery.Fields("ed05")) = "", "", "(" & Trim(rstQuery.Fields("ed05")) & ")") & _
                                 "#" & rstQuery.Fields("ed01") & "]"
                  End If
               End If
            End If
            '2014/4/17 END
            
            'Modify By Sindy 2024/12/4 比較資料是否有重覆,去掉重覆值
            Call PUB_CompRepeatReple(stReceivers, stCCReceiver)
            Call PUB_CompRepeatReple(stReceivers, stBCCr)
'            'Add By Sindy 2021/10/19
'            '過濾是否有收受者重覆的資料
'            m_Sender = Replace(stReceivers, ",", ";")
'            If Left(m_Sender, 1) = ";" Then m_Sender = Mid(m_Sender, 2)
'            If Right(m_Sender, 1) = ";" Then m_Sender = Left(m_Sender, Len(m_Sender) - 1)
'            If m_Sender <> "" And InStr(m_Sender, ";") > 0 Then
'               tmpArr = Split(m_Sender, ";")
'               stReceivers = ""
'               For j = 0 To UBound(tmpArr)
'                  If tmpArr(j) <> "" Then
'                     If InStr(stReceivers, tmpArr(j)) = 0 Then
'                        stReceivers = stReceivers & IIf(stReceivers = "", "", ";") & tmpArr(j)
'                     End If
'                  End If
'               Next j
'            End If
'            If stCCReceiver <> "" Then
'               m_Sender = Replace(stCCReceiver, ",", ";")
'               If Left(m_Sender, 1) = ";" Then m_Sender = Mid(m_Sender, 2)
'               If Right(m_Sender, 1) = ";" Then m_Sender = Left(m_Sender, Len(m_Sender) - 1)
'               If m_Sender <> "" And InStr(m_Sender, ";") > 0 Then
'                  tmpArr = Split(m_Sender, ";")
'                  stCCReceiver = ""
'                  For j = 0 To UBound(tmpArr)
'                     If tmpArr(j) <> "" Then
'                        If InStr(stCCReceiver, tmpArr(j)) = 0 Then
'                           stCCReceiver = stCCReceiver & IIf(stCCReceiver = "", "", ";") & tmpArr(j)
'                        End If
'                     End If
'                  Next j
'               End If
'            End If
'            '密件副本
'            If stBCCr <> "" Then
'               m_Sender = Replace(stBCCr, ",", ";")
'               If Left(m_Sender, 1) = ";" Then m_Sender = Mid(m_Sender, 2)
'               If Right(m_Sender, 1) = ";" Then m_Sender = Left(m_Sender, Len(m_Sender) - 1)
'               If m_Sender <> "" And InStr(m_Sender, ";") > 0 Then
'                  tmpArr = Split(m_Sender, ";")
'                  stBCCr = ""
'                  For j = 0 To UBound(tmpArr)
'                     If tmpArr(j) <> "" Then
'                        If InStr(stBCCr, tmpArr(j)) = 0 Then
'                           stBCCr = stBCCr & IIf(stBCCr = "", "", ";") & tmpArr(j)
'                        End If
'                     End If
'                  Next j
'               End If
'            End If
'            '2021/10/19 END
            '2024/12/4 END
            
            stReceivers = Trim(Replace(stReceivers, " ", "")) 'Addd By Sindy 2016/4/28
            If Replace(stReceivers, ";", "") <> "" Then
            'If stReceivers <> "" Then
            
               'Added by Morgan 2022/5/27
               '若收件者為已離職的智權人員則改發
               '1. 有案號者，正本發給該案現行智權人員、加發副本給原收件者之區主管
               '2. 無案號者直接發給區主管
               '3. 內文加註原智權人員XXX已離職
               stTmp = Replace(stReceivers, ";", "")
               stTmp2 = PUB_GetStaffST15(stTmp, "1")
               If Left(stTmp2, 1) = "S" Then
                  If GetStaffName(stTmp) = "" Then
                     If stReceiveNo <> "" Then
                        stSQL = "Select cp01,cp02,cp03,cp04 from caseprogress where cp09='" & stReceiveNo & "'"
                        intI = 1
                        Set rstQuery = ClsLawReadRstMsg(intI, stSQL)
                        If intI = 1 Then
                           stReceivers = PUB_GetAKindSalesNo(rstQuery("cp01"), rstQuery("cp02"), rstQuery("cp03"), rstQuery("cp04"))
                           stCCReceiver = GetDeptMan(stTmp2) & ";" & stCCReceiver
                        End If
                     Else
                        stReceivers = GetDeptMan(stTmp2)
                     End If
                     'Modify By Sindy 2022/12/2 增加判斷是否留職停薪中
                     'stContent = "原智權人員 " & GetStaffName(stTmp, True) & " 已離職!!" & vbCrLf & vbCrLf & stContent
                     stContent = "原智權人員 " & GetStaffName(stTmp, True) & " " & IIf(PUB_StaffChange04(stTmp) = True, "留職停薪中", "已離職") & "!!" & vbCrLf & vbCrLf & stContent
                  End If
               End If
               'end 2022/5/27
               
               'Add By Sindy 2011/10/27 收件人請假時則同時副本發案件職代
               Dim strTempCC1 As String, strTempCC2 As String
               If bolAbsenceSys = False Then '非出缺勤系統才需控管案件職代
                  'Modify By Sindy 2012/1/10 +bolCaseDutyAgentMsg
                  'Modify By Sindy 2012/9/13 +strRestKind休假狀況
                  'Modify by Sindy 2016/10/12 + bolInSpecialDuty:是否含特殊職代
                  'Modify By Sindy 2023/6/2 + strDutyAgentKind:指定職代種類
                  'Modify By Sindy 2025/2/24 此函數 bolInSpecialDuty 已取消使用
                  strTempCC1 = GetCaseDutyAgent(stReceiver, stReceiveNo, bolCaseDutyAgentMsg, strRestKind, bolInSpecialDuty, strDutyAgentKind)
                  If strTempCC1 <> "" Then
                     'stCCReceiver = stCCReceiver & ";" & strTempCC1  'Modify By Sindy 2017/5/12 Mark
                     'Modify By Sindy 2012/9/13 王副總提能否就實際狀況顯示,若出差則顯示出差
                     'stContent = "因收件人請假，請副本收件人處理此郵件。" & vbCrLf & vbCrLf & stContent
            '         If strRestKind = "1" Then '請假
            '            stContent = "因收件人請假，請副本收件人處理此郵件。" & vbCrLf & vbCrLf & stContent
            '         Else '出差
            '            stContent = "因收件人出差，請副本收件人處理此郵件。" & vbCrLf & vbCrLf & stContent
            '         End If
                     '2012/9/13 End
                     'Modify By Sindy 2012/10/3
                     'Modify By Sindy 2024/8/1
                     If strRestKind = "全體人員因颱風天停止上班" Then
                        stContent = "因颱風天停止上班，請收件者和副本收件人處理此郵件。" & vbCrLf & vbCrLf & stContent
                     Else
                     '2024/8/1 END
                        stContent = "因收件人" & strRestKind & "，請副本收件人處理此郵件。" & vbCrLf & vbCrLf & stContent
                     End If
                  End If
                  'Modify By Sindy 2019/7/18 和秀玲,經理討論結果副本應該是被告知,所以若人員休假時不需另再通知其職代
                  '***** ex *****
                  '收受者:陳鳳英(Frances.經理) <68005@taie.com.tw>; 洪琬姿(Amanda.經理) <Amanda@taie.com.tw>; 葉易雲(May.副理) <78011@taie.com.tw>; 葉芳如(Ellie) <78028@taie.com.tw>; 顏裕洋(David.副理) <77015@taie.com.tw>; 陳毓芳(Elaine.主任) <99021@taie.com.tw>; 潘子微(FCP承辦.主任) <A4011@taie.com.tw>; 楊映慈(FCP承辦.主任) <A6035@taie.com.tw>; TM
                  '副本:江郁仁(律師.協理) <Yuni@taie.com.tw>; 葉雪貞(jennie.特助) <67002@taie.com.tw>; 林純貞(內商.經理) <69008@taie.com.tw>; 洪琬姿(Amanda.經理) <Amanda@taie.com.tw>; 葉芳如(Ellie) <78028@taie.com.tw>; 吳彩菱(FCP承辦) <A1021@taie.com.tw>; 邱子瑜(FCP承辦) <A1032@taie.com.tw>; 林承慧(商爭.主任) <86048@taie.com.tw>
                  '
                  '因收件人陳鳳英請假、陳毓芳請假，請副本收件人處理此郵件。
                  '信件內容參附件
                  '同仁收到由 INBOUND (ipdept) 所寄發之郵件, 若無法暸解為何會收到該封e-mail, 或該封e-mail非貴單位之案件, 請務必及時再轉寄 ipdept@taie.com.tw 以便國外部迅速轉發適當收信同仁, 謝謝!
                  '***** ex *****
                        'Add By Sindy 2017/5/12 增加檢查副本收件人是否有休假,若有,其職代也要加入為副本收件人
                  '      If stCCReceiver <> "" Then
                  '         strTempCC2 = GetCaseDutyAgent(stCCReceiver, stReceiveNo, False, strRestKind, bolInSpecialDuty)
                  '      End If
                  If strTempCC1 <> "" Then
                     stCCReceiver = IIf(stCCReceiver <> "", stCCReceiver & ";" & strTempCC1, strTempCC1)
                  End If
            '      If strTempCC2 <> "" Then stCCReceiver = IIf(stCCReceiver <> "", stCCReceiver & ";" & strTempCC2, strTempCC2)
                  '2019/7/18 END
                  '2017/5/12 END
               End If
               '2011/10/27 End
               
               'Modify By Sindy 2024/12/9 比較資料是否有重覆,去掉重覆值
               Call PUB_CompRepeatReple(stReceivers, stCCReceiver)
               Call PUB_CompRepeatReple(stReceivers, stBCCr)
               
               With frm880005
                  .m_ByUTF8 = bolByUTF8 'Added by Morgan 2022/3/23
                  .m_iSignatureID = iSignatureID 'Added by Morgan 2019/8/27
                  
                  .txtEmail(0).Text = stReceivers '收件者
 
                  'edit by nickc 2005/03/17
                  '        '若使用者非北所人員, 則E-Mail後面加@taie.com.tw
                  '        Else
                  '            For ii = LBound(arrReciverNo) To UBound(arrReciverNo)
                  '               stReceivers = stReceivers & arrReciverNo(ii) & "@taie.com.tw;"
                  '            Next
                  '            .txtEmail(0).Text = stReceivers
                  '        End If
                  .txtEmail(1).Text = stSubject '主旨
                  .txtEmail(2).Text = stContent '內容
                  'add by nickc 2006/12/06
                  'Modified by Morgan 2017/11/2
                  'If blHtml = True Then .chkShowPic.Value = 1 Else .chkShowPic.Value = 0
                  .bolHTML = blHtml
                  .chkShowPic.Value = IIf(bolShowPic, 1, 0)
                  'end 2017/11/2
                  .txtEmail(4).Text = stFilePath
                  'Add By Sindy 2009/09/23
                  .txtEmail(5).Text = stCCReceiver  '副本
                  
                  'add by nickc 2006/12/28
                  .bolByMsa = IsByMsaIsp
                  
                  'Add by Morgan 2010/12/17
                  .m_FromID = stFromID
                  .m_FromName = stFromName
                  'end 2010/12/17
                  .m_ReplyTo = stReplyTo 'Add by Morgan 2011/4/22
                  .m_BCCto = stBCCr 'Added by Lydia 2015/08/03
                  .bolShowErrMsg = bolShowErrMsg 'Modify by Sindy 2016/12/12
                  .bolImportant = bolImportant 'Added by Morgan 2018/9/12
                  
                  'Add By Sindy 2017/11/17 為了記錄寄送資訊
                  .m_strUpdWhere = strUpdWhere
                  .m_strTableName = strTableName
                  '2017/11/17 END
                  
                  'Modify By Sindy 2019/4/25 因董事長無收到作業系統發的E-Mail，請協助處理。
                  '                          發現,因董事長在系統裡是設定不寄信
                  .bol63001CanSend = bol63001CanSend
                  .bolGetReceipt = bolGetReceipt 'Added by Morgan 2021/4/9
                  .m_SMTP_TEST = SMTP 'Added by Morgan 2024/4/17
                  .m_SaveMailCP09 = stSaveMailCP09 'Added by Morgan 2025/6/27
                  .Form_Activate: DoEvents
               End With
               Debug.Print Now
               frm880005.cmdok_Click 0: DoEvents
            Else
               'Modify By Sindy 2017/9/20 沒有收件者，要秀訊息
               'Modify By Sindy 2021/10/7 + 秀玲:把主旨也顯示出來，否則不知道怎麼去追蹤程式是哪裡出錯
               If bolShowErrMsg = True Then
                  MsgBox "沒有收件者，請問要寄給誰？" & vbCrLf & "(主旨=" & stSubject & ")", vbInformation, "寄信錯誤！"
               'Add By Sindy 2018/5/28
               Else
                  Pub_WriteSysLog "沒有收件者，請問要寄給誰？(寄信錯誤)" & vbCrLf & "(主旨=" & stSubject & ")"
               End If
               '2018/5/28 END
            End If
    End If
    
ErrHnd:
    If Err.Number <> 0 Then
      If bolShowErrMsg = True Then
         MsgBox Err.Description, vbCritical
      'Add By Sindy 2018/5/28
      Else
         Pub_WriteSysLog Err.Description
      End If
      '2018/5/28 END
    End If
    Set rstQuery = Nothing
    strUserName = strOldName 'Add by Morgan 2007/11/13
End Sub

'Add By Sindy 2024/12/4 比較資料是否有重覆,去掉重覆值
'strMain: 主要資料, 不可空白 ex:收受者
'strSec:  次要資料           ex:副本
'   沒有傳入次要資料時, 代表僅比較 strMain 是否有重覆的, 去掉 strMain 重覆的值
'     有傳入次要資料時, 代表以 strMain 為主 比對 strMain 的資料是否有存在 strSec 中, 若有, 去掉在 strSec 重覆的值
Public Sub PUB_CompRepeatReple(ByRef strMain As String, ByRef strSec As String)
Dim strText As String
Dim tmpArr As Variant
Dim j As Integer
   
   If strMain = "" Then Exit Sub
   
   '比較 strMain 是否有重覆的, 去掉 strMain 重覆的值
   strText = Replace(strMain, ",", ";")
   If Left(strText, 1) = ";" Then strText = Mid(strText, 2)
   If Right(strText, 1) = ";" Then strText = Left(strText, Len(strText) - 1)
   If strText <> "" And InStr(strText, ";") > 0 Then
      tmpArr = Split(strText, ";")
      strMain = ""
      For j = 0 To UBound(tmpArr)
         If tmpArr(j) <> "" Then
            If InStr(strMain, tmpArr(j)) = 0 Then
               strMain = strMain & IIf(strMain = "", "", ";") & tmpArr(j)
            End If
         End If
      Next j
   End If
   
   If strSec <> "" Then
      strText = Replace(strSec, ",", ";")
      If Left(strText, 1) = ";" Then strText = Mid(strText, 2)
      If Right(strText, 1) = ";" Then strText = Left(strText, Len(strText) - 1)
      If strText <> "" And InStr(strText, ";") > 0 Then
         tmpArr = Split(strText, ";")
         strSec = ""
         For j = 0 To UBound(tmpArr)
            If tmpArr(j) <> "" Then
               If InStr(strSec, tmpArr(j)) = 0 Then '比較 strSec 是否有重覆的, 去掉 strSec 重覆的值
                  If InStr(strMain, tmpArr(j)) = 0 Then '以 strMain 為主 比對 strMain 的資料是否有存在 strSec 中, 若有, 去掉在 strSec 重覆的值
                     strSec = strSec & IIf(strSec = "", "", ";") & tmpArr(j)
                  End If
               End If
            End If
         Next j
      End If
   End If
End Sub

'Add by Sindy 2019/9/4 檢查特殊收信人員(收受者,副本,密件副本均可使用的共同條件)
'Modify By Sindy 2021/9/7 + , ByVal stReceiveNo As Strin
'Modify By Sindy 2019/4/25 因董事長無收到作業系統發的E-Mail，請協助處理。
'                          發現,因董事長在系統裡是設定不寄信 + Optional ByVal bol63001CanSend As Boolean = False
'Add by Sindy 2021/10/25 + , ByVal bolAbsenceSys As Boolean: 是否為人事系統
'Modified by Morgan 2022/3/22 改為全域函數(frm880019要用)
Public Function ChkSpecMailReciver(ByVal strReciver As String, ByVal stReceiveNo As String, _
   ByVal bolAbsenceSys As Boolean, Optional ByVal bol63001CanSend As Boolean = False) As String
   
Dim stSQL As String, intR As Integer
Dim rstQuery As ADODB.Recordset
Dim arrReciverNo As Variant
Dim ii As Integer
Dim m_ST14 As String, strSys As String
Dim strChkData As String
   
   If strReciver = "" Then
      Exit Function
   End If
   
   ChkSpecMailReciver = ""
   arrReciverNo = Split(strReciver, ";")
   For ii = LBound(arrReciverNo) To UBound(arrReciverNo)
      strChkData = arrReciverNo(ii)
      'add by nickc 2008/03/28 原先僅外翻使用，現改通用
      m_ST14 = PUB_GetST14(Replace(UCase(arrReciverNo(ii)), "@TAIE.COM.TW", ""))
      If m_ST14 <> "" Then
         'Modified by Lydia 2017/03/28 不只一人
         'If m_ST14 = "99997" Then
         If m_ST14 <> "" And InStr(m_ST14, "99997") > 0 Then
            'Modify By Sindy 2019/4/25 董事長指示蘇月星請假、出差及加班單在所長核准後應會知董事長,因此特別調整必寄
            If arrReciverNo(ii) = "63001" Then
               If bol63001CanSend = False Then
                  arrReciverNo(ii) = ""
               End If
            Else
            '2019/4/25 END
               arrReciverNo(ii) = ""
            End If
         Else
            arrReciverNo(ii) = m_ST14
         End If
      End If

      If arrReciverNo(ii) <> "" Then
         ChkSpecMailReciver = ChkSpecMailReciver & arrReciverNo(ii) & ";"
      End If
       
      'Add By Sindy 2019/9/4 加發其他人員 (寄W1001 加發 W10全部人員;
      '寄W2001 加發 W20全部人員)
      'Modify By Sindy 2020/7/6 剔除不寄信者 and (st14<>'99997' or st14 is null)
      'Modify By Sindy 2024/11/26 系統通知信件(W2001)原會轉發顧服組所有人，請改發系統特殊設定「W2001收件人」。
      'If UCase(strChkData) = "W1001" Or UCase(strChkData) = "W2001" Then
      If UCase(strChkData) = "W1001" Then
      '2024/11/26 END
         stSQL = "select st01 from staff where st03='" & Left(UCase(strChkData), 3) & "'" & _
                 " and st04='1' and (st14<>'99997' or st14 is null)"
         intR = 1
         Set rstQuery = ClsLawReadRstMsg(intR, stSQL)
         If intR = 1 Then
            rstQuery.MoveFirst
            Do While Not rstQuery.EOF
               If InStr(ChkSpecMailReciver, rstQuery.Fields("st01")) = 0 And _
                  InStr(strReciver, rstQuery.Fields("st01")) = 0 Then
                  ChkSpecMailReciver = ChkSpecMailReciver & rstQuery.Fields("st01") & ";"
               End If
               rstQuery.MoveNext
            Loop
         End If
      'Modify By Sindy 2024/11/26
      ElseIf UCase(strChkData) = "W2001" Then
         ChkSpecMailReciver = ChkSpecMailReciver & Pub_GetSpecMan("W2001收件人") & ";"
      End If
      '2024/11/26 END
         'Modify By Sindy 2023/9/25 mark,取消
'         'Add By Sindy 2021/9/7
'         '現在W2001所有收文之專利案件皆由專利國內部程序在管理，所以在發W2001時要同時加發給程序。
'         '請修改程式:
'         '1. 若有案號可判斷時，以系統類別讀SYSTEMKIND之SK02為'1'或'5'者，則再加發系統特殊設定人員"A8"。
'         '2. 若無案號可判斷時也加發系統特殊設定人員"A8"。
'         If UCase(strChkData) = "W2001" Then
'            strSys = ""
'            stSQL = "select cp01 from caseprogress where cp09='" & stReceiveNo & "'"
'            intR = 1
'            Set rstQuery = ClsLawReadRstMsg(intR, stSQL)
'            If intR = 1 Then
'               strSys = CheckSys(rstQuery.Fields("cp01"))
'            End If
'            If strSys = "" Or strSys = "1" Or strSys = "5" Then
'               ChkSpecMailReciver = ChkSpecMailReciver & Pub_GetSpecMan("A8") & ";"
'            End If
'         End If
'      End If
'      '2019/9/4 END
      
      'Add By Sindy 2021/10/25 系統發信時，增加檢查收信人員裡
      '是否有「總經理員工編號」並且非出缺勤系統時，才須加發「總經理業務工作代理人員」
      If bolAbsenceSys = False Then
         If InStr(UCase(strChkData), Pub_GetSpecMan("總經理員工編號")) > 0 Then
            ChkSpecMailReciver = ChkSpecMailReciver & Pub_GetSpecMan("總經理業務工作代理人員") & ";"
         End If
      End If
      '2021/10/25 END
   Next ii
   
   'Add By Sindy 2023/5/8
   If ChkSpecMailReciver <> "" And Right(ChkSpecMailReciver, 1) = ";" Then ChkSpecMailReciver = Left(ChkSpecMailReciver, Len(ChkSpecMailReciver) - 1)
   '2023/5/8 END
   
   Set rstQuery = Nothing
End Function
 

'Add by Morgan 2004/12/13 檢查國內外案件關聯是否存在
'sFrom:0=國內查國外，1=國外查國內
Public Function PUB_IfCaseMapExist(ByRef stCM() As String, Optional ByVal sFrom As String = "1") As Boolean

On Error GoTo ErrHnd

   If sFrom = "1" Then
      strSql = "select 1 from casemap,caseprogress" & _
         " where cm01='" & stCM(1) & "' and cm02='" & stCM(2) & "' and cm03='" & stCM(3) & "' and cm04='" & stCM(4) & "'" & _
         " and cm10='0'" & _
         " and cp01(+)=cm05 and cp02(+)=cm06 and cp03(+)=cm07 and cp04(+)=cm08 and cp31='Y' and cp05<=19110000+" & stCM(5)
   Else
      strSql = "select 1 from casemap,caseprogress" & _
         " where cm05='" & stCM(1) & "' and cm06='" & stCM(2) & "' and cm07='" & stCM(3) & "' and cm08='" & stCM(4) & "'" & _
         " and cm10='0'" & _
         " and cp01(+)=cm01 and cp02(+)=cm02 and cp03(+)=cm03 and cp04(+)=cm04 and cp31='Y' and cp05<19110000+" & stCM(5)
   End If
   CheckOC3
   AdoRecordSet3.CursorLocation = adUseClient
   AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If AdoRecordSet3.RecordCount > 0 Then
      PUB_IfCaseMapExist = True
   End If
   
ErrHnd:

   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
   
End Function

'Add by Morgan 2004/12/16 代理人名稱
'stOpt:1=中,2=英,3=日
Public Function PUB_GetFAgentName(ByVal stCode As String, Optional ByVal stOpt As String = "1") As String

   Dim stFA0102 As String
   
On Error GoTo ErrHnd
   
   stFA0102 = Left(stCode & "0000000", 9)
   
   strSql = "select FA04,FA05,FA63,FA64,FA65,FA06 from FAGENT" & _
      " where FA01='" & Left(stFA0102, 8) & "' and FA02='" & Right(stFA0102, 1) & "'"
   CheckOC3
   With AdoRecordSet3
      .CursorLocation = adUseClient
      .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      If .RecordCount > 0 Then
         Select Case stOpt
            Case "1" '中
               PUB_GetFAgentName = "" & .Fields("FA04")
            Case "2" '英
               PUB_GetFAgentName = Trim("" & .Fields("FA05") & " " & .Fields("FA63") & " " & .Fields("FA64") & " " & .Fields("FA65"))
            Case Else '日
               PUB_GetFAgentName = "" & .Fields("FA06")
         End Select
      End If
   End With
ErrHnd:

   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
   
End Function

'add by nick 2004/12/16
'傳入案件備註，帶出代理人資料
'格式
'身分證統一編號：B100021145、G220556084
'姓          名：林晉章、林純貞
'地址：１ ０ ４：台北市長安東路2段112號9樓
'電          話：（02）25061023轉<管制人專業代號> 傳真：（02）25090804
' 現在只有林晉章和林純貞
Public Function GetExceptionFagent(oCP64 As String) As String
Dim oStr1 As String
Dim oStr2 As String
If oCP64 = "" Then GetExceptionFagent = ",": Exit Function
GetExceptionFagent = ""
oStr1 = ""
oStr2 = ""
If InStr(1, oCP64, "林晉章") > 0 Then
    oStr1 = oStr1 & "B100021145"
    oStr2 = oStr2 & "林晉章"
End If
If InStr(1, oCP64, "林純貞") > 0 Then
    If oStr1 <> "" Then
        oStr1 = oStr1 & "、"
        oStr2 = oStr2 & "、"
    End If
    oStr1 = oStr1 & "G220556084"
    oStr2 = oStr2 & "林純貞"
End If
GetExceptionFagent = oStr1 & "," & oStr2
End Function
'Add by Morgan 2005/1/3
'判斷專利種類是否自動發證
'Modify by Morgan 2011/8/8 +strPA10
'Modified by Morgan 2012/4/24 +pCP()
Public Function PUB_AutoIssue(ByVal strNA01 As String, ByVal strPA08 As String, ByVal strPA10 As String, ByRef pCP() As String) As Boolean
   
   PUB_AutoIssue = False
   
On Error GoTo ErrHnd

   'Added by Morgan 2012/4/24
   '馬來西亞發明或新型實審提出日為 2011/2/15 當日或以後者為自動發證(因沒有強制要輸已提申且與慧汶確認後沒有該日之前發文而之後提申的案件故改用發文日判斷)
   If strNA01 = "018" And (strPA08 = "1" Or strPA08 = "2") Then
      strSql = "select cp47 from caseprogress" & _
         " where cp01='" & pCP(1) & "' and cp02='" & pCP(2) & "' and cp03='" & pCP(3) & "' and cp04='" & pCP(4) & "'" & _
         " and cp10='416' and cp27<20110215"
      intI = 1
      Set AdoRecordSet3 = ClsLawReadRstMsg(intI, strSql)
      If intI = 1 Then
         PUB_AutoIssue = False
         Exit Function
      End If
   End If
   'end 2012/4/24
   
   strSql = "Select * From Nation Where NA01='" & strNA01 & "'"
   CheckOC3
   With AdoRecordSet3
      .CursorLocation = adUseClient
      .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      If .RecordCount > 0 Then
         Select Case strPA08
            Case 1 '發明
               PUB_AutoIssue = IIf("" & .Fields("NA49").Value = "", False, True)
            Case 2 '新型
               PUB_AutoIssue = IIf("" & .Fields("NA53").Value = "", False, True)
               'Add by Morgan 2011/8/8 參考 frm05010403_2
               'CFP-021410
               If strNA01 = "012" And Val(DBDATE(strPA10)) < 20061001 Then
                  PUB_AutoIssue = True
               End If
               'end 2011/8/8
            Case 3 '設計
               PUB_AutoIssue = IIf("" & .Fields("NA54").Value = "", False, True)
         End Select
      End If
   End With
   
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
   
End Function

'Add by Morgan 2005/1/17 檢查是否一案兩請 (鎖定以發明案抓取新型案)
'I: p_stPA()->發明案本所案號陣列,p_stCaseNo->新型本所號,p_stCertNo->新型證書號,p_stAppNo->申請案號,p_stCaseName->案件名稱
'Modified by Lydia 2015/04/20 改為可抓相對應的申請案+p_bolDualNO , p_CaseType
'Public Function PUB_IsDualApply(ByRef p_stPA() As String, ByRef p_stUPA() As String, Optional ByRef p_stCaseNo As String, Optional ByRef p_stCertNo As String, Optional ByRef p_stAppNo As String, Optional ByRef p_stCaseName As String, Optional p_bolNo429 As Boolean) As Boolean
Public Function PUB_IsDualApply(ByRef p_stPA() As String, ByRef p_stUPA() As String, Optional ByRef p_stCaseNo As String, Optional ByRef p_stCertNo As String, Optional ByRef p_stAppNo As String, Optional ByRef p_stCaseName As String, Optional p_bolNo429 As Boolean, Optional ByVal p_bolDualNO As Boolean, Optional ByRef p_CaseType As String) As Boolean
On Error GoTo ErrHnd
   'Modified by Lydia 2015/04/20
   If p_bolDualNO Then
    strSql = "SELECT PA01||'-'||PA02||DECODE(PA03,'0',NULL,'-'||PA03)||DECODE(PA04,'00',NULL,'-'||PA04) X01" & _
       ",PA22 X02, PA11 X03,PA05||PA06||PA07 X04, PA01,PA02,PA03,PA04,PTM03" & _
       " FROM ( SELECT CM01,CM02,CM03,CM04 FROM CASEMAP" & _
       " Where CM10 = 3 AND CM05='" & p_stPA(1) & "' AND CM06='" & p_stPA(2) & "' AND CM07='" & p_stPA(3) & "' AND CM08='" & p_stPA(4) & "'" & _
       " Union All" & _
       " SELECT CM05,CM06,CM07,CM08 FROM CASEMAP" & _
       " Where CM10 = 3  AND CM01='" & p_stPA(1) & "' AND CM02='" & p_stPA(2) & "' AND CM03='" & p_stPA(3) & "' AND CM04='" & p_stPA(4) & "'" & _
       " ) X, PATENT,PatentTrademarkMap" & _
       " WHERE PA01(+)=CM01 AND PA02(+)=CM02 AND PA03(+)=CM03 AND PA04(+)=CM04 and PTM01='1' AND PA08=PTM02(+) "
   'end 'Modified by Lydia 2015/04/20
   Else
    strSql = "SELECT PA01||'-'||PA02||DECODE(PA03,'0',NULL,'-'||PA03)||DECODE(PA04,'00',NULL,'-'||PA04) X01" & _
       ",PA22 X02, PA11 X03,PA05||PA06||PA07 X04, PA01,PA02,PA03,PA04" & _
       " FROM ( SELECT CM01,CM02,CM03,CM04 FROM CASEMAP" & _
       " Where CM10 = 3 AND CM05='" & p_stPA(1) & "' AND CM06='" & p_stPA(2) & "' AND CM07='" & p_stPA(3) & "' AND CM08='" & p_stPA(4) & "'" & _
       " Union All" & _
       " SELECT CM05,CM06,CM07,CM08 FROM CASEMAP" & _
       " Where CM10 = 3  AND CM01='" & p_stPA(1) & "' AND CM02='" & p_stPA(2) & "' AND CM03='" & p_stPA(3) & "' AND CM04='" & p_stPA(4) & "'" & _
       " ) X, PATENT" & _
       " WHERE PA01(+)=CM01 AND PA02(+)=CM02 AND PA03(+)=CM03 AND PA04(+)=CM04 AND PA08=2"
   End If
   'Added by Morgan 2012/8/15
   If p_bolNo429 = True Then
      strSql = strSql & " and not exists(select * from caseprogress where cp01=pa01 and cp02=pa02 and cp03=pa03 and cp04=pa04 and cp10='429' and cp57 is null)"
   End If
   'end 2012/8/15
      
   CheckOC
   adoRecordset.CursorLocation = adUseClient
   adoRecordset.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If adoRecordset.RecordCount > 0 Then
      PUB_IsDualApply = True
      p_stCaseNo = "" & adoRecordset.Fields(0)
      p_stCertNo = "" & adoRecordset.Fields(1)
      p_stAppNo = "" & adoRecordset.Fields(2)
      p_stCaseName = "" & adoRecordset.Fields(3)
      p_stUPA(1) = "" & adoRecordset.Fields("PA01")
      p_stUPA(2) = "" & adoRecordset.Fields("PA02")
      p_stUPA(3) = "" & adoRecordset.Fields("PA03")
      p_stUPA(4) = "" & adoRecordset.Fields("PA04")
      'Modified by Lydia 2015/04/20
      If p_bolDualNO Then
         p_CaseType = "" & adoRecordset.Fields("PTM03")
      End If
   End If
   
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
End Function

'Add By Sindy 2014/7/8 檢查是否為一案兩請且另一案未閉卷; 亦可同時檢查另一案是否某案件性質未發文未取消收文
'I: p_stPA()->本所案號陣列,p_stAnoPA->另一案的本所案號,p_stCaseNo->本所案號(串在一起)
'p_stCertNo->專利號數,p_stAppNo->申請案號,p_stCaseName->案件名稱
'p_stCP10->欲檢查的案件性質,p_bolIsExistsCP10->是否有此案件性質未發文未取消收文
'p_stCP27->本案發文日,p_bolAnoDated-->另一案是否有發文日
Public Function PUB_IsDualApplyCom(ByRef p_stPA() As String, ByRef p_stAnoPA() As String, Optional ByRef p_stCaseNo As String, _
                                   Optional ByRef p_stCertNo As String, Optional ByRef p_stAppNo As String, Optional ByRef p_stCaseName As String, _
                                   Optional ByVal p_stCP10 As String = "", Optional p_bolIsExistsCP10 As Boolean = False, Optional p_stCP27 As String, Optional p_bolAnoDated As Boolean = False) As Boolean
   Dim stCon As String
   
On Error GoTo ErrHnd
   
   '一案兩請且另一案未閉卷
   strSql = "SELECT PA01||'-'||PA02||DECODE(PA03,'0',NULL,'-'||PA03)||DECODE(PA04,'00',NULL,'-'||PA04) X01" & _
      ",PA22 X02, PA11 X03,PA05||PA06||PA07 X04, PA01,PA02,PA03,PA04" & _
      " FROM ( SELECT CM01,CM02,CM03,CM04 FROM CASEMAP" & _
      " Where CM10 = 3 AND CM05='" & p_stPA(1) & "' AND CM06='" & p_stPA(2) & "' AND CM07='" & p_stPA(3) & "' AND CM08='" & p_stPA(4) & "'" & _
      " Union All" & _
      " SELECT CM05,CM06,CM07,CM08 FROM CASEMAP" & _
      " Where CM10 = 3  AND CM01='" & p_stPA(1) & "' AND CM02='" & p_stPA(2) & "' AND CM03='" & p_stPA(3) & "' AND CM04='" & p_stPA(4) & "'" & _
      " ) X, PATENT" & _
      " WHERE PA01(+)=CM01 AND PA02(+)=CM02 AND PA03(+)=CM03 AND PA04(+)=CM04 AND PA57 is null AND PA108 is null"
   CheckOC
   adoRecordset.CursorLocation = adUseClient
   adoRecordset.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If adoRecordset.RecordCount > 0 Then
      PUB_IsDualApplyCom = True
      p_stCaseNo = "" & adoRecordset.Fields(0)
      p_stCertNo = "" & adoRecordset.Fields(1)
      p_stAppNo = "" & adoRecordset.Fields(2)
      p_stCaseName = "" & adoRecordset.Fields(3)
      p_stAnoPA(1) = "" & adoRecordset.Fields("PA01")
      p_stAnoPA(2) = "" & adoRecordset.Fields("PA02")
      p_stAnoPA(3) = "" & adoRecordset.Fields("PA03")
      p_stAnoPA(4) = "" & adoRecordset.Fields("PA04")
   End If
   If p_stCP10 <> "" And PUB_IsDualApplyCom = True Then
      'Modified by Morgan 2015/6/11 +考慮第2案發文時第1案已有發文日
      If p_stCP27 <> "" Then
         stCon = " and (cp27 is null or cp27=" & p_stCP27 & ")"
      Else
         stCon = " and cp27 is null"
      End If
      strSql = "select cp01,cp27 from caseprogress" & _
               " where cp01='" & p_stAnoPA(1) & "' and cp02='" & p_stAnoPA(2) & "' and cp03='" & p_stAnoPA(3) & "' and cp04='" & p_stAnoPA(4) & "'" & _
               " and cp10 in(" & p_stCP10 & ")  and cp57 is null" & stCon
      'end 2015/6/11
      CheckOC
      adoRecordset.CursorLocation = adUseClient
      adoRecordset.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      If adoRecordset.RecordCount > 0 Then
         p_bolIsExistsCP10 = True
         If adoRecordset("cp27") > 0 Then
            p_bolAnoDated = True
         End If
      End If
   End If
   
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
End Function

'Add by Morgan 2005/2/1
'新型案提申日(民國)
Public Function PUB_UtiAppDate(ByRef p_CP() As String, ByRef PA10 As String) As String
   
   PUB_UtiAppDate = PA10
   
On Error GoTo ErrHnd

   strSql = "select CP27,CP10 from caseprogress" & _
         " where cp01='" & p_CP(1) & "' AND CP02='" & p_CP(2) & "' and CP03='" & p_CP(3) & "' AND CP04='" & p_CP(4) & "' AND CP10='302'" & _
         " Union All" & _
         " select CP27,CP10 from caseprogress A" & _
         " where cp01='" & p_CP(1) & "' AND CP02='" & p_CP(2) & "' and CP03='" & p_CP(3) & "' AND CP04='" & p_CP(4) & "' AND CP10='404'" & _
         " AND EXISTS(SELECT * FROM CASEPROGRESS B WHERE B.CP09=A.CP43 AND B.CP10='302')" & _
         " ORDER BY CP27"
         
   CheckOC3
   With AdoRecordSet3
      .CursorLocation = adUseClient
      .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      If .RecordCount > 0 Then
         PUB_UtiAppDate = Format(Val("" & .Fields("CP27")) - 19110000)
      End If
   End With
   
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
   
End Function


'Add by Morgan 2005/2/16 設定使用者資料庫參數
Public Function PUB_SetUserData() As Boolean

On Error GoTo ErrHnd
    
    PUB_SetUserData = False
    strSql = "select st04,st02,st11 from staff where upper(st01)=" + CNULL(strUserNum)
   CheckOC3
   With AdoRecordSet3
      .CursorLocation = adUseClient
      .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      If .RecordCount > 0 Then
         If .Fields(0) = "1" Then
            strSql = "begin " + _
                "select st02,st03,st05,st11 into user_data.user_name,user_data.user_department," + _
                "user_data.user_level,user_data.user_group from staff where upper(st01)=" + CNULL(strUserNum) + ";" + _
                "user_data.user_num:=" + CNULL(strUserNum) + ";" + _
                "end;"
            cnnConnection.Execute strSql
            strUserName = IIf(IsNull(.Fields(1)), "", .Fields(1))
            strGroup = IIf(IsNull(.Fields(2)), "", .Fields(2))
            PUB_SetUserData = True
         Else
            ShowMsg MsgText(9165)
         End If
      Else
         ShowMsg MsgText(9166)
      End If
   End With
   
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
   
End Function
'Add by Morgan 2005/2/16 重新連線
Public Function PUB_ReConnect() As Boolean

On Error GoTo ErrHnd

   If cnnConnection.State = adStateClosed Then
      cnnConnection.Open
   End If
   PUB_ReConnect = True
   
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
   
End Function

'Add by Morgan 2005/3/2 從 prjTaieDll.ReadCaseProgressDatabase 移過來
'讀取CaseProgress案件進度檔
'Modified by Lydia 2023/05/11 +是否縮短X編號bolShortNo
Public Function PUB_ReadCaseProgressDatabase(ByRef cp() As String, intWhere As Integer, Optional ByVal bolShortNo As Boolean = True) As Boolean

   Dim i As Integer
   
On Error GoTo ErrHnd

   ReDim Preserve cp(TF_CP) As String
   
   strSql = "select * from caseprogress where cp09=" + CNULL(cp(9))
   CheckOC3
   With AdoRecordSet3
      .CursorLocation = adUseClient
      .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      If .RecordCount > 0 Then
         For i = 0 To TF_CP - 1
             cp(i + 1) = "" & .Fields(i)
         Next
         If intWhere <> 國外_CF Then
            cp(5) = ChangeWStringToTString(cp(5))
            cp(6) = ChangeWStringToTString(cp(6))
            cp(7) = ChangeWStringToTString(cp(7))
            cp(25) = ChangeWStringToTString(cp(25))
            cp(27) = ChangeWStringToTString(cp(27))
            cp(46) = ChangeWStringToTString(cp(46))
            cp(47) = ChangeWStringToTString(cp(47))
            cp(48) = ChangeWStringToTString(cp(48))
            'Modify by Morgan 2010/1/21 內專的領證年費退費放的是起迄年度不要轉
            '2010/2/22 MODIFY BY SONIA CFP的605~607也不要轉
            'If Not (cp(1) = "P" And (cp(10) = "601" Or cp(10) = "605" Or cp(10) = "908")) Then
            'Modfiy by Amy 2018/04/10 +612 年費移作次年
            If Not ((cp(1) = "P" Or cp(1) = "CFP") And (cp(10) = "601" Or cp(10) = "605" Or cp(10) = "606" Or cp(10) = "607" Or cp(10) = "612" Or cp(10) = "908")) Then
               cp(53) = ChangeWStringToTString(cp(53))
               cp(54) = ChangeWStringToTString(cp(54))
            End If
            cp(57) = ChangeWStringToTString(cp(57))
         End If
         If bolShortNo = True Then 'Added by Lydia 2023/05/11
            cp(44) = ChangeCustomerS(cp(44))
            cp(55) = ChangeCustomerS(cp(55))  '移轉人(讓與人)
            cp(56) = ChangeCustomerS(cp(56)) '移轉申請人(讓與申請人)1
         'Added by Lydia 2023/05/11
            cp(89) = ChangeCustomerS(cp(89)) '移轉申請人(讓與申請人)2
            cp(90) = ChangeCustomerS(cp(90)) '移轉申請人(讓與申請人)3
            cp(91) = ChangeCustomerS(cp(91)) '移轉申請人(讓與申請人)4
            cp(92) = ChangeCustomerS(cp(92)) '移轉申請人(讓與申請人)5
            cp(93) = ChangeCustomerS(cp(93)) '移轉人(讓與人)2
            cp(94) = ChangeCustomerS(cp(94)) '移轉人(讓與人)3
            cp(95) = ChangeCustomerS(cp(95)) '移轉人(讓與人)4
            cp(96) = ChangeCustomerS(cp(96)) '移轉人(讓與人)5
         End If
         'end 2023/05/11
         PUB_ReadCaseProgressDatabase = True
      Else
         ShowMsg MsgText(9147)
      End If
   End With
   
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical

End Function

'Add by Morgan 2005/3/2 抓加乘註記預設
'p_CP09 總收文號,p_CP98 承辦加乘註記,p_CP101 草圖加乘註記,p_CP104 墨圖加乘註記
Public Function PUB_GetFlagValue(ByRef p_CP09 As String, Optional ByRef p_CP98 As String, Optional ByRef p_CP101 As String, Optional ByRef p_CP104 As String) As Boolean
   
   Dim stEF03 As String, i As Integer, stCP18 As String, stCF13 As String, siBonus As Single
   
On Error GoTo ErrHnd
   'edit by nickc 2005/03/17 加商標法務顧問
'   StrSql = " SELECT CP05,CP13,CP18,PA26,PA27,PA28,PA29,PA30,CF13" & _
      " FROM (select CP01,CP05,CP10,CP13,CP18,PA09,PA26,PA27,PA28,PA29,PA30" & _
      " from caseprogress,patent" & _
      " where cp09=" & CNULL(p_CP09) & " AND PA01=CP01 AND PA02=CP02 AND PA03=CP03 AND PA04=CP04" & _
      " union select CP01,CP05,CP10,CP13,CP18,SP09,SP08,SP58,SP59,SP65,SP66" & _
      " from caseprogress,SERVICEPRACTICE" & _
      " where cp09=" & CNULL(p_CP09) & " AND SP01=CP01 AND SP02=CP02 AND SP03=CP03 AND SP04=CP04" & _
      " ) A,CASEFEE" & _
      " WHERE CF01(+)=CP01 AND CF02(+)=PA09 AND CF03(+)=CP10"
'Modify By Sindy 2011/2/22 增加TM78,TM79,TM80,TM81,LC43,LC44,LC45,LC46,HC24,HC25,HC26,HC27,SP58,SP59,SP65,SP66
strSql = " SELECT CP05,CP13,CP18,PA26,PA27,PA28,PA29,PA30,CF13" & _
      " FROM (select CP01,CP05,CP10,CP13,CP18,PA09,PA26,PA27,PA28,PA29,PA30" & _
      " from caseprogress,patent" & _
      " where cp09=" & CNULL(p_CP09) & " AND PA01=CP01 AND PA02=CP02 AND PA03=CP03 AND PA04=CP04" & _
      " union select CP01,CP05,CP10,CP13,CP18,tm10,tm23,tm78,tm79,tm80,tm81" & _
      " from caseprogress,trademark" & _
      " where cp09=" & CNULL(p_CP09) & " AND tm01=CP01 AND tm02=CP02 AND tm03=CP03 AND tm04=CP04" & _
      " union select CP01,CP05,CP10,CP13,CP18,lc15,lc11,lc43,lc44,lc45,lc46" & _
      " from caseprogress,lawcase" & _
      " where cp09=" & CNULL(p_CP09) & " AND lc01=CP01 AND lc02=CP02 AND lc03=CP03 AND lc04=CP04" & _
      " union select CP01,CP05,CP10,CP13,CP18,'000',hc05,hc24,hc25,hc26,hc27" & _
      " from caseprogress,hirecase" & _
      " where cp09=" & CNULL(p_CP09) & " AND hc01=CP01 AND hc02=CP02 AND hc03=CP03 AND hc04=CP04" & _
      " union select CP01,CP05,CP10,CP13,CP18,SP09,SP08,SP58,SP59,SP65,SP66" & _
      " from caseprogress,SERVICEPRACTICE" & _
      " where cp09=" & CNULL(p_CP09) & " AND SP01=CP01 AND SP02=CP02 AND SP03=CP03 AND SP04=CP04" & _
      " ) A,CASEFEE" & _
      " WHERE CF01(+)=CP01 AND CF02(+)=PA09 AND CF03(+)=CP10"
      
      
   CheckOC3
   With AdoRecordSet3
      .CursorLocation = adUseClient
      .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      If .RecordCount > 0 Then
         'CP98,CP101,CP104 承辦人,草圖,墨圖加乘註記
         '先抓特殊加乘註記設定
         For i = 26 To 30
            If "" & .Fields("PA" & Format(i)) <> "" Then
               stEF03 = stEF03 & "'" & .Fields("PA" & Format(i)) & "',"
            End If
         Next
         stEF03 = stEF03 & "'" & .Fields("CP13") & "'"
         stCP18 = "" & .Fields("CP18")
         stCF13 = "" & .Fields("CF13")
         strSql = "SELECT NVL(MAX(EF04),1) X01,NVL(MAX(EF05),1) X02,NVL(MAX(EF06),1) X03 FROM ExFlag" & _
            " Where EF01<=" & .Fields("CP05") & " AND EF02>=" & .Fields("CP05") & " AND EF03 IN (" & stEF03 & ")"
         CheckOC2
         adoRecordset1.CursorLocation = adUseClient
         adoRecordset1.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
         If adoRecordset1.RecordCount > 0 Then
            p_CP98 = adoRecordset1.Fields(0)
            p_CP101 = adoRecordset1.Fields(1)
            p_CP104 = adoRecordset1.Fields(2)
            If Val(stCP18) > 0 And Val(stCF13) > 0 Then
               '超出標準價每40%加0.5，上限為3 int 有bug int(4/0.4)=9 須先轉dbl
               siBonus = 0.5 * Int(CDbl((Val(stCP18) - Val(stCF13)) / (Val(stCF13) * 0.4)))
               If siBonus > 0 Then
                  p_CP98 = Format(Val(p_CP98) + siBonus)
                  If Val(p_CP98) > 3 Then p_CP98 = "3"
                  p_CP101 = Format(Val(p_CP101) + siBonus)
                  If Val(p_CP101) > 3 Then p_CP101 = "3"
                  p_CP104 = Format(Val(p_CP104) + siBonus)
                  If Val(p_CP104) > 3 Then p_CP104 = "3"
               End If
            End If
            PUB_GetFlagValue = True
         End If
      End If
   End With
   
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical

End Function

'Add by Morgan 2005/3/2 從 prjTaieDll.ReadAllData 移過來
'讀取該收文號之資料，包含基本檔、進度檔(暫時只有專利,服務)
'Modify by Morgan 2007/2/14 加商標,法務,顧問
Public Function PUB_ReadAllData(ByRef cp() As String, ByRef field() As String, ByRef intCaseKind As Integer, ByRef intWhere As Integer) As Boolean

On Error GoTo ErrHnd

   If PUB_ReadCaseProgressDatabase(cp(), intWhere) Then
      ReDim field(4) As String
      field(1) = cp(1)
      field(2) = cp(2)
      field(3) = cp(3)
      field(4) = cp(4)
      'Modify by Morgan 2007/4/10 抽出成另一function
      PUB_ReadAllData = PUB_ReadCaseData(field, intCaseKind, intWhere)
   Else
      ShowMsg MsgText(9147)
   End If

ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
End Function

'Add by Morgan 2007/4/10 從PUB_ReadAllData抽出來
'Modified by Lydia 2023/05/11 +是否縮短X編號bolShortNo
Public Function PUB_ReadCaseData(ByRef field() As String, ByRef intCaseKind As Integer, ByRef intWhere As Integer, Optional ByVal bolShortNo As Boolean = True) As Boolean
   If ClsPDGetSystemKind(field(1), intCaseKind) Then
      Select Case intCaseKind
         Case 專利
            ReDim Preserve field(TF_PA) As String
            'Modified by Lydia 2023/05/11 +bolShortNo
            If PUB_ReadPatentDatabase(field(), intWhere, bolShortNo) Then
               PUB_ReadCaseData = True
            Else
               ShowMsg MsgText(9141)
            End If
         'Add by Morgan 2007/2/14
         Case 商標
            ReDim Preserve field(TF_TM) As String
            If PUB_ReadTradeMarkData(field(), field(1), field(2), field(3), field(4)) Then
               PUB_ReadCaseData = True
            Else
               ShowMsg MsgText(9141)
            End If
         Case 法務
            ReDim Preserve field(TF_LC) As String
            If PUB_ReadLawCaseData(field(), field(1), field(2), field(3), field(4)) Then
               PUB_ReadCaseData = True
            Else
               ShowMsg MsgText(9141)
            End If
         Case 顧問
            ReDim Preserve field(TF_HC) As String
            If PUB_ReadHireCaseData(field(), field(1), field(2), field(3), field(4)) Then
               PUB_ReadCaseData = True
            Else
               ShowMsg MsgText(9141)
            End If
         'End 2007/2/14
         Case Else
            ReDim Preserve field(tf_SP) As String
            'Modified by Lydia 2023/05/11 +bolShortNo
            If PUB_ReadServicePracticeDatabase(field(), intWhere, bolShortNo) Then
               PUB_ReadCaseData = True
            Else
               ShowMsg MsgText(9110)
            End If
      End Select
   End If
End Function

'Add by Morgan 2005/3/4 從 prjTaieDll.ReadPatentDatabase 移過來
'讀取Patent專利檔
'Optional bolDate As Boolean = True 依系統別轉日期 False 不依系統別，全轉為民國日期
'Modified by Lydia 2023/05/11 +是否縮短X編號bolShortNo
Public Function PUB_ReadPatentDatabase(ByRef pa() As String, ByVal intWhere As Integer, Optional bolDate As Boolean = True, Optional ByVal bolShortNo As Boolean = True) As Boolean

   Dim i As Integer

On Error GoTo ErrHnd

   ReDim Preserve pa(TF_PA) As String
   
   strSql = "select * from patent where pa01=" + CNULL(pa(1)) + " and pa02=" + CNULL(pa(2)) + " and pa03=" + CNULL(pa(3)) + " and pa04=" + CNULL(pa(4))
   CheckOC3
   With AdoRecordSet3
      .CursorLocation = adUseClient
      .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      If .RecordCount > 0 Then
         For i = 0 To TF_PA - 1
            pa(i + 1) = "" & .Fields(i).Value
         Next
      
         If intWhere <> 國外_CF Or bolDate = False Then
            pa(10) = ChangeWStringToTString(pa(10))
            pa(12) = ChangeWStringToTString(pa(12))
            pa(14) = ChangeWStringToTString(pa(14))
            pa(20) = ChangeWStringToTString(pa(20))
            pa(21) = ChangeWStringToTString(pa(21))
            pa(24) = ChangeWStringToTString(pa(24))
            pa(25) = ChangeWStringToTString(pa(25))
            pa(58) = ChangeWStringToTString(pa(58))
            pa(140) = ChangeWStringToTString(pa(140)) 'Added by Morgan 2012/5/9
         End If
         If bolShortNo = True Then 'Added by Lydia 2023/05/11
            pa(26) = ChangeCustomerS(pa(26))
            pa(27) = ChangeCustomerS(pa(27))
            pa(28) = ChangeCustomerS(pa(28))
            pa(29) = ChangeCustomerS(pa(29))
            pa(30) = ChangeCustomerS(pa(30))
            pa(75) = ChangeCustomerS(pa(75))
            pa(76) = ChangeCustomerS(pa(76))
            pa(86) = ChangeCustomerS(pa(86))
            pa(88) = ChangeCustomerS(pa(88))
         End If 'Added by Lydia 2023/05/11
         PUB_ReadPatentDatabase = True
      Else
         ShowMsg MsgText(9141)
      End If
   End With
   
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
End Function

'Add by Morgan 2005/3/14 從 prjTaieDll.ReadServicePracticeDatabase 移過來
'讀取ServicePractice服務業務檔
'Modified by Lydia 2023/05/11 +是否縮短X編號bolShortNo
Public Function PUB_ReadServicePracticeDatabase(ByRef sp() As String, ByRef intWhere As Integer, Optional ByVal bolShortNo As Boolean = True) As Boolean

   Dim i As Integer

On Error GoTo ErrHnd

   ReDim Preserve sp(tf_SP) As String
   
   strSql = "select * from servicepractice where sp01=" + CNULL(sp(1)) + " and sp02=" + CNULL(sp(2)) + " and sp03=" + CNULL(sp(3)) + " and sp04=" + CNULL(sp(4))
   CheckOC3
   With AdoRecordSet3
      .CursorLocation = adUseClient
      .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      If .RecordCount > 0 Then
         For i = 0 To tf_SP - 1
            sp(i + 1) = "" & .Fields(i).Value
         Next
         
         If intWhere <> 國外_CF Then
            sp(10) = ChangeWStringToTString(sp(10))
            sp(12) = ChangeWStringToTString(sp(12))
            sp(16) = ChangeWStringToTString(sp(16))
            sp(20) = ChangeWStringToTString(sp(20))
            sp(21) = ChangeWStringToTString(sp(21))
            sp(39) = ChangeWStringToTString(sp(39))
            sp(40) = ChangeWStringToTString(sp(40))
         End If
         If bolShortNo = True Then 'Added by Lydia 2023/05/11
            sp(8) = ChangeCustomerS(sp(8)) '申請人1
            sp(26) = ChangeCustomerS(sp(26))
            sp(35) = ChangeCustomerS(sp(35))
            sp(37) = ChangeCustomerS(sp(37))
         'Added by Lydia 2023/05/11
            sp(58) = ChangeCustomerS(sp(58)) '申請人2
            sp(59) = ChangeCustomerS(sp(59)) '申請人3
            sp(65) = ChangeCustomerS(sp(65)) '申請人4
            sp(66) = ChangeCustomerS(sp(66)) '申請人5
         End If
         'end 2023/05/11
         PUB_ReadServicePracticeDatabase = True
      Else
         ShowMsg MsgText(9141)
      End If
   End With
   
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
End Function

'Mark by Amy 2023/02/10 秀玲說不使用Mark
''檢查新制可否使用
'Function CheckCanUse() As Boolean
'CheckCanUse = False
'If strSrvDate(1) >= "20050321" Or strUserNum = "93013" Or strUserNum = "71011" Then
'   CheckCanUse = True
'End If
'End Function

'Add by Morgan 2005/4/18 讀取會員國資料
'p_MC04 會員別:1=成員國(default),2=延伸國;p_AppDate 申請日期
Public Function PUB_GetMemberCountry(Optional ByVal p_MC04 As String = "1", Optional ByVal p_AppDate As String = "", Optional ByVal p_MC01 As String = "1") As String

On Error GoTo ErrHnd
   '若無申請日期則預設系統日
   If p_AppDate = "" Then p_AppDate = strSrvDate(1)
   strSql = "select mc03 from membercountry a" & _
      " where mc01='" & p_MC01 & "' and mc04='" & p_MC04 & "'" & _
      " and mc02=(select max(b.mc02) from membercountry b where b.mc01='" & p_MC01 & "' and b.mc02<=" & p_AppDate & " AND MC04='" & p_MC04 & "')"
   CheckOC3
   With AdoRecordSet3
      .CursorLocation = adUseClient
      .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      If .RecordCount > 0 Then
         PUB_GetMemberCountry = .GetString(, , , ",")
      End If
   End With
   
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
End Function

'add by nickc 2005/04/22 詢問是否可結餘
Public Sub Pub_EndModCashMsg(oNation As String, Optional oCP01 As String, Optional oCP02 As String, Optional oCP03 As String, Optional oCP04 As String)
Dim tRS As New ADODB.Recordset  'add by sonia 2020/3/23
   
   '2011/11/8 add by sonia TF,CFP子案不必詢問
   Select Case oCP01
      Case "TF"
         If oCP03 <> "0" Then
            bolEndModCash = False
            Exit Sub
         End If
         If oCP04 <> "00" Then
            bolEndModCash = False
            Exit Sub
         End If
      Case "CFP"
         If oCP04 <> "00" Then
            bolEndModCash = False
            Exit Sub
         End If
      Case Else
   End Select
   '2011/11/8 end
   
   If Trim(oNation) <> "000" Then
      'modify by sonia 2020/3/23 瑞婷說若有A類有收費且未發文未取消收文者不上可結餘日 T-168781
      strSql = "select cp09 from caseprogress where cp01='" & oCP01 & "' and cp02='" & oCP02 & "' and cp03='" & oCP03 & "' and cp04='" & oCP04 & "' and cp158=0 and cp159=0 and nvl(cp16,0)>0"
      Set tRS = New ADODB.Recordset
      tRS.CursorLocation = adUseClient
      tRS.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      If tRS.RecordCount > 0 Then
         bolEndModCash = False
      Else
      'end 2020/3/23
         'Modified by Lydia 2015/03/03 P案非台灣案,不問結餘
         'modify by sonia 2025/4/29 CFP案也不詢問
         If oCP01 = "P" Or oCP01 = "CFP" Then
            bolEndModCash = True
         Else
            bolEndModCash = IIf(MsgBox("此案號是否可以結餘？", vbYesNo, "上可結餘日期") = vbYes, True, False)
         End If
         'end 2015/03/03
      End If    'add by sonia 2020/3/23
   Else
      bolEndModCash = False
   End If
End Sub

'add by nickc 2005/04/22 儲存可結餘日期動作
Public Sub Pub_UpdateEndModCash(oCP01 As String, oCP02 As String, oCP03 As String, oCP04 As String)
Dim StrSQLa As String
'2011/11/10 ADD BY SONIA
Dim IsOldSystem As Boolean
Dim tRS As New ADODB.Recordset
'2011/11/10 END

   If bolEndModCash = False Then Exit Sub
   '更新可結餘日期
   'Modify by Morgan 2008/12/12 CP59 最後是放結餘單號
   'StrSQLa = "update caseprogress set cp109=to_number(to_char(sysdate,'YYYYMMDD')) " & _
                 " where cp01='" & oCP01 & "' and cp02='" & oCP02 & "' and cp03='" & oCP03 & "' and cp04='" & oCP04 & "' " & _
                 " and cp27 is not null and (cp59 is null or cp59<>'*') "
   
   '2011/11/10 ADD BY SONIA 舊案抓規費科目借貸不平衡的才要上可結餘日期, 新案一律上
   If Judgecase(oCP01, oCP02) = False Then GoTo Nextstep
   
   'add by sonia 2018/10/26 若2012年起有A類收文且有收費者也要上可結餘日期CFT-001736
   strSql = "select cp09 from caseprogress where cp01='" & oCP01 & "' and cp02='" & oCP02 & "' and cp03='" & oCP03 & "' and cp04='" & oCP04 & "' and cp05>20120101 and cp09<'B' and nvl(cp16,0)>0"
   Set tRS = New ADODB.Recordset
   tRS.CursorLocation = adUseClient
   tRS.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If tRS.RecordCount > 0 Then GoTo Nextstep
   'end 2018/10/26
   
   If oCP01 = "CFP" Then
      strSql = "select sum(ax206) ax206,sum(ax207) ax207 from " & _
               "(select a.ax202,a.ax203,substr(a.ax205,1,4) ax205,a.ax206,a.ax207 from acc021 a " & _
               "where a.ax214>='" & oCP01 & oCP02 & oCP03 & "00' and a.ax214<='" & oCP01 & oCP02 & oCP03 & "99' and substr(a.ax205,1,4)='2201' union " & _
               "select a1p04,a1p03,substr(a1p05,1,4) a1p05,a1p07,a1p08 from acc1p0,acc021 b " & _
               "where a1p17>='" & oCP01 & oCP02 & oCP03 & "00' and a1p17<='" & oCP01 & oCP02 & oCP03 & "99' and substr(a1p05,1,4)='2201' and a1p22=b.ax202(+) and a1p03=b.ax203(+) and b.ax202 is null) "
   ElseIf oCP01 = "TF" Then
      strSql = "select sum(ax206) ax206,sum(ax207) ax207 from " & _
               "(select a.ax202,a.ax203,substr(a.ax205,1,4) ax205,a.ax206,a.ax207 from acc021 a " & _
               "where a.ax214>='" & oCP01 & oCP02 & "000' and a.ax214<='" & oCP01 & oCP02 & "999' and substr(a.ax205,1,4)='2201' union " & _
               "select a1p04,a1p03,substr(a1p05,1,4) a1p05,a1p07,a1p08 from acc1p0,acc021 b " & _
               "where a1p17>='" & oCP01 & oCP02 & "000' and a1p17<='" & oCP01 & oCP02 & "999' and substr(a1p05,1,4)='2201' and a1p22=b.ax202(+) and a1p03=b.ax203(+) and b.ax202 is null) "
   Else
      strSql = "select sum(ax206) ax206,sum(ax207) ax207 from " & _
               "(select a.ax202,a.ax203,substr(a.ax205,1,4) ax205,a.ax206,a.ax207 from acc021 a " & _
               "where a.ax214='" & oCP01 & oCP02 & oCP03 & oCP04 & "' and substr(a.ax205,1,4)='2201' union " & _
               "select a1p04,a1p03,substr(a1p05,1,4) a1p05,a1p07,a1p08 from acc1p0,acc021 b " & _
               "where a1p17='" & oCP01 & oCP02 & oCP03 & oCP04 & "' and substr(a1p05,1,4)='2201' and a1p22=b.ax202(+) and a1p03=b.ax203(+) and b.ax202 is null) "
   End If
   Set tRS = New ADODB.Recordset
   tRS.CursorLocation = adUseClient
   tRS.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If tRS.RecordCount = 0 Then Exit Sub
   If Val("" & tRS.Fields(0)) = Val("" & tRS.Fields(1)) Then Exit Sub    '借貸平衡
   '2011/11/10 END
   
Nextstep:
   Select Case oCP01    '2010/3/30 ADD BY SONIA 加區分系統類別
      Case "TF"    '母子案一起更新,領土延伸不可一起更新
         StrSQLa = "update caseprogress set cp109=to_number(to_char(sysdate,'YYYYMMDD')) " & _
                   " where cp01='" & oCP01 & "' and cp02='" & oCP02 & "' " & _
                   " and cp27 is not null and cp59 is null "
      Case "CFP"   '僅EPC母子案一起更新,接續案或集體設計個別更新
         'Added by Morgan 2012/4/25
         '集體設計也改為母子案一起更新
         If oCP03 = "0" Then
            StrSQLa = "update caseprogress a set cp109=to_number(to_char(sysdate,'YYYYMMDD')) " & _
                   " where cp01='" & oCP01 & "' and cp02='" & oCP02 & "' and cp03<>'0' and cp04='" & oCP04 & "'" & _
                   " and cp27 is not null and cp59 is null " & _
                   " and exists(select * from caseprogress b where b.cp01=a.cp01 and b.cp02=a.cp02 and b.cp03=a.cp03 and b.cp04=a.cp04 and b.cp10='105' and b.cp27>0 and b.cp57 is null)"
            cnnConnection.Execute StrSQLa
         End If
         'end 2012/4/25
         StrSQLa = "update caseprogress set cp109=to_number(to_char(sysdate,'YYYYMMDD')) " & _
                   " where cp01='" & oCP01 & "' and cp02='" & oCP02 & "' and cp03='" & oCP03 & "' " & _
                   " and cp27 is not null and cp59 is null "
      Case Else
         '2012/7/31 ADD BY SONIA 將CP146清除
         If oCP01 = "T" Then
            StrSQLa = "update caseprogress set cp146=null " & _
                      " where cp01='" & oCP01 & "' and cp02='" & oCP02 & "' and cp03='" & oCP03 & "' and cp04='" & oCP04 & "' " & _
                      " and cp146 is not null"
            cnnConnection.Execute StrSQLa
         End If
         '2012/7/31 END
         StrSQLa = "update caseprogress set cp109=to_number(to_char(sysdate,'YYYYMMDD')) " & _
                   " where cp01='" & oCP01 & "' and cp02='" & oCP02 & "' and cp03='" & oCP03 & "' and cp04='" & oCP04 & "' " & _
                   " and cp27 is not null and cp59 is null "
   End Select
   cnnConnection.Execute StrSQLa
   bolEndModCash = False 'Add by Morgan 2005/5/20
End Sub

'Add by Morgan 2005/4/29 檢查一件國內案不可關聯兩件相同國家之國外案
Public Function PUB_CheckDaulCaseMap(ByRef p_OutCaseNo As String, ByRef p_InCaseNo As String, Optional ByRef p_OtherCaseNo As String, Optional ByVal p_bolMsg As Boolean = True) As Boolean

   Dim strCaseNoOut(1 To 4) As String
   Dim strCaseNoIn(1 To 4) As String
   
   ChgCaseNo p_OutCaseNo, strCaseNoOut
   ChgCaseNo p_InCaseNo, strCaseNoIn
   
On Error GoTo ErrHnd
   
   strSql = "SELECT PA01||'-'||PA02||'-'||PA03||'-'||PA04 FROM CASEMAP,PATENT A" & _
      " WHERE CM10='0' AND CM05='" & strCaseNoIn(1) & "' AND CM06='" & strCaseNoIn(2) & "' AND CM07='" & strCaseNoIn(3) & "' AND CM08='" & strCaseNoIn(4) & "'" & _
      " AND NOT( CM01='" & strCaseNoOut(1) & "' AND CM02='" & strCaseNoOut(2) & "' AND CM03='" & strCaseNoOut(3) & "' AND CM04='" & strCaseNoOut(4) & "')" & _
      " AND PA01=CM01 AND PA02=CM02 AND PA03=CM03 AND PA04=CM04 AND PA57 IS NULL"

   'Modify by Morgan 2005/5/12 專利種類不同可
   'strSQL = strSQL & " AND EXISTS ( SELECT * FROM PATENT B WHERE  B.PA01='" & strCaseNoOut(1) & "' AND B.PA02='" & strCaseNoOut(2) & "' AND B.PA03='" & strCaseNoOut(3) & "' AND B.PA04='" & strCaseNoOut(4) & "' AND B.PA09=A.PA09 )"
   strSql = strSql & " AND EXISTS ( SELECT * FROM PATENT B WHERE  B.PA01='" & strCaseNoOut(1) & "' AND B.PA02='" & strCaseNoOut(2) & "' AND B.PA03='" & strCaseNoOut(3) & "' AND B.PA04='" & strCaseNoOut(4) & "' AND B.PA09=A.PA09 AND B.PA08=A.PA08 )"
   
   CheckOC3
   With AdoRecordSet3
      .CursorLocation = adUseClient
      .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      If .RecordCount > 0 Then
         PUB_CheckDaulCaseMap = True
         p_OtherCaseNo = "" & .Fields(0)
         If p_bolMsg = True Then
            'Modify by Morgan 2006/6/27 改確認並可繼續
            'MsgBox "國內案 " & strCaseNoIn(1) & "-" & strCaseNoIn(2) & "-" & strCaseNoIn(3) & "-" & strCaseNoIn(4) & " 已與國外案 " & p_OtherCaseNo & " 關聯，請確認！", vbExclamation, "一件國內案不可關聯兩件相同國家之國外案"
            If MsgBox("國內案 " & strCaseNoIn(1) & "-" & strCaseNoIn(2) & "-" & strCaseNoIn(3) & "-" & strCaseNoIn(4) & " 已與國外案 " & p_OtherCaseNo & " 關聯，是否要繼續？", vbYesNo + vbDefaultButton2, "一件國內案關聯兩件相同國家之國外案") = vbYes Then
               PUB_CheckDaulCaseMap = False
            End If
         End If
      End If
   End With
   
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
End Function

'add by nickc 2005/04/29
Public Function GetSystemKindByNickTformSP() As String
Dim StrTempGroup As String, i As Integer, strTemp As String
Dim StrTempKind As String, strTemp1 As Variant
bolFNation = False
CheckOC3
strSql = "SELECT ST11,ST03 FROM STAFF WHERE ST01='" & strUserNum & "'"
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
     If Not IsNull(AdoRecordSet3.Fields(0)) Then
         StrTempGroup = AdoRecordSet3.Fields(0)
         'Modified by Lydia 2021/12/15 統一判斷S部門及P11部門人員bolFNation = False => +Or AdoRecordSet3.Fields(1) = "P11"
         If UCase(Left(StrTempGroup, 1)) = "S" Or AdoRecordSet3.Fields(1) = "P11" Then
            bolFNation = False
         Else
            bolFNation = True
         End If
         '2009/11/13 ADD BY SONIA 開放94007林景郁可查國外代理人資料
         Select Case strUserNum
            Case "94007"
               bolFNation = True
         End Select
         '2009/11/13 END
     Else
         StrTempGroup = ""
         GetSystemKindByNickTformSP = ""
         Exit Function
     End If
End If
CheckOC3
GetSystemKindByNickTformSP = ""
strTemp = ""


strSql = "select sk01 from systemkind where sk02=6  and substr(sk01,1,1)='T' AND SK01 IN (SELECT SG02 FROM STAFF_GROUP WHERE SG01='" & StrTempGroup & "')"
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount > 0 Then
   GetSystemKindByNickTformSP = AdoRecordSet3.GetString(adClipString, , , ",")
End If
CheckOC3
If GetSystemKindByNickTformSP <> "" Then GetSystemKindByNickTformSP = Left(GetSystemKindByNickTformSP, Len(GetSystemKindByNickTformSP) - 1)


End Function

'add by nickc 2005/05/05 浮動準備金
'edit by nickc 2007/11/16 改成結餘單時控制
'Public Function GetFloatPrepareCase(oCP01 As String, oCP02 As String, oCP03 As String, oCP04 As String) As Integer
Public Function GetFloatPrepareCase(oCP01 As String, oCP02 As String, oCP03 As String, oCP04 As String, Optional CanZero As Boolean = False) As Integer
Dim rs8 As New ADODB.Recordset
Dim StrSQLa As String
'add by nickc 2005/05/16
Dim StrSqlB As String
Dim m_A240001 As String   '2009/6/1 add by sonia
   
   GetFloatPrepareCase = 0
   
   '2009/6/1 add by sonia CFP浮動準備金自2009/6/1起改為3000元,之前已結餘案件仍維持原浮動準備金
   m_A240001 = ""
   StrSQLa = "select A240001 from caseprogress,acc240 where cp01='" & oCP01 & "' and cp02='" & oCP02 & "' and cp03='" & IIf(Trim(oCP03) = "", "0", oCP03) & "' and cp04='" & IIf(Trim(oCP04) = "", "00", oCP04) & "' and cp59 is not null and cp59=a240002(+) and rownum<2 "
   Set rs8 = New ADODB.Recordset
   rs8.CursorLocation = adUseClient
   rs8.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
   If rs8.RecordCount <> 0 Then
      m_A240001 = "" & rs8.Fields("A240001")
   End If
   '2009/6/1 END
   
   Select Case oCP01
      Case "TS", "S", "TT"  '就是 0 不用在指定  2007/8/10 modify by sonia 加入 TT,TT-000068
               Exit Function
      Case "P"
         StrSQLa = "select * from patent where pa01='" & oCP01 & "' and pa02='" & oCP02 & "' and pa03='" & IIf(Trim(oCP03) = "", "0", oCP03) & "' and pa04='" & IIf(Trim(oCP04) = "", "00", oCP04) & "' "
         Set rs8 = New ADODB.Recordset
         rs8.CursorLocation = adUseClient
         rs8.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
         If rs8.RecordCount <> 0 Then
            If CheckStr(rs8.Fields("pa09")) = "020" Then
               GetFloatPrepareCase = 2000
            '2009/12/16 add by sonia 專利非台灣(香港,澳門,PCT)案,自2009/12/16起改為2000元,之前已結餘案件仍維持原浮動準備金
            ElseIf CheckStr(rs8.Fields("pa09")) <> "000" And (m_A240001 = "" Or Val(m_A240001) >= 981216) Then
               GetFloatPrepareCase = 2000
            '2009/12/16 end
            Else
               GetFloatPrepareCase = 3000
            End If
         End If
         'add by sonia 2019/7/10 P案中間接進來之領證或年費案件不提列安全基金,不溯及既往
'modify by sonia 2023/6/13 改為第一道有收費進度或是有帳單的進度是領證或年費的才不列P-131380，但免費辦案件則不行P-116470
'         StrSQLa = "select * from caseprogress where cp01='" & oCP01 & "' and cp02='" & oCP02 & "' and cp03='" & IIf(Trim(oCP03) = "", "0", oCP03) & "' and cp04='" & IIf(Trim(oCP04) = "", "00", oCP04) & "' and cp05>=20190710 and cp31='Y' and cp10 in ('601','605','606')"
'         Set rs8 = New ADODB.Recordset
'         rs8.CursorLocation = adUseClient
'         rs8.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
'         If rs8.RecordCount <> 0 Then
'            GetFloatPrepareCase = 0
'         End If
         StrSQLa = "select caseprogress.* from (select min(cp05||cp66||to_char(cp67,'0000')||cp09) min from caseprogress where cp01='" & oCP01 & "' and cp02='" & oCP02 & "' and cp03='" & IIf(Trim(oCP03) = "", "0", oCP03) & "' and cp04='" & IIf(Trim(oCP04) = "", "00", oCP04) & "' " & _
                   "and (nvl(cp16,0)>0 or cp61 is not null)),caseprogress where substr(min,-9)=cp09(+)"
         Set rs8 = New ADODB.Recordset
         rs8.CursorLocation = adUseClient
         rs8.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
         If rs8.RecordCount <> 0 Then
            If Val("" & rs8.Fields("cp05")) > 0 Then 'add by sonia 2023/7/26 P-054609都沒有收費時會出現型態不符
               If CheckStr(rs8.Fields("cp05")) >= 20190710 And (CheckStr(rs8.Fields("cp10")) = "601" Or CheckStr(rs8.Fields("cp10")) = "605" Or CheckStr(rs8.Fields("cp10")) = "606") Then
                  GetFloatPrepareCase = 0
               End If
            End If                                   'add by sonia 2023/7/26
         End If
'end 2023/6/13
         'end 2019/7/10
         'add by nickc 2005/05/16
         StrSqlB = " cp01='" & oCP01 & "' and cp02='" & oCP02 & "' and cp03='" & oCP03 & "' and cp04='" & oCP04 & "' and cp59 is not null "
      Case "CPS"
         StrSQLa = "select * from caseprogress,staff  where cp01='" & oCP01 & "' and cp02='" & oCP02 & "' and cp03='" & IIf(Trim(oCP03) = "", "0", oCP03) & "' and cp04='" & IIf(Trim(oCP04) = "", "00", oCP04) & "' and cp14=st01(+) and cp10 in ('903','904') and st03='P12' "
         Set rs8 = New ADODB.Recordset
         rs8.CursorLocation = adUseClient
         rs8.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
         If rs8.RecordCount <> 0 Then
               GetFloatPrepareCase = 0
               Exit Function
         End If
         StrSQLa = "select * from servicepractice  where sp01='" & oCP01 & "' and sp02='" & oCP02 & "' and sp03='" & IIf(Trim(oCP03) = "", "0", oCP03) & "' and sp04='" & IIf(Trim(oCP04) = "", "00", oCP04) & "' "
         Set rs8 = New ADODB.Recordset
         rs8.CursorLocation = adUseClient
         rs8.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
         If rs8.RecordCount <> 0 Then
            If CheckStr(rs8.Fields("sp09")) = "101" Or CheckStr(rs8.Fields("sp09")) = "011" Or CheckStr(rs8.Fields("sp09")) = "231" Then
               GetFloatPrepareCase = 3000
            Else
                'edit by nickc 2006/05/02
                If CheckStr(rs8.Fields("sp09")) = "020" Then
                    GetFloatPrepareCase = 2000
                Else
                    '2009/6/1 modify by sonia CFP浮動準備金自2009/6/1起改為3000元,之前已結餘案件仍維持原浮動準備金
                    'GetFloatPrepareCase = 5000
                    If m_A240001 = "" Or Val(m_A240001) >= 980601 Then
                       GetFloatPrepareCase = 3000
                    Else
                       GetFloatPrepareCase = 5000
                    End If
                    '2009/6/1 end
                End If
            End If
         End If
         'add by nickc 2005/05/16
         StrSqlB = " cp01='" & oCP01 & "' and cp02='" & oCP02 & "' and cp03='" & oCP03 & "'  and cp59 is not null "
      Case "T"
         StrSQLa = "select * from trademark where tm01='" & oCP01 & "' and tm02='" & oCP02 & "' and tm03='" & IIf(Trim(oCP03) = "", "0", oCP03) & "' and tm04='" & IIf(Trim(oCP04) = "", "00", oCP04) & "' "
         Set rs8 = New ADODB.Recordset
         rs8.CursorLocation = adUseClient
         rs8.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
         If rs8.RecordCount <> 0 Then
            If CheckStr(rs8.Fields("tm10")) = "020" Then
               '2010/1/26 modify by sonia CMT浮動準備金自2010/2/1起改為1000元,之前已結餘案件仍維持原浮動準備金
               'GetFloatPrepareCase = 2000
               If m_A240001 = "" Or Val(m_A240001) >= 990201 Then
                  GetFloatPrepareCase = 1000
               Else
                  GetFloatPrepareCase = 2000
               End If
               '2010/1/26 end
            Else
               GetFloatPrepareCase = 3000
            End If
         End If
         'add by nickc 2005/05/16
         StrSqlB = " cp01='" & oCP01 & "' and cp02='" & oCP02 & "' and cp03='" & oCP03 & "' and cp04='" & oCP04 & "' and cp59 is not null "
      Case "CFP"
         'modify by sonia 2021/11/23 +caserelation1 簡協理說只要有歐盟關聯案者都不扣，即使是同日收文CFT-022614(CFT-022615)
         'StrSQLa = "select * from patent where pa01='" & oCP01 & "' and pa02='" & oCP02 & "' and pa03='" & IIf(Trim(oCP03) = "", "0", oCP03) & "' and pa04='" & IIf(Trim(oCP04) = "", "00", oCP04) & "'"
         StrSQLa = "select a.pa09 apa09,a.pa22 apa22,a.pa23 apa23,b.pa02 bpa02 from patent a,patent b,caserelation1 where a.pa01='" & oCP01 & "' and a.pa02='" & oCP02 & "' and a.pa03='" & IIf(Trim(oCP03) = "", "0", oCP03) & "' and a.pa04='" & IIf(Trim(oCP04) = "", "00", oCP04) & "' " & _
                   "and a.Pa01=Cr01(+) And a.Pa02=Cr02(+) And a.Pa03=Cr03(+) And a.Pa04=Cr04(+) and cr05=b.pa01(+) and cr06=b.pa02(+) and cr07=b.pa03(+) and cr08=b.pa04(+) and '239'=b.pa09(+) "
         'end 2021/11/23
         Set rs8 = New ADODB.Recordset
         rs8.CursorLocation = adUseClient
         rs8.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
         If rs8.RecordCount <> 0 Then
            If CheckStr(rs8.Fields("apa09")) = "101" Or CheckStr(rs8.Fields("apa09")) = "011" Or CheckStr(rs8.Fields("apa09")) = "231" Then
               GetFloatPrepareCase = 3000
            Else
                If CheckStr(rs8.Fields("apa09")) = "020" Then
                    GetFloatPrepareCase = 2000
                'add by sonia 2021/11/23 脫歐英國案不必扣浮動準備金
                ElseIf CheckStr(rs8.Fields("apa09")) = "201" And CheckStr(rs8.Fields("apa23")) = "1" And Left(CheckStr(rs8.Fields("apa22")), 1) = "9" And CheckStr(rs8.Fields("bpa02")) <> "" Then
                    GetFloatPrepareCase = 0
                'end 2021/11/23
                Else
                    '2009/6/1 modify by sonia CFP浮動準備金自2009/6/1起改為3000元,之前已結餘案件仍維持原浮動準備金
                    'GetFloatPrepareCase = 5000
                    If m_A240001 = "" Or Val(m_A240001) >= 980601 Then
                       GetFloatPrepareCase = 3000
                    Else
                       GetFloatPrepareCase = 5000
                    End If
                    '2009/6/1 end
                End If
            End If
         End If
         'add by nickc 2005/05/16
         StrSqlB = " cp01='" & oCP01 & "' and cp02='" & oCP02 & "' and cp03='" & oCP03 & "'  and cp59 is not null "
      '2006/3/3 ADD BY SONIA
      Case "TC"
         StrSQLa = "select * from SERVICEPRACTICE where SP01='" & oCP01 & "' and SP02='" & oCP02 & "' and SP03='" & IIf(Trim(oCP03) = "", "0", oCP03) & "' and SP04='" & IIf(Trim(oCP04) = "", "00", oCP04) & "' "
         Set rs8 = New ADODB.Recordset
         rs8.CursorLocation = adUseClient
         rs8.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
         If rs8.RecordCount <> 0 Then
            If CheckStr(rs8.Fields("SP09")) = "020" Then
               '2015/4/27 modify by sonia 婧瑄說大陸案同商標改為1000元,TC-010730
               'GetFloatPrepareCase = 2000
               If m_A240001 = "" Or Val(m_A240001) >= 1040427 Then
                  GetFloatPrepareCase = 1000
               Else
                  GetFloatPrepareCase = 2000
               End If
               'end 2015/4/27
            Else
               GetFloatPrepareCase = 3000
            End If
         End If
         StrSqlB = " cp01='" & oCP01 & "' and cp02='" & oCP02 & "' and cp03='" & oCP03 & "'  and cp59 is not null "
      '2006/3/3 END
      'add by nickc 2006/05/02 先檢查有無 A 類 101 有代表不是中間接進來，所以不能有浮動金
      'edit by nickc 2006/06/12 改成 有 A 101 ==>3000，若沒有檢查有無 A 102 有 2000，若都沒有 0 婧瑄
      'edit by nickc 2006/07/10 改成 有 A 101,107,308,601,603,605 ==>3000，若都沒有 2000 婧瑄
      Case "CFT"
         'edit by nickc 2006/07/10
         'StrSQLa = "select * from caseprogress  where cp01='" & oCP01 & "' and cp02='" & oCP02 & "' and cp03='" & IIf(Trim(oCP03) = "", "0", oCP03) & "' and cp04='" & IIf(Trim(oCP04) = "", "00", oCP04) & "' and cp10='101' and substr(cp09,1,1)='A' "
         'modify by sonia 2021/11/23 +caserelation1 簡協理說只要有歐盟關聯案者都不扣，即使是同日收文CFT-022614(CFT-022615)
         'StrSQLa = "select * from caseprogress where cp01='" & oCP01 & "' and cp02='" & oCP02 & "' and cp03='" & IIf(Trim(oCP03) = "", "0", oCP03) & "' and cp04='" & IIf(Trim(oCP04) = "", "00", oCP04) & "' and cp10 in ('101','107','308','601','603','605') and substr(cp09,1,1)='A' "
         StrSQLa = "select a.tm10 atm10,a.tm12 atm12,a.tm15 atm15,a.tm28 atm28,b.tm02 btm02 from caseprogress,trademark a,trademark b,caserelation1 where cp01='" & oCP01 & "' and cp02='" & oCP02 & "' and cp03='" & IIf(Trim(oCP03) = "", "0", oCP03) & "' and cp04='" & IIf(Trim(oCP04) = "", "00", oCP04) & "' and cp10 in ('101','107','308','601','603','605') and substr(cp09,1,1)='A' " & _
                   "and cp01=a.tm01(+) and cp02=a.tm02(+) and cp03=a.tm03(+) and cp04=a.tm04(+) and a.tm01=Cr01(+) And a.tm02=Cr02(+) And a.tm03=Cr03(+) And a.tm04=Cr04(+) and cr05=b.tm01(+) and cr06=b.tm02(+) and cr07=b.tm03(+) and cr08=b.tm04(+) and '239'=b.tm10(+) "
         'end 2021/11/23
         Set rs8 = New ADODB.Recordset
         rs8.CursorLocation = adUseClient
         rs8.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
         If rs8.RecordCount <> 0 Then
            'edit by nickc
            GetFloatPrepareCase = 3000
            'add by sonia 2021/11/23 脫歐英國案不必扣浮動準備金
            If CheckStr(rs8.Fields("atm10")) = "201" And CheckStr(rs8.Fields("aTM28")) = "1" And (Left(CheckStr(rs8.Fields("aTM12")), 5) = "UK009" Or Left(CheckStr(rs8.Fields("aTM15")), 5) = "UK009") And CheckStr(rs8.Fields("btm02")) <> "" Then
                GetFloatPrepareCase = 0
            End If
            'end 2021/11/23
         Else
'edit by nickc 2006/07/10
'            StrSQLa = "select * from caseprogress  where cp01='" & oCP01 & "' and cp02='" & oCP02 & "' and cp03='" & IIf(Trim(oCP03) = "", "0", oCP03) & "' and cp04='" & IIf(Trim(oCP04) = "", "00", oCP04) & "' and cp10='102' and substr(cp09,1,1)='A' "
'            Set rs8 = New ADODB.Recordset
'            rs8.CursorLocation = adUseClient
'            rs8.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
'            If rs8.RecordCount <> 0 Then
                GetFloatPrepareCase = 2000
'            Else
'            '102 A  = 2000
'               GetFloatPrepareCase = 0
'               Exit Function
'            End If
            'add by sonia 2021/11/23 簡協理說只要有歐盟關聯案者都不扣，即使是同日收文CFT-022614(CFT-022615)
            StrSQLa = "select a.tm10 atm10,a.tm12 atm12,a.tm15 atm15,a.tm28 atm28,b.tm02 btm02 from trademark a,trademark b,caserelation1 where a.tm01='" & oCP01 & "' and a.tm02='" & oCP02 & "' and a.tm03='" & IIf(Trim(oCP03) = "", "0", oCP03) & "' and a.tm04='" & IIf(Trim(oCP04) = "", "00", oCP04) & "' " & _
                      "and a.tm01=Cr01(+) And a.tm02=Cr02(+) And a.tm03=Cr03(+) And a.tm04=Cr04(+) and cr05=b.tm01(+) and cr06=b.tm02(+) and cr07=b.tm03(+) and cr08=b.tm04(+) and '239'=b.tm10(+) "
            Set rs8 = New ADODB.Recordset
            rs8.CursorLocation = adUseClient
            rs8.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
            If rs8.RecordCount <> 0 Then
               If CheckStr(rs8.Fields("atm10")) = "201" And CheckStr(rs8.Fields("atm28")) = "1" And (Left(CheckStr(rs8.Fields("atm12")), 5) = "UK009" Or Left(CheckStr(rs8.Fields("atm15")), 5) = "UK009") And CheckStr(rs8.Fields("btm02")) <> "" Then
                   GetFloatPrepareCase = 0
               End If
            End If
            'end 2021/11/23
         End If
'edit by nickc 2006/07/10
'         StrSQLa = "select * from trademark where tm01='" & oCP01 & "' and tm02='" & oCP02 & "' and tm03='" & IIf(Trim(oCP03) = "", "0", oCP03) & "' and tm04='" & IIf(Trim(oCP04) = "", "00", oCP04) & "' "
'         Set rs8 = New ADODB.Recordset
'         rs8.CursorLocation = adUseClient
'         rs8.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
'         If rs8.RecordCount <> 0 Then
'            If CheckStr(rs8.Fields("tm10")) = "020" Then
'               GetFloatPrepareCase = 2000
'            Else
'               GetFloatPrepareCase = 3000
'            End If
'         End If
         'add by nickc 2005/05/16
         StrSqlB = " cp01='" & oCP01 & "' and cp02='" & oCP02 & "' and cp03='" & oCP03 & "' and cp04='" & oCP04 & "' and cp59 is not null "
      Case Else
         'add by nickc 2006/05/02 其餘的 只要是國家大陸都是 2000
         StrSQLa = "select tm10 from trademark where tm01='" & oCP01 & "' and tm02='" & oCP02 & "' and tm03='" & IIf(Trim(oCP03) = "", "0", oCP03) & "' and tm04='" & IIf(Trim(oCP04) = "", "00", oCP04) & "' "
         StrSQLa = StrSQLa & " union select sp09 from SERVICEPRACTICE where SP01='" & oCP01 & "' and SP02='" & oCP02 & "' and SP03='" & IIf(Trim(oCP03) = "", "0", oCP03) & "' and SP04='" & IIf(Trim(oCP04) = "", "00", oCP04) & "' "
         'CANCEL BY SONIA 2017/9/27 專利案P,CFP上述已單獨判斷
         'StrSQLa = StrSQLa & " union select pa09 from patent where pa01='" & oCP01 & "' and pa02='" & oCP02 & "' and pa03='" & IIf(Trim(oCP03) = "", "0", oCP03) & "' and pa04='" & IIf(Trim(oCP04) = "", "00", oCP04) & "' "
         Set rs8 = New ADODB.Recordset
         rs8.CursorLocation = adUseClient
         rs8.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
         If rs8.RecordCount <> 0 Then
            If CheckStr(rs8.Fields("tm10")) = "020" Then
                GetFloatPrepareCase = 2000
            '2009/12/16 add by sonia 專利非台灣(香港,澳門,PCT)案,自2009/12/16起改為2000元,之前已結餘案件仍維持原浮動準備金
            ElseIf oCP01 = "PS" And CheckStr(rs8.Fields("tm10")) <> "000" And (m_A240001 = "" Or Val(m_A240001) >= 981216) Then
               GetFloatPrepareCase = 2000
            '2009/12/16 end
            Else
                GetFloatPrepareCase = 3000
            End If
         Else
            GetFloatPrepareCase = 3000
         End If
         If oCP01 = "TF" Then
               'add by nickc 2005/05/16
               StrSqlB = " cp01='" & oCP01 & "' and cp02='" & oCP02 & "' and cp59 is not null "
         Else
               'add by nickc 2005/05/16
               StrSqlB = " cp01='" & oCP01 & "' and cp02='" & oCP02 & "' and cp03='" & oCP03 & "' and cp04='" & oCP04 & "' and cp59 is not null  "
         End If
   End Select
   'add by nickc 2007/11/16
   If CanZero Then
      StrSQLa = "select * from caseprogress where " & StrSqlB
      Set rs8 = New ADODB.Recordset
      rs8.CursorLocation = adUseClient
      rs8.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
      If rs8.RecordCount <> 0 Then
         GetFloatPrepareCase = 0
      End If
      Set rs8 = Nothing
   End If
End Function

'Add by Morgan 2005/5/13
'檢查是否可減免退費且未收文
'p_PA()=本所號 p_bolMsg=顯示對話框 p_iDiscount=可退費金額 p_iYear1=退費起始年度 p_iYear2=退費終止年度
Public Function PUB_CheckYearFeeReturn(p_PA() As String, Optional p_bolMsg As Boolean = True, Optional p_iDiscount As Integer, Optional p_iYear1 As Integer, Optional p_iYear2 As Integer) As Boolean
   
   Dim stPA14 As String, stPA73 As String, stCP27 As String, iPos As Integer
   Dim iFeeTimes As Integer '93.7.1以前已繳年費次數
   Dim iTimes As Integer '應繳次數
   
   PUB_CheckYearFeeReturn = False
   
On Error GoTo ErrHnd
   '台灣，93.7.1以前公告，未收文減免退費
   strSql = "SELECT PA14,PA73,CP27 FROM PATENT,( SELECT CP01 ,CP02 ,CP03 ,CP04 ,MIN(CP27) CP27 FROM CASEPROGRESS" & _
      " WHERE CP01='" & p_PA(1) & "' AND CP02='" & p_PA(2) & "' AND CP03='" & p_PA(3) & "' AND CP04='" & p_PA(4) & "'" & _
      " AND CP10 in ('601','605') AND CP27>20040700 AND CP57 IS NULL GROUP BY CP01,CP02,CP03,CP04) X" & _
      " Where  PA01='" & p_PA(1) & "' AND PA02='" & p_PA(2) & "' AND PA03='" & p_PA(3) & "' AND PA04='" & p_PA(4) & "'" & _
      " and pa09='000' and pa73 is not null and pa14<20040700 AND CP02(+)=PA02 AND CP03(+)=PA03 AND CP04(+)=PA04 " & _
      " and not exists(select * from caseprogress WHERE CP01=PA01 AND CP02=PA02 AND CP03=PA03 AND CP04=PA04 AND CP10='919' AND CP57 IS NULL)" & _
      " and exists(select * from caseprogress WHERE CP01=PA01 AND CP02=PA02 AND CP03=PA03 AND CP04=PA04 AND CP10 in ('601','605') AND CP27>=20020101 and cp27<20040701)"
   
   CheckOC3
   With AdoRecordSet3
      .CursorLocation = adUseClient
      .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      If .RecordCount > 0 Then
         stPA14 = "" & .Fields("PA14")
         stPA73 = "" & .Fields("PA73")
         stCP27 = "" & .Fields("CP27")
         iFeeTimes = 0
         If stCP27 <> "" Then
            iPos = InStr(stPA73, stCP27)
            If iPos > 0 Then
               stPA73 = Left(stPA73, iPos - 1)
            End If
         Else
            '若無發文日時要多加一年
            iFeeTimes = iFeeTimes + 1
         End If
         iPos = InStr(stPA73, ",")
         Do While iPos > 0
            iFeeTimes = iFeeTimes + 1
            iPos = InStr(iPos + 1, stPA73, ",")
         Loop
         'Modify by Morgan 2005/6/17 若公告日為7/1則93預繳年費不可減免(郭說以繳費期限判斷是否適用)
         'iTimes = (20050700 - Val(stPA14)) \ 10000
         iTimes = (20050701 - Val(stPA14)) \ 10000
         '有預繳第6年以前年費
         If iFeeTimes > iTimes And iTimes < 6 Then
            '算退費金額
            p_iDiscount = 0
            '起始年
            p_iYear1 = iTimes + 1
            Do While (iFeeTimes > iTimes)
               iTimes = iTimes + 1
               If iTimes > 6 Then
                  Exit Do
               Else
                  p_iYear2 = iTimes
                  If iTimes < 4 Then
                     p_iDiscount = p_iDiscount + 800
                  Else
                     p_iDiscount = p_iDiscount + 1200
                  End If
               End If
            Loop
            PUB_CheckYearFeeReturn = True
            If p_bolMsg = True Then
               MsgBox "本案應可辦理減免退費但尚未收文，請確認！" & vbCrLf & "( 應可退第" & p_iYear1 & IIf(p_iYear2 > p_iYear1, "-" & p_iYear2, "") & "年減免金額共" & Format(p_iDiscount, "###,##0") & "元)", vbExclamation
            End If
         End If
      End If
   End With
   
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
   
End Function

Function ChkDataBy308(oKey As String) As Boolean
Dim strSQL1 As String, strSQL2 As String, StrSQL3 As String, StrSQL4 As String, strSQL5 As String
Dim strTemp As String
Dim strTM27 As String '正商標號數
Dim strTM12 As String '申請案號
Dim Strsql20040730 As String
Dim StrSQLa As String
Dim T940606RS As New ADODB.Recordset
'畫面上方改成輸入畫面的條件

'add by nick 2004/07/30 加入檢查是母案或分割案
Dim IsMother As Boolean
Dim s As Integer
        StrSQLa = "select AA.A,AA.B,BB.A,BB.B from ("
        StrSQLa = StrSQLa & "select '1' A,count(*) B from divisioncase where dc01='" & SystemNumber(oKey, 1) & "' and dc02='" & SystemNumber(oKey, 2) & "' and dc03='" & SystemNumber(oKey, 3) & "' and dc04='" & SystemNumber(oKey, 4) & "' ) AA,"
        StrSQLa = StrSQLa & " (select '2' A,count(*) B from divisioncase where dc05='" & SystemNumber(oKey, 1) & "' and dc06='" & SystemNumber(oKey, 2) & "' and dc07='" & SystemNumber(oKey, 3) & "' and dc08='" & SystemNumber(oKey, 4) & "') BB "
        Set T940606RS = New ADODB.Recordset
        
        T940606RS.CursorLocation = adUseClient
        T940606RS.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
        If T940606RS.RecordCount <> 0 And T940606RS.RecordCount > 0 Then
            If Val(CheckStr(T940606RS.Fields(1).Value)) = 0 And Val(CheckStr(T940606RS.Fields(3).Value)) = 0 Then
                ChkDataBy308 = False
                Exit Function
            End If
            If Val(CheckStr(T940606RS.Fields(1).Value)) > 0 Then
                IsMother = False
            Else
                If Val(CheckStr(T940606RS.Fields(3).Value)) > 0 Then
                    IsMother = True
                Else
                    ChkDataBy308 = False
                    Set T940606RS = Nothing
                    Exit Function
                End If
            End If
        End If
        If IsMother = True Then
            strSQL1 = " and dc05='" & SystemNumber(oKey, 1) & "' and dc06='" & SystemNumber(oKey, 2) & "' and dc07='" & SystemNumber(oKey, 3) & "' and dc08='" & SystemNumber(oKey, 4) & "' "
            strSQL2 = " and dc05='" & SystemNumber(oKey, 1) & "' and dc06='" & SystemNumber(oKey, 2) & "' and dc07='" & SystemNumber(oKey, 3) & "' and dc08='" & SystemNumber(oKey, 4) & "' "
            StrSQL3 = " and dc05='" & SystemNumber(oKey, 1) & "' and dc06='" & SystemNumber(oKey, 2) & "' and dc07='" & SystemNumber(oKey, 3) & "' and dc08='" & SystemNumber(oKey, 4) & "' "
            StrSQL4 = " and dc05='" & SystemNumber(oKey, 1) & "' and dc06='" & SystemNumber(oKey, 2) & "' and dc07='" & SystemNumber(oKey, 3) & "' and dc08='" & SystemNumber(oKey, 4) & "' "
            strSQL5 = " and dc05='" & SystemNumber(oKey, 1) & "' and dc06='" & SystemNumber(oKey, 2) & "' and dc07='" & SystemNumber(oKey, 3) & "' and dc08='" & SystemNumber(oKey, 4) & "' "
            strSQL1 = strSQL1 & " and T1.PA01 in (" & SQLGrpStr(SystemNumber(oKey, 1), 1) & ") "
            strSQL2 = strSQL2 & " and T1.TM01 in (" & SQLGrpStr(SystemNumber(oKey, 1), 2) & ") "
            StrSQL3 = StrSQL3 & " and T1.LC01 in (" & SQLGrpStr(SystemNumber(oKey, 1), 3) & ") "
            StrSQL4 = StrSQL4 & " and T1.HC01 in (" & SQLGrpStr(SystemNumber(oKey, 1), 4) & ") "
            strSQL5 = strSQL5 & " and T1.SP01 in (" & SQLGrpStr(SystemNumber(oKey, 1), 5) & ") "
        Else
            strSQL1 = " and dc01='" & SystemNumber(oKey, 1) & "' and dc02='" & SystemNumber(oKey, 2) & "' and dc03='" & SystemNumber(oKey, 3) & "' and dc04='" & SystemNumber(oKey, 4) & "' "
            strSQL2 = " and dc01='" & SystemNumber(oKey, 1) & "' and dc02='" & SystemNumber(oKey, 2) & "' and dc03='" & SystemNumber(oKey, 3) & "' and dc04='" & SystemNumber(oKey, 4) & "' "
            StrSQL3 = " and dc01='" & SystemNumber(oKey, 1) & "' and dc02='" & SystemNumber(oKey, 2) & "' and dc03='" & SystemNumber(oKey, 3) & "' and dc04='" & SystemNumber(oKey, 4) & "' "
            StrSQL4 = " and dc01='" & SystemNumber(oKey, 1) & "' and dc02='" & SystemNumber(oKey, 2) & "' and dc03='" & SystemNumber(oKey, 3) & "' and dc04='" & SystemNumber(oKey, 4) & "' "
            strSQL5 = " and dc01='" & SystemNumber(oKey, 1) & "' and dc02='" & SystemNumber(oKey, 2) & "' and dc03='" & SystemNumber(oKey, 3) & "' and dc04='" & SystemNumber(oKey, 4) & "' "
            strSQL1 = strSQL1 & " and T2.PA01 in (" & SQLGrpStr(SystemNumber(oKey, 1), 1) & ") "
            strSQL2 = strSQL2 & " and T2.TM01 in (" & SQLGrpStr(SystemNumber(oKey, 1), 2) & ") "
            StrSQL3 = StrSQL3 & " and T2.LC01 in (" & SQLGrpStr(SystemNumber(oKey, 1), 3) & ") "
            StrSQL4 = StrSQL4 & " and T2.HC01 in (" & SQLGrpStr(SystemNumber(oKey, 1), 4) & ") "
            strSQL5 = strSQL5 & " and T2.SP01 in (" & SQLGrpStr(SystemNumber(oKey, 1), 5) & ") "
        End If
strTemp = SystemNumber(oKey, 1)
'edit by nick 2004/09/14

        StrSQLa = "SELECT '' AS V,T1.PA01||'-'||T1.PA02||'-'||T1.PA03||'-'||T1.PA04 AS 母案案號,NVL(T1.PA05,NVL(T1.PA06,T1.PA07)) AS 母案案件名稱,''  as 商品類別,T2.PA01||'-'||T2.PA02||'-'||T2.PA03||'-'||T2.PA04 AS 分割案案號,NVL(T2.PA05,NVL(T2.PA06,T2.PA07)) AS 分割案案件名稱,''  as 商品類別 FROM PATENT T1,PATENT T2,DIVISIONcase " & _
                       "WHERE DC01=T2.PA01(+) AND DC02=T2.PA02(+) AND DC03=T2.PA03(+) AND DC04=T2.PA04(+) AND DC05=T1.PA01(+) AND DC06=T1.PA02(+) AND DC07=T1.PA03(+) AND DC08=T1.PA04(+) " & strSQL1
        StrSQLa = StrSQLa & " union SELECT '' AS V,T1.TM01||'-'||T1.TM02||'-'||T1.TM03||'-'||T1.TM04 AS 母案案號,NVL(T1.TM05,NVL(T1.TM06,T1.TM07)) AS 母案案件名稱,T1.tm09 as 商品類別,T2.TM01||'-'||T2.TM02||'-'||T2.TM03||'-'||T2.TM04 AS 分割案案號,NVL(T2.TM05,NVL(T2.TM06,T2.TM07)) AS 分割案案件名稱,T2.tm09 as 商品類別 FROM TRADEMARK T1,TRADEMARK T2,DIVISIONcase " & _
                       "WHERE DC01=T2.TM01(+) AND DC02=T2.TM02(+) AND DC03=T2.TM03(+) AND DC04=T2.TM04(+) AND DC05=T1.TM01(+) AND DC06=T1.TM02(+) AND DC07=T1.TM03(+) AND DC08=T1.TM04(+) " & strSQL2
        StrSQLa = StrSQLa & " union SELECT '' AS V,T1.LC01||'-'||T1.LC02||'-'||T1.LC03||'-'||T1.LC04 AS 母案案號,NVL(T1.LC05,NVL(T1.LC06,T1.LC07)) AS 母案案件名稱,'' as 商品類別,T2.LC01||'-'||T2.LC02||'-'||T2.LC03||'-'||T2.LC04 AS 分割案案號,NVL(T2.LC05,NVL(T2.LC06,T2.LC07)) AS 分割案案件名稱,''  as 商品類別 FROM LAWCASE T1,LAWCASE T2,DIVISIONcase " & _
                       "WHERE DC01=T2.LC01(+) AND DC02=T2.LC02(+) AND DC03=T2.LC03(+) AND DC04=T2.LC04(+) AND DC05=T1.LC01(+) AND DC06=T1.LC02(+) AND DC07=T1.LC03(+) AND DC08=T1.LC04(+) " & StrSQL3
        StrSQLa = StrSQLa & " union SELECT '' AS V,T1.HC01||'-'||T1.HC02||'-'||T1.HC03||'-'||T1.HC04 AS 母案案號,T1.HC06                                                  AS 母案案件名稱,'' as 商品類別,T2.HC01||'-'||T2.HC02||'-'||T2.HC03||'-'||T2.HC04 AS 分割案案號,T2.HC06                       AS 分割案案件名稱,''  as 商品類別 FROM HIRECASE T1,HIRECASE T2,DIVISIONcase " & _
                       "WHERE DC01=T2.HC01(+) AND DC02=T2.HC02(+) AND DC03=T2.HC03(+) AND DC04=T2.HC04(+) AND DC05=T1.HC01(+) AND DC06=T1.HC02(+) AND DC07=T1.HC03(+) AND DC08=T1.HC04(+) " & StrSQL4
        StrSQLa = StrSQLa & " union SELECT '' AS V,T1.SP01||'-'||T1.SP02||'-'||T1.SP03||'-'||T1.SP04 AS 母案案號,NVL(T1.SP05,NVL(T1.SP06,T1.SP07)) AS 母案案件名稱,'' as 商品類別,T2.SP01||'-'||T2.SP02||'-'||T2.SP03||'-'||T2.SP04 AS 分割案案號,NVL(T2.SP05,NVL(T2.SP06,T2.SP07)) AS 分割案案件名稱,''  as 商品類別 FROM SERVICEPRACTICE T1,SERVICEPRACTICE T2,DIVISIONcase " & _
                       "WHERE DC01=T2.SP01(+) AND DC02=T2.SP02(+) AND DC03=T2.SP03(+) AND DC04=T2.SP04(+) AND DC05=T1.SP01(+) AND DC06=T1.SP02(+) AND DC07=T1.SP03(+) AND DC08=T1.SP04(+) " & strSQL5
           Set T940606RS = New ADODB.Recordset
           T940606RS.CursorLocation = adUseClient
           T940606RS.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
       If T940606RS.RecordCount <> 0 And T940606RS.RecordCount > 0 Then
            ChkDataBy308 = True
       Else
           ChkDataBy308 = False
       End If
       Set T940606RS = Nothing
End Function

Function ChkDataByCR(oKey As String) As Boolean
Dim strSQL1 As String, strSQL2 As String, StrSQL3 As String, StrSQL4 As String, strSQL5 As String
Dim StrSQLa As String
Dim T940606RS As New ADODB.Recordset
   CheckOC3
   'modify by sonia 2015/3/19 不在此管制可看之系統類別, 否則FCP串P(FMP),外專程序會看不到 FCP-051717串P-111066
   'strSQL1 = "AND CR05 IN (" & SQLGrpStr(GetSystemKindByNick, 1) & ") "
   'strSQL2 = "AND CR05 IN (" & SQLGrpStr(GetSystemKindByNick, 2) & ") "
   'StrSQL3 = "AND CR05 IN (" & SQLGrpStr(GetSystemKindByNick, 3) & ") "
   'StrSQL4 = "AND CR05 IN (" & SQLGrpStr(GetSystemKindByNick, 4) & ") "
   'strSQL5 = "AND CR05 IN (" & SQLGrpStr(GetSystemKindByNick, 5) & ") "
   strSQL1 = "AND PA01 IS NOT NULL "
   strSQL2 = "AND TM01 IS NOT NULL "
   StrSQL3 = "AND LC01 IS NOT NULL "
   StrSQL4 = "AND HC01 IS NOT NULL "
   strSQL5 = "AND SP01 IS NOT NULL "
   'end 2015/3/19
      
   'edit by nickc 2007/01/02 資料抓錯 table
   'StrSQLa = "SELECT '' AS V,CR05||'-'||CR06||'-'||CR07||'-'||CR08||DECODE(PA57,'Y','＊','')||DECODE(length(nvl(pa108,'')),null,'','●') AS 本所案號,DECODE(length(nvl(pa136,'')),null,'','●')||pa47 as 分所號,NVL(PA05,NVL(PA06,PA07)) AS 案件名稱,NVL(NVL(CU04,NVL(CU05||' '||CU88||' '||CU89||' '||CU90,CU06)),pa26) AS 申請人,nvl(na03,pa09) AS 申請國家,decode(pa01,'CFP',ptm03,DeCODE(pa09,'000',PTM03,PTM04)) 專利商標種類,DECODE(PA16,'1','准','2','駁','') AS 目前准駁," & SQLDate("pa58") & " AS 閉卷日期,PA22 AS 審定專利號數 FROM CASERELATION,patent,nation,customer,PATENTTRADEMARKMAP WHERE CR01='" & SystemNumber(oKey, 1) & "' AND CR02='" & SystemNumber(oKey, 2) & "' AND CR03='" & SystemNumber(oKey, 3) & "' and CR04='" & SystemNumber(oKey, 4) & "' and cr05=pa01(+) and cr06=pa02(+) and cr07=pa03(+) and cr08=pa04(+) and pa09=na01(+) and '1'=ptm01(+) and pa08=ptm02(+) and " & SQLNewFag("pa26", "cu") & " " & strSQL1
   'StrSQLa = StrSQLa & " union SELECT '' AS V,CR05||'-'||CR06||'-'||CR07||'-'||CR08||DECODE(tm29,'Y','＊','')||DECODE(length(nvl(tm57,'')),null,'','●') AS 本所案號,DECODE(length(nvl(tm73,'')),null,'','●')||tm34 as 分所號,NVL(TM05,NVL(TM06,TM07)) AS 案件名稱,NVL(NVL(CU04,NVL(CU05||' '||CU88||' '||CU89||' '||CU90,CU06)),TM23) AS 申請人,nvl(na03,tm10) AS 申請國家,DeCODE(TM10,'000',PTM03,PTM04) 專利商標種類,DECODE(TM16,'1','准','2','駁','') AS 目前准駁," & SQLDate("tm30") & " AS 閉卷日期,TM15 AS 審定專利號數 FROM CASERELATION,trademark,nation,customer,PATENTTRADEMARKMAP WHERE CR01='" & SystemNumber(oKey, 1) & "' AND CR02='" & SystemNumber(oKey, 2) & "' AND CR03='" & SystemNumber(oKey, 3) & "' and CR04='" & SystemNumber(oKey, 4) & "' and cr05=tm01(+) and cr06=tm02(+) and cr07=tm03(+) and cr08=tm04(+) and tm10=na01(+) and '2'=ptm01(+) and tm08=ptm02(+) and " & SQLNewFag("tm23", "cu") & " " & strSQL2
   'StrSQLa = StrSQLa & " union SELECT '' AS V,CR05||'-'||CR06||'-'||CR07||'-'||CR08||DECODE(lc08,'Y','＊','')||DECODE(length(nvl(lc34,'')),null,'','●') AS 本所案號,DECODE(length(nvl(lc36,'')),null,'','●')||lc16 as 分所號,NVL(LC05,NVL(LC06,LC07)) AS 案件名稱,NVL(NVL(CU04,NVL(CU05||' '||CU88||' '||CU89||' '||CU90,CU06)),lc11) AS 申請人,nvl(na03,lc15) AS 申請國家,'' 專利商標種類,'' AS 目前准駁," & SQLDate("lc09") & " AS 閉卷日期,'' AS 審定專利號數 FROM CASERELATION,lawcase,nation,customer                                                                                                                                                                                           WHERE CR01='" & SystemNumber(oKey, 1) & "' AND CR02='" & SystemNumber(oKey, 2) & "' AND CR03='" & SystemNumber(oKey, 3) & "' and CR04='" & SystemNumber(oKey, 4) & "' and cr05=lc01(+)  and cr06=lc02(+) and cr07=lc03(+)   and cr08=lc04(+) and lc15=na01(+) and " & SQLNewFag("lc11", "cu") & " " & StrSQL3
   'StrSQLa = StrSQLa & " union SELECT '' AS V,CR05||'-'||CR06||'-'||CR07||'-'||CR08||DECODE(hc09,'Y','＊','')||DECODE(length(nvl(hc19,'')),null,'','●') AS 本所案號,DECODE(length(nvl(hc20,'')),null,'','●')||hc07 as 分所號,HC06 AS 案件名稱,NVL(NVL(CU04,NVL(CU05||' '||CU88||' '||CU89||' '||CU90,CU06)),hc05) AS 申請人,na03 AS 申請國家,'' 專利商標種類,'' AS 目前准駁," & SQLDate("hc10") & " AS 閉卷日期,'' AS 審定專利號數 FROM CASERELATION,hirecase,nation,customer                                                                                                                                                                                                                                 WHERE CR01='" & SystemNumber(oKey, 1) & "' AND CR02='" & SystemNumber(oKey, 2) & "' AND CR03='" & SystemNumber(oKey, 3) & "' and CR04='" & SystemNumber(oKey, 4) & "' and cr05=hc01(+) and cr06=hc02(+) and cr07=hc03(+) and cr08=hc04(+) and '000'=na01(+) and " & SQLNewFag("hc05", "cu") & " " & StrSQL4
   'StrSQLa = StrSQLa & " union SELECT '' AS V,CR05||'-'||CR06||'-'||CR07||'-'||CR08||DECODE(sp15,'Y','＊','')||DECODE(length(nvl(sp61,'')),null,'','●') AS 本所案號,DECODE(length(nvl(sp68,'')),null,'','●')||sp28 as 分所號,NVL(SP05,NVL(SP06,SP07)) AS 案件名稱,NVL(NVL(CU04,NVL(CU05||' '||CU88||' '||CU89||' '||CU90,CU06)),sp08) AS 申請人,nvl(na03,sp09) AS 申請國家,'' 專利商標種類,'' AS 目前准駁," & SQLDate("sp16") & " AS 閉卷日期,SP14 AS 審定專利號數 FROM CASERELATION,servicepractice,nation,customer                                                                                                                                                            WHERE CR01='" & SystemNumber(oKey, 1) & "' AND CR02='" & SystemNumber(oKey, 2) & "' AND CR03='" & SystemNumber(oKey, 3) & "' and CR04='" & SystemNumber(oKey, 4) & "' and cr05=sp01(+) and cr06=sp02(+) and cr07=sp03(+) and cr08=sp04(+) and sp09=na01(+) and " & SQLNewFag("sp08", "cu") & " " & strSQL5
   StrSQLa = "SELECT '' AS V,CR05||'-'||CR06||'-'||CR07||'-'||CR08||DECODE(PA57,'Y','＊','')||DECODE(length(nvl(pa108,'')),null,'','●') AS 本所案號,DECODE(length(nvl(pa136,'')),null,'','●')||pa47 as 分所號,NVL(PA05,NVL(PA06,PA07)) AS 案件名稱,NVL(NVL(CU04,DECODE(CU05,NULL,CU06,CU05||' '||CU88||' '||CU89||' '||CU90)),pa26) AS 申請人,nvl(na03,pa09) AS 申請國家,decode(pa01,'CFP',ptm03,DeCODE(pa09,'000',PTM03,PTM04)) 專利商標種類,DECODE(PA16,'1','准','2','駁','') AS 目前准駁," & SQLDate("pa58") & " AS 閉卷日期,PA22 AS 審定專利號數 FROM CASERELATION1,patent,nation,customer,PATENTTRADEMARKMAP WHERE CR01='" & SystemNumber(oKey, 1) & "' AND CR02='" & SystemNumber(oKey, 2) & "' AND CR03='" & SystemNumber(oKey, 3) & "' and CR04='" & SystemNumber(oKey, 4) & "' and cr05=pa01(+) and cr06=pa02(+) and cr07=pa03(+) and cr08=pa04(+) and pa09=na01(+) and '1'=ptm01(+) and pa08=ptm02(+) and " & SQLNewFag("pa26", "cu") & " " & strSQL1
   StrSQLa = StrSQLa & " union SELECT '' AS V,CR05||'-'||CR06||'-'||CR07||'-'||CR08||DECODE(tm29,'Y','＊','')||DECODE(length(nvl(tm57,'')),null,'','●') AS 本所案號,DECODE(length(nvl(tm73,'')),null,'','●')||tm34 as 分所號,NVL(TM05,NVL(TM06,TM07)) AS 案件名稱,NVL(NVL(CU04,DECODE(CU05,NULL,CU06,CU05||' '||CU88||' '||CU89||' '||CU90)),TM23) AS 申請人,nvl(na03,tm10) AS 申請國家,DeCODE(TM10,'000',PTM03,PTM04) 專利商標種類,DECODE(TM16,'1','准','2','駁','') AS 目前准駁," & SQLDate("tm30") & " AS 閉卷日期,TM15 AS 審定專利號數 FROM CASERELATION1,trademark,nation,customer,PATENTTRADEMARKMAP WHERE CR01='" & SystemNumber(oKey, 1) & "' AND CR02='" & SystemNumber(oKey, 2) & "' AND CR03='" & SystemNumber(oKey, 3) & "' and CR04='" & SystemNumber(oKey, 4) & "' and cr05=tm01(+) and cr06=tm02(+) and cr07=tm03(+) and cr08=tm04(+) and tm10=na01(+) and '2'=ptm01(+) and tm08=ptm02(+) and " & SQLNewFag("tm23", "cu") & " " & strSQL2
   StrSQLa = StrSQLa & " union SELECT '' AS V,CR05||'-'||CR06||'-'||CR07||'-'||CR08||DECODE(lc08,'Y','＊','')||DECODE(length(nvl(lc34,'')),null,'','●') AS 本所案號,DECODE(length(nvl(lc36,'')),null,'','●')||lc16 as 分所號,NVL(LC05,NVL(LC06,LC07)) AS 案件名稱,NVL(NVL(CU04,DECODE(CU05,NULL,CU06,CU05||' '||CU88||' '||CU89||' '||CU90)),lc11) AS 申請人,nvl(na03,lc15) AS 申請國家,'' 專利商標種類,'' AS 目前准駁," & SQLDate("lc09") & " AS 閉卷日期,'' AS 審定專利號數 FROM CASERELATION1,lawcase,nation,customer                                                                                                                                                                                           WHERE CR01='" & SystemNumber(oKey, 1) & "' AND CR02='" & SystemNumber(oKey, 2) & "' AND CR03='" & SystemNumber(oKey, 3) & "' and CR04='" & SystemNumber(oKey, 4) & "' and cr05=lc01(+)  and cr06=lc02(+) and cr07=lc03(+)   and cr08=lc04(+) and lc15=na01(+) and " & SQLNewFag("lc11", "cu") & " " & StrSQL3
   StrSQLa = StrSQLa & " union SELECT '' AS V,CR05||'-'||CR06||'-'||CR07||'-'||CR08||DECODE(hc09,'Y','＊','')||DECODE(length(nvl(hc19,'')),null,'','●') AS 本所案號,DECODE(length(nvl(hc20,'')),null,'','●')||hc07 as 分所號,HC06 AS 案件名稱,NVL(NVL(CU04,DECODE(CU05,NULL,CU06,CU05||' '||CU88||' '||CU89||' '||CU90)),hc05) AS 申請人,na03 AS 申請國家,'' 專利商標種類,'' AS 目前准駁," & SQLDate("hc10") & " AS 閉卷日期,'' AS 審定專利號數 FROM CASERELATION1,hirecase,nation,customer                                                                                                                                                                                                                                 WHERE CR01='" & SystemNumber(oKey, 1) & "' AND CR02='" & SystemNumber(oKey, 2) & "' AND CR03='" & SystemNumber(oKey, 3) & "' and CR04='" & SystemNumber(oKey, 4) & "' and cr05=hc01(+) and cr06=hc02(+) and cr07=hc03(+) and cr08=hc04(+) and '000'=na01(+) and " & SQLNewFag("hc05", "cu") & " " & StrSQL4
   StrSQLa = StrSQLa & " union SELECT '' AS V,CR05||'-'||CR06||'-'||CR07||'-'||CR08||DECODE(sp15,'Y','＊','')||DECODE(length(nvl(sp61,'')),null,'','●') AS 本所案號,DECODE(length(nvl(sp68,'')),null,'','●')||sp28 as 分所號,NVL(SP05,NVL(SP06,SP07)) AS 案件名稱,NVL(NVL(CU04,DECODE(CU05,NULL,CU06,CU05||' '||CU88||' '||CU89||' '||CU90)),sp08) AS 申請人,nvl(na03,sp09) AS 申請國家,'' 專利商標種類,'' AS 目前准駁," & SQLDate("sp16") & " AS 閉卷日期,SP14 AS 審定專利號數 FROM CASERELATION1,servicepractice,nation,customer                                                                                                                                                            WHERE CR01='" & SystemNumber(oKey, 1) & "' AND CR02='" & SystemNumber(oKey, 2) & "' AND CR03='" & SystemNumber(oKey, 3) & "' and CR04='" & SystemNumber(oKey, 4) & "' and cr05=sp01(+) and cr06=sp02(+) and cr07=sp03(+) and cr08=sp04(+) and sp09=na01(+) and " & SQLNewFag("sp08", "cu") & " " & strSQL5
   
   Set T940606RS = New ADODB.Recordset
   T940606RS.CursorLocation = adUseClient
   T940606RS.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
   If T940606RS.RecordCount <> 0 And T940606RS.RecordCount > 0 Then
       ChkDataByCR = True
   Else
       ChkDataByCR = False
   End If
   Set T940606RS = Nothing
End Function
'Add by Morgan 2005/6/8

'檢查收據客戶所屬所別
'p_Key:本所號1~4,收據號1,收款號1 ,p_Office:所別, p_Choice:p_Key類別 1.本所號2.收據號3.收款號
Public Function PUB_CheckCaseZone(ByRef p_Key() As String, Optional ByRef p_Office As String, Optional ByVal p_Choice As String = "1") As Boolean

   Dim stP06 As String, stMsg As String
   
   '北所不檢查
   If p_Office = "1" Then
      PUB_CheckCaseZone = True
      Exit Function
   End If
   
   Dim stSysNo As String, stVTable As String, stOffice As String
   
On Error GoTo ErrHnd

   Select Case p_Choice
      Case "1" '本所號
         stSysNo = CheckSys(p_Key(1))
         Select Case stSysNo
            Case "1"
               stVTable = "SELECT SUBSTR(PA26,1,8) X01,SUBSTR(PA26,9,1) X02 FROM Patent WHERE PA01='" & p_Key(1) & "' AND PA02='" & p_Key(2) & "' AND PA03='" & p_Key(3) & "' AND PA04='" & p_Key(4) & "'"
            Case "2"
               stVTable = "SELECT SUBSTR(TM23,1,8) X01,SUBSTR(TM23,9,1) X02 FROM Trademark WHERE TM01='" & p_Key(1) & "' AND TM02='" & p_Key(2) & "' AND TM03='" & p_Key(3) & "' AND TM04='" & p_Key(4) & "'"
            Case "3"
               stVTable = "SELECT SUBSTR(LC11,1,8) X01,SUBSTR(LC11,9,1) X02 FROM Lawcase WHERE LC01='" & p_Key(1) & "' AND LC02='" & p_Key(2) & "' AND LC03='" & p_Key(3) & "' AND LC04='" & p_Key(4) & "'"
            'add by sonia 2022/11/21 發現漏寫顧問LA-002975
            Case "4"
               stVTable = "SELECT SUBSTR(HC05,1,8) X01,SUBSTR(HC05,9,1) X02 FROM Hirecase WHERE HC01='" & p_Key(1) & "' AND HC02='" & p_Key(2) & "' AND HC03='" & p_Key(3) & "' AND HC04='" & p_Key(4) & "'"
            'end
            Case Else
               stVTable = "SELECT SUBSTR(SP08,1,8) X01,SUBSTR(SP08,9,1) X02 FROM Servicepractice WHERE SP01='" & p_Key(1) & "' AND SP02='" & p_Key(2) & "' AND SP03='" & p_Key(3) & "' AND SP04='" & p_Key(4) & "'"
         End Select
         strSql = "SELECT ST06 FROM (" & stVTable & ") X,CUSTOMER,STAFF WHERE CU01=X01 AND CU02=X02 AND ST01(+)=CU13"
      
      Case "2" '收據號
         strSql = "SELECT ST06 FROM ACC0K0,STAFF WHERE A0K01='" & p_Key(1) & "' AND ST01(+)=A0K20"
         
      Case "3" '收款號
         'Modify by Morgan 2005/7/20 --檢查收據
         'strSQL = "SELECT ST06 FROM ACC0L0,STAFF WHERE A0L01='" & p_Key(1) & "' AND ST01(+)=A0L13"
         strSql = "SELECT ST06 FROM ACC0L0,ACC0M0,STAFF WHERE A0L01='" & p_Key(1) & "' AND A0M01(+)=A0L01 AND ST01(+)=A0M10"
         
      Case Else
         strSql = ""
   End Select
   
   CheckOC3
   With AdoRecordSet3
      .CursorLocation = adUseClient
      .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      If .RecordCount > 0 Then
         stP06 = "" & .Fields(0)
         If p_Office <> "" And stP06 <> p_Office Then
            
            Select Case stP06
               Case "1"
                  stOffice = "北所"
               Case "2"
                  stOffice = "中所"
               Case "3"
                  stOffice = "南所"
               Case "4"
                  stOffice = "高所"
               Case Else
                  stOffice = "其他所"
            End Select
            stMsg = "使用者所別不符，本收據應為【 " & stOffice & "】案件！"
            MsgBox stMsg, vbExclamation
         Else
            PUB_CheckCaseZone = True
         End If
      End If
   End With
   
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
   
End Function

'add by nickc 2005/06/13 取得我的文件匣位置
Public Function GetMyDocPath() As String
Dim pidl As Long, s As String
'Debug.Print Environ("userprofile")
'Debug.Print Environ("username")
'Id = CSIDL_DESKTOP ' 「桌面」資料夾
s = String(MAX_PATH, 0)
SHGetSpecialFolderLocation 0, CSIDL_PERSONAL, pidl
SHGetPathFromIDList pidl, s
GetMyDocPath = Left(s, InStr(s, Chr(0)) - 1)
End Function

'Add by Morgan 2004/7/26
'依照國家英文名將代號陣列排序
Public Function PUB_GetCountryData(ByRef strCountry As String) As String
   
On Error GoTo ErrHnd
   strSql = "select rpad(nvl(na04,' '),22,' ')||rpad(na03,22,' ')||na01 from nation " & _
      " where instr('" & strCountry & "',na01)>0 order by na04"
      
   CheckOC
   adoRecordset.CursorLocation = adUseClient
   adoRecordset.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If adoRecordset.RecordCount > 0 Then
      PUB_GetCountryData = adoRecordset.GetString(adClipString, , , ",")
      '去掉最後一個逗號
      PUB_GetCountryData = Left(PUB_GetCountryData, Len(PUB_GetCountryData) - 1)
   End If
   
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
   CheckOC
End Function

'move by nickc 2005/09/16 from cls001
'修改CKind資料庫
Public Function UpdateCKindDatabase(ByRef mr01 As String, _
             ByRef mr02 As String, ByRef mr03 As String, ByRef mr04 As String, ByRef mr05 As String, _
             ByRef mr06 As String, ByRef mr07 As String, ByRef mr08 As String, _
             ByRef mr09 As String, ByRef mr10 As String, ByRef mr11 As String, ByRef mr12 As String, _
             ByRef mr13 As String, ByRef mr14 As String, ByRef mr15 As String, ByRef mr16 As String, _
             ByRef mr17 As String, Optional ByRef mr24 As String) As Boolean
Dim strSql As String

On Error GoTo ErrHand
mr02 = ChangeTStringToWString(mr02)
mr08 = ChangeTStringToWString(mr08)
mr16 = ChangeTStringToWString(mr16)
mr17 = ChangeTStringToWString(mr17)
mr24 = ChangeTStringToWString(mr24) 'Add by Morgan 2007/6/12 加 mr24
'edit by nickc 2005/09/16 未觸發 triggers
'StrSql = "update mailrec set mr02=" + CNULL(mr02) + ",mr03=" + CNULL(mr03) + ",mr04=" + CNULL(mr04) _
          + ",mr05=" + CNULL(mr05) + ",mr06=" + CNULL(mr06) + ",mr07=" + CNULL(mr07) + ",mr08=" + CNULL(mr08) + ",mr09=" + CNULL(mr09) + _
          ",mr10=" + CNULL(mr10) + ",mr11=" + CNULL(mr11) + ",mr12=" + CNULL(mr12) + ",mr13=" + CNULL(mr13) + ",mr14=" + CNULL(mr14) + _
          ",mr15=" + CNULL(mr15) + ",mr16=" + CNULL(mr16) + ",mr17=" + CNULL(mr17) + " where mr01=" + CNULL(mr01)
'Modify by Morgan 2007/6/12 加 mr24
strSql = "begin user_data.user_enabled:=1; update mailrec set mr02=" + CNULL(mr02) + ",mr03=" + CNULL(mr03) + ",mr04=" + CNULL(mr04) _
          + ",mr05=" + CNULL(mr05) + ",mr06=" + CNULL(mr06) + ",mr07=" + CNULL(mr07) + ",mr08=" + CNULL(mr08) + ",mr09=" + CNULL(mr09) + _
          ",mr10=" + CNULL(mr10) + ",mr11=" + CNULL(mr11) + ",mr12=" + CNULL(mr12) + ",mr13=" + CNULL(mr13) + ",mr14=" + CNULL(mr14) + _
          ",mr15=" + CNULL(mr15) + ",mr16=" + CNULL(mr16) + ",mr17=" + CNULL(mr17) + ",mr24=" + CNULL(mr24) + " where mr01=" + CNULL(mr01) & " ; end; "

cnnConnection.Execute strSql
UpdateCKindDatabase = True
Exit Function
ErrHand:
   UpdateCKindDatabase = False
   MsgBox "(" & Err.Number & ")" & Err.Description, vbExclamation + vbOKOnly, "更新來函紀錄檔動作失敗"
End Function

'move by nickc 2005/09/16 from cls001
'讀取CKind資料庫
Public Function ReadCKindDataBase(ByRef mr01 As String, _
             ByRef mr02 As String, ByRef mr03 As String, ByRef mr04 As String, ByRef mr05 As String, _
             ByRef mr06 As String, ByRef mr07 As String, ByRef mr08 As String, _
             ByRef mr09 As String, ByRef mr10 As String, ByRef mr11 As String, ByRef mr12 As String, _
             ByRef mr13 As String, ByRef mr14 As String, ByRef mr15 As String) As Boolean
Dim strSql As String, rsRecordset As New ADODB.Recordset

On Error GoTo ErrHand
strSql = "select mr02,mr03,mr04,mr05,mr06,mr07,mr08,mr09,mr10,mr11,mr12,mr13," + _
          "mr14,mr15 from mailrec where mr01=" + CNULL(mr01)
rsRecordset.CursorLocation = adUseClient
rsRecordset.Open strSql, cnnConnection
If rsRecordset.RecordCount > 0 Then
   mr02 = IIf(IsNull(rsRecordset.Fields(0)), "", rsRecordset.Fields(0))
   If mr02 <> "" Then mr02 = ChangeWStringToTString(mr02)
   mr03 = IIf(IsNull(rsRecordset.Fields(1)), "", rsRecordset.Fields(1))
   mr04 = IIf(IsNull(rsRecordset.Fields(2)), "", rsRecordset.Fields(2))
   mr05 = IIf(IsNull(rsRecordset.Fields(3)), "", rsRecordset.Fields(3))
   mr06 = IIf(IsNull(rsRecordset.Fields(4)), "", rsRecordset.Fields(4))
   mr07 = IIf(IsNull(rsRecordset.Fields(5)), "", rsRecordset.Fields(5))
   mr08 = IIf(IsNull(rsRecordset.Fields(6)), "", rsRecordset.Fields(6))
   If mr08 <> "" Then mr08 = ChangeWStringToTString(mr08)
   mr09 = IIf(IsNull(rsRecordset.Fields(7)), "", rsRecordset.Fields(7))
   mr10 = IIf(IsNull(rsRecordset.Fields(8)), "", rsRecordset.Fields(8))
   mr11 = IIf(IsNull(rsRecordset.Fields(9)), "", rsRecordset.Fields(9))
   mr12 = IIf(IsNull(rsRecordset.Fields(10)), "", rsRecordset.Fields(10))
   mr13 = IIf(IsNull(rsRecordset.Fields(11)), "", rsRecordset.Fields(11))
   mr14 = IIf(IsNull(rsRecordset.Fields(12)), "", rsRecordset.Fields(12))
   mr15 = IIf(IsNull(rsRecordset.Fields(13)), "", rsRecordset.Fields(13))
   ReadCKindDataBase = True
Else
   ShowMsg MsgText(1505)
End If
rsRecordset.Close
Exit Function
ErrHand:
   MsgBox "(" & Err.Number & ")" & Err.Description, vbExclamation + vbOKOnly, "讀取來函紀錄檔動作失敗"

End Function

'Move by Lydia 2016/12/15 移回frm010002
''move by nickc 2005/09/16 from cls001
''新增CKind至資料庫
'Public Function InsertCKindDatabase(ByRef mr01 As String, _
'             ByRef mr02 As String, ByRef mr03 As String, ByRef mr04 As String, ByRef mr05 As String, _
'             ByRef mr06 As String, ByRef mr07 As String, ByRef mr08 As String, _
'             ByRef mr09 As String, ByRef mr10 As String, ByRef mr11 As String, ByRef mr12 As String, _
'             ByRef mr13 As String, ByRef mr14 As String, ByRef mr15 As String, ByRef mr16 As String, _
'             ByRef mr17 As String, Optional ByRef mr24 As String) As Boolean
'Dim strSql As String, strAutoNumber As String
''Add By Cheng 2002/11/14
'Dim BolTransOk As Boolean
'BolTransOk = True
'
'On Error GoTo ErrHand
'cnnConnection.BeginTrans
''edit by nickc 2007/02/06 不用 dll 了
''Dim objPublicData As Object
''Set objPublicData = CreateObject("prjTaieDll.clsPublicData")
''If objPublicData.GetAutoNumber(Left(mr01, 1), strAutoNumber, True, True) Then
'If ClsPDGetAutoNumber(Left(mr01, 1), strAutoNumber, True, True) Then
'   mr01 = mr01 + strAutoNumber
'   mr02 = ChangeTStringToWString(mr02)
'   mr08 = ChangeTStringToWString(mr08)
'   mr16 = ChangeTStringToWString(mr16)
'   mr17 = ChangeTStringToWString(mr17)
'   'Modify by Morgan 2007/6/12 加 mr24
'   mr24 = ChangeTStringToWString(mr24)
'   strSql = "insert into mailrec (mr01,mr02,mr03,mr04,mr05,mr06,mr07,mr08,mr09,mr10,mr11,mr12,mr13," + _
'          "mr14,mr15,mr16,mr17,mr24) values (" + CNULL(mr01) + "," + CNULL(mr02) + "," + CNULL(mr03) + "," + CNULL(mr04) _
'          + "," + CNULL(mr05) + "," + CNULL(mr06) + "," + CNULL(mr07) + "," + CNULL(mr08) + "," + CNULL(mr09) + "," + _
'          CNULL(mr10) + "," + CNULL(mr11) + "," + CNULL(mr12) + "," + CNULL(mr13) + "," + CNULL(mr14) + "," + _
'          CNULL(mr15) + "," + CNULL(mr16) + "," + CNULL(mr17) + "," + CNULL(mr24) + ")"
'   'end 2007/6/12
'   cnnConnection.Execute strSql
'   cnnConnection.CommitTrans
'   InsertCKindDatabase = True
'Else
'   cnnConnection.RollbackTrans
'   InsertCKindDatabase = False
'   MsgBox "(" & Err.Number & ")" & Err.Description, vbExclamation + vbOKOnly, "新增來函紀錄檔動作失敗"
'End If
''edit by nickc 2007/02/06 不用 dll 了
''Set objPublicData = Nothing
'Exit Function
'ErrHand:
'    'Add By Cheng 2002/11/14
'    If Err.Number = -2147168237 Then
'       BolTransOk = False
'       Resume Next
'    End If
'
'cnnConnection.RollbackTrans
'   InsertCKindDatabase = False
'   MsgBox "(" & Err.Number & ")" & Err.Description, vbExclamation + vbOKOnly, "新增來函紀錄檔動作失敗"
'
'End Function

'Modify by Morgan 2005/10/17從Public移過來因為財務也要用
'Add By Cheng 2002/07/03
'Modify by Morgan 2005/10/7 加p_iDays參數
'p_iDays:工作天數,預設1天
Public Function PUB_GetWorkDayAfterSysDate(dblDate As Double, Optional ByVal p_iDays As Integer = 1) As Double
Dim rsA As New ADODB.Recordset
Dim StrSQLa As String

PUB_GetWorkDayAfterSysDate = dblDate - 19110000
If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing
rsA.CursorLocation = adUseClient
'Modify by Morgan 2005/10/7
'StrSQLa = "Select * From WorkDay Where WD01>" & dblDate & " Order By WD01 "
'rsA.MaxRecords = 1
If p_iDays > 0 Then
   rsA.MaxRecords = p_iDays
   StrSQLa = "Select * From WorkDay Where WD01>" & dblDate & " Order By WD01 "
ElseIf p_iDays < 0 Then
   rsA.MaxRecords = Abs(p_iDays)
   StrSQLa = "Select * From WorkDay Where WD01<" & dblDate & " Order By WD01 desc"
Else
   rsA.MaxRecords = 1
   StrSQLa = "Select * From WorkDay Where WD01>" & dblDate & " Order By WD01 "
End If

rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
If rsA.RecordCount > 0 Then
   rsA.MoveLast 'add by Morgan 2005/10/7
   PUB_GetWorkDayAfterSysDate = rsA.Fields(0).Value - 19110000
End If
If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing
End Function
'Add by Morgan 2005/10/25 將"A、B、C"敘述改成"A、B和C"
Public Function PUB_ReContent(ByVal p_Content As String, Optional ByVal p_ChrOld As String = "、", Optional ByVal p_ChrNew As String = "和") As String
   Dim i As Integer, iPos As Integer, stReturn As String
   i = 0: iPos = 0: stReturn = p_Content
   Do
      iPos = i
      i = i + 1
      i = InStr(i, p_Content, p_ChrOld)
   Loop While i > 0
   If iPos > 0 Then stReturn = Left(p_Content, iPos - 1) & p_ChrNew & Mid(p_Content, iPos + 1)
   PUB_ReContent = stReturn
End Function


'add by nickc 2005/11/23 取圖用
'edit by nickc 2006/05/24
'Public Function pvGetStdPicture(ByVal sFileName As String, bSuccess As Boolean, Optional pic As PictureBox) As StdPicture
Public Function pvGetStdPicture(ByVal sFileName As String) As StdPicture
    'add by nickc 2006/05/09
    Dim tBI      As BITMAP
    Dim bSuccess
    
    On Error Resume Next

    If (pvGetExt(sFileName) = "png" Or pvGetExt(sFileName) = "tif") Then
        
        '-- Use GDI+ loading
        'Remove by Morgan 2006/8/10 不再使用
        'Set pvGetStdPicture = mGDIpEx.LoadPictureEx(sFileName)
        'end 2006/8/10
        
    'add by nickc 2006/01/05 修正 wmf and emf 秀圖問題
'    ElseIf (pvGetExt(sFileName) = "wmf" Or pvGetExt(sFileName) = "emf") Then
'        Dim tmpPB As PictureBox
'        Set tmpPB = pic
'        Set pvGetStdPicture = mGDIpEx.LoadPictureExWmf(sFileName, tmpPB)
    Else
        '-- Use VB LoadPicture
        Set pvGetStdPicture = LoadPicture(sFileName)
'        If pvGetStdPicture Is Nothing Then
'            Set pvGetStdPicture = mGDIpEx.LoadPictureEx(sFileName)
'        End If
    End If

    '-- Is there an image ?
    bSuccess = Not (pvGetStdPicture Is Nothing)

    If (bSuccess = False) Then
        '-- Nothing loaded
        Call MsgBox("無法解析的圖檔！", vbExclamation)
    End If
'edit by nickc 2006/05/24
'    Call GetObject(pvGetStdPicture.handle, Len(tBI), tBI)
'
'    If tBI.bmWidth > 2000 Or tBI.bmHeight > 2000 Then
'        bSuccess = False
'        Call MsgBox("目前尚不提供圖檔太大的格式！" & vbCrLf & "請將圖的寬與高調整到 2000 像素內！", , "圖片太大！")
'    End If
    On Error GoTo 0
End Function

Public Function pvGetExt(ByVal sFileName As String) As String
    pvGetExt = LCase(Right$(sFileName, 3))
End Function
'Add by Morgan 2005/12/13
'讀資料庫電腦名稱
Public Function PUB_GetDbTerminal() As String
   'Modified by Morgan 2015/3/26 變數都改私有
   Dim stSQL As String, intR As Integer
   Dim rsQuery As ADODB.Recordset
   
On Error GoTo ErrHnd
   
   stSQL = "select TERMINAL FROM V$SESSION where SID=1"
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      pub_DbTerminalName = rsQuery.Fields(0)
      PUB_GetDbTerminal = "(" & rsQuery.Fields(0) & ")"
   End If
   
ErrHnd:
   If Err.Number <> 0 Then
      MsgBox Err.Description, vbCritical
   End If
   Set rsQuery = Nothing
End Function

'Add by Morgan 2006/6/23
'Removed by Morgan 2025/4/30 不再使用
'Public Function UPdateTNSName(p_DS As String) As Boolean
'   Dim sFilePath1 As String, sFilePath2 As String
'   pub_OS = GetVersion32
'   pub_HostName = PUB_ReadHostName 'Add by Morgan 2008/3/27
'   If pub_OS = 1 Then
'      sFilePath1 = "C:\orawin95\NET80\ADMIN\TNSNAMES.ORA"
'      sFilePath2 = "C:\orawin95\NET80\ADMIN\TNSNAMES." & p_DS
'   Else
'      sFilePath1 = "C:\orant\NET80\ADMIN\TNSNAMES.ORA"
'      sFilePath2 = "C:\orant\NET80\ADMIN\TNSNAMES." & p_DS
'   End If
'   If Dir(sFilePath2) <> Empty Then
'      FileCopy sFilePath2, sFilePath1
'      UPdateTNSName = True
'   End If
'End Function

'Add by Morgan 2005/12/14
'連接資料庫
Public Function PUB_Connect2DB(Optional ByVal p_IsChgCnn As Boolean = False) As Boolean

   Dim sChoice As String, sDS As String
   Static bolO12Test As Boolean
   
On Error GoTo ErrHand
   
   'Modified by Morgan 2017/8/21 改跑執行檔才可選連線
   ''Added by Morgan 2017/4/20
   'If strProvider = cOraProvider Then
   '   bolO12Test = True
   'ElseIf strProvider = "" Then
   '   If p_IsChgCnn = False And Val(PUB_GetVersionNo) > 6 Then
   '      If MsgBox("是否在測試 O12?", vbYesNo + vbDefaultButton1) = vbYes Then
   '         'strProvider = cOraProvider 'Removed by Morgan 2017/8/14 配合財務程式改用 O12 12.1 版以便與 O8 相容
   '         bolO12Test = True
   '      End If
   '   End If
   '   If strProvider = "" Then strProvider = cProvider
   'End If
   ''end 2017/4/20
   'If bolO12Test Then
   '   sChoice = Trim(InputBox("1.O12" & vbCrLf & vbCrLf & "2.M51-O12", "請選擇連線", "1"))
   'Else
   '   sChoice = Trim(InputBox("1.【 正式 】資料庫" & vbCrLf & vbCrLf & "2.【 測試 】資料庫", "請選擇連線", "2"))
   'End If
   'Modified by Morgan 2018/6/21 O12上線改回可選
   'If InStr(UCase(Pub_GetModuleFileName), "VB6.EXE") = 0 Then
      sChoice = Trim(InputBox("1.【 正式 】資料庫" & vbCrLf & vbCrLf & "2.【 測試 】資料庫", "請選擇連線", "2"))
   'Else
   '   sChoice = "1"
   'End If
   'end 2017/8/21
   
   '重新連線取消
   If sChoice = Empty Then
      If p_IsChgCnn = True Then
         PUB_Connect2DB = True
         Exit Function
      'Add by Morgan 2006/5/15
      Else
         End
      End If
   End If
   
   Select Case sChoice
      Case 1
         sDS = "Live"
         strProvider = cProvider 'Added by Morgan 2021/4/16
      Case Else
         sDS = "Test"
         strProvider = cOraProvider 'Added by Morgan 2021/4/9 測試資料庫改用OLEDB確認沒問題後上線
   End Select
   
   'Removed by Morgan 2025/4/30
   'If UPdateTNSName(sDS) = True Then
   '   sDS = "M51CON"
   'End If
   
   Set cnnConnection = Nothing
   If cnnConnection Is Nothing Then
      Set cnnConnection = New ADODB.Connection
   Else
      If cnnConnection.State = adStateOpen Then
         cnnConnection.Close
      End If
   End If
   cnnConnection.ConnectionTimeout = 60
   
   cnnConnection.Provider = IIf(strProvider <> "", strProvider, cProvider)
   cnnConnection.Properties("Data Source").Value = sDS
   cnnConnection.Properties("User ID").Value = UserName
   cnnConnection.Properties("Password").Value = Password
   cnnConnection.Open
   
   strServerName = sDS 'Added by Morgan 2019/5/22
   
   strSrvDate(1) = Format(ServerDate)
   strSrvDate(2) = Format(Val(strSrvDate(1)) - 19110000)
   PUB_Connect2DB = True
   If p_IsChgCnn = True Then
      'Add by Morgan 2006/6/30
      'edit by nickc 2007/02/06 不用 dll 了
      'If IsObject(obj003) = True Then
      '   Set obj003.Connection = cnnConnection
      'End If
      'Set objLawDll.Connection = cnnConnection
      'objPublicData.Connection = cnnConnection
      
      
      'end 2006/6/30
      'Add by Morgan 2006/7/13
      If IsObject(adoTaie) = True Then
         Set adoTaie = cnnConnection
      End If
      If InStr(Forms(0).Caption, "(") > 0 Then
         Forms(0).Caption = Left(Forms(0).Caption, InStr(Forms(0).Caption, "(") - 1) & PUB_GetDbTerminal
      'Added by Morgan 2025/4/30
      Else
         Forms(0).Caption = Forms(0).Caption & PUB_GetDbTerminal
      'end 2025/4/30
      End If
      If PUB_SetUserData() = False Then
          MsgBox "資料庫變數設定失敗！"
          PUB_Connect2DB = False
      End If
   End If
   PUB_SetSystemVar 'Add by Morgan 2009/2/19
   
ErrHand:
   If Err.Number <> 0 Then
      MsgBox Err.Description, vbCritical
   End If
   
End Function

'合併及以 "-" 連結字串
Public Function GiveSymbol(ByVal txt1 As String, ByVal txt2 As String, txt3 As String, txt4 As String, Optional strMerger As String) As String
   If txt4 = "" Or txt4 = "00" Then
      If txt3 = "" Or txt3 = "0" Then
        GiveSymbol = txt1 + "-" + txt2
        strMerger = txt1 + txt2 + "000"
      Else
         GiveSymbol = txt1 + "-" + txt2 + "-" + txt3
         strMerger = txt1 + txt2 + txt3 + "00"
      End If
   Else
      GiveSymbol = txt1 + "-" + txt2 + "-" + txt3 + "-" + txt4
      strMerger = txt1 + txt2 + txt3 + txt4
   End If
End Function

'Add by Morgan 2006/1/10 檢查客戶匯款銀行資料並發Mail
Public Sub PUB_AccDataCheck(p_A2201 As String, Optional p_Content As String)
   Dim stSubject As String
   strSql = "select 1 from acc220 where a2201='" & Left(p_A2201 & "0", 9) & "'"
   CheckOC
   With adoRecordset
      .CursorLocation = adUseClient
      .Open strSql, cnnConnection, adOpenForwardOnly, adLockReadOnly
      If .RecordCount > 0 Then
         If Left(p_A2201, 1) = "X" Then
            stSubject = "客戶"
         Else
            stSubject = "代理人"
         End If
         '2011/12/26 MODIFY BY SONIA 因加入中日文名稱故修改
         'stSubject = stSubject & "【" & p_A2201 & "】的英文名稱已修改，請更正銀行匯款資料！"
         stSubject = stSubject & "【" & p_A2201 & "】的名稱已修改，請更正銀行匯款資料！"
         'Modify By Sindy 2019/7/3 收受者休假不需要彈訊息告知
         'PUB_SendMail strUserNum, "70004", "", stSubject, p_Content
         'modify by sonia 2022/10/25 70004->B1007
         PUB_SendMail strUserNum, "B1007", "", stSubject, p_Content, , , , , , , , , , , False
      End If
   End With
End Sub

'將申請地址中的郵遞區號換成新的郵遞區號，原先沒有的話就加入
'add by nickc 2006/01/26
Public Function Pub_RplCu112(oStr As String, oCu112 As String, oCu As String) As String
Dim tmpOldStr As String
Dim NoData As Boolean
Dim strCU23
NoData = False
   
   'Add By Sindy 2011/2/22 取得客戶中文地址
   oCu = ChangeCustomerL(oCu)
   strCU23 = ""
   strSql = "SELECT * FROM Customer " & _
         "WHERE CU01 = '" & Mid(oCu, 1, 8) & "' AND " & _
               "CU02 = '" & Mid(oCu, 9, 1) & "'"
   intI = 1
   Set RsTemp = ClsLawReadRstMsg(intI, strSql)
   If intI = 1 Then
      strCU23 = RsTemp("cu23")
   End If
   
   tmpOldStr = oStr
   Do While NoData = False
       If tmpOldStr <> "" Then
           If Asc(Mid(tmpOldStr, 1, 1)) + 65536 >= 41647 And Asc(Mid(tmpOldStr, 1, 1)) + 65536 <= 41656 Then
               tmpOldStr = Mid(tmpOldStr, 2)
           Else
               NoData = True
           End If
       Else
           NoData = True
       End If
   Loop
   
   'Modify By Sindy 2011/2/22 檢查客戶中文地址和申請中文地址相同時,才須將申請中文地址中的郵遞區號換成新的郵遞區號
   If strCU23 = tmpOldStr Then
   '2011/2/22 End
      Pub_RplCu112 = oCu112 & tmpOldStr
   Else
      Pub_RplCu112 = oStr
   End If
End Function


'add by nickc 2006/02/07 取得員工入所日
Public Function PUB_GetST13(strUserNum As String) As String
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset

PUB_GetST13 = ""
StrSQLa = "Select ST13 From Staff Where ST01='" & strUserNum & "' "
rsA.CursorLocation = adUseClient
rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
If rsA.RecordCount > 0 Then
    PUB_GetST13 = "" & rsA.Fields(0).Value
End If
If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing

End Function

'add by nickc 2006/03/10 紀錄所有的維護資料
'ActSQLStr     執行中的語法
'edit by nickc 2007/01/03 改 byval
'Public Function Pub_SeekTbLog(ActSQLStr As String) As Boolean
'Modify by Amy 2017/09/04 +stUser 參數
'Modified by Lydia 2018/10/19 bolDesc 是否記錄詳細 (Memo by Lydia 2025/10/30 新增判斷模組PUB_FilterSeekSQL來區分是否包含SQL的保留文字；若有不同情況，請自行調整)
'Modified by Morgan 2019/10/3 +bolUpdWoFunc Update語法是否有使用db function(因語法態樣太多,建議只在特定的地方使用,以免發生不可預期的錯誤)
'Modified by Lydia 2021/04/27 + stFromName 更新來源的表單名稱 ; (因外專特殊字開啟原始檔維護, form_unload不完整造成記錄來源有問題)
'Modified by Lydia 2025/07/22 +傳入收文號stDefCP09 'Memo by Lydia 2025/10/30 拿掉stDefCP09，併入stVal 傳入值
'Modify by Amy 2025/09/15 +stVal 傳入值 (memo by Lydia 2025/10/30 傳入DL05=>收文號 / X、Y、R編號)
Public Function Pub_SeekTbLog(ByVal ActSQLStr As String, Optional ByVal stUser As String = "", Optional ByVal bolDesc As Boolean = False, _
      Optional ByVal bolUpdWoFunc As Boolean = False, Optional stFromName As String = "", Optional stVal As String = "") As Boolean
Dim tmpStr As String
Dim tmp2SQLStr As String
Dim oDL01 As String
Dim oDL02 As String
Dim oDL03 As String
Dim oDL04 As String
Dim oDL05 As String
Dim oDL09 As String
Dim oDL10 As String
Dim oDL12 As String
Dim tArr As Variant
Dim tArrF As Variant
Dim tArrV As Variant
Dim tArrTI As Integer
Dim SeekWhere As String
Dim tmpSelData As String
Dim tmpUpdateFileds As String
Dim tmpSelRs As New ADODB.Recordset
Dim ChkDatachg As Boolean
'add by nickc 2007/04/18
Dim SQLtmp As Integer
Dim strNewUpd As String, intU As Integer 'Added by Lydia 2023/04/18
Dim m_NP07 As String, m_NP22 As String, stTmp As String, stQ As String, stOldData As String, arrTmp 'Add by Amy 2025/09/15
Dim stData As String 'Add by Amy 2025/09/19

'Modified by Morgan 2024/7/10 單引號的內容不可去空白,否則判斷與紀錄都會不正確 PUB_RepToOneSpace->PUB_RepToOneSpaceX

'清空白
oDL01 = "": oDL02 = "": oDL03 = "": oDL04 = "": oDL05 = "": oDL09 = "": oDL10 = "": oDL12 = "": SeekWhere = ""
ChkDatachg = False
If stUser <> MsgText(601) Then strUserNum = stUser
'end 2017/09/04

'add by nickc 2006/12/29 去除 begin user_data.user_enabled:=1; end;
If InStr(1, UCase(ActSQLStr), UCase("begin user_data.user_enabled")) > 0 Then
    tArr = Split(ActSQLStr, ";")
    'edit by nickc 2007/04/18 因為資料內容會有多個;
    'If UBound(tArr) > 1 Then
        'ActSQLStr = tArr(UBound(tArr) - 2)
        ActSQLStr = ""
        For SQLtmp = 0 To UBound(tArr) - 2
            If InStr(1, UCase(tArr(SQLtmp)), UCase("begin user_data.user_enabled")) = 0 Then
                ActSQLStr = ActSQLStr & tArr(SQLtmp) & ";"
            End If
        Next SQLtmp
        If InStr(1, UCase(tArr(UBound(tArr) - 1)), UCase("end")) = 0 Then
            ActSQLStr = ActSQLStr & tArr(UBound(tArr) - 1) & ";"
        Else
            ActSQLStr = Mid(ActSQLStr, 1, Len(ActSQLStr) - 1)
        End If
        'Debug.Print
    'End If

End If
'設定哪支作用中
'edit by nickc mdimain 改為 screen 2007/02/07
'If mdiMain.ActiveForm Is Nothing Then
If Screen.ActiveForm Is Nothing Then
    oDL12 = ""
'Add by Amy 2025/09/15 +frm140401 拿掉「客戶基本資料維護(修改)(frm140401)」(修改)、(新增)字樣
ElseIf UCase(Screen.ActiveForm.Name) = "FRM140401" Then
   oDL12 = Replace(Replace(Screen.ActiveForm.Caption, "(修改)", ""), "(新增)", "") & "(" & Screen.ActiveForm.Name & ")"
'end 2025/09/15
Else
    'edit by nickc mdimain 改為 screen 2007/02/07
    'oDL12 = mdiMain.ActiveForm.Caption & "(" & mdiMain.ActiveForm.Name & ")"
    oDL12 = Screen.ActiveForm.Caption & "(" & Screen.ActiveForm.Name & ")"
End If
'Added by Lydia 2021/04/27 更新來源的表單名稱 ; (因外專特殊字開啟原始檔維護, form_unload不完整造成記錄來源有問題)
If stFromName <> "" Then
    oDL12 = stFromName
End If
'end 2021/04/27

'先將原本的多個空白修正成一個空白，前面空白也除去，關鍵字轉大寫，連續 2 個'變成一個
tmpStr = PUB_RepToOneSpaceX(PUB_ChgDMLKeyWordToUpper(LTrim(ActSQLStr)))
'add by nickc 2008/02/13  將數值欄位+'
tmpStr = ChgSQLfldToStr(tmpStr, bolUpdWoFunc)
'拆解語法
Select Case Mid(tmpStr, 1, 6)
Case "INSERT"  '新增
      '檢查有無 select
      'edit by nickc 2007/01/03
      'If InStr(1, TmpStr, "SELECT") <> 0 Then   '有 select  因為太多筆，所以不紀錄詳細只紀錄整句
      'Modified by Lydia 2025/10/31 改用模組判斷
      'If InStr(1, tmpStr, "SELECT") <> 0 Or InStr(1, UCase(tmpStr), " IN ") <> 0 Then
      If PUB_FilterSeekSQL(tmpStr) = True Then
         tmpStr = Replace(tmpStr, "''", "'")
         tArr = Split(PUB_RepToOneSpaceX(Replace(Replace(tmpStr, "INSERT", ""), "INTO", "")), "(")
         oDL10 = tArr(0)
         'Modify by Amy 2025/09/19 客戶變更名稱作業 新增客戶檔語法不會解析,故增加傳入 改號前的編號 以利記錄
         oDL05 = ",null"
         'Modified by Lydia 2025/10/30 不限制Table
         'If Trim(UCase(oDL10)) = "CUSTOMER" And Trim(stVal) <> "" Then
         If Trim(UCase(oDL10)) <> "" And Trim(stVal) <> "" Then
            oDL05 = ",'" & stVal & "'"
         End If
         'tmp2SQLStr = "insert into dml_log (dl01,dl02,dl03,dl04,dl05,dl06,dl07,dl08,dl09,dl10,dl11,dl12) select null,null,null,null,null,'" & strUserNum & "',to_number(to_char(sysdate,'YYYYMMDD')),to_number(to_char(sysdate,'HH24MIss')),'" & ChgSQL(tmpStr) & "','" & oDL10 & "','2'," & IIf(oDL12 = "", "null", "'" & ChgSQL(oDL12) & "'") & " from dual"
         tmp2SQLStr = "insert into dml_log (dl01,dl02,dl03,dl04,dl05,dl06,dl07,dl08,dl09,dl10,dl11,dl12) select null,null,null,null" & oDL05 & ",'" & strUserNum & "',to_number(to_char(sysdate,'YYYYMMDD')),to_number(to_char(sysdate,'HH24MIss')),'" & ChgSQL(tmpStr) & "','" & oDL10 & "','2'," & IIf(oDL12 = "", "null", "'" & ChgSQL(oDL12) & "'") & " from dual"
         'end 2025/09/19
         ChkDatachg = True
      Else
         tArr = Split(PUB_RepToOneSpaceX(Replace(Replace(tmpStr, "INSERT", ""), "INTO", "")), "(")
         'Modify By Sindy 2011/9/27
         'If InStr(1, tArr(0), "VALUES") <> 0 Then
         If InStr(1, UCase(tArr(0)), "VALUES") <> 0 Then
            tArr = Split(tArr(0), "VALUES")
            oDL10 = Trim(tArr(0))
            oDL09 = " 新增 " & oDL10 & " 資料；"
            tmp2SQLStr = "insert into dml_log (dl01,dl02,dl03,dl04,dl05,dl06,dl07,dl08,dl09,dl10,dl11,dl12) select null,null,null,null,null,'" & strUserNum & "',to_number(to_char(sysdate,'YYYYMMDD')),to_number(to_char(sysdate,'HH24MIss')),'" & ChgSQL(tmpStr) & "','" & oDL10 & "','2'," & IIf(oDL12 = "", "null", "'" & ChgSQL(oDL12) & "'") & " from dual"
            ChkDatachg = True
         Else
            oDL10 = Trim(tArr(0))
            oDL09 = " 新增 " & oDL10 & " 資料；"
            tArr = Split(PUB_RepToOneSpaceX(Replace(Replace(Replace(tmpStr, "INSERT ", " "), " INTO ", " "), oDL10, " ")), "VALUES")
            tArrF = Split(Replace(Replace(tArr(0), "(", ""), ")", ""), ",")   '欄位
            'edit by nickc 2007/01/03
            'tArrV = Split(Replace(Replace(tArr(1), "(", ""), ")", ""), ",")   '值
            tArrV = SplitValues(tArr(1))

            For tArrTI = 0 To UBound(tArrF)
               'Modify By Sindy 2020/4/16 排除這Table
               If UCase(oDL10) <> "STAFF_WORKPLACE" Then
               '2020/4/16 END
                  '指定本所案號、收文號
                  Select Case UCase(Trim(tArrF(tArrTI)))
                  'Modify By Sindy 2017/8/23 + PI01
                  Case "TM01", "PA01", "LC01", "HC01", "SP01", "CP01", "NP02", "PI01"
                      oDL01 = IIf(Right(Trim(tArrV(tArrTI)), 1) = "'" And Left(Trim(tArrV(tArrTI)), 1) = "'", Mid(Trim(tArrV(tArrTI)), 2, Len(Trim(tArrV(tArrTI))) - 2), Trim(tArrV(tArrTI)))
                  'Modify By Sindy 2017/8/23 + PI02
                  Case "TM02", "PA02", "LC02", "HC02", "SP02", "CP02", "NP03", "PI02"
                      oDL02 = IIf(Right(Trim(tArrV(tArrTI)), 1) = "'" And Left(Trim(tArrV(tArrTI)), 1) = "'", Mid(Trim(tArrV(tArrTI)), 2, Len(Trim(tArrV(tArrTI))) - 2), Trim(tArrV(tArrTI)))
                  'Modify By Sindy 2017/8/23 + PI03
                  Case "TM03", "PA03", "LC03", "HC03", "SP03", "CP03", "NP04", "PI03"
                      oDL03 = IIf(Right(Trim(tArrV(tArrTI)), 1) = "'" And Left(Trim(tArrV(tArrTI)), 1) = "'", Mid(Trim(tArrV(tArrTI)), 2, Len(Trim(tArrV(tArrTI))) - 2), Trim(tArrV(tArrTI)))
                  'Modify By Sindy 2017/8/23 + PI04
                  Case "TM04", "PA04", "LC04", "HC04", "SP04", "CP04", "NP05", "PI04"
                      oDL04 = IIf(Right(Trim(tArrV(tArrTI)), 1) = "'" And Left(Trim(tArrV(tArrTI)), 1) = "'", Mid(Trim(tArrV(tArrTI)), 2, Len(Trim(tArrV(tArrTI))) - 2), Trim(tArrV(tArrTI)))
                  'Add By Sindy 2011/8/11 +CDP01
                  'Add By Sindy 2011/8/23 +, "SB10", "SO13", "SA09"
                  'Add by Amy 2014/09/09 +EV01
                  'Add by Sindy 2015/12/3 +CP140,F0301
                  'Add by Amy 2017/12/07 +LP01
                  'Add by Sindy 2018/10/26 +EEP01
                  'Add by Amy 2025/09/15 +CU01,FA01,PCC01,POC01,PCU01,OCU01
                  Case "CP09", "NP01", "CDP01", "SB10", "SO13", "SA09", "EV01", "CP140", "F0301", "LP01", "EEP01", "CU01", "FA01", "PCC01", "POC01", "PCU01", "OCU01"
                      oDL05 = IIf(Right(Trim(tArrV(tArrTI)), 1) = "'" And Left(Trim(tArrV(tArrTI)), 1) = "'", Mid(Trim(tArrV(tArrTI)), 2, Len(Trim(tArrV(tArrTI))) - 2), Trim(tArrV(tArrTI)))
                  'Add by Amy 2025/09/15 +客戶/代理人/潛在客戶 相關欄位
                  Case "CU02", "FA02", "PCC02", "POC02", "PCU02"
                      'Mark by Amy 2025/09/19 編號改只記錄8碼-秀玲
   '                   'Modify by Amy 2025/09/15  POTCUSTCONT 資料表,記錄PCC01,並補滿9碼
   '                   If Trim(UCase(oDL10)) = "POTCUSTCONT" And Len(oDL05) < 9 Then
   '                     oDL05 = GetNewFagent(oDL05)
   '                   Else
   '                     oDL05 = oDL05 & IIf(Right(Trim(tArrV(tArrTI)), 1) = "'" And Left(Trim(tArrV(tArrTI)), 1) = "'", Mid(Trim(tArrV(tArrTI)), 2, Len(Trim(tArrV(tArrTI))) - 2), Trim(tArrV(tArrTI)))
   '                   End If
                  Case Else
                  End Select
               End If
               
               'Add by Amy 2014/09/09 補足 , 若是只有收文號, 則再讀取一次, 補本所案號
               'Modified by Lydia 2025/07/22 +stDefCP09
               'Modify by Amy 2025/09/15 +不是 客戶/代理人/潛在客戶 編號
               'Modified by Lydia 2025/10/30 拿掉stDefCP09，併入stVal 傳入值
               If Trim(oDL01 & oDL02 & oDL03 & oDL04) = "" And Trim(oDL05) <> "" _
                 And Left(Trim(oDL05), 1) <> 客戶編號 And Left(Trim(oDL05), 1) <> 代理人編號 And Left(Trim(oDL05), 1) <> "R" Then
                  Set tmpSelRs = New ADODB.Recordset
                  If tmpSelRs.State = 1 Then tmpSelRs.Close
                  tmpSelRs.CursorLocation = adUseClient
                  'Modified by Lydia 2025/07/22 判斷傳入收文號 oDL05=> IIf(Trim(oDL05) <> "", oDL05, stDefCP09); +CP09
                  'Modified by Lydia 2025/10/30 拿掉stDefCP09，併入stVal 傳入值
                  tmpSelRs.Open "select cp01,cp02,cp03,cp04,cp09 from caseprogress where cp09='" & IIf(Trim(oDL05) <> "", oDL05, stVal) & "' ", cnnConnection, adOpenStatic, adLockReadOnly
                  If tmpSelRs.RecordCount <> 0 Then
                      oDL01 = CheckStr(tmpSelRs.Fields("cp01").Value)
                      oDL02 = CheckStr(tmpSelRs.Fields("cp02").Value)
                      oDL03 = CheckStr(tmpSelRs.Fields("cp03").Value)
                      oDL04 = CheckStr(tmpSelRs.Fields("cp04").Value)
                      oDL05 = CheckStr(tmpSelRs.Fields("cp09").Value) 'Added by Lydia 2025/07/22
                  End If
               End If
               'end 2014/09/09
               oDL09 = oDL09 & tArrF(tArrTI) & "=>" & IIf(Right(Trim(tArrV(tArrTI)), 1) = "'" And Left(Trim(tArrV(tArrTI)), 1) = "'", Replace(Mid(Trim(tArrV(tArrTI)), 2, Len(Trim(tArrV(tArrTI))) - 2), "''", "'"), Replace(Trim(tArrV(tArrTI)), "''", "'")) & ";"
            Next tArrTI
            'Added by Lydia 2025/10/30 oDL05為空值時,以傳入之變數更新DL05
            If Trim(UCase(oDL10)) <> "" And Trim(oDL05) = "" And Trim(stVal) <> "" Then
               oDL05 = stVal
            End If
            'end 2025/10/30
            ChkDatachg = True
            tmp2SQLStr = "insert into dml_log (dl01,dl02,dl03,dl04,dl05,dl06,dl07,dl08,dl09,dl10,dl11,dl12) select '" & ChgSQL(oDL01) & "','" & ChgSQL(oDL02) & "','" & ChgSQL(oDL03) & "','" & ChgSQL(oDL04) & "','" & ChgSQL(oDL05) & "','" & strUserNum & "',to_number(to_char(sysdate,'YYYYMMDD')),to_number(to_char(sysdate,'HH24MIss')),'" & ChgSQL(oDL09) & "','" & oDL10 & "','1'," & IIf(oDL12 = "", "null", "'" & ChgSQL(oDL12) & "'") & " from dual "
         End If  'If InStr(1, UCase(tArr(0)), "VALUES") <> 0 Then
      End If   ''檢查有無 select
Case "UPDATE"  '修改
      'Add by Amy 2025/09/15 客戶檔更新下一程序時語法中 strNpSqlOfNoSalesDuty 有 IN字樣,導致未解析而不會寫入案號及總收文號
      If InStr(1, UCase(tmpStr), "UPDATE NEXTPROGRESS ") > 0 And InStr(1, tmpStr, "SELECT") = 0 And InStr(1, UCase(tmpStr), UCase(strNpSqlOfNoSalesDuty)) > 0 Then
         bolDesc = True
      End If
      '檢查有無 select
      'edit by nickc 2007/01/03
      'If InStr(1, TmpStr, "SELECT") <> 0 Then   '有 select  因為太多筆，所以不紀錄詳細只紀錄整句
      'Modified by Lydia 2018/10/18 FCP-59244因為案件英文名稱有IN,造成命名修改基本檔的記錄無法完整
      'If InStr(1, tmpStr, "SELECT") <> 0 Or InStr(1, UCase(tmpStr), " IN ") <> 0 Then
      'Modified by Lydia 2025/10/31 改用模組判斷
      'If bolDesc = False And (InStr(1, tmpStr, "SELECT") <> 0 Or InStr(1, UCase(tmpStr), " IN ") <> 0) Then
      If bolDesc = False And PUB_FilterSeekSQL(tmpStr) = True Then
         tmpStr = Replace(tmpStr, "''", "'")
         tArr = Split(PUB_RepToOneSpaceX(Replace(tmpStr, "UPDATE", "")), "SET")
         oDL10 = tArr(0)
         tmp2SQLStr = "insert into dml_log (dl01,dl02,dl03,dl04,dl05,dl06,dl07,dl08,dl09,dl10,dl11,dl12) select null,null,null,null,null,'" & strUserNum & "',to_number(to_char(sysdate,'YYYYMMDD')),to_number(to_char(sysdate,'HH24MIss')),'" & ChgSQL(tmpStr) & "','" & oDL10 & "','2'," & IIf(oDL12 = "", "null", "'" & ChgSQL(oDL12) & "'") & " from dual"
         ChkDatachg = True
      Else
         tArr = Split(PUB_RepToOneSpaceX(Replace(tmpStr, "UPDATE", "")), "SET")
         oDL10 = Trim(tArr(0))
         '2012/7/26 modify by sonia FCP-038067案件名稱有WHERE字樣,故"WHERE"改為" WHERE "
         If InStr(1, tmpStr, " WHERE ") <> 0 Then
            'Add by Amy 2025/09/15 +if 下一程序有strNpSqlOfNoSalesDuty字樣
            If Trim(UCase(oDL10)) = "NEXTPROGRESS" And bolDesc = True And InStr(1, UCase(tmpStr), UCase(strNpSqlOfNoSalesDuty)) > 0 Then
               'strNpSqlOfNoSalesDuty字樣中有np07='6001',避免抓錯NP07 故取代為空不解析
               tArr = Split(PUB_RepToOneSpaceX(Replace(UCase(Replace(tmpStr, "UPDATE", "")), UCase(strNpSqlOfNoSalesDuty), "")), " WHERE ")
            Else
               tArr = Split(PUB_RepToOneSpaceX(Replace(tmpStr, "UPDATE", "")), " WHERE ")
            End If
            tArrV = Split(tArr(1), "AND")    'where 後面的條件 將條件歸類
            For tArrTI = 0 To UBound(tArrV)
                'edit by nickc 2007/09/27
                If InStr(1, tArrV(tArrTI), "=") <> 0 Then
                    tArrF = Split(tArrV(tArrTI), "=")
                    
                    'Modify By Sindy 2020/4/16 排除這Table
                    'Modify By Sindy 2021/1/28 + PATENTINPUT
                    If UCase(oDL10) <> "STAFF_WORKPLACE" And UCase(oDL10) <> "PATENTINPUT" Then
                    '2020/4/16 END
                      '指定本所案號、收文號
                      Select Case UCase(Trim(tArrF(0)))
                      'Modify By Sindy 2017/8/23 + PI01
                      Case "TM01", "PA01", "LC01", "HC01", "SP01", "CP01", "NP02", "PI01"
                          oDL01 = IIf(Right(Trim(tArrF(1)), 1) = "'" And Left(Trim(tArrF(1)), 1) = "'", Mid(Trim(tArrF(1)), 2, Len(Trim(tArrF(1))) - 2), Trim(tArrF(1)))
                     'Modify By Sindy 2017/8/23 + PI02
                      Case "TM02", "PA02", "LC02", "HC02", "SP02", "CP02", "NP03", "PI02"
                          oDL02 = IIf(Right(Trim(tArrF(1)), 1) = "'" And Left(Trim(tArrF(1)), 1) = "'", Mid(Trim(tArrF(1)), 2, Len(Trim(tArrF(1))) - 2), Trim(tArrF(1)))
                      'Modify By Sindy 2017/8/23 + PI03
                      Case "TM03", "PA03", "LC03", "HC03", "SP03", "CP03", "NP04", "PI03"
                          oDL03 = IIf(Right(Trim(tArrF(1)), 1) = "'" And Left(Trim(tArrF(1)), 1) = "'", Mid(Trim(tArrF(1)), 2, Len(Trim(tArrF(1))) - 2), Trim(tArrF(1)))
                      'Modify By Sindy 2017/8/23 + PI04
                      Case "TM04", "PA04", "LC04", "HC04", "SP04", "CP04", "NP05", "PI04"
                          oDL04 = IIf(Right(Trim(tArrF(1)), 1) = "'" And Left(Trim(tArrF(1)), 1) = "'", Mid(Trim(tArrF(1)), 2, Len(Trim(tArrF(1))) - 2), Trim(tArrF(1)))
                      'Add By Sindy 2011/8/11 +CDP01
                      'Add By Sindy 2011/8/23 +, "SB10", "SO13", "SA09"
                      'Add by Amy 2014/09/09 +EV01
                      'Add by Sindy 2015/12/3 +CP140,F0301
                      'Add by Amy 2017/12/07 +LP01
                      'Add by Sindy 2018/8/27 +EEP01
                      'Add by Amy 2024/10/04 +ti02
                      'Add by Amy 2025/09/15 +CU01,FA01,PCC01,POC01,PCU01,OCU01
                      Case "CP09", "NP01", "CDP01", "SB10", "SO13", "SA09", "EV01", "CP140", "F0301", "LP01", "EEP01", "TI02", "CU01", "FA01", "PCC01", "POC01", "PCU01", "OCU01"
                          'Modify by Amy 2025/09/15 +if 客戶檔進入且修改 FAGENT 資料表,則記錄 客戶編號
                          If UCase(TypeName(Screen.ActiveForm)) = "FRM140401" And Trim(UCase(oDL10)) = "FAGENT" And Trim(stVal) <> "" Then
                              oDL05 = stVal
                          Else
                              oDL05 = IIf(Right(Trim(tArrF(1)), 1) = "'" And Left(Trim(tArrF(1)), 1) = "'", Mid(Trim(tArrF(1)), 2, Len(Trim(tArrF(1))) - 2), Trim(tArrF(1)))
                          End If
                      'Add by Amy 2025/09/15 +客戶/代理人/潛在客戶 相關欄位及下一程序欄位
                      Case "CU02", "FA02", "PCC02", "POC02", "PCU02"
                          'Mark by Amy 2025/09/19 編號改只記錄8碼-秀玲
'                          '客戶檔進入且修改 FAGENT 資料表,則記錄 客戶編號-stVal
'                          If UCase(TypeName(Screen.ActiveForm)) = "FRM140401" And Trim(UCase(oDL10)) = "FAGENT" And Trim(stVal) <> "" Then
'                          'POTCUSTCONT 資料表,記錄PCC01,並補滿9碼
'                          ElseIf Trim(UCase(oDL10)) = "POTCUSTCONT" And Len(oDL05) < 9 Then
'                              oDL05 = GetNewFagent(oDL05)
'                          Else
'                              oDL05 = oDL05 & IIf(Right(Trim(tArrF(1)), 1) = "'" And Left(Trim(tArrF(1)), 1) = "'", Mid(Trim(tArrF(1)), 2, Len(Trim(tArrF(1))) - 2), Trim(tArrF(1)))
'                           End If
                      Case "NP07"
                           'strNpSqlOfNoSalesDuty字樣中有np07='6001',不確定是否有其他狀況,抓第一次出現的NP07
                           If m_NP07 = "" Then
                              m_NP07 = IIf(Right(Trim(tArrF(1)), 1) = "'" And Left(Trim(tArrF(1)), 1) = "'", Mid(Trim(tArrF(1)), 2, Len(Trim(tArrF(1))) - 2), Trim(tArrF(1)))
                           End If
                      Case "NP22"
                           '不確定是否有像NP07狀況,故抓第一次出現的NP22
                           If m_NP22 = "" Then
                              m_NP22 = IIf(Right(Trim(tArrF(1)), 1) = "'" And Left(Trim(tArrF(1)), 1) = "'", Mid(Trim(tArrF(1)), 2, Len(Trim(tArrF(1))) - 2), Trim(tArrF(1)))
                           End If
                      'end 2025/09/15
                      Case Else
                      End Select
                    End If
                  
                  'Modify by Morgan 2009/6/12 一位數字的欄位會錯
                  'SeekWhere = SeekWhere & Trim(tArrF(0)) & "=>" & IIf(Right(Trim(tArrF(1)), 1) = "'" And Left(Trim(tArrF(1)), 1) = "'", Mid(Trim(tArrF(1)), 2, Len(Trim(tArrF(1))) - 2), Trim(tArrF(1))) & IIf(tArrTI < UBound(tArrV), ",", "")
                  If Right(Trim(tArrF(1)), 1) = "'" And Left(Trim(tArrF(1)), 1) = "'" Then
                     SeekWhere = SeekWhere & Trim(tArrF(0)) & "=>" & Mid(Trim(tArrF(1)), 2, Len(Trim(tArrF(1))) - 2) & IIf(tArrTI < UBound(tArrV), ",", "")
                  Else
                     SeekWhere = SeekWhere & Trim(tArrF(0)) & "=>" & Trim(tArrF(1)) & IIf(tArrTI < UBound(tArrV), ",", "")
                  End If
                Else
                    SeekWhere = SeekWhere & tArrV(tArrTI) & ","
                End If
            Next tArrTI
            'Add by Amy 2025/09/15 客戶檔更新下一程序時語法中 strNpSqlOfNoSalesDuty 不解析,直接加變數名-與秀玲討論後
            If InStr(1, UCase(tmpStr), "UPDATE NEXTPROGRESS ") > 0 And bolDesc = True Then
               SeekWhere = SeekWhere & IIf(Right(SeekWhere, 1) <> ",", ",strNpSqlOfNoSalesDuty", "strNpSqlOfNoSalesDuty")
            End If
            
            'Add by Amy 2025/09/15 補足,本所案號 下一程序資料(寫法同DELETE) ex:NP01=C94010860,NP22=329979 有2筆資料,故傳 NP07
            If Trim(UCase(oDL10)) = "NEXTPROGRESS" And Trim(m_NP22) <> "" And (Trim(oDL01 & oDL02 & oDL03 & oDL04) = "" Or Trim(oDL05) = "") Then
                stQ = ""
               If Trim(oDL05) <> "" Then stQ = "And np01='" & Trim(oDL05) & "'"
               If Trim(m_NP07) <> "" Then stQ = stQ & "And np07='" & Trim(m_NP07) & "'"
               If Trim(m_NP22) <> "" Then stQ = stQ & "And np22=" & Trim(m_NP22) & " "
               'NP22 可能有2筆資料 ex:NP22=1023803 FCP/CFP 案號
               If Trim(oDL01 & oDL02 & oDL03 & oDL04) <> "" Then
                  stQ = stQ & "And np02='" & Trim(oDL01) & "' And np03='" & Trim(oDL02) & "' And np04='" & Trim(oDL03) & "' And np05='" & Trim(oDL04) & "'"
               End If
               stTmp = Pub_GetField("NextProgress", Mid(stQ, 5), "np02||';'||np03||';'||np04||';'||np05||';'||np01")
               If stTmp <> "" Then
                  arrTmp = Split(stTmp, ";")
                  If oDL01 = "" Then oDL01 = arrTmp(0)
                  If oDL02 = "" Then oDL02 = arrTmp(1)
                  If oDL03 = "" Then oDL03 = arrTmp(2)
                  If oDL04 = "" Then oDL04 = arrTmp(3)
                  If oDL05 = "" Then oDL05 = arrTmp(4)
               End If
            '補足，若是只有收文號，則再讀取一次，補本所案號
            'Modified by Lydia 2025/07/22 +stDefCP09
            'Modify by Amy 2025/09/15 +不是 客戶/代理人/潛在客戶 編號
            'Modified by Lydia 2025/10/30 拿掉stDefCP09，併入stVal 傳入值
            ElseIf Trim(oDL01 & oDL02 & oDL03 & oDL04) = "" And Trim(oDL05) <> "" _
              And Left(Trim(oDL05), 1) <> 客戶編號 And Left(Trim(oDL05), 1) <> 代理人編號 And Left(Trim(oDL05), 1) <> "R" Then
               Set tmpSelRs = New ADODB.Recordset
               If tmpSelRs.State = 1 Then tmpSelRs.Close
               tmpSelRs.CursorLocation = adUseClient
               'Modified by Lydia 2025/07/22 判斷傳入收文號 oDL05=> IIf(Trim(oDL05) <> "", oDL05, stDefCP09); +CP09
               'Modified by Lydia 2025/10/30 拿掉stDefCP09，併入stVal 傳入值
               tmpSelRs.Open "select cp01,cp02,cp03,cp04,cp09 from caseprogress where cp09='" & IIf(Trim(oDL05) <> "", oDL05, stVal) & "' ", cnnConnection, adOpenStatic, adLockReadOnly
               If tmpSelRs.RecordCount <> 0 Then
                   oDL01 = CheckStr(tmpSelRs.Fields("cp01").Value)
                   oDL02 = CheckStr(tmpSelRs.Fields("cp02").Value)
                   oDL03 = CheckStr(tmpSelRs.Fields("cp03").Value)
                   oDL04 = CheckStr(tmpSelRs.Fields("cp04").Value)
                   oDL05 = CheckStr(tmpSelRs.Fields("cp09").Value) 'Added by Lydia 2025/07/22
               End If
            End If
         End If
         oDL09 = " 修改 " & oDL10 & " " & IIf(SeekWhere <> "", "，條件 " & SeekWhere & " 資料", "") & "；"
         '儲存原始 where 後面語法
         '2012/7/26 modify by sonia FCP-038067案件名稱有WHERE字樣,故"WHERE"改為" WHERE "
         If InStr(1, tmpStr, " WHERE ") <> 0 Then
            If Trim(tArr(1)) <> "" Then
               SeekWhere = tArr(1)
            Else
               SeekWhere = ""
            End If
         End If
         tArr = Split(PUB_RepToOneSpaceX(Replace(tmpStr, "UPDATE", "")), " WHERE ")
         tmpUpdateFileds = PUB_ChgUpFd(PUB_RepToOneSpaceX(Replace(Replace(Replace(tArr(0), "UPDATE ", " "), " SET ", " "), oDL10, "")), bolUpdWoFunc)
         tArr = Split(tmpUpdateFileds, vbCrLf & Chr(8))
         'Modified by Lydia 2023/04/18 排除非英文的欄位
         'tmpSelData = "select "
         'For tArrTI = 0 To UBound(tArr)
         '   tArrF = Split(tArr(tArrTI), "=")   '更新的欄位
         '   tmpSelData = tmpSelData & tArrF(0) & IIf(tArrTI < UBound(tArr), ",", "")
         'Next tArrTI
         tmpSelData = ""
         For tArrTI = 0 To UBound(tArr)
            tArrF = Split(tArr(tArrTI), "=")   '更新的欄位
            tmp2SQLStr = PUB_GetSimpleName("" & tArrF(0), True) '名稱只留英數字含空白
            If tmp2SQLStr = "" & tArrF(0) And InStr(LTrim(RTrim(tmp2SQLStr)), " ") = 0 Then '排除中間有空白
               tmpSelData = tmpSelData & "," & tArrF(0)
               '重組語法
               strNewUpd = strNewUpd & IIf(strNewUpd <> "", vbCrLf & Chr(8), "") & "," & tArrF(0)
               If UBound(tArrF) > 0 Then
                  For intU = 1 To UBound(tArrF)
                      If intU = 1 Then
                         strNewUpd = strNewUpd & " = " & tArrF(intU)
                      Else
                         strNewUpd = strNewUpd & "=" & tArrF(intU)
                      End If
                  Next intU
               End If
            Else
               strNewUpd = strNewUpd & "," & tArr(tArrTI)  '重組語法
            End If
         Next tArrTI
         tmpSelData = "select " & Mid(tmpSelData, 2)
         'end 2023/04/18
         
         'Add by Amy 2025/09/15 客戶檔更新下一程序時語法中 strNpSqlOfNoSalesDuty 不解析,直接加變數名-與秀玲討論後
         If InStr(1, UCase(tmpStr), "UPDATE NEXTPROGRESS ") > 0 And bolDesc = True Then
            SeekWhere = SeekWhere & strNpSqlOfNoSalesDuty
         End If
         'end 2025/09/15
         
         tmpSelData = tmpSelData & " from " & oDL10 & IIf(SeekWhere <> "", " where " & SeekWhere, "")
         'Added by Lydia 2016/04/13 保留Acc220歷史記錄(依據台銀水單的需求保留)
         If InStr(UCase(ActSQLStr), "ACC220") > 0 And InStr(UCase(ActSQLStr), "UPDATEDATE") > 0 Then
            tmpSelData = Mid(tmpSelData, 1, InStr(UCase(tmpSelData), "AND UPDATEDATE") - 1)
         End If
         'end 2016/04/13
         Set tmpSelRs = New ADODB.Recordset
         If tmpSelRs.State = 1 Then tmpSelRs.Close
         tmpSelRs.CursorLocation = adUseClient
         tmpSelRs.Open tmpSelData, cnnConnection, adOpenStatic, adLockReadOnly
         If tmpSelRs.RecordCount <> 0 Then
             tArr = Split(strNewUpd, vbCrLf & Chr(8)) 'Added by Lydia 2023/04/18 改成判斷過英文欄位的語法
             For tArrTI = 0 To UBound(tArr)
                'edit by nickc 2007/09/27
                If InStr(1, tArr(tArrTI), "=") <> 0 Then
                    'Modified by Lydia 2023/04/18 去掉開頭,+MID
                     tArrF = Split(Mid(tArr(tArrTI), 2), "=")
                    'edit by nickc 修正 2006/06/08
                    tArrF(1) = Trim(tArrF(1))
                    'Added by Lydia 2016/12/28 檢查更新內容是否有"=",造成分割成多筆
                    If UBound(tArrF) > 1 Then
                       For SQLtmp = 2 To UBound(tArrF)
                          If Trim(tArrF(SQLtmp)) <> "" Then
                             tArrF(1) = tArrF(1) & "=" & tArrF(SQLtmp)
                          End If
                       Next SQLtmp
                    End If
                    'end 2016/12/28
                    'Add by Amy 2025/09/15 客戶基本檔更新下一程序時,判斷有執行才寫log,故此時抓的資料已是改後的資料
                    If InStr(1, UCase(tmpStr), "UPDATE NEXTPROGRESS ") > 0 And bolDesc = True And stVal <> "" Then
                        stOldData = stVal
                    Else
                        stOldData = CheckStr(tmpSelRs.Fields(Trim(tArrF(0))).Value)
                    End If
                    'end 2025/09/15
                    
                    If Right(tArrF(1), 1) = "'" Then tArrF(1) = Mid(tArrF(1), 1, Len(tArrF(1)) - 1)
                    If Left(tArrF(1), 1) = "'" Then tArrF(1) = Mid(tArrF(1), 2)
                    tArrF(1) = Replace(tArrF(1), "''", "'")
                    If IsNull(tmpSelRs.Fields(Trim(tArrF(0))).Value) = True And UCase((tArrF(1))) = "NULL" Then
                    'Modify by Amy 2025/09/15 改抓 stOldData ,客戶基本檔更新下一程序時,判斷有執行才寫log,故此時抓的資料已是改後的資料
                    'ElseIf Trim(CheckStr(tmpSelRs.Fields(Trim(tArrF(0))).Value)) <> Trim((tArrF(1))) Then
                    'Modify By Sindy 2025/9/18 + UCase 比較,內容一樣
                    'stOldData=Process for the preparation of ethylene glycol from sugars
                    ' tArrF(1)=Process for the preparation of ethylene glycol FROM sugars
                    ElseIf UCase(Trim(stOldData)) <> UCase(Trim((tArrF(1)))) Then
                        ChkDatachg = True
                        'Modify by Amy 2016/06/28 +if 客戶基本資料維護及個人客戶資料修改最後一個資料列也顯示];
                        'oDL09 = oDL09 & Trim(tArrF(0)) & "[" & CheckStr(tmpSelRs.Fields(Trim(tArrF(0))).Value) & "=>" & LTrim(tArrF(1)) & "]" & IIf(tArrTI < UBound(tArr), ";", "")
                        If InStr(UCase(oDL12), "FRM140401") > 0 Or InStr(UCase(oDL12), "FRM210101_1") > 0 Then
                            'oDL09 = oDL09 & Trim(tArrF(0)) & "[" & CheckStr(tmpSelRs.Fields(Trim(tArrF(0))).Value) & "=>" & LTrim(tArrF(1)) & "];"
                            oDL09 = oDL09 & Trim(tArrF(0)) & "[" & stOldData & "=>" & LTrim(tArrF(1)) & "];"
                        Else
                            'oDL09 = oDL09 & Trim(tArrF(0)) & "[" & CheckStr(tmpSelRs.Fields(Trim(tArrF(0))).Value) & "=>" & LTrim(tArrF(1)) & "]" & IIf(tArrTI < UBound(tArr), ";", "")
                            oDL09 = oDL09 & Trim(tArrF(0)) & "[" & stOldData & "=>" & LTrim(tArrF(1)) & "]" & IIf(tArrTI < UBound(tArr), ";", "")
                        End If
                    'end 2025/09/15
                    End If
                Else
                    oDL09 = oDL09 & tArrV(tArrTI) & ","
                End If
            Next tArrTI
         End If
         'Add by Amy 2025/09/24 更新CUSTOMER TB,條件未有cu01資料者(oDL05為空值)時,以傳入之變數更新DL05
         'Modified by Lydia 2025/10/30 不限制Table
         'If Trim(UCase(oDL10)) = "CUSTOMER" And Trim(oDL05) = "" And Trim(stVal) <> "" Then
         If Trim(UCase(oDL10)) <> "" And Trim(oDL05) = "" And Trim(stVal) <> "" Then
            oDL05 = stVal
         End If
         'end 2025/09/24
         If ChkDatachg = True Then
            tmp2SQLStr = "insert into dml_log (dl01,dl02,dl03,dl04,dl05,dl06,dl07,dl08,dl09,dl10,dl11,dl12) select '" & ChgSQL(oDL01) & "','" & ChgSQL(oDL02) & "','" & ChgSQL(oDL03) & "','" & ChgSQL(oDL04) & "','" & ChgSQL(oDL05) & "','" & strUserNum & "',to_number(to_char(sysdate,'YYYYMMDD')),to_number(to_char(sysdate,'HH24MIss')),'" & ChgSQL(oDL09) & "','" & oDL10 & "','1'," & IIf(oDL12 = "", "null", "'" & ChgSQL(oDL12) & "'") & " from dual "
         End If
      End If  '檢查有無 select
Case "DELETE"  '刪除
      '檢查有無 select
      'edit by nickc 2007/01/03
      'If InStr(1, TmpStr, "SELECT") <> 0 Then   '有 select  因為太多筆，所以不紀錄詳細只紀錄整句
      'Memo by Amy 2025/09/19 20250915改成 由客戶檔維護進入者且有執行才寫log(語法無 IN 字樣),後來發現於下方可判斷是否有執行,故改回原寫法
      stTmp = Replace(Mid(tmpStr, 1, InStr(1, tmpStr, " WHERE ") - 1), "DELETE FROM ", "")
      'Modified by Lydia 2025/10/31 改用模組判斷
      'If InStr(1, tmpStr, "SELECT") <> 0 Or InStr(1, UCase(tmpStr), " IN ") <> 0 Then
      If PUB_FilterSeekSQL(tmpStr) = True Then
         tmpStr = Replace(tmpStr, "''", "'")
         'Modify by Amy 2025/09/15 第1個字不可以為空白,否則抓不到Table(oDL10)
         'tArr = Split(PUB_RepToOneSpaceX(Replace(Replace(tmpStr, "DELETE", ""), "FROM", "")), " ")
         tArr = Split(LTrim(PUB_RepToOneSpaceX(Replace(Replace(tmpStr, "DELETE", ""), "FROM", ""))), " ")
         oDL10 = tArr(0)
         'Modify by Amy 2025/09/15 由客戶檔維護且不是刪Customer TB,記錄客戶編號及筆數
         '  ex:Delete From INVENTOR Where IN01 in (Select cu01 From Customer Where cu01='客戶編號')
         oDL05 = ",null"
         oDL09 = tmpStr
         'Modify by Amy 2025/09/15 +if 由客戶檔維護進入且不是刪Customer TB,有執行才寫log,資料已更新無法抓原使資料解析,故只寫語法
         '  秀玲:都會先查無資料才會刪客戶資料,所以可以只寫語法,並記錄筆數即可
         If UCase(TypeName(Screen.ActiveForm)) = "FRM140401" And Trim(UCase(oDL10)) <> "CUSTOMER" And stVal <> "" Then
            tArrV = Split(stVal, ";")
            oDL05 = ",'" & tArrV(0) & "'"
            oDL09 = oDL09 & "共計" & tArrV(1) & "筆"
         End If
         'tmp2SQLStr = "insert into dml_log (dl01,dl02,dl03,dl04,dl05,dl06,dl07,dl08,dl09,dl10,dl11,dl12) select null,null,null,null,null,'" & strUserNum & "',to_number(to_char(sysdate,'YYYYMMDD')),to_number(to_char(sysdate,'HH24MIss')),'" & ChgSQL(tmpStr) & "','" & oDL10 & "','2'," & IIf(oDL12 = "", "null", "'" & ChgSQL(oDL12) & "'") & " from dual"
         tmp2SQLStr = "insert into dml_log (dl01,dl02,dl03,dl04,dl05,dl06,dl07,dl08,dl09,dl10,dl11,dl12) select null,null,null,null" & oDL05 & ",'" & strUserNum & "',to_number(to_char(sysdate,'YYYYMMDD')),to_number(to_char(sysdate,'HH24MIss')),'" & ChgSQL(oDL09) & "','" & oDL10 & "','2'," & IIf(oDL12 = "", "null", "'" & ChgSQL(oDL12) & "'") & " from dual"
         'end 2025/09/15
         ChkDatachg = True
      Else
         '2012/7/26 modify by sonia FCP-038067案件名稱有WHERE字樣,故"WHERE"改為" WHERE "
         tArr = Split(PUB_RepToOneSpaceX(Replace(Replace(Replace(tmpStr, "DELETE ", " "), " FROM ", " "), " ALIAS ", " ")), " WHERE ")
         oDL10 = Trim(tArr(0))
         If InStr(1, tmpStr, " WHERE ") <> 0 Then
            tArr = Split(PUB_RepToOneSpaceX(Replace(Replace(Replace(tmpStr, "UPDATE ", " "), " FROM ", " "), " ALIAS ", " ")), " WHERE ")
            tArrV = Split(tArr(1), "AND")    'where 後面的條件 將條件歸類
            For tArrTI = 0 To UBound(tArrV)
                'edit by nickc 2007/09/27
                If InStr(1, tArrV(tArrTI), "=") <> 0 Then
                    tArrF = Split(tArrV(tArrTI), "=")
                    '指定本所案號、收文號
                    Select Case UCase(Trim(tArrF(0)))
                    'Modify By Sindy 2017/8/23 + PI01
                    Case "TM01", "PA01", "LC01", "HC01", "SP01", "CP01", "NP02", "PI01"
                        oDL01 = IIf(Right(Trim(tArrF(1)), 1) = "'" And Left(Trim(tArrF(1)), 1) = "'", Mid(Trim(tArrF(1)), 2, Len(Trim(tArrF(1))) - 2), Trim(tArrF(1)))
                    'Modify By Sindy 2017/8/23 + PI02
                    Case "TM02", "PA02", "LC02", "HC02", "SP02", "CP02", "NP03", "PI02"
                        oDL02 = IIf(Right(Trim(tArrF(1)), 1) = "'" And Left(Trim(tArrF(1)), 1) = "'", Mid(Trim(tArrF(1)), 2, Len(Trim(tArrF(1))) - 2), Trim(tArrF(1)))
                    'Modify By Sindy 2017/8/23 + PI03
                    Case "TM03", "PA03", "LC03", "HC03", "SP03", "CP03", "NP04", "PI03"
                        oDL03 = IIf(Right(Trim(tArrF(1)), 1) = "'" And Left(Trim(tArrF(1)), 1) = "'", Mid(Trim(tArrF(1)), 2, Len(Trim(tArrF(1))) - 2), Trim(tArrF(1)))
                    'Modify By Sindy 2017/8/23 + PI04
                    Case "TM04", "PA04", "LC04", "HC04", "SP04", "CP04", "NP05", "PI04"
                        oDL04 = IIf(Right(Trim(tArrF(1)), 1) = "'" And Left(Trim(tArrF(1)), 1) = "'", Mid(Trim(tArrF(1)), 2, Len(Trim(tArrF(1))) - 2), Trim(tArrF(1)))
                    'Add By Sindy 2011/8/11 +CDP01
                    'Add By Sindy 2011/8/23 +, "SB10", "SO13", "SA09"
                    'Add by Amy 2014/09/09 +EV01
                    'Add by Sindy 2015/12/3 +CP140,F0301
                    'Add by Amy 2017/12/07 +LP01
                    'Add by Sindy 2018/8/27 +EEP01
                    'Add by Amy 2022/06/20 +TI02
                    'Add by Amy 2025/09/15 +CU01,FA01,PCC01,POC01,PCU01,OCU01
                    Case "CP09", "NP01", "CDP01", "SB10", "SO13", "SA09", "EV01", "CP140", "F0301", "LP01", "EEP01", "TI02", "CU01", "FA01", "PCC01", "POC01", "PCU01", "OCU01"
                        oDL05 = IIf(Right(Trim(tArrF(1)), 1) = "'" And Left(Trim(tArrF(1)), 1) = "'", Mid(Trim(tArrF(1)), 2, Len(Trim(tArrF(1))) - 2), Trim(tArrF(1)))
                    'Add by Amy 2025/09/15 客戶/代理人/潛在客戶 相關欄位及下一程序欄位
                    Case "CU02", "FA02", "PCC02", "POC02", "PCU02"
                        'Mark by Amy 2025/09/19 編號改只記錄8碼-秀玲
'                        'POTCUSTCONT 資料表,記錄PCC01,並補滿9碼
'                        If Trim(UCase(oDL10)) = "POTCUSTCONT" And Len(oDL05) < 9 Then
'                           oDL05 = GetNewFagent(oDL05)
'                        Else
'                           oDL05 = oDL05 & IIf(Right(Trim(tArrF(1)), 1) = "'" And Left(Trim(tArrF(1)), 1) = "'", Mid(Trim(tArrF(1)), 2, Len(Trim(tArrF(1))) - 2), Trim(tArrF(1)))
'                        End If
                    Case "NP07"
                           m_NP07 = IIf(Right(Trim(tArrF(1)), 1) = "'" And Left(Trim(tArrF(1)), 1) = "'", Mid(Trim(tArrF(1)), 2, Len(Trim(tArrF(1))) - 2), Trim(tArrF(1)))
                      Case "NP22"
                           m_NP22 = IIf(Right(Trim(tArrF(1)), 1) = "'" And Left(Trim(tArrF(1)), 1) = "'", Mid(Trim(tArrF(1)), 2, Len(Trim(tArrF(1))) - 2), Trim(tArrF(1)))
                    'end 2025/09/15
                    Case Else
                    End Select
                     'Modify by Morgan 2009/6/12 一位數字的欄位會錯
                     'SeekWhere = SeekWhere & Trim(tArrF(0)) & "=>" & IIf(Right(Trim(tArrF(1)), 1) = "'" And Left(Trim(tArrF(1)), 1) = "'", Mid(Trim(tArrF(1)), 2, Len(Trim(tArrF(1))) - 2), Trim(tArrF(1))) & IIf(tArrTI < UBound(tArrV), ",", "")
                     If Right(Trim(tArrF(1)), 1) = "'" And Left(Trim(tArrF(1)), 1) = "'" Then
                        SeekWhere = SeekWhere & Trim(tArrF(0)) & "=>" & Mid(Trim(tArrF(1)), 2, Len(Trim(tArrF(1))) - 2) & IIf(tArrTI < UBound(tArrV), ",", "")
                     Else
                        SeekWhere = SeekWhere & Trim(tArrF(0)) & "=>" & Trim(tArrF(1)) & IIf(tArrTI < UBound(tArrV), ",", "")
                    End If
                Else
                    SeekWhere = SeekWhere & tArrV(tArrTI) & ","
                End If
            Next tArrTI
            'Add by Amy 2025/09/15 補足,本所案號 下一程序資料
            '   ex:刪下一程序語法 DELETE FROM NEXTPROGRESS WHERE NP02 = 'CFP' AND NP03 = '035298' AND NP04 = '0' AND NP05 = '00' AND NP22 = 2084375
            If Trim(UCase(oDL10)) = "NEXTPROGRESS" And Trim(m_NP22) <> "" And (Trim(oDL01 & oDL02 & oDL03 & oDL04) = "" Or Trim(oDL05) = "") Then
               stQ = ""
               If Trim(oDL05) <> "" Then stQ = "And np01='" & Trim(oDL05) & "'"
               If Trim(m_NP07) <> "" Then stQ = stQ & "And np07='" & Trim(m_NP07) & "'"
               If Trim(m_NP22) <> "" Then stQ = stQ & "And np22='" & Trim(m_NP22) & "'"
               'NP22 可能有2筆資料 ex:NP22=1023803 FCP/CFP 案號
               If Trim(oDL01 & oDL02 & oDL03 & oDL04) <> "" Then
                  stQ = stQ & "And np02='" & Trim(oDL01) & "' And np03='" & Trim(oDL02) & "' And np04='" & Trim(oDL03) & "' And np05='" & Trim(oDL04) & "'"
               End If
               stTmp = Pub_GetField("NextProgress", Mid(stQ, 5), "np02||';'||np03||';'||np04||';'||np05||';'||np01")
               If stTmp <> "" Then
                  arrTmp = Split(stTmp, ";")
                  If oDL01 = "" Then oDL01 = arrTmp(0)
                  If oDL02 = "" Then oDL02 = arrTmp(1)
                  If oDL03 = "" Then oDL03 = arrTmp(2)
                  If oDL04 = "" Then oDL04 = arrTmp(3)
                  If oDL05 = "" Then oDL05 = arrTmp(4)
               End If
            'end 2025/09/15
            '補足，若是只有收文號，則再讀取一次，補本所案號
            'Modified by Lydia 2025/07/22 +stDefCP09
            'Modify by Amy 2025/09/15 +不是 客戶/代理人/潛在客戶 編號
            'Modified by Lydia 2025/10/30 拿掉stDefCP09，併入stVal 傳入值
            ElseIf Trim(oDL01 & oDL02 & oDL03 & oDL04) = "" And Trim(oDL05) <> "" _
              And Left(Trim(oDL05), 1) <> 客戶編號 And Left(Trim(oDL05), 1) <> 代理人編號 And Left(Trim(oDL05), 1) <> "R" Then
               Set tmpSelRs = New ADODB.Recordset
               If tmpSelRs.State = 1 Then tmpSelRs.Close
               tmpSelRs.CursorLocation = adUseClient
               'Modified by Lydia 2025/07/22 判斷傳入收文號 oDL05=> IIf(Trim(oDL05) <> "", oDL05, stDefCP09); +CP09
               'Modified by Lydia 2025/10/30 拿掉stDefCP09，併入stVal 傳入值
               tmpSelRs.Open "select cp01,cp02,cp03,cp04,cp09 from caseprogress where cp09='" & IIf(Trim(oDL05) <> "", oDL05, stVal) & "' ", cnnConnection, adOpenStatic, adLockReadOnly
               If tmpSelRs.RecordCount <> 0 Then
                   oDL01 = CheckStr(tmpSelRs.Fields("cp01").Value)
                   oDL02 = CheckStr(tmpSelRs.Fields("cp02").Value)
                   oDL03 = CheckStr(tmpSelRs.Fields("cp03").Value)
                   oDL04 = CheckStr(tmpSelRs.Fields("cp04").Value)
                   oDL05 = CheckStr(tmpSelRs.Fields("cp09").Value) 'Added by Lydia 2025/07/22
               End If
            End If
         End If
         oDL09 = " 刪除 " & oDL10 & " " & IIf(SeekWhere <> "", "，條件 " & SeekWhere & " 資料", "") & "；"
         '儲存原始 where 後面語法
         '2012/7/26 modify by sonia FCP-038067案件名稱有WHERE字樣,故"WHERE"改為" WHERE "
         If InStr(1, tmpStr, " WHERE ") <> 0 Then
            If Trim(tArr(1)) <> "" Then
               SeekWhere = tArr(1)
            Else
               SeekWhere = ""
            End If
         End If
         If UCase(oDL10) <> UCase("casepaperpdf") And UCase(oDL10) <> UCase("casepaperfile") Then 'Add By Sindy 2013/7/16 +if
            If SeekWhere <> "" Then
               tmpSelData = " select * from " & oDL10 & IIf(SeekWhere <> "", " where " & SeekWhere, "")
               Set tmpSelRs = New ADODB.Recordset
               If tmpSelRs.State = 1 Then tmpSelRs.Close
               tmpSelRs.CursorLocation = adUseClient
               tmpSelRs.Open tmpSelData, cnnConnection, adOpenStatic, adLockReadOnly
               If tmpSelRs.RecordCount <> 0 Then
                  'Modify By Sindy 2025/9/4 刪除為多筆時,記錄筆數
                  If tmpSelRs.RecordCount > 1 Then
                     oDL09 = oDL09 & "共計" & tmpSelRs.RecordCount & "筆"
                  Else
                  '2025/9/4 END
                     For tArrTI = 0 To tmpSelRs.Fields.Count - 1
                         If CheckStr(tmpSelRs.Fields(tArrTI).Value) <> "" Then   '有值才紀錄
                           'Modify by Amy 2025/09/19 +因客戶檔維護刪除 非Customer TB資料,執行刪除有資料才寫log,故換變數記錄
                           'oDL09 = oDL09 & tmpSelRs.Fields(tArrTI).Name & "=>" & CheckStr(tmpSelRs.Fields(tArrTI).Value) & IIf(tArrTI < tmpSelRs.Fields.Count - 1, ";", "")
                           stData = stData & tmpSelRs.Fields(tArrTI).Name & "=>" & CheckStr(tmpSelRs.Fields(tArrTI).Value) & IIf(tArrTI < tmpSelRs.Fields.Count - 1, ";", "")
                         End If
                     Next tArrTI
                  End If
               End If
            End If
         End If
         'Modify by Amy 2025/09/19 客戶檔維護刪除 非Customer TB資料
         If UCase(TypeName(Screen.ActiveForm)) = "FRM140401" And UCase(stTmp) <> "CUSTOMER" Then
            '客戶檔維護刪除 非Customer TB資料,記錄客戶編號8碼(由客戶檔傳入)
            If Trim(oDL05) = "" And Trim(stVal) <> "" Then
               oDL05 = stVal
            End If
            '執行刪除有資料才寫log
            If stData <> "" Then
               oDL09 = oDL09 & stData
               ChkDatachg = True
            End If
         Else
            oDL09 = oDL09 & stData
            ChkDatachg = True
         End If
         If ChkDatachg = True Then
            tmp2SQLStr = "insert into dml_log (dl01,dl02,dl03,dl04,dl05,dl06,dl07,dl08,dl09,dl10,dl11,dl12) select '" & ChgSQL(oDL01) & "','" & ChgSQL(oDL02) & "','" & ChgSQL(oDL03) & "','" & ChgSQL(oDL04) & "','" & ChgSQL(oDL05) & "','" & strUserNum & "',to_number(to_char(sysdate,'YYYYMMDD')),to_number(to_char(sysdate,'HH24MIss')),'" & ChgSQL(oDL09) & "','" & oDL10 & "','1'," & IIf(oDL12 = "", "null", "'" & ChgSQL(oDL12) & "'") & " from dual "
         End If
         'end 2025/09/19
      End If '檢查有無 select
Case Else      '未能辨識 也許是查詢，也許是不合法句子
      tmpStr = Replace(tmpStr, "''", "'")
      tmp2SQLStr = "insert into dml_log (dl01,dl02,dl03,dl04,dl05,dl06,dl07,dl08,dl09,dl10,dl11,dl12) select null,null,null,null,null,'" & strUserNum & "',to_number(to_char(sysdate,'YYYYMMDD')),to_number(to_char(sysdate,'HH24MIss')),'" & ChgSQL(tmpStr) & "','非 DML 語法','2'," & IIf(oDL12 = "", "null", "'" & ChgSQL(oDL12) & "'") & " from dual"
      ChkDatachg = True
End Select
'Debug.Print tmp2SQLStr
If ChkDatachg = True Then
    'Modified by Morgan 2023/4/27 使用公用變數intI可能造成其他程式錯誤
    'cnnConnection.Execute tmp2SQLStr, intI
    cnnConnection.Execute tmp2SQLStr
End If

End Function

'Added by Morgan 2024/7/10 將多個連續空白全變成單個,但前後為單引號的內容除外(SQL語法的值)
Public Function PUB_RepToOneSpaceX(ByVal oStr As String) As String
Dim ii As Integer, StrOk As String
Dim iPos1 As Integer, iPos2 As Integer

StrOk = ""
iPos1 = InStr(oStr, "'")
If iPos1 > 0 Then
   iPos2 = InStr(iPos1 + 1, oStr, "'")
   If iPos2 > iPos1 Then
      If iPos1 > 1 Then
         StrOk = PUB_RepToOneSpace(Left(oStr, iPos1 - 1))
      End If
      StrOk = StrOk & Mid(oStr, iPos1, iPos2 - iPos1 + 1)
      If Len(oStr) > iPos2 Then
         StrOk = StrOk & PUB_RepToOneSpaceX(Mid(oStr, iPos2 + 1))
      End If
      
      PUB_RepToOneSpaceX = StrOk
   Else
      PUB_RepToOneSpaceX = PUB_RepToOneSpace(oStr)
   End If
Else
   PUB_RepToOneSpaceX = PUB_RepToOneSpace(oStr)
End If

End Function

'add by nickc 2006/03/10 將多個連續空白全變成單個
Public Function PUB_RepToOneSpace(ByVal oStr As String) As String
PUB_RepToOneSpace = oStr
Do While InStr(1, PUB_RepToOneSpace, "  ") <> 0
    PUB_RepToOneSpace = Replace(PUB_RepToOneSpace, "  ", " ")
Loop
End Function

'add by nickc 2006/03/14 將 DML 語法中的關鍵字變成大寫
Public Function PUB_ChgDMLKeyWordToUpper(oStr As String) As String
Dim oOldStr As String
Dim oNewStr As String
Dim oStrKeyWord As String
Dim oKeyItem As Integer
Dim SeekNowI As Integer
oOldStr = UCase(oStr)
oNewStr = oStr
'select 、insert 、into 、values 、 update 、 set 、where 、delete 、from 、 alias 關鍵字前後要空白
oStrKeyWord = "select ,insert , into , values ,update , set , where ,delete , from , alias "
Dim oKeyWord As Variant
oKeyWord = Split(UCase(oStrKeyWord), ",")
For oKeyItem = 0 To UBound(oKeyWord)
    If InStr(1, oOldStr, oKeyWord(oKeyItem)) <> 0 Then
        'Added by Morgan 2024/8/27 where 改從後面開始抓,否則若更新的欄位內含 where 時會出錯
        If LCase(Trim(oKeyWord(oKeyItem))) = "where" Then
            oNewStr = Mid(oNewStr, 1, InStrRev(oOldStr, oKeyWord(oKeyItem)) - 1) & oKeyWord(oKeyItem) & Mid(oNewStr, InStrRev(oOldStr, oKeyWord(oKeyItem)) + Len(oKeyWord(oKeyItem)))
        Else
        'end 2024/8/27
            oNewStr = Mid(oNewStr, 1, InStr(1, oOldStr, oKeyWord(oKeyItem)) - 1) & oKeyWord(oKeyItem) & Mid(oNewStr, InStr(1, oOldStr, oKeyWord(oKeyItem)) + Len(oKeyWord(oKeyItem)))
        End If
    End If
Next oKeyItem
'將 where 後面的 and 換成大寫
If InStr(1, oNewStr, " WHERE ") <> 0 Then
    oKeyWord = Split(oNewStr, " WHERE ")
    SeekNowI = 1
    oOldStr = UCase(oKeyWord(1))
    oNewStr = oKeyWord(1)
    Do While InStr(SeekNowI, UCase(oOldStr), " AND ") <> 0
        oNewStr = Mid(oNewStr, 1, InStr(SeekNowI, oOldStr, " AND ") - 1) & " AND " & Mid(oNewStr, InStr(SeekNowI, oOldStr, " AND ") + Len(" AND "))
        SeekNowI = InStr(SeekNowI, UCase(oOldStr), " AND ") + 1
    Loop
    PUB_ChgDMLKeyWordToUpper = oKeyWord(0) & " WHERE " & oNewStr
Else
    PUB_ChgDMLKeyWordToUpper = oNewStr
End If
End Function

'add by nickc 2006/03/07 將 update 語法內的要更新的欄位，若是欄位中有, 拆會有問題，結果將他轉成 vbcrlf
'Modified by Morgan 2019/10/3 +bolUpdWoFunc Update語法是否有使用db function
Public Function PUB_ChgUpFd(oStr As String, Optional ByVal bolUpdWoFunc As Boolean = False) As String
Dim oldStr As String
Dim NewStr As String
Dim tArrS As Variant
Dim SeekSmb1 As Integer
Dim SeekSmb2 As Integer
Dim TarrTJ As Integer
Dim tArrTK As Integer
Dim bolSkip As Boolean 'Added by Morgan 2018/3/13


'Added by Morgan 2019/10/4
'原程式解析=號會有問題 Ex:Y54975
If bolUpdWoFunc Then
   NewStr = ""
   oldStr = oStr
   Do While oldStr <> ""
      SeekSmb1 = InStr(oldStr, "=")
      If SeekSmb1 > 0 Then
         NewStr = NewStr & Trim(Left(oldStr, SeekSmb1 - 1))
         oldStr = Trim(Mid(oldStr, SeekSmb1 + 1))
         SeekSmb2 = InStr(oldStr, ",")
         '後面同有","號及"="號時表示可能還有欄位
         If SeekSmb2 > 0 And InStr(SeekSmb2 + 1, oldStr, "=") > 0 Then
            '文字
            If Left(oldStr, 1) = "'" Then
               tArrS = Split(oldStr, ",")
               Do While SeekSmb2 > 0
                  tArrS(0) = RTrim(Replace(tArrS(0), "''", ""))
                  'Modified by Morgan 2021/3/16 +SeekSmb2 > 2
                  If Right(tArrS(0), 1) = "'" And SeekSmb2 > 2 Then
                  'end 2021/3/16
                     NewStr = NewStr & "=" & Left(oldStr, SeekSmb2 - 1) & vbCrLf & Chr(8)
                     oldStr = Trim(Mid(oldStr, SeekSmb2 + 1))
                     Exit Do
                  Else
                     SeekSmb2 = InStr(SeekSmb2 + 1, oldStr, ",")
                     If SeekSmb2 > 0 Then tArrS(0) = Left(oldStr, SeekSmb2 - 1)
                  End If
               Loop
   
               If SeekSmb2 = 0 Then
                  NewStr = NewStr & "=" & oldStr
                  oldStr = ""
               End If
            '數字/NULL
            Else
               NewStr = NewStr & "=" & Left(oldStr, SeekSmb2 - 1) & vbCrLf & Chr(8)
               oldStr = Trim(Mid(oldStr, SeekSmb2 + 1))
            End If
         Else
            NewStr = NewStr & "=" & oldStr
            oldStr = ""
         End If
      Else
         NewStr = oldStr
      End If
   Loop
   PUB_ChgUpFd = NewStr
   Exit Function
End If
'end 2019/10/4

NewStr = ""
tArrS = Split(oStr, "=")
NewStr = NewStr & tArrS(0)
For TarrTJ = 0 To UBound(tArrS) - 2
    For tArrTK = Len(tArrS(TarrTJ + 1)) To 1 Step -1
        oldStr = Mid(tArrS(TarrTJ + 1), tArrTK, 1)
        If oldStr = "," Then
            bolSkip = False 'Added by Morgan 2018/3/13
            'Modified by Lydia 2016/12/28 逗號造成換行,再加上更新內容有"="造成誤判(ex. CFP-28452的CA5100149進度備註2016/12/28 報價：15,000(5P);領證費15000(5)=代理人費用10000+點數5000;
            SeekSmb2 = InStrRev(tArrS(TarrTJ + 1), "'") '右引號
            SeekSmb1 = InStr(tArrS(TarrTJ + 1), "'")    '左引號
            '只有一個引號
            If SeekSmb1 = SeekSmb2 And SeekSmb1 > 0 Then
               '下一欄位有完整資料
               If InStr(UCase(tArrS(TarrTJ + 2)), "NULL") > 0 Or InStr(tArrS(TarrTJ + 2), "'") <> InStrRev(tArrS(TarrTJ + 2), "'") Then
                  NewStr = NewStr & "=" & Mid(tArrS(TarrTJ + 1), 1, tArrTK - 1) & vbCrLf & Chr(8) & Mid(tArrS(TarrTJ + 1), tArrTK + 1)
               Else
                  NewStr = NewStr & "=" & Mid(tArrS(TarrTJ + 1), 1, tArrTK - 1) & oldStr & Mid(tArrS(TarrTJ + 1), tArrTK + 1)
               End If
               tArrTK = 1
            'Added by Morgan 2018/3/8
            '逗號後面有單引號可判斷為內容 ex:Y54975
            ElseIf SeekSmb2 > tArrTK Then
               bolSkip = True
            'end 2018/3/13
            Else
            'END 2016/12/28
               NewStr = NewStr & "=" & Mid(tArrS(TarrTJ + 1), 1, tArrTK - 1) & vbCrLf & Chr(8) & Mid(tArrS(TarrTJ + 1), tArrTK + 1)
               tArrTK = 1
            End If
        End If
    Next tArrTK
    'Added by Lydia 2016/12/28 無逗號
    'Modified by Morgan 2018/3/13
    'If tArrS(TarrTJ + 1) <> "" And InStr(tArrS(TarrTJ + 1), ",") = 0 Then
    If tArrS(TarrTJ + 1) <> "" And (InStr(tArrS(TarrTJ + 1), ",") = 0 Or bolSkip) Then
       NewStr = NewStr & "=" & tArrS(TarrTJ + 1)
    End If
Next TarrTJ

NewStr = NewStr & "=" & tArrS(UBound(tArrS))

PUB_ChgUpFd = NewStr
End Function

'add by nickc 2006/04/04 檢查有收文非智權部人員
Public Function PUB_ChkNotSalesButHaveCase(oStr As String) As Boolean
PUB_ChkNotSalesButHaveCase = False
Dim tmpSelRs As New ADODB.Recordset
strSql = "select * from nsbhc where ns01='" & oStr & "' "
Set tmpSelRs = New ADODB.Recordset
If tmpSelRs.State = 1 Then tmpSelRs.Close
tmpSelRs.CursorLocation = adUseClient
tmpSelRs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If tmpSelRs.RecordCount <> 0 Then
    PUB_ChkNotSalesButHaveCase = True
End If
tmpSelRs.Close
Set tmpSelRs = Nothing
End Function
'Add by Morgan 2006/4/7 從dll移過來
'分案之指定國家－新增  intSend 0: 新增基本資料  intSend 1:新增案件進度資料
'                      intSend 2:新增基本資料及案件進度資料
'Modified by Morgan 2020/8/7 +strFAgent,strCP09s,strCP10
Public Function PUB_SaveCountry(ByRef intSend As Integer, ByRef intCaseKind As Integer, _
    ByRef strRule As String, ByVal strReciveNo As String, ByRef strCountry As String, Optional ByVal strFagent As String, Optional ByRef strCP09s As String, Optional ByVal strCP10 As String) As Boolean
    
   Dim varCountryTemp As Variant, i As Integer, strSql As String, strTmp As String
   Dim varFAgentTemp As Variant 'Added by Morgan 2020/8/7

   varCountryTemp = Split(strCountry, ",")
   strTmp = ""
   If intSend <> 1 Then
        '新增基本檔
      Select Case intCaseKind
         Case 專利
            For i = 10 To TF_PA 'edit by nickc 2006/07/12 T_PA
               Select Case i
                  'edit by nickc 2006/07/12
                  'Case 92, 93, 94, 95, 96, 97
                  Case 92, 93, 94, 95, 96, 97, 108, 136, 137, 138
                     
                  Case Else
                     strTmp = strTmp & "PA" & Format(i) & ","
               End Select
            Next
            strTmp = Left(strTmp, Len(strTmp) - 1)
            For i = 0 To UBound(varCountryTemp)
               strSql = "INSERT INTO PATENT (PA01,PA02,PA03,PA04,PA05,PA06,PA07,PA08,PA09," & _
                  strTmp & ") SELECT PA01,PA02,PA03,'" & Format(i + 1, "00") & "',PA05,PA06," & _
                  "PA07,PA08,'" & CStr(varCountryTemp(i)) & "'," & strTmp & " FROM PATENT WHERE " & ChgPatent(strRule)
               cnnConnection.Execute strSql
            Next
         
         Case 商標
            For i = 11 To TF_TM 'edit by nickc 2006/07/12 T_TM
               Select Case i
                  'edit by nickc 2006/07/12
                  'Case 59, 60, 61, 62, 63, 64
                  Case 59, 60, 61, 62, 63, 64, 57, 73, 74, 75
                     
                  Case Else
                     strTmp = strTmp & "TM" & Format(i) & ","
               End Select
            Next
            strTmp = Left(strTmp, Len(strTmp) - 1)
            
            For i = 0 To UBound(varCountryTemp)
               strSql = "INSERT INTO TRADEMARK (TM01,TM02,TM03,TM04,TM05,TM06,TM07,TM08,TM09," & _
                  "TM10," & strTmp & ") SELECT TM01,TM02,TM03,'" & Format(i + 1, "00") & "'," & _
                  "TM05,TM06,TM07,TM08,TM09,'" & CStr(varCountryTemp(i)) & "'," & strTmp & _
                  " FROM TRADEMARK WHERE " & ChgTradeMark(strRule)
               cnnConnection.Execute strSql
            Next
         
      End Select
   End If
   If intSend <> 0 Then
      '新增進度檔
      Dim CP09 As String, strAutoNumber As String
      Dim aryCP09() As String
      Dim nCP09Count As Integer
      nCP09Count = 0
      strTmp = ""
      For i = 1 To TF_CP 'edit by nickc 2007/02/06 T_CP
         Select Case i
            'Modified by Morgan 2020/8/14 +10,44,116
            Case 4, 9, 43, 10, 44, 116
            'Removed by Morgan 2025/7/24 沒用,點掉以免誤看
            'Case 44, 116
            '   If strFagent = "" Then
            '      strTmp = strTmp & "CP" & Format(i, "00") & ","
            '   ElseIf i = 44 Then
            '      varFAgentTemp = Split(strFagent, ",")
            '   End If
            'end 2025/7/24
            'end 2020/8/7
            Case Else
               strTmp = strTmp & "CP" & Format(i, "00") & ","
         End Select
      Next
      strTmp = Left(strTmp, Len(strTmp) - 1)
      
      Dim FIELD04 As String, strPA(1 To 9) As String
      Dim stCP10 As String, stCP44 As String, stCP116 As String, iPos As Integer  'Added by Morgan 2020/8/14
      
      If strFagent <> "" Then varFAgentTemp = Split(strFagent, ",") 'Added by Morgan 2020/8/14
      For i = 0 To UBound(varCountryTemp)
         If varCountryTemp(i) <> "" Then
            If ClsPDGetAutoNumber("B", strAutoNumber, True, True) Then
               'Modify By Sindy 2010/8/17 比對自動編號年度
               'CP09 = "B" & Mid(strSrvDate(2), 1, 2) + strAutoNumber
               CP09 = "B" & CompAutoNumberYear(Val(Mid(strSrvDate(1), 1, 4)) - 1911) + strAutoNumber
               ' 先將收文號儲存起來
               'Modified by Morgan 2020/8/14
               'ReDim Preserve aryCP09(nCP09Count + 1)
               ReDim Preserve aryCP09(nCP09Count)
               'end 2020/8/14
               aryCP09(nCP09Count) = CP09
               nCP09Count = nCP09Count + 1
               
               ChgCaseNo strRule, strPA()
               
               FIELD04 = GetPA04(strPA(1), strPA(2), strPA(3), Format(varCountryTemp(i)))
               
               'Modified by Morgan 2020/8/14
               'strSql = "INSERT INTO CASEPROGRESS (CP09,CP04,CP43," & strTmp & ") " & _
                  "SELECT '" & CP09 & "','" & FIELD04 & "',CP09," & strTmp _
                  & " FROM CASEPROGRESS WHERE CP09='" & strReciveNo & "'"
               
               If strCP10 = "" Then
                  stCP10 = "CP10"
               Else
                  stCP10 = "'" & strCP10 & "'"
               End If
               
               stCP44 = "": stCP116 = ""
               If strFagent <> "" Then
                  If varFAgentTemp(i) <> "" Then
                     iPos = InStr(varFAgentTemp(i), "-")
                     If iPos > 0 Then
                        stCP44 = Left(varFAgentTemp(i), iPos - 1)
                        stCP116 = Mid(varFAgentTemp(i), iPos + 1)
                     Else
                        stCP44 = varFAgentTemp(i)
                        stCP116 = ""
                     End If
                     stCP44 = "'" & ChangeCustomerL(stCP44) & "'"
                     stCP116 = "'" & stCP116 & "'"
                  End If
               End If
               If stCP44 = "" Then stCP44 = "CP44"
               If stCP116 = "" Then stCP116 = "CP116"
                  
               strSql = "INSERT INTO CASEPROGRESS (CP09,CP04,CP43,CP10,CP44,CP116," & strTmp & ") " & _
                  "SELECT '" & CP09 & "','" & FIELD04 & "',CP09," & stCP10 & "," & stCP44 & "," & stCP116 & "," & strTmp _
                  & " FROM CASEPROGRESS WHERE CP09='" & strReciveNo & "'"
               'end 2020/8/14
               cnnConnection.Execute strSql
            End If
         Else
            
         End If
      Next
      
      ' 90.12.19 modify by louis (對以下的幾個欄位預設值)
      '90.12.24 nick 因為並不是每件案件都要新增子案cp
      If nCP09Count <> 0 Then
         Dim nPos As Integer
         Dim strCP09Con As String
         strCP09Con = Empty
         For nPos = 0 To nCP09Count - 1
            If strCP09Con <> "" Then
               strCP09Con = strCP09Con & "OR "
            End If
            strCP09Con = strCP09Con & "CP09 = '" & aryCP09(nPos) & "' "
            
         Next nPos
         '2007/3/2 modify by sonia 加入cp87,cp88
         'Added by Morgan 2020/8/19 有案件性質時不必清除承辦人、所限、法限，不要上提申日(224,605)
         If strCP10 <> "" Then
            strSql = "UPDATE CASEPROGRESS SET CP15=NULL,CP16=NULL,CP17=NULL,CP18=NULL,CP19=NULL, CP29=Null, CP31=NULL, CP33=NULL, " & _
               "CP34=NULL, CP48=NULL, CP60=NULL, CP61=NULL, CP62=NULL, CP63=NULL, CP87=NULL, CP88=NULL, " & _
               "CP74=NULL, CP75=NULL, CP76=NULL, CP77=NULL, CP78=NULL, CP64='子案發文記錄'," & _
               "CP79=NULL, CP20='N', CP26='N', CP32='N', CP21='Y',CP05=" & strSrvDate(1) & _
               " WHERE " & strCP09Con
            cnnConnection.Execute strSql
         Else
         'end 2020/8/19
         
            strSql = "UPDATE CASEPROGRESS SET CP06=NULL,CP07=NULL,CP14=Null,CP15=NULL,CP16=NULL,CP17=NULL,CP18=NULL,CP19=NULL, CP29=Null, CP31=NULL, CP33=NULL, " & _
               "CP34=NULL, CP48=NULL, CP60=NULL, CP61=NULL, CP62=NULL, CP63=NULL, CP87=NULL, CP88=NULL, " & _
               "CP74=NULL, CP75=NULL, CP76=NULL, CP77=NULL, CP78=NULL, CP64='子案發文記錄'," & _
               "CP79=NULL, CP20='N', CP26='N', CP32='N', CP21='Y',CP05=" & strSrvDate(1) & ",CP47=" & strSrvDate(1) & _
               " WHERE " & strCP09Con
            cnnConnection.Execute strSql
            
         End If 'Added by Morgan 2020/8/19
         
         strCP09s = Join(aryCP09, ",") 'Added by Morgan 2020/8/14
      End If
      '******************************************************
   End If
   PUB_SaveCountry = True
End Function

'抓代理人代碼 從 CP 來 add by nickc 2006/04/12
Public Function GetPrjFagentNumByCP(ByRef Strindex As String) As String            '抓代理人代碼
If UCase(Left(Strindex, 1)) = "N" Then
    Strindex = Right(Strindex, Len(Strindex) - 1)
End If
strSql = "SELECT cp44 FROM  caseprogress WHERE cp01='" & SystemNumber(Strindex, 1) & "'  AND cp02='" & SystemNumber(Strindex, 2) & "' AND cp03='" & SystemNumber(Strindex, 3) & "' AND cp04='" & SystemNumber(Strindex, 4) & "' and cp44 is not null "
CheckOC3
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
    If Not IsNull(AdoRecordSet3.Fields(0)) Then
        GetPrjFagentNumByCP = AdoRecordSet3.Fields(0)
    Else
        GetPrjFagentNumByCP = ""
    End If
Else
    GetPrjFagentNumByCP = ""
End If
CheckOC3
End Function

Public Sub HSLtoRGB(ByVal h As Single, ByVal s As Single, ByVal L As Single, r As Byte, g As Byte, B As Byte)

    Dim rr As Single, rG As Single, rB As Single
    Dim Min As Single, max As Single

    '-- Achromatic case:
    If (s = 0) Then
        rr = L: rG = L: rB = L

        '-- Chromatic case:
    Else
        If (L <= 0.5) Then
            '-- S = (Max - Min) / (Max + Min)
            Min = L * (1 - s)
        Else
            '-- S = (Max - Min) / (2 - Max - Min)
            Min = L - s * (1 - L)
        End If
        max = 2 * L - Min

        '-- Now depending on sector we can evaluate the H,L,S:
        If (h < 1) Then
            rr = max
            If (h < 0) Then
                rG = Min
                rB = rG - h * (max - Min)
            Else
                rB = Min
                rG = h * (max - Min) + rB
            End If
        ElseIf (h < 3) Then
            rG = max
            If (h < 2) Then
                rB = Min
                rr = rB - (h - 2) * (max - Min)
            Else
                rr = Min
                rB = (h - 2) * (max - Min) + rr
            End If
        Else
            rB = max
            If (h < 4) Then
                rr = Min
                rG = rr - (h - 4) * (max - Min)
            Else
                rG = Min
                rr = (h - 4) * (max - Min) + rG
            End If
        End If
    End If
    r = rr * 255: g = rG * 255: B = rB * 255
End Sub

Public Sub RGBtoHSL(ByVal r As Byte, ByVal g As Byte, ByVal B As Byte, h As Single, s As Single, L As Single)

    Dim max As Single
    Dim Min As Single
    Dim delta As Single
    Dim rr As Single, rG As Single, rB As Single

    '-- Given:   RGB each in [0,1]
    '-- Desired: H in [0,240] and S in [0,1], except if S = 0, then H = UNDEFINED
    rr = r / 255: rG = g / 255: rB = B / 255

    max = pvMaximum(rr, rG, rB)
    Min = pvMinimum(rr, rG, rB)
    L = (max + Min) / 2

    '== Calculate saturation:

    '-- Achromatic case
    If (max = Min) Then
        s = 0
        h = 0

        '-- Chromatic case
    Else
        '-- First calculate the saturation
        If (L <= 0.5) Then
            s = (max - Min) / (max + Min)
        Else
            s = (max - Min) / (2 - max - Min)
        End If
        '-- Next calculate the hue
        delta = max - Min
        If (rr = max) Then
            h = (rG - rB) / delta                          ' Resulting color is between yellow and magenta
        ElseIf (rG = max) Then
            h = 2 + (rB - rr) / delta                      ' Resulting color is between cyan and yellow
        ElseIf (rB = max) Then
            h = 4 + (rr - rG) / delta                      ' Resulting color is between magenta and cyan
        End If
    End If
End Sub

Private Function pvMaximum(rr As Single, rG As Single, rB As Single) As Single
    If (rr > rG) Then
        If (rr > rB) Then pvMaximum = rr Else pvMaximum = rB
    Else
        If (rB > rG) Then pvMaximum = rB Else pvMaximum = rG
    End If
End Function

Private Function pvMinimum(rr As Single, rG As Single, rB As Single) As Single
    If (rr < rG) Then
        If (rr < rB) Then pvMinimum = rr Else pvMinimum = rB
    Else
        If (rB < rG) Then pvMinimum = rB Else pvMinimum = rG
    End If
End Function

'Add by Morgan 2006/4/26 檢查帳單是否重複(A1502+A1503+A1504)
'Modify by Morgan 2007/5/16 加參數p_iType :0=帳單; 1=抵帳單
Public Function PUB_ChkDNDup(ByVal p_A1502 As String, p_A1503 As String, p_A1504 As String, Optional p_A1501 As String, Optional p_bolMsg As Boolean = True, Optional p_iType As Integer = 0) As Boolean
   
   Dim stBillName As String
   
   If p_iType = 0 Then
      stBillName = "帳單"
      'Modify By Sindy 2009/06/17
      'strSQL = "Select * From Acc150 Where A1502=" & TransDate(Val(Replace(p_A1502, "/", "")), 1)
      strSql = "Select * From Acc150 Where A1507 is null "
      
      'Add By Sindy 2009/06/17
      If p_A1502 <> "" Then
         strSql = strSql & " and A1502=" & TransDate(Val(Replace(p_A1502, "/", "")), 1)
      End If
      
      If p_A1503 = "Y51469000" Then
         strSql = strSql & " and ( A1503='" & p_A1503 & "' or A1503='Y51566000' )"
      Else
         strSql = strSql & " and A1503='" & p_A1503 & "'"
      End If
      
      If p_A1504 <> "" Then
         strSql = strSql & " and A1504='" & p_A1504 & "'"
      End If
      
      If p_A1501 <> "" Then
         strSql = strSql & " and A1501<>'" & p_A1501 & "'"
      End If
   Else
      stBillName = "抵帳單"
      'Modify By Sindy 2009/06/17
      'strSQL = "Select * From Acc160 Where A1602=" & TransDate(Val(Replace(p_A1502, "/", "")), 1)
      strSql = "Select * From Acc160 Where 1=1 "
      
      'Add By Sindy 2009/06/17
      If p_A1502 <> "" Then
         strSql = strSql & " and A1602=" & TransDate(Val(Replace(p_A1502, "/", "")), 1)
      End If
      
      If p_A1503 = "Y51469000" Then
         strSql = strSql & " and ( A1603='" & p_A1503 & "' or A1603='Y51566000' )"
      Else
         strSql = strSql & " and A1603='" & p_A1503 & "'"
      End If
      
      If p_A1504 <> "" Then
         strSql = strSql & " and A1604='" & p_A1504 & "'"
      End If
      
      If p_A1501 <> "" Then
         strSql = strSql & " and A1601<>'" & p_A1501 & "'"
      End If
   End If
   
   CheckOC3
   With AdoRecordSet3
   .CursorLocation = adUseClient
   .Open strSql, cnnConnection, adOpenForwardOnly, adLockReadOnly
   If .RecordCount > 0 Then
      PUB_ChkDNDup = True
      If p_bolMsg = True Then
         If p_A1504 = "" Then
            MsgBox "此" & stBillName & "資料重覆，請確認!!!", vbExclamation + vbOKOnly
         Else
            MsgBox "代理人此" & stBillName & "D/N No.重覆，請確認!!!", vbExclamation + vbOKOnly
         End If
      End If
   End If
   End With
   
End Function

'move from acc_fun by nickc 2006/05/01
'*************************************************
'  將數字轉換成中文數字
'
'*************************************************
'Modified by Lydia 2023/08/10 是否加上"元整"=>bolShow
Public Function ChangeNumber(ByVal strInputValue As String, Optional ByVal bolShow As Boolean = True) As String
Dim intCounter As Integer
Dim bolZero As Boolean
Dim intDot As Integer, strTmp As String 'Adddec by Lydia 2023/08/10
      
   'Added by Lydia 2023/08/10 取得小數點
   intDot = InStr("" & strInputValue, ".")
   If intDot > 0 Then
       strTmp = strInputValue '暫存
       strInputValue = Mid(strInputValue, 1, intDot - 1)
   End If
   'end 2023/08/10
   
   bolZero = False
   'Modified by Lydia 2023/08//10 判斷小數點
   For intCounter = 1 To Len(strInputValue)
   'For intCounter = 1 To IIf(intDot > 0, intDot - 1, Len(strInputValue))
      Select Case intCounter
         Case 1 '個
            If Val(Mid(strInputValue, Len(strInputValue) - intCounter + 1, 1)) <> 0 Then
               ChangeNumber = ShowNumberWord(Val(Mid(strInputValue, Len(strInputValue) - intCounter + 1, 1)))
            End If
         Case 2 '拾
            If Val(Mid(strInputValue, Len(strInputValue) - intCounter + 1, 1)) <> 0 Then
               ChangeNumber = ShowNumberWord(Val(Mid(strInputValue, Len(strInputValue) - intCounter + 1, 1))) & ShowNumberWord(10) & ChangeNumber
            Else
               If Len(strInputValue) > 2 Then
                  bolZero = True
               End If
            End If
         Case 3 '佰
            If Val(Mid(strInputValue, Len(strInputValue) - intCounter + 1, 1)) <> 0 Then
               If bolZero Then
                  If Mid(strInputValue, Len(strInputValue) - 1, 2) = "00" Then
                     ChangeNumber = ShowNumberWord(Val(Mid(strInputValue, Len(strInputValue) - intCounter + 1, 1))) & ShowNumberWord(11) & ChangeNumber
                  Else
                     ChangeNumber = ShowNumberWord(Val(Mid(strInputValue, Len(strInputValue) - intCounter + 1, 1))) & ShowNumberWord(11) & ShowNumberWord(0) & ChangeNumber
                  End If
                  bolZero = False
               Else
                  ChangeNumber = ShowNumberWord(Val(Mid(strInputValue, Len(strInputValue) - intCounter + 1, 1))) & ShowNumberWord(11) & ChangeNumber
               End If
            Else
               If Len(strInputValue) > 3 Then
                  bolZero = True
               End If
            End If
         Case 4 '仟
            If Val(Mid(strInputValue, Len(strInputValue) - intCounter + 1, 1)) <> 0 Then
               If bolZero Then
                  If Mid(strInputValue, Len(strInputValue) - 2, 3) = "000" Then
                     ChangeNumber = ShowNumberWord(Val(Mid(strInputValue, Len(strInputValue) - intCounter + 1, 1))) & ShowNumberWord(12) & ChangeNumber
                  Else
                     ChangeNumber = ShowNumberWord(Val(Mid(strInputValue, Len(strInputValue) - intCounter + 1, 1))) & ShowNumberWord(12) & ShowNumberWord(0) & ChangeNumber
                  End If
                  bolZero = False
               Else
                  ChangeNumber = ShowNumberWord(Val(Mid(strInputValue, Len(strInputValue) - intCounter + 1, 1))) & ShowNumberWord(12) & ChangeNumber
               End If
            Else
               If Len(strInputValue) > 4 Then
                  bolZero = True
               End If
            End If
         Case 5 '萬
            If Val(Mid(strInputValue, Len(strInputValue) - intCounter + 1, 1)) <> 0 Then
               If bolZero Then
                  If Mid(strInputValue, Len(strInputValue) - 3, 4) = "0000" Then
                     ChangeNumber = ShowNumberWord(Val(Mid(strInputValue, Len(strInputValue) - intCounter + 1, 1))) & ShowNumberWord(13) & ChangeNumber
                  Else
                     ChangeNumber = ShowNumberWord(Val(Mid(strInputValue, Len(strInputValue) - intCounter + 1, 1))) & ShowNumberWord(13) & ShowNumberWord(0) & ChangeNumber
                  End If
                  bolZero = False
               Else
                  ChangeNumber = ShowNumberWord(Val(Mid(strInputValue, Len(strInputValue) - intCounter + 1, 1))) & ShowNumberWord(13) & ChangeNumber
               End If
            Else
               If Len(strInputValue) > 5 Then
                  If Len(strInputValue) > 8 Then
                     If Mid(strInputValue, Len(strInputValue) - 6, 3) = "000" Then
                        If Mid(strInputValue, Len(strInputValue) - 3, 4) = "0000" Then
                           ChangeNumber = ChangeNumber
                        Else
                           ChangeNumber = ShowNumberWord(0) & ChangeNumber
                        End If
                     Else
                        ChangeNumber = ShowNumberWord(13) & ShowNumberWord(0) & ChangeNumber
                     End If
                  Else
                     If bolZero Then
                        If Mid(strInputValue, Len(strInputValue) - 3, 4) = "0000" Then
                           ChangeNumber = ShowNumberWord(13) & ChangeNumber
                        Else
                           ChangeNumber = ShowNumberWord(13) & ShowNumberWord(0) & ChangeNumber
                        End If
                        bolZero = False
                     Else
                        'Modify By Cheng 2004/04/29
'                        ChangeNumber = ShowNumberWord(13) & ChangeNumber
                        'Modify by Morgan 2004/11/5 靖瑄要改回不補 "零"
                        'ChangeNumber = ShowNumberWord(13) & IIf(Val(Right(Left(strInputValue, Len(strInputValue) - 3), 1)) > 0, ShowNumberWord(0), "") & ChangeNumber
                        ChangeNumber = ShowNumberWord(13) & ChangeNumber
                        '2004/11/5 end
                        'End
                        bolZero = True
                     End If
                  End If
               End If
            End If
         Case 6 '拾萬
            If Val(Mid(strInputValue, Len(strInputValue) - intCounter + 1, 1)) <> 0 Then
               ChangeNumber = ShowNumberWord(Val(Mid(strInputValue, Len(strInputValue) - intCounter + 1, 1))) & ShowNumberWord(10) & ChangeNumber
                'Add By Cheng 2004/04/29
                If bolZero Then bolZero = False
                'End
            Else
               If Len(strInputValue) > 6 Then
                  bolZero = True
               End If
            End If
         Case 7 '百萬
            If Val(Mid(strInputValue, Len(strInputValue) - intCounter + 1, 1)) <> 0 Then
               If bolZero Then
                  If Mid(strInputValue, Len(strInputValue) - 5, 2) = "00" Then
                     ChangeNumber = ShowNumberWord(Val(Mid(strInputValue, Len(strInputValue) - intCounter + 1, 1))) & ShowNumberWord(11) & ChangeNumber
                  Else
                     ChangeNumber = ShowNumberWord(Val(Mid(strInputValue, Len(strInputValue) - intCounter + 1, 1))) & ShowNumberWord(11) & ShowNumberWord(0) & ChangeNumber
                  End If
                  bolZero = False
               Else
                  ChangeNumber = ShowNumberWord(Val(Mid(strInputValue, Len(strInputValue) - intCounter + 1, 1))) & ShowNumberWord(11) & ChangeNumber
               End If
            Else
               If Len(strInputValue) > 7 Then
                  bolZero = True
               End If
            End If
         Case 8 '仟萬
            If Val(Mid(strInputValue, Len(strInputValue) - intCounter + 1, 1)) <> 0 Then
               If bolZero Then
                  If Mid(strInputValue, Len(strInputValue) - 6, 3) = "000" Then
                     ChangeNumber = ShowNumberWord(Val(Mid(strInputValue, Len(strInputValue) - intCounter + 1, 1))) & ShowNumberWord(12) & ChangeNumber
                  Else
                     ChangeNumber = ShowNumberWord(Val(Mid(strInputValue, Len(strInputValue) - intCounter + 1, 1))) & ShowNumberWord(12) & ShowNumberWord(0) & ChangeNumber
                  End If
                  bolZero = False
               Else
                  ChangeNumber = ShowNumberWord(Val(Mid(strInputValue, Len(strInputValue) - intCounter + 1, 1))) & ShowNumberWord(12) & ChangeNumber
               End If
            End If
         Case 9 '億
            If Val(Mid(strInputValue, Len(strInputValue) - intCounter + 1, 1)) <> 0 Then
               ChangeNumber = ShowNumberWord(Val(Mid(strInputValue, Len(strInputValue) - intCounter + 1, 1))) & ShowNumberWord(14) & ChangeNumber
            Else
               ChangeNumber = ShowNumberWord(14) & ChangeNumber
            End If
      End Select
   Next intCounter
   'Added by Ldia 2023/08/10 小數點以後
   strInputValue = strTmp
   If intDot > 0 Then
      ChangeNumber = ChangeNumber + "元"
      For intCounter = intDot To Len(strInputValue)
         Select Case intCounter - intDot
            Case 1
              If Val(Mid(strInputValue, intCounter, 1)) <> 0 Then
                ChangeNumber = ChangeNumber + ShowNumberWord(Val(Mid(strInputValue, intCounter, 1))) & ShowNumberWord(31)
              End If
            Case 2
              If Val(Mid(strInputValue, intCounter, 1)) <> 0 Then
                ChangeNumber = ChangeNumber + ShowNumberWord(Val(Mid(strInputValue, intCounter, 1))) & ShowNumberWord(32)
              End If
         End Select
      Next intCounter
   End If
   'end 2023/08/10
   
   'Added by Lydia 2023/08/10
   If intDot > 0 And bolShow = True Then
      ChangeNumber = ChangeNumber & "整"
   ElseIf bolShow = True Then
   'end 2023/08/10
      ChangeNumber = ChangeNumber & ShowNumberWord(20)
   End If
End Function

Public Function ChangeCDateNumber(strInputValue As String) As String
Dim intCounter As Integer
Dim bolZero As Boolean

   bolZero = False
   For intCounter = 1 To Len(strInputValue)
      Select Case intCounter
         Case 1 '個
            If Val(Mid(strInputValue, Len(strInputValue) - intCounter + 1, 1)) <> 0 Then
               ChangeCDateNumber = ShowCDateNumberWord(Val(Mid(strInputValue, Len(strInputValue) - intCounter + 1, 1)))
            End If
         Case 2 '拾
            If Val(Mid(strInputValue, Len(strInputValue) - intCounter + 1, 1)) <> 0 Then
               ChangeCDateNumber = ShowCDateNumberWord(Val(Mid(strInputValue, Len(strInputValue) - intCounter + 1, 1))) & ShowCDateNumberWord(10) & ChangeCDateNumber
            Else
               If Len(strInputValue) > 2 Then
                  bolZero = True
               End If
            End If
         Case 3 '佰
            If Val(Mid(strInputValue, Len(strInputValue) - intCounter + 1, 1)) <> 0 Then
               If bolZero Then
                  If Mid(strInputValue, Len(strInputValue) - 1, 2) = "00" Then
                     ChangeCDateNumber = ShowCDateNumberWord(Val(Mid(strInputValue, Len(strInputValue) - intCounter + 1, 1))) & ShowCDateNumberWord(11) & ChangeCDateNumber
                  Else
                     ChangeCDateNumber = ShowCDateNumberWord(Val(Mid(strInputValue, Len(strInputValue) - intCounter + 1, 1))) & ShowCDateNumberWord(11) & ShowNumberWord(0) & ChangeCDateNumber
                  End If
                  bolZero = False
               Else
                  ChangeCDateNumber = ShowCDateNumberWord(Val(Mid(strInputValue, Len(strInputValue) - intCounter + 1, 1))) & ShowCDateNumberWord(11) & ChangeCDateNumber
               End If
            Else
               If Len(strInputValue) > 3 Then
                  bolZero = True
               End If
            End If
      End Select
   Next intCounter
End Function

Public Function ShowCDateNumberWord(InputNumber As Long) As String
   Select Case InputNumber
      Case 0
         ShowCDateNumberWord = ""
      Case 1
         ShowCDateNumberWord = "一"
      Case 2
         ShowCDateNumberWord = "二"
      Case 3
         ShowCDateNumberWord = "三"
      Case 4
         ShowCDateNumberWord = "四"
      Case 5
         ShowCDateNumberWord = "五"
      Case 6
         ShowCDateNumberWord = "六"
      Case 7
         ShowCDateNumberWord = "七"
      Case 8
         ShowCDateNumberWord = "八"
      Case 9
         ShowCDateNumberWord = "九"
      Case 10
         ShowCDateNumberWord = "十"
      Case 11
         ShowCDateNumberWord = "百"
   End Select
End Function

'move from baspublic by nickc 2006/05/01
'將數字轉全型
'Modified by Morgan 2021/12/13 +TextBox2:Form2.0的TextBox
Public Function ChangeZIP(ByVal intZIP As Integer, Optional TextBox2 As Object) As Integer
   Dim iNewASCII As Integer, iSelStart As Integer 'Added by Morgan 2021/12/13
   
   'Added by Lydia 2022/09/15 判斷物件可編輯狀態，不然在Locked=True也能輸入英數字
   If UCase(TypeName(TextBox2)) = "TEXTBOX" Then
       If TextBox2.Locked = True Or TextBox2.Enabled = False Then
           Exit Function
       End If
   End If
   'end 2022/09/15
   
   If intZIP > 47 And intZIP < 58 Then
      ChangeZIP = Asc("０") + intZIP - 48
   ElseIf intZIP = 8 Then
      ChangeZIP = intZIP
   'ElseIf intZIP > 96 And intZIP < 123 Then
   ElseIf intZIP > 96 And intZIP < 119 Then
      ChangeZIP = Asc("ａ") + intZIP - 97
   'add by nickc 2007/07/02 因為全型w 會跳號
   ElseIf intZIP > 118 And intZIP < 123 Then
      ChangeZIP = Asc("ａ") + intZIP - 32
   ElseIf intZIP > 64 And intZIP < 91 Then
      ChangeZIP = Asc("Ａ") + intZIP - 65
   ElseIf intZIP = 32 Then
      ChangeZIP = -24256
   Else
      ChangeZIP = intZIP
   End If
   
   'Added by Morgan 2021/12/13
   'Form2.0的KeyPress事件 KeyAscii 設定全型字的內碼實際只有後面1個位元組有效,EX:"０"(A2AF)輸入2次會變成"秤"(AFAF)
   '改成直接寫文字框的內容,但原來判斷KeyAscii的程式會變無效
   If ChangeZIP <> intZIP Then
      iNewASCII = ChangeZIP
      If TypeName(TextBox2) = "TextBox" Then
         iSelStart = TextBox2.SelStart
         TextBox2 = Left(TextBox2, iSelStart) & Chr(iNewASCII) & Mid(TextBox2, iSelStart + TextBox2.SelLength + 1)
         TextBox2.SelStart = iSelStart + 1
         ChangeZIP = 0
      End If
   End If
   'end 2021/12/13
   
End Function

'Add by Morgan 2006/5/2
'取得/釋放資料異動權 p_NewKey:欲取得資料鍵值,p_OldKey:欲釋放資料鍵值
Public Function PUB_GetLock(ByVal p_NewKey As String, ByRef p_OldKey As String, Optional ByVal p_Msg As String) As Boolean
   
On Error GoTo ErrHand
   
'   'Add By Sindy 2017/2/14 不適合,因為也要控管一個人開多個系統操作的問題
'   If p_OldKey = Empty Then
'      strExc(0) = "select LR02 from LockRec where LR01='" & p_NewKey & "'"
'      intI = 1
'      Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
'      If intI = 1 Then
'         If RsTemp.Fields(0) = strUserNum Then
'            p_OldKey = p_NewKey
'         End If
'      End If
'   End If
'   '2017/2/14 END
   
   If p_OldKey <> Empty Then
      strSql = "Delete from LockRec where LR01='" & p_OldKey & "' and LR02='" & strUserNum & "'"
      adoTaie.Execute strSql
      p_OldKey = Empty
   End If
   If p_NewKey <> Empty Then
      strSql = "Insert into LockRec(LR01,LR02,LR03) values ('" & p_NewKey & "','" & strUserNum & "',to_char(sysdate,'YYYYMMDDHH24MISS'))"
      adoTaie.Execute strSql
      p_OldKey = p_NewKey
   End If
   PUB_GetLock = True
ErrHand:
   
   If Err.Number <> 0 Then
      If Err.Number = -2147217873 Then
         If p_Msg = Empty Then p_Msg = p_NewKey
         strExc(0) = "select st02 from LockRec,staff where LR01='" & p_NewKey & "' and st01(+)=LR02"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            MsgBox "【" & p_Msg & "】正被【" & RsTemp.Fields(0) & "】使用中，請確認！"
         Else
            MsgBox "【" & p_Msg & "】正被使用中，請確認！"
         End If
      Else
         MsgBox Err.Description, vbCritical
      End If
   End If
End Function

'Add by Morgan 2006/5/4
'取得信函收件人的代碼
'A.一般:1.代理人->2.申請人
'B.年費:1.基本檔年費代理人->2.申請人年費代理人->3.A
'C.延展:1.基本檔延展代理人->2.代理人延展代理人2.申請人延展代理人->3.A
Public Function PUB_GetReceiver(ByVal p_Cp01 As String, ByVal p_Cp02 As String, ByVal p_Cp03 As String, ByVal p_Cp04 As String, Optional ByVal p_CP10 As String, Optional ByVal p_SysKind As String) As String
   Dim adoRst As ADODB.Recordset, intR As Integer
   If p_SysKind = Empty Then
      
      strSql = "SELECT SK02 FROM SYSTEMKIND WHERE SK01='" & p_Cp01 & "'"
      intR = 1
      Set adoRst = ClsLawReadRstMsg(intR, strSql)
      If intR = 1 Then
         p_SysKind = "" & adoRst.Fields(0)
      End If
      If p_SysKind = Empty Then p_SysKind = "1"
   End If
   
   Select Case p_SysKind
      Case "1" '專利
         Select Case p_CP10
            Case "605", "1605" '年費,通知年費逾期
               '規則
               strSql = "Select Nvl(PA76, Nvl(CU96, Nvl(PA75, PA26))) From Patent, Customer Where PA01='" & p_Cp01 & "' AND PA02='" & p_Cp02 & "' AND PA03='" & p_Cp03 & "' AND PA04='" & p_Cp04 & "' And substr(PA26,1,8)=CU01(+) And substr(PA26,9,1)=CU02(+) "
            Case Else
               strSql = "SELECT Nvl(PA75, PA26) FROM PATENT WHERE PA01='" & p_Cp01 & "' AND PA02='" & p_Cp02 & "' AND PA03='" & p_Cp03 & "' AND PA04='" & p_Cp04 & "'"
         End Select
      Case "2" '商標
         Select Case p_CP10
            Case "102" '延展
               strSql = "Select Nvl(TM33, Nvl(FA66, Nvl(CU98, Nvl(TM44, TM23)))) From Trademark, Fagent, Customer Where TM01='" & p_Cp01 & "' AND TM02='" & p_Cp02 & "' AND TM03='" & p_Cp03 & "' AND TM04='" & p_Cp04 & "' And substr(TM44,1,8)=FA01(+) And substr(TM44,9,1)=FA02(+) And substr(TM23,1,8)=CU01(+) And substr(TM23,9,1)=CU02(+) "
            Case Else
               strSql = "SELECT Nvl(TM44, TM23) FROM TRADEMARK WHERE TM01='" & p_Cp01 & "' AND TM02='" & p_Cp02 & "' AND TM03='" & p_Cp03 & "' AND TM04='" & p_Cp04 & "'"
         End Select
      'Added by Morgan 2020/12/9
      Case "3" '法務
         strSql = "SELECT Nvl(LC22, LC11) FROM LAWCASE WHERE LC01='" & p_Cp01 & "' AND LC02='" & p_Cp02 & "' AND LC03='" & p_Cp03 & "' AND LC04='" & p_Cp04 & "'"
      'end 2020/12/9
      Case Else
         strSql = "SELECT Nvl(SP26, Nvl(SP08,Nvl(SP58,SP59))) FROM SERVICEPRACTICE WHERE SP01='" & p_Cp01 & "' AND SP02='" & p_Cp02 & "' AND SP03='" & p_Cp03 & "' AND SP04='" & p_Cp04 & "'"
   End Select
   
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, strSql)
   If intR = 1 Then
      PUB_GetReceiver = "" & adoRst.Fields(0)
   End If
   Set adoRst = Nothing
End Function
'Add by Morgan 2006/5/25
'取得定稿語文1.基本檔2.收件人(信函抬頭)
Public Function PUB_GetLanguage(ByVal p_Cp01 As String, ByVal p_Cp02 As String, ByVal p_Cp03 As String, ByVal p_Cp04 As String, Optional ByVal p_CP10 As String, Optional ByVal p_SysKind As String) As String

   Dim stLanguage As String, stReceiver As String
   
   If p_SysKind = Empty Then
      CheckOC
      strSql = "SELECT SK02 FROM SYSTEMKIND WHERE SK01='" & p_Cp01 & "'"
      With adoRecordset
         .CursorLocation = adUseClient
         .Open strSql, cnnConnection, adOpenForwardOnly, adLockReadOnly
         If .RecordCount > 0 Then
            p_SysKind = "" & .Fields(0)
         End If
      End With
      If p_SysKind = Empty Then p_SysKind = "1"
   End If
   
   p_Cp03 = Right("0" & p_Cp03, 1)
   p_Cp04 = Right("00" & p_Cp04, 2)
   
   '先抓基本檔設定
   Select Case p_SysKind
      Case "1" '專利
         strSql = "SELECT PA85 FROM PATENT WHERE PA01='" & p_Cp01 & "' AND PA02='" & p_Cp02 & "' AND PA03='" & p_Cp03 & "' AND PA04='" & p_Cp04 & "'"
      Case "2" '商標
         strSql = "SELECT TM53 FROM TRADEMARK WHERE TM01='" & p_Cp01 & "' AND TM02='" & p_Cp02 & "' AND TM03='" & p_Cp03 & "' AND TM04='" & p_Cp04 & "'"
      'Add by Morgan 2006/7/5
      Case "4" '顧問
         stLanguage = "1"
      Case Else
         strSql = "SELECT SP34 FROM SERVICEPRACTICE WHERE SP01='" & p_Cp01 & "' AND SP02='" & p_Cp02 & "' AND SP03='" & p_Cp03 & "' AND SP04='" & p_Cp04 & "'"
   End Select
   If stLanguage = "" Then
      CheckOC
      With adoRecordset
      .CursorLocation = adUseClient
      .Open strSql, cnnConnection, adOpenForwardOnly, adLockReadOnly
      If .RecordCount > 0 Then
         stLanguage = "" & .Fields(0)
      End If
      '再抓代理人/客戶檔設定
      If stLanguage = "" Then
         stReceiver = PUB_GetReceiver(p_Cp01, p_Cp02, p_Cp03, p_Cp04, p_CP10, p_SysKind)
         If Left(stReceiver, 1) = "Y" Then
            strSql = "select FA31 from Fagent where fa01||fa02='" & stReceiver & "'"
         Else
            strSql = "select CU64 from Customer where cu01||cu02='" & stReceiver & "'"
         End If
         CheckOC
         .CursorLocation = adUseClient
         .Open strSql, cnnConnection, adOpenForwardOnly, adLockReadOnly
         If .RecordCount > 0 Then
            stLanguage = "" & .Fields(0)
         End If
      End If
      End With
   End If
   
   If stLanguage = "" Then
      '外的預設英文,其他中文
      If Left(p_Cp01, 1) = "F" Then
         stLanguage = "2"
      Else
         stLanguage = "1"
      End If
   End If
   PUB_GetLanguage = stLanguage
End Function
'add by nickc 2006/05/11 將字串置中
'oStr    要置中的字串
'oIntLen 實際放至長度
'Modified by Lydia 2022/04/15  +Public並且更名 StrToStrCenter=>Pub_StrToCenter
'Public Function StrToStrCenter(oStr As String, oIntLen As Integer) As String
Public Function Pub_StrToCenter(oStr As String, oIntLen As Integer) As String
'edit by nickc 2006/05/17 修正字串比 oIntLen 長
If LenB(StrConv(oStr, vbFromUnicode)) > oIntLen Then
    oStr = StrConv(MidB(StrConv(oStr, vbFromUnicode), 1, oIntLen), vbUnicode)
End If
Pub_StrToCenter = String(Int((oIntLen - LenB(StrConv(oStr, vbFromUnicode))) / 2), " ") & Trim(oStr) & String(oIntLen - LenB(StrConv(String(Int((oIntLen - LenB(StrConv(oStr, vbFromUnicode))) / 2), " ") & Trim(oStr), vbFromUnicode)), " ")
End Function
'Add by Morgan 2006/5/12
'Modified by Morgan 2012/7/5 +p_Type:'主張優先權期限適用類別 1.發明或新型,2.設計
'最早優先權日
'Modified by Morgan 2024/4/11 +p_PA08:主張案的專利種類
Public Function PUB_GetFirstPriDate(ByRef p_PD() As String, Optional p_Type As String, Optional p_PA08 As String) As String
   strSql = "Select min(PD05),max(PD08),max(pa08) From PriDate,patent Where PD01='" & p_PD(1) & "' AND PD02='" & p_PD(2) & "' AND PD03='" & p_PD(3) & "' AND PD04='" & p_PD(4) & "'" & _
      " and pa01(+)=pd01 and pa02(+)=pd02 and pa03(+)=pd03 and pa04(+)=pd04"
   CheckOC
   With adoRecordset
   .CursorLocation = adUseClient
   .Open strSql, cnnConnection, adOpenForwardOnly, adLockReadOnly
   If .RecordCount > 0 Then
      PUB_GetFirstPriDate = "" & .Fields(0)
      If .Fields(1) = "3" Then
         p_Type = "2"
      Else
         p_Type = "1"
      End If
      p_PA08 = "" & .Fields(2) 'Added by Morgan 2024/4/11
   End If
   End With
End Function
'計算PCT(發明)進入國家階段期限 p_Date1:申請日/優先權日 ,p_Date2:法定期限, p_Date3:本所期限, p_Country:申請國家
'Modified by Lydia 2014/11/24 PCT進各個國家階段之期限設定 (不傳p_414,改傳本所案號進行判斷)
'Public Function PUB_GetPCTLimit(ByVal p_Date1 As String, ByRef p_Date2 As String, ByRef p_Date3 As String, Optional ByVal p_Country As String = "000", Optional p_414 As Boolean = False)
Public Function PUB_GetPCTLimit(ByVal p_Date1 As String, ByRef p_Date2 As String, ByRef p_Date3 As String, ByVal p01 As String, ByVal p02 As String, ByVal p03 As String, ByVal p04 As String, Optional ByVal p_Country As String = "000")
Dim rsA As New ADODB.Recordset, strPA08 As String
'Modified by Lydia 2014/11/24 PCT進各個國家階段之期限設定 (不傳p_414,改傳本所案號進行判斷)
'NA75,NA76若無值則為30個月;1.若案件有收文未發文未取消收文的414(恢愎原狀),抓NA76,未設定者仍抓NA75;

   '法限=申請日(最早優先權日)+30月 'Modified by Lydia 2014/11/24 先前p_414已不使用
'   If p_414 Then
'      p_Date2 = TransDate(CompDate(1, 32, p_Date1), 1)
'   Else
'      'Added by Morgan 2011/12/14 PCT進EPC改31個月(和實審期限一樣)--郭雅娟
'      '2014/3/24 MODIFY BY SONIA 加韓國012,澳洲015,印度040InStr(NewCasePtyList & ",803", p_CP10) > 0
'      'If p_Country = "221" Then
'      If InStr("012,015,040,221", p_Country) > 0 Then
'         p_Date2 = TransDate(CompDate(1, 31, p_Date1), 1)
'      Else
'      'end 2011/12/14
'         p_Date2 = TransDate(CompDate(1, 30, p_Date1), 1)
'      End If
'   End If
   
    strSql = " select NA01,NA03,nvl(NA75,30) NA75,nvl(NA76,30) NA76,CP09,PA08 from PATENT,NATION, " & _
             "(select CP01,CP02,CP03,CP04,CP09 from CASEPROGRESS where CP10='414' and CP27 IS NULL and CP57 IS NULL and CP01='" & p01 & "' and CP02='" & p02 & "' " & _
             "and CP03='" & p03 & "' and CP04='" & p04 & "') XN " & _
             "where PA09=NA01(+) and PA01=CP01(+) and PA02=CP02(+) and PA03=CP03(+) and PA04=CP04(+) " & _
             "and pa01='" & p01 & "' and pa02='" & p02 & "' and pa03='" & p03 & "' and pa04='" & p04 & "' "
    Set rsA = New ADODB.Recordset
    If rsA.State = 1 Then rsA.Close
    rsA.CursorLocation = adUseClient
    rsA.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
    If rsA.RecordCount <> 0 Then
       If Len(LTrim(RTrim(rsA!CP09))) > 0 Then '有收文未發文未取消收文的414(恢愎原狀),抓NA76
          p_Date2 = TransDate(CompDate(1, rsA!NA76, p_Date1), 1)
       Else
          p_Date2 = TransDate(CompDate(1, rsA!NA75, p_Date1), 1)
       End If
       strPA08 = rsA("pa08") 'Added by Morgan 2015/12/14
    End If
'end 'Modified by Lydia 2014/11/24 PCT

   '所限同主張優先權
   '台灣:所限=法限-2天
   If p_Country = 台灣國家代號 Then
      p_Date3 = TransDate(CompDate(2, -2, p_Date2), 1)
   
   'Modified by Morgan 2015/12/14 改用函數(CFP所限規則要一致)--禧佩 CFP-28161
   ''非英語系國家:所限=法定-14天
   'ElseIf InStr(NoneEngCountry, p_Country) > 0 Then
   '   p_Date3 = TransDate(CompDate(2, -14, p_Date2), 1)
   ''其他國家:所限=法定-7天
   ElseIf p01 = "CFP" Then
      p_Date3 = PUB_GetCP06byCP07(p_Date2, p_Country, strPA08)
   'end 2015/12/14
   
   Else
      p_Date3 = TransDate(CompDate(2, -7, p_Date2), 1)
   End If
   'Added by Lydia 2025/10/29 大陸PCT案
   'Modified by Lydia 2025/10/31 非台灣案(大陸、香港、澳門和PCT)都是相同算法---郭經理(電話)
   'If p01 = "P" And p_Country = 大陸國家代號 And strSrvDate(1) >= 內專本所約定期限啟用日 Then
   If p01 = "P" And p_Country <> 台灣國家代號 And strSrvDate(1) >= 內專本所約定期限啟用日 Then
      p_Date3 = PUB_GetPOurDeadline(p_Date2, p_Country)
   End If
   'end 2025/10/29
   
   p_Date3 = TransDate(PUB_GetWorkDay1(p_Date3, True), 1)
   '若所限小於系統日時改為系統日
   If Val(p_Date3) < Val(strSrvDate(2)) Then
      p_Date3 = strSrvDate(2)
   End If
End Function

'add by nickc 2006/05/24
Public Function FileExists(FileName As String) As Boolean
    If Len(FileName) > 0 Then FileExists = (Len(Dir(FileName, vbNormal Or vbReadOnly Or vbHidden Or vbSystem Or vbArchive)) > 0)
End Function
Public Sub RidFile(FileName As String)
    If FileExists(FileName) Then
        SetAttr FileName, vbNormal
        Kill FileName
    End If
End Sub
'add by nickc 2006/06/06 EDFun 開頭都是加解密用
Sub EDFun_Init()
    m_InCo(0) = &HB: m_InCo(1) = &HD: m_InCo(2) = &H9: m_InCo(3) = &HE
    m_bytOnBits(0) = 1: m_bytOnBits(1) = 3: m_bytOnBits(2) = 7: m_bytOnBits(3) = 15
    m_bytOnBits(4) = 31: m_bytOnBits(5) = 63: m_bytOnBits(6) = 127: m_bytOnBits(7) = 255
    m_byt2Power(0) = 1: m_byt2Power(1) = 2: m_byt2Power(2) = 4: m_byt2Power(3) = 8
    m_byt2Power(4) = 16: m_byt2Power(5) = 32: m_byt2Power(6) = 64: m_byt2Power(7) = 128
    m_lOnBits(0) = 1: m_lOnBits(1) = 3: m_lOnBits(2) = 7: m_lOnBits(3) = 15: m_lOnBits(4) = 31
    m_lOnBits(5) = 63: m_lOnBits(6) = 127: m_lOnBits(7) = 255: m_lOnBits(8) = 511
    m_lOnBits(9) = 1023: m_lOnBits(10) = 2047: m_lOnBits(11) = 4095: m_lOnBits(12) = 8191
    m_lOnBits(13) = 16383: m_lOnBits(14) = 32767: m_lOnBits(15) = 65535: m_lOnBits(16) = 131071
    m_lOnBits(17) = 262143: m_lOnBits(18) = 524287: m_lOnBits(19) = 1048575: m_lOnBits(20) = 2097151
    m_lOnBits(21) = 4194303: m_lOnBits(22) = 8388607: m_lOnBits(23) = 16777215: m_lOnBits(24) = 33554431
    m_lOnBits(25) = 67108863: m_lOnBits(26) = 134217727: m_lOnBits(27) = 268435455: m_lOnBits(28) = 536870911
    m_lOnBits(29) = 1073741823: m_lOnBits(30) = 2147483647
    m_l2Power(0) = 1: m_l2Power(1) = 2: m_l2Power(2) = 4: m_l2Power(3) = 8: m_l2Power(4) = 16
    m_l2Power(5) = 32: m_l2Power(6) = 64: m_l2Power(7) = 128: m_l2Power(8) = 256: m_l2Power(9) = 512
    m_l2Power(10) = 1024: m_l2Power(11) = 2048: m_l2Power(12) = 4096: m_l2Power(13) = 8192
    m_l2Power(14) = 16384: m_l2Power(15) = 32768: m_l2Power(16) = 65536: m_l2Power(17) = 131072
    m_l2Power(18) = 262144: m_l2Power(19) = 524288: m_l2Power(20) = 1048576: m_l2Power(21) = 2097152
    m_l2Power(22) = 4194304: m_l2Power(23) = 8388608: m_l2Power(24) = 16777216: m_l2Power(25) = 33554432
    m_l2Power(26) = 67108864: m_l2Power(27) = 134217728: m_l2Power(28) = 268435456: m_l2Power(29) = 536870912
    m_l2Power(30) = 1073741824
End Sub
Public Function EDFun_LShift(ByVal lValue As Long, ByVal iShiftBits As Integer) As Long
    If iShiftBits = 0 Then
        EDFun_LShift = lValue
        Exit Function
    ElseIf iShiftBits = 31 Then
        If lValue And 1 Then
            EDFun_LShift = &H80000000
        Else
            EDFun_LShift = 0
        End If
        Exit Function
    ElseIf iShiftBits < 0 Or iShiftBits > 31 Then
        Err.Raise 6
    End If
    If (lValue And m_l2Power(31 - iShiftBits)) Then
        EDFun_LShift = ((lValue And m_lOnBits(31 - (iShiftBits + 1))) * m_l2Power(iShiftBits)) Or &H80000000
    Else
        EDFun_LShift = ((lValue And m_lOnBits(31 - iShiftBits)) * m_l2Power(iShiftBits))
    End If
End Function
Public Function EDFun_RShift(ByVal lValue As Long, ByVal iShiftBits As Integer) As Long
    If iShiftBits = 0 Then
        EDFun_RShift = lValue
        Exit Function
    ElseIf iShiftBits = 31 Then
        If lValue And &H80000000 Then
            EDFun_RShift = 1
        Else
            EDFun_RShift = 0
        End If
        Exit Function
    ElseIf iShiftBits < 0 Or iShiftBits > 31 Then
        Err.Raise 6
    End If
    EDFun_RShift = (lValue And &H7FFFFFFE) \ m_l2Power(iShiftBits)
    If (lValue And &H80000000) Then
        EDFun_RShift = (EDFun_RShift Or (&H40000000 \ m_l2Power(iShiftBits - 1)))
    End If
End Function
Public Function EDFun_LShiftByte(ByVal bytValue As Byte, ByVal bytShiftBits As Byte) As Byte
    If bytShiftBits = 0 Then
        EDFun_LShiftByte = bytValue
        Exit Function
    ElseIf bytShiftBits = 7 Then
        If bytValue And 1 Then
            EDFun_LShiftByte = &H80
        Else
            EDFun_LShiftByte = 0
        End If
        Exit Function
    ElseIf bytShiftBits < 0 Or bytShiftBits > 7 Then
        Err.Raise 6
    End If
    EDFun_LShiftByte = ((bytValue And m_bytOnBits(7 - bytShiftBits)) * m_byt2Power(bytShiftBits))
End Function
Public Function EDFun_RShiftByte(ByVal bytValue As Byte, ByVal bytShiftBits As Byte) As Byte
    If bytShiftBits = 0 Then
        EDFun_RShiftByte = bytValue
        Exit Function
    ElseIf bytShiftBits = 7 Then
        If bytValue And &H80 Then
            EDFun_RShiftByte = 1
        Else
            EDFun_RShiftByte = 0
        End If
        Exit Function
    ElseIf bytShiftBits < 0 Or bytShiftBits > 7 Then
        Err.Raise 6
    End If
    EDFun_RShiftByte = bytValue \ m_byt2Power(bytShiftBits)
End Function
Public Function EDFun_RotateLeft(ByVal lValue As Long, ByVal iShiftBits As Integer) As Long
    EDFun_RotateLeft = EDFun_LShift(lValue, iShiftBits) Or EDFun_RShift(lValue, (32 - iShiftBits))
End Function
Public Function EDFun_RotateLeftByte(ByVal bytValue As Byte, ByVal bytShiftBits As Byte) As Byte
    EDFun_RotateLeftByte = EDFun_LShiftByte(bytValue, bytShiftBits) Or EDFun_RShiftByte(bytValue, (8 - bytShiftBits))
End Function
Public Function EDFun_Pack(B() As Byte) As Long
    Dim Lcount As Long, lTemp As Long
    For Lcount = 0 To 3
        lTemp = B(Lcount)
        EDFun_Pack = EDFun_Pack Or EDFun_LShift(lTemp, (Lcount * 8))
    Next
End Function
Public Function EDFun_PackFrom(B() As Byte, ByVal k As Long) As Long
    Dim Lcount As Long, lTemp As Long
    For Lcount = 0 To 3
        lTemp = B(Lcount + k)
        EDFun_PackFrom = EDFun_PackFrom Or EDFun_LShift(lTemp, (Lcount * 8))
    Next
End Function
Public Sub EDFun_Un_Pack(ByVal a As Long, B() As Byte)
    B(0) = a And m_lOnBits(7)
    B(1) = EDFun_RShift(a, 8) And m_lOnBits(7)
    B(2) = EDFun_RShift(a, 16) And m_lOnBits(7)
    B(3) = EDFun_RShift(a, 24) And m_lOnBits(7)
End Sub
Public Sub EDFun_Un_PackFrom(ByVal a As Long, B() As Byte, ByVal k As Long)
    B(0 + k) = a And m_lOnBits(7)
    B(1 + k) = EDFun_RShift(a, 8) And m_lOnBits(7)
    B(2 + k) = EDFun_RShift(a, 16) And m_lOnBits(7)
    B(3 + k) = EDFun_RShift(a, 24) And m_lOnBits(7)
End Sub
Public Function EDFun_xtime(ByVal a As Byte) As Byte
    Dim B As Byte
    If (a And &H80) Then
        B = &H1B
    Else
        B = 0
    End If
    a = EDFun_LShiftByte(a, 1)
    a = a Xor B
    EDFun_xtime = a
End Function
Public Function EDFun_bmul(ByVal X As Byte, Y As Byte) As Byte
    If X <> 0 And Y <> 0 Then
        EDFun_bmul = m_ptab((CLng(m_ltab(X)) + CLng(m_ltab(Y))) Mod 255)
    Else
        EDFun_bmul = 0
    End If
End Function
Public Function EDFun_SubByte(ByVal a As Long) As Long
    Dim B(3) As Byte
    EDFun_Un_Pack a, B
    B(0) = m_fbsub(B(0))
    B(1) = m_fbsub(B(1))
    B(2) = m_fbsub(B(2))
    B(3) = m_fbsub(B(3))
    EDFun_SubByte = EDFun_Pack(B)
End Function
Public Function EDFun_product(ByVal X As Long, ByVal Y As Long) As Long
    Dim xb(3) As Byte, yb(3) As Byte
    EDFun_Un_Pack X, xb
    EDFun_Un_Pack Y, yb
    EDFun_product = EDFun_bmul(xb(0), yb(0)) Xor EDFun_bmul(xb(1), yb(1)) Xor EDFun_bmul(xb(2), yb(2)) Xor EDFun_bmul(xb(3), yb(3))
End Function
Public Function EDFun_InvMixCol(ByVal X As Long) As Long
    Dim Y As Long, m As Long, B(3) As Byte
    m = EDFun_Pack(m_InCo)
    B(3) = EDFun_product(m, X)
    m = EDFun_RotateLeft(m, 24)
    B(2) = EDFun_product(m, X)
    m = EDFun_RotateLeft(m, 24)
    B(1) = EDFun_product(m, X)
    m = EDFun_RotateLeft(m, 24)
    B(0) = EDFun_product(m, X)
    Y = EDFun_Pack(B)
    EDFun_InvMixCol = Y
End Function
Public Function EDFun_ByteSub(ByVal X As Byte) As Byte
    Dim Y As Byte
    Y = m_ptab(255 - m_ltab(X))
    X = Y
    X = EDFun_RotateLeftByte(X, 1)
    Y = Y Xor X
    X = EDFun_RotateLeftByte(X, 1)
    Y = Y Xor X
    X = EDFun_RotateLeftByte(X, 1)
    Y = Y Xor X
    X = EDFun_RotateLeftByte(X, 1)
    Y = Y Xor X
    Y = Y Xor &H63
    EDFun_ByteSub = Y
End Function
Public Sub EDFun_GenTables()
    Dim i As Long, Y As Byte, B(3) As Byte, iB As Byte
    m_ltab(0) = 0
    m_ptab(0) = 1
    m_ltab(1) = 0
    m_ptab(1) = 3
    m_ltab(3) = 1
    For i = 2 To 255
        m_ptab(i) = m_ptab(i - 1) Xor EDFun_xtime(m_ptab(i - 1))
        m_ltab(m_ptab(i)) = i
    Next
    m_fbsub(0) = &H63
    m_rbsub(&H63) = 0
    For i = 1 To 255
        iB = i
        Y = EDFun_ByteSub(iB)
        m_fbsub(i) = Y
        m_rbsub(Y) = i
    Next
        Y = 1
    For i = 0 To 29
        m_rco(i) = Y
        Y = EDFun_xtime(Y)
    Next
    For i = 0 To 255
        Y = m_fbsub(i)
        B(3) = Y Xor EDFun_xtime(Y)
        B(2) = Y
        B(1) = Y
        B(0) = EDFun_xtime(Y)
        m_ftable(i) = EDFun_Pack(B)
        
        Y = m_rbsub(i)
        B(3) = EDFun_bmul(m_InCo(0), Y)
        B(2) = EDFun_bmul(m_InCo(1), Y)
        B(1) = EDFun_bmul(m_InCo(2), Y)
        B(0) = EDFun_bmul(m_InCo(3), Y)
        m_rtable(i) = EDFun_Pack(B)
    Next
End Sub
Public Sub EDFun_gKey(ByVal Nb As Long, ByVal nk As Long, KEY() As Byte)
    Dim i As Long, j As Long, k As Long, m As Long, n As Long, C1 As Long, C2 As Long, c3 As Long, CipherKey(7) As Long
    m_Nb = Nb
    m_Nk = nk
    If m_Nb >= m_Nk Then
        m_Nr = 6 + m_Nb
    Else
        m_Nr = 6 + m_Nk
    End If
    C1 = 1
    If m_Nb < 8 Then
        C2 = 2
        c3 = 3
    Else
        C2 = 3
        c3 = 4
    End If
    For j = 0 To Nb - 1
        m = j * 3
        m_fi(m) = (j + C1) Mod Nb
        m_fi(m + 1) = (j + C2) Mod Nb
        m_fi(m + 2) = (j + c3) Mod Nb
        m_ri(m) = (Nb + j - C1) Mod Nb
        m_ri(m + 1) = (Nb + j - C2) Mod Nb
        m_ri(m + 2) = (Nb + j - c3) Mod Nb
    Next
    n = m_Nb * (m_Nr + 1)
    For i = 0 To m_Nk - 1
        j = i * 4
        CipherKey(i) = EDFun_PackFrom(KEY, j)
    Next
    For i = 0 To m_Nk - 1
        m_fkey(i) = CipherKey(i)
    Next
    j = m_Nk
    k = 0
    Do While j < n
        m_fkey(j) = m_fkey(j - m_Nk) Xor _
            EDFun_SubByte(EDFun_RotateLeft(m_fkey(j - 1), 24)) Xor m_rco(k)
        If m_Nk <= 6 Then
            i = 1
            Do While i < m_Nk And (i + j) < n
                m_fkey(i + j) = m_fkey(i + j - m_Nk) Xor _
                    m_fkey(i + j - 1)
                i = i + 1
            Loop
        Else
            i = 1
            Do While i < 4 And (i + j) < n
                m_fkey(i + j) = m_fkey(i + j - m_Nk) Xor _
                    m_fkey(i + j - 1)
                i = i + 1
            Loop
            If j + 4 < n Then
                m_fkey(j + 4) = m_fkey(j + 4 - m_Nk) Xor _
                    EDFun_SubByte(m_fkey(j + 3))
            End If
            i = 5
            Do While i < m_Nk And (i + j) < n
                m_fkey(i + j) = m_fkey(i + j - m_Nk) Xor _
                    m_fkey(i + j - 1)
                i = i + 1
            Loop
        End If
        j = j + m_Nk
        k = k + 1
    Loop
    For j = 0 To m_Nb - 1
        m_rkey(j + n - Nb) = m_fkey(j)
    Next
    i = m_Nb
    Do While i < n - m_Nb
        k = n - m_Nb - i
        For j = 0 To m_Nb - 1
            m_rkey(k + j) = EDFun_InvMixCol(m_fkey(i + j))
        Next
        i = i + m_Nb
    Loop
    j = n - m_Nb
    Do While j < n
        m_rkey(j - n + m_Nb) = m_fkey(j)
        j = j + 1
    Loop
End Sub
Public Sub EDFun_Encrypt(Buff() As Byte)
    Dim i As Long, j As Long, k As Long, m As Long, a(7) As Long, B(7) As Long, X() As Long, Y() As Long, t() As Long
    For i = 0 To m_Nb - 1
        j = i * 4
        a(i) = EDFun_PackFrom(Buff, j)
        a(i) = a(i) Xor m_fkey(i)
    Next
    k = m_Nb
    X = a
    Y = B
    For i = 1 To m_Nr - 1
        For j = 0 To m_Nb - 1
            m = j * 3
            Y(j) = m_fkey(k) Xor m_ftable(X(j) And m_lOnBits(7)) Xor _
                EDFun_RotateLeft(m_ftable(EDFun_RShift(X(m_fi(m)), 8) And m_lOnBits(7)), 8) Xor _
                EDFun_RotateLeft(m_ftable(EDFun_RShift(X(m_fi(m + 1)), 16) And m_lOnBits(7)), 16) Xor _
                EDFun_RotateLeft(m_ftable(EDFun_RShift(X(m_fi(m + 2)), 24) And m_lOnBits(7)), 24)
            k = k + 1
        Next
        t = X
        X = Y
        Y = t
    Next
    For j = 0 To m_Nb - 1
        m = j * 3
        Y(j) = m_fkey(k) Xor m_fbsub(X(j) And m_lOnBits(7)) Xor _
            EDFun_RotateLeft(m_fbsub(EDFun_RShift(X(m_fi(m)), 8) And m_lOnBits(7)), 8) Xor _
            EDFun_RotateLeft(m_fbsub(EDFun_RShift(X(m_fi(m + 1)), 16) And m_lOnBits(7)), 16) Xor _
            EDFun_RotateLeft(m_fbsub(EDFun_RShift(X(m_fi(m + 2)), 24) And m_lOnBits(7)), 24)
        k = k + 1
    Next
    For i = 0 To m_Nb - 1
        j = i * 4
        EDFun_Un_PackFrom Y(i), Buff, j
        X(i) = 0
        Y(i) = 0
    Next
End Sub
Public Sub EDFun_Decrypt(Buff() As Byte)
    Dim i As Long, j As Long, k As Long, m As Long, a(7) As Long, B(7) As Long, X() As Long, Y() As Long, t() As Long
    For i = 0 To m_Nb - 1
        j = i * 4
        a(i) = EDFun_PackFrom(Buff, j)
        a(i) = a(i) Xor m_rkey(i)
    Next
    k = m_Nb
    X = a
    Y = B
    For i = 1 To m_Nr - 1
        For j = 0 To m_Nb - 1
            m = j * 3
            Y(j) = m_rkey(k) Xor m_rtable(X(j) And m_lOnBits(7)) Xor _
                EDFun_RotateLeft(m_rtable(EDFun_RShift(X(m_ri(m)), 8) And m_lOnBits(7)), 8) Xor _
                EDFun_RotateLeft(m_rtable(EDFun_RShift(X(m_ri(m + 1)), 16) And m_lOnBits(7)), 16) Xor _
                EDFun_RotateLeft(m_rtable(EDFun_RShift(X(m_ri(m + 2)), 24) And m_lOnBits(7)), 24)
            k = k + 1
        Next
        t = X
        X = Y
        Y = t
    Next
    For j = 0 To m_Nb - 1
        m = j * 3
        Y(j) = m_rkey(k) Xor m_rbsub(X(j) And m_lOnBits(7)) Xor _
            EDFun_RotateLeft(m_rbsub(EDFun_RShift(X(m_ri(m)), 8) And m_lOnBits(7)), 8) Xor _
            EDFun_RotateLeft(m_rbsub(EDFun_RShift(X(m_ri(m + 1)), 16) And m_lOnBits(7)), 16) Xor _
            EDFun_RotateLeft(m_rbsub(EDFun_RShift(X(m_ri(m + 2)), 24) And m_lOnBits(7)), 24)
        k = k + 1
    Next
    For i = 0 To m_Nb - 1
        j = i * 4
        EDFun_Un_PackFrom Y(i), Buff, j
        X(i) = 0
        Y(i) = 0
    Next i
End Sub
Public Function EDFun_IsInitialized(ByRef vArray As Variant) As Boolean
    On Error Resume Next
    EDFun_IsInitialized = IsNumeric(UBound(vArray))
End Function
Public Function EDFun_EncryptData(bytMessage() As Byte, bytPassword() As Byte) As Byte()
    Dim bytKey(31) As Byte, bytIn() As Byte, bytOut() As Byte, bytTemp(31) As Byte
    Dim Lcount As Long, lLength As Long, lEncodedLength As Long, bytLen(3) As Byte, lPosition As Long
    If Not EDFun_IsInitialized(bytMessage) Then
        Exit Function
    End If
    If Not EDFun_IsInitialized(bytPassword) Then
        Exit Function
    End If
    For Lcount = 0 To UBound(bytPassword)
        bytKey(Lcount) = bytPassword(Lcount)
        If Lcount = 31 Then
            Exit For
        End If
    Next Lcount
    EDFun_GenTables
    EDFun_gKey 8, 8, bytKey
    lLength = UBound(bytMessage) + 1
    lEncodedLength = lLength + 4
    If lEncodedLength Mod 32 <> 0 Then
        lEncodedLength = lEncodedLength + 32 - (lEncodedLength Mod 32)
    End If
    ReDim bytIn(lEncodedLength - 1)
    ReDim bytOut(lEncodedLength - 1)
    CopyMemory VarPtr(bytIn(0)), VarPtr(lLength), 4
    CopyMemory VarPtr(bytIn(4)), VarPtr(bytMessage(0)), lLength
    For Lcount = 0 To lEncodedLength - 1 Step 32
        CopyMemory VarPtr(bytTemp(0)), VarPtr(bytIn(Lcount)), 32
        EDFun_Encrypt bytTemp
        CopyMemory VarPtr(bytOut(Lcount)), VarPtr(bytTemp(0)), 32
    Next
    EDFun_EncryptData = bytOut
End Function
Public Function EDFun_DecryptData(bytIn() As Byte, bytPassword() As Byte) As Byte()
    Dim bytMessage() As Byte, bytKey(31) As Byte, bytOut() As Byte, bytTemp(31) As Byte
    Dim Lcount As Long, lLength As Long, lEncodedLength As Long, bytLen(3) As Byte
    Dim lPosition As Long
    If Not EDFun_IsInitialized(bytIn) Then
        Exit Function
    End If
    If Not EDFun_IsInitialized(bytPassword) Then
        Exit Function
    End If
    lEncodedLength = UBound(bytIn) + 1
    If lEncodedLength Mod 32 <> 0 Then
        Exit Function
    End If
    For Lcount = 0 To UBound(bytPassword)
        bytKey(Lcount) = bytPassword(Lcount)
        If Lcount = 31 Then
            Exit For
        End If
    Next Lcount
    EDFun_GenTables
    EDFun_gKey 8, 8, bytKey
    ReDim bytOut(lEncodedLength - 1)
    For Lcount = 0 To lEncodedLength - 1 Step 32
        CopyMemory VarPtr(bytTemp(0)), VarPtr(bytIn(Lcount)), 32
        EDFun_Decrypt bytTemp
        CopyMemory VarPtr(bytOut(Lcount)), VarPtr(bytTemp(0)), 32
    Next
    CopyMemory VarPtr(lLength), VarPtr(bytOut(0)), 4
    If lLength > lEncodedLength - 4 Then
        Exit Function
    End If
    ReDim bytMessage(lLength - 1)
    CopyMemory VarPtr(bytMessage(0)), VarPtr(bytOut(4)), lLength
    EDFun_DecryptData = bytMessage
End Function
'加密
Public Function StrEncrypt(oStr As String) As String
    Dim bytSrc() As Byte
    Dim bytDec() As Byte
    Dim bytKey() As Byte
    Dim Lcount As Long
    Dim oStr2 As String
    EDFun_Init
    bytSrc = oStr
    bytKey = "93013"
    bytDec = EDFun_EncryptData(bytSrc, bytKey)
    oStr2 = ""
    For Lcount = 0 To UBound(bytDec)
        oStr2 = oStr2 & Right("0" & Hex(bytDec(Lcount)), 2)
    Next
    StrEncrypt = oStr2
End Function
'解密
Public Function StrDecrypt(oStr As String) As String
    Dim bytSrc() As Byte
    Dim bytDec() As Byte
    Dim bytKey() As Byte
    Dim Lcount As Long
    Dim lLength As Long
    EDFun_Init
    lLength = Len(oStr)
    ReDim bytSrc((lLength \ 2) - 1)
    For Lcount = 1 To lLength Step 2
      bytSrc(Lcount \ 2) = CByte("&H" & Mid(oStr, Lcount, 2))
    Next Lcount
    bytKey = "93013"
    bytDec = EDFun_DecryptData(bytSrc, bytKey)
    StrDecrypt = bytDec
End Function

'************************************加解密結束
'add by nickc 2006/06/14 抓 內商大對台的請款資料
'Modified by Lydia 2016/12/22 + 是否合計 bolTotal,幣別顯示 rCurr
'Modified by Lydia 2017/04/06 + 請款對象rA1k28
Function GetT_020_a1k_data(oCP01 As String, oCP02 As String, Optional oCP03 As String = "0", Optional oCP04 As String = "00", Optional rCurr As String = "1", Optional bolTotal As Boolean = False, Optional ByRef rA1k28 As String) As String
'Add By Sindy 2009/09/07
'Remove by Lydia 2016/12/22
'Dim dblRate As Double
'Dim douAmount As Double
'Dim douDiscount As Double
'Dim douAmt As Double
'2009/09/07 End
'end 2016/12/22
Dim strA1K01 As String
Dim strFeeTxt As String
 'Added by Lydia 2016/12/22
Dim rCurrName As String '幣別顯示
Dim TmpTotal As Double  '合計金額
Dim TmpCnt As Integer   '請款單筆數

   'Modify By Sindy 2013/1/28
'   If strSrvDate(1) >= AccFMPImputCurrStarDate Then
      GetT_020_a1k_data = ""
      'edit by nickc 2008/02/29 若台幣請款的FC代理人，應顯示台幣，並將 US$改成USD$
      'strSQL = "select nvl(cpm03,cpm04),'US$'||to_char(a1k08) from caseprogress,acc1k0,casepropertymap where cp60=a1k01(+) and cp01=cpm01(+) and cp10=cpm02(+) and a1k29 is null " & _
             " and cp09 in (select min(cp09) from caseprogress,acc1k0 where a1k29 is null and a1k13='" & oCP01 & "' and a1k14='" & oCP02 & "' and a1k15='" & oCP03 & "' and a1k16='" & oCP04 & "' and a1k01=cp60(+) and cp01='" & oCP01 & "' and cp02='" & oCP02 & "' and cp03='" & oCP03 & "' and cp04='" & oCP04 & "' group by cp60) "
      '**********  2008/04/07 商標處加入人民幣，但是 a1k 並尚無人民幣欄位
      'Modify By Sindy 2011/3/3 fa43改抓fa108
      'strSql = "select nvl(cpm03,cpm04),decode(fa43,'N','NTD$'||to_char(a1k11),'USD$'||to_char(a1k08)),a1k02,a1k18,a1k01 from caseprogress,acc1k0,casepropertymap,trademark,fagent where cp60=a1k01(+) and cp01=cpm01(+) and cp10=cpm02(+) and a1k29 is null and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+) and substr(tm44,1,8)=fa01(+) and substr(tm44,9,1)=fa02(+) " & _
      '       " and cp09 in (select min(cp09) from caseprogress,acc1k0 where a1k29 is null and a1k13='" & oCP01 & "' and a1k14='" & oCP02 & "' and a1k15='" & oCP03 & "' and a1k16='" & oCP04 & "' and a1k01=cp60(+) and cp01='" & oCP01 & "' and cp02='" & oCP02 & "' and cp03='" & oCP03 & "' and cp04='" & oCP04 & "' group by cp60) "
      'Modify By Sindy 2013/1/17
      'strSql = "select nvl(cpm03,cpm04),decode(fa108,'N','NTD$'||to_char(a1k11),'USD$'||to_char(a1k08)),a1k02,a1k18,a1k01 from caseprogress,acc1k0,casepropertymap,trademark,fagent where cp60=a1k01(+) and cp01=cpm01(+) and cp10=cpm02(+) and a1k29 is null and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+) and substr(tm44,1,8)=fa01(+) and substr(tm44,9,1)=fa02(+) " & _
      '       " and cp09 in (select min(cp09) from caseprogress,acc1k0 where a1k29 is null and a1k13='" & oCP01 & "' and a1k14='" & oCP02 & "' and a1k15='" & oCP03 & "' and a1k16='" & oCP04 & "' and a1k01=cp60(+) and cp01='" & oCP01 & "' and cp02='" & oCP02 & "' and cp03='" & oCP03 & "' and cp04='" & oCP04 & "' group by cp60) "
   'Modify By Sindy 2016/10/6 原控制一張請款單只抓一個案件性質,改為
   '1.以每一請款單項目抓案件性質檔之cpm03
   '2.xxx98,xxx99不抓
   '3.抓不到案件性質檔者再抓Acc1j0之a1j03
'      strSql = "select nvl(cpm03,cpm04),decode(fa108,'NTD','NTD$'||to_char(a1k11),a1k18||'$'||to_char(a1k08)),a1k02,a1k18,a1k01 from caseprogress,acc1k0,casepropertymap,trademark,fagent where cp60=a1k01(+) and cp01=cpm01(+) and cp10=cpm02(+) and a1k29 is null and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+) and substr(tm44,1,8)=fa01(+) and substr(tm44,9,1)=fa02(+) " & _
'               " and cp09 in (select min(cp09) from caseprogress,acc1k0 where a1k29 is null and a1k13='" & oCP01 & "' and a1k14='" & oCP02 & "' and a1k15='" & oCP03 & "' and a1k16='" & oCP04 & "' and a1k01=cp60(+) and cp01='" & oCP01 & "' and cp02='" & oCP02 & "' and cp03='" & oCP03 & "' and cp04='" & oCP04 & "' group by cp60) "
      '2013/1/17 End
      'modify by sonia 2016/11/3 應剔除作廢a1k12,銷帳a1k25,抵帳資料a1k17
      'Modified by Lydia 2016/12/22 區分幣別顯示為1-英文,2-中文
      'strSql = "select decode(nvl(cpm03,cpm04),null,decode(a1j03,null,a1l04,a1j03),nvl(cpm03,cpm04)),decode(fa108,'NTD','NTD$'||to_char(a1k11),a1k18||'$'||to_char(a1k08)),a1k02,a1k18,a1k01" & _
               " From acc1k0, acc1L0, Trademark, fagent, casepropertymap, acc1j0" & _
               " Where a1k29 Is Null and a1k25||a1k17 is null and nvl(a1k12,0)=0 " & _
               " and a1k13='" & oCP01 & "' and a1k14='" & oCP02 & "' and a1k15='" & oCP03 & "' and a1k16='" & oCP04 & "'" & _
               " and a1k01=a1l01(+)" & _
               " and a1k13=tm01(+) and a1k14=tm02(+) and a1k15=tm03(+) and a1k16=tm04(+)" & _
               " and substr(tm44,1,8)=fa01(+) and substr(tm44,9,1)=fa02(+)" & _
               " and substr(a1l04,-2)<>'98' and substr(a1l04,-2)<>'99'" & _
               " and a1l03=cpm01(+) and a1l04=cpm02(+)" & _
               " and a1l03=a1j01(+) and a1l04=a1j02(+)" & _
               " order by a1k01 asc,a1l02 asc"
      'Modified by Lydia 2017/04/06 + a1k28
      strSql = "select decode(nvl(cpm03,cpm04),null,decode(a1j03,null,a1l04,a1j03),nvl(cpm03,cpm04)) a01," & _
               " decode(fa108,'NTD','NTD$'||to_char(a1k11),a1k18||'$'||to_char(a1k08)) a02,a1k02,a1k18,a1k01,a1y02, " & _
               " decode(fa108,'NTD',a1k11,a1k08) a02_1,a1k28 " & _
               " From acc1k0, acc1L0, Trademark, fagent, casepropertymap, acc1j0,acc1y0" & _
               " Where a1k29 Is Null and a1k25||a1k17 is null and nvl(a1k12,0)=0 " & _
               " and a1k13='" & oCP01 & "' and a1k14='" & oCP02 & "' and a1k15='" & oCP03 & "' and a1k16='" & oCP04 & "'" & _
               " and a1k01=a1l01(+)" & _
               " and a1k13=tm01(+) and a1k14=tm02(+) and a1k15=tm03(+) and a1k16=tm04(+)" & _
               " and substr(tm44,1,8)=fa01(+) and substr(tm44,9,1)=fa02(+)" & _
               " and substr(a1l04,-2)<>'98' and substr(a1l04,-2)<>'99'" & _
               " and a1l03=cpm01(+) and a1l04=cpm02(+)" & _
               " and a1l03=a1j01(+) and a1l04=a1j02(+) and a1k18=a1y01(+)" & _
               " order by a1k01 asc,a1l02 asc"
   '2016/10/6 END
      CheckOC3
      With AdoRecordSet3
         .CursorLocation = adUseClient
         .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
         If .RecordCount <> 0 Then
            .MoveFirst
            strA1K01 = .Fields("A1k01")
            rA1k28 = "" & .Fields("a1k28") 'Added by Lydia 2017/04/06
            'Added by Lydia 2016/12/22 加總筆數和合計
            TmpTotal = TmpTotal + Val("" & .Fields("a02_1"))
            TmpCnt = TmpCnt + 1
            Do While Not .EOF
               If strA1K01 <> .Fields("A1k01") Then
                  'Modified by Lydia 2016/12/22
                  'GetT_020_a1k_data = GetT_020_a1k_data & strFeeTxt & "；"
                  GetT_020_a1k_data = GetT_020_a1k_data & strFeeTxt & IIf(bolTotal = True, "、", "；")
                  'Added by Lydia 2016/12/22 加總筆數和合計
                  TmpTotal = TmpTotal + Val("" & .Fields("a02_1"))
                  TmpCnt = TmpCnt + 1
                  'Added by Lydia 2017/04/06
                  If InStr(rA1k28, "" & .Fields("a1k28")) = 0 Then
                     rA1k28 = rA1k28 & "," & .Fields("a1k28")
                  End If
                  'end 2017/04/06
               Else
                  If GetT_020_a1k_data <> "" Then
                     GetT_020_a1k_data = GetT_020_a1k_data & "、"
                  End If
               End If
               strA1K01 = .Fields("A1k01")
            '            'Add By Sindy 2009/09/07 增加計算外幣金額
            '            If UCase(Trim(.Fields(3))) <> "USD" Then
            '               dblRate = PUB_GetUSXRate_1(.Fields(2), UCase(Trim(.Fields(3))))
            '
            '               strSql = "select sum(a1l05), sum(a1l07) " & _
            '                             "From acc1l0 " & _
            '                             "where a1l01 = '" & Trim(.Fields(4)) & "' "
            '               intI = 1
            '               Set RsTemp = ClsLawReadRstMsg(intI, strSql)
            '               If intI = 1 Then
            '                  If IsNull(RsTemp.Fields(0).Value) Then
            '                     douAmount = 0
            '                  Else
            '                     douAmount = Val(RsTemp.Fields(0).Value)
            '                  End If
            '                  If IsNull(RsTemp.Fields(1).Value) Then
            '                     douDiscount = 0
            '                  Else
            '                     douDiscount = Val(RsTemp.Fields(1).Value)
            '                  End If
            '                  If dblRate <> 0 Then
            '                     '非美金請款
            '                     douAmt = Format((((douAmount - douDiscount) * 100 * 100) \ (dblRate * 100)) / 100, FAmount)
            '                  Else
            '                     douAmt = 0
            '                  End If
            '               Else
            '                  douAmt = MsgText(601)
            '               End If
            '               GetT_020_a1k_data = GetT_020_a1k_data & CheckStr(.Fields(0)) & "費用" & UCase(Trim(.Fields(3))) & "$" & douAmt
            '            '2009/09/07 End
            '            Else
                   '2008/6/27 modify by sonia 加'費用'二字
                   'GetT_020_a1k_data = GetT_020_a1k_data & CheckStr(.Fields(0)) & CheckStr(.Fields(1))
               GetT_020_a1k_data = GetT_020_a1k_data & CheckStr(.Fields(0))
               'Modified by Lydia 2016/12/22 區分幣別顯示為1-英文,2-中文
               'strFeeTxt = "費用" & CheckStr(.Fields(1))
               If rCurr = "1" Then
                  strFeeTxt = "費用" & CheckStr(.Fields(1))
                  rCurrName = CheckStr(.Fields("a1k18")) & "$"
               Else
                  strFeeTxt = "費用" & Trim(.Fields("a1y02")) & Val("" & .Fields("a02_1")) & "元"
                  rCurrName = CheckStr(.Fields("a1y02"))
               End If
               'end 2016/12/22
               
            '            End If
               .MoveNext
            Loop
            GetT_020_a1k_data = GetT_020_a1k_data & strFeeTxt
            
            'Added by Lydia 2016/12/22 顯示加總金額
            If bolTotal = True And TmpCnt > 1 Then
               GetT_020_a1k_data = GetT_020_a1k_data & "，共計" & rCurrName & TmpTotal & IIf(rCurr = "1", "", "元")
            End If
            'end 2016/12/22
         End If
      End With
      CheckOC3
'   Else
'   '2013/1/28 End
'
'      GetT_020_a1k_data = ""
'      'edit by nickc 2008/02/29 若台幣請款的FC代理人，應顯示台幣，並將 US$改成USD$
'      'strSQL = "select nvl(cpm03,cpm04),'US$'||to_char(a1k08) from caseprogress,acc1k0,casepropertymap where cp60=a1k01(+) and cp01=cpm01(+) and cp10=cpm02(+) and a1k29 is null " & _
'             " and cp09 in (select min(cp09) from caseprogress,acc1k0 where a1k29 is null and a1k13='" & oCP01 & "' and a1k14='" & oCP02 & "' and a1k15='" & oCP03 & "' and a1k16='" & oCP04 & "' and a1k01=cp60(+) and cp01='" & oCP01 & "' and cp02='" & oCP02 & "' and cp03='" & oCP03 & "' and cp04='" & oCP04 & "' group by cp60) "
'      '**********  2008/04/07 商標處加入人民幣，但是 a1k 並尚無人民幣欄位
'      'Modify By Sindy 2011/3/3 fa43改抓fa108
'      'strSql = "select nvl(cpm03,cpm04),decode(fa43,'N','NTD$'||to_char(a1k11),'USD$'||to_char(a1k08)),a1k02,a1k18,a1k01 from caseprogress,acc1k0,casepropertymap,trademark,fagent where cp60=a1k01(+) and cp01=cpm01(+) and cp10=cpm02(+) and a1k29 is null and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+) and substr(tm44,1,8)=fa01(+) and substr(tm44,9,1)=fa02(+) " & _
'      '       " and cp09 in (select min(cp09) from caseprogress,acc1k0 where a1k29 is null and a1k13='" & oCP01 & "' and a1k14='" & oCP02 & "' and a1k15='" & oCP03 & "' and a1k16='" & oCP04 & "' and a1k01=cp60(+) and cp01='" & oCP01 & "' and cp02='" & oCP02 & "' and cp03='" & oCP03 & "' and cp04='" & oCP04 & "' group by cp60) "
'      strSql = "select nvl(cpm03,cpm04),decode(fa108,'N','NTD$'||to_char(a1k11),'USD$'||to_char(a1k08)),a1k02,a1k18,a1k01 from caseprogress,acc1k0,casepropertymap,trademark,fagent where cp60=a1k01(+) and cp01=cpm01(+) and cp10=cpm02(+) and a1k29 is null and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+) and substr(tm44,1,8)=fa01(+) and substr(tm44,9,1)=fa02(+) " & _
'             " and cp09 in (select min(cp09) from caseprogress,acc1k0 where a1k29 is null and a1k13='" & oCP01 & "' and a1k14='" & oCP02 & "' and a1k15='" & oCP03 & "' and a1k16='" & oCP04 & "' and a1k01=cp60(+) and cp01='" & oCP01 & "' and cp02='" & oCP02 & "' and cp03='" & oCP03 & "' and cp04='" & oCP04 & "' group by cp60) "
'      CheckOC3
'      With AdoRecordSet3
'          .CursorLocation = adUseClient
'          .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
'          If .RecordCount <> 0 Then
'              .MoveFirst
'              Do While Not .EOF
'                  If GetT_020_a1k_data <> "" Then
'                      GetT_020_a1k_data = GetT_020_a1k_data & "、"
'                  End If
'                  'Add By Sindy 2009/09/07 增加計算外幣金額
'                  If UCase(Trim(.Fields(3))) <> "USD" Then
'                     dblRate = PUB_GetUSXRate_1(.Fields(2), UCase(Trim(.Fields(3))))
'
'                     strSql = "select sum(a1l05), sum(a1l07) " & _
'                                   "From acc1l0 " & _
'                                   "where a1l01 = '" & Trim(.Fields(4)) & "' "
'                     intI = 1
'                     Set RsTemp = ClsLawReadRstMsg(intI, strSql)
'                     If intI = 1 Then
'                        If IsNull(RsTemp.Fields(0).Value) Then
'                           douAmount = 0
'                        Else
'                           douAmount = Val(RsTemp.Fields(0).Value)
'                        End If
'                        If IsNull(RsTemp.Fields(1).Value) Then
'                           douDiscount = 0
'                        Else
'                           douDiscount = Val(RsTemp.Fields(1).Value)
'                        End If
'                        If dblRate <> 0 Then
'                           '非美金請款
'                           douAmt = Format((((douAmount - douDiscount) * 100 * 100) \ (dblRate * 100)) / 100, FAmount)
'                        Else
'                           douAmt = 0
'                        End If
'                     Else
'                        douAmt = MsgText(601)
'                     End If
'                     GetT_020_a1k_data = GetT_020_a1k_data & CheckStr(.Fields(0)) & "費用" & UCase(Trim(.Fields(3))) & "$" & douAmt
'                  '2009/09/07 End
'                  Else
'                     '2008/6/27 modify by sonia 加'費用'二字
'                     'GetT_020_a1k_data = GetT_020_a1k_data & CheckStr(.Fields(0)) & CheckStr(.Fields(1))
'                     GetT_020_a1k_data = GetT_020_a1k_data & CheckStr(.Fields(0)) & "費用" & CheckStr(.Fields(1))
'                  End If
'                  .MoveNext
'              Loop
'          End If
'      End With
'      CheckOC3
'
'   End If
End Function

'move by nickc 2006/06/22 from  prjtaiedll011.Cls011
'判斷是否有子案或相關卷號
Public Function CheckChildCaseOrCaseRelation(ByRef field() As String) As Integer
Dim strSql As String, rsRecordset As New ADODB.Recordset

On Error GoTo ErrHand
CheckChildCaseOrCaseRelation = -1
Select Case CheckChildCase(field())
             Case 1
                        CheckChildCaseOrCaseRelation = 1
                        Exit Function
             Case -1
                        Exit Function
End Select
Select Case CheckCaseRelation(field())
             Case 1
                        CheckChildCaseOrCaseRelation = 2
                        Exit Function
             Case -1
                        Exit Function
End Select
CheckChildCaseOrCaseRelation = 0
Exit Function
ErrHand:
CheckChildCaseOrCaseRelation = -2
End Function
'move by nickc 2006/06/22 from  prjtaiedll011.Cls011
'判斷是否有相關卷號
Public Function CheckCaseRelation(ByRef field() As String) As Integer
Dim strSql As String, rsRecordset As New ADODB.Recordset

On Error GoTo ErrHand
strSql = "select cr01 from caserelation where cr01=" + CNULL(field(1)) + " and cr02=" + CNULL(field(2)) + " and cr03=" + CNULL(field(3)) + " and cr04=" + CNULL(field(4))
'edit by nickc 2006/11/21 專利處不用，但是要留
'add by nickc 2006/06/22 加 caserelation1
strSql = strSql & " union select cr01 from caserelation1 where cr01=" + CNULL(field(1)) + " and cr02=" + CNULL(field(2)) + " and cr03=" + CNULL(field(3)) + " and cr04=" + CNULL(field(4))
rsRecordset.CursorLocation = adUseClient
rsRecordset.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If rsRecordset.RecordCount > 0 Then
   CheckCaseRelation = 1
Else
   CheckCaseRelation = 0
End If
Exit Function
ErrHand:
CheckCaseRelation = -1
End Function
'2007/8/13 ADD BY SONIA 檢查是否銷卷, 若銷卷並提醒
Public Function CheckCaseDestroy(ByRef caseno_1 As String, ByRef caseno_2 As String, ByRef caseno_3 As String, ByRef caseno_4 As String)
Dim strSql As String, rsRecordset As New ADODB.Recordset
Dim intCaseKind As Integer

On Error GoTo ErrHand
   If ClsPDGetSystemKind(caseno_1, intCaseKind) Then
      Select Case intCaseKind
         Case 專利
            strSql = "select pa108,pa136 from patent where pa01=" + CNULL(caseno_1) + " and pa02=" + CNULL(caseno_2) + " and pa03=" + CNULL(caseno_3) + "and pa04=" + CNULL(caseno_4)
         Case 商標
            strSql = "select tm57,tm73 from trademark where tm01=" + CNULL(caseno_1) + " and tm02=" + CNULL(caseno_2) + " and tm03=" + CNULL(caseno_3) + "and tm04=" + CNULL(caseno_4)
         Case 法務
            strSql = "select lc34,lc36 from lawcase where lc01=" + CNULL(caseno_1) + " and lc02=" + CNULL(caseno_2) + " and lc03=" + CNULL(caseno_3) + "and lc04=" + CNULL(caseno_4)
         Case 顧問
            strSql = "select hc19,hc20 from hirecase where hc01=" + CNULL(caseno_1) + " and hc02=" + CNULL(caseno_2) + " and hc03=" + CNULL(caseno_3) + "and hc04=" + CNULL(caseno_4)
         Case Else
            strSql = "select sp61,sp68 from servicepractice where sp01=" + CNULL(caseno_1) + " and sp02=" + CNULL(caseno_2) + " and sp03=" + CNULL(caseno_3) + "and sp04=" + CNULL(caseno_4)
      End Select
      rsRecordset.CursorLocation = adUseClient
      rsRecordset.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      If rsRecordset.RecordCount > 0 Then
         If IsNull(rsRecordset.Fields(0)) = False Then
            MsgBox "此案北所已銷卷, 請確認 !"
         End If
         If IsNull(rsRecordset.Fields(1)) = False Then
            MsgBox "此案分所已銷卷, 請確認 !"
         End If
      End If
   End If
   Exit Function
ErrHand:
End Function
'2007/8/13 end

'move by nickc 2006/06/22 from  prjtaiedll011.Cls011
'判斷是否有子案
Public Function CheckChildCase(ByRef field() As String) As Integer
Dim strSql As String, rsRecordset As New ADODB.Recordset
'edit by nickc 2007/02/06 不用 dll 了
'Dim objPublicData As Object, intCaseKind As Integer
Dim intCaseKind As Integer

On Error GoTo ErrHand
'edit by nickc 2007/02/06 不用 dll 了
'Set objPublicData = CreateObject("prjTaieDll.clsPublicData")
'If objPublicData.GetSystemKind(field(1), intCaseKind) Then
If ClsPDGetSystemKind(field(1), intCaseKind) Then
   Select Case intCaseKind
                Case 專利
                           strSql = "select pa01 from patent where pa01=" + CNULL(field(1)) + " and pa02=" + CNULL(field(2)) + " and pa03<>'0'"
                Case 商標
                           strSql = "select tm01 from trademark where tm27=" + CNULL(15)
                Case 法務
                           strSql = "select lc01 from lawcase where lc01=" + CNULL(field(1)) + " and lc02=" + CNULL(field(2)) + " and lc03<>'0'"
                Case 顧問
                           strSql = "select hc01 from hirecase where hc01=" + CNULL(field(1)) + " and hc02=" + CNULL(field(2)) + " and hc03<>'0'"
                Case Else
                           strSql = "select sp01 from servicepractice where sp01=" + CNULL(field(1)) + " and sp02=" + CNULL(field(2)) + " and sp03<>'0'"
   End Select
   rsRecordset.CursorLocation = adUseClient
   rsRecordset.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If rsRecordset.RecordCount > 0 Then
      CheckChildCase = 1
   Else
      CheckChildCase = 0
   End If
End If
'edit by nickc 2007/02/06 不用 dll 了
'Set objPublicData = Nothing
Exit Function
ErrHand:
CheckChildCase = -1
'edit by nickc 2007/02/06 不用 dll 了
'Set objPublicData = Nothing
End Function

'add by nickc 2006/06/28 內商 所有定稿 的語言重新定義
'1 == > 台對各國  - 中
'2 == > 外對台    - 中
'3 == > 英文
'N == > 其他未定義
'案件==>代理人==>客戶定稿語言
Public Function GetTWordLng(oCP01 As String, oCP02 As String, Optional oCP03 As String = "0", Optional oCP04 As String = "00") As String
Dim tmpLng As Integer
Dim oStrSQL As String
Dim rsTmp As New ADODB.Recordset
   tmpLng = GetLetterLanguage(oCP01, oCP02, oCP03, oCP04)
   If tmpLng = 1 Then
      'modify by sonia 2015/9/21 再抓業務區,智權人員及案件FC代理人
      oStrSQL = "select cu10,cu12,cu13,tm44 from trademark,customer where tm01='" & oCP01 & "' and tm02='" & oCP02 & "' and tm03='" & oCP03 & "' and tm04='" & oCP04 & "' and substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+) "
      oStrSQL = oStrSQL & " union select cu10,cu12,cu13,sp26 as tm44 from servicepractice,customer where sp01='" & oCP01 & "' and sp02='" & oCP02 & "' and sp03='" & oCP03 & "' and sp04='" & oCP04 & "' and substr(sp08,1,8)=cu01(+) and substr(sp08,9,1)=cu02(+) "
      Set rsTmp = New ADODB.Recordset
      rsTmp.CursorLocation = adUseClient
      rsTmp.Open oStrSQL, cnnConnection, adOpenStatic, adLockReadOnly
      If rsTmp.RecordCount <> 0 Then
         'modify by sonia 2015/9/21 中文定稿一律設為1台->各國,僅有FC代理人案件設為2外->台,或巨京的國外客戶設為2外->台(T-150350葉經理的國外客戶不要,除非有FC代理人)
         'If CheckStr(rsTmp.Fields("cu10").Value) <= "010" Then
         '   GetTWordLng = "1"
         'Else
         '   GetTWordLng = "2"
         'End If
         GetTWordLng = "1"
         If CheckStr(rsTmp.Fields("tm44").Value) <> "" Then
            GetTWordLng = "2"
         'Modify by Amy 2017/01/09 +MCTF開頭也是
         ElseIf (CheckStr(rsTmp.Fields("cu13").Value) = "96029" Or CheckStr(rsTmp.Fields("cu13").Value) = "96030" Or Left(CheckStr(rsTmp.Fields("cu13").Value), 4) = "MCTF") _
           And CheckStr(rsTmp.Fields("cu10").Value) >= "010" Then
            GetTWordLng = "2"
         End If
         'end 2015/9/21
      'cancel by sonia 2015/9/21
      'Else
      '   GetTWordLng = "N"
      'end 2015/9/21
      End If
   ElseIf tmpLng = 2 Then
      GetTWordLng = "3"
   'cancel by sonia 2015/9/21
   'Else
   '   GetTWordLng = "N"
   'end 2015/9/21
   End If
End Function
'抓國內案的承辦人
Public Function PUB_GetInCaseCP14(p_cm01 As String, p_cm02 As String, p_cm03 As String, p_cm04 As String) As String
   strSql = "select CP14 from casemap, CASEPROGRESS" & _
      " where cm10='0' and cm01='" & p_cm01 & "' and cm02='" & p_cm02 & "' and cm03='" & p_cm03 & "' and cm04='" & p_cm04 & "'" & _
      " AND CP01=CM05 AND CP02=CM06 AND CP03=CM07 AND CP04=CM08 AND CP10 IN (" & CaseMapIn & ")"
   intI = 1
   Set adoRecordset = ClsLawReadRstMsg(intI, strSql)  'edit by nickc 2007/02/05 不用 dll 了  objLawDll.ReadRstMsg(intI, strSQL)
   If intI = 1 Then
      PUB_GetInCaseCP14 = "" & adoRecordset.Fields(0)
   End If
End Function

'add by nickc 2006/08/24 將符號換掉
Public Function Pub_RplStr(oStr As String) As String
'Modify By Sindy 2009/07/29
'Pub_RplStr = Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(oStr, "*", ""), "△", ""), "N", ""), "＊", ""), "v", ""), "V", ""), "●", ""), "$", "")

'Modify By Sindy 2019/1/10 Mark,改放到最下面
'If Left(Trim(oStr), 1) = "N" Then
'   oStr = Right(Trim(oStr), Len(Trim(oStr)) - 1)
'End If

'Modify By Sindy 2012/2/8 增加◎符號
'Pub_RplStr = Replace(Replace(Replace(Replace(Replace(Replace(Replace(oStr, "*", ""), "△", ""), "＊", ""), "v", ""), "V", ""), "●", ""), "$", "")
'Modify By Sindy 2012/3/21 增加♁符號
'Pub_RplStr = Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(oStr, "◎", ""), "*", ""), "△", ""), "＊", ""), "v", ""), "V", ""), "●", ""), "$", "")
'Modify By Sindy 2012/5/30 增加□符號
'Pub_RplStr = Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(oStr, "♁", ""), "◎", ""), "*", ""), "△", ""), "＊", ""), "v", ""), "V", ""), "●", ""), "$", "")
'Modify By Sindy 2012/5/31 增加◇符號
'Pub_RplStr = Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(oStr, "□", ""), "♁", ""), "◎", ""), "*", ""), "△", ""), "＊", ""), "v", ""), "V", ""), "●", ""), "$", "")
'Modify By Sindy 2014/7/4 增加＃符號
'Modified by Lydia 2018/06/08 增加▲, ◆符號
'Pub_RplStr = Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(oStr, "＃", ""), "◇", ""), "□", ""), "♁", ""), "◎", ""), "*", ""), "△", ""), "＊", ""), "v", ""), "V", ""), "●", ""), "$", "")
Pub_RplStr = Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(oStr, "＃", ""), "◇", ""), "□", ""), "♁", ""), "◎", ""), "*", ""), "△", ""), "＊", ""), "v", ""), "V", ""), "●", ""), "$", ""), "▲", ""), "◆", "")

'Added by Lydia 2019/12/05 以期限管制日查詢frm100106_2,增加符號
'Modify by Amy 2022/12/14 +e
'Modify by Amy 2023/01/17 +▼
Pub_RplStr = Replace(Replace(Replace(Replace(Replace(Replace(Pub_RplStr, "#", ""), "!", ""), "&", ""), "x", ""), "e", ""), "▼", "")

'Modify By Sindy 2019/1/10
If Left(Trim(Pub_RplStr), 1) = "N" Then
   Pub_RplStr = Right(Trim(Pub_RplStr), Len(Trim(Pub_RplStr)) - 1)
End If
End Function

'Remove by Morgan 2007/10/17 併入 PUB_GetRelateCasePropertyName
''add by nickc 2006/09/01 不續辦，取消收文，閉卷用
'Public Function PUB_GetRelateNPCPName(strCP09 As String, strLang As String) As String
'Dim StrSQLa As String
'Dim rsA As New ADODB.Recordset
'
'PUB_GetRelateNPCPName = ""
''strSQL = "select * from caseprogress where cp09='" & strCP09 & "' and ((cp01 in ('P','PS','FCP','FG','CFP','CPS') and cp10 in ('907','913','925')) or (cp01 in ('CFT','CFC','FCT','S','T','TB','TC','TD','TF','TM','TR','TS','TT') and cp10 in ('703','704','718')) or (cp01 in ('L','LA','FCL','CFL') and cp10 in ('991','992','993') )) "
''2006/9/15 MODIFY BY SONIA 加 NP22=CP30 條件
'                 StrSQLa = "Select Decode(PA09,'020',CPM04,CPM03), CPM10, CPM13 From nextProgress, Patent,          CasePropertyMap Where nP02=PA01 And nP03=PA02 And nP04=PA03 And nP05=PA04 And nP02=CPM01 And to_char(nP07)=CPM02 And (np01,np11,NP22) in (Select CP43,DECODE(CP05,CP57,cp05,CP57),CP30 From CaseProgress Where ((cp01 in ('P','FCP','CFP') and cp10 in ('907','913'))) And CP09='" & strCP09 & "' ) "
'StrSQLa = StrSQLa & " Union Select Decode(TM10,'020',CPM04,CPM03), CPM10, CPM13 From nextProgress, Trademark,       CasePropertyMap Where nP02=TM01 And nP03=TM02 And nP04=TM03 And nP05=TM04 And nP02=CPM01 And to_char(nP07)=CPM02 And (np01,np11,NP22) in (Select CP43,DECODE(CP05,CP57,cp05,CP57),CP30 From CaseProgress Where ((cp01 in ('CFT','FCT','T') and cp10 in ('703','704'))) And CP09='" & strCP09 & "' ) "
'StrSQLa = StrSQLa & " Union Select Decode(lc15,'020',CPM04,CPM03), CPM10, CPM13 From nextProgress, lawcase,         CasePropertyMap Where nP02=lc01 And nP03=lc02 And nP04=lc03 And nP05=lc04 And nP02=CPM01 And to_char(nP07)=CPM02 And (np01,np11,NP22) in (Select CP43,DECODE(CP05,CP57,cp05,CP57),CP30 From CaseProgress Where ((cp01 in ('L','FCL','CFL') and cp10 in ('991','993'))) And CP09='" & strCP09 & "' ) "
'StrSQLa = StrSQLa & " Union Select                          CPM03, CPM10, CPM13 From nextProgress, hirecase,        CasePropertyMap Where nP02=hc01 And nP03=hc02 And nP04=hc03 And nP05=hc04 And nP02=CPM01 And to_char(nP07)=CPM02 And (np01,np11,NP22) in (Select CP43,DECODE(CP05,CP57,cp05,CP57),CP30 From CaseProgress Where ((cp01 in ('LA') and cp10 in ('991','992'))) And CP09='" & strCP09 & "' ) "
'StrSQLa = StrSQLa & " Union Select Decode(sp09,'020',CPM04,CPM03), CPM10, CPM13 From nextProgress, servicepractice, CasePropertyMap Where nP02=sp01 And nP03=sp02 And nP04=sp03 And nP05=sp04 And nP02=CPM01 And to_char(nP07)=CPM02 And (np01,np11,NP22) in (Select CP43,DECODE(CP05,CP57,cp05,CP57),CP30 From CaseProgress Where ((cp01 in ('PS','FG','CPS') and cp10 in ('907','913')) or (cp01 in ('CFC','S','TB','TC','TD','TF','TM','TR','TS','TT') and cp10 in ('703','704'))) And CP09='" & strCP09 & "' ) "
'Set rsA = New ADODB.Recordset
'If rsA.State = 1 Then rsA.Close
'rsA.CursorLocation = adUseClient
'rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
'If rsA.RecordCount <> 0 Then
'    Select Case strLang
'    Case "1" '中文
'        PUB_GetRelateNPCPName = "-" & rsA.Fields(0).Value
'    Case "2" '英文
'        PUB_GetRelateNPCPName = "-" & rsA.Fields(1).Value
'    Case "3" '日文
'        PUB_GetRelateNPCPName = "-" & rsA.Fields(2).Value
'    End Select
'Else
'    If rsA.State <> adStateClosed Then rsA.Close
'    Set rsA = Nothing
'                     StrSQLa = "Select Decode(PA09,'020',CPM04,CPM03), CPM10, CPM13 From CaseProgress, Patent,          CasePropertyMap Where CP01=PA01 And CP02=PA02 And CP03=PA03 And CP04=PA04 And CP01=CPM01 And CP10=CPM02 And (CP09,cp57) in (Select CP43,DECODE(cp05,CP57,CP05,CP57) From CaseProgress Where ((cp01 in ('P','FCP','CFP') and cp10 in ('907','913','925'))) And CP09='" & strCP09 & "' ) "
'    StrSQLa = StrSQLa & " Union Select Decode(TM10,'020',CPM04,CPM03), CPM10, CPM13 From CaseProgress, Trademark,       CasePropertyMap Where CP01=TM01 And CP02=TM02 And CP03=TM03 And CP04=TM04 And CP01=CPM01 And CP10=CPM02 And (CP09,cp57) in (Select CP43,DECODE(cp05,CP57,CP05,CP57) From CaseProgress Where ((cp01 in ('CFT','FCT','T') and cp10 in ('703','704','718'))) And CP09='" & strCP09 & "' ) "
'    StrSQLa = StrSQLa & " Union Select Decode(lc15,'020',CPM04,CPM03), CPM10, CPM13 From CaseProgress, lawcase,         CasePropertyMap Where CP01=lc01 And CP02=lc02 And CP03=lc03 And CP04=lc04 And CP01=CPM01 And CP10=CPM02 And (CP09,cp57) in (Select CP43,DECODE(cp05,CP57,CP05,CP57) From CaseProgress Where ((cp01 in ('L','FCL','CFL') and cp10 in ('991','992','993'))) And CP09='" & strCP09 & "' ) "
'    StrSQLa = StrSQLa & " Union Select                          CPM03, CPM10, CPM13 From CaseProgress, hirecase,        CasePropertyMap Where CP01=hc01 And CP02=hc02 And CP03=hc03 And CP04=hc04 And CP01=CPM01 And CP10=CPM02 And (CP09,cp57) in (Select CP43,DECODE(cp05,CP57,CP05,CP57) From CaseProgress Where ((cp01 in ('LA') and cp10 in ('991','992','993'))) And CP09='" & strCP09 & "' ) "
'    StrSQLa = StrSQLa & " Union Select Decode(sp09,'020',CPM04,CPM03), CPM10, CPM13 From CaseProgress, servicepractice, CasePropertyMap Where CP01=sp01 And CP02=sp02 And CP03=sp03 And CP04=sp04 And CP01=CPM01 And CP10=CPM02 And (CP09,cp57) in (Select CP43,DECODE(cp05,CP57,CP05,CP57) From CaseProgress Where ((cp01 in ('PS','FG','CPS') and cp10 in ('907','913','925')) or (cp01 in ('CFC','S','TB','TC','TD','TF','TM','TR','TS','TT') and cp10 in ('703','704','718'))) And CP09='" & strCP09 & "' ) "
'    rsA.CursorLocation = adUseClient
'    rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
'    If rsA.RecordCount > 0 Then
'        Select Case strLang
'        Case "1" '中文
'            PUB_GetRelateNPCPName = "-" & rsA.Fields(0).Value
'        Case "2" '英文
'            PUB_GetRelateNPCPName = "-" & rsA.Fields(1).Value
'        Case "3" '日文
'            PUB_GetRelateNPCPName = "-" & rsA.Fields(2).Value
'        End Select
'    End If
'    If rsA.State <> adStateClosed Then rsA.Clone
'    Set rsA = Nothing
'End If
'End Function

'Add by Morgan 2006/9/7
'建立離線資料集
'Modify by Amy 2014/05/30 離線資料集於Win7無法使用,改為寫入暫存TB-RDataFactory
'p_FormName:目前FormName
'p_SeqNo:序號 (產生空集合需回傳序號)
Public Function PUB_CreateRecordset(Optional p_Rst As ADODB.Recordset, Optional p_FldCnt As Integer = 1, Optional ByRef p_stFieldPrefix As String = "C", Optional ByRef p_iMaxColSize As Integer = 2000, Optional ByRef p_FormName As String = "", Optional ByRef p_SeqNo As String = "") As ADODB.Recordset
   Dim ADF
   Dim rsNew As New ADODB.Recordset
   Dim iField As Integer
   Dim ColInfo()
'Add by Amy 2014/05/30
   Dim stSQL As String, strField As String
   Dim intR As Integer, ii As Integer, jj As Integer
   Dim bolIsOverSize As Boolean
   Dim strSeqNo As String
   Dim intRowSeq As Integer 'Add by Amy 2014/06/23
On Error GoTo ErrHand

If p_FormName <> "" Then
    'Modfify by Amy 2014/06/06
    '暫存TB欄位數不夠增加欄位
    If Not p_Rst Is Nothing Then
        iField = p_Rst.Fields.Count
    Else
        iField = p_FldCnt
    End If
    stSQL = "Select * From RDataFactory Where FormName='" & p_FormName & "' And ID='" & strUserNum & "' Order by SeqNo Desc"
    
    If adoTaie.ConnectionString = "" Then Set adoTaie = cnnConnection 'Added by Lydia 2020/01/15
    
    rsNew.MaxRecords = 1 'Add by Amy 2014/06/25 避免多筆變慢
    rsNew.CursorLocation = adUseClient
    rsNew.Open stSQL, adoTaie, adOpenDynamic, adLockBatchOptimistic
    If rsNew.EOF Then
        strSeqNo = 1
    Else
        rsNew.MoveFirst
        strSeqNo = Val("" & rsNew.Fields("SeqNo")) + 1
    End If
    If iField > rsNew.Fields.Count - 4 Then
        strField = ""
        iField = iField - (rsNew.Fields.Count - 4)
        For ii = 0 To iField - 1
            'Modified by Lydia 2019/12/06 改成varchar2(100 char)
            strField = strField & ",R" & ZeroBeforeNo((rsNew.Fields.Count - 4) + ii, 3) & " varchar2(100 char) " '避免null值故大小先設100
        Next ii
        strField = Mid(strField, 2, Len(strField) - 1)
        stSQL = "Alter Table RDataFactory Add(" & strField & ")"
        cnnConnection.Execute stSQL
    End If
    
    If Not p_Rst Is Nothing Then
         ReDim ColInfo(p_Rst.Fields.Count - 1)
         '記錄欄名
         For ii = 0 To UBound(ColInfo)
            'Add by Amy 2014/06/11 避免欄位名稱過長錯誤 +取前30個字元
            ColInfo(ii) = LeftB(p_Rst.Fields(ii).Name, 30)
         Next
            
         If rsNew.State <> adStateClosed Then rsNew.Close
         'Modify by Amy 2014/06/25 調整語法只抓結構 讓速度變快
         'stSQL = "Select * From RDataFactory Where FormName='" & p_FormName & "' And ID='" & strUserNum & "' Order by SeqNo Desc"
         stSQL = "Select * From RDataFactory Where RowNum<1"
         rsNew.MaxRecords = 0
         'end  2014/06/25
         rsNew.CursorLocation = adUseClient
         rsNew.Open stSQL, adoTaie, adOpenDynamic, adLockBatchOptimistic
         
         intRowSeq = 1 'Add by Amy 2014/06/23 增加列序號欄,避免順序改變ex:frm140403 有時查X27766 再查Y27766順序會跑掉
        '複製原來資料
        With p_Rst
            If .RecordCount > 0 Then
                .MoveFirst
                Do While Not .EOF
                    rsNew.AddNew
                    rsNew.Fields("FormName") = p_FormName
                    rsNew.Fields("ID") = strUserNum
                    rsNew.Fields("SeqNo") = strSeqNo
                    rsNew.Fields("RowSeq") = intRowSeq 'Add by Amy 2014/06/23
                    For ii = 0 To p_Rst.Fields.Count - 1
                        rsNew.Fields(ii + 4).Value = .Fields(ii)
                        If bolIsOverSize = True Then
                           Exit For
                        End If
                    Next ii
                    'Modify by Amy 2014/08/22 FCP-049854(A1035)外專期限通知 備註欄超過300字
                    If bolIsOverSize = False Then
                        rsNew.UpdateBatch
                    End If
                    '因欄位變大重抓rsnew 資料集所以重跑
                    If bolIsOverSize = True Then
                        rsNew.AddNew
                        rsNew.Fields("FormName") = p_FormName
                        rsNew.Fields("ID") = strUserNum
                        rsNew.Fields("SeqNo") = strSeqNo
                        rsNew.Fields("RowSeq") = intRowSeq 'Add by Amy 2014/06/23
                        For jj = 0 To p_Rst.Fields.Count - 1
                            rsNew.Fields(jj + 4).Value = .Fields(jj)
                        Next jj
                        bolIsOverSize = False
                        rsNew.UpdateBatch
                    End If
                    'end 2014/08/22
                    .MoveNext
                    intRowSeq = intRowSeq + 1 'Add by Amy 2014/06/23
                Loop
            End If
        End With
        '轉換成記錄的欄名
        strField = ""
        For ii = 0 To UBound(ColInfo)
            strField = strField & ",R" & ZeroBeforeNo("" & ii, 3) & " as """ & ColInfo(ii) & """"
        Next
        
    ElseIf p_FldCnt > 0 Then
        iField = p_FldCnt - 1
        strField = ""
        For ii = 0 To iField
           strField = strField & ",R" & ZeroBeforeNo("" & ii, 3) & " as """ & p_stFieldPrefix & Format(ii, "00") & """"
        Next
        strField = strField & ",FormName,ID,SeqNo,RowSeq"
    End If
    '重新抓資料
    strField = Mid(strField, 2, Len(strField) - 1)
    stSQL = "Select " & strField & " From RDataFactory Where FormName='" & p_FormName & "' And ID='" & strUserNum & "' And SeqNo=" & strSeqNo & _
                 " Order by RowSeq" 'Add by Amy 2014/06/23
    If rsNew.State <> adStateClosed Then rsNew.Close
    rsNew.MaxRecords = 0 'Add by Amy 2014/06/25
    rsNew.CursorLocation = adUseClient
    rsNew.Open stSQL, adoTaie, adOpenDynamic, adLockBatchOptimistic
        
    p_SeqNo = strSeqNo '回傳
    Set PUB_CreateRecordset = rsNew.Clone
    Set rsNew = Nothing
    Exit Function
End If
'end 2014/06/06

   Set ADF = CreateObject("RDSServer.DataFactory")
   
   If Not p_Rst Is Nothing Then
      With p_Rst
         ReDim ColInfo(.Fields.Count - 1)
         For iField = 0 To UBound(ColInfo)
            ColInfo(iField) = Array(.Fields(iField).Name, CInt(129), CInt(p_iMaxColSize), True)
         Next
         Set rsNew = ADF.CreateRecordset(ColInfo)
         
         '複製原來資料
         If .RecordCount > 0 Then
            .MoveFirst
            Do While Not .EOF
               
               rsNew.AddNew
               For iField = 0 To UBound(ColInfo)
                  rsNew.Fields(iField) = .Fields(iField)
               Next
               .MoveNext
            Loop
            rsNew.UPDATE
         End If
      End With
      
   ElseIf p_FldCnt > 0 Then
      ReDim ColInfo(p_FldCnt - 1)
      For iField = 0 To UBound(ColInfo)
         ColInfo(iField) = Array(p_stFieldPrefix & Format(iField, "00"), CInt(129), CInt(2000), True)
      Next
      Set rsNew = ADF.CreateRecordset(ColInfo)
   End If
   Set PUB_CreateRecordset = rsNew.Clone
   Set rsNew = Nothing
   Exit Function
   
ErrHand:
    If p_FormName <> "" Then
        rsNew.CancelUpdate
        'Modify by Amy 2014/08/22 FCP-049854(A1035)外專期限通知 備註欄超過300字,Err.Number 非 -2147217887
        'If Err.Number = -2147217887 Then
            strField = ""
            With p_Rst
                For jj = 0 To .Fields.Count - 1
                    'Modified by Lydia 2019/12/06 因為O12的欄位有設char,會=O8欄位長度*4
                    'If rsNew.Fields(jj + 4).DefinedSize < .Fields(jj).ActualSize Then
                    '    strField = strField & ",R" & ZeroBeforeNo("" & jj, 3) & " varchar2(" & (-Int(-(.Fields(jj).ActualSize / 100))) * 100 & ") "
                    If (rsNew.Fields(jj + 4).DefinedSize / 4) < .Fields(jj).ActualSize Then
                        strField = strField & ",R" & ZeroBeforeNo("" & jj, 3) & " varchar2(" & (-Int(-(.Fields(jj).ActualSize / 100))) * 100 & " char) "
                    'end 2019/12/06
                    End If
                Next jj
                If strField <> "" Then
                    strField = Mid(strField, 2, Len(strField) - 1)
                    stSQL = "Alter Table RDataFactory Modify(" & strField & ")"
                    cnnConnection.Execute stSQL
                    rsNew.ReQuery
                    bolIsOverSize = True
                    Err.Clear
                    Resume Next
                Else
                    MsgBox "錯誤 : " & Err.Description, vbInformation
                End If
            End With
'        Else
'            MsgBox "錯誤 : " & Err.Description, vbInformation
'        End If
        'end 2014/08/22
    End If
End Function
'Add by Morgan 2006/9/7
'轉號更正財務資料
Public Sub PUB_UpdateAccData(p_CP09 As String, p_OldCaseNo As String)
   Dim stCP60 As String
   Dim stCP01 As String, stCP02 As String, stCP03 As String, stCP04 As String
   Dim intRow As Integer
   strExc(0) = "SELECT CP01,CP02,CP03,CP04,CP60 FROM CASEPROGRESS WHERE CP09='" & p_CP09 & "'"
   intI = 1
   Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
   If intI = 1 Then
      stCP60 = "" & RsTemp.Fields("CP60")
      If stCP60 <> "" Then
         stCP01 = "" & RsTemp.Fields("CP01")
         stCP02 = "" & RsTemp.Fields("CP02")
         stCP03 = "" & RsTemp.Fields("CP03")
         stCP04 = "" & RsTemp.Fields("CP04")
         If Left(stCP60, 1) = "E" Then
            strSql = "update acc0j0 set a0j02='" & stCP01 & stCP02 & stCP03 & stCP04 & "' where a0j01='" & p_CP09 & "'"
            cnnConnection.Execute strSql, intRow
            'Modified by Morgan 2011/11/10 考慮拆收據情形改用收文號串
            'strSql = "UPDATE ACC1P0 SET A1P17='" & stCP01 & stCP02 & stCP03 & stCP04 & "' WHERE A1P04 IN (SELECT A1U01 FROM ACC1U0 WHERE A1U02='" & stCP60 & "') and A1P17='" & p_OldCaseNo & "'"
            strSql = "UPDATE ACC1P0 SET A1P17='" & stCP01 & stCP02 & stCP03 & stCP04 & "' WHERE A1P04 IN (SELECT A1U01 FROM ACC1U0 WHERE A1U03='" & p_CP09 & "') and A1P17='" & p_OldCaseNo & "'"
            
            cnnConnection.Execute strSql, intRow
            '更新傳票
            If intRow > 0 Then
               'strSql = "UPDATE ACC021 SET AX214='" & stCP01 & stCP02 & stCP03 & stCP04 & "' WHERE AX202 IN (SELECT A1P22 FROM ACC1P0 WHERE A1P04 IN (SELECT A1U01 FROM ACC1U0 WHERE A1U02='" & stCP60 & "')) and AX214='" & p_OldCaseNo & "'"
               strSql = "UPDATE ACC021 SET AX214='" & stCP01 & stCP02 & stCP03 & stCP04 & "' WHERE AX202 IN (SELECT A1P22 FROM ACC1P0 WHERE A1P04 IN (SELECT A1U01 FROM ACC1U0 WHERE A1U03='" & p_CP09 & "')) and AX214='" & p_OldCaseNo & "'"
               
               cnnConnection.Execute strSql, intRow
               'Add by Morgan 2010/8/12
               'strSql = "UPDATE ACC031 SET AX314='" & stCP01 & stCP02 & stCP03 & stCP04 & "' WHERE AX302 IN (SELECT A1P22 FROM ACC1P0 WHERE A1P04 IN (SELECT A1U01 FROM ACC1U0 WHERE A1U02='" & stCP60 & "')) and AX314='" & p_OldCaseNo & "'"
               strSql = "UPDATE ACC031 SET AX314='" & stCP01 & stCP02 & stCP03 & stCP04 & "' WHERE AX302 IN (SELECT A1P22 FROM ACC1P0 WHERE A1P04 IN (SELECT A1U01 FROM ACC1U0 WHERE A1U03='" & p_CP09 & "')) and AX314='" & p_OldCaseNo & "'"
               cnnConnection.Execute strSql, intRow
            End If
         Else
            strSql = "UPDATE ACC1K0 SET A1K13='" & stCP01 & "',A1K14='" & stCP02 & "',A1K15='" & stCP03 & "',A1K16='" & stCP04 & "' WHERE A1K01='" & stCP60 & "'"
            cnnConnection.Execute strSql, intRow
            strSql = "UPDATE ACC1P0 SET A1P17='" & stCP01 & stCP02 & stCP03 & stCP04 & "' WHERE A1P04 IN (SELECT A0Z01 FROM ACC0Z0 WHERE A0Z02='" & stCP60 & "') and A1P17='" & p_OldCaseNo & "'"
            cnnConnection.Execute strSql, intRow
            'Add by Morgan 2010/8/12 更新傳票
            If intRow > 0 Then
               strSql = "UPDATE ACC021 SET AX214='" & stCP01 & stCP02 & stCP03 & stCP04 & "' WHERE AX202 IN (SELECT A1P22 FROM ACC1P0 WHERE A1P04 IN (SELECT A0Z01 FROM ACC0Z0 WHERE A0Z02='" & stCP60 & "')) and AX214='" & p_OldCaseNo & "'"
               cnnConnection.Execute strSql, intRow
               'Add by Morgan 2010/8/12
               strSql = "UPDATE ACC031 SET AX314='" & stCP01 & stCP02 & stCP03 & stCP04 & "' WHERE AX302 IN (SELECT A1P22 FROM ACC1P0 WHERE A1P04 IN (SELECT A0Z01 FROM ACC0Z0 WHERE A0Z02='" & stCP60 & "')) and AX314='" & p_OldCaseNo & "'"
               cnnConnection.Execute strSql, intRow
            End If
         End If
         
      End If
   End If
End Sub

'Add by Morgan 2006/9/19 更新P案和CFP案
Public Sub PUB_UpdateCaseRelation(oPA() As String, nPA() As String)
   
   strSql = "Update CaseMap Set CM01='" & nPA(1) & "', CM02='" & nPA(2) & "', CM03='" & nPA(3) & "', CM04='" & nPA(4) & "' where CM01='" & oPA(1) & "' and CM02='" & oPA(2) & "'  and CM03='" & oPA(3) & "' and CM04='" & oPA(4) & "'"
   cnnConnection.Execute strSql, intI
   strSql = "Update CaseMap Set CM05='" & nPA(1) & "', CM06='" & nPA(2) & "', CM07='" & nPA(3) & "', CM08='" & nPA(4) & "' where CM05='" & oPA(1) & "' and CM06='" & oPA(2) & "'  and CM07='" & oPA(3) & "' and CM08='" & oPA(4) & "'"
   cnnConnection.Execute strSql, intI
   strSql = "Update CaseRelation Set CR01='" & nPA(1) & "', CR02='" & nPA(2) & "', CR03='" & nPA(3) & "', CR04='" & nPA(4) & "' where CR01='" & oPA(1) & "' and CR02='" & oPA(2) & "'  and CR03='" & oPA(3) & "' and CR04='" & oPA(4) & "'"
   cnnConnection.Execute strSql, intI
   strSql = "Update CaseRelation Set CR05='" & nPA(1) & "', CR06='" & nPA(2) & "', CR07='" & nPA(3) & "', CR08='" & nPA(4) & "' where CR05='" & oPA(1) & "' and CR06='" & oPA(2) & "'  and CR07='" & oPA(3) & "' and CR08='" & oPA(4) & "'"
   cnnConnection.Execute strSql, intI
   '********* rem Nickc 專利處分案，要順便將智權人員用關聯轉掉
   strSql = "Update CaseRelation1 Set CR01='" & nPA(1) & "', CR02='" & nPA(2) & "', CR03='" & nPA(3) & "', CR04='" & nPA(4) & "' where CR01='" & oPA(1) & "' and CR02='" & oPA(2) & "'  and CR03='" & oPA(3) & "' and CR04='" & oPA(4) & "'"
   cnnConnection.Execute strSql, intI
   strSql = "Update CaseRelation1 Set CR05='" & nPA(1) & "', CR06='" & nPA(2) & "', CR07='" & nPA(3) & "', CR08='" & nPA(4) & "' where CR05='" & oPA(1) & "' and CR06='" & oPA(2) & "'  and CR07='" & oPA(3) & "' and CR08='" & oPA(4) & "'"
   cnnConnection.Execute strSql, intI
   strSql = "Update DivisionCase Set DC01='" & nPA(1) & "', DC02='" & nPA(2) & "', DC03='" & nPA(3) & "', DC04='" & nPA(4) & "' where DC01='" & oPA(1) & "' and DC02='" & oPA(2) & "'  and DC03='" & oPA(3) & "' and DC04='" & oPA(4) & "'"
   cnnConnection.Execute strSql, intI
   strSql = "Update DivisionCase Set DC05='" & nPA(1) & "', DC06='" & nPA(2) & "', DC07='" & nPA(3) & "', DC08='" & nPA(4) & "' where DC05='" & oPA(1) & "' and DC06='" & oPA(2) & "'  and DC07='" & oPA(3) & "' and DC08='" & oPA(4) & "'"
   cnnConnection.Execute strSql, intI
   
End Sub

'Added by Lydia 2020/08/18 更新相關卷號前,先檢查是否有重複
Public Function PUB_ChkUpdCR(ByVal pOld01 As String, ByVal pOld02 As String, ByVal pOld03 As String, ByVal pOld04 As String, _
                                                ByVal pNew01 As String, ByVal pNew02 As String, ByVal pNew03 As String, ByVal pNew04 As String) As Boolean
Dim intQ As Integer, stSQL As String
Dim rsQuery  As New ADODB.Recordset
Dim stMsg As String
     PUB_ChkUpdCR = True
     stSQL = "select '國內外案件關聯' as kind, cm01||cm02||cm03||cm04 as Cno01,cm05||cm06||cm07||cm08 as cno2 from CaseMap where CM01='" & pOld01 & "' and CM02='" & pOld02 & "'  and CM03='" & pOld03 & "' and CM04='" & pOld04 & "' and CM05='" & pNew01 & "' and CM06='" & pNew02 & "'  and CM07='" & pNew03 & "' and CM08='" & pNew04 & "' "
     stSQL = stSQL & "union select '多國案關聯' as kind, cr01||cr02||cr03||cr04 as Cno01,cr05||cr06||cr07||cr08 as cno2 from CaseRelation where CR01='" & pOld01 & "' and CR02='" & pOld02 & "'  and CR03='" & pOld03 & "' and CR04='" & pOld04 & "' and CR05='" & pNew01 & "' and CR06='" & pNew02 & "'  and CR07='" & pNew03 & "' and CR08='" & pNew04 & "' "
     stSQL = stSQL & "union select '相關卷號' as kind, cr01||cr02||cr03||cr04 as Cno01,cr05||cr06||cr07||cr08 as cno2 from CaseRelation1 where CR01='" & pOld01 & "' and CR02='" & pOld02 & "'  and CR03='" & pOld03 & "' and CR04='" & pOld04 & "' and CR05='" & pNew01 & "' and CR06='" & pNew02 & "'  and CR07='" & pNew03 & "' and CR08='" & pNew04 & "' "
     stSQL = stSQL & "union select '分割案件關係' as kind, dc01||dc02||dc03||dc04 as Cno01,dc05||dc06||dc07||dc08 as cno2 from DivisionCase where DC01='" & pOld01 & "' and DC02='" & pOld02 & "'  and DC03='" & pOld03 & "' and DC04='" & pOld04 & "' and DC05='" & pNew01 & "' and DC06='" & pNew02 & "'  and DC07='" & pNew03 & "' and DC08='" & pNew04 & "' "
     stSQL = stSQL & "union select '國內外案件關聯' as kind, cm01||cm02||cm03||cm04 as Cno01,cm05||cm06||cm07||cm08 as cno2 from CaseMap where CM05='" & pOld01 & "' and CM06='" & pOld02 & "'  and CM07='" & pOld03 & "' and CM08='" & pOld04 & "' and CM01='" & pNew01 & "' and CM02='" & pNew02 & "'  and CM03='" & pNew03 & "' and CM04='" & pNew04 & "' "
     stSQL = stSQL & "union select '多國案關聯' as kind, cr01||cr02||cr03||cr04 as Cno01,cr05||cr06||cr07||cr08 as cno2 from CaseRelation where CR05='" & pOld01 & "' and CR06='" & pOld02 & "'  and CR07='" & pOld03 & "' and CR08='" & pOld04 & "' and CR01='" & pNew01 & "' and CR02='" & pNew02 & "'  and CR03='" & pNew03 & "' and CR04='" & pNew04 & "' "
     stSQL = stSQL & "union select '相關卷號' as kind, cr01||cr02||cr03||cr04 as Cno01,cr05||cr06||cr07||cr08 as cno2 from CaseRelation1 where CR05='" & pOld01 & "' and CR06='" & pOld02 & "'  and CR07='" & pOld03 & "' and CR08='" & pOld04 & "' and CR01='" & pNew01 & "' and CR02='" & pNew02 & "'  and CR03='" & pNew03 & "' and CR04='" & pNew04 & "' "
     stSQL = stSQL & "union select '分割案件關係' as kind, dc01||dc02||dc03||dc04 as Cno01,dc05||dc06||dc07||dc08 as cno2 from DivisionCase where DC05='" & pOld01 & "' and DC06='" & pOld02 & "'  and DC07='" & pOld03 & "' and DC08='" & pOld04 & "' and DC01='" & pNew01 & "' and DC02='" & pNew02 & "'  and DC03='" & pNew03 & "' and DC04='" & pNew04 & "' "
     
     intQ = 1
     Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
     If intQ = 1 Then
          rsQuery.MoveFirst
          Do While Not rsQuery.EOF
               If stMsg = "" Then
                   stMsg = "、【 " & rsQuery.Fields("kind") & " 】"
               ElseIf InStr(stMsg, "" & rsQuery.Fields("kind")) = 0 Then
                   stMsg = stMsg & "、【 " & rsQuery.Fields("kind") & " 】"
               End If
               rsQuery.MoveNext
          Loop
          If stMsg <> "" Then
              MsgBox "更新" & Mid(stMsg, 2) & "會有重複，請先行維護！", vbExclamation, "檢核資料"
              PUB_ChkUpdCR = False
          End If
     End If
     Set rsQuery = Nothing
End Function

'Added by Lydia 2020/08/18 更新CaseRelation1和DivisionCase
Public Sub PUB_UpdateCaseRelation1(ByVal pOld01 As String, ByVal pOld02 As String, ByVal pOld03 As String, ByVal pOld04 As String, _
                                                ByVal pNew01 As String, ByVal pNew02 As String, ByVal pNew03 As String, ByVal pNew04 As String)
     
   strSql = "Update CaseRelation1 Set CR01='" & pNew01 & "', CR02='" & pNew02 & "', CR03='" & pNew03 & "', CR04='" & pNew04 & "' where CR01='" & pOld01 & "' and CR02='" & pOld02 & "'  and CR03='" & pOld03 & "' and CR04='" & pOld04 & "'"
   cnnConnection.Execute strSql, intI
   strSql = "Update CaseRelation1 Set CR05='" & pNew01 & "', CR06='" & pNew02 & "', CR07='" & pNew03 & "', CR08='" & pNew04 & "' where CR05='" & pOld01 & "' and CR06='" & pOld02 & "'  and CR07='" & pOld03 & "' and CR08='" & pOld04 & "'"
   cnnConnection.Execute strSql, intI
   strSql = "Update DivisionCase Set DC01='" & pNew01 & "', DC02='" & pNew02 & "', DC03='" & pNew03 & "', DC04='" & pNew04 & "' where DC01='" & pOld01 & "' and DC02='" & pOld02 & "'  and DC03='" & pOld03 & "' and DC04='" & pOld04 & "'"
   cnnConnection.Execute strSql, intI
   strSql = "Update DivisionCase Set DC05='" & pNew01 & "', DC06='" & pNew02 & "', DC07='" & pNew03 & "', DC08='" & pNew04 & "' where DC05='" & pOld01 & "' and DC06='" & pOld02 & "'  and DC07='" & pOld03 & "' and DC08='" & pOld04 & "'"
   cnnConnection.Execute strSql, intI
End Sub

'Add by Morgan 2006/10/13
'計算預定公告日
Public Function PUB_GetPrePA14(p_PA() As String, Optional p_bol412 As Boolean = False) As String

   Dim stSQL As String
   'Modified by Lydia 2021/08/18 配合PUB_Get605NP模組
   'Dim stDate(1 To 3) As String
   Dim stDate(1 To 4) As String
      
   stSQL = "select pa14, c1.cp27, c2.cp27, c2.cp71 from patent, caseprogress c1, caseprogress c2" & _
      " where pa01='" & p_PA(1) & "' and pa02='" & p_PA(2) & "' and pa03='" & p_PA(3) & "' and pa04='" & p_PA(4) & "'" & _
      " and c1.cp01(+)=pa01 and c1.cp02(+)=pa02 and c1.cp03(+)=pa03 and c1.cp04(+)=pa04 and c1.cp10(+)='601' and c1.cp27(+)>0 and c1.cp57(+) is null" & _
      " and c2.cp01(+)=pa01 and c2.cp02(+)=pa02 and c2.cp03(+)=pa03 and c2.cp04(+)=pa04 and c2.cp10(+)='412' and c2.cp27(+)>0 and c2.cp57(+) is null"
   intI = 1
   'edit by nickc 2007/02/06 不用 dll 了
   'Set AdoRecordSet3 = objLawDll.ReadRstMsg(intI, stSQL)
   Set AdoRecordSet3 = ClsLawReadRstMsg(intI, stSQL)
   If intI = 1 Then
      '是否有發文延緩公告
      If Not IsNull(AdoRecordSet3(2)) Then
         p_bol412 = True
      End If
      
      If Not IsNull(AdoRecordSet3(0)) Then
         PUB_GetPrePA14 = AdoRecordSet3(0)
      'Added by Morgan 2019/5/23 有可能有延緩公告發文但無領證發文 Ex:P-119237
      ElseIf Len("" & AdoRecordSet3(3)) >= 6 Then
         PUB_GetPrePA14 = DBDATE(AdoRecordSet3(3))
         Exit Function
      'end 2019/5/23
      ElseIf Not IsNull(AdoRecordSet3(1)) Then
         PUB_Get605NP p_PA(1), AdoRecordSet3(1), 0, stDate(), "" & AdoRecordSet3(3)
         PUB_GetPrePA14 = stDate(3)
      End If
   End If
   
End Function
'Add By Morgan 2006/10/17
'列印代理人小信封
Public Sub PUB_PrintCase(strAgentNo As String)

   Dim i As Integer
   Dim nRow As Integer
   Dim lngXo As Long, lngYo As Long, lngRowH As Long
   
   lngXo = 15.5 * 567
   lngYo = 9.5 * 567 ' edit by nickc 往上提一格  10.5 * 567
   lngRowH = 0.6 * 567
   
On Error GoTo ErrHand
   
   'POBOX-->英文地址
   strExc(0) = "SELECT FA05,FA63,FA64,FA65" & _
      ",Decode(FA32, Null, FA18, FA32), Decode(FA32, Null, FA19, FA33),Decode(FA32, Null, FA20, FA34)" & _
      ",Decode(FA32, Null, FA21, FA35), Decode(FA32, Null, FA22, FA36)" & _
      " FROM FAGENT WHERE " & ChgFagent(strAgentNo)
   intI = 1
   Set RsTemp = ClsLawReadRstMsg(intI, strExc(0)) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intI, strExc(0))
   If intI = 1 Then
      Printer.ScaleMode = 1
      '橫印
      Printer.Orientation = 2
      Printer.FontName = "Times New Roman"
      Printer.Font.Size = 14
      RsTemp.MoveFirst
      With RsTemp
      nRow = 0
      For i = 0 To .Fields.Count - 1
         Printer.CurrentX = lngXo
         If IsNull(.Fields(i)) = False Then
            Printer.CurrentY = lngYo + nRow * lngRowH
            Printer.Print .Fields(i)
            nRow = nRow + 1
         End If
      Next
      End With
      Printer.EndDoc
      
   Else
      MsgBox "無法讀取代理人資料！"
   End If
   Exit Sub
   
ErrHand:
   MsgBox Err.Description
End Sub

'Add by Morgan 2006/11/3
'檢查NP是否已存在
'iState= 0:未續辦, 其他:不限制
Public Function PUB_ChkNPExist(ByRef cp() As String, ByVal stNP07 As String, Optional ByVal iState As Integer = 0, Optional ByRef stNP22 As String, Optional ByRef stNP01 As String) As Boolean
'Added by Lydia 2016/12/08
Dim rsR1 As New ADODB.Recordset
Dim inR As Integer
'end 2016/12/08
 
   stNP22 = "": stNP01 = ""
   
On Error GoTo ErrHnd
 
   strSql = "select np01,np22 from nextprogress where np02='" & cp(1) & "' and np03='" & cp(2) & "' and np04='" & cp(3) & "' and np05='" & cp(4) & "' and np07='" & stNP07 & "'"
   If iState = 0 Then
      strSql = strSql & " and np06 IS NULL"
   End If
   'Modified by Lydia 2016/12/08
   'CheckOC
   'adoRecordset.CursorLocation = adUseClient
   'adoRecordset.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   'If adoRecordset.RecordCount > 0 Then
   inR = 1
   Set rsR1 = ClsLawReadRstMsg(inR, strSql)
   If inR = 1 Then
   'end 2016/12/08
      'Modified by Morgan 2016/12/14
      'stNP22 = "" & adoRecordset.Fields("np22")
      'stNP01 = "" & adoRecordset.Fields("np01")
      stNP22 = "" & rsR1.Fields("np22")
      stNP01 = "" & rsR1.Fields("np01")
      'end 2016/12/14
      PUB_ChkNPExist = True
   End If
   
   Set rsR1 = Nothing 'Added by Lydia 2016/12/08
   
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
End Function

'Add by Morgan 2006/11/15
'跳行列印
'p_dblWidth = 列印寬(mm)
'p_lngLineH = 跳行高(twips)
Public Sub Pub_SmartPrint(ByVal p_Data As String, ByRef p_lngX As Long, ByRef p_lngY As Long, Optional p_lngWidth As Long = 80, Optional p_lngLineH As Long = 300)
   Dim strData As String, strCache As String, i As Integer
   
   strData = Trim(p_Data) 'Add by Morgan 2009/1/19 去除空白以免多跳行
   For i = 1 To Len(p_Data)
      If Printer.TextWidth(strCache & Mid(strData, i, 1)) > p_lngWidth * 56.7 Then
         Printer.CurrentX = p_lngX
         Printer.CurrentY = p_lngY
         Printer.Print strCache
         strCache = Mid(strData, i, 1)
         p_lngY = p_lngY + p_lngLineH
      Else
         strCache = strCache & Mid(strData, i, 1)
      End If
   Next
   If strCache <> "" Then
      Printer.CurrentX = p_lngX
      Printer.CurrentY = p_lngY
      Printer.Print strCache
   End If
End Sub

'move from prjTaieDll by nickc 2006/12/05
'取得案件之規費
'Modify by Morgan 2007/9/7 +bEqual:是否相等
'2009/2/10 modify by sonia +bMoreCase:是否為同時申請三國(含)以上之美日德可多5點
'Modified by Lydia 2023/02/10 +strCaseKind 專利/商標種類
'Modify By Sindy 2025/4/8 + Optional ByVal strCaseAttributes As String : 案件屬性
'Modify By Sindy 2025/4/14 若擬收文之案件規費與系統設定不符，可自行解開規費之設定，自行填入正確之規費
'                          +, Optional ByVal bolShowErrMsg As Boolean = True
Public Function GetCaseMoney(ByRef strSystem As String, ByRef strNation As String, ByRef strCaseProperty As String, _
   ByRef Fee As Long, Optional bEqual As Boolean = False, Optional bMoreCase As Integer = 0, _
   Optional ByVal strCaseKind As String, Optional ByVal strIDentity As String, Optional ByVal strCP140 As String, _
   Optional ByVal strCRLType As String, _
   Optional ByVal strCP01 As String, Optional ByVal strCP02 As String, _
   Optional ByVal strCP03 As String, Optional ByVal strCP04 As String, _
   Optional ByVal strCaseAttributes As String, Optional ByVal bolShowErrMsg As Boolean = True) As Integer
'傳入參數如下：
'strSystem : 系統類別
'strNation : 國家別
'strCaseProperty : 案件性質
'Fee : 輸入的規費

Dim strSql As String, rsRecordset As New ADODB.Recordset
Dim strCasePropertyNm As String
'Dim strCRL94 As String '個體別
'Dim strCF205 As String '案件屬性/身份種類/商標電子送件
'Dim strQuyCP01 As String '查詢系統別

On Error GoTo ErrHand

'Add By Sindy 2023/2/15 案件性質名稱
strSql = "select decode('" & strNation & "','000',cpm03,cpm04) cName from casepropertymap" & _
         " where cpm01=" + CNULL(strSystem) + " and cpm02=" + CNULL(strCaseProperty)
intI = 1
Set RsTemp = ClsLawReadRstMsg(intI, strSql)
If intI = 1 Then
   strCasePropertyNm = "" & RsTemp.Fields(0)
End If
'2023/2/15 END

''Modified by Lydia 2018/06/05 修改顯示案件性質 '020',CPM04,CPM03 => '000',CPM03,CPM04
''strSql = "select cf08,decode(cf02,'000',cpm03,cpm04) cName from casefee,casepropertymap where cf01=" + CNULL(strSystem) + " and cf02=" + _
''        CNULL(strNation) + " and cf03=" + CNULL(strCaseProperty) & _
''        " and cpm01(+)=cf01 and cpm02(+)=cf03"
''Modify By Sindy 2023/2/15 + CaseFee2
'If strCP140 <> "" Then
'   strSql = "select CRL01,CRL94,CRL81 from ConsultRecordList where CRL01='" & strCP140 & "'"
'   intI = 1
'   Set RsTemp = ClsLawReadRstMsg(intI, strSql)
'   If intI = 1 Then
'      '身份種類:ex:大個體,小個體...
'      strCRL94 = "" & RsTemp.Fields("CRL94").Value
'      'Modify By Sindy 2025/2/4 P大陸非"有"台灣專利說明書時,改抓案件屬性
'      If strSystem = "P" And strNation = "020" And strCRL94 <> "2" Then
'         strCRL94 = "" & RsTemp.Fields("CRL81").Value
'      End If
'      '2025/2/4 END
'   End If
'End If
'If strCRL94 <> "" Then
'   strCF205 = strCRL94
'Else
'   strCF205 = strIDentity
'End If
'
''Modify By Sindy 2023/2/7 抓代理人代碼,"有值"代表為大至台
'If strCRLType = "" And strCP02 <> "" Then
'   If GetPrjPeopleNum6(strCP01 & "-" & strCP02 & "-" & strCP03 & "-" & strCP04) <> "" Then
'      strCRLType = "2" '接洽單種類-1.國內 2.大至台
'   End If
'End If
'strSql = ""
''P大陸有台灣專利說明書
'If strSystem = "P" And strNation = "020" And (strCRL94 = "2" Or strCRL94 = "") Then
'   strSql = "select '5',cf01,cf02,cf03,'0','0',cf08 from casefee where cf01=" & CNULL(strSystem) & " and cf02=" & _
'            CNULL(strNation) & " and cf03=" & CNULL(strCaseProperty)
'Else '(以第一筆資料檢查費用及底價，費用啟始值之區主管1點權限由程式碼控制)
'   '調整大陸來台P案之價格檢查
'   '接洽記錄單若為外至台的接洽單,在檢查價格及抓標準價及底價時, 加入以下控制:
'   'P案增加CF201='MCP'，T案增加CF201='MCT'的語法
'   If strCRLType = "2" And (strSystem = "P" Or strSystem = "T") And strNation = "000" Then '2.大至台
'      If strSystem = "P" Then
'         strQuyCP01 = "MCP"
'      Else
'         strQuyCP01 = "MCT"
'      End If
'      strSql = "select '1',cf201,cf202,cf203,cf204,cf205,cf208 as cf08 from casefee2" & _
'               " where cf201=" & CNULL(strQuyCP01) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
'               " and cf204=" & CNULL(strCaseKind) & " and cf205=" & CNULL(strCF205) & _
'               " and cf210=(select max(cf210) from casefee2 where cf201=" & CNULL(strQuyCP01) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
'               " and cf204=" & CNULL(strCaseKind) & " and cf205=" & CNULL(strCF205) & " and cf210<=" & strSrvDate(1) & ")"
'      strSql = strSql & " Union " & _
'               "select '2',cf201,cf202,cf203,cf204,cf205,cf208 as cf08 from casefee2" & _
'               " where cf201=" & CNULL(strQuyCP01) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
'               " and cf204=" & CNULL(strCaseKind) & " and cf205='0'" & _
'               " and cf210=(select max(cf210) from casefee2 where cf201=" & CNULL(strQuyCP01) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
'               " and cf204=" & CNULL(strCaseKind) & " and cf205='0' and cf210<=" & strSrvDate(1) & ")"
'      strSql = strSql & " Union " & _
'               "select '3',cf201,cf202,cf203,cf204,cf205,cf208 as cf08 from casefee2" & _
'               " where cf201=" & CNULL(strQuyCP01) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
'               " and cf204='0' and cf205=" & CNULL(strCF205) & _
'               " and cf210=(select max(cf210) from casefee2 where cf201=" & CNULL(strQuyCP01) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
'               " and cf204='0' and cf205=" & CNULL(strCF205) & " and cf210<=" & strSrvDate(1) & ")"
'      strSql = strSql & " Union " & _
'               "select '4',cf201,cf202,cf203,cf204,cf205,cf208 as cf08 from casefee2" & _
'               " where cf201=" & CNULL(strQuyCP01) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
'               " and cf204='0' and cf205='0'" & _
'               " and cf210=(select max(cf210) from casefee2 where cf201=" & CNULL(strQuyCP01) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
'               " and cf204='0' and cf205='0' and cf210<=" & strSrvDate(1) & ")"
'   End If
'   If strSql <> "" Then strSql = strSql & " Union "
'   strSql = strSql & "select '1',cf201,cf202,cf203,cf204,cf205,cf208 as cf08 from casefee2" & _
'            " where cf201=" & CNULL(strSystem) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
'            " and cf204=" & CNULL(strCaseKind) & " and cf205=" & CNULL(strCF205) & _
'            " and cf210=(select max(cf210) from casefee2 where cf201=" & CNULL(strSystem) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
'            " and cf204=" & CNULL(strCaseKind) & " and cf205=" & CNULL(strCF205) & " and cf210<=" & strSrvDate(1) & ")"
'   strSql = strSql & " Union " & _
'            "select '2',cf201,cf202,cf203,cf204,cf205,cf208 as cf08 from casefee2" & _
'            " where cf201=" & CNULL(strSystem) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
'            " and cf204=" & CNULL(strCaseKind) & " and cf205='0'" & _
'            " and cf210=(select max(cf210) from casefee2 where cf201=" & CNULL(strSystem) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
'            " and cf204=" & CNULL(strCaseKind) & " and cf205='0' and cf210<=" & strSrvDate(1) & ")"
'   strSql = strSql & " Union " & _
'            "select '3',cf201,cf202,cf203,cf204,cf205,cf208 as cf08 from casefee2" & _
'            " where cf201=" & CNULL(strSystem) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
'            " and cf204='0' and cf205=" & CNULL(strCF205) & _
'            " and cf210=(select max(cf210) from casefee2 where cf201=" & CNULL(strSystem) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
'            " and cf204='0' and cf205=" & CNULL(strCF205) & " and cf210<=" & strSrvDate(1) & ")"
'   strSql = strSql & " Union " & _
'            "select '4',cf201,cf202,cf203,cf204,cf205,cf208 as cf08 from casefee2" & _
'            " where cf201=" & CNULL(strSystem) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
'            " and cf204='0' and cf205='0'" & _
'            " and cf210=(select max(cf210) from casefee2 where cf201=" & CNULL(strSystem) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
'            " and cf204='0' and cf205='0' and cf210<=" & strSrvDate(1) & ")"
'   strSql = strSql & " Union " & _
'            "select '5',cf01,cf02,cf03,'0','0',cf08 from casefee" & _
'            " where cf01=" & CNULL(strSystem) & " and cf02=" & CNULL(strNation) & " and cf03=" & CNULL(strCaseProperty) & _
'            " order by 1,2,3,4,5,6"
'End If
''2023/2/15 END
'Modify By Sindy 2025/2/4 改Call共用Func
strSql = PUB_GetCaseFee2SQL(strSystem, strNation, strCaseProperty, strCaseKind, strIDentity, strCP140, _
                            strCRLType, strCP01, strCP02, strCP03, strCP04, strCaseAttributes)
If strSql = "" Then
   GetCaseMoney = 1
   Exit Function
End If
'2025/2/4 END
rsRecordset.CursorLocation = adUseClient
rsRecordset.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If rsRecordset.RecordCount > 0 Then
   'Add By Cheng 2002/04/19
   '若系統類別為"P"或"FCP"且案件性質為"發明"時, 規費必須 "等於" 案件(國家)收費表設定之規費
   'edit by nickc 2006/12/05 台灣再控制 相等
   'If (strSystem = "P" Or strSystem = "FCP") And strCaseProperty = 發明申請 Then
   'Modify by Morgan 2007/9/7
   'If (strSystem = "P" Or strSystem = "FCP") And strCaseProperty = 發明申請 And strNation = "000" Then
   If bEqual = True Or ((strSystem = "P" Or strSystem = "FCP") And strCaseProperty = 發明申請 And strNation = "000") Then
      If IsNull(rsRecordset.Fields("cf08")) Then
         GetCaseMoney = 1
      ElseIf Fee = Val(rsRecordset.Fields("cf08")) Then
         GetCaseMoney = 1
      Else
         'ShowMsg MsgText(9164)
         'Modify By Sindy 2023/2/15
         'MsgBox "【" & rsRecordset(1) & strCaseProperty & "】規費應為 " & rsRecordset("cf08") & " 元！", vbInformation, "規費錯誤"
         'Add By Sindy 2025/4/14
         If bolShowErrMsg = True Then
         '2025/4/14 END
            MsgBox "【" & strCasePropertyNm & strCaseProperty & "】規費應為 " & rsRecordset("cf08") & " 元！", vbInformation, "規費錯誤"
         End If
         '2023/2/15 END
         GetCaseMoney = 0
      End If
   'Modify By Cheng 2002/04/19
   '其他狀況, 維持原規定
   Else
      
      If Fee >= rsRecordset.Fields("cf08") Or IsNull(rsRecordset.Fields("cf08")) Then
         GetCaseMoney = 1
      Else
         If rsRecordset.Fields("cf08").Value = 0 Then
            GetCaseMoney = 1
         Else
            '2009/2/10 add by sonia是否為同時申請三國(含)以上之美日德可多5點
            If bMoreCase Then
               If Fee >= rsRecordset.Fields("cf08") - 5000 Then
                  GetCaseMoney = 1
               Else
                  ShowMsg MsgText(9164) & "，規費必須 >= " & rsRecordset.Fields("cf08") - 5000 & " "
                  GetCaseMoney = 0
               End If
            'Added by Lydia 2023/02/10 台灣專利案收文之超項費939、超頁費938之規費欄檢查，只限制在專利種類為發明的案件。
            ElseIf strSystem = "P" And strNation = "000" And InStr("938,939", strCaseProperty) > 0 And strCaseKind <> "1" Then
                  GetCaseMoney = 1
            'end 2023/02/10
            Else
            '2009/2/10 end
               'Add By Sindy 2025/4/14
               If bolShowErrMsg = True Then
               '2025/4/14 END
                  ShowMsg MsgText(9164) & "，規費必須 >= " & rsRecordset.Fields("cf08") & " "
               End If
               GetCaseMoney = 0
            End If
         End If
      End If
   
   End If
Else
   GetCaseMoney = 1
End If
rsRecordset.Close
Exit Function
ErrHand:
GetCaseMoney = -2
MsgBox Err.Description
End Function

'Add by Morgan 2011/5/24
'讀取信頭尾圖檔(中文)
'Modified by Morgan 2014/8/27 +本所案號以判斷收據公司別帶不同信頭
'Public Sub PUB_ReadLetterPic(ByRef p_Sys As String, ByRef p_HeadPicPath As String, ByRef p_FootPicPath As String)
Public Sub PUB_ReadLetterPic(ByRef p_Sys As String, p_CNo2 As String, p_CNo3 As String, p_CNo4 As String, ByRef p_HeadPicPath As String, ByRef p_FootPicPath As String)
   Dim iPicNo As Integer, iPicNo2 As Integer
   Dim stComp As String 'Added by Morgan 2014/8/27
   
'Added by Morgan 2020/3/30
If strSrvDate(1) >= 智慧所更名日 Then
   stComp = PUB_GetReceiptComp(p_Sys, p_CNo2, p_CNo3, p_CNo4, True)
   PUB_GetLetterPicID stComp, p_Sys, iPicNo, iPicNo2, 1, False
Else
'end 2020/3/30

   stComp = PUB_GetReceiptComp(p_Sys, p_CNo2, p_CNo3, p_CNo4) 'Added by Morgan 2014/8/27
   
   'Modify By Sindy 2012/4/5
   'Select Case p_Sys
   Select Case Left(p_Sys, 1)
      Case "T"
         iPicNo = 12
         iPicNo2 = 11
         'Added by Morgan 2014/8/27
         If stComp = "J" Then
            iPicNo = 28
            iPicNo2 = 31
         End If
         'end 2014/8/27
      Case Else
         iPicNo = 10
         iPicNo2 = 11
         
         'Added by Morgan 2014/8/27
         If stComp = "T" Then
            iPicNo = 12
         ElseIf stComp = "J" Then
            iPicNo = 28
            'Modified by Morgan 2015/11/18
            '統一用10樓的傳真--陳鳳英
            'If m_MySt(1) = "CFT" Then
            '   iPicNo2 = 29 'fax:25090804
            'Else
               iPicNo2 = 31 'fax:25011666
            'End If
            'end 2015/11/18
         End If
         'end 2014/8/27
   End Select
   
End If 'Added by Morgan 2020/3/30
   
   If p_HeadPicPath = "" Then p_HeadPicPath = App.path & "\TempFile" & iPicNo
   If p_FootPicPath = "" Then p_FootPicPath = App.path & "\TempFile" & iPicNo2
   
   PUB_ReadDB2File p_HeadPicPath, iPicNo
   PUB_ReadDB2File p_FootPicPath, iPicNo2
   
End Sub

'從資料庫讀出檔案 Add by Morgan 2006/12/5
'Modified by Morgan 2017/10/30 +p_ibf01
Public Function PUB_ReadDB2File(ByRef p_FileName As String, Optional p_iPicNo As Integer = 1, Optional p_ibf01 As String = "M51", Optional p_ibf03 As String = "0", Optional p_ibf04 As String = "00") As Boolean
Dim intR As Integer, strR1 As String
Dim rsRD As New ADODB.Recordset
Dim iFileNo As Integer
Dim bytes() As Byte
   
On Error GoTo ErrHnd

   strR1 = "select * from ImgByteFile where ibf01='" & p_ibf01 & "' and ibf02='" & Format(p_iPicNo, "00000#") & "' and ibf03='" & p_ibf03 & "' and ibf04='" & p_ibf04 & "'"
   intR = 1
   Set rsRD = ClsLawReadRstMsg(intR, strR1) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(intr, strr1)
   If intR = 1 Then
      If p_FileName = "" Then
         p_FileName = App.path & "\TempFile"
      End If
      RidFile p_FileName
      'Add By Sindy 2017/8/10
'      If "" & rsrd.Fields("IBF15") <> "" Then
         PUB_ReadDB2File = PUB_GetFtpFile(rsRD.Fields("IBF15"), p_FileName, UCase("ImgByteFile"))
'      Else
'      '2017/8/10 END
'         With rsrd
'         ReDim bytes(Val(.Fields("ibf13").Value))
'         bytes() = .Fields("ibf14").GetChunk(Val(.Fields("ibf13").Value))
'         iFileNo = FreeFile
'         Open p_FileName For Binary Access Write As #iFileNo
'         Put #iFileNo, , bytes()
'         Close #iFileNo
'         End With
'         PUB_ReadDB2File = True
'      End If
   End If
   
   Set rsRD = Nothing
   Exit Function
   
ErrHnd:
   MsgBox Err.Description
   
End Function

'add by nickc 2006/12/06 mail Winsock 用 *************************************
Public Function GetGUID() As String
 Dim id1 As GUID
 Dim LRet As Long, LLen As Long
 Dim sID As String
     On Error Resume Next
   LRet = CoCreateGuid(id1)
     If (LRet = 0) Then
       LLen = 255
       sID = String$(LLen, 0)
         LRet = StringFromGUID2(id1, StrPtr(sID), LLen)
           If (LRet > 30) Then
             sID = Left$(sID, (LRet - 2))  '--snip off { and }
             sID = Right$(sID, (Len(sID) - 1))
             sID = Replace(sID, cDASH, cDOT)
             GetGUID = sID
           End If
     End If
End Function

'Added by Morgan 2022/3/23
Private Function ConvertStringToUtf8Bytes(ByRef strText As String) As Byte()

    Dim objStream As ADODB.Stream
    Dim data() As Byte
   
    ' init stream
    Set objStream = New ADODB.Stream
    objStream.Charset = "utf-8"
    objStream.Mode = adModeReadWrite
    objStream.Type = adTypeText
    objStream.Open
   
    ' write bytes into stream
    objStream.WriteText strText
    objStream.Flush
   
    ' rewind stream and read text
    objStream.Position = 0
    objStream.Type = adTypeBinary
    data = objStream.Read(3)
    data = objStream.Read()
   
    ' close up and return
    objStream.Close
    ConvertStringToUtf8Bytes = data
End Function


'Modified by Morgan 2022/3/17 +pUTF8
Public Function ConvertToBase64(ByVal sPathOrString As String, IfFile As Boolean, AddReturns As Boolean, Optional pUTF8 As Boolean = False) As String
  Static Enc() As Byte
  Dim b1() As Byte, b2() As Byte, B76() As Byte
  Dim i As Long, i2 As Long, i3 As Long, LFil As Long, NumReturns As Long
  Dim FF2 As Integer
  Dim stRtn As String 'Added by Morgan 2017/11/10
  Dim stRemoteFile As String 'Added by Morgan 2025/8/28
  
     On Error Resume Next
  If (Not Val(Not Enc)) = 0 Then
    Enc = StrConv("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/", vbFromUnicode)
  End If
  
  If (IfFile = True) Then  '-- if converting picture file.
      'Added by Morgan 2025/8/28
      '若檔案在遠端電腦時會非常慢，改複製到本機來開啟
      If Left(sPathOrString, 2) = "\\" Then
         stRemoteFile = sPathOrString
         sPathOrString = App.path & "\$ATT" & Int(Rnd * 1000000) & ".TMP"
         If Dir(sPathOrString) <> "" Then Kill sPathOrString
         FileCopy stRemoteFile, sPathOrString
      End If
      'end 2025/8/28
  
      FF2 = FreeFile()
      Open sPathOrString For Binary As #FF2
            
      LFil = LOF(FF2)
      ReDim b1(0 To (LFil - 1)) As Byte
      For i = 1 To LFil
         Get #FF2, i, b1(i - 1)
      Next
      Close #FF2
  Else   '-- converting a string.
  
     'Added by Morgan 2022/3/23
     'b1() = StrConv(sPathOrString, vbFromUnicode)
     If pUTF8 Then
         b1() = ConvertStringToUtf8Bytes(sPathOrString)
     Else
         b1() = StrConv(sPathOrString, vbFromUnicode)
     End If
     'end 2022/3/23
     
     LFil = UBound(b1) + 1  '-- added as correction 12-2-04
  End If
  
  
  ReDim Preserve b1(0 To ((LFil - 1) \ 3) * 3 + 2)
  ReDim Preserve b2(0 To (UBound(b1) \ 3) * 4 + 3)
  For i = 0 To UBound(b1) - 1 Step 3
    b2(i2) = Enc(b1(i) \ 4)
      i2 = i2 + 1
    b2(i2) = Enc((b1(i + 1) \ 16) Or (b1(i) And 3) * 16)
      i2 = i2 + 1
    b2(i2) = Enc((b1(i + 2) \ 64) Or (b1(i + 1) And 15) * 4)
      i2 = i2 + 1
    b2(i2) = Enc(b1(i + 2) And 63)
      i2 = i2 + 1
  Next i
    For i = 1 To i - LFil
       b2(UBound(b2) - i + 1) = 61
    Next i
    
   'Modified by Morgan 2018/8/9 應該以編碼後的長度判斷
   'If (AddReturns = True) And (LFil > 76) Then
   If (AddReturns = True) And ((UBound(b2) + 1) > 76) Then
   'end 2018/8/9
      '-- add returns every 76 characters before converting to string:
        NumReturns = ((UBound(b2) + 1) \ 76)
        If (UBound(b2) + 1) Mod 76 = 0 Then NumReturns = NumReturns - 1 'Added by Morgan 2018/8/9 整除時要少+2個位元否則會多2個空白而導致某些郵件系統無法讀取
        LFil = (UBound(b2) + (NumReturns * 2)) '--make B76 B2 plus 2 spots for each vbcrlf.
         ReDim B76(0 To LFil) As Byte
          i2 = 0
          i3 = 0
        For i = 0 To UBound(b2)
           B76(i2) = b2(i)
            i2 = i2 + 1
            i3 = i3 + 1
           If (i3 = 76) And (i2 < (LFil - 2)) Then   '--extra check. make sure there are still
              B76(i2) = 13                      '-- 2 spots left for return if at end.
              B76(i2 + 1) = 10
              i2 = i2 + 2
              i3 = 0
           End If
        Next
         
         'Modified by Morgan 2017/11/10 修正大附件會轉成空字串問題
         'ConvertToBase64 = StrConv(B76, vbUnicode)
         'Modified by Morgan 2020/9/24 改1次5M，10M會出現記憶體不足
         If UBound(B76) > 5000000 Then
            stRtn = ""
            For i = 0 To UBound(B76) \ 5000000
               If (i + 1) * 5000000 > UBound(B76) Then
                  stRtn = stRtn & StrConv(Mid(B76, 1 + i * 5000000), vbUnicode)
                  Exit For
               Else
                  stRtn = stRtn & StrConv(Mid(B76, 1 + i * 5000000, 5000000), vbUnicode)
               End If
            Next
            ConvertToBase64 = stRtn
         Else
            ConvertToBase64 = StrConv(B76, vbUnicode)
         End If
         'end 2017/11/10
   Else
     ConvertToBase64 = StrConv(b2, vbUnicode)
   End If
End Function

'Modified by Morgan 2017/11/20 +bHTML
'Modified by Morgan 2022/3/23 +pUTF8
Public Sub PrepareEmail(ByVal sMailText As String, sFils As String, sID As String, ByVal BooPlain As Boolean, ByVal bHTML As Boolean, Optional pUTF8 As Boolean = False)
 Dim s1 As String, sFil64 As String, sFilName As String, sHeader As String
 Dim Pt1 As Long
 Dim AFils As Variant
 Dim i As Integer, iPics As Integer
  'On Error Resume Next 'Removed by Morgan 2023/9/19 錯誤要觸發
     'Modified by Morgan 2017/11/20
     'If (BooPlain = False) Then  '--html
     If bHTML Then
     'end 2017/11/20
        'Modified by Morgan 2022/3/24 +pUTF8
        sBodyText = PrepText(sMailText, pUTF8)
     Else
        sBodyText = sMailText
     End If
     
    ReDim APics(0) As String
    APics(0) = ""
    iPics = 0
    sFils = Trim$(sFils)
     If (Len(sFils) > 0) Then
        AFils = Split(sFils, cAST)
          '-- array of picture file full paths.
          '-- when done this will have pics in APics array, names in apics(0).
       For i = 0 To UBound(AFils)
         s1 = Trim$(AFils(i))
         If s1 <> "" Then 'Added by Morgan 2023/9/19
          If (UCFileExists(s1) = True) Then
             Pt1 = InStrRev(s1, "\")
             sFilName = Right$(s1, (Len(s1) - Pt1)) '--get file name.
             '-- for each file attachment, get header for HTML email content
             '-- or plain text attachment, then encode the file as Base64.
             '-- Finally, save the whole thing as a single string in the Apics array.
                If (BooPlain = False) Then  '--html
                   '-- this will get header for picture file and also get a GUID to use
                   '-- as Content-ID. The CID will then replace the picture file name
                   '-- in the body text to match.
                   'Modified by Morgan 2022/3/23 +pUTF8
                   sHeader = GetPicHeader(sFilName, sID & "." & Format(i + 1, "000"), pUTF8)
                Else
                    'Modified by Morgan 2022/3/23 +pUTF8
                    sHeader = GetAttachmentHeader(sFilName, pUTF8)
                End If
             sFil64 = ConvertToBase64(s1, True, True)
             sHeader = sHeader & sFil64
             sHeader = sHeader & vbCrLf
             sHeader = sHeader & vbCrLf
             iPics = iPics + 1
             ReDim Preserve APics(0 To iPics) As String
             APics(iPics) = sHeader
          
          'Added by Morgan 2023/9/19 檢查失敗要觸發錯誤
          Else
            Err.Raise 999, , "附件檢查失敗！" & vbCrLf & vbCrLf & s1
          'end 2023/9/19
          End If
         End If
       Next
     End If
     
End Sub
'Added by Morgan 2018/9/5
Public Function PUB_Text2Html(pText As String) As String
   Dim stContent As String
   
   stContent = pText
   '跳行轉 <BR>
   If InStr(stContent, "<BR>") = 0 And InStr(stContent, vbCrLf) > 0 Then
      stContent = Replace(stContent, vbCrLf, "<BR>")
   End If
   '空白轉 &nbsp;
   If InStr(stContent, "&nbsp;") = 0 And InStr(stContent, " ") > 0 Then
      stContent = Replace(stContent, " ", "&nbsp;")
   End If
   
   PUB_Text2Html = stContent
End Function

'夾背景圖
'Modified by Morgan 2022/3/24 +pUTF8
Public Function PrepText(ByVal stExt As String, Optional pUTF8 As Boolean = False) As String '-- edit IMG tags and change = to =3D
  Dim sToRep As String, sRep As String, sRet As String
  On Error Resume Next
   stExt = Trim$(stExt)
   
   'Modified by Morgan 2018/9/5
'   If InStr(sText, "<BR>") = 0 And InStr(sText, vbCrLf) > 0 Then 'Added by Morgan 2012/2/29
'      sText = Replace(sText, vbCrLf, "<BR>") 'Add by Morgan 2006/12/11 跳行改成<BR>
'   End If
'
'   If InStr(sText, "&nbsp;") = 0 And InStr(sText, " ") > 0 Then 'Added by Morgan 2012/2/29
'      sText = Replace(sText, " ", "&nbsp;") 'Add by Morgan 2006/12/11 空白改成nbsp;
'   End If
   stExt = PUB_Text2Html(stExt)
   'end 2018/9/5
          '-- set up Content-ID edit for IMG tags.
   sToRep = "SRC=" & Chr$(34)              '--  SRC="
   sRep = "SRC=" & Chr$(34) & "cid:"     '--  SRC="cid:
     sRet = Replace(stExt, sToRep, sRep, 1, -1, vbTextCompare)
          '-- do content-id tags for body background pic if present
   sToRep = "BACKGROUND=" & Chr$(34)
   sRep = sToRep & "cid:"
   sRet = Replace(sRet, sToRep, sRep, 1, 1, vbTextCompare)
          '-- replace "=" with "=3D"
          
   'Added by Morgan 2022/3/29 UFT8會編成base64 不必轉碼和切行
   If pUTF8 Then
       sRep = sRet
   Else
   'end 2022/3/29
   
     sRep = "=3D"
     sRet = Replace(sRet, "=", sRep, 1, -1, vbTextCompare)
         '-- wrap lines to 70+- characters. Probably not necessary
         '-- but it is part of the official format standard.
     'edit by nickc 2007/01/04 還是要切
     'Modify by Morgan 2006/12/11 內文會多"="符號
     'sRep = sRet
     sRep = Clip70(sRet)
     'end 2006/12/11
     
   End If 'Added by Morgan 2022/3/29
   
   PrepText = sRep
End Function

Private Function UCFileExists(sFilPath As String) As Boolean
  Dim i As Integer
  On Error Resume Next
  Err.Clear
   UCFileExists = False
     i = GetAttr(sFilPath)
    If (Err = 0) Then
       If (i And vbDirectory) = 0 Then
          UCFileExists = True
       End If
    End If
  Err.Clear
End Function
Public Function TextBlurb() As String
  Dim s As String
     s = "This is an HTML wewbpage email." & vbCrLf
     s = s & "It may only be viewed as HTML email, but your email program" & vbCrLf
     s = s & "does not appear to read HTML format." & vbCrLf & vbCrLf
  TextBlurb = s
End Function

'Modified by Morgan 2022/3/23 +pUTF8
Public Function GetPicHeader(ByVal sFil As String, sID As String, Optional pUTF8 As Boolean = False) As String
  Dim s As String, sExt As String ', sID As String
  Dim tmpMailStr As String
      On Error Resume Next '-- just in case problem with file name.
    sExt = Right$(sFil, 3)
      If UCase$(sExt) = "PEG" Then sExt = "jpg"
        '-- get a GUID to replace file name for Content-ID.
        '-- very silly, but apparently an official standard practice.
    'sID = GetGUID()
  If (Len(sID) > 0) Then   '--replace file string in html IMG tag with new ID.
     sBodyText = Replace(sBodyText, "cid:" & sFil, "cid:" & sID, 1, -1, vbTextCompare)
  Else   '-- if generating GUID was not successful then just assign sfil to sID.
     sID = sFil
  End If
    s = cDASH2 & cBoundaryA & vbCrLf                          ' --Boundary_Taie_A
    s = s & "Content-Type: image/" & sExt & cSEMIC & vbCrLf   'Content-Type: image/gif;
    'edit by nickc 2006/10/05 加入編碼
    's = s & vbTab & "Name=" & Chr$(34) & sFil & Chr$(34) & vbCrLf            '  Name = "pic.gif"
    'Modified by Morgan 2022/3/23 +UTF8格式
    'tmpMailStr = ConvertToBase64(sFil, False, False)
    tmpMailStr = ConvertToBase64(sFil, False, False, pUTF8)
    'end 2022/3/23
    If tmpMailStr <> sFil Then
      'Modified by Morgan 2022/3/23 +UTF8格式
      's = s & vbTab & "Name=" & Chr$(34) & "=?Big5?B?" & tmpMailStr & "?=" & Chr$(34) & vbCrLf            '  Name = "pic.gif"
      If pUTF8 Then
         s = s & vbTab & "Name=" & Chr$(34) & "=?utf-8?B?" & tmpMailStr & "?=" & Chr$(34) & vbCrLf            '  Name = "pic.gif"
      Else
         s = s & vbTab & "Name=" & Chr$(34) & "=?Big5?B?" & tmpMailStr & "?=" & Chr$(34) & vbCrLf            '  Name = "pic.gif"
      End If
      'end 2022/3/23
    Else
      s = s & vbTab & "Name=" & Chr$(34) & sFil & Chr$(34) & vbCrLf            '  Name = "pic.gif"
    End If
    s = s & "Content-Transfer-Encoding: base64" & vbCrLf
    'add by nickc 2006/10/05 加入
    s = s & "Content-Disposition: attachment" & cSEMIC & vbCrLf
    'Modified by Morgan 2022/3/23 +UTF8格式
    'tmpMailStr = ConvertToBase64(sFil, False, False)
    tmpMailStr = ConvertToBase64(sFil, False, False, pUTF8)
    'end 2022/3/23
    If tmpMailStr <> sFil Then
      'Modified by Morgan 2022/3/23 +UTF8格式
      's = s & vbTab & "filename=""=?Big5?B?" & tmpMailStr & "?=""" & vbCrLf
      If pUTF8 Then
         s = s & vbTab & "filename=""=?utf-8?B?" & tmpMailStr & "?=""" & vbCrLf
      Else
         s = s & vbTab & "filename=""=?Big5?B?" & tmpMailStr & "?=""" & vbCrLf
      End If
      'end 2022/3/23
    Else
      s = s & vbTab & "filename=""" & sFil & """" & vbCrLf
    End If
    s = s & "Content-ID: <" & sID & ">" & vbCrLf & vbCrLf     'Content-ID: <49984ed.9399.2de3. etc.>  '#
  GetPicHeader = s
End Function

'Modified by Morgan 2022/3/23 +pUTF8
Private Function GetAttachmentHeader(ByVal sFil As String, Optional pUTF8 As Boolean = False) As String
  Dim s As String, sExt1 As String, sID As String, sCT1 As String
  Dim Pt1 As Long
  Dim Boo1 As Boolean
      On Error Resume Next
        '-- get MIME type string:
   Pt1 = InStrRev(sFil, cDOT)
     If (Pt1 > 0) Then
       sExt1 = Right$(sFil, (Len(sFil) - (Pt1 - 1)))  '-- get  ".xxx"
       Boo1 = RegGetString(HKEY_CLASSES_ROOT, sExt1, "Content Type", sCT1)
     End If
       If (Len(sCT1) = 0) Then sCT1 = "application/octet-stream"
       
    s = cDASH2 & cBoundaryA & vbCrLf                          ' --Boundary_A_3435FE2_6617A_AA
    s = s & "Content-Type: " & sCT1 & cSEMIC & vbCrLf   'Content-Type: image/gif;
    'Modified by Morgan 2016/11/11
    's = s & vbTab & "Name=" & Chr$(34) & sFil & Chr$(34) & vbCrLf            '  Name = "pic.gif"
    'Modified by Morgan 2022/3/23 +UTF8格式
    's = s & vbTab & "Name=" & Chr$(34) & "=?Big5?B?" & ConvertToBase64(sFil, False, False) & "?=" & Chr$(34) & vbCrLf             '  Name = "pic.gif"
    If pUTF8 Then
      s = s & vbTab & "Name=" & Chr$(34) & "=?utf-8?B?" & ConvertToBase64(sFil, False, False, True) & "?=" & Chr$(34) & vbCrLf            '  Name = "pic.gif"
    Else
      s = s & vbTab & "Name=" & Chr$(34) & "=?Big5?B?" & ConvertToBase64(sFil, False, False) & "?=" & Chr$(34) & vbCrLf             '  Name = "pic.gif"
    End If
    'end 2022/3/23
    'end 2016/11/11
    s = s & "Content-Transfer-Encoding: base64" & vbCrLf
    s = s & "Content-Disposition: attachment;" & vbCrLf
    'Modified by Morgan 2016/11/11
    's = s & vbTab & "Filename=" & Chr$(34) & sFil & Chr$(34) & vbCrLf & vbCrLf
    'Modified by Morgan 2022/3/23 +UTF8格式
    's = s & vbTab & "Filename=" & Chr$(34) & "=?Big5?B?" & ConvertToBase64(sFil, False, False) & "?=" & Chr$(34) & vbCrLf & vbCrLf
    If pUTF8 Then
      s = s & vbTab & "Filename=" & Chr$(34) & "=?utf-8?B?" & ConvertToBase64(sFil, False, False, True) & "?=" & Chr$(34) & vbCrLf & vbCrLf
    Else
      s = s & vbTab & "Filename=" & Chr$(34) & "=?Big5?B?" & ConvertToBase64(sFil, False, False) & "?=" & Chr$(34) & vbCrLf & vbCrLf
    End If
    'end 2022/3/23
    'end 2016/11/11
  GetAttachmentHeader = s
End Function

Public Function Clip70(ByVal sIn As String) As String
  Dim s1 As String, sRet As String
  Dim Pt1 As Long, PtA As Long, LLen As Long
    On Error Resume Next
      LLen = Len(sIn)
        If (LLen < 76) Then
           Clip70 = sIn
           Exit Function
        End If
      PtA = 1
   Do
     s1 = Mid$(sIn, PtA, 70)
       Pt1 = InStrRev(s1, R_BRACKET)
        If (Pt1 > 0) Then
           s1 = Left$(s1, Pt1) & vbCrLf  '-- get line up to last ">" and add vbcrlf.
           PtA = (PtA + Pt1)
        Else  '-- no ">" in line.
          Pt1 = InStrRev(s1, cSPACE)
            If (Pt1 > 0) Then
              s1 = Left$(s1, Pt1) & cEQUAL & vbCrLf
              PtA = (PtA + Pt1)
            Else
              s1 = s1 & cEQUAL & vbCrLf
              PtA = (PtA + 70)
            End If
        End If
       sRet = sRet & s1
         Select Case (LLen - PtA)
            Case Is < 0   '-- if at end of text, then quit.
               Exit Do
            Case 0 To 75
               sRet = sRet & Right$(sIn, ((LLen - PtA) + 1))
               Exit Do
            Case Else
               '--
         End Select
    Loop
      Clip70 = sRet
End Function
Private Function RegGetString(ByVal KeyH As Long, sPath As String, sValName As String, sReturn As String) As Boolean
 Dim hKey As Long, LRet As Long, LBuf As Long, LType As Long
 Dim sBuf As String, sRet As String
  On Error Resume Next
     LRet = RegOpenKeyEx(ByVal KeyH, sPath, 0&, KEY_QUERY_VALUE, hKey)
        If (LRet <> 0) Then Exit Function
     LBuf = 255
     sBuf = String$(LBuf, 0)
       LRet = RegQueryValueExString(hKey, sValName, 0&, LType, sBuf, LBuf)
          If (LRet = 0) And (LBuf > 1) Then
             sReturn = Left$(sBuf, (LBuf - 1))
             RegGetString = True
          End If
    LRet = RegCloseKey(hKey)
End Function
'Quoteprint 編碼
Public Function ConvertToQp(inString As String) As String
  Dim myB     As Byte
  Dim convByte()     As Byte
  Dim mOutStr     As String
  Dim FinishPercent     As Long
  Dim TotalB, k       As Long
    
  convByte = StrConv(inString, vbFromUnicode)
    
  TotalB = UBound(convByte)
  For k = 0 To TotalB
          myB = convByte(k)
          EncodeByte myB, mOutStr
          ConvertToQp = ConvertToQp & mOutStr
  Next
End Function
Private Sub EncodeByte(mInByte As Byte, mOutStr As String)
  'Memo by Morgan 2022/3/29
  'Quoted-printable編碼
  '任何8-bit位元組值可編碼為3個字元：一個等號「=」後跟隨兩個十六進位數字（0–9或A–F）表示該位元組的數值。
  '所有可列印ASCII字元（十進位值的範圍為33到126）可用ASCII字元編碼來直接表示, 但是等號「=」（十進位值為61）不可以這樣直接表示
  If (mInByte >= 33 And mInByte <= 60) Or (mInByte >= 62 And mInByte <= 126) Then
          mOutStr = Chr(mInByte)
  Else
          If mInByte <= &HF Then
                  mOutStr = "=0" & Hex(mInByte)
          Else
                  mOutStr = "=" & Hex(mInByte)
          End If
  End If
End Sub

'Add by Morgan 2006/12/6
'表單初始化
'Modified by Lydia 2023/11/07 傳入主Frame高寬:pMainHeigh ,pMainWidth
Public Sub PUB_InitForm(ByRef p_Form As Form, Optional ByVal p_lngWidth As Long = 8850, Optional ByVal p_lngHeight As Long = 5500, _
    Optional ByVal p_BackPicPath As String, Optional ByVal pMainWidth As Double, Optional ByVal pMainHeight As Double)

   Dim intX As Integer
   Dim intY As Integer
   Dim sglWidth As Single
   Dim sglHeight As Single
   Dim oImage As New StdPicture
   Dim lngX As Long
   Dim lngY As Long
   
   p_Form.Icon = LoadPicture(strIcoPath)
   p_Form.Width = p_lngWidth
   p_Form.Height = p_lngHeight
   'Add by Morgan 2010/5/6
   If p_Form.MDIChild = False Then
      'Modified by Lydia 2023/11/07
      'lngX = VB.Forms(0).Left + (VB.Forms(0).Width - p_Form.Width) / 2
      lngX = VB.Forms(0).Left + (IIf(pMainWidth > 0, pMainWidth, VB.Forms(0).Width) - p_Form.Width) / 2
      lngY = 920 + VB.Forms(VB.Forms.Count - 2).Top
      If VB.Forms(0).Toolbar1.Visible Then
         lngY = lngY + VB.Forms(0).Top + VB.Forms(0).Toolbar1.Height
      End If
      p_Form.Left = lngX
      p_Form.Top = lngY
   'end 2010/5/6
   Else
      'Modified by Lydia 2023/11/07
      'lngX = (VB.Forms(0).ScaleWidth - p_Form.Width) / 2
      lngX = (IIf(pMainWidth > 0, pMainWidth, VB.Forms(0).ScaleWidth) - p_Form.Width) / 2
      If lngX < 0 Then lngX = 0
      'Modified by Lydia 2023/11/07
      'lngY = (VB.Forms(0).ScaleHeight - p_Form.Height) / 2
      lngY = (IIf(pMainHeight > 0, pMainHeight, VB.Forms(0).ScaleHeight) - p_Form.Height) / 2
      If lngY < 0 Then lngY = 0
      p_Form.Move lngX, lngY
   End If
   If p_BackPicPath = "" Then p_BackPicPath = strBackPicPath1
   Set oImage = LoadPicture(p_BackPicPath)
   sglWidth = oImage.Width
   sglHeight = oImage.Height
   For intX = 0 To Int(p_Form.ScaleWidth / sglWidth)
       For intY = 0 To Int(p_Form.ScaleHeight / sglHeight)
           p_Form.PaintPicture oImage, intX * sglWidth, intY * sglHeight, sglWidth, sglHeight + 10, 0, 0
       Next
   Next
   strFormName = p_Form.Name
   Set oImage = Nothing
   
End Sub
'Add by Morgan 2006/12/14 於字串內取得最早優先權日
Public Function PUB_GetFirstPriDate2(strPriDates As String) As String
   Dim oDate
   Dim ii As Integer, strEarliest As String
   
   oDate = Split(strPriDates, "，")
   strEarliest = ""
   For ii = LBound(oDate) To UBound(oDate)
      If strEarliest = "" Then
         strEarliest = oDate(ii)
      ElseIf Val(oDate(ii)) > 0 And Val(oDate(ii)) < Val(strEarliest) Then
            strEarliest = oDate(ii)
      End If
   Next
   PUB_GetFirstPriDate2 = strEarliest
End Function
'add by nickc 2007/01/03
Public Function SplitValues(ByVal oStr As String) As Variant
Dim StrCount As Long
Dim NowCount As Long
Dim bolSymbol1 As Boolean  '逗號
Dim bolSymbol2 As Boolean  '上引號
Dim NewStr As String
oStr = Trim(oStr)
If Left(oStr, 1) = "(" Then
    oStr = Mid(oStr, 2)
End If
If Right(oStr, 1) = ")" Then
    oStr = Mid(oStr, 1, Len(oStr) - 1)
End If
'先把雙引號換掉
oStr = Replace(oStr, "''", "雙單引號")
StrCount = Len(oStr)
NewStr = ""
NowCount = 1
Do While Not NowCount > StrCount
    If Mid(oStr, NowCount, 1) = "'" Then
        NewStr = NewStr & Mid(oStr, NowCount, 1)
        NowCount = NowCount + 1
        Do While Mid(oStr, NowCount, 1) <> "'" And Not NowCount > StrCount
            NewStr = NewStr & Mid(oStr, NowCount, 1)
            NowCount = NowCount + 1
        Loop
        NewStr = NewStr & Mid(oStr, NowCount, 1)
        NowCount = NowCount + 1
    Else
        NewStr = NewStr & Mid(oStr, NowCount, 1)
        NowCount = NowCount + 1
        Do While Mid(oStr, NowCount, 1) <> "," And Not NowCount > StrCount
            NewStr = NewStr & Mid(oStr, NowCount, 1)
            NowCount = NowCount + 1
        Loop
    End If
    If Mid(oStr, NowCount, 1) = "," Then
        NewStr = NewStr & "逗號"
        NowCount = NowCount + 1
    End If
Loop
NewStr = Replace(NewStr, "雙單引號", "''")
SplitValues = Split(NewStr, "逗號")
End Function

'add by nickc 2007/01/23 更改智權人員時，一併更改下一程序智權人員
'商標的移轉,專利的讓與及專利權讓與發文時,
'同時更新下一程序非專業部掌控之案件性質(未續辦)的智權人員
Public Function pub_ChgSalesTargetIsNp(oCP01 As String, oCP02 As String, oCP03 As String, oCP04 As String, oSa As String)
Dim oStrSQLa As String
   
   'Modify By Sindy 2009/07/24 增加LIN系統類別
   oStrSQLa = "update nextprogress set np10='" & oSa & "' where np02='" & oCP01 & "' and np03='" & oCP02 & "' and np04='" & oCP03 & "' and np05='" & oCP04 & "'"
   '2010/3/22 MODIFY BY SONIA 改用常數strNpSqlOfNoSalesDuty
   oStrSQLa = oStrSQLa & strNpSqlOfNoSalesDuty
   oStrSQLa = oStrSQLa & " and np06 is null "
   cnnConnection.Execute oStrSQLa
End Function

'************************************************************************************************************

'edit by nickc 2007/02/02 **********************  以下由 clsPublicData copy 出來
'取得該Group所能用之系統類別
Public Function ClsPDGetGroupSystemKind(ByRef strGroup As String, ByRef strSystemKind As String) As Boolean
Dim StrSqlbb As String, rsRecordset As New ADODB.Recordset

On Error GoTo ErrHand
StrSqlbb = "select distinct sg02 from staff_group where sg01=" + CNULL(strGroup)
rsRecordset.CursorLocation = adUseClient
rsRecordset.Open StrSqlbb, cnnConnection, adOpenStatic, adLockReadOnly
If rsRecordset.RecordCount > 0 Then
   Do While Not rsRecordset.EOF
         strSystemKind = strSystemKind + rsRecordset.Fields(0) + ","
         rsRecordset.MoveNext
   Loop
   strSystemKind = Left(strSystemKind, Len(strSystemKind) - 1)
Else
   ShowMsg MsgText(9101)
End If
ClsPDGetGroupSystemKind = True
rsRecordset.Close
Exit Function
ErrHand:
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function
'分析系統類別字串
Public Function ClsPDAnalysisSystemKindString(ByRef strSystemKind As String, ByRef strSystem() As String) As Boolean
Dim varSystemTemp As Variant, i As Integer, intCaseKind As Integer

On Error GoTo ErrHand
varSystemTemp = Split(strSystemKind, ",")
For i = 0 To UBound(varSystemTemp)
   If ClsPDGetSystemKind(CStr(varSystemTemp(i)), intCaseKind) = False Then
      Exit Function
   Else
      Select Case intCaseKind
         Case 專利
            strSystem(0) = strSystem(0) + CNULL(CStr(varSystemTemp(i))) + ","
         Case 商標
            strSystem(1) = strSystem(1) + CNULL(CStr(varSystemTemp(i))) + ","
         Case 法務
            strSystem(2) = strSystem(2) + CNULL(CStr(varSystemTemp(i))) + ","
         Case 顧問
            strSystem(3) = strSystem(3) + CNULL(CStr(varSystemTemp(i))) + ","
         Case Else
            strSystem(4) = strSystem(4) + CNULL(CStr(varSystemTemp(i))) + ","
      End Select
   End If
Next
For i = 0 To 4
   If strSystem(i) <> "" Then
      strSystem(i) = Left(strSystem(i), Len(CStr(strSystem(i))) - 1)
   End If
Next
ClsPDAnalysisSystemKindString = True
Exit Function
ErrHand:
ShowMsg MsgText(9102)
'ErrorLog
End Function
'Remove by Lydia 2015/04/10 已不再使用
''代理人其他來函、主管機關一般（其他）來函存檔
'' 91.01.22 modify by louis (加傳回新增的CP09)
''Public Function SaveAgentOtherDatabase(ByRef intCaseKind As Integer, ByRef cp() As String, ByRef field() As String, ByRef cpT05 As String, ByRef cpT10 As String, ByRef npT07 As String, ByRef strID As String, ByRef cpT06 As String, ByRef cpT07 As String, ByRef spT50 As String, ByRef cpT14 As String, ByRef cpT48 As String, ByRef cpT64 As String, ByRef strNextProgress As String) As Boolean
'Public Function ClsPDSaveAgentOtherDatabase( _
'   ByRef intCaseKind As Integer, ByRef cp() As String, _
'   ByRef field() As String, ByRef cpT05 As String, _
'   ByRef cpT10 As String, ByRef npT07 As String, _
'   ByRef strID As String, ByRef cpT06 As String, _
'   ByRef cpT07 As String, ByRef spT50 As String, _
'   ByRef cpT14 As String, ByRef cpT48 As String, _
'   ByRef cpT64 As String, ByRef strNextProgress As String, _
'   Optional ByRef strNewCP09 As String = Empty) As Boolean
'Dim strDate As String
''Add By Cheng 2002/11/14
'Dim BolTransOk As Boolean
'BolTransOk = True
'
'On Error GoTo ErrHand1
'If intCaseKind <> 國外_CF Then
'   cpT05 = ChangeTDateStringToTString(cpT05)
'Else
'   cpT05 = ChangeWDateStringToWString(cpT05)
'End If
'cnnConnection.BeginTrans
''更新案件進度檔
'If ClsPDSaveCaseProgressDatabase(cp(), 國外_CF) = False Then GoTo ErrHand
''edit by nickc 2007/02/02
''Dim strDataTemp(1 To T_CP) As String
'Dim strDataTemp() As String
'ReDim strDataTemp(1 To TF_CP) As String
'
'strDataTemp(1) = cp(1)
'strDataTemp(2) = cp(2)
'strDataTemp(3) = cp(3)
'strDataTemp(4) = cp(4)
'strDataTemp(5) = cpT05
'strDataTemp(6) = cpT06
'strDataTemp(7) = cpT07
''Modify By Sindy 2010/8/17 比對自動編號年度
''strDataTemp(9) = 主管機關來函 + GetTaiwanThisYear
'strDataTemp(9) = 主管機關來函 + CompAutoNumberYear(GetTaiwanThisYear)
'strDataTemp(10) = cpT10
'strDataTemp(13) = cp(13)
'strDataTemp(12) = cp(12)
'strDataTemp(14) = cpT14
'strDataTemp(48) = cpT48
'strDataTemp(43) = cp(9)
'strDataTemp(20) = "N"
'strDataTemp(32) = "N"
''新增案件進度檔
'If ClsPDSaveNewCaseProgressDatabase(主管機關來函, strDataTemp(), intCaseKind) = False Then GoTo ErrHand
'' 91.01.22 modify by louis (傳回新的案件進度檔)
'strNewCP09 = strDataTemp(9)
'If npT07 <> "" Then
'   If ClsPDSaveNewNextProgressDatabase(intCaseKind, strDataTemp(), cpT06, cpT07, npT07, cpT64) = False Then GoTo ErrHand
'End If
'If strNextProgress <> "" Then
'   Dim strNext(0) As String
'   strNext(0) = strNextProgress
'   If ClsPDSetNextProgressDate(strNext(), cpT06, cpT07) = False Then GoTo ErrHand
'End If
'If strID <> "" Then
'   If ClsPDSaveAgentID(ChangeCustomerL(field(26)), field(9), strID) = False Then GoTo ErrHand
'End If
'ClsPDSaveAgentOtherDatabase = True
'ErrHand:
'If ClsPDSaveAgentOtherDatabase Then
'    'Modify By Cheng 2002/11/14
'    If BolTransOk Then
'        cnnConnection.CommitTrans
'    End If
'Else
'    'Modify By Cheng 2002/11/14
'    If BolTransOk Then
'        cnnConnection.RollbackTrans
'    End If
'End If
'Exit Function
'ErrHand1:
'    'Add By Cheng 2002/11/14
'    If Err.NUMBER = -2147168237 Then
'       BolTransOk = False
'       Resume Next
'    End If
'
'cnnConnection.RollbackTrans
'   'edit by nickc 2007/02/02
'   'ErrorLog
'   MsgBox Err.Description
'End Function
'Modified by Lydia 2015/04/10 frm02010603_3 已不用
''新增或更新申請人國外ID對照檔
'Public Function ClsPDSaveAgentID(ByRef strAgent As String, ByRef strNation As String, ByRef strID As String) As Boolean
'Dim StrSqlbb As String, rsRecordset As New ADODB.Recordset
'
'On Error GoTo ErrHand
'StrSqlbb = "select afid03 from applicantforeignid where afid01=" + CNULL(Left(strAgent, 8)) + " and afid02=" + CNULL(strNation)
'rsRecordset.CursorLocation = adUseClient
'rsRecordset.Open StrSqlbb, cnnConnection, adOpenStatic, adLockReadOnly
'If rsRecordset.RecordCount = 0 Then
'   StrSqlbb = "insert into applicantforeignid values(" + CNULL(Left(strAgent, 8)) + "," + CNULL(strNation) + "," + CNULL(strID) + ")"
'Else
'   StrSqlbb = "update applicantforeignid set afid03=" + CNULL(strID) + " where afid01=" + CNULL(Left(strAgent, 8)) + " and afid02=" + CNULL(strNation)
'End If
'rsRecordset.Close
'cnnConnection.Execute StrSqlbb
'ClsPDSaveAgentID = True
'Exit Function
'ErrHand:
'ShowMsg MsgText(9103)
'   'edit by nickc 2007/02/02
'   'ErrorLog
'   MsgBox Err.Description
'End Function
'代理人通知修正存檔
Public Function ClsPDSaveAgentNotifyDatabase(ByRef intCaseKind As Integer, ByRef cp() As String, ByRef cpT05 As String, ByRef cpT10 As String, ByRef cpT06 As String, ByRef cpT07 As String, ByRef cpT14 As String, ByRef cpT48 As String, ByRef cpT64 As String) As Boolean
Dim strDate As String
'Add By Cheng 2002/11/14
Dim BolTransOk As Boolean
BolTransOk = True

On Error GoTo ErrHand1:
cnnConnection.BeginTrans
If ClsPDSaveCaseProgressDatabase(cp(), 國外_CF) = False Then GoTo ErrHand
'edit by nickc 2007/02/02
'Dim strDataTemp(1 To T_CP) As String
Dim strDataTemp() As String
ReDim strDataTemp(1 To TF_CP) As String

strDataTemp(1) = cp(1)
strDataTemp(2) = cp(2)
strDataTemp(3) = cp(3)
strDataTemp(4) = cp(4)
strDataTemp(5) = cpT05
strDataTemp(6) = cpT06
strDataTemp(7) = cpT07
'Modify By Sindy 2010/8/17 比對自動編號年度
'strDataTemp(9) = 主管機關來函 + GetTaiwanThisYear
strDataTemp(9) = 主管機關來函 + CompAutoNumberYear(GetTaiwanThisYear)
strDataTemp(10) = 通知修正
strDataTemp(13) = cp(13)
strDataTemp(12) = cp(12)
strDataTemp(14) = cpT14
strDataTemp(48) = cpT48
strDataTemp(43) = cp(9)
strDataTemp(20) = "N"
strDataTemp(32) = "N"
'Add By Cheng 2002/07/22
strDataTemp(64) = "" & cpT64
If ClsPDSaveNewCaseProgressDatabase(主管機關來函, strDataTemp(), intCaseKind) = False Then GoTo ErrHand
If cpT10 <> "" Then
   If ClsPDSaveNewNextProgressDatabase(intCaseKind, strDataTemp(), cpT06, cpT07, cpT10, cpT64) = False Then GoTo ErrHand
End If
ClsPDSaveAgentNotifyDatabase = True
ErrHand:
If ClsPDSaveAgentNotifyDatabase Then
    'Modify By Cheng 2002/11/14
    If BolTransOk Then
        cnnConnection.CommitTrans
    End If
Else
    'Modify By Cheng 2002/11/14
    If BolTransOk Then
        cnnConnection.RollbackTrans
    End If
End If
Exit Function
ErrHand1:
    'Add By Cheng 2002/11/14
    If Err.Number = -2147168237 Then
       BolTransOk = False
       Resume Next
    End If

cnnConnection.RollbackTrans
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function

' 1 : 發明年費
' 2 : 新型年費
' 3 : 設計年費
' 4 : 發明實體審查
' 5 : 新型實體審查
' 6 : 設計實體審查
' 7 : 發明公開
' 8 : 新型公開
' 9 : 設計公開
'10 : 商標專用年度
'11 : 商標延展年度
'取得年費等期限
'Modified by Morgan 2019/12/3 +strReduceOneDay(專用期是否減1天):N=不減; 取消 GetNationTaxEx 改用本函數
'Modified by Morgan 2019/12/4 ByRef 及 Optional 修改
'Public Function ClsPDGetNationTax(ByRef intChoose As Integer, ByRef strNation As String, ByRef strStartUpDay As String, ByRef strYears As String, Optional strProperty As String, Optional strPayYears As String, Optional strCaseType As String, Optional strReduceOneDay As String) As Boolean
Public Function ClsPDGetNationTax(ByVal intChoose As Integer, ByVal strNation As String, Optional ByRef strStartUpDay As String, Optional ByRef strYears As String, Optional strProperty As String, Optional strPayYears As String, Optional strCaseType As String, Optional strReduceOneDay As String) As Boolean
Dim StrSqlbb As String, rsRecordset As New ADODB.Recordset, strTemp As String

On Error GoTo ErrHand
Select Case intChoose
   Case 1
      'Modified by Morgan 2019/12/3 +na82
      StrSqlbb = "select na06,na21,na07,na20,na82"
   Case 2
      'Modified by Morgan 2019/12/3 +na83
      StrSqlbb = "select na08,na23,na09,na22,na83"
   Case 3
      'Modified by Morgan 2019/12/3 +na84
      StrSqlbb = "select na10,na25,na11,na24,na84"
   Case 4
      StrSqlbb = "select na26,na27"
   Case 5
      StrSqlbb = "select na28,na29"
   Case 6
      StrSqlbb = "select na30,na31"
   Case 7
      StrSqlbb = "select na32,na33"
   Case 8
      StrSqlbb = "select na34,na35"
   Case 9
      StrSqlbb = "select na36,na37"
   Case 10
      StrSqlbb = "select na12,na13"
   'Add By Sindy 2019/10/16
   Case 11
      StrSqlbb = "select na12,na14"
   '2019/10/16 END
End Select
StrSqlbb = StrSqlbb + " from nation where na01=" + CNULL(strNation)
rsRecordset.CursorLocation = adUseClient
rsRecordset.Open StrSqlbb, cnnConnection, adOpenStatic, adLockReadOnly
If rsRecordset.RecordCount > 0 Then
   strStartUpDay = IIf(IsNull(rsRecordset.Fields(0)), "", rsRecordset.Fields(0))
   strYears = IIf(IsNull(rsRecordset.Fields(1)), "", rsRecordset.Fields(1))
   'Modified by Morgan 2019/12/3
   'If rsRecordset.Fields.Count = 4 Then
   If rsRecordset.Fields.Count = 5 Then
      strCaseType = "" & rsRecordset.Fields(3)
      'Added by Morgan 2020/10/19 馬來西亞發明及新型年費期限要減1天 --林禧佩
      'Removed by Morgan  2025/6/10 取消 --禧佩
      'If strNation = "018" And (intChoose = "1" Or intChoose = "2") Then
      '   strReduceOneDay = "Y"
      ''Removed by Morgan 2021/5/10 取消,年費改都不減1天,例外才要 --郭,玫音
      ''Else
      '''end 2020/10/19
      ''   strReduceOneDay = "" & rsRecordset.Fields(4)
      ''end 2021/5/10
      ''End If
      'end 2025/6/10
   'end 2019/12/3
      strPayYears = IIf(IsNull(rsRecordset.Fields(2)), "", rsRecordset.Fields(2))
      strTemp = IIf(IsNull(rsRecordset.Fields(3)), "", rsRecordset.Fields(3))
       
   End If
End If

'Modified by Morgan 2019/12/4
'Modified by Morgan 2020/12/24
'If (rsRecordset.Fields.Count = 2 And strYears = "") Or (rsRecordset.Fields.Count = 4 And strYears = "" And strTemp <> strProperty) Then
'If (rsRecordset.Fields.Count = 2 And strPayYears = "") Or (rsRecordset.Fields.Count = 5 And strPayYears = "") Then
If (rsRecordset.Fields.Count = 2 And strYears = "") Or (rsRecordset.Fields.Count = 5 And strPayYears = "") Then
'end 2019/12/4
   ShowMsg MsgText(9104)
Else
   ClsPDGetNationTax = True
End If
rsRecordset.Close
Exit Function
ErrHand:
ShowMsg MsgText(9105)
'ErrorLog
End Function

''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' 90.12.05 新增此段 By Louis (若案件性質為空的時不去做任何事)
' 回傳值為0時表成功, -1時表失敗, 1時表不做任何處理
' 1 : 發明年費
' 2 : 新型年費
' 3 : 設計年費
' 4 : 發明實體審查
' 5 : 新型實體審查
' 6 : 設計實體審查
' 7 : 發明公開
' 8 : 新型公開
' 9 : 設計公開
'10 : 商標
'取得年費等期限
'Modify by Morgan 2007/5/2 加strFeeProperty:回傳年費案件性質
'Modified by Morgan 2013/10/23 +strPA10,strPA21,strPA72
Public Function ClsPDGetNationTaxEx(ByRef intChoose As Integer, ByRef strNation As String, ByRef strStartUpDay As String, ByRef strYears As String, Optional strProperty As String, Optional strPayYears As String, Optional ByVal bShowMsg As Boolean = True, Optional ByRef strFeeProperty As String, Optional strPA10 As String, Optional strPA21 As String, Optional strPA72 As String) As Integer
Dim StrSqlbb As String, rsRecordset As New ADODB.Recordset, strTemp As String

On Error GoTo ErrHand
ClsPDGetNationTaxEx = -1
Select Case intChoose
   Case 1
      StrSqlbb = "select na06,na21,na07,na20"
   Case 2
      StrSqlbb = "select na08,na23,na09,na22"
   Case 3
      StrSqlbb = "select na10,na25,na11,na24"
   Case 4
      StrSqlbb = "select na26,na27"
   Case 5
      StrSqlbb = "select na28,na29"
   Case 6
      StrSqlbb = "select na30,na31"
   Case 7
      StrSqlbb = "select na32,na33"
   Case 8
      StrSqlbb = "select na34,na35"
   Case 9
      StrSqlbb = "select na36,na37"
   Case 10
      StrSqlbb = "select na12,na13"
End Select
StrSqlbb = StrSqlbb + " from nation where na01=" + CNULL(strNation)
rsRecordset.CursorLocation = adUseClient
rsRecordset.Open StrSqlbb, cnnConnection, adOpenStatic, adLockReadOnly
If rsRecordset.RecordCount > 0 Then
   strStartUpDay = IIf(IsNull(rsRecordset.Fields(0)), "", rsRecordset.Fields(0))
   strYears = IIf(IsNull(rsRecordset.Fields(1)), "", rsRecordset.Fields(1))
   If rsRecordset.Fields.Count = 4 Then
      strPayYears = IIf(IsNull(rsRecordset.Fields(2)), "", rsRecordset.Fields(2))
      strTemp = IIf(IsNull(rsRecordset.Fields(3)), "", rsRecordset.Fields(3))
   End If
End If
strFeeProperty = strTemp 'Add by Morgan 2007/5/2

' 90.12.05 modify by louis
If rsRecordset.Fields.Count > 2 Then
   If (rsRecordset.Fields.Count = 4 And (IsNull(rsRecordset.Fields(3)) Or rsRecordset.Fields(3) = "")) Then
      rsRecordset.Close
      ClsPDGetNationTaxEx = 1
      Exit Function
   End If
End If

If (rsRecordset.Fields.Count = 2 And strYears = "") Or (rsRecordset.Fields.Count = 4 And strYears = "" And strTemp <> strProperty) Then
   If bShowMsg Then
      ShowMsg MsgText(9104)
   End If
Else
   'Added by Morgan 2013/10/23
   If intChoose <= 3 Then
      PUB_GetSpecAnnuityRef strNation, intChoose, strPA10, strFeeProperty, strPA21, strPA72, strYears, , , strStartUpDay
   End If
   'end 2013/10/23
   ClsPDGetNationTaxEx = 0
End If

Exit Function
ErrHand:
If bShowMsg Then
   ShowMsg MsgText(9105)
'   ErrorLog
End If
End Function
'儲存該收文號之資料，不分系統，包含基本檔、進度檔
Public Function ClsPDSaveAllData(ByRef cp() As String, ByRef field() As String, ByRef intCaseKind As Integer, ByRef intWhere As Integer) As Boolean
Dim rt As Boolean, i As Integer

On Error GoTo ErrHand
If ClsPDSaveCaseProgressDatabase(cp(), intWhere) Then
   Select Case intCaseKind
      Case 專利
         If ClsPDSavePatentDatabase(field(), intWhere) Then
            rt = True
         Else
            ShowMsg MsgText(9112)
         End If
      Case 商標
         If ClsPDReadTrademarkDatabase(field(), intWhere) Then
            rt = True
         Else
            ShowMsg MsgText(9113)
         End If
      Case 法務
         If ClsPDSaveLawCaseDatabase(field()) Then
            rt = True
         Else
            ShowMsg MsgText(9114)
         End If
      Case 顧問
         If ClsPDSaveHireCaseDatabase(field()) Then
            rt = True
         Else
            ShowMsg MsgText(9115)
         End If
      Case Else
         If ClsPDSaveServicePracticeDatabase(field(), intWhere) Then
            rt = True
         Else
            ShowMsg MsgText(9116)
         End If
   End Select
Else
   ShowMsg MsgText(9117)
End If
If rt Then ClsPDSaveAllData = True
Exit Function
ErrHand:
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function
'新增資料至延期記錄檔
Public Function ClsPDSaveDelayData(ByRef strReceiveCode As String, ByRef strDelayDate As String, ByRef strDate1 As String, ByRef StrDate2 As String) As Boolean
Dim StrSqlbb As String

On Error GoTo ErrHand
StrSqlbb = "insert into datelimit values(" + CNULL(strReceiveCode) + "," + CNULL(strDelayDate) + "," + CNULL(strDate1) + "," + CNULL(StrDate2) + ")"
cnnConnection.Execute StrSqlbb
ClsPDSaveDelayData = True
Exit Function
ErrHand:
ShowMsg MsgText(9118)
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function
'取得本案前一個發文之代理人之彼所案號
Public Function ClsPDGetCaseThatCode(ByRef cp() As String) As Boolean
Dim StrSqlbb As String, rsRecordset As New ADODB.Recordset

On Error GoTo ErrHand
'Modified by Morgan 2012/2/15 只限於 A,B類已發文進度
StrSqlbb = "select cp45 from caseprogress where cp01=" + CNULL(cp(1)) + _
   " and cp02=" + CNULL(cp(2)) + " and cp03=" + CNULL(cp(3)) + _
   " and cp04=" + CNULL(cp(4)) + " and cp44=" + CNULL(ChangeCustomerL(cp(44))) + " and cp09<'C' order by cp27 desc"
rsRecordset.CursorLocation = adUseClient
rsRecordset.Open StrSqlbb, cnnConnection, adOpenStatic, adLockReadOnly
If rsRecordset.RecordCount > 0 Then
   cp(45) = IIf(IsNull(rsRecordset.Fields(0)), "", rsRecordset.Fields(0))
End If
ClsPDGetCaseThatCode = True
rsRecordset.Close
Exit Function
ErrHand:
ShowMsg MsgText(9118)
'ErrorLog
End Function

'取得本案前一個發文時之代理人
'Modified by Morgan 2014/11/24
'+bolShortNo: 末3碼 000 時只傳 6 碼
'Modified by Morgan 2024/6/24 +bolExclude605:是否排除年費
Public Function ClsPDGetCasePreAgent(ByRef strCode() As String, ByRef strAgent As String, Optional bolShortNo As Boolean = True, Optional strCP45 As String, Optional strCP09 As String, Optional bolExclude605 As Boolean = True) As Boolean
Dim StrSqlbb As String, rsRecordset As New ADODB.Recordset
Dim stCP10List As String 'Added by Morgan 2024/6/24 專利要排除的案件性質

On Error GoTo ErrHand

strCP45 = "": strCP09 = "" 'Added by Morgan 2024/3/27

'2007/4/19 modify by sonia 只限於 A,B類已發文進度
'StrSqlbb = "select cp44 from caseprogress where cp01=" + CNULL(strCode(1)) + _
'   " and cp02=" + CNULL(strCode(2)) + " and cp03=" + CNULL(strCode(3)) + _
'   " and cp04=" + CNULL(strCode(4)) + " and cp44 is not null order by cp27 desc"
'Modify by Morgan 2008/2/18 加聯絡人
'Modified by Morgan 2014/11/24 +收文號排序(取消原內專證書私有函數)
'Modified by Morgan 2023/10/27 +排除CFP的IDS(214)或相關收文號為IDS的進度,因IDS會固定給Y20825000且不變更原案件的代理人--郭
'StrSqlbb = "select cp44||decode(cp116,null,null,'-'||cp116) from caseprogress where cp01=" + CNULL(strCode(1)) + _
   " and cp02=" + CNULL(strCode(2)) + " and cp03=" + CNULL(strCode(3)) + _
   " and cp04=" + CNULL(strCode(4)) + " and cp09<'C' and cp44 is not null order by cp27 desc,cp09 desc"
'Modified by Morgan 2024/3/27 +cp45,cp09 排除 各國專利局Y編號
'Modified by Morgan 2024/4/11 排除P大陸案年費--郭
'Modified by Morgan 2024/6/24 改年費/維持費/延展費都排除--郭
'StrSqlbb = "select cp44||decode(cp116,null,null,'-'||cp116),cp45,cp09 from caseprogress a,PATENT" & _
   " where cp01=" & CNULL(strCode(1)) & " and cp02=" + CNULL(strCode(2)) & " and cp03=" & CNULL(strCode(3)) & " and cp04=" + CNULL(strCode(4)) & _
   " and cp09<'C' and cp44 is not null and cp57 is null AND NOT (CP01='CFP' AND CP10='214')" & _
   " AND PA01(+)=CP01 AND PA02(+)=CP02 AND PA03(+)=CP03 AND PA04(+)=CP04 AND NOT (CP01='P' AND CP10='605' AND PA09='020')" & _
   " and not exists(select * from caseprogress b,caseprogress c where b.cp09=a.cp43 and b.cp01='CFP' and c.cp09(+)=b.cp43 and (b.cp10='214' or c.cp10='214'))" & _
   " and not exists(select * from SetSpecMan where ocode='各國專利局Y編號' and instr(oman,cp44)>0)" & _
   " order by cp27 desc,cp09 desc"
If bolExclude605 Then
   stCP10List = "'214','605','606','607'"
Else
   stCP10List = "'214'"
End If
StrSqlbb = "select cp44||decode(cp116,null,null,'-'||cp116),cp45,cp09 from caseprogress a" & _
   " where cp01=" & CNULL(strCode(1)) & " and cp02=" + CNULL(strCode(2)) & " and cp03=" & CNULL(strCode(3)) & " and cp04=" + CNULL(strCode(4)) & _
   " and cp09<'C' and cp44 is not null and cp57 is null AND NOT (CP01 in ('P','CFP') AND CP10 in (" & stCP10List & "))" & _
   " and not exists(select * from caseprogress b,caseprogress c where b.cp09=a.cp43 and b.cp01 in ('P','CFP') and c.cp09(+)=b.cp43 and (b.cp10 in (" & stCP10List & ") or c.cp10 in (" & stCP10List & ")))" & _
   " order by cp27 desc,cp09 desc"
'end 2024/6/24
'2007/4/19 END
rsRecordset.CursorLocation = adUseClient
rsRecordset.Open StrSqlbb, cnnConnection, adOpenStatic, adLockReadOnly
If rsRecordset.RecordCount > 0 Then
   strAgent = IIf(IsNull(rsRecordset.Fields(0)), "", rsRecordset.Fields(0))
   'Added by Morgan 2024/3/27
   strCP45 = "" & rsRecordset.Fields("cp45")
   strCP09 = "" & rsRecordset.Fields("cp09")
   'end 2024/3/27
   If bolShortNo = True Then
      strAgent = ChangeCustomerS(strAgent)
   End If
   ClsPDGetCasePreAgent = True
End If
rsRecordset.Close
Exit Function
ErrHand:
ShowMsg MsgText(9119)
'ErrorLog
End Function


'取得延期天數,審查時間,提申期限
Public Function ClsPDGetCaseDelayDay(ByRef strSystem As String, ByRef strNation As String, ByRef strCaseProperty As String, Optional strCaseDelayDay As String, Optional strCheckDay As String, Optional strTakeDay As String) As Boolean
Dim StrSqlbb As String, rsRecordset As New ADODB.Recordset

On Error GoTo ErrHand
StrSqlbb = "select cf22,cf05,cf11 from casefee where cf01=" + CNULL(strSystem) + " and cf02=" + CNULL(strNation) + " and cf03=" + CNULL(strCaseProperty)
rsRecordset.CursorLocation = adUseClient
rsRecordset.Open StrSqlbb, cnnConnection, adOpenStatic, adLockReadOnly
If rsRecordset.RecordCount > 0 Then
   strCaseDelayDay = IIf(IsNull(rsRecordset.Fields(0)), "", rsRecordset.Fields(0))
   strCheckDay = IIf(IsNull(rsRecordset.Fields(1)), "", rsRecordset.Fields(1))
   strTakeDay = IIf(IsNull(rsRecordset.Fields(2)), "", rsRecordset.Fields(2))
   ClsPDGetCaseDelayDay = True
End If
rsRecordset.Close
Exit Function
ErrHand:
ShowMsg MsgText(9120)
'ErrorLog
End Function

''讀取發文資料,intCaseKind系統分類
'Public Function ClsPDReadSendCaseRst(ByRef intOpt As Integer, ByRef intCaseKind As Integer, ByRef intWhere As Integer, ByRef strGroup As String, ByRef strReceiveCode As String, ByRef strCode1 As String, ByRef strCode2 As String, ByRef strCode3 As String, ByRef strCode4 As String) As ADODB.Recordset
'Dim StrSqlbb As String, strSQL1bb As String, rsRecordset As New ADODB.Recordset
'Dim strDateLine As String
'
''If intWhere <> 國外_CF Then strDateLine = "-1911"
''strSQL = "select substr(cp05,1,4)" + strDateLine + "||'/'||substr(cp05,5,2)||'/'||substr(cp05,7,2) s01,"
''strSQL1 = "select substr(cp05,1,4)" + strDateLine + "||'/'||substr(cp05,5,2)||'/'||substr(cp05,7,2) s01,decode(sp09," + CNULL(大陸國家代號) + ",cpm04,cpm03) s02,staff.st02 s03,staff1.st02 s04,cp64 s05,cp09,cp20,cp10,sp09 s06,sk02,staff1.st01 s07 from caseprogress,servicepractice,casepropertymap,staff,staff staff1,staff_group,systemkind where sk01=sp01 and cp01=sp01 and cp02=sp02 and cp03=sp03 and cp04=sp04 and cp01=cpm01 and cp10=cpm02 and cp14=staff.st01(+) and cp13=staff1.st01 and sg01=" + CNULL(strGroup) + " and sg02=cp01 and sg03=cp10"
''Select Case intCaseKind
''   Case 專利
''      strSQL = strSQL + "decode(pa09," + CNULL(大陸國家代號) + ",cpm04,cpm03) s02,staff.st02 s03,staff1.st02 s04,cp64 s05,cp09,cp20,cp10,pa09 s06,sk02,staff1.st01 s07 from caseprogress,patent,casepropertymap,staff,staff staff1,staff_group,systemkind where sk01=cp01 and cp01=pa01 and cp02=pa02 and cp03=pa03 and cp04=pa04"
''   Case 商標
''      strSQL = strSQL + "decode(tm10," + CNULL(大陸國家代號) + ",cpm04,cpm03) s02,staff.st02 s03,staff1.st02 s04,cp64 s05,cp09,cp20,cp10,tm10 s06,sk02,staff1.st01 s07 from caseprogress,trademark,casepropertymap,staff,staff staff1,staff_group,systemkind where sk01=cp01 and cp01=tm01 and cp02=tm02 and cp03=tm03 and cp04=tm04"
''End Select
''strSQL = strSQL + " and cp01=cpm01 and cp10=cpm02 and cp14=staff.st01(+) and cp13=staff1.st01 and sg01=" + CNULL(strGroup) + " and sg02=cp01 and sg03=cp10"
''If intOpt = 1 Then
''   strSQL = strSQL + " and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4)
''   strSQL1 = strSQL1 + " and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4)
''Else
''   strSQL = strSQL + " and cp09=" + CNULL(strReceiveCode) + " and substr(cp09,1,1) in (" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")"
''   strSQL1 = strSQL1 + " and cp09=" + CNULL(strReceiveCode) + " and substr(cp09,1,1) in (" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")"
''End If
''strSQL = strSQL + " and cp27 is null and cp57 is null"
''strSQL1 = strSQL1 + " and cp27 is null and cp57 is null"
''strSQL = "select s01 收文日,s02 案件性質,s03 承辦人,s04 智權人員,s05 進度備註,cp09 總收文號,cp20 是否向客戶收款,cp10 案件性質,s06 申請國家,sk02 系統種類,s07 智權人員代號 from (" + strSQL + " union " + strSQL1 + ") order by s01"
''
'If intWhere <> 國外_CF Then strDateLine = "-1911"
'StrSqlbb = "select " & SQLDate("cp05") & " s01,"
'strSQL1bb = "select " & SQLDate("cp05") & " s01,decode(sp09," + CNULL(大陸國家代號) + ",cpm04,cpm03) s02,staff.st02 s03,staff1.st02 s04,cp64 s05,cp09,cp79,cp10,sp09 s06,sk02,staff1.st01 s07 from caseprogress,servicepractice,casepropertymap,staff,staff staff1,systemkind where cp09 < 'C' and sk01=sp01 and cp01=sp01 and cp02=sp02 and cp03=sp03 and cp04=sp04 and cp01=cpm01(+) and cp10=cpm02 and cp14=staff.st01(+) and cp13=staff1.st01(+) "
'Select Case intCaseKind
'   Case 專利
'      StrSqlbb = StrSqlbb + "decode(pa09," + CNULL(大陸國家代號) + ",cpm04,cpm03) s02,staff.st02 s03,staff1.st02 s04,cp64 s05,cp09,cp79,cp10,pa09 s06,sk02,staff1.st01 s07 from caseprogress,patent,casepropertymap,staff,staff staff1,systemkind where sk01=cp01 and cp01=pa01 and cp02=pa02 and cp03=pa03 and cp04=pa04"
'   Case 商標
'      StrSqlbb = StrSqlbb + "decode(tm10," + CNULL(大陸國家代號) + ",cpm04,cpm03) s02,staff.st02 s03,staff1.st02 s04,cp64 s05,cp09,cp79,cp10,tm10 s06,sk02,staff1.st01 s07 from caseprogress,trademark,casepropertymap,staff,staff staff1,systemkind where sk01=cp01 and cp01=tm01 and cp02=tm02 and cp03=tm03 and cp04=tm04"
'End Select
'StrSqlbb = StrSqlbb + " and cp09 < 'C' and cp01=cpm01(+) and cp10=cpm02 and cp14=staff.st01(+) and cp13=staff1.st01(+)"
'If intOpt = 1 Then
'   StrSqlbb = StrSqlbb + " and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4)
'   strSQL1bb = strSQL1bb + " and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4)
'Else
'   StrSqlbb = StrSqlbb + " and cp09=" + CNULL(strReceiveCode) + " and substr(cp09,1,1) in (" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")"
'   strSQL1bb = strSQL1bb + " and cp09=" + CNULL(strReceiveCode) + " and substr(cp09,1,1) in (" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")"
'End If
'StrSqlbb = StrSqlbb + " and cp27 is null and cp57 is null"
'strSQL1bb = strSQL1bb + " and cp27 is null and cp57 is null"
''911119 nick 邱小姐說 CP79 改成  未收金額
''strSQL = "select s01 收文日,s02 案件性質,s03 承辦人,s04 智權人員,s05 進度備註,cp09 總收文號,cp79 是否向客戶收款,cp10 案件性質,s06 申請國家,sk02 系統種類,s07 智權人員代號 from (" + strSQL + " union " + strSQL1 + ") order by s01"
'StrSqlbb = "select s01 收文日,s02 案件性質,s03 承辦人,s04 智權人員,s05 進度備註,cp09 總收文號,cp79 未收金額,cp10 案件性質,s06 申請國家,sk02 系統種類,s07 智權人員代號 from (" + StrSqlbb + " union " + strSQL1bb + ") order by s01"
'
'Set ClsPDReadSendCaseRst = ClsPDReadRst(StrSqlbb)
'End Function

'分案之優先權資料－讀取
'Modify by Amy 2014/03/25 +PD09
'Modify by Sindy 2017/9/29 +PD10
'Modified by Lydia 2023/02/09 +stWhere
Public Function ClsPDReadPriority(ByRef strCode() As String, ByRef strPriority1 As String, ByRef strPriority2 As String, ByRef strPriority3 As String, Optional ByRef strPriority4 As String, Optional ByRef strPriority5 As String, Optional ByRef strPriority6 As String, Optional ByVal stWhere As String) As Boolean
Dim StrSqlbb As String, i As Integer, rsRecordset As New ADODB.Recordset
Dim tmpArr As Variant 'Added by Lydia 2023/02/09

On Error GoTo ErrHand

'Addeed by Lydia 2023/02/09 判斷商品類別frm030201_02
If stWhere <> "" Then
   StrSqlbb = "select pd07,pd05,pd06,pd08,pd09,pd10 from pridate where pd01=" + CNULL(strCode(1)) + _
      " and pd02=" + CNULL(strCode(2)) + " and pd03=" + CNULL(strCode(3)) + _
      " and pd04=" + CNULL(strCode(4)) + " and (PD10 is null or instr(PD10,'" & stWhere & "')>0) "
   tmpArr = Split(stWhere, ",")
   For i = 0 To UBound(tmpArr)
      If Trim(tmpArr(i)) <> "" Then
         StrSqlbb = StrSqlbb & "Union select pd07,pd05,pd06,pd08,pd09,pd10 from pridate where pd01=" + CNULL(strCode(1)) + _
            " and pd02=" + CNULL(strCode(2)) + " and pd03=" + CNULL(strCode(3)) + _
            " and pd04=" + CNULL(strCode(4)) + " and instr(PD10,'" & Format(tmpArr(i), "00") & "')>0 "
      End If
   Next i
Else
'end 2023/02/09
   StrSqlbb = "select pd07,pd05,pd06,pd08,pd09,pd10 from pridate where pd01=" + CNULL(strCode(1)) + _
      " and pd02=" + CNULL(strCode(2)) + " and pd03=" + CNULL(strCode(3)) + _
      " and pd04=" + CNULL(strCode(4))
End If 'Added by Lydia 2023/02/09

rsRecordset.CursorLocation = adUseClient
rsRecordset.Open StrSqlbb, cnnConnection, adOpenStatic, adLockReadOnly
strPriority1 = ""
strPriority2 = ""
strPriority3 = ""
strPriority4 = ""
strPriority5 = ""
strPriority6 = ""
If rsRecordset.RecordCount > 0 Then
   Do
      strPriority1 = strPriority1 + rsRecordset.Fields(0) + "，"
      strPriority2 = strPriority2 + Format(rsRecordset.Fields(1)) + "，"
      strPriority3 = strPriority3 + "" & rsRecordset.Fields(2) + "，"
      'Add by Morgan 2007/4/24
      strPriority4 = strPriority4 + "" & rsRecordset.Fields(3) & "，"
      'Add by Amy 2014/03/25
      strPriority5 = strPriority5 + "" & rsRecordset.Fields(4) & "，"
      strPriority6 = strPriority6 + "" & rsRecordset.Fields(5) & "，" 'Add By Sindy 2017/9/29
      rsRecordset.MoveNext
   Loop While Not rsRecordset.EOF
   strPriority1 = Mid(strPriority1, 1, Len(strPriority1) - 1)
   strPriority2 = Mid(strPriority2, 1, Len(strPriority2) - 1)
   strPriority3 = Mid(strPriority3, 1, Len(strPriority3) - 1)
   'Add by Morgan 2007/4/24
   strPriority4 = Mid(strPriority4, 1, Len(strPriority4) - 1)
   'Add by Amy 2014/03/25
   strPriority5 = Mid(strPriority5, 1, Len(strPriority5) - 1)
   strPriority6 = Mid(strPriority6, 1, Len(strPriority6) - 1) 'Add By Sindy 2017/9/29
End If
rsRecordset.Close
ClsPDReadPriority = True
Exit Function
ErrHand:
ShowMsg MsgText(9121)
'ErrorLog
End Function

'分案之優先權資料－刪除
Public Function ClsPDDeletePriority(ByRef strCode() As String) As Boolean
Dim StrSqlbb As String

On Error GoTo ErrHand
'Add By Cheng 2002/11/06
ClsPDDeletePriority = False

StrSqlbb = "delete from pridate where pd01=" + CNULL(strCode(1)) + _
    " and pd02=" + CNULL(strCode(2)) + " and pd03=" + CNULL(strCode(3)) + _
    " and pd04=" + CNULL(strCode(4))
cnnConnection.Execute StrSqlbb
ClsPDDeletePriority = True
Exit Function
ErrHand:
ShowMsg MsgText(9122)
'ErrorLog
End Function

'新增優先權資料
'** frm060105_2 有Insert PriDate 故請確認frm060105_2是否也需修改
'Modify by Amy 2014/03/25 加PD09
'Modify by Morgan 2007/4/24 加PD8
'Modify by Sindy 2017/9/29 加PD10
Public Function ClsPDSavePriority(ByRef strCode() As String, ByRef strPriority1 As String, ByRef strPriority2 As String, ByRef strPriority3 As String, Optional ByRef strPriority4 As String, Optional ByRef strPriority5 As String, Optional ByRef strPriority6 As String) As Boolean
Dim varPriorityTemp1, varPriorityTemp2, varPriorityTemp3, varPriorityTemp4, varPriorityTemp5, varPriorityTemp6, i As Integer
Dim StrSqlbb As String
Dim strPD06 As String, strPD08 As String
Dim strPD09 As String 'Add by Amy 2014/03/25
Dim strPD10 As String 'Add by Sindy 2017/9/29

On Error GoTo ErrHand
ClsPDSavePriority = False

If ClsPDDeletePriority(strCode()) = False Then Exit Function
If strPriority1 <> "" Then
   'Add by Morgan 2008/9/3 優先權日可空白故後面補一空白以免無陣列可讀
   If strPriority2 = "" Then strPriority2 = " "
   varPriorityTemp1 = Split(strPriority1, "，")
   varPriorityTemp2 = Split(strPriority2, "，")
   varPriorityTemp3 = Split(strPriority3, "，")
   varPriorityTemp4 = Split(strPriority4, "，")
   'Add by Amy 2014/03/25
   varPriorityTemp5 = Split(strPriority5, "，")
   varPriorityTemp6 = Split(strPriority6, "，") 'Add by Sindy 2017/9/29
   For i = 0 To UBound(varPriorityTemp1)
      strPD06 = "": strPD08 = "": strPD09 = "" 'Add by Amy 2014/03/25 +strPD09
      strPD10 = "" 'Add by Sindy 2017/9/29 +strPD10
      If UBound(varPriorityTemp1) = UBound(varPriorityTemp3) Then
         strPD06 = ChgSQL(CStr(varPriorityTemp3(i)))
      Else
         strPD06 = " "
      End If
      If UBound(varPriorityTemp1) = UBound(varPriorityTemp4) Then
         strPD08 = ChgSQL(CStr(varPriorityTemp4(i)))
      End If
      'Add by Amy 2014/03/25
      If UBound(varPriorityTemp1) = UBound(varPriorityTemp5) Then
         strPD09 = ChgSQL(CStr(varPriorityTemp5(i)))
      End If
      'Add by Sindy 2017/9/29
      If UBound(varPriorityTemp1) = UBound(varPriorityTemp6) Then
         strPD10 = ChgSQL(CStr(varPriorityTemp6(i)))
      End If
      StrSqlbb = "insert into pridate(PD01,PD02,PD03,PD04,PD05,PD06,PD07,PD08,PD09,PD10) values (" + CNULL(strCode(1)) + "," + CNULL(strCode(2)) + "," + CNULL(strCode(3)) + "," + _
            CNULL(strCode(4)) + "," + CNULL(Trim(CStr(varPriorityTemp2(i))), True) + "," + CNULL(strPD06) + "," + CNULL(CStr(varPriorityTemp1(i))) + "," & CNULL(strPD08) & "," & CNULL(strPD09) & "," & CNULL(strPD10) & ")"
      cnnConnection.Execute StrSqlbb
   Next
End If
ClsPDSavePriority = True
Exit Function
ErrHand:
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
ErrHand1:
ShowMsg MsgText(9123)
End Function

'分案之指定國家－讀取
'bolHasLicenceNumber 是否閉卷
'bolHasMoney 是否年費
'Added by Lydia 2016/06/14 +bolHasName 定稿使用,抓國家名稱
Public Function ClsPDReadCountry(ByRef intCaseKind As Integer, ByRef strCode() As String, ByRef strCountry As String, Optional bolHasLicenceNumber As Boolean = False, Optional bolHasMoney As Boolean = False, Optional bolHasName As Boolean = False) As Boolean
Dim StrSqlbb As String, i As Integer, rsRecordset As New ADODB.Recordset

On Error GoTo ErrHand
If bolHasMoney = False Then
   Select Case intCaseKind
      Case 專利
         StrSqlbb = "select pa09 from patent where pa01=" + CNULL(strCode(1)) + _
            " and pa02=" + CNULL(strCode(2)) + " and pa03=" + CNULL(strCode(3)) + _
            " and pa04<>" + CNULL(strCode(4))
         If bolHasLicenceNumber Then
            StrSqlbb = StrSqlbb + " and pa57 is null"
         End If
      Case Else
         StrSqlbb = "select sp09 from servicepractice where sp01=" + CNULL(strCode(1)) + _
            " and sp02=" + CNULL(strCode(2)) + " and sp03=" + CNULL(strCode(3)) + _
            " and sp04<>" + CNULL(strCode(4))
         If bolHasLicenceNumber Then
            StrSqlbb = StrSqlbb + " and sp15 is null"
         End If
   End Select
Else
   'Modified by Morgan 2018/5/24 沒用過改寫為帶出年費發文指定國家
   'Select Case intCaseKind
   '   Case 專利
   '      StrSqlbb = "select pa09 from patent,caseprogress where pa01=" + CNULL(strCode(1)) + _
   '         " and pa02=" + CNULL(strCode(2)) + " and pa03=" + CNULL(strCode(3)) + _
   '         " and pa04<>" + CNULL(strCode(4)) + " and pa01=cp01 and pa02=cp02 and pa03=cp03 and pa04=cp04 and cp10=" + CNULL(年費)
   '
   '   Case Else
   '      StrSqlbb = "select sp09 from servicepractice,caseprogress where sp01=" + CNULL(strCode(1)) + _
   '         " and sp02=" + CNULL(strCode(2)) + " and sp03=" + CNULL(strCode(3)) + _
   '         " and pa04<>" + CNULL(strCode(4)) + " and sp01=cp01 and sp02=cp02 and sp03=cp03 and sp04=cp04 and cp10=" + CNULL(年費)
   'End Select
         StrSqlbb = "select pa09 from patent where pa01=" + CNULL(strCode(1)) + _
            " and pa02=" + CNULL(strCode(2)) + " and pa03=" + CNULL(strCode(3)) + " and pa04<>" + CNULL(strCode(4)) + _
            " and exists(select * from caseprogress where cp01=pa01 and cp02=pa02 and cp03=pa03 and cp04=pa04 and cp10=" + CNULL(年費) & ")"
         
         If bolHasLicenceNumber Then
            StrSqlbb = StrSqlbb + " and pa57 is null"
         End If
   'end 2018/5/24
End If
rsRecordset.CursorLocation = adUseClient
If intCaseKind = 專利 Then
   StrSqlbb = StrSqlbb & " ORDER BY PA04"
Else
   StrSqlbb = StrSqlbb & " ORDER BY SP04"
End If
rsRecordset.Open StrSqlbb, cnnConnection, adOpenStatic, adLockReadOnly
strCountry = ""
If rsRecordset.RecordCount > 0 Then
   Do
        strCountry = strCountry + rsRecordset.Fields(0) + ","
        rsRecordset.MoveNext
   Loop While Not rsRecordset.EOF
   strCountry = Mid(strCountry, 1, Len(strCountry) - 1)
End If
rsRecordset.Close
'Added by Lydia 2016/06/14 處理字串
If bolHasName Then
   'Modified by Morgan 2023/8/10 以本所號排序
   'strCountry = PUB_GetNationName(strCountry)
   strCountry = PUB_GetNationName(strCountry, , True)
   'end 2023/8/10
   If InStr(strCountry, ",") > 0 Then 'Added by Lydia 2018/04/16
      strCountry = Mid(strCountry, 1, InStrRev(strCountry, ",") - 1) & "及" & Mid(strCountry, InStrRev(strCountry, ",") + 1)
   End If
   strCountry = Replace(strCountry, ",", "、")
End If

ClsPDReadCountry = True
Exit Function
ErrHand:
ShowMsg MsgText(9124)
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function

'分案之指定國家－刪除,intSend 0: 刪除基本資料  intSend 1:刪除基本資料及案件進度資料
Public Function ClsPDDeleteCountry(ByRef intSend As Integer, ByRef intCaseKind As Integer, ByRef strCode() As String) As Boolean
Dim StrSqlbb As String, i As Integer

On Error GoTo ErrHand
Select Case intCaseKind
   Case 專利
      StrSqlbb = "delete from patent where pa01=" + CNULL(strCode(1)) + _
         " and pa02=" + CNULL(strCode(2)) + " and pa03=" + CNULL(strCode(3)) + _
         " and pa04<>" + CNULL(strCode(4))
      cnnConnection.Execute StrSqlbb
   Case 商標
      StrSqlbb = "delete from trademark where tm01=" + CNULL(strCode(1)) + _
         " and tm02=" + CNULL(strCode(2)) + " and tm03=" + CNULL(strCode(3)) + _
         " and tm04<>" + CNULL(strCode(4))
      cnnConnection.Execute StrSqlbb
   Case Else
      StrSqlbb = "delete from servicepractice where sp01=" + CNULL(strCode(1)) + _
         " and sp02=" + CNULL(strCode(2)) + " and sp03=" + CNULL(strCode(3)) + _
         " and sp04<>" + CNULL(strCode(4))
      cnnConnection.Execute StrSqlbb
End Select
If intSend = 1 Then
   StrSqlbb = "delete from caseprogress where cp01=" + CNULL(strCode(1)) + _
      " and cp02=" + CNULL(strCode(2)) + " and cp03=" + CNULL(strCode(3)) + _
      " and cp04<>" + CNULL(strCode(4))
   cnnConnection.Execute StrSqlbb
End If
ClsPDDeleteCountry = True
Exit Function
ErrHand:
ShowMsg MsgText(9125)
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function

'Removed by Morgan 2013/9/25 沒使用
''分案之指定國家－新增  intSend 0: 新增基本資料  intSend 1:新增案件進度資料
''                      intSend 2:新增基本資料及案件進度資料
'Public Function ClsPDSaveCountry(ByRef intSend As Integer, ByRef intCaseKind As Integer, _
'    ByRef strRule As String, ByVal strReciveNo As String, ByRef strCountry As String) As Boolean
'**內容已刪除**
'End Function
''分案之轉本所案號
'Public Function ClsPDReCaseCode(ByRef bolNew As Boolean, ByRef intCaseKind As Integer, ByRef intWhere As Integer, ByRef strReceiveCode As String, ByRef field() As String, ByRef strCode() As String) As Boolean
'**內容已刪除**
'End Function
'end 2013/9/25

'新增資料至ChangeEvent基本檔
Public Function ClsPDSaveChangeEventDatabase(ByRef strChange As String, ByRef intWhere As Integer) As Boolean
Dim StrSqlbb As String, i As Integer, varChangeTemp As Variant, strTmpbb As String

On Error GoTo ErrHand
'Modify by Morgan 2011/6/10 變更事項改用 chr(29) 分隔,因為地址欄內會有逗號(Ex.CFP-023675)
'varChangeTemp = Split(strChange, ",")
varChangeTemp = Split(strChange, Chr(29))

If intWhere = 國內 Then
   varChangeTemp(1) = ChangeTStringToWString(CStr(varChangeTemp(1)))
End If
varChangeTemp(3) = ChangeCustomerL(CStr(varChangeTemp(3)))
varChangeTemp(4) = ChangeCustomerL(CStr(varChangeTemp(4)))
varChangeTemp(5) = ChangeCustomerL(CStr(varChangeTemp(5)))
varChangeTemp(6) = ChangeCustomerL(CStr(varChangeTemp(6)))
varChangeTemp(7) = ChangeCustomerL(CStr(varChangeTemp(7)))
strTmpbb = ""
StrSqlbb = ""
For i = 0 To UBound(varChangeTemp) - 1
   If CStr(varChangeTemp(i)) <> "" Then
      strTmpbb = strTmpbb & "CE" & Format(i + 1, "00") & ","
      StrSqlbb = StrSqlbb + CNULL(CStr(varChangeTemp(i))) + ","
   End If
Next
If Right(strTmpbb, 1) = "," Then strTmpbb = Left(strTmpbb, Len(strTmpbb) - 1)
If Right(StrSqlbb, 1) = "," Then StrSqlbb = Left(StrSqlbb, Len(StrSqlbb) - 1)
StrSqlbb = "insert into changeevent (" & strTmpbb & ") values (" & StrSqlbb & ")"
cnnConnection.Execute StrSqlbb
ClsPDSaveChangeEventDatabase = True
Exit Function
ErrHand:
ShowMsg MsgText(9129)
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function
'新增資料至ServicePractice基本檔
Public Function ClsPDSaveNewServicePracticeDatabase(ByRef sp() As String, ByRef intWhere As Integer) As Boolean
Dim StrSqlbb As String, i As Integer

On Error GoTo ErrHand
If intWhere = 國內 Then
   sp(10) = ChangeTStringToWString(sp(10))
   sp(12) = ChangeTStringToWString(sp(12))
   sp(16) = ChangeTStringToWString(sp(16))
   sp(20) = ChangeTStringToWString(sp(20))
   sp(21) = ChangeTStringToWString(sp(21))
   sp(39) = ChangeTStringToWString(sp(39))
   sp(40) = ChangeTStringToWString(sp(40))
End If
sp(8) = ChangeCustomerL(sp(8))
sp(26) = ChangeCustomerL(sp(26))
sp(35) = ChangeCustomerL(sp(35))
sp(37) = ChangeCustomerL(sp(37))
sp(65) = ChangeCustomerL(sp(65))
sp(66) = ChangeCustomerL(sp(66))
sp(67) = ChangeCustomerL(sp(67))
strSql = "insert into servicepractice values("
'For i = 1 To T_SP - 1
For i = 1 To tf_SP 'edit by nickc 2007/02/02 T_SP
       StrSqlbb = StrSqlbb + CNULL(Replace(sp(i), "'", "''")) + ","
Next
StrSqlbb = StrSqlbb + CNULL(sp(i)) + ")"
cnnConnection.Execute StrSqlbb
ClsPDSaveNewServicePracticeDatabase = True
Exit Function
ErrHand:
ShowMsg MsgText(9130)
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function

'新增資料至Patent基本檔
Public Function ClsPDSaveNewPatentDatabase(ByRef pa() As String, ByVal intWhere As Integer, Optional bolDate As Boolean = True) As Boolean
 Dim StrSqlbb As String, i As Integer, strTmpbb As String, strTmp1bb As String
On Error GoTo ErrHand
   If intWhere <> 國外_CF Or bolDate = False Then
      pa(10) = ChangeTStringToWString(pa(10))
      pa(12) = ChangeTStringToWString(pa(12))
      pa(14) = ChangeTStringToWString(pa(14))
      pa(20) = ChangeTStringToWString(pa(20))
      pa(21) = ChangeTStringToWString(pa(21))
      pa(24) = ChangeTStringToWString(pa(24))
      pa(25) = ChangeTStringToWString(pa(25))
      pa(58) = ChangeTStringToWString(pa(58))
   End If
   pa(26) = ChangeCustomerL(pa(26))
   pa(27) = ChangeCustomerL(pa(27))
   pa(28) = ChangeCustomerL(pa(28))
   pa(29) = ChangeCustomerL(pa(29))
   pa(30) = ChangeCustomerL(pa(30))
   pa(75) = ChangeCustomerL(pa(75))
   pa(76) = ChangeCustomerL(pa(76))
   pa(86) = ChangeCustomerL(pa(86))
   pa(88) = ChangeCustomerL(pa(88))
   pa(101) = ChangeCustomerL(pa(101))
   pa(105) = ChangeCustomerL(pa(105))
   pa(133) = ChangeCustomerL(pa(133))
   pa(134) = ChangeCustomerL(pa(134))
   For i = 1 To 99
      Select Case i
         Case 92, 93, 94, 95, 96, 97
         Case Else
          StrSqlbb = StrSqlbb & CNULL(Replace(pa(i), "'", "''")) & ","
          strTmpbb = strTmpbb & "PA" & Format(i, "00") & ","
      End Select
   Next
   For i = 100 To TF_PA 'edit by nickc 2007/02/02 T_PA
'      If i = 103 Then
         If InStr(pa(i), "'") > 0 Then
            strTmp1bb = Replace(pa(i), "'", "''")
            StrSqlbb = StrSqlbb + CNULL(strTmp1bb) + ","
         Else
            StrSqlbb = StrSqlbb + CNULL(pa(i)) + ","
         End If
'      Else
'         strSQL = strSQL + CNULL(pa(i)) + ","
'      End If
      strTmpbb = strTmpbb & "PA" & Format(i) & ","
   Next
   StrSqlbb = Left(StrSqlbb, Len(StrSqlbb) - 1)
   strTmpbb = Left(strTmpbb, Len(strTmpbb) - 1)
   StrSqlbb = "insert into patent (" & strTmpbb & ") values (" & StrSqlbb & ")"
   cnnConnection.Execute StrSqlbb
   ClsPDSaveNewPatentDatabase = True
   Exit Function
ErrHand:
   ShowMsg MsgText(9131)
      'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function
'新增資料至Trademark基本檔
Public Function ClsPDSaveNewTrademarkDatabase(ByRef tm() As String, ByRef intWhere As Integer) As Boolean
Dim StrSqlbb As String, i As Integer

On Error GoTo ErrHand
If intWhere = 國內 Then
   tm(11) = ChangeTStringToWString(tm(11))
   tm(13) = ChangeTStringToWString(tm(13))
   tm(14) = ChangeTStringToWString(tm(14))
   tm(20) = ChangeTStringToWString(tm(20))
   tm(21) = ChangeTStringToWString(tm(21))
   tm(22) = ChangeTStringToWString(tm(22))
   tm(30) = ChangeTStringToWString(tm(30))
End If
tm(23) = ChangeCustomerL(tm(23))
tm(44) = ChangeCustomerL(tm(44))
tm(54) = ChangeCustomerL(tm(54))
tm(56) = ChangeCustomerL(tm(56))
tm(69) = ChangeCustomerL(tm(69))
tm(70) = ChangeCustomerL(tm(70))
StrSqlbb = "insert into trademark values("
'For i = 1 To T_PA - 1
For i = 1 To TF_TM 'edit by nickc 2007/02/02 T_TM
       StrSqlbb = StrSqlbb + CNULL(Replace(tm(i), "'", "''")) + ","
Next
StrSqlbb = StrSqlbb + CNULL(tm(i)) + ")"
cnnConnection.Execute StrSqlbb
ClsPDSaveNewTrademarkDatabase = True
Exit Function
ErrHand:
ShowMsg MsgText(9132)
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function
'Modify By Cheng 2002/01/28
'多加參數 Optional 目的是傳回值給呼叫的Form列印使用 : m_strCP09ByCheng (總收文號)
'新增資料至CaseProgress基本檔
'Public Function SaveNewCaseProgressDatabase(ByRef cp09 As String, ByRef cp() As String, ByRef intWhere As Integer) As Boolean
Public Function ClsPDSaveNewCaseProgressDatabase(ByRef CP09 As String, ByRef cp() As String, ByRef intWhere As Integer, Optional m_strCP09ByCheng As String) As Boolean
Dim StrSqlbb As String, i As Integer, strAutoNumber As String, strTmpbb As String

On Error GoTo ErrHand
If ClsPDGetAutoNumber(CP09, strAutoNumber, True, True) Then
   cp(9) = CP09 + Mid(cp(9), 2, 2) + strAutoNumber
   'Add By Cheng 2002/01/28
   m_strCP09ByCheng = cp(9)
   If intWhere <> 國外_CF Then
      'Modified by Lydia 2019/05/31 將ChangeTStringToWString換成DBDATE
      cp(5) = DBDATE(cp(5))
      cp(6) = DBDATE(cp(6))
      cp(7) = DBDATE(cp(7))
      cp(25) = DBDATE(cp(25))
      cp(27) = DBDATE(cp(27))
      cp(46) = DBDATE(cp(46))
      cp(47) = DBDATE(cp(47))
      cp(48) = DBDATE(cp(48))
      cp(53) = DBDATE(cp(53))
      cp(54) = DBDATE(cp(54))
      cp(57) = DBDATE(cp(57))
      'end 2019/05/31
   End If
   cp(44) = ChangeCustomerL(cp(44))
   cp(55) = ChangeCustomerL(cp(55))
   cp(56) = ChangeCustomerL(cp(56))
   For i = 1 To TF_CP 'edit by nickc 2007/02/02 T_CP
      Select Case i
         Case 65, 66, 67, 68, 69, 70
         Case Else
          StrSqlbb = StrSqlbb & CNULL(Replace(cp(i), "'", "''")) & ","
          strTmpbb = strTmpbb & "CP" & Format(i, "00") & ","
      End Select
   Next
   StrSqlbb = Left(StrSqlbb, Len(StrSqlbb) - 1)
   strTmpbb = Left(strTmpbb, Len(strTmpbb) - 1)
   StrSqlbb = "insert into caseprogress (" & strTmpbb & ") values (" & StrSqlbb & ")"
   cnnConnection.Execute StrSqlbb
   ClsPDSaveNewCaseProgressDatabase = True
Else
   ShowMsg MsgText(9133)
End If
Exit Function
ErrHand:
ShowMsg MsgText(9134)
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function
'讀取下一程序檔是否存在
Public Function ClsPDReadNextProgressData(ByRef np() As String, Optional strRowID As String = "") As Boolean
Dim strSql As String, rsRecordset As New ADODB.Recordset, i As Integer, intWhere As Integer

On Error GoTo ErrHand
If strRowID = "" Then
   strSql = "select * from nextprogress where np07=" + CNULL(np(7)) + _
      " and np02=" + CNULL(np(2)) + " and np03=" + CNULL(np(3)) + " and np04=" + CNULL(np(4)) + " and np05=" + CNULL(np(5))
Else
   strSql = "select * from nextprogress where dbms_rowid.rowid_to_restricted(rowid,0)=" + CNULL(strRowID)
End If
rsRecordset.CursorLocation = adUseClient
rsRecordset.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If rsRecordset.RecordCount > 0 Then
   For i = 0 To TF_NP - 1 'edit by nickc 2007/02/06 T_NP - 1
          np(i + 1) = IIf(IsNull(rsRecordset.Fields(i)), "", rsRecordset.Fields(i))
   Next
   If ClsPDGetSystemKind(np(2), , , intWhere) = False Then GoTo ErrHand1
      If intWhere <> 國外_CF Then
         np(8) = ChangeWStringToTString(np(8))
         np(9) = ChangeWStringToTString(np(9))
      End If
End If
ErrHand1:
rsRecordset.Close
ClsPDReadNextProgressData = True
Exit Function
ErrHand:
ShowMsg MsgText(9135)
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function
' 選取資料表
Public Function ClsPDSelectTable(strSql As String, ByRef adoRecord As ADODB.Recordset) As Boolean
Dim adoTable As Object

   Set adoTable = CreateObject("ADODB.Recordset")
   adoTable.CursorLocation = adUseClient
   adoTable.Open strSql, cnnConnection, adOpenDynamic, adLockBatchOptimistic
   If adoTable.RecordCount <> 0 Then
      Set adoRecord = adoTable
      ClsPDSelectTable = True
   Else
      ClsPDSelectTable = False
   End If
End Function
'更新下一程序檔之本所期限及法定期限
Public Function ClsPDSetNextProgressDate(ByRef strNextProgress() As String, ByRef strDate1 As String, ByRef StrDate2 As String) As Boolean
Dim strSql As String, i As Integer, strSQLtemp As String

On Error GoTo ErrHand
strSql = "update nextprogress set np08=" + strDate1 + ",np09=" + StrDate2 + " where dbms_rowid.rowid_to_restricted(nextprogress.rowid,0) in "
strSQLtemp = "("
For i = 0 To UBound(strNextProgress)
       strSQLtemp = strSQLtemp + CNULL(strNextProgress(i)) + ","
Next
strSQLtemp = Mid(strSQLtemp, 1, Len(strSQLtemp) - 1) + ")"
strSql = strSql + strSQLtemp
cnnConnection.Execute strSql
ClsPDSetNextProgressDate = True
Exit Function
ErrHand:
ShowMsg MsgText(9136)
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function
'更新下一程序檔之是否續辦欄
Public Function ClsPDSetNextProgressGoOn(ByRef strNextProgress() As String, ByRef bolRowID As Boolean, Optional bolGoOn As Boolean = True) As Boolean
Dim strSql As String, i As Integer, strSQLtemp As String, strGoOn As String

On Error GoTo ErrHand
If bolGoOn Then
   strGoOn = "Y"
Else
   strGoOn = "N"
End If
strSql = "update nextprogress set np06=" + CNULL(strGoOn)
If bolRowID Then
   strSql = strSql + " where dbms_rowid.rowid_to_restricted(nextprogress.rowid,0) in "
Else
   strSql = strSql + " where np01 in "
End If
strSQLtemp = "("
For i = 0 To UBound(strNextProgress)
       strSQLtemp = strSQLtemp + CNULL(strNextProgress(i)) + ","
Next
strSQLtemp = Mid(strSQLtemp, 1, Len(strSQLtemp) - 1) + ")"
strSql = strSql + strSQLtemp
cnnConnection.Execute strSql
ClsPDSetNextProgressGoOn = True
Exit Function
ErrHand:
ShowMsg MsgText(9137)
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function
'新增繳費之下一程序
Public Function ClsPDSaveGiveMonryDatabase(ByRef cp() As String, ByRef field() As String, ByRef strCaseProperty As String)
Dim strTemp As String, strTemp1 As String, strTemp2 As String, dobDateAdd As Double
Dim varTemp As Variant, strStartDate As String, strDate As String, strDate1 As String
Dim i As Integer
Dim iRet As Integer

On Error GoTo ErrHand1:
strTemp = GetMoneyYears(field(72))
' If GetNationTax(Val(field(8)), field(9), strTemp, strTemp1, strCaseProperty, strTemp2) Then
'Modified by Morgan 2013/10/23
'iRet = ClsPDGetNationTaxEx(Val(field(8)), field(9), strTemp, strTemp1, strCaseProperty, strTemp2)
iRet = ClsPDGetNationTaxEx(Val(field(8)), field(9), strTemp, strTemp1, strCaseProperty, strTemp2, , , field(10), field(21), field(72))
' 取得正確的值
If iRet = 0 Then
   varTemp = Split(strTemp1, ",")
   ' 90.07.12 modify by louis
   If Val(strTemp) > UBound(varTemp) Then
      ClsPDSaveGiveMonryDatabase = True
      GoTo ErrHand
   End If
   dobDateAdd = varTemp(Val(strTemp))
   'EDIT BY nickc 2007/02/26
   'strStartDate = GetStartDate(strTemp, cp(), field(), False)
   strStartDate = GetStartDate(strTemp, cp(), field())
   ' 90.12.18 modify by louis (抓不到日期則離開)
   If strStartDate = "" Then
      ClsPDSaveGiveMonryDatabase = True
      Exit Function
   End If
   
   If strStartDate <> "" Then
      ' 91.09.28 modify by louis (加年用yyyy)
      'strStartDate = DateAdd("Y", dobDateAdd, ChangeWStringToWDateString(strStartDate))
      strStartDate = DateAdd("yyyy", dobDateAdd, ChangeWStringToWDateString(strStartDate))
      strStartDate = DateAdd("d", -1, strStartDate)
      strDate = ChangeWDateStringToWString(strStartDate)
   End If
   strDate1 = ChangeWDateStringToWString(DateAdd("M", -1, ChangeWStringToWDateString(strDate)))
   'edit by nickc 2007/02/02
   'Dim np(1 To T_NP) As String
   Dim np() As String
   ReDim np(1 To TF_NP) As String
   
   np(2) = cp(1)
   np(3) = cp(2)
   np(4) = cp(3)
   np(5) = cp(4)
   np(7) = strCaseProperty
   If ClsPDReadNextProgressData(np()) = False Then GoTo ErrHand
   If np(1) = "" Then
      If ClsPDSaveNewNextProgressDatabase(國外_CF, cp(), strDate1, strDate, strCaseProperty) = False Then GoTo ErrHand
   Else
      Dim strNextProgress(0) As String
      strNextProgress(0) = strTemp
      If ClsPDSetNextProgressDate(strNextProgress(), strDate1, strDate) = False Then GoTo ErrHand
   End If
   ClsPDSaveGiveMonryDatabase = True
ElseIf iRet > 0 Then
   ClsPDSaveGiveMonryDatabase = True
End If
ErrHand:
Exit Function
ErrHand1:
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function
'Modify By Cheng 2002/01/29
'多加一參數--使用者代號(strUserNum)
'新增資料至NextProgress檔
Public Function ClsPDSaveNewNextProgressDatabase( _
      ByRef intWhere As Integer, ByRef cp() As String, _
      ByVal strDate1 As String, ByVal StrDate2 As String, _
      ByRef strCaseProperty As String, _
      Optional strMemo As String, Optional strNumber As String, _
      Optional strPerson As String, Optional strUserNum As String) As Boolean
   Dim strSql As String, strCounter As String
   Dim adoRecord As New ADODB.Recordset
   Dim objPrtForm001 As New ClsPrtForm001
   
   On Error GoTo ErrHand:
   strDate1 = TransDate(strDate1, 2)
   StrDate2 = TransDate(StrDate2, 2)
   
   adoRecord.CursorLocation = adUseClient
   adoRecord.Open "select max(np22) from nextprogress", cnnConnection, adOpenDynamic, adLockBatchOptimistic
   If IsNull(adoRecord.Fields(0).Value) Then
      strCounter = "1"
   Else
      strCounter = Val(adoRecord.Fields(0).Value) + 1
   End If
   'Add By Cheng 2002/04/11
   '取得欲新增的下一程序檔的序號
   g_dbl_NPSerialNo = Val(strCounter)
   
   'Modify By Cheng 2002/01/29
   '若為CFP案且下一程序為催審, 提申或收達時, 智權人員代號(NP10)以操作員代號寫入
   '若為CFP案且下一程序為補文件, 智權人員代號(NP10)以操作員代號寫入
'   If intWhere = 國外_CF And (strCaseProperty = 催審 Or strCaseProperty = 提申 Or strCaseProperty = 收達) Then
   If intWhere = 國外_CF And (strCaseProperty = 催審 Or strCaseProperty = 提申 Or strCaseProperty = 收達 Or strCaseProperty = 補文件) Then
      'Modify By Cheng 2002/09/25
'      strSQL = "insert into nextprogress (np01,np02,np03,np04,np05,np07,np08,np09,np10,np13,np14,np15,np22) values (" + _
'         CNULL(cp(9)) + "," + CNULL(cp(1)) + "," + CNULL(cp(2)) + "," + CNULL(cp(3)) + _
'         "," + CNULL(cp(4)) + "," + CNULL(strCaseProperty) + "," & Val(strDate1) & "," & Val(strDate2) & _
'         "," + CNULL(strUserNum) + "," + CNULL(strNumber) + "," + CNULL(strPerson) + "," + CNULL(strMemo) + "," & Val(strCounter) & ")"
      strSql = "insert into nextprogress (np01,np02,np03,np04,np05,np07,np08,np09,np10,np13,np14,np15,np22) values (" + _
         CNULL(cp(9)) + "," + CNULL(cp(1)) + "," + CNULL(cp(2)) + "," + CNULL(cp(3)) + _
         "," + CNULL(cp(4)) + "," + CNULL(strCaseProperty) + "," & Val(strDate1) & "," & Val(StrDate2) & _
         "," + CNULL(strUserNum) + "," + CNULL(strNumber) + "," + CNULL(ChgSQL(strPerson)) + "," + CNULL(strMemo) + "," & Val(strCounter) & ")"
   '其他的維持原狀
   Else
      'Modify By Cheng 2002/09/25
'      strSQL = "insert into nextprogress (np01,np02,np03,np04,np05,np07,np08,np09,np10,np13,np14,np15,np22) values (" + _
'         CNULL(cp(9)) + "," + CNULL(cp(1)) + "," + CNULL(cp(2)) + "," + CNULL(cp(3)) + _
'         "," + CNULL(cp(4)) + "," + CNULL(strCaseProperty) + "," & Val(strDate1) & "," & Val(strDate2) & _
'         "," + CNULL(cp(13)) + "," + CNULL(strNumber) + "," + CNULL(strPerson) + "," + CNULL(strMemo) + "," & Val(strCounter) & ")"
      strSql = "insert into nextprogress (np01,np02,np03,np04,np05,np07,np08,np09,np10,np13,np14,np15,np22) values (" + _
         CNULL(cp(9)) + "," + CNULL(cp(1)) + "," + CNULL(cp(2)) + "," + CNULL(cp(3)) + _
         "," + CNULL(cp(4)) + "," + CNULL(strCaseProperty) + "," & Val(strDate1) & "," & Val(StrDate2) & _
         "," + CNULL(cp(13)) + "," + CNULL(strNumber) + "," + CNULL(ChgSQL(strPerson)) + "," + CNULL(strMemo) + "," & Val(strCounter) & ")"
   End If
   cnnConnection.Execute strSql
   ClsPDSaveNewNextProgressDatabase = True
   ' 90.12.18 modify by louis 列印接洽結案單
   objPrtForm001.PrintForm strCounter, cp(1), cp(2), cp(3), cp(4)
   Exit Function
ErrHand:
   ShowMsg MsgText(9138)
      'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function

'判斷此相關總收文號是否存在
Public Function ClsPDGetRelationalReceiveCode(ByRef strReceiveCode As String, ByRef strCode1 As String, ByRef strCode2 As String, ByRef strCode3 As String, ByRef strCode4 As String) As Boolean
Dim strSql As String, rsRecordset As New ADODB.Recordset

On Error GoTo ErrHand
strSql = "select cp09 from caseprogress where cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + " and cp09=" + CNULL(strReceiveCode)
rsRecordset.CursorLocation = adUseClient
rsRecordset.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If rsRecordset.RecordCount > 0 Then
   ClsPDGetRelationalReceiveCode = True
Else
   ShowMsg MsgText(9139)
End If
Exit Function
ErrHand:
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function
'Added by Morgan 2022/5/27 取得最新AB類收文號
Public Function PUB_GetLastABKindCP09(ByVal strCode1 As String, ByVal strCode2 As String, ByVal strCode3 As String, ByVal strCode4 As String) As String
   Dim strRecNo As String
   If ClsPDGetReceiveCode(strCode1, strCode2, strCode3, strCode4, strRecNo) = True Then
      PUB_GetLastABKindCP09 = strRecNo
   End If
End Function

'取得總收文號
Public Function ClsPDGetReceiveCode(ByRef strCode1 As String, ByRef strCode2 As String, ByRef strCode3 As String, ByRef strCode4 As String, ByRef strReceiveCode As String) As Boolean
Dim strSql As String, rsRecordset As New ADODB.Recordset

On Error GoTo ErrHand
   '2010/3/16 MODIFY BY SONIA 改抓最後收文的A,B類
   'strSql = "select cp09 from caseprogress where cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4)
   strSql = "select cp09 from caseprogress where cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + " AND CP09<'C' AND CP05||CP67 IN (" + _
            "SELECT MAX(CP05||CP67) FROM CASEPROGRESS WHERE CP01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + " AND CP09<'C')"
   rsRecordset.CursorLocation = adUseClient
   rsRecordset.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If rsRecordset.RecordCount > 0 Then
      strReceiveCode = rsRecordset.Fields(0)
      ClsPDGetReceiveCode = True
   Else
      ShowMsg MsgText(9139)
   End If
   Exit Function
ErrHand:
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function
'ServicePractice服務業務檔存檔
Public Function ClsPDSaveServicePracticeDatabase(ByRef sp() As String, ByRef intWhere As Integer) As Boolean
Dim strSql As String, i As Integer

On Error GoTo ErrHand
If intWhere = 國內 Then
   sp(10) = ChangeTStringToWString(sp(10))
   sp(12) = ChangeTStringToWString(sp(12))
   sp(16) = IIf(CheckIsDate(ChangeTStringToWString(sp(16)), False), sp(16), ChangeTStringToWString(sp(16)))
   sp(20) = ChangeTStringToWString(sp(20))
   sp(21) = ChangeTStringToWString(sp(21))
   sp(39) = ChangeTStringToWString(sp(39))
   sp(40) = ChangeTStringToWString(sp(40))
End If
sp(8) = ChangeCustomerL(sp(8))
sp(26) = ChangeCustomerL(sp(26))
sp(35) = ChangeCustomerL(sp(35))
sp(37) = ChangeCustomerL(sp(37))
sp(65) = ChangeCustomerL(sp(65))
sp(66) = ChangeCustomerL(sp(66))
sp(67) = ChangeCustomerL(sp(67))
strSql = "update servicepractice set "
For i = 1 To tf_SP - 1 'edit by nickc 2007/02/06 T_SP - 1 '注意："- 1"不可拿掉，否則欄位會多出來
    strSql = strSql + "sp" + Format(i, "00") + "=" + CNULL(Replace(sp(i), "'", "''")) + ","
Next
strSql = strSql + "sp" + Format(i, "00") + "=" + CNULL(sp(i)) + " where sp01=" + CNULL(sp(1)) + " and sp02=" + CNULL(sp(2)) + " and sp03=" + CNULL(sp(3)) + " and sp04=" + CNULL(sp(4))
cnnConnection.Execute strSql
ClsPDSaveServicePracticeDatabase = True
Exit Function
ErrHand:
ShowMsg MsgText(9140)
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function
'讀取ServicePractice服務業務檔
Public Function ClsPDReadServicePracticeDatabase(ByRef sp() As String, ByRef intWhere As Integer) As Boolean
Dim strSql As String, rsRecordset As New ADODB.Recordset, i As Integer

On Error GoTo ErrHand
strSql = "select * from servicepractice where sp01=" + CNULL(sp(1)) + " and sp02=" + CNULL(sp(2)) + " and sp03=" + CNULL(sp(3)) + " and sp04=" + CNULL(sp(4))
rsRecordset.CursorLocation = adUseClient
rsRecordset.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If rsRecordset.RecordCount > 0 Then
   For i = 0 To tf_SP - 1 'edit by nickc 2007/02/06 T_SP - 1
          sp(i + 1) = IIf(IsNull(rsRecordset.Fields(i)), "", rsRecordset.Fields(i))
   Next
   If intWhere <> 國外_CF Then
      sp(10) = ChangeWStringToTString(sp(10))
      sp(12) = ChangeWStringToTString(sp(12))
      sp(16) = ChangeWStringToTString(sp(16))
      sp(20) = ChangeWStringToTString(sp(20))
      sp(21) = ChangeWStringToTString(sp(21))
      sp(39) = ChangeWStringToTString(sp(39))
      sp(40) = ChangeWStringToTString(sp(40))
   End If
   sp(8) = ChangeCustomerS(sp(8))
   sp(26) = ChangeCustomerS(sp(26))
   sp(35) = ChangeCustomerS(sp(35))
   sp(37) = ChangeCustomerS(sp(37))
   ClsPDReadServicePracticeDatabase = True
Else
   ShowMsg MsgText(9141)
End If
rsRecordset.Close
Exit Function
ErrHand:
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function
'CaseProgress案件進度檔存檔
Public Function ClsPDSaveCaseProgressDatabase(ByRef cp() As String, ByRef intWhere As Integer) As Boolean
Dim strSql As String, i As Integer

On Error GoTo ErrHand
If intWhere <> 國外_CF Then
   cp(5) = ChangeTStringToWString(cp(5))
   cp(6) = ChangeTStringToWString(cp(6))
   cp(7) = ChangeTStringToWString(cp(7))
   cp(25) = ChangeTStringToWString(cp(25))
   cp(27) = ChangeTStringToWString(cp(27))
   cp(46) = ChangeTStringToWString(cp(46))
   cp(47) = ChangeTStringToWString(cp(47))
   cp(48) = ChangeTStringToWString(cp(48))
   cp(53) = ChangeTStringToWString(cp(53))
   cp(54) = ChangeTStringToWString(cp(54))
   cp(57) = ChangeTStringToWString(cp(57))
End If
cp(44) = ChangeCustomerL(cp(44))
cp(55) = ChangeCustomerL(cp(55))
cp(56) = ChangeCustomerL(cp(56))
strSql = "update caseprogress set "
For i = 1 To TF_CP 'edit by nickc 2007/02/06 T_CP
   Select Case i
      Case 65, 66, 67, 68, 69, 70
      Case Else
         ' 91.03.25 modify by louis (單引號)
         'strSQL = strSQL + "cp" + Format(i, "00") + "=" + CNULL(cp(i)) + ","
         strSql = strSql + "cp" + Format(i, "00") + "=" + CNULL(ChgSQL(cp(i))) + ","
   End Select
Next
strSql = Left(strSql, Len(strSql) - 1)
strSql = strSql & " where cp09=" + CNULL(cp(9))
cnnConnection.Execute strSql
ClsPDSaveCaseProgressDatabase = True
Exit Function
ErrHand:
ShowMsg MsgText(9142)
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function

'Patent專利檔存檔
'Optional bolDate As Boolean = True 依系統別轉日期 False 不依系統別，全轉為民國日期
'Optional BolWdb As Boolean = false 寫更新時間     nick 910910
Public Function ClsPDSavePatentDatabase(ByRef pa() As String, ByVal intWhere As Integer, Optional bolDate As Boolean = True, Optional BolWDB As Boolean = False) As Boolean
 Dim strSql As String, i As Integer, strTmp As String
'Add By Cheng 2002/11/14
Dim BolTransOk As Boolean
BolTransOk = True
   
   On Error GoTo ErrHand
   If intWhere <> 國外_CF Or bolDate = False Then
      pa(10) = ChangeTStringToWString(pa(10))
      pa(12) = ChangeTStringToWString(pa(12))
      pa(14) = ChangeTStringToWString(pa(14))
      pa(20) = ChangeTStringToWString(pa(20))
      pa(21) = ChangeTStringToWString(pa(21))
      pa(24) = ChangeTStringToWString(pa(24))
      pa(25) = ChangeTStringToWString(pa(25))
      pa(58) = ChangeTStringToWString(pa(58))
   End If
   pa(26) = ChangeCustomerL(pa(26))
   pa(27) = ChangeCustomerL(pa(27))
   pa(28) = ChangeCustomerL(pa(28))
   pa(29) = ChangeCustomerL(pa(29))
   pa(30) = ChangeCustomerL(pa(30))
   pa(75) = ChangeCustomerL(pa(75))
   pa(76) = ChangeCustomerL(pa(76))
   pa(86) = ChangeCustomerL(pa(86))
   pa(88) = ChangeCustomerL(pa(88))
   pa(101) = ChangeCustomerL(pa(101))
   pa(105) = ChangeCustomerL(pa(105))
   pa(133) = ChangeCustomerL(pa(133))
   pa(134) = ChangeCustomerL(pa(134))
   strSql = "update patent set "
   For i = 1 To 99
      Select Case i
         Case 92, 93, 94, 95, 96, 97
         Case Else
            strSql = strSql + "pa" + Format(i, "00") + "=" + CNULL(Replace(pa(i), "'", "''")) + ","
      End Select
   Next
   For i = 100 To TF_PA 'edit by nickc 2007/02/06 T_PA
'      If i = 103 Then
         If InStr(pa(i), "'") > 0 Then
            strTmp = Replace(pa(i), "'", "''")
            strSql = strSql + "pa" + Format(i) + "=" + CNULL(strTmp) + ","
         Else
            strSql = strSql + "pa" + Format(i) + "=" + CNULL(pa(i)) + ","
         End If
'      Else
         ' 91.03.25 modify by louis (單引號)
         'strSQL = strSQL + "pa" + Format(i) + "=" + CNULL(pa(i)) + ","
'         strSQL = strSQL + "pa" + Format(i) + "=" + CNULL(DBString(pa(i))) + ","
'      End If
   Next
   strSql = Left(strSql, Len(strSql) - 1)
   strSql = strSql & " where pa01=" + CNULL(pa(1)) + " and pa02=" + CNULL(pa(2)) + " and pa03=" + CNULL(pa(3)) + " and pa04=" + CNULL(pa(4))
   '910910 nick tigger
   '***** start
   If BolWDB = True Then
      strSql = "begin user_data.user_enabled:=1;  " & strSql & "; end; "
   End If
   cnnConnection.BeginTrans
   '***** end
   cnnConnection.Execute strSql
   '910910 nick tigger
   '***** start
    'Modify By Cheng 2002/11/14
    If BolTransOk Then
        cnnConnection.CommitTrans
    End If
   '***** end
   ClsPDSavePatentDatabase = True
   Exit Function
ErrHand:
    'Add By Cheng 2002/11/14
    If Err.Number = -2147168237 Then
       BolTransOk = False
       Resume Next
    End If
   
   '910910 nick tigger
   '***** start
   cnnConnection.RollbackTrans
   '***** end
   ShowMsg MsgText(9143)
      'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function
'新增或更新NextProgress下一程序檔
Public Function ClsPDSaveNextProgress(strSql As String, intOption As Integer, Optional strRowID As String) As Boolean
   Select Case intOption
      Case 1
         cnnConnection.Execute "insert into nextprogress values (" & strSql & ")"
         ClsPDSaveNextProgress = True
      Case 2
         cnnConnection.Execute "update nextprogress set " & strSql & " where rowid = '" & strRowID & "'"
         ClsPDSaveNextProgress = True
   End Select
End Function
'LawCase法務檔存檔
Public Function ClsPDSaveLawCaseDatabase(ByRef lC() As String) As Boolean
Dim strSql As String, i As Integer

On Error GoTo ErrHand
lC(9) = ChangeTStringToWString(lC(9))
lC(11) = ChangeCustomerL(lC(11))
strSql = "update lawcase set "
For i = 1 To TF_LC - 1 'edit by nickc 2007/02/06 T_LC - 1
       strSql = strSql + "lc" + Format(i, "00") + "=" + CNULL(Replace(lC(i), "'", "''")) + ","
Next
strSql = strSql + "lc" + Format(i, "00") + "=" + CNULL(lC(i)) + " where lc01=" + CNULL(lC(1)) + " and lc02=" + CNULL(lC(2)) + " and lc03=" + CNULL(lC(3)) + " and lc04=" + CNULL(lC(4))
cnnConnection.Execute strSql
ClsPDSaveLawCaseDatabase = True
Exit Function
ErrHand:
ShowMsg MsgText(9144)
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function
'HireCase顧問檔存檔
Public Function ClsPDSaveHireCaseDatabase(ByRef hc() As String) As Boolean
Dim strSql As String, i As Integer

On Error GoTo ErrHand
hc(10) = ChangeTStringToWString(hc(10))
hc(5) = ChangeCustomerL(hc(5))
strSql = "update hirecase set "
For i = 1 To TF_HC - 1 'edit by nickc 2007/02/06 T_HC - 1
       strSql = strSql + "hc" + Format(i, "00") + "=" + CNULL(Replace(hc(i), "'", "''")) + ","
Next
strSql = strSql + "hc" + Format(i, "00") + "=" + CNULL(hc(i)) + " where hc01=" + CNULL(hc(1)) + " and hc02=" + CNULL(hc(2)) + " and hc03=" + CNULL(hc(3)) + " and hc04=" + CNULL(hc(4))
cnnConnection.Execute strSql
ClsPDSaveHireCaseDatabase = True
Exit Function
ErrHand:
ShowMsg MsgText(9145)
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function
Public Function ClsPDSaveTrademarkDatabase(ByRef tm() As String) As Boolean
Dim strSql As String, i As Integer

On Error GoTo ErrHand
tm(11) = ChangeTStringToWString(tm(11))
tm(13) = ChangeTStringToWString(tm(13))
tm(14) = ChangeTStringToWString(tm(14))
tm(20) = ChangeTStringToWString(tm(20))
tm(21) = ChangeTStringToWString(tm(21))
tm(22) = ChangeTStringToWString(tm(22))
tm(30) = IIf(CheckIsDate(ChangeTStringToWString(tm(30)), False), tm(30), ChangeTStringToWString(tm(30)))
tm(23) = ChangeCustomerL(tm(23))
tm(44) = ChangeCustomerL(tm(44))
tm(54) = ChangeCustomerL(tm(54))
tm(56) = ChangeCustomerL(tm(56))
tm(69) = ChangeCustomerL(tm(69))
tm(70) = ChangeCustomerL(tm(70))
strSql = "update Trademark set "
'For i = 1 To T_TM - 1
For i = 1 To TF_TM 'edit by nickc 2007/02/06 T_TM
       strSql = strSql + "tm" + Format(i, "00") + "=" + CNULL(Replace(tm(i), "'", "''")) + ","
Next
strSql = strSql + "tm" + Format(i, "00") + "=" + CNULL(tm(i)) + " where tm01=" + CNULL(tm(1)) + " and tm02=" + CNULL(tm(2)) + " and tm03=" + CNULL(tm(3)) + " and tm04=" + CNULL(tm(4))
cnnConnection.Execute strSql
ClsPDSaveTrademarkDatabase = True
Exit Function
ErrHand:
ShowMsg MsgText(9146)
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function
'讀取Trademark檔
Public Function ClsPDReadTrademarkDatabase(ByRef tm() As String, ByRef intWhere As Integer) As Boolean
Dim strSql As String, rsRecordset As New ADODB.Recordset, i As Integer

On Error GoTo ErrHand
strSql = "select * from Trademark where tm01=" + CNULL(tm(1)) + " and tm02=" + CNULL(tm(2)) + " and tm03=" + CNULL(tm(3)) + " and tm04=" + CNULL(tm(4))
rsRecordset.CursorLocation = adUseClient
rsRecordset.Open strSql, cnnConnection, adOpenStatic
If rsRecordset.RecordCount > 0 Then
   For i = 0 To TF_TM - 1 'edit by nickc 2007/02/06  T_TM - 1
          tm(i + 1) = IIf(IsNull(rsRecordset.Fields(i)), "", rsRecordset.Fields(i))
   Next
   If intWhere <> 國外_CF Then
      tm(11) = ChangeWStringToTString(tm(11))
      tm(13) = ChangeWStringToTString(tm(13))
      tm(14) = ChangeWStringToTString(tm(14))
      tm(20) = ChangeWStringToTString(tm(20))
      tm(21) = ChangeWStringToTString(tm(21))
      tm(22) = ChangeWStringToTString(tm(22))
      tm(30) = ChangeWStringToTString(tm(30))
   End If
   tm(23) = ChangeCustomerS(tm(23))
   tm(44) = ChangeCustomerS(tm(44))
   tm(54) = ChangeCustomerS(tm(54))
   tm(56) = ChangeCustomerS(tm(56))
   ClsPDReadTrademarkDatabase = True
Else
   ShowMsg MsgText(9141)
End If
rsRecordset.Close
Exit Function
ErrHand:
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function

'讀取Patent專利檔
'Optional bolDate As Boolean = True 依系統別轉日期 False 不依系統別，全轉為民國日期
Public Function ClsPDReadPatentDatabase(ByRef pa() As String, ByVal intWhere As Integer, Optional bolDate As Boolean = True) As Boolean
Dim strSql As String, rsRecordset As New ADODB.Recordset, i As Integer

On Error GoTo ErrHand
strSql = "select * from patent where pa01=" + CNULL(pa(1)) + " and pa02=" + CNULL(pa(2)) + " and pa03=" + CNULL(pa(3)) + " and pa04=" + CNULL(pa(4))
rsRecordset.CursorLocation = adUseClient
rsRecordset.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If rsRecordset.RecordCount > 0 Then
   With rsRecordset
      For i = 0 To TF_PA - 1 'edit by nickc 2007/02/06 T_PA - 1
         If IsNull(.Fields(i).Value) Then
            pa(i + 1) = ""
         Else
            pa(i + 1) = .Fields(i).Value
         End If
      Next
   End With
   If intWhere <> 國外_CF Or bolDate = False Then
      pa(10) = ChangeWStringToTString(pa(10))
      pa(12) = ChangeWStringToTString(pa(12))
      pa(14) = ChangeWStringToTString(pa(14))
      pa(20) = ChangeWStringToTString(pa(20))
      pa(21) = ChangeWStringToTString(pa(21))
      pa(24) = ChangeWStringToTString(pa(24))
      pa(25) = ChangeWStringToTString(pa(25))
      pa(58) = ChangeWStringToTString(pa(58))
   End If
   pa(26) = ChangeCustomerS(pa(26))
   pa(27) = ChangeCustomerS(pa(27))
   pa(28) = ChangeCustomerS(pa(28))
   pa(29) = ChangeCustomerS(pa(29))
   pa(30) = ChangeCustomerS(pa(30))
   pa(75) = ChangeCustomerS(pa(75))
   pa(76) = ChangeCustomerS(pa(76))
   pa(86) = ChangeCustomerS(pa(86))
   pa(88) = ChangeCustomerS(pa(88))
   ClsPDReadPatentDatabase = True
Else
   ShowMsg MsgText(9141)
End If
rsRecordset.Close
Exit Function
ErrHand:
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function
'讀取LawCase專利檔
Public Function ClsPDReadLawCaseDatabase(ByRef lC() As String) As Boolean
Dim strSql As String, rsRecordset As New ADODB.Recordset, i As Integer

On Error GoTo ErrHand
strSql = "select * from lawcase where lc01=" + CNULL(lC(1)) + " and lc02=" + CNULL(lC(2)) + " and lc03=" + CNULL(lC(3)) + " and lc04=" + CNULL(lC(4))
rsRecordset.CursorLocation = adUseClient
rsRecordset.Open strSql, cnnConnection, adOpenStatic
If rsRecordset.RecordCount > 0 Then
   For i = 0 To TF_LC - 1 'edit by nickc 2007/02/06 T_LC - 1
          lC(i + 1) = IIf(IsNull(rsRecordset.Fields(i)), "", rsRecordset.Fields(i))
   Next
   lC(9) = ChangeWStringToTString(lC(9))
   lC(11) = ChangeCustomerS(lC(11))
   lC(22) = ChangeCustomerS(lC(22))   'add by sonia 2019/11/19
   ClsPDReadLawCaseDatabase = True
Else
   ShowMsg MsgText(9141)
End If
rsRecordset.Close
Exit Function
ErrHand:
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function
'讀取hirecase專利檔
Public Function ClsPDReadHireCaseDatabase(ByRef hc() As String) As Boolean
Dim strSql As String, rsRecordset As New ADODB.Recordset, i As Integer

On Error GoTo ErrHand
strSql = "select * from hirecase where hc01=" + CNULL(hc(1)) + " and hc02=" + CNULL(hc(2)) + " and hc03=" + CNULL(hc(3)) + " and hc04=" + CNULL(hc(4))
rsRecordset.CursorLocation = adUseClient
rsRecordset.Open strSql, cnnConnection, adOpenStatic
If rsRecordset.RecordCount > 0 Then
   For i = 0 To TF_HC - 1 'edit by nickc 2007/02/06 T_HC - 1
          hc(i + 1) = IIf(IsNull(rsRecordset.Fields(i)), "", rsRecordset.Fields(i))
   Next
   hc(10) = ChangeWStringToTString(hc(10))
   hc(5) = ChangeCustomerS(hc(5))
   ClsPDReadHireCaseDatabase = True
Else
   ShowMsg MsgText(9141)
End If
rsRecordset.Close
Exit Function
ErrHand:
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function
'讀取CaseProgress案件進度檔
Public Function ClsPDReadCaseProgressDatabase(ByRef cp() As String, intWhere As Integer) As Boolean
Dim strSql As String, rsRecordset As New ADODB.Recordset, i As Integer

On Error GoTo ErrHand
strSql = "select * from caseprogress where cp09=" + CNULL(cp(9))
rsRecordset.CursorLocation = adUseClient
rsRecordset.Open strSql, cnnConnection, adOpenStatic
If rsRecordset.RecordCount > 0 Then
   For i = 0 To TF_CP - 1 'edit by nickc 2007/02/06 T_CP - 1
          cp(i + 1) = IIf(IsNull(rsRecordset.Fields(i)), "", rsRecordset.Fields(i))
   Next
   If intWhere <> 國外_CF Then
      cp(5) = ChangeWStringToTString(cp(5))
      cp(6) = ChangeWStringToTString(cp(6))
      cp(7) = ChangeWStringToTString(cp(7))
      cp(25) = ChangeWStringToTString(cp(25))
      cp(27) = ChangeWStringToTString(cp(27))
      cp(46) = ChangeWStringToTString(cp(46))
      cp(47) = ChangeWStringToTString(cp(47))
      cp(48) = ChangeWStringToTString(cp(48))
      cp(53) = ChangeWStringToTString(cp(53))
      cp(54) = ChangeWStringToTString(cp(54))
      cp(57) = ChangeWStringToTString(cp(57))
   End If
   cp(44) = ChangeCustomerS(cp(44))
   cp(55) = ChangeCustomerS(cp(55))
   cp(56) = ChangeCustomerS(cp(56))
   ClsPDReadCaseProgressDatabase = True
Else
   ShowMsg MsgText(9147)
End If
rsRecordset.Close
Exit Function
ErrHand:
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function
'讀取本案期限之Recordset,bolContinueBlank =False本案期限 續辦不為Y     =True未收文期限 續辦為空白
Public Function ClsPDReadCaseDeadLineRst(ByRef strCode1 As String, ByRef strCode2 As String, ByRef strCode3 As String, ByRef strCode4 As String, ByRef bolContinueBlank As Boolean) As ADODB.Recordset
Dim intCaseKind As Integer, strSql As String, intWhere As Integer, strDateLine As String

If ClsPDGetSystemKind(strCode1, intCaseKind, , intWhere) Then
   Select Case intCaseKind
      Case 專利
         'Modified by Lydia 2018/06/05 修改顯示案件性質
         'strSql = "select '' ˇ,decode(pa09," + CNULL(大陸國家代號) + ",cpm04,cpm03) 下一程序,"
         strSql = "select '' ˇ,decode(pa09,'000',CPM03,CPM04) 下一程序,"
      Case 商標
         'Modified by Lydia 2018/06/05 修改顯示案件性質
         'strSql = "select '' ˇ,decode(tm10," + CNULL(大陸國家代號) + ",cpm04,cpm03) 下一程序,"
         strSql = "select '' ˇ,decode(tm10,'000',CPM03,CPM04) 下一程序,"
      Case Else
         'Modified by Lydia 2018/06/05 修改顯示案件性質
         'strSql = "select '' ˇ,decode(sp09," + CNULL(大陸國家代號) + ",cpm04,cpm03) 下一程序,"
         strSql = "select '' ˇ,decode(sp09,'000',CPM03,CPM04) 下一程序,"
   End Select
'   If intWhere <> 國外_CF Then strDateLine = "-1911"
   strSql = strSql + SQLDate("np08") & " 本所期限," & SQLDate("np09") & " 法定期限,np13 機關文號,np14 相關人," & SQLDate("np11") & " 解除期限日期, np01 總收文號, dbms_rowid.rowid_to_restricted(nextprogress.rowid,0), NP15 備註, NP22 序號 "
   Select Case intCaseKind
      Case 專利
         strSql = strSql + "from nextprogress,patent,casepropertymap where pa01=np02 and pa02=np03 and pa03=np04 and pa04=np05"
      Case 商標
         strSql = strSql + "from nextprogress,trademark,casepropertymap where tm01=np02 and tm02=np03 and tm03=np04 and tm04=np05"
      Case Else
         strSql = strSql + "from nextprogress,servicepractice,casepropertymap where sp01=np02 and sp02=np03 and sp03=np04 and sp04=np05"
   End Select
   strSql = strSql + " and np02=cpm01 and np07=cpm02 and "
   If bolContinueBlank = False Then
      strSql = strSql + "(np06<>'Y' or np06 is null)"
   Else
      strSql = strSql + "np06 is null"
   End If
   strSql = strSql + " and np02=" + CNULL(strCode1) + " and np03=" + CNULL(strCode2) + " and np04=" + CNULL(strCode3) + " and np05=" + CNULL(strCode4)
   Set ClsPDReadCaseDeadLineRst = ClsPDReadRst(strSql)
End If
End Function

'Remove by Morgan 2007/10/16
'讀取案件(國家)收費表
'Public Function ClsPDReadCaseFee(strField As String, strSysKind, strCountry, strCaseKind As String, ByRef adoRecord As ADODB.Recordset) As Boolean
'Dim strSQL As String
'   strSQL = "select " & strField & " from casefee where cf01 = '" & strSysKind & "' and cf02 = '" & strCountry & "' and cf03 = '" & strCaseKind & "'"
'   Set adoRecord = ClsPDReadRst(strSQL)
'   If adoRecord.RecordCount <> 0 Then
'      ClsPDReadCaseFee = True
'   Else
'      ClsPDReadCaseFee = False
'   End If
'End Function

'讀取分案資料－進度資料,intCaseKind系統分類
Public Function ClsPDReadSeparateCaseProgressRst(ByRef intCaseKind As Integer, ByRef intWhere As Integer, ByRef strCode1 As String, ByRef strCode2 As String, ByRef strCode3 As String, ByRef strCode4 As String) As ADODB.Recordset
Dim strSql As String, rsRecordset As New ADODB.Recordset
Dim strDateLine As String

'If intWhere <> 國外_CF Then strDateLine = "-1911"
strSql = "select cp09 收文號," & SQLDate("cp05") & " 收文日,decode("
Select Case intCaseKind
   Case 專利
      strSql = strSql + "pa09"
   Case 商標
      strSql = strSql + "tm10"
   Case Else
      strSql = strSql + "sp09"
End Select
'Modified by Lydia 2018/06/05 修改顯示案件性質
'strSql = strSql + "," + CNULL(大陸國家代號) + ",cpm04,cpm03) 案件性質," & SQLDate("cp27") & " 發文日,cp24 結果,cp19 後金,nvl(cp40,nvl(cp50,cp55)) 相關人 "
strSql = strSql + ",'000',CPM03,CPM04) 案件性質," & SQLDate("cp27") & " 發文日,cp24 結果,cp19 後金,nvl(cp40,nvl(cp50,cp55)) 相關人 "
Select Case intCaseKind
   Case 專利
      strSql = strSql + "from caseprogress,patent,casepropertymap where cp01=pa01 and cp02=pa02 and cp03=pa03 and cp04=pa04"
   Case 商標
      strSql = strSql + "from caseprogress,trademark,casepropertymap where cp01=tm01 and cp02=tm02 and cp03=tm03 and cp04=tm04"
   Case Else
      strSql = strSql + "from caseprogress,servicepractice,casepropertymap where cp01=sp01 and cp02=sp02 and cp03=sp03 and cp04=sp04"
End Select
strSql = strSql + " and cp01=cpm01 and cp10=cpm02 and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4)
Set ClsPDReadSeparateCaseProgressRst = ClsPDReadRst(strSql)
End Function

''讀取分案資料,intCaseKind系統分類
'Public Function ClsPDReadSeparateCaseRst(ByRef intCaseKind As Integer, ByRef intWhere As Integer, ByRef strGroup As String, ByRef intKind1 As Integer, ByRef intKind2 As Integer, ByRef intKind3 As Integer, Optional strSeparate1 As String, Optional strSeparate2 As String, Optional strSeparate3 As String, Optional strSeparate4 As String, Optional intNone As Integer) As ADODB.Recordset
'Dim strSql As String, strSQL1 As String, rsRecordset As New ADODB.Recordset
'Dim strDateLine As String
'
''If intWhere <> 國外_CF Then strDateLine = "-1911"
'strSql = "select " & SQLDate("cp05") & " s01,cp09 s02,"
''Modify By Cheng 2002/07/16
''加是否算案件數欄
''strSQL1 = "select substr(cp05,1,4)" + strDateLine + "||'/'||substr(cp05,5,2)||'/'||substr(cp05,7,2) s01,cp09 s02,nvl(sp05,nvl(sp06,sp07)) s03,decode(sp09," + CNULL(大陸國家代號) + ",cpm04,cpm03) s04,sp01 s05,sp02 s06,sp02 s07,replace(sp03,'0') s08,replace(sp04,'00') s09,staff.st02 s10,staff1.st02 s11, substr(cp06,1,4)" + strDateLine + "||'/'||substr(cp06,5,2)||'/'||substr(cp06,7,2) s12, sp15 s13, substr(cp57,1,4)" + strDateLine + "||'/'||substr(cp57,5,2)||'/'||substr(cp57,7,2) s14, cp27 s15 from caseprogress,servicepractice,casepropertymap,staff,staff staff1 where CP01 in ('CPS', '') AND cp01=sp01(+) and cp02=sp02(+) and cp03=sp03(+) and cp04=sp04(+) and cp01=cpm01(+) and cp10=cpm02(+) and cp13=staff.st01(+) and cp14=staff1.st01(+)"
'strSQL1 = "select " & SQLDate("cp05") & " s01,cp09 s02,nvl(sp05,nvl(sp06,sp07)) s03," & _
'   "decode(sp09," + CNULL(大陸國家代號) + ",cpm04,cpm03) s04,sp01 s05,sp02 s06,sp02 s07,replace(sp03,'0') s08," & _
'   "replace(sp04,'00') s09,staff.st02 s10,staff1.st02 s11, " & SQLDate("cp06") & " s12, sp15 s13, " & SQLDate("cp57") & _
'   " s14," & SQLDate("cp27") & " s15,CP26 AS S16 from caseprogress,servicepractice,casepropertymap,staff,staff staff1 where CP01 in ('CPS', '') AND cp01=sp01(+) and cp02=sp02(+) and cp03=sp03(+) and cp04=sp04(+) and cp01=cpm01(+) and cp10=cpm02(+) and cp13=staff.st01(+) and cp14=staff1.st01(+)"
'Select Case intCaseKind
'   Case 專利
'      'Modify By Cheng 2002/07/16
'      '加是否算案件數欄
''      strSQL = strSQL + "nvl(pa05,nvl(pa06,pa07)) s03,decode(pa09," + CNULL(大陸國家代號) + ",cpm04,cpm03) s04,pa01 s05,pa02 s06,pa02 s07,replace(pa03,'0') s08,replace(pa04,'00') s09,staff.st02 s10,staff1.st02 s11, substr(cp06,1,4)" + strDateLine + "||'/'||substr(cp06,5,2)||'/'||substr(cp06,7,2) s12, pa57 s13, substr(cp57,1,4)" + strDateLine + "||'/'||substr(cp57,5,2)||'/'||substr(cp57,7,2) s14, cp27 s15 from caseprogress,patent,casepropertymap,staff,staff staff1 where cp01 in ('CFP', '') AND CP01=PA01(+) and cp02=pa02(+) and cp03=pa03(+) and cp04=pa04(+)"
'        'Modify By Cheng 2003/10/03
'        '若CP04<>"00", 收文號為"B"類且已有發文日的資料不顯示
'        'Begin
''      strSQL = strSQL + "nvl(pa05,nvl(pa06,pa07)) s03,decode(pa09," + CNULL(大陸國家代號) + ",cpm04,cpm03) s04,pa01 s05," & _
''         "pa02 s06,pa02 s07,replace(pa03,'0') s08,replace(pa04,'00') s09,staff.st02 s10,staff1.st02 s11," & _
''         SQLDate("cp06") & " s12, pa57 s13," & SQLDate("cp57") & "s14," & SQLDate("cp27") & " s15,cp26 as S16 from " & _
''         "caseprogress,patent,casepropertymap,staff,staff staff1 where cp01 in ('CFP', '') AND CP01=PA01(+) and cp02=pa02(+) and cp03=pa03(+) and cp04=pa04(+)"
'      strSql = strSql + "nvl(pa05,nvl(pa06,pa07)) s03,decode(pa09," + CNULL(大陸國家代號) + ",cpm04,cpm03) s04,pa01 s05," & _
'         "pa02 s06,pa02 s07,replace(pa03,'0') s08,replace(pa04,'00') s09,staff.st02 s10,staff1.st02 s11," & _
'         SQLDate("cp06") & " s12, pa57 s13," & SQLDate("cp57") & "s14," & SQLDate("cp27") & " s15,cp26 as S16 from " & _
'         "caseprogress,patent,casepropertymap,staff,staff staff1 where cp01 in ('CFP', '') AND CP01=PA01(+) and cp02=pa02(+) and cp03=pa03(+) and cp04=pa04(+) And ( CP04='00' Or ( ( CP04<>'00' And ( CP09<'B' Or CP09>'C' ) ) Or ( CP04<>'00' And ( CP09>'B' And CP09<'C' ) And CP27 Is Null ) ) ) "
'        'End
'   Case 商標
'      strSql = strSql + "nvl(tm05,nvl(tm06,tm07)) s03,decode(tm10," + CNULL(大陸國家代號) + ",cpm04,cpm03) s04,tm01 s05," & _
'         "decode(tm01," + CNULL(馬德里案) + ",substr(tm02,1,5),tm02) s06,decode(tm01," + CNULL(馬德里案) + _
'         ",replace(substr(tm02,6,1),'0'),tm02) s07,replace(tm03,'0') s08,replace(tm04,'00') s09,staff.st02 s10," & _
'         "staff1.st02 s11," & SQLDate("cp06") & " s12, tm29 s13, " & SQLDate("cp57") & " s14 from caseprogress,trademark,casepropertymap,staff,staff staff1,staff_group where cp01=tm01 and cp02=tm02 and cp03=tm03 and cp04=tm04"
'End Select
'strSql = strSql + " and cp01=cpm01(+) and cp10=cpm02(+) and cp13=staff.st01(+) and cp14=staff1.st01(+)"
'
'If strSeparate1 = "" Then strSeparate1 = "0"
'If strSeparate2 = "" Then strSeparate2 = "0"
'Select Case intKind1
'   Case 0
'      If intWhere = 國內 Then
'         strSql = strSql + " and cp05 between " + ChangeTStringToWString(strSeparate1) + " and " + ChangeTStringToWString(strSeparate2)
'         strSQL1 = strSQL1 + " and cp05 between " + ChangeTStringToWString(strSeparate1) + " and " + ChangeTStringToWString(strSeparate2)
'      Else
'         strSql = strSql + " and cp05 between " + strSeparate1 + " and " + strSeparate2
'         strSQL1 = strSQL1 + " and cp05 between " + strSeparate1 + " and " + strSeparate2
'      End If
'   Case 1
'      strSql = strSql + " and cp01=" + CNULL(strSeparate1) + " and cp02=" + CNULL(strSeparate2) + " and cp03=" + CNULL(strSeparate3) + " and cp04=" + CNULL(strSeparate4)
'      strSQL1 = strSQL1 + " and cp01=" + CNULL(strSeparate1) + " and cp02=" + CNULL(strSeparate2) + " and cp03=" + CNULL(strSeparate3) + " and cp04=" + CNULL(strSeparate4)
'End Select
'strSql = strSql + " and substr(cp09,1,1)"
'strSQL1 = strSQL1 + " and substr(cp09,1,1)"
'If intKind2 = 0 Then
'   strSql = strSql + " in(" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")"
'   strSQL1 = strSQL1 + " in(" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")"
'Else
'   strSql = strSql + "=" + CNULL(主管機關來函)
'   strSQL1 = strSQL1 + "=" + CNULL(主管機關來函)
'End If
'If intNone = 1 Then
'   strSql = strSql & " and cp14 is null"
'   strSQL1 = strSQL1 & " and cp14 is null"
'End If
''Modify By Cheng 2002/07/16
''strSQL = "select '' ˇ,s01 收文日期,s02 總收文號,s03 案件名稱,s04 案件性質,s05 本所案號,s06 本所案號,s07 本所案號,s08 本所案號,s09 本所案號,s10 智權人員,s11 承辦人, s12 本所期限, s13 是否閉卷, s14 取消收文日, s15 發文日 from (" + strSQL + " union " + strSQL1 + ") order by s02"
'strSql = "select '' ˇ,s01 收文日期,s02 總收文號,s03 案件名稱,s04 案件性質,s05 本所案號,s06 本所案號,s07 本所案號,s08 本所案號,s09 本所案號,s10 智權人員,s11 承辦人, s12 本所期限,s16 as 是否算案件數 , s13 是否閉卷, s14 取消收文日, s15 發文日 from (" + strSql + " union " + strSQL1 + ") order by s02"
''Clipboard.Clear
''Clipboard.SetText strSQL
'
'Set ClsPDReadSeparateCaseRst = ClsPDReadRst(strSql)
'End Function

'從Server取回Recordset，且rsRecordset.CursorLocation須為adUseServer
'以bolOpenMode判斷 True用adUseClient False用adUseServer
Public Function ClsPDReadRst(ByRef strSql As String, Optional bolOpenMode As Boolean = True) As ADODB.Recordset
Dim rsRecordset As New ADODB.Recordset

On Error GoTo ErrHand
If bolOpenMode Then
   rsRecordset.CursorLocation = adUseClient
Else
   rsRecordset.CursorLocation = adUseServer
End If
rsRecordset.Open strSql, cnnConnection, adOpenDynamic
Set ClsPDReadRst = rsRecordset
Exit Function
ErrHand:
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function
'讀取案件代理人已收達已提申,intCaseKind系統分類
Public Function ClsPDReadAgentReceivedRst(ByRef intCaseKind As Integer, ByRef strGroup As String, ByRef strCode1 As String, ByRef strCode2 As String, ByRef strCode3 As String, ByRef strCode4 As String) As ADODB.Recordset
Dim strSql As String, rsRecordset As New ADODB.Recordset
On Error GoTo ErrHand
' 91.09.13 modify by louis
'Select Case intCaseKind
'   Case 專利
'      strSQL = "select cp09 收文號," & SQLDate("cp05") & " 收文日,cpm03 案件性質," & SQLDate("cp27") & " 發文日,staff.st02 代理人" + _
'          " from caseprogress,casepropertymap,staff,staff_group where cp01=cpm01 and cp10=cpm02 and cp44=staff.st01(+) and sg01=" + CNULL(strGroup) + _
'          " and sg02=cp01 and sg03=cp10" + _
'          " and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + _
'          " and substr(cp09,1,1) in (" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")" + _
'          " and cp27 is not null and cp46 is null and cp47 is null and cp24 is null and cp61 is null"
'   Case Else
'      strSQL = "select cp09 收文號," & SQLDate("cp05") & " 收文日,cpm03 案件性質," & SQLDate("cp27") & " 發文日," & _
'         SQLDate("cp46") & " 代理人收達日," & SQLDate("cp47") & " 解除期限日,staff.st02 代理人" + _
'         " from caseprogress,casepropertymap,staff,staff_group where cp01=cpm01 and cp10=cpm02 and cp44=staff.st01(+) and sg01=" + CNULL(strGroup) + _
'         " and sg02=cp01 and sg03=cp10" + _
'         " and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + _
'         " and substr(cp09,1,1) in (" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")" + _
'         " and cp27 is not null and cp46 is null and cp47 is null and cp24 is null and cp61 is null"
'End Select
Select Case intCaseKind
   Case 專利
      '91.12.8 MODIFY BY SONIA 不檢查帳單編號
      'strSQL = "select cp09 收文號," & SQLDate("cp05") & " 收文日,cpm03 案件性質," & SQLDate("cp27") & " 發文日,staff.st02 代理人" + _
      '         ",DECODE(CP27,19221111,99999999,CP27) AS SORTFIELD " + _
      '    " from caseprogress,casepropertymap,staff,staff_group where cp01=cpm01 and cp10=cpm02 and cp44=staff.st01(+) and sg01=" + CNULL(strGroup) + _
      '    " and sg02=cp01 and sg03=cp10" + _
      '    " and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + _
      '    " and substr(cp09,1,1) in (" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")" + _
      '    " and cp27 is not null and cp46 is null and cp47 is null and cp24 is null and cp61 is null " + _
      '    " ORDER BY SORTFIELD DESC "
      strSql = "select cp09 收文號," & SQLDate("cp05") & " 收文日,cpm03 案件性質," & SQLDate("cp27") & " 發文日,staff.st02 代理人" + _
               ",DECODE(CP27,19221111,99999999,CP27) AS SORTFIELD " + _
          " from caseprogress,casepropertymap,staff,staff_group where cp01=cpm01 and cp10=cpm02 and cp44=staff.st01(+) and sg01=" + CNULL(strGroup) + _
          " and sg02=cp01 and sg03=cp10" + _
          " and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + _
          " and substr(cp09,1,1) in (" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")" + _
          " and cp27 is not null and cp46 is null and cp47 is null and cp24 is null " + _
          " ORDER BY SORTFIELD DESC "
      '91.12.8 END
   Case Else
      strSql = "select cp09 收文號," & SQLDate("cp05") & " 收文日,cpm03 案件性質," & SQLDate("cp27") & " 發文日," & _
         SQLDate("cp46") & " 代理人收達日," & SQLDate("cp47") & " 解除期限日,staff.st02 代理人" + _
         ",DECODE(CP27,19221111,99999999,CP27) AS SORTFIELD " + _
         " from caseprogress,casepropertymap,staff,staff_group where cp01=cpm01 and cp10=cpm02 and cp44=staff.st01(+) and sg01=" + CNULL(strGroup) + _
         " and sg02=cp01 and sg03=cp10" + _
         " and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + _
         " and substr(cp09,1,1) in (" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")" + _
         " and cp27 is not null and cp46 is null and cp47 is null and cp24 is null and cp61 is null " + _
         " ORDER BY SORTFIELD DESC "
End Select

Set ClsPDReadAgentReceivedRst = ClsPDReadRst(strSql)
Exit Function
ErrHand:
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function
'讀取其他來函輸入,intCaseKind系統分類
Public Function ClsPDReadOtherInputFromCodeRst(ByRef intCaseKind As Integer, ByRef strGroup As String, ByRef strCode1 As String, ByRef strCode2 As String, ByRef strCode3 As String, ByRef strCode4 As String) As ADODB.Recordset
Dim strSql As String, rsRecordset As New ADODB.Recordset

On Error GoTo ErrHand
' 91.09.13 modify by louis
'Select Case intCaseKind
'   Case 專利
'      strSQL = "select cp09 收文號," & SQLDate("cp05") & " 收文日,cpm03 案件性質," & SQLDate("cp06") & " 本所期限," & SQLDate("cp07") & " 法定期限," & SQLDate("cp27") & " 發文日," & SQLDate("cp57") & " 取消收文日期,cp24 結果,cp19 後金,cp64 進度備註,nvl(cp40,nvl(cp50,cp55)) 相關人" + _
'          " from caseprogress,casepropertymap,staff_group where cp01=cpm01 and cp10=cpm02 and sg01=" + CNULL(strGroup) + _
'          " and sg02=cp01 and sg03=cp10" + _
'          " and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + _
'          " and substr(cp09,1,1) in (" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")" + _
'          " and cp27 is not null order by cp27 desc"
'   Case Else
'      strSQL = "select cp09 收文號," & SQLDate("cp05") & " 收文日,cpm03 案件性質," & SQLDate("cp27") & " 發文日,cp24 結果,nvl(cp40,nvl(cp50,cp55)) 相關人" + _
'         " from caseprogress,casepropertymap,staff_group where cp01=cpm01 and cp10=cpm02 and sg01=" + CNULL(strGroup) + _
'         " and sg02=cp01 and sg03=cp10" + _
'         " and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + _
'         " and substr(cp09,1,1) in (" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")" + _
'         " and cp27 is not null order by cp27 desc"
'End Select
Select Case intCaseKind
   Case 專利
      strSql = "select cp09 收文號," & SQLDate("cp05") & " 收文日,cpm03 案件性質," & SQLDate("cp06") & " 本所期限," & SQLDate("cp07") & " 法定期限," & SQLDate("cp27") & " 發文日," & SQLDate("cp57") & " 取消收文日期,cp24 結果,cp19 後金,cp64 進度備註,nvl(cp40,nvl(cp50,cp55)) 相關人" + _
               ",DECODE(CP27,19221111,99999999,CP27) AS SORTFIELD " + _
          " from caseprogress,casepropertymap,staff_group where cp01=cpm01 and cp10=cpm02 and sg01=" + CNULL(strGroup) + _
          " and sg02=cp01 and sg03=cp10" + _
          " and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + _
          " and substr(cp09,1,1) in (" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")" + _
          " and cp27 is not null order by SORTFIELD desc"
   Case Else
      strSql = "select cp09 收文號," & SQLDate("cp05") & " 收文日,cpm03 案件性質," & SQLDate("cp27") & " 發文日,cp24 結果,nvl(cp40,nvl(cp50,cp55)) 相關人" + _
               ",DECODE(CP27,19221111,99999999,CP27) AS SORTFIELD " + _
         " from caseprogress,casepropertymap,staff_group where cp01=cpm01 and cp10=cpm02 and sg01=" + CNULL(strGroup) + _
         " and sg02=cp01 and sg03=cp10" + _
         " and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + _
         " and substr(cp09,1,1) in (" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")" + _
         " and cp27 is not null order by SORTFIELD desc"
End Select

Set ClsPDReadOtherInputFromCodeRst = ClsPDReadRst(strSql)
Exit Function
ErrHand:
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function
'讀取其他來函之審定號數 申請案號 本所發文號之Recordset,intCaseKind系統分類
Public Function ClsPDReadOtherInputFromNumberRst(ByRef intOpt As Integer, ByRef intCaseKind As Integer, ByRef strGroup As String, ByRef strNumber As String) As ADODB.Recordset
Dim strSql As String, rsRecordset As New ADODB.Recordset

On Error GoTo ErrHand
Select Case intCaseKind
   Case 專利
       
   Case 商標
      strSql = "select tm01 本所案號,decode(tm01," + CNULL(馬德里案) + ",substr(tm02,1,5),tm02) 本所案號,decode(tm01," + CNULL(馬德里案) + ",replace(substr(tm02,6,1),'0'),tm02) 本所案號,replace(tm03,'0') 本所案號,replace(tm04,'00') 本所案號,nvl(tm05,nvl(tm06,tm07)) 案件名稱,decode(tm10," + CNULL(大陸國家代號) + ",ptm04,ptm03) 商品種類,tm09 商品類別,st02 申請人,na03 申請國家" + _
         " from trademark,caseprogress,patenttrademarkmap,nation,staff,staff_group where " + _
         " cp01=tm01 and cp02=tm02 and cp03=tm03 and cp04=tm04" + _
         " and ptm01=" + CNULL(Format(intCaseKind)) + " and ptm02=tm08 and sg01=" + CNULL(strGroup) + _
         " and sg02=tm01 and sg03=cp10 and tm10=na01 and tm23=st01(+)"
      Select Case intOpt
         Case 0
            strSql = strSql + " and tm12=" + CNULL(strNumber)
         Case 1
            strSql = strSql + " and tm15=" + CNULL(strNumber)
         Case 3
            strSql = strSql + " and cp28=" + CNULL(strNumber)
      End Select
End Select
Set ClsPDReadOtherInputFromNumberRst = ClsPDReadRst(strSql)
Exit Function
ErrHand:
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function
'讀取案件代理人通知修正,intCaseKind系統分類
Public Function ClsPDReadAgentNotifyRst(ByRef intCaseKind As Integer, ByRef strGroup As String, ByRef strCode1 As String, ByRef strCode2 As String, ByRef strCode3 As String, ByRef strCode4 As String) As ADODB.Recordset
Dim strSql As String, rsRecordset As New ADODB.Recordset
On Error GoTo ErrHand
' 91.09.13 modify by louis
'Select Case intCaseKind
'   Case 專利
'      strSQL = "select cp09 收文號," & SQLDate("cp05") & " 收文日,cpm03 案件性質," & SQLDate("cp06") & " 本所期限," & _
'         SQLDate("cp07") & " 法定期限," & SQLDate("cp27") & " 發文日," & SQLDate("cp57") & " 取消收文日,cp64 進度備註" + _
'         " from caseprogress,casepropertymap,staff_group where cp01=cpm01 and cp10=cpm02 and sg01=" + CNULL(strGroup) + _
'         " and sg02=cp01 and sg03=cp10" + _
'         " and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + _
'         " and substr(cp09,1,1) in (" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")" + _
'         " and cp27 is not null and cp24 is null"
'   Case Else
'      strSQL = "select cp09 收文號," & SQLDate("cp05") & " 收文日,cpm03 案件性質," & SQLDate("cp27") & " 發文日," & _
'         SQLDate("cp64") & " 代理人收達日,cp24 結果" + _
'         " from caseprogress,casepropertymap,staff_group where cp01=cpm01 and cp10=cpm02 and sg01=" + CNULL(strGroup) + _
'         " and sg02=cp01 and sg03=cp10" + _
'         " and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + _
'         " and substr(cp09,1,1) in (" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")" + _
'         " and cp27 is not null and cp24 is null"
'End Select
Select Case intCaseKind
   Case 專利
      strSql = "select cp09 收文號," & SQLDate("cp05") & " 收文日,cpm03 案件性質," & SQLDate("cp06") & " 本所期限," & _
         SQLDate("cp07") & " 法定期限," & SQLDate("cp27") & " 發文日," & SQLDate("cp57") & " 取消收文日,cp64 進度備註" + _
         ",DECODE(CP27,19221111,99999999,CP27) AS SORTFIELD " + _
         " from caseprogress,casepropertymap,staff_group where cp01=cpm01 and cp10=cpm02 and sg01=" + CNULL(strGroup) + _
         " and sg02=cp01 and sg03=cp10" + _
         " and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + _
         " and substr(cp09,1,1) in (" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")" + _
         " and cp27 is not null and cp24 is null " + _
         " ORDER BY SORTFIELD DESC "
   Case Else
      strSql = "select cp09 收文號," & SQLDate("cp05") & " 收文日,cpm03 案件性質," & SQLDate("cp27") & " 發文日," & _
         SQLDate("cp64") & " 代理人收達日,cp24 結果" + _
         ",DECODE(CP27,19221111,99999999,CP27) AS SORTFIELD " + _
         " from caseprogress,casepropertymap,staff_group where cp01=cpm01 and cp10=cpm02 and sg01=" + CNULL(strGroup) + _
         " and sg02=cp01 and sg03=cp10" + _
         " and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + _
         " and substr(cp09,1,1) in (" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")" + _
         " and cp27 is not null and cp24 is null " + _
         " ORDER BY SORTFIELD DESC "
End Select

Set ClsPDReadAgentNotifyRst = ClsPDReadRst(strSql)
Exit Function
ErrHand:
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function

'檢查本所案號是否存在於案件基本檔
Public Function ClsPDCheckCaseCodeIsExist(ByRef cp01 As String, ByRef cp02 As String, ByRef cp03 As String, ByRef cp04 As String, _
                                          Optional strCaseName1 As String, Optional strCaseName2 As String, Optional strCaseName3 As String, _
                                          Optional strCustomer As String, Optional strNation As String, Optional strNumber1 As String, _
                                          Optional strNumber2 As String, Optional bolMsgShow As Boolean = True, Optional ByRef strApplDate As String) As Boolean
Dim strSql As String, rsRecordset As New ADODB.Recordset, intCaseKind As Integer

On Error GoTo ErrHand

If ClsPDGetSystemKind(cp01, intCaseKind) Then
   'Modify By Sindy 2015/7/28 +申請日
   Select Case intCaseKind
       Case 專利
         strSql = "select pa05,pa06,pa07," & _
            "NVL(CU04,DECODE(CU05,NULL,CU06,CU05||' '||CU88||' '||CU89||' '||CU90)),pa09," & _
            "pa22,pa11,pa10 from patent,customer where pa01=" & CNULL(cp01) & " and " & _
            "pa02=" & CNULL(cp02) & " and pa03=" & CNULL(cp03) & " and " & _
            "pa04=" & CNULL(cp04) & " and substr(pa26,1,8)=cu01(+) and " & _
            "substr(pa26,9,1)=cu02(+) "
      Case 商標
         strSql = "select tm05,tm06,tm07," & _
            "NVL(CU04,DECODE(CU05,NULL,CU06,CU05||' '||CU88||' '||CU89||' '||CU90)),tm10," & _
            "tm15,tm12,tm11 from trademark,customer where tm01=" & CNULL(cp01) & " and " & _
            "tm02=" & CNULL(cp02) & " and tm03=" & CNULL(cp03) & " and " & _
            "tm04=" & CNULL(cp04) & " AND substr(tm23,1,8)=cu01(+) and " & _
            "substr(tm23,9,1)=cu02(+)"
      Case 法務
         strSql = "select lc05,lc06,lc07," & _
            "NVL(CU04,DECODE(CU05,NULL,CU06,CU05||' '||CU88||' '||CU89||' '||CU90)),lc15," & _
            "'','','' from lawcase,customer where lc01=" & CNULL(cp01) & " and " & _
            "lc02=" & CNULL(cp02) & " and lc03=" & CNULL(cp03) & " and " & _
            "lc04=" & CNULL(cp04) & " and substr(lc11,1,8)=cu01(+) and " & _
            "substr(lc11,9,1)=cu02(+)"
      Case 顧問
         strSql = "select hc06,'',''," & _
            "NVL(CU04,DECODE(CU05,NULL,CU06,CU05||' '||CU88||' '||CU89||' '||CU90)),''," & _
            "'','','' from hirecase,customer where hc01=" & CNULL(cp01) & " and hc02=" & CNULL(cp02) & _
            " and hc03=" & CNULL(cp03) & " and hc04=" & CNULL(cp04) & _
            " and substr(hc05,1,8)=cu01(+) and substr(hc05,9,1)=cu02(+)"
      Case Else
         strSql = "select sp05,sp06,sp07," & _
            "NVL(CU04,DECODE(CU05,NULL,CU06,CU05||' '||CU88||' '||CU89||' '||CU90)),sp09," & _
            "sp14,sp11,sp10 from servicepractice,customer where sp01=" & CNULL(cp01) & _
            " and sp02=" & CNULL(cp02) & " and sp03=" & CNULL(cp03) & " and sp04=" & _
            CNULL(cp04) & " and substr(sp08,1,8)=cu01(+) and substr(sp08,9,1)=cu02(+) "
   End Select
   rsRecordset.CursorLocation = adUseClient
   rsRecordset.Open strSql, cnnConnection
   If rsRecordset.RecordCount > 0 Then
      If IsNull(rsRecordset.Fields(0)) Then
         strCaseName1 = ""
      Else
         strCaseName1 = rsRecordset.Fields(0)
      End If
      If IsNull(rsRecordset.Fields(1)) Then
         strCaseName2 = ""
      Else
         strCaseName2 = rsRecordset.Fields(1)
      End If
      If IsNull(rsRecordset.Fields(2)) Then
         strCaseName3 = ""
      Else
         strCaseName3 = rsRecordset.Fields(2)
      End If
      
      strCustomer = IIf(IsNull(rsRecordset.Fields(3)), "", rsRecordset.Fields(3))
      strNation = IIf(IsNull(rsRecordset.Fields(4)), "", rsRecordset.Fields(4))
      strNumber1 = IIf(IsNull(rsRecordset.Fields(5)), "", rsRecordset.Fields(5))
      strNumber2 = IIf(IsNull(rsRecordset.Fields(6)), "", rsRecordset.Fields(6))
      strApplDate = IIf(IsNull(rsRecordset.Fields(7)), "", rsRecordset.Fields(7)) 'Modify By Sindy 2015/7/28 申請日
      ClsPDCheckCaseCodeIsExist = True
   Else
      If bolMsgShow Then ShowMsg MsgText(9141)
   End If
   rsRecordset.Close
End If
Exit Function
ErrHand:
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function

'判斷輸入之系統代號能否屬於該Group
Public Function ClsPDGetGroupCase(ByRef strKind As String, ByRef strGroup As String) As Boolean
Dim strSql As String, rsRecordset As New ADODB.Recordset

On Error GoTo ErrHand
strSql = "select sg01 from staff_group where sg02=" + CNULL(strKind) + " and sg01=" + CNULL(strGroup)
rsRecordset.CursorLocation = adUseClient
rsRecordset.Open strSql, cnnConnection
If rsRecordset.RecordCount > 0 Then
   ClsPDGetGroupCase = True
End If
rsRecordset.Close
Exit Function
ErrHand:
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function

'由系統代號，取得1為專利，2為商標，3為顧問聘任，4為法務，及系統代號之名稱
Public Function ClsPDGetSystemKind(ByRef strKind As String, Optional intCaseKind As Integer, Optional strCaseName As String, Optional intWhere As Integer) As Boolean
 Dim strSql As String, rsRecordset As New ADODB.Recordset
On Error GoTo ErrHand
   strCaseName = "此代號無中文名稱"
   strSql = "select sk02,sk03,sk04 from systemkind where sk01=" + CNULL(strKind)
   rsRecordset.CursorLocation = adUseClient
   rsRecordset.Open strSql, cnnConnection
   If rsRecordset.RecordCount > 0 Then
      If Not IsNull(rsRecordset.Fields(0)) Then intCaseKind = rsRecordset.Fields(0)
      If Not IsNull(rsRecordset.Fields(1)) Then intWhere = rsRecordset.Fields(1)
      If Not IsNull(rsRecordset.Fields(2)) Then strCaseName = rsRecordset.Fields(2)
      ClsPDGetSystemKind = True
   Else
      ShowMsg MsgText(9148)
      intCaseKind = -1
   End If
   rsRecordset.Close
   Exit Function
ErrHand:
      'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function
'Modify by Morgan 2008/12/26 若為薪資系統的檢查,當第三碼為'A'時改為用'0'取代來抓資料
'取得員工名稱(離職會彈訊息並回傳 False)
'Modify By Sindy 2014/4/16 + Optional strST06 As String
Public Function ClsPDGetStaff(ByVal StrStaff As String, ByRef strStaffName As String, Optional strStaffDepartment As String, Optional bolIsSalary As Boolean, _
                              Optional strST06 As String) As Boolean
 Dim strSql As String, rsRecordset As New ADODB.Recordset
On Error GoTo ErrHand
   
   If bolIsSalary Then
      If Mid(StrStaff, 3, 1) = "A" Then
         StrStaff = Left(StrStaff, 2) & "0" & Mid(StrStaff, 4)
      End If
   End If
   
   strStaffName = ""
   strStaffDepartment = ""
   strST06 = "" 'Add By Sindy 2014/4/16
   'Added by Lydia 2024/01/05
   If strSrvDate(1) >= 新部門啟用日 Then
      strSql = "select st02,nvl(a0922,a0902) as a0902,st04,st06 from staff,acc090,acc090new where st03=a0901 and st93=a0921(+) and st01=" + CNULL(StrStaff)
   Else
   'end 2024/01/05
      'Modify By Sindy 2014/4/16 + ,st06
      strSql = "select st02,a0902,st04,st06 from staff,acc090 where st03=a0901 and st01=" + CNULL(StrStaff)
   End If
   rsRecordset.CursorLocation = adUseClient
   rsRecordset.Open strSql, cnnConnection
   If rsRecordset.RecordCount > 0 Then
      If rsRecordset.Fields(2) = 1 Then
         If Not IsNull(rsRecordset.Fields(0)) Then strStaffName = "" & rsRecordset.Fields(0)
         If Not IsNull(rsRecordset.Fields(1)) Then strStaffDepartment = "" & rsRecordset.Fields(1)
         If Not IsNull(rsRecordset.Fields("st06")) Then strST06 = "" & rsRecordset.Fields("st06") 'Add By Sindy 2014/4/16
         ClsPDGetStaff = True
      Else
         ShowMsg MsgText(9149)
      End If
   Else
      ShowMsg MsgText(9150)
   End If
   rsRecordset.Close
   Exit Function
ErrHand:
      'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function

'Modify by Morgan 2008/12/26 若為薪資系統的檢查,當第三碼為'A'時改為用'0'取代來抓資料
'取得員工名稱(含離職)
Public Function ClsPDGetStaffN(ByVal StrStaff As String, ByRef strStaffName As String, Optional strStaffDepartment As String, Optional bolIsSalary As Boolean) As Boolean
 Dim strSql As String, rsRecordset As New ADODB.Recordset
 
On Error GoTo ErrHand

   If bolIsSalary Then
      If Mid(StrStaff, 3, 1) = "A" Then
         StrStaff = Left(StrStaff, 2) & "0" & Mid(StrStaff, 4)
      End If
   End If
   
   strStaffName = ""
   strStaffDepartment = ""
   'Added by Lydia 2024/01/05
   If strSrvDate(1) >= 新部門啟用日 Then
      strSql = "select st02,nvl(a0922,a0902) as a0902,st04 from staff,acc090,acc090new where st03=a0901 and st93=a0921(+) and st01=" + CNULL(StrStaff)
   Else
   'end 2024/01/05
      strSql = "select st02,a0902,st04 from staff,acc090 where st03=a0901 and st01=" + CNULL(StrStaff)
   End If
   rsRecordset.CursorLocation = adUseClient
   rsRecordset.Open strSql, cnnConnection
   If rsRecordset.RecordCount > 0 Then
      If Not IsNull(rsRecordset.Fields(0)) Then strStaffName = "" & rsRecordset.Fields(0)
      If Not IsNull(rsRecordset.Fields(1)) Then strStaffDepartment = "" & rsRecordset.Fields(1)
      ClsPDGetStaffN = True
   Else
      ShowMsg MsgText(9150)
   End If
   rsRecordset.Close
   Exit Function
ErrHand:
      'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function

'取得客戶名稱(中英日任一),郵遞區號,地址(中英日任一)
Public Function ClsPDGetCustomer(ByRef strCustomer As String, ByRef strCustomerName As String, Optional ByRef strZipCode As String, Optional ByRef strAddress As String) As Boolean
   'Modify by Morgan 2011/1/18 併入 ClsPDGetCustomerNameAndAddress
   ClsPDGetCustomer = ClsPDGetCustomerNameAndAddress(strCustomer, strCustomerName, , , , , strZipCode, strAddress)
   
'   Dim strSql As String, rsRecordset As New ADODB.Recordset, i As Integer
'On Error GoTo ErrHand
'   strCustomer = ChangeCustomerL(strCustomer)
'   If Left(strCustomer, 1) = 客戶編號 Then
'      strSql = "select cu01||cu02,nvl(cu04,nvl(cu05,cu06)),cu30," & _
'         "nvl(cu23,nvl(cu24||' '||cu25||' '||cu26||' '||cu27||' '||cu28||' '||cu102,cu29)) " & _
'         "from customer where " & ChgCustomer(strCustomer) & " order by cu01,cu02"
'   ElseIf Left(strCustomer, 1) = 代理人編號 Then
'      strSql = "select fa01||fa02,nvl(cu04,nvl(cu05,cu06)),cu30," & _
'         "nvl(cu23,nvl(cu24||' '||cu25||' '||cu26||' '||cu27||' '||cu28||' '||cu102,cu29))," & _
'         "cu01||cu02 from customer,fagent where cu01=fa03 and " & ChgFagent(strCustomer) & _
'         " order by cu01,cu02"
'   Else
'      ShowMsg MsgText(9151)
'      Exit Function
'   End If
'   strCustomerName = ""
'   strZipCode = ""
'   strAddress = ""
'   rsRecordset.CursorLocation = adUseClient
'   rsRecordset.Open strSql, cnnConnection
'   If rsRecordset.RecordCount > 0 Then
'      If rsRecordset.Fields(0) = strCustomer Then
'         If Left(strCustomer, 1) = 代理人編號 Then strCustomer = rsRecordset.Fields(4)
'         strCustomer = ChangeCustomerS(strCustomer)
'         If Not IsNull(rsRecordset.Fields(1)) Then strCustomerName = rsRecordset.Fields(1)
'         If Not IsNull(rsRecordset.Fields(2)) Then strZipCode = rsRecordset.Fields(2)
'         If Not IsNull(rsRecordset.Fields(3)) Then strAddress = rsRecordset.Fields(3)
'      End If
'      ClsPDGetCustomer = True
'   Else
'      ShowMsg MsgText(9151)
'   End If
'   rsRecordset.Close
'   Exit Function
'ErrHand:
'      'edit by nickc 2007/02/02
'   'ErrorLog
'   MsgBox Err.Description
End Function

'取得客戶之國籍
Public Function ClsPDGetCustomerNation(ByRef strCustomer As String, ByRef strCustomerNation As String) As Boolean
Dim strSql As String, rsRecordset As New ADODB.Recordset, i As Integer

On Error GoTo ErrHand
strCustomer = ChangeCustomerL(strCustomer)
If Left(strCustomer, 1) = 客戶編號 Then
   strSql = "select cu01||cu02,cu10 " & _
      "from customer where cu01='" & Left(strCustomer, 8) & "' and " & _
      "cu02='" & Right(strCustomer, 1) & "'"
ElseIf Left(strCustomer, 1) = 代理人編號 Then
   strSql = "select fa01||fa02,cu10 " & _
      "from customer,fagent where cu01=fa03 and " & _
      "fa01='" & Left(strCustomer, 8) & "' and fa02='" & Right(strCustomer, 1) & "'"
Else
   ShowMsg MsgText(9151)
   Exit Function
End If
rsRecordset.CursorLocation = adUseClient
rsRecordset.Open strSql, cnnConnection
If rsRecordset.RecordCount > 0 Then
   If rsRecordset.Fields(0) = strCustomer Then
      strCustomerNation = IIf(IsNull(rsRecordset.Fields(1)), "", rsRecordset.Fields(1))
   End If
   ClsPDGetCustomerNation = True
Else
   ShowMsg MsgText(9151)
End If
rsRecordset.Close
Exit Function
ErrHand:
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function
'Modify by Morgan 2011/1/11 +strAppNation:國名(中) (與 PUB_GetCustomerNameAndAddress 合併)
'Modify by Morgan 2011/1/18 +strZipCode:郵遞區號,strAddress:地址(中英日任一) (與 ClsPDGetCustomer 合併但保留原函數介面)
'取得客戶中文名稱,中英日地址
Public Function ClsPDGetCustomerNameAndAddress(ByRef strCustomer As String, ByRef strCustomerChinaName As String, Optional ByRef strAddress1 As String, Optional ByRef strAddress2 As String, Optional ByRef strAddress3 As String, Optional ByRef strAppNation, Optional ByRef strZipCode As String, Optional ByRef strAddress As String) As Boolean
 Dim strSql As String, rsRecordset As New ADODB.Recordset, i As Integer
On Error GoTo ErrHand
   strCustomer = ChangeCustomerL(strCustomer)
   If Left(strCustomer, 1) = 客戶編號 Then
      strSql = "select cu01||cu02 CNo,nvl(cu04,nvl(cu05,cu06)) CName,cu23,cu24||' '||cu25||' '||cu26||' '||cu27||' '||cu28||' '||cu102 CAddrEng" & _
         ",cu29,na03,cu30,NVL(CU23,DECODE(CU24,NULL,CU29,CU24||' '||CU25||' '||CU26||' '||CU27||' '||CU28||' '||cu102)) CAddr,'' CNo" & _
         " from customer,nation where " & ChgCustomer(strCustomer) & " and na01(+)=cu10 order by cu01,cu02"
   ElseIf Left(strCustomer, 1) = 代理人編號 Then
      'Add By Sindy 2015/8/7
      If Right(strCustomer, 1) <> "0" Then
         MsgBox "Y編號不可輸入更名前的編號！", vbCritical + vbOKOnly, MsgText(9001)
         Exit Function
      End If
      '2015/8/7 END
      strSql = "select fa01||fa02 FNo,nvl(cu04,nvl(cu05,cu06)) CName,cu23,cu24||' '||cu25||' '||cu26||' '||cu27||' '||cu28||' '||cu102 CAddrEng" & _
         ",cu29,na03,cu30,NVL(CU23,DECODE(CU24,NULL,CU29,CU24||' '||CU25||' '||CU26||' '||CU27||' '||CU28||' '||cu102)) CAddr,cu01||cu02 CNo" & _
         " from fagent,customer,nation where " & ChgFagent(strCustomer) & _
         " and cu01(+)=fa03 and na01(+)=cu10 order by cu01,cu02"
   Else
      ShowMsg MsgText(9151)
      Exit Function
   End If
   
   strCustomerChinaName = ""
   strAddress1 = ""
   strAddress2 = ""
   strAddress3 = ""
   strZipCode = ""
   strAddress = ""
   
   rsRecordset.CursorLocation = adUseClient
   rsRecordset.Open strSql, cnnConnection
   If rsRecordset.RecordCount > 0 Then
      If rsRecordset.Fields(0) = strCustomer Then
         If Left(strCustomer, 1) = 代理人編號 Then strCustomer = "" & rsRecordset.Fields("CNo")
         strCustomer = ChangeCustomerS(strCustomer)
         strCustomerChinaName = "" & rsRecordset.Fields("CName")
         strAddress1 = "" & rsRecordset.Fields("cu23")
         strAddress2 = Trim("" & rsRecordset.Fields("CAddrEng"))
         strAddress3 = "" & rsRecordset.Fields("cu29")
         strZipCode = "" & rsRecordset.Fields("cu30")
         strAddress = "" & rsRecordset.Fields("CAddr")
         strAppNation = "" & rsRecordset.Fields("na03")
      End If
      ClsPDGetCustomerNameAndAddress = True
   Else
      ShowMsg MsgText(9151)
   End If
   rsRecordset.Close
   Set rsRecordset = Nothing
   Exit Function
ErrHand:
      'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function

'取得代理人名稱 'Memo by Lydia 2020/11/03 取得代理人/申請人之代理人名稱、地址
'Modify by Amy 2022/12/05 +bolLongNo:顯示長編號
Public Function ClsPDGetAgent(ByRef strAgent As String, ByRef strAgentName As String, Optional strAdress As String, Optional ByVal bolLongNo As Boolean = False) As Boolean
 Dim strSql As String, rsRecordset As New ADODB.Recordset, i As Integer, strTemp
On Error GoTo ErrHand
   strAgent = ChangeCustomerL(strAgent)
   If Left(strAgent, 1) = 代理人編號 Then
      'Modified by Lydia 2021/01/12 英文名稱之間+空白
      'strSql = "select fa01||fa02,nvl(fa05||fa63||fa64||fa65,nvl(fa04,fa06))," & _
         "nvl(fa15,nvl(fa16||' '||fa17||' '||fa18||' '||fa19||' '||fa20,fa21)) from " & _
         "fagent where " & ChgFagent(strAgent) & " order by fa01,fa02"
      strSql = "select fa01||fa02 as fno, decode(fa05,null,nvl(fa04,fa06),fa05||' '||fa63||' '||fa64||' '||fa65) as fname," & _
         "nvl(fa15,nvl(fa16||' '||fa17||' '||fa18||' '||fa19||' '||fa20,fa21)) as faddr from " & _
         "fagent where " & ChgFagent(strAgent) & " order by fa01,fa02"
   ElseIf Left(strAgent, 1) = 客戶編號 Then
      'Modified by Lydia 2021/01/12 英文名稱之間+空白
      'strSql = "select cu01||cu02,nvl(fa05||fa63||fa64||fa65,nvl(fa04,fa06))," & _
         "nvl(fa15,nvl(fa16||' '||fa17||' '||fa18||' '||fa19||' '||fa20,fa21))," & _
         "fa01||fa02 from customer,fagent where fa01=cu03 and " & ChgCustomer(strAgent) & " order by fa01,fa02"
      strSql = "select cu01||cu02 as fno,decode(fa05,null,nvl(fa04,fa06),fa05||' '||fa63||' '||fa64||' '||fa65) as fname," & _
         "nvl(fa15,nvl(fa16||' '||fa17||' '||fa18||' '||fa19||' '||fa20,fa21)) as faddr," & _
         "fa01||fa02 from customer,fagent where fa01=cu03 and " & ChgCustomer(strAgent) & " order by fa01,fa02"
   Else
      ShowMsg MsgText(9152)
      Exit Function
   End If
   strAgentName = ""
   strAdress = ""
   rsRecordset.CursorLocation = adUseClient
   rsRecordset.Open strSql, cnnConnection
   If rsRecordset.RecordCount > 0 Then
      If rsRecordset.Fields(0) = strAgent Then
         If Left(strAgent, 1) = 客戶編號 Then strAgent = rsRecordset.Fields(3)
         If bolLongNo = False Then strAgent = ChangeCustomerS(strAgent) 'Modify by Amy 2022/12/05 +bolLongNo
         'Modified by Lydia 2019/03/11 在Label顯示&會變成_
         'If Not IsNull(rsRecordset.Fields(1)) Then strAgentName = rsRecordset.Fields(1)
         'If Not IsNull(rsRecordset.Fields(2)) Then strAdress = rsRecordset.Fields(2)
         If Not IsNull(rsRecordset.Fields(1)) Then strAgentName = Replace("" & rsRecordset.Fields(1), "&", "＆")
         If Not IsNull(rsRecordset.Fields(2)) Then strAdress = Replace("" & rsRecordset.Fields(2), "&", "＆")
         'end 2019/03/11
      End If
      ClsPDGetAgent = True
   Else
      ShowMsg MsgText(9152)
   End If
   rsRecordset.Close
   Exit Function
ErrHand:
      'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function

'Add by Morgan 2008/2/20
'讀取聯絡人名稱 英->中->日
Public Function ClsPDGetContact(ByRef strAgent As String, ByRef strAgentName As String) As Boolean
   Dim PCC01 As String, PCC02 As String, iPos As Integer
   iPos = InStr(strAgent, "-")
   PCC01 = ChangeCustomerL(Left(strAgent, iPos - 1))
   PCC02 = Right("00" & Mid(strAgent, iPos + 1), 2)
   strAgent = PCC01 & "-" & PCC02
   strExc(0) = "select nvl(pcc03,nvl(pcc05,pcc04)) from potcustcont where pcc01='" & Left(PCC01, 8) & "' and pcc02='" & PCC02 & "'"
   intI = 1
   Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
   If intI = 1 Then
      strAgentName = "" & RsTemp.Fields(0)
      ClsPDGetContact = True
   End If
End Function
'取得申請國家之名稱
Public Function ClsPDGetNation(ByRef strNation As String, Optional strNationName, Optional strLanguage As String) As Boolean
 Dim strSql As String, rsRecordset As New ADODB.Recordset
On Error GoTo ErrHand
   strNationName = ""
   strLanguage = ""
   strSql = "select nvl(na03,na04),na05 from nation where na01=" + CNULL(strNation)
   rsRecordset.CursorLocation = adUseClient
   rsRecordset.Open strSql, cnnConnection
   If rsRecordset.RecordCount > 0 Then
      If Not IsNull(rsRecordset.Fields(0)) Then strNationName = rsRecordset.Fields(0)
      If Not IsNull(rsRecordset.Fields(1)) Then strLanguage = rsRecordset.Fields(1)
      ClsPDGetNation = True
   Else
      ShowMsg MsgText(9153)
   End If
   rsRecordset.Close
   Exit Function
ErrHand:
      'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function

'取得最大流水號
Public Function ClsPDGetMaxNumber(ByRef strAutoName As String, ByRef strAutoNumber As String) As Boolean
Dim strSql As String, rsRecordset As New ADODB.Recordset, intAutoNumber As Integer

On Error GoTo ErrHand
strSql = "select au03 from autonumber where au01=" + CNULL(strAutoName)
rsRecordset.CursorLocation = adUseClient
rsRecordset.Open strSql, cnnConnection
If rsRecordset.RecordCount > 0 Then
   strAutoNumber = IIf(IsNull(rsRecordset.Fields(0)), "", rsRecordset.Fields(0))
   ClsPDGetMaxNumber = True
Else
   ShowMsg MsgText(9154)
End If
Exit Function
ErrHand:
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function
'取得自動流水號
'AutoSet True為若沒有，則自動產生，False為若沒有，則不自動產生
'intChangeByYear True為年度改變時，則自動歸零，False為不自動歸零，繼續編號
Public Function ClsPDGetAutoNumber(ByRef strAutoName As String, ByRef strAutoNumber As String, ByRef intAutoSet As Boolean, ByRef intChangeByYear As Boolean) As Boolean
Dim strSql As String, rsRecordset As New ADODB.Recordset, intAutoNumber As Long
'*************************
'Modify By Cheng 2002/11/13
'將此處的Connection取消
'*************************
''Add By Cheng 2002/01/03
Dim cn As New ADODB.Connection

'911113 NICK  避免相同連線作做2次 transation
Dim BolTransOk As Boolean
BolTransOk = True

On Error GoTo ErrHand
''Add By Cheng 2002/01/03
'If cn.State <> adStateClosed Then cn.Close
'Set cn = Nothing
'cn.Open "Provider=MSDAORA.1;Password=PGMPWD;User ID=PGMID;Data Source=M51CON"

Select Case strAutoName
   Case "B", "C"
      cnnConnection.BeginTrans
End Select

strSql = "select au02 from autonumber where au01=" + CNULL(strAutoName)
rsRecordset.CursorLocation = adUseClient
'Modify By Cheng 2002/11/13
'rsRecordset.Open strSQL, cn
rsRecordset.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If rsRecordset.RecordCount > 0 Then
   rsRecordset.Close
   If intChangeByYear Then
      strSql = "declare sysyear number; syear number;" + _
         "begin sysyear:=to_char(sysdate,'YYYY');" + _
         "select au02 into syear from autonumber where au01=" + CNULL(strAutoName) + ";" + _
         "if syear=sysyear then " + _
         "   update autonumber set au03=au03+1 where au01=" + CNULL(strAutoName) + ";" + _
         "else " + _
         "   update autonumber set au03=1,au02=sysyear where au01=" + CNULL(strAutoName) + ";" + _
         "end if;" + _
         "end;"
   Else
      strSql = "update autonumber set au03=au03+1 where au01=" + CNULL(strAutoName)
   End If
    'Modify By Cheng 2002/11/13
'   cn.Execute strSQL
    cnnConnection.Execute strSql
   strSql = "select au03 from autonumber where au01=" + CNULL(strAutoName)
   rsRecordset.CursorLocation = adUseClient
    'Modify By Cheng 2002/11/13
'   rsRecordset.Open strSQL, cn
   rsRecordset.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If rsRecordset.RecordCount > 0 Then
       intAutoNumber = rsRecordset.Fields(0)
       If strAutoName = 馬德里案 Then
          strAutoNumber = Format(intAutoNumber, "00000") + "0"
       Else
          strAutoNumber = Format(intAutoNumber, "000000")
       End If
   End If
   rsRecordset.Close
   ClsPDGetAutoNumber = True
Else
   rsRecordset.Close
   If intAutoSet Then
      strSql = "insert into autonumber (au01,au02,au03) values('" + strAutoName + "',to_char(sysdate,'YYYY'),1)"
        'Modify By Cheng 2002/11/13
'      cn.Execute strSQL
      cnnConnection.Execute strSql
      strAutoNumber = IIf(strAutoName = 馬德里案, "000010", "000001")
      ClsPDGetAutoNumber = True
   End If
End If
If ClsPDGetAutoNumber = False Then ShowMsg MsgText(9155)

   If BolTransOk Then
        Select Case strAutoName
           Case "B", "C"
             cnnConnection.CommitTrans
        End Select
   End If


''Add By Cheng 2002/01/03
'If cn.State <> adStateClosed Then cn.Close
'Set cn = Nothing

Exit Function
ErrHand:

   If Err.Number = -2147168237 Then
      BolTransOk = False
      Resume Next
   End If
   If BolTransOk Then
        Select Case strAutoName
           Case "B", "C"
             cnnConnection.RollbackTrans
        End Select
   End If
''Add By Cheng 2002/01/03
'If cn.State <> adStateClosed Then cn.Close
'Set cn = Nothing

   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function

'取得商標專利之種類名稱
'bolIsChina為True時，取大陸名稱
Public Function ClsPDGetPatentTrademarkKind(ByRef strKind As String, ByRef strPTKind As String, _
   ByRef strPTKindName As String, Optional bolIsChina As Boolean = False, Optional strNation As String) As Integer
Dim strSql As String, rsRecordset As New ADODB.Recordset

On Error GoTo ErrHand
strSql = "select " + IIf(bolIsChina, "ptm04", "ptm03") + " from patenttrademarkmap where ptm01=" + CNULL(strKind) + " and ptm02=" + CNULL(strPTKind)
'Added by Lydia 2023/11/14 特殊專利商標資料檔
strSql = strSql & " Union select " + IIf(bolIsChina, "spt04", "spt03") + " from SpecialPatentTrademark where spt01=" + CNULL(strKind) + " and spt02=" + CNULL(strPTKind)
'end 2023/11/14
rsRecordset.CursorLocation = adUseClient
rsRecordset.Open strSql, cnnConnection
If rsRecordset.RecordCount > 0 Then
   strPTKindName = IIf(IsNull(rsRecordset.Fields(0)), "", rsRecordset.Fields(0))
   If strKind = 專利 Then
      rsRecordset.Close
      strSql = "select na" + Format(7 + (Val(strPTKind) - 1) * 2, "00") + " from nation where na01=" + CNULL(strNation)
      rsRecordset.CursorLocation = adUseClient
      rsRecordset.Open strSql, cnnConnection
      If rsRecordset.RecordCount > 0 Then
         If IsNull(rsRecordset.Fields(0)) = False Then
            ClsPDGetPatentTrademarkKind = 1
         Else
            ShowMsg MsgText(9156)
            ClsPDGetPatentTrademarkKind = 0
         End If
      Else
         ShowMsg MsgText(9157)
         ClsPDGetPatentTrademarkKind = 0
      End If
   Else
      ClsPDGetPatentTrademarkKind = 1
   End If
Else
   ShowMsg IIf(strKind = 商標, "商標", "專利") + MsgText(9158)
   ClsPDGetPatentTrademarkKind = -1
End If
rsRecordset.Close
Exit Function
ErrHand:
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function

'取得此本所案號之國家代號
Public Function ClsPDGetCaseNation(ByRef intCaseKind As Integer, ByRef strSystem As String, strTemp0 As String, strTemp1 As String, strTemp2 As String, ByRef strCaseNation As String) As Boolean
 Dim strSql As String, rsRecordset As New ADODB.Recordset
On Error GoTo ErrHand
   strCaseNation = ""
   Select Case intCaseKind
      Case 專利
         strSql = "select pa09 from patent where pa01=" + CNULL(strSystem) + " and pa02=" + CNULL(strTemp0) + " and pa03=" + CNULL(strTemp1) + " and pa04=" + CNULL(strTemp2)
      Case 商標
         strSql = "select tm10 from trademark where tm01=" + CNULL(strSystem) + " and tm02=" + CNULL(strTemp0) + " and tm03=" + CNULL(strTemp1) + " and tm04=" + CNULL(strTemp2)
      '2013/8/22 add by sonia
      Case 法務
         strSql = "select lc15 from lawcase where lc01=" + CNULL(strSystem) + " and lc02=" + CNULL(strTemp0) + " and lc03=" + CNULL(strTemp1) + " and lc04=" + CNULL(strTemp2)
      Case 顧問
         strSql = "select '000' from hirecase where hc01=" + CNULL(strSystem) + " and hc02=" + CNULL(strTemp0) + " and hc03=" + CNULL(strTemp1) + " and hc04=" + CNULL(strTemp2)
      '2013/8/22 end
      Case Else
         strSql = "select sp09 from servicepractice where sp01=" + CNULL(strSystem) + " and sp02=" + CNULL(strTemp0) + " and sp03=" + CNULL(strTemp1) + " and sp04=" + CNULL(strTemp2)
   End Select
   rsRecordset.CursorLocation = adUseClient
   rsRecordset.Open strSql, cnnConnection
   If rsRecordset.RecordCount > 0 Then
      If Not IsNull(rsRecordset.Fields(0)) Then strCaseNation = rsRecordset.Fields(0)
      ClsPDGetCaseNation = True
   Else
      ShowMsg MsgText(9159)
   End If
   rsRecordset.Close
   Exit Function
ErrHand:
      'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function

'取得案件性質之名稱
'bolIsChina為True時，取大陸名稱
Public Function ClsPDGetCaseProperty(ByRef strSystem As String, ByRef strProperty As String, ByRef strPropertyName As String, Optional bolIsChina As Boolean = False, Optional bShowMsg As Boolean = True) As Boolean
 Dim strSql As String, rsRecordset As New ADODB.Recordset
On Error GoTo ErrHand
   strPropertyName = ""
   'Modify By Sindy 2015/1/22 +,cpm03,cpm04
   strSql = "select cpm0" + IIf(bolIsChina, "4", "3") + ",cpm03,cpm04 from casepropertymap where cpm01=" + CNULL(strSystem) + " and cpm02=" + CNULL(strProperty)
   rsRecordset.CursorLocation = adUseClient
   rsRecordset.Open strSql, cnnConnection
   If rsRecordset.RecordCount > 0 Then
      If Not IsNull(rsRecordset.Fields(0)) Then
         strPropertyName = rsRecordset.Fields(0)
      End If
      'Modify By Sindy 2015/1/22 表頭之案件性質名稱,若申請國家條件020~020則改抓CPM04,否則抓CPM03,但CPM03為（無）者改抓CPM04)
      If bolIsChina = False And strPropertyName = "（無）" Then
         strPropertyName = "" & rsRecordset.Fields("cpm04")
      End If
      '2015/1/22 END
      ClsPDGetCaseProperty = True
   Else
      ClsPDGetCaseProperty = False
      If bShowMsg Then
         ShowMsg MsgText(9160)
      End If
   End If
   rsRecordset.Close
   If strPropertyName = "（無）" Then strPropertyName = "" 'Add By Sindy 2015/1/22
   Exit Function
ErrHand:
      'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function

'取得案件性質之名稱
Public Function ClsPDGetCasePropertyL(ByRef kind As Integer, ByRef strRecieveKind As String, ByRef strProperty As String, ByRef strPropertyName As String) As Boolean
Dim strSql As String, rsRecordset As New ADODB.Recordset

On Error GoTo ErrHand
strPropertyName = ""
Select Case kind
Case 1
 strSql = "select cpm03 from casepropertymap where cpm01='" + strRecieveKind + "' and cpm02='" + strProperty + "' "
Case 2
 strSql = "select cpm04 from casepropertymap where cpm01='" + strRecieveKind + "' and cpm02='" + strProperty + "' "
End Select
rsRecordset.CursorLocation = adUseClient
rsRecordset.Open strSql, cnnConnection
If rsRecordset.RecordCount > 0 Then
   strPropertyName = rsRecordset.Fields(0)
   ClsPDGetCasePropertyL = True
Else
   ShowMsg MsgText(9160)
End If
rsRecordset.Close
Exit Function
ErrHand:
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function

'判斷收文號是否存在
Public Function ClsPDCheckRecieveCode(ByRef strRecieve As String, ByRef strCode0 As String, ByRef strCode1 As String, ByRef strCode2 As String, ByRef strCode3 As String) As Integer
Dim strSql As String, rsRecordset As New ADODB.Recordset

On Error GoTo ErrHand
If Left(strRecieve, 1) = 接洽記錄單 Or Left(strRecieve, 1) = 內部收文 Then
   strSql = "select cp01,cp02,cp03,cp04,cp10 from caseprogress where cp09=" + CNULL(strRecieve)
Else
   strSql = "select mr16,mr10,mr11,mr12 from mailrec where mr01=" + CNULL(strRecieve)
End If
rsRecordset.CursorLocation = adUseClient
rsRecordset.Open strSql, cnnConnection
If rsRecordset.RecordCount > 0 Then
   strCode0 = IIf(IsNull(rsRecordset.Fields(0)), "", rsRecordset.Fields(0))
   strCode1 = IIf(IsNull(rsRecordset.Fields(1)), "", rsRecordset.Fields(1))
   strCode2 = IIf(IsNull(rsRecordset.Fields(2)), "", rsRecordset.Fields(2))
   strCode3 = IIf(IsNull(rsRecordset.Fields(3)), "", rsRecordset.Fields(3))
   If Left(strRecieve, 1) = 接洽記錄單 Or Left(strRecieve, 1) = 內部收文 Then
      If rsRecordset.Fields(4) = 顧問聘任 Then
         ClsPDCheckRecieveCode = 2
      Else
         ClsPDCheckRecieveCode = 1
      End If
   Else
      ClsPDCheckRecieveCode = 1
   End If
Else
   ShowMsg MsgText(9161)
End If
rsRecordset.Close
Exit Function
ErrHand:
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function
'Modified by Lydia 2015/04/10 frm02010603_3 已不用
''取得申請人國外ID號碼
'Public Function ClsPDGetAgentID(ByRef strAgent As String, ByRef strNation As String, ByRef strAgentID As String) As Boolean
' Dim strSql As String, rsRecordset As New ADODB.Recordset
'On Error GoTo ErrHand
'   strAgentID = ""
'   strSql = "select afid03 from applicantforeignid where afid01=" + CNULL(Left(ChangeCustomerL(strAgent), 8)) + " and afid02=" + CNULL(strNation)
'   rsRecordset.CursorLocation = adUseClient
'   rsRecordset.Open strSql, cnnConnection
'   If rsRecordset.RecordCount > 0 Then
'      If Not IsNull(rsRecordset.Fields(0)) Then strAgentID = rsRecordset.Fields(0)
'      ClsPDGetAgentID = True
'   End If
'   rsRecordset.Close
'   Exit Function
'ErrHand:
'   ShowMsg MsgText(9162)
'      'edit by nickc 2007/02/02
'   'ErrorLog
'   MsgBox Err.Description
'End Function

'取得檔案來源之名稱
Public Function ClsPDGetCaseSource(ByRef strSource As String, ByRef strSourceName As String) As Boolean
Dim strSql As String, rsRecordset As New ADODB.Recordset

On Error GoTo ErrHand
strSourceName = ""
strSql = "select csm02 from casesourcemap where csm01=" + CNULL(strSource)
rsRecordset.CursorLocation = adUseClient
rsRecordset.Open strSql, cnnConnection
If rsRecordset.RecordCount > 0 Then
   strSourceName = rsRecordset.Fields(0)
   ClsPDGetCaseSource = True
Else
   ShowMsg MsgText(9163)
End If
rsRecordset.Close
Exit Function
ErrHand:
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function

'Remove by Morgan 2007/10/16 功能重複,改用GetWorkDays取代
''取得案件之工作天數
'Public Function ClsPDGetCaseWorkDays(ByRef strSystem As String, ByRef strNation As String, ByRef strCaseProperty As String, Optional strWorkDays As String) As Boolean
'Dim strSQL As String, rsRecordset As New ADODB.Recordset
'
'On Error GoTo Err
'strWorkDays = ""
'strSQL = "select cf04 from casefee where cf01=" + CNULL(strSystem) + " and cf02=" + _
'        CNULL(strNation) + " and cf03=" + CNULL(strCaseProperty)
'rsRecordset.CursorLocation = adUseClient
'rsRecordset.Open strSQL, cnnConnection
'If rsRecordset.RecordCount > 0 Then
'   strWorkDays = IIf(IsNull(rsRecordset.Fields(0)), "", rsRecordset.Fields(0))
'End If
'ClsPDGetCaseWorkDays = True
'rsRecordset.Close
'Exit Function
'Err:
'   'edit by nickc 2007/02/02
'   'ErrorLog
'   MsgBox Err.Description
'End Function

'取得案件之費用
Public Function ClsPDGetCaseFee(ByRef strSystem As String, ByRef strNation As String, ByRef strCaseProperty As String, _
   ByRef Fee As Long, ByRef OfficialFee As Long) As Integer
   
   'Modify By Sindy 2022/12/30
   If ChkPointValue(strSystem, strNation, strCaseProperty, "", "", , , , , , True, Fee, OfficialFee) = True Then
      ClsPDGetCaseFee = 1
   Else
      ClsPDGetCaseFee = 0
   End If
   '2022/12/30 END
   
   Exit Function
   
'Dim strSql As String, rsRecordset As New ADODB.Recordset
'Dim Wkcf06 As Long, Wkcf07 As Long, Wkcf08 As Long
'
'   Wkcf06 = 0: Wkcf07 = 0: Wkcf08 = 0
'On Error GoTo ErrHand
'
'   'MODIFY BY SONIA 2014/7/16 +cf08
'   strSql = "select cf06,cf07,cf08 from casefee where cf01=" + CNULL(strSystem) + " and cf02=" + _
'           CNULL(strNation) + " and cf03=" + CNULL(strCaseProperty)
'   rsRecordset.CursorLocation = adUseClient
'   rsRecordset.Open strSql, cnnConnection
'   If rsRecordset.RecordCount > 0 Then
'      If Not IsNull(rsRecordset.Fields(0)) Then Wkcf06 = rsRecordset.Fields(0)
'      If Not IsNull(rsRecordset.Fields(1)) Then Wkcf07 = rsRecordset.Fields(1)
'      'add by sonia 2014/7/16
'      If Not IsNull(rsRecordset.Fields(2)) Then Wkcf08 = rsRecordset.Fields(2)
'      If Val(OfficialFee) = 0 And strNation <> "000" Then
'         Wkcf06 = Wkcf06 - Wkcf08
'         Wkcf07 = Wkcf07 - Wkcf08
'      End If
'      'end 2014/7/16
'      If Wkcf06 = 0 And Wkcf07 = 0 Then
'         ClsPDGetCaseFee = 1
'      Else
'         If Fee >= Wkcf06 And Fee <= Wkcf07 Then
'            ClsPDGetCaseFee = 1
'         Else
'            '2011/10/18 MODIFY BY SONIA
'            'ShowMsg MsgText(9164)
'            ShowMsg MsgText(9164) & "，最低費用為 " & Wkcf06 & "，最高費用為 " & Wkcf07 & " "
'            '2011/10/18 END
'            ClsPDGetCaseFee = 0
'         End If
'      End If
'   Else
'      ClsPDGetCaseFee = 1
'   End If
'   rsRecordset.Close
'   Exit Function
'
'ErrHand:
'   ClsPDGetCaseFee = -2
'   'edit by nickc 2007/02/02
'   'ErrorLog
'   MsgBox Err.Description
End Function

'Add By Sindy 2010/7/30
'取得案件之費用-商標例外狀況處理
Public Function ClsPDGetCaseFee_T(ByRef strSystem As String, ByRef strNation As String, ByRef strCaseProperty As String, ByRef Fee As Long, ByRef RuleFee As Long, ByRef GoodsCnt As Long) As Integer
Dim strSql As String, rsRecordset As New ADODB.Recordset
Dim Wkcf06 As Long, Wkcf07 As Long, Wkcf08 As Long
Dim dblSetFee As Double

Wkcf06 = 0: Wkcf07 = 0: Wkcf08 = 0: dblSetFee = 0
On Error GoTo ErrHand
strSql = "select cf06,cf07,cf08 from casefee where cf01=" + CNULL(strSystem) + " and cf02=" + _
        CNULL(strNation) + " and cf03=" + CNULL(strCaseProperty)
rsRecordset.CursorLocation = adUseClient
rsRecordset.Open strSql, cnnConnection
If rsRecordset.RecordCount > 0 Then
   If Not IsNull(rsRecordset.Fields(0)) Then Wkcf06 = rsRecordset.Fields(0)
   If Not IsNull(rsRecordset.Fields(1)) Then Wkcf07 = rsRecordset.Fields(1)
   If Not IsNull(rsRecordset.Fields(2)) Then Wkcf08 = rsRecordset.Fields(2)
   If Wkcf06 = 0 And Wkcf07 = 0 Then
      ClsPDGetCaseFee_T = 1
   Else
      '申請
      If strCaseProperty = "101" Then dblSetFee = 5000
      '延展,異議,評定,廢止
      If strCaseProperty = "102" Or strCaseProperty = "601" Or strCaseProperty = "603" Or strCaseProperty = "605" Then dblSetFee = 6000
      '第一期,第二期,全期註冊費
      If strCaseProperty = "715" Or strCaseProperty = "716" Or strCaseProperty = "717" Then dblSetFee = 1000
      If Fee >= Wkcf06 And Fee <= ((Wkcf07 - Wkcf08) + RuleFee + (dblSetFee * GoodsCnt)) Then
         ClsPDGetCaseFee_T = 1
      Else
         '2011/10/18 MODIFY BY SONIA
         'ShowMsg MsgText(9164)
         ShowMsg MsgText(9164) & "，最低費用為 " & Wkcf06 & "，最高費用為 " & ((Wkcf07 - Wkcf08) + RuleFee + (dblSetFee * GoodsCnt)) & " "
         '2011/10/18 END
         ClsPDGetCaseFee_T = 0
      End If
   End If
Else
   ClsPDGetCaseFee_T = 1
End If
rsRecordset.Close
Exit Function
ErrHand:
ClsPDGetCaseFee_T = -2
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function

'Add By Sindy 2025/2/4 抓 CaseFee2 SQL
'Modify By Sindy 2025/4/8 + Optional ByVal strCaseAttributes As String : 案件屬性
Public Function PUB_GetCaseFee2SQL(ByRef strSystem As String, ByRef strNation As String, ByRef strCaseProperty As String, _
   Optional ByVal strCaseKind As String, Optional ByVal strIDentity As String, Optional ByVal strCP140 As String, _
   Optional ByVal strCRLType As String, _
   Optional ByVal strCP01 As String, Optional ByVal strCP02 As String, _
   Optional ByVal strCP03 As String, Optional ByVal strCP04 As String, _
   Optional ByVal strCaseAttributes As String) As String

Dim StrSQLa As String
Dim strCRL94 As String, strCRL81 As String
Dim strCF205 As String
Dim strQuyCP01 As String 'Add By Sindy 2023/2/7

   'strCaseKind : 專利/商標種類
   If strCP02 <> "" And strCaseKind = "" Then
      strCaseKind = GetPrjKind(strCP01 & "-" & strCP02 & "-" & strCP03 & "-" & strCP04, 0)
   End If
   'strIDentity : 案件屬性/身份種類
   If strCP02 <> "" And strIDentity = "" Then
      '身份種類
      strIDentity = PUB_GetEntityType(strCP01, strCP02, strCP03, strCP04)
      If strIDentity = "" Then
         '案件屬性
         strSql = "select pa158 from patent where pa01='" & strCP01 & "' and pa02='" & strCP02 & "' and pa03='" & strCP03 & "' and pa04='" & strCP04 & "'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strSql)
         If intI = 1 Then
            strIDentity = "" & RsTemp.Fields("pa158").Value
         End If
      End If
   End If
   
   If strCP140 <> "" Then
      strSql = "select CRL01,CRL94,CRL81 from ConsultRecordList where CRL01='" & strCP140 & "'"
      intI = 1
      Set RsTemp = ClsLawReadRstMsg(intI, strSql)
      If intI = 1 Then
         strCRL94 = "" & RsTemp.Fields("CRL94").Value '身份種類:ex:大個體,小個體...
         strCRL81 = "" & RsTemp.Fields("CRL81").Value 'Add By Sindy 2025/2/4 案件屬性
         'Modify By Sindy 2025/2/4 P大陸非"有"台灣專利說明書時,改抓案件屬性
         If strSystem = "P" And strNation = "020" And strCRL94 <> "2" Then
            strCF205 = strCRL81
         Else
         '2025/2/4 END
            If strCRL94 <> "" Then
               strCF205 = strCRL94
            Else
               strCF205 = strCRL81
            End If
         End If
      End If
   '依傳入值
   'Modify By Sindy 2025/5/20 + Or strCF205 = ""
   ElseIf strCP02 = "" Or strCF205 = "" Then '新案依傳入的值判斷
      'Modify By Sindy 2025/2/4 P大陸非"有"台灣專利說明書時,改抓案件屬性
      strCRL94 = strIDentity
      If strSystem = "P" And strNation = "020" And strIDentity <> "2" Then
         strCF205 = strCaseAttributes
      Else
      '2025/2/4 END
         If strIDentity <> "" Then
            strCF205 = strIDentity
         Else
            strCF205 = strCaseAttributes
         End If
      End If
   End If
   
   'Modify By Sindy 2023/2/7 抓代理人代碼,"有值"代表為大至台
   If strCRLType = "" And strCP02 <> "" Then
      If GetPrjPeopleNum6(strCP01 & "-" & strCP02 & "-" & strCP03 & "-" & strCP04) <> "" Then
         strCRLType = "2" '接洽單種類-1.國內 2.大至台
      End If
   End If
    
   StrSQLa = ""
   'Modify By Sindy 2022/12/15
   'P大陸有台灣專利說明書
   If strSystem = "P" And strNation = "020" And (strCRL94 = "2" Or strCRL94 = "") Then
      StrSQLa = "select '5',cf01,cf02,cf03,'0','0',cf06,cf07,cf08,null,cf13,cf14 from casefee where cf01=" & CNULL(strSystem) & " and cf02=" & _
               CNULL(strNation) & " and cf03=" & CNULL(strCaseProperty)
   Else '(以第一筆資料檢查費用及底價，費用啟始值之區主管1點權限由程式碼控制)
      'Modify By Sindy 2023/2/7 調整大陸來台P案之價格檢查
      '接洽記錄單若為外至台的接洽單,在檢查價格及抓標準價及底價時, 加入以下控制:
      'P案增加CF201='MCP'，T案增加CF201='MCT'的語法
      'Modify By Sindy 2023/2/8 + And strNation = "000"
      If strCRLType = "2" And (strSystem = "P" Or strSystem = "T") And strNation = "000" Then '2.大至台
         If strSystem = "P" Then
            strQuyCP01 = "MCP"
         Else
            strQuyCP01 = "MCT"
         End If
         StrSQLa = "select '1',cf201,cf202,cf203,cf204,cf205,cf206 as cf06,cf207 as cf07,cf208 as cf08,cf209,cf213 as cf13,cf214 as cf14 from casefee2" & _
                  " where cf201=" & CNULL(strQuyCP01) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
                  " and cf204=" & CNULL(strCaseKind) & " and cf205=" & CNULL(strCF205) & _
                  " and cf210=(select max(cf210) from casefee2 where cf201=" & CNULL(strQuyCP01) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
                  " and cf204=" & CNULL(strCaseKind) & " and cf205=" & CNULL(strCF205) & " and cf210<=" & strSrvDate(1) & ")"
         StrSQLa = StrSQLa & " Union " & _
                  "select '2',cf201,cf202,cf203,cf204,cf205,cf206 as cf06,cf207 as cf07,cf208 as cf08,cf209,cf213 as cf13,cf214 as cf14 from casefee2" & _
                  " where cf201=" & CNULL(strQuyCP01) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
                  " and cf204=" & CNULL(strCaseKind) & " and cf205='0'" & _
                  " and cf210=(select max(cf210) from casefee2 where cf201=" & CNULL(strQuyCP01) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
                  " and cf204=" & CNULL(strCaseKind) & " and cf205='0' and cf210<=" & strSrvDate(1) & ")"
         StrSQLa = StrSQLa & " Union " & _
                  "select '3',cf201,cf202,cf203,cf204,cf205,cf206 as cf06,cf207 as cf07,cf208 as cf08,cf209,cf213 as cf13,cf214 as cf14 from casefee2" & _
                  " where cf201=" & CNULL(strQuyCP01) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
                  " and cf204='0' and cf205=" & CNULL(strCF205) & _
                  " and cf210=(select max(cf210) from casefee2 where cf201=" & CNULL(strQuyCP01) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
                  " and cf204='0' and cf205=" & CNULL(strCF205) & " and cf210<=" & strSrvDate(1) & ")"
         StrSQLa = StrSQLa & " Union " & _
                  "select '4',cf201,cf202,cf203,cf204,cf205,cf206 as cf06,cf207 as cf07,cf208 as cf08,cf209,cf213 as cf13,cf214 as cf14 from casefee2" & _
                  " where cf201=" & CNULL(strQuyCP01) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
                  " and cf204='0' and cf205='0'" & _
                  " and cf210=(select max(cf210) from casefee2 where cf201=" & CNULL(strQuyCP01) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
                  " and cf204='0' and cf205='0' and cf210<=" & strSrvDate(1) & ")"
      End If
      If StrSQLa <> "" Then StrSQLa = StrSQLa & " Union "
      '2023/2/7 END
      StrSQLa = StrSQLa & "select '1',cf201,cf202,cf203,cf204,cf205,cf206 as cf06,cf207 as cf07,cf208 as cf08,cf209,cf213 as cf13,cf214 as cf14 from casefee2" & _
               " where cf201=" & CNULL(strSystem) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
               " and cf204=" & CNULL(strCaseKind) & " and cf205=" & CNULL(strCF205) & _
               " and cf210=(select max(cf210) from casefee2 where cf201=" & CNULL(strSystem) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
               " and cf204=" & CNULL(strCaseKind) & " and cf205=" & CNULL(strCF205) & " and cf210<=" & strSrvDate(1) & ")"
      StrSQLa = StrSQLa & " Union " & _
               "select '2',cf201,cf202,cf203,cf204,cf205,cf206 as cf06,cf207 as cf07,cf208 as cf08,cf209,cf213 as cf13,cf214 as cf14 from casefee2" & _
               " where cf201=" & CNULL(strSystem) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
               " and cf204=" & CNULL(strCaseKind) & " and cf205='0'" & _
               " and cf210=(select max(cf210) from casefee2 where cf201=" & CNULL(strSystem) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
               " and cf204=" & CNULL(strCaseKind) & " and cf205='0' and cf210<=" & strSrvDate(1) & ")"
      StrSQLa = StrSQLa & " Union " & _
               "select '3',cf201,cf202,cf203,cf204,cf205,cf206 as cf06,cf207 as cf07,cf208 as cf08,cf209,cf213 as cf13,cf214 as cf14 from casefee2" & _
               " where cf201=" & CNULL(strSystem) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
               " and cf204='0' and cf205=" & CNULL(strCF205) & _
               " and cf210=(select max(cf210) from casefee2 where cf201=" & CNULL(strSystem) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
               " and cf204='0' and cf205=" & CNULL(strCF205) & " and cf210<=" & strSrvDate(1) & ")"
      StrSQLa = StrSQLa & " Union " & _
               "select '4',cf201,cf202,cf203,cf204,cf205,cf206 as cf06,cf207 as cf07,cf208 as cf08,cf209,cf213 as cf13,cf214 as cf14 from casefee2" & _
               " where cf201=" & CNULL(strSystem) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
               " and cf204='0' and cf205='0'" & _
               " and cf210=(select max(cf210) from casefee2 where cf201=" & CNULL(strSystem) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
               " and cf204='0' and cf205='0' and cf210<=" & strSrvDate(1) & ")"
      StrSQLa = StrSQLa & " Union " & _
               "select '5',cf01,cf02,cf03,'0','0',cf06,cf07,cf08,null,cf13,cf14 from casefee" & _
               " where cf01=" & CNULL(strSystem) & " and cf02=" & CNULL(strNation) & " and cf03=" & CNULL(strCaseProperty) & _
               " order by 1,2,3,4,5,6"
   End If
   PUB_GetCaseFee2SQL = StrSQLa
End Function

'取得案件之標準價及底價
'Modify By Sindy 2022/12/15 + Optional ByVal strCaseKind As String : 專利/商標種類
'Optional ByVal strIDentity As String : 案件屬性/身份種類
'Optional ByVal strCP140 As String : 接洽單編號
'Modify By Sindy 2023/2/7 + Optional ByVal strCRLType As String : 接洽單種類-1.國內 2.大至台
'                           , Optional ByVal strCP01 As String, Optional ByVal strCP02 As String, _
'                           Optional ByVal strCP03 As String, Optional ByVal strCP04 As String
'Modify By Sindy 2025/4/8 + Optional ByVal strCaseAttributes As String : 案件屬性
'Modify By Sindy 2025/8/26 +, Optional ByVal strFC As String: FC代理人
Public Function ClsPDGetCaseLowPrice(ByRef strSystem As String, ByRef strNation As String, ByRef strCaseProperty As String, _
   ByRef douStPrice As Double, ByRef douLowPrice As Double, _
   Optional ByVal strCaseKind As String, Optional ByVal strIDentity As String, Optional ByVal strCP140 As String, _
   Optional ByVal strCRLType As String, _
   Optional ByVal strCP01 As String, Optional ByVal strCP02 As String, _
   Optional ByVal strCP03 As String, Optional ByVal strCP04 As String, _
   Optional ByVal strCaseAttributes As String, Optional ByVal strFC As String) As Integer

Dim strSql As String, rsRecordset As New ADODB.Recordset
Dim RsTemp As New ADODB.Recordset
'Dim strCRL94 As String
'Dim strCF205 As String
'Dim strQuyCP01 As String 'Add By Sindy 2023/2/7

On Error GoTo ErrHand
   
'   If strCP140 <> "" Then
'      strSql = "select CRL01,CRL94,CRL81 from ConsultRecordList where CRL01='" & strCP140 & "'"
'      intI = 1
'      Set RsTemp = ClsLawReadRstMsg(intI, strSql)
'      If intI = 1 Then
'         '身份種類:ex:大個體,小個體...
'         strCRL94 = "" & RsTemp.Fields("CRL94").Value
'         'Modify By Sindy 2025/2/4 P大陸非"有"台灣專利說明書時,改抓案件屬性
'         If strSystem = "P" And strNation = "020" And strCRL94 <> "2" Then
'            strCRL94 = "" & RsTemp.Fields("CRL81").Value
'         End If
'         '2025/2/4 END
'      End If
'   End If
'   If strCRL94 <> "" Then
'      strCF205 = strCRL94
'   Else
'      strCF205 = strIDentity
'   End If
'
'   'Modify By Sindy 2023/2/7 抓代理人代碼,"有值"代表為大至台
'   If strCRLType = "" And strCP02 <> "" Then
'      If GetPrjPeopleNum6(strCP01 & "-" & strCP02 & "-" & strCP03 & "-" & strCP04) <> "" Then
'         strCRLType = "2" '接洽單種類-1.國內 2.大至台
'      End If
'   End If
'
'   strSql = ""
'   'Modify By Sindy 2022/12/15
'   'P大陸有台灣專利說明書
'   If strSystem = "P" And strNation = "020" And (strCRL94 = "2" Or strCRL94 = "") Then
'      strSql = "select '5',cf01,cf02,cf03,'0','0',cf06,cf07,cf08,null,cf13,cf14 from casefee where cf01=" & CNULL(strSystem) & " and cf02=" & _
'               CNULL(strNation) & " and cf03=" & CNULL(strCaseProperty)
'   Else '(以第一筆資料檢查費用及底價，費用啟始值之區主管1點權限由程式碼控制)
'      'Modify By Sindy 2023/2/7 調整大陸來台P案之價格檢查
'      '接洽記錄單若為外至台的接洽單,在檢查價格及抓標準價及底價時, 加入以下控制:
'      'P案增加CF201='MCP'，T案增加CF201='MCT'的語法
'      'Modify By Sindy 2023/2/8 + And strNation = "000"
'      If strCRLType = "2" And (strSystem = "P" Or strSystem = "T") And strNation = "000" Then '2.大至台
'         If strSystem = "P" Then
'            strQuyCP01 = "MCP"
'         Else
'            strQuyCP01 = "MCT"
'         End If
'         strSql = "select '1',cf201,cf202,cf203,cf204,cf205,cf206,cf207,cf208,cf209,cf213 as cf13,cf214 as cf14 from casefee2" & _
'                  " where cf201=" & CNULL(strQuyCP01) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
'                  " and cf204=" & CNULL(strCaseKind) & " and cf205=" & CNULL(strCF205) & _
'                  " and cf210=(select max(cf210) from casefee2 where cf201=" & CNULL(strQuyCP01) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
'                  " and cf204=" & CNULL(strCaseKind) & " and cf205=" & CNULL(strCF205) & " and cf210<=" & strSrvDate(1) & ")"
'         strSql = strSql & " Union " & _
'                  "select '2',cf201,cf202,cf203,cf204,cf205,cf206,cf207,cf208,cf209,cf213 as cf13,cf214 as cf14 from casefee2" & _
'                  " where cf201=" & CNULL(strQuyCP01) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
'                  " and cf204=" & CNULL(strCaseKind) & " and cf205='0'" & _
'                  " and cf210=(select max(cf210) from casefee2 where cf201=" & CNULL(strQuyCP01) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
'                  " and cf204=" & CNULL(strCaseKind) & " and cf205='0' and cf210<=" & strSrvDate(1) & ")"
'         strSql = strSql & " Union " & _
'                  "select '3',cf201,cf202,cf203,cf204,cf205,cf206,cf207,cf208,cf209,cf213 as cf13,cf214 as cf14 from casefee2" & _
'                  " where cf201=" & CNULL(strQuyCP01) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
'                  " and cf204='0' and cf205=" & CNULL(strCF205) & _
'                  " and cf210=(select max(cf210) from casefee2 where cf201=" & CNULL(strQuyCP01) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
'                  " and cf204='0' and cf205=" & CNULL(strCF205) & " and cf210<=" & strSrvDate(1) & ")"
'         strSql = strSql & " Union " & _
'                  "select '4',cf201,cf202,cf203,cf204,cf205,cf206,cf207,cf208,cf209,cf213 as cf13,cf214 as cf14 from casefee2" & _
'                  " where cf201=" & CNULL(strQuyCP01) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
'                  " and cf204='0' and cf205='0'" & _
'                  " and cf210=(select max(cf210) from casefee2 where cf201=" & CNULL(strQuyCP01) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
'                  " and cf204='0' and cf205='0' and cf210<=" & strSrvDate(1) & ")"
'      End If
'      If strSql <> "" Then strSql = strSql & " Union "
'      '2023/2/7 END
'      strSql = strSql & "select '1',cf201,cf202,cf203,cf204,cf205,cf206,cf207,cf208,cf209,cf213 as cf13,cf214 as cf14 from casefee2" & _
'               " where cf201=" & CNULL(strSystem) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
'               " and cf204=" & CNULL(strCaseKind) & " and cf205=" & CNULL(strCF205) & _
'               " and cf210=(select max(cf210) from casefee2 where cf201=" & CNULL(strSystem) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
'               " and cf204=" & CNULL(strCaseKind) & " and cf205=" & CNULL(strCF205) & " and cf210<=" & strSrvDate(1) & ")"
'      strSql = strSql & " Union " & _
'               "select '2',cf201,cf202,cf203,cf204,cf205,cf206,cf207,cf208,cf209,cf213 as cf13,cf214 as cf14 from casefee2" & _
'               " where cf201=" & CNULL(strSystem) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
'               " and cf204=" & CNULL(strCaseKind) & " and cf205='0'" & _
'               " and cf210=(select max(cf210) from casefee2 where cf201=" & CNULL(strSystem) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
'               " and cf204=" & CNULL(strCaseKind) & " and cf205='0' and cf210<=" & strSrvDate(1) & ")"
'      strSql = strSql & " Union " & _
'               "select '3',cf201,cf202,cf203,cf204,cf205,cf206,cf207,cf208,cf209,cf213 as cf13,cf214 as cf14 from casefee2" & _
'               " where cf201=" & CNULL(strSystem) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
'               " and cf204='0' and cf205=" & CNULL(strCF205) & _
'               " and cf210=(select max(cf210) from casefee2 where cf201=" & CNULL(strSystem) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
'               " and cf204='0' and cf205=" & CNULL(strCF205) & " and cf210<=" & strSrvDate(1) & ")"
'      strSql = strSql & " Union " & _
'               "select '4',cf201,cf202,cf203,cf204,cf205,cf206,cf207,cf208,cf209,cf213 as cf13,cf214 as cf14 from casefee2" & _
'               " where cf201=" & CNULL(strSystem) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
'               " and cf204='0' and cf205='0'" & _
'               " and cf210=(select max(cf210) from casefee2 where cf201=" & CNULL(strSystem) & " and cf202=" & CNULL(strNation) & " and cf203=" & CNULL(strCaseProperty) & _
'               " and cf204='0' and cf205='0' and cf210<=" & strSrvDate(1) & ")"
'      strSql = strSql & " Union " & _
'               "select '5',cf01,cf02,cf03,'0','0',cf06,cf07,cf08,null,cf13,cf14 from casefee" & _
'               " where cf01=" & CNULL(strSystem) & " and cf02=" & CNULL(strNation) & " and cf03=" & CNULL(strCaseProperty) & _
'               " order by 1,2,3,4,5,6"
'   End If
   'Modify By Sindy 2025/2/4 改Call共用Func
   strSql = PUB_GetCaseFee2SQL(strSystem, strNation, strCaseProperty, strCaseKind, strIDentity, strCP140, _
                               strCRLType, strCP01, strCP02, strCP03, strCP04, strCaseAttributes)
   If strSql = "" Then
      douStPrice = 0
      douLowPrice = 0
      ClsPDGetCaseLowPrice = 1
   Else
   '2025/2/4 END
      rsRecordset.CursorLocation = adUseClient
      rsRecordset.Open strSql, cnnConnection
      If rsRecordset.RecordCount > 0 Then
         rsRecordset.MoveFirst
         If IsNull(rsRecordset.Fields("cf13").Value) Then
            douStPrice = 0
         Else
            douStPrice = rsRecordset.Fields("cf13").Value
         End If
         If IsNull(rsRecordset.Fields("cf14").Value) Then
            douLowPrice = 0
         Else
            douLowPrice = rsRecordset.Fields("cf14").Value
         End If
         ClsPDGetCaseLowPrice = 1
      Else
         douStPrice = 0
         douLowPrice = 0
         ClsPDGetCaseLowPrice = 1
      End If
      rsRecordset.Close
   End If
   'Add By Sindy 2023/1/9 特殊的規則:CFP的電子及生化案件收費及點數標準
   'Modify By Sindy 2023/7/28 +, strCaseKind
   'Modify By Sindy 2025/8/26 +, strNation
   '                          +, strFC
   If SetSpecPricePoint(strSystem, strNation, strCaseProperty, strCaseAttributes, strCaseKind, , , douStPrice, douLowPrice, strFC) = True Then
      ClsPDGetCaseLowPrice = 1
   End If
   '2023/1/9 END
   
   Exit Function
   
ErrHand:
   ClsPDGetCaseLowPrice = -2
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function

'Modify By Sindy 2010/11/22
'Add By Cheng 2003/08/28
'比較點數與底價
'Modify By Sindy 2023/1/7 + strClerk : 智權人員
'Modify By Sindy 2022/11/4 + , Optional ByRef dblPorint As Double = 0 : 回傳,差多少點數
'Modify By Sindy 2022/12/15 + Optional ByVal strCaseKind As String : 專利/商標種類
'Optional ByVal strIDentity As String : 案件屬性/身份種類
'Optional ByVal strCP140 As String : 接洽單編號
'Optional ByRef m_ByRefMsg As String = "" : 回傳錯誤訊息 Add By Sindy 2023/1/7
'Optional ByVal intChkItem As Integer = 0 : 0.都檢查 1.檢查最高費用 Add By Sindy 2023/1/7
'Modify By Sindy 2022/12/30 + Optional bolChkFee As Boolean = False, Optional ByRef Fee As Long, Optional ByRef OfficialFee As Long
'Modify By Sindy 2023/2/7 + Optional ByVal strCRLType As String : 接洽單種類-1.國內 2.大至台
'                           Optional ByVal strCP01 As String, Optional ByVal strCP02 As String, _
'                           Optional ByVal strCP03 As String, Optional ByVal strCP04 As String
'Modify By Sindy 2025/4/8 + Optional ByVal strCaseAttributes As String : 案件屬性
'Modify By Sindy 2025/8/26 +, Optional ByVal strFC As String: FC代理人
Public Function ChkPointValue(strCF01 As String, strCF02 As String, strCF03 As String, strPointValue As String, strClerk As String, _
   Optional bolShowMsg As Boolean = True, Optional ByRef dblPorint As Double = 0, _
   Optional ByVal strCaseKind As String = "", Optional ByVal strIDentity As String = "", Optional ByVal strCP140 As String = "", _
   Optional bolChkFee As Boolean = False, Optional ByRef Fee As Long, Optional ByRef OfficialFee As Long, _
   Optional ByRef m_ByRefMsg As String = "", Optional ByVal intChkItem As Integer = 0, _
   Optional ByVal strCRLType As String, _
   Optional ByVal strCP01 As String, Optional ByVal strCP02 As String, _
   Optional ByVal strCP03 As String, Optional ByVal strCP04 As String, _
   Optional ByVal strCaseAttributes As String, Optional ByVal strFC As String) As Boolean
   
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset
Dim dblFreePoV As Double 'Add By Sindy 2010/3/23
Dim LongCF06 As Long, LongCF07 As Long, LongCF08 As Long
Dim dblCF13 As Double, dblCF14 As Double
'Dim strCRL94 As String, strCF205 As String
'Dim strQuyCP01 As String 'Add By Sindy 2023/2/7
Dim strAppl1 As String 'Add By Sindy 2024/5/23
   
   ChkPointValue = True
   m_ByRefMsg = ""
   
   'Add By Sindy 2022/12/30 排除不用檢查費用的人員
   If strClerk <> "" Then
      If Pub_GetSpecMan("應收帳款上限檢查排除") <> "" Then
         If InStr(Pub_GetSpecMan("應收帳款上限檢查排除"), strClerk) > 0 Then
            Exit Function
         End If
      End If
   End If
   '2022/12/30 END
   
   dblPorint = 0 'Add By Sindy 2022/11/4
   If strCF02 = "" Then strCF02 = "000"
   
'   'Modify By Sindy 2022/12/16
'   'StrSQLa = "Select * From CaseFee Where CF01='" & strCF01 & "' And CF02='" & strCF02 & "' And CF03='" & strCF03 & "' "
'   If strCP140 <> "" Then
'      strSql = "select CRL01,CRL94,CRL81 from ConsultRecordList where CRL01='" & strCP140 & "'"
'      intI = 1
'      Set RsTemp = ClsLawReadRstMsg(intI, strSql)
'      If intI = 1 Then
'         '身份種類:ex:大個體,小個體...
'         strCRL94 = "" & RsTemp.Fields("CRL94").Value
'         'Modify By Sindy 2025/2/4 P大陸非"有"台灣專利說明書時,改抓案件屬性
'         If strCF01 = "P" And strCF02 = "020" And strCRL94 <> "2" Then
'            strCRL94 = "" & RsTemp.Fields("CRL81").Value
'         End If
'         '2025/2/4 END
'      End If
'   End If
'   If strCRL94 <> "" Then
'      strCF205 = strCRL94
'   Else
'      strCF205 = strIDentity
'   End If
'
'   'Modify By Sindy 2023/2/7 抓代理人代碼,"有值"代表為大至台
'   If strCRLType = "" And strCP02 <> "" Then
'      If GetPrjPeopleNum6(strCP01 & "-" & strCP02 & "-" & strCP03 & "-" & strCP04) <> "" Then
'         strCRLType = "2" '接洽單種類-1.國內 2.大至台
'      End If
'   End If
'
'   StrSQLa = ""
'   'Modify By Sindy 2022/12/15
'   'P大陸有台灣專利說明書
'   If strCF01 = "P" And strCF02 = "020" And (strCRL94 = "2" Or strCRL94 = "") Then
'      StrSQLa = "select '5',cf01,cf02,cf03,'0','0',cf06,cf07,cf08,null,cf13,cf14 from casefee where cf01=" & CNULL(strCF01) & " and cf02=" & _
'               CNULL(strCF02) & " and cf03=" & CNULL(strCF03)
'   Else '(以第一筆資料檢查費用及底價，費用啟始值之區主管1點權限由程式碼控制)
'      'Modify By Sindy 2023/2/7 調整大陸來台P案之價格檢查
'      '接洽記錄單若為外至台的接洽單,在檢查價格及抓標準價及底價時, 加入以下控制:
'      'P案增加CF201='MCP'，T案增加CF201='MCT'的語法
'      'Modify By Sindy 2023/2/8 + And strCF02 = "000"
'      If strCRLType = "2" And (strCF01 = "P" Or strCF01 = "T") And strCF02 = "000" Then '2.大至台
'         If strCF01 = "P" Then
'            strQuyCP01 = "MCP"
'         Else
'            strQuyCP01 = "MCT"
'         End If
'         StrSQLa = "select '1',cf201,cf202,cf203,cf204,cf205,cf206 as cf06,cf207 as cf07,cf208 as cf08,cf209,cf213 as cf13,cf214 as cf14 from casefee2" & _
'                  " where cf201=" & CNULL(strQuyCP01) & " and cf202=" & CNULL(strCF02) & " and cf203=" & CNULL(strCF03) & _
'                  " and cf204=" & CNULL(strCaseKind) & " and cf205=" & CNULL(strCF205) & _
'                  " and cf210=(select max(cf210) from casefee2 where cf201=" & CNULL(strQuyCP01) & " and cf202=" & CNULL(strCF02) & " and cf203=" & CNULL(strCF03) & _
'                  " and cf204=" & CNULL(strCaseKind) & " and cf205=" & CNULL(strCF205) & " and cf210<=" & strSrvDate(1) & ")"
'         StrSQLa = StrSQLa & " Union " & _
'                  "select '2',cf201,cf202,cf203,cf204,cf205,cf206 as cf06,cf207 as cf07,cf208 as cf08,cf209,cf213 as cf13,cf214 as cf14 from casefee2" & _
'                  " where cf201=" & CNULL(strQuyCP01) & " and cf202=" & CNULL(strCF02) & " and cf203=" & CNULL(strCF03) & _
'                  " and cf204=" & CNULL(strCaseKind) & " and cf205='0'" & _
'                  " and cf210=(select max(cf210) from casefee2 where cf201=" & CNULL(strQuyCP01) & " and cf202=" & CNULL(strCF02) & " and cf203=" & CNULL(strCF03) & _
'                  " and cf204=" & CNULL(strCaseKind) & " and cf205='0' and cf210<=" & strSrvDate(1) & ")"
'         StrSQLa = StrSQLa & " Union " & _
'                  "select '3',cf201,cf202,cf203,cf204,cf205,cf206 as cf06,cf207 as cf07,cf208 as cf08,cf209,cf213 as cf13,cf214 as cf14 from casefee2" & _
'                  " where cf201=" & CNULL(strQuyCP01) & " and cf202=" & CNULL(strCF02) & " and cf203=" & CNULL(strCF03) & _
'                  " and cf204='0' and cf205=" & CNULL(strCF205) & _
'                  " and cf210=(select max(cf210) from casefee2 where cf201=" & CNULL(strQuyCP01) & " and cf202=" & CNULL(strCF02) & " and cf203=" & CNULL(strCF03) & _
'                  " and cf204='0' and cf205=" & CNULL(strCF205) & " and cf210<=" & strSrvDate(1) & ")"
'         StrSQLa = StrSQLa & " Union " & _
'                  "select '4',cf201,cf202,cf203,cf204,cf205,cf206 as cf06,cf207 as cf07,cf208 as cf08,cf209,cf213 as cf13,cf214 as cf14 from casefee2" & _
'                  " where cf201=" & CNULL(strQuyCP01) & " and cf202=" & CNULL(strCF02) & " and cf203=" & CNULL(strCF03) & _
'                  " and cf204='0' and cf205='0'" & _
'                  " and cf210=(select max(cf210) from casefee2 where cf201=" & CNULL(strQuyCP01) & " and cf202=" & CNULL(strCF02) & " and cf203=" & CNULL(strCF03) & _
'                  " and cf204='0' and cf205='0' and cf210<=" & strSrvDate(1) & ")"
'      End If
'      If StrSQLa <> "" Then StrSQLa = StrSQLa & " Union "
'      '2023/2/7 END
'      StrSQLa = StrSQLa & "select '1',cf201,cf202,cf203,cf204,cf205,cf206 as cf06,cf207 as cf07,cf208 as cf08,cf209,cf213 as cf13,cf214 as cf14 from casefee2" & _
'               " where cf201=" & CNULL(strCF01) & " and cf202=" & CNULL(strCF02) & " and cf203=" & CNULL(strCF03) & _
'               " and cf204=" & CNULL(strCaseKind) & " and cf205=" & CNULL(strCF205) & _
'               " and cf210=(select max(cf210) from casefee2 where cf201=" & CNULL(strCF01) & " and cf202=" & CNULL(strCF02) & " and cf203=" & CNULL(strCF03) & _
'               " and cf204=" & CNULL(strCaseKind) & " and cf205=" & CNULL(strCF205) & " and cf210<=" & strSrvDate(1) & ")"
'      StrSQLa = StrSQLa & " Union " & _
'               "select '2',cf201,cf202,cf203,cf204,cf205,cf206 as cf06,cf207 as cf07,cf208 as cf08,cf209,cf213 as cf13,cf214 as cf14 from casefee2" & _
'               " where cf201=" & CNULL(strCF01) & " and cf202=" & CNULL(strCF02) & " and cf203=" & CNULL(strCF03) & _
'               " and cf204=" & CNULL(strCaseKind) & " and cf205='0'" & _
'               " and cf210=(select max(cf210) from casefee2 where cf201=" & CNULL(strCF01) & " and cf202=" & CNULL(strCF02) & " and cf203=" & CNULL(strCF03) & _
'               " and cf204=" & CNULL(strCaseKind) & " and cf205='0' and cf210<=" & strSrvDate(1) & ")"
'      StrSQLa = StrSQLa & " Union " & _
'               "select '3',cf201,cf202,cf203,cf204,cf205,cf206 as cf06,cf207 as cf07,cf208 as cf08,cf209,cf213 as cf13,cf214 as cf14 from casefee2" & _
'               " where cf201=" & CNULL(strCF01) & " and cf202=" & CNULL(strCF02) & " and cf203=" & CNULL(strCF03) & _
'               " and cf204='0' and cf205=" & CNULL(strCF205) & _
'               " and cf210=(select max(cf210) from casefee2 where cf201=" & CNULL(strCF01) & " and cf202=" & CNULL(strCF02) & " and cf203=" & CNULL(strCF03) & _
'               " and cf204='0' and cf205=" & CNULL(strCF205) & " and cf210<=" & strSrvDate(1) & ")"
'      StrSQLa = StrSQLa & " Union " & _
'               "select '4',cf201,cf202,cf203,cf204,cf205,cf206 as cf06,cf207 as cf07,cf208 as cf08,cf209,cf213 as cf13,cf214 as cf14 from casefee2" & _
'               " where cf201=" & CNULL(strCF01) & " and cf202=" & CNULL(strCF02) & " and cf203=" & CNULL(strCF03) & _
'               " and cf204='0' and cf205='0'" & _
'               " and cf210=(select max(cf210) from casefee2 where cf201=" & CNULL(strCF01) & " and cf202=" & CNULL(strCF02) & " and cf203=" & CNULL(strCF03) & _
'               " and cf204='0' and cf205='0' and cf210<=" & strSrvDate(1) & ")"
'      StrSQLa = StrSQLa & " Union " & _
'               "select '5',cf01,cf02,cf03,'0','0',cf06,cf07,cf08,null,cf13,cf14 from casefee" & _
'               " where cf01=" & CNULL(strCF01) & " and cf02=" & CNULL(strCF02) & " and cf03=" & CNULL(strCF03) & _
'               " order by 1,2,3,4,5,6"
'   End If
   'Modify By Sindy 2025/2/4 改Call共用Func
   StrSQLa = PUB_GetCaseFee2SQL(strCF01, strCF02, strCF03, strCaseKind, strIDentity, strCP140, _
                               strCRLType, strCP01, strCP02, strCP03, strCP04, strCaseAttributes)
   If StrSQLa = "" Then
      Exit Function
   End If
   '2025/2/4 END
   rsA.CursorLocation = adUseClient
   rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
   If rsA.RecordCount > 0 Then
      '費用(起)
      If IsNull(rsA.Fields("cf06").Value) Then
         LongCF06 = 0
      Else
         LongCF06 = rsA.Fields("cf06").Value
      End If
      '費用(迄)
      If IsNull(rsA.Fields("cf07").Value) Then
         LongCF07 = 0
      Else
         LongCF07 = rsA.Fields("cf07").Value
      End If
      '規費
      If IsNull(rsA.Fields("cf08").Value) Then
         LongCF08 = 0
      Else
         LongCF08 = rsA.Fields("cf08").Value
      End If
      '標準價(點數)
      If IsNull(rsA.Fields("cf13").Value) Then
         dblCF13 = 0
      Else
         dblCF13 = rsA.Fields("cf13").Value
      End If
      '底價(點數)
      If IsNull(rsA.Fields("cf14").Value) Then
         dblCF14 = 0
      Else
         dblCF14 = rsA.Fields("cf14").Value
      End If
      
      'Modify By Sindy 2025/8/26
      If strCP01 & strCP02 & strCP03 & strCP04 <> "" Then
         '申請人1
         strAppl1 = GetPrjPeopleNum1(strCP01 & "-" & strCP02 & "-" & strCP03 & "-" & strCP04)
      End If
      '2025/8/26 END
      'Add By Sindy 2023/1/9 特殊的規則:CFP的電子及生化案件收費及點數標準
      'Modify By Sindy 2023/7/28 +, strCaseKind
      'Modify By Sindy 2025/8/26 +, strCF02
      '                          +, strFC, LongCF08
      Call SetSpecPricePoint(strCF01, strCF02, strCF03, strCaseAttributes, strCaseKind, LongCF06, LongCF07, dblCF13, dblCF14, strFC, LongCF08)
      '2023/1/9 END
      'Add By Sindy 2024/5/23 T註冊費增加報價資料維護
      If strCF01 = "T" And strCF03 = "717" And strCP01 & strCP02 & strCP03 & strCP04 <> "" Then
'         '申請人1
'         strAPPL1 = GetPrjPeopleNum1(strCP01 & "-" & strCP02 & "-" & strCP03 & "-" & strCP04)
         If strAppl1 <> "" Then
            '抓費用
            strSql = "select yf04,yf06+yf07 as fee from patentyearfee" & _
                     " where yf01='" & strCF02 & "' and yf02='" & strCF01 & "' and substr(yf03,1,8)='" & Left(strAppl1, 8) & "' and yf04='" & strCF03 & "'"
            intI = 1 'Add by Amy 2024/05/24 bug
            Set RsTemp = ClsLawReadRstMsg(intI, strSql)
            If intI = 1 Then
               If IsNull(RsTemp.Fields("fee").Value) Then
                  LongCF06 = 0
               Else
                  LongCF06 = RsTemp.Fields("fee").Value
               End If
            End If
         End If
      End If
      '2024/5/23 END
      
      'Modify By Sindy 2022/12/12 薛經理說智權部區主管多1000元扣答
      dblFreePoV = 0
      If Left(PUB_GetStaffST15(Trim(strClerk), "1"), 1) = "S" Then
          If GetDeptMan(PUB_GetStaffST15(Trim(strClerk), "1")) = Trim(strClerk) Then
             dblFreePoV = 1
          End If
      End If
      '2022/12/12 END
   
      'Modify By Sindy 2022/12/30 ClsPDGetCaseFee():取得案件之費用,此函數使用此段程式
      If bolChkFee = True Then
         'add by sonia 2014/7/16
         If Val(OfficialFee) = 0 And strCF02 <> "000" Then
            LongCF06 = LongCF06 - LongCF08
            LongCF07 = LongCF07 - LongCF08
         End If
         'end 2014/7/16
         
'         '智權部區主管多1000元扣答
'         If Left(PUB_GetStaffST15(Trim(strClerk), "1"), 1) = "S" Then
'             If GetDeptMan(PUB_GetStaffST15(Trim(strClerk), "1")) = Trim(strClerk) Then
'                'Modify By Sindy 2023/5/11
'                'Fee = Fee + 1000
'                If LongCF06 > 0 Then LongCF06 = LongCF06 - 1000
'                '2023/5/11 END
'             End If
'         End If
         
         If LongCF06 = 0 And LongCF07 = 0 Then
            'OK
         Else
            If Fee >= LongCF06 And Fee <= LongCF07 Then
               'OK
            Else
               '2011/10/18 MODIFY BY SONIA
               'ShowMsg MsgText(9164)
               '案件性質名稱
               strExc(10) = ""
               If strCF02 = "000" Then
                  Call ClsPDGetCasePropertyL(1, strCF01, strCF03, strExc(10))
               Else
                  Call ClsPDGetCasePropertyL(2, strCF01, strCF03, strExc(10))
               End If
               'Add By Sindy 2023/1/7
               'ShowMsg "[" & strExc(10) & "]" & MsgText(9164) & "，最低費用為 " & LongCF06 & "，最高費用為 " & LongCF07 & " "
               If intChkItem = 1 Then '檢查最高費用
                  'Modified by Morgan 2025/8/29
                  'If Fee > LongCF07 Then
                  If Fee > LongCF07 And LongCF07 > 0 Then
                  'end 2025/8/29
                     m_ByRefMsg = "[" & strExc(10) & "]" & MsgText(9164) & "，最低費用為 " & LongCF06 & "，最高費用為 " & LongCF07
                     ChkPointValue = False
                  End If
               ElseIf Fee < Val(LongCF06) - dblFreePoV Then 'Modify By Sindy 2023/5/15 +if
                  m_ByRefMsg = "[" & strExc(10) & "]" & MsgText(9164) & "，最低費用為 " & LongCF06 & "，最高費用為 " & LongCF07
                  ChkPointValue = False
               End If
               If bolShowMsg = True And m_ByRefMsg <> "" Then
                  ShowMsg m_ByRefMsg
               End If
               '2023/1/7 END
               '2011/10/18 END
            End If
         End If
      Else
      '2022/12/30 END
      
         'If Val("" & rsA("CF14").Value) > 0 Then
         If dblCF14 > 0 Then
'           'Add By Sindy 2010/3/23
'           dblFreePoV = 0
'           'Modify By Sindy 2022/12/2 Mark:薛經理說現在沒有此機制了
''           StrSQLa = "SELECT * FROM staff WHERE ST01='" & Trim(strClerk) & "' "
''           intI = 1
''           Set RsTemp = ClsLawReadRstMsg(intI, StrSQLa)
''           If intI = 1 Then
''              If Not IsNull(RsTemp("ST20")) Then
''                 If Left(Trim(RsTemp("ST20")), 1) = "4" Then dblFreePoV = 1
''                 If Left(Trim(RsTemp("ST20")), 1) = "3" Then dblFreePoV = 3
''              End If
''           End If
'           '2010/3/23 End
'           'Modify By Sindy 2022/12/12 薛經理說智權部區主管多1000元扣答
'           If Left(PUB_GetStaffST15(Trim(strClerk), "1"), 1) = "S" Then
'               If GetDeptMan(PUB_GetStaffST15(Trim(strClerk), "1")) = Trim(strClerk) Then
'                  dblFreePoV = 1
'               End If
'           End If
'           '2022/12/12 END
           
           'Modify By Sindy 2010/3/23
           'If Val("" & rsA("CF14").Value) > Val(strPointValue) Then
           'If Val("" & rsA("CF14").Value) > (Val(strPointValue) + dblFreePoV) Then
           If dblCF14 > (Val(strPointValue) + dblFreePoV) Then
           '2010/3/23 End
               'dblPorint = Val("" & rsA("CF14").Value) - (Val(strPointValue) + dblFreePoV) 'Add By Sindy 2022/11/4
               dblPorint = dblCF14 - (Val(strPointValue) + dblFreePoV) 'Add By Sindy 2022/11/4
               If bolShowMsg = True Then
                  'If MsgBox("您輸入的點數 (" & Val(strPointValue) & ") 低於底價 (" & Val("" & rsA("CF14").Value) & ")，請確認此客戶接洽單主管是否核示???", vbExclamation + vbYesNo) = vbNo Then
                  If MsgBox("您輸入的點數 (" & Val(strPointValue) & ") 低於底價 (" & dblCF14 & ")，請確認此客戶接洽單主管是否核示???", vbExclamation + vbYesNo) = vbNo Then
                     ChkPointValue = False
                  End If
               Else
                  ChkPointValue = False
               End If
           End If
         End If
      End If
   End If
   If rsA.State <> adStateClosed Then rsA.Close
   Set rsA = Nothing
End Function

'Add By Sindy 2023/1/9 特殊的規則:CFP的電子及生化案件收費及點數標準
'strSys : 系統別
'strCF03 : 案件性質
'strCaseAttributes : 案件屬性
'Modify By Sindy 2023/7/28 + , strCaseKind : 專利/商標種類
'longCF206=費用(起)
'longCF207=費用(迄)
'dblCF213=標準價(點數)
'dblCF214=底價(點數)
'Modify By Sindy 2025/8/26 +, strCF02 As String: 申請國家
'                          +, Optional ByVal strFC As String: FC代理人
'                          +, Optional ByRef longCF208 As Long: 規費
Public Function SetSpecPricePoint(strSys As String, strCF02 As String, strCF03 As String, strCaseAttributes As String, strCaseKind As String, _
Optional ByRef longCF206 As Long, Optional ByRef longCF207 As Long, _
Optional ByRef dblCF213 As Double, Optional ByRef dblCF214 As Double, _
Optional ByVal strFC As String, Optional ByRef longCF208 As Long) As Boolean
   
   SetSpecPricePoint = False
   If strSys = "CFP" Then
      '(1)2.電子案件：價格表中1.發明及2.新型之標準價調高8,000元，並可多作8點；底價暫不作調整。
      '讀出之CF13再加8即可。
      If strCaseAttributes = "2" Then
         If strCF03 = "101" Or strCF03 = "102" Then
            dblCF213 = CDbl(dblCF213) + 8
            SetSpecPricePoint = True
         End If
      '(2)3.生化案件：價格表中1.發明及2.新型之標準價及底價均調高8,000元，並可多作點數。
      '讀出之CF13再加8，CF14也要加8；讀出之CF06及CF07各加8000後再去做檢查。
      ElseIf strCaseAttributes = "3" Then
         If strCF03 = "101" Or strCF03 = "102" Then
            longCF206 = CLng(longCF206) + 8000
            longCF207 = CLng(longCF207) + 8000
            dblCF213 = CDbl(dblCF213) + 8
            dblCF214 = CDbl(dblCF214) + 8
            SetSpecPricePoint = True
         End If
      End If
      
   'Add By Sindy 2023/7/27
   '台灣專利舊案，專利種類=3設計時，若收文302改請新型時，底價是12000(9點)，即CF06改為12,000、CF14改為9去檢查。
   '收文存入進度檔之CP34也要存9。
   ElseIf strSys = "P" And strCaseKind = "3" And strCF03 = "302" Then
      longCF206 = 12000
      dblCF214 = 9
      SetSpecPricePoint = True
      '2023/7/27 END
      
   'Add By Sindy 2025/8/26
   '調降MCT特定代理人申請註冊收文管控底價事
   ElseIf strSys = "T" And strCF02 = "000" Then
      If Left(strFC, 6) = "Y52459" Then
         Select Case strCF03
            Case "101" '申請
               longCF206 = 3800
               longCF208 = 3000
               dblCF214 = 0.8
               SetSpecPricePoint = True
            Case "107" '跨類
               longCF206 = 3700
               longCF208 = 3000
               dblCF214 = 0.7
               SetSpecPricePoint = True
            Case "717" '註冊費
               longCF206 = 3800
               longCF208 = 2500
               dblCF214 = 1.3
               SetSpecPricePoint = True
         End Select
      ElseIf Left(strFC, 6) = "Y53288" Then
         Select Case strCF03
            Case "101", "107" '申請,跨類
               longCF206 = 3200
               longCF208 = 3000
               dblCF214 = 0.2
               SetSpecPricePoint = True
            Case "717" '註冊費
               longCF206 = 3200
               longCF208 = 2500
               dblCF214 = 0.7
               SetSpecPricePoint = True
         End Select
      End If
   End If
End Function
'2023/1/9 END

'設定User Data至Session
Public Function ClsPDSetUserData(ByRef strUserNum As String, ByRef strUserName As String, ByRef strGroup As String) As Boolean
Dim lngRt As Long, strUser As String * 100, a As String
Dim strSql As String, rsRecordset As New ADODB.Recordset

On Error GoTo ErrHand
lngRt = WNetGetUser("", strUser, 10)
'lngRt = 0
If lngRt = 0 Then
   strUserNum = UCase(MyTrim(strUser))
   'strUserNum = "74001"
   strSql = "select st04,st02,st11 from staff where upper(st01)=" + CNULL(strUserNum)
   rsRecordset.CursorLocation = adUseClient
   rsRecordset.Open strSql, cnnConnection
   If rsRecordset.RecordCount > 0 Then
      If rsRecordset.Fields(0) = "1" Then
         strSql = "begin " + _
            "select st02,st03,st05,st11 into user_data.user_name,user_data.user_department," + _
            "user_data.user_level,user_data.user_group from staff where upper(st01)=" + CNULL(strUserNum) + ";" + _
            "user_data.user_num:=" + CNULL(strUserNum) + ";" + _
            "end;"
         cnnConnection.Execute strSql
         strUserName = IIf(IsNull(rsRecordset.Fields(1)), "", rsRecordset.Fields(1))
         strGroup = IIf(IsNull(rsRecordset.Fields(2)), "", rsRecordset.Fields(2))
         ClsPDSetUserData = True
      Else
         ShowMsg MsgText(9165)
      End If
   Else
      ShowMsg MsgText(9166)
   End If
   rsRecordset.Close
Else
   ShowMsg MsgText(9167)
End If
Exit Function
ErrHand:
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function

'連接資料庫
Public Function ConnectToServer() As Boolean
On Error GoTo ErrHand
   frm990002.Show
   frm990002.Refresh
   Set cnnConnection = New ADODB.Connection
   cnnConnection.ConnectionTimeout = 60
   cnnConnection.Provider = IIf(strProvider <> "", strProvider, cProvider)
   cnnConnection.Properties("Data Source").Value = ServerName
   cnnConnection.Properties("User ID").Value = UserName
   cnnConnection.Properties("Password").Value = Password
   cnnConnection.Open
   ConnectToServer = True
   strSrvDate(1) = Format(ServerDate)
   strSrvDate(2) = Format(Val(strSrvDate(1)) - 19110000)
   
   'Unload frm990002
   Exit Function
ErrHand:
   'Unload frm990002
      'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function

'Add By Cheng 2003/07/11
'連接資料庫
Public Function ConnectToServer_1() As Boolean
On Error GoTo ErrHand
   ConnectToServer_1 = False
   If cnnConnection.State = adStateOpen Then cnnConnection.Close 'Added by Morgan 2017/4/25 若已連線要先斷線否則會虛增連線數
   Set cnnConnection = New ADODB.Connection
   cnnConnection.ConnectionTimeout = 60
   cnnConnection.Provider = IIf(strProvider <> "", strProvider, cProvider)
   If UCase(pub_strCommand) = "T" Then
      cnnConnection.Properties("Data Source").Value = "test"
   Else
      cnnConnection.Properties("Data Source").Value = ServerName
   End If
   cnnConnection.Properties("User ID").Value = UserName
   cnnConnection.Properties("Password").Value = Password
   cnnConnection.Open
   ConnectToServer_1 = True
   strSrvDate(1) = Format(ServerDate)
   strSrvDate(2) = Format(Val(strSrvDate(1)) - 19110000)
   
   Exit Function
ErrHand:
      'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function

'顯示About
Public Sub ShowAbout()
'   frm990001.Show vbModal
End Sub

'動態集之recordset
Public Function ClsPDReadRstD(ByRef strSql As String) As ADODB.Recordset
 Dim rsRecordset As New ADODB.Recordset
On Error GoTo ErrHand
   rsRecordset.CursorLocation = adUseClient
   rsRecordset.CursorType = adOpenDynamic
   rsRecordset.Open strSql, cnnConnection
   Set ClsPDReadRstD = rsRecordset
   If ClsPDReadRstD.BOF And ClsPDReadRstD.EOF Then ShowMsg MsgText(9211)
   Exit Function
ErrHand:
      'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function

'取得機關名稱
Public Function ClsPDGetGovName(ByRef strGov As String, ByRef strGovName As String) As Boolean
 Dim strSql As String, Rs As New ADODB.Recordset
On Error GoTo ErrHand
   strGovName = ""
   strSql = "select or02 from organization where or01='" + strGov + "'"
   Rs.CursorLocation = adUseClient
   Rs.Open strSql, cnnConnection
   If Not Rs.BOF And Not Rs.EOF Then
      strGovName = Rs.Fields!or02
      ClsPDGetGovName = True
   Else
      ShowMsg MsgText(9212)
      ClsPDGetGovName = False
   End If
   Exit Function
ErrHand:
      'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function

'取得部門名稱
Public Function ClsPDGetStaffDeptName(ByRef strSDNum As String, ByRef strSDName As String) As Boolean
 Dim strSql As String, rsRecordset As New ADODB.Recordset
On Error GoTo ErrHand
   strSDName = ""
   strSql = "select a0902 from acc090 where a0901='" + strSDNum + "'"
   rsRecordset.CursorLocation = adUseClient
   rsRecordset.Open strSql, cnnConnection
   If rsRecordset.BOF And rsRecordset.EOF Then
      ShowMsg MsgText(9213)
      ClsPDGetStaffDeptName = False
   Else
      strSDName = rsRecordset.Fields(0)
      ClsPDGetStaffDeptName = True
   End If
   Exit Function
ErrHand:
   ClsPDGetStaffDeptName = False
      'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function

'檢查本所案號號碼
Public Function ClsPDChkCaseNum(ByVal cp01 As String, ByVal cp02 As String) As Boolean
Dim strSql As String, rsRecordset As New ADODB.Recordset
On Error GoTo ErrHand
   strSql = "select au03 from autonumber where au01=" + CNULL(cp01) + " order by  au03 desc"
   rsRecordset.CursorLocation = adUseClient
   rsRecordset.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If rsRecordset.RecordCount > 0 Then
      'Added by Lydia 2020/03/23 排除LA-999999和TT-999999
      'modify by sonia 2021/2/8 再排除L-999999
      If (cp01 = "LA" Or cp01 = "TT" Or cp01 = "L") And cp02 = "999999" Then
           ClsPDChkCaseNum = False
      'add by sonia 2022/7/13 再排除L-888888
      ElseIf cp01 = "L" And cp02 = "888888" Then
           ClsPDChkCaseNum = False
      'end 2022/7/13
      Else
      'end 2020/03/23
            'add by sonia 2021/2/18
            If cp01 = "TF" Then
               If Val(rsRecordset.Fields!au03) - Val(Left(cp02, 5)) < 0 Then
                  ShowMsg MsgText(9214)
                  ClsPDChkCaseNum = True
               Else
                  ClsPDChkCaseNum = False
               End If
            'end 2021/2/18
            ElseIf Val(rsRecordset.Fields!au03) - Val(cp02) < 0 Then
               ShowMsg MsgText(9214)
               ClsPDChkCaseNum = True
            Else
               ClsPDChkCaseNum = False
            End If
      End If 'Added by Lydia 2020/03/23
   Else
      ShowMsg MsgText(9214)
      ClsPDChkCaseNum = True
   End If
   rsRecordset.Close
   Exit Function
ErrHand:
      'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function

'檢查本所案號是否存在
Public Function ClsPDCheckIsExistCaseNum(ByRef intKind As Integer, ByRef strlc As String, ByRef MSG As String) As Boolean
 Dim strSql As String, rsRecordset As New ADODB.Recordset
On Error GoTo ErrHand
   Select Case intKind
      Case 1
         strSql = "select lc11 from lawcase where " & ChgLawcase(strlc)
      Case 2
         strSql = "select hc05 from hirecase where " & ChgHirecase(strlc)
   End Select
   'edit by nickc 2007/04/18
   'rsRecordset.Open strSQL, cnnConnection
   rsRecordset.CursorLocation = adUseClient
   rsRecordset.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If rsRecordset.RecordCount > 0 Then
      MSG = MsgText(9215) + strlc + MsgText(9216)
      ClsPDCheckIsExistCaseNum = False
   Else
      MSG = MsgText(9215) + strlc + MsgText(9217)
      ClsPDCheckIsExistCaseNum = True
   End If
   rsRecordset.Close
   Exit Function
ErrHand:
      'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function

'取得所屬區域
Public Function ClsPDGetStaffArea(ByRef strSDNum As String, ByRef strSDName As String) As Boolean
 Dim strSql As String, rsRecordset As New ADODB.Recordset
On Error GoTo ErrHand
   strSDName = ""
   strSql = "select st03 from staff  where st01='" + strSDNum + "'"
   rsRecordset.CursorLocation = adUseClient
   rsRecordset.Open strSql, cnnConnection
   If rsRecordset.BOF And rsRecordset.EOF Then
      ShowMsg MsgText(9218)
      ClsPDGetStaffArea = False
   Else
     strSDName = rsRecordset.Fields(0)
     ClsPDGetStaffArea = True
   End If
   Exit Function
ErrHand:
   ClsPDGetStaffArea = False
      'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function

''Cls011  nickc 2007/02/05 搬
''讀取解除期限資料
'Public Function Cls011ReadRelieveDeadlineRst(ByRef strCode1 As String, ByRef strCode2 As String, ByRef strCode3 As String, ByRef strCode4 As String) As ADODB.Recordset
'Dim strSql As String, rsRecordset As New ADODB.Recordset
''edit by nickc 2007/02/05 不用 dll 了
''Dim objPublicData As Object
'
'On Error GoTo ErrHand
''edit by nickc 2007/02/05 不用 dll 了
''Set objPublicData = CreateObject("prjTaieDll.clsPublicData")
'strSql = "select " & SQLDate("cp05") & " 來函收文日,decode(np07," + CNULL(大陸國家代號) + ",cpm04,cpm03) 下一程序," & SQLDate("np08") & " 本所期限," & SQLDate("np09") & " 法定期限,staff.st02 承辦人,staff1.st02 智權人員,np13 機關文號,np14 相關人,np01,np07,dbms_rowid.rowid_to_restricted(nextprogress.rowid,0) rid from caseprogress,nextprogress,casepropertymap,staff,staff staff1 where np02=cpm01 and np07=cpm02 and cp14=staff.st01(+) and np10=staff1.st01(+) and cp01=np02 and cp02=np03 and cp03=np04 and cp04=np05 and np06 is null and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + " and cp09=np01"
''edit by nickc 2007/02/05 不用 dll 了
''Set ReadRelieveDeadlineRst = objPublicData.ReadRst(strSQL)
'Set Cls011ReadRelieveDeadlineRst = ClsPDReadRst(strSql)
''Set objPublicData = Nothing
'Exit Function
'ErrHand:
''edit by nickc 2007/02/05 不用 dll 了
''Set objPublicData = Nothing
'   'edit by nickc 2007/02/05
'   'ErrorLog
'   MsgBox Err.Description
'End Function

'讀取取消收文資料
Public Function Cls011ReadCancelReceivedDayRst(ByRef strCode1 As String, ByRef strCode2 As String, ByRef strCode3 As String, ByRef strCode4 As String) As ADODB.Recordset
Dim strSql As String, rsRecordset As New ADODB.Recordset
'edit by nickc 2007/02/05 不用 dll 了
'Dim objPublicData As Object
'Add By Cheng 2002/01/14
Dim rs1 As New ADODB.Recordset

On Error GoTo ErrHand
'edit by nickc 2007/02/05 不用 dll 了
'Set objPublicData = CreateObject("prjTaieDll.clsPublicData")
'Add By Cheng 2002/01/14
'若案件性質為"不續辦"或"閉卷"的資料不抓(各系統之代號不同)
If rs1.State <> adStateClosed Then rs1.Close
Set rs1 = Nothing
rs1.CursorLocation = adUseClient
rs1.Open "Select SK02 From SystemKind Where SK01 = '" & "" & strCode1 & "'", _
         cnnConnection, adOpenStatic, adLockReadOnly
If rs1.RecordCount > 0 Then
   Select Case rs1.Fields(0).Value
   '專利或專利服務
   Case "1", "5"
      '911024 nick 取消收文應該為 null ，只有取消收文會用到
      'strSQL = "select cp09 收文號," & SQLDate("cp05") & " 收文日,decode(cp10," + CNULL(大陸國家代號) + ",cpm04,cpm03) 案件性質,staff.st02 智權人員,staff1.st02 承辦人," & SQLDate("cp06") & " 本所期限," & SQLDate("cp07") & " 法定期限," & SQLDate("cp57") & " 取消收文日 " & _
               " from caseprogress,casepropertymap,staff,staff staff1 " & _
               " where cp01=cpm01 and cp10=cpm02 and cp13=staff.st01(+) and cp14=staff1.st01(+) and cp27 is null and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + " and substr(cp09,1,1) in (" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")" & _
               " And (CP10 <> '907' And CP10 <> '913')"
      '92.1.12 MODIFY BY SONIA 取消發文日的限制
      'strSQL = "select cp09 收文號," & SQLDate("cp05") & " 收文日,decode(cp10," + CNULL(大陸國家代號) + ",cpm04,cpm03) 案件性質,staff.st02 智權人員,staff1.st02 承辦人," & SQLDate("cp06") & " 本所期限," & SQLDate("cp07") & " 法定期限," & SQLDate("cp57") & " 取消收文日 " & _
      '         " from caseprogress,casepropertymap,staff,staff staff1 " & _
      '         " where cp01=cpm01 and cp10=cpm02 and cp13=staff.st01(+) and cp14=staff1.st01(+) and cp27 is null and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + " and substr(cp09,1,1) in (" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")" & _
      '         " And (CP10 <> '907' And CP10 <> '913') and cp57 is null "
      '92.7.29 MODIFY BY SONIA 增加顯示發文日
      'strSQL = "select cp09 收文號," & SQLDate("cp05") & " 收文日,decode(cp10," + CNULL(大陸國家代號) + ",cpm04,cpm03) 案件性質,staff.st02 智權人員,staff1.st02 承辦人," & SQLDate("cp06") & " 本所期限," & SQLDate("cp07") & " 法定期限," & SQLDate("cp57") & " 取消收文日 " & _
      '         " from caseprogress,casepropertymap,staff,staff staff1 " & _
      '         " where cp01=cpm01 and cp10=cpm02 and cp13=staff.st01(+) and cp14=staff1.st01(+) and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + " and substr(cp09,1,1) in (" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")" & _
      '         " And (CP10 <> '907' And CP10 <> '913') and cp57 is null "
      
      'Modify by Morgan 2007/2/7
      'strSQL = "select cp09 收文號," & SQLDate("cp05") & " 收文日,decode(cp10," + CNULL(大陸國家代號) + ",cpm04,cpm03) 案件性質,staff.st02 智權人員,staff1.st02 承辦人," & SQLDate("cp06") & " 本所期限," & SQLDate("cp07") & " 法定期限," & SQLDate("cp27") & " 發文日," & SQLDate("cp57") & " 取消收文日 " & _
               " from caseprogress,casepropertymap,staff,staff staff1 " & _
               " where cp01=cpm01 and cp10=cpm02 and cp13=staff.st01(+) and cp14=staff1.st01(+) and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + " and substr(cp09,1,1) in (" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")" & _
               " And (CP10 <> '907' And CP10 <> '913') and cp57 is null "
      'Modified by Lydia 2018/06/05 修改顯示案件性質
      'strSql = "select cp09 收文號," & SQLDate("cp05") & " 收文日,decode(pa09," + CNULL(大陸國家代號) + ",cpm04,cpm03) 案件性質,staff.st02 智權人員,staff1.st02 承辦人," & SQLDate("cp06") & " 本所期限," & SQLDate("cp07") & " 法定期限," & SQLDate("cp27") & " 發文日," & SQLDate("cp57") & " 取消收文日 " & _
               " from caseprogress,casepropertymap,staff,staff staff1,patent " & _
               " where cp01=cpm01 and cp10=cpm02 and cp13=staff.st01(+) and cp14=staff1.st01(+) and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + " and substr(cp09,1,1) in (" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")" & _
               " And (CP10 <> '907' And CP10 <> '913') and cp57 is null and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04"
      'Modifid by Lydia 2023/07/06 +服務業務檔
      'strSql = "select cp09 收文號," & SQLDate("cp05") & " 收文日,decode(pa09,'000',CPM03,CPM04) 案件性質,staff.st02 智權人員,staff1.st02 承辦人," & SQLDate("cp06") & " 本所期限," & SQLDate("cp07") & " 法定期限," & SQLDate("cp27") & " 發文日," & SQLDate("cp57") & " 取消收文日 " & _
               " from caseprogress,casepropertymap,staff,staff staff1,patent " & _
               " where cp01=cpm01 and cp10=cpm02 and cp13=staff.st01(+) and cp14=staff1.st01(+) and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + " and substr(cp09,1,1) in (" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")" & _
               " And (CP10 <> '907' And CP10 <> '913') and cp57 is null and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04"
      strSql = "select cp09 收文號," & SQLDate("cp05") & " 收文日,decode(nvl(pa09,sp09),'000',CPM03,CPM04) 案件性質,staff.st02 智權人員,staff1.st02 承辦人," & SQLDate("cp06") & " 本所期限," & SQLDate("cp07") & " 法定期限," & SQLDate("cp27") & " 發文日," & SQLDate("cp57") & " 取消收文日 " & _
               " from caseprogress,casepropertymap,staff,staff staff1,patent,servicepractice " & _
               " where cp01=cpm01 and cp10=cpm02 and cp13=staff.st01(+) and cp14=staff1.st01(+) and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + " and substr(cp09,1,1) in (" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")" & _
               " And (CP10 <> '907' And CP10 <> '913') and cp57 is null and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04 and cp01=sp01(+) and cp02=sp02(+) and cp03=sp03(+) and cp04=sp04(+)"
      'End 2007/2/7
      
      '92.7.29 END
      '92.1.12 END
   '商標或商標服務
   Case "2", "6"
      '911024 nick 取消收文應該為 null ，只有取消收文會用到
      'strSQL = "select cp09 收文號," & SQLDate("cp05") & " 收文日,decode(cp10," + CNULL(大陸國家代號) + ",cpm04,cpm03) 案件性質,staff.st02 智權人員,staff1.st02 承辦人," & SQLDate("cp06") & " 本所期限," & SQLDate("cp07") & " 法定期限," & SQLDate("cp57") & " 取消收文日 " & _
               " from caseprogress,casepropertymap,staff,staff staff1 " & _
               " where cp01=cpm01 and cp10=cpm02 and cp13=staff.st01(+) and cp14=staff1.st01(+) and cp27 is null and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + " and substr(cp09,1,1) in (" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")" & _
               " And (CP10 <> '703' And CP10 <> '704')"
      '92.1.12 MODIFY BY SONIA 取消發文日的限制
      'strSQL = "select cp09 收文號," & SQLDate("cp05") & " 收文日,decode(cp10," + CNULL(大陸國家代號) + ",cpm04,cpm03) 案件性質,staff.st02 智權人員,staff1.st02 承辦人," & SQLDate("cp06") & " 本所期限," & SQLDate("cp07") & " 法定期限," & SQLDate("cp57") & " 取消收文日 " & _
      '         " from caseprogress,casepropertymap,staff,staff staff1 " & _
      '         " where cp01=cpm01 and cp10=cpm02 and cp13=staff.st01(+) and cp14=staff1.st01(+) and cp27 is null and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + " and substr(cp09,1,1) in (" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")" & _
      '         " And (CP10 <> '703' And CP10 <> '704') and cp57 is null "
      '92.7.29 MODIFY BY SONIA 增加顯示發文日
      'strSQL = "select cp09 收文號," & SQLDate("cp05") & " 收文日,decode(cp10," + CNULL(大陸國家代號) + ",cpm04,cpm03) 案件性質,staff.st02 智權人員,staff1.st02 承辦人," & SQLDate("cp06") & " 本所期限," & SQLDate("cp07") & " 法定期限," & SQLDate("cp57") & " 取消收文日 " & _
      '         " from caseprogress,casepropertymap,staff,staff staff1 " & _
      '         " where cp01=cpm01 and cp10=cpm02 and cp13=staff.st01(+) and cp14=staff1.st01(+) and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + " and substr(cp09,1,1) in (" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")" & _
      '         " And (CP10 <> '703' And CP10 <> '704') and cp57 is null "
      
      'Modify by Morgan 2007/2/7
      'strSQL = "select cp09 收文號," & SQLDate("cp05") & " 收文日,decode(cp10," + CNULL(大陸國家代號) + ",cpm04,cpm03) 案件性質,staff.st02 智權人員,staff1.st02 承辦人," & SQLDate("cp06") & " 本所期限," & SQLDate("cp07") & " 法定期限," & SQLDate("cp27") & " 發文日," & SQLDate("cp57") & " 取消收文日 " & _
               " from caseprogress,casepropertymap,staff,staff staff1 " & _
               " where cp01=cpm01 and cp10=cpm02 and cp13=staff.st01(+) and cp14=staff1.st01(+) and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + " and substr(cp09,1,1) in (" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")" & _
               " And (CP10 <> '703' And CP10 <> '704') and cp57 is null "
      'Modified by Lydia 2018/06/05 修改顯示案件性質
      'strSql = "select cp09 收文號," & SQLDate("cp05") & " 收文日,decode(tm10," + CNULL(大陸國家代號) + ",cpm04,cpm03) 案件性質,staff.st02 智權人員,staff1.st02 承辦人," & SQLDate("cp06") & " 本所期限," & SQLDate("cp07") & " 法定期限," & SQLDate("cp27") & " 發文日," & SQLDate("cp57") & " 取消收文日 " & _
               " from caseprogress,casepropertymap,staff,staff staff1,trademark " & _
               " where cp01=cpm01 and cp10=cpm02 and cp13=staff.st01(+) and cp14=staff1.st01(+) and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + " and substr(cp09,1,1) in (" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")" & _
               " And (CP10 <> '703' And CP10 <> '704') and cp57 is null and tm01(+)=cp01 and tm02(+)=cp02 and tm03(+)=cp03 and tm04(+)=cp04"
      'Modifid by Lydia 2023/07/06 +服務業務檔
      'strSql = "select cp09 收文號," & SQLDate("cp05") & " 收文日,decode(tm10,'000',CPM03,CPM04) 案件性質,staff.st02 智權人員,staff1.st02 承辦人," & SQLDate("cp06") & " 本所期限," & SQLDate("cp07") & " 法定期限," & SQLDate("cp27") & " 發文日," & SQLDate("cp57") & " 取消收文日 " & _
               " from caseprogress,casepropertymap,staff,staff staff1,trademark " & _
               " where cp01=cpm01 and cp10=cpm02 and cp13=staff.st01(+) and cp14=staff1.st01(+) and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + " and substr(cp09,1,1) in (" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")" & _
               " And (CP10 <> '703' And CP10 <> '704') and cp57 is null and tm01(+)=cp01 and tm02(+)=cp02 and tm03(+)=cp03 and tm04(+)=cp04"
      strSql = "select cp09 收文號," & SQLDate("cp05") & " 收文日,decode(nvl(tm10,sp09),'000',CPM03,CPM04) 案件性質,staff.st02 智權人員,staff1.st02 承辦人," & SQLDate("cp06") & " 本所期限," & SQLDate("cp07") & " 法定期限," & SQLDate("cp27") & " 發文日," & SQLDate("cp57") & " 取消收文日 " & _
               " from caseprogress,casepropertymap,staff,staff staff1,trademark,servicepractice " & _
               " where cp01=cpm01 and cp10=cpm02 and cp13=staff.st01(+) and cp14=staff1.st01(+) and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + " and substr(cp09,1,1) in (" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")" & _
               " And (CP10 <> '703' And CP10 <> '704') and cp57 is null and tm01(+)=cp01 and tm02(+)=cp02 and tm03(+)=cp03 and tm04(+)=cp04 and cp01=sp01(+) and cp02=sp02(+) and cp03=sp03(+) and cp04=sp04(+)"
      'End 2007/2/7
      
      '92.7.29 END
      '92.1.12 END
   '法務顧問或法務顧問服務
   Case Else
      '911024 nick 取消收文應該為 null ，只有取消收文會用到
      'strSQL = "select cp09 收文號," & SQLDate("cp05") & " 收文日,decode(cp10," + CNULL(大陸國家代號) + ",cpm04,cpm03) 案件性質,staff.st02 智權人員,staff1.st02 承辦人," & SQLDate("cp06") & " 本所期限," & SQLDate("cp07") & " 法定期限," & SQLDate("cp57") & " 取消收文日 " & _
               " from caseprogress,casepropertymap,staff,staff staff1 " & _
               " where cp01=cpm01 and cp10=cpm02 and cp13=staff.st01(+) and cp14=staff1.st01(+) and cp27 is null and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + " and substr(cp09,1,1) in (" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")" & _
               " And (CP10 <> '998' And CP10 <> '999')"
      '92.1.12 MODIFY BY SONIA 取消發文日的限制
      'strSQL = "select cp09 收文號," & SQLDate("cp05") & " 收文日,decode(cp10," + CNULL(大陸國家代號) + ",cpm04,cpm03) 案件性質,staff.st02 智權人員,staff1.st02 承辦人," & SQLDate("cp06") & " 本所期限," & SQLDate("cp07") & " 法定期限," & SQLDate("cp57") & " 取消收文日 " & _
      '         " from caseprogress,casepropertymap,staff,staff staff1 " & _
      '         " where cp01=cpm01 and cp10=cpm02 and cp13=staff.st01(+) and cp14=staff1.st01(+) and cp27 is null and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + " and substr(cp09,1,1) in (" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")" & _
      '         " And (CP10 <> '998' And CP10 <> '999') and cp57 is null "
      '92.7.29 MODIFY BY SONIA 增加顯示發文日
      'strSQL = "select cp09 收文號," & SQLDate("cp05") & " 收文日,decode(cp10," + CNULL(大陸國家代號) + ",cpm04,cpm03) 案件性質,staff.st02 智權人員,staff1.st02 承辦人," & SQLDate("cp06") & " 本所期限," & SQLDate("cp07") & " 法定期限," & SQLDate("cp57") & " 取消收文日 " & _
      '         " from caseprogress,casepropertymap,staff,staff staff1 " & _
      '         " where cp01=cpm01 and cp10=cpm02 and cp13=staff.st01(+) and cp14=staff1.st01(+) and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + " and substr(cp09,1,1) in (" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")" & _
      '         " And (CP10 <> '998' And CP10 <> '999') and cp57 is null "
      'Modify by Morgan 2009/7/13 +995,996
      'Modified by Lydia 2018/06/05 修改顯示案件性質
      'strSql = "select cp09 收文號," & SQLDate("cp05") & " 收文日,decode(cp10," + CNULL(大陸國家代號) + ",cpm04,cpm03) 案件性質,staff.st02 智權人員,staff1.st02 承辦人," & SQLDate("cp06") & " 本所期限," & SQLDate("cp07") & " 法定期限," & SQLDate("cp27") & " 發文日," & SQLDate("cp57") & " 取消收文日 " & _
               " from caseprogress,casepropertymap,staff,staff staff1 " & _
               " where cp01=cpm01 and cp10=cpm02 and cp13=staff.st01(+) and cp14=staff1.st01(+) and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + " and substr(cp09,1,1) in (" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")" & _
               " And (CP10 <> '998' And CP10 <> '995' And CP10 <> '996' And CP10 <> '999') and cp57 is null "
      'Modified by Lydia 2023/07/06 debug
      'strSql = "select cp09 收文號," & SQLDate("cp05") & " 收文日,decode(cp10,'000',CPM03,CPM04) 案件性質,staff.st02 智權人員,staff1.st02 承辦人," & SQLDate("cp06") & " 本所期限," & SQLDate("cp07") & " 法定期限," & SQLDate("cp27") & " 發文日," & SQLDate("cp57") & " 取消收文日 " & _
               " from caseprogress,casepropertymap,staff,staff staff1 " & _
               " where cp01=cpm01 and cp10=cpm02 and cp13=staff.st01(+) and cp14=staff1.st01(+) and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + " and substr(cp09,1,1) in (" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")" & _
               " And (CP10 <> '998' And CP10 <> '995' And CP10 <> '996' And CP10 <> '999') and cp57 is null "
      strSql = "select cp09 收文號," & SQLDate("cp05") & " 收文日,decode(nvl(sp09,nvl(lc15,'000')),'000',CPM03,CPM04) 案件性質,staff.st02 智權人員,staff1.st02 承辦人," & SQLDate("cp06") & " 本所期限," & SQLDate("cp07") & " 法定期限," & SQLDate("cp27") & " 發文日," & SQLDate("cp57") & " 取消收文日 " & _
               " from caseprogress,casepropertymap,staff,staff staff1,servicepractice,lawcase,hirecase " & _
               " where cp01=cpm01 and cp10=cpm02 and cp13=staff.st01(+) and cp14=staff1.st01(+) and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + " and substr(cp09,1,1) in (" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")" & _
               " And (CP10 <> '998' And CP10 <> '995' And CP10 <> '996' And CP10 <> '999') and cp57 is null " & _
               " and cp01=sp01(+) and cp02=sp02(+) and cp03=sp03(+) and cp04=sp04(+) and cp01=lc01(+) and cp02=lc02(+) and cp03=lc03(+) and cp04=lc04(+) and cp01=hc01(+) and cp02=hc02(+) and cp03=hc03(+) and cp04=hc04(+)"
      '92.7.29 END
      '92.1.12 END
   End Select
Else
   '911024 nick 取消收文應該為 null ，只有取消收文會用到
   'strSQL = "select cp09 收文號," & SQLDate("cp05") & " 收文日,decode(cp10," + CNULL(大陸國家代號) + ",cpm04,cpm03) 案件性質,staff.st02 智權人員,staff1.st02 承辦人," & SQLDate("cp06") & " 本所期限," & SQLDate("cp07") & " 法定期限," & SQLDate("cp57") & " 取消收文日 from caseprogress,casepropertymap,staff,staff staff1 where cp01=cpm01 and cp10=cpm02 and cp13=staff.st01(+) and cp14=staff1.st01(+) and cp27 is null and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + " and substr(cp09,1,1) in (" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")"
   '92.1.12 MODIFY BY SONIA 取消發文日的限制
   'strSQL = "select cp09 收文號," & SQLDate("cp05") & " 收文日,decode(cp10," + CNULL(大陸國家代號) + ",cpm04,cpm03) 案件性質,staff.st02 智權人員,staff1.st02 承辦人," & SQLDate("cp06") & " 本所期限," & SQLDate("cp07") & " 法定期限," & SQLDate("cp57") & " 取消收文日 from caseprogress,casepropertymap,staff,staff staff1 where cp01=cpm01 and cp10=cpm02 and cp13=staff.st01(+) and cp14=staff1.st01(+) and cp27 is null and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + " and substr(cp09,1,1) in (" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")  and cp57 is null "
  '92.7.29 MODIFY BY SONIA 增加顯示發文日
   'strSQL = "select cp09 收文號," & SQLDate("cp05") & " 收文日,decode(cp10," + CNULL(大陸國家代號) + ",cpm04,cpm03) 案件性質,staff.st02 智權人員,staff1.st02 承辦人," & SQLDate("cp06") & " 本所期限," & SQLDate("cp07") & " 法定期限," & SQLDate("cp57") & " 取消收文日 from caseprogress,casepropertymap,staff,staff staff1 where cp01=cpm01 and cp10=cpm02 and cp13=staff.st01(+) and cp14=staff1.st01(+) and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + " and substr(cp09,1,1) in (" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")  and cp57 is null "
   'Modified by Lydia 2018/06/05 修改顯示案件性質
   'strSql = "select cp09 收文號," & SQLDate("cp05") & " 收文日,decode(cp10," + CNULL(大陸國家代號) + ",cpm04,cpm03) 案件性質,staff.st02 智權人員,staff1.st02 承辦人," & SQLDate("cp06") & " 本所期限," & SQLDate("cp07") & " 法定期限," & SQLDate("cp27") & " 發文日," & SQLDate("cp57") & " 取消收文日 from caseprogress,casepropertymap,staff,staff staff1 where cp01=cpm01 and cp10=cpm02 and cp13=staff.st01(+) and cp14=staff1.st01(+) and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + " and substr(cp09,1,1) in (" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")  and cp57 is null "
   strSql = "select cp09 收文號," & SQLDate("cp05") & " 收文日,decode(cp10,'000',CPM03,CPM04) 案件性質,staff.st02 智權人員,staff1.st02 承辦人," & SQLDate("cp06") & " 本所期限," & SQLDate("cp07") & " 法定期限," & SQLDate("cp27") & " 發文日," & SQLDate("cp57") & " 取消收文日 from caseprogress,casepropertymap,staff,staff staff1 where cp01=cpm01 and cp10=cpm02 and cp13=staff.st01(+) and cp14=staff1.st01(+) and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + " and substr(cp09,1,1) in (" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")  and cp57 is null "
   '92.7.29 END
   '92.1.12 END
End If
'2008/9/17 ADD BY SONIA
strSql = strSql & " ORDER BY CP05 DESC,CP09 DESC"
'2008/9/17 END
If rs1.State <> adStateClosed Then rs1.Close
Set rs1 = Nothing

'strSQL = "select cp09 收文號,substr(cp05,1,4)-1911||'/'||substr(cp05,5,2)||'/'||substr(cp05,7,2) 收文日,decode(cp10," + CNULL(大陸國家代號) + ",cpm04,cpm03) 案件性質,staff.st02 智權人員,staff1.st02 承辦人,decode(cp06,null,'',substr(cp06,1,4)-1911||'/'||substr(cp06,5,2)||'/'||substr(cp06,7,2)) 本所期限,decode(cp07,null,'',substr(cp07,1,4)-1911||'/'||substr(cp07,5,2)||'/'||substr(cp07,7,2)) 法定期限,decode(cp57,null,'',substr(cp57,1,4)-1911||'/'||substr(cp57,5,2)||'/'||substr(cp57,7,2)) 取消收文日 from caseprogress,casepropertymap,staff,staff staff1 where cp01=cpm01 and cp10=cpm02 and cp13=staff.st01(+) and cp14=staff1.st01(+) and cp27 is null and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + " and substr(cp09,1,1) in (" + CNULL(接洽記錄單) + "," + CNULL(內部收文) + ")"
'edit by nickc 2007/02/05 不用 dll 了
'Set ReadCancelReceivedDayRst = objPublicData.ReadRst(strSQL)
Set Cls011ReadCancelReceivedDayRst = ClsPDReadRst(strSql)
'Set objPublicData = Nothing
Exit Function
ErrHand:
'edit by nickc 2007/02/05 不用 dll 了
'Set objPublicData = Nothing
   'edit by nickc 2007/02/05
   'ErrorLog
   MsgBox Err.Description
End Function

'讀取解除期限原因
Public Function Cls011ReadReasonOfRelief(ByRef strReasonNo() As String, ByRef strReasonName() As String) As Integer
Dim strSql As String, rsRecordset As New ADODB.Recordset, i As Integer

On Error GoTo ErrHand
strSql = "select ror01,ror02 from reasonofrelief"
rsRecordset.CursorLocation = adUseClient
rsRecordset.Open strSql, cnnConnection
If rsRecordset.RecordCount > 0 Then
   Do While Not rsRecordset.EOF
         ReDim Preserve strReasonNo(i) As String
         ReDim Preserve strReasonName(i) As String
         strReasonNo(i) = rsRecordset.Fields(0)
         strReasonName(i) = IIf(IsNull(rsRecordset.Fields(1)), "", rsRecordset.Fields(1))
         i = i + 1
         rsRecordset.MoveNext
   Loop
   Cls011ReadReasonOfRelief = 1
Else
   Cls011ReadReasonOfRelief = 0
End If
Exit Function
ErrHand:
ShowMsg MsgText(8001)
Cls011ReadReasonOfRelief = -1
   'edit by nickc 2007/02/05
   'ErrorLog
   MsgBox Err.Description

End Function
'解除期限存檔
Public Function Cls011SaveRelieveDeadlineData(ByRef intCaseKind As Integer, ByRef intWhere As Integer, ByRef cp() As String, ByRef field() As String, ByRef strRowID As String, ByRef strClose As String, ByRef strDate1 As String, ByRef StrDate2 As String, ByRef strMemo As String) As Boolean
Dim strReceiveCode As String, strTemp As String, strNextProgress(0) As String
'Add By Cheng 2002/11/14
Dim BolTransOk As Boolean
BolTransOk = True

On Error GoTo ErrHand1
cnnConnection.BeginTrans

'edit by nickc 2007/02/05 不用 dll 了
'Dim objPublicData As Object
'Set objPublicData = CreateObject("prjTaieDll.clsPublicData")
'If objPublicData.SaveAllData(cp(), field(), intCaseKind, intWhere) = False Then GoTo Err
If ClsPDSaveAllData(cp(), field(), intCaseKind, intWhere) = False Then GoTo ErrHand
If strClose = "Y" Then
   'edit by nickc 2007/02/05
   'Dim strDataTemp(1 To T_CP) As String
   Dim strDataTemp() As String
   ReDim strdatetemp(1 To TF_CP) As String
   
   strDataTemp(1) = field(1)
   strDataTemp(2) = field(2)
   strDataTemp(3) = field(3)
   strDataTemp(4) = field(4)
   strDataTemp(5) = GetTodayDate
   strDataTemp(27) = GetTodayDate
   'Modify By Sindy 2010/8/17 比對自動編號年度
   'strDataTemp(9) = 內部收文 + GetTaiwanThisYear
   strDataTemp(9) = 內部收文 + CompAutoNumberYear(GetTaiwanThisYear)
   strDataTemp(10) = 不續辦
   strDataTemp(13) = cp(13)
   strDataTemp(12) = cp(12)
   strDataTemp(20) = "N"
   strDataTemp(32) = "N"
   strDataTemp(43) = cp(9)
   'edit by nickc 2007/02/05 不用 dll 了
   'If objPublicData.SaveNewCaseProgressDatabase(內部收文, strDataTemp(), intWhere) = False Then GoTo Err
   If ClsPDSaveNewCaseProgressDatabase(內部收文, strDataTemp(), intWhere) = False Then GoTo ErrHand
End If
strNextProgress(0) = strRowID
'edit by nickc 2007/02/05 不用 dll 了
'If objPublicData.SetNextProgressGoOn(strNextProgress(), True, False) = False Then GoTo Err
'If objPublicData.SetNextProgressDate(strNextProgress(), strDate1, strDate2) = False Then GoTo Err
If ClsPDSetNextProgressGoOn(strNextProgress(), True, False) = False Then GoTo ErrHand
If ClsPDSetNextProgressDate(strNextProgress(), strDate1, StrDate2) = False Then GoTo ErrHand
If strDate1 <> "" Then
   'edit by nickc 2007/02/05
   'Dim np(1 To T_NP) As String
   Dim np() As String
   ReDim np(1 To TF_NP) As String
   'edit by nickc 2007/02/05 不用 dll 了
   'If objPublicData.ReadNextProgressData(np(), strRowID) = False Then GoTo Err
   If ClsPDReadNextProgressData(np(), strRowID) = False Then GoTo ErrHand
   cp(9) = np(1)
   cp(13) = np(10)
   'edit by nickc 2007/02/05 不用 dll 了
   'If objPublicData.SaveNewNextProgressDatabase(intWhere, cp(), strDate1, strDate2, np(7), strMemo, np(13), np(14)) = False Then GoTo Err
   If ClsPDSaveNewNextProgressDatabase(intWhere, cp(), strDate1, StrDate2, np(7), strMemo, np(13), np(14)) = False Then GoTo ErrHand
End If
'edit by nickc 2007/02/05 不用 dll 了
'Set objPublicData = Nothing
Cls011SaveRelieveDeadlineData = True
ErrHand:
If Cls011SaveRelieveDeadlineData Then
        'Modify By Cheng 2002/11/14
    If BolTransOk Then
        cnnConnection.CommitTrans
    End If
Else
    'Modify By Cheng 2002/11/14
    If BolTransOk Then
        cnnConnection.RollbackTrans
    End If
End If
Exit Function
ErrHand1:
    'Add By Cheng 2002/11/14
    If Err.Number = -2147168237 Then
       BolTransOk = False
       Resume Next
    End If

cnnConnection.RollbackTrans
'edit by nickc 2007/02/05
'ErrorLog
MsgBox Err.Description

End Function
'取消收文存檔
Public Function Cls011SaveCancelReceivedDayData(ByRef intCaseKind As Integer, ByRef intWhere As Integer, ByRef cp() As String, ByRef field() As String, ByRef strClose As String, ByRef strDate1 As String, ByRef StrDate2 As String, ByRef strMemo As String) As Boolean
Dim strReceiveCode As String, strTemp As String, strNextProgress(0) As String
'Add By Cheng 2002/11/14
Dim BolTransOk As Boolean
BolTransOk = True

On Error GoTo ErrHand1
cnnConnection.BeginTrans
'edit by nickc 2007/02/05 不用 dll 了
'Dim objPublicData As Object
'Set objPublicData = CreateObject("prjTaieDll.clsPublicData")
'If objPublicData.SaveAllData(cp(), field(), intCaseKind, intWhere) = False Then GoTo Err
If ClsPDSaveAllData(cp(), field(), intCaseKind, intWhere) = False Then GoTo ErrHand
If strClose = "Y" Then
   'edit by nickc 2007/02/05
   'Dim strDataTemp(1 To T_CP) As String
   Dim strDataTemp() As String
   ReDim strDataTemp(1 To TF_CP) As String
   strDataTemp(1) = field(1)
   strDataTemp(2) = field(2)
   strDataTemp(3) = field(3)
   strDataTemp(4) = field(4)
   strDataTemp(5) = GetTodayDate
   strDataTemp(27) = GetTodayDate
   'Modify By Sindy 2010/8/17 比對自動編號年度
   'strDataTemp(9) = 內部收文 + GetTaiwanThisYear
   strDataTemp(9) = 內部收文 + CompAutoNumberYear(GetTaiwanThisYear)
   strDataTemp(10) = 不續辦
   strDataTemp(13) = cp(13)
   strDataTemp(12) = cp(12)
   strDataTemp(20) = "N"
   strDataTemp(32) = "N"
   strDataTemp(43) = cp(9)
   'edit by nickc 2007/02/05 不用 dll 了
   'If objPublicData.SaveNewCaseProgressDatabase(內部收文, strDataTemp(), intWhere) = False Then GoTo Err
   If ClsPDSaveNewCaseProgressDatabase(內部收文, strDataTemp(), intWhere) = False Then GoTo ErrHand
End If
If strDate1 <> "" Then
   If cp(40) <> "" Then
      strTemp = cp(40)
   ElseIf cp(41) <> "" Then
      strTemp = cp(41)
   Else
      strTemp = cp(42)
   End If
   'edit by nickc 2007/02/05 不用 dll 了
   'If objPublicData.SaveNewNextProgressDatabase(intWhere, cp(), strDate1, strDate2, cp(10), strMemo, , strTemp) = False Then GoTo Err
   If ClsPDSaveNewNextProgressDatabase(intWhere, cp(), strDate1, StrDate2, cp(10), strMemo, , strTemp) = False Then GoTo ErrHand
End If
'edit by nickc 2007/02/05 不用 dll 了
'Set objPublicData = Nothing
Cls011SaveCancelReceivedDayData = True
ErrHand:
If Cls011SaveCancelReceivedDayData Then
    'Modify By Cheng 2002/11/14
    If BolTransOk Then
        cnnConnection.CommitTrans
    End If
Else
    'Modify By Cheng 2002/11/14
    If BolTransOk Then
        cnnConnection.RollbackTrans
    End If
End If
Exit Function
ErrHand1:
    'Add By Cheng 2002/11/14
    If Err.Number = -2147168237 Then
       BolTransOk = False
       Resume Next
    End If

cnnConnection.RollbackTrans
'edit by nickc 2007/02/05
'ErrorLog
MsgBox Err.Description

End Function
'讀取閉卷申請人或代理人資料
Public Function Cls011ReadCloseCaseRst(ByRef strNo As String, ByRef strSystemKind As String) As ADODB.Recordset
Dim strSql As String, rsRecordset As New ADODB.Recordset
'edit by nickc 2007/02/05 不用 dll 了
'Dim objPublicData As Object, strSQLS(4) As String, strSystem(4) As String, i As Integer
Dim strSQLS(4) As String, strSystem(4) As String, i As Integer

On Error GoTo ErrHand
'edit by nickc 2007/02/05 不用 dll 了
'Set objPublicData = CreateObject("prjTaieDll.clsPublicData")
'If objPublicData.AnalysisSystemKindString(strSystemKind, strSystem()) = False Then GoTo err1
If ClsPDAnalysisSystemKindString(strSystemKind, strSystem()) = False Then GoTo ErrHand1
strNo = ChangeCustomerL(strNo)
If Left(strNo, 1) = 代理人編號 Then
   strNo = Left(strNo, 8)
End If
If strSystem(0) <> "" Then
   strSQLS(0) = "select pa01 s01,pa02 s02,pa02 s03,replace(pa03,'0') s04,replace(pa04,'00') s05,nvl(pa05,nvl(pa06,pa07)) s06,na03 s07,pa11 s08,pa01 s09,pa02 s10,pa03 s11,pa04 s12 from patent,nation where pa09=na01 "
   If Left(strNo, 1) = 客戶編號 Then
      strSQLS(0) = strSQLS(0) + "and (pa26=" + CNULL(strNo) + " or pa27=" + CNULL(strNo) + " or pa28=" + CNULL(strNo) + " or pa29=" + CNULL(strNo) + " or pa30=" + CNULL(strNo) + ")"
   Else
      strSQLS(0) = strSQLS(0) + "and pa75=" + CNULL(strNo)
   End If
   strSQLS(0) = strSQLS(0) + " and pa01 in (" + strSystem(0) + ")"
End If
If strSystem(1) <> "" Then
   strSQLS(1) = "select tm01 s01,decode(tm01," + CNULL(馬德里案) + ",substr(tm02,1,5),tm02) s02,decode(tm01," + CNULL(馬德里案) + ",replace(substr(tm02,6,1),'0'),tm02) s03,replace(tm03,'0') s04,replace(tm04,'00') s05,nvl(tm05,nvl(tm06,tm07)) s06,na03 s07,tm12 s08,tm01 s09,tm02 s10,tm03 s11,tm04 s12 from trademark,nation where tm10=na01 "
   If Left(strNo, 1) = 客戶編號 Then
      'Modify By Sindy 2011/2/22 增加TM78,TM79,TM80,TM81
      'strSQLS(1) = strSQLS(1) + "and tm23=" + CNULL(strNo)
      strSQLS(1) = strSQLS(1) + "and (tm23=" + CNULL(strNo) + " or tm78=" + CNULL(strNo) + " or tm79=" + CNULL(strNo) + " or tm80=" + CNULL(strNo) + " or tm81=" + CNULL(strNo) + ")"
   Else
      strSQLS(1) = strSQLS(1) + "and tm44=" + CNULL(strNo)
   End If
   strSQLS(1) = strSQLS(1) + " and tm01 in (" + strSystem(1) + ")"
End If
If strSystem(2) <> "" Then
   strSQLS(2) = "select lc01 s01,lc02 s02,lc02 s03,replace(lc03,'0') s04,replace(lc04,'00') s05,nvl(lc05,nvl(lc06,lc07)) s06,na03 s07,'' s08,lc01 s09,lc02 s10,lc03 s11,lc04 s12 from lawcase,nation where lc15=na01 "
   If Left(strNo, 1) = 客戶編號 Then
      'Modify By Sindy 2011/2/22 增加LC43,LC44,LC45,LC46
      'strSQLS(2) = strSQLS(2) + "and lc11=" + CNULL(strNo)
      strSQLS(2) = strSQLS(2) + "and (lc11=" + CNULL(strNo) + " or lc43=" + CNULL(strNo) + " or lc44=" + CNULL(strNo) + " or lc45=" + CNULL(strNo) + " or lc46=" + CNULL(strNo) + ")"
   Else
      strSQLS(2) = strSQLS(2) + "and lc22=" + CNULL(strNo)
   End If
   strSQLS(2) = strSQLS(2) + " and lc01 in (" + strSystem(2) + ")"
End If
If strSystem(3) <> "" Then
   strSQLS(3) = "select hc01 s01,hc02 s02,hc02 s03,replace(hc03,'0') s04,replace(hc04,'00') s05,hc06 s06,'' s07,'' s08,hc01 s09,hc02 s10,hc03 s11,hc04 s12 from hirecase where hc01 in (" + strSystem(3) + ") "
   If Left(strNo, 1) = 客戶編號 Then
      'Modify By Sindy 2011/2/22 增加HC24,HC25,HC26,HC27
      strSQLS(3) = strSQLS(3) + "and (hc05=" + CNULL(strNo) + " or hc24=" + CNULL(strNo) + " or hc25=" + CNULL(strNo) + " or hc26=" + CNULL(strNo) + " or hc27=" + CNULL(strNo) + ")"
   End If
End If
If strSystem(4) <> "" Then
   strSQLS(4) = "select sp01 s01,sp02 s02,sp02 s03,replace(sp03,'0') s04,replace(sp04,'00') s05,nvl(sp05,nvl(sp06,sp07)) s06,na03 s07,sp11 s08,sp01 s09,sp02 s10,sp03 s11,sp04 s12 from servicepractice,nation where sp09=na01 "
   If Left(strNo, 1) = 客戶編號 Then
      'Modify By Sindy 2011/2/22 增加SP65,SP66
      'strSQLS(4) = strSQLS(4) + "and (sp08=" + CNULL(strNo) + " or sp58=" + CNULL(strNo) + " or sp59=" + CNULL(strNo) + ")"
      strSQLS(4) = strSQLS(4) + "and (sp08=" + CNULL(strNo) + " or sp58=" + CNULL(strNo) + " or sp59=" + CNULL(strNo) + " or sp65=" + CNULL(strNo) + " or sp66=" + CNULL(strNo) + ")"
   Else
      strSQLS(4) = strSQLS(4) + "and sp26=" + CNULL(strNo)
   End If
   strSQLS(4) = strSQLS(4) + " and sp01 in (" + strSystem(4) + ")"
End If
strSql = "select '' ˇ,s01 本所案號,s02 本所案號,s03 本所案號,s04 本所案號,s05 本所案號,s06 案件名稱,s07 申請國家,s08 申請案號,s09,s10,s11,s12 from ("
For i = 0 To 4
       If strSQLS(i) <> "" Then
          strSql = strSql + strSQLS(i) + " union "
       End If
Next
strSql = Left(strSql, Len(strSql) - 7)
strSql = strSql + ") order by s09,s10,s11,s12"
'edit by nickc 2007/02/05 不用 dll 了
'Set ReadCloseCaseRst = objPublicData.ReadRst(strSQL)
Set Cls011ReadCloseCaseRst = ClsPDReadRst(strSql)
ErrHand1:
'edit by nickc 2007/02/05 不用 dll 了
'Set objPublicData = Nothing
Exit Function
ErrHand:
'edit by nickc 2007/02/05 不用 dll 了
'Set objPublicData = Nothing
'edit by nickc 2007/02/05
'ErrorLog
MsgBox Err.Description
End Function

'Remove by Lydia 2018/06/05 不使用,移除
''讀取閉卷之下一程序及案件進度檔資料
'Public Function Cls011ReadCloseCaseDRst(ByRef intWhere As Integer, ByRef strCode1 As String, ByRef strCode2 As String, ByRef strCode3 As String, ByRef strCode4 As String) As ADODB.Recordset
'Dim strSql As String, rsRecordset As New ADODB.Recordset
''edit by nickc 2007/02/05 不用 dll 了
''Dim objPublicData As Object, strSQL1 As String, strSQL2 As String, i As Integer
'Dim strSQL1 As String, strSQL2 As String, i As Integer
'
'On Error GoTo ErrHand
''edit by nickc 2007/02/05 不用 dll 了
''Set objPublicData = CreateObject("prjTaieDll.clsPublicData")
'strSQL1 = "select decode(np07," + CNULL(大陸國家代號) + ",cpm04,cpm03) s01," & SQLDate("np08") & " s02," & SQLDate("np09") & " s03,np13 s04,np14 s05,'' s06 from nextprogress,casepropertymap where np02=cpm01 and np07=cpm02 and np02=" + CNULL(strCode1) + " and np03=" + CNULL(strCode2) + " and np04=" + CNULL(strCode3) + " and np05=" + CNULL(strCode4)
'strSQL2 = "select decode(cp10," + CNULL(大陸國家代號) + ",cpm04,cpm03) s01," & SQLDate("cp06") & " s02," & SQLDate("cp07") & " s03,cp08 s04,nvl(cp40,nvl(cp50,cp55)) s05,cp09 s06 from caseprogress,casepropertymap where cp01=cpm01 and cp10=cpm02 and cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4)
'strSql = "select s01 案件性質,s02 本所期限,s03 法定期限,s04 機關文號,s05 相關人,s06 收文號 from (" + strSQL1 + " union " + strSQL2 + ") order by s02,s06"
''edit by nickc 2007/02/05 不用 dll 了
''Set ReadCloseCaseDRst = objPublicData.ReadRst(strSQL)
'Set Cls011ReadCloseCaseDRst = ClsPDReadRst(strSql)
'ErrHand1:
''edit by nickc 2007/02/05 不用 dll 了
''Set objPublicData = Nothing
'Exit Function
'ErrHand:
''edit by nickc 2007/02/05 不用 dll 了
''Set objPublicData = Nothing
''edit by nickc 2007/02/05
''ErrorLog
'MsgBox Err.Description
'
'End Function
'end 2018/06/05

'閉卷存檔
Public Function Cls011SaveCloseCaseData(ByRef intCaseKind As Integer, ByRef intWhere As Integer, ByRef cp() As String, ByRef field() As String) As Boolean
Dim strReceiveCode As String, strTemp As String, strNextProgress(0) As String
'Add By Cheng 2002/11/14
Dim BolTransOk As Boolean
BolTransOk = True

On Error GoTo ErrHand1
cnnConnection.BeginTrans
'edit by nickc 2007/02/05 不用 dll 了
'Dim objPublicData As Object
'Set objPublicData = CreateObject("prjTaieDll.clsPublicData")
'If objPublicData.SaveAllData(cp(), field(), intCaseKind, intWhere) = False Then GoTo Err
'Dim strDataTemp(1 To T_CP) As String
If ClsPDSaveAllData(cp(), field(), intCaseKind, intWhere) = False Then GoTo ErrHand
Dim strDataTemp() As String
ReDim strDataTemp(1 To TF_CP) As String
strDataTemp(1) = field(1)
strDataTemp(2) = field(2)
strDataTemp(3) = field(3)
strDataTemp(4) = field(4)
strDataTemp(5) = GetTodayDate
strDataTemp(27) = GetTodayDate
'Modify By Sindy 2010/8/17 比對自動編號年度
'strDataTemp(9) = 內部收文 + GetTaiwanThisYear
strDataTemp(9) = 內部收文 + CompAutoNumberYear(GetTaiwanThisYear)
strDataTemp(10) = 不續辦
strDataTemp(20) = "N"
strDataTemp(32) = "N"
'edit by nickc 2007/02/05 不用 dll 了
'If objPublicData.SaveNewCaseProgressDatabase(內部收文, strDataTemp(), intWhere) = False Then GoTo Err
If ClsPDSaveNewCaseProgressDatabase(內部收文, strDataTemp(), intWhere) = False Then GoTo ErrHand:
'Set objPublicData = Nothing
Cls011SaveCloseCaseData = True
ErrHand:
If Cls011SaveCloseCaseData Then
    'Modify By Cheng 2002/11/14
    If BolTransOk Then
        cnnConnection.CommitTrans
    End If
Else
    'Modify By Cheng 2002/11/14
    If BolTransOk Then
        cnnConnection.RollbackTrans
    End If
End If
Exit Function
ErrHand1:
    'Add By Cheng 2002/11/14
    If Err.Number = -2147168237 Then
       BolTransOk = False
       Resume Next
    End If

cnnConnection.RollbackTrans
'edit by nickc 2007/02/05
'ErrorLog
MsgBox Err.Description

End Function
'讀取相關卷號檔
Public Function Cls011ReadCaseRelationData(ByRef strCode1 As String, ByRef strCode2 As String, ByRef strCode3 As String, ByRef strCode4 As String, ByRef strRelation() As String) As Integer
Dim strSql As String, rsRecordset As New ADODB.Recordset, i As Integer, j As Integer
On Error GoTo ErrHand
   strSql = "select cr05,cr06,cr07,cr08 from caserelation where cr01=" + CNULL(strCode1) + " and cr02=" + CNULL(strCode2) + " and cr03=" + CNULL(strCode3) + " and cr04=" + CNULL(strCode4)
   'add by nickc 2007/04/18
   rsRecordset.CursorLocation = adUseClient
   rsRecordset.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   Cls011ReadCaseRelationData = 0
   Do While Not rsRecordset.EOF
      Cls011ReadCaseRelationData = 1
         ReDim Preserve strRelation(3, j)
         For i = 0 To 3
                strRelation(i, j) = rsRecordset.Fields(i)
         Next
         rsRecordset.MoveNext
         j = j + 1
   Loop
   Exit Function
ErrHand:
Cls011ReadCaseRelationData = -1
'edit by nickc 2007/02/05
'ErrorLog
MsgBox Err.Description

End Function
'相關卷號檔存檔
Public Function Cls011SaveCaseRelationData(ByRef strCode1 As String, ByRef strCode2 As String, ByRef strCode3 As String, ByRef strCode4 As String, ByRef strRelation() As String) As Boolean
Dim strSql As String, rsRecordset As New ADODB.Recordset, i As Integer
'Add By Cheng 2002/11/14
Dim BolTransOk As Boolean
BolTransOk = True

On Error GoTo ErrHand
cnnConnection.BeginTrans
strSql = "delete from caserelation where cr01=" + CNULL(strCode1) + " and cr02=" + CNULL(strCode2) + " and cr03=" + CNULL(strCode3) + " and cr04=" + CNULL(strCode4)
cnnConnection.Execute strSql
For i = 0 To UBound(strRelation, 2)
       strSql = "insert into caserelation values(" + CNULL(strCode1) + "," + CNULL(strCode2) + "," + CNULL(strCode3) + "," + CNULL(strCode4) + _
             "," + CNULL(strRelation(0, i)) + "," + CNULL(strRelation(1, i)) + "," + CNULL(strRelation(2, i)) + "," + CNULL(strRelation(3, i)) + ")"
       cnnConnection.Execute strSql
Next
For i = 0 To UBound(strRelation, 2)
       strSql = "delete from caserelation where cr01=" + CNULL(strRelation(0, i)) + " and cr02=" + CNULL(strRelation(1, i)) + " and cr03=" + CNULL(strRelation(2, i)) + " and cr04=" + CNULL(strRelation(3, i)) + " and cr05=" + CNULL(strCode1) + " and cr06=" + CNULL(strCode2) + " and cr07=" + CNULL(strCode3) + " and cr08=" + CNULL(strCode4)
       cnnConnection.Execute strSql
Next
For i = 0 To UBound(strRelation, 2)
       strSql = "insert into caserelation values(" + CNULL(strRelation(0, i)) + "," + CNULL(strRelation(1, i)) + "," + CNULL(strRelation(2, i)) + "," + CNULL(strRelation(3, i)) + "," + _
            CNULL(strCode1) + "," + CNULL(strCode2) + "," + CNULL(strCode3) + "," + CNULL(strCode4) + ")"
       cnnConnection.Execute strSql
Next
Cls011SaveCaseRelationData = True
'Modify By Cheng 2002/11/14
If BolTransOk Then
    cnnConnection.CommitTrans
End If
Exit Function
ErrHand:
    'Add By Cheng 2002/11/14
    If Err.Number = -2147168237 Then
       BolTransOk = False
       Resume Next
    End If

cnnConnection.RollbackTrans
'edit by nickc 2007/02/05
'ErrorLog
MsgBox Err.Description

End Function

'Mark by Lydia 2023/03/22 沒有使用
''ClsLaw nickc 2007/02/05 搬
'Public Function ClsLawGetExpand(ByVal strNum As String, ByRef StrNam As String) As Boolean
' Dim RsTemp As New ADODB.Recordset, strQty As String
'On Error GoTo ErrHand
'   StrNam = ""
'   strQty = "SELECT ECA02 FROM EXPANDCUSATTR WHERE ECA01 ='" & strNum & "'"
'   'add by nickc 2007/04/18
'   RsTemp.CursorLocation = adUseClient
'
'   RsTemp.Open strQty, cnnConnection
'   ClsLawGetExpand = False
'   Do While Not RsTemp.EOF
'      If Not IsNull(RsTemp.Fields(0).Value) Then StrNam = RsTemp.Fields(0).Value
'      ClsLawGetExpand = True
'      Exit Do
'   Loop
'   RsTemp.Close
'   If ClsLawGetExpand = False Then MsgBox "屬性代號錯誤", vbCritical
'   Exit Function
'ErrHand:
'   MsgBox "錯誤 : " & Err.Description, vbCritical
'End Function

Public Function CNULL(ByRef strNULL As String, Optional IsNum As Boolean = False) As String
   If strNULL = "" Then
      CNULL = "NULL"
   'Add by Morgan 2007/7/19
   ElseIf IsNum = True Then
      CNULL = strNULL
   Else
      CNULL = "'" + strNULL + "'"
   End If
End Function

Public Function ClsLawGetReasonOfRelief(ByRef strNum As String, ByRef strResult As String) As Boolean
 Dim RsTemp As New ADODB.Recordset
 Dim strQty As String
On Error GoTo ErrHand
   strResult = ""
   strQty = "select ror02 from reasonofrelief where ror01='" + strNum + "'"
   ClsLawGetReasonOfRelief = False
   'add by nickc 2007/04/18
   RsTemp.CursorLocation = adUseClient
   
   RsTemp.Open strQty, cnnConnection
   Do While Not RsTemp.EOF
      If Not IsNull(RsTemp.Fields(0).Value) Then strResult = RsTemp.Fields(0).Value
      ClsLawGetReasonOfRelief = True
      Exit Do
   Loop
   RsTemp.Close
   If ClsLawGetReasonOfRelief = False Then MsgBox "解除期限原因代碼錯誤.", vbCritical
   Exit Function
ErrHand:
   MsgBox "錯誤 : " & Err.Description, vbCritical
End Function
'Remove by Lydia 2022/09/06 經過查詢，沒有使用
'Public Function ClsLawGetNextProgress(ByRef CP09 As String, ByRef cp As String, ByRef strProperty As String, ByRef strPropertymemo As String) As Boolean
' Dim RsTemp As New ADODB.Recordset
' Dim strQty As String
'On Error GoTo ErrHand
'   strProperty = ""
'   strPropertymemo = ""
'   strQty = "select np07,np15 from nextprogress where np01='" + CP09 + "' and " & ChgNextProgress(cp)
'   'add by nickc 2007/04/18
'   RsTemp.CursorLocation = adUseClient
'
'   RsTemp.Open strQty, cnnConnection
'   Do While Not RsTemp.EOF
'      If Not IsNull(RsTemp.Fields(0)) Then strProperty = RsTemp.Fields(0)
'      If Not IsNull(RsTemp.Fields(1)) Then strPropertymemo = RsTemp.Fields(1)
'      ClsLawGetNextProgress = True
'   Loop
'   RsTemp.Close
'   Exit Function
'ErrHand:
'   ClsLawGetNextProgress = False
'   MsgBox "錯誤 : " & Err.Description, vbCritical
'End Function
'end 2022/09/06

Public Function ClsLawGetMax() As Long
 Dim RsTemp As New ADODB.Recordset
 Dim strQty As String
   strQty = "SELECT MAX(NP22) FROM NEXTPROGRESS"
   'add by nickc 2007/04/18
   RsTemp.CursorLocation = adUseClient
   
   RsTemp.Open strQty, cnnConnection
   ClsLawGetMax = 1
   Do While Not RsTemp.EOF
      ClsLawGetMax = RsTemp.Fields(0).Value + 1
      Exit Do
   Loop
   RsTemp.Close
End Function

'動態集之recordset Input 0:有訊息 1:無訊息 Output 0:無資料 1:有資料 2:錯誤
'Modified by Morgan 2021/8/25 +pErrMsg
Public Function ClsLawReadRstMsg(ByRef i As Integer, ByRef strSql As String, Optional Server As Boolean = False, _
      Optional ErrShow As Boolean = False, Optional ByRef pErrMsg As String) As ADODB.Recordset
 
 Dim Rc As New ADODB.Recordset
On Error GoTo ErrHand
   
   'Modify By Sindy 2024/12/6 mark:怕有古老程式會使用到,為要回傳訊息
   'i = 1 'Add By Sindy 2024/5/27 預設值
   
   If Server = False Then
      Rc.CursorLocation = adUseClient
      
      'Add By Cheng 2002/01/02
      'nick建議會加速查詢速度
'      Rc.CursorType = adOpenDynamic
      Rc.CursorType = adOpenStatic
      Rc.LockType = adLockReadOnly
      Rc.Open strSql, cnnConnection
      If Rc.RecordCount > 0 Then
         Set ClsLawReadRstMsg = Rc
         i = 1
      Else
         If i = 0 Then MsgBox "資料庫無資料 !", vbInformation
         Set ClsLawReadRstMsg = Rc
         i = 0
      End If
   Else
      Rc.CursorLocation = adUseServer
      
      'Add By Cheng 2002/01/02
      'nick建議會加速查詢速度
'      Rc.CursorType = adOpenDynamic
      Rc.CursorType = adOpenStatic
      Rc.LockType = adLockReadOnly
      
      Rc.Open strSql, cnnConnection
      If Rc.EOF And Rc.BOF Then
         If i = 0 Then MsgBox "資料庫無資料 !", vbInformation
         Set ClsLawReadRstMsg = Rc
         i = 0
      Else
         Set ClsLawReadRstMsg = Rc
         i = 1
      End If
   End If
   Exit Function
ErrHand:
   i = 2
   pErrMsg = vbCrLf & Now & vbCrLf & Err.Number & vbCrLf & Err.Description & vbCrLf 'Added by Morgan 2021/8/25
   If ErrShow = False Then MsgBox "錯誤 : " & Err.Description, vbCritical
   
End Function
'Modified by Morgan 2011/11/10 +bolNoMoreTrans
Public Function ClsLawExecSQL(ByVal j As Integer, ByRef Qty() As String, Optional bolNoMoreTrans As Boolean) As Boolean
 Dim i As Integer
'Add By Cheng 2002/11/14
Dim BolTransOk As Boolean
BolTransOk = True
 
On Error GoTo ErrHand
   If j > 0 Then
   
      If bolNoMoreTrans = False Then 'Added by Morgan 2011/11/10
         cnnConnection.BeginTrans
      End If
      
      For i = 1 To j
         If Qty(i) <> "" Then cnnConnection.Execute Qty(i)
      Next
        'Modify By Cheng 2002/11/14
        If BolTransOk Then
            If bolNoMoreTrans = False Then 'Added by Morgan 2011/11/10
               cnnConnection.CommitTrans
            End If
        End If
   End If
   ClsLawExecSQL = True
   Exit Function
   
ErrHand:
   
   'Added by Morgan 2011/11/10
   If bolNoMoreTrans = True Then
      Err.Raise Err.Number
      Exit Function
   End If
   'end 2011/11/10

   'Add By Cheng 2002/11/14
   If Err.Number = -2147168237 Then 'Memo by Morgan 2025/1/9 交易中已經存在有徵募。(發生在重複BeginTrans時)
      BolTransOk = False
      Resume Next
   End If
   
   'Add By Sindy 2022/6/7 ex:INSERT INTO EXCEPTCONDITION (ET01,ET02,ET03,ET04,ET05,ET06)  VALUES ('01','BA8048001','05','97038','申請人1-國籍','JP日本')
   'Removed by Morgan 2025/1/9 跟Sindy確認後移除，因為Key重複但資料有可能不同，無法確定寫入的就一定是正確的資料。且錯誤跳過也會造成transaction沒有正常commit而可能引發後續的徵募錯誤。
   'If Err.NUMBER = -2147217873 And InStr(UCase(Qty(i)), UCase("INSERT INTO EXCEPTCONDITION")) > 0 Then 'ORA-00001: 違反必須為唯一的限制條件 (PGMID.SYS_C002626183)
   '   BolTransOk = False
   '   Resume Next
   'End If
   'end 2025/1/9

   cnnConnection.RollbackTrans
   ClsLawExecSQL = False
   MsgBox "錯誤 : " & Err.Description, vbCritical
End Function

'取得代理人名稱
Public Function ClsLawLawGetName(ByRef strNum As String, ByRef strName As String, Optional ByVal intSituE As Integer = 0) As Boolean
 Dim RsTemp As New ADODB.Recordset
 Dim strQty As String
On Error GoTo ErrHand
   strName = ""
   strNum = ChangeCustomerL(strNum)
   If Left(strNum, 1) = 代理人編號 Then
      strQty = "SELECT NVL(FA05,NVL(FA04,FA06)) FROM FAGENT WHERE " & ChgFagent(strNum)
   ElseIf Left(strNum, 1) = 客戶編號 Then
      If intSituE = 1 Then
         strQty = "SELECT NVL(CU05,NVL(CU04,CU06)) FROM CUSTOMER WHERE " & ChgCustomer(strNum)
      Else
         strQty = "SELECT NVL(CU04,NVL(CU05,CU06)) FROM CUSTOMER WHERE " & ChgCustomer(strNum)
      End If
   Else
      MsgBox "編號第一碼錯誤，請重新輸入 !", vbCritical
      Exit Function
   End If
   'add by nickc 2007/04/18
   RsTemp.CursorLocation = adUseClient
   
   RsTemp.Open strQty, cnnConnection
   ClsLawLawGetName = False
   Do While Not RsTemp.EOF
      If Not IsNull(RsTemp.Fields(0).Value) Then strName = RsTemp.Fields(0).Value
      ClsLawLawGetName = True
      Exit Do
   Loop
   RsTemp.Close
   strNum = ChangeCustomerS(strNum)
   If ClsLawLawGetName = False Then MsgBox "編號錯誤，請重新輸入 !", vbCritical
   Exit Function
ErrHand:
   MsgBox "錯誤 : " & Err.Description, vbCritical
End Function

Public Function ClsLawGetInvLetter(ByVal strIn As String, ByRef strName() As String) As Boolean
 Dim RsTemp As New ADODB.Recordset
 Dim strQty As String
 Dim i As Integer
On Error GoTo ErrHand
   ClsLawGetInvLetter = False
   For i = 0 To 4
      strName(i) = ""
   Next
   strIn = strIn & String(10 - Len(strIn), "0")
   strQty = "SELECT IN03,IN04,IN05,IN07,NA03 FROM INVENTOR,NATION WHERE in01='" & Left(strIn, 8) & "' AND IN02='" & Right(strIn, 2) & "' AND IN11=NA01"
   'add by nickc 2007/04/18
   RsTemp.CursorLocation = adUseClient
   
   RsTemp.Open strQty, cnnConnection
   Do While Not RsTemp.EOF
      For i = 0 To 4
         If Not IsNull(RsTemp.Fields(i)) Then strName(i) = RsTemp.Fields(i)
      Next
      ClsLawGetInvLetter = True
      Exit Do
   Loop
   RsTemp.Close
   Exit Function
ErrHand:
   MsgBox "錯誤 : " & Err.Description, vbCritical
End Function

Public Function ClsLawGetCusLetter(ByVal strNum As String, ByRef strNA03 As String, ByRef strCU11 As String, _
   ByRef strCU23 As String) As Boolean
 Dim RsTemp As New ADODB.Recordset
 Dim strQty As String
On Error GoTo ErrHand
   ClsLawGetCusLetter = False
   strNA03 = ""
   strCU11 = ""
   strCU23 = ""
   strQty = "SELECT NA03,CU11,CU23 FROM CUSTOMER,NATION WHERE " & ChgCustomer(strNum) & " AND CU10=NA01"
   'add by nickc 2007/04/18
   RsTemp.CursorLocation = adUseClient
   
   RsTemp.Open strQty, cnnConnection
   With RsTemp
      Do While Not .EOF
         If Not IsNull(.Fields(0).Value) Then strNA03 = .Fields(0).Value
         If Not IsNull(.Fields(1).Value) Then strCU11 = .Fields(1).Value
         If Not IsNull(.Fields(2).Value) Then strCU23 = .Fields(2).Value
         ClsLawGetCusLetter = True
         Exit Do
      Loop
      .Close
   End With
   Exit Function
ErrHand:
   MsgBox "錯誤 : " & Err.Description, vbCritical
End Function

Public Function ClsLawGetCusCAJnam(ByVal strNum As String, ByRef StrCnam As String, _
   ByRef StrAnam As String, ByRef StrJnam As String) As Boolean
 Dim RsTemp As New ADODB.Recordset
 Dim strQty As String
On Error GoTo ErrHand
   StrCnam = ""
   StrAnam = ""
   StrJnam = ""
   If Left(strNum, 1) = 代理人編號 Then
      strQty = "SELECT FA04,FA05||' '||FA63||' '||FA64||' '||FA65,FA06 FROM FAGENT WHERE " & ChgFagent(strNum)
   ElseIf Left(strNum, 1) = 客戶編號 Then
      strQty = "SELECT CU04,CU05||' '||CU88||' '||CU89||' '||CU90,CU06 FROM CUSTOMER WHERE " & ChgCustomer(strNum)
   Else
      MsgBox "編號第一碼錯誤，請重新輸入 !", vbCritical
      Exit Function
   End If
   'add by nickc 2007/04/18
   RsTemp.CursorLocation = adUseClient
   
   RsTemp.Open strQty, cnnConnection
   ClsLawGetCusCAJnam = False
   With RsTemp
      Do While Not .EOF
         If Not IsNull(.Fields(0).Value) Then StrCnam = .Fields(0).Value
         If Not IsNull(.Fields(1).Value) Then StrAnam = .Fields(1).Value
         If Not IsNull(.Fields(2).Value) Then StrJnam = .Fields(2).Value
         ClsLawGetCusCAJnam = True
         Exit Do
      Loop
      .Close
   End With
   If ClsLawGetCusCAJnam = False Then MsgBox "編號錯誤，請重新輸入 !", vbCritical
   Exit Function
ErrHand:
   MsgBox "錯誤 : " & Err.Description, vbCritical
End Function

'讀取客戶發明人檔
Public Function ClsLawGetInventor(ByVal strIn As String, ByRef strName() As String) As Boolean
 Dim RsTemp As New ADODB.Recordset
 Dim strQty As String
 Dim i As Integer
On Error GoTo ErrHand
   ClsLawGetInventor = False
   For i = 0 To 5
      strName(i + 1) = ""
   Next
   ' 90.08.22 modify by louis
   If Len(strIn) < 10 Then
      strIn = strIn & String(10 - Len(strIn), "0")
   End If
   'Modify By Sindy 2015/12/4 + IN11
   strQty = "SELECT IN04,IN05,IN06,IN07,IN08,IN11 FROM INVENTOR WHERE in01='" & Left(strIn, 8) & "' AND IN02='" & Right(strIn, 2) & "'"
   'add by nickc 2007/04/18
   RsTemp.CursorLocation = adUseClient
   
   RsTemp.Open strQty, cnnConnection
   Do While Not RsTemp.EOF
      For i = 0 To 5
         If Not IsNull(RsTemp.Fields(i)) Then strName(i + 1) = RsTemp.Fields(i)
      Next
      ClsLawGetInventor = True
      Exit Do
   Loop
   RsTemp.Close
   Exit Function
ErrHand:
   MsgBox "錯誤 : " & Err.Description, vbCritical
End Function

'取得下次繳費日,利用array傳值,array(1-4)為本所案號,
Public Function ClsLawGetNextPayDate(ByRef pa() As String, ByRef strName As String) As Boolean
 Dim RsTemp As New ADODB.Recordset
 Dim strQty As String
On Error GoTo ErrHand
   ClsLawGetNextPayDate = False
   strName = ""
   strQty = "SELECT MAX(NP09) FROM NEXTPROGRESS WHERE " & ChgNextProgress(pa(1) & pa(2) & pa(3) & pa(4)) & _
      " AND NP07 IN ('" & 年費 & "','" & 維持費 & "','" & 延展費 & "') And NP08 IS NOT NULL AND NP06 IS NULL"
   'add by nickc 2007/04/18
   RsTemp.CursorLocation = adUseClient
   
   RsTemp.Open strQty, cnnConnection
   Do While Not RsTemp.EOF
      If Not IsNull(RsTemp.Fields(0)) Then strName = RsTemp.Fields(0)
      ClsLawGetNextPayDate = True
      Exit Do
   Loop
   RsTemp.Close
   Exit Function
ErrHand:
   MsgBox "錯誤 : " & Err.Description, vbCritical
End Function

'Cls003 nick 2007/02/05 搬
Public Function Cls003EnableShowMessage(ByVal bEnable As Boolean) As Boolean
   Cls003EnableShowMessage = m_ShowMsg
   m_ShowMsg = bEnable
End Function

'讀取CaseProgress案件進度檔 C類
Public Function Cls003ReadCCaseProgressDatabase(ByRef cp() As String, ByRef strCaseProperty As String, intWhere As Integer) As Integer
Dim strSql As String, rsRecordset As New ADODB.Recordset, i As Integer

On Error GoTo ErrHand
strSql = "select * from caseprogress where cp01=" + CNULL(cp(1)) + " and cp02=" + CNULL(cp(2)) + " and cp03=" + CNULL(cp(3)) + " and cp04=" + CNULL(cp(4)) + " and cp10=" + CNULL(strCaseProperty)
rsRecordset.CursorLocation = adUseClient
rsRecordset.Open strSql, cnnConnection, adOpenDynamic
If Not rsRecordset.EOF And Not rsRecordset.BOF Then
   For i = 0 To TF_CP - 1 'edit by nickc 2007/02/05 T_CP - 1
          cp(i + 1) = IIf(IsNull(rsRecordset.Fields(i)), "", rsRecordset.Fields(i))
   Next
   If intWhere <> 國外_CF Then
      cp(5) = ChangeWStringToTString(cp(5))
      cp(6) = ChangeWStringToTString(cp(6))
      cp(7) = ChangeWStringToTString(cp(7))
      cp(27) = ChangeWStringToTString(cp(27))
      cp(46) = ChangeWStringToTString(cp(46))
      cp(47) = ChangeWStringToTString(cp(47))
      cp(48) = ChangeWStringToTString(cp(48))
      cp(53) = ChangeWStringToTString(cp(53))
      cp(54) = ChangeWStringToTString(cp(54))
      cp(57) = ChangeWStringToTString(cp(57))
   End If
   cp(44) = ChangeCustomerS(cp(44))
   cp(55) = ChangeCustomerS(cp(55))
   cp(56) = ChangeCustomerS(cp(56))
   Cls003ReadCCaseProgressDatabase = 1
Else
   Cls003ReadCCaseProgressDatabase = 2
End If
rsRecordset.Close
Exit Function
ErrHand:
Cls003ReadCCaseProgressDatabase = 0
'edit by nickc 2007/02/05
'ErrorLog
MsgBox Err.Description
End Function
'讀取下一程序檔之法定期限
Public Function Cls003GetNextProgressLawDate(ByRef strCode() As String, ByRef strCaseProgress As String, ByRef strLawDate As String) As Boolean
Dim strSql As String, rsRecordset As New ADODB.Recordset

On Error GoTo ErrHand
strSql = "select np09 from nextprogress where np02=" + CNULL(strCode(1)) + " and np03=" + CNULL(strCode(2)) + " and np04=" + CNULL(strCode(3)) + " and np05=" + CNULL(strCode(4)) + " and np07=" + CNULL(strCaseProgress)
rsRecordset.CursorLocation = adUseClient
rsRecordset.Open strSql, cnnConnection, adOpenDynamic
If Not rsRecordset.EOF And Not rsRecordset.BOF Then
   strLawDate = IIf(IsNull(rsRecordset.Fields(0)), "", rsRecordset.Fields(0))
End If
Cls003GetNextProgressLawDate = True
rsRecordset.Close
Exit Function
ErrHand:
ShowMsg MsgText(9135)
'edit by nickc 2007/02/05
'ErrorLog
MsgBox Err.Description

End Function
'補件期限存檔
Public Function Cls003SaveAddDeadline(ByRef cp() As String, ByRef strAddDeadline1 As String, ByRef strAddDeadline2 As String, ByRef strAddDeadline3 As String, Optional intWhere As Integer = 國外_CF, Optional ByRef strUserNum As String) As Boolean
Dim i As Integer, varAddDeadLineTemp1, varAddDeadLineTemp2, varAddDeadLineTemp3, strTemp As String
'edit by nickc 2007/02/05 不用 dll 了
'Dim objPublicData   As Object
'edit by nickc 2007/02/05 不用 dll 了
'Set objPublicData = CreateObject("prjTaieDll.clsPublicData")
On Error GoTo ErrHand
If strAddDeadline1 <> "" Then
   varAddDeadLineTemp1 = Split(strAddDeadline1, ",")
   varAddDeadLineTemp2 = Split(strAddDeadline2, ",")
   varAddDeadLineTemp3 = Split(strAddDeadline3, ",")
   If strAddDeadline3 = "" Then
      'Modify By Cheng 2002/03/06
'      If objPublicData.SaveNewNextProgressDatabase(intWhere, cp(), CStr(varAddDeadLineTemp1(i)), CStr(varAddDeadLineTemp2(i)), 補文件) = False Then GoTo Err
      'edit by nickc 2007/02/05 不用 dll 了
      'If objPublicData.SaveNewNextProgressDatabase(intWhere, cp(), CStr(varAddDeadLineTemp1(i)), CStr(varAddDeadLineTemp2(i)), 補文件, , , , strUserNum) = False Then GoTo Err
      If ClsPDSaveNewNextProgressDatabase(intWhere, cp(), CStr(varAddDeadLineTemp1(i)), CStr(varAddDeadLineTemp2(i)), 補文件, , , , strUserNum) = False Then GoTo ErrHand
   Else
      For i = 0 To UBound(varAddDeadLineTemp1)
         'Modify By Cheng 2002/03/06
'         If objPublicData.SaveNewNextProgressDatabase(intWhere, cp(), CStr(varAddDeadLineTemp1(i)), CStr(varAddDeadLineTemp2(i)), 補文件, CStr(varAddDeadLineTemp3(i))) = False Then GoTo Err
         'edit by nickc 2007/02/05 不用 dll 了
         'If objPublicData.SaveNewNextProgressDatabase(intWhere, cp(), CStr(varAddDeadLineTemp1(i)), CStr(varAddDeadLineTemp2(i)), 補文件, CStr(varAddDeadLineTemp3(i)), , , strUserNum) = False Then GoTo Err
         If ClsPDSaveNewNextProgressDatabase(intWhere, cp(), CStr(varAddDeadLineTemp1(i)), CStr(varAddDeadLineTemp2(i)), 補文件, CStr(varAddDeadLineTemp3(i)), , , strUserNum) = False Then GoTo ErrHand
      Next
   End If
End If
Cls003SaveAddDeadline = True
'edit by nickc 2007/02/05 不用 dll 了
'Set objPublicData = Nothing
Exit Function
ErrHand:
'edit by nickc 2007/02/05
'ErrorLog
MsgBox Err.Description

End Function
'讀取客戶發明人檔
Public Function Cls003ReadInventor(ByRef strPetition() As String, ByRef strInventorNo1() As String, ByRef strInventorNo2() As String, ByRef strInventorName() As String) As Boolean
Dim strSql As String, rsRecordset As New ADODB.Recordset, i As Integer

On Error GoTo ErrHand
For i = 0 To 4
   strPetition(i) = Left(ChangeCustomerL(strPetition(i)), 8)
Next
'Modify By Sindy 2010/5/14
'strSql = "select in01,in02,in04 from inventor where in01=" + CNULL(strPetition(0)) + " or in01=" + CNULL(strPetition(1)) + " or in01=" + CNULL(strPetition(2)) + " or in01=" + CNULL(strPetition(3)) + " or in01=" + CNULL(strPetition(4))
strSql = "select in01,in02,in04||in05||in06 from inventor where in01=" + CNULL(strPetition(0)) + " or in01=" + CNULL(strPetition(1)) + " or in01=" + CNULL(strPetition(2)) + " or in01=" + CNULL(strPetition(3)) + " or in01=" + CNULL(strPetition(4))
rsRecordset.CursorLocation = adUseClient
rsRecordset.CursorType = adOpenDynamic
rsRecordset.Open strSql, cnnConnection
If rsRecordset.RecordCount > 0 Then
  i = 0
   Do While Not rsRecordset.EOF
         ReDim Preserve strInventorNo1(i)
         ReDim Preserve strInventorNo2(i)
         ReDim Preserve strInventorName(i)
         strInventorNo1(i) = rsRecordset.Fields(0)
         strInventorNo2(i) = rsRecordset.Fields(1)
         strInventorName(i) = IIf(IsNull(rsRecordset.Fields(2)), "", rsRecordset.Fields(2))
         rsRecordset.MoveNext
         i = i + 1
   Loop
   Cls003ReadInventor = True
Else
   ShowMsg MsgText(1002)
End If
Exit Function
ErrHand:
'edit by nickc 2007/02/05
'ErrorLog
MsgBox Err.Description
End Function

''專利CFP發文延期存檔
''intWhereComeFrom按延期鈕或延期性質 1:延期鈕     2:延期性質
'Public Function Cls003SaveCFPPubishTextDelayData(ByRef intWhereComeFrom, ByRef strDelayDate As String, ByRef StrDate1 As String, StrDate2 As String, ByRef cp() As String, ByRef strNextProgress() As String, ByRef strUserNum As String) As Boolean
''edit by nickc 2007/02/06 不用 dll 了
''Dim objPublicData As Object, strDataTemp() As String
'Dim strDataTemp() As String
''Add By Cheng 2002/11/14
'Dim BolTransOk As Boolean
'BolTransOk = True
'
'On Error GoTo ErrHand1
'cnnConnection.BeginTrans
''edit by nickc 2007/02/06 不用 dll 了
''Set objPublicData = CreateObject("prjTaieDll.clsPublicData")
''Modify By Cheng 2002/06/20
''If objPublicData.SaveDelayData(cp(9), strDelayDate, cp(6), cp(7)) = False Then GoTo Err
''edit by nickc 2007/02/06 不用 dll 了
''If objPublicData.SaveDelayData(cp(9), strDelayDate, cp(6), cp(7), "" & intWhereComeFrom) = False Then GoTo Err
'If ClsPDSaveDelayData(cp(9), strDelayDate, cp(6), cp(7)) = False Then GoTo ErrHand
'If intWhereComeFrom = 1 Then
'   cp(6) = StrDate1
'   cp(7) = StrDate2
'   'edit by nickc 2007/02/06 不用 dll 了
'   'If objPublicData.SaveCaseProgressDatabase(cp(), 國外_CF) = False Then GoTo Err
'   If ClsPDSaveCaseProgressDatabase(cp(), 國外_CF) = False Then GoTo ErrHand
'   'edit by nickc 2007/02/06
'   'ReDim strDataTemp(1 To T_CP) As String
'   ReDim strDataTemp(1 To TF_CP) As String
'   strDataTemp(1) = cp(1)
'   strDataTemp(2) = cp(2)
'   strDataTemp(3) = cp(3)
'   strDataTemp(4) = cp(4)
'   strDataTemp(5) = GetTodayDate
'   strDataTemp(6) = cp(6)
'   strDataTemp(7) = cp(7)
'   strDataTemp(9) = cp(9)
'   strDataTemp(10) = 延期
'   strDataTemp(12) = cp(12)
'   strDataTemp(13) = cp(13)
'   strDataTemp(14) = strUserNum
'   strDataTemp(20) = "N"
'   strDataTemp(26) = "N"
'   strDataTemp(27) = strDelayDate
'   strDataTemp(32) = "N"
'   strDataTemp(43) = cp(9)
'   strDataTemp(44) = cp(44)
'   'edit by nickc 2007/02/06 不用 dll 了
'   'If objPublicData.GetCaseThatCode(strDataTemp()) = False Then GoTo Err
'   'If objPublicData.SaveNewCaseProgressDatabase(內部收文, strDataTemp(), 國外_CF) = False Then GoTo Err
'   If ClsPDGetCaseThatCode(strDataTemp()) = False Then GoTo ErrHand
'   If ClsPDSaveNewCaseProgressDatabase(內部收文, strDataTemp(), 國外_CF) = False Then GoTo ErrHand
'ElseIf intWhereComeFrom = 2 Then
'   cp(27) = strDelayDate
'   'edit by nickc 2007/02/06 不用 dll 了
'   'If objPublicData.GetCaseThatCode(cp()) = False Then GoTo Err
'   'If objPublicData.SaveCaseProgressDatabase(cp(), 國外_CF) = False Then GoTo Err
'   'If objPublicData.SetNextProgressDate(strNextProgress(), StrDate1, StrDate2) = False Then GoTo Err
'   If ClsPDGetCaseThatCode(cp()) = False Then GoTo ErrHand
'   If ClsPDSaveCaseProgressDatabase(cp(), 國外_CF) = False Then GoTo ErrHand
'   If ClsPDSetNextProgressDate(strNextProgress(), StrDate1, StrDate2) = False Then GoTo ErrHand
'End If
''edit by nickc 2007/02/06 不用 dll 了
''Set objPublicData = Nothing
'Cls003SaveCFPPubishTextDelayData = True
'ErrHand:
'If Cls003SaveCFPPubishTextDelayData Then
'    'Modify By Cheng 2002/11/14
'    If BolTransOk Then
'        cnnConnection.CommitTrans
'    End If
'Else
'    'Modify By Cheng 2002/11/14
'    If BolTransOk Then
'        cnnConnection.RollbackTrans
'    End If
'End If
'Exit Function
'ErrHand1:
'    'Add By Cheng 2002/11/14
'    If Err.Number = -2147168237 Then
'       BolTransOk = False
'       Resume Next
'    End If
'
'cnnConnection.RollbackTrans
''edit by nickc 2007/02/05
''ErrorLog
'MsgBox Err.Description
'End Function

'專利CFP發文繳年費、維持費、延展費更新繳費年度、繳費日期
Public Function Cls003UpdateGiveMoneyDate(ByRef field() As String, ByRef strCountry As String, ByRef strDate1 As String, ByRef StrDate2 As String) As Boolean
Dim strSql As String, varTemp As Variant, i As Integer

On Error GoTo ErrHand
varTemp = Split(strCountry, ",")
For i = 0 To UBound(varTemp)
       If varTemp(i) <> "" Then
          strSql = "update patent set pa72=" + CNULL(strDate1) + ",pa73=" + CNULL(StrDate2) + _
             " where pa01=" + CNULL(field(1)) + " and pa02=" + CNULL(field(2)) + " and pa09=" + CNULL(CStr(varTemp(i)))
          cnnConnection.Execute strSql
       End If
Next
Cls003UpdateGiveMoneyDate = True
Exit Function
ErrHand:
   'edit by nickc 2007/02/05
   'ErrorLog
   MsgBox Err.Description
ErrHand1:
ShowMsg MsgText(1003)
End Function

'讀取國內外案件關聯表之Recordset
'iSitu 0 國內外案件資料維護資料(CFP) 1 讀取美國IDS資料 2 大陸發明
Public Function Cls003ReadCaseRelationRst(ByRef strEnginer As String, ByRef strDate1 As String, ByRef StrDate2 As String, ByVal iSitu As Integer) As ADODB.Recordset
Dim i As Integer, rsRecordset As New ADODB.Recordset
Dim strSql As String, strSQL1 As String, strSQL2 As String, StrSQL3 As String

On Error GoTo ErrHand
'edit by nickc 2007/02/05 不用 dll 了
'Dim objPublicData As Object
'Set objPublicData = CreateObject("prjTaieDll.clsPublicData")

Select Case iSitu
   Case 0 '國內外案件資料維護資料(CFP)
'   strSQL = "delete from casemap where (cm01,cm02,cm03,cm04) IN (select DISTINCT cm01,cm02,cm03,cm04 from casemap," & _
      "caseprogress where cm10='0' and cm01=cp01(+) and cm02=cp02(+) and cm03=cp03(+) and cm04=cp04(+) and CP27 IS NOT NULL AND " & _
      "cp10 in (" + CNULL(發明申請) + "," + CNULL(新型申請) + "," + CNULL(設計申請) + "," + CNULL(追加申請) + "," + CNULL(聯合申請) + ") " & _
      "union select DISTINCT cm01,cm02,cm03,cm04 from casemap," & _
      "caseprogress where cm10='0' and cm01=cp01(+) and cm02=cp02(+) and cm03=cp03(+) and cm04=cp04(+) and CP57 IS NOT NULL AND " & _
      "cp10 in (" + CNULL(發明申請) + "," + CNULL(新型申請) + "," + CNULL(設計申請) + "," + CNULL(追加申請) + "," + CNULL(聯合申請) + "))"
'   cnnConnection.Execute strSQL
   
'   strSQL = " and CP27 IS NULL and CP57 IS NULL and cp10 in (" + CNULL(發明申請) + "," + CNULL(新型申請) + "," + CNULL(設計申請) + "," + CNULL(追加申請) + "," + CNULL(聯合申請) + ")"
   strSQL1 = " and cp1.cp10 in (" + CNULL(發明申請) + "," + CNULL(新型申請) + "," + CNULL(設計申請) + "," + CNULL(追加申請) + "," + CNULL(聯合申請) + "," + CNULL(翻譯) + ")"
   
   If strEnginer <> "" Then
'      strSQL = strSQL & " and cp14=" + CNULL(strEnginer)
      strSql = " and c1.cp14=" + CNULL(strEnginer)
      strSQL1 = strSQL1 & " and cp1.cp14=" + CNULL(strEnginer)
   End If
   
'   strSQL2 = " and cp10 in (" + CNULL(發明申請) + "," + CNULL(新型申請) + "," + CNULL(設計申請) + "," + CNULL(追加申請) + "," + CNULL(聯合申請) + ")"
   StrSQL3 = " and cp2.cp10 in (" + CNULL(發明申請) + "," + CNULL(新型申請) + "," + CNULL(設計申請) + "," + CNULL(追加申請) + "," + CNULL(聯合申請) + "," + CNULL(翻譯) + ")"
   
   If strDate1 <> "" And StrDate2 <> "" Then
'      strSQL2 = strSQL2 & " and cp27 between " + strDate1 + " and " + strDate2
      strSQL2 = " and c2.cp27 between " + strDate1 + " and " + StrDate2
      StrSQL3 = StrSQL3 & " and cp2.cp27 between " + strDate1 + " and " + StrDate2
   ElseIf StrDate2 <> "" Then
'      strSQL2 = strSQL2 & " and (cp27<=" + strDate2 & " or cp27 is null)"
      strSQL2 = " and (c2.cp27<=" + StrDate2 & " or c2.cp27 is null)"
      StrSQL3 = StrSQL3 & " and (cp2.cp27<=" + StrDate2 & " or cp2.cp27 is null)"
   End If
   
   strSql = "select cm01 國外案號,cm02 國外案號,cm03 國外案號,cm04 國外案號," & _
      "nvl(pa1.pa05,nvl(pa1.pa06,pa1.pa07)) 案件名稱,st1.st02 承辦人,st3.st02 智權人員," & _
      "cm05 國內案號,cm06 國內案號,cm07 國內案號,cm08 國內案號," & _
      "nvl(pa2.pa05,nvl(pa2.pa06,pa2.pa07)) 案件名稱,st2.st02 承辦人,st4.st02 智權人員," & _
      SQLDate("CP2.CP27") & " 發文日," & SQLDate("CP2.CP57") & " 取消收文日,cm18 記錄 FROM " & _
      "(select cm01,cm02,cm03,cm04,cm05,cm06,cm07,cm08,cm18 from casemap,caseprogress c1,caseprogress c2 where " & _
      "CM10='0' AND cm01=c1.cp01 and cm02=c1.cp02 and cm03=c1.cp03 and cm04=c1.cp04 and " & _
      "(c1.cp01='P' OR c1.CP01='CFP') and c1.CP27 IS NULL and c1.CP57 IS NULL and " & _
      "c1.cp10 in ('101','102','103','104','105','125','201')" & strSql & " and cm05=c2.cp01 and cm06=c2.cp02 and " & _
      "cm07=c2.cp03 and cm08=c2.cp04 and (c2.cp01='P' OR c2.CP01='CFP') and " & _
      "c2.cp10 in ('101','102','103','104','105','125','201')" & strSQL2 & ")," & _
      "patent pa1,patent pa2,caseprogress cp1,caseprogress cp2,staff st1,staff st2,staff st3,staff st4 where " & _
      "cm01=pa1.pa01(+) and cm02=pa1.pa02(+) and cm03=pa1.pa03(+) and cm04=pa1.pa04(+) and " & _
      "cm01=cp1.cp01(+) and cm02=cp1.cp02(+) and cm03=cp1.cp03(+) and cm04=cp1.cp04(+)" & strSQL1 & _
      " and cp1.cp14=st1.st01(+) and cp1.cp13=st3.st01(+) and " & _
      "cm05=pa2.pa01(+) and cm06=pa2.pa02(+) and cm07=pa2.pa03(+) and cm08=pa2.pa04(+) and " & _
      "cm05=cp2.cp01(+) and cm06=cp2.cp02(+) and cm07=cp2.cp03(+) and cm08=cp2.cp04(+)" & StrSQL3 & _
      " and cp2.cp14=st2.st01(+) and cp2.cp13=st4.st01(+) ORDER BY cm01,cm02,cm03,CM04"

'   strSQL = "select cm01 國外案號,cm02 國外案號,cm03 國外案號,cm04 國外案號," & _
      "nvl(pa1.pa05,nvl(pa1.pa06,pa1.pa07)) 案件名稱,st1.st02 承辦人,st3.st02 智權人員," & _
      "cm05 國內案號,cm06 國內案號,cm07 國內案號,cm08 國內案號," & _
      "nvl(pa2.pa05,nvl(pa2.pa06,pa2.pa07)) 案件名稱,st2.st02 承辦人,st4.st02 智權人員," & _
      SQLDate("CP2.CP27") & " 發文日," & SQLDate("CP2.CP57") & " 取消收文日 FROM " & _
      "(select cm01,cm02,cm03,cm04,cm05,cm06,cm07,cm08 from casemap where CM10='0' AND ((cm01,cm02,cm03,cm04) in " & _
      "(select cp01,cp02,cp03,cp04 from caseprogress where (cp01='P' OR CP01='CFP')" & strSQL & ") or " & _
      "(cm05,cm06,cm07,cm08) in (select cp01,cp02,cp03,cp04 from caseprogress where (cp01='P' OR CP01='CFP')" & strSQL2 & ")))," & _
      "patent pa1,patent pa2,caseprogress cp1,caseprogress cp2,staff st1,staff st2,staff st3,staff st4 where " & _
      "cm01=pa1.pa01(+) and cm02=pa1.pa02(+) and cm03=pa1.pa03(+) and cm04=pa1.pa04(+) and " & _
      "cm01=cp1.cp01(+) and cm02=cp1.cp02(+) and cm03=cp1.cp03(+) and cm04=cp1.cp04(+)" & strSQL1 & _
      " and cp1.cp14=st1.st01(+) and cp1.cp13=st3.st01(+) and " & _
      "cm05=pa2.pa01(+) and cm06=pa2.pa02(+) and cm07=pa2.pa03(+) and cm08=pa2.pa04(+) and " & _
      "cm05=cp2.cp01(+) and cm06=cp2.cp02(+) and cm07=cp2.cp03(+) and cm08=cp2.cp04(+)" & strSQL3 & _
      " and cp2.cp14=st2.st01(+) and cp2.cp13=st4.st01(+) ORDER BY cm01,cm02,cm03,CM04"
      
Case 1 '讀取美國IDS資料

   strSql = "delete from casemap where (cm05,cm06,cm07,cm08) IN (select DISTINCT cm01,cm02,cm03,cm04 from casemap," & _
      "caseprogress where cm10='1' and cm01=cp01(+) and cm02=cp02(+) and cm03=cp03(+) and cm04=cp04(+) and cp10=" + CNULL(檢索報告) & " and CP27 IS NOT NULL " & _
      "union select DISTINCT cm01,cm02,cm03,cm04 from casemap," & _
      "caseprogress where cm10='1' and cm01=cp01(+) and cm02=cp02(+) and cm03=cp03(+) and cm04=cp04(+) and cp10=" + CNULL(檢索報告) & " and CP57 IS NOT NULL)"
   cnnConnection.Execute strSql
   
   strSql = " and cp10 in (" + CNULL(發明申請) + "," + CNULL(新型申請) + "," + CNULL(設計申請) + "," + CNULL(追加申請) + "," + CNULL(聯合申請) + ")"
   strSQL1 = " and cp1.cp10 in (" + CNULL(發明申請) + "," + CNULL(新型申請) + "," + CNULL(設計申請) + "," + CNULL(追加申請) + "," + CNULL(聯合申請) + ")"
   If strEnginer <> "" Then
      strSql = strSql & " and cp14=" + CNULL(strEnginer)
      strSQL1 = strSQL1 & " and cp1.cp14=" + CNULL(strEnginer)
   End If
   
   strSQL2 = " and cp10 =" & CNULL(檢索報告)
   StrSQL3 = " and " & CNULL(檢索報告) & "=cp2.cp10(+) "
   If strDate1 <> "" And StrDate2 <> "" Then
      strSQL2 = strSQL2 & " and cp05 between " + strDate1 + " and " + StrDate2
      StrSQL3 = StrSQL3 & " and cp2.cp05 between " + strDate1 + " and " + StrDate2
   ElseIf StrDate2 <> "" Then
      strSQL2 = strSQL2 & " and (cp05<=" + StrDate2 & " or cp05 is null)"
      StrSQL3 = StrSQL3 & " and (cp2.cp05<=" + StrDate2 & " or cp2.cp05 is null)"
   End If
   
   strSql = "select cm01 美國案號,cm02 美國案號,cm03 美國案號,cm04 美國案號,nvl(pa1.pa05,nvl(pa1.pa06,pa1.pa07)) 案件名稱,st1.st02 承辦人," & _
      "cm05 EPC_英國案號,cm06 EPC_英國案號,cm07 EPC_英國案號,cm08 EPC_英國案號,nvl(pa2.pa05,nvl(pa2.pa06,pa2.pa07)) 案件名稱,st2.st02 承辦人," & _
      SQLDate("CP2.CP05") & " 收文日 FROM " & _
      "(select cm01,cm02,cm03,cm04,cm05,cm06,cm07,cm08 from casemap where CM10='1' AND ((cm01,cm02,cm03,cm04) in " & _
      "(select cp01,cp02,cp03,cp04 from caseprogress where CP01='CFP'" & strSql & ") OR " & _
      "(cm05,cm06,cm07,cm08) in (select cp01,cp02,cp03,cp04 from caseprogress where cp01='CFP'" & strSQL2 & ")))," & _
      "patent pa1,patent pa2,caseprogress cp1,caseprogress cp2,staff st1,staff st2 where " & _
      "cm01=pa1.pa01(+) and cm02=pa1.pa02(+) and cm03=pa1.pa03(+) and cm04=pa1.pa04(+) and pa1.pa09='101' and " & _
      "cm01=cp1.cp01(+) and cm02=cp1.cp02(+) and cm03=cp1.cp03(+) and cm04=cp1.cp04(+)" & strSQL1 & _
      " and cp1.cp14=st1.st01(+) and " & _
      "cm05=pa2.pa01(+) and cm06=pa2.pa02(+) and cm07=pa2.pa03(+) and cm08=pa2.pa04(+) and pa2.pa09 IN ('221','201') and " & _
      "cm05=cp2.cp01(+) and cm06=cp2.cp02(+) and cm07=cp2.cp03(+) and cm08=cp2.cp04(+)" & StrSQL3 & _
      " and cp2.cp14=st2.st01(+) ORDER BY cm01,cm02,cm03,CM04"
Case 2 '大陸發明
    'Add by Lydia 2014/10/31 開放外專程序人員(31,33,34)可進入專利處系統操作FMP寰華案件，但非此類案件時外專程序人員不可操作。
     Dim midSql As String
     If FMP2open = True Then
        '國內外案件關聯判斷國外案號(cm01~cm04),香港大陸案判斷大陸案號(cm01~cm04)
        midSql = Replace(FMP2openSQL, "f0.CP", "pa1.PA")
       ' If Len(midSql) > 0 Then midSql = Mid(midSql, 5, Len(midSql) - 4) & " and"
     End If
     
   strSql = "delete from casemap where (cm01,cm02,cm03,cm04) IN (select DISTINCT cm01,cm02,cm03,cm04 from casemap," & _
      "caseprogress where cm10='2' and cm01=cp01(+) and cm02=cp02(+) and cm03=cp03(+) and cm04=cp04(+) and cp24='1' and CP25 IS NOT NULL AND " & _
      "cp10 in (" + CNULL(發明申請) + "," + CNULL(新型申請) + "," + CNULL(設計申請) + "," + CNULL(追加申請) + "," + CNULL(聯合申請) + ") " & _
      "union select DISTINCT cm01,cm02,cm03,cm04 from casemap," & _
      "caseprogress where cm10='2' and cm01=cp01(+) and cm02=cp02(+) and cm03=cp03(+) and cm04=cp04(+) and CP57 IS NOT NULL AND " & _
      "cp10 in (" + CNULL(發明申請) + "," + CNULL(新型申請) + "," + CNULL(設計申請) + "," + CNULL(追加申請) + "," + CNULL(聯合申請) + "))"
   cnnConnection.Execute strSql
   
   strSql = " and cp10 in (" + CNULL(發明申請) + "," + CNULL(新型申請) + "," + CNULL(設計申請) + "," + CNULL(追加申請) + "," + CNULL(聯合申請) + ")"
   strSQL1 = "cp1.cp10 in (" + CNULL(發明申請) + "," + CNULL(新型申請) + "," + CNULL(設計申請) + "," + CNULL(追加申請) + "," + CNULL(聯合申請) + ") and "
   
   strSQL2 = " and cp10 in (" + CNULL(發明申請) + "," + CNULL(新型申請) + "," + CNULL(設計申請) + "," + CNULL(追加申請) + "," + CNULL(聯合申請) + ")"
   StrSQL3 = " AND cp2.cp10 in (" + CNULL(發明申請) + "," + CNULL(新型申請) + "," + CNULL(設計申請) + "," + CNULL(追加申請) + "," + CNULL(聯合申請) + ")"
   
   If strDate1 <> "" And StrDate2 <> "" Then
      strSQL2 = strSQL2 & " and cp25 between " + strDate1 + " and " + StrDate2
      StrSQL3 = StrSQL3 & " AND cp2.cp25 between " + strDate1 + " and " + StrDate2
   ElseIf StrDate2 <> "" Then
      strSQL2 = strSQL2 & " and (cp25<=" + StrDate2 & " or cp25 is null)"
      StrSQL3 = StrSQL3 & " AND (cp2.cp25<=" + StrDate2 & " or cp2.cp25 is null)"
   End If
   
   If strEnginer <> "" Then
      strSQL2 = strSQL2 & " and cp14=" + CNULL(strEnginer)
      StrSQL3 = StrSQL3 & " AND cp2.cp14=" + CNULL(strEnginer)
   End If
   
   strSql = "select cm01 大陸發明案號,cm02 大陸發明案號,cm03 大陸發明案號,cm04 大陸發明案號,nvl(pa1.pa05,nvl(pa1.pa06,pa1.pa07)) 案件名稱," & SQLDate("CP1.CP27") & " 發文日," & _
      "cm05 CF案號,cm06 CF案號,cm07 CF案號,cm08 CF案號,nvl(pa2.pa05,nvl(pa2.pa06,pa2.pa07)) 案件名稱," & _
      SQLDate("CP2.CP27") & " 發文日," & SQLDate("CP2.CP25") & " 准駁日," & SQLDate("CP2.CP57") & " 取消收文日,CM09 處理狀況 FROM " & _
      "(select cm01,cm02,cm03,cm04,cm05,cm06,cm07,cm08,CM09 from casemap where CM10='2' AND ((cm01,cm02,cm03,cm04) in " & _
      "(select cp01,cp02,cp03,cp04 from caseprogress where CP01='P'" & strSql & ") OR " & _
      "(cm05,cm06,cm07,cm08) in (select cp01,cp02,cp03,cp04 from caseprogress where cp01='CFP'" & strSQL2 & ")))," & _
      "patent pa1,patent pa2,caseprogress cp1,caseprogress cp2 where " & _
      "cm01=pa1.pa01(+) and cm02=pa1.pa02(+) and cm03=pa1.pa03(+) and cm04=pa1.pa04(+) and pa1.pa09='" & 大陸國家代號 & "' and " & _
      "cm01=cp1.cp01(+) and cm02=cp1.cp02(+) and cm03=cp1.cp03(+) and cm04=cp1.cp04(+) and " & strSQL1 & _
      "cm05=pa2.pa01(+) and cm06=pa2.pa02(+) and cm07=pa2.pa03(+) and cm08=pa2.pa04(+) and " & _
      "cm05=cp2.cp01(+) and cm06=cp2.cp02(+) and cm07=cp2.cp03(+) and cm08=cp2.cp04(+)" & StrSQL3 & midSql & " ORDER BY cm01,cm02,cm03,CM04"
      
End Select
'Clipboard.Clear
'Clipboard.SetText strSQL
'edit by nickc 2007/02/05 不用 dll 了
'Set Cls003ReadCaseRelationRst = objPublicData.ReadRst(strSQL)
Set Cls003ReadCaseRelationRst = ClsPDReadRst(strSql)
'Set objPublicData = Nothing
Exit Function
ErrHand:
'edit by nickc 2007/02/05
'ErrorLog
MsgBox Err.Description

End Function

'新增國內外案件關聯表
'iSitu 0 國內外案件資料維護資料 1 讀取美國IDS資料 2 大陸發明
Public Function Cls003InsertCaseRelationData(ByRef strCode() As String, ByVal iSitu As Integer) As Boolean
 Dim strSql As String, strTxt(0 To 3) As String, i As Integer
 Dim rsRecordset As New ADODB.Recordset, strTmp As String
On Error GoTo ErrHand
strCode(2) = IIf(strCode(2) = "", "0", strCode(2))
strCode(3) = IIf(strCode(3) = "", "00", strCode(3))
strCode(6) = IIf(strCode(6) = "", "0", strCode(6))
strCode(7) = IIf(strCode(7) = "", "00", strCode(7))
Select Case iSitu
   Case 0
      For i = 4 To 7
         strTxt(i - 4) = strCode(i)
      Next
      If Not Cls003ChkDocu(strTxt, "CP27") Then
         strSql = "SELECT CP09 FROM CASEPROGRESS WHERE CP01='" & strCode(0) & "' AND CP02='" & strCode(1) & _
            "' AND CP03='" & strCode(2) & "' AND CP04='" & strCode(3) & "' AND " & _
            "CP10 in ('" & 發明申請 & "','" & 新型申請 & "','" & 設計申請 & "','" & 追加申請 & "','" & 聯合申請 & "','" & 翻譯 & "')"
         rsRecordset.CursorLocation = adUseClient
         rsRecordset.Open strSql, cnnConnection, adOpenDynamic
         If Not rsRecordset.BOF And Not rsRecordset.EOF Then
            strTmp = rsRecordset.Fields(0).Value
         Else
            strTmp = ""
         End If
         rsRecordset.Close
         strSql = "SELECT COUNT(*) FROM ENGINEERPROGRESS WHERE EP02=" & CNULL(strTmp)
         rsRecordset.CursorLocation = adUseClient
         rsRecordset.Open strSql, cnnConnection, adOpenDynamic
         If rsRecordset.Fields(0) = 0 Then
            MsgBox "無法更新國外案之文件齊備日 !", vbInformation
         Else
            strSql = "UPDATE ENGINEERPROGRESS SET EP06=" & GetTodayDate & " WHERE EP02=" & CNULL(strTmp) & " AND EP06 IS NULL"
            cnnConnection.Execute strSql
         End If
      End If
      
      strSql = "insert into casemap (cm01,cm02,cm03,cm04,cm05,cm06,cm07,cm08,cm10) values (" + CNULL(strCode(0)) + "," + CNULL(strCode(1)) + "," + CNULL(strCode(2)) + "," + CNULL(strCode(3)) + "," + CNULL(strCode(4)) + "," + CNULL(strCode(5)) + "," + CNULL(strCode(6)) + "," + CNULL(strCode(7)) + ",'" & iSitu & "')"
   Case 1
      strSql = "insert into casemap (cm01,cm02,cm03,cm04,cm05,cm06,cm07,cm08,cm10) values (" + CNULL(strCode(0)) + "," + CNULL(strCode(1)) + "," + CNULL(strCode(2)) + "," + CNULL(strCode(3)) + "," + CNULL(strCode(4)) + "," + CNULL(strCode(5)) + "," + CNULL(strCode(6)) + "," + CNULL(strCode(7)) + ",'" & iSitu & "')"
   Case 2
      For i = 4 To 7
         strTxt(i - 4) = strCode(i)
      Next
      If Not Cls003ChkDocu(strTxt, "CP25") Then
         strSql = "SELECT CP09 FROM CASEPROGRESS WHERE CP01='" & strCode(0) & "' AND CP02='" & strCode(1) & _
            "' AND CP03='" & strCode(2) & "' AND CP04='" & strCode(3) & "' AND " & _
            "CP10 in ('" & 發明申請 & "','" & 新型申請 & "','" & 設計申請 & "','" & 追加申請 & "','" & 聯合申請 & "')"
         rsRecordset.CursorLocation = adUseClient
         rsRecordset.Open strSql, cnnConnection, adOpenDynamic
         If Not rsRecordset.BOF And Not rsRecordset.EOF Then
            strTmp = rsRecordset.Fields(0).Value
         Else
            strTmp = ""
         End If
         rsRecordset.Close
         strSql = "SELECT COUNT(*) FROM ENGINEERPROGRESS WHERE EP02=" & CNULL(strTmp)
         rsRecordset.CursorLocation = adUseClient
         rsRecordset.Open strSql, cnnConnection, adOpenDynamic
         If rsRecordset.Fields(0) = 0 Then
            MsgBox "無法更新大陸發明案之文件齊備日 !", vbInformation
         Else
            strSql = "UPDATE ENGINEERPROGRESS SET EP06=" & GetTodayDate & " WHERE EP02=" & CNULL(strTmp) & " AND EP06 IS NULL"
            cnnConnection.Execute strSql
         End If
      End If
      
      strSql = "insert into casemap (cm01,cm02,cm03,cm04,cm05,cm06,cm07,cm08,cm10,cm09) values (" + CNULL(strCode(0)) + "," + CNULL(strCode(1)) + "," + CNULL(strCode(2)) + "," + CNULL(strCode(3)) + "," + CNULL(strCode(4)) + "," + CNULL(strCode(5)) + "," + CNULL(strCode(6)) + "," + CNULL(strCode(7)) + ",'" & iSitu & "'," + CNULL(strCode(8)) + ")"
End Select
cnnConnection.Execute strSql
Cls003InsertCaseRelationData = True
Exit Function
ErrHand:
ShowMsg MsgText(1005)
'edit by nickc 2007/02/05
'ErrorLog
MsgBox Err.Description

End Function

'修改國內外案件關聯表
'iSitu 0 國內外案件資料維護資料 1 讀取美國IDS資料 2 大陸發明
'Optional BolWDB As Boolean = False    910910 nick 是否觸發 tigger
Public Function Cls003UpdateCaseRelationData(ByRef strCode() As String, ByVal iSitu As Integer, Optional BolWDB As Boolean = False) As Boolean
Dim strSql As String, i As Integer
Dim strTmp As String
'Add By Cheng 2002/11/14
Dim BolTransOk As Boolean
BolTransOk = True

On Error GoTo ErrHand
strCode(2) = IIf(strCode(2) = "", "0", strCode(2))
strCode(3) = IIf(strCode(3) = "", "00", strCode(3))
strCode(6) = IIf(strCode(6) = "", "0", strCode(6))
strCode(7) = IIf(strCode(7) = "", "00", strCode(7))

If iSitu = 2 Then
   strSql = "update casemap set cm01=" + CNULL(strCode(0)) + ",cm02=" + CNULL(strCode(1)) + _
      ",cm03=" + CNULL(strCode(2)) + ",cm04=" + CNULL(strCode(3)) + ",cm05=" + CNULL(strCode(4)) + _
      ",cm06=" + CNULL(strCode(5)) + ",cm07=" + CNULL(strCode(6)) + ",cm08=" + CNULL(strCode(7)) + _
      ",cm09=" + CNULL(strCode(16)) & " where cm01=" + CNULL(strCode(8)) + " and " & _
      "cm02=" + CNULL(strCode(9)) + " and cm03=" + CNULL(strCode(10)) + " and " & _
      "cm04=" + CNULL(strCode(11)) + " and cm05=" + CNULL(strCode(12)) + " and " & _
      "cm06=" + CNULL(strCode(13)) + " and cm07=" + CNULL(strCode(14)) + " and " & _
      "cm08=" + CNULL(strCode(15)) + " and cm10='" & iSitu & "'"
Else
   'Modified by Lydia 2015/07/27 +香港案,澳門案
   'If iSitu = 0 Then
   If iSitu = 0 Or iSitu = 4 Or iSitu = 5 Then
      strTmp = ",CM18=" & CNULL(strCode(16))
   Else
      strTmp = ""
   End If
   strSql = "update casemap set cm01=" + CNULL(strCode(0)) + ",cm02=" + CNULL(strCode(1)) + _
      ",cm03=" + CNULL(strCode(2)) + ",cm04=" + CNULL(strCode(3)) + ",cm05=" + CNULL(strCode(4)) + _
      ",cm06=" + CNULL(strCode(5)) + ",cm07=" + CNULL(strCode(6)) + ",cm08=" + CNULL(strCode(7)) + _
      strTmp & " where cm01=" + CNULL(strCode(8)) + " and cm02=" + CNULL(strCode(9)) + " and " & _
      "cm03=" + CNULL(strCode(10)) + " and cm04=" + CNULL(strCode(11)) + " and " & _
      "cm05=" + CNULL(strCode(12)) + " and cm06=" + CNULL(strCode(13)) + " and " & _
      "cm07=" + CNULL(strCode(14)) + " and cm08=" + CNULL(strCode(15)) + " and " & _
      "cm10='" & iSitu & "'"
End If
'910910 nick tigger
'***** stert
If BolWDB = True Then
    strSql = "begin user_data.user_enabled:=1; " & strSql & ";end;"
    
End If
'***** end
'910910 nick tigger
'***** start
cnnConnection.BeginTrans
'***** end
cnnConnection.Execute strSql, i
'910910 nick tigger
'***** start
'Modify By Cheng 2002/11/14
If BolTransOk Then
    cnnConnection.CommitTrans
End If
'***** end
If i = 0 Then ShowMsg MsgText(1007)
Cls003UpdateCaseRelationData = True
Exit Function
ErrHand:
    'Add By Cheng 2002/11/14
    If Err.Number = -2147168237 Then
       BolTransOk = False
       Resume Next
    End If

'910910 nick tigger
'***** start
cnnConnection.RollbackTrans
'***** end
ShowMsg MsgText(1006)
'edit by nickc 2007/02/05
'ErrorLog
MsgBox Err.Description

End Function

'bolTmp False 新案 True 檢索報告
Private Function Cls003ChkDocu(ByRef strCode() As String, ByVal strTmp As String, Optional bolTmp As Boolean = False) As Boolean
 Dim strSql As String, rsRecordset As New ADODB.Recordset, strTmp1 As String, i As Integer
On Error GoTo ErrHand
   Cls003ChkDocu = False
   Select Case strTmp
      Case "CP25"
         strTmp1 = "准駁"
      Case "CP27"
         strTmp1 = "發文"
      Case "CP57"
         strTmp1 = "取消收文"
   End Select
   If bolTmp Then
      strSql = "SELECT CP09 FROM CASEPROGRESS WHERE CP01='" & strCode(0) & "' AND CP02='" & strCode(1) & "' AND CP03='" & strCode(2) & _
         "' AND CP04='" & strCode(3) & "' AND CP10='" & 檢索報告 & "' AND " & strTmp & " IS NOT NULL"
   Else
      strSql = "SELECT CP09 FROM CASEPROGRESS WHERE CP01='" & strCode(0) & "' AND CP02='" & strCode(1) & _
         "' AND CP03='" & strCode(2) & "' AND CP04='" & strCode(3) & "' AND " & _
         "CP10 in ('" & 發明申請 & "','" & 新型申請 & "','" & 設計申請 & "','" & 追加申請 & "','" & 聯合申請 & "','" & 翻譯 & "')" & _
         " AND " & strTmp & " IS NOT NULL"
   End If
   rsRecordset.CursorLocation = adUseClient
   rsRecordset.Open strSql, cnnConnection, adOpenDynamic
   If Not rsRecordset.BOF And Not rsRecordset.EOF Then
      ' 90.07.01 modify by louis
      'ShowMsg strCode(0) & strCode(1) & strCode(2) & strCode(3) & "已有" & strTmp1 & "日 !"
      If m_ShowMsg = True Then
         ShowMsg strCode(0) & strCode(1) & strCode(2) & strCode(3) & "已有" & strTmp1 & "日 !"
      End If
   Else
      Cls003ChkDocu = True
   End If
Exit Function
ErrHand:
   ShowMsg Err.Description
      'edit by nickc 2007/02/05
   'ErrorLog
   MsgBox Err.Description
End Function

Public Function Cls003ChkCaseMap(ByRef strCode() As String, ByVal iSitu As Integer) As Boolean
 Dim strSql As String, rsRecordset As New ADODB.Recordset
 Dim strWhich As String
 Dim strTmp1(0 To 3) As String, strTmp2(0 To 3) As String, i As Integer
   Cls003ChkCaseMap = False
   strCode(2) = IIf(strCode(2) = "", "0", strCode(2))
   strCode(3) = IIf(strCode(3) = "", "00", strCode(3))
   strCode(6) = IIf(strCode(6) = "", "0", strCode(6))
   strCode(7) = IIf(strCode(7) = "", "00", strCode(7))
   Select Case iSitu
      Case 0
         strWhich = "國內外"
      Case 1
         strWhich = "美國 IDS"
      Case 2
         strWhich = "CF"
   End Select
   strSql = "select count(*) from casemap where cm01=" + CNULL(strCode(0)) + " and cm02=" + CNULL(strCode(1)) + _
      " and cm03=" + CNULL(strCode(2)) + " and cm04=" + CNULL(strCode(3)) + " and cm05=" + CNULL(strCode(4)) + _
      " and cm06=" + CNULL(strCode(5)) + " and cm07=" + CNULL(strCode(6)) + " and cm08=" + CNULL(strCode(7)) + _
      " and cm10='" & iSitu & "'"
   rsRecordset.CursorLocation = adUseClient
   rsRecordset.Open strSql, cnnConnection, adOpenDynamic
   If rsRecordset.Fields(0) > 0 Then
      ShowMsg strWhich & "案件關聯資料已存在，請重新輸入 !"
   Else
      For i = 0 To 3
         strTmp1(i) = strCode(i)
      Next
      For i = 0 To 3
         strTmp2(i) = strCode(i + 4)
      Next
      Select Case iSitu
         Case 0
            If Cls003ChkDocu(strTmp1, "CP27") Then
               If Cls003ChkDocu(strTmp1, "CP57") Then
                  If Cls003ChkDocu(strTmp2, "CP57") Then
                     Cls003ChkCaseMap = True
                  End If
               End If
            End If
         Case 1
            rsRecordset.Close
            strSql = "select count(*) from patent where pa01=" + CNULL(strCode(0)) + " and pa02=" + CNULL(strCode(1)) + _
               " and pa03=" + CNULL(strCode(2)) + " and pa04=" + CNULL(strCode(3)) + " and pa09='101'"
            rsRecordset.CursorLocation = adUseClient
            rsRecordset.Open strSql, cnnConnection, adOpenDynamic
            If rsRecordset.Fields(0) = 0 Then
               ShowMsg "非美國案，請重新輸入 !"
               Exit Function
            End If
            
            rsRecordset.Close
            strSql = "select count(*) from patent where pa01=" + CNULL(strCode(4)) + " and pa02=" + CNULL(strCode(5)) + _
               " and pa03=" + CNULL(strCode(6)) + " and pa04=" + CNULL(strCode(7)) + " and pa09 IN ('221','201')"
            rsRecordset.CursorLocation = adUseClient
            rsRecordset.Open strSql, cnnConnection, adOpenDynamic
            If rsRecordset.Fields(0) = 0 Then
               ShowMsg "非英國或 EPC 案，請重新輸入 !"
               Exit Function
            End If
            'Modify By Cheng 2002/12/11
            '取消檢查CP27
'            If ChkDocu(strTmp1, "CP27") Then
'               If ChkDocu(strTmp1, "CP57") Then
'                  If ChkDocu(strTmp2, "CP27", True) Then
'                     If ChkDocu(strTmp2, "CP57", True) Then
'                        ChkCaseMap = True
'                     End If
'                  End If
'               End If
'            End If
               If Cls003ChkDocu(strTmp1, "CP57") Then
                    If Cls003ChkDocu(strTmp2, "CP57", True) Then
                       Cls003ChkCaseMap = True
                    End If
               End If
         Case 2
            rsRecordset.Close
            strSql = "select count(*) from patent where pa01=" + CNULL(strCode(0)) + " and pa02=" + CNULL(strCode(1)) + _
               " and pa03=" + CNULL(strCode(2)) + " and pa04=" + CNULL(strCode(3)) + " and pa09='020' and pa08='1'"
            rsRecordset.CursorLocation = adUseClient
            rsRecordset.Open strSql, cnnConnection, adOpenDynamic
            If rsRecordset.Fields(0) = 0 Then
               ShowMsg "非大陸發明案，請重新輸入 !"
            Else
               If Cls003ChkDocu(strTmp1, "CP27") Then
                  If Cls003ChkDocu(strTmp1, "CP57") Then
                     If Cls003ChkDocu(strTmp2, "CP57") Then
                        Cls003ChkCaseMap = True
                     End If
                  End If
               End If
            End If
      End Select
   End If
End Function

Public Function Cls003ChkExist(ByRef strCode() As String, ByVal iSitu As Integer) As Boolean
 Dim strSql As String, rsRecordset As New ADODB.Recordset
   strCode(2) = IIf(strCode(2) = "", "0", strCode(2))
   strCode(3) = IIf(strCode(3) = "", "00", strCode(3))
   strCode(6) = IIf(strCode(6) = "", "0", strCode(6))
   strCode(7) = IIf(strCode(7) = "", "00", strCode(7))
   strSql = "select count(*) from casemap where cm01=" + CNULL(strCode(0)) + " and cm02=" + CNULL(strCode(1)) + _
      " and cm03=" + CNULL(strCode(2)) + " and cm04=" + CNULL(strCode(3)) + " and cm05=" + CNULL(strCode(4)) + _
      " and cm06=" + CNULL(strCode(5)) + " and cm07=" + CNULL(strCode(6)) + " and cm08=" + CNULL(strCode(7)) + _
      " and cm10='" & iSitu & "'"
   rsRecordset.CursorLocation = adUseClient
   rsRecordset.Open strSql, cnnConnection, adOpenDynamic
   If rsRecordset.Fields(0) = 0 Then
      ShowMsg "案件關聯資料不存在，請重新輸入 !"
      Cls003ChkExist = False
   Else
      Cls003ChkExist = True
   End If
End Function

'判斷本所案號是否存在國內外案件關聯表中
'iSitu 0 國內外案件資料維護資料 1 讀取美國IDS資料 2 大陸發明
Public Function Cls003ReadCaseRelationData(ByRef strCode1 As String, ByRef strCode2 As String, ByRef strCode3 As String, ByRef strCode4 As String, ByRef strCode5 As String, ByRef strCode6 As String, ByRef strCode7 As String, ByRef strCode8 As String, ByVal iSitu As Integer) As Boolean
Dim strSql As String, rsRecordset As New ADODB.Recordset

On Error GoTo ErrHand
strCode3 = IIf(strCode3 = "", "0", strCode3)
strCode4 = IIf(strCode4 = "", "00", strCode4)
strCode7 = IIf(strCode7 = "", "0", strCode7)
strCode8 = IIf(strCode8 = "", "00", strCode8)
strSql = "select cm01 from casemap where cm01=" + CNULL(strCode1) + " and cm02=" + CNULL(strCode2) + " and cm03=" + CNULL(strCode3) + " and cm04=" + CNULL(strCode4) + " and cm05=" + CNULL(strCode5) + " and cm06=" + CNULL(strCode6) + " and cm07=" + CNULL(strCode7) + " and cm08=" + CNULL(strCode8) + " and cm10='" & iSitu & "'"
rsRecordset.CursorLocation = adUseClient
rsRecordset.Open strSql, cnnConnection, adOpenDynamic
If Not rsRecordset.EOF And Not rsRecordset.BOF Then
   Cls003ReadCaseRelationData = True
Else
   ShowMsg MsgText(1007)
End If
Exit Function
ErrHand:
ShowMsg MsgText(1008)
'edit by nickc 2007/02/05
'ErrorLog
MsgBox Err.Description

End Function

'讀取國內案件關聯表之資料
'iSitu 0 國內外案件資料維護資料 1 讀取美國IDS資料 2 大陸發明
Public Function Cls003GetCaseRelationDataIn(ByRef strCode1 As String, ByRef strCode2 As String, _
   ByRef strCode3 As String, ByRef strCode4 As String, ByRef strPromoter As String, _
   ByRef strSendDay As String, ByVal iSitu As Integer, Optional strSales As String) As Boolean
Dim strSql As String, rsRecordset As New ADODB.Recordset, strWhich As String
Dim strTmp As String
On Error GoTo ErrHand
Select Case iSitu
   Case 0
      strWhich = "國內"
      strTmp = "cp27"
   Case 1
      strWhich = "EPC,英國"
      strTmp = "cp05"
   Case 2
      strWhich = "CF"
      strTmp = "cp25"
End Select

strPromoter = ""
strSales = ""
strSendDay = ""

strCode3 = IIf(strCode3 = "", "0", strCode3)
strCode4 = IIf(strCode4 = "", "00", strCode4)

strSql = "select s1.st02," & strTmp & ",cp10,s2.st02 from caseprogress,staff s1,staff s2 where " & _
   "cp01=" + CNULL(strCode1) + " and " & "cp02=" + CNULL(strCode2) + _
   " and cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + _
   " and cp10 in ('" & 發明申請 & "', '" & 新型申請 & "', '" & 設計申請 & "', '" & 追加申請 & "', '" & 聯合申請 & "', '" & 翻譯 & "', '" & 檢索報告 & "') and " & _
   "cp14=s1.st01(+) and cp13=s2.st01(+)"

rsRecordset.CursorLocation = adUseClient
rsRecordset.Open strSql, cnnConnection, adOpenDynamic
If Not rsRecordset.EOF And Not rsRecordset.BOF Then
   If iSitu <> 1 Then
      If rsRecordset.Fields(2) = 發明申請 Or rsRecordset.Fields(2) = 新型申請 Or _
            rsRecordset.Fields(2) = 設計申請 Or rsRecordset.Fields(2) = 追加申請 Or rsRecordset.Fields(2) = 聯合申請 Or rsRecordset.Fields(2) = 翻譯 Then
         Cls003GetCaseRelationDataIn = True
      End If
   Else
      If rsRecordset.Fields(2) = 檢索報告 Then
         Cls003GetCaseRelationDataIn = True
      End If
   End If
   If Cls003GetCaseRelationDataIn Then
      strPromoter = IIf(IsNull(rsRecordset.Fields(0)), "", rsRecordset.Fields(0))
      strSendDay = IIf(IsNull(rsRecordset.Fields(1)), "", rsRecordset.Fields(1))
      If Not IsNull(rsRecordset.Fields(3)) Then strSales = rsRecordset.Fields(3)
      Cls003GetCaseRelationDataIn = True
   Else
      ' 90.07.03 modify by louis
      If m_ShowMsg = True Then
         ShowMsg MsgText(1009)
      End If
   End If
Else
   ShowMsg strWhich + MsgText(1010)
End If
Exit Function
ErrHand:
ShowMsg MsgText(1008)
'edit by nickc 2007/02/05
'ErrorLog
MsgBox Err.Description

End Function

'讀取國內外案件關聯表之資料 ,預設0=從國外案(CM01~CM04)讀取國內案(CM05~CM06)
'iSitu 0 國內外案件資料維護資料 1 讀取美國IDS資料 2 大陸發明
Public Function Cls003GetCaseMap(ByRef strCode() As String, Optional iSitu As Integer = 0) As Boolean
 Dim strSql As String, rsRecordset As New ADODB.Recordset, i As Integer
On Error GoTo ErrHand
   strSql = "select cm05,cm06,cm07,cm08 from casemap where CM10='" & iSitu & "' AND " & _
      ChgCaseMap(strCode(0) & strCode(1) & strCode(2) & strCode(3)) & " ORDER BY CM05,CM06,CM07,CM08"
   rsRecordset.CursorLocation = adUseClient
   rsRecordset.Open strSql, cnnConnection, adOpenDynamic, adLockBatchOptimistic
   For i = 4 To 7
      strCode(i) = ""
   Next
   Do While Not rsRecordset.EOF
      With rsRecordset
         If Not IsNull(.Fields(0)) Then strCode(4) = .Fields(0)
         If Not IsNull(.Fields(1)) Then strCode(5) = .Fields(1)
         If Not IsNull(.Fields(2)) Then
            strCode(6) = .Fields(2)
         Else
            strCode(6) = "0"
         End If
         If Not IsNull(.Fields(3)) Then
            strCode(7) = .Fields(3)
         Else
            strCode(7) = "00"
         End If
         Cls003GetCaseMap = True
      End With
      Exit Do
   Loop
   Exit Function
ErrHand:
   Cls003GetCaseMap = False
   ShowMsg MsgText(1001)
   'edit by nickc 2007/02/05
'ErrorLog
MsgBox Err.Description

End Function

'讀取國外案件關聯表之資料
'iSitu 0 國內外案件資料維護資料 1 讀取美國IDS資料 2 大陸發明
Public Function Cls003GetCaseRelationDataOut(ByRef strCode1 As String, ByRef strCode2 As String, _
   ByRef strCode3 As String, ByRef strCode4 As String, ByRef strPromoter As String, _
   ByVal iSitu As Integer, Optional strSales As String) As Boolean
Dim strSql As String, rsRecordset As New ADODB.Recordset, strWhich As String

On Error GoTo ErrHand
Select Case iSitu
   Case 0
      strWhich = "國外"
   Case 1
      strWhich = "美國"
   Case 2
      strWhich = "大陸"
End Select

strPromoter = ""
strSales = ""

strCode3 = IIf(strCode3 = "", "0", strCode3)
strCode4 = IIf(strCode4 = "", "00", strCode4)
strSql = "select s1.st02,s2.st02 from caseprogress,staff s1,staff s2 where " & _
   "cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and " & _
   "cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + _
   " and cp10 in ('" & 發明申請 & "', '" & 新型申請 & "', '" & 設計申請 & "', '" & 追加申請 & "', '" & 聯合申請 & "', '" & 翻譯 & "')  AND " & _
   "cp14=s1.st01(+) and cp13=s2.st01(+)"
rsRecordset.CursorLocation = adUseClient
rsRecordset.Open strSql, cnnConnection, adOpenDynamic

If Not rsRecordset.EOF And Not rsRecordset.BOF Then
   If Not IsNull(rsRecordset.Fields(0)) Then strPromoter = rsRecordset.Fields(0)
   If Not IsNull(rsRecordset.Fields(1)) Then strSales = rsRecordset.Fields(1)
   Cls003GetCaseRelationDataOut = True
Else
   ShowMsg strWhich + MsgText(1010)
End If
Exit Function
ErrHand:
ShowMsg MsgText(1008)
'edit by nickc 2007/02/05
'ErrorLog
MsgBox Err.Description

End Function
'刪除國內外案件關聯表之資料
'iSitu 0 國內外案件資料維護資料 1 讀取美國IDS資料 2 大陸發明
Public Function Cls003DeleteCaseRelation(ByRef strCode() As String, ByVal iSitu As Integer) As Boolean
Dim strSql As String, i As Integer

On Error GoTo ErrHand
strCode(2) = IIf(strCode(2) = "", "0", strCode(2))
strCode(3) = IIf(strCode(3) = "", "00", strCode(3))
strCode(6) = IIf(strCode(6) = "", "0", strCode(6))
strCode(7) = IIf(strCode(7) = "", "00", strCode(7))
strSql = "delete from casemap where cm01=" + CNULL(strCode(0)) + " and cm02=" + CNULL(strCode(1)) + " and cm03=" + CNULL(strCode(2)) + " and cm04=" + CNULL(strCode(3)) + " and cm05=" + CNULL(strCode(4)) + " and cm06=" + CNULL(strCode(5)) + " and cm07=" + CNULL(strCode(6)) + " and cm08=" + CNULL(strCode(7)) + " and cm10='" & iSitu & "'"
cnnConnection.Execute strSql, i
If i = 0 Then ShowMsg MsgText(1007)
Cls003DeleteCaseRelation = True
Exit Function
ErrHand:
ShowMsg MsgText(9018)
'edit by nickc 2007/02/05
'ErrorLog
MsgBox Err.Description

End Function

Public Function Cls003ReadIdTime(ByRef strCode() As String) As Boolean
 Dim strSql As String, rsRecordset As New ADODB.Recordset, i As Integer
   If strCode(3) = "" Then strCode(3) = "0"
   If strCode(4) = "" Then strCode(4) = "00"
   If strCode(7) = "" Then strCode(7) = "0"
   If strCode(8) = "" Then strCode(8) = "00"

   strSql = "select cm09,cm11,st1.st02," & SQLDate("CM13") & ",cm14,st2.st02," & SQLDate("CM16") & ",cm17 from casemap,staff st1,staff st2 where " & _
      "cm01=" + CNULL(strCode(1)) + " and cm02=" + CNULL(strCode(2)) + " and cm03=" + CNULL(strCode(3)) + " and cm04=" + CNULL(strCode(4)) + " and " & _
      "cm05=" + CNULL(strCode(5)) + " and cm06=" + CNULL(strCode(6)) + " and cm07=" + CNULL(strCode(7)) + " and cm08=" + CNULL(strCode(8)) + " and " & _
      "cm10=" + CNULL(strCode(10)) & " and cm12=st1.st01(+) and cm15=st2.st01(+)"
   rsRecordset.CursorLocation = adUseClient
   rsRecordset.Open strSql, cnnConnection, adOpenDynamic
   Cls003ReadIdTime = False
   Do While Not rsRecordset.EOF
      With rsRecordset
      strCode(9) = ""
      For i = 11 To 17
         strCode(i) = ""
      Next
      If Not IsNull(.Fields(0)) Then strCode(9) = .Fields(0)
      For i = 1 To 7
         If Not IsNull(.Fields(i)) Then strCode(10 + i) = .Fields(i)
      Next
      If strCode(14) <> "" Then strCode(14) = Format(strCode(14), "##:##")
      If strCode(17) <> "" Then strCode(17) = Format(strCode(17), "##:##")
      
      Cls003ReadIdTime = True
      End With
      Exit Do
   Loop
End Function

'新增資料
'Remove by Lydia 2022/09/06 經過查詢，沒有使用
'Public Function Cls0701AddData0707(dl() As String) As Boolean
'Dim i As Integer
'Dim j As Integer
'Dim DATE1 As String
'Dim DATE2 As String
'Dim Date3 As String
''Add By Cheng 2002/11/14
'Dim BolTransOk As Boolean
'BolTransOk = True
'
'    strSql = "insert into datelimit (dl01,dl02,dl03,dl04) values("
'    strSql = strSql + CNULL(dl(0)) + "," + CNULL(ChangeTStringToWString(dl(1))) + "," + CNULL(ChangeTStringToWString(dl(2))) + "," + CNULL(ChangeTStringToWString(dl(3))) + ")"
'   'Debug.Print strSQL
'On Error GoTo ErrHand
'    cnnConnection.BeginTrans
'    cnnConnection.Execute strSql
'    'Modify By Cheng 2002/11/14
'    If BolTransOk Then
'        cnnConnection.CommitTrans
'    End If
'    Cls0701AddData0707 = True
'    Exit Function
'ErrHand:
'    'Add By Cheng 2002/11/14
'    If Err.NUMBER = -2147168237 Then
'       BolTransOk = False
'       Resume Next
'    End If
'
'    cnnConnection.RollbackTrans
'    Cls0701AddData0707 = False
'    'edit by nickc 2007/02/05
''ErrorLog
'MsgBox Err.Description
'End Function

'Remove by Lydia 2022/09/06 經過查詢，沒有使用
'Public Function Cls0701EraseData0707(dl() As String) As Boolean
''Add By Cheng 2002/11/14
'Dim BolTransOk As Boolean
'BolTransOk = True
'
'    strSql = "delete from datelimit where dl01=" + CNULL(dl(0)) + " and dl02=" + CNULL(ChangeTStringToWString(dl(1)))
'   'Debug.Print strSQL
'On Error GoTo ErrHand
'    cnnConnection.BeginTrans
'    cnnConnection.Execute strSql
'    'Modify By Cheng 2002/11/14
'    If BolTransOk Then
'        cnnConnection.CommitTrans
'    End If
'    Cls0701EraseData0707 = True
'    Exit Function
'ErrHand:
'    'Add By Cheng 2002/11/14
'    If Err.NUMBER = -2147168237 Then
'       BolTransOk = False
'       Resume Next
'    End If
'
'    cnnConnection.RollbackTrans
'    Cls0701EraseData0707 = False
'    'edit by nickc 2007/02/05
''ErrorLog
'MsgBox Err.Description
'End Function

'Remove by Lydia 2022/09/06 經過查詢，沒有使用
''新增資料
'Public Function Cls0701ModifyData0707(dl() As String) As Boolean
'Dim i As Integer
'Dim j As Integer
'Dim DATE1 As String
'Dim DATE2 As String
'Dim Date3 As String
''Add By Cheng 2002/11/14
'Dim BolTransOk As Boolean
'BolTransOk = True
'
'    strSql = "update datelimit set dl03=" + CNULL(ChangeTStringToWString(dl(2))) + ","
'    strSql = strSql + " dl04=" + CNULL(ChangeTStringToWString(dl(3)))
'    strSql = strSql + " where dl01=" + CNULL(dl(0)) + " and dl02=" + CNULL(ChangeTStringToWString(dl(1)))
'   'Debug.Print strSQL
'On Error GoTo ErrHand
'    cnnConnection.BeginTrans
'    cnnConnection.Execute strSql
'    'Modify By Cheng 2002/11/14
'    If BolTransOk Then
'        cnnConnection.CommitTrans
'    End If
'    Cls0701ModifyData0707 = True
'    Exit Function
'ErrHand:
'    'Add By Cheng 2002/11/14
'    If Err.NUMBER = -2147168237 Then
'       BolTransOk = False
'       Resume Next
'    End If
'
'    cnnConnection.RollbackTrans
'    Cls0701ModifyData0707 = False
'    'edit by nickc 2007/02/05
''ErrorLog
'MsgBox Err.Description
'End Function

'Remove by Lydia 2022/09/06 經過查詢，沒有使用
''新增資料
'Public Function Cls0701AddData0706(ce() As String) As Boolean
'Dim i As Integer
'Dim j As Integer
''Add By Cheng 2002/11/14
'Dim BolTransOk As Boolean
'BolTransOk = True
'
'    strSql = "insert into changeevent("
'    strSql = strSql + "ce01,ce02,ce03,ce04,ce05,ce06,ce07,ce08,ce09,ce10,"
'    strSql = strSql + "ce11,ce12,ce13,ce14,ce15,ce16,ce17,ce18,ce19,ce20,"
'    strSql = strSql + "ce21,ce22,ce23,ce24,ce25,ce26,ce27,ce28,ce29,ce30,"
'    strSql = strSql + "ce31,ce32,ce33,ce34,ce35,ce36,ce37,ce38,ce39,ce40,"
'    strSql = strSql + "ce41,ce42,ce43,ce44,ce45,ce46,ce47,ce48,ce49,ce50,"
'    strSql = strSql + "ce51,ce52,ce53,ce54,ce55,ce56,ce57,ce58,ce59,ce60,ce61,ce62,ce63,ce64,ce65)  values('"
'    strSql = strSql + ce(0) + "'," + ce(1) + ",'"
'    For i = 2 To 65
'        strSql = strSql + ce(i) + "','"
'    Next
'    strSql = Mid$(strSql, 1, Len(strSql) - 2) + ")"
'   'Debug.Print strSQL
'On Error GoTo ErrHand
'    cnnConnection.BeginTrans
'    cnnConnection.Execute strSql
'    'Modify By Cheng 2002/11/14
'    If BolTransOk Then
'        cnnConnection.CommitTrans
'    End If
'    Cls0701AddData0706 = True
'    Exit Function
'ErrHand:
'    'Add By Cheng 2002/11/14
'    If Err.NUMBER = -2147168237 Then
'       BolTransOk = False
'       Resume Next
'    End If
'
'    cnnConnection.RollbackTrans
'    Cls0701AddData0706 = False
'    Exit Function
''    ErrorLog
'End Function

'Remove by Lydia 2022/09/06 經過查詢，沒有使用
'Public Function Cls0701EraseData0706(ce() As String) As Boolean
''Add By Cheng 2002/11/14
'Dim BolTransOk As Boolean
'BolTransOk = True
'
'    strSql = "delete from changeevent where ce01='" + ce(0) + "'"
'   'Debug.Print strSQL
'On Error GoTo ErrHand
'    cnnConnection.BeginTrans
'    cnnConnection.Execute strSql
'    'Modify By Cheng 2002/11/14
'    If BolTransOk Then
'        cnnConnection.CommitTrans
'    End If
'    Cls0701EraseData0706 = True
'    Exit Function
'ErrHand:
'    'Add By Cheng 2002/11/14
'    If Err.NUMBER = -2147168237 Then
'       BolTransOk = False
'       Resume Next
'    End If
'
'    cnnConnection.RollbackTrans
'    Cls0701EraseData0706 = False
'    'edit by nickc 2007/02/05
''ErrorLog
'MsgBox Err.Description
'End Function

'Remove by Lydia 2022/09/06 經過查詢，沒有使用
'Public Function Cls0701ModifyData0706(ce() As String) As Integer
'Dim i As Integer
'Dim j As Integer
''Add By Cheng 2002/11/14
'Dim BolTransOk As Boolean
'BolTransOk = True
'
'    strSql = "update changeevent set "
'    strSql = strSql + "ce02=" + IIf(ce(1) <> "", ce(1), "0") + " , "
'    For j = 0 To 5
'    For i = 0 To 9
'        If j = 0 And i > 2 Then
'            strSql = strSql + "CE0" + Trim$(str(i)) + "='" + ce(i - 1) + "',"
'        End If
'        If j = 5 And i > 7 Then
'        Else
'            If j > 0 Then
'                strSql = strSql + "CE" + Trim$(str(j)) + Trim$(str(i)) + "='" + ce((j * 10 + i) - 1) + "',"
'            End If
'        End If
'    Next
'    Next
'
'    strSql = Mid$(strSql, 1, Len(strSql) - 1) + "  where CE01='" + ce(0) + "'"
'
'
'
'   'Debug.Print strSQL
'On Error GoTo ErrHand
'    cnnConnection.BeginTrans
'    cnnConnection.Execute strSql
'    'Modify By Cheng 2002/11/14
'    If BolTransOk Then
'        cnnConnection.CommitTrans
'    End If
'    Cls0701ModifyData0706 = True
'    Exit Function
'ErrHand:
'    'Add By Cheng 2002/11/14
'    If Err.NUMBER = -2147168237 Then
'       BolTransOk = False
'       Resume Next
'    End If
'
'    cnnConnection.RollbackTrans
'    Cls0701ModifyData0706 = False
'    'edit by nickc 2007/02/05
''ErrorLog
'MsgBox Err.Description
'End Function

'Remove by Lydia 2022/09/06 經過查詢，沒有使用
''新增資料
'Public Function Cls0701AddData0710(fac() As String) As Boolean
'Dim i As Integer
'Dim j As Integer
''Add By Cheng 2002/11/14
'Dim BolTransOk As Boolean
'BolTransOk = True
'
'    strSql = "insert into facase(fac01,fac02,fac03,fac04) values("
'    strSql = strSql + CNULL(fac(0)) + "," + CNULL(fac(1)) + "," + CNULL(fac(2)) + "," + CNULL(fac(3)) + ")"
'   'Debug.Print strSQL
'On Error GoTo ErrHand
'    cnnConnection.BeginTrans
'    cnnConnection.Execute strSql
'    'Modify By Cheng 2002/11/14
'    If BolTransOk Then
'        cnnConnection.CommitTrans
'    End If
'    Cls0701AddData0710 = True
'    Exit Function
'ErrHand:
'    'Add By Cheng 2002/11/14
'    If Err.NUMBER = -2147168237 Then
'       BolTransOk = False
'       Resume Next
'    End If
'
'    cnnConnection.RollbackTrans
'    Cls0701AddData0710 = False
'    'edit by nickc 2007/02/05
''ErrorLog
'MsgBox Err.Description
'End Function

'Remove by Lydia 2022/09/06 經過查詢，沒有使用
'Public Function Cls0701EraseData0710(fac() As String) As Boolean
''Add By Cheng 2002/11/14
'Dim BolTransOk As Boolean
'BolTransOk = True
'
'    strSql = "delete from facase where fac01='" + fac(0) + "' and fac02='" + fac(1) + "'"
'   'Debug.Print strSQL
'On Error GoTo ErrHand
'    cnnConnection.BeginTrans
'    cnnConnection.Execute strSql
'    'Modify By Cheng 2002/11/14
'    If BolTransOk Then
'        cnnConnection.CommitTrans
'    End If
'    Cls0701EraseData0710 = True
'    Exit Function
'ErrHand:
'    'Add By Cheng 2002/11/14
'    If Err.NUMBER = -2147168237 Then
'       BolTransOk = False
'       Resume Next
'    End If
'
'    cnnConnection.RollbackTrans
'    Cls0701EraseData0710 = False
'    'edit by nickc 2007/02/05
''ErrorLog
'MsgBox Err.Description
'End Function

'Remove by Lydia 2022/09/06 經過查詢，沒有使用
'Public Function Cls0701ModifyData0710(fac() As String) As Integer
'Dim i As Integer
'Dim j As Integer
''Add By Cheng 2002/11/14
'Dim BolTransOk As Boolean
'BolTransOk = True
'
'    strSql = "update facase set fac03=" + IIf(fac(2) = "", "0", fac(2)) + ","
'    strSql = strSql + "fac04='" + fac(3) + "' "
'    strSql = strSql + " where fac01='" + fac(0) + "' and fac02='" + fac(1) + "'"
'   'Debug.Print strSQL
'On Error GoTo ErrHand
'    cnnConnection.BeginTrans
'    cnnConnection.Execute strSql
'    'Modify By Cheng 2002/11/14
'    If BolTransOk Then
'        cnnConnection.CommitTrans
'    End If
'    Cls0701ModifyData0710 = True
'    Exit Function
'ErrHand:
'    'Add By Cheng 2002/11/14
'    If Err.NUMBER = -2147168237 Then
'       BolTransOk = False
'       Resume Next
'    End If
'
'    cnnConnection.RollbackTrans
'    Cls0701ModifyData0710 = False
'    'edit by nickc 2007/02/05
''ErrorLog
'MsgBox Err.Description
'End Function

'Remove by Lydia 2022/09/06 經過查詢，沒有使用
''新增資料
'Public Function Cls0701AddData0708(cf() As String) As Boolean
'Dim i As Integer
'Dim j As Integer
''Add By Cheng 2002/11/14
'Dim BolTransOk As Boolean
'BolTransOk = True
'
'    strSql = "insert into casefee(cf01,cf02,cf03,cf04,cf05,cf06,cf07,"
'    strSql = strSql + "cf08,cf09,cf10,cf11,cf12,cf13,cf14,cf15) values('"
'    strSql = strSql + cf(0) + "','" + cf(1) + "','" + cf(2) + "'," + IIf(cf(3) <> "", cf(3), "0") + "," + IIf(cf(4) <> "", cf(4), "0") + "," + IIf(cf(5) <> "", cf(5), "0") + ","
'    strSql = strSql + IIf(cf(6) <> "", cf(6), "0") + "," + IIf(cf(7) <> "", cf(7), "0") + ",'" + cf(8) + "','" + cf(9) + "'," + IIf(cf(10) <> "", cf(10), "0") + "," + IIf(cf(11) <> "", cf(11), "0") + "," + IIf(cf(12) <> "", cf(12), "0") + ","
'    strSql = strSql + IIf(cf(13) <> "", cf(13), "0") + ",'" + cf(14) + "')"
'   'Debug.Print strSQL
'On Error GoTo ErrHand
'    cnnConnection.BeginTrans
'    cnnConnection.Execute strSql
'    'Modify By Cheng 2002/11/14
'    If BolTransOk Then
'        cnnConnection.CommitTrans
'    End If
'    Cls0701AddData0708 = True
'    Exit Function
'ErrHand:
'    'Add By Cheng 2002/11/14
'    If Err.NUMBER = -2147168237 Then
'       BolTransOk = False
'       Resume Next
'    End If
'
'    cnnConnection.RollbackTrans
'    Cls0701AddData0708 = False
'    'edit by nickc 2007/02/05
''ErrorLog
'MsgBox Err.Description
'End Function

'Remove by Lydia 2022/09/06 經過查詢，沒有使用
'Public Function Cls0701EraseData0708(cf() As String) As Boolean
''Add By Cheng 2002/11/14
'Dim BolTransOk As Boolean
'BolTransOk = True
'
'    strSql = "delete from casefee where cf01='" + cf(0) + "' and cf02='" + cf(1) + "' and cf03='" + cf(2) + "'"
'   'Debug.Print strSQL
'On Error GoTo ErrHand
'    cnnConnection.BeginTrans
'    cnnConnection.Execute strSql
'    'Modify By Cheng 2002/11/14
'    If BolTransOk Then
'        cnnConnection.CommitTrans
'    End If
'    Cls0701EraseData0708 = True
'    Exit Function
'ErrHand:
'    'Add By Cheng 2002/11/14
'    If Err.NUMBER = -2147168237 Then
'       BolTransOk = False
'       Resume Next
'    End If
'
'    cnnConnection.RollbackTrans
'    Cls0701EraseData0708 = False
'    'edit by nickc 2007/02/05
''ErrorLog
'MsgBox Err.Description
'End Function

'Remove by Lydia 2022/09/06 經過查詢，沒有使用
'Public Function Cls0701ModifyData0708(cf() As String) As Integer
'Dim i As Integer
'Dim j As Integer
''Add By Cheng 2002/11/14
'Dim BolTransOk As Boolean
'BolTransOk = True
'
'    strSql = "update casefee set "
'    strSql = strSql + "cf04=" + IIf(cf(3) <> "", cf(3), "0") + ","
'    strSql = strSql + "cf05=" + IIf(cf(4) <> "", cf(4), "0") + ","
'    strSql = strSql + "cf06=" + IIf(cf(5) <> "", cf(5), "0") + ","
'    strSql = strSql + "cf07=" + IIf(cf(6) <> "", cf(6), "0") + ","
'    strSql = strSql + "cf08=" + IIf(cf(7) <> "", cf(7), "0") + ","
'    strSql = strSql + "cf09='" + cf(8) + "',"
'    strSql = strSql + "cf10='" + cf(9) + "',"
'    strSql = strSql + "cf11=" + IIf(cf(10) <> "", cf(10), "0") + ","
'    strSql = strSql + "cf12=" + IIf(cf(11) <> "", cf(11), "0") + ","
'    strSql = strSql + "cf13=" + IIf(cf(12) <> "", cf(12), "0") + ","
'    strSql = strSql + "cf14=" + IIf(cf(13) <> "", cf(13), "0") + ","
'    strSql = strSql + "cf15='" + cf(14) + "' "
'    strSql = strSql + " where cf01='" + cf(0) + "' and cf02='" + cf(1) + "' and cf03='" + cf(2) + "'"
'   'Debug.Print strSQL
'On Error GoTo ErrHand
'    cnnConnection.BeginTrans
'    cnnConnection.Execute strSql
'    'Modify By Chenhg 2002/11/14
'    If BolTransOk Then
'        cnnConnection.CommitTrans
'    End If
'    Cls0701ModifyData0708 = True
'    Exit Function
'ErrHand:
'    'Add By Cheng 2002/11/14
'    If Err.NUMBER = -2147168237 Then
'       BolTransOk = False
'       Resume Next
'    End If
'
'    cnnConnection.RollbackTrans
'    Cls0701ModifyData0708 = False
'    'edit by nickc 2007/02/05
''ErrorLog
'MsgBox Err.Description
'End Function

'Remove by Lydia 2022/09/06 經過查詢，沒有使用
''Cls0702  nickc 2007/02/05
''取得客戶名稱
'Public Function Cls0702GetCustomer1(ByRef strCustomer As String, ByRef strCustomerName As String, Optional ByRef strZipCode As String) As Boolean
'Dim strSql As String, rsRecordset As New ADODB.Recordset, i As Integer
'
'On Error GoTo ErrHand
'strCustomer = ChangeCustomerL(strCustomer)
'If Left(strCustomer, 1) = 客戶編號 Then
'   strSql = "select cu01||cu02,nvl(cu05,nvl(cu04,nvl(cu06,''))),cu27 from customer " & _
'      "where " & ChgCustomer(strCustomer) & " order by cu01||cu02"
'ElseIf Left(strCustomer, 1) = 代理人編號 Then
'   strSql = "select fa01||fa02,nvl(cu05,nvl(cu04,nvl(cu06,''))),cu27,cu01||cu02 " & _
'      "from customer,fagent where cu01=fa03 and " & ChgFagent(strCustomer) + " order by cu01||cu02"
'Else
'   MsgBox "客戶代碼錯誤!!", vbCritical
'   Exit Function
'End If
'rsRecordset.CursorLocation = adUseClient
'rsRecordset.Open strSql, cnnConnection
'If rsRecordset.RecordCount > 0 Then
'   If rsRecordset.Fields(0) = strCustomer Then
'      If Left(strCustomer, 1) = 代理人編號 Then
'         strCustomer = rsRecordset.Fields(3)
'      End If
'      strCustomer = ChangeCustomerS(strCustomer)
'      strCustomerName = rsRecordset.Fields(1)
'      strZipCode = IIf(IsNull(rsRecordset.Fields(2)), "", rsRecordset.Fields(2))
'   End If
'   Cls0702GetCustomer1 = True
'Else
'   MsgBox "申請人代碼錯誤!!", vbCritical
'End If
'rsRecordset.Close
'Exit Function
'ErrHand:
'    'edit by nickc 2007/02/05
''ErrorLog
'MsgBox Err.Description
'End Function

'Remove by Lydia 2022/09/06 經過查詢，沒有使用
'Public Function Cls0702Adddata0702(sp() As String) As Boolean
'Dim i As Integer
'Dim j As Integer
''Add By Cheng 2002/11/14
'Dim BolTransOk As Boolean
'BolTransOk = True
'    'Modify By Cheng 2003/09/24
''    strSQL = "insert into Servicepractice(sp01,sp02,sp03,sp04,sp05,sp06,sp07,sp08,sp09,sp10,sp15,sp16,sp17,sp34,"
''    strSQL = strSQL + "sp28,sp18,sp29,sp26,sp30,sp37,sp35,sp27,sp31,sp33,sp36"
''    strSQL = strSQL + ") values("
'    strSql = "insert into Servicepractice(sp01,sp02,sp03,sp04,sp05,sp06,sp07,sp08,sp09,sp10,sp15,sp16,sp17,sp34,"
'    strSql = strSql + "sp28,sp18,sp29,sp26,sp30,sp37,sp35,sp27,sp31,sp33,sp36, SP67"
'    strSql = strSql + ") values("
'    For i = 0 To 25
'        strSql = strSql + CNULL(sp(i)) + ","
'    Next
'    strSql = Mid$(strSql, 1, Len(strSql) - 1)
'    strSql = strSql + ")"
'   'Debug.Print strSQL
'On Error GoTo ErrHand
'    cnnConnection.BeginTrans
'    cnnConnection.Execute strSql
'    'Modify By Cheng 2002/11/14
'    If BolTransOk Then
'        cnnConnection.CommitTrans
'    End If
'    Cls0702Adddata0702 = True
'    Exit Function
'ErrHand:
'    'Add By Cheng 2002/11/14
'    If Err.NUMBER = -2147168237 Then
'       BolTransOk = False
'       Resume Next
'    End If
'
'    cnnConnection.RollbackTrans
'    Cls0702Adddata0702 = False
'        'edit by nickc 2007/02/05
''ErrorLog
'MsgBox Err.Description
'End Function

'Remove by Lydia 2022/09/06 經過查詢，沒有使用
'Public Function Cls0702EraseData0702(sp() As String) As Boolean
''Add By Cheng 2002/11/14
'Dim BolTransOk As Boolean
'BolTransOk = True
'
'    strSql = "delete from servicepractice where sp01='" + sp(0) + "' and sp02='" + sp(1) + "' and sp03='" + sp(2) + "' and sp04='" + sp(3) + "'"
'   'Debug.Print strSQL
'On Error GoTo ErrHand
'    cnnConnection.BeginTrans
'    cnnConnection.Execute strSql
'    'Modify By Cheng 2002/11/14
'    If BolTransOk Then
'        cnnConnection.CommitTrans
'    End If
'    Cls0702EraseData0702 = True
'    Exit Function
'ErrHand:
'    'Add By Cheng 2002/11/14
'    If Err.NUMBER = -2147168237 Then
'       BolTransOk = False
'       Resume Next
'    End If
'
'    cnnConnection.RollbackTrans
'    Cls0702EraseData0702 = False
'        'edit by nickc 2007/02/05
''ErrorLog
'MsgBox Err.Description
'End Function

'Remove by Lydia 2022/09/06 經過查詢，沒有使用
'Public Function Cls0702EraseData0701(strSQL1 As String, strSQL2 As String) As Boolean
''Add By Cheng 2002/11/14
'Dim BolTransOk As Boolean
'BolTransOk = True
'
'   'Debug.Print strSQL1
'On Error GoTo ErrHand
'    cnnConnection.BeginTrans
'    cnnConnection.Execute strSQL1
'    cnnConnection.Execute strSQL2
'    'Modify By Cheng 2002/11/14
'    If BolTransOk Then
'        cnnConnection.CommitTrans
'    End If
'    Cls0702EraseData0701 = True
'    Exit Function
'ErrHand:
'    'Add By Cheng 2002/11/14
'    If Err.NUMBER = -2147168237 Then
'       BolTransOk = False
'       Resume Next
'    End If
'
'    cnnConnection.RollbackTrans
'    Cls0702EraseData0701 = False
'        'edit by nickc 2007/02/05
''ErrorLog
'MsgBox Err.Description
'End Function

'Remove by Lydia 2022/09/06 經過查詢，沒有使用
'Public Function Cls0702ModifyData0702(sp() As String, Optional BolWDB As Boolean = False) As Integer
'Dim i As Integer
'Dim j As Integer
''Add By Cheng 2002/11/14
'Dim BolTransOk As Boolean
'BolTransOk = True
'
'    strSql = "update servicepractice set sp05=" + CNULL(sp(4)) + ","
'    '910910  nick tigger
'    '***** start
'    If BolWDB = True Then
'        strSql = "begin user_data.user_enabled:=1; " & strSql
'    End If
'    '***** end
'    strSql = strSql + "sp06=" + CNULL(sp(5)) + ",sp07=" + CNULL(sp(6)) + ","
'    strSql = strSql + "sp08=" + CNULL(sp(7)) + ",sp09=" + CNULL(sp(8)) + ","
'    strSql = strSql + "sp10=" + CNULL(sp(9)) + ",sp15=" + CNULL(sp(10)) + ","
'    strSql = strSql + "sp16=" + CNULL(sp(11)) + ",sp17=" + CNULL(sp(12)) + ","
'    strSql = strSql + "sp34=" + CNULL(sp(13)) + ",sp28=" + CNULL(sp(14)) + ","
'    strSql = strSql + "sp18=" + CNULL(sp(15)) + ",sp29=" + CNULL(sp(16)) + ","
'    strSql = strSql + "sp26=" + CNULL(sp(17)) + ",sp30=" + CNULL(sp(18)) + ","
'    strSql = strSql + "sp37=" + CNULL(sp(19)) + ",sp35=" + CNULL(sp(20)) + ","
'    strSql = strSql + "sp27=" + CNULL(sp(21)) + ",sp31=" + CNULL(sp(22)) + ","
'    strSql = strSql + "sp33=" + CNULL(sp(23)) + ",sp36=" + CNULL(sp(24)) + ",sp67=" + CNULL(sp(25))
'    strSql = strSql + " where sp01=" + CNULL(sp(0)) + " and sp02=" + CNULL(sp(1)) + " and sp03=" + CNULL(sp(2)) + "  and sp04=" + CNULL(sp(3))
'    '910910  nick tigger
'    '***** start
'    If BolWDB = True Then
'        strSql = strSql & "; end;"
'    End If
'    '***** end
'On Error GoTo ErrHand
'    cnnConnection.BeginTrans
'    cnnConnection.Execute strSql
'    'Modify By Cheng 2002/11/14
'    If BolTransOk Then
'        cnnConnection.CommitTrans
'    End If
'    Cls0702ModifyData0702 = True
'    Exit Function
'ErrHand:
'    'Add By Cheng 2002/11/14
'    If Err.NUMBER = -2147168237 Then
'       BolTransOk = False
'       Resume Next
'    End If
'
'    cnnConnection.RollbackTrans
'    Cls0702ModifyData0702 = False
'        'edit by nickc 2007/02/05
''ErrorLog
'MsgBox Err.Description
'End Function


'取得使用者可使用的系統名稱
Public Function Cls0702GetUserUseSysKind(ByRef strGroup As String, ByRef StrSysName As String) As Boolean
Dim Rs As ADODB.Recordset
'edit by nickc 2007/02/06 不用 dll 了
'Dim obj01 As Object
        'Set obj01 = CreateObject("prjtaiedll.clspublicdata")
        strSql = "select sg02 from staff_group where sg01='" + strGroup + "'"
        'edit by nickc 2007/02/06 不用 dll 了
        'Set rs = obj01.ReadRst(strSQL, True)
        Set Rs = ClsPDReadRst(strSql, True)
        If Rs.EOF Then
            Rs.Close
            Cls0702GetUserUseSysKind = False
        Else
            StrSysName = Rs(0)
            Cls0702GetUserUseSysKind = True
            Rs.Close
        End If
        'edit by nickc 2007/02/06 不用 dll 了
        'Set obj01 = Nothing
End Function

'Remove by Lydia 2022/09/06 經過查詢，沒有使用
''檢查新增之本所案號是否大於現在AutoNum
'Public Function Cls0702ChkCaseNoWithAuNum0701(strNo1 As String, strNo2 As String, strNo3 As String, strNo4 As String, strSysKind As String) As Boolean
'Dim rs As ADODB.Recordset
'Dim nRet As Boolean
'Dim strName As String
''edit by nickc 2007/02/06 不用 dll 了
''Dim obj01 As Object
'        strSql = "select * from patent where pa01=" + CNULL(strNo1) + " and pa02=" + CNULL(strNo2) + " and pa03=" + CNULL(strNo3) + " and pa04=" + CNULL(strNo4)
'        'edit by nickc 2007/02/06 不用 dll 了
'        'Set obj01 = CreateObject("prjtaiedll.clspublicdata")
'        'Set rs = obj01.ReadRst(strSQL)
'        Set rs = ClsPDReadRst(strSql)
'        If Not rs.EOF Then
'             MsgBox "本所案號重覆"
'             Cls0702ChkCaseNoWithAuNum0701 = False
'             rs.Close
'             Exit Function
'        End If
'        rs.Close
'        Select Case strSysKind
'        Case "CFP"
'            strSql = "select  *  from patent where pa01='CFP' and pa02 >" + Format(strNo2, "#####0")
'           'Debug.Print strSQL
'        Case "FCP"
'            strSql = "select  *  from patent where pa01='FCP' and pa02 >" + Format(strNo2, "#####0")
'           'Debug.Print strSQL
'        Case "P"
'            strSql = "select  *  from patent where pa01='P' and pa02 >" + Format(strNo2, "#####0")
'           'Debug.Print strSQL
'        End Select
'        'edit by nickc 2007/02/06 不用 dll 了
'        'Set rs = obj01.ReadRst(strSQL)
'        Set rs = ClsPDReadRst(strSql)
'        'Set obj01 = Nothing
'        If rs.EOF Then
'            rs.Close
'            Cls0702ChkCaseNoWithAuNum0701 = False  '不可以新增資料
'            MsgBox "本所案號不合規則"
'            Exit Function
'        Else
'            Cls0702ChkCaseNoWithAuNum0701 = True  '可以新增資料
'            rs.Close
'        End If
'End Function


'Remove by Lydia 2022/09/06 經過查詢，沒有使用
''取得代理人備註
'Public Function Cls0702GetCustomerNote0702(strNo As String, ByRef strName As String) As Boolean
'Dim rs As ADODB.Recordset
''edit by nickc 2007/02/06 不用 dll 了
''Dim obj01 As Object
'    'Set obj01 = CreateObject("prjtaiedll.clspublicdata")
'    strSql = "select  cu79  from customer where cu01=" + CNULL(strNo)
'    'edit by nickc 2007/02/06 不用 dll 了
'    'Debug.Print strSQL
'    'Set rs = obj01.ReadRst(strSQL)
'    Set rs = ClsPDReadRst(strSql)
'    If rs.EOF Then
'        Cls0702GetCustomerNote0702 = False
'        rs.Close
'        Exit Function
'    Else
'        Cls0702GetCustomerNote0702 = True
'        strName = IIf(IsNull(rs(0)), "", rs(0))
'    End If
'    rs.Close
'    'edit by nickc 2007/02/06 不用 dll 了
'    'Set obj01 = Nothing
'End Function

'Remove by Lydia 2022/09/06 經過查詢，沒有使用
''取得代理人備註
'Public Function Cls0702GetAgentNote0702(strNo As String, ByRef strName As String) As Boolean
'Dim rs As ADODB.Recordset
''edit by nickc 2007/02/06 不用 dll 了
''Dim obj01 As Object
'    'Set obj01 = CreateObject("prjtaiedll.clspublicdata")
'    strSql = "select  fa29  from fagent where fa01=" + CNULL(Mid$(strNo, 1, 8)) + "and fa02=" + CNULL(Mid$(strNo, 9, 1))
'    'edit by nickc 2007/02/06 不用 dll 了
'    'Debug.Print strSQL
'    'Set rs = obj01.ReadRst(strSQL)
'    Set rs = ClsPDReadRst(strSql)
'    If rs.EOF Then
'        Cls0702GetAgentNote0702 = False
'        rs.Close
'        Exit Function
'    Else
'        Cls0702GetAgentNote0702 = True
'        strName = IIf(IsNull(rs(0)), "", rs(0))
'    End If
'    rs.Close
'    'edit by nickc 2007/02/06 不用 dll 了
'    'Set obj01 = Nothing
'End Function

'Remove by Lydia 2022/09/06 經過查詢，沒有使用
''取得PriDate資料
'Public Function Cls0702GetPriDateData0701(pd() As String) As String()
'Dim PD1() As String
'Dim rs As ADODB.Recordset
'Dim i As Integer
''edit by nickc 2007/02/06 不用 dll 了
''Dim objPublicData As Object
'    strSql = "select * from Pridate where pd01=" + CNULL(pd(0)) + " and pd02=" + CNULL(pd(1)) + " and pd03=" + CNULL(pd(2)) + " and pd04=" + CNULL(pd(3))
'    'edit by nickc 2007/02/06 不用 dll 了
'    'Set objPublicData = CreateObject("Prjtaiedll.clspublicdata")
'    'Set rs = objPublicData.ReadRst(strSQL)
'    Set rs = ClsPDReadRst(strSql)
'    If rs.EOF Then
'        Cls0702GetPriDateData0701 = PD1()
'        rs.Close
'    Else
'        rs.MoveLast
'        rs.MoveFirst
'        ReDim PD1(rs.RecordCount, 3)
'        i = 0
'        While Not rs.EOF
'            PD1(i, 0) = rs(0)
'            PD1(i, 1) = rs(1)
'            PD1(i, 2) = rs(2)
'            rs.MoveNext
'            i = i + 1
'        Wend
'        Cls0702GetPriDateData0701 = PD1()
'    End If
'    'edit by nickc 2007/02/06 不用 dll 了
'    'Set objPublicData = Nothing
'End Function

'Remove by Lydia 2022/09/06 經過查詢，沒有使用
''取得年費通知人
'Public Function Cls0702GetAnnualAgent(ByRef strNo As String, ByRef strName As String, ByRef strTemp As String) As Boolean
''edit by nickc 2007/02/06 不用 dll 了
''Dim obj01 As Object
''Dim obj02 As Object
'Dim rs As ADODB.Recordset
'    'edit by nickc 2007/02/06 不用 dll 了
'    'Set obj01 = CreateObject("prjtaiedll.clspublicdata")
'    Select Case Mid$(strNo, 1, 1)
'    Case "X"
'        strSql = "select cu03 from customer where cu01=" + CNULL(strNo)
'        'edit by nickc 2007/02/06 不用 dll 了
'        'Set rs = obj01.ReadRst(strSQL)
'        Set rs = ClsPDReadRst(strSql)
'        If rs.EOF Then
'            rs.Close
'            'edit by nickc 2007/02/06 不用 dll 了
'            'Set obj01 = Nothing
'            Cls0702GetAnnualAgent = False
'            Exit Function
'        Else
'            strTemp = IIf(IsNull(rs(0)), "", rs(0))
'            rs.Close
'        End If
'    Case "Y"
'        strTemp = strNo
'    End Select
'    strSql = "select  nvl(fa06,nvl(fa04,fa05))  from fagent where fa01=" + CNULL(Mid$(strTemp, 1, 8)) + " and fa02=" + CNULL(Mid$(strTemp, 9, 1))
'    'edit by nickc 2007/02/06 不用 dll 了
'    'Set rs = obj01.ReadRst(strSQL)
'    Set rs = ClsPDReadRst(strSql)
'    If rs.EOF Then
'        rs.Close
'        'edit by nickc 2007/02/06 不用 dll 了
'        'Set obj01 = Nothing
'        Cls0702GetAnnualAgent = False
'        Exit Function
'    Else
'        strName = IIf(IsNull(rs(0)), "", rs(0))
'        rs.Close
'        'edit by nickc 2007/02/06 不用 dll 了
'        'Set obj01 = Nothing
'        Cls0702GetAnnualAgent = True
'    End If
'End Function

'Remove by Lydia 2022/09/06 經過查詢，沒有使用
''取得副本收受人,固定請款對象
'Public Function Cls0702GetCopyReceiver(ByRef strNo As String, ByRef strName As String) As Boolean
''edit by nickc 2007/02/06 不用 dll 了
''Dim obj01 As Object
'Dim rs As ADODB.Recordset
'    'edit by nickc 2007/02/06 不用 dll 了
'    'Set obj01 = CreateObject("prjtaiedll.clspublicdata")
'    Select Case Mid$(strNo, 1, 1)
'    Case "X"
'        strSql = "select nvl(cu04,nvl(cu05,cu06))  from customer where cu01=" + CNULL(Mid$(strNo, 1, 8)) + "  and cu02='0'"
'        'edit by nickc 2007/02/06 不用 dll 了
'        'Set rs = obj01.ReadRst(strSQL)
'        Set rs = ClsPDReadRst(strSql)
'    Case "Y"
'        strSql = "select nvl(fa05,nvl(fa04,fa06))  from customer where fa01=" + CNULL(Mid$(strNo, 1, 8)) + "  and fa02='0'"
'        'edit by nickc 2007/02/06 不用 dll 了
'        'Set rs = obj01.ReadRst(strSQL)
'        Set rs = ClsPDReadRst(strSql)
'    End Select
'    If rs.EOF Then
'        rs.Close
'        Cls0702GetCopyReceiver = False
'        Exit Function
'     Else
'        strName = IIf(IsNull(rs(0)), "", rs(0))
'        Cls0702GetCopyReceiver = True
'        rs.Close
'    End If
'    'edit by nickc 2007/02/06 不用 dll 了
'    'Set obj01 = Nothing
'End Function

'Remove by Lydia 2022/09/06 經過查詢，沒有使用
''取得下次繳費日,利用array傳值,array(0-3)為本所案號,
'Public Function Cls0702GetNextPayDate(pa() As String, ByRef strName As String) As Boolean
''edit by nickc 2007/02/06 不用 dll 了
''Dim obj01 As Object
'Dim rs As ADODB.Recordset
'Dim strTemp As String
' Dim i As Integer
'    'edit by nickc 2007/02/06 不用 dll 了
'    'Set obj01 = CreateObject("prjtaiedll.clspublicdata")
'    strTemp = "select np09 from nextprogress where np02=" + CNULL(pa(0)) + " and np03=" + CNULL(pa(1)) + "and np04=" + CNULL(pa(2)) + " and np05=" + CNULL(pa(3))
'    strSql = strTemp + " and np07='21' "
'    'edit by nickc 2007/02/06 不用 dll 了
'    'Debug.Print strSQL
'    'Set rs = obj01.ReadRst(strSQL)
'    Set rs = ClsPDReadRst(strSql)
'    If rs.EOF Then
'        rs.Close
'        strSql = strTemp + " and np07='" & 年費 & "'"
'    Else
'        strName = IIf(IsNull(rs(0)), "", rs(0))
'        Cls0702GetNextPayDate = True
'        Exit Function
'    End If
'    'edit by nickc 2007/02/06 不用 dll 了
'    'Debug.Print strSQL
'    'Set rs = obj01.ReadRst(strSQL)
'    Set rs = ClsPDReadRst(strSql)
'
'    If rs.EOF Then
'        rs.Close
'        strSql = strTemp + " and np07='49'"
'    Else
'        strName = IIf(IsNull(rs(0)), "", rs(0))
'        Cls0702GetNextPayDate = True
'        Exit Function
'    End If
'
'    'edit by nickc 2007/02/06 不用 dll 了
'    'Set rs = obj01.ReadRst(strSQL)
'    Set rs = ClsPDReadRst(strSql)
'
'    If rs.EOF Then
'        rs.Close
'        Cls0702GetNextPayDate = False
'        strName = ""
'        Exit Function
'    Else
'        strName = IIf(IsNull(rs(0)), "", rs(0))
'        Cls0702GetNextPayDate = True
'        Exit Function
'    End If
'    'edit by nickc 2007/02/06 不用 dll 了
'    'Set obj01 = Nothing
'End Function

'Remove by Lydia 2022/09/06 經過查詢，沒有使用
''取得收款後辦案,代理人備註
'Public Function Cls0702GetFagentData0701(strNo As String, ByRef strName As String, ByRef strTemp As String) As Boolean
''edit by nickc 2007/02/06 不用 dll 了
''Dim obj01 As Object
'Dim rs As ADODB.Recordset
'    'edit by nickc 2007/02/06 不用 dll 了
'    'Set obj01 = CreateObject("prjtaiedll.clspublicdata")
'    strSql = "select fa39,fa29 from fagent where fa01=" + CNULL(Mid$(strNo, 1, 8)) + " and fa02=" + CNULL(Mid$(strNo, 9, 1))
'    'edit by nickc 2007/02/06 不用 dll 了
'    'Debug.Print strSQL
'    'Set rs = obj01.ReadRst(strSQL)
'    Set rs = ClsPDReadRst(strSql)
'    If rs.EOF Then
'        rs.Close
'        Cls0702GetFagentData0701 = False
'        'edit by nickc 2007/02/06 不用 dll 了
'        'Set obj01 = Nothing
'        Exit Function
'    Else
'        strName = IIf(IsNull(rs(0)), "", rs(0))
'        strTemp = IIf(IsNull(rs(1)), "", rs(1))
'        rs.Close
'        Cls0702GetFagentData0701 = True
'    End If
'    'edit by nickc 2007/02/06 不用 dll 了
'    'Set obj01 = Nothing
'End Function

'2012/9/21 cancel by sonia 無用
''取得收款後辦案,客戶備註
'Public Function Cls0702GetCustomer0701(strNo As String, ByRef strName As String, ByRef strTemp As String) As Boolean
''edit by nickc 2007/02/05 不用 dll 了
''Dim obj01 As Object
'Dim rs As ADODB.Recordset
'    'edit by nickc 2007/02/05 不用 dll 了
'    'Set obj01 = CreateObject("prjtaiedll.clspublicdata")
'    strNo = ChangeCustomerL(strNo)
'    strSql = "select cu72,cu79 from customer where " + ChgCustomer(strNo)
'    'edit by nickc 2007/02/05 不用 dll 了
'    'Set rs = obj01.ReadRst(StrSql)
'    Set rs = ClsPDReadRst(strSql)
'    If rs.EOF Then
'        rs.Close
'        Cls0702GetCustomer0701 = False
'        'edit by nickc 2007/02/05 不用 dll 了
'        'Set obj01 = Nothing
'        Exit Function
'    Else
'        strName = IIf(IsNull(rs(0)), "", rs(0))
'        strTemp = IIf(IsNull(rs(1)), "", rs(1))
'        rs.Close
'        Cls0702GetCustomer0701 = True
'    End If
'    strNo = ChangeCustomerS(strNo)
'    'edit by nickc 2007/02/05 不用 dll 了
'    'Set obj01 = Nothing
'End Function
'
'Public Function Cls0702GetInventor0701(strInventorNo As String, Optional strInID As String, Optional strInName1 As String, Optional strInName2 As String, Optional strInName3 As String) As Boolean
''edit by nickc 2007/02/05 不用 dll 了
''Dim obj01 As Object
'Dim rs As ADODB.Recordset
'    strSql = "select in03,in04,in05,in06 from inventor where in01||in02=" + CNULL(strInventorNo)
'    'edit by nickc 2007/02/05 不用 dll 了
'    'Set obj01 = CreateObject("prjtaiedll.clsPublicData")
'    'Debug.Print StrSql
'    'Set rs = obj01.ReadRst(StrSql)
'    Set rs = ClsPDReadRst(strSql)
'    If rs.EOF Then
'        rs.Close
'        'edit by nickc 2007/02/05 不用 dll 了
'        'Set obj01 = Nothing
'        Cls0702GetInventor0701 = False
'        Exit Function
'    Else
'        strInID = IIf(IsNull(rs(0)), "", rs(0))
'        strInName1 = IIf(IsNull(rs(1)), "", rs(1))
'        strInName2 = IIf(IsNull(rs(2)), "", rs(2))
'        strInName3 = IIf(IsNull(rs(3)), "", rs(3))
'        rs.Close
'        'edit by nickc 2007/02/05 不用 dll 了
'        'Set obj01 = Nothing
'        Cls0702GetInventor0701 = True
'    End If
'End Function
'2012/9/21 end

'Cls001 nickc 2007/02/05
'判斷是否新案
Public Function Cls001IsNewCase(ByRef strReceiveCode As String, ByRef bolNew As Boolean) As Boolean
Dim strSql As String, rsRecordset As New ADODB.Recordset

On Error GoTo ErrHand
strSql = "select cp31 from caseprogress where cp09=" + CNULL(strReceiveCode)
rsRecordset.CursorLocation = adUseClient
rsRecordset.Open strSql, cnnConnection, adOpenStatic
If rsRecordset.RecordCount > 0 Then
   bolNew = IIf(rsRecordset.Fields(0) = "Y", True, False)
   Cls001IsNewCase = True
End If
rsRecordset.Close
Exit Function
ErrHand:
ShowMsg MsgText(1501)
        'edit by nickc 2007/02/05
'ErrorLog
MsgBox Err.Description
End Function
'刪除期限內之機關來函資料
Public Function Cls001DeleteCkind(ByVal strSDate As String, ByVal strEDate As String, ByRef lngDelete As Long) As Boolean
Dim strSql As String

On Error GoTo ErrHand
strSDate = ChangeTStringToWString(strSDate)
strEDate = ChangeTStringToWString(strEDate)
strSql = "delete from mailrec where mr02>=" + strSDate + " and mr02 <= " + strEDate
cnnConnection.Execute strSql, lngDelete
Cls001DeleteCkind = True
Exit Function
ErrHand:
ShowMsg MsgText(9018)
'edit by nickc 2007/02/05
'ErrorLog
MsgBox Err.Description
End Function

'讀取主管機關來函查詢資料之Recodeset
'MODIFY BY SONIA 2014/5/7 加傳Check1,是否含專業部輸入資料
Public Function Cls001ReadOrgRst(ByRef intIndex As Integer, ByRef strCkind1 As String, ByRef strCkind2 As String, strCheck1 As String) As ADODB.Recordset
Dim strSql As String
Dim strSort As String
   'edit by nickc 2007/02/06 不用 dll 了
   'Dim objPublicData As Object
   'Set objPublicData = CreateObject("prjTaieDll.clsPublicData")
   Select Case intIndex
             Case 0
                        If strCkind1 <> "" Then
                           strSql = "mr01>=" + CNULL(政府機關來函 + strCkind1) + " and "
                        End If
                        strSql = strSql + "mr01<=" + CNULL(政府機關來函 + strCkind2)
                        'add by sonia 2014/5/7 是否含專業部輸入資料
                        If strCheck1 = "0" Then
                           strSql = strSql + " and substr(st03,1,2)<>'P1' "
                        End If
                        'end 2014/5/7
                        strSort = " order by nvl(mr01, '0') asc"
             Case 1
                        If strCkind1 <> "" Then
                           strSql = "mr02>=" + ChangeTStringToWString(strCkind1) + " and "
                        End If
                        strSql = strSql + "mr02<=" + ChangeTStringToWString(strCkind2)
                        'add by sonia 2014/5/7 是否含專業部輸入資料
                        If strCheck1 = "0" Then
                           strSql = strSql + " and substr(st03,1,2)<>'P1' "
                        End If
                        'end 2014/5/7
                        '2010/9/16 MODIFY BY SONIA
                        'strSort = " order by nvl(mr02, '0') asc"
                        strSort = " order by nvl(mr02, '0') asc,nvl(mr01, '0') asc"
             Case 2
                        If strCkind1 <> "" Then
                           strSql = "mr04>=" + CNULL(strCkind1) + " and "
                           strSql = strSql + "mr04<=" + CNULL(strCkind2)
                        Else
                           strSql = "(mr04 is null or mr04<=" + CNULL(strCkind2) + ")"
                        End If
                        'add by sonia 2014/5/7 是否含專業部輸入資料
                        If strCheck1 = "0" Then
                           strSql = strSql + " and substr(st03,1,2)<>'P1' "
                        End If
                        'end 2014/5/7
                        '2010/9/16 MODIFY BY SONIA
                        'strSort = " order by nvl(mr04, '0') asc"
                        strSort = " order by nvl(mr04, '0') asc,nvl(mr01, '0') asc"
             Case 3
                        If strCkind1 <> "" Then
                           strSql = "mr11>=" + CNULL(strCkind1) + " and "
                           strSql = strSql + "mr11<=" + CNULL(strCkind2)
                        Else
                           strSql = "(mr11 is null or mr11<=" + CNULL(strCkind2) + ")"
                        End If
                        'add by sonia 2014/5/7 是否含專業部輸入資料
                        If strCheck1 = "0" Then
                           strSql = strSql + " and substr(st03,1,2)<>'P1' "
                        End If
                        'end 2014/5/7
                        '2010/9/16 MODIFY BY SONIA
                        'strSort = " order by nvl(mr11, '0') asc"
                        strSort = " order by nvl(mr11, '0') asc,nvl(mr01, '0') asc"
             Case 4
                  ' 90.12.19 modify by louis
                        'If strCkind1 <> "" Then
                        '   strSQL = "mr12||mr13||mr14||mr15>=" + CNULL(strCkind1) + " and "
                        'End If
                        'strSQL = strSQL + "mr12||mr13||mr14||mr15<=" + CNULL(strCkind2)
                        'strSort = " order by nvl(mr12, '0') asc, nvl(mr13, '0') asc, nvl(mr14, '0') asc, nvl(mr15, '0') asc"
                     Dim strKEY01 As String
                     Dim strKEY02 As String
                     Dim strKEY03 As String
                     Dim strKEY04 As String
                     If strCkind1 <> "" Then
                        Cls001SplitOurReference strCkind1, strKEY01, strKEY02, strKEY03, strKEY04
                        strSql = " MR12>='" & strKEY01 & "' AND " & _
                                  "MR13>='" & strKEY02 & "' AND " & _
                                  "MR14>='" & strKEY03 & "' AND " & _
                                  "MR15>='" & strKEY04 & "' AND "
                     End If
                     If strCkind2 <> "" Then
                        Cls001SplitOurReference strCkind2, strKEY01, strKEY02, strKEY03, strKEY04
                        strSql = strSql & " MR12<='" & strKEY01 & "' AND " & _
                                  "MR13<='" & strKEY02 & "' AND " & _
                                  "MR14<='" & strKEY03 & "' AND " & _
                                  "MR15<='" & strKEY04 & "' "
                     End If
                     '2010/9/16 MODIFY BY SONIA
                     'strSort = " order by nvl(mr12, '0') asc, nvl(mr13, '0') asc, nvl(mr14, '0') asc, nvl(mr15, '0') asc"
                     'add by sonia 2014/5/7 是否含專業部輸入資料
                     If strCheck1 = "0" Then
                        strSql = strSql + " and substr(st03,1,2)<>'P1' "
                     End If
                     'end 2014/5/7
                     strSort = " order by nvl(mr12, '0') asc, nvl(mr13, '0') asc, nvl(mr14, '0') asc, nvl(mr15, '0') asc,nvl(mr02, '0') asc,nvl(mr01, '0') asc"
   End Select
   'modify by sonia 2014/5/7 是否含專業部輸入資料
   'strSql = "select '' ˇ,mr01 收件號,mr04 來函號數,mr12 本所案號,decode(mr12," + CNULL(馬德里案) + ",substr(mr13,1,5),mr13) 本所案號,decode(mr12," + CNULL(馬德里案) + ",substr(mr13,6,1),mr13) 本所案號,replace(mr14,'0') 本所案號,replace(mr15,'00') 本所案號,substr(mr02,1,4)-1911||'/'||substr(mr02,5,2)||'/'||substr(mr02,7,2) 收件日,decode(mr16,null,'',substr(mr16,1,4)-1911||'/'||substr(mr16,5,2)||'/'||substr(mr16,7,2)) 本所期限,mr11 機關文號,mr09 備註 from mailrec where " + strSql + strSort
   strSql = "select '' ˇ,mr01 收件號,mr04 來函號數,mr12 本所案號,decode(mr12," + CNULL(馬德里案) + ",substr(mr13,1,5),mr13) 本所案號,decode(mr12," + CNULL(馬德里案) + ",substr(mr13,6,1),mr13) 本所案號,replace(mr14,'0') 本所案號,replace(mr15,'00') 本所案號,substr(mr02,1,4)-1911||'/'||substr(mr02,5,2)||'/'||substr(mr02,7,2) 收件日,decode(mr16,null,'',substr(mr16,1,4)-1911||'/'||substr(mr16,5,2)||'/'||substr(mr16,7,2)) 本所期限,mr11 機關文號,mr09 備註 from mailrec,staff " & _
            "Where mr18=st01(+) and " + strSql + strSort
   'end 2014/5/7
   'edit by nickc 2007/02/06 不用 dll 了
   'Set Cls001ReadOrgRst = objPublicData.ReadRst(strSQL)
   'Set objPublicData = Nothing
   Set Cls001ReadOrgRst = ClsPDReadRst(strSql)
End Function
'讀取機關單位來函資料之Recodeset
Public Function Cls001ReadCKindRst(ByRef strCkind1 As String, ByRef strCkind2 As String) As ADODB.Recordset
'edit by nickc 2007/02/06 不用 dll 了
 'Dim strSQL As String, objPublicData As Object
   'Set objPublicData = CreateObject("prjTaieDll.clsPublicData")
   Dim strSql As String
   Select Case strCkind1
      Case 專利
         '91.11.7 MODIFY BY SONIA
         'strSQL = "select nvl(pa05,nvl(pa06,pa07)) 案件名稱,pa01 本所案號," & _
         '   "pa02 本所案號,pa02 本所案號,decode(pa03, '0', ' ', pa03) 本所案號,decode(pa04, '00', ' ', pa04) 本所案號," & _
         '   "nvl(cu04,nvl(cu05,cu06)) 申請人 from patent,customer where (pa11=" + CNULL(strCkind2) + " or pa22=" + CNULL(strCkind2) + ") AND " & _
         '   "substr(pa26,1,8)=cu01(+) and substr(pa26,9,1)=cu02(+) order by pa01,pa02,pa03,pa04"
         strSql = "select nvl(pa05,nvl(pa06,pa07)) 案件名稱,pa01 本所案號," & _
            "pa02 本所案號,pa02 本所案號,decode(pa03, '0', ' ', pa03) 本所案號,decode(pa04, '00', ' ', pa04) 本所案號," & _
            "nvl(cu04,nvl(cu05,cu06)) 申請人 from patent,customer where pa11=" + CNULL(strCkind2) + " AND " & _
            "substr(pa26,1,8)=cu01(+) and substr(pa26,9,1)=cu02(+) " & _
            "union select all nvl(pa05,nvl(pa06,pa07)) 案件名稱,pa01 本所案號," & _
            "pa02 本所案號,pa02 本所案號,decode(pa03, '0', ' ', pa03) 本所案號,decode(pa04, '00', ' ', pa04) 本所案號," & _
            "nvl(cu04,nvl(cu05,cu06)) 申請人 from patent,customer where pa22=" + CNULL(strCkind2) + " AND " & _
            "substr(pa26,1,8)=cu01(+) and substr(pa26,9,1)=cu02(+) order by 1,2,3,4"
         '91.11.7 END
      Case 商標
         '91.11.7 MODIFY BY SONIA
         'strSQL = "select nvl(tm05,nvl(tm06,tm07)) 案件名稱,tm01 本所案號," & _
         '   "decode(tm01," + CNULL(馬德里案) + ",substr(tm02,1,5),tm02) 本所案號," & _
         '   "decode(tm01," + CNULL(馬德里案) + ",substr(tm02,6,1),tm02) 本所案號," & _
         '   "decode(tm03, '0', ' ', tm03) 本所案號,decode(tm04, '0', ' ', tm04) 本所案號,nvl(cu04,nvl(cu05,cu06)) 申請人 from trademark," & _
         '   "customer where (tm12=" + CNULL(strCkind2) + " or tm15=" + CNULL(strCkind2) + ") AND substr(tm23,1,8)=cu01 and substr(tm23,9,1)=cu02" & _
         '   " order by 1,2,3,4"
         strSql = "select nvl(tm05,nvl(tm06,tm07)) 案件名稱,tm01 本所案號," & _
            "decode(tm01," + CNULL(馬德里案) + ",substr(tm02,1,5),tm02) 本所案號," & _
            "decode(tm01," + CNULL(馬德里案) + ",substr(tm02,6,1),tm02) 本所案號," & _
            "decode(tm03, '0', ' ', tm03) 本所案號,decode(tm04, '0', ' ', tm04) 本所案號,nvl(cu04,nvl(cu05,cu06)) 申請人 from trademark," & _
            "customer where tm12=" + CNULL(strCkind2) + " AND substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+)" & _
            "union select all nvl(tm05,nvl(tm06,tm07)) 案件名稱,tm01 本所案號," & _
            "decode(tm01," + CNULL(馬德里案) + ",substr(tm02,1,5),tm02) 本所案號," & _
            "decode(tm01," + CNULL(馬德里案) + ",substr(tm02,6,1),tm02) 本所案號," & _
            "decode(tm03, '0', ' ', tm03) 本所案號,decode(tm04, '0', ' ', tm04) 本所案號,nvl(cu04,nvl(cu05,cu06)) 申請人 from trademark," & _
            "customer where tm15=" + CNULL(strCkind2) + " AND substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+)" & _
            " order by 1,2,3,4"
         '91.11.7 END
      Case 法務
         strSql = "select nvl(lc05,nvl(lc06,lc07)) 案件名稱,lc01 本所案號,lc02 本所案號," & _
            "lc02 本所案號,decode(lc03, '0', ' ', lc03) 本所案號,decode(lc04, '0', ' ', lc04) 本所案號,nvl(cu04,nvl(cu05,cu06)) 申請人 from " & _
            "lawcase,customer,caseprogress where lc02=cp02 and lc03=cp03 and lc04=cp04 and cp35=" & CNULL(strCkind2) & " AND " & _
            "substr(lc11,1,8)=cu01(+) and substr(lc11,9,1)=cu02(+) order by lc01,lc02,lc03,lc04"
         'edit by nickc 2007/02/06 不用 dll 了
         'Set Cls001ReadCKindRst = objPublicData.ReadRst(strSQL)
         Set Cls001ReadCKindRst = ClsPDReadRst(strSql)
         If Cls001ReadCKindRst.EOF Then
            strSql = "select hc06 案件名稱,hc01 本所案號,hc02 本所案號,hc02 本所案號," & _
               "decode(hc03, '0', ' ', hc03) 本所案號,decode(hc04, '0', ' ', hc04) 本所案號,nvl(cu04,nvl(cu05,cu06)) 申請人 from hirecase,customer," & _
               "caseprogress where hc01=cp01 and hc02=cp02 and hc03=cp03 and hc04=cp04 and cp35=" + CNULL(strCkind2) + " AND " & _
               "substr(hc05,1,8)=cu01(+) and substr(hc05,9,1)=cu02(+) order by hc01,hc02,hc03,hc04"
         End If
      Case Else
         strSql = "select nvl(sp05,nvl(sp06,sp07)) 案件名稱,sp01 本所案號,sp02 本所案號,decode(sp03, '0', ' ', sp03) 本所案號," & _
            "decode(sp04, '0', ' ', sp04) 本所案號,nvl(cu04,nvl(cu05,cu06)) 申請人 from servicepractice,customer,caseprogress where " & _
            "sp01=cp01 and sp02=cp02 and sp03=cp03 and sp04=cp04 and cp28= " + CNULL(strCkind2) + " and cp01='TM'  AND " & _
            "substr(sp08,1,8)=cu01(+) and substr(sp08,9,1)=cu02(+) order by sp01,sp02,sp03,sp04"
   End Select
   'edit by nickc 2007/02/06 不用 dll 了
   'Set Cls001ReadCKindRst = objPublicData.ReadRst(strSQL)
   'Set objPublicData = Nothing
   Set Cls001ReadCKindRst = ClsPDReadRst(strSql)
End Function

'Add By Cheng 2003/05/13
'讀取機關單位來函資料之Recodeset
Public Function Cls001ReadCKindRst_1(ByRef strCkind1 As String, ByRef strCkind2 As String) As ADODB.Recordset
'edit by nickc 2007/02/06 不用 dll 了
'Dim strSQL As String, objPublicData As Object
   'Set objPublicData = CreateObject("prjTaieDll.clsPublicData")
Dim strSql As String
   Select Case strCkind1
      Case 專利
         '2008/3/5 modify by sonia 加控制申請國家為台灣 97104930 會找到大陸案
         '2009/2/12 MODIFY BY SONIA 加號數欄97300170會帶出FCP-037115,037116
         strSql = "Select nvl(pa05,nvl(pa06,pa07)) 案件名稱,pa01 本所案號," & _
            "pa02 本所案號,pa02 本所案號,decode(pa03, '0', ' ', pa03) 本所案號,decode(pa04, '00', ' ', pa04) 本所案號," & _
            "nvl(cu04,nvl(cu05,cu06)) 申請人,PA11 號數 From patent,customer where pa09='000' and pa11 Like " + CNULL(strCkind2 & "%") + " AND " & _
            "substr(pa26,1,8)=cu01(+) and substr(pa26,9,1)=cu02(+) " & _
            " Group By nvl(pa05,nvl(pa06,pa07)), pa01, pa02, decode(pa03, '0', ' ', pa03), decode(pa04, '00', ' ', pa04), nvl(cu04,nvl(cu05,cu06)),PA11 " & _
            " Union Select all nvl(pa05,nvl(pa06,pa07)) 案件名稱,pa01 本所案號," & _
            "pa02 本所案號,pa02 本所案號,decode(pa03, '0', ' ', pa03) 本所案號,decode(pa04, '00', ' ', pa04) 本所案號," & _
            "nvl(cu04,nvl(cu05,cu06)) 申請人,PA22 號數 from patent,customer where pa09='000' and pa22 Like " + CNULL(strCkind2 & "%") + " AND " & _
            "substr(pa26,1,8)=cu01(+) and substr(pa26,9,1)=cu02(+) " & _
            " Group By nvl(pa05,nvl(pa06,pa07)), pa01, pa02, decode(pa03, '0', ' ', pa03), decode(pa04, '00', ' ', pa04), nvl(cu04,nvl(cu05,cu06)),PA22 " & _
            " Union Select all nvl(pa05,nvl(pa06,pa07)) 案件名稱,pa01 本所案號," & _
            "pa02 本所案號,pa02 本所案號,decode(pa03, '0', ' ', pa03) 本所案號,decode(pa04, '00', ' ', pa04) 本所案號," & _
            "nvl(cu04,nvl(cu05,cu06)) 申請人,CP36 號數 from patent,customer, Caseprogress where pa09(+)='000' and PA01(+)=CP01 And PA02(+)=CP02 And PA03(+)=CP03 And PA04(+)=cp04 And CP36 Like " + CNULL(strCkind2 & "%") + " AND " & _
            "substr(pa26,1,8)=cu01(+) and substr(pa26,9,1)=cu02(+) " & _
            " Group By nvl(pa05,nvl(pa06,pa07)), pa01, pa02, decode(pa03, '0', ' ', pa03), decode(pa04, '00', ' ', pa04), nvl(cu04,nvl(cu05,cu06)),CP36 " & _
            " Order By 2,3,4,5,6 "
      Case 商標
         '2008/3/5 modify by sonia 加控制申請國家為台灣
         '2009/2/12 MODIFY BY SONIA 加號數欄97300170會帶出FCP-037115,037116
         'modify by sonia 2021/9/15 加TM10以排序(因有CFT-022553(01692168))
         strSql = "select nvl(tm05,nvl(tm06,tm07)) 案件名稱,tm01 本所案號," & _
            "decode(tm01," + CNULL(馬德里案) + ",substr(tm02,1,5),tm02) 本所案號," & _
            "decode(tm01," + CNULL(馬德里案) + ",substr(tm02,6,1),tm02) 本所案號," & _
            "decode(tm03, '0', ' ', tm03) 本所案號,decode(tm04, '00', ' ', tm04) 本所案號,nvl(cu04,nvl(cu05,cu06)) 申請人,TM12 號數,tm10 from trademark," & _
            "customer where tm10='000' and tm12 Like " + CNULL(strCkind2 & "%") + " AND substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+)" & _
            " Group By nvl(tm05,nvl(tm06,tm07)), tm01, decode(tm01," + CNULL(馬德里案) + ",substr(tm02,1,5),tm02), decode(tm01," + CNULL(馬德里案) + ",substr(tm02,6,1),tm02), decode(tm03, '0', ' ', tm03), decode(tm04, '00', ' ', tm04), nvl(cu04,nvl(cu05,cu06)),TM12,tm10 " & _
            " union select all nvl(tm05,nvl(tm06,tm07)) 案件名稱,tm01 本所案號," & _
            "decode(tm01," + CNULL(馬德里案) + ",substr(tm02,1,5),tm02) 本所案號," & _
            "decode(tm01," + CNULL(馬德里案) + ",substr(tm02,6,1),tm02) 本所案號," & _
            "decode(tm03, '0', ' ', tm03) 本所案號,decode(tm04, '00', ' ', tm04) 本所案號,nvl(cu04,nvl(cu05,cu06)) 申請人,TM15 號數,tm10 from trademark," & _
            "customer where tm10='000' and tm15 Like " + CNULL(strCkind2 & "%") + " AND substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+)" & _
            " Group By nvl(tm05,nvl(tm06,tm07)), tm01, decode(tm01," + CNULL(馬德里案) + ",substr(tm02,1,5),tm02), decode(tm01," + CNULL(馬德里案) + ",substr(tm02,6,1),tm02), decode(tm03, '0', ' ', tm03), decode(tm04, '00', ' ', tm04), nvl(cu04,nvl(cu05,cu06)),TM15,tm10 " & _
            " union select all nvl(tm05,nvl(tm06,tm07)) 案件名稱,tm01 本所案號," & _
            "decode(tm01," + CNULL(馬德里案) + ",substr(tm02,1,5),tm02) 本所案號," & _
            "decode(tm01," + CNULL(馬德里案) + ",substr(tm02,6,1),tm02) 本所案號," & _
            "decode(tm03, '0', ' ', tm03) 本所案號,decode(tm04, '00', ' ', tm04) 本所案號,nvl(cu04,nvl(cu05,cu06)) 申請人,CP36 號數,tm10 from trademark," & _
            "customer, CaseProgress where tm10(+)='000' and TM01(+)=CP01 And TM02(+)=CP02 And TM03(+)=CP03 And TM04(+)=CP04 And CP36 Like " + CNULL(strCkind2 & "%") + " AND substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+)" & _
            " Group By nvl(tm05,nvl(tm06,tm07)), tm01, decode(tm01," + CNULL(馬德里案) + ",substr(tm02,1,5),tm02), decode(tm01," + CNULL(馬德里案) + ",substr(tm02,6,1),tm02), decode(tm03, '0', ' ', tm03), decode(tm04, '00', ' ', tm04), nvl(cu04,nvl(cu05,cu06)),CP36,tm10 "
            'add by sonia 2021/9/15 +CFT之cp30(申請英文證明存台灣案審定號)CFT-022553(01692168)
            strSql = strSql & "union select nvl(tm05,nvl(tm06,tm07)) 案件名稱,tm01 本所案號,tm02 本所案號,tm02 本所案號,decode(tm03, '0', ' ', tm03) 本所案號,decode(tm04, '00', ' ', tm04) 本所案號," & _
               " nvl(cu04,nvl(cu05,cu06)) 申請人,cp30 號數,tm10 from CaseProgress,trademark,customer" & _
               " where cp30 Like " + CNULL(strCkind2 & "%") + " And cp01='CFT'" & _
               " And cp01=tm01(+) And cp02=tm02(+) And cp03=tm03(+) And cp04=tm04(+) " & _
               " And substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+) " & _
               " Group By nvl(tm05,nvl(tm06,tm07)),tm01,tm02,decode(tm03, '0', ' ', tm03),decode(tm04, '00', ' ', tm04),nvl(cu04,nvl(cu05,cu06)),cp30,tm10 "
            'end 2021/9/15
            strSql = strSql & " order by tm10,2,3,4,5,6"
      Case 法務
         '2008/3/5 modify by sonia 加控制申請國家為台灣
         strSql = "select nvl(lc05,nvl(lc06,lc07)) 案件名稱,lc01 本所案號,lc02 本所案號," & _
            "lc02 本所案號,decode(lc03, '0', ' ', lc03) 本所案號,decode(lc04, '0', ' ', lc04) 本所案號,nvl(cu04,nvl(cu05,cu06)) 申請人 from " & _
            "lawcase,customer,caseprogress where lc01(+)=cp01 and lc02(+)=cp02 and lc03(+)=cp03 and lc04(+)=cp04 and lc15(+)='000' and cp35 Like " & CNULL(strCkind2 & "%") & " AND " & _
            "substr(lc11,1,8)=cu01(+) and substr(lc11,9,1)=cu02(+) " & _
            " Group By nvl(lc05,nvl(lc06,lc07)), lc01, lc02, decode(lc03, '0', ' ', lc03), decode(lc04, '0', ' ', lc04), nvl(cu04,nvl(cu05,cu06)) " & _
            "order by lc01,lc02,decode(lc03, '0', ' ', lc03), decode(lc04, '0', ' ', lc04) "
         'edit by nickc 2007/02/06 不用 dll 了
         'Set ReadCKindRst_1 = objPublicData.ReadRst(strSQL)
         Set Cls001ReadCKindRst_1 = ClsPDReadRst(strSql)
         If Cls001ReadCKindRst_1.EOF Then
            strSql = "select hc06 案件名稱,hc01 本所案號,hc02 本所案號,hc02 本所案號," & _
               "decode(hc03, '0', ' ', hc03) 本所案號,decode(hc04, '0', ' ', hc04) 本所案號,nvl(cu04,nvl(cu05,cu06)) 申請人 from hirecase,customer," & _
               "caseprogress where hc01=cp01 and hc02=cp02 and hc03=cp03 and hc04=cp04 and cp35 Like " + CNULL(strCkind2 & "%") + " AND " & _
               "substr(hc05,1,8)=cu01(+) and substr(hc05,9,1)=cu02(+) " & _
               " Group By hc06, hc01, hc02, decode(hc03, '0', ' ', hc03), decode(hc04, '0', ' ', hc04), nvl(cu04,nvl(cu05,cu06)) " & _
               "order by hc01,hc02, decode(hc03, '0', ' ', hc03), decode(hc04, '0', ' ', hc04) "
         End If
      Case Else
         '2008/3/5 modify by sonia 加控制申請國家為台灣
         '2013/8/16 MODIFY BY SONIA 加FG-000882植物新品種保護申請案號抓SP11(暫時外專輸案件備註,秀玲補在SP11申請案號)
         'strSql = "select nvl(sp05,nvl(sp06,sp07)) 案件名稱,sp01 本所案號,sp02 本所案號,decode(sp03, '0', ' ', sp03) 本所案號," & _
            "decode(sp04, '0', ' ', sp04) 本所案號,nvl(cu04,nvl(cu05,cu06)) 申請人 from servicepractice,customer,caseprogress where " & _
            "sp01(+)=cp01 and sp02(+)=cp02 and sp03(+)=cp03 and sp04(+)=cp04 and sp09(+)='000' and cp28 Like " + CNULL(strCkind2 & "%") + " and cp01='TM'  AND " & _
            "substr(sp08,1,8)=cu01(+) and substr(sp08,9,1)=cu02(+) " & _
            " Group By nvl(sp05,nvl(sp06,sp07)), sp01, sp02, decode(sp03, '0', ' ', sp03), decode(sp04, '0', ' ', sp04), nvl(cu04,nvl(cu05,cu06)) " & _
            " order by sp01,sp02, decode(sp03, '0', ' ', sp03), decode(sp04, '0', ' ', sp04) "
         strSql = "select distinct nvl(sp05,nvl(sp06,sp07)) 案件名稱,sp01 本所案號,sp02 本所案號,decode(sp03, '0', ' ', sp03) 本所案號," & _
            "decode(sp04, '0', ' ', sp04) 本所案號,nvl(cu04,nvl(cu05,cu06)) 申請人 from servicepractice,customer,caseprogress where " & _
            "sp01(+)=cp01 and sp02(+)=cp02 and sp03(+)=cp03 and sp04(+)=cp04 and sp09(+)='000' and cp28 Like " + CNULL(strCkind2 & "%") + " and cp01='TM'  AND " & _
            "substr(sp08,1,8)=cu01(+) and substr(sp08,9,1)=cu02(+) " & _
            "union select nvl(sp05,nvl(sp06,sp07)) 案件名稱,sp01 本所案號,sp02 本所案號,decode(sp03, '0', ' ', sp03) 本所案號," & _
            "decode(sp04, '0', ' ', sp04) 本所案號,nvl(cu04,nvl(cu05,cu06)) 申請人 from servicepractice,customer where " & _
            "sp09(+)='000' and sp11 Like " + CNULL(strCkind2 & "%") + " and sp01='FG'  AND " & _
            "substr(sp08,1,8)=cu01(+) and substr(sp08,9,1)=cu02(+) " & _
            " order by 2,3,4,5"
   End Select
   'edit by nickc 2007/02/06 不用 dll 了
   'Set Cls001ReadCKindRst_1 = objPublicData.ReadRst(strSQL)
   'Set objPublicData = Nothing
   Set Cls001ReadCKindRst_1 = ClsPDReadRst(strSql)
End Function


'修改顧問聘任資料庫
Public Function Cls001UpdateHireDatabase(ByRef hc01 As String, _
      ByRef hc02 As String, ByRef hc03 As String, ByRef hc04 As String, ByRef hc05 As String, _
      ByRef hc06 As String, ByRef CP09 As String, _
      ByRef cp05 As String, ByRef CP10 As String, ByRef cp11 As String, ByRef cp53 As String, _
      ByRef cp54 As String, ByRef cp13 As String, ByRef cp16 As String, _
      ByRef cp32 As String, ByRef cu30 As String, ByRef cp14 As String) As Boolean
Dim strSql As String
Dim adoquery As New ADODB.Recordset
'Add By Cheng 2002/11/14
Dim BolTransOk As Boolean
BolTransOk = True

On Error GoTo ErrHand
cp05 = ChangeTStringToWString(cp05)
cp53 = ChangeTStringToWString(cp53)
cp54 = ChangeTStringToWString(cp54)
hc05 = ChangeCustomerL(hc05)
cnnConnection.BeginTrans
strSql = "update hirecase set hc05=" + CNULL(hc05) + ",hc06=" + CNULL(hc06) + _
   " where hc01=" + CNULL(hc01) + " and hc02=" + CNULL(hc02) + " and hc03=" + CNULL(hc03) + " and hc04=" + CNULL(hc04)
cnnConnection.Execute strSql
strSql = "update caseprogress set cp05=" + CNULL(cp05) + ",cp10=" + CNULL(CP10) + ",cp11=" + CNULL(cp11) + ",cp53=" + CNULL(cp53) + ",cp54=" + CNULL(cp54) + ",cp13=" + CNULL(cp13) + _
   ",cp14=" + CNULL(cp14) + ",cp16=" + CNULL(cp16) + ",cp32=" + CNULL(cp32) + ",cp18=" & CNULL(IIf(Val(cp16) / 1000 = 0, "", Val(cp16) / 1000)) & " where cp09=" + CNULL(CP09)
cnnConnection.Execute strSql
strSql = "update caseprogress set cp12=(select st03 from staff where st01=" + CNULL(cp13) + ") where cp09=" + CNULL(CP09)
cnnConnection.Execute strSql
strSql = "update customer set cu30=" + CNULL(cu30) + " where cu01=" + CNULL(Mid(hc05, 1, 8)) + " and cu02=" + CNULL(Mid(hc05, 9, 1))
cnnConnection.Execute strSql
adoquery.CursorLocation = adUseClient
adoquery.Open "select np01 from nextprogress where np02 = '" & hc01 & "' and np03 = '" & hc02 & "' and np04 = '" & hc03 & "' and np05 = '" & hc04 & "' and np07 = '" & CP10 & "'", cnnConnection, adOpenStatic, adLockReadOnly
If adoquery.RecordCount <> 0 Then
   If IsNull(adoquery.Fields(0).Value) = False Then
      cnnConnection.Execute "update caseprogress set cp43 = '" & adoquery.Fields(0).Value & "' where cp09 = '" & CP09 & "'"
   End If
End If
adoquery.Close
'Modify By Cheng 2002/11/14
If BolTransOk Then
    cnnConnection.CommitTrans
End If
Cls001UpdateHireDatabase = True
Exit Function
ErrHand:
    'Add By Cheng 2002/11/14
    If Err.Number = -2147168237 Then
       BolTransOk = False
       Resume Next
    End If

cnnConnection.RollbackTrans
ShowMsg MsgText(9004)
'edit by nickc 2007/02/05
'ErrorLog
MsgBox Err.Description

End Function
'讀取顧問聘任資料庫
Public Function Cls001ReadHireDatabase(ByRef intModifyKind As Integer, ByRef hc01 As String, _
             ByRef hc02 As String, ByRef hc03 As String, ByRef hc04 As String, ByRef hc05 As String, _
             ByRef hc06 As String, ByRef cp05 As String, ByRef CP09 As String, ByRef CP10 As String, ByRef cp11 As String, ByRef cp53 As String, ByRef cp54 As String, _
             ByRef cp13 As String, ByRef cp16 As String, ByRef cp32 As String, ByRef cu30 As String, ByRef cp14 As String) As Boolean
Dim strSql As String, rsRecordset As New ADODB.Recordset, strTemp As String

On Error GoTo ErrHand
If intModifyKind <> 0 Then
   strSql = "select cp05,cp09,cp10,cp11,cp53,cp54,cp13,cp16,cp32,cp14 from caseprogress where cp09=" + CNULL(CP09)
   rsRecordset.CursorLocation = adUseClient
   rsRecordset.Open strSql, cnnConnection
   If rsRecordset.RecordCount > 0 Then
      cp05 = IIf(IsNull(rsRecordset.Fields(0)), "", rsRecordset.Fields(0))
      If cp05 <> "" Then cp05 = ChangeWStringToTString(cp05)
      CP09 = IIf(IsNull(rsRecordset.Fields(1)), "", rsRecordset.Fields(1))
      CP10 = IIf(IsNull(rsRecordset.Fields(2)), "", rsRecordset.Fields(2))
      cp11 = IIf(IsNull(rsRecordset.Fields(3)), "", rsRecordset.Fields(3))
      cp53 = IIf(IsNull(rsRecordset.Fields(4)), "", rsRecordset.Fields(4))
      If cp53 <> "" Then cp53 = ChangeWStringToTString(cp53)
      cp54 = IIf(IsNull(rsRecordset.Fields(5)), "", rsRecordset.Fields(5))
      If cp54 <> "" Then cp54 = ChangeWStringToTString(cp54)
      cp13 = IIf(IsNull(rsRecordset.Fields(6)), "", rsRecordset.Fields(6))
      cp16 = IIf(IsNull(rsRecordset.Fields(7)), "", rsRecordset.Fields(7))
      cp32 = IIf(IsNull(rsRecordset.Fields(8)), "", rsRecordset.Fields(8))
      cp14 = IIf(IsNull(rsRecordset.Fields(9)), "", rsRecordset.Fields(9))
   Else
      ShowMsg MsgText(1502)
      Exit Function
   End If
   rsRecordset.Close
End If
strSql = "select hc05,hc06 from hirecase where hc01=" + CNULL(hc01) + " and hc02=" + CNULL(hc02) + " and hc03=" + CNULL(hc03) + " and hc04=" + CNULL(hc04)
rsRecordset.CursorLocation = adUseClient
rsRecordset.Open strSql, cnnConnection
If rsRecordset.RecordCount > 0 Then
   hc05 = IIf(IsNull(rsRecordset.Fields(0)), "", rsRecordset.Fields(0))
   hc06 = IIf(IsNull(rsRecordset.Fields(1)), "", rsRecordset.Fields(1))
   rsRecordset.Close
   'strSQL = "select cu30 from customer where cu01||cu02='" + hc05 + "'"
   strSql = "select cu30 from customer where cu01=" + CNULL(Mid(hc05, 1, 8)) + " AND cu02=" + CNULL(Mid(hc05, 9, 1))
   rsRecordset.CursorLocation = adUseClient
   rsRecordset.Open strSql, cnnConnection
   If rsRecordset.RecordCount > 0 Then
      cu30 = IIf(IsNull(rsRecordset.Fields(0)), "", rsRecordset.Fields(0))
      hc05 = ChangeCustomerS(hc05)
      Cls001ReadHireDatabase = True
   Else
      ShowMsg MsgText(1503)
      Exit Function
   End If
Else
   If intModifyKind <> 0 Then
      ShowMsg "找不到此本所案號在基本檔之資料"
   End If
End If
rsRecordset.Close
Exit Function
ErrHand:
'edit by nickc 2007/02/05
'ErrorLog
MsgBox Err.Description

End Function
'讀取Trademark資料庫
Public Function Cls001ReadTrademarkDatabase(ByRef intModifyKind As Integer, ByRef tm01 As String, _
             ByRef tm02 As String, ByRef tm03 As String, ByRef tm04 As String, ByRef tm05 As String, _
             ByRef tm06 As String, ByRef tm07 As String, ByRef tm08 As String, ByRef tm09 As String, _
             ByRef tm10 As String, ByRef tm23 As String, ByRef tm44 As String, ByRef CP09 As String, _
             ByRef cp05 As String, ByRef cp06 As String, ByRef cp07 As String, ByRef CP10 As String, ByRef cp11 As String, _
             ByRef cp13 As String, ByRef cp14 As String, ByRef cp16 As String, ByRef cp17 As String, _
             ByRef cp18 As String, ByRef cp19 As String, ByRef cp32 As String, ByRef cp56 As String, ByRef cu30 As String) As Boolean
Dim strSql As String, rsRecordset As New ADODB.Recordset, strTemp As String

On Error GoTo ErrHand
If intModifyKind <> 0 Then
   strSql = "select cp05,cp06,cp07,cp10,cp11,cp13,cp16,cp17,cp18,cp19,cp32,cp56,cp14 from caseprogress where cp09='" + CP09 + "'"
   rsRecordset.CursorLocation = adUseClient
   rsRecordset.Open strSql, cnnConnection
   If rsRecordset.RecordCount > 0 Then
      cp05 = IIf(IsNull(rsRecordset.Fields(0)), "", rsRecordset.Fields(0))
      If cp05 <> "" Then cp05 = ChangeWStringToTString(cp05)
      cp06 = IIf(IsNull(rsRecordset.Fields(1)), "", rsRecordset.Fields(1))
      cp07 = IIf(IsNull(rsRecordset.Fields(2)), "", rsRecordset.Fields(2))
      CP10 = IIf(IsNull(rsRecordset.Fields(3)), "", rsRecordset.Fields(3))
      cp11 = IIf(IsNull(rsRecordset.Fields(4)), "", rsRecordset.Fields(4))
      cp13 = IIf(IsNull(rsRecordset.Fields(5)), "", rsRecordset.Fields(5))
      cp16 = IIf(IsNull(rsRecordset.Fields(6)), "", rsRecordset.Fields(6))
      cp17 = IIf(IsNull(rsRecordset.Fields(7)), "", rsRecordset.Fields(7))
      cp18 = IIf(IsNull(rsRecordset.Fields(8)), "", rsRecordset.Fields(8))
      cp19 = IIf(IsNull(rsRecordset.Fields(9)), "", rsRecordset.Fields(9))
      cp32 = IIf(IsNull(rsRecordset.Fields(10)), "", rsRecordset.Fields(10))
      cp56 = IIf(IsNull(rsRecordset.Fields(11)), "", rsRecordset.Fields(11))
      cp14 = IIf(IsNull(rsRecordset.Fields(12)), "", rsRecordset.Fields(12))
   Else
      ShowMsg MsgText(1502)
      rsRecordset.Close
      Exit Function
   End If
   rsRecordset.Close
Else
   If Cls001GetNextProgressDate(tm01, tm02, tm03, tm04, CP10, cp06, cp07) = False Then
      Exit Function
   End If
End If
If cp06 <> "" Then cp06 = ChangeWStringToTString(cp06)
If cp07 <> "" Then cp07 = ChangeWStringToTString(cp07)
strSql = "select tm05,tm06,tm07,tm08,tm09,tm10,tm23,tm44 from trademark where tm01=" + CNULL(tm01) + " and tm02=" + CNULL(tm02) + " and tm03=" + CNULL(tm03) + " and tm04=" + CNULL(tm04)
rsRecordset.CursorLocation = adUseClient
rsRecordset.Open strSql, cnnConnection
If rsRecordset.RecordCount > 0 Then
   tm05 = IIf(IsNull(rsRecordset.Fields(0)), "", rsRecordset.Fields(0))
   tm06 = IIf(IsNull(rsRecordset.Fields(1)), "", rsRecordset.Fields(1))
   tm07 = IIf(IsNull(rsRecordset.Fields(2)), "", rsRecordset.Fields(2))
   tm08 = IIf(IsNull(rsRecordset.Fields(3)), "", rsRecordset.Fields(3))
   tm09 = IIf(IsNull(rsRecordset.Fields(4)), "", rsRecordset.Fields(4))
   tm10 = IIf(IsNull(rsRecordset.Fields(5)), "", rsRecordset.Fields(5))
   tm23 = IIf(IsNull(rsRecordset.Fields(6)), "", rsRecordset.Fields(6))
   tm44 = IIf(IsNull(rsRecordset.Fields(7)), "", rsRecordset.Fields(7))
   rsRecordset.Close
   strSql = "select cu30 from customer where cu01=" + CNULL(Mid(tm23, 1, 8)) + " AND cu02=" + CNULL(Mid(tm23, 9, 1))
   rsRecordset.CursorLocation = adUseClient
   rsRecordset.Open strSql, cnnConnection
   If rsRecordset.RecordCount > 0 Then
      cu30 = IIf(IsNull(rsRecordset.Fields(0)), "", rsRecordset.Fields(0))
      tm23 = ChangeCustomerS(tm23)
      tm44 = ChangeCustomerS(tm44)
      cp56 = ChangeCustomerS(cp56)
      Cls001ReadTrademarkDatabase = True
   Else
      ShowMsg MsgText(1503)
      Exit Function
   End If
Else
   If intModifyKind <> 0 Then
      ShowMsg MsgText(1504)
   End If
End If
rsRecordset.Close
Exit Function
ErrHand:
'edit by nickc 2007/02/05
'ErrorLog
MsgBox Err.Description

End Function


'讀取Patent資料庫
Public Function Cls001ReadPatentDatabase(ByRef intModifyKind As Integer, ByRef pa01 As String, _
             ByRef pa02 As String, ByRef pa03 As String, ByRef pa04 As String, ByRef pa05 As String, _
             ByRef pa06 As String, ByRef pa07 As String, ByRef PA08 As String, ByRef PA09 As String, _
             ByRef pa26 As String, ByRef pa27 As String, ByRef pa28 As String, ByRef pa29 As String, _
             ByRef pa30 As String, ByRef pa75 As String, ByRef CP09 As String, _
             ByRef cp05 As String, ByRef cp06 As String, ByRef cp07 As String, ByRef CP10 As String, ByRef cp11 As String, _
             ByRef cp13 As String, ByRef cp16 As String, ByRef cp17 As String, _
             ByRef cp18 As String, ByRef cp19 As String, ByRef cp32 As String, ByRef cp56 As String, ByRef cu30 As String, ByRef cp14 As String) As Boolean
Dim strSql As String, rsRecordset As New ADODB.Recordset, strTemp As String

On Error GoTo ErrHand
If intModifyKind <> 0 Then
   strSql = "select cp05,cp06,cp07,cp10,cp11,cp13,cp16,cp17,cp18,cp19,cp32,cp56,cp14 from caseprogress where cp09='" + CP09 + "'"
   rsRecordset.CursorLocation = adUseClient
   rsRecordset.Open strSql, cnnConnection
   If rsRecordset.RecordCount > 0 Then
      cp05 = IIf(IsNull(rsRecordset.Fields(0)), "", rsRecordset.Fields(0))
      If cp05 <> "" Then cp05 = ChangeWStringToTString(cp05)
      cp06 = IIf(IsNull(rsRecordset.Fields(1)), "", rsRecordset.Fields(1))
      cp07 = IIf(IsNull(rsRecordset.Fields(2)), "", rsRecordset.Fields(2))
      CP10 = IIf(IsNull(rsRecordset.Fields(3)), "", rsRecordset.Fields(3))
      cp11 = IIf(IsNull(rsRecordset.Fields(4)), "", rsRecordset.Fields(4))
      cp13 = IIf(IsNull(rsRecordset.Fields(5)), "", rsRecordset.Fields(5))
      cp16 = IIf(IsNull(rsRecordset.Fields(6)), "", rsRecordset.Fields(6))
      cp17 = IIf(IsNull(rsRecordset.Fields(7)), "", rsRecordset.Fields(7))
      cp18 = IIf(IsNull(rsRecordset.Fields(8)), "", rsRecordset.Fields(8))
      cp19 = IIf(IsNull(rsRecordset.Fields(9)), "", rsRecordset.Fields(9))
      cp32 = IIf(IsNull(rsRecordset.Fields(10)), "", rsRecordset.Fields(10))
      cp56 = IIf(IsNull(rsRecordset.Fields(11)), "", rsRecordset.Fields(11))
      cp14 = IIf(IsNull(rsRecordset.Fields(12)), "", rsRecordset.Fields(12))
   Else
      ShowMsg MsgText(1502)
      rsRecordset.Close
      Exit Function
   End If
   rsRecordset.Close
Else
   If Cls001GetNextProgressDate(pa01, pa02, pa03, pa04, CP10, cp06, cp07) = False Then
      Exit Function
   End If
End If
If cp06 <> "" Then cp06 = ChangeWStringToTString(cp06)
If cp07 <> "" Then cp07 = ChangeWStringToTString(cp07)
strSql = "select pa05,pa06,pa07,pa08,pa09,pa26,pa27,pa28,pa29,pa30,pa75 " + _
       "from patent where pa01=" + CNULL(pa01) + " and pa02=" + CNULL(pa02) + " and pa03=" + CNULL(pa03) + " and pa04=" + CNULL(pa04)
rsRecordset.CursorLocation = adUseClient
rsRecordset.Open strSql, cnnConnection
If rsRecordset.RecordCount > 0 Then
   pa05 = IIf(IsNull(rsRecordset.Fields(0)), "", rsRecordset.Fields(0))
   pa06 = IIf(IsNull(rsRecordset.Fields(1)), "", rsRecordset.Fields(1))
   pa07 = IIf(IsNull(rsRecordset.Fields(2)), "", rsRecordset.Fields(2))
   PA08 = IIf(IsNull(rsRecordset.Fields(3)), "", rsRecordset.Fields(3))
   PA09 = IIf(IsNull(rsRecordset.Fields(4)), "", rsRecordset.Fields(4))
   pa26 = IIf(IsNull(rsRecordset.Fields(5)), "", rsRecordset.Fields(5))
   pa27 = IIf(IsNull(rsRecordset.Fields(6)), "", rsRecordset.Fields(6))
   pa28 = IIf(IsNull(rsRecordset.Fields(7)), "", rsRecordset.Fields(7))
   pa29 = IIf(IsNull(rsRecordset.Fields(8)), "", rsRecordset.Fields(8))
   pa30 = IIf(IsNull(rsRecordset.Fields(9)), "", rsRecordset.Fields(9))
   pa75 = IIf(IsNull(rsRecordset.Fields(10)), "", rsRecordset.Fields(10))
   rsRecordset.Close
   strSql = "select cu30 from customer where cu01=" + CNULL(Mid(pa26, 1, 8)) + " AND cu02=" + CNULL(Mid(pa26, 9, 1))
   rsRecordset.CursorLocation = adUseClient
   rsRecordset.Open strSql, cnnConnection
   If rsRecordset.RecordCount > 0 Then
      cu30 = IIf(IsNull(rsRecordset.Fields(0)), "", rsRecordset.Fields(0))
      cp56 = ChangeCustomerS(cp56)
      pa26 = ChangeCustomerS(pa26)
      pa27 = ChangeCustomerS(pa27)
      pa28 = ChangeCustomerS(pa28)
      pa29 = ChangeCustomerS(pa29)
      pa30 = ChangeCustomerS(pa30)
      pa75 = ChangeCustomerS(pa75)
      Cls001ReadPatentDatabase = True
   Else
      ShowMsg MsgText(1503)
      Exit Function
   End If
Else
   If intModifyKind <> 0 Then
      ShowMsg "找不到此本所案號在專利基本檔之資料"
      Exit Function
   End If
End If
rsRecordset.Close
Exit Function
ErrHand:
'edit by nickc 2007/02/05
'ErrorLog
MsgBox Err.Description

End Function


'修改CKind資料庫
Public Function Cls001UpdateCKindDatabase(ByRef mr01 As String, _
             ByRef mr02 As String, ByRef mr03 As String, ByRef mr04 As String, ByRef mr05 As String, _
             ByRef mr06 As String, ByRef mr07 As String, ByRef mr08 As String, _
             ByRef mr09 As String, ByRef mr10 As String, ByRef mr11 As String, ByRef mr12 As String, _
             ByRef mr13 As String, ByRef mr14 As String, ByRef mr15 As String, ByRef mr16 As String, _
             ByRef mr17 As String) As Boolean
Dim strSql As String

On Error GoTo ErrHand
mr02 = ChangeTStringToWString(mr02)
mr08 = ChangeTStringToWString(mr08)
mr16 = ChangeTStringToWString(mr16)
mr17 = ChangeTStringToWString(mr17)
'edit by nickc 2005/09/16 未觸發 triggers
'StrSql = "update mailrec set mr02=" + CNULL(mr02) + ",mr03=" + CNULL(mr03) + ",mr04=" + CNULL(mr04) _
          + ",mr05=" + CNULL(mr05) + ",mr06=" + CNULL(mr06) + ",mr07=" + CNULL(mr07) + ",mr08=" + CNULL(mr08) + ",mr09=" + CNULL(mr09) + _
          ",mr10=" + CNULL(mr10) + ",mr11=" + CNULL(mr11) + ",mr12=" + CNULL(mr12) + ",mr13=" + CNULL(mr13) + ",mr14=" + CNULL(mr14) + _
          ",mr15=" + CNULL(mr15) + ",mr16=" + CNULL(mr16) + ",mr17=" + CNULL(mr17) + " where mr01=" + CNULL(mr01)
strSql = "begin user_data.user_enabled:=1; update mailrec set mr02=" + CNULL(mr02) + ",mr03=" + CNULL(mr03) + ",mr04=" + CNULL(mr04) _
          + ",mr05=" + CNULL(mr05) + ",mr06=" + CNULL(mr06) + ",mr07=" + CNULL(mr07) + ",mr08=" + CNULL(mr08) + ",mr09=" + CNULL(mr09) + _
          ",mr10=" + CNULL(mr10) + ",mr11=" + CNULL(mr11) + ",mr12=" + CNULL(mr12) + ",mr13=" + CNULL(mr13) + ",mr14=" + CNULL(mr14) + _
          ",mr15=" + CNULL(mr15) + ",mr16=" + CNULL(mr16) + ",mr17=" + CNULL(mr17) + " where mr01=" + CNULL(mr01) & " ; end; "

cnnConnection.Execute strSql
Cls001UpdateCKindDatabase = True
Exit Function
ErrHand:
ShowMsg MsgText(9004)
'edit by nickc 2007/02/05
'ErrorLog
MsgBox Err.Description

End Function

'讀取CKind資料庫
'Modify by Morgan 2007/6/12 加 mr24
Public Function Cls001ReadCKindDataBase(ByRef mr01 As String, _
             ByRef mr02 As String, ByRef mr03 As String, ByRef mr04 As String, ByRef mr05 As String, _
             ByRef mr06 As String, ByRef mr07 As String, ByRef mr08 As String, _
             ByRef mr09 As String, ByRef mr10 As String, ByRef mr11 As String, ByRef mr12 As String, _
             ByRef mr13 As String, ByRef mr14 As String, ByRef mr15 As String, ByRef mr24 As String, _
             ByRef mr18 As String, ByRef mr19 As String, ByRef mr20 As String, ByRef mr21 As String, _
             ByRef mr22 As String, ByRef mr23 As String) As Boolean
Dim strSql As String, rsRecordset As New ADODB.Recordset

On Error GoTo ErrHand
strSql = "select mr02,mr03,mr04,mr05,mr06,mr07,mr08,mr09,mr10,mr11,mr12,mr13," + _
          "mr14,mr15,mr24,mr18,mr19,mr20,mr21,mr22,mr23 from mailrec where mr01=" + CNULL(mr01)
rsRecordset.CursorLocation = adUseClient
rsRecordset.Open strSql, cnnConnection
If rsRecordset.RecordCount > 0 Then
   mr02 = IIf(IsNull(rsRecordset.Fields(0)), "", rsRecordset.Fields(0))
   If mr02 <> "" Then mr02 = ChangeWStringToTString(mr02)
   mr03 = IIf(IsNull(rsRecordset.Fields(1)), "", rsRecordset.Fields(1))
   mr04 = IIf(IsNull(rsRecordset.Fields(2)), "", rsRecordset.Fields(2))
   mr05 = IIf(IsNull(rsRecordset.Fields(3)), "", rsRecordset.Fields(3))
   mr06 = IIf(IsNull(rsRecordset.Fields(4)), "", rsRecordset.Fields(4))
   mr07 = IIf(IsNull(rsRecordset.Fields(5)), "", rsRecordset.Fields(5))
   mr08 = IIf(IsNull(rsRecordset.Fields(6)), "", rsRecordset.Fields(6))
   If mr08 <> "" Then mr08 = ChangeWStringToTString(mr08)
   mr09 = IIf(IsNull(rsRecordset.Fields(7)), "", rsRecordset.Fields(7))
   mr10 = IIf(IsNull(rsRecordset.Fields(8)), "", rsRecordset.Fields(8))
   mr11 = IIf(IsNull(rsRecordset.Fields(9)), "", rsRecordset.Fields(9))
   mr12 = IIf(IsNull(rsRecordset.Fields(10)), "", rsRecordset.Fields(10))
   mr13 = IIf(IsNull(rsRecordset.Fields(11)), "", rsRecordset.Fields(11))
   mr14 = IIf(IsNull(rsRecordset.Fields(12)), "", rsRecordset.Fields(12))
   mr15 = IIf(IsNull(rsRecordset.Fields(13)), "", rsRecordset.Fields(13))
   mr24 = "" & rsRecordset.Fields("mr24")
   '2014/5/2 add by sonia
   mr18 = "" & rsRecordset.Fields("mr18")
   mr19 = "" & rsRecordset.Fields("mr19")
   mr20 = "" & rsRecordset.Fields("mr20")
   mr21 = "" & rsRecordset.Fields("mr21")
   mr22 = "" & rsRecordset.Fields("mr22")
   mr23 = "" & rsRecordset.Fields("mr23")
   '2014/5/2 end
   Cls001ReadCKindDataBase = True
Else
   ShowMsg MsgText(1505)
End If
rsRecordset.Close
Exit Function
ErrHand:
'edit by nickc 2007/02/05
'ErrorLog
MsgBox Err.Description

End Function

Public Function Cls001GetCodeNameAndPetition(ByRef mr09 As String, ByRef mr10 As String, _
      ByRef mr11 As String, ByRef mr12 As String, ByRef tm05 As String, ByRef cu04 As String) As Boolean
Dim strSql As String, rsRecordset As New ADODB.Recordset
Dim intCaseKind As Integer, strCaseName As String

On Error GoTo ErrHand
'edit by nickc 2007/02/06 不用 dll 了
'Dim objPublicData As Object
'Set objPublicData = CreateObject("prjTaieDll.clsPublicData")
'If objPublicData.GetSystemKind(mr09, intCaseKind, strCaseName) = False Then
   'Set objPublicData = Nothing
If ClsPDGetSystemKind(mr09, intCaseKind, strCaseName) = False Then
   Exit Function
End If
'edit by nickc 2007/02/06 不用 dll 了
'Set objPublicData = Nothing
Select Case intCaseKind
             Case 0
                        strSql = "select nvl(tm05,nvl(tm06,tm07)),cu04 from trademark,customer where cu01=substr(tm23, 1, 8) and cu02=substr(tm23, 9, 1) and tm01=" + _
                              CNULL(mr09) + " and tm02=" + CNULL(mr10) + " and tm03=" + CNULL(mr11) + _
                              " and tm04=" + CNULL(mr12)
             Case 1
                        strSql = "select nvl(pa05,nvl(pa06,pa07)),cu04 from patent,customer where cu01=substr(pa26, 1, 8) and cu02=substr(pa26, 9, 1) and pa01=" + _
                              CNULL(mr09) + " and pa02=" + CNULL(mr10) + " and pa03=" + CNULL(mr11) + _
                              " and pa04=" + CNULL(mr12)
             Case 2
                        strSql = "select nvl(tm05,nvl(tm06,tm07)),tm20 from trademark where tm01=" + _
                              CNULL(mr09) + " and tm02=" + CNULL(mr10) + " and tm03=" + CNULL(mr11) + _
                              " and tm04=" + CNULL(mr12)
             Case Else
                        ShowMsg MsgText(1006)
                        Exit Function
End Select
rsRecordset.CursorLocation = adUseClient
rsRecordset.Open strSql, cnnConnection
If rsRecordset.RecordCount > 0 Then
   tm05 = IIf(IsNull(rsRecordset.Fields(0)), "", rsRecordset.Fields(0))
   cu04 = IIf(IsNull(rsRecordset.Fields(1)), "", rsRecordset.Fields(1))
   Cls001GetCodeNameAndPetition = True
Else
   ShowMsg MsgText(9141)
End If
rsRecordset.Close
Exit Function
ErrHand:
ShowMsg MsgText(1507)
'edit by nickc 2007/02/05
'ErrorLog
MsgBox Err.Description

End Function

'判斷馬德里案之輸入是否正確
Public Function Cls001CheckTFTextOkay(ByVal strSystem As String, ByRef intSaveMode As Integer, ParamArray txtTemp()) As Boolean
Dim i As Integer

If txtTemp(0).Text = "" And txtTemp(1).Text = "" And txtTemp(2).Text = "" And txtTemp(3).Text = "" Then
   Cls001CheckTFTextOkay = True
   intSaveMode = 1
   Exit Function
End If
If txtTemp(0).Text <> "" And txtTemp(1).Text = "" And txtTemp(2).Text = "" And txtTemp(3).Text = "" Then
   ShowMsg MsgText(1508)
   Exit Function
End If
If txtTemp(0).Text <> "" And txtTemp(1).Text <> "" And txtTemp(2).Text <> "" And txtTemp(3).Text = "" Then
   ShowMsg MsgText(1508)
   Exit Function
End If
For i = 0 To 3
       If txtTemp(i).Text <> "" Then
          If Len(txtTemp(i).Text) <> txtTemp(i).MaxLength Then
             Exit For
          End If
       End If
Next
If i < 4 Then
   ShowMsg MsgText(1509)
   Exit Function
End If
intSaveMode = Cls001CheckTFCodeExist(strSystem, txtTemp(0).Text, txtTemp(1).Text, txtTemp(2).Text, txtTemp(3).Text)
If intSaveMode = -1 Then
   ShowMsg MsgText(1510)
   Exit Function
ElseIf intSaveMode = -2 Then
   Exit Function
End If
Cls001CheckTFTextOkay = True
End Function

'判斷其他案之輸入是否正確
Public Function Cls001CheckTextOkay(ByVal intCaseKind As Integer, ByVal strSystem As String, ByRef intSaveMode As Integer, ParamArray txtTemp()) As Boolean
Dim i As Integer

If txtTemp(0).Text = "" And txtTemp(1).Text = "" And txtTemp(2).Text = "" Then
   Cls001CheckTextOkay = True
   intSaveMode = 1
   Exit Function
End If
If (txtTemp(1).Text <> "" And txtTemp(0).Text = "") Or _
   (txtTemp(2).Text <> "" And txtTemp(0).Text = "") Then
   ShowMsg MsgText(1511)
   Exit Function
End If
If txtTemp(2).Text <> "" And txtTemp(1).Text = "" Then
   ShowMsg MsgText(1512)
   Exit Function
End If
For i = 0 To 2
       If txtTemp(i).Text <> "" Then
          If Len(txtTemp(i).Text) <> txtTemp(i).MaxLength Then
             Exit For
          End If
       End If
Next
If i < 3 Then
   ShowMsg MsgText(1509)
   Exit Function
End If
intSaveMode = Cls001CheckCodeExist(intCaseKind, strSystem, txtTemp(0).Text, txtTemp(1).Text, txtTemp(2).Text)
If intSaveMode = -1 Then
   ShowMsg MsgText(1510)
   Exit Function
ElseIf intSaveMode = -2 Then
   Exit Function
End If
Cls001CheckTextOkay = True
End Function

'判斷其他案之本所案號是否正確
Private Function Cls001CheckCodeExist(ByVal intCaseKind As Integer, ByVal strSystem As String, strTemp0 As String, strTemp1 As String, strTemp2 As String) As Integer
Dim strSQL1 As String, strSQL2 As String, StrSQL3 As String, rsRecordset As New ADODB.Recordset

On Error GoTo ErrHand
Select Case intCaseKind
             Case 商標
                        strSQL1 = "select tm01 from trademark where tm01='" + strSystem + "' and tm02=" + CNULL(strTemp0)
                        strSQL2 = "select tm01 from trademark where tm01='" + strSystem + "' and tm02=" + CNULL(strTemp0) + " and tm03=" + CNULL(strTemp1)
                        StrSQL3 = "select tm01 from trademark where tm01='" + strSystem + "' and tm02=" + CNULL(strTemp0) + " and tm03=" + CNULL(strTemp1) + " and tm04=" + CNULL(strTemp2)
             Case 專利
                        strSQL1 = "select pa01 from patent where pa01='" + strSystem + "' and pa02=" + CNULL(strTemp0)
                        strSQL2 = "select pa01 from patent where pa01='" + strSystem + "' and pa02=" + CNULL(strTemp0) + " and pa03=" + CNULL(strTemp1)
                        StrSQL3 = "select pa01 from patent where pa01='" + strSystem + "' and pa02=" + CNULL(strTemp0) + " and pa03=" + CNULL(strTemp1) + " and pa04=" + CNULL(strTemp2)
             Case 法務
                        strSQL1 = "select lc01 from lawcase where lc01='" + strSystem + "' and lc02=" + CNULL(strTemp0)
                        strSQL2 = "select lc01 from lawcase where lc01='" + strSystem + "' and lc02=" + CNULL(strTemp0) + " and lc03=" + CNULL(strTemp1)
                        StrSQL3 = "select lc01 from lawcase where lc01='" + strSystem + "' and lc02=" + CNULL(strTemp0) + " and lc03=" + CNULL(strTemp1) + " and lc04=" + CNULL(strTemp2)
             Case 顧問
                        strSQL1 = "select hc01 from hirecase where hc01='" + strSystem + "' and hc02=" + CNULL(strTemp0)
                        strSQL2 = "select hc01 from hirecase where hc01='" + strSystem + "' and hc02=" + CNULL(strTemp0) + " and hc03=" + CNULL(strTemp1)
                        StrSQL3 = "select hc01 from hirecase where hc01='" + strSystem + "' and hc02=" + CNULL(strTemp0) + " and hc03=" + CNULL(strTemp1) + " and hc04=" + CNULL(strTemp2)
             Case Else
                        strSQL1 = "select sp01 from servicepractice where sp01='" + strSystem + "' and sp02=" + CNULL(strTemp0)
                        strSQL2 = "select sp01 from servicepractice where sp01='" + strSystem + "' and sp02=" + CNULL(strTemp0) + " and sp03=" + CNULL(strTemp1)
                        StrSQL3 = "select sp01 from servicepractice where sp01='" + strSystem + "' and sp02=" + CNULL(strTemp0) + " and sp03=" + CNULL(strTemp1) + " and sp04=" + CNULL(strTemp2)
End Select
rsRecordset.CursorLocation = adUseClient
rsRecordset.Open strSQL1, cnnConnection, adOpenDynamic, adLockBatchOptimistic
If rsRecordset.RecordCount > 0 Then
   If strTemp1 <> "" Then
      rsRecordset.Close
      rsRecordset.Open strSQL2, cnnConnection, adOpenDynamic, adLockBatchOptimistic
      If rsRecordset.RecordCount > 0 Then
         If strTemp2 <> "" Then
            rsRecordset.Close
            rsRecordset.Open StrSQL3, cnnConnection, adOpenDynamic, adLockBatchOptimistic
            If rsRecordset.RecordCount > 0 Then
               Cls001CheckCodeExist = 0
            Else
               Cls001CheckCodeExist = -1
            End If
            rsRecordset.Close
         Else
            Cls001CheckCodeExist = 0
         End If
      Else
         Cls001CheckCodeExist = 1
         rsRecordset.Close
      End If
   Else
      Cls001CheckCodeExist = 0
   End If
Else
   '911017 nick
   'CheckCodeExist = -1
   Cls001CheckCodeExist = 1
   rsRecordset.Close
End If
'-1為錯誤之本所案號，0為重複之本所案號(新增舊案)，1為正確之本所案號(新增新案)
Exit Function
ErrHand:
Cls001CheckCodeExist = -2
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function

'判斷馬德里案之本所案號是否正確
Private Function Cls001CheckTFCodeExist(ByVal strSystem As String, strTemp0 As String, strTemp1 As String, strTemp2 As String, strTemp3 As String) As Integer
Dim strSql As String, rsRecordset As New ADODB.Recordset

On Error GoTo ErrHand
If strTemp1 = "" Then
   Cls001CheckTFCodeExist = -1
ElseIf strTemp2 = "" Then
   strSql = "select tm01 from trademark where tm01='" + strSystem + "' and substr(tm02,1,5)=" + CNULL(strTemp0)
   rsRecordset.CursorLocation = adUseClient
   rsRecordset.Open strSql, cnnConnection
   If rsRecordset.RecordCount > 0 Then
      rsRecordset.Close
      strSql = "select tm01 from trademark where tm01='" + strSystem + "' and tm02=" + CNULL(strTemp0 + strTemp1)
      rsRecordset.CursorLocation = adUseClient
      rsRecordset.Open strSql, cnnConnection
      If rsRecordset.RecordCount > 0 Then
         '911017 nick
         'CheckTFCodeExist = -1
         Cls001CheckTFCodeExist = 0
      Else
         Cls001CheckTFCodeExist = 1
      End If
   Else
      rsRecordset.Close
      Cls001CheckTFCodeExist = -1
   End If
ElseIf strTemp3 = "" Then
   Cls001CheckTFCodeExist = -1
Else
   strSql = "select tm01 from trademark where tm01='" + strSystem + "' and tm02=" + CNULL(strTemp0 + strTemp1) + " and tm03=" + CNULL(strTemp2) + " and tm04=" + CNULL(strTemp3)
   rsRecordset.CursorLocation = adUseClient
   rsRecordset.Open strSql, cnnConnection
   If rsRecordset.RecordCount > 0 Then
      Cls001CheckTFCodeExist = 0
   Else
      Cls001CheckTFCodeExist = -1
   End If
   rsRecordset.Close
End If
'-1為錯誤之本所案號，0為重複之本所案號(新增舊案)，1為正確之本所案號(新增新案)
Exit Function
ErrHand:
Cls001CheckTFCodeExist = -2
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function

'更新案件標準價及底價
Public Function Cls001SetCaseProgressFee(ByRef pa01 As String, ByRef PA09 As String, ByRef CP10 As String, ByRef CP09 As String) As Boolean
Dim strSql As String

On Error GoTo ErrHand
strSql = "update caseprogress set cp33=(select cf13 from casefee where cf01=" + CNULL(pa01) + " and cf02=" + CNULL(PA09) + " and cf03=" + CNULL(CP10) + _
     "),cp34=(select cf14 from casefee where cf01=" + CNULL(pa01) + " and cf02=" + CNULL(PA09) + " and cf03=" + CNULL(CP10) + ") where cp09=" + CNULL(CP09)
cnnConnection.Execute strSql
Cls001SetCaseProgressFee = True
Exit Function
ErrHand:
ShowMsg MsgText(1513)
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function

'Modified by Lydia 2018/05/10 修改
''是否算案件數
'Public Sub Cls001SetPAIsCase(ByRef CP10 As String, ByRef cp26 As String)
'Select Case CP10
'             Case 讓與, 專利權讓與, 授權, 變更, 補換發證書, 領證及繳年費, 年費, 申請英文證明, _
'                              實體審查, 申請優先權證明, 維持費
'                        cp26 = "N"
'End Select
'Mark by Lydia 2025/06/19 改用PUB_GetCPMbyCP10
'Public Sub Pub_SetPAIsCase(ByVal iCP01 As String, ByVal iCP10 As String, ByRef iCP26 As String)
'      If iCP01 = "P" Or iCP01 = "CFP" Then
'            Select Case iCP10
'                Case 讓與, 專利權讓與, 授權, 變更, 補換發證書, 領證及繳年費, 年費, 申請英文證明, _
'                                  實體審查, 申請優先權證明, 維持費
'                          If iCP01 = "P" Or iCP01 = "CFP" Then
'                               iCP26 = "N"
'                          End If
'                Case 主張優先權, 補文件, 催審, 請求公告, 加註追加, 加註聯合 _
'                                , 合併, 終止授權, 繼承, 設定質權, 終止設定質權, 退費, 後金, 補收款
'                          If iCP01 = "P" Then
'                               iCP26 = "N"
'                          End If
'            End Select
'      Else
'            iCP26 = ""
'      End If
'End Sub
''end 2018/05/09
'end 2025/06/19

'取得商標卷宗性質
'Modified by Lydia 2022/08/11 拿掉tm34
'Public Sub Cls001SetTMFileProperty(ByRef CP10 As String, ByRef tm28 As String, ByRef tm34 As String)
Public Sub Cls001SetTMFileProperty(ByRef CP10 As String, ByRef tm28 As String)
   Select Case CP10
      'modify by sonia 2021/10/13 加案件性質627部分異議,625參加異議
      'Modified by Lydia 2021/11/23 +案件性質210陳述意見書
      Case 異議, 627, 625, 210
         tm28 = "2"
      'modify by sonia 2021/10/13 加案件性質629部分評定,609參加評定
      Case 評定, 629, 609
         tm28 = "3"
      'modify by sonia 2021/10/13 加案件性質623部分廢止
      Case 廢止, 623
         tm28 = "4"
      Case Else
         tm28 = "1"
   End Select
End Sub

'取得專利卷宗性質
'Modified by Lydia 2022/08/11 拿掉PA46
'Public Sub Cls001SetPAFileProperty(ByRef CP10 As String, ByRef pa23 As String, ByRef PA46 As String)
Public Sub Cls001SetPAFileProperty(ByRef CP10 As String, ByRef pa23 As String)
Select Case CP10
             Case 異議_專
                        pa23 = "2"
             'Modify by Morgan 2007/8/29 加807第三人申請技術報告
             Case 舉發, "807"
                        pa23 = "3"
             Case Else
                        pa23 = "1"
End Select
End Sub

'取得專利種類
Public Sub Cls001SetPatentProperty(ByRef CP10 As String, ByRef PA08 As String)
   Select Case CP10
      'Modify By Sindy 2012/5/31 +, PCT申請, 記錄請求_標準專利, 美國暫時申請, 植物新品種保護
      Case 發明申請, 追加申請, PCT申請, 記錄請求_標準專利, 美國暫時申請, 植物新品種保護
         PA08 = "1"
      'Modify By Sindy 2012/5/31 +, 短期專利申請
      Case 新型申請, 短期專利申請
         PA08 = "2"
      'Modified by Morgan 2012/12/19 +衍生設計
      Case 設計申請, 聯合申請, 衍生設計
         PA08 = "3"
   End Select
End Sub

'從下一程序檔取回機關文號、對造名稱
'Modify By Sindy 2025/1/24 strContrast 以總收文號再回抓 CP40,CP41,CP42 因下一程序相關人只有一個欄位,但進度檔有區分中英日
'                          + Optional ByRef strContrast_41 As String, Optional ByRef strContrast_42 As String
Public Function Cls001GetNextProgressData(ByVal np02 As String, ByVal np03 As String, ByVal np04 As String, _
       ByVal np05 As String, ByVal NP07 As String, ByRef strOrgan As String, ByRef strContrast As String, _
       Optional ByRef strContrast_41 As String, Optional ByRef strContrast_42 As String) As Boolean
Dim strSql As String
Dim rsRecordset As New ADODB.Recordset

On Error GoTo ErrHand

'Modify By Sindy 2025/1/24 增加抓 caseprogress
strSql = "select np13,np14,cp40,cp41,cp42 from nextprogress,caseprogress" & _
         " where np02=" + CNULL(np02) + " and np03=" + CNULL(np03) + _
         " and np04=" + CNULL(np04) + " and np05=" + CNULL(np05) + _
         " and np07=" + CNULL(NP07) + " and (np06<>'Y' or np06 is null)" + _
         " and np01=cp09(+)"
rsRecordset.CursorLocation = adUseClient
rsRecordset.Open strSql, cnnConnection, adOpenDynamic
If rsRecordset.RecordCount > 0 Then
   rsRecordset.MoveLast
   rsRecordset.MoveFirst
   If rsRecordset.RecordCount = 1 Then
      strOrgan = IIf(IsNull(rsRecordset.Fields(0)), "", rsRecordset.Fields(0))
      strContrast = IIf(IsNull(rsRecordset.Fields(1)), "", rsRecordset.Fields(1))
      'Add By Sindy 2025/1/24 有相關人資料時,改抓 CP40,CP41,CP42
      If strContrast <> "" Then
         strContrast = IIf(IsNull(rsRecordset.Fields("cp40")), "", rsRecordset.Fields("cp40"))
         strContrast_41 = IIf(IsNull(rsRecordset.Fields("cp41")), "", rsRecordset.Fields("cp41"))
         strContrast_42 = IIf(IsNull(rsRecordset.Fields("cp42")), "", rsRecordset.Fields("cp42"))
      End If
      '2025/1/24 END
      Cls001GetNextProgressData = True
   End If
End If
rsRecordset.Close
Exit Function
ErrHand:
ShowMsg MsgText(1514)
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function

'從下一程序檔取回本所期限、法定期限
Public Function Cls001GetNextProgressDate(ByVal np02 As String, ByVal np03 As String, ByVal np04 As String, _
       ByVal np05 As String, ByVal NP07 As String, ByRef strDate1 As String, ByRef StrDate2 As String) As Boolean
Dim strSql As String, rsRecordset As New ADODB.Recordset

On Error GoTo ErrHand
strSql = "select np08,np09 from nextprogress where np02=" + CNULL(np02) + " and np03=" + _
          CNULL(np03) + " and np04=" + CNULL(np04) + " and np05=" + CNULL(np05) + _
          " and np07=" + CNULL(NP07) + " and (np06<>'Y' or np06 is null)"
rsRecordset.CursorLocation = adUseClient
rsRecordset.Open strSql, cnnConnection, adOpenStatic
If rsRecordset.RecordCount > 0 Then
   rsRecordset.MoveLast
   rsRecordset.MoveFirst
   If rsRecordset.RecordCount = 1 Then
      strDate1 = IIf(IsNull(rsRecordset.Fields(0)), "", rsRecordset.Fields(0))
      StrDate2 = IIf(IsNull(rsRecordset.Fields(1)), "", rsRecordset.Fields(1))
   End If
End If
Cls001GetNextProgressDate = True
rsRecordset.Close
Exit Function
ErrHand:
ShowMsg MsgText(1515)
   'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function

' 將本所案號拆成四個欄位
Private Sub Cls001SplitOurReference(ByVal strKey As String, ByRef strKEY01 As String, ByRef strKEY02 As String, ByRef strKEY03 As String, ByRef strKEY04 As String)
   Dim nPos As Integer
   Dim nBegin As Integer
   strKEY01 = Empty
   strKEY02 = Empty
   strKEY03 = Empty
   strKEY04 = Empty
   nBegin = -1
   For nPos = 1 To Len(strKey)
      If IsNumeric(Mid(strKey, nPos, 1)) Then
         nBegin = nPos
         Exit For
      End If
   Next nPos
   
   If nBegin > 0 Then
      strKEY01 = Left(strKey, nBegin - 1)
      strKey = Mid(strKey, nBegin, Len(strKey) - nBegin + 1)
      strKEY02 = Left(strKey, 6)
      If Len(strKey) > 6 Then
         strKey = Mid(strKey, 7, Len(strKey) - 6)
         strKEY03 = Left(strKey, 1)
         If (Len(strKey) > 1) Then
            strKey = Mid(strKey, 2, Len(strKey) - 1)
            strKEY04 = Left(strKey, 2)
         End If
      End If
   End If
End Sub
'取得解除期限原因
Public Function Cls0702GetReasonOfRelief(ByRef StrRorNum As String, ByRef StrRorName As String) As Boolean
'edit by nickc 2007/02/06 不用 dll 了
'Dim obj01 As Object
Dim Rs As ADODB.Recordset
    strSql = "select ROR02 from ReasonOfRelief where Ror01=" + CNULL(StrRorNum)
    'edit by nickc 2007/02/06 不用 dll 了
    'Set obj01 = CreateObject("prjtaiedll.clspublicdata")
    'Set rs = obj01.ReadRst(strSQL)
    Set Rs = ClsPDReadRst(strSql)
    If Not Rs.EOF Then
        StrRorName = IIf(IsNull(Rs(0)), "", Rs(0))
        Cls0702GetReasonOfRelief = True
        Rs.Close
        'edit by nickc 2007/02/06 不用 dll 了
        'Set obj01 = Nothing
    Else
        MsgBox "解除期限原因代碼錯誤.", vbCritical
        Cls0702GetReasonOfRelief = False
        Rs.Close
        'edit by nickc 2007/02/06 不用 dll 了
        'Set obj01 = Nothing
        Exit Function
    End If
End Function

'讀取分案資料,intCaseKind系統分類
Public Function ClsPPGetSQL(ByRef intCaseKind As Integer, ByRef intWhere As Integer, ByRef strReceiveCode As String) As String
 Dim strDateLine As String, bolChk As Boolean
   If intWhere <> 國外_CF Then
      bolChk = True
   Else
      bolChk = False
   End If
   If intWhere <> 國外_CF Then strDateLine = "-1911"
   Select Case intCaseKind
      Case 專利
         'Modified by Lydia 2018/06/05 修改顯示案件性質
         'ClsPPGetSQL = "select decode(st06,'1','北所','2','中所','3','南所','4','高所','5','其他','') a01,st02 a02," & ChgPatent("", 1) & _
            " a03,pa05 a04,pa06 a05,pa07 a06,decode(pa09," + CNULL(大陸國家代號) + ",cpm04,cpm03) a07," & _
            SQLDate("CP05", bolChk) & " a08,cp16 a09,cp17 a10,cp18 a11," & SQLDate("CP06", bolChk) & " a12," & _
            SQLDate("CP07", bolChk) & " a13 from caseprogress,patent,casepropertymap,staff where cp09=" + CNULL(strReceiveCode) & _
            " and cp01=pa01 and cp02=pa02 and cp03=pa03 and cp04=pa04 and cp01=cpm01 and cp10=cpm02 and cp13=st01(+)"
         ClsPPGetSQL = "select decode(st06,'1','北所','2','中所','3','南所','4','高所','5','其他','') a01,st02 a02," & ChgPatent("", 1) & _
            " a03,pa05 a04,pa06 a05,pa07 a06,decode(pa09,'000',CPM03,CPM04) a07," & _
            SQLDate("CP05", bolChk) & " a08,cp16 a09,cp17 a10,cp18 a11," & SQLDate("CP06", bolChk) & " a12," & _
            SQLDate("CP07", bolChk) & " a13 from caseprogress,patent,casepropertymap,staff where cp09=" + CNULL(strReceiveCode) & _
            " and cp01=pa01 and cp02=pa02 and cp03=pa03 and cp04=pa04 and cp01=cpm01 and cp10=cpm02 and cp13=st01(+)"
      Case 商標
         'Modified by Lydia 2018/06/05 修改顯示案件性質
         'ClsPPGetSQL = "select decode(st06,'1','北所','2','中所','3','南所','4','高所','5','其他','') a01,st02 a02," & _
            "tm01||'- '||decode(tm01," + CNULL(馬德里案) + ",substr(tm02,1,5),tm02)||decode(tm01," + CNULL(馬德里案) + ",decode(substr(tm02,6,1),'0','','- '||substr(tm02,6,1)),'')||decode(tm03,'0','','- '||tm03)||decode(tm04,'00','','- '||tm04) a03," & _
            "tm05 a04,tm06 a05,tm07 a06,decode(tm10," + CNULL(大陸國家代號) + ",cpm04,cpm03) a07," & _
            SQLDate("CP05", bolChk) & " a08,cp16 a09,cp17 a10,cp18 a11," & SQLDate("CP06", bolChk) & " a12," & SQLDate("CP07", bolChk) & _
            " a13 from caseprogress,trademark,casepropertymap,staff where cp09=" + CNULL(strReceiveCode) & " and cp01=tm01 and " & _
            "cp02=tm02 and cp03=tm03 and cp04=tm04 and cp01=cpm01 and cp10=cpm02 and cp13=st01(+)"
         ClsPPGetSQL = "select decode(st06,'1','北所','2','中所','3','南所','4','高所','5','其他','') a01,st02 a02," & _
            "tm01||'- '||decode(tm01," + CNULL(馬德里案) + ",substr(tm02,1,5),tm02)||decode(tm01," + CNULL(馬德里案) + ",decode(substr(tm02,6,1),'0','','- '||substr(tm02,6,1)),'')||decode(tm03,'0','','- '||tm03)||decode(tm04,'00','','- '||tm04) a03," & _
            "tm05 a04,tm06 a05,tm07 a06,decode(tm10,'000',CPM03,CPM04) a07," & _
            SQLDate("CP05", bolChk) & " a08,cp16 a09,cp17 a10,cp18 a11," & SQLDate("CP06", bolChk) & " a12," & SQLDate("CP07", bolChk) & _
            " a13 from caseprogress,trademark,casepropertymap,staff where cp09=" + CNULL(strReceiveCode) & " and cp01=tm01 and " & _
            "cp02=tm02 and cp03=tm03 and cp04=tm04 and cp01=cpm01 and cp10=cpm02 and cp13=st01(+)"
      Case Else
         'Modified by Lydia 2018/06/05 修改顯示案件性質
         'ClsPPGetSQL = "select decode(st06,'1','北所','2','中所','3','南所','4','高所','5','其他','') a01,st02 a02," & ChgService("", 1) & _
            " a03,sp05 a04,sp06 a05,sp07 a06,decode(sp09," + CNULL(大陸國家代號) + ",cpm04,cpm03) a07," & _
            SQLDate("CP05", bolChk) & " a08,cp16 a09,cp17 a10,cp18 a11," & SQLDate("CP06", bolChk) & " a12," & _
            SQLDate("CP07", bolChk) & " a13 from caseprogress,servicepractice,casepropertymap,staff where cp09=" + CNULL(strReceiveCode) & _
            " and cp01=sp01 and cp02=sp02 and cp03=sp03 and cp04=sp04 and cp01=cpm01 and cp10=cpm02 and cp13=st01(+)"
         ClsPPGetSQL = "select decode(st06,'1','北所','2','中所','3','南所','4','高所','5','其他','') a01,st02 a02," & ChgService("", 1) & _
            " a03,sp05 a04,sp06 a05,sp07 a06,decode(sp09,'000',CPM03,CPM04) a07," & _
            SQLDate("CP05", bolChk) & " a08,cp16 a09,cp17 a10,cp18 a11," & SQLDate("CP06", bolChk) & " a12," & _
            SQLDate("CP07", bolChk) & " a13 from caseprogress,servicepractice,casepropertymap,staff where cp09=" + CNULL(strReceiveCode) & _
            " and cp01=sp01 and cp02=sp02 and cp03=sp03 and cp04=sp04 and cp01=cpm01 and cp10=cpm02 and cp13=st01(+)"
   End Select
End Function

'取得所屬的系統類別
Public Function Cls0703GetSystemTypeNo(strGroup As String, ByRef strName As String) As Boolean
'edit by nickc 2007/02/06 不用 dll 了
'Dim obj01 As Object
Dim IntTemp1 As Integer
Dim strTemp2 As String
Dim IntTemp3 As Integer
    'edit by nickc 2007/02/06 不用 dll 了
    'Set obj01 = CreateObject("prjtaiedll.class0702")
    'If Not obj01.GetUserUseSysKind(strGroup, StrName) Then
        'Set obj01 = Nothing
    If Not Cls0702GetUserUseSysKind(strGroup, strName) Then
        Cls0703GetSystemTypeNo = False
        Exit Function
    End If
    'edit by nickc 2007/02/06 不用 dll 了
    'Set obj01 = Nothing
    'Set obj01 = CreateObject("prjtaiedll.clspublicdata")
    'If Not obj01.GetSystemKind(StrName, IntTemp1, strTemp2, IntTemp3) Then
    '    Set obj01 = Nothing
    If Not ClsPDGetSystemKind(strName, IntTemp1, strTemp2, IntTemp3) Then
        Cls0703GetSystemTypeNo = False
        Exit Function
    End If
    strName = str(IntTemp1)
    Cls0703GetSystemTypeNo = True
End Function

''檢查是否為系統代號'
Public Function Cls0703ChkSysKind0708(strName As String) As Boolean
Dim Rs As ADODB.Recordset
'edit by nickc 2007/02/06 不用 dll 了
'Dim obj01 As Object
'    Set obj01 = CreateObject("prjtaiedll.clspublicdata")
    strSql = "select * from casefee"
    'edit by nickc 2007/02/06 不用 dll 了
    'Set rs = obj01.ReadRst(strSQL)
    Set Rs = ClsPDReadRst(strSql)
    If Rs.EOF Then
        Rs.Close
        Cls0703ChkSysKind0708 = False
        
        Exit Function
    Else
        
    End If
End Function

Public Function Cls0703Create0201TempTable() As Boolean
'edit by nickc 2007/02/06 不用 dll 了
'Dim obj01 As Object
'Add By Cheng 2002/11/14
Dim BolTransOk As Boolean
BolTransOk = True

    strSql = "create table temp0502("
    strSql = strSql + "fdna03 varchar2(20),"
    strSql = strSql + "agent varchar2(8),"
    strSql = strSql + "fdp00 number(8),"
    strSql = strSql + "fdp01 number(8),"
    strSql = strSql + "fdp02 number(8),"
    strSql = strSql + "fdp03 number(8),"
    strSql = strSql + "fdt02 number(8),"
    strSql = strSql + "fdcp31 number(8),"
    strSql = strSql + "fdfac03 number(1),"
    strSql = strSql + "fdfac04 varchar2(100),"
    strSql = strSql + "Primary Key(agent)"
    strSql = strSql + ")"
   'Debug.Print strSQL
On Error GoTo ErrHand
    cnnConnection.BeginTrans
    cnnConnection.Execute strSql
    'Modify By Cheng 2002/11/14
    If BolTransOk Then
        cnnConnection.CommitTrans
    End If
    Cls0703Create0201TempTable = True
    Exit Function
ErrHand:
    'Add By Cheng 2002/11/14
    If Err.Number = -2147168237 Then
       BolTransOk = False
       Resume Next
    End If

    cnnConnection.RollbackTrans
    Cls0703Create0201TempTable = False
       'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function

Public Function Cls0703DropTemp0502Table() As Boolean
'Add By Cheng 2002/11/14
Dim BolTransOk As Boolean
BolTransOk = True
    
    strSql = "drop table temp0502"
On Error GoTo ErrHand
    cnnConnection.BeginTrans
    cnnConnection.Execute strSql
    'Modify By Cheng 2002/11/14
    If BolTransOk Then
        cnnConnection.CommitTrans
    End If
    Cls0703DropTemp0502Table = True
    Exit Function
ErrHand:
    'Add By Cheng 2002/11/14
    If Err.Number = -2147168237 Then
       BolTransOk = False
       Resume Next
    End If

    cnnConnection.RollbackTrans
    Cls0703DropTemp0502Table = False
       'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function

'填入代理人編號,代理人國籍,(代理人新案查詢)  ReturnValue=1(表格建立完成沒有資料),2(表格建立完成有資料)3.(表格建立失敗)
Public Function Cls0703InsertDataToTemp0502(StrSqlStmt As String, ByRef fa() As String) As String
Dim Rs As ADODB.Recordset
'edit by nickc 2007/02/06 不用 dll 了
'Dim obj01 As Object
Dim i As Integer
'Add By Cheng 2002/11/14
Dim BolTransOk As Boolean
BolTransOk = True

    strSql = "insert into temp0502(agent,fdna03) select fa01,na03 from fagent,nation where fa10=na01(+)" + StrSqlStmt
On Error GoTo ErrHand
    'edit by nickc 2007/02/06 不用 dll 了
    'Set obj01 = CreateObject("prjTaieDll.clspublicdata")
    cnnConnection.BeginTrans
    'Debug.Print strSQL
    cnnConnection.Execute strSql
    'Modify By Cheng 2002/11/14
    If BolTransOk Then
        cnnConnection.CommitTrans
    End If
    strSql = "select count(agent) from temp0502"
    'edit by nickc 2007/02/06 不用 dll 了
    'Set rs = obj01.ReadRst(strSQL)
    Set Rs = ClsPDReadRst(strSql)
    ReDim fa(Rs(0) - 1)
    Rs.Close
    strSql = "select agent from temp0502 "
    'edit by nickc 2007/02/06 不用 dll 了
    'Set rs = obj01.ReadRst(strSQL)
    Set Rs = ClsPDReadRst(strSql)
    If Rs.EOF Then
        Rs.Close
        Cls0703InsertDataToTemp0502 = 1
        'edit by nickc 2007/02/06 不用 dll 了
        'Set obj01 = Nothing
        Exit Function
    Else
        i = 0
        While Not Rs.EOF
            fa(i) = IIf(IsNull(Rs(0)), "", Rs(0))
            i = i + 1
            Rs.MoveNext
        Wend
        Rs.Close
    End If
    Cls0703InsertDataToTemp0502 = 2
    'edit by nickc 2007/02/06 不用 dll 了
    'Set obj01 = Nothing
    Exit Function
ErrHand:
    'Add By Cheng 2002/11/14
    If Err.Number = -2147168237 Then
       BolTransOk = False
       Resume Next
    End If

    cnnConnection.RollbackTrans
    Cls0703InsertDataToTemp0502 = 3
    'edit by nickc 2007/02/06 不用 dll 了
    'Set obj01 = Nothing
       'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function

'填入給案備註,人工排行
Public Function Cls0703InsertDataToTemp0502_2(ByRef fa() As String, strSysKind As String) As Boolean
Dim i As Integer
'edit by nickc 2007/02/06 不用 dll 了
'Dim obj01 As Object
Dim Rs As ADODB.Recordset
Dim Ary1() As String
'Add By Cheng 2002/11/14
Dim BolTransOk As Boolean
BolTransOk = True

On Error GoTo ErrHand
    cnnConnection.BeginTrans
    ReDim Ary1(UBound(fa()), 1)
    strSql = "select agent, fac04,fac03 from facase,temp0502 where fac01=" + CNULL(strSysKind) + " and agent=fac02"
    'edit by nickc 2007/02/06 不用 dll 了
    'Set obj01 = CreateObject("prjtaiedll.clspublicdata")
    'Set rs = obj01.ReadRst(strSQL)
    Set Rs = ClsPDReadRst(strSql)
    If Rs.EOF Then
        Rs.Close
        Cls0703InsertDataToTemp0502_2 = True
        Exit Function
    End If
    i = 0
    'While Not Rs.EOF
    '    Ary1(i, 0) = IIf(IsNull(Rs(0)), "", Rs(0))
    '    Ary1(i, 1) = IIf(IsNull(Rs(1)), "", Rs(1))
    '    i = i + 1
    '    Rs.MoveNext
    'Wend
    'Rs.Close
    'Set obj01 = Nothing

    While Not Rs.EOF
        strSql = "update temp0502 set fdfac04=" + CNULL(IIf(IsNull(Rs(1)), "", Rs(1))) + ",fdfac03=" + CNULL(IIf(IsNull(Rs(2)), "", Rs(2))) + " where agent=" + CNULL(IIf(IsNull(Rs(0)), "", Rs(0)))
        'Debug.Print strSQL
        cnnConnection.Execute strSql
        Rs.MoveNext
    Wend
    'Modify By Cheng 2002/11/14
    If BolTransOk Then
        cnnConnection.CommitTrans
    End If
    Cls0703InsertDataToTemp0502_2 = True
    Exit Function
ErrHand:
    'Add By Cheng 2002/11/14
    If Err.Number = -2147168237 Then
       BolTransOk = False
       Resume Next
    End If
    
       'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
    cnnConnection.RollbackTrans
    Cls0703InsertDataToTemp0502_2 = False
End Function

'填入發明申請案件數
Public Function Cls0703InsertDataTo0502_3a(ByRef fa() As String, StrSqlStmt As String) As Boolean
'edit by nickc 2007/02/06 不用 dll 了
'Dim obj01 As Object
Dim i As Integer
Dim Rs As ADODB.Recordset
On Error GoTo ErrHand
'Add By Cheng 2002/11/14
Dim BolTransOk As Boolean
BolTransOk = True
    'edit by nickc 2007/02/06 不用 dll 了
    'Set obj01 = CreateObject("prjtaiedll.clspublicdata")
    strSql = "select  count(c2.cp09) from caseprogress c1,caseprogress c2,temp0502,patent where agent=c1.cp44  " + StrSqlStmt + " and  c2.cp01=pa01 and c2.cp02=pa02 and c2.cp03=pa03 and c2.cp04=pa04"
    'Debug.Print strSQL
    'edit by nickc 2007/02/06 不用 dll 了
    'Set rs = obj01.ReadRst(strSQL)
    Set Rs = ClsPDReadRst(strSql)
    If Rs.EOF Then
        Rs.Close
        Cls0703InsertDataTo0502_3a = True
        Exit Function
    End If
    i = 0
    cnnConnection.BeginTrans
    While Not Rs.EOF
        strSql = "update TEMP0502 set fdp00=" + CNULL(IIf(IsNull(Rs(0)), "", Rs(0))) + "where agent=" + CNULL(fa(i))
        'Debug.Print strSQL
        cnnConnection.Execute strSql
        Rs.MoveNext
        i = i + 1
    Wend
    Rs.Close
    'edit by nickc 2007/02/06 不用 dll 了
    'Set obj01 = Nothing
    'Modify By Cheng 2002/11/14
    If BolTransOk Then
        cnnConnection.CommitTrans
    End If
    Cls0703InsertDataTo0502_3a = True
    Exit Function
ErrHand:
    'Add By Cheng 2002/11/14
    If Err.Number = -2147168237 Then
       BolTransOk = False
       Resume Next
    End If

       'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
    cnnConnection.RollbackTrans
    Cls0703InsertDataTo0502_3a = False
End Function

'填入設計申請案件數
Public Function Cls0703InsertDataTo0502_4a(ByRef fa() As String, StrSqlStmt As String) As Boolean
'edit by nickc 2007/02/06 不用 dll 了
'Dim obj01 As Object
Dim i As Integer
Dim Rs As ADODB.Recordset
'Add By Cheng 2002/11/14
Dim BolTransOk As Boolean
BolTransOk = True

On Error GoTo ErrHand
    'edit by nickc 2007/02/06 不用 dll 了
    'Set obj01 = CreateObject("prjtaiedll.clspublicdata")
    strSql = "select  count(c2.cp09) from caseprogress c1,caseprogress c2,temp0502,patent where agent=c1.cp44  " + StrSqlStmt + " and  c2.cp01=pa01 and c2.cp02=pa02 and c2.cp03=pa03 and c2.cp04=pa04"
    'edit by nickc 2007/02/06 不用 dll 了
    'Set rs = obj01.ReadRst(strSQL)
    Set Rs = ClsPDReadRst(strSql)
    If Rs.EOF Then
        Rs.Close
        Cls0703InsertDataTo0502_4a = True
        Exit Function
    End If
    i = 0
    cnnConnection.BeginTrans
    While Not Rs.EOF
        strSql = "update TEMP0502 set fdp02=" + CNULL(IIf(IsNull(Rs(0)), "", Rs(0))) + " where agent=" + CNULL(fa(i))
        'Debug.Print strSQL
        cnnConnection.Execute strSql
        Rs.MoveNext
        i = i + 1
    Wend
    Rs.Close
    'edit by nickc 2007/02/06 不用 dll 了
    'Set obj01 = Nothing
    'Modify By Cheng 2002/11/14
    If BolTransOk Then
        cnnConnection.CommitTrans
    End If
    Cls0703InsertDataTo0502_4a = True
    Exit Function
ErrHand:
    'Add By Cheng 2002/11/14
    If Err.Number = -2147168237 Then
       BolTransOk = False
       Resume Next
    End If

       'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
    cnnConnection.CommitTrans
    Cls0703InsertDataTo0502_4a = False
End Function

'填入新型申請案件數
Public Function Cls0703InsertDataTo0502_5a(ByRef fa() As String, StrSqlStmt As String) As Boolean
'edit by nickc 2007/02/06 不用 dll 了
'Dim obj01 As Object
Dim i As Integer
Dim Rs As ADODB.Recordset
'Add By Cheng 2002/11/14
Dim BolTransOk As Boolean
BolTransOk = True

On Error GoTo ErrHand
    'edit by nickc 2007/02/06 不用 dll 了
    'Set obj01 = CreateObject("prjtaiedll.clspublicdata")
    strSql = "select  count(c2.cp09) from caseprogress c1,caseprogress c2,temp0502,patent where agent=c1.cp44  " + StrSqlStmt + " and  c2.cp01=pa01 and c2.cp02=pa02 and c2.cp03=pa03 and c2.cp04=pa04"
    'edit by nickc 2007/02/06 不用 dll 了
    'Set rs = obj01.ReadRst(strSQL)
    Set Rs = ClsPDReadRst(strSql)
    If Rs.EOF Then
        Rs.Close
        Cls0703InsertDataTo0502_5a = True
        Exit Function
    End If
    i = 0
    cnnConnection.BeginTrans
    While Not Rs.EOF
        strSql = "update TEMP0502 set fdp01=" + CNULL(IIf(IsNull(Rs(0)), "", Rs(0))) + "where agent=" + CNULL(fa(i))
        'Debug.Print strSQL
        cnnConnection.Execute strSql
        Rs.MoveNext
        i = i + 1
    Wend
    Rs.Close
    'edit by nickc 2007/02/06 不用 dll 了
    'Set obj01 = Nothing
    'Modify By Cheng 2002/11/14
    If BolTransOk Then
        cnnConnection.CommitTrans
    End If
    Cls0703InsertDataTo0502_5a = True
    Exit Function
ErrHand:
    'Add By Cheng 2002/11/14
    If Err.Number = -2147168237 Then
       BolTransOk = False
       Resume Next
    End If

       'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
    cnnConnection.CommitTrans
    Cls0703InsertDataTo0502_5a = False
End Function

'填入聯合申請案件數
Public Function Cls0703InsertDataTo0502_6a(ByRef fa() As String, StrSqlStmt As String) As Boolean
'edit by nickc 2007/02/06 不用 dll 了
'Dim obj01 As Object
Dim i As Integer
Dim Rs As ADODB.Recordset
On Error GoTo ErrHand
'Add By Cheng 2002/11/14
Dim BolTransOk As Boolean
BolTransOk = True

    'edit by nickc 2007/02/06 不用 dll 了
    'Set obj01 = CreateObject("prjtaiedll.clspublicdata")
    strSql = "select  count(c2.cp09) from caseprogress c1,caseprogress c2,temp0502,patent where agent=c1.cp44  " + StrSqlStmt + " and  c2.cp01=pa01 and c2.cp02=pa02 and c2.cp03=pa03 and c2.cp04=pa04"
    'edit by nickc 2007/02/06 不用 dll 了
    'Set rs = obj01.ReadRst(strSQL)
    Set Rs = ClsPDReadRst(strSql)
    If Rs.EOF Then
        Rs.Close
        Cls0703InsertDataTo0502_6a = True
        Exit Function
    End If
    i = 0
    cnnConnection.BeginTrans
    While Not Rs.EOF
        strSql = "update TEMP0502 set fdp03=" + CNULL(IIf(IsNull(Rs(0)), "", Rs(0))) + "where agent=" + CNULL(fa(i))
        'Debug.Print strSQL
        cnnConnection.Execute strSql
        Rs.MoveNext
        i = i + 1
    Wend
    Rs.Close
    'edit by nickc 2007/02/06 不用 dll 了
    'Set obj01 = Nothing
    'Modify By Cheng 2002/11/14
    If BolTransOk Then
        cnnConnection.CommitTrans
    End If
    Cls0703InsertDataTo0502_6a = True
    Exit Function
ErrHand:
    'Add By Cheng 2002/11/14
    If Err.Number = -2147168237 Then
       BolTransOk = False
       Resume Next
    End If

       'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
    cnnConnection.CommitTrans
    Cls0703InsertDataTo0502_6a = False
End Function
'填入商標案件數
Public Function Cls0703InsertDataTo0502_7a(ByRef fa() As String, StrSqlStmt As String) As Boolean
'edit by nickc 2007/02/06 不用 dll 了
'Dim obj01 As Object
Dim i As Integer
Dim Rs As ADODB.Recordset
On Error GoTo ErrHand
'Add By Cheng 2002/11/14
Dim BolTransOk As Boolean
BolTransOk = True
    'edit by nickc 2007/02/06 不用 dll 了
    'Set obj01 = CreateObject("prjtaiedll.clspublicdata")
    strSql = "select  count(c2.cp09) from caseprogress c1,caseprogress c2,temp0502,patent where agent=c1.cp44  " + StrSqlStmt + " and  c2.cp01=pa01 and c2.cp02=pa02 and c2.cp03=pa03 and c2.cp04=pa04"
    'edit by nickc 2007/02/06 不用 dll 了
    'Set rs = obj01.ReadRst(strSQL)
    Set Rs = ClsPDReadRst(strSql)
    If Rs.EOF Then
        Rs.Close
        Cls0703InsertDataTo0502_7a = True
        Exit Function
    End If
    i = 0
    cnnConnection.BeginTrans
    While Not Rs.EOF
        strSql = "update TEMP0502 set fdt02=" + CNULL(IIf(IsNull(Rs(0)), "", Rs(0))) + "where agent=" + CNULL(fa(i))
        'Debug.Print strSQL
        cnnConnection.Execute strSql
        Rs.MoveNext
        i = i + 1
    Wend
    Rs.Close
    'edit by nickc 2007/02/06 不用 dll 了
    'Set obj01 = Nothing
    'Modify By Cheng 2002/11/14
    If BolTransOk Then
        cnnConnection.CommitTrans
    End If
    Cls0703InsertDataTo0502_7a = True
    Exit Function
ErrHand:
    'Add By Cheng 2002/11/14
    If Err.Number = -2147168237 Then
       BolTransOk = False
       Resume Next
    End If

       'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
    cnnConnection.CommitTrans
    Cls0703InsertDataTo0502_7a = False
End Function

'填入法務案件數
Public Function Cls0703InsertDataTo0502_8a(ByRef fa() As String, StrSqlStmt As String) As Boolean
'edit by nickc 2007/02/06 不用 dll 了
'Dim obj01 As Object
Dim i As Integer
Dim Rs As ADODB.Recordset
On Error GoTo ErrHand
'Add By Cheng 2002/11/14
Dim BolTransOk As Boolean
BolTransOk = True
    'edit by nickc 2007/02/06 不用 dll 了
    'Set obj01 = CreateObject("prjtaiedll.clspublicdata")
    strSql = "select  count(c2.cp09) from caseprogress c1,caseprogress c2,temp0502,patent where agent=c1.cp44  " + StrSqlStmt + " and  c2.cp01=pa01 and c2.cp02=pa02 and c2.cp03=pa03 and c2.cp04=pa04"
    'edit by nickc 2007/02/06 不用 dll 了
    'Set rs = obj01.ReadRst(strSQL)
    Set Rs = ClsPDReadRst(strSql)
    If Rs.EOF Then
        Rs.Close
        Cls0703InsertDataTo0502_8a = True
        Exit Function
    End If
    i = 0
    cnnConnection.BeginTrans
    While Not Rs.EOF
        strSql = "update TEMP0502 set fdcp31=" + CNULL(IIf(IsNull(Rs(0)), "", Rs(0))) + "where agent=" + CNULL(fa(i))
        'Debug.Print strSQL
        cnnConnection.Execute strSql
        Rs.MoveNext
        i = i + 1
    Wend
    Rs.Close
    'edit by nickc 2007/02/06 不用 dll 了
    'Set obj01 = Nothing
    'Modify By Cheng 2002/11/14
    If BolTransOk Then
        cnnConnection.CommitTrans
    End If
    Cls0703InsertDataTo0502_8a = True
    Exit Function
ErrHand:
    'Add By Cheng 2002/11/14
    If Err.Number = -2147168237 Then
       BolTransOk = False
       Resume Next
    End If

       'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
    cnnConnection.CommitTrans
    Cls0703InsertDataTo0502_8a = False
End Function
'Move by Lydia 2015/04/10 移到frm050711
''新增資料
'Public Function Cls0703AddData0711(AFID() As String) As Boolean
'Dim i As Integer
'Dim j As Integer
''Add By Cheng 2002/11/14
'Dim BolTransOk As Boolean
'BolTransOk = True
'
'    strSql = "insert into applicantforeignid(afid01,afid02,afid03) values('"
'    strSql = strSql + AFID(0) + "','" + AFID(1) + "','" + AFID(2) + "')"
'   'Debug.Print strSQL
'On Error GoTo ErrHand
'    cnnConnection.BeginTrans
'    cnnConnection.Execute strSql
'    'Modify By Cheng 2002/11/14
'    If BolTransOk Then
'        cnnConnection.CommitTrans
'    End If
'    Cls0703AddData0711 = True
'    Exit Function
'ErrHand:
'    'Add By Cheng 2002/11/14
'    If Err.NUMBER = -2147168237 Then
'       BolTransOk = False
'       Resume Next
'    End If
'
'    cnnConnection.RollbackTrans
'    Cls0703AddData0711 = False
'       'edit by nickc 2007/02/02
'   'ErrorLog
'   MsgBox Err.Description
'End Function
'
'Public Function Cls0703EraseData0711(AFID() As String) As Boolean
''Add By Cheng 2002/11/14
'Dim BolTransOk As Boolean
'BolTransOk = True
'
'    strSql = "delete from applicantforeignid where afid01='" + AFID(0) + "' and afid02='" + AFID(1) + "'"
'   'Debug.Print strSQL
'On Error GoTo ErrHand
'    cnnConnection.BeginTrans
'    cnnConnection.Execute strSql
'    'Modify By Cheng 2002/11/14
'    If BolTransOk Then
'        cnnConnection.CommitTrans
'    End If
'    Cls0703EraseData0711 = True
'    Exit Function
'ErrHand:
'    'Add By Cheng 2002/11/14
'    If Err.NUMBER = -2147168237 Then
'       BolTransOk = False
'       Resume Next
'    End If
'
'    cnnConnection.RollbackTrans
'    Cls0703EraseData0711 = False
'       'edit by nickc 2007/02/02
'   'ErrorLog
'   MsgBox Err.Description
'End Function
'
'Public Function Cls0703ModifyData0711(AFID() As String) As Integer
'Dim i As Integer
'Dim j As Integer
''Add By Cheng 2002/11/14
'Dim BolTransOk As Boolean
'BolTransOk = True
'
'    strSql = "update applicantforeignid set afid03=" + CNULL(AFID(2))
'    strSql = strSql + " where afid01=" + CNULL(AFID(0)) + " and afid02=" + CNULL(AFID(1))
'   'Debug.Print strSQL
'On Error GoTo ErrHand
'    cnnConnection.BeginTrans
'    cnnConnection.Execute strSql
'    'Modify By Cheng 202/11/14
'    If BolTransOk Then
'        cnnConnection.CommitTrans
'    End If
'    Cls0703ModifyData0711 = True
'    Exit Function
'ErrHand:
'    'Add By Cheng 2002/11/14
'    If Err.NUMBER = -2147168237 Then
'       BolTransOk = False
'       Resume Next
'    End If
'
'    cnnConnection.RollbackTrans
'    Cls0703ModifyData0711 = False
'       'edit by nickc 2007/02/02
'   'ErrorLog
'   MsgBox Err.Description
'End Function

Public Function Cls0703EraseData0702(StrSqlStmt As String, StrSqlStmt1 As String) As Boolean
'Add By Cheng 2002/11/14
Dim BolTransOk As Boolean
BolTransOk = True

On Error GoTo ErrHand
    cnnConnection.BeginTrans
    cnnConnection.Execute strSql
    'Modify By Cheng 2002/11/14
    If BolTransOk Then
        cnnConnection.CommitTrans
    End If
    Cls0703EraseData0702 = True
    Exit Function
ErrHand:
    'Add By Cheng 2002/11/14
    If Err.Number = -2147168237 Then
       BolTransOk = False
       Resume Next
    End If

    cnnConnection.RollbackTrans
    Cls0703EraseData0702 = False
       'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
End Function

'取得系統類別,案件性質條件
Public Function Cls0703GetDataTo0502_8(ByRef StrSqlStmt As String, ByRef SYS() As String) As Boolean
Dim AryTemp As Variant
Dim Ary1() As String
Dim i As Integer
'edit by nickc 2007/02/06 不用 dll 了
'Dim obj01 As Object
Dim Rs As ADODB.Recordset
On Error GoTo ErrHand
    'edit by nickc 2007/02/06 不用 dll 了
    'Set obj01 = CreateObject("prjtaiedll.clspublicdata")
    
    If Mid$(StrSqlStmt, Len(StrSqlStmt), 1) = "," Then
       StrSqlStmt = Mid$(StrSqlStmt, 1, Len(StrSqlStmt) - 1)
    End If
    AryTemp = Split(Trim$(StrSqlStmt), ",")
    
    strSql = "select count(cpm01) from casepropertymap where( cpm03 like '" + 選擇專利案件性質1 + "%'  or  cpm03 like '" + 選擇專利案件性質2 + "%' or cpm03 like'" + 選擇專利案件性質3 + "%' or cpm03 like '" + 選擇專利案件性質4 + "%' or cpm04 like '" + 選擇專利案件性質1 + "%' or cpm04 like '" + 選擇專利案件性質2 + "%' or cpm04 like '" + 選擇專利案件性質3 + "%'  or cpm04 like '" + 選擇專利案件性質4 + "%') and cpm01 in("
    For i = 0 To UBound(AryTemp)
        strSql = strSql + "'" + AryTemp(i) + "',"
    Next
    strSql = Mid$(strSql, 1, Len(strSql) - 1) + ")"
    'Debug.Print strSQL
    'edit by nickc 2007/02/06 不用 dll 了
    'Set rs = obj01.ReadRst(strSQL)
    Set Rs = ClsPDReadRst(strSql)
    If Rs.EOF Then
        Rs.Close
        Cls0703GetDataTo0502_8 = False
        'edit by nickc 2007/02/06 不用 dll 了
        'Set obj01 = Nothing
        Exit Function
    Else
        ReDim SYS(Rs(0))
        Rs.Close
    End If
    
    'ReDim Sys()
    strSql = "select cpm01||cpm02 from casepropertymap where( cpm03 like '" + 選擇專利案件性質1 + "%'  or  cpm03 like '" + 選擇專利案件性質2 + "%' or cpm03 like'" + 選擇專利案件性質3 + "%' or cpm03 like '" + 選擇專利案件性質4 + "%' or cpm04 like '" + 選擇專利案件性質1 + "%' or cpm04 like '" + 選擇專利案件性質2 + "%' or cpm04 like '" + 選擇專利案件性質3 + "%'  or cpm04 like '" + 選擇專利案件性質4 + "%') and cpm01 in("
    For i = 0 To UBound(AryTemp)
        strSql = strSql + "'" + AryTemp(i) + "',"
    Next
    strSql = Mid$(strSql, 1, Len(strSql) - 1) + ")"
    'Debug.Print strSQL
    'edit by nickc 2007/02/06 不用 dll 了
    'Set rs = obj01.ReadRst(strSQL)
    Set Rs = ClsPDReadRst(strSql)
    If Rs.EOF Then
        Rs.Close
        Cls0703GetDataTo0502_8 = False
        'edit by nickc 2007/02/06 不用 dll 了
        'Set obj01 = Nothing
        Exit Function
    End If
    
    i = 0
    While Not Rs.EOF
        SYS(i) = Rs(0)
        i = i + 1
        Rs.MoveNext
    Wend
    Rs.Close
    'edit by nickc 2007/02/06 不用 dll 了
    'Set obj01 = Nothing
    Cls0703GetDataTo0502_8 = True
    Exit Function
ErrHand:
    Cls0703GetDataTo0502_8 = False
    'edit by nickc 2007/02/06 不用 dll 了
    'Set obj01 = Nothing
End Function

'取得商標案件性質
Public Function Cls0703GetDataTo0502_9(ByRef StrSqlStmt As String, ByRef SYS() As String) As Boolean
'edit by nickc 2007/02/06 不用 dll 了
'Dim obj01 As Object
Dim Rs As ADODB.Recordset
Dim AryTemp As Variant
Dim i As Integer
    'edit by nickc 2007/02/06 不用 dll 了
    'Set obj01 = CreateObject("prjtaiedll.clspublicdata")
    
    If Mid$(StrSqlStmt, Len(StrSqlStmt), 1) = "," Then
       StrSqlStmt = Mid$(StrSqlStmt, 1, Len(StrSqlStmt) - 1)
    End If
    AryTemp = Split(Trim$(StrSqlStmt), ",")
    
    strSql = "select count(cpm01) from casepropertymap where cpm03 like '" + 選擇商標案件性質1 + "%' or  cpm04 like '" + 選擇商標案件性質1 + "%' and cpm01 in("
    For i = 0 To UBound(AryTemp)
        strSql = strSql + "'" + AryTemp(i) + "',"
    Next
    strSql = Mid$(strSql, 1, Len(strSql) - 1) + ")"
    'Debug.Print strSQL
    'edit by nickc 2007/02/06 不用 dll 了
    'Set rs = obj01.ReadRst(strSQL)
    Set Rs = ClsPDReadRst(strSql)
    If Rs.EOF Then
        Rs.Close
        Cls0703GetDataTo0502_9 = False
        'edit by nickc 2007/02/06 不用 dll 了
        'Set obj01 = Nothing
        Exit Function
    End If
    ReDim SYS(Rs(0))
    Rs.Close
    
    strSql = "select cpm01||cpm02 from casepropertymap where cpm03 like '" + 選擇商標案件性質1 + "%' or  cpm04 like '" + 選擇商標案件性質1 + "%' and cpm01 in("
    For i = 0 To UBound(AryTemp)
        strSql = strSql + "'" + AryTemp(i) + "',"
    Next
    strSql = Mid$(strSql, 1, Len(strSql) - 1) + ")"
    'Debug.Print strSQL
    'edit by nickc 2007/02/06 不用 dll 了
    'Set rs = obj01.ReadRst(strSQL)
    Set Rs = ClsPDReadRst(strSql)
    If Rs.EOF Then
        Rs.Close
        Cls0703GetDataTo0502_9 = False
        'edit by nickc 2007/02/06 不用 dll 了
        'Set obj01 = Nothing
        Exit Function
    End If
    i = 0
    While Not Rs.EOF
        SYS(i) = Rs(0)
        i = i + 1
        Rs.MoveNext
    Wend
    Rs.Close
    'edit by nickc 2007/02/06 不用 dll 了
    'Set obj01 = Nothing
    Cls0703GetDataTo0502_9 = True
End Function

'填入發明申請案件數
Public Function Cls0703InsertDataTo0502_3(ByRef fa() As String, StrSqlStmt As String) As Boolean
'edit by nickc 2007/02/06 不用 dll 了
'Dim obj01 As Object
Dim i As Integer
Dim Rs As ADODB.Recordset

'Add By Cheng 2002/11/14
Dim BolTransOk As Boolean
BolTransOk = True

On Error GoTo ErrHand
    'edit by nickc 2007/02/06 不用 dll 了
    'Set obj01 = CreateObject("prjtaiedll.clspublicdata")
    strSql = "select  count(cp09) from caseprogress ,temp0502,patent where agent=cp44  " + StrSqlStmt
    'Debug.Print strSQL
    'edit by nickc 2007/02/06 不用 dll 了
    'Set rs = obj01.ReadRst(strSQL)
    Set Rs = ClsPDReadRst(strSql)
    If Rs.EOF Then
        Rs.Close
        Cls0703InsertDataTo0502_3 = True
        Exit Function
    End If
    i = 0
    cnnConnection.BeginTrans
    While Not Rs.EOF
        strSql = "update TEMP0502 set fdp00=" + CNULL(IIf(IsNull(Rs(0)), "", Rs(0))) + "where agent=" + CNULL(fa(i))
        'Debug.Print strSQL
        cnnConnection.Execute strSql
        Rs.MoveNext
        i = i + 1
    Wend
    Rs.Close
    'edit by nickc 2007/02/06 不用 dll 了 Set obj01 = Nothing
    'Modify By Cheng 2002/11/14
    If BolTransOk Then
        cnnConnection.CommitTrans
    End If
    Cls0703InsertDataTo0502_3 = True
    Exit Function
ErrHand:
    'Add By Cheng 2002/11/14
    If Err.Number = -2147168237 Then
       BolTransOk = False
       Resume Next
    End If

       'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
    cnnConnection.RollbackTrans
    Cls0703InsertDataTo0502_3 = False
End Function

'填入設計申請案件數
Public Function Cls0703InsertDataTo0502_4(ByRef fa() As String, StrSqlStmt As String) As Boolean
'edit by nickc 2007/02/06 不用 dll 了 Dim obj01 As Object
Dim i As Integer
Dim Rs As ADODB.Recordset
'Add By Cheng 2002/11/14
Dim BolTransOk As Boolean
BolTransOk = True

On Error GoTo ErrHand
   'edit by nickc 2007/02/06 不用 dll 了 Set obj01 = CreateObject("prjtaiedll.clspublicdata")
    strSql = "select  count(cp09) from caseprogress,temp0502 where agent=cp44  " + StrSqlStmt
    Set Rs = ClsPDReadRst(strSql)  'edit by nickc 2007/02/06 不用 dll 了 Set rs = obj01.ReadRst(strSQL)
    If Rs.EOF Then
        Rs.Close
        Cls0703InsertDataTo0502_4 = True
        Exit Function
    End If
    i = 0
    cnnConnection.BeginTrans
    While Not Rs.EOF
        strSql = "update TEMP0502 set fdp02=" + CNULL(IIf(IsNull(Rs(0)), "", Rs(0))) + "where agent=" + CNULL(fa(i))
       'Debug.Print strSQL
        cnnConnection.Execute strSql
        Rs.MoveNext
        i = i + 1
    Wend
    Rs.Close
    'edit by nickc 2007/02/06 不用 dll 了 Set obj01 = Nothing
    'Modify By Cheng 2002/11/14
    If BolTransOk Then
        cnnConnection.CommitTrans
    End If
    Cls0703InsertDataTo0502_4 = True
    Exit Function
ErrHand:
    'Add By Cheng 2002/11/14
    If Err.Number = -2147168237 Then
       BolTransOk = False
       Resume Next
    End If

       'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
    cnnConnection.CommitTrans
    Cls0703InsertDataTo0502_4 = False
End Function

'填入新型申請案件數
Public Function Cls0703InsertDataTo0502_5(ByRef fa() As String, StrSqlStmt As String) As Boolean
'edit by nickc 2007/02/06 不用 dll 了 Dim obj01 As Object
Dim i As Integer
Dim Rs As ADODB.Recordset

'Add By Cheng 2002/11/14
Dim BolTransOk As Boolean
BolTransOk = True

On Error GoTo ErrHand
   'edit by nickc 2007/02/06 不用 dll 了 Set obj01 = CreateObject("prjtaiedll.clspublicdata")
    strSql = "select  count(cp09) from caseprogress,temp0502 where agent=cp44  " + StrSqlStmt
    Set Rs = ClsPDReadRst(strSql)  'edit by nickc 2007/02/06 不用 dll 了 Set rs = obj01.ReadRst(strSQL)
    If Rs.EOF Then
        Rs.Close
        Cls0703InsertDataTo0502_5 = True
        Exit Function
    End If
    i = 0
    cnnConnection.BeginTrans
    While Not Rs.EOF
        strSql = "update TEMP0502 set fdp01=" + CNULL(IIf(IsNull(Rs(0)), "", Rs(0))) + "where agent=" + CNULL(fa(i))
       'Debug.Print strSQL
        cnnConnection.Execute strSql
        Rs.MoveNext
        i = i + 1
    Wend
    Rs.Close
    'edit by nickc 2007/02/06 不用 dll 了 Set obj01 = Nothing
    'Modify By Cheng 2002/11/14
    If BolTransOk Then
        cnnConnection.CommitTrans
    End If
    Cls0703InsertDataTo0502_5 = True
    Exit Function
ErrHand:
    'Add By Cheng 2002/11/14
    If Err.Number = -2147168237 Then
       BolTransOk = False
       Resume Next
    End If

       'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
    cnnConnection.CommitTrans
    Cls0703InsertDataTo0502_5 = False
End Function

'填入聯合申請案件數
Public Function Cls0703InsertDataTo0502_6(ByRef fa() As String, StrSqlStmt As String) As Boolean
'edit by nickc 2007/02/06 不用 dll 了 Dim obj01 As Object
Dim i As Integer
Dim Rs As ADODB.Recordset
'Add By Cheng 2002/11/14
Dim BolTransOk As Boolean
BolTransOk = True

On Error GoTo ErrHand
   'edit by nickc 2007/02/06 不用 dll 了 Set obj01 = CreateObject("prjtaiedll.clspublicdata")
    strSql = "select  count(cp09) from caseprogress,temp0502 where agent=cp44  " + StrSqlStmt
    Set Rs = ClsPDReadRst(strSql)  'edit by nickc 2007/02/06 不用 dll 了 Set rs = obj01.ReadRst(strSQL)
    If Rs.EOF Then
        Rs.Close
        Cls0703InsertDataTo0502_6 = True
        Exit Function
    End If
    i = 0
    cnnConnection.BeginTrans
    While Not Rs.EOF
        strSql = "update TEMP0502 set fdp03=" + CNULL(IIf(IsNull(Rs(0)), "", Rs(0))) + "where agent=" + CNULL(fa(i))
       'Debug.Print strSQL
        cnnConnection.Execute strSql
        Rs.MoveNext
        i = i + 1
    Wend
    Rs.Close
    'edit by nickc 2007/02/06 不用 dll 了 Set obj01 = Nothing
    'Modify By Cheng 2002/11/14
    If BolTransOk Then
        cnnConnection.CommitTrans
    End If
    Cls0703InsertDataTo0502_6 = True
    Exit Function
ErrHand:
    'Add By Cheng 2002/11/14
    If Err.Number = -2147168237 Then
       BolTransOk = False
       Resume Next
    End If
       'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
    cnnConnection.CommitTrans
    Cls0703InsertDataTo0502_6 = False
End Function

'填入商標案件數
Public Function Cls0703InsertDataTo0502_7(ByRef fa() As String, StrSqlStmt As String) As Boolean
'edit by nickc 2007/02/06 不用 dll 了 Dim obj01 As Object
Dim i As Integer
Dim Rs As ADODB.Recordset
'Add By Cheng 2002/11/14
Dim BolTransOk As Boolean
BolTransOk = True

On Error GoTo ErrHand
   'edit by nickc 2007/02/06 不用 dll 了 Set obj01 = CreateObject("prjtaiedll.clspublicdata")
    strSql = "select count(cp09) from caseprogress,temp0502 where agent=cp44  " + StrSqlStmt
    Set Rs = ClsPDReadRst(strSql)  'edit by nickc 2007/02/06 不用 dll 了 Set rs = obj01.ReadRst(strSQL)
    If Rs.EOF Then
        Rs.Close
        Cls0703InsertDataTo0502_7 = True
        Exit Function
    End If
    i = 0
    cnnConnection.BeginTrans
    While Not Rs.EOF
        strSql = "update TEMP0502 set fdt02=" + CNULL(IIf(IsNull(Rs(0)), "", Rs(0))) + "where agent=" + CNULL(fa(i))
       'Debug.Print strSQL
        cnnConnection.Execute strSql
        Rs.MoveNext
        i = i + 1
    Wend
    Rs.Close
    'edit by nickc 2007/02/06 不用 dll 了 Set obj01 = Nothing
    'Modify By Cheng 2002/11/14
    If BolTransOk Then
        cnnConnection.CommitTrans
    End If
    Cls0703InsertDataTo0502_7 = True
    Exit Function
ErrHand:
    'Add By Cheng 2002/11/14
    If Err.Number = -2147168237 Then
       BolTransOk = False
       Resume Next
    End If

       'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
    cnnConnection.CommitTrans
    Cls0703InsertDataTo0502_7 = False
End Function

'填入法務案件數
Public Function Cls0703InsertDataTo0502_8(ByRef fa() As String, StrSqlStmt As String) As Boolean
'edit by nickc 2007/02/06 不用 dll 了 Dim obj01 As Object
Dim i As Integer
Dim Rs As ADODB.Recordset
'Add By Cheng 2002/11/14
Dim BolTransOk As Boolean
BolTransOk = True

On Error GoTo ErrHand
   'edit by nickc 2007/02/06 不用 dll 了 Set obj01 = CreateObject("prjtaiedll.clspublicdata")
    strSql = "select  count(cp09) from caseprogress,temp0502 where agent=cp44  and cp31='Y'" + StrSqlStmt
    Set Rs = ClsPDReadRst(strSql)  'edit by nickc 2007/02/06 不用 dll 了 Set rs = obj01.ReadRst(strSQL)
    If Rs.EOF Then
        Rs.Close
        Cls0703InsertDataTo0502_8 = True
        Exit Function
    End If
    i = 0
    cnnConnection.BeginTrans
    While Not Rs.EOF
        strSql = "update TEMP0502 set fdcp31=" + CNULL(IIf(IsNull(Rs(0)), "", Rs(0))) + "where agent=" + CNULL(fa(i))
       'Debug.Print strSQL
        cnnConnection.Execute strSql
        Rs.MoveNext
        i = i + 1
    Wend
    Rs.Close
    'edit by nickc 2007/02/06 不用 dll 了 Set obj01 = Nothing
    'Modify By Cheng 2002/11/14
    If BolTransOk Then
        cnnConnection.CommitTrans
    End If
    Cls0703InsertDataTo0502_8 = True
    Exit Function
ErrHand:
    'Add By Cheng 2002/11/14
    If Err.Number = -2147168237 Then
       BolTransOk = False
       Resume Next
    End If

       'edit by nickc 2007/02/02
   'ErrorLog
   MsgBox Err.Description
    cnnConnection.CommitTrans
    Cls0703InsertDataTo0502_8 = False
End Function

'傳回現在應該是繳第幾年之費用
Public Function GetMoneyYears(ByRef strTemp As String) As Integer
Dim varTemp As Variant

If strTemp = "" Then
   GetMoneyYears = 1
Else
   varTemp = Split(strTemp, ",")
   'Modify by Morgan 2005/3/21 下次繳費年度須再加1
   'GetMoneyYears = UBound(varTemp) + 1
   GetMoneyYears = UBound(varTemp) + 2
End If
End Function

'傳回起算日之日期
Public Function GetStartDate(ByRef strTemp As String, cp() As String, field() As String) As String
      
   Select Case strTemp
      Case 收文日
         GetStartDate = cp(5)
                                       
      Case 申請日
         GetStartDate = field(10)
         
      Case 公開日
         GetStartDate = field(12)
         
      Case 准駁日
         GetStartDate = field(20)
         
      Case 公告日
         GetStartDate = field(14)
         
      Case 發證日
         GetStartDate = field(21)
         
      Case 發文日
         GetStartDate = cp(27)
         
      Case Else
         GetStartDate = ""
         
   End Select
   
End Function


'去除字串空白
Public Function MyTrim(ByRef strTemp As String) As String
Dim i As Long

For i = 1 To Len(strTemp)
       If Asc(Mid(strTemp, i, 1)) = 0 Then
          MyTrim = Mid(strTemp, 1, i - 1)
          Exit For
       End If
Next
End Function


'Update:True 更新 False:新增
Public Function GetCPSQL(cp() As String, Optional UPDATE As Boolean = True) As String
 Dim i As Integer, strTmp As String, strTmp1 As String
   cp(5) = TransDate(cp(5), 2)
   cp(6) = TransDate(cp(6), 2)
   cp(7) = TransDate(cp(7), 2)
   
   If Not UPDATE Then cp(9) = AutoNo(Left(cp(9), 1), 6)
   
   cp(25) = TransDate(cp(25), 2)
   cp(27) = TransDate(cp(27), 2)
   ''910917 nick 單引號修正
   cp(38) = ChgSQL(cp(38))
   cp(41) = ChgSQL(cp(41))
   
   cp(46) = TransDate(cp(46), 2)
   cp(47) = TransDate(cp(47), 2)
   cp(48) = TransDate(cp(48), 2)
   '2010/2/12 MODIFY BY SONIA
   'cp(53) = TransDate(cp(53), 2)
   'cp(54) = TransDate(cp(54), 2)
   '2012/11/6 modify by sonia 加入601領證
   'Modify by Amy 2018/04/10 +612年費移作次年
   If (cp(1) = "P" Or cp(1) = "CFP") And _
      (cp(10) = "601" Or cp(10) = "605" Or cp(10) = "606" Or cp(10) = "607" Or cp(10) = "612" Or cp(10) = "908") Then
   Else
      cp(53) = TransDate(cp(53), 2)
      cp(54) = TransDate(cp(54), 2)
   End If
   '2010/2/12 END
   cp(57) = TransDate(cp(57), 2)
   
   cp(44) = ChangeCustomerL(cp(44))
   cp(55) = ChangeCustomerL(cp(55))
   cp(56) = ChangeCustomerL(cp(56))
   'Added by Morgan 2024/5/20
   '修正編號未存9碼問題 Ex:CFP-034164讓渡(AB2045329)讓與人2&受讓人2
   cp(89) = ChangeCustomerL(cp(89))
   cp(90) = ChangeCustomerL(cp(90))
   cp(91) = ChangeCustomerL(cp(91))
   cp(92) = ChangeCustomerL(cp(92))
   cp(93) = ChangeCustomerL(cp(93))
   cp(94) = ChangeCustomerL(cp(94))
   cp(95) = ChangeCustomerL(cp(95))
   cp(96) = ChangeCustomerL(cp(96))
   'end 2024/5/20
   GetCPSQL = ""
      
   'Modify by Morgan 2005/11/22
   'For i = 1 To T_CP
   For i = 1 To UBound(cp)
      Select Case i
         '2005/9/15 MODIBY SONIA 加 CP61,CP62,CP63,CP87,CP88
         'Modify by Morgan 2005/6/29 加cp60不可回寫
         'Case 65, 66, 67, 68, 69, 70
         'Modified by Morgan 2013/5/17 +CP151
         Case 60, 65, 66, 67, 68, 69, 70, 61, 62, 63, 87, 88, 151
         '2011/8/25 ADD by sonia 加cp16~18,cp73~79(2011/8/17加在上面會造成CFP-024078自動發證未開收據前也不會回寫)
         Case 16, 17, 18, 73, 74, 75, 76, 77, 78, 79
            If cp(60) = "" Then
               GetCPSQL = GetCPSQL + "cp" + Format(i, "00") + "=" + CNULL(ChgSQL(cp(i))) + ","
               If Not UPDATE Then
                  strTmp = strTmp & "CP" & Format(i, "00") & ","
                  strTmp1 = strTmp1 & CNULL(ChgSQL(cp(i))) & ","
               End If
            End If
         '2011/8/25 END
         Case Else
            GetCPSQL = GetCPSQL + "cp" + Format(i, "00") + "=" + CNULL(ChgSQL(cp(i))) + ","
            If Not UPDATE Then
               strTmp = strTmp & "CP" & Format(i, "00") & ","
               strTmp1 = strTmp1 & CNULL(ChgSQL(cp(i))) & ","
            End If
      End Select
   Next
   
   If UPDATE Then
      GetCPSQL = Left(GetCPSQL, Len(GetCPSQL) - 1)
      GetCPSQL = "update caseprogress set " & GetCPSQL & " where cp09=" + CNULL(cp(9))
   Else
   
      strTmp = Left(strTmp, Len(strTmp) - 1)
      strTmp1 = Left(strTmp1, Len(strTmp1) - 1)
      GetCPSQL = "insert into caseprogress (" & strTmp & ") values (" & strTmp1 & ")"
   End If
End Function

'Update:True 更新 False:新增
Public Function GetPASQL(pa() As String, Optional UPDATE As Boolean = True) As String
 Dim i As Integer, strTmp As String, strTmp1 As String
   pa(10) = TransDate(pa(10), 2)
   pa(12) = TransDate(pa(12), 2)
   pa(14) = TransDate(pa(14), 2)
   pa(20) = TransDate(pa(20), 2)
   pa(21) = TransDate(pa(21), 2)
   pa(24) = TransDate(pa(24), 2)
   pa(25) = TransDate(pa(25), 2)
   pa(58) = TransDate(pa(58), 2)
   pa(140) = TransDate(pa(140), 2) 'Added by Morgan 2020/7/3
   
   pa(26) = ChangeCustomerL(pa(26))
   pa(27) = ChangeCustomerL(pa(27))
   pa(28) = ChangeCustomerL(pa(28))
   pa(29) = ChangeCustomerL(pa(29))
   pa(30) = ChangeCustomerL(pa(30))
   pa(75) = ChangeCustomerL(pa(75))
   pa(76) = ChangeCustomerL(pa(76))
   pa(86) = ChangeCustomerL(pa(86))
   pa(88) = ChangeCustomerL(pa(88))
   pa(101) = ChangeCustomerL(pa(101))
   pa(105) = ChangeCustomerL(pa(105))
   
   GetPASQL = ""
   
   For i = 1 To 99
      Select Case i
         Case 92, 93, 94, 95, 96, 97
         Case Else
            GetPASQL = GetPASQL + "pa" + Format(i, "00") + "=" + CNULL(ChgSQL(pa(i))) + ","
            If Not UPDATE Then
               strTmp = strTmp & "PA" & Format(i, "00") & ","
               strTmp1 = strTmp1 & CNULL(ChgSQL(pa(i))) & ","
            End If
      End Select
   Next
   
   For i = 100 To TF_PA 'edit by nickc 2006/07/12 T_PA
      'add by nickc 2006/07/12
      If i <> 108 And i <> 136 And i <> 137 And i <> 138 Then
        GetPASQL = GetPASQL + "pa" + Format(i) + "=" + CNULL(ChgSQL(pa(i))) + ","
        strTmp = strTmp & "PA" & Format(i) & ","
        strTmp1 = strTmp1 & CNULL(ChgSQL(pa(i))) & ","
      End If
   Next
   
   If UPDATE Then
      GetPASQL = Left(GetPASQL, Len(GetPASQL) - 1)
      GetPASQL = "update patent set " & GetPASQL & " where pa01=" + CNULL(pa(1)) + " and pa02=" + CNULL(pa(2)) + _
         " and pa03=" + CNULL(pa(3)) + " and pa04=" + CNULL(pa(4))
   Else
      strTmp = Left(strTmp, Len(strTmp) - 1)
      strTmp1 = Left(strTmp1, Len(strTmp1) - 1)
      GetPASQL = "insert into patent (" & strTmp & ") values (" & strTmp1 & ")"
   End If
   
End Function

''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' 檢查案件國家收費表是否存在該筆記錄
' Input : strCF01 ==> 系統別
'         strCF02 ==> 國家代碼
'         strCF03 ==> 案件性質
' Output : TRUE = 存在, FALSE = 不存在
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Public Function IsExistCasefee(ByVal strCF01 As String, ByVal strCF02 As String, ByVal strCF03 As String, ByRef strCF23 As String) As Boolean
   Dim strSql As String
   Dim rsTmp As ADODB.Recordset
   
   IsExistCasefee = False
   strCF23 = Empty
   Set rsTmp = New ADODB.Recordset
   strSql = "SELECT * FROM CASEFEE " & _
            "WHERE CF01 = '" & strCF01 & "' AND " & _
                  "CF02 = '" & strCF02 & "' AND " & _
                  "CF03 = '" & strCF03 & "' "
   rsTmp.CursorLocation = adUseClient
   rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If rsTmp.RecordCount > 0 Then
      If Not IsNull(rsTmp.Fields("CF23")) Then
         If rsTmp.Fields("CF23") <> 0 Then
            strCF23 = rsTmp.Fields("CF23")
            IsExistCasefee = True
         End If
      End If
   End If
   rsTmp.Close
   Set rsTmp = Nothing
End Function

''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' 新增一筆收達的下一程序檔
' Input : strNP01 ==> 總收文號
'         strNP02 ==> 本所案號第一個欄位(系統別)
'         strNP03 ==> 本所案號第二個欄位(流水號)
'         strNP04 ==> 本所案號第三個欄位(追加案號)
'         strNP05 ==> 本所案號第四個欄位(多國類別碼)
'         strDate ==> 本所期限及法定期限的日期
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Public Function InsertNextProgress_997(ByVal strNP01 As String, ByVal strNP02 As String, ByVal strNP03 As String, ByVal strNP04 As String, ByVal strNP05 As String, ByVal strDate As String) As String
   Dim strSql As String
   Dim strNP22 As String
   
   strNP22 = GetNextProgressNo()
    'Modify By Cheng 2003/12/08
    '若本所期限非工作天則抓最近的工作天
'   strSQL = "INSERT INTO NEXTPROGRESS (NP01,NP02,NP03,NP04,NP05,NP07,NP08,NP09,NP10,NP22) " & _
'               "VALUES ('" & strNP01 & "','" & strNP02 & "','" & strNP03 & "','" & strNP04 & "','" & strNP05 & "'," & _
'                       "997" & "," & DBDATE(strDate) & "," & DBDATE(strDate) & ",'" & strUserNum & "'," & strNP22 & ") "
   strSql = "INSERT INTO NEXTPROGRESS (NP01,NP02,NP03,NP04,NP05,NP07,NP08,NP09,NP10,NP22) " & _
               "VALUES ('" & strNP01 & "','" & strNP02 & "','" & strNP03 & "','" & strNP04 & "','" & strNP05 & "'," & _
                       "997" & "," & DBDATE(PUB_GetWorkDay1(strDate, True)) & "," & DBDATE(strDate) & ",'" & strUserNum & "'," & strNP22 & ") "
   cnnConnection.Execute strSql
End Function

'Added by Morgan 2023/10/24
'
Public Function PUB_GetPatRefCaseSQL(strText As String, Optional pWithCheckCol As Boolean = True) As String
   cnnConnection.Execute "delete from r100101_h where id='" & strUserNum & "' "
   cnnConnection.Execute "insert into r100101_h select '" & SystemNumber(strText, 1) & "','" & SystemNumber(strText, 2) & "','" & SystemNumber(strText, 3) & "','" & SystemNumber(strText, 4) & "',0,'1','" & strUserNum & "' from dual "
   cnnConnection.Execute "insert into r100101_h select '" & SystemNumber(strText, 1) & "','" & SystemNumber(strText, 2) & "','" & SystemNumber(strText, 3) & "','" & SystemNumber(strText, 4) & "',0,'2','" & strUserNum & "' from dual "
   cnnConnection.Execute "begin db_r100101_h('" & strUserNum & "'); end;"
   PUB_GetPatRefCaseSQL = "select distinct " & IIf(pWithCheckCol, "'',", "") & "replace(decode(pa23,'1','','N')||r001001||'-'||r001002||'-'||r001003||'-'||r001004||decode(pa57,'Y','＊','')||DECODE(length(nvl(pa108,'')),null,'','●'),'N---','')" & _
      ",pa05,nvl(s2.ST02,s1.ST02) st02,nvl(ptm03,ptm04),nvl(na03,na04),r001005 as bysort,r001001||'-'||r001002||'-'||r001003||'-'||r001004||decode(pa57,'Y','＊','')||DECODE(length(nvl(pa108,'')),null,'','●') as A" & _
      " from r100101_h,patent,patenttrademarkmap,nation,caseprogress c1,staff s1,caseprogress c2,staff s2" & _
      " where r001001=pa01(+) and r001002=pa02(+) and r001003=pa03(+) and r001004=pa04(+) and id='" & strUserNum & "'  and '1'=ptm01(+) and pa08=ptm02(+) and pa09=na01(+)" & _
      " and c1.cp01(+)=pa01 and c1.cp02(+)=pa02 and c1.cp03(+)=pa03 and c1.cp04(+)=pa04 and c1.cp31(+)='Y' and s1.st01(+)=c1.cp14" & _
      " and c2.cp01(+)=pa01 and c2.cp02(+)=pa02 and c2.cp03(+)=pa03 and c2.cp04(+)=pa04 and c2.cp09(+)<'B' and instr('" & NewCasePtyList & "',c2.cp10(+))>0 and s2.st01(+)=c2.cp14" & _
      " order by bysort,A "
End Function

'Add By Sindy 2022/12/15
'傳入:總收文號,接洽單編號,新案件性質代碼,申請國家代碼
'Modify By Sindy 2023/5/18 + , objCP64 As Object
'strCP10_New = 修改後案件性質, strCP10_Old = 原案件性質
'strCP16_New = 修改後費用, strCP16_Old = 原費用
'strCP17_New = 修改後規費, strCP17_Old = 原規費
'Modify By Sindy 2023/12/12 +, Optional ByVal bolSendMail As Boolean = True :是否發通知信
'                            , Optional ByVal strReason As String = "" :修改原因
Public Function PUB_ModCrLCRCData(strCP09 As String, strCP140 As String, strCP10_New As String, strCP10_Old As String, _
   strNA01 As String, Optional ByVal objCP64 As Object, _
   Optional ByVal strCP16_New As String, Optional ByVal strCP17_New As String, _
   Optional ByVal strCP16_Old As String, Optional ByVal strCP17_Old As String, _
   Optional ByVal bolSendMail As Boolean = True, Optional ByVal strReason As String = "") As Boolean
   
Dim strCRC03 As String
Dim strCP01 As String, strCP02 As String, strCP03 As String, strCP04 As String, strCP13 As String
Dim strCP05 As String
Dim strCP10Nm_New As String, strCP10Nm_Old As String
Dim strCaseName As String
Dim strSubject As String, strContent As String
Dim strCP139 As String
Dim strUpdDate As String, strUpdTime As String 'Add By Sindy 2023/5/18
Dim strModifyNote As String, strModifyType As String 'Add By Sindy 2023/5/18
Dim strCRL05 As String 'Add By Sindy 2023/11/17
Dim strTo As String 'Add By Sindy 2023/12/12
Dim strAccPerson As String 'Add by Amy 2024/05/14
   
   PUB_ModCrLCRCData = True
   If strSrvDate(1) < 接洽單電子收文啟用日 Then Exit Function
   If Len(strCP140) <> 10 Then Exit Function
   
   strModifyNote = "": strModifyType = ""
   strSql = "SELECT * FROM CaseProgress where CP09='" & strCP09 & "'"
   intI = 1
   Set RsTemp = ClsLawReadRstMsg(intI, strSql)
   If intI = 1 Then
      'Add By Sindy 2023/1/18 Morgan:控制TT-999999修改時不發通知也不更新接洽記錄單(L-5938-9 及P-127395點數分配乙事)
      If RsTemp.Fields("CP01") & RsTemp.Fields("CP02") = "TT999999" Then Exit Function
      strCP139 = "" & RsTemp.Fields("CP139")
      strCP01 = RsTemp.Fields("CP01")
      strCP02 = RsTemp.Fields("CP02")
      strCP03 = RsTemp.Fields("CP03")
      strCP04 = RsTemp.Fields("CP04")
      strCP05 = RsTemp.Fields("CP05")
      If strCP10_Old = "" Then strCP10_Old = RsTemp.Fields("CP10")
      strCP13 = RsTemp.Fields("CP13")
      If strCP16_Old = "" Then strCP16_Old = "" & RsTemp.Fields("CP16")
      If strCP17_Old = "" Then strCP17_Old = "" & RsTemp.Fields("CP17")
      strCaseName = GetPrjName(strCP01 & "-" & strCP02 & "-" & strCP03 & "-" & strCP04)
   End If
   '抓接洽單資料
   strSql = "SELECT CRL01,CRL05 FROM consultrecordlist where CRL01='" & strCP140 & "'"
   intI = 1
   Set RsTemp = ClsLawReadRstMsg(intI, strSql)
   If intI = 1 Then
      strCRL05 = "" & RsTemp.Fields("CRL05")
   End If
   
ReQ:
   If strReason = "" Then '是否有傳入修改原因(Frmacc11d0會傳入)
      strReason = InputBox("請輸入修改的原因！（不可空白）" & vbCrLf & vbCrLf & _
                           "(後續會發Mail通知財務處及智權人員)" & vbCrLf & vbCrLf & _
                           "按取消鍵無效，必輸！")
   End If
   If strReason = "" Then
      MsgBox "修改的原因，不可空白！", vbCritical + vbOKOnly
      GoTo ReQ
      'PUB_ModCrLCRCData = False
      'Exit Function
   End If
   
   strUpdDate = strSrvDate(1)
   strUpdTime = Right("000000" & ServerTime, 6)
   '記錄異動費用
   If strCP16_New <> "" Or strCP17_New <> "" Then
      If strCP16_Old <> strCP16_New Or strCP17_Old <> strCP17_New Then
         strModifyType = IIf(strModifyType <> "", strModifyType & "、", "") & "費用"
         
         '異動接洽記錄單案件性質金額欄位
         strSql = "UPDATE ConsultRecCMP SET CRC04='有修改',CRC05='有修改',CRC06='有修改'" & _
                  " WHERE CRC08='" & strCP09 & "'"
         cnnConnection.Execute strSql
         'Modify By Sindy 2024/8/22
'         strModifyNote = IIf(strModifyNote <> "", strModifyNote & vbCrLf, "") & _
'                         "原費用：" & Val(strCP16_Old) & " 元  修改為：" & strCP16_New & " 元;" & vbCrLf & _
'                         "原規費：" & Val(strCP17_Old) & " 元  修改為：" & strCP17_New & " 元;"
         strModifyNote = IIf(strModifyNote <> "", strModifyNote & vbCrLf, "") & _
                         "原費用" & Format(Val(strCP16_Old), "##,##0") & "元修改為" & Format(Val(strCP16_New), "##,##0") & "元、" & vbCrLf & _
                         "原規費" & Format(Val(strCP17_Old), "##,##0") & "元修改為" & Format(Val(strCP17_New), "##,##0") & "元"
      End If
   End If
   '記錄異動案件性質
   If strCP10_New <> "" Then
      strSql = "SELECT * FROM ConsultRecCMP where CRC08='" & strCP09 & "'"
      intI = 1
      Set RsTemp = ClsLawReadRstMsg(intI, strSql)
      If intI = 1 Then
         strCRC03 = RsTemp.Fields("CRC03")
         If strCRC03 <> strCP10_New Then
            strModifyType = IIf(strModifyType <> "", strModifyType & "、", "") & "案件性質"
            
            '案件性質名稱
            If strNA01 = "000" Then
               Call ClsPDGetCasePropertyL(1, strCP01, strCP10_New, strCP10Nm_New)
               'Add By Sindy 2024/9/2
               If strCRC03 = "有修改" Then
                  strCP10Nm_Old = "有修改"
               Else
               '2024/9/2 END
                  Call ClsPDGetCasePropertyL(1, strCP01, strCRC03, strCP10Nm_Old)
               End If
            Else
               Call ClsPDGetCasePropertyL(2, strCP01, strCP10_New, strCP10Nm_New)
               'Add By Sindy 2024/9/2
               If strCRC03 = "有修改" Then
                  strCP10Nm_Old = "有修改"
               Else
               '2024/9/2 END
                  Call ClsPDGetCasePropertyL(2, strCP01, strCRC03, strCP10Nm_Old)
               End If
            End If
            'Modify By Sindy 2024/8/22
'            strModifyNote = IIf(strModifyNote <> "", strModifyNote & vbCrLf, "") & _
'                            "原案件性質：" + strCP10Nm_Old + " 修改為：" + strCP10Nm_New + ";"
            strModifyNote = IIf(strModifyNote <> "", strModifyNote & vbCrLf, "") & _
                            "原案件性質" + strCP10Nm_Old + "修改為" + strCP10Nm_New
            '同時更新卷宗區的電子檔名
            strSql = "UPDATE CasePaperPDF SET CPP02=replace(CPP02,'." & strCRC03 & ".','." & strCP10_New & ".')" & _
                     " WHERE CPP01='" & strCP09 & "' and instr(CPP02,'." & strCRC03 & ".')>0"
            cnnConnection.Execute strSql
            
            '接洽記錄單案件性質
            'Modify By Sindy 2024/9/2 秀玲決定案件性質不要更新成新的案件性質, 存放為"有修改"讓人員更清楚知道有變動
'            strSql = "UPDATE ConsultRecCMP SET CRC03='" & strCP10_New & "'" & _
'                     " WHERE CRC08='" & strCP09 & "'"
            strSql = "UPDATE ConsultRecCMP SET CRC03='有修改'" & _
                     " WHERE CRC08='" & strCP09 & "'"
            cnnConnection.Execute strSql
         End If
      End If
   Else
      '案件性質沒有異動,純抓此總收文號的案件性質名稱
      If strNA01 = "000" Then
         Call ClsPDGetCasePropertyL(1, strCP01, strCP10_Old, strCP10Nm_New)
      Else
         Call ClsPDGetCasePropertyL(2, strCP01, strCP10_Old, strCP10Nm_New)
      End If
   End If
   
   If strModifyNote <> "" Then
      '流程備註檔
      strSql = GetInsertFLOW004Sql(strCP140, strUserNum, strUpdDate, strUpdTime, "", _
         strCP10Nm_New & "(" & strCP09 & ")" & Replace(strModifyNote, vbCrLf, "") & "，修改原因：" & strReason)
      cnnConnection.Execute strSql
      
      'Add By Sindy 2023/5/18 記錄進度備註
      strSql = "update caseprogress set cp64='" & Format(Val(strUpdDate) - 19110000, "###/##/##") & " " & _
               Format(strUpdTime, "##:##:##") & " " & strUserName & "：" & Replace(strModifyNote, vbCrLf, "") & "，修改原因：" & strReason
      If TypeName(objCP64) <> "Nothing" Then
         'Modify By Sindy 2023/5/29 加''
         strSql = strSql & IIf(objCP64.Text = "", "；'||cp64", "；" & objCP64.Text & "'")
      Else
         strSql = strSql & "；'||cp64"
      End If
      strSql = strSql & " where CP09='" & strCP09 & "'"
      cnnConnection.Execute strSql
      '2023/5/18 END
      
      'Add By Sindy 2023/12/12 + if
      If bolSendMail = True Then
      '2023/12/12 END
         strSubject = strCP01 & "-" & strCP02 & "-" & strCP03 & "-" & strCP04 & " 案(" & strCP10Nm_New & ")「" & strCaseName & "」" & strModifyType & "已異動"
         strContent = "本所案號： " + strCP01 & "-" & strCP02 & "-" & strCP03 & "-" & strCP04 + vbCrLf + _
                      "案件名稱： " + strCaseName + vbCrLf + _
                      "總收文號： " + strCP09 + vbCrLf + _
                      "收 文 日： " + ChangeTStringToTDateString(TransDate(strCP05, 1)) + vbCrLf + _
                      strModifyNote + vbCrLf + vbCrLf + _
                      "修改原因： " + strReason + vbCrLf
         'Add By Sindy 2023/12/12 若修改後的點數小於0，則依智權人員加發給部門主管；若為智權部則再加發「全所智權部主管」。
         strTo = ""
         If strCP16_New <> "" Or strCP17_New <> "" Then
            If strCP16_Old <> strCP16_New Or strCP17_Old <> strCP17_New Then
               If ((strCP16_New - strCP17_New) / 1000) < 0 Then
                  strTo = GetDeptMan(PUB_GetST03(strCP13))
                  If Left(PUB_GetST03(strCP13), 1) = "S" Then
                     strTo = strTo & ";" & Pub_GetSpecMan("全所智權部主管")
                  End If
               End If
            End If
         End If
         '2023/12/12 END
         '郵件暫存記錄 :
         'If strCP139 <> "" Then '有FC代理人,只寄給智權人員
         If strCRL05 = "2" Then 'Modify By Sindy 2023/11/17 是否發給財務處不判斷CP139，改判斷國內接洽單都發
            'Modify By Sindy 2023/5/3 + ChgSQL
            strSql = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08)" & _
               " values( '" & strUserNum & "','" & strCP13 & _
               IIf(strTo <> "", ";" & strTo, "") & "',to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss')" & _
               ",'" & ChgSQL(strSubject) & "','" & ChgSQL(strContent) & "')"
            cnnConnection.Execute strSql
         Else
            'Modify by Amy 2024/05/17 財務2個特殊設定拆成3個
            If Val(strSrvDate(1)) >= Val(財務拆總帳出納國內應收啟用日) Then
                strTo = Pub_GetSpecMan("財務處應收處理人員")
            Else
               strAccPerson = Pub_GetSpecMan("財務處總帳人員")
            End If
            'Modify By Sindy 2023/5/3 + ChgSQL
            strSql = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08)" & _
               " values( '" & strUserNum & "','" & strAccPerson & ";" & strCP13 & _
               IIf(strTo <> "", ";" & strTo, "") & "',to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss')" & _
               ",'" & ChgSQL(strSubject) & "','" & ChgSQL(strContent) & "')"
            'end 2024/05/14
            cnnConnection.Execute strSql
         End If
      End If
   End If
End Function

'Modify By Sindy 2024/1/17 從frm060121_1客戶提供文件處理,移出來共用
Public Sub PUB_SetCmbList(oCmbFL As Object, ByVal strFlist As String)
'strFlist   傳入檔案串列
Dim strT1 As String
Dim intA As Integer
Dim tmpArr As Variant
     
     oCmbFL.Clear
     If strFlist <> "" Then
         tmpArr = Empty
         'Modified by Lydia 2018/03/06 ";"改成"&"
         tmpArr = Split(strFlist, "&")
         For intA = 0 To UBound(tmpArr)
               strT1 = "" & tmpArr(intA)
               If Trim(strT1) <> "" Then
                    oCmbFL.AddItem strT1, intA
               End If
         Next intA
         oCmbFL.ListIndex = 0
     End If
End Sub

'Add By Sindy 2024/1/22 檢查送件方式
Public Function PUB_ChkCP141IsSend(strCP09 As String, Optional bolChkCP79 As Boolean = True, _
   Optional strMsgText As String = "發文") As Boolean
Dim strCP141 As String
Dim strCP142 As String
Dim strCP164 As String
Dim strNA01 As String
   
   PUB_ChkCP141IsSend = True
   
   '91.7.16此段錯誤, 正確的控制在DisplayNextForm的ShowMaintainForm m_CP09
   ' 檢查是否要顯示商標基本檔資料維護的畫面
   'If CheckJumpFrm020501() = True Then
   '   DisplayFrm020501
   'Else
   ' 檢查是否已收款
   'Added by Lydia 2015/11/24
   'Modify By Sindy 2023/4/21 +,cp142
   'Modify By Sindy 2023/12/11 +,cp164
   strExc(0) = "select cp06,nvl(cp79,0) cp79,cp141,cp142,cp164,cp01,cp02,cp03,cp04 from caseprogress where cp09='" & strCP09 & "'"
   intI = 1
   Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
   If intI = 1 Then
      strCP141 = "" & RsTemp.Fields("cp141")
      strCP142 = "" & RsTemp.Fields("cp142")
      strCP164 = "" & RsTemp.Fields("cp164")
      strNA01 = GetPrjNation1(RsTemp.Fields("cp01") & "-" & RsTemp.Fields("cp02") & "-" & RsTemp.Fields("cp03") & "-" & RsTemp.Fields("cp04"))
      
      'Modify By Sindy 2024/1/22 +And bolChkCP79 = True: 因是共用函數,判斷是否有要在此處同時檢查收款後送件
      If (strCP141 = "2" And RsTemp.Fields("cp79") > 0) And bolChkCP79 = True Then
         If PUB_ChkPaidByCP09(strCP09) = False Then   'Added by Morgan 2016/8/23 出納繳款確認後就可送件
            If IsNull(RsTemp.Fields("cp06")) Or "" & RsTemp.Fields("cp06") > strSrvDate(1) Then
               'Modified by Morgan 2024/2/6
               'MsgBox "此案智權人員欲管控收款後才可送件" & IIf(strMsgText = "發文", "，暫不可發文", "") & "！"
               MsgBox "此案智權人員欲管控收款後才可送件，目前尚有未收款，" & vbCrLf & "暫不可" & strMsgText & "！", vbExclamation
               'end 2024/2/6
               'MsgBox "本案已設定為收款後送件且尚有未收金額，不可發文！"
               PUB_ChkCP141IsSend = False
               Exit Function
            End If
         End If
      ElseIf strCP141 = "3" And strCP142 <> "" Then
         strExc(0) = ChangeWStringToTDateString(strCP142)
         If strCP164 = "" Then '之前有指定日期,尚未有指定日期方式
            If strCP142 <> strSrvDate(1) Then
               If MsgBox("本案已設定指定日期(" & strExc(0) & ")，但該日期與系統日不符，是否仍要" & strMsgText & "？", vbYesNo + vbDefaultButton2) = vbNo Then
                  PUB_ChkCP141IsSend = False
                  Exit Function
               End If
            End If
         Else
            'Modify By Sindy 2023/12/11
            '2=之前
'            If strCP164 = "2" And strCP142 < strSrvDate(1) Then
'               If MsgBox("本案已設定於指定日期(" & strExc(0) & ")之前送件但與系統日不符，是否仍要" & strMsgText & "？", vbYesNo + vbExclamation + vbDefaultButton2) = vbNo Then
'                  PUB_ChkCP141IsSend = False
'                  Exit Function
'               End If
'            else
            '3=之後
            'Modified by Morgan 2024/2/1 改含當日(比照原內外專控制) Ex:T-247630
            'If strCP164 = "3" And strCP142 >= strSrvDate(1) Then '提早了或當日,鎖住或提醒
            If strCP164 = "3" And strCP142 > strSrvDate(1) Then
               If strNA01 = "000" Then
                  MsgBox "本案需於指定日期(" & strExc(0) & ")之後方可" & strMsgText & "！", vbExclamation, "指定日期檢查"
                  PUB_ChkCP141IsSend = False
                  Exit Function
               ElseIf MsgBox("本案已設定於指定日期(" & strExc(0) & ")之後送件但與系統日不符，是否仍要" & strMsgText & "？", vbYesNo + vbExclamation + vbDefaultButton2) = vbNo Then
                  PUB_ChkCP141IsSend = False
                  Exit Function
               End If
            '1=當天
            ElseIf strCP164 = "1" And strCP142 > strSrvDate(1) Then '提早了,鎖住或提醒
               If strNA01 = "000" Then
                  MsgBox "本案需於指定日期(" & strExc(0) & ")方可" & strMsgText & "！", vbExclamation, "指定日期檢查"
                  PUB_ChkCP141IsSend = False
                  Exit Function
               ElseIf MsgBox("本案已設定於指定日期(" & strExc(0) & ")送件但與系統日不符，是否仍要" & strMsgText & "？", vbYesNo + vbExclamation + vbDefaultButton2) = vbNo Then
                  PUB_ChkCP141IsSend = False
                  Exit Function
               End If
            End If
            '2023/12/11 END
         End If
      End If
   End If
   'end 2015/11/24
End Function
'Added by Morgan 2024/4/17
'P案來函判發內部收文通知工程師及智權人員
Public Sub PUB_PBCPInform(ByVal pBCP09 As String)
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   Dim strSub As String, strContent As String
   
   stSQL = "select pa01||'-'||pa02||decode(pa03||pa04,'000','','-'||pa03||'-'||pa04) CNO,pa05" & _
      ",nvl(cu04,nvl(rtrim(cu05||' '||cu88||' '||cu89||' '||cu90),cu06)) CuName" & _
      ",c1.cp14||' '||st02 EngName,c1.cp13,c1.cp14,decode(pa09,'000',p1.cpm03,p1.cpm04) cpm03_1" & _
      ",c1.cp06 cp06,decode(pa09,'000',p2.cpm03,p2.cpm04) cpm03_2" & _
      " from caseprogress c1,patent,customer,staff,caseprogress c2,casepropertymap p1,casepropertymap p2" & _
      " where c1.cp09='" & pBCP09 & "' and pa01(+)=c1.cp01 and pa02(+)=c1.cp02 and pa03(+)=c1.cp03 and pa04(+)=c1.cp04" & _
      " and cu01(+)=substr(pa26,1,8) and cu02(+)=substr(pa26,9)  and st01(+)=c1.cp14 and c2.cp09(+)=c1.cp43" & _
      " and p1.cpm01(+)=c1.cp01 and p1.cpm02(+)=c1.cp10 and p2.cpm01(+)=c2.cp01 and p2.cpm02(+)=c2.cp10"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      strSub = rsQuery("CNO") & "「" & rsQuery("pa05") & "」 --> " & rsQuery("cpm03_2") & "(已內部收文" & rsQuery("cpm03_1") & ")"
      'end 2016/8/17
      strContent = "本所案號：" & rsQuery("CNO")
      strContent = strContent & vbCrLf & "申請人　：" & rsQuery("CuName")
      strContent = strContent & vbCrLf & "案件名稱：" & rsQuery("pa05")
      strContent = strContent & vbCrLf & "案件性質：" & rsQuery("cpm03_2")
      strContent = strContent & vbCrLf & "本所期限：" & ChangeWStringToWDateString(rsQuery("cp06"))
      strContent = strContent & vbCrLf & "來函內容：請至卷宗區參看官方來函"
      strContent = strContent & vbCrLf & "承辦人：" & rsQuery("EngName")
      
      stSQL = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08)" & _
         " values( '" & strUserNum & "','" & rsQuery("cp13") & ";" & rsQuery("cp14") & "',to_char(sysdate,'yyyymmdd')" & _
         ",to_char(sysdate,'hh24miss'),'" & ChgSQL(strSub) & "','" & ChgSQL(strContent) & "')"
      cnnConnection.Execute stSQL, intQ
   End If
               
   Set rsQuery = Nothing
End Sub

'Add By Sindy 2010/6/21
'*************************************************
'  電腦自動給號
'
'*************************************************
Public Function AutoNo_AA(InputItem As String, InputLength As Integer, Optional intTrans As Integer = 0) As String
Dim adoaccnum As New ADODB.Recordset
Dim strItem As String, strYes As String

'911106 NICK '911106 nick 避免相同連線作做2次 transation
Dim BolTransOk As Boolean

   If intTrans = 0 Then
      BolTransOk = True
   Else
      BolTransOk = False
   End If
   
On Error GoTo TransErr

   If BolTransOk = True Then
      adoTaie.BeginTrans
   End If
   
   adoTaie.Execute "update autonumber set au03 = au03 where au01 = '" & InputItem & "'"
   'Modify By Sindy 2010/6/21
   'Modified by Morgan 2020/4/29 +"LOS"
   If Trim(InputItem) = "AA" Or Trim(InputItem) = "LOS" Then
      strItem = ""
   '2010/6/21 End
'   ElseIf Len(InputItem) > 1 Then
'      strItem = Mid(InputItem, 2, 1)
'   Else
'      strItem = InputItem
   End If
   adoaccnum.CursorLocation = adUseClient
   adoaccnum.Open "select * from autonumber where au01 = '" & InputItem & "'", adoTaie, adOpenStatic, adLockReadOnly
   If adoaccnum.RecordCount = 0 Then
'      If InputItem = "E" Then
'         AutoNo = strItem & Mid(ACDate(ServerDate), 1, 3) & ZeroBeforeNo("2000", InputLength)
'      Else
'         'Modify By Sindy 2010/6/21
'         'If InputItem = "U" Or InputItem = "V" Then
'         If InputItem = "U" Or InputItem = "V" Or InputItem = "AA" Then
            AutoNo_AA = strItem & Mid(ACDate(ServerDate), 1, 3) & ZeroBeforeNo("0", InputLength)
'         Else
'            AutoNo = strItem & Val(Mid(ACDate(ServerDate), 1, 3)) & ZeroBeforeNo("0", InputLength)
'         End If
'      End If
   Else
      If adoaccnum.Fields("au02").Value <> Val(Mid(ServerDate, 1, 4)) Then
'         If InputItem = "E" Then
'            AutoNo = strItem & Mid(ACDate(ServerDate), 1, 3) & ZeroBeforeNo("2000", InputLength)
'         Else
'            'Modify By Sindy 2010/6/21
'            'If InputItem = "U" Or InputItem = "V" Then
'            If InputItem = "U" Or InputItem = "V" Or InputItem = "AA" Then
               AutoNo_AA = strItem & Mid(ACDate(ServerDate), 1, 3) & ZeroBeforeNo("0", InputLength)
'            Else
'               AutoNo = strItem & Val(Mid(ACDate(ServerDate), 1, 3)) & ZeroBeforeNo("0", InputLength)
'            End If
'         End If
      Else
'         'Modify By Sindy 2010/6/21
'         'If InputItem = "U" Or InputItem = "V" Then
'         If InputItem = "U" Or InputItem = "V" Or InputItem = "AA" Then
            AutoNo_AA = strItem & Mid(ACDate(ServerDate), 1, 3) & ZeroBeforeNo(str(adoaccnum.Fields("au03").Value), InputLength)
'         Else
'            AutoNo = strItem & Val(Mid(ACDate(ServerDate), 1, 3)) & ZeroBeforeNo(str(adoaccnum.Fields("au03").Value), InputLength)
'         End If
      End If
   End If
'   'Modify By Sindy 2010/6/21
'   'If Len(InputItem) = 1 Then
'   If Len(InputItem) = 1 Or InputItem = "AA" Then
'      If InputItem = "U" Or InputItem = "V" Then
'         strYes = SaveAutoNo(InputItem, Mid(AutoNo, 5, InputLength))
'      Else
         strYes = SaveAutoNo(InputItem, Mid(AutoNo_AA, 4, InputLength))
'      End If
'   End If
   adoaccnum.Close
   
   If BolTransOk Then
      adoTaie.CommitTrans
   End If
   
'911106 nick 避免相同連線作做2次 transation
   Exit Function
   
TransErr:
   If Err.Number = -2147168237 Then
      BolTransOk = False
      Resume Next
   End If
End Function

'Add By Sindy 2024/10/28 外商發文時，增加發Mail通知承辦人及副本給判發主管
'Modify By Sindy 2025/7/11 外商發文時，發Mail對象改抓智權人員(FC案承辦人亦也是智權人員在承辦的)
Public Sub PUB_FCTSendRecvMail(p_CP09 As String)
Dim cp() As String, tm() As String
Dim stSubject As String, stContent As String
Dim strEP40 As String, strEP04 As String, strEP05 As String, strST52 As String, strCC As String
Dim strST16 As String 'Add By Sindy 2024/12/20
Dim strCP13 As String 'Add By Sindy 2025/7/11

   If strSrvDate(1) < 外商承辦歷程啟用日 Then Exit Sub
   
   ReDim Preserve cp(1 To TF_CP) As String
   ReDim Preserve tm(1 To TF_TM) As String
   
   cp(9) = p_CP09
   If ClsPDReadCaseProgressDatabase(cp(), 國外_CF) = False Then
      Exit Sub
   Else
      tm(1) = cp(1)
      tm(2) = cp(2)
      tm(3) = cp(3)
      tm(4) = cp(4)
      If ClsPDReadTrademarkDatabase(tm(), 國外_CF) = False Then
         Exit Sub
      Else
         'Modify By Sindy 2025/7/11 mark
'         'Modify By Sindy 2025/7/7 增加判斷若承辦人為外商程序人員就不用發mail ex:302=更正
'         If PUB_GetST03(IIf(strEP05 <> "", strEP05, cp(14))) <> "F12" Then
'         '2025/7/7 END
            strSql = "select * from engineerprogress,staff,caseprogress where ep02='" & p_CP09 & "' and ep05=st01(+) and ep02=cp09"
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strSql)
            If intI = 1 Then
               strCP13 = "" & RsTemp.Fields("CP13") 'Add By Sindy 2025/7/11 智權人員
               strEP05 = "" & RsTemp.Fields("EP05") '承辦人
               strEP40 = "" & RsTemp.Fields("EP40") '歷程判發人
               strEP04 = "" & RsTemp.Fields("EP04") '歷程核稿人
               strST52 = "" & RsTemp.Fields("ST52") '二級主管
               strST16 = "" & RsTemp.Fields("ST16") 'Add By Sindy 2024/12/20
            End If
            'stSubject = "發文通知 " & tm(5) & "（本所案號：" & tm(1) & "-" & tm(2) & IIf(tm(3) & tm(4) = "000", "", "-" & tm(3) & "-" & tm(4)) & "）"
            stSubject = "【發文通知】" & tm(5) & " (Our Ref: " & tm(1) & "-" & tm(2) & IIf(tm(3) & tm(4) = "000", "", "-" & tm(3) & "-" & tm(4)) & ") "
            stContent = "本所案號：" + tm(1) & "-" & tm(2) & "-" & tm(3) & "-" & tm(4) + vbCrLf + _
                        "申請國家：" + tm(10) + " " + GetPrjNationNameHM(tm(10)) + vbCrLf + _
                        "案件名稱：" + tm(5) + vbCrLf + _
                        "案件性質：" + GetPrjState4(tm(1) & "-" & tm(2) & "-" & tm(3) & "-" & tm(4), cp(10)) + vbCrLf + _
                        "收文日　：" + ChangeWStringToTDateString(cp(5)) + vbCrLf + _
                        "智權人員：" + cp(13) + " " + GetPrjSalesNM(cp(13)) + vbCrLf + _
                        "承辦人　：" + cp(14) + " " + GetPrjSalesNM(cp(14)) + vbCrLf + _
                        "承辦期限：" + ChangeWStringToTDateString(cp(48)) + vbCrLf + _
                        "本所期限：" + ChangeWStringToTDateString(cp(6)) + vbCrLf + _
                        "法定期限：" + ChangeWStringToTDateString(cp(7)) + IIf(Val(cp(7)) <= Val(strSrvDate(1)) And Val(cp(7)) > 0, " (已過期)", "") + vbCrLf
            'Modify By Sindy 2024/12/20 May副理提FC日文組的發文通知信不CC二級主管
            If strST16 <> "4" Then
            '2024/12/20 END
               'Modify By Sindy 2025/7/11
'               If Left(PUB_GetST93(strEP40), 1) = "T" Then
'                  strCC = strEP40
'               ElseIf strEP40 = "" And Left(PUB_GetST93(strEP04), 1) = "T" Then
'                  strCC = strEP04
'               Else
'                  strCC = strST52
'               End If
               strCC = PUB_GetFCPProSup(strCP13)
               '2025/7/11 END
            End If
'            PUB_SendMail strUserNum, IIf(strEP05 <> "", strEP05, cp(14)), "", stSubject, stContent, , , , , , _
'               strCC, , , , , False
            PUB_SendMail strUserNum, strCP13, "", stSubject, stContent, , , , , , _
               strCC, , , , , False
'         End If
      End If
   End If
End Sub

'Modify By Sindy 2024/11/4 調整可通用於案件及財務系統
'Add By Sindy 2022/12/23 查詢接洽記錄單
'傳入:接洽單編號,收文日期
Public Function PUB_Queryfrm090801(strCRL01 As String, strCP05 As String, oForm As Form _
   , Optional bolLocked As Boolean = False) As Boolean
   
'Dim strCRL19 As String
Dim bolfrm090801 As Boolean 'Add By Sindy 2024/4/16
Dim strTmp As String, intA As Integer, rsAD As New ADODB.Recordset 'Added by Lydia 2024/05/15
Dim frmTmp As Form
Dim formCnt As Integer
Dim nFrm As Form
   
   If strCRL01 = "" And Left(UCase(TypeName(oForm)), 6) = UCase("Frmacc") Then Exit Function
   
   '沒傳入收文日,則用系統日檢查
   If strCP05 = "" Then
      strCP05 = strSrvDate(1)
   Else
      strCP05 = DBDATE(strCP05)
   End If
   
   'Modify By Sindy 2023/5/9 法律案源接洽單還是查 _Q
'   '檢查CRL19案件性質是否有資料,若有就跑舊接洽單
'   '法律所未電子化,電子化上線一樣維持使用舊接洽單
'   strtmp = "select crL01,crL19 from consultrecordlist where crl01='" & strCRL01 & "'"
'   inta = 1
'   Set rsad = ClsLawReadRstMsg(inta, strtmp)
'   If inta = 1 Then
'      strCRL19 = "" & rsad.Fields("crL19")
'   End If
   
   'Add By Sindy 2024/4/16 檢查是否為(紙本)接洽單的收文(frm090801) ex:LIN-000266 接洽單號:1130008132 TT-999999收文號:AB3014907
   strTmp = "select crc01 from consultreccmp where crc01='" & strCRL01 & "'"
   intA = 1
   Set rsAD = ClsLawReadRstMsg(intA, strTmp)
   If intA = 0 Then
      bolfrm090801 = True
   End If
   '2024/4/16 END
   Set rsAD = Nothing 'Added by Lydia 2024/05/15
   
   'Modify By Sindy 2022/9/16
   'Modify By Sindy 2024/4/16 + And bolfrm090801 = False
   If strCP05 >= 接洽單電子收文啟用日 And bolfrm090801 = False Then 'Modify By Sindy 2023/5/9 取消 And strCRL19 = ""
      '查詢接洽記錄單
      For formCnt = 0 To Forms.Count - 1
         If UCase(Forms(formCnt).Name) = UCase("frm090801_Q") Then
            If Forms(formCnt).Text5 = strCRL01 Then
               Forms(formCnt).Show
               Forms(formCnt).ZOrder
               DoEvents
               Exit Function
            End If
         End If
      Next
      'Modify By Sindy 2024/11/5
      'Set frmTmp = New frm090801_Q
      Set frmTmp = Forms(0).GetForm("frm090801_Q")
      '2024/11/5 END
      With frmTmp
         .SetParent oForm
         .bolIsTmp = True
         .m_blnCallPrint = True
         .Text5 = strCRL01
         Call .cmdok_Click(4)
         'Add By Sindy 2023/1/12
         If bolLocked = True Then
            .Show vbModal
         Else
         '2023/1/12 END
            .Show
         End If
      End With
      Set frmTmp = Nothing
      DoEvents
      
'      '畫面存在
'      If PUB_CheckFormExist("frm090801_Q") = True Then
'         'MsgBox "接洽單已開啟中！", vbInformation
'         'Exit Function
'         Unload frm090801_Q
'      End If
'      frm090801_Q.SetParent oForm
'      'frm090801_Q.bolIsTmp = True 'Add By Sindy 2023/1/4
'      frm090801_Q.m_blnCallPrint = True
'      frm090801_Q.Text5 = strCRL01
'      Call frm090801_Q.cmdOK_Click(4)
'      'frm090801_Q.ZOrder
'      frm090801_Q.Show vbModal
   Else
   '2022/9/16 END
      Set nFrm = Forms(0).GetForm("frm090801")
      nFrm.SetParent oForm
      nFrm.m_blnCallPrint = True 'Add By Sindy 2022/10/19
      nFrm.Text5 = strCRL01
      nFrm.m_blnCallPrint_CRL119 = True '是否列印特殊收據頁
      Call nFrm.cmdok_Click(4)
      nFrm.cmdOK(2).Visible = False
      nFrm.cmdOK(0).Visible = False
      nFrm.txtPCnt.Visible = False
      oForm.Hide '*****
   End If
   
   Exit Function
End Function

'Added by Morgan 2024/11/14
'無條件進位
Public Function UInt(pNum As Double) As Long
   UInt = -1 * Int(-1 * pNum)
End Function

'Added by Morgan 2024/11/14
'檢查是否已通知實審
Public Function PUB_Chk1204(pa() As String) As Boolean
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   '分割案也可用此規則(續行母案再審也適用)
   stSQL = "select * from caseprogress a where cp01='" & pa(1) & "' and cp02='" & pa(2) & "'" & _
      " and cp03='" & pa(3) & "' and cp04='" & pa(4) & "' and cp10='1204'" & _
      " and not exists(select * from caseprogress b where b.cp01=a.cp01 and b.cp02=a.cp02 and b.cp03=a.cp03" & _
      " and b.cp04=a.cp04 and b.cp10='107' and b.cp05>a.cp05 and b.cp57 is null)"
   intQ = 1
   Set RsTemp = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      PUB_Chk1204 = True
   End If
   Set rsQuery = Nothing
End Function

'Add by Amy 2025/02/14 確認是否已有代填繳款(扣繳)同意書
'intType:0-確認是否有檔案 / 1-開啟檔案
'stComp:公司別 (客戶簽回之同意書需 智慧所 和 法律所 分開) / stCName:客戶名稱 or 收據抬頭 -更名後,也需客戶再提供同意書
'stCName_NoUni:非Form2.0 元件傳入之資料
Public Function ChkWithholdingTaxConsent(intType As Integer, ByVal stFormN As String, ByVal stComp As String, ByVal stCName As String, _
  Optional ByRef objFile As Object, Optional ByRef stMsg As String, Optional ByVal stCName_NoUni) As Boolean
   Dim hLocalFile As Long, bolGetFile As Boolean
   Dim ii As Integer, stFilePath As String, stFileN(2) As String
   Dim bolChkUni As Boolean, stUniFileN As String, stFileExt As String, fs 'Add by Amy 2025/11/03
On Error GoTo ErrHand

   ChkWithholdingTaxConsent = False
   Select Case UCase(stFormN)
      Case "FRMACC1125" '特殊收據
      Case "FRMACC11P0" '收據抬頭基本資料維護
      Case "FRMACC21R0" '客戶/代理人財務EMail資料維護
      Case "FRMACC44W0" '代填繳款書客戶明細
      Case "FRMACC44W1" '代填繳款書客戶查詢(FRMACC44W0-查詢鈕)
   End Select
   
   stMsg = ""
   stFilePath = "智慧所"
   If stComp = "L" Then stFilePath = "法律所"
   stFilePath = Pub_GetSpecMan("財務代填扣繳繳款同意書") & "\" & stFilePath
   'stFilePath = strExcelPath & "委託代填繳款書(含名單)\" & stFilePath '測式用>>上線要Mark
   stFileN(1) = stCName & ".*" '客戶/抬頭名稱
  
   '以 客戶/抬頭名稱 確認是否有此檔名
   If PUB_ChkDir(stFilePath & "\" & stFileN(1)) = True Then
      stFileN(0) = stFileN(1)
      ChkWithholdingTaxConsent = True
   End If
   'Add by Amy 2025/03/06 名稱有[台],[臺]也確認
   If ChkWithholdingTaxConsent = False Then
      strExc(9) = Pub_GetField("Dual", "1=1", "ReplaceSign(TO_MULTI_BYTE(Upper('" & ChgSQL(stFileN(1)) & "')))")
      If PUB_ChkDir(stFilePath & "\" & strExc(9)) = True Then
         stFileN(0) = strExc(9)
         ChkWithholdingTaxConsent = True
      End If
   End If

   '開啟檔案
   If ChkWithholdingTaxConsent = True And intType = 1 Then
      objFile.path = stFilePath
      objFile.Refresh
      If objFile.ListCount > 0 Then
         stFileN(0) = Replace(stFileN(0), ".*", "") '抓到的檔名
         For ii = 0 To objFile.ListCount - 1
            'Memo by Amy 2025/11/03 ShellExecute 不支援Unicode檔名 ex:X59463 (使用ShellExecute無作用)
            If stFileN(0) = Mid(objFile.List(ii), 1, Val(InStr(objFile.List(ii), ".") - 1)) Then
               If PUB_ChkDir(stFilePath & "\" & objFile.List(ii)) = True Then
                  bolGetFile = True
                  '檢查檔案是否正在使用中 (.jpg判斷不到)
                  If PUB_ChkFileOpening(stFilePath & "\" & objFile.List(ii), , False) = True Then
                     MsgBox stFilePath & "\" & objFile.List(ii) & vbCrLf & "檔案正在使用中。", vbExclamation
                     Exit Function
                  Else
                     ShellExecute hLocalFile, "open", stFilePath & "\" & objFile.List(ii), vbNullString, vbNullString, 1
                  End If
                  Exit For
               End If
            'Add by Amy 2025/11/03 有? (Uni 字)
            ElseIf stCName_NoUni = Mid(objFile.List(ii), 1, Val(InStr(objFile.List(ii), ".") - 1)) Then
               bolChkUni = True
               stUniFileN = objFile.List(ii)
               stFileExt = Mid(stUniFileN, InStr(stUniFileN, "."))
               Exit For
            End If
         Next ii
         '未開啟檔
         If bolGetFile = False Then
            'Modify by Amy 2025/11/03 +if 用App開啟Pdf檔 ShellExecute不支援Unicode檔名 ex:X59463
            If ChkWithholdingTaxConsent = True And bolChkUni = True Then
               '檢查檔案是否正在使用中 (.jpg判斷不到)
               If PUB_ChkFileOpening(stFilePath & "\" & Replace(stUniFileN, "?", ""), , False) = True Then
                  MsgBox "檔案 " & Replace(stUniFileN, "?", "") & "* 正在使用中。", vbExclamation
                  Exit Function
               ElseIf PUB_ChkFileOpening(stFilePath & "\" & stFileN(0) & stFileExt, , False) = True Then
                  MsgBox stFileN(0) & stFileExt & "檔案正在使用中。", vbExclamation
                  Exit Function
               Else
                  '複製檔案至 user 電腦更名
                  Set fs = CreateObject("Scripting.FileSystemObject")
                  If Dir(strExcelPath & Replace(stUniFileN, "?", "")) = MsgText(601) Then
                     If Dir(Mid(strExcelPath, 1, Len(strExcelPath) - 1), vbDirectory) = MsgText(601) Then
                         MkDir strExcelPath
                     End If
                  End If
                  fs.CopyFile stFilePath & "\" & stFileN(0) & stFileExt, strExcelPath & Replace(stUniFileN, "?", "")
                  DoEvents
                  ShellExecute hLocalFile, "open", strExcelPath & "\" & Replace(stUniFileN, "?", ""), vbNullString, vbNullString, 1
                  ChkWithholdingTaxConsent = True
               End If
            Else
               stMsg = "Dir有檔案,路徑「" & stFilePath & "」卻未對應到"
               ChkWithholdingTaxConsent = False
            End If
            'end 2025/11/03
         End If
      End If
   End If
   
   Exit Function
   
ErrHand:
   ChkWithholdingTaxConsent = False
   stMsg = Err.Description
End Function


'Added by Morgan 2025/6/25
'專利基本檔刪除時一併刪除相關資料(參考進度刪除及專利基本檔刪除)
Public Sub PUB_DelPatentRefData(pa01 As String, pa02 As String, pa03 As String, pa04 As String, pForm As Form)
   Dim stSQL As String, intR As Integer
   Dim rsQuery As ADODB.Recordset
   
   'CASEMAP
   stSQL = "UPDATE CASEMAP SET CM01=CM01 WHERE (CM01='" & pa01 & "' AND CM02='" & pa02 & "' AND CM03='" & pa03 & "' AND CM04='" & pa04 & "')" & _
      " OR (CM05='" & pa01 & "' AND CM06='" & pa02 & "' AND CM07='" & pa03 & "' AND CM08='" & pa04 & "')"
   cnnConnection.Execute stSQL, intR
   If intR > 0 Then
      stSQL = "DELETE FROM CASEMAP WHERE CM01='" & pa01 & "' AND CM02='" & pa02 & "' AND CM03='" & pa03 & "' AND CM04='" & pa04 & "'" & _
         " OR (CM05='" & pa01 & "' AND CM06='" & pa02 & "' AND CM07='" & pa03 & "' AND CM08='" & pa04 & "')"
      Pub_SeekTbLog stSQL, , , , pForm.Caption & "(" & pForm.Name & ")"
      cnnConnection.Execute stSQL, intR
   End If
   
   'CASERELATION
   stSQL = "UPDATE CASERELATION SET CR01=CR01 WHERE CR01='" & pa01 & "' AND CR02='" & pa02 & "' AND CR03='" & pa03 & "' AND CR04='" & pa04 & "'" & _
      " OR (CR05='" & pa01 & "' AND CR06='" & pa02 & "' AND CR07='" & pa03 & "' AND CR08='" & pa04 & "')"
   cnnConnection.Execute stSQL, intR
   If intR > 0 Then
      stSQL = "DELETE FROM CASERELATION WHERE CR01='" & pa01 & "' AND CR02='" & pa02 & "' AND CR03='" & pa03 & "' AND CR04='" & pa04 & "'" & _
         " OR (CR05='" & pa01 & "' AND CR06='" & pa02 & "' AND CR07='" & pa03 & "' AND CR08='" & pa04 & "')"
      Pub_SeekTbLog stSQL, , , , pForm.Caption & "(" & pForm.Name & ")"
      cnnConnection.Execute stSQL, intR
   End If
   
   'CASERELATION1
   stSQL = "UPDATE CASERELATION1 SET CR01=CR01 WHERE CR01='" & pa01 & "' AND CR02='" & pa02 & "' AND CR03='" & pa03 & "' AND CR04='" & pa04 & "'" & _
      " OR (CR05='" & pa01 & "' AND CR06='" & pa02 & "' AND CR07='" & pa03 & "' AND CR08='" & pa04 & "')"
   cnnConnection.Execute stSQL, intR
   If intR > 0 Then
      stSQL = "DELETE FROM CASERELATION1 WHERE CR01='" & pa01 & "' AND CR02='" & pa02 & "' AND CR03='" & pa03 & "' AND CR04='" & pa04 & "'" & _
         " OR (CR05='" & pa01 & "' AND CR06='" & pa02 & "' AND CR07='" & pa03 & "' AND CR08='" & pa04 & "')"
      Pub_SeekTbLog stSQL, , , , pForm.Caption & "(" & pForm.Name & ")"
      cnnConnection.Execute stSQL, intR
   End If
   
   'DIVISIONCASE
   stSQL = "UPDATE DIVISIONCASE SET DC01=DC01 WHERE DC01='" & pa01 & "' AND DC02='" & pa02 & "' AND DC03='" & pa03 & "' AND DC04='" & pa04 & "'" & _
      " OR (DC05='" & pa01 & "' AND DC06='" & pa02 & "' AND DC07='" & pa03 & "' AND DC08='" & pa04 & "')"
   cnnConnection.Execute stSQL, intR
   If intR > 0 Then
      stSQL = "DELETE FROM CASERELATION1 WHERE DC01='" & pa01 & "' AND DC02='" & pa02 & "' AND DC03='" & pa03 & "' AND DC04='" & pa04 & "'" & _
         " OR (DC05='" & pa01 & "' AND DC06='" & pa02 & "' AND DC07='" & pa03 & "' AND DC08='" & pa04 & "')"
      Pub_SeekTbLog stSQL, , , , pForm.Caption & "(" & pForm.Name & ")"
      cnnConnection.Execute stSQL, intR
   End If
   
   '優先權資料
   stSQL = "UPDATE PRIDATE SET PD01=PD01 WHERE " & ChgPriDate(pa01 & pa02 & pa03 & pa04)
   cnnConnection.Execute stSQL, intR
   If intR > 0 Then
      stSQL = "DELETE FROM PRIDATE WHERE " & ChgPriDate(pa01 & pa02 & pa03 & pa04)
      Pub_SeekTbLog stSQL, , , , pForm.Caption & "(" & pForm.Name & ")"
      cnnConnection.Execute stSQL, intR
   End If
   
   '特殊備註
   If pa01 = "P" Or pa01 = "FCP" Then
         '下一程序固定備註(NpMemo)
         stSQL = "DELETE NPMEMO WHERE NM03='" & pa01 & pa02 & pa03 & pa04 & "' "
         cnnConnection.Execute stSQL
         '核准函輸入備註(ApprovalMemo2)
         stSQL = "DELETE APPROVALMEMO2 WHERE AM03='" & pa01 & pa02 & pa03 & pa04 & "' "
         cnnConnection.Execute stSQL
         '核駁及審查意見通知函備註(IncomMemo)
         stSQL = "DELETE INCOMMEMO WHERE IM03='" & pa01 & pa02 & pa03 & pa04 & "' "
         cnnConnection.Execute stSQL
         '請款函預設備註維護檔(DebitNotePS)
         stSQL = "DELETE DEBITNOTEPS WHERE DNPS03='" & pa01 & pa02 & pa03 & pa04 & "' "
         cnnConnection.Execute stSQL
         'end 2018/11/28
         'FCP承辦單設定維護(FcpEMPbill)
         stSQL = "DELETE FCPEMPBILL WHERE FEB03='" & pa01 & pa02 & pa03 & pa04 & "' "
         cnnConnection.Execute stSQL
         '通知告准加註(ApprovalPS)
         stSQL = "DELETE APPROVALPS WHERE APS03='" & pa01 & pa02 & pa03 & pa04 & "' "
         cnnConnection.Execute stSQL
   End If
   
   '各項指示
   stSQL = "UPDATE INSTRUCTIONS SET ITS01=ITS01 WHERE ITS01=" & CNULL(Pub_GetITS01Type(pa01)) & " AND ITS02=" & CNULL(pa01 & pa02 & pa03 & pa04)
   cnnConnection.Execute stSQL, intR
   If intR > 0 Then
      stSQL = "DELETE FROM INSTRUCTIONS WHERE ITS01=" & CNULL(Pub_GetITS01Type(pa01)) & " AND ITS02=" & CNULL(pa01 & pa02 & pa03 & pa04)
      Pub_SeekTbLog stSQL, , , , pForm.Caption & "(" & pForm.Name & ")"
      cnnConnection.Execute stSQL, intR
   End If
      
   '檢查專利發明人檔是否有資料,若有,逐筆記錄刪除
   stSQL = "SELECT * FROM PATENTInventor WHERE Pi01='" & pa01 & "' AND Pi02='" & pa02 & "' AND Pi03='" & pa03 & "' AND Pi04='" & pa04 & "' order by pi05 asc"
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL, True)
   If intR = 1 Then
      With rsQuery
      .MoveFirst
      Do While Not .EOF
         stSQL = "delete from patentInventor WHERE Pi01='" & pa01 & "' AND Pi02='" & pa02 & "' AND Pi03='" & pa03 & "' AND Pi04='" & pa04 & "' and pi05=" & .Fields("pi05")
         Pub_SeekTbLog stSQL, , , , pForm.Caption & "(" & pForm.Name & ")"
         cnnConnection.Execute stSQL, intR
         .MoveNext
      Loop
      End With
   End If
End Sub

'Added by Morgan 2025/8/8 從frm060307抽來
'FCP領證年費特殊/優先請款
Public Function PUB_Get601605SpecDN(pCP10 As String, ByVal pCP01 As String, ByVal pCP02 As String, ByVal pCP03 As String, ByVal pCP04 As String, ByVal pPA08 As String, Optional ByVal pPA72 As String, Optional ByVal pPA26 As String, Optional ByVal pPA75 As String, Optional ByRef pA1K28 As String, Optional ByRef pA1L05 As String, Optional ByRef p926CP09 As String, Optional ByRef p926CP16 As String, Optional ByRef p926Disc As String, Optional ByRef p926In605 As Boolean, Optional ByRef pMsg As String) As Boolean
   Dim dblRate As Double, intYr As Integer
   Dim rsQuery As ADODB.Recordset, intQ As Integer, stSQL As String
   Dim stA1K28List As String
   
   If pA1K28 = "" Then pA1K28 = PUB_GetA1K28(pCP01, pCP02, pCP03, pCP04, pCP10)
   
   'Modified by Morgan 2014/3/10 判斷是否有特殊請款金額
   'Modified by Morgan 2015/6/8
   'If PUB_GetSpecInvoiceFee(strA1K28, "FCP", "601", strSrvDate(2), dblUSRate, strExc(1)) = True Then
   'Modified by Morgan 2017/9/5 +Y54179000 Longitude Licensing Ltd. 領證年費固定報價
   'Modified by Morgan 2024/11/14 +Y27696 Bobst Mex SA領證及二核帳單之服務費設定為固定金額(領證及繳年費服務費：170美金,二次核對服務費：135美金,服務費總金額：305美金)
   'Modified by Morgan 2024/11/14 固定報價台幣都改無條件進位,否則當捨去後再轉回美金又捨去就會差1美元. Ex: 2美元*29.24=58.48台幣-> 58台幣/29.24=1.98美元->1美元
   'Modified by Morgan 2025/8/8 重整
   'If strA1K28 = "Y54179000" Or (m_strCP10 = 領證及繳年費 And (strA1K28 = "Y45814010" Or Left(m_PA26, 6) = "X48310" Or strA1K28 = "Y27696000")) Then
   
   pA1L05 = ""
   '領證固定報價
   If pCP10 = 領證及繳年費 Then
      'X48310 SYNGENTA 領證固定報價 USD$95
      If Left(pPA26, 6) = "X48310" Then
         dblRate = PUB_GetUSXRate_1(strSrvDate(2), "USD")
         pA1L05 = UInt(95 * Val(dblRate))
         
      'Added by Morgan 2025/8/21
      '請款對象Y56199000 Coupang Corp 領證固定報價 USD$110 --Kahn
      ElseIf pA1K28 = "Y56199000" Then
         dblRate = PUB_GetUSXRate_1(strSrvDate(2), "USD")
         pA1L05 = UInt(110 * Val(dblRate))
      'end 2025/8/21
      
      End If
      
      If pA1L05 <> "" Then
         PUB_Get601605SpecDN = True
         pMsg = "本案已於請款函設定【申請人】領證固定報價"
      End If
   End If
   
   'Y54179000 Longitude Licensing Ltd. 領證年費固定報價
   If pA1K28 = "Y54179000" Then
      dblRate = PUB_GetUSXRate_1(strSrvDate(2), "USD")
      '領證及第一年年費請款金額為USD72
      If pCP10 = 領證及繳年費 Then
         'pA1L05 = Round(72 * Val(dblRate))
         pA1L05 = UInt(72 * Val(dblRate))
      Else
         intYr = Val(Mid(pPA72, InStrRev(pPA72, ",") + 1))
         '10-20年 USD120
         If intYr >= 10 Then
            'pA1L05 = Round(120 * Val(dblRate))
            pA1L05 = UInt(120 * Val(dblRate))
         '7-9年 USD84
         ElseIf intYr >= 7 Then
            'pA1L05 = Round(84 * Val(dblRate))
            pA1L05 = UInt(84 * Val(dblRate))
         '4-6年 USD65
         ElseIf intYr >= 4 Then
            'pA1L05 = Round(65 * Val(dblRate))
            pA1L05 = UInt(65 * Val(dblRate))
         '1-3年 USD60
         Else
            'pA1L05 = Round(60 * Val(dblRate))
            pA1L05 = UInt(60 * Val(dblRate))
         End If
      End If
      PUB_Get601605SpecDN = True
      pMsg = "本案已於請款函設定【請款對象】領證/年費固定報價"
   End If
   'end 2017/9/5
   
   'A. 特殊請款-固定價目表：領證請款包含核對已准專利[請款帳單上僅顯示領證之請款金額]
   
   'Modified by Morgan 2025/8/8
   'Y22457000,Y48048000,Y52322000,Y52322B10,Y55165000,Y20438000,X84948000,Y54047000--TIM
   'Y33268010,Y45814010,Y51971000,Y20412010 --FRANNY
   'Y55240000 --TEDDY
   'Y34126000 --ANNY
   stA1K28List = "Y22457000,Y48048000,Y52322000,Y52322B10,Y55165000,Y20438000,X84948000,Y54047000" & _
      ",Y33268010,Y45814010,Y51971000,Y20412010,Y55240000,Y34126000"
   If pCP10 = 領證及繳年費 And InStr(stA1K28List, pA1K28) > 0 Then
      p926In605 = True
      dblRate = PUB_GetUSXRate_1(strSrvDate(2), "USD")
      'THE DOW USD$270 --Tim
      If InStr("Y22457000,Y48048000,Y52322000,Y52322B10", pA1K28) > 0 Then
         pA1L05 = UInt(270 * Val(dblRate))
         
      'EATON USD$200 --Tim
      ElseIf InStr("Y55165000,Y20438000,X84948000", pA1K28) > 0 Then
         pA1L05 = UInt(200 * Val(dblRate))
         
      
      '波音 USD$205 --Tim
      ElseIf pA1K28 = "Y54047000" Then
         pA1L05 = UInt(205 * Val(dblRate))
         
      'BASF USD$168 --Franny
      ElseIf InStr("Y33268010,Y45814010", pA1K28) > 0 Then
          pA1L05 = UInt(168 * Val(dblRate))
          
      'Outokumpu USD$200 --Franny
      ElseIf pA1K28 = "Y51971000" Then
          pA1L05 = UInt(200 * Val(dblRate))
          
      'Novo Nordisk USD$200 --Franny
      ElseIf pA1K28 = "Y20412010" Then
          pA1L05 = UInt(200 * Val(dblRate))
          
      'DUPONT USD$270 --TEDDY
      ElseIf pA1K28 = "Y55240000" Then
          pA1L05 = UInt(270 * Val(dblRate))
          
      'L'AIR LIQUIDE USD$200 --ANNY
      ElseIf pA1K28 = "Y34126000" Then
          pA1L05 = UInt(200 * Val(dblRate))
          
      End If
      
      '設定926的收文金額，點數分配時依此金額分給工程師
      stSQL = "select cp09,st93 from caseprogress,staff where cp01='" & pCP01 & "' and cp02='" & pCP02 & "' and cp03='" & pCP03 & "' and cp04='" & pCP04 & "' and cp10='926' and cp57 is null and cp60 is null and st01(+)=cp14"
      intQ = 1
      Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
      If intQ = 1 Then
         p926CP09 = rsQuery("cp09")
         '外日專共用請款對象依926的承辦工程師判斷分配金額
         stA1K28List = "Y48048000,Y52322000,Y52322B10,Y55240000,Y34126000"
         If InStr(stA1K28List, pA1K28) > 0 And Left("" & rsQuery("st93"), 1) = "J" Then
            If pPA08 = "3" Then
               p926CP16 = "3000"
            Else
               p926CP16 = "4500"
            End If
         
         Else
            If pPA08 = "3" Then
               p926CP16 = "2000"
            Else
               p926CP16 = "3000"
            End If
         End If
      End If
      PUB_Get601605SpecDN = True
      pMsg = "本案已於請款函設定【請款對象】領證(含二核)固定報價"
   End If
   
   'B. 優先請款-領證請款時一併優先請款核對已准專利[請款帳單上分別顯示領證&核對已准專利金額]
   
   'Added by Morgan 2024/11/14 +Y27696 Bobst Mex SA領證及二核帳單之服務費設定為固定金額(領證及繳年費服務費：170美金,二次核對服務費：135美金,服務費總金額：305美金)
   If pCP10 = 領證及繳年費 And pA1K28 = "Y27696000" Then
      dblRate = PUB_GetUSXRate_1(strSrvDate(2), "USD")
      pA1L05 = UInt(170 * Val(dblRate))
      stSQL = "select cp09 from caseprogress where cp01='" & pCP01 & "' and cp02='" & pCP02 & "' and cp03='" & pCP03 & "' and cp04='" & pCP04 & "' and cp10='926' and cp57 is null and cp60 is null"
      intQ = 1
      Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
      If intQ = 1 Then
         p926CP09 = rsQuery("cp09")
         p926CP16 = UInt(135 * dblRate)
         p926Disc = 0 'Added by Morgan 2024/12/12
      End If
      PUB_Get601605SpecDN = True
      pMsg = "本案已於請款函設定【請款對象】領證一併優先請二核(固定報價)"
   End If
   'end 2024/11/14
   
   'Modified by Morgan 2025/8/8
   '+Y55579000 --Tim
   '+Y22808000,Y52218000 --Kahn
   If pCP10 = 領證及繳年費 And InStr("Y52709000,Y48526000,Y52418000,Y55579000,Y22808000,Y52218000", Left(pPA75, 8)) > 0 Then
      stSQL = "select cp09 from caseprogress where cp01='" & pCP01 & "' and cp02='" & pCP02 & "' and cp03='" & pCP03 & "' and cp04='" & pCP04 & "' and cp10='926' and cp57 is null and cp60 is null"
      intQ = 1
      Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
      If intQ = 1 Then
         p926CP09 = rsQuery("cp09")
         p926Disc = 1 - (PUB_GetA1L07Disc(pCP01, pCP02, pCP03, pCP04, "926", strSrvDate(2)) / 100)
         If pPA08 = "3" Then
            p926CP16 = "3000"
         Else
            p926CP16 = "4500"
         End If
      End If
      PUB_Get601605SpecDN = True
      pMsg = "本案已於請款函設定【代理人】領證一併優先請二核"
   End If
   Set rsQuery = Nothing
End Function

'Added by Morgan 2025/9/2
'讀取來函期限先延期後收文的進度
Public Function PUB_GetCPAftExt(pNation As String, pExtCP09 As String, pCP09 As String, Optional pNP06 As String, Optional pCP06 As String, Optional pCP07 As String, Optional pNpPty As String, Optional pCpPty As String) As Boolean
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   'Modified by Morgan 2025/9/8 - np06='Y'
   stSQL = "select np06," & IIf(pNation = 台灣國家代號, "c1.cpm03", "c1.cpm04") & " as nppty,b.cp09,b.cp06,b.cp07," & IIf(pNation = 台灣國家代號, "c2.cpm03", "c2.cpm04") & " as cppty" & _
      " from caseprogress a, nextprogress, caseprogress b, casepropertymap c1,casepropertymap c2" & _
      " where  a.cp09='" & pExtCP09 & "' and a.cp43>'C' and np01(+)=a.cp43 and np02=a.cp01 and np03=a.cp02 and np04=a.cp03 and np05=a.cp04" & _
      " and b.cp09(+)=np24 and c1.cpm01(+)=np02 and c1.cpm02(+)=np07 and c2.cpm01(+)=b.cp01 and c2.cpm02(+)=b.cp10"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      With rsQuery
      pNP06 = "" & .Fields("np06")
      pNpPty = "" & .Fields("nppty")
      If pNP06 = "Y" Then
         pCP09 = "" & .Fields("cp09")
         pCP06 = "" & .Fields("cp06")
         pCP07 = "" & .Fields("cp07")
         pCpPty = "" & .Fields("cppty")
      Else
         pCP09 = ""
         pCP06 = ""
         pCP07 = ""
         pCpPty = ""
      End If
      End With
      If pCP09 <> "" Then
         PUB_GetCPAftExt = True
      End If
   End If
   Set rsQuery = Nothing
End Function

'Add by Sindy 2025/10/20
'strPath 例如:電子送件暫存區
'bolOnlyOpenCase: 只要開啟有掛案號的資料夾
Public Function GetFCPPathVal(strPath As String, strCP01 As String, strCP02 As String, strCP10Nm As String, _
   Optional ByVal bolOnlyOpenCase As Boolean = False, Optional ByVal strServer As String = "Typing2") As String
Dim strFolder As String
   
   '資料夾
   If Right(strPath, 1) = "\" Then strPath = Left(strPath, Len(strPath) - 1)
   strFolder = strPath
   If InStr(strFolder, "\") > 0 Then
      strFolder = Mid(strFolder, InStrRev(strFolder, "\") + 1)
   End If
   '桌面
   If strServer = PUB_Getdesktop Or _
      UCase(pub_DbTerminalName) <> UCase(正式資料庫電腦名稱) Or Pub_StrUserSt03 = "M51" Then
      If InStr(UCase(strPath), UCase(PUB_Getdesktop)) = 0 Then
         If InStr(strPath, "\") = 0 Then
            GetFCPPathVal = PUB_Getdesktop & "\" & strPath 'ex:strPath=電子送件暫存區
         Else
            GetFCPPathVal = PUB_Getdesktop & "\" & strFolder
         End If
      Else
         GetFCPPathVal = strPath
      End If
   Else
      If InStr(strPath, "\") = 0 Then
         GetFCPPathVal = "\\" & Trim(strTyping2Path) & "\" & strPath
      Else
         If InStr(UCase(strPath), UCase(strServer & "\")) > 0 Then
            If InStr(strPath, strServer & "\") = 0 Then
               strPath = UCase(strPath)
            End If
            GetFCPPathVal = Replace(strPath, UCase(strServer), Trim(strTyping2Path))
         Else
            GetFCPPathVal = strPath
         End If
      End If
   End If
   If Right(GetFCPPathVal, 1) = "\" Then GetFCPPathVal = Left(GetFCPPathVal, Len(GetFCPPathVal) - 1)
   If strCP01 <> "" And strCP02 <> "" Then
      If InStr(GetFCPPathVal, strCP01 & strCP02) > 0 Then
         GetFCPPathVal = Left(GetFCPPathVal, InStrRev(GetFCPPathVal, strCP01 & strCP02) - 2)
      End If
      '多案件性質同時期操作歷程時,檢查是否再建下一層子資料夾
      If strPath = "送件區" Then
         strExc(10) = GetFCPPathVal & "\" & strCP01 & strCP02 & strCP10Nm
      Else
         strExc(10) = GetFCPPathVal & "\" & strCP01 & strCP02 & "\" & strCP01 & strCP02 & strCP10Nm
      End If
      If Dir(strExc(10) & "\", vbDirectory) <> "" Then
         GetFCPPathVal = strExc(10)
      Else
         strExc(10) = GetFCPPathVal & "\" & strCP01 & strCP02
         If Dir(strExc(10) & "\", vbDirectory) <> "" Then
            GetFCPPathVal = strExc(10)
         ElseIf bolOnlyOpenCase = True Then
            GetFCPPathVal = strExc(10)
         Else
            GetFCPPathVal = GetFCPPathVal 'ex:\\typing2\外專送件\
         End If
      End If
   End If
   If Right(GetFCPPathVal, 1) <> "\" Then GetFCPPathVal = GetFCPPathVal & "\"
End Function

'Added by Lydia 2018/05/18 檢查副檔名
'Modify By Sindy 2025/10/27 從frm090905工程師上傳作業 move過來,變共用函數
' + , m_CP01 As String, m_CP02 As String, Optional ByVal bolSendDate As Boolean = True
Public Function ChkAttFileName(ByVal pName As String _
   , m_CP01 As String, m_CP02 As String, Optional ByVal bolSendDate As Boolean = True) As Boolean
Dim cName As String
Dim intR As Integer, strKey As String  'Added by Lydia 2021/04/19

       ChkAttFileName = False
       cName = UCase(pName)
       'Add by Lydia 2018/12/27 去除路徑
       If InStrRev(cName, "\") > 0 Then
           cName = Mid(cName, InStrRev(cName, "\") + 1)
       End If
       'end 2018/12/27
       'Move by Lydia 2018/11/14 不限檔案格式要放在最前面
       'ZIP檔(從智慧局下載)
       If Right(cName, Len(".ZIP")) = ".ZIP" Then
                        ChkAttFileName = True
       'Added by Lydia 2018/10/25 翻譯參考用之說明書不限檔案格式
       ElseIf InStr(cName, ".SEP.") > 0 Then
                        ChkAttFileName = True
       'end 2018/10/25
       'Added by Lydia 2019/01/16 相似結果比對檔案(*.RES)
       ElseIf Right(cName, Len(".RES.DOCX")) = ".RES.DOCX" Or Right(cName, Len(".RES.DOC")) = ".RES.DOC" _
                Or Right(cName, Len(".RES.PDF")) = ".RES.PDF" Then
                        ChkAttFileName = True
       'end 2019/01/16
       
       'Word檔
       'Modified by Lydia 2020/01/16 +TXT檔
       ElseIf Right(cName, Len(".DOCX")) = ".DOCX" Or Right(cName, Len(".DOC")) = ".DOC" Or Right(cName, Len(".TXT")) = ".TXT" Then
               'Modified by Lydia 2018/10/22 + 提供翻譯參考用之word版說明書(*.SEP)
               'If Right(cName, Len(".ORI.DOCX")) = ".ORI.DOCX" Or Right(cName, Len(".ORI.DOC")) = ".ORI.DOC" _
                            Or Right(cName, Len(".FIX.DOCX")) = ".FIX.DOCX" Or Right(cName, Len(".FIX.DOC")) = ".FIX.DOC" _
                            Or Right(cName, Len(".COR.DOCX")) = ".COR.DOCX" Or Right(cName, Len(".COR.DOC")) = ".COR.DOC" _
                            Or Right(cName, Len(".DES.DOCX")) = ".DES.DOCX" Or Right(cName, Len(".DES.DOC")) = ".DES.DOC" _
                            Or InStr(cName, ".FIX_U.DOC") > 0 Or InStr(cName, ".COR_U.DOC") > 0 Then
               'Modified by Lydia 2020/01/16 +TXT檔
               'If InStr(".ORI.DOC;.FIX.DOC;.COR.DOC;.DES.DOC;.SEP.DOC", Right(cName, 8)) > 0 _
                            Or InStr(".ORI.DOCX;.FIX.DOCX;.COR.DOCX;.DES.DOCX;.SEP.DOCX", Right(cName, 9)) > 0 _
                            Or InStr(cName, ".FIX_U.DOC") > 0 Or InStr(cName, ".COR_U.DOC") > 0 _
                            Or InStr(cName, ".FIX_U.DOCX") > 0 Or InStr(cName, ".COR_U.DOCX") > 0 Then
               'Modified by Lydia 2021/04/19 +.FIX.SEQ.
               If InStr(".ORI.DOC;.FIX.DOC;.COR.DOC;.DES.DOC;.SEP.DOC;.ORI.TXT;.FIX.TXT;.COR.TXT", Right(cName, 8)) > 0 _
                            Or InStr(".ORI.DOCX;.FIX.DOCX;.COR.DOCX;.DES.DOCX;.SEP.DOCX", Right(cName, 9)) > 0 _
                            Or InStr(".FIX_U.DOC;.COR_U.DOC;.FIX_U.TXT;.COR_U.TXT", Right(cName, 10)) > 0 _
                            Or InStr(".FIX_U.DOCX;.COR_U.DOCX", Right(cName, 11)) > 0 _
                            Or InStr(cName, ".FIX.SEQ.") > 0 Then
                        
                     'Modify By Sindy 2025/10/27
                     If bolSendDate = True Then '須檢查有送件日者
                     '2025/10/27 END
                        'Added by Lydia 2021/04/19 改用迴圈
                        For intR = 1 To 2
                            If intR = 1 Then
                                strKey = ".FIX_U."
                            ElseIf intR = 2 Then
                                strKey = ".FIX."
                            End If
                        'end 2021/04/19
                            'Added by Lydia 2018/12/27 判斷最終版本中說word=>案號-送件日.FIX_U
                            'Modified by Lydia 2021/04/19 上傳檔名含有「.FIX_U.、.FIX.」會檢查檔名無日期(送件日)不可上傳
                            'If InStr(cName, ".FIX_U.DOC") > 0 Then
                            '     cName = Mid(cName, 1, InStr(cName, ".FIX_U.DOC") - 1)
                            If InStr(cName, strKey) > 0 Then
                                 cName = Mid(cName, 1, InStr(cName, strKey) - 1)
                                 'If cName <> m_Pa(1) & m_Pa(2) And cName <> m_Pa(1) & Val(m_Pa(2)) Then 'Remove by Lydia 2021/04/19 如果有日期,才要判斷格式; 沒日期會自動加上系統日
                                     If InStr(cName, "-") = 0 Then
                                         GoTo HelpMsg
                                     Else
                                         cName = Mid(cName, InStr(cName, "-") + 1)
                                         If Len(cName) > 7 Then
                                            GoTo HelpMsg
                                         Else
                                            If ChkDate(cName, False) = False Then
                                                GoTo HelpMsg
                                            ElseIf ChkWorkDay(TransDate(cName, 2)) = False Then
                                                MsgBox "檔名的送件日非工作天！", vbCritical
                                                Exit Function
                                            End If
                                         End If
                                     End If
                                 'End If 'Remove by Lydia 2021/04/19
                            End If
                            'END 2018/12/27
                        Next intR 'end 2021/04/19
                     End If
                     ChkAttFileName = True
               End If
       'PDF檔
       ElseIf Right(cName, Len(".PDF")) = ".PDF" Then
               'Modify By Sindy 2025/10/28 + Or (InStr(cName, "申請書") > 0 And bolSendDate = False)
               If Right(cName, Len(".ORI.PDF")) = ".ORI.PDF" Or Right(cName, Len(".FIG.PDF")) = ".FIG.PDF" _
                                Or InStr(cName, ".FIX_") > 0 Or bolSendDate = False Then  '修正本
                     'Modify By Sindy 2025/10/27
                     If bolSendDate = True Then '須檢查有送件日者
                     '2025/10/27 END
                        'Added by Lydia 2019/01/10 判斷-最終版圖式=>案號-送件日.FIG.PDF
                        If Right(cName, Len(".FIG.PDF")) = ".FIG.PDF" Then
                             cName = Mid(cName, 1, InStr(cName, ".FIG.PDF") - 1)
                             If cName <> m_CP01 & m_CP02 And cName <> m_CP01 & Val(m_CP02) Then
                                 If InStr(cName, "-") = 0 Then
                                     GoTo HelpMsg
                                 Else
                                     cName = Mid(cName, InStr(cName, "-") + 1)
                                     If Len(cName) > 7 Then
                                        GoTo HelpMsg
                                     Else
                                        If ChkDate(cName, False) = False Then
                                            GoTo HelpMsg
                                        ElseIf ChkWorkDay(TransDate(cName, 2)) = False Then
                                            MsgBox "檔名的送件日非工作天！", vbCritical
                                            Exit Function
                                        End If
                                     End If
                                 End If
                             End If
                        End If
                        'end 2019/01/10
                     End If
                     ChkAttFileName = True
               End If
       'Added by Lydia 2022/06/28 XML檔
       ElseIf Right(cName, Len(".XML")) = ".XML" Then
               If InStr(cName, ".FIX.SEQ.") > 0 Then  '最終版序列表
                  'Modify By Sindy 2025/10/27
                  If bolSendDate = True Then '須檢查有送件日者
                  '2025/10/27 END
                     cName = Mid(cName, 1, InStr(cName, ".FIX.SEQ.") - 1)
                     If cName <> m_CP01 & m_CP02 And cName <> m_CP01 & Val(m_CP02) Then
                        If InStr(cName, "-") = 0 Then
                            GoTo HelpMsg
                        Else
                            cName = Mid(cName, InStr(cName, "-") + 1)
                            If Len(cName) > 7 Then
                               GoTo HelpMsg
                            Else
                               If ChkDate(cName, False) = False Then
                                   GoTo HelpMsg
                               ElseIf ChkWorkDay(TransDate(cName, 2)) = False Then
                                   MsgBox "檔名的送件日非工作天！", vbCritical
                                   Exit Function
                               End If
                            End If
                        End If
                     End If
                  End If
                  ChkAttFileName = True
               End If
       'end 2022/06/28
       End If
    
    'Added by Lydia 2020/01/20 檔名不可超過100字元
    If CheckLengthIsOK(cName, 95) = False Then  '保留案件性質的長度
        MsgBox "檔名不可超過95字元！", vbCritical
        ChkAttFileName = False
    End If
    
'Added by Lydia 2018/12/27
    Exit Function
    
HelpMsg:
   'Modified by Lydia 2019/01/10
   'MsgBox "最終版本中說word應為劃線版，" & vbCrLf & "請自行命名為" & m_PA(1) & m_PA(2) & "-送件日(民國年).FIX_U.doc 或docx", vbCritical
   'Modified by Lydia 2021/04/19
   'MsgBox "請先確認年月日是否正確！" & vbCrLf & vbCrLf & "最終版本中說Word：" & vbCrLf & "請自行命名為" & m_Pa(1) & m_Pa(2) & "-送件日(民國年).FIX_U.doc 或docx" & vbCrLf & vbCrLf & _
                "最終版本圖式PDF：" & vbCrLf & "請自行命名為" & m_Pa(1) & m_Pa(2) & "-送件日(民國年).FIG.PDF ", vbCritical
   'Modify By Sindy 2025/10/27
   If bolSendDate = False Then
      MsgBox "最終版本中說：" & vbCrLf & "請自行命名為" & m_CP01 & m_CP02 & ".FIX_U.、" & m_CP01 & m_CP02 & ".FIX." & vbCrLf & vbCrLf & _
             "最終版本圖式PDF：" & vbCrLf & "請自行命名為" & m_CP01 & m_CP02 & ".FIG.PDF ", vbCritical
   Else '須檢查有送件日者
   '2025/10/27 END
      MsgBox "請先確認年月日是否正確！" & vbCrLf & vbCrLf & "最終版本中說：" & vbCrLf & "請自行命名為" & m_CP01 & m_CP02 & "-送件日(民國年).FIX_U.、" & m_CP01 & m_CP02 & "-送件日(民國年).FIX." & vbCrLf & vbCrLf & _
             "最終版本圖式PDF：" & vbCrLf & "請自行命名為" & m_CP01 & m_CP02 & "-送件日(民國年).FIG.PDF ", vbCritical
   End If
End Function

'Added by Lydia 2025/10/30 判斷畫面所有文字框/或是語法是否包含SQL的保留文字=>配合DML_Log(Pub_SeekTbLog)的詳細記錄
Public Function PUB_FilterSeekSQL(Optional ByVal pstrSql As String, Optional ByRef prevForm As Form, Optional strNotFilterText As String = "") As Boolean
   Dim intN As Integer, intW As Integer
   Dim bolDesc As Boolean
   Dim oObj As Object
   Dim varTemp As Variant, bolNotFilter As Boolean, ii As Integer
   Dim strFieldN As String, intIdx As Integer '文字框陣列名稱/Index
   
On Error GoTo HndErr
   PUB_FilterSeekSQL = False
   If Trim(pstrSql) = "" And UCase(TypeName(prevForm)) = "NOTHING" Then
      Exit Function
   End If
   
   bolDesc = False
   If pstrSql <> "" Then   '傳入語法
      '參考DML_Log(Pub_SeekTbLog)的判斷
      If InStr(1, UCase(Trim(pstrSql)), "UPDATE NEXTPROGRESS ") > 0 And InStr(1, UCase(Trim(pstrSql)), "SELECT") = 0 And InStr(1, UCase(pstrSql), UCase(strNpSqlOfNoSalesDuty)) > 0 Then
         bolDesc = True
      End If
      If bolDesc = False Then
         Select Case Mid(UCase(Trim(pstrSql)), 1, 6)
            Case "UPDATE", "DELETE"
                intN = InStr(1, UCase(Trim(pstrSql)), " IN ")
                intW = InStrRev(UCase(Trim(pstrSql)), " WHERE ") '先預設變更的內容有Where的情況
                If intN > 0 And intW > 0 And intN > intW Then
                   bolDesc = True
                End If
                'Modified by Lydia 2025/11/03 調整參考:frm075004_2若有更改承辦人, 則更新ENG的核稿人=>UPDATE ENGINEERPROGRESS SET EP04=(SELECT PP04 FROM CASEPROGRESS,PROMOTERPROOFREADER WHERE ...
                'intN = InStr(1, UCase(Trim(pstrSql)), "SELECT")
                'If intN > 0 And intW > 0 And intN > intW Then
                intN = InStr(1, UCase(Trim(pstrSql)), "SELECT ")
                If intN > 0 And intW > 0 Then
                   bolDesc = True
                End If
            Case "INSERT"
                'Modified by Lydia 2025/11/03 調整參考: SELECT+空白, FROM+空白
                intN = InStr(1, UCase(Trim(pstrSql)), "SELECT ")
                intW = InStr(1, UCase(Trim(pstrSql)), "FROM ")
                If intN > 0 And intW > 0 Then
                   bolDesc = True
                End If
         End Select
      End If
   Else  '判斷畫面所有文字框
      varTemp = Split(strNotFilterText, ",")
      For Each oObj In prevForm.Controls
         If TypeName(oObj) = "TextBox" Then
            If oObj.Text <> "" And oObj.Locked = False And oObj.Enabled = True Then
               '比對是否為不過濾的文字框
               bolNotFilter = False
               If strNotFilterText <> "" Then
                  For ii = 0 To UBound(varTemp)
                     If UCase(oObj.Name) = UCase(varTemp(ii)) Then
                        bolNotFilter = True
                        Exit For
                     ElseIf InStr(varTemp(ii), "(") > 0 And InStr(varTemp(ii), ")") > 0 Then
                        strFieldN = Mid(varTemp(ii), 1, InStr(varTemp(ii), "(") - 1)
                        intIdx = Val(Mid(varTemp(ii), InStr(varTemp(ii), "(") + 1, InStr(varTemp(ii), ")") - 1))
                        If UCase(oObj.Name) = UCase(strFieldN) Then
                           If oObj.Index = intIdx Then
                               bolNotFilter = True
                               Exit For
                           End If
                        End If
                     End If
ReadNext:
                  Next ii
               End If
               If bolNotFilter = False Then
                  If InStr(1, UCase(Trim(oObj.Text)), " IN ") > 0 Then
                     bolDesc = True
                  End If
               End If
            End If
         End If
      Next
   End If
   PUB_FilterSeekSQL = bolDesc
   
   Exit Function
HndErr:
   If Err.Number = 343 Then
      GoTo ReadNext
   End If

End Function

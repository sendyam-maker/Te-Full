Attribute VB_Name = "basUpdate"
'Memo By Sindy 2012/12/5 智權人員欄已修改
'Memo By Sindy 2011/2/15 SQLDate已檢查
'Memo By Sindy 2010/8/4 日期欄已修改
Option Explicit

Public Const 曠職以分計啟用日 = 20250908 'Added by Morgan 2025/8/14
Public Const 台灣案所限新規則啟用日 = 20141101 'Add by Morgan 2014/10/2
Public Const 專利發明人檔啟用日 = 20141213 'Add by Sindy 2014/11/7
Public Const 外專台灣案所限新規則啟用日 = 20190715 'Add by Morgan 2019/7/11
Public Const 外專台灣案約定期限啟用日 = 20210801 'Add by Sindy 2021/4/23
Public Const CFP業務區劃分啟用日 = 20200401 'Added by Lydia 2020/03/05
Public Const 指定日期啟用日 = 20240117 'Added by Morgan 2023/11/10
Public Const P業務區劃分啟用日 = 20250211 'Added by Morgan 2024/12/16
Public pub_PMan As String  'Added by Morgan 2025/2/19 此變數預設73022，游協理工作交接日後改82026
'Added by Morgan 2025/2/27
Public Const 不寄官方收據 As String = "1"
Public Const 勾選讀取回條 As String = "2"
'end 2025/2/27

'Added by Morgan 2016/6/3
Private Type BrowseInfo
   hwndOwner As Long
   pIDLRoot As Long
   pszDisplayName As String
   lpszTitle As String
   ulFlags As Long
   lpfnCallback As Long
   lParam As Long
   iImage As Long
End Type

Private Const BIF_RETURNONLYFSDIRS = &H1
Private Const BIF_DONTGOBELOWDOMAIN = &H2
Private Const BIF_STATUSTEXT = &H4
Private Const BIF_RETURNFSANCESTORS = &H8
Private Const BIF_EDITBOX = &H10
Private Const BIF_VALIDATE = &H20
Private Const BIF_NEWDIALOGSTYLE = &H40
Private Const BIF_USENEWUI = (BIF_NEWDIALOGSTYLE Or BIF_EDITBOX)
Private Const BIF_BROWSEINCLUDEURLS = &H80
Private Const BIF_UAHINT = &H100
Private Const BIF_NONEWFOLDERBUTTON = &H200
Private Const BIF_NOTRANSLATETARGETS = &H400
Private Const BIF_BROWSEFORCOMPUTER = &H1000
Private Const BIF_BROWSEFORPRINTER = &H2000
Private Const BIF_BROWSEINCLUDEFILES = &H4000
Private Const BIF_SHAREABLE = &H8000
Private Const MAX_PATH = 260
Private Const WM_USER = &H400
Private Const BFFM_INITIALIZED = 1
Private Const BFFM_SELCHANGED = 2
Private Const BFFM_SETSTATUSTEXT = (WM_USER + 100)
Private Const BFFM_SETSELECTION = (WM_USER + 102)

Private Declare Function SHGetPathFromIDList Lib "SHELL32.DLL" Alias "SHGetPathFromIDListA" (ByVal pidl As Long, ByVal pszPath As String) As Long
Private Declare Function SHBrowseForFolder Lib "SHELL32.DLL" Alias "SHBrowseForFolderA" (lpBrowseInfo As BrowseInfo) As Long
Private Declare Sub CoTaskMemFree Lib "ole32.dll" (ByVal pv As Long)
Private Declare Function SendMessage Lib "user32" Alias "SendMessageA" (ByVal hWnd As Long, ByVal wMsg As Long, ByVal wParam As Long, ByVal lParam As String) As Long

Private mstrSTARTFOLDER As String
'end 2016/6/3

'Added by Morgan 2025/7/18
Public Declare Function SystemTimeToFileTime Lib "kernel32" (lpSystemTime As SYSTEMTIME, lpFileTime As FILETIME) As Long
Public Declare Function SetFileTime Lib "kernel32" (ByVal hFile As Long, lpCreationTime As Any, lpLastAccessTime As Any, lpLastWriteTime As Any) As Long
Public Const OF_READWRITE = &H2
'end 2025/7/18

'Added by Lydia 2016/06/02
Public TMQ_近似1 As String  '結果與本所案相同(代號)
Public TMQ_近似2 As String    '結果與本所案近似(代號)
Public TMQ_近似T1 As String '結果與本所案相同(文字)
Public TMQ_近似T2 As String   '結果與本所案近似(文字)
Public TMQ_不查 As String   '(代號)
Public TMQ_無 As String 'Added by Lydia 2016/07/06 (代號)
'Added by Lydia 2024/11/11 查名單(網中)
Public Const 查名單網中系統平行測試 As String = "20290531" '在正式上線前，新舊查名單同時進行商標查名作業 '1234
Public Const 查名單網中系統啟用日 As String = "20990531" '正式啟用後，舊查名單不再新增記錄
'end 2024/11/11
Public Const 本所D類收文啟用日 = 20170101 'Added by Lydia 2016/12/22
Public Const FMP管制人啟用日 = 20170217  'Added by Lydia 2017/02/16
Public Const CR_NewDate As String = "20170818" 'Added by Lydia 2017/08/09 往來記錄的移檔日期
Public bolTheSame As Boolean 'Move by Lydia 2017/10/17 再確認輸入(從frm880004)
Public Const FCP案件命名啟用日 = 20180305 'Added by Lydia 2017/11/14 預設FCP案件命名電子化啟用日
'Public Const T案收文齊備排除 As String = "303,206,310" 'Added by Lydia 2018/12/10 T案收文齊備: 延期303、放棄專用權206、暫緩審理310不必填「文件是否齊備」'Mark by Lydia 2019/04/10 移到basQuery
Public Const T案收文齊備啟用日 = 20190410 'Added by Lydia 2018/12/10 預設T案收文齊備啟用日'Modified by Lydia 2019/04/08 預設4/10啟用
Public Const cHPZipPwd As String = "HPCOMPANY" 'Added by Morgan 2020/7/10
Public Const B2律師費 As Integer = 5000 'Added by Lydia 2022/12/01 改成常數
Public Const 非B2律師費 As Integer = 15000 'Added by Lydia 2022/12/01 改成常數
'Add By Sindy 2020/7/15 列印收據
Dim Px() As Integer, Py() As Integer, Py_t() As Integer, TwPerCm As Integer, iLineHeight As Integer
'Add By Sindy 2022/1/26 PUB_PrintCaseReceipt_2 使用
Dim m_intTimes As Integer '列印次數
Dim m_strNo As String
Dim m_bolIsTT9 As Boolean
Dim m_CU173 As String
Dim m_CU11 As String 'Add By Sindy 2022/9/8
Dim m_intRecPos As Integer '目前指向第幾筆資料
Public Const m_intRecMaxItem = 6 '收據帳款類別總項數
Dim m_strItemDesc(1 To 6)  As String '帳款類別
Dim m_strAmount1(1 To 6) As String
Dim m_strAmount2(1 To 6) As String
Dim m_lngAmount1 As Long '服務費累計
Dim m_lngAmount2 As Long '規費累計
Dim m_strNote1 As String, m_strNote2 As String
Dim m_strCustCaseNo As String '客戶案件案號
'2022/1/26 END
Public Const cntEPC新案發文不須提供前案 = "011,012,020,101,201,205,206,211,214,216" 'Added by Lydia 2022/04/18
Public Const 專利進度註冊費已發文語法 = "And cp10(+)='601' And cp158(+)<>0 And pa01=cp01(+) And pa02=cp02(+) And pa03=cp03(+) And pa04=cp04(+) " 'Add by Amy 2023/03/06
Public Const cntTQC自動記錄 = "AAAAAAAA" 'Added by Lydia 2023/08/18
Public Const CFP分割案抓母案期限的性質 = "107,601,208,501,126,438,424" 'Added by Morgan 2024/6/14
Public Const cntFrm040303New As String = "Y" 'Added by Lydia 2025/06/20 內專通知函之繳年費/實體審查通知函：例外通知的程式調整 'Memo by Lydia 2025/07/25 上線日期114/7/28
Public Const 內專本所約定期限啟用日 = 20251030  'Added by Lydia 2025/09/24 內專P案從法定期限取得本所期限、約定期限---啟用日設定為10/30

Public Sub Pub_CheckSysVer()
Dim strFileName As String
Dim strvar As String
Dim strOldVer As String '舊的版本資訊
Dim strNewVer As String '新的版本資訊
Dim blnOldVerExist As Boolean '本機的版本資訊檔案是否存在
Dim blnNewVerExist As Boolean 'Server的版本資訊檔案是否存在

On Error GoTo ErrorHandler

'刪除記錄檔
Pub_DeleteLogFile

'判斷是否有其他專案正在更新
If GetSetting("UpdSys", "Update", "ExcUpdate", "False") = "True" Then
   '寫入Log檔
   Pub_WriteSysLog GetSetting("UpdSys", "Update", "ExcUpdate", "") & _
                     "目前正在執行更新動作, 請稍候再執行" & App.EXEName & "..."
   pub_bln_NeedUpdate = False
   Exit Sub
End If

'讀取本機WIN系統路徑
If PUB_GetMyComputerSysPath <> 0 Then
   '寫入Log檔
   Pub_WriteSysLog "讀取與記錄本機WinSysPath失敗..."
   pub_bln_NeedUpdate = False
   Exit Sub
End If

'讀取本機的版本資訊檔
blnOldVerExist = False
If ReadMyComputerVerFile(strFileName, strOldVer) = 0 Then
   '讀取本機的版本資訊檔
   blnOldVerExist = True
   '寫入Log檔
   Pub_WriteSysLog "本機上版本資訊檔案讀取成功..."

   '讀取Server的版本資訊檔
   blnNewVerExist = False
   If ReadServerVerFile(strFileName, strNewVer) = 0 Then
      '讀取本機的版本資訊檔
      blnNewVerExist = True
      '寫入Log檔
      Pub_WriteSysLog "Server上版本資訊檔案讀取成功..."
   '讀取失敗
   Else
      pub_bln_NeedUpdate = False
      '寫入Log檔
      Pub_WriteSysLog "Server上版本資訊檔案讀取失敗, 無法執行更新動作..."
      Exit Sub
   End If

'讀取失敗
Else
   '寫入Log檔
   Pub_WriteSysLog "本機上版本資訊檔案讀取失敗, 無法執行更新動作..."
End If

''若本機版本資訊檔讀取失敗, 而Server上版本資訊檔讀取成功
'If blnNewVerExist = True And blnOldVerExist = False Then
'   '寫入Log檔
'   Pub_WriteSysLog "本機版本資訊檔讀取失敗, 而Server上版本資訊檔讀取成功..."
'   '寫入Log檔
'   Pub_WriteSysLog "準備執行更新動作..."
'   '執行更新動作
'   Shell App.Path & "\UpdSys.exe", vbNormalFocus
'   DoEvents
'   pub_bln_UpdateActive = True
'   '寫入Log檔
'   Pub_WriteSysLog "更新動作執行中..."
'   Exit Sub
'End If

'若版本資訊不符
If strOldVer <> strNewVer Then
   '寫入Log檔
   Pub_WriteSysLog "版本資訊不符<舊 : " & strOldVer & " ; 新 : " & strNewVer & ">..."
   '寫入Log檔
   Pub_WriteSysLog "準備執行更新動作..."
   '執行更新動作
   SHELL App.path & "\UpdSys.exe", vbNormalFocus
   DoEvents
   pub_bln_UpdateActive = True
   '寫入Log檔
   Pub_WriteSysLog "更新動作執行中..."
Else
   pub_bln_NeedUpdate = False
   '寫入Log檔
   Pub_WriteSysLog "版本資訊相符不需執行更新動作..."
End If

Exit Sub

ErrorHandler:
pub_bln_NeedUpdate = False
'寫入Log檔
Pub_WriteSysLog "<" & Err.Number & ">" & Err.Description & " , 無法執行更新動作..."
End Sub

'Memo by Lydia 2020/03/19 刪除檔案：刪除執行檔的Log.txt
Public Sub Pub_DeleteLogFile()

On Error Resume Next

Kill App.path & "\Log_" & App.EXEName & ".txt"
If Err.Number <> 0 Then Err.Clear

End Sub

'讀取本機Ver.ini
Private Function ReadMyComputerVerFile( _
         ByRef strFileName As String, _
         ByRef strOldVer As String) As Long
Dim strvar As String

On Error GoTo ErrorHandler
ReadMyComputerVerFile = -1
strFileName = App.path & "\" & App.EXEName & "Ver.ini"
'寫入Log檔
Pub_WriteSysLog "準備開啟Client端" & App.EXEName & "Ver.ini..."
Open strFileName For Input Access Read As #9
'寫入Log檔
Pub_WriteSysLog "正確開啟Client端" & App.EXEName & "Ver.ini..."
strFileName = ""
'將重要資訊寫入登錄檔
SaveSetting "UpdSys", "Update", "PrjName", App.EXEName
'SaveSetting "UpdSys", "Update", "ExcUpdate", "True"
'寫入Log檔
Pub_WriteSysLog "目前準備更新的專案系統為" & App.EXEName & "..."
Do Until EOF(9)
   Line Input #9, strvar
   If Len(strvar) > 0 Then
      If Left(strvar, 1) <> "#" Then
         Select Case Left(strvar, 1)
            Case "1" '版本序號
               strOldVer = Right(strvar, Len(strvar) - 2)
               '寫入Log檔
               Pub_WriteSysLog "1.讀取Client端的版本序號..."
            Case "2" 'XXXVer.ini來源目錄及檔名
               strFileName = Right(strvar, Len(strvar) - 2)
               '將重要資訊寫入登錄檔
               SaveSetting App.EXEName, "ForUpdate", "VerPathFileName", strFileName
               '寫入Log檔
               Pub_WriteSysLog "2.記錄Server端" & App.EXEName & "Ver.ini的路徑..."
         End Select
      End If
   End If
Loop
Close #9
ReadMyComputerVerFile = 0
'寫入Log檔
Pub_WriteSysLog "關閉Client端" & App.EXEName & "Ver.ini..."
Exit Function

ErrorHandler:
'寫入Log檔
Pub_WriteSysLog "<" & Err.Number & ">" & Err.Description
End Function

Private Function ReadServerVerFile( _
         ByRef strFileName As String, _
         ByRef strNewVer As String)
Dim strvar As String

On Error GoTo ErrorHandler
'寫入Log檔
Pub_WriteSysLog "準備開啟Server端" & App.EXEName & "Ver.ini..."
Open strFileName For Input Access Read As #9
'寫入Log檔
Pub_WriteSysLog "正確開啟Server端" & App.EXEName & "Ver.ini..."
Do Until EOF(9)
   Line Input #9, strvar
   If Len(strvar) > 0 Then
      If Left(strvar, 1) <> "#" Then
         Select Case Left(strvar, 1)
            Case "1" '版本序號
               strNewVer = Right(strvar, Len(strvar) - 2)
               '寫入Log檔
               Pub_WriteSysLog "1.讀取Server端的版本序號..."
            Case "3" 'XXXUpd.ini來源目錄及檔名
               SaveSetting App.EXEName, "ForUpdate", "UpdPathFileName", Right(strvar, Len(strvar) - 2)
               '寫入Log檔
               Pub_WriteSysLog "3.記錄Server端" & App.EXEName & "Upd.ini的路徑..."
            Case "4" '更新檔案的來源目錄
               SaveSetting App.EXEName, "ForUpdate", "SourcePath", Right(strvar, Len(strvar) - 2)
               '寫入Log檔
               Pub_WriteSysLog "4.記錄Server端各個更新檔案的路徑..."
         End Select
      End If
   End If
Loop
Close #9
'寫入Log檔
Pub_WriteSysLog "關閉Server端" & App.EXEName & "Ver.ini..."
Exit Function

ErrorHandler:
'寫入Log檔
Pub_WriteSysLog "<" & Err.Number & ">" & Err.Description
End Function

'Remove by Morgan 2011/3/25 改由 trigger 更新
''Add by Morgan 2005/3/3 更新計件值
''p_CP09 總收文號,p_CP97 承辦計件值,p_CP100 草圖計件值,p_CP103 墨圖計件值
'Public Function PUB_UpdateCaseValue(ByRef p_CP09 As String, Optional ByRef p_bolUpdate As Boolean = True, Optional ByRef p_CP97 As String, Optional ByRef p_CP100 As String, Optional ByRef p_CP103 As String) As Boolean
'
''Add by Morgan 2005/4/13 改由 trigger 更新
'   PUB_UpdateCaseValue = True
'   Exit Function
''2005/4/13 end
'
'   Dim bolCaseMap As Boolean
'
'   strSql = " SELECT CP01,CP02,CP03,CP04,CP05,CP10,CP13,CP18,CP21,cp26,CP106" & _
'      ",EP20,EP26,EP29,CPM06,CPM14,CPM15,PA08" & _
'      " FROM caseprogress,ENGINEERPROGRESS, CASEPROPERTYMAP,patent" & _
'      " where cp09=" & CNULL(p_CP09) & " AND EP02=CP09 AND CPM01(+)=CP01 AND CPM02(+)=CP10" & _
'      " AND PA01(+)=CP01 AND PA02(+)=CP02 AND PA03(+)=CP03 AND PA04(+)=CP04"
'
'   CheckOC3
'   With AdoRecordSet3
'      .CursorLocation = adUseClient
'      .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
'      If .RecordCount > 0 Then
'         'CP97 承辦人計件值
'         '預設抓案件性質
'         p_CP97 = "" & .Fields("CPM06")
'         'CFP
'         If .Fields("CP01") = "CFP" Then
'               '多國案的第二國起每件0.2,(設計=0)
'               If "" & .Fields("CP21") = "Y" Then
'                  'add by nickc 2005/04/04 若是算案件，以案件性質算
'                  If .Fields("CP26") = "N" Then
'                        If .Fields("PA08") = "3" Then
'                           p_CP97 = "0"
'                        Else
'                           p_CP97 = "0.2"
'                        End If
'                  End If
'               '設計分割案(307)以設計計件(103)
'               ElseIf "" & .Fields("PA08") = "3" And .Fields("CP10") = "307" Then
'                  strSql = "SELECT CPM06 FROM CASEPROPERTYMAP WHERE CPM01='CFP' AND CPM02='103'"
'                  CheckOC2
'                  adoRecordset1.CursorLocation = adUseClient
'                  adoRecordset1.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
'                  If adoRecordset1.RecordCount > 0 Then
'                     p_CP97 = "" & adoRecordset1.Fields("CPM06")
'                  End If
'               End If
'         End If
'
'         '判斷是否為國內外案
'         bolCaseMap = False
'         strSql = "SELECT 1 FROM CASEMAP WHERE CM01='" & .Fields("CP01") & "' AND CM02='" & .Fields("CP02") & "' AND CM03='" & .Fields("CP03") & "' AND CM04='" & .Fields("CP04") & "' AND CM10='0'"
'         CheckOC2
'         adoRecordset1.CursorLocation = adUseClient
'         adoRecordset1.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
'         If adoRecordset1.RecordCount > 0 Then
'            bolCaseMap = True
'         End If
'
'         'CP100 草圖計件值
'         '草圖計件
'         If "" & .Fields("EP20") = "" Then
'            '1.判斷案件性質
'            If "" & .Fields("CPM14") <> "" Then
'               p_CP100 = .Fields("CPM14")
'            '2.多國案
'            ElseIf "" & .Fields("CP21") = "Y" Then
'               p_CP100 = "0.6"
'            '3.國內外案且為新申請案
'            ElseIf bolCaseMap = True And ((Val(.Fields("CP10")) >= 101 And Val(.Fields("CP10")) <= 105) Or (Val(.Fields("CP10")) >= 108 And Val(.Fields("CP10")) <= 115) Or (Val(.Fields("CP10")) = 117)) Then
'               p_CP100 = "0.6"
'            '4.客戶提供圖檔
'            ElseIf "" & .Fields("CP106") = "Y" Then
'               p_CP100 = "0.6"
'            Else
'               p_CP100 = "1"
'            End If
'         Else
'            p_CP100 = "0"
'         End If
'
'         'CP103 墨圖計件值
'         If "" & .Fields("EP29") = "" Then
'            '1.判斷案件性質
'            If "" & .Fields("CPM15") <> "" Then
'               p_CP103 = .Fields("CPM15")
'            '2.多國案
'            ElseIf "" & .Fields("CP21") = "Y" Then
'               p_CP103 = "0.6"
'            '3.國內外案且為新申請案
'            ElseIf bolCaseMap = True And ((Val(.Fields("CP10")) >= 101 And Val(.Fields("CP10")) <= 105) Or (Val(.Fields("CP10")) >= 108 And Val(.Fields("CP10")) <= 115) Or (Val(.Fields("CP10")) = 117)) Then
'               p_CP103 = "0.4"
'            '4.照相
'            ElseIf Left("" & .Fields("EP26"), 2) = "照相" Then
'               p_CP103 = "0.5"
'            '5.客戶提供圖檔
'            ElseIf "" & .Fields("CP106") = "Y" Then
'               p_CP103 = "0.6"
'            Else
'               p_CP103 = "1"
'            End If
'         Else
'            p_CP103 = "0"
'         End If
'         If p_bolUpdate = True Then
'            strSql = "Update CaseProgress Set CP97=" & p_CP97 & ", CP100=" & p_CP100 & ", CP103=" & p_CP103 & " Where CP09='" & p_CP09 & "'"
'            cnnConnection.Execute strSql
'         End If
'      End If
'      PUB_UpdateCaseValue = True
'   End With
'
'End Function

'Remove by Morgan 2011/3/25 改由 trigger 更新
''Add by Morgan 2005/3/10 以本所號更新
'Public Function PUB_UpdateCaseValueA(ByRef p_PA() As String) As Boolean
'
'   'edit by nickc 2005/03/17 加判斷未發文未取消收文
'   'StrSql = "SELECT CP09 FROM CASEPROGRESS" & _
'      " WHERE CP01='" & p_PA(1) & "' AND CP02='" & p_PA(2) & "' AND CP03='" & p_PA(3) & "' AND CP04='" & p_PA(4) & "'"
'   strSql = "SELECT CP09 FROM CASEPROGRESS" & _
'      " WHERE CP01='" & p_PA(1) & "' AND CP02='" & p_PA(2) & "' AND CP03='" & p_PA(3) & "' AND CP04='" & p_PA(4) & "' and cp27 is null and cp57 is null "
'
'   CheckOC
'   With adoRecordset
'      .CursorLocation = adUseClient
'      .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
'      If .RecordCount > 0 Then
'         Do While Not .EOF
'            Call PUB_UpdateCaseValue(.Fields("CP09"))
'            .MoveNext
'         Loop
'      End If
'   End With
'   PUB_UpdateCaseValueA = True
'
'End Function

'Add by Morgan 2005/3/4 新增FLAGSTORY
'p_FS01 總收文號,p_FS04=1.承辦;2.草圖;3.墨圖,p_FS05 原加乘註記,p_FS06 修改後加乘註記,p_FS07 理由
Public Function PUB_InsFlagStory(ByRef p_FS01 As String, ByRef p_FS04 As String, ByRef p_FS05 As String, ByRef p_FS06 As String, ByRef p_FS07 As String) As Boolean

   strSql = "insert into flagstory(FS01,FS02,FS03,FS04,FS05,FS06,FS07,FS08)" & _
      " values ('" & p_FS01 & "',TO_NUMBER(TO_CHAR( SYSDATE,'YYYYMMDD')),TO_NUMBER(TO_CHAR( SYSDATE,'HH24MISS'))" & _
      ",'" & p_FS04 & "'," & p_FS05 & "," & p_FS06 & ",'" & p_FS07 & "','" & strUserNum & "')"
      
   cnnConnection.Execute strSql
   
End Function
'Add by Morgan 2005/3/9
'批次更新計件值，加乘註記資料
'所有未發文未取消收文或94年已發文資料
Public Function PUB_BatchUpdate(Optional p_Systems As String = "'P','CFP','PS','CPS'") As Boolean
  
   Dim stCP97 As String, stCP98 As String, stCP100 As String, stCP101 As String, stCP103 As String, stCP104 As String
   
   strSql = "select CP09 from caseprogress " & _
      " where cp27>20050000 AND CP01 IN (" & p_Systems & ") AND CP57 IS NULL and CP97 IS NULL" & _
      " Union All" & _
      " select cp09 from caseprogress" & _
      " where cp27 is null AND CP01 IN (" & p_Systems & ") AND CP57 IS NULL and CP97 IS NULL"
      
On Error GoTo ErrHnd

   CheckOC
   With adoRecordset
      .CursorLocation = adUseClient
      .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      If .RecordCount > 0 Then

         Do While Not .EOF
            Call PUB_GetFlagValue(.Fields("CP09"), stCP98, stCP101, stCP104)
            'Call PUB_UpdateCaseValue(.Fields("CP09"), False, stCP97, stCP100, stCP103) 'Remove by Morgan 2005/4/13 改由 trigger 更新
            strSql = "Update CaseProgress SET" & _
               " CP97=" & stCP97 & ",CP98=" & stCP98 & ",CP100=" & stCP100 & ",CP101=" & stCP101 & ",CP103=" & stCP103 & ",CP104=" & stCP104 & _
               " Where CP09='" & .Fields("CP09") & "'"
            cnnConnection.Execute strSql
            .MoveNext
         Loop
      End If
   End With
   PUB_BatchUpdate = True
   
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
   
End Function

'Add by Morgan 2005/3/15 大陸設計且無繪圖人員時帶國內案繪圖人員
'2009/2/2 MODIFY BY SONIA 不限制設計 P-090127
'p_EP02=國外案收文號, p_CP(1~4)=國內案號
Public Function PUB_UpdateEP13(ByRef p_EP02 As String, ByRef p_CP() As String) As Boolean
   
   'Modified by Morgan 2018/7/27 繪圖人員離職時不更新--EX:P-120775
   strSql = "SELECT CP29 FROM CASEPROGRESS,STAFF" & _
      " WHERE CP01='" & p_CP(1) & "' AND CP02='" & p_CP(2) & "'" & _
      " AND CP03='" & p_CP(3) & "' AND CP04='" & p_CP(4) & "'" & _
      " AND CP10 in ('101','102','103','104','105','125','201') AND CP57 IS NULL" & _
      " AND CP29 IS NOT NULL AND ST01(+)=CP29 AND ST04='1' "
         
   CheckOC
   With adoRecordset
      .CursorLocation = adUseClient
      .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      If .RecordCount > 0 Then
         If "" & .Fields(0) <> "" Then
            'Modify by Morgan 2005/6/28 改更新CP29由TRIGGER回寫EP13以免不同步
'            strSQL = "UPDATE ENGINEERPROGRESS SET EP13='" & .Fields(0) & "'" & _
'               " WHERE EP02='" & p_EP02 & "' AND EP13 IS NULL"
            strSql = "UPDATE CASEPROGRESS SET CP29='" & .Fields(0) & "'" & _
               " WHERE CP09='" & p_EP02 & "' AND CP29 IS NULL"
            cnnConnection.Execute strSql
         End If
         
         'Remove by Morgan 2011/5/4 改都要計件
         ''2005/4/19 ADD BY SONIA 再控制國外案為大陸設計有國內案時,草圖及墨圖都不計件
         'strSql = "UPDATE ENGINEERPROGRESS SET EP20='N',EP29='N'" & _
         '   " WHERE EP02='" & p_EP02 & "'"
         ''Add by Morgan 2005/4/25 大陸設計才要
         'strSql = strSql & " and exists(SELECT * FROM CASEPROGRESS WHERE CP09=EP02 AND CP01='P')"
         'cnnConnection.Execute strSql
         ''2005/4/19 END
         'end 2011/5/4
      End If
   End With
   PUB_UpdateEP13 = True
   
End Function

'Add by Morgan 2008/6/16
'新增表單執行記錄
Public Sub PUB_AddExcuteLog(p_FormName As String)
   Dim stSQL As String, intR As Integer
   stSQL = "insert into ExecuteLog values('" & p_FormName & "','" & strUserNum & "'," & strSrvDate(1) & ",to_char(sysdate,'HH24MiSS'))" & _
      ""
On Error GoTo ErrHnd
   cnnConnection.Execute stSQL, intR
   Exit Sub
   
ErrHnd:
   If Err.Number = -2147217873 Then
      Err.Clear
   Else
      MsgBox Err.Description, vbCritical
   End If
End Sub

'Add by Morgan 2008/8/29 從CFP分案抽來共用
'1.更新主張優先權期限
'2.更新新案期限
'Modified by Lydia 2023/03/25 +回傳訊息pMsgTxt
Public Sub PUB_UpdCfpDate1(ByVal p_PA01 As String, ByVal p_PA02 As String, ByVal p_PA03 As String, ByVal p_PA04 As String, Optional ByVal p_bUpdateNext As Boolean, Optional ByRef pMsgTxt As String)
   Dim stSQL As String, adoRst As ADODB.Recordset, intR As Integer, adoRst2 As ADODB.Recordset
   Dim PA08 As String, PA09 As String, PA46 As String, CP09 As String, PD05 As String, PD08s As String
   Dim iM As Integer, WorkDate1 As String, WorkDate2 As String
   Dim bolFMP As Boolean, cp05 As String
   Dim CP09_2 As String 'Added by Morgan 2014/6/9
   Dim mPD06 As String, mCP10 As String 'Add by Lydia 2014/10/15 台灣(P)主張國內優先權(121)，提申期限以母案之審查意見(1202)通知之期限為準

   'Modify by Morgan 2010/8/9 改 P 也可以用
   'If p_PA01 <> "CFP" Then GoTo SkipMe
   If Not (p_PA01 = "CFP" Or p_PA01 = "P") Then GoTo SkipMe
   pMsgTxt = "" 'Added by Lydia 2023/03/25
   
   'Modify by Morgan 2010/9/7 排除分割案--玲玲
   'Modified by Lydia 2014/10/15 +pd06,cp10; 台灣(P)主張國內優先權(121)，提申期限以母案之審查意見(1202)通知之期限為準
    stSQL = "select pa08,pa46,pd05,pd06,pd08,cp09,pa09,cp10,cp12,cp05 from patent,caseprogress,pridate" & _
      " where pa01='" & p_PA01 & "' and pa02='" & p_PA02 & "' and pa03='" & p_PA03 & "' and pa04='" & p_PA04 & "'" & _
      " and cp01='" & p_PA01 & "' and cp02='" & p_PA02 & "' and cp03='" & p_PA03 & "' and cp04='" & p_PA04 & "'" & _
      " and cp10 in ('106','121') and cp27 is null and cp57 is null" & _
      " and not exists(select * from caseprogress b where b.cp01=pa01 and b.cp02=pa02 and b.cp03=pa03" & _
      " and b.cp04=pa04 and b.cp10='307' and b.cp57 is null)" & _
      " and pd01(+)=pa01 and pd02(+)=pa02 and pd03(+)=pa03 and pd04(+)=pa04 order by pd05 asc"
      
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      With adoRst
         .MoveFirst
         PA08 = "" & .Fields("pa08")
         PA46 = "" & .Fields("pa46")
         CP09 = "" & .Fields("cp09")
         PD05 = "" & .Fields("pd05")
         'Add by Lydia 2014/10/15 台灣(P)主張國內優先權(121)，提申期限以母案之審查意見(1202)通知之期限為準
         If .Fields("cp10") = "121" Then 'Add by Lydia 2014/10/15 同時存在國內和國際優先權，需判斷
            mPD06 = "" & .Fields("pd06")
            mCP10 = "" & .Fields("cp10")
         End If
         
         PD08s = "" & .Fields("pd08")
         PA09 = "" & .Fields("pa09")
         'Add by Morgan 2010/8/9
         'Modified by Morgan 2021/2/2
         'If Left("" & .Fields("cp12"), 1) = "F" Then
         '   bolFMP = True
         'End If
         bolFMP = PUB_ChkIsFMP(p_PA01, p_PA02, p_PA03, p_PA04, PA09)
         'end 2021/2/2
         cp05 = "" & .Fields("cp05")
         'end 2010/8/9
         .MoveNext
         Do While Not .EOF
            'Add by Lydia 2014/10/15 台灣(P)主張國內優先權(121)，提申期限以母案之審查意見(1202)通知之期限為準
            If .Fields("cp10") = "121" Then  'Add by Lydia 2014/10/15 同時存在國內和國際優先權，需判斷
               mPD06 = "" & .Fields("pd06")
               mCP10 = "" & .Fields("cp10")
            End If
            
            If .Fields("cp09") <> CP09 Then CP09_2 = .Fields("cp09") 'Added by Morgan 2014/6/9
            If Not IsNull(.Fields("pd08")) Then
               PD08s = PD08s & "," & .Fields("pd08")
            End If
            .MoveNext
         Loop
      End With
      
      If PD05 = "" Then GoTo SkipMe
      
      'Modify by Morgan 2007/4/25 判斷非PCT案才要
      If PA46 <> "Y" Then
         'Modify by Morgan 2007/5/9
         '主張或被主張的若為設計時+6個月,其餘的+12個月
         If PA08 = "3" Or InStr(PD08s, "3") > 0 Then
            iM = 6
         Else
            iM = 12
         End If

         '法定期限
         WorkDate2 = DBDATE(CompDate(1, iM, Format(PD05)))
         If p_PA01 = "CFP" Then
'Modified by Morgan 2012/10/19 改呼叫公用函數
'            'Add by Morgan 2006/4/18
'            'Add by Morgan 2007/4/3 日本新型  本所=法定-14天
'            'Modify by Morgan 2009/4/16 +日本發明 --郭
'            'If PA09 = "011" And PA08 = "2" Then
'            '   WorkDate1 = PUB_GetWorkDay1(DBDATE(CompDate(2, -14, Format(WorkDate2))), True)
'            'Modify by Morgan 2010/4/9 將日本改為非英語系國家
'            If PA09 = "011" And PA08 = "3" Then
'               WorkDate1 = PUB_GetWorkDay1(DBDATE(CompDate(2, -7, Format(WorkDate2))), True)
'
'            '非英語系 本所=法定-14天
'            'Modify by Morgan 2011/7/20 改 21 天--郭
'            ElseIf InStr(NoneEngCountry, PA09) > 0 Then
'               'WorkDate1 = PUB_GetWorkDay1(DBDATE(CompDate(2, -14, Format(WorkDate2))), True)
'               WorkDate1 = PUB_GetWorkDay1(DBDATE(CompDate(2, -21, Format(WorkDate2))), True)
'            '其他 本所=法定-7天
'            Else
'               WorkDate1 = PUB_GetWorkDay1(DBDATE(CompDate(2, -7, Format(WorkDate2))), True)
'            End If
'            'End
            WorkDate1 = PUB_GetCP06byCP07(WorkDate2, PA09, PA08)
'end 2012/10/19
         'Add by Morgan 2010/8/9
         Else
            If PA09 = 台灣國家代號 Then
               WorkDate1 = PUB_GetWorkDay1(DBDATE(CompDate(2, -2, Format(WorkDate2))), True)
            Else
               If bolFMP Then
                  WorkDate1 = PUB_GetDeadLine(DBDATE(cp05), WorkDate2, 2)
               Else
                  WorkDate1 = DBDATE(CompDate(2, -7, Format(WorkDate2)))
                  WorkDate1 = PUB_GetWorkDay1(WorkDate1, True) 'Add by Morgan 2011/3/29
               End If
            End If
         End If
         
         'Added by Morgan 2012/11/20 若被主張優先權的案件有主張新穎性優惠期則不更新新案期限
         'Modified by Morgan 2016/11/28 美專新案收文日小於優惠期+1年才不更新--郭 Ex.CFP29093
         'Modified by Morgan 2016/12/5 不更新新案期限只限定美專(其他國家還是要更新) --郭
         stSQL = "select cp09 from pridate,patent,caseprogress where pd01='" & p_PA01 & "' and pd02='" & p_PA02 & "'" & _
            " and pd03='" & p_PA03 & "' and pd04='" & p_PA04 & "' and pa11(+)=pd06 and pa09(+)=pd07 and pa140>0" & _
            " and cp01(+)=pa01 and cp02(+)=pa02 and cp03(+)=pa03 and cp04(+)=pa04 and cp10='123' and cp57 is null" & _
            " and exists(select * from patent b where b.pa01=pd01 and b.pa02=pd02 and b.pa03=pd03 and b.pa04=pd04 and b.pa09='101')" & _
            " and exists(select * from caseprogress c where c.cp01(+)=pd01 and c.cp02(+)=pd02 and c.cp03(+)=pd03 and c.cp04(+)=pd04 and c.cp10 in ('101','108') and c.cp05<=to_char(add_months(to_date(pa140,'yyyymmdd'),12),'yyyymmdd'))"
         intR = 1
         Set adoRst2 = ClsLawReadRstMsg(intR, stSQL)
         If intR = 1 Then
            'Modified by Morgan 2014/6/9
            '會同時主張國內及國際優先權 Ex.CFP-26737
            'stSQL = "UPDATE CASEPROGRESS SET CP06=" & CNULL(WorkDate1) & ",CP07=" & CNULL(WorkDate2) & " WHERE CP09='" & CP09 & "'"
            stSQL = "UPDATE CASEPROGRESS SET CP06=" & CNULL(WorkDate1) & ",CP07=" & CNULL(WorkDate2) & " WHERE CP09='" & CP09 & "'" & IIf(CP09_2 <> "", " or CP09='" & CP09_2 & "'", "")
            cnnConnection.Execute stSQL, intR
            'end 2014/6/9
         Else
         'end 2012/11/20

             'Add by Lydia 2014/10/15 台灣(P)主張國內優先權(121)，提申期限以母案之審查意見(1202)通知之期限為準
            If PA09 = 台灣國家代號 And mCP10 = "121" And p_PA01 = "P" Then
               'Modified by Morgan 2021/3/15 抓最新收文之審查意見 Ex:P-126915 --韻丞
               'Modified by Lydia 2023/03/25 若母案的審查意見通知之期限已延過期，期限設定請以延期後的期限為後申請案的提申期限(下一程序期限) --玲玲
                                                            '下一程序未收文：直接抓下一程序；　已收文：抓NP24該收文是否有延期過
               'stSQL = " select cp06,cp07 from patent,caseprogress where cp01(+)=pa01 and cp02(+)=pa02 and cp03(+)=pa03 and cp04(+)=pa04 " & _
                      " and cp10='1202' and pa09='000' and pa11='" & mPD06 & "' order by cp05 desc"
               stSQL = "select pa01,pa02,pa03,pa04,decode(c2.cp06,null,c1.cp10,c2.cp10) cp10 " & _
                            ",decode(c2.cp06,null,c1.cp05,c2.cp05) cp05,decode(c2.cp06,null,c1.cp09,c2.cp09) cp09 " & _
                            ",nvl(c2.cp06,nvl(np08,c1.cp06)) as cp06,nvl(c2.cp07,nvl(np09,c1.cp07)) as cp07,np24 " & _
                            "from patent,caseprogress c1,nextprogress,caseprogress c2 where c1.cp01(+)=pa01 and c1.cp02(+)=pa02 and c1.cp03(+)=pa03 and c1.cp04(+)=pa04 " & _
                            "and c1.cp10='1202' and pa09='000' and pa11='" & mPD06 & "' and c1.cp09=np01(+) and c1.cp01=np02(+) and c1.cp02=np03(+) and c1.cp03=np04(+) and c1.cp04=np05(+) " & _
                            "and np24=c2.cp09(+) order by 6 desc"
               intR = 1
               Set adoRst2 = ClsLawReadRstMsg(intR, stSQL)
               If intR = 1 Then
                  'Modified by Lydia 2015/03/24 提申期限以優先權的期限與母案之審查意見通知之期限之間,最早到期者為準 (By 郭雅娟)
                  If Val(adoRst2.Fields("cp07")) < Val(WorkDate2) Then
                    WorkDate1 = adoRst2.Fields("cp06")
                    WorkDate2 = adoRst2.Fields("cp07")
                  End If
                  'Added by Lydia 2023/03/25 若後案的提申期限為當日或已過期，請出現訊息提醒USER
                  If WorkDate1 <= strSrvDate(1) Then
                      pMsgTxt = "本所期限已屆，請知會主管進行調整期限設定。"
                  End If
                  'end 2023/03/25
               End If
             End If
            'end --Add by Lydia 2014/10/15
                              
                '92.5.27 ADD BY SONIA 同時更新新案之期限
                stSQL = "UPDATE CASEPROGRESS a SET CP06=" & CNULL(WorkDate1) & ",CP07=" & CNULL(WorkDate2) & _
                   " WHERE CP01='" & p_PA01 & "' AND CP02='" & p_PA02 & "' AND CP03='" & p_PA03 & "' AND CP04='" & p_PA04 & "'" & _
                   " AND CP31='Y' and cp57 is null"
                'Add by Morgan 2010/3/17 期限大的才要更新(若有主張新穎性優惠時也會有期限所以要比較)
                'Modify by Morgan 2010/8/2 判斷有收文新穎性優惠期限才判斷法限(改大於等於)否則都要更新
                'stSQL = stSQL & " AND (CP07 IS NULL OR CP07>" & WorkDate2 & ")"
             '    stSQL = stSQL & " AND (CP07 IS NULL OR CP07>=" & WorkDate2 & _
                         " OR not exists (select * from caseprogress b where b.cp01=a.cp01 and b.cp02=a.cp02" & _
                        " and b.cp03=a.cp03 and b.cp04=a.cp04 and b.cp10='123' and b.cp57 is null))"

                'end 2010/8/2
                cnnConnection.Execute stSQL, intR
                '92.5.27 END
      
            'Modify by Morgan 2010/3/17 改用新案期限更新
            'stSQL = "UPDATE CASEPROGRESS SET CP06=" & CNULL(WorkDate1) & ",CP07=" & CNULL(WorkDate2) & " WHERE CP09='" & CP09 & "'"
            'Modified by Morgan 2014/6/9
            '會同時主張國內及國際優先權 Ex.CFP-26737
            stSQL = "UPDATE CASEPROGRESS a SET (CP06,CP07)=(select b.CP06,b.CP07 from caseprogress b" & _
               " WHERE b.CP01=a.CP01 AND b.CP02=a.CP02 AND b.CP03=a.CP03 AND b.CP04=a.CP04" & _
               " AND b.CP31='Y' and b.cp57 is null) WHERE CP09='" & CP09 & "'" & IIf(CP09_2 <> "", " or CP09='" & CP09_2 & "'", "")
            cnnConnection.Execute stSQL, intR
            'end 2014/6/9
         End If
            
         'Add by Morgan 2010/3/17
         '同時更新新穎性優惠期限
         stSQL = "UPDATE CASEPROGRESS a SET (CP06,CP07)=(select b.CP06,b.CP07 from caseprogress b" & _
            " WHERE b.CP01=a.CP01 AND b.CP02=a.CP02 AND b.CP03=a.CP03 AND b.CP04=a.CP04" & _
            " AND b.CP31='Y' and b.cp57 is null) " & _
            " WHERE CP01='" & p_PA01 & "' AND CP02='" & p_PA02 & "' AND CP03='" & p_PA03 & "' AND CP04='" & p_PA04 & "'" & _
            " AND cp10='123' and cp57 is null"
         cnnConnection.Execute stSQL, intR
      End If
      
      '更新公開、實審期限
      If p_bUpdateNext = True Then
         'Added by Morgan 2013/4/9
         '公開或實審期限的相關總收文號應該用申請程序的收文號
         stSQL = "select cp09 from caseprogress" & _
            " WHERE CP01='" & p_PA01 & "' AND CP02='" & p_PA02 & "' AND CP03='" & p_PA03 & "' AND CP04='" & p_PA04 & "'" & _
            " and instr('" & NewCasePtyList & "',cp10)>0 and cp57 is null order by cp05 asc"
         intR = 1
         Set adoRst2 = ClsLawReadRstMsg(intR, stSQL)
         If intR = 1 Then
            CP09 = adoRst2(0)
         End If
         'end 2013/4/9
         PUB_UpdCfpDate2 p_PA01, p_PA02, p_PA03, p_PA04, PD05, CP09
      End If
   End If
   
SkipMe:
   Set adoRst = Nothing
   Set adoRst2 = Nothing
End Sub


'Add by Morgan 2008/8/29 從CFP分案，提申抽來共用
'1.更新公開期限
'2.更新實審期限
Public Sub PUB_UpdCfpDate2(p_PA01 As String, p_PA02 As String, p_PA03 As String, p_PA04 As String, p_BaseDay As String, p_CP09 As String, Optional p_CpNo416 As String, Optional p_Is307Case As Boolean)
   
'Modify by Morgan 2008/10/20 公開仍舊要判斷優先權日，但實審則例外的才要

   PUB_UpdOpenDate p_PA01, p_PA02, p_PA03, p_PA04, p_CP09, p_BaseDay
   PUB_UpdExamDate p_PA01, p_PA02, p_PA03, p_PA04, p_CP09, p_BaseDay, p_CpNo416, , , p_Is307Case
   
'   Dim stSQL As String, adoRst As ADODB.Recordset, intR As Integer
'   Dim PA08 As String, PA09 As String, PA12 As String, PA46 As String, iOpenMonth As Integer, iExamMonth As Integer
'   Dim stDate(3) As String, cp(4) As String, stNP22 As String, stNP01 As String
'   Dim stCP06 As String, stCP07 As String
'
'   If p_PA01 <> "CFP" Or p_BaseDay = "" Then Exit Sub
'
'   stSQL = "select * from patent,nation" & _
'      " where pa01='" & p_PA01 & "' and pa02='" & p_PA02 & "' and pa03='" & p_PA03 & "' and pa04='" & p_PA04 & "'" & _
'      " and na01=pa09"
'   intR = 1
'   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
'   If intR = 1 Then
'      With adoRst
'         PA08 = "" & .Fields("pa08")
'         PA09 = "" & .Fields("pa09")
'         PA12 = "" & .Fields("pa12")
'         PA46 = "" & .Fields("pa46")
'         iOpenMonth = 0 '公開月份
'         Select Case PA08
'            Case "1" '發明
'               '未公開
'               If "" & .Fields("na32") = "2" And PA12 = "" Then
'                  iOpenMonth = Val("" & .Fields("na33"))
'               End If
'            Case "2" '新型
'               If "" & .Fields("na34") = "2" And PA12 = "" Then
'                  iOpenMonth = Val("" & .Fields("na35"))
'               End If
'            Case "3" '設計
'               If "" & .Fields("na36") = "2" And PA12 = "" Then
'                  iOpenMonth = Val("" & .Fields("na37"))
'               End If
'         End Select
'
'         iExamMonth = 0 '實審月份
'         Select Case PA08
'            Case "1" '發明
'               If "" & .Fields("na26") = "2" Then
'                  'Add by Morgan 2008/6/11 pct進英國的實審期限為33個月
'                  If PA09 = "201" And PA46 = "Y" Then
'                     iExamMonth = 33
'                  Else
'                     iExamMonth = Val("" & .Fields("na27"))
'                  End If
'               ElseIf "" & .Fields("na26") = "7" Then
'                  '未公開
'                  If "" & .Fields("na32") = "2" And PA12 = "" Then
'                     '公開月份+實審月份
'                     iExamMonth = Val("" & .Fields("na27")) + Val("" & .Fields("na33"))
'                  End If
'               End If
'            Case "2" '新型
'               If "" & .Fields("na28") = "2" Then
'                  iExamMonth = Val("" & .Fields("na29"))
'               ElseIf "" & .Fields("na28") = "7" Then
'                  If "" & .Fields("na34") = "2" And PA12 = "" Then
'                     '公開月份+實審月份
'                     iExamMonth = Val("" & .Fields("na29")) + Val("" & .Fields("na35"))
'                  End If
'               End If
'            Case "3" '設計
'               If "" & .Fields("na30") = "2" Then
'                  iExamMonth = Val("" & .Fields("na31"))
'               ElseIf "" & .Fields("na30") = "7" Then
'                  If "" & .Fields("na36") = "2" And PA12 = "" Then
'                     '公開月份+實審月份
'                     iExamMonth = Val("" & .Fields("na31")) + Val("" & .Fields("na37"))
'                  End If
'               End If
'         End Select
'      End With
'
'      cp(1) = p_PA01: cp(2) = p_PA02: cp(3) = p_PA03: cp(4) = p_PA04
'
'      '公開期限
'      If iOpenMonth <> 0 Then
'         stCP07 = CompDate(1, iOpenMonth, p_BaseDay) '法限
'         stDate(0) = ""
'         stDate(1) = p_PA01
'         stDate(2) = PA09
'         stDate(3) = stCP07
'         GetCtrlDT stDate
'         stCP06 = PUB_GetWorkDay1(stDate(0), True) '所限
'
'         If PUB_ChkNPExist(cp, "999", 0, stNP22, stNP01) Then
'            stSQL = "Update NextProgress Set NP08=" & stCP06 & ",NP09=" & stCP07 & " Where NP22=" & stNP22 & " and NP01='" & stNP01 & "'"
'         Else
'            stSQL = "declare intMax number;begin select max(np22)+1 into intMax from nextprogress;IF intMax IS NULL THEN intMax:=1; END IF;"
'            stSQL = stSQL & "Insert Into NextProgress (NP01,NP02,NP03,NP04,NP05,NP07,NP08,NP09,NP10,NP22) " & _
'               " Values ('" & p_CP09 & "','" & cp(1) & "','" & cp(2) & "','" & cp(3) & "','" & cp(4) & "','999'," & stCP06 & "," & stCP07 & ",'" & strUserNum & "',intMax); "
'            stSQL = stSQL & " end;"
'         End If
'         cnnConnection.Execute stSQL, intR
'      End If
'
'      '實審期限
'      If iExamMonth > 0 Then
'         stCP07 = CompDate(1, iExamMonth, p_BaseDay) '法限
'         stDate(0) = ""
'         stDate(1) = p_PA01
'         stDate(2) = PA09
'         stDate(3) = stCP07
'         GetCtrlDT stDate
'         stCP06 = PUB_GetWorkDay1(stDate(0), True) '所限
'
'         If PUB_ChkCPExist(cp, "416", 0, stNP01) Then
'            stSQL = "Update CaseProgress Set CP06=" & stCP06 & ",CP07=" & stCP07 & " Where CP09='" & stNP01 & "' and cp27 is null"
'         ElseIf PUB_ChkNPExist(cp, "416", 0, stNP22, stNP01) Then
'            stSQL = "Update NextProgress Set NP08=" & stCP06 & ",NP09=" & stCP07 & " Where NP22=" & stNP22 & " and NP01='" & stNP01 & "'"
'         Else
'            stSQL = "declare intMax number;begin select max(np22)+1 into intMax from nextprogress;IF intMax IS NULL THEN intMax:=1; END IF;"
'            stSQL = stSQL & "Insert Into NextProgress (NP01,NP02,NP03,NP04,NP05,NP07,NP08,NP09,NP10,NP22) " & _
'               " select cp09,cp01,cp02,cp03,cp04,'416'," & stCP06 & "," & stCP07 & ",cp13,intMax from caseprogress where cp09='" & p_CP09 & "'; "
'            stSQL = stSQL & " end;"
'         End If
'         cnnConnection.Execute stSQL, intR
'      End If
'   End If
   
End Sub
'Add by Morgan 2008/10/20
'計算公開期限
Public Function PUB_GetOpenDate(p_PA01 As String, p_PA02 As String, p_PA03 As String, p_PA04 As String, Optional stCP06 As String, Optional stCP07 As String, Optional p_CP09 As String, Optional p_1stPriDate As String, Optional p_PA10 As String) As Boolean
   Dim stSQL As String, adoRst As ADODB.Recordset, intR As Integer
   Dim PA08 As String, PA09 As String, PA10 As String
   Dim strSDate As String, iOpenMonth As Integer
   Dim stDate(3) As String, cp(4) As String
   Dim stNP22 As String, stNP01 As String

   cp(1) = p_PA01: cp(2) = p_PA02: cp(3) = p_PA03: cp(4) = p_PA04
   
   'Modify by Morgan 2011/3/21 英國分割案的公開期限與母案相同
   stSQL = "select * from patent,nation,divisioncase" & _
      " where pa01='" & cp(1) & "' and pa02='" & cp(2) & "' and pa03='" & cp(3) & "' and pa04='" & cp(4) & "'" & _
      " and na01(+)=pa09" & _
      " and dc01(+)=pa01 and dc02(+)=pa02 and dc03(+)=pa03 and dc04(+)=pa04"
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      With adoRst
         
         If IsNull(.Fields("pa12")) Then
         
            'Add by Morgan 2011/3/21 英國分割案的公開期限與母案相同
            If .Fields("pa09") = "201" And Not IsNull(.Fields("dc05")) Then
               cp(1) = .Fields("dc05")
               cp(2) = .Fields("dc06")
               cp(3) = .Fields("dc07")
               cp(4) = .Fields("dc08")
               stSQL = "select * from patent,nation,divisioncase" & _
                  " where pa01='" & cp(1) & "' and pa02='" & cp(2) & "' and pa03='" & cp(3) & "' and pa04='" & cp(4) & "'" & _
                  " and na01(+)=pa09" & _
                  " and dc01(+)=pa01 and dc02(+)=pa02 and dc03(+)=pa03 and dc04(+)=pa04"
               intR = 1
               Set adoRst = ClsLawReadRstMsg(intR, stSQL)
               If intR <> 1 Then
                  Exit Function
               End If
            End If
         
         
            PA08 = "" & .Fields("pa08") '專利種類
            PA09 = "" & .Fields("pa09") '申請國家
            If p_PA10 <> "" Then
               PA10 = p_PA10 '代理人提申未存檔時已輸入之申請日
            Else
               PA10 = "" & .Fields("pa10") '申請日
            End If
                        
            strSDate = PA10
            
            If p_1stPriDate = "" Then
               p_1stPriDate = PUB_GetFirstPriDate(cp)
            End If
            
            If p_1stPriDate <> "" Then strSDate = p_1stPriDate
            
            iOpenMonth = 0 '公開月份
            Select Case PA08
               Case "1" '發明
                  If "" & .Fields("na32") = "2" Then
                     iOpenMonth = Val("" & .Fields("na33"))
                  End If
               Case "2" '新型
                  If "" & .Fields("na34") = "2" Then
                     iOpenMonth = Val("" & .Fields("na35"))
                  End If
               Case "3" '設計
                  If "" & .Fields("na36") = "2" Then
                     iOpenMonth = Val("" & .Fields("na37"))
                  End If
            End Select
         End If
      End With
         
      '公開期限
      If iOpenMonth <> 0 And strSDate <> "" Then
         stCP07 = CompDate(1, iOpenMonth, strSDate) '法限
         stDate(0) = ""
         stDate(1) = cp(1)
         stDate(2) = PA09
         stDate(3) = stCP07
         GetCtrlDT stDate
         stCP06 = PUB_GetWorkDay1(stDate(0), True) '所限
         PUB_GetOpenDate = True
      End If
   End If
   
End Function
'Add by Morgan 2008/10/20
'更新公開期限
Public Sub PUB_UpdOpenDate(p_PA01 As String, p_PA02 As String, p_PA03 As String, p_PA04 As String, p_CP09 As String, Optional p_1stPriDate As String)
   Dim stSQL As String, intR As Integer, cp(4) As String
   
   Dim stCP06 As String, stCP07 As String, stNP22 As String, stNP01 As String
   
   If p_PA01 <> "CFP" Then Exit Sub
   
   PUB_GetOpenDate p_PA01, p_PA02, p_PA03, p_PA04, stCP06, stCP07, p_CP09, p_1stPriDate
   
   If stCP07 <> "" And stCP06 <> "" Then
      cp(1) = p_PA01: cp(2) = p_PA02: cp(3) = p_PA03: cp(4) = p_PA04
      
      If PUB_ChkNPExist(cp, "999", 0, stNP22, stNP01) Then
         stSQL = "Update NextProgress Set NP08=" & stCP06 & ",NP09=" & stCP07 & " Where NP22=" & stNP22 & " and NP01='" & stNP01 & "'"
      Else
         stSQL = "Insert Into NextProgress (NP01,NP02,NP03,NP04,NP05,NP07,NP08,NP09,NP10,NP22) " & _
            " Values ('" & p_CP09 & "','" & cp(1) & "','" & cp(2) & "','" & cp(3) & "','" & cp(4) & "','999'," & stCP06 & "," & stCP07 & ",'" & strUserNum & "',GETNP22) "
      End If
      cnnConnection.Execute stSQL, intR
   End If
   
End Sub

'Add by Morgan 2009/11/18 從PUB_UpdExamDate抽出
Public Sub PUB_GetExamDate(p_PA01 As String, p_PA02 As String, p_PA03 As String, p_PA04 As String, Optional p_CP09 As String, Optional ByVal p_1stPriDate As String, Optional p_CP06 As String, Optional p_CP07 As String, Optional p_PA08 As String, Optional p_PA09 As String, Optional p_PA10 As String, Optional p_Is307Case As Boolean)
   Dim stSQL As String, adoRst As ADODB.Recordset, intR As Integer
   Dim PA10 As String, PA12 As String, PA46 As String
   Dim strSDate As String, iExamMonth As Integer
   Dim stDate(3) As String
   Dim adoRst2 As ADODB.Recordset
   Dim stRefCP10 As String, stRefCP27 As String
   Dim bolFMP As Boolean 'Add by Morgan 2009/11/4
   Dim cp(4) As String
   Dim strAppDate As String 'Add by Morgan 2011/2/15 提交日
   Dim bolNormalRule As Boolean
   
   p_CP06 = "": p_CP07 = ""
   'Modified by Morgan 2022/10/24 +FCP
   If p_PA01 <> "CFP" And p_PA01 <> "P" And p_PA01 <> "FCP" Then Exit Sub

   'Add by Morgan 2010/6/14
   cp(1) = p_PA01
   cp(2) = p_PA02
   cp(3) = p_PA03
   cp(4) = p_PA04
   If p_1stPriDate = "" Then
      p_1stPriDate = PUB_GetFirstPriDate(cp)
   End If
   'end 2010/6/14
   
   'Modify by Morgan 2010/8/16 日本植物新品種保護除外
   stSQL = "select * from patent,nation,caseprogress a" & _
      " where pa01='" & p_PA01 & "' and pa02='" & p_PA02 & "' and pa03='" & p_PA03 & "' and pa04='" & p_PA04 & "'" & _
      " and na01=pa09" & _
      " and cp01(+)=pa01 and cp02(+)=pa02 and cp03(+)=pa03 and cp04(+)=pa04 and cp09(+)='" & p_CP09 & "'" & _
      " and not exists(select * from caseprogress b where b.cp01=pa01 and b.cp02=pa02 and b.cp03=pa03 and b.cp04=pa04 and b.cp10='120' and b.cp27>0 and pa09='011')"
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      With adoRst
         p_PA08 = "" & .Fields("pa08") '專利種類
         p_PA09 = "" & .Fields("pa09") '申請國家
         'Add by Morgan 2010/7/13 優先抓傳入的日期
         If p_PA10 <> "" Then
            PA10 = DBDATE(p_PA10) '申請日
         Else
         'end 2010/7/13
            PA10 = "" & .Fields("pa10") '申請日
         End If
         PA12 = "" & .Fields("pa12") '公開日
         PA46 = "" & .Fields("pa46") '是否PCT案
         stRefCP10 = "" & .Fields("cp10") '相關案號案件性質
         stRefCP27 = "" & .Fields("cp27") '相關案號發文日
         
         'Add by Morgan 2009/11/4
         'Modified by Morgan 2012/8/20
         'If p_PA09 = "020" And Left(.Fields("cp12"), 1) = "F" Then
         'Modified by Morgan 2021/2/2
         'If p_PA01 = "P" And p_PA09 <> "000" And Left(.Fields("cp12"), 1) = "F" Then
         '   bolFMP = True
         'Else
         '   bolFMP = False
         'End If
         bolFMP = PUB_ChkIsFMP(p_PA01, p_PA02, p_PA03, p_PA04, p_PA09)
         'end 2009/11/4
         
         iExamMonth = 0 '實審月份
         bolNormalRule = True
         Select Case p_PA08
            Case "1" '發明
               'Add by Morgan 2009/7/2
               'PCT進各國有特別規定的
               If PA46 = "Y" Then
                  bolNormalRule = False
                  Select Case p_PA09
'CANCEL BY SONIA 2014/6/20 新加坡改為不分是否PCT案都為優先權日起算36個月內請求實審,設定在國家檔
'                     '新加坡:優先權日起39個月
'                     Case "014"
'                        If p_1stPriDate <> "" Then
'                           strSDate = p_1stPriDate
'                        Else
'                           strSDate = PA10
'                        End If
'                        iExamMonth = 39

                     '馬來西亞:PCT申請日起4年
                     Case "018"
                        strSDate = PA10
                        iExamMonth = 48
                        
                     '菲律賓:進入國家階段之日起6個月
                     Case "030"
                        stSQL = "select cp47 from caseprogress where cp01='" & p_PA01 & "' and cp02='" & p_PA02 & "' and cp03='" & p_PA03 & "' and cp04='" & p_PA04 & "' and cp10='101' and cp47>0"
                        intR = 1
                        Set adoRst2 = ClsLawReadRstMsg(intR, stSQL)
                        If intR = 1 Then
                           strSDate = adoRst2(0)
                           iExamMonth = 6
                        End If
                     '英國:優先權日起33個月或進入國家階段之日起2個月
                     Case "201"
                        
                        'Add by Morgan 2008/6/11
                        'pct進英國的實審期限為33個月
                        If p_1stPriDate <> "" Then
                           strSDate = p_1stPriDate
                        Else
                           strSDate = PA10
                        End If
                        iExamMonth = 33
                        'end 2008/6/11
                        
                        '進入國家階段之日起2個月
                        stSQL = "select cp47 from caseprogress where cp01='" & p_PA01 & "' and cp02='" & p_PA02 & "' and cp03='" & p_PA03 & "' and cp04='" & p_PA04 & "' and cp10='101' and cp47>0"
                        intR = 1
                        Set adoRst2 = ClsLawReadRstMsg(intR, stSQL)
                        If intR = 1 Then
                           If CompDate(1, 2, adoRst2(0)) < CompDate(1, iExamMonth, strDate) Then
                              strSDate = adoRst2(0)
                              iExamMonth = 2
                           End If
                        End If
                     'EPC:優先權日起31個月
                     Case "221"
                     
                        'Added by Morgan 2024/12/9
                        '若有輸入檢索報告公開日時以該日期+6個月更新實審,指定費,回覆檢索報告期限--郭
                        stSQL = "select cp115 from caseprogress where cp01='" & p_PA01 & "' and cp02='" & p_PA02 & "' and cp03='" & p_PA03 & "' and cp04='" & p_PA04 & "' and cp10='1238' and cp115>0 order by cp09 desc"
                        intR = 1
                        Set adoRst2 = ClsLawReadRstMsg(intR, stSQL)
                        If intR = 1 Then
                           strSDate = adoRst2(0)
                           iExamMonth = 6
                        Else
                        'end 2024/12/9
                        
                           If p_1stPriDate <> "" Then
                              strSDate = p_1stPriDate
                           Else
                              strSDate = PA10
                           End If
                           iExamMonth = 31
                        
                           'add by sonia 2014/6/17 EPC通知公開後,不管是否為PCT案件,皆以公開日+6個月更新實審,指定費,回覆檢索報告期限 CFP-025835
                           If PA12 <> "" Then
                              strSDate = PA12
                              iExamMonth = 6
                           End If
                           
                        End If
                        'end 2014/1/17
                     '匈牙利:檢索報告發出後6個月(不控制)
                     'Case "219"
                        
                     Case Else
                        bolNormalRule = True
                        
                  End Select
               End If
               
               '各國規定(發明)
               If bolNormalRule Then
                  '申請日
                  If "" & .Fields("na26") = "2" Then
                     strSDate = PA10
                     '優先權日起算:PCT進各國,越南,PCT,大陸
                     'Modify by Morgan 2008/10/30 +新加坡014,印度040,德國231
                     'Modify by Morgan 2009/7/2
                     'PCT進各國改控制只有特定的國家才要抓最早優先權日(移到上面)
                     
                     '優先權日起算的國家
                     If p_1stPriDate <> "" Then
                        Select Case p_PA09
                           '新加坡014,越南042,PCT056,大陸020,印度040,德國231,EPC221
                           'MODIFY BY SONIA 2014/6/20 加汶萊022,比利時209
                           Case "014", "042", "056", "020", "040", "231", "221", "022", "209"
                              strSDate = p_1stPriDate
                        End Select
                     End If
                     
                     'Add by Morgan 2011/3/21 英國分割案用母案的申請日起算
                     If p_PA09 = "201" And p_Is307Case = True Then
                        stSQL = "select pa10 from DIVISIONCASE,patent" & _
                           " where dc01='" & p_PA01 & "' and dc02='" & p_PA02 & "' and dc03='" & p_PA03 & "' and dc04='" & p_PA04 & "'" & _
                           " and pa01(+)=dc05 and pa02(+)=dc06 and pa03(+)=dc07 and pa04(+)=dc08"
                        intR = 1
                        Set adoRst2 = ClsLawReadRstMsg(intR, stSQL)
                        If intR = 1 Then
                           strSDate = "" & adoRst2("pa10")
                        End If
                     End If
                     
                     If strSDate <> "" Then
                        iExamMonth = Val("" & .Fields("na27"))
                     End If
                     
                     'Add by Morgan 2009/7/2
                     '國家檔設申請日實際為公開日
                     Select Case p_PA09
                        '菲律賓:公開日起半年
                        Case "030"
                           If PA12 <> "" Then
                              strSDate = PA12
                              iExamMonth = 6
                           End If
                        '泰國:公開日起5年
                        Case "019"
                           If PA12 <> "" Then
                              strSDate = PA12
                              iExamMonth = 60
                           End If
                        '英國:公開日起6個月
                        Case "201"
                           If PA12 <> "" Then
                              strSDate = PA12
                              iExamMonth = 6
                           'Added by Morgan 2021/5/18
                           '英國未公開若有優先權日則以該日期起算--甄妮
                           ElseIf p_1stPriDate <> "" Then
                              strSDate = p_1stPriDate
                           End If
                        'EPC:公開日起6個月
                        Case "221"
                           'Added by Morgan 2024/12/9
                           '若有輸入檢索報告公開日時以該日期+6個月更新實審,指定費,回覆檢索報告期限--郭
                           stSQL = "select cp115 from caseprogress where cp01='" & p_PA01 & "' and cp02='" & p_PA02 & "' and cp03='" & p_PA03 & "' and cp04='" & p_PA04 & "' and cp10='1238' and cp115>0 order by cp09 desc"
                           intR = 1
                           Set adoRst2 = ClsLawReadRstMsg(intR, stSQL)
                           If intR = 1 Then
                              strSDate = adoRst2(0)
                              iExamMonth = 6
                           Else
                           'end 2024/12/9
                           
                              If PA12 <> "" Then
                                 strSDate = PA12
                                 iExamMonth = 6
                              End If
                              
                           End If
                        '匈牙利:公開日起6個月
                        Case "219"
                           If PA12 <> "" Then
                              strSDate = PA12
                              iExamMonth = 6
                           End If
                        '土耳其:公開日起3個月
                        Case "253"
                           If PA12 <> "" Then
                              strSDate = PA12
                              iExamMonth = 3
                           End If
                     End Select
                     
                     'Add by Morgan 2008/10/20 從提申併入
                     '各國修法
                     'Added by Morgan 2017/8/31
                     '韓國發明
                     If p_PA09 = "012" And PA10 <> "" Then
                        '申請日2017/3/1(不含)以前實審期限為申請日起5年
                        If PA10 < "20170301" Then
                           strSDate = PA10
                           iExamMonth = 60
                        End If
                     'end 2017/8/31
                     '新加坡發明
                     ElseIf p_PA09 = "014" And PA10 <> "" Then
                        '申請日2004/7/1(不含)以前實審期限為申請日起28個月
                        If PA10 < "20040701" Then
                           strSDate = PA10
                           iExamMonth = 28
                        End If
                        
                     'Add by Morgan 2011/3/10
                     '馬來西亞發明
                     ElseIf p_PA09 = "018" And PA10 <> "" Then
                        '申請日2011/2/15以前實審期限為申請日起24個月
                        If PA10 < "20110215" Then
                           strSDate = PA10
                           iExamMonth = 24
                        End If
                     '印度發明
                     ElseIf p_PA09 = "040" And PA10 <> "" Then
                        '申請日2004/12/31(含)以前實審期限為申請日起48個月
                        If PA10 <= "20041231" Then
                           strSDate = PA10
                           iExamMonth = 48
                        '申請日2006/5/5以後改回48個月
                        ElseIf PA10 < "20060505" Then
                           iExamMonth = 36
                        '申請日2024/3/14以後改回31個月  add by sonia 2024/5/8
                        ElseIf PA10 < "20240314" Then
                           iExamMonth = 48
                        End If
                     'end 2008/10/20
                     End If
                     
                  '公開日
                  ElseIf "" & .Fields("na26") = "7" Then
                     strSDate = PA12
                     '有公開日
                     If strSDate <> "" Then
                        iExamMonth = Val("" & .Fields("na27"))
                     '無公開日
                     ElseIf "" & .Fields("na32") = "2" Then
                        strSDate = PA10
                        If p_1stPriDate <> "" Then
                           strSDate = p_1stPriDate
                        End If
                        If strSDate <> "" Then
                           '公開月份+實審月份
                           iExamMonth = Val("" & .Fields("na33")) + Val("" & .Fields("na27"))
                        End If
                     End If
                     
                  '發文日
                  ElseIf "" & .Fields("na26") = "3" Then
                     '新案發文日
                     stSQL = "select cp27 from caseprogress where cp01='" & p_PA01 & "' and cp02='" & p_PA02 & "' and cp03='" & p_PA03 & "' and cp04='" & p_PA04 & "' and cp10='101' and cp27>0"
                     intR = 1
                     Set adoRst2 = ClsLawReadRstMsg(intR, stSQL)
                     If intR = 1 Then
                        strSDate = adoRst2(0)
                        iExamMonth = Val("" & .Fields("na27"))
                     End If
                     
                  End If
               End If
               
            Case "2" '新型
               'Add by Morgan 2009/7/2
               'PCT進各國有特別規定的
               If PA46 = "Y" Then
                  bolNormalRule = False
                  Select Case p_PA09
                     '馬來西亞:PCT申請日起4年
                     Case "018"
                        strSDate = PA10
                        iExamMonth = 48
                        
                     '匈牙利:檢索報告發出後6個月(不控制)
                     'Case "219"
                     Case Else
                        bolNormalRule = True
                  End Select
               End If
               
               '各國規定(新型)
               If bolNormalRule Then
                  '申請日
                  If "" & .Fields("na28") = "2" Then
                     strSDate = PA10
                     'PCT進各國改控制只有特定的國家才要抓最早優先權日(程式在上面)
                     '優先權日起算的國家:越南042
                     'If p_1stPriDate <> "" And (PA46 = "Y" Or p_PA09 = "042") Then
                     If p_1stPriDate <> "" Then
                        Select Case p_PA09
                           Case "042"
                              strSDate = p_1stPriDate
                        End Select
                     End If
                     
                     If strSDate <> "" Then
                        iExamMonth = Val("" & .Fields("na29"))
                     End If
                     
                     '國家檔設申請日實際為公開日
                     Select Case p_PA09
                        '匈牙利:公開日起6個月
                        Case "219"
                           If PA12 <> "" Then
                              strSDate = PA12
                              iExamMonth = 6
                           End If
                     End Select
                     
                     '各國修法
                     '2008/10/27 ADD BY SONIA CFP-021410
                     If p_PA09 = "012" And PA10 <> "" Then
                        If PA10 < 20061001 Then
                           iExamMonth = 0
                        End If
                        
                     'Add by Morgan 2011/3/10
                     '馬來西亞新型
                     ElseIf p_PA09 = "018" And PA10 <> "" Then
                        '申請日2011/2/15以前實審期限為申請日起24個月
                        If PA10 < "20110215" Then
                           strSDate = PA10
                           iExamMonth = 24
                        End If
                        
                     End If
                     '2008/10/27 end
                     
                  ElseIf "" & .Fields("na28") = "7" Then
                     strSDate = PA12
                     '有公開日
                     If strSDate <> "" Then
                        iExamMonth = Val("" & .Fields("na29"))
                     '無公開日
                     ElseIf "" & .Fields("na34") = "2" Then
                        strSDate = PA10
                        If p_1stPriDate <> "" Then
                           strSDate = p_1stPriDate
                        End If
                        If strSDate <> "" Then
                           '公開月份+實審月份
                           iExamMonth = Val("" & .Fields("na35")) + Val("" & .Fields("na29"))
                        End If
                     End If
                     
                  '發文日
                  ElseIf "" & .Fields("na26") = "3" Then
                     '新案發文日
                     stSQL = "select cp27 from caseprogress where cp01='" & p_PA01 & "' and cp02='" & p_PA02 & "' and cp03='" & p_PA03 & "' and cp04='" & p_PA04 & "' and cp10='102' and cp27>0"
                     intR = 1
                     Set adoRst2 = ClsLawReadRstMsg(intR, stSQL)
                     If intR = 1 Then
                        strSDate = adoRst2(0)
                        iExamMonth = Val("" & .Fields("na29"))
                     End If
                     
                  End If
               End If
               
            Case "3" '設計
               If "" & .Fields("na30") = "2" Then
                  strSDate = PA10
                  If strSDate <> "" Then
                     iExamMonth = Val("" & .Fields("na31"))
                  End If
               ElseIf "" & .Fields("na30") = "7" Then
                  strSDate = PA12
                  '有公開日
                  If strSDate <> "" Then
                     iExamMonth = Val("" & .Fields("na31"))
                  '無公開日
                  ElseIf "" & .Fields("na36") = "2" Then
                     strSDate = PA10
                     If p_1stPriDate <> "" Then
                        strSDate = p_1stPriDate
                     End If
                     If strSDate <> "" Then
                        '公開月份+實審月份
                        iExamMonth = Val("" & .Fields("na37")) + Val("" & .Fields("na31"))
                     End If
                  End If
                  
               '發文日
               ElseIf "" & .Fields("na26") = "3" Then
                  '新案發文日
                  stSQL = "select cp27 from caseprogress where cp01='" & p_PA01 & "' and cp02='" & p_PA02 & "' and cp03='" & p_PA03 & "' and cp04='" & p_PA04 & "' and cp10='103' and cp27>0"
                  intR = 1
                  Set adoRst2 = ClsLawReadRstMsg(intR, stSQL)
                  If intR = 1 Then
                     strSDate = adoRst2(0)
                     iExamMonth = Val("" & .Fields("na31"))
                  End If
                     
               End If
         End Select

      End With
         
      '實審期限
      If iExamMonth > 0 And strSDate <> "" Then
         'Modify by Morgan 2011/2/15
         'p_CP07 = CompDate(1, iExamMonth, strSDate) '法限
         '日本分割案的實審期限為母案申請日起算3年,但若提申時已過期則改為提申日+30天
         If p_PA09 = "011" And p_Is307Case = True Then
            stSQL = "select pa10,cp47 from DIVISIONCASE,patent,caseprogress" & _
               " where dc01='" & p_PA01 & "' and dc02='" & p_PA02 & "' and dc03='" & p_PA03 & "' and dc04='" & p_PA04 & "'" & _
               " and pa01(+)=dc05 and pa02(+)=dc06 and pa03(+)=dc07 and pa04(+)=dc08" & _
               " and cp01(+)=dc01 and cp02(+)=dc02 and cp03(+)=dc03 and cp04(+)=dc04 and cp10='307'"
            intR = 1
            Set adoRst2 = ClsLawReadRstMsg(intR, stSQL)
            If intR = 1 Then
               strSDate = "" & adoRst2("pa10")
               strAppDate = "" & adoRst2("cp47")
            End If
            p_CP07 = CompDate(1, iExamMonth, strSDate) '法限
            
            
            If Val(p_CP07) < Val(strAppDate) Then
               p_CP07 = CompDate(2, 30, strAppDate)
            End If
            
         'Added by Morgan 2014/7/30 +新加坡分割案要從提申日起算
         ElseIf p_PA09 = "014" And p_Is307Case = True Then
            stSQL = "select cp47 from caseprogress" & _
               " where cp01='" & p_PA01 & "' and cp02='" & p_PA02 & "' and cp03='" & p_PA03 & "' and cp04='" & p_PA04 & "' and cp10='307' and cp47>0"
            intR = 1
            Set adoRst2 = ClsLawReadRstMsg(intR, stSQL)
            If intR = 1 Then
               strSDate = adoRst2("cp47")
            End If
            p_CP07 = CompDate(1, iExamMonth, strSDate) '法限
         'end 2014/7/30
         
         Else
            p_CP07 = CompDate(1, iExamMonth, strSDate) '法限
         End If
      
         
         If p_PA09 = 台灣國家代號 Then
            'p_CP07 = CompDate(2, -1, p_CP07) '台灣案要減1天 'Removed by Morgan 2022/10/24 不必減1天--郭
            'Add by Morgan 2006/5/12 台灣改請發明時實審期限為"原實審期限"or"改請日+30"取較大者
            If stRefCP10 = "301" And stRefCP27 <> "" Then
               strExc(0) = CompDate(2, 30, stRefCP27)
               If Val(strExc(0)) > Val(p_CP07) Then
                  p_CP07 = strExc(0)
               End If
            End If
         End If
         
         'Add by Morgan 2009/11/4
         'FMP 案實審的所限=法限-10天
         If bolFMP = True Then
            stDate(0) = CompDate(2, -10, p_CP07)
         'Added by Morgan 2018/10/3 非FMP非台灣的專利案年費及實審的本所期限也改法限-10天
         ElseIf p_PA01 = "P" And p_PA09 <> 台灣國家代號 Then
            'Modified by Lydia 2025/10/30 改用模組---屬於2025/10/29更新所限 'Memo by Lydia 2025/10/31 非台灣案(大陸、香港、澳門和PCT)都是相同算法---郭經理(電話)
            'stDate(0) = CompDate(2, -10, p_CP07)
            stDate(0) = PUB_GetPOurDeadline(p_CP07, "020", , p_PA01, stRefCP10)
         'end 2018/10/3
         Else
         'end 2009/11/4
            stDate(0) = ""
            stDate(1) = p_PA01
            stDate(2) = p_PA09
            stDate(3) = p_CP07
            GetCtrlDT stDate
         End If
         
         p_CP06 = PUB_GetWorkDay1(stDate(0), True) '所限
      End If
   End If
   
   Set adoRst = Nothing
   Set adoRst2 = Nothing
End Sub

'Add by Morgan 2008/10/20
'更新實審期限
'Modify by Morgan 2010/7/13 +p_PA10
Public Sub PUB_UpdExamDate(p_PA01 As String, p_PA02 As String, p_PA03 As String, p_PA04 As String, Optional p_CP09 As String, Optional p_1stPriDate As String, Optional p_CpNo416 As String, Optional p_bolCheckOnly As Boolean = False, Optional p_PA10 As String, Optional p_Is307Case As Boolean)
   Dim stSQL As String, intR As Integer, adoRst As ADODB.Recordset
   Dim stPA08 As String, stPA09 As String
   Dim stCP06 As String, stCP07 As String, stNP22 As String, stNP01 As String
   Dim cp(4) As String
   Dim bPCTCase As Boolean 'Added by Morgan 2012/11/13
   Dim stNP23 As String 'Added by Morgan 2024/12/10
   Dim stPA10 As String, stStartDate As String, st421CP07 As String, st421CP06 As String, stDate(3) As String 'Added by Morgan 2025/1/20
   
   PUB_GetExamDate p_PA01, p_PA02, p_PA03, p_PA04, p_CP09, p_1stPriDate, stCP06, stCP07, stPA08, stPA09, p_PA10, p_Is307Case
   
   If stCP07 <> "" And stCP06 <> "" Then
   
      cp(1) = p_PA01: cp(2) = p_PA02: cp(3) = p_PA03: cp(4) = p_PA04
         
      '2008/11/27 ADD BY SONIA 新加坡發明判斷合併檢索及實審427,再分別判斷實審416,申請檢索報告421
      'Modified by Morgan 2025/5/29 +汶萊發明
      If (stPA09 = "014" Or stPA09 = "022") And stPA08 = "1" Then
         
         'Added by Morgan 2012/11/13 PCT案不必再檢索(PCT申請時已檢索)
         bPCTCase = False
         'Modified by Morgan 2025/1/20
         'stSQL = "select 1 from patent where pa01='" & p_PA01 & "' and pa02='" & p_PA02 & "' and pa03='" & p_PA03 & "' and pa04='" & p_PA04 & "' and pa46='Y'"
         stSQL = "select pa10,pa46 from patent where pa01='" & p_PA01 & "' and pa02='" & p_PA02 & "' and pa03='" & p_PA03 & "' and pa04='" & p_PA04 & "'"
         intR = 1
         Set adoRst = ClsLawReadRstMsg(intR, stSQL)
         If intR = 1 Then
            'Added by Morgan 2025/1/20
            stPA10 = "" & adoRst("pa10")
            If adoRst("pa46") = "Y" Then
            'end 2025/1/20
               bPCTCase = True
            End If
         End If
         
         If bPCTCase = False Then
         'end 2012/11/13
         
            'Added by Morgan 2025/1/20
            '新加坡若檢索報告與實審分開請求而不是合併請求的話，申請檢索報告的期限為自申請日(或優先權日)起13個月 --禧佩
            If p_1stPriDate <> "" Then
               stStartDate = p_1stPriDate
            Else
               stStartDate = PUB_GetFirstPriDate(cp)
            End If
            If stStartDate = "" Then
               If p_PA10 <> "" Then
                  stStartDate = p_PA10
               Else
                  stStartDate = stPA10
               End If
            End If
            
            'Added by Morgan 2025/5/29
            '汶萊發明的申請檢索報告期限同樣是為自申請日(或優先權日)起39個月
            If stPA09 = "022" Then
               st421CP07 = stCP07
               st421CP06 = stCP06
            Else
            'end 2025/5/29
            
               st421CP07 = CompDate(1, 13, stStartDate)
               stDate(0) = ""
               stDate(1) = p_PA01
               stDate(2) = stPA09
               stDate(3) = st421CP07
               GetCtrlDT stDate
               st421CP06 = stDate(0)
            End If
            'end 2025/1/20
            
            '更新已收文資料
            If PUB_ChkCPExist(cp, "427", 0, stNP01) Then
               If p_bolCheckOnly Then Exit Sub 'Add by Morgan 2010/6/14
               stSQL = "Update CaseProgress Set CP06=" & stCP06 & ",CP07=" & stCP07 & " Where CP09='" & stNP01 & "' and cp27 is null"
               GoTo Nextstep
            End If
            
            stSQL = "declare intMax number;begin "
            If PUB_ChkCPExist(cp, "416", 0, stNP01) Then
               If p_bolCheckOnly Then Exit Sub 'Add by Morgan 2010/6/14
               stSQL = stSQL & "Update CaseProgress Set CP06=" & stCP06 & ",CP07=" & stCP07 & " Where CP09='" & stNP01 & "' and cp27 is null;"
            End If
            If PUB_ChkCPExist(cp, "421", 0, stNP01) Then
               If p_bolCheckOnly Then Exit Sub 'Add by Morgan 2010/6/14
               'Modified by Morgan 2025/1/20
               'stSQL = stSQL & "Update CaseProgress Set CP06=" & stCP06 & ",CP07=" & stCP07 & " Where CP09='" & stNP01 & "' and cp27 is null;"
               stSQL = stSQL & "Update CaseProgress Set CP06=" & st421CP06 & ",CP07=" & st421CP07 & " Where CP09='" & stNP01 & "' and cp27 is null;"
               'end 2025/1/20
            End If
            
            '更新或新增未收文資料
            If Not PUB_ChkCPExist(cp, "416", 0, stNP01) And Not PUB_ChkCPExist(cp, "421", 0, stNP01) Then
               p_CpNo416 = "Y"
               If p_bolCheckOnly Then Exit Sub 'Add by Morgan 2010/6/14
               If PUB_ChkNPExist(cp, "427", 0, stNP22, stNP01) Then
                  stSQL = stSQL & "Update NextProgress Set NP08=" & stCP06 & ",NP09=" & stCP07 & " Where NP22=" & stNP22 & " and NP01='" & stNP01 & "';"
               ElseIf p_CP09 <> "" Then
                  stSQL = stSQL & "select max(np22)+1 into intMax from nextprogress;IF intMax IS NULL THEN intMax:=1; END IF;"
                  stSQL = stSQL & "Insert Into NextProgress (NP01,NP02,NP03,NP04,NP05,NP07,NP08,NP09,NP10,NP22) " & _
                     " select cp09,cp01,cp02,cp03,cp04,'427'," & stCP06 & "," & stCP07 & ",'" & PUB_GetAKindSalesNo(p_PA01, p_PA02, p_PA03, p_PA04) & "',intMax from caseprogress where cp09='" & p_CP09 & "'; "
               End If
            
            ElseIf Not PUB_ChkCPExist(cp, "416", 0, stNP01) Then
               p_CpNo416 = "Y"
               If p_bolCheckOnly Then Exit Sub 'Add by Morgan 2010/6/14
               If PUB_ChkNPExist(cp, "416", 0, stNP22, stNP01) Then
                  stSQL = stSQL & "Update NextProgress Set NP08=" & stCP06 & ",NP09=" & stCP07 & " Where NP22=" & stNP22 & " and NP01='" & stNP01 & "';"
               ElseIf p_CP09 <> "" Then
                  stSQL = stSQL & "select max(np22)+1 into intMax from nextprogress;IF intMax IS NULL THEN intMax:=1; END IF;"
                  stSQL = stSQL & "Insert Into NextProgress (NP01,NP02,NP03,NP04,NP05,NP07,NP08,NP09,NP10,NP22) " & _
                     " select cp09,cp01,cp02,cp03,cp04,'416'," & stCP06 & "," & stCP07 & ",'" & PUB_GetAKindSalesNo(p_PA01, p_PA02, p_PA03, p_PA04) & "',intMax from caseprogress where cp09='" & p_CP09 & "'; "
               End If
            
            ElseIf Not PUB_ChkCPExist(cp, "421", 0, stNP01) Then
               'p_CpNo416 = "Y"   不上未收實審註記
               If p_bolCheckOnly Then Exit Sub 'Add by Morgan 2010/6/14
               If PUB_ChkNPExist(cp, "421", 0, stNP22, stNP01) Then
                  'Modified by Morgan 2025/1/20
                  'stSQL = stSQL & "Update NextProgress Set NP08=" & stCP06 & ",NP09=" & stCP07 & " Where NP22=" & stNP22 & " and NP01='" & stNP01 & "';"
                  stSQL = stSQL & "Update NextProgress Set NP08=" & st421CP06 & ",NP09=" & st421CP07 & " Where NP22=" & stNP22 & " and NP01='" & stNP01 & "';"
               ElseIf p_CP09 <> "" Then
                  stSQL = stSQL & "select max(np22)+1 into intMax from nextprogress;IF intMax IS NULL THEN intMax:=1; END IF;"
                  'Modified by Morgan 2025/1/20
                  'stSQL = stSQL & "Insert Into NextProgress (NP01,NP02,NP03,NP04,NP05,NP07,NP08,NP09,NP10,NP22) " & _
                     " select cp09,cp01,cp02,cp03,cp04,'421'," & stCP06 & "," & stCP07 & ",'" & PUB_GetAKindSalesNo(p_PA01, p_PA02, p_PA03, p_PA04) & "',intMax from caseprogress where cp09='" & p_CP09 & "'; "
                  stSQL = stSQL & "Insert Into NextProgress (NP01,NP02,NP03,NP04,NP05,NP07,NP08,NP09,NP10,NP22) " & _
                     " select cp09,cp01,cp02,cp03,cp04,'421'," & st421CP06 & "," & st421CP07 & ",'" & PUB_GetAKindSalesNo(p_PA01, p_PA02, p_PA03, p_PA04) & "',intMax from caseprogress where cp09='" & p_CP09 & "'; "
               End If
            End If
            stSQL = stSQL & " end;"
            GoTo Nextstep
            
         End If 'Added by Morgan 2012/11/13
         
      End If
      '2008/11/27 END
         
      If PUB_ChkCPExist(cp, "416", 0, stNP01) Then
         If p_bolCheckOnly Then Exit Sub 'Add by Morgan 2010/6/14
         stSQL = "Update CaseProgress Set CP06=" & stCP06 & ",CP07=" & stCP07 & " Where CP09='" & stNP01 & "' and cp27 is null"
      Else
         p_CpNo416 = "Y"
         If p_bolCheckOnly Then Exit Sub 'Add by Morgan 2010/6/14
         If PUB_ChkNPExist(cp, "416", 0, stNP22, stNP01) Then
            stSQL = "Update NextProgress Set NP08=" & stCP06 & ",NP09=" & stCP07 & " Where NP22=" & stNP22 & " and NP01='" & stNP01 & "'"
         ElseIf p_CP09 <> "" Then
            'Modify By Sindy 2012/1/20 PUB_GetAKindSalesNo函數必須前後加引號, 不然SQL在執行時會錯, 因員工編號非全部數字
            stSQL = "declare intMax number;begin select max(np22)+1 into intMax from nextprogress;IF intMax IS NULL THEN intMax:=1; END IF;"
            stSQL = stSQL & "Insert Into NextProgress (NP01,NP02,NP03,NP04,NP05,NP07,NP08,NP09,NP10,NP22) " & _
               " select cp09,cp01,cp02,cp03,cp04,'416'," & stCP06 & "," & stCP07 & ",'" & PUB_GetAKindSalesNo(p_PA01, p_PA02, p_PA03, p_PA04) & "',intMax from caseprogress where cp09='" & p_CP09 & "'; "
            stSQL = stSQL & " end;"
         End If
      End If

Nextstep:
      If p_bolCheckOnly Then Exit Sub 'Add by Morgan 2010/6/14
      cnnConnection.Execute stSQL, intR
         
'Removed by Morgan 2020/3/10 取消--禧佩
'      'Add by Morgan 2008/10/20 從提申併入
'      '馬來西亞發明,新型要新增(更新) 提前案資料207 期限
'      If stPA09 = "018" And (stPA08 = "1" Or stPA08 = "2") And Val(stCP06) > 0 Then
'         stSQL = ""
'         If PUB_ChkCPExist(cp, "207", 0, stNP01) Then
'            stSQL = "Update CaseProgress Set CP06=" & stCP06 & ",CP07=" & stCP07 & " Where CP09='" & stNP01 & "' and cp27 is null"
'         ElseIf PUB_ChkNPExist(cp, "207", 0, stNP22, stNP01) Then
'            stSQL = "Update NextProgress Set NP08=" & stCP06 & ",NP09=" & stCP07 & " Where NP22=" & stNP22 & " and NP01='" & stNP01 & "'"
'         ElseIf p_CP09 <> "" Then
'            stSQL = "declare intMax number;begin select max(np22)+1 into intMax from nextprogress;IF intMax IS NULL THEN intMax:=1; END IF;"
'            'Modified by Morgan 2014/7/18 PUB_GetAKindSalesNo()前後補單引號
'            stSQL = stSQL & "Insert Into NextProgress (NP01,NP02,NP03,NP04,NP05,NP07,NP08,NP09,NP10,NP22) " & _
'               " select cp09,cp01,cp02,cp03,cp04,'207'," & stCP06 & "," & stCP07 & ",'" & PUB_GetAKindSalesNo(p_PA01, p_PA02, p_PA03, p_PA04) & "',intMax from caseprogress where cp09='" & p_CP09 & "'; "
'            stSQL = stSQL & " end;"
'         End If
'         If stSQL <> "" Then cnnConnection.Execute stSQL, intR
'      End If
'end 2020/3/10
         
      'Add by Morgan 2008/10/20 從提申併入
      '若申請國家為 EPC 時更新[215-指定費]進度檔(下一程序)或新增指定費下一程序，期限同[416-實體審查]
      If stPA09 = "221" And Val(stCP06) > 0 Then
         
         'Added by Morgan 2024/12/26
         If PUB_ChkCPExist(cp, "1209", 1, stNP01) Then
            stSQL = "Update CaseProgress Set CP06=" & stCP06 & ",CP07=" & stCP07 & " Where CP09='" & stNP01 & "' and cp27 is null"
            cnnConnection.Execute stSQL, intR
         End If
         'end 2024/12/26
         
         stSQL = ""
         If PUB_ChkCPExist(cp, "215", 0, stNP01) Then
            stSQL = "Update CaseProgress Set CP06=" & stCP06 & ",CP07=" & stCP07 & " Where CP09='" & stNP01 & "' and cp27 is null"
         ElseIf PUB_ChkNPExist(cp, "215", 0, stNP22, stNP01) Then
            stSQL = "Update NextProgress Set NP08=" & stCP06 & ",NP09=" & stCP07 & " Where NP22=" & stNP22 & " and NP01='" & stNP01 & "'"
         ElseIf p_CP09 <> "" Then
            stSQL = "declare intMax number;begin select max(np22)+1 into intMax from nextprogress;IF intMax IS NULL THEN intMax:=1; END IF;"
            'Modified by Morgan 2014/7/18 PUB_GetAKindSalesNo()前後補單引號
            stSQL = stSQL & "Insert Into NextProgress (NP01,NP02,NP03,NP04,NP05,NP07,NP08,NP09,NP10,NP22) " & _
               " select cp09,cp01,cp02,cp03,cp04,'215'," & stCP06 & "," & stCP07 & ",'" & PUB_GetAKindSalesNo(p_PA01, p_PA02, p_PA03, p_PA04) & "',intMax from caseprogress where cp09='" & p_CP09 & "'; "
            stSQL = stSQL & " end;"
         End If
         If stSQL <> "" Then cnnConnection.Execute stSQL, intR
         
         'Add by Morgan 2011/9/27 +回覆檢索報告218 --慧汶
         stSQL = "" 'Added by Morgan 2012/7/16
         If PUB_ChkCPExist(cp, "218", 0, stNP01) Then
            stSQL = "Update CaseProgress Set CP06=" & stCP06 & ",CP07=" & stCP07 & " Where CP09='" & stNP01 & "' and cp27 is null"
         ElseIf PUB_ChkNPExist(cp, "218", 0, stNP22, stNP01) Then
            'Modified by Morgan 2024/12/9 +約定期限(依預設規則設定)--郭
            'stSQL = "Update NextProgress Set NP08=" & stCP06 & ",NP09=" & stCP07 & " Where NP22=" & stNP22 & " and NP01='" & stNP01 & "'"
            stNP23 = PUB_GetWorkDay1(CompDate(2, -28, stCP06), True)
            stSQL = "Update NextProgress Set NP08=" & stCP06 & ",NP09=" & stCP07 & ",NP23=" & stNP23 & " Where NP22=" & stNP22 & " and NP01='" & stNP01 & "' and (NP09<>" & stCP07 & " or NP08<>" & stCP06 & ")"
            'end 2024/12/9
         'Removed by Morgan 2012/2/4 不必新增----慧汶
         'ElseIf p_CP09 <> "" Then
         '   stSQL = "declare intMax number;begin select max(np22)+1 into intMax from nextprogress;IF intMax IS NULL THEN intMax:=1; END IF;"
         '   stSQL = stSQL & "Insert Into NextProgress (NP01,NP02,NP03,NP04,NP05,NP07,NP08,NP09,NP10,NP22) " & _
         '      " select cp09,cp01,cp02,cp03,cp04,'218'," & stCP06 & "," & stCP07 & ",'" & PUB_GetAKindSalesNo(p_PA01, p_PA02, p_PA03, p_PA04) & "',intMax from caseprogress where cp09='" & p_CP09 & "'; "
         '   stSQL = stSQL & " end;"
         End If
         If stSQL <> "" Then cnnConnection.Execute stSQL, intR
         'Modified by Lydia 2015/02/03 EPC有主張優先權之優先權案非為新型案，下一程序請掛提供前案，期限同實審。
         stSQL = ""
         'Modified by Lydia 2020/06/08
         'strExc(0) = " select * from pridate where pd01='" & p_PA01 & "' and pd02='" & p_PA02 & "' and pd03='" & p_PA03 & "' and pd04='" & p_PA04 & "' "
         strExc(0) = "select pd05,pd06,pd07,pd08,decode(pd08,'1',na26,'2',na28,'3',na30,null) 實審起算日 " & _
                          "from pridate,nation where pd01='" & p_PA01 & "' and pd02='" & p_PA02 & "' and pd03='" & p_PA03 & "' and pd04='" & p_PA04 & "' and pd07=na01(+) " & _
                          "order by pd08 "
         intI = 1: strExc(1) = ""
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
             RsTemp.MoveFirst
             'Modified by Lydia 2020/06/08 修改規則
             '1.若優先權為發明案，在輸入案件提申時，下一程序掛「提供前案」，期限同實審。
             '2.若優先權為新型案，但該所主張之優先權國家新型有實審制，在輸入案件提申時，下一程序掛「提供前案」，期限同實審。
             '3.若主張多筆優先權，且基礎案有發明案也有新型案，則在輸入案件提申時，下一程序掛「提供前案」，期限同實審。
             'Do While Not RsTemp.EOF
             '   If RsTemp!PD08 = "2" Then  '優先權案為新型案
             '      strExc(1) = "" & Trim(RsTemp!pd06)
             '   End If
             '   RsTemp.MoveNext
             'Loop
             'If strExc(1) = "" Then
             strExc(1) = "" & RsTemp.Fields("pd08")
             strExc(2) = "" & RsTemp.Fields("實審起算日")
             If strExc(1) <> "2" Or (strExc(1) = "2" And Val("" & RsTemp.Fields("實審起算日")) > 0) Then
             'end 2020/06/08
                 If PUB_ChkCPExist(cp, "207", 0, stNP01) Then
                    stSQL = "Update CaseProgress Set CP06=" & stCP06 & ",CP07=" & stCP07 & " Where CP09='" & stNP01 & "' and cp27 is null"
                    cnnConnection.Execute stSQL, intR 'Added by Lydi 2022/04/18
                 ElseIf PUB_ChkNPExist(cp, "207", 0, stNP22, stNP01) Then
                    stSQL = "Update NextProgress Set NP08=" & stCP06 & ",NP09=" & stCP07 & " Where NP22=" & stNP22 & " and NP01='" & stNP01 & "'"
                    cnnConnection.Execute stSQL, intR 'Added by Lydi 2022/04/18
                 ElseIf p_CP09 <> "" Then
                    'Added by Lydia 2022/04/18 調整設定：若優先權基礎案的國家為奧地利、丹麥、日本、中國大陸、韓國、西班牙、瑞典、瑞士、英國、美國，則新案發文時不在下一程序掛提供前案的期限，並在新案指示信帶出相關段落。
                    Do While Not RsTemp.EOF
                       If "" & RsTemp.Fields("PD07") <> "" And InStr(cntEPC新案發文不須提供前案, "" & RsTemp.Fields("PD07")) = 0 Then
                    'end 2022/04/18
                          stSQL = "declare intMax number;begin select max(np22)+1 into intMax from nextprogress;IF intMax IS NULL THEN intMax:=1; END IF;"
                          stSQL = stSQL & "Insert Into NextProgress (NP01,NP02,NP03,NP04,NP05,NP07,NP08,NP09,NP10,NP22) " & _
                             " select cp09,cp01,cp02,cp03,cp04,'207'," & stCP06 & "," & stCP07 & ",'" & PUB_GetAKindSalesNo(p_PA01, p_PA02, p_PA03, p_PA04) & "',intMax from caseprogress where cp09='" & p_CP09 & "'; "
                          stSQL = stSQL & " end;"
                          cnnConnection.Execute stSQL, intR
                          Exit Do 'Added by Morgan 2025/7/11 修正同國家主張多筆優先權會重複管制問題 Ex:CFP-034508
                    'Added by Lydia 2022/04/18
                       End If
                       RsTemp.MoveNext
                    Loop
                    'end 2022/04/18
                 End If
             End If
         End If
         'If stSQL <> "" Then cnnConnection.Execute stSQL, intR 'Mark by Lydia 2022/04/18
         'end  2015/02/03
      End If
      'Added by Lydia 2015/09/09 大陸發明案更新實審期限時，若同時有未發文的主動修正進度，同時更新實審期限至主動修正期限
      If stPA09 = "020" And stPA08 = "1" And Val(stCP06) > 0 Then
        If PUB_ChkCPExist(cp, "203", 1, stNP01) Then
           stSQL = "Update CaseProgress Set CP06=" & stCP06 & ",CP07=" & stCP07 & " Where CP09='" & stNP01 & "' and cp27 is null"
           cnnConnection.Execute stSQL, intR
        End If
      End If
      'end 2015/09/09
   End If
   Set adoRst = Nothing
End Sub
'Modify by Morgan 2009/4/28 +CP130
Public Sub PUB_UpdateDispatch(CP09s As String, CP123s As String, Optional CP130 As String)
   Dim ArrCP09, arrCP123
   Dim strCP09 As String, strCP123 As String
   Dim stSQL As String, ii As Integer, intR As Integer
   
   If CP09s <> "" Then
      ArrCP09 = Split(CP09s, ",")
      arrCP123 = Split(CP123s & ",", ",") '注意:若設定值為空字串時無法產生陣列所以多加一個逗號
      For ii = 0 To UBound(ArrCP09)
         strCP09 = ArrCP09(ii)
         strCP123 = arrCP123(ii)
         If ii = 0 Then
            stSQL = "update caseprogress set cp123=" & CNULL(strCP123) & ",cp130='" & CP130 & "' where cp09='" & strCP09 & "'"
         Else
            stSQL = "update caseprogress set cp123=" & CNULL(strCP123) & " where cp09='" & strCP09 & "'"
         End If
         cnnConnection.Execute stSQL, intR
      Next
   End If
End Sub
'Modify by Morgan 2009/8/13 排除PCT案
'Modify by Morgan 2009/8/12 更新相同案期限的案件性質改抓 SameCaseProperty4Update
'Modify by Morgan 2009/5/11 +期限更新備註
'Add by Morgan 2007/8/21 以美國公開日更新其他多國案期限
'pfield:美國案本所案號,pCP07:公開日(預定公開日)
'Modified by Morgan 2012/3/27 備註更換改抓到關鍵字起到第一個';'號止,不再用固定長度以方便放其他文字
Public Sub PUB_UpdCP07byPA12(PField() As String, pCP07 As String)

   Dim strCRList As String, strCP06 As String
   Dim strCP64 As String
   Dim strNP22 As String
   'Added by Morgan 2022/6/20
   Dim stSQL As String, intR As Integer
   Dim adoRst As ADODB.Recordset
   'end 2022/6/20
   
   strCP64 = "期限來源:" & Right("  " & PField(1), 3) & "-" & PField(2) & "-" & PField(3) & "-" & PField(4) & "(美國公開日);"
   
   strCRList = "select cr05,cr06,cr07,cr08 from caserelation where cr01='" & PField(1) & "' and cr02='" & PField(2) & "' and cr03='" & PField(3) & "' and cr04='" & PField(4) & "'"
   
'Modified by Morgan 2022/6/20
'本所期限算法比照以優先權日更新新案期限要逐案判斷申請國家等故改跑回圈更新
'   strCP06 = CompDate(2, -10, pCP07)
'   If Val(strCP06) < Val(strSrvDate(1)) Then
'      strCP06 = strSrvDate(1)
'   End If
'   '英語系
'   strSql = "UPDATE CASEPROGRESS C1 SET CP06=" & strCP06 & ",CP07=" & pCP07 & _
'      ",CP64=SUBSTR(CP64,1,INSTR(CP64,'期限來源:')-1)||'" & strCP64 & "'||SUBSTR(CP64,INSTR(CP64,';',instr(CP64,'期限來源:'))+1)" & _
'      " WHERE (CP01,CP02,CP03,CP04) IN (" & strCRList & ") AND CP27 IS NULL AND CP57 IS NULL" & _
'      " AND CP10 IN (" & SameCaseProperty4Update & ") AND ( CP07 IS NULL OR CP07>" & pCP07 & ")" & _
'      " AND NOT EXISTS(SELECT * FROM CASEPROGRESS C2 WHERE C2.CP01=C1.CP01 AND C2.CP02=C1.CP02 AND C2.CP03=C1.CP03 AND C2.CP04=C1.CP04 AND C2.CP10='106' AND C2.CP57 IS NULL)" & _
'      " AND EXISTS(SELECT * FROM PATENT WHERE PA01=CP01 AND PA02=CP02 AND PA03=CP03 AND PA04=CP04 AND PA46 IS NULL AND INSTR('" & NoneEngCountry & "',PA09)=0)"
'   cnnConnection.Execute strSql, intI

'   'Add by Morgan 2009/5/12 更新最終期限(已發文未提申有最終提申期限)
'   strSql = "update nextprogress set np08=" & strCP06 & ",np09=" & pCP07 & _
'      ",np15=SUBSTR(np15,1,INSTR(np15,'期限來源:')-1)||'" & strCP64 & "'||SUBSTR(np15,INSTR(np15,';',instr(np15,'期限來源:'))+1)" & _
'      " where np01 in (select cp09 from caseprogress C1 where cp10 in (" & SameCaseProperty4Update & ")" & _
'      " and (cp01,cp02,cp03,cp04) in (" & strCRList & ") and cp27>0 and cp47 is null and cp57 is null" & _
'      " AND NOT EXISTS(SELECT * FROM CASEPROGRESS C2 WHERE C2.CP01=C1.CP01 AND C2.CP02=C1.CP02 AND C2.CP03=C1.CP03 AND C2.CP04=C1.CP04 AND C2.CP10='106' AND C2.CP57 IS NULL)" & _
'      " AND EXISTS(SELECT * FROM PATENT WHERE PA01=CP01 AND PA02=CP02 AND PA03=CP03 AND PA04=CP04 AND PA46 IS NULL AND INSTR('" & NoneEngCountry & "',PA09)=0))" & _
'      " and np07='996' and np06 is null and np09>" & pCP07
'   cnnConnection.Execute strSql, intI
'
'   'Add by Morgan 2009/5/12 新增最終期限(已發文未提申且無最終提申期限)
'   strSql = "declare nNP22 number;begin select max(np22) into nNP22 from nextprogress;" & _
'      " insert into nextprogress a (np01,np02,np03,np04,np05,np07,np08,np09,np10,np15,np22)" & _
'      " select cp09,cp01,cp02,cp03,cp04,'996'," & strCP06 & "," & pCP07 & ",'" & strUserNum & "','" & strCP64 & "',nNP22+rownum" & _
'      " from caseprogress C1 where cp10 in (" & SameCaseProperty4Update & ")" & _
'      " and (cp01,cp02,cp03,cp04) in (" & strCRList & ") and cp27>0 and cp47 is null and cp57 is null" & _
'      " AND NOT EXISTS(SELECT * FROM CASEPROGRESS C2 WHERE C2.CP01=C1.CP01 AND C2.CP02=C1.CP02 AND C2.CP03=C1.CP03 AND C2.CP04=C1.CP04 AND C2.CP10='106' AND C2.CP57 IS NULL)" & _
'      " AND EXISTS(SELECT * FROM PATENT WHERE PA01=CP01 AND PA02=CP02 AND PA03=CP03 AND PA04=CP04 AND PA46 IS NULL AND INSTR('" & NoneEngCountry & "',PA09)=0)" & _
'      " and not exists(select * from nextprogress b where b.np01=cp09 and b.np07='996' and b.np06 is null);" & _
'      " end;"
'   cnnConnection.Execute strSql, intI
'
'   strCP06 = CompDate(2, -14, pCP07)
'   If Val(strCP06) < Val(strSrvDate(1)) Then
'      strCP06 = strSrvDate(1)
'   End If
'   '非英語系
'   strSql = "UPDATE CASEPROGRESS C1 SET CP06=" & strCP06 & ",CP07=" & pCP07 & _
'      ",CP64=SUBSTR(CP64,1,INSTR(CP64,'期限來源:')-1)||'" & strCP64 & "'||SUBSTR(CP64,INSTR(CP64,';',instr(CP64,'期限來源:'))+1)" & _
'      " WHERE (CP01,CP02,CP03,CP04) IN (" & strCRList & ") AND CP27 IS NULL AND CP57 IS NULL" & _
'      " AND CP10 IN (" & SameCaseProperty4Update & ") AND ( CP07 IS NULL OR CP07>" & pCP07 & ")" & _
'      " AND NOT EXISTS(SELECT * FROM CASEPROGRESS C2 WHERE C2.CP01=C1.CP01 AND C2.CP02=C1.CP02 AND C2.CP03=C1.CP03 AND C2.CP04=C1.CP04 AND C2.CP10='106' AND C2.CP57 IS NULL)" & _
'      " AND EXISTS(SELECT * FROM PATENT WHERE PA01=CP01 AND PA02=CP02 AND PA03=CP03 AND PA04=CP04 AND PA46 IS NULL AND INSTR('" & NoneEngCountry & "',PA09)>0)"
'   cnnConnection.Execute strSql, intI

   stSQL = "select cp09,pa09,pa08 from CASEPROGRESS C1,PATENT" & _
      " WHERE (CP01,CP02,CP03,CP04) IN (" & strCRList & ") AND CP27 IS NULL AND CP57 IS NULL" & _
      " AND CP10 IN (" & SameCaseProperty4Update & ") AND ( CP07 IS NULL OR CP07>" & pCP07 & ")" & _
      " AND NOT EXISTS(SELECT * FROM CASEPROGRESS C2 WHERE C2.CP01=C1.CP01 AND C2.CP02=C1.CP02 AND C2.CP03=C1.CP03 AND C2.CP04=C1.CP04 AND C2.CP10='106' AND C2.CP57 IS NULL)" & _
      " AND PA01(+)=CP01 AND PA02(+)=CP02 AND PA03(+)=CP03 AND PA04(+)=CP04 AND PA46 IS NULL"
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      With adoRst
      Do While Not .EOF
         '非英語系國家比照主張優先權的期限設定
         If InStr(NoneEngCountry, .Fields("pa09")) > 0 Then
            strCP06 = PUB_GetCP06byCP07(pCP07, .Fields("pa09"), .Fields("pa08"))
         Else
            strCP06 = CompDate(2, -10, pCP07)
         End If
         
         stSQL = "update caseprogress C1 set cp06=" & strCP06 & ",cp07=" & pCP07 & _
            ",CP64=SUBSTR(CP64,1,INSTR(CP64,'期限來源:')-1)||'" & strCP64 & "'||SUBSTR(CP64,INSTR(CP64,';',instr(CP64,'期限來源:'))+1)" & _
            " where cp09='" & .Fields("cp09") & "'"
         cnnConnection.Execute stSQL, intR
         .MoveNext
      Loop
      End With
   End If
'end 2022/6/20
   
   'Added by Morgan 2022/6/20 最終提申的本所期限(抓工作天)=法定期限
   strCP06 = PUB_GetWorkDay1(pCP07, True)
   If strCP06 < strSrvDate(1) Then
      strCP06 = strSrvDate(1)
   End If
   'end 2022/6/20

   'Add by Morgan 2009/5/12 更新最終期限(已發文未提申有最終提申期限)
   'Modified by Morgan 2018/9/17 假發文不必管制 cp27>0 --> cp27>19221111 --玫音 (Ex: CFP29677)
   'Modified by Morgan 2022/6/20 最終提申是用法定期限管制，與是否英語系無關(取消 AND INSTR('" & NoneEngCountry & "',PA09)>0 條件)
   stSQL = "update nextprogress set np08=" & strCP06 & ",np09=" & pCP07 & _
      ",np15=SUBSTR(np15,1,INSTR(np15,'期限來源:')-1)||'" & strCP64 & "'||SUBSTR(np15,INSTR(np15,';',instr(np15,'期限來源:'))+1)" & _
      " where np01 in (select cp09 from caseprogress C1 where cp10 in (" & SameCaseProperty4Update & ")" & _
      " and (cp01,cp02,cp03,cp04) in (" & strCRList & ") and cp27>19221111 and cp47 is null and cp57 is null" & _
      " AND NOT EXISTS(SELECT * FROM CASEPROGRESS C2 WHERE C2.CP01=C1.CP01 AND C2.CP02=C1.CP02 AND C2.CP03=C1.CP03 AND C2.CP04=C1.CP04 AND C2.CP10='106' AND C2.CP57 IS NULL)" & _
      " AND EXISTS(SELECT * FROM PATENT WHERE PA01=CP01 AND PA02=CP02 AND PA03=CP03 AND PA04=CP04 AND PA46 IS NULL AND PA57 IS NULL))" & _
      " and np07='996' and np06 is null and np09>" & pCP07
   cnnConnection.Execute stSQL, intR
   
   'Add by Morgan 2009/5/12 新增最終期限(已發文未提申且無最終提申期限)
   'Modified by Morgan 2018/9/17 假發文不必管制 cp27>0 --> cp27>19221111 --玫音 (Ex: CFP29677)
   'Modified by Morgan 2022/6/20 最終提申是用法定期限管制，與是否英語系無關(取消 AND INSTR('" & NoneEngCountry & "',PA09)>0 條件)
   strNP22 = GetNextProgressNo
   stSQL = " insert into nextprogress a (np01,np02,np03,np04,np05,np07,np08,np09,np10,np15,np22)" & _
      " select cp09,cp01,cp02,cp03,cp04,'996'," & strCP06 & "," & pCP07 & ",'" & strUserNum & "','" & strCP64 & "'," & strNP22 & "+rownum-1" & _
      " from caseprogress C1 where cp10 in (" & SameCaseProperty4Update & ")" & _
      " and (cp01,cp02,cp03,cp04) in (" & strCRList & ") and cp27>19221111 and cp47 is null and cp57 is null" & _
      " AND NOT EXISTS(SELECT * FROM CASEPROGRESS C2 WHERE C2.CP01=C1.CP01 AND C2.CP02=C1.CP02 AND C2.CP03=C1.CP03 AND C2.CP04=C1.CP04 AND C2.CP10='106' AND C2.CP57 IS NULL)" & _
      " AND EXISTS(SELECT * FROM PATENT WHERE PA01=CP01 AND PA02=CP02 AND PA03=CP03 AND PA04=CP04 AND PA46 IS NULL AND PA57 IS NULL)" & _
      " and not exists(select * from nextprogress b where b.np01=cp09 and b.np07='996' and b.np06 is null)"
   cnnConnection.Execute stSQL, intR

   Set adoRst = Nothing 'Added by Morgan 2022/6/20
End Sub
'Modify by Morgan 2009/8/13 排除PCT案
'Modify by Morgan 2009/8/12 更新相同案期限的案件性質改抓 SameCaseProperty4Update
'Modify by Morgan 2009/5/11 +期限更新備註
'Add by Morgan 2007/9/6 以發文日更新多國案期限
'pfield:任一多國案本所案號
'Modified by Morgan 2012/3/27 備註更換改抓到關鍵字起到第一個';'號止,不再用固定長度以方便放其他文字
Public Sub PUB_UpdCP07byCP27(PField() As String)
   
   Dim strCRList As String, stSQL As String, strCP06 As String, strCP07 As String
   Dim strDate As String, iRslt As Integer, rsTmp As ADODB.Recordset
   Dim strCP64 As String, stConCP As String
   Dim strNP22 As String
   
   strCRList = "select cr05,cr06,cr07,cr08 from caserelation where cr01='" & PField(1) & "' and cr02='" & PField(2) & "' and cr03='" & PField(3) & "' and cr04='" & PField(4) & "'" & _
      " union select '" & PField(1) & "','" & PField(2) & "','" & PField(3) & "','" & PField(4) & "' from dual"
   
   stSQL = "select pa09,cp27,PA01,PA02,PA03,PA04 from (" & strCRList & ") X,caseprogress,patent where cp01(+)=cr05 and cp02(+)=cr06 and cp03(+)=cr07 and cp04(+)=cr08" & _
      " and cp10='102' and cp27>0 and cp57 is null and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04" & _
      " and pa09 in ('011','231','015')"
      
   iRslt = 1
   Set rsTmp = ClsLawReadRstMsg(iRslt, stSQL)
   If iRslt = 1 Then
      With rsTmp
      Do While Not .EOF
         '日本新型發文預估2個月的核准日更新到其他多國新申請案的期限
         If .Fields("pa09") = "011" Then
            'Modified by Morgan 2012/4/16 改1個半月(45)天--郭
            'strDate = CompDate(1, 2, .Fields("cp27"))
            strDate = CompDate(2, 45, .Fields("cp27"))
         '德國新型發文預估3個月的核准日更新到其他多國新申請案的期限
         'Modified by Morgan 2016/8/11 改2禮拜 --郭雅娟
         ElseIf .Fields("pa09") = "231" Then
            'strDate = CompDate(1, 3, .Fields("cp27"))
            strDate = CompDate(2, 14, .Fields("cp27"))
         'end 2016/8/11
         '澳洲新型發文預估3禮拜的核准日更新到其他多國新申請案的期限
         ElseIf .Fields("pa09") = "015" Then
            strDate = CompDate(2, 21, .Fields("cp27"))
         End If
         If strCP07 = "" Or Val(strCP07) > Val(strDate) Then
            strCP07 = strDate
            strCP64 = "期限來源:" & Right("  " & .Fields("PA01"), 3) & "-" & .Fields("PA02") & "-" & .Fields("PA03") & "-" & .Fields("PA04") & "(預估核准日);"
            'Add by Morgan 2009/7/20 需排除本身案號
            stConCP = " and cp01||cp02||cp03||cp04<>'" & .Fields("PA01") & .Fields("PA02") & .Fields("PA03") & .Fields("PA04") & "'"
         End If
         .MoveNext
      Loop
      End With
   End If
   If strCP07 <> "" Then

      strCP06 = PUB_GetWorkDay1(strCP07, True)
      If Val(strCP06) < Val(strSrvDate(1)) Then
         strCP06 = strSrvDate(1)
      End If
      'Add by Morgan 2009/5/12 更新最終期限(已發文未提申有最終提申期限)
      stSQL = "update nextprogress set np08=" & strCP06 & ",np09=" & strCP07 & _
         ",np15=SUBSTR(np15,1,INSTR(np15,'期限來源:')-1)||'" & strCP64 & "'||SUBSTR(np15,INSTR(np15,';',instr(np15,'期限來源:'))+1)" & _
         " where np01 in (select cp09 from caseprogress C1 where cp10 in (" & SameCaseProperty4Update & ") and cp27>0 and cp47 is null and cp57 is null" & _
         " and (cp01,cp02,cp03,cp04) in (" & strCRList & ")" & stConCP & _
         " AND NOT EXISTS(SELECT * FROM patent WHERE PA01=C1.CP01 AND PA02=C1.CP02 AND PA03=C1.CP03 AND PA04=C1.CP04 AND PA46='Y')" & _
         " AND NOT EXISTS(SELECT * FROM CASEPROGRESS C2 WHERE C2.CP01=C1.CP01 AND C2.CP02=C1.CP02 AND C2.CP03=C1.CP03 AND C2.CP04=C1.CP04 AND C2.CP10='106' AND C2.CP57 IS NULL))" & _
         " and np07='996' and np06 is null and np09>" & strCP07
      cnnConnection.Execute stSQL, iRslt

      'Add by Morgan 2009/5/12 新增最終期限(已發文未提申且無最終提申期限)
      strNP22 = GetNextProgressNo
      stSQL = " insert into nextprogress a (np01,np02,np03,np04,np05,np07,np08,np09,np10,np15,np22)" & _
         " select cp09,cp01,cp02,cp03,cp04,'996'," & strCP06 & "," & strCP07 & ",'" & strUserNum & "','" & strCP64 & "'," & strNP22 & "+rownum-1" & _
         " from caseprogress C1 where cp10 in (" & SameCaseProperty4Update & ") and cp27>0 and cp47 is null and cp57 is null" & _
         " and (cp01,cp02,cp03,cp04) in (" & strCRList & ")" & stConCP & _
         " AND NOT EXISTS(SELECT * FROM patent WHERE PA01=C1.CP01 AND PA02=C1.CP02 AND PA03=C1.CP03 AND PA04=C1.CP04 AND PA46='Y')" & _
         " AND NOT EXISTS(SELECT * FROM CASEPROGRESS C2 WHERE C2.CP01=C1.CP01 AND C2.CP02=C1.CP02 AND C2.CP03=C1.CP03 AND C2.CP04=C1.CP04 AND C2.CP10='106' AND C2.CP57 IS NULL)" & _
         " and not exists(select * from nextprogress b where b.np01=cp09 and b.np07='996' and b.np06 is null)"
      cnnConnection.Execute stSQL, iRslt


      
      'Modified by Morgan 2012/10/19
      ''Modify by Morgan 2009/3/17 需排除有主張國際優先權的--跟郭確認過
      'stSQL = "update caseprogress C1 set cp06=" & strCP06 & ",cp07=" & strCP07 & _
         ",CP64=SUBSTR(CP64,1,INSTR(CP64,'期限來源:')-1)||'" & strCP64 & "'||SUBSTR(CP64,INSTR(CP64,';',instr(CP64,'期限來源:'))+1)" & _
         " where cp10 in (" & SameCaseProperty4Update & ") and cp27 is null and cp57 is null and (cp07 is null or cp07>" & strCP07 & ")" & _
         " and (cp01,cp02,cp03,cp04) in (" & strCRList & ")" & _
         " AND NOT EXISTS(SELECT * FROM patent WHERE PA01=C1.CP01 AND PA02=C1.CP02 AND PA03=C1.CP03 AND PA04=C1.CP04 AND PA46='Y')" & _
         " AND NOT EXISTS(SELECT * FROM CASEPROGRESS C2 WHERE C2.CP01=C1.CP01 AND C2.CP02=C1.CP02 AND C2.CP03=C1.CP03 AND C2.CP04=C1.CP04 AND C2.CP10='106' AND C2.CP57 IS NULL)"
      'cnnConnection.Execute stSQL, iRslt
      
      '本所期限算法比照以優先權日更新新案期限要逐案判斷申請國家等故改跑回圈更新
      '更新申請案
      stSQL = "select cp09,pa09,pa08 from caseprogress C1,patent" & _
         " where cp10 in (" & SameCaseProperty4Update & ") and cp27 is null and cp57 is null and (cp07 is null or cp07>" & strCP07 & ")" & _
         " and (cp01,cp02,cp03,cp04) in (" & strCRList & ")" & _
         " AND NOT EXISTS(SELECT * FROM CASEPROGRESS C2 WHERE C2.CP01=C1.CP01 AND C2.CP02=C1.CP02 AND C2.CP03=C1.CP03 AND C2.CP04=C1.CP04 AND C2.CP10='106' AND C2.CP57 IS NULL)" & _
         " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04 and pa46 is null"
      iRslt = 1
      Set rsTmp = ClsLawReadRstMsg(iRslt, stSQL)
      If iRslt = 1 Then
         With rsTmp
         Do While Not .EOF
            strCP06 = PUB_GetCP06byCP07(strCP07, .Fields("pa09"), .Fields("pa08"))
            If Val(strCP06) < Val(strSrvDate(1)) Then
               strCP06 = strSrvDate(1)
            End If
            stSQL = "update caseprogress C1 set cp06=" & strCP06 & ",cp07=" & strCP07 & _
               ",CP64=SUBSTR(CP64,1,INSTR(CP64,'期限來源:')-1)||'" & strCP64 & "'||SUBSTR(CP64,INSTR(CP64,';',instr(CP64,'期限來源:'))+1)" & _
               " where cp09='" & .Fields("cp09") & "'"
            cnnConnection.Execute stSQL, iRslt
            .MoveNext
         Loop
         End With
      End If
      'end 2012/10/19
      
   End If
   Set rsTmp = Nothing
End Sub
'Added by Morgan 2012/10/19
'CFP以法定期限計算本所期限
Public Function PUB_GetCP06byCP07(p_CP07 As String, p_PA09 As String, p_PA08 As String) As String
   '日本設計 -7 天
   'Modified by Morgan 2016/11/3 +韓國設計--郭
   If (p_PA09 = "011" Or p_PA09 = "012") And p_PA08 = "3" Then
      PUB_GetCP06byCP07 = PUB_GetWorkDay1(DBDATE(CompDate(2, -7, Format(p_CP07))), True)
   '非英語系 -21天
   ElseIf InStr(NoneEngCountry, p_PA09) > 0 Then
      PUB_GetCP06byCP07 = PUB_GetWorkDay1(DBDATE(CompDate(2, -21, Format(p_CP07))), True)
   Else
      PUB_GetCP06byCP07 = PUB_GetWorkDay1(DBDATE(CompDate(2, -7, Format(p_CP07))), True)
   End If
End Function

'Added by Lydia 2025/10/29 內專P案從法定期限取得本所期限、約定期限
         'P案法定,本所,約定期限三者之間的固定關係及規則---(8/27確認修改內容)郭經理提出的新規則：不含FMP案
Public Function PUB_GetPOurDeadline(ByVal pOfficialDeadline As String, ByVal pNA01 As String, Optional ByRef pAgreeOnDate As String, Optional ByVal pCP01 As String, Optional ByVal pCP10 As String) As String
'pOfficialDeadline法限(起算日)、PUB_GetPOurDeadlinep本所期限、pAgreeOnDate約定期限
Dim intQ As Integer, strQuery As String
Dim rsQuery As New ADODB.Recordset
Dim strCPM35 As String

   If pOfficialDeadline = "" Then Exit Function
   pOfficialDeadline = DBDATE(pOfficialDeadline)
   pAgreeOnDate = ""
   
   If pCP01 <> "" And pCP10 <> "" Then
      strQuery = "select CPM35 from CasePropertyMap Where CPM01='" & pCP01 & "' and CPM02='" & pCP10 & "' "
      intQ = 1
      Set rsQuery = ClsLawReadRstMsg(intQ, strQuery)
      If intQ = 1 Then
          strCPM35 = "" & rsQuery.Fields("CPM35")
      End If
      '239擇一申復也列入非實質
      If pCP10 = "239" Then strCPM35 = "2"
   End If
   
   If pNA01 = "000" Then
      '台灣：法定期限-2個工作天，約定期限(非實質CPM35=2)本所期限-5個工作日／約定期限(實質CPM35<>2)本所期限-10個工作日
      PUB_GetPOurDeadline = PUB_GetOurDeadline(pOfficialDeadline) '統一用該模組控制所有台灣案所限(含專利、商標...等)
      If pCP01 <> "" And pCP10 <> "" Then
         If strCPM35 = "2" Then
            pAgreeOnDate = CompWorkDay(5, CompDate(2, -1, PUB_GetPOurDeadline), 1)
         Else
            pAgreeOnDate = CompWorkDay(10, CompDate(2, -1, PUB_GetPOurDeadline), 1)
         End If
      End If
   Else
      '非台灣(不含FMP)：法定期限-5個工作天，約定期限(非實質CPM35=2)本所期限-5個工作日／約定期限(實質CPM35<>2)本所期限-15個工作日
      'Memo by Lydia 2025/10/31 非台灣案(大陸、香港、澳門和PCT)都是相同算法---郭經理(電話)
      PUB_GetPOurDeadline = CompWorkDay(5, CompDate(2, -1, pOfficialDeadline), 1) '不含法限當日-X個工作天
      If pCP01 <> "" And pCP10 <> "" Then
         If strCPM35 = "2" Then
            pAgreeOnDate = CompWorkDay(5, CompDate(2, -1, PUB_GetPOurDeadline), 1)
         Else
            pAgreeOnDate = CompWorkDay(15, CompDate(2, -1, PUB_GetPOurDeadline), 1)
         End If
      End If
   End If
   
   Set rsQuery = Nothing
End Function

'Added by Morgan 2014/10/2
'台灣案本所期限=法定期限－２個工作天（不含當日）
'pOfficialDeadline:法定期限
Public Function PUB_GetOurDeadline(pOfficialDeadline As String) As String
   PUB_GetOurDeadline = CompWorkDay(2, CompDate(2, -1, DBDATE(pOfficialDeadline)), 1)
End Function

'Added by Morgan 2019/7/11
'外專台灣案本所期限: 30天以內期限者，所限設定為法限前2個工作天，30天以上期限者，所限設定為法限前4個工作天。
'pOfficialDeadline:法定期限
'pDays:指定工作天數
'pStartDate:起算日
'pAgreeOnDate:約定期限 'Add By Sindy 2021/4/23
'Add By Sindy 2021/4/29 傳入N,代表要計算非主管機關的本所期限
'  Optional ByVal strCPM34 As String = ""
'Modify By Sindy 2023/6/7
'+ Optional ByVal strNP07 As String = "" : 下一程序
'  Optional ByVal strCP01 As String = "", Optional ByVal strCP02 As String = "", _
   Optional ByVal strCP03 As String = "", Optional ByVal strCP04 As String = "" : 本所案號
'Modify By Sindy 2025/2/12
'+ Optional ByVal strCP09 As String = "" : 總收文號
Public Function PUB_GetFCPOurDeadline(pOfficialDeadline As String, Optional pDays As Integer, _
   Optional pStartDate As String, Optional ByRef pAgreeOnDate As String, _
   Optional ByVal strCPM34 As String = "", Optional ByVal strNP07 As String = "", _
   Optional ByVal strCP01 As String = "", Optional ByVal strCP02 As String = "", _
   Optional ByVal strCP03 As String = "", Optional ByVal strCP04 As String = "", _
   Optional ByVal strCP09 As String = "") As String
   
Dim iDays As Integer
Dim strLDate As String, strSDate As String
Dim strPA150 As String
Dim strPA75 As String, strNP09 As String 'Add By Sindy 2025/2/12
Dim rsQuery As ADODB.Recordset 'Added by Morgan 2024/3/25
   
   pAgreeOnDate = "" 'Add By Sindy 2025/2/13
   strLDate = DBDATE(pOfficialDeadline)
   
   'Add By Sindy 2021/4/29 傳入N,代表要計算非主管機關的本所期限
   '以承辦期限＋5個工作天為本所期限
   If UCase(strCPM34) = "N" Then
      If Val(strLDate) > 0 Then
         PUB_GetFCPOurDeadline = CompWorkDay(5, CompDate(2, 1, DBDATE(strLDate)), 0)
      End If
      Exit Function
   End If
   '2021/4/29 END
   
   'Add By Sindy 2023/6/8
   'Modify By Sindy 2025/2/12 +,pa75
   strSql = "select pa150,pa75 from PATENT" & _
            " WHERE PA01='" & strCP01 & "' AND PA02='" & strCP02 & "' AND PA03='" & strCP03 & "' AND PA04='" & strCP04 & "'"
   intI = 1
   'Modified by Morgan 2024/3/25
   'Set RsTemp = ClsLawReadRstMsg(intI, strSql)
   Set rsQuery = ClsLawReadRstMsg(intI, strSql)
   'end 2024/3/25
   If intI = 1 Then
      'Modified by Morgan 2024/3/25
      'strPA150 = "" & RsTemp.Fields("pa150") 'FCP工程師組別
      strPA150 = "" & rsQuery.Fields("pa150") 'FCP工程師組別
      'end 2024/3/25
      strPA75 = "" & rsQuery.Fields("pa75") 'Add By Sindy 2025/2/12 FC代理人
   End If
   '2023/6/8 END
   
   'Add By Sindy 2025/2/12 檢查此文號是否有法定期限
   If Len(Trim(strCP09)) > 1 Then
      strSql = "select * from NEXTPROGRESS WHERE NP01='" & strCP09 & "'"
      intI = 1
      Set rsQuery = ClsLawReadRstMsg(intI, strSql)
      If intI = 1 Then
         strNP09 = "" & rsQuery.Fields("NP09")
      End If
   End If
   '2025/2/12 END
   
   iDays = pDays
   If iDays = 0 Then
      strSDate = pStartDate
      If strSDate = "" Then strSDate = strSrvDate(1)
      
      If strLDate >= CompDate(2, 30, strSDate) Then
         iDays = 4
      Else
         iDays = 2
      End If
   End If
   
   'Modify By Sindy 2021/4/23
   '2.新增與客戶約定期限：
   '原本本所期限前為法限前4個工作天:約定期限為法定期限前6工作天
   '原本本所期限前為法限前2個工作天:約定期限為法定期限前4工作天
   If strSrvDate(1) >= 外專台灣案約定期限啟用日 Then
      'Add By Sindy 2025/2/12
      'Y46706000 Ashida & Kimura Patent Attorneys來信之要求,
      '年費期限因為沒有智慧局來函，所以約定期限維持原計算方式
      '只要有來函有回答期限者(不限於智慧局)，都需要把約定期限修改為法限前兩週(遇假日請提早至前一個工作日)
      '例如:法限2025/02/13 => 約定期限2025/01/24
      If strPA75 = "Y46706000" And _
         (Left(strCP09, 1) = "C" Or Val(strNP09) > 0) Then
         pAgreeOnDate = CompWorkDay(1, CompDate(2, -14, DBDATE(strLDate)), 1)
      End If
      If pAgreeOnDate = "" Then
      '2025/2/12 END
         'Add By Sindy 2023/6/7 行政訴訟.503約定期限改為法限前10個工作天
         '故輸入1002核駁,相關收文號為501訴願, 產生下一程序約定期限為法限前10個工作天(所限不變)
         '***** 日本部不調整，日文組請維持原期限 *****
         If strNP07 = "503" And strPA150 <> "3" And strPA150 <> "" Then
            pAgreeOnDate = CompWorkDay(10, CompDate(2, -1, DBDATE(strLDate)), 1)
         Else
         '2023/6/7 END
            'Modify By Sindy 2021/6/11 + Or iDays = -4
            If iDays = 4 Or iDays = -4 Then
               pAgreeOnDate = CompWorkDay(6, CompDate(2, -1, DBDATE(strLDate)), 1)
            Else
               pAgreeOnDate = CompWorkDay(4, CompDate(2, -1, DBDATE(strLDate)), 1)
            End If
         End If
      End If
   End If
   '2021/4/23 END
   
   'Modify By Sindy 2021/4/23
   '1.本所期限：
   '原本為法限前4個工作天改為法定期限前2個工作天
   '原本為法限前2個工作天仍為法定期限前2個工作天
   If strSrvDate(1) >= 外專台灣案約定期限啟用日 Then
      PUB_GetFCPOurDeadline = CompWorkDay(2, CompDate(2, -1, DBDATE(strLDate)), 1)
   Else
   '2021/4/23 END
      PUB_GetFCPOurDeadline = CompWorkDay(iDays, CompDate(2, -1, DBDATE(strLDate)), 1)
   End If
   
   Set rsQuery = Nothing 'Added by Morgan 2024/3/25
End Function

'Modify by Morgan 2009/8/13 排除PCT案
'Modify by Morgan 2009/8/12 更新相同案期限的案件性質改抓 SameCaseProperty4Update
'Add by Morgan 2009/7/1
'以預定公告日更新多國案期限
'Modify by Morgan 2010/4/23 +strMsg:若更新之本所期限已過期時要彈訊息提醒
'Modified by Morgan 2012/3/27 備註更換改抓到關鍵字起到第一個';'號止,不再用固定長度以方便放其他文字
'Modified by Morgan 2015/9/16 +bolMail2Eng=更新期限是否EMail通知工程師
Public Sub PUB_UpdCP07byPA14(PField() As String, pCP07 As String, Optional ByRef strMsg As String, Optional ByVal strDateMsg As String = "(預定公告日)", Optional bolMail2Eng As Boolean = False)
   Dim stVTable As String, strCP06 As String
   Dim strCP64 As String, bolMsg As Boolean
   Dim stSQL As String, intR As Integer, intI1 As Integer, intI2 As Integer
   Dim adoRst As ADODB.Recordset
   Dim strNP22 As String
   Dim strContent As String 'Added by Morgan 2015/9/16
   Dim stConNoUs As String 'Added by Morgan 2015/9/22
   Dim stExpCaseList As String 'Added by Morgan 2022/6/20
   
   'Added by Morgan 2015/9/22
   '美國案另外用相關案的公開/公告日+1年來更新期限
   If strDateMsg = "(公開日)" Or strDateMsg = "(公告日)" Then
      stConNoUs = " AND NOT EXISTS(SELECT * FROM patent WHERE PA01=C1.CP01 AND PA02=C1.CP02 AND PA03=C1.CP03 AND PA04=C1.CP04 AND PA09='101')"
   End If
   'end 2015/9/22
   
   'Memo by Morgan 2015/9/18 備註格式要與 frm040104_g 同步
   strCP64 = "期限來源:" & Right("  " & PField(1), 3) & "-" & PField(2) & "-" & PField(3) & "-" & PField(4) & strDateMsg & ";"
   
   'Modofied by Morgan 2015/7/13 +CM10='0'
   'Modofied by Morgan 2016/2/17 +一案兩請
   '國內案
   stVTable = " SELECT CM05,CM06,CM07,CM08 FROM CASEMAP" & _
      " WHERE CM01='" & PField(1) & "' AND CM02='" & PField(2) & "' AND CM03='" & PField(3) & "' AND CM04='" & PField(4) & "' AND CM10 in ('0','3')"
   '國內案的其他國外案
   stVTable = stVTable & " UNION SELECT CM01,CM02,CM03,CM04 FROM CASEMAP WHERE (CM05,CM06,CM07,CM08) IN" & _
      " (SELECT CM05,CM06,CM07,CM08 FROM CASEMAP" & _
      " WHERE CM01='" & PField(1) & "' AND CM02='" & PField(2) & "' AND CM03='" & PField(3) & "' AND CM04='" & PField(4) & "' AND CM10 in ('0','3'))  AND CM10 in ('0','3')"
   '國內案的其他國外案的國外案
   stVTable = stVTable & " UNION SELECT CM01,CM02,CM03,CM04 FROM CASEMAP WHERE (CM05,CM06,CM07,CM08) IN" & _
      " (SELECT CM01,CM02,CM03,CM04 FROM CASEMAP WHERE (CM05,CM06,CM07,CM08) IN" & _
      " (SELECT CM05,CM06,CM07,CM08 FROM CASEMAP" & _
      " WHERE CM01='" & PField(1) & "' AND CM02='" & PField(2) & "' AND CM03='" & PField(3) & "' AND CM04='" & PField(4) & "' AND CM10 in ('0','3')) AND CM10 in ('0','3')) AND CM10 in ('0','3')"
   
   '國外案
   stVTable = stVTable & " UNION SELECT CM01,CM02,CM03,CM04 FROM CASEMAP" & _
      " WHERE CM05='" & PField(1) & "' AND CM06='" & PField(2) & "' AND CM07='" & PField(3) & "' AND CM08='" & PField(4) & "' AND CM10 in ('0','3')"
   '國外案的其他國外案
   'Modofied by Morgan 2016/2/17 +一案兩請
   stVTable = stVTable & " UNION SELECT CM01,CM02,CM03,CM04 FROM CASEMAP WHERE (CM05,CM06,CM07,CM08) IN" & _
      " (SELECT CM01,CM02,CM03,CM04 FROM CASEMAP" & _
      " WHERE CM05='" & PField(1) & "' AND CM06='" & PField(2) & "' AND CM07='" & PField(3) & "' AND CM08='" & PField(4) & "' AND CM10 in ('0','3')) AND CM10 in ('0','3')"
   'end 2015/7/13
   
'Modified by Morgan 2022/6/20
'本所期限算法比照以優先權日更新新案期限要逐案判斷申請國家等故改跑回圈更新
'   bolMsg = False
'   '本所期限=法定期限-10天
'   strCP06 = PUB_GetWorkDay1(CompDate(2, -10, pCP07), True)
'   If strCP06 < strSrvDate(1) Then
'      strCP06 = strSrvDate(1)
'      bolMsg = True
'   End If
'
'   'Modified by Morgan 2020/4/6 有主張國內優先權也要排除--郭(Ex:CFP-31552)
'   'Modify by Morgan 2009/11/2 FCP不必管制
'   stSQL = "UPDATE CASEPROGRESS C1 SET CP06=" & strCP06 & ",CP07=" & pCP07 & _
'      ",CP64=SUBSTR(CP64,1,INSTR(CP64,'期限來源:')-1)||'" & strCP64 & "'||SUBSTR(CP64,INSTR(CP64,';',instr(CP64,'期限來源:'))+1)" & _
'      " WHERE (CP01,CP02,CP03,CP04) IN (" & stVTable & ") AND CP01<>'FCP' AND CP27 IS NULL AND CP57 IS NULL" & _
'      " AND CP10 IN (" & SameCaseProperty4Update & ") AND ( CP07 IS NULL OR CP07>" & pCP07 & ")" & _
'      " AND NOT EXISTS(SELECT * FROM patent WHERE PA01=C1.CP01 AND PA02=C1.CP02 AND PA03=C1.CP03 AND PA04=C1.CP04 AND PA46='Y')" & stConNoUs & _
'      " AND NOT EXISTS(SELECT * FROM CASEPROGRESS C2 WHERE C2.CP01=C1.CP01 AND C2.CP02=C1.CP02 AND C2.CP03=C1.CP03 AND C2.CP04=C1.CP04 AND C2.CP10 in ('106','121') AND C2.CP57 IS NULL)"
'   cnnConnection.Execute strSql, intI
'
'   'Add by Morgan 2010/4/23
'   'Modified by Morgan 2015/9/16
'   'If bolMsg And intI > 0 Then
'   If (bolMsg Or bolMail2Eng) And intI > 0 Then
'   'end 2015/9/16
'      stSQL = "SELECT CP01||'-'||CP02||DECODE(CP03||CP04,'000','','-'||CP03||'-'||CP04) C1,CP01||'-'||CP02||decode(CP03||CP04,'000','','-'||CP03||'-'||CP04) RefNo,CP14" & _
'         " FROM CASEPROGRESS WHERE CP27||CP57 IS NULL AND CP06=" & strCP06 & " AND CP07=" & pCP07 & " AND INSTR(CP64,'" & strCP64 & "')>0"
'      intR = 1
'      Set adoRst = ClsLawReadRstMsg(intR, stSQL)
'      If intR = 1 Then
'         If bolMsg Then strMsg = strMsg & "下列案號本所期限已過期且已設定為系統日請確認！" & vbCrLf & vbCrLf
'         With adoRst
'         Do While Not .EOF
'            If bolMsg Then strMsg = strMsg & .Fields(0) & vbCrLf
'            'Added by Morgan 2015/9/16
'            If bolMail2Eng Then
'               'modify by sonia 2019/11/26 incCNV_CHINESE_MINKO改用incCNV_CHINESE_MINKO1
'               strContent = .Fields("RefNo") & "已更新期限為" & TranslateKeyWord(incCNV_CHINESE_MINKO1, strCP06, "") & "。"
'               strSql = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08)" & _
'                  " values( '" & strUserNum & "','" & .Fields("CP14") & "',to_char(sysdate,'yyyymmdd')" & _
'                  ",to_char(sysdate,'hh24miss'),'" & strContent & "','如旨')"
'               cnnConnection.Execute strSql, intI
'            End If
'            'end 2015/9/16
'            .MoveNext
'         Loop
'         End With
'      End If
'   End If
   
   'Modified by Lydia 2025/10/31 +,PA01,PA02,PA03,PA04,CP12,CP10
   stSQL = "select CP01||'-'||CP02||DECODE(CP03||CP04,'000','','-'||CP03||'-'||CP04) C1,CP01||'-'||CP02||decode(CP03||CP04,'000','','-'||CP03||'-'||CP04) RefNo" & _
      ",CP14,cp09,pa09,pa08,PA01,PA02,PA03,PA04,CP12,CP10 from CASEPROGRESS C1,PATENT" & _
      " WHERE (CP01,CP02,CP03,CP04) IN (" & stVTable & ") AND CP01<>'FCP' AND CP27||CP57 IS NULL" & _
      " AND CP10 IN (" & SameCaseProperty4Update & ") AND ( CP07 IS NULL OR CP07>" & pCP07 & ")" & _
      " AND PA01(+)=C1.CP01 AND PA02(+)=C1.CP02 AND PA03(+)=C1.CP03 AND PA04(+)=C1.CP04 AND PA46 is null" & stConNoUs & _
      " AND NOT EXISTS(SELECT * FROM CASEPROGRESS C2 WHERE C2.CP01=C1.CP01 AND C2.CP02=C1.CP02 AND C2.CP03=C1.CP03 AND C2.CP04=C1.CP04 AND C2.CP10 in ('106','121') AND C2.CP57 IS NULL)"
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      With adoRst
      Do While Not .EOF
         '非英語系國家比照主張優先權的期限設定
         If InStr(NoneEngCountry, .Fields("pa09")) > 0 Then
            strCP06 = PUB_GetCP06byCP07(pCP07, .Fields("pa09"), .Fields("pa08"))
         Else
            strCP06 = CompDate(2, -10, pCP07)
         End If
         'Added by Lydia 2025/10/31 屬於2025/10/29更新所限 ; 非台灣案(大陸、香港、澳門和PCT)都是相同算法---郭經理(電話)
         If "" & .Fields("PA01") = "P" And Left("" & .Fields("CP12"), 1) <> "F" And InStr("000,020,013,044,056", .Fields("PA09")) > 0 Then
             strCP06 = PUB_GetPOurDeadline(pCP07, "" & .Fields("PA09"), , "" & .Fields("PA01"), "" & .Fields("CP10"))
         End If
         'end 2025/10/31
         
         If Val(strCP06) < Val(strSrvDate(1)) Then
            strCP06 = strSrvDate(1)
            stExpCaseList = stExpCaseList & .Fields(0) & vbCrLf
         End If
         stSQL = "update caseprogress C1 set cp06=" & strCP06 & ",cp07=" & pCP07 & _
            ",CP64=SUBSTR(CP64,1,INSTR(CP64,'期限來源:')-1)||'" & strCP64 & "'||SUBSTR(CP64,INSTR(CP64,';',instr(CP64,'期限來源:'))+1)" & _
            " where cp09='" & .Fields("cp09") & "'"
         cnnConnection.Execute stSQL, intI1
         
         If bolMail2Eng Then
            strContent = .Fields("RefNo") & "已更新期限為" & TranslateKeyWord(incCNV_CHINESE_MINKO1, strCP06, "") & "。"
            strSql = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08)" & _
               " values( '" & strUserNum & "','" & .Fields("CP14") & "',to_char(sysdate,'yyyymmdd')" & _
               ",to_char(sysdate,'hh24miss'),'" & strContent & "','如旨')"
            cnnConnection.Execute strSql, intI1
         End If
         .MoveNext
      Loop
      End With
      
      If stExpCaseList <> "" Then strMsg = strMsg & "下列案號本所期限已過期且已設定為系統日請確認！" & vbCrLf & vbCrLf & stExpCaseList
   End If
'end 2022/6/20
   
   bolMsg = False
   strCP06 = PUB_GetWorkDay1(pCP07, True)
   If strCP06 < strSrvDate(1) Then
      strCP06 = strSrvDate(1)
      bolMsg = True
   End If
   
   '更新最終期限(已發文未提申有最終提申期限)
   'Memo by Lydia 2025/10/31 最終提申歸程序管制,不新增約定期限
   stSQL = "update nextprogress set np08=" & strCP06 & ",np09=" & pCP07 & _
      ",np15=SUBSTR(np15,1,INSTR(np15,'期限來源:')-1)||'" & strCP64 & "'||SUBSTR(np15,INSTR(np15,';',instr(np15,'期限來源:'))+1)" & _
      " where np01 in (select cp09 from caseprogress C1 where cp10 in (" & SameCaseProperty4Update & ")" & _
      " and (cp01,cp02,cp03,cp04) in (" & stVTable & ") and cp27>0 and cp44>'Y' and cp47 is null and cp57 is null" & _
      " AND NOT EXISTS(SELECT * FROM patent WHERE PA01=C1.CP01 AND PA02=C1.CP02 AND PA03=C1.CP03 AND PA04=C1.CP04 AND PA46='Y')" & stConNoUs & _
      " AND NOT EXISTS(SELECT * FROM CASEPROGRESS C2 WHERE C2.CP01=C1.CP01 AND C2.CP02=C1.CP02 AND C2.CP03=C1.CP03 AND C2.CP04=C1.CP04 AND C2.CP10 in ('106','121') AND C2.CP57 IS NULL)" & _
      " ) and np07='996' and np06 is null and np09>" & pCP07
   cnnConnection.Execute stSQL, intI1
   
   '新增最終期限(已發文未提申且無最終提申期限)
   strNP22 = GetNextProgressNo
   'Modified by Morgan 2014/6/25 +判斷必須為A類收文( 假收文不要 Ex. CFP-23622 )
   stSQL = " insert into nextprogress a (np01,np02,np03,np04,np05,np07,np08,np09,np10,np15,np22)" & _
      " select cp09,cp01,cp02,cp03,cp04,'996'," & strCP06 & "," & pCP07 & ",'" & strUserNum & "','" & strCP64 & "'," & strNP22 & "+rownum-1" & _
      " from caseprogress C1 where cp10 in (" & SameCaseProperty4Update & ")" & _
      " and (cp01,cp02,cp03,cp04) in (" & stVTable & ") and cp09<'B' and cp27>0 and cp44>'Y' and cp47 is null and cp57 is null" & _
      " AND NOT EXISTS(SELECT * FROM patent WHERE PA01=C1.CP01 AND PA02=C1.CP02 AND PA03=C1.CP03 AND PA04=C1.CP04 AND PA46='Y')" & stConNoUs & _
      " AND NOT EXISTS(SELECT * FROM CASEPROGRESS C2 WHERE C2.CP01=C1.CP01 AND C2.CP02=C1.CP02 AND C2.CP03=C1.CP03 AND C2.CP04=C1.CP04 AND C2.CP10 in ('106','121') AND C2.CP57 IS NULL)" & _
      " and not exists(select * from nextprogress b where b.np01=cp09 and b.np07='996' and b.np06 is null)"
   cnnConnection.Execute stSQL, intI2
   
   'Add by Morgan 2010/4/23
   If bolMsg And intI1 + intI2 > 0 Then
      stSQL = "SELECT NP02||'-'||NP03||DECODE(NP04||NP05,'000','','-'||NP04||'-'||NP05) C1 FROM nextprogress WHERE np07='996' and np06 is null" & _
         " AND np08=" & strCP06 & " AND NP09=" & pCP07 & " AND INSTR(np15,'" & strCP64 & "')>0"
      intR = 1
      Set adoRst = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         strMsg = strMsg & "下列案號最終提申期限已過期且已設定為系統日請確認！" & vbCrLf & vbCrLf
         Do While Not adoRst.EOF
            strMsg = strMsg & adoRst(0) & vbCrLf
            adoRst.MoveNext
         Loop
      End If
   End If
   Set adoRst = Nothing
End Sub

'Added by Morgan 2015/9/22
'以國內案公開/公告日+1年更新美國案期限
Public Sub PUB_UpdateUSCase(PField() As String, ByVal pCP07 As String, Optional ByRef strMsg As String, Optional ByVal strDateMsg As String)
   Dim stVTable As String, strCP06 As String
   Dim strCP64 As String, bolMsg As Boolean
   Dim stSQL As String, intR As Integer
   Dim adoRst As ADODB.Recordset
   
   pCP07 = CompDate(0, 1, pCP07)
   strDateMsg = Replace(strDateMsg, "日", "日+1年")
   
   '本所期限=法定期限-10天
   strCP06 = PUB_GetWorkDay1(CompDate(2, -10, pCP07), True)
   If strCP06 < strSrvDate(1) Then
      strCP06 = strSrvDate(1)
      bolMsg = True
   End If
   
   strCP64 = "期限來源:" & Right("  " & PField(1), 3) & "-" & PField(2) & "-" & PField(3) & "-" & PField(4) & strDateMsg & ";"
   stVTable = PUB_GetRefCaseMapSQL(PField)
   '美國非PCT案
   stSQL = "SELECT CP09,CP01||'-'||CP02||decode(CP03||CP04,'000','','-'||CP03||'-'||CP04) RefNo" & _
         " FROM CASEPROGRESS C1 WHERE (CP01,CP02,CP03,CP04) IN (" & stVTable & ") AND CP01='CFP'" & _
         " AND CP10 IN (" & SameCaseProperty4Update & ") AND CP27||CP57 IS NULL" & _
         " AND EXISTS(SELECT * FROM patent WHERE PA01=C1.CP01 AND PA02=C1.CP02 AND PA03=C1.CP03 AND PA04=C1.CP04 AND PA46 is null AND PA09='101')" & _
         " AND NOT EXISTS(SELECT * FROM CASEPROGRESS C2 WHERE C2.CP01=C1.CP01 AND C2.CP02=C1.CP02 AND C2.CP03=C1.CP03 AND C2.CP04=C1.CP04 AND C2.CP10='106' AND C2.CP57 IS NULL)"
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      If bolMsg Then strMsg = strMsg & "下列案號本所期限已過期且已設定為系統日請確認！" & vbCrLf & vbCrLf
      With adoRst
      Do While Not .EOF
         If bolMsg Then strMsg = strMsg & .Fields("RefNo") & vbCrLf
         stSQL = "UPDATE CASEPROGRESS C1 SET CP06=" & strCP06 & ",CP07=" & pCP07 & _
            ",CP64=SUBSTR(CP64,1,INSTR(CP64,'期限來源:')-1)||'" & strCP64 & "'||SUBSTR(CP64,INSTR(CP64,';',instr(CP64,'期限來源:'))+1)" & _
            " where CP09='" & .Fields("cp09") & "'"
         cnnConnection.Execute stSQL, intR
         .MoveNext
      Loop
      End With
   End If
   Set adoRst = Nothing
End Sub

'Added by Morgan 2017/3/31
'大陸分割案期限=原始母案的 領證601(不論是否發文)
'Modified by Morgan 2024/6/18 CFP改為只要抓上一層母案就好，不必抓原始母案--玫音
'CFP分割案期限=母案的 領證601或答辯107(不論是否發文) Added by Morgan 2018/3/28--甄妮
'                        +選取208或訴願501 Added by Morgan 2021/9/22--玫音
'                        +期末拋棄126,再考量試行計畫438,請求繼續審查424 (美國分割分案規則併入) 'Added by Morgan 2022/6/16
'pOrgCP01~CP04:母案本所案號
'pOrgIs307:母案是否為分割案 Added by Morgan 2019/12/26
Public Sub PUB_Get307CtrlDate(ByVal pOrgCP01 As String, ByVal pOrgCP02 As String, ByVal pOrgCP03 As String, ByVal pOrgCP04 As String, Optional ByRef p307CP06 As String, Optional ByRef p307CP07 As String, Optional ByRef pOrgIs307 As Boolean = False)
   Dim rsQuery As ADODB.Recordset
   Dim stSQL As String, intQ As Integer
   Dim bolOrgCaseExist As Boolean
   Dim stCP10 As String
   
   'Added by Morgan 2018/3/29
   If pOrgCP01 = "CFP" Then
      'Modified by Morgan 2024/6/14 改用常數以便CFP來函判斷是否要更新分割案期限
      'stCP10 = "107,601,208,501,126,438,424"
      stCP10 = CFP分割案抓母案期限的性質
      'end 2024/6/14
   Else
      stCP10 = "601"
   End If
   'end 2018/3/29
   
   p307CP06 = "": p307CP07 = ""
   Do
      'Modified by Morgan 2022/6/16 改抓下一程序
      'stSQL = "select dc05,dc06,dc07,dc08,c1.cp09 C307cp09,c2.cp09 RefCP09,c2.cp06 RefCP06,c2.cp07 RefCP07,c2.cp27 RefCP27" & _
         " from patent,divisioncase,caseprogress c1,caseprogress c2" & _
         " where pa01='" & pOrgCP01 & "' and pa02='" & pOrgCP02 & "' and pa03='" & pOrgCP03 & "' and pa04='" & pOrgCP04 & "'" & _
         " and dc01(+)=pa01 and dc02(+)=pa02 and dc03(+)=pa03 and dc04(+)=pa04 and c1.cp01(+)=pa01 and c1.cp02(+)=pa02 and c1.cp03(+)=pa03 and c1.cp04(+)=pa04 and c1.cp10(+)='307'" & _
         " and c2.cp01(+)=pa01 and c2.cp02(+)=pa02 and c2.cp03(+)=pa03 and c2.cp04(+)=pa04 and instr('" & stCP10 & "',c2.cp10(+))>0 and c2.cp57(+) is null order by c2.cp07 desc"
      stSQL = "select dc05,dc06,dc07,dc08,cp09 C307cp09,np01 RefCP09,np08 RefCP06,np09 RefCP07" & _
         " from patent,caseprogress,nextprogress,divisioncase" & _
         " where pa01='" & pOrgCP01 & "' and pa02='" & pOrgCP02 & "' and pa03='" & pOrgCP03 & "' and pa04='" & pOrgCP04 & "'" & _
         " and cp01(+)=pa01 and cp02(+)=pa02 and cp03(+)=pa03 and cp04(+)=pa04 and cp10(+)='307'" & _
         " and np02(+)=pa01 and np03(+)=pa02 and np04(+)=pa03 and np05(+)=pa04 and instr('" & stCP10 & "',np07(+))>0" & _
         " and dc01(+)=pa01 and dc02(+)=pa02 and dc03(+)=pa03 and dc04(+)=pa04 order by np09 desc"
      'end 2022/6/16
      intQ = 1
      Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
      If intQ = 1 Then
         '母案為分割案
         If Not IsNull(rsQuery("C307cp09")) Then
            pOrgIs307 = True 'Added by Morgan 2019/12/26
            
            'Added by Morgan 2024/6/18 CFP改為只要抓上一層母案就好，不必抓原始母案--玫音
            If pOrgCP01 = "CFP" Then
               bolOrgCaseExist = True
               Exit Do
            Else
            'end 2024/6/18
            
               If Not IsNull(rsQuery("dc05")) Then
                  pOrgCP01 = rsQuery("dc05"): pOrgCP02 = rsQuery("dc06"): pOrgCP03 = rsQuery("dc07"): pOrgCP04 = rsQuery("dc08")
               '沒有原始母案
               Else
                  Exit Do
               End If
               
            End If
         '原始母案
         Else
            bolOrgCaseExist = True
            Exit Do
         End If
      '母案無期限
      Else
         Exit Do
      End If
   Loop
   
   If bolOrgCaseExist Then
      If Not IsNull(rsQuery("RefCP09")) Then
         p307CP06 = "" & rsQuery("RefCP06")
         p307CP07 = "" & rsQuery("RefCP07")
      Else
         'Modified by Morgan 2023/5/25 +改同上面的規則(最後的期限)
         'stSQL = "select n1.np01 RefNP01,n1.np08 RefNP08,n1.np09 RefNP09,n1.np07" & _
            " from nextprogress n1 where n1.np02='" & pOrgCP01 & "'" & _
            " and n1.np03='" & pOrgCP02 & "' and n1.np04='" & pOrgCP03 & "'" & _
            " and n1.np05='" & pOrgCP04 & "' and n1.np07 in (" & stCP10 & ") and n1.np06 is null"
         stSQL = "select n1.np01 RefNP01,n1.np08 RefNP08,n1.np09 RefNP09,n1.np07" & _
            " from nextprogress n1 where n1.np02='" & pOrgCP01 & "'" & _
            " and n1.np03='" & pOrgCP02 & "' and n1.np04='" & pOrgCP03 & "'" & _
            " and n1.np05='" & pOrgCP04 & "' and n1.np07 in (" & stCP10 & ") order by np09 desc"
         'end 2023/5/25
         intQ = 1
         Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
         If intQ = 1 Then
            p307CP06 = "" & rsQuery("RefNP08")
            p307CP07 = "" & rsQuery("RefNP09")
         End If
      End If
   End If
   Set rsQuery = Nothing
End Sub

'Add by Morgan 2009/7/15
'更新大陸分割案期限
'更新CFP分割案期限 'Added by Morgan 2018/3/28
'Modified by Morgan 2017/3/30
''分割307:母案的 領證601(不論是否發文) 或 修正204(未發文)、陳述意見205(未發文) 期限, 2015/5/22 再加復審107、行政訴訟503(P-111643(母案P-103293))
'分割307:原始母案的 領證601(不論是否發文)
'end 2017/3/30
'實審416:母案的申請日(優先權日)+3年或分割發文日(提申日)+2個月(取大者,分割發文才需掛期限)
Public Function PUB_Update307Ref(p307CP09 As String) As String
   Dim stSQL As String, intR As Integer, stCaseNo As String
   Dim stCP06 As String, stCP07 As String
   Dim st416CP06 As String, st416CP07 As String, st416CP07_1 As String
   Dim adoRst As ADODB.Recordset
   Dim adoRst2 As ADODB.Recordset
   Dim stOrgCP(4) As String, bolOrgCaseExist As Boolean 'Added by Morgan 2017/3/31
   
   'modify by sonia 2014/11/10 +pa08要檢查設計案不掛實審期限且分割案專利種類一定與母案相同,P-101812
   'Modified by Morgan 2015/9/18 取消母案未閉卷判斷 Ex.P-112495(母案 P-103513)
   stSQL = "select c1.cp27 C307cp27,dc05,dc06,dc07,dc08,pa10" & _
      ",c3.cp09 C416cp09,c3.cp27 C416cp27,n2.np01 C416np01,c1.cp01||'-'||c1.cp02||decode(c1.cp03||c1.cp04,'000','','-'||c1.cp03||'-'||c1.cp04) CNo" & _
      ",c1.cp47 C307cp47,pa08,c1.cp12 from caseprogress c1,DIVISIONCASE,patent,caseprogress c3,nextprogress n2" & _
      " where c1.cp09='" & p307CP09 & "'" & _
      " and dc01(+)=c1.cp01 and dc02(+)=c1.cp02 and dc03(+)=c1.cp03 and dc04(+)=c1.cp04 and dc05 is not null" & _
      " and pa01(+)=dc05 and pa02(+)=dc06 and pa03(+)=dc07 and pa04(+)=dc08 and pa10>0" & _
      " and c3.cp01(+)=c1.cp01 and c3.cp02(+)=c1.cp02 and c3.cp03(+)=c1.cp03 and c3.cp04(+)=c1.cp04 " & _
      " and c3.cp10(+)='416' and c3.cp57(+) is null" & _
      " and n2.np02(+)=c1.cp01 and n2.np03(+)=c1.cp02" & _
      " and n2.np04(+)=c1.cp03 and n2.np05(+)=c1.cp04" & _
      " and n2.np06(+) is null and n2.np07(+)='416'"
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      stCaseNo = "" & adoRst("CNo")
      '分案實審未發文
      If IsNull(adoRst("C416cp27")) Then
         '分案未發文
         If IsNull(adoRst("C307cp27")) Then
            'Modify by Morgan 2009/9/4 母案的 領證(不論是否發文) 或 陳述意見(未發文) 期限
            'Modified by Morgan 2013/10/17 +204修正
            'modify by sonia 2015/5/22 +107復審、503行政訴訟 P-111643(母案P-103293)
            'Modified by Morgan 2017/3/31 改只抓原始母案的領證期限,其他不必考慮--郭雅娟
            'stSQL = "select c2.cp09 C601cp09,c2.cp27 C601cp27,c2.cp06 C601cp06,c2.cp07 C601cp07,c2.CP10" & _
               " from caseprogress c2 where c2.cp01='" & adoRst("dc05") & "'" & _
               " and c2.cp02='" & adoRst("dc06") & "' and c2.cp03='" & adoRst("dc07") & "'" & _
               " and c2.cp04='" & adoRst("dc08") & "' and c2.cp57 is null" & _
               " and (c2.cp10='601' or ((c2.cp10='204' or c2.cp10='205' or c2.cp10='107' or c2.cp10='503')  and c2.cp27 is null))"
            'intR = 1
            'Set adoRst2 = ClsLawReadRstMsg(intR, stSQL)
            ''CP
            'If intR = 1 Then
            '   stCP06 = "" & adoRst2("c601cp06")
            '   stCP07 = "" & adoRst2("C601cp07")
            ''NP
            'Else
            '   'Modified by Morgan 2013/10/17 +204修正
            '   'modify by sonia 2015/5/22 +107復審、503行政訴訟 P-111643(母案P-103293)
            '   stSQL = "select n1.np01 C601np01,n1.np08 C601np08,n1.np09 C601np09,n1.np07" & _
            '      " from nextprogress n1 where n1.np02='" & adoRst("dc05") & "'" & _
            '      " and n1.np03='" & adoRst("dc06") & "' and n1.np04='" & adoRst("dc07") & "'" & _
            '      " and n1.np05='" & adoRst("dc08") & "' and n1.np07 in ('601','204','205','107','503') and n1.np06 is null"
            '   intR = 1
            '   Set adoRst2 = ClsLawReadRstMsg(intR, stSQL)
            '   If intR = 1 Then
            '      stCP06 = "" & adoRst2("C601np08")
            '      stCP07 = "" & adoRst2("C601np09")
            '   End If
            'End If
            PUB_Get307CtrlDate adoRst("dc05"), adoRst("dc06"), adoRst("dc07"), adoRst("dc08"), stCP06, stCP07
            'end 2017/3/31
         
            If Val(stCP07) > 0 Then
               intR = 0
               stSQL = "update caseprogress set cp06=" & CNULL(stCP06, True) & _
                  ",cp07=" & CNULL(stCP07, True) & " where cp09='" & p307CP09 & "'"
               cnnConnection.Execute stSQL, intR
               
               If intR > 0 Then
                  PUB_Update307Ref = "分割案 " & stCaseNo & " 期限已更新！" & vbCrLf & vbCrLf & "(法限：" & ChangeWStringToTDateString(stCP07) & ")"
               End If
            End If
         
         'Modified by Morgan 2015/5/13 提早判斷可省去期限計算
         'Else
         ElseIf ("" & adoRst("pa08")) = "1" And adoRst("dc05") <> "CFP" Then 'Modified by Morgan 2018/3/28 排除CFP案
         'end 2015/5/13
         
            stSQL = "select pd05 from pridate where pd01='" & adoRst("dc05") & "'" & _
               " and pd02='" & adoRst("dc06") & "' and pd03='" & adoRst("dc07") & "'" & _
               " and pd04='" & adoRst("dc08") & "' order by pd05 asc"
            intR = 1
            Set adoRst2 = ClsLawReadRstMsg(intR, stSQL)
            If intR = 1 Then
               st416CP07 = CompDate(0, 3, adoRst2(0))
            Else
               st416CP07 = CompDate(0, 3, adoRst("pa10"))
            End If
            
            'Add by Morgan 2009/9/4
            If Val("" & adoRst("C307cp47")) > 0 Then
               st416CP07_1 = CompDate(1, 2, adoRst("C307cp47"))
            ElseIf Val("" & adoRst("C307cp27")) > 0 Then
               st416CP07_1 = CompDate(1, 2, adoRst("C307cp27"))
            End If
            If st416CP07_1 > st416CP07 Then
               st416CP07 = st416CP07_1
            End If
            'end 2009/9/4
            
            'Modified by Morgan 2015/5/13 不必考慮分割案期限--陳玲玲 Ex.P-104503
            'If st416CP07 < stCP07 Then
            '   st416CP07 = stCP07
            '   st416CP06 = stCP06
            'Else
            'Added by Morgan 2015/10/6
            'FMP案所限=法限-10天
            'strExc(4) = "" 'Add By Sindy 2021/8/17 'Removed by Morgan 2024/6/4 沒期限不要回寫否則約定期限會被清除 Ex:P-133394,P-133566
            If Left(adoRst("cp12"), 1) = "F" Then
               st416CP06 = CompDate(2, -10, st416CP07)
            Else
            'end 2015/10/6
               strExc(0) = ""
               strExc(1) = "P"
               strExc(2) = "020"
               strExc(3) = st416CP07
               GetCtrlDT strExc
               st416CP06 = strExc(0)
            'End If
            'end 2015/5/13
            End If 'Added by Morgan 2015/10/6
            
            'modify by sonia 2014/11/10 +pa08判斷,檢查設計案不掛實審期限且分割案專利種類一定與母案相同,P-101812
            If Val(st416CP07) > 0 And ("" & adoRst("pa08")) = "1" Then
               st416CP06 = PUB_GetWorkDay1(st416CP06, True) 'Added by Morgan 2012/7/11 所限要是工作天
               intR = 0
               If Not IsNull(adoRst("C416cp09")) Then
                  stSQL = "update caseprogress set cp06=" & CNULL(st416CP06, True) & _
                     ",cp07=" & CNULL(st416CP07, True) & " where cp09='" & adoRst("C416cp09") & "'"
                  cnnConnection.Execute stSQL, intR
               ElseIf Not IsNull(adoRst("C416np01")) Then
                  'Add By Sindy 2021/8/17 + ",np23=" & CNULL(strExc(4), True)
                  'Modified by Morgan 2024/6/4 取消 NP23(無約定期限不可寫入)
                  stSQL = "update nextprogress set np08=" & CNULL(st416CP06, True) & _
                     ",np09=" & CNULL(st416CP07, True) & " where np01='" & adoRst("C416np01") & "'" & _
                     " and np06 is null and np07='416'"
                  cnnConnection.Execute stSQL, intR
               Else
                  'Add By Sindy 2021/8/17 + ,np23
                  'Modified by Morgan 2024/6/4 取消 NP23(無約定期限不可寫入)
                  stSQL = "insert into nextprogress (np01,np02,np03,np04,np05,np07,np08,np09,np10,np22)" & _
                     " select cp09,cp01,cp02,cp03,cp04,'416'," & st416CP06 & "," & st416CP07 & ",cp13,np22" & _
                     " from caseprogress,(select max(np22)+1 np22 from nextprogress) where cp09='" & p307CP09 & "'"
                  cnnConnection.Execute stSQL, intR
               End If
               If intR > 0 Then
                  PUB_Update307Ref = "分割案 " & stCaseNo & " 實審期限已更新！" & vbCrLf & vbCrLf & "(法限：" & ChangeWStringToTDateString(st416CP07) & ")"
               End If
            End If
         End If
         
      End If
   End If
   
   Set adoRst = Nothing
   Set adoRst2 = Nothing
End Function

'更新台灣分割案期限(參考PUB_Update307Ref)
'分割307:母案未發文的 修正(204)、申復(205) 或 再審(107) 的期限
'Modified by Morgan 2021/8/20 +pCP06,pCP07 (回傳)
Public Function PUB_Update307RefTw(p307CP09 As String, Optional pCP06 As String, Optional pCP07 As String) As String
   Dim stSQL As String, intR As Integer, stCaseNo As String
   Dim stCP06 As String, stCP07 As String
   Dim st416CP06 As String, st416CP07 As String, st416CP07_1 As String
   Dim adoRst As ADODB.Recordset
   Dim adoRst2 As ADODB.Recordset
   Dim stDate(3) As String
   
    'Modified by Morgan 2015/9/18 取消母案未閉卷判斷 Ex.P-112495(母案 P-103513)
    stSQL = "select c1.cp27 C307cp27,dc05,dc06,dc07,dc08,pa10" & _
      ",c3.cp09 C416cp09,c3.cp27 C416cp27,n2.np01 C416np01,c1.cp01||'-'||c1.cp02||decode(c1.cp03||c1.cp04,'000','','-'||c1.cp03||'-'||c1.cp04) CNo" & _
      " from caseprogress c1,DIVISIONCASE,patent,caseprogress c3,nextprogress n2" & _
      " where c1.cp09='" & p307CP09 & "'" & _
      " and dc01(+)=c1.cp01 and dc02(+)=c1.cp02 and dc03(+)=c1.cp03 and dc04(+)=c1.cp04 and dc05 is not null" & _
      " and pa01(+)=dc05 and pa02(+)=dc06 and pa03(+)=dc07 and pa04(+)=dc08 and pa10>0" & _
      " and c3.cp01(+)=c1.cp01 and c3.cp02(+)=c1.cp02 and c3.cp03(+)=c1.cp03 and c3.cp04(+)=c1.cp04 " & _
      " and c3.cp10(+)='416' and c3.cp57(+) is null" & _
      " and n2.np02(+)=c1.cp01 and n2.np03(+)=c1.cp02" & _
      " and n2.np04(+)=c1.cp03 and n2.np05(+)=c1.cp04" & _
      " and n2.np06(+) is null and n2.np07(+)='416'"
      
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      stCaseNo = "" & adoRst("CNo")
      '分割未發文
      If IsNull(adoRst("C307cp27")) Then
         'Added by Morgan 2012/8/14 102新法
         '發明母案初審准後30日內可分割(101/12/2~31核准案件由人工自行管控)
         'Modified by Morgan 2012/12/21 改 20121202 以後核准就更新
         'Modified by Morgan 2012/12/25 考慮中間來所案件改判斷沒有再審發文,核准日抓核准函收文日或基本檔核准日
         'Modified by Morgan 2014/4/8 +考慮母案是分割案
         'Modified by Morgan 2019/10/3 +考慮母案是再審准
         'Modified by Morgan 2021/8/24 +不可排除有再審發文(取消 and c2.cp09 is null 條件) Ex:P-127991,P-126539--玲玲
         'Modified by Morgan 2021/12/1 取消母案為發明案限制，因新型也適用
         'Modified by Morgan 2023/6/19 申請案的案件性質也要+102,301,302 ( and c1.cp10(+)='101' --> and instr('101,102,301,302',c1.cp10(+))>0 FCP-069735
         stSQL = "select pa01,nvl(nvl(c5.cp05,c3.cp05),pa20) RD1st,nvl(nvl(nvl(c6.cp05,c5.cp05),c3.cp05),pa20) RD3st from patent,caseprogress c1,caseprogress c2,caseprogress c3,caseprogress c4,caseprogress c5" & _
            ",caseprogress c6 where pa01='" & adoRst("dc05") & "' and pa02='" & adoRst("dc06") & "' and pa03='" & adoRst("dc07") & "' and pa04='" & adoRst("dc08") & "'" & _
            " and pa16='1' and pa20>20121202" & _
            " and c1.cp01(+)=pa01 and c1.cp02(+)=pa02 and c1.cp03(+)=pa03 and c1.cp04(+)=pa04 and instr('101,102,301,302',c1.cp10(+))>0 and c2.cp27(+)>0" & _
            " and c2.cp01(+)=pa01 and c2.cp02(+)=pa02 and c2.cp03(+)=pa03 and c2.cp04(+)=pa04 and c2.cp10(+)='107' and c2.cp27(+)>0" & _
            " and c3.cp43(+)=c1.cp09 and c3.cp10(+)='1001'" & _
            " and c4.cp01(+)=pa01 and c4.cp02(+)=pa02 and c4.cp03(+)=pa03 and c4.cp04(+)=pa04 and c4.cp10(+)='307' and c4.cp27(+)>0" & _
            " and c5.cp43(+)=c4.cp09 and c5.cp10(+)='1001' and c6.cp43(+)=c2.cp09 and c6.cp10(+)='1001'"
            
         intR = 1
         Set adoRst2 = ClsLawReadRstMsg(intR, stSQL)
         If intR = 1 Then
            'Modified by Morgan 2019/10/3 108.11.1 新法發明/新型准後3個月內可提分割(原發明初審准內30日),108.8.1以後收文分割適用
            'stCP07 = CompDate(2, 30, adoRst2("RD1st"))
            stCP07 = CompDate(1, 3, adoRst2("RD3st"))
            'end 2019/10/3
            'cancel by sonia 2020/4/21 FCP已改為2工作天
            ''Added by Morgan 2012/11/12 +FCP
            'If adoRst2("pa01") = "FCP" Then
            '   stCP06 = CompDate(2, -2, stCP07)
            'Else
            ''end 2012/11/12
            'end 2020/4/21
               stDate(0) = ""
               stDate(1) = adoRst2("pa01")
               stDate(2) = "000"
               stDate(3) = stCP07
               GetCtrlDT stDate
               '本所期限
               stCP06 = PUB_GetWorkDay1(stDate(0), True)
            'End If 'cancel by sonia 2020/4/21
         Else
         'end 2012/8/14
         
            'Modified by Morgan 2013/10/4 +204修正
            stSQL = "select c2.cp09 C205cp09,c2.cp27 C205cp27,c2.cp06 C205cp06,c2.cp07 C205cp07" & _
               " from caseprogress c2 where c2.cp01='" & adoRst("dc05") & "'" & _
               " and c2.cp02='" & adoRst("dc06") & "' and c2.cp03='" & adoRst("dc07") & "'" & _
               " and c2.cp04='" & adoRst("dc08") & "' and c2.cp57 is null" & _
               " and c2.cp10 in ('204','205','107') and c2.cp27 is null"
            intR = 1
            Set adoRst2 = ClsLawReadRstMsg(intR, stSQL)
            'CP
            If intR = 1 Then
               stCP06 = "" & adoRst2("C205cp06")
               stCP07 = "" & adoRst2("C205cp07")
            'NP
            Else
               'Modified by Morgan 2013/10/4 +204修正
               'Modified by Morgan 2023/8/31 +不續辦但未過期的也要 Ex:FCP-070177
               stSQL = "select n1.np01 C205np01,n1.np08 C205np08,n1.np09 C205np09" & _
                  " from nextprogress n1 where n1.np02='" & adoRst("dc05") & "'" & _
                  " and n1.np03='" & adoRst("dc06") & "' and n1.np04='" & adoRst("dc07") & "'" & _
                  " and n1.np05='" & adoRst("dc08") & "' and n1.np07 in (204,205,107) and (n1.np06 is null or (n1.np06='N' and n1.np09>=" & strSrvDate(1) & "))"
               intR = 1
               Set adoRst2 = ClsLawReadRstMsg(intR, stSQL)
               If intR = 1 Then
                  stCP06 = "" & adoRst2("C205np08")
                  stCP07 = "" & adoRst2("C205np09")
               End If
            End If
            
         End If 'Added by Morgan 2012/8/14
        
         If Val(stCP07) > 0 Then
            intR = 0
            stSQL = "update caseprogress set cp06=" & CNULL(stCP06, True) & _
               ",cp07=" & CNULL(stCP07, True) & " where cp09='" & p307CP09 & "'"
            cnnConnection.Execute stSQL, intR
            If intR > 0 Then
               pCP06 = stCP06: pCP07 = stCP07 'Added by Morgan 2021/8/20
               PUB_Update307RefTw = "分割案 " & stCaseNo & " 期限已更新！" & vbCrLf & vbCrLf & "(法限：" & ChangeWStringToTDateString(stCP07) & ")"
            End If
            
         End If
      End If
   End If
   
   Set adoRst = Nothing
   Set adoRst2 = Nothing
End Function

'Add by Morgan 2009/8/4 設定催審期限
'Modified by Morgan 2021/12/4 oText 改為 Object 以相容 Form2.0
Public Sub PUB_SetChkResultDate(ByVal CF01 As String, ByVal CF02 As String, ByVal CF03 As String, _
   ByVal sFromDate As String, ByRef oText As Object, cp() As String, Optional PA08 As String = "1", _
   Optional PA16 As String)
   
Dim stSQL As String, intR As Integer
Dim adoRst As ADODB.Recordset
Dim iAct As Integer '1=Update,2=Insert,0=Nothing
Dim strMailSubject As String
Dim iDays As Integer
Dim stDate As String
   
   oText.Text = ""
   
   'Add by Morgan 2009/9/9有實審制度的國家申請、改請或分割發文時不掛催審期限，等實審發文時才掛申請的催審期限
   If InStr("101,102,103,301,302,303,307", CF03) > 0 Then
      stSQL = "SELECT NA26,NA28,NA30 FROM NATION WHERE NA01='" & CF02 & "'"
      intR = 1
      Set adoRst = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         Select Case CF03
            Case "101", "301"
               If adoRst.Fields(0) > 0 Then
                  GoTo ExitPoint
               End If
            Case "102", "302"
               If adoRst.Fields(1) > 0 Then
                  GoTo ExitPoint
               End If
            Case "103", "303"
               If adoRst.Fields(2) > 0 Then
                  GoTo ExitPoint
               End If
            Case "307"
               Select Case PA08
                  Case "1"
                     If adoRst.Fields(0) > 0 Then
                        GoTo ExitPoint
                     End If
                  Case "2"
                     If adoRst.Fields(1) > 0 Then
                        GoTo ExitPoint
                     End If
                  Case "3"
                     If adoRst.Fields(2) > 0 Then
                        GoTo ExitPoint
                     End If
               End Select
         End Select
      End If
   'Modify by Morgan 2010/11/8 核准後實審催本程序(設定半年)
   'ElseIf CF03 = "416" Then
   'Modified by Lydia 2016/10/13 PCT案照一般案件性質處理
   'ElseIf CF03 = "416" And PA16 <> "1" Then
   'Modified by Morgan 2019/3/7 +427 合併檢索及實審 Ex:CFP-030552 --郭，禧佩
   'ElseIf CF03 = "416" And PA16 <> "1" And CF02 <> "056" Then
   ElseIf (CF03 = "416" Or CF03 = "427") And PA16 <> "1" And CF02 <> "056" Then
      stSQL = "SELECT cp10 FROM caseprogress" & _
         " WHERE cp01='" & cp(1) & "' and cp02='" & cp(2) & "'" & _
         " and cp03='" & cp(3) & "' and cp04='" & cp(4) & "'" & _
         " and cp10 in ('101','102','103','301','302','303','307')"
      'Modify by Morgan 2010/5/19 中間接來也要
      'stSQL = stSQL & " and cp27>19221111 order by cp27 desc"
      stSQL = stSQL & " and cp27>0 order by cp27 desc"
      
      intR = 1
      Set adoRst = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         CF03 = adoRst.Fields(0)
      Else
         MsgBox "無法讀取已發文申請程序！"
         GoTo ExitPoint
      End If
   
   'Add by Morgan 2009/9/16
   '中間接進來的才要掛催審期限
   'Remove by Morgan 2009/9/29 申復,修正發文也要更新
   'ElseIf CF03 = "204" Or CF03 = "205" Then
   '   stSQL = "select 1 from caseprogress where cp01='" & cp(1) & "' and cp02='" & cp(2) & "'" & _
   '      " and cp03='" & cp(3) & "' and cp04='" & cp(4) & "' and instr('" & NewCasePtyList & ",107',cp10)>0" & _
   '      " and cp27>19221111"
   '   intR = 1
   '   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   '   If intR = 1 Then
   '      GoTo ExitPoint
   '   End If
   
   'Add by Morgan 2011/3/22 台灣發明的修正發文不用更新申請案的催審
   'Modified by Morgan 2016/1/15 +新型 --郭
   ElseIf CF01 = "P" And CF02 = "000" And CF03 = "204" And (PA08 = "1" Or PA08 = "2") Then
      GoTo ExitPoint
      
   'Added by Morgan 2019/7/9 +大陸發明也不更新--郭
   ElseIf CF01 = "P" And CF02 = "020" And CF03 = "204" And PA08 = "1" Then
      GoTo ExitPoint
      
   'Add By Sindy 2019/7/23 + 958代理人撰稿
   ElseIf CF03 = "958" And cp(43) <> "" Then
      stSQL = "SELECT cp10,cp06 FROM caseprogress" & _
         " WHERE cp01='" & cp(1) & "' and cp02='" & cp(2) & "'" & _
         " and cp03='" & cp(3) & "' and cp04='" & cp(4) & "'" & _
         " and cp09='" & cp(43) & "' and cp10 is not null"
      intR = 1
      Set adoRst = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         '1.新申請案-CFP發文日起三週,P發文日起一週。
         If InStr(NewCasePtyList, adoRst.Fields("cp10")) > 0 Then
            If CF01 = "CFP" Then
               oText.Text = TransDate(CompDate(2, 21, DBDATE(sFromDate)), 1)
            Else
               oText.Text = TransDate(CompDate(2, 7, DBDATE(sFromDate)), 1)
            End If
         '2.後續案-CFP及P均為發文日起一週。
         Else
            oText.Text = TransDate(CompDate(2, 7, DBDATE(sFromDate)), 1)
         End If
         '3.上述期限設定若超過原有的本所期限,則以該案原有的本限作為催審期限。
         If Val("" & adoRst.Fields("cp06")) > 0 Then
            If Val(oText.Text) > Val(TransDate(adoRst.Fields("cp06"), 1)) Then
               oText.Text = TransDate(adoRst.Fields("cp06"), 1)
            End If
         End If
      End If
      GoTo ExitPoint
   End If
   
   stSQL = "SELECT CF05,CF11 FROM CASEFEE WHERE CF01='" & CF01 & "' AND " & _
      "CF02='" & CF02 & "' AND CF03='" & CF03 & "'"
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      If adoRst.Fields(0) > 0 Then
         iAct = 0
         'Modified by Morgan 2023/5/29 大陸一案兩請發明案設4年
         'oText.Text = TransDate(CompDate(2, adoRst.Fields(0), DBDATE(sFromDate)), 1)
         iDays = adoRst.Fields(0)
         If CF01 = "P" And CF02 = "020" And CF03 = "101" Then
            stSQL = "SELECT * FROM CASEMAP WHERE CM10='3' and CM01='" & cp(1) & "' AND " & _
               "CM02='" & cp(2) & "' AND CM03='" & cp(3) & "' and CM04='" & cp(4) & "'" & _
               "union SELECT * FROM CASEMAP WHERE CM10='3' and CM05='" & cp(1) & "' AND " & _
               "CM06='" & cp(2) & "' AND CM07='" & cp(3) & "' and CM08='" & cp(4) & "'"
            intR = 1
            Set adoRst = ClsLawReadRstMsg(intR, stSQL)
            If intR = 1 Then
               iDays = 365 * 4
            End If
         End If
         oText.Text = TransDate(CompDate(2, iDays, DBDATE(sFromDate)), 1)
         'end 2023/5/29
         'Added by Morgan 2012/7/4 102專利新法
         '申請寄存催審期限不可晚於最早優先權日+14個月
         If CF01 = "P" And CF02 = "000" And CF03 = "108" Then
            stDate = PUB_GetFirstPriDate(cp)
            If stDate <> "" Then
               stDate = TransDate(CompDate(1, 14, stDate), 1)
               If Val(oText.Text) > Val(stDate) Then
                  oText.Text = stDate
               End If
            End If
         End If
         'end 2012/7/4
      'Update
      Else
         iAct = 1
      End If
   'Insert
   Else
      iAct = 2
   End If
   
   If iAct <> 0 Then
      '檢查該系統該案件性質若至少有一國有設審查時間則自動設定為12個月(365天)
      stSQL = "select na03,decode(na01,'000',cpm03,cpm04) cpm03 from nation,casepropertymap where na01='" & CF02 & "' and cpm01='" & CF01 & "' and cpm02='" & CF03 & "'" & _
         " and exists(select * from casefee where cf01='" & CF01 & "' and cf03='" & CF03 & "' and cf05>0)"
      intR = 1
      Set adoRst = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
      
         cnnConnection.BeginTrans

On Error GoTo ErrHnd
         'Modify by Morgan 2009/12/3 催審期限都加半年(180天)
         '領證設定為8個月
         If CF03 = "601" Then
            iDays = 8 * 30 + 6 * 30
         '申復修正設定為6個月(更新新申請案催審期限,存檔控制)
         ElseIf CF03 = "204" Or CF03 = "205" Then
            iDays = 6 * 30 + 6 * 30
         '其他設定為12個月
         Else
            'Modified by Morgan 2018/8/15 改為180天--郭
            'iDays = 365 + 6 * 30
            iDays = 180
         End If
         strMailSubject = CF01 & "系統" & adoRst("na03") & "(" & CF02 & ")案的" & adoRst("cpm03") & "(" & CF03 & ")的審查時間已自動設定為 " & iDays & " 天！"
         
         'Update
         If iAct = 1 Then
            stSQL = "update casefee set cf05=" & iDays & " where  CF01='" & CF01 & "' AND " & _
               "CF02='" & CF02 & "' AND CF03='" & CF03 & "'"
            cnnConnection.Execute stSQL, intR
         'Insert
         Else
            stSQL = "insert into casefee (cf01,cf02,cf03,cf05)" & _
               " values ('" & CF01 & "','" & CF02 & "','" & CF03 & "'," & iDays & ")"
         End If
         
         Pub_SeekTbLog stSQL
         stSQL = "begin user_data.user_enabled:=1;  " & stSQL & "; end; "
         cnnConnection.Execute stSQL, intR
      
      
         stSQL = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08)" & _
            " values ('" & strUserNum & "','79075',to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss'),'" & ChgSQL(strMailSubject) & "','0->" & iDays & " 天')"
         cnnConnection.Execute stSQL, intR
         
         cnnConnection.CommitTrans
         
         oText.Text = TransDate(CompDate(2, iDays, DBDATE(sFromDate)), 1)
      End If
   End If
   
   Set adoRst = Nothing
   Exit Sub
   
ErrHnd:
   cnnConnection.RollbackTrans
   MsgBox Err.Description, vbCritical
   
ExitPoint:
   Set adoRst = Nothing
End Sub
'Add by Morgan 2009/8/18
'更新催審期限
'Modified by Lydia 2016/10/13 + nPA09 國別
Public Sub PUB_UpdateChkResultDate(ByVal np09 As String, ByRef cp() As String, ByVal CP09 As String, Optional ByVal CP10 As String, Optional ByVal CP43 As String, Optional ByVal nPA09 As String)
Dim stSQL As String, intR As Integer, iR As Integer
Dim adoRst As ADODB.Recordset
   
   If np09 <> "" Then
      'Add by Morgan 2009/9/10 若為改請的發文時要將原申請程序的催審期限上'Y'
      '2010/1/28 MODIFY BY SONIA 所有改請案件性質301~306都要做,被更新的案件性質要再加聯合申請105,且NP06改上N
      'If CP10 = "301" Or CP10 = "302" Or CP10 = "303" Then
      If Left(CP10, 1) = "3" And CP10 <> "307" Then
          stSQL = "UPDATE NEXTPROGRESS SET NP06='N'" & _
            " WHERE NP02='" & cp(1) & "' AND NP03='" & cp(2) & "' AND NP04='" & cp(3) & _
            "' AND NP05='" & cp(4) & "' AND NP06 IS NULL AND NP07=" & 催審 & _
            " AND EXISTS(SELECT * FROM CASEPROGRESS WHERE CP09=NP01 AND CP10 IN ('101','102','103','307','105','125'))"
         cnnConnection.Execute stSQL, intR
      End If
      
      intR = 0
      '若為修正,申復且有相關總收文號時要更新該相關總收文號的相關總收文號的催審期限
      'Modify by Morgan 2009/9/1 發文修正申復時判斷有C類相關收文號或該案是中間接進來的才要掛催審期限
      If (CP10 = "204" Or CP10 = "205") Then
         
         'Modify by Morgan 2009/9/16 非中間接來案件改通知修正,申復時處理
         'Modify by Morgan 2009/9/29 申復,修正發文改回要更新
         If CP43 > "C" Then
            'add by sonia 2014/11/12 台灣421申請技術報告及807第三人申請技術報告的來函,再收文的申復發文不可更新原催審期限
            stSQL = "select c2.cp09,c2.cp10 from caseprogress c1,caseprogress c2,patent" & _
               " where c1.cp09='" & CP43 & "' and c1.cp43=c2.cp09(+) and c2.cp10 in ('','421','807') " & _
               " and pa01(+)=c1.cp01 and pa02(+)=c1.cp02 and pa03(+)=c1.cp03 and pa04(+)=c1.cp04 and '000'=pa09 "
            iR = 1
            Set adoRst = ClsLawReadRstMsg(iR, stSQL)
            If iR = 1 Then
               GoTo Nextstep
            End If
            'end 2014/11/12
            
            stSQL = "UPDATE NEXTPROGRESS SET NP08=" & PUB_GetWorkDay1(DBDATE(np09), True) & _
               ",NP09= " & DBDATE(np09) & _
               " WHERE NP01=(SELECT CP43 FROM CASEPROGRESS WHERE CP09='" & CP43 & "')" & _
               " AND NP02='" & cp(1) & "' AND NP03='" & cp(2) & "' AND NP04='" & cp(3) & _
               "' AND NP05='" & cp(4) & "' AND NP06 IS NULL AND NP07=" & 催審
            cnnConnection.Execute stSQL, intR
            '2010/10/8 ADD BY SONIA 相關總收文號的相關總收文號若無催審期限,表示中間接進來則要新增該相關總收文號的相關總收文號的催審期限
            If intR = 0 Then
               stSQL = "INSERT INTO NEXTPROGRESS (NP01,NP02,NP03,NP04,NP05," & _
                  "NP07,NP08,NP09,NP10,NP22) select CP43,'" & cp(1) & _
                  "','" & cp(2) & "','" & cp(3) & "','" & cp(4) & "'," & 催審 & "," & _
                  PUB_GetWorkDay1(DBDATE(np09), True) & "," & DBDATE(np09) & _
                  ",'" & strUserNum & "',NP22 from dual,(select nvl(max(np22),0)+1 NP22 from nextprogress)" & _
                  ",(SELECT CP43 FROM CASEPROGRESS WHERE CP09='" & CP43 & "')"
               cnnConnection.Execute stSQL, intR
            End If
            '2010/10/8 END
         Else
            stSQL = "UPDATE NEXTPROGRESS SET NP08=" & PUB_GetWorkDay1(DBDATE(np09), True) & _
               ",NP09= " & DBDATE(np09) & _
               " WHERE NP01='" & CP09 & "' AND NP06 IS NULL AND NP07='411'"
            cnnConnection.Execute stSQL, intR
         End If
         
         If intR = 0 Then
            stSQL = "INSERT INTO NEXTPROGRESS (NP01,NP02,NP03,NP04,NP05," & _
               "NP07,NP08,NP09,NP10,NP22) select '" & CP09 & "','" & cp(1) & _
               "','" & cp(2) & "','" & cp(3) & "','" & cp(4) & "'," & 催審 & "," & _
               PUB_GetWorkDay1(DBDATE(np09), True) & "," & DBDATE(np09) & _
               ",'" & strUserNum & "',NP22 from dual,(select nvl(max(np22),0)+1 NP22 from nextprogress)" & _
               " where not exists(select * from caseprogress where cp01='" & cp(1) & "' and cp02='" & cp(2) & "'" & _
               " and cp03='" & cp(3) & "' and cp04='" & cp(4) & "' and instr('" & NewCasePtyList & ",107',cp10)>0" & _
               " and cp27>19221111)"
            cnnConnection.Execute stSQL, intR
         End If
      'Add by Morgan 2009/10/9 回覆檢索報告有相關總收文號時要更新該相關總收文號的相關總收文號的催審期限,但不可早於原催審期限
      ElseIf CP10 = "218" Then
         If CP43 > "C" Then
            stSQL = "UPDATE NEXTPROGRESS SET NP08=" & PUB_GetWorkDay1(DBDATE(np09), True) & _
               ",NP09= " & DBDATE(np09) & _
               " WHERE NP01=(SELECT CP43 FROM CASEPROGRESS WHERE CP09='" & CP43 & "')" & _
               " AND NP02='" & cp(1) & "' AND NP03='" & cp(2) & "' AND NP04='" & cp(3) & _
               "' AND NP05='" & cp(4) & "' AND NP06 IS NULL AND NP07=" & 催審 & " AND NP09<" & DBDATE(np09)
            cnnConnection.Execute stSQL, intR
         End If
         
      'Add by Morgan 2009/9/16
      '通知修正,申復時以(P發文日,CFP收文日)+6個月更新相關總收文號的催審期限2009/12/14 改1年
      'Modify by Morgan 2010/8/10 +通知審查中1905=來函收文日+6個月更新相關總收文號的催審期限
      'Modified by Morgan 2014/9/30 +最後通知1227 Ex.P-94877
      ElseIf (CP10 = "1201" Or CP10 = "1202" Or CP10 = "1905" Or CP10 = "1227") Then
         If CP43 <> "" Then
            stSQL = "UPDATE NEXTPROGRESS SET NP08=" & PUB_GetWorkDay1(DBDATE(np09), True) & _
               ",NP09= " & DBDATE(np09) & _
               " WHERE NP01='" & CP43 & "' AND NP02='" & cp(1) & "' AND NP03='" & cp(2) & "'" & _
               " AND NP04='" & cp(3) & "' AND NP05='" & cp(4) & "' AND NP06 IS NULL AND NP07=" & 催審
            cnnConnection.Execute stSQL, intR
            '2010/10/12 ADD BY SONIA 相關總收文號若無催審期限,表示中間接進來則要新增該相關總收文號的催審期限
            If intR = 0 Then
               stSQL = "INSERT INTO NEXTPROGRESS (NP01,NP02,NP03,NP04,NP05," & _
                  "NP07,NP08,NP09,NP10,NP22) select CP43,'" & cp(1) & _
                  "','" & cp(2) & "','" & cp(3) & "','" & cp(4) & "'," & 催審 & "," & _
                  PUB_GetWorkDay1(DBDATE(np09), True) & "," & DBDATE(np09) & _
                  ",'" & strUserNum & "',NP22 from dual,(select nvl(max(np22),0)+1 NP22 from nextprogress)" & _
                  ",(SELECT CP43 FROM CASEPROGRESS WHERE CP09='" & CP09 & "')"
               cnnConnection.Execute stSQL, intR
            End If
            '2010/10/12 END
         End If
         
      'Add by Morgan 2009/9/9 實審發文更新最後發文的申請程序的催審期限
      'Modified by Lydia 2016/10/13 排除PCT案
      'ElseIf CP10 = "416" Then
      'Modified by Morgan 2019/3/7 +427 合併檢索及實審 Ex:CFP-030552 --郭，禧佩
      'ElseIf CP10 = "416" And nPA09 <> "056" Then
      ElseIf (CP10 = "416" Or CP10 = "427") And nPA09 <> "056" Then
         'Modify by Morgan 2010/5/19 發文日111111的也要
         stSQL = "UPDATE NEXTPROGRESS SET NP08=" & PUB_GetWorkDay1(DBDATE(np09), True) & _
            ",NP09= " & DBDATE(np09) & _
            " WHERE NP01=(SELECT SUBSTR(MAX(CP27||CP09),9) FROM CASEPROGRESS WHERE CP01='" & cp(1) & "'" & _
            " AND CP02='" & cp(2) & "' AND CP03='" & cp(3) & "' AND CP04='" & cp(4) & "'" & _
            " AND CP10 in ('101','102','103','301','302','303','307') AND CP27>0)" & _
            " AND NP06 IS NULL AND NP07=" & 催審
         cnnConnection.Execute stSQL, intR
         If intR = 0 Then
            stSQL = "INSERT INTO NEXTPROGRESS (NP01,NP02,NP03,NP04,NP05," & _
               "NP07,NP08,NP09,NP10,NP22) select SUBSTR(MAX(CP27||CP09),9)" & _
               ",CP01,CP02,CP03,CP04," & 催審 & "," & PUB_GetWorkDay1(DBDATE(np09), True) & _
               "," & DBDATE(np09) & ",'" & strUserNum & "',max(NP22)" & _
               " from CASEPROGRESS,(select nvl(max(np22),0)+1 NP22 from nextprogress)" & _
               " where CP01='" & cp(1) & "' AND CP02='" & cp(2) & "'" & _
               " AND CP03='" & cp(3) & "' AND CP04='" & cp(4) & "'" & _
               " AND CP10 in ('101','102','103','301','302','303','307')" & _
               " AND CP27>0 GROUP BY CP01,CP02,CP03,CP04"
            cnnConnection.Execute stSQL, intR
         End If
         
      'Added by Morgan 2016/8/16
      '擇一申復的發文時請更新"通知擇一申復"的相關總收文號的催審期限 --陳玲玲
      ElseIf CP10 = "239" Then
         If CP43 > "C" Then
            stSQL = "UPDATE NEXTPROGRESS SET NP08=" & PUB_GetWorkDay1(DBDATE(np09), True) & _
               ",NP09= " & DBDATE(np09) & _
               " WHERE NP01=(SELECT CP43 FROM CASEPROGRESS WHERE CP09='" & CP43 & "' AND CP10='1232')" & _
               " AND NP02='" & cp(1) & "' AND NP03='" & cp(2) & "' AND NP04='" & cp(3) & _
               "' AND NP05='" & cp(4) & "' AND NP06 IS NULL AND NP07=" & 催審
            cnnConnection.Execute stSQL, intR
         End If
      'End 2016/8/16
      
      Else
         stSQL = "UPDATE NEXTPROGRESS SET NP08=" & PUB_GetWorkDay1(DBDATE(np09), True) & _
            ",NP09= " & DBDATE(np09) & _
            " WHERE NP01='" & CP09 & "' AND NP06 IS NULL AND NP07='411'"
         cnnConnection.Execute stSQL, intR
         If intR = 0 Then
            stSQL = "INSERT INTO NEXTPROGRESS (NP01,NP02,NP03,NP04,NP05," & _
               "NP07,NP08,NP09,NP10,NP22) select '" & CP09 & "','" & cp(1) & _
               "','" & cp(2) & "','" & cp(3) & "','" & cp(4) & "'," & 催審 & "," & _
               PUB_GetWorkDay1(DBDATE(np09), True) & "," & DBDATE(np09) & _
               ",'" & strUserNum & "',NP22 from dual,(select nvl(max(np22),0)+1 NP22 from nextprogress)"
            cnnConnection.Execute stSQL, intR
         End If
      End If

Nextstep:    'add by sonia 2014/11/12

   End If
End Sub

'Removed by Morgan 2017/10/11 FMP案已改用PUB_GetFCPPromoterNo
''Add by Morgan 2009/11/27
''FMP案預設承辦人
'Public Function PUB_GetFmpCP14(cp() As String, Optional FA10 As String) As String
'Dim stSQL As String, adoRst As ADODB.Recordset, iR As Integer, strCP14 As String
'
'   'Added by Morgan 2012/8/7 改呼叫共用函數
'   strCP14 = PUB_GetSpecCP14(cp(1) & cp(2) & cp(3) & cp(4))
'
'   'Added by Morgan 2012/8/20
'   If strCP14 = "" Then
'      'modify by sonia 2014/9/9 +st16,離職改抓案件工程師組別的主管,若案件無則抓工程師主管
'      stSQL = "select cp14,st04,st16 from caseprogress,staff where cp01='" & cp(1) & "' and cp02='" & cp(2) & "'" & _
'              " and cp03='" & cp(3) & "' and cp04='" & cp(4) & "' and st01(+)=cp14 and st03 in ('F21','F81') and cp57 is null order by cp05 desc"
'      iR = 1
'      Set adoRst = ClsLawReadRstMsg(iR, stSQL)
'      If iR = 1 Then
'         If adoRst.Fields("st04") = "1" Then
'            strCP14 = adoRst.Fields("cp14")
'         End If
'      End If
'   End If
'   'end 2012/8/20
'
'   If strCP14 = "" Then
'      'modify by sonia 2014/9/9 離職改抓案件工程師組別的主管,若案件無則抓工程師主管
'      'strCP14 = "88003"
'      stSQL = "select '1',oman from setspecman,patent where pa01='" & cp(1) & "' and pa02='" & cp(2) & "'" & _
'              " and pa03='" & cp(3) & "' and pa04='" & cp(4) & "' and pa150 is not null and decode(pa150,'1','T','2','R','3','S','4','T1',pa150)=OCODE(+) "
'      If adoRst.RecordCount > 0 Then 'Added by Morgan 2014/10/13
'         stSQL = stSQL & " union " & _
'                 " select '2',oman from setspecman where decode(" & adoRst.Fields("st16") & ",'1','T','2','R','3','S','4','T1'," & adoRst.Fields("st16") & ")=OCODE(+) " & _
'                 " order by 1,2 "
'      End If 'Added by Morgan 2014/10/13
'
'      iR = 1
'      Set adoRst = ClsLawReadRstMsg(iR, stSQL)
'      If iR = 1 Then
'         strCP14 = "" & adoRst(1)
'      End If
'   End If
'
'   PUB_GetFmpCP14 = strCP14
'   'end 2012/8/7
'
''Removed by Morgan 2012/8/7
''
''   'Modify by Morgan 2010/9/23 +910其他(FMP的比對分析會收此案件性質)--郭
''   'stSQL = "select DECODE(CP10,'201',ep04,NVL(EP04,CP14))" & _
''      " from caseprogress,engineerprogress" & _
''      " where cp01='" & cp(1) & "' and cp02='" & cp(2) & "'" & _
''      " and cp03='" & cp(3) & "' and cp04='" & cp(4) & "'" & _
''      " and cp10 IN ('201','209','210','910') and cp57 is null and ep02(+)=cp09 order by cp10 asc"
''   iR = 1
''   Set adoRst = ClsLawReadRstMsg(iR, stSQL)
''   '新案翻譯核稿人
''   If iR = 1 Then
''      strCP14 = "" & adoRst(0)
''   Else
''      stSQL = "select DECODE(CP10,'201',ep04,NVL(EP04,CP14))" & _
''         " from casemap,caseprogress,engineerprogress" & _
''         " where cm01='" & cp(1) & "' and cm02='" & cp(2) & "'" & _
''         " and cm03='" & cp(3) & "' and cm04='" & cp(4) & "' and cm10='0'" & _
''         " and cp01(+)=cm05 and cp02(+)=cm06 and cp03(+)=cm07 and cp04(+)=cm08" & _
''         " and cp10 IN ('201','209','210') and cp57 is null and ep02(+)=cp09"
''      iR = 1
''      Set adoRst = ClsLawReadRstMsg(iR, stSQL)
''      '國內案新案翻譯核稿人
''      If iR = 1 Then
''         strCP14 = "" & adoRst(0)
''      End If
''   End If
''
''   If strCP14 <> "" Then
''      '若為內翻編號時抓對照檔的員工編號
''      If Left(strCP14, 1) = "F" Then
''          strCP14 = PUB_GetMapID(strCP14)
''      End If
''
''      stSQL = "select 1 from staff where st01='" & strCP14 & "' and st04='1'"
''      iR = 1
''      Set adoRst = ClsLawReadRstMsg(iR, stSQL)
''      If iR = 0 Then
''         strCP14 = ""
''      End If
''   End If
''   If strCP14 = "" Then
''      If FA10 = "" Then
''         stSQL = "select fa10 from patent,fagent" & _
''            " where pa01='" & cp(1) & "' and pa02='" & cp(2) & "'" & _
''            " and pa03='" & cp(3) & "' and pa04='" & cp(4) & "'" & _
''            " and fa01(+)=substr(pa75,1,8) and fa02(+)=substr(pa75,9)"
''         iR = 1
''         Set adoRst = ClsLawReadRstMsg(iR, stSQL)
''         '代理人國籍
''         If iR = 1 Then
''            FA10 = "" & adoRst(0)
''         End If
''      End If
''
''      '日本:王文安
''      If Left(FA10, 3) = "011" Then
''         strCP14 = "88003"
''      '其他:阮威立
''      Else
''         'Modify by Morgan 2011/2/25 85030 留職停薪半年,暫改 88003
''         strCP14 = "88003"
''      End If
''   End If
''   PUB_GetFmpCP14 = strCP14
'   Set adoRst = Nothing
'End Function


'Mark by Lydia 2015/02/06 改成表單維護, 共用模組PUB_GetDebitNotePS
''Add by Morgan 2008/6/11
''請款函備註
''Modified by Morgan 2012/7/11 +p_CaseNo
''Modified by Morgan 2012/9/11 +p_CP10
'Public Function PUB_GetDNPS(p_XYNo As String, Optional p_CaseNo As String, Optional p_CP10 As String, Optional p_XNo As String) As String
'   Dim stPS As String
'
'   'Added by Morgan 2013/5/3
'   If p_CaseNo = "FCP041886000" Then
'      stPS = "Our debit note will be directly sent to Ms. Elaine A. Brooks at Dept165@examen.com by e-mail."
'   Else
'      'Modified by Morgan 2015/2/4 更名前的也要
'      'Select Case p_XYNo
'      Select Case Left(p_XYNo, 8)
'      'Added by Morgan 2012/2/17 --陳怡君
'      Case "Y2026700"
'         stPS = "Our invoice will be sent to the email address of accountspayable@vereenigde.com by separate email."
'
'      Case "Y2021200" 'Add by Morgan 2010/5/26 --何淑華
'         stPS = "Our debit note will be addressed to OMYA Development AG."
'
'      Case "Y2041200" 'Add by Morgan 2010/5/26 --何淑華
'         stPS = "Our debit note will be separated from the rest of this letter and dealt with separately."
'
'      Case "Y2043800" 'Add by Morgan 2011/4/1--敏莉
'         stPS = "Our debit note will be directly sent to Ms. Elaine A. Brooks at dept165@examen.com by e-mail."
'
'      Case "Y2049500" 'Added by Morgan 2013/3/26 --芳如
'         stPS = "Our debit note will be sent directly to ipdebitnotes@kilpatricktownsend.com"
'
'      Case "Y2136100" 'Add by Morgan 2008/6/11--何淑華
'         stPS = "Our debit note will be sent to you via regular mail per your general instructions of May 6, 2008."
'
'      'Modified by Morgan 2014/5/22--陳怡君
'      Case "Y2143100", "Y5328000"
'         stPS = "Our monthly invoice will be sent to you by separate email."
'
'      'Removed by Morgan 2013/8/1--敏莉
'      'Case "Y2149300" 'Add by Morgan 2011/4/1--敏莉
'      '   stPS = "Our debit note will be emailed directly to Accounting Department at accounting@graybeal.com."
'
'      Case "Y2165207" 'Add by Morgan 2012/12/4--敏莉
'         stPS = "Our debit note will be submitted through FRVP."
'
'      'Removed by Morgan 2013/8/1--敏莉
'      'Case "Y2232700" 'Add by Morgan 2012/3/19--敏莉
'      '   stPS = "Our debit note will be sent to Accounts Payable directly by e-mail at accountspayable@esi.com."
'
'      'Removed by Morgan 2012/3/28--芳如
'      'Case "Y2245700" 'Add by Morgan 2011/5/31--芳如
'      '   stPS = "Our debit note will be uploaded via Oce."
'
'      Case "Y2785700" 'Add by Morgan 2012/3/19--敏莉
'         stPS = "Our debit note will be sent to Accounting Dept. directly by e-mail at accounts@hgcpatent.com."
'
'      Case "Y3326802" 'Add by Morgan 2011/4/1--敏莉
'         'Modified by Morgan 2012/4/3--敏莉
'         'stPS = "Our debit note will be directly sent to Mrs. Deborah Pinori at deborah.pinori@basf.com by e-mail."
'         stPS = "Our debit note will be addressed and sent to BASF SE by e-mail to global-ip-accountancygroup@basf.com."
'
'      Case "Y3384400" 'Add by Morgan 2011/7/25--芳如
'         stPS = "Our debit note will be sent to accounting@klarquist.com directly."
'
'      Case "Y3441200" 'Added by Morgan 2014/9/10 --何淑華
'         stPS = "Our debit note will be sent to e-invoice@scania.com by separate email."
'
'      'Added by Morgan 2013/5/31 --陳怡君
'      'Removed by Morgan 2015/1/7 取消--林芳如 FCP-49848
'      'Case "Y3864600"
'      '   stPS = "Our debit note will be directly sent to Mr. Geremy Sia of Creative Technology Ltd at geremy_sia@ctl.creative.com by email."
'
'      Case "Y4223700" 'Added by Morgan 2014/8/7--敏莉
'         stPS = "A second copy of our debit note will be sent to Cindy.Sostak@axcelis.com per Ms. Cindy Sostak’s instructions."
'
'      'Added by Morgan 2012/11/27 --陳怡君
'      Case "Y4549300"
'         stPS = "Our invoice will be sent to you by separate email."
'
'      'Modify by Morgan 2010/5/18 +Y46933--何淑華
'      Case "Y4569700", "Y4693300" 'Add by Morgan 2006/11/8
'         'Modify by Morgan 2008/4/21
'         'stPS = "Our debit note will be sent to Ciba Specialty Chemicals Inc. by separate mail."
'         'Modify by Morgan 2010/2/4--何淑華
'         'stPS = "Our debit note will be sent to Ciba Inc. by separate mail."
'         'Modified by Morgan 2012/6/18--何淑華
'         'stPS = "Our debit note will be addressed to BASF SE."
'         stPS = "Our debit note will be sent to global-ip-accountancygroup@basf.com pursuant to your instructions."
'
'      'Added by Morgan 2014/8/29
'      Case "Y4579905"
'         stPS = "Our debit note will be uploaded to the DataCert for your kind settlement."
'
'      'Modify by Morgan 2009/5/7 改備註--何淑華
'      ''Add by Morgan 2008/4/21
'      'Case "Y4584800"
'      '   stPS = "The original debit note will be sent to Shell International B.V. Intellectual Property Services-The Hague c/o Shell Shared Service Centre-Glasgow Limited by separate mail."
'      ''Add by Morgan 2008/4/21
'      'Case "Y4585000"
'      '   stPS = "The original debit note will be sent to Shell International Limited Intellectual Property Services-London c/o Shell Shared Service Centre-Glasgow Limited by separate mail."
'      Case "Y4584800", "Y4585000"
'         'Modified by Morgan 2011/10/6--何淑華,陳怡君
'         'stPS = "The debit note will be sent to Shell International B.V. Intellectual Property Services - The Hague c/o Shell Shared Service Centre - Glasgow Limited by ordinary mail."
'         stPS = "The debit note will be sent to Shell International B.V. FAO: DOCUMENT MANAGEMENT TEAM by separate email."
'      'end 2009/5/7
'
'      Case "Y4627500" 'Added by Morgan 2013/7/9--敏莉
'         stPS = "Our debit note will be sent to Accounting Department directly by e-mail at invoices@brookskushman.com."
'
'      Case "Y4629500" 'Add by Morgan 2011/7/13--芳如
'         stPS = "Our debit note will be submitted to Bridgeway."
'
'      Case "Y4665300" 'Add by Morgan 2004/12/8
'         stPS = "Our debit note will be sent to Mr. Alexandre Zysman by separate mail."
'
'      'Modified by Morgan 2014/5/6--敏莉
'      'Case "Y4674200" 'Add by Morgan 2011/4/1--敏莉
'      '   stPS = "Our debit note will be directly sent to your Accounts Payable Dept. in Los Angeles."
'      Case "Y4674200", "Y4674201", "Y4674202", "Y4674203", "Y4674211"
'         stPS = "Our debit note will be sent via email to LA_Accounting@BSTZ.com."
'
'      Case "Y4895500" 'Add by Morgan 2012/4/20--芳如
'         stPS = "Two copies of our debit note will be sent to you by registered mail."
'
'      Case "Y4712402" 'Add by Morgan 2012/1/18--芳如
'         stPS = "Our debit note will be sent directly to mlaipsdinvoices@mckennalong.com."
'
'      'Modified by Morgan 2014/5/21--芳如
'      'Case "Y4725000" 'Add by Morgan 2012/7/20--芳如
'      '   stPS = "Our debit note will be sent to mary.dobish@lsi.com directly."
'      Case "Y4725000", "Y4725002", "X3224200"
'         stPS = "Our debit notes will be sent directly to mary.dobish@avagotech.com once per month as instructed."
'      'end 2014/5/21
'
'      'Modified by Morgan 2012/7/12 --David
'      'Case "Y4774000" 'Add by Morgan 2012/3/28--芳如
'      '   stPS = "The debit note will be also sent to client by separate email."
'      Case "X5403200", "X5988900"
'         Select Case p_CaseNo
'            'Modified by Morgan 2015/1/28 +FCP-51024例外--芳如
'            Case "FCP039517000", "FCP039142000", "FCP045373000", "FCP035771000", "FCP051024000"
'            Case Else
'               'Modified by Morgan 2012/9/11 年費除外--David,Lisa
'               If p_CP10 <> "605" Then
'                  stPS = "The debit note will be also sent to client by separate email."
'               End If
'         End Select
'
'      Case "Y4796700" 'Add by Morgan 2011/4/1--敏莉
'
'         'Modified by Morgan 2013/4/8--敏莉
'         'stPS = "Our debit note will be directly sent to Ms. Elaine A. Brooks at dept165@examen.com by e-mail."
'         stPS = "Our debit note will be submitted through Serengeti Tracker."
'
'      Case "Y4829203" 'Add by Morgan 2014/2/17--敏莉
'         'Modified by Morgan 2014/10/17
'         'stPS = "Our debit note will be uploaded via DataCert."
'         stPS = "Our debit note will be uploaded via Collaborati."
'
'      'Add by Morgan 2010/7/15 -- 何淑華
'      'Removed by Morgan 2011/11/22 -- 何淑華
'      'Case "Y4830904", "Y513260"
'      '   stPS = "Our invoice will be sent to you as an original by post."
'
'      'Added by Morgan 2012/2/17 --陳怡君
'      'Modified by Morgan 2012/11/20--陳怡君 +Y48309080
'      Case "Y4830900", "Y4830901", "Y4830902", "Y4830903", "Y4830904", "Y4830905", "Y4830908", "Y5132600"
'         'Modified by Morgan 2012/6/13--陳怡君
'         'stPS = "Our invoice will be sent to Central Invoice Entry of Syngenta International AG  as an original by post."
'         'Modified by Morgan 2012/11/20--陳怡君
'         'stPS = "Our invoice will be sent to Central Invoice Entry of Syngenta Crop Protection AG as an original by post."
'         'Modified by Morgan 2014/5/22--陳怡君
'         'stPS = "Our invoice will be sent to the email address of Capsyn.CHgsap@document.co.uk by separate email."
'         stPS = "Our invoice will be sent to the email address of ip.invoices@syngenta.com by separate email."
'
'      'Removed by Morgan 2014/3/25--敏莉
'      'Modified by Morgan 2015/1/7 恢復--敏莉
'      Case "Y4876300" 'Add by Morgan 2012/3/19--敏莉
'         stPS = "Our debit note will be directly sent at Accounting@cantorcolburn.com by e-mail."
'
'      'Added by Morgan 2014/5/22--芳如
'      Case "Y4888000"
'         stPS = "Our debit note will be directly sent to accounts.payable@procopio.com"
'
'      'Add by Morgan 2011/4/1--敏莉
'      'Modified by Morgan 2012/9/25 +Y49165010
'      Case "Y4916500", "Y4916501"
'         stPS = "Our debit note will be directly sent to Data Cert, Inc."
'
'      Case "Y4954000" 'Add by Morgan 2011/9/23--芳如
'         stPS = "Our debit note will be sent to WHVIPGroup@wegmanlaw.com per Mr. Charles Hayes'instructions."
'
'      Case "Y4956200" 'Added by Morgan 2012/4/9 --陳怡君
'         stPS = "Our debit note will be uploaded via Oce."
'
'      Case "Y5145800" 'Add by Morgan 2011/7/19--芳如
'         stPS = "Our debit note will be sent to your office by registered mail."
'
'      Case "Y5221300" 'Add by Morgan 2013/1/8 --敏莉
'         stPS = "Our debit note will be sent to Accounting Department directly by e-mail at accounting@blanchard-patent.com."
'
'      'Removed by Morgan 2012/9/19 取消--敏莉
'      'Case "Y526600" 'Add by Morgan 2011/4/1--敏莉
'      '   stPS = "Our debit note will be sent directly by e-mail at billing@huffmanlaw.net."
'
'      Case "Y5285900" 'Add by Morgan 2014/2/17--敏莉
'         stPS = "Our debit note will be made payable and sent to Sandvik Intellectual Property AB by e-mail to katrine.manneteg@sandvik.com."
'
'      Case "Y5329700" 'Added by Morgan 2013/7/9--敏莉
'         stPS = "Our original debit note will be directly sent to Avon Products, Inc. Financial Shared Services Center."
'
'      Case "Y5341800" 'Add by Morgan 2012/3/19--芳如
'         stPS = "Our invoice will be sent to rs.cviplegalinvoices@medtronic.com directly."
'
'      'Modified by Morgan 2013/3/25 改判斷 X28186+Y53495案件
'      'Case "X2818600" 'Add by Morgan 2008/11/13
'      '   stPS = "Our debit note will be sent directly to the applicant."
'
'      Case "Y5344300" 'Added by Morgan 2013/11/4--芳如
'         stPS = "Our debit note will be submitted via TyMetrix 360° electronic billing platform."
'
'      Case "Y5349500"
'         If Left(p_XNo, 8) = "X2818600" Then
'            stPS = "Our invoice will be sent to Mr. Hubach/Texas Instruments."
'         End If
'      'end 2013/3/25
'
'      Case "Y5389300" 'Added by Morgan 2014/1/3--敏莉
'         stPS = "Our debit note will be submitted through Serengeti."
'
'      Case "Y5397000" 'Added by Morgan 2014/2/20--敏莉
'         stPS = "Our debit note will be addressed and sent to GPO.HCInvoice@ge.com following the guidelines set out by the Global Patent Operation."
'
'      Case "Y5404700" 'Added by Morgan 2014/6/18--敏莉
'         stPS = "Our debit note will be submitted to DataCert."
'
'      'Removed by Morgan 2012/3/19--敏莉
'      'Case "X6050700", "X6050701" 'Add by Morgan 2011/4/1--敏莉
'      '   stPS = "Our debit note will be uploaded via Oce per Dow's general instructions."
'            'Added by Morgan 2015/2/4
'      Case "X6050700", "X6050701", "X6740200", "X6740201", "X6740202", "X7074900"
'         stPS = "Our debit note will be sent directly to the email address FMDIPAD@dow.com pursuant to Dow's instructions."
'      'end 2015/2/4
'
'      'Added by Morgan 2014/10/17 --江如玉
'      Case "Y2102300"
'         If Left(p_XNo, 8) = "X2112801" Then
'            stPS = "Our debit note will be sent directly to your firm by airmail."
'         End If
'
'      Case "Y4581401", "Y4581400"
'         If Left(p_XNo, 8) = "X4581400" Then
'            stPS = "Our debit note will be sent to global-ip-accountancygroup@basf.com pursuant to your instructions."
'         End If
'
'      Case "Y2002900"
'         stPS = "Our debit note will be sent directly to your firm by registered mail."
'
'      Case "Y5130402"
'         If Left(p_XNo, 8) = "X5246900" Then
'            stPS = "Our debit note will be sent directly to Evonik Stockhausen GmbH Zentraler Rechnungseingang."
'         ElseIf Left(p_XNo, 8) = "X7057300" Then
'            stPS = "Our debit note will be sent directly to Evonik Corporation."
'         End If
'
'      Case "Y4730300"
'         stPS = "Our debit note will be sent directly to your central mailbox PatentMail-HZA@schaeffler.com."
'
'      Case "Y2002602"
'         stPS = "Our debit note will be sent to you via email directly."
'
'      Case "Y4864000"
'         stPS = "Our debit note will be sent directly to maildus@hfp-ip.de."
'
'      Case "Y5180100"
'         stPS = "Our debit note will be sent directly to Tax@hoeger-stellrecht.de."
'      'end 2014/10/17
'
'      Case "Y3404901" 'Added by Morgan 2014/11/5
'         stPS = "Our debit note will be sent to Schneider Electric Finance Shared Services Europe as an original by airmail."
'
'      Case Else
'         stPS = ""
'      End Select
'   End If
'   PUB_GetDNPS = stPS
'End Function
'end ----- 'Mark by Lydia 2015/02/06 改成表單維護, 共用模組PUB_GetDebitNotePS


'Add by Morgan 2009/11/4
'取得 FMP 案的期限
Public Function PUB_GetDeadLine(pCP05 As String, ByVal pLawLimit As String, pOption As Integer) As String
'pLawLimit:原始法定期限
'pOption:1=法限,2=所限,3=翻譯,4=核稿,5=會稿,6=回中代
   Dim iDiff As Integer, stSQL As String, adoRst As ADODB.Recordset, iR As Integer, stCol As String
   Dim stDate As String
   '天數=法限-收文日(不必前後都算)--2009/12/28 威立
   
   '無法限則抓45天
   If pLawLimit = "" Then
      iDiff = 45
      pLawLimit = CompDate(2, 44, pCP05)
   Else
      iDiff = DateDiff("d", ChangeWStringToWDateString(pCP05), ChangeWStringToWDateString(pLawLimit))
      If iDiff > 75 Then
         iDiff = 75
      'Add by Morgan 2011/8/24 過法限設當天,否則會沒期限
      ElseIf iDiff < 0 Then
         iDiff = 0
      End If
   End If
   
   '法限
   If pOption = 1 Then
      PUB_GetDeadLine = pLawLimit
   Else
      Select Case pOption
         Case 2 '所限
            stCol = "DL04"
         Case 3 '翻譯
            stCol = "DL02"
         Case 4 '核稿
            stCol = "DL03"
         Case 5 '會稿
            stCol = "DL05"
         Case 6 '回中代
            stCol = "DL06"
         Case Else
            Exit Function
      End Select
      stSQL = "select " & stCol & " from deadline where dl01=" & iDiff & " AND " & stCol & " is not null"
      iR = 1
      Set adoRst = ClsLawReadRstMsg(iR, stSQL)
      If iR = 1 Then
         '收文日要算
         stDate = CompDate(2, adoRst(0), pCP05)
         'Modified by Morgan 2022/4/1 全部都往前抓工作天-Sharon
         ''所限、翻譯要往前抓工作天
         'Select Case pOption
         '   Case 2, 3, 6
         '      stDate = PUB_GetWorkDay1(stDate, True)
         'End Select
         stDate = PUB_GetWorkDay1(stDate, True)
         'end 2022/4/1
         PUB_GetDeadLine = stDate
      End If
   End If
   Set adoRst = Nothing
End Function

'Added by Morgan 2012/3/26
'以(新穎性優惠期日/公告日)+1年更新相關美國發明案提申期限
Public Function PUB_UpdateUsPatent(pRefList() As String) As Boolean
   Dim stSQL As String, stVTB As String
   Dim ii As Integer
   Dim intR As Integer, rsQuery As ADODB.Recordset
   Dim stDate As String, strCP06 As String, strCP07 As String, strCP64 As String
   Dim stCon As String
   Dim strNP22 As String
   
   stVTB = ""
   For ii = 1 To UBound(pRefList, 2)
      If stVTB <> "" Then stVTB = stVTB & " union "
      stVTB = stVTB & " select '" & pRefList(1, ii) & "' c1,'" & pRefList(2, ii) & "' c2,'" & pRefList(3, ii) & "' c3,'" & pRefList(4, ii) & "' c4 from dual"
   Next
   If stVTB <> "" Then
      
      stSQL = "select pa01,pa02,pa03,pa04,cp10,pa140,pa14 from patent,caseprogress" & _
         " where (pa01,pa02,pa03,pa04) in (" & stVTB & ") and (pa140>0 or pa14>0)" & _
         " and cp01(+)=pa01 and cp02(+)=pa02 and cp03(+)=pa03 and cp04(+)=pa04 and cp10(+)='123'" & _
         " order by cp10 asc,pa140 asc,pa14 asc"
      intR = 1
      Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         If rsQuery.Fields("cp10") = "123" Then
            strCP64 = "期限來源:" & Right("  " & rsQuery.Fields("PA01"), 3) & "-" & rsQuery.Fields("PA02") & "-" & rsQuery.Fields("PA03") & "-" & rsQuery.Fields("PA04") & "(新穎性優惠日期+1年);"
            stDate = rsQuery.Fields("pa140")
         Else
            strCP64 = "期限來源:" & Right("  " & rsQuery.Fields("PA01"), 3) & "-" & rsQuery.Fields("PA02") & "-" & rsQuery.Fields("PA03") & "-" & rsQuery.Fields("PA04") & "(公告日+1年);"
            stDate = rsQuery.Fields("pa14")
            stCon = " AND NOT EXISTS(SELECT * FROM CASEPROGRESS C2 WHERE C2.CP01=C1.CP01 AND C2.CP02=C1.CP02 AND C2.CP03=C1.CP03 AND C2.CP04=C1.CP04 AND C2.CP10='106' AND C2.CP57 IS NULL)"
         End If
         
         strCP07 = CompDate(0, 1, stDate)
         '本所期限=法定期限-10天
         strCP06 = PUB_GetWorkDay1(CompDate(2, -10, strCP07), True)
         If strCP06 < strSrvDate(1) Then
            strCP06 = strSrvDate(1)
         End If
         
         '只考慮美國發明申請(101,118)
         'Modified by Morgan 2016/11/28 法定期限則未過期(不早於收文日)才更新 --郭 Ex.CFP-29093
         stSQL = "update caseprogress C1 set cp06=" & strCP06 & ",cp07=" & strCP07 & _
            ",CP64=SUBSTR(CP64,1,INSTR(CP64,'期限來源:')-1)||'" & strCP64 & "'||SUBSTR(CP64,INSTR(CP64,';',instr(CP64,'期限來源:'))+1)" & _
            " where cp10 in ('101','118') and cp27 is null and cp57 is null and cp05<=" & strCP07 & _
            " and (cp01,cp02,cp03,cp04) in (" & stVTB & ")" & _
            " AND EXISTS(SELECT * FROM patent WHERE PA01=C1.CP01 AND PA02=C1.CP02 AND PA03=C1.CP03 AND PA04=C1.CP04 AND PA09='101' AND PA46 IS NULL)" & stCon
         
         cnnConnection.Execute stSQL, intR
         
         strCP06 = PUB_GetWorkDay1(strCP07, True)
         If strCP06 < strSrvDate(1) Then
            strCP06 = strSrvDate(1)
         End If
         
         '更新最終期限(已發文未提申有最終提申期限)
         strSql = "update nextprogress set np08=" & strCP06 & ",np09=" & strCP07 & _
            ",np15=SUBSTR(np15,1,INSTR(np15,'期限來源:')-1)||'" & strCP64 & "'||SUBSTR(np15,INSTR(np15,';',instr(np15,'期限來源:'))+1)" & _
            " where np01 in (select cp09 from caseprogress C1 where cp10 in ('101','118') and cp27>0 and cp44>'Y' and cp47||cp57 is null and cp05<=" & strCP07 & _
            " and (cp01,cp02,cp03,cp04) in (" & stVTB & ")" & _
            " AND EXISTS(SELECT * FROM patent WHERE PA01=C1.CP01 AND PA02=C1.CP02 AND PA03=C1.CP03 AND PA04=C1.CP04  AND PA09='101' AND PA46 IS NULL)" & stCon & _
            ") and np07='996' and np06 is null"
         cnnConnection.Execute strSql, intI
         
         '新增最終期限(已發文未提申且無最終提申期限)
         strNP22 = GetNextProgressNo
         strSql = " insert into nextprogress a (np01,np02,np03,np04,np05,np07,np08,np09,np10,np15,np22)" & _
            " select cp09,cp01,cp02,cp03,cp04,'996'," & strCP06 & "," & strCP07 & ",'" & strUserNum & "','" & strCP64 & "'," & strNP22 & "+rownum-1" & _
            " from caseprogress C1 where cp10 in ('101','118') and cp27>0 and cp44>'Y' and cp47||cp57 is null and cp05<=" & strCP07 & _
            " and (cp01,cp02,cp03,cp04) in (" & stVTB & ")" & _
            " AND EXISTS(SELECT * FROM patent WHERE PA01=C1.CP01 AND PA02=C1.CP02 AND PA03=C1.CP03 AND PA04=C1.CP04  AND PA09='101' AND PA46 IS NULL)" & stCon & _
            " and not exists(select * from nextprogress b where b.np01=C1.cp09 and b.np07='996' and b.np06 is null)"
         cnnConnection.Execute strSql, intI

      End If
   End If
   
   Set rsQuery = Nothing
End Function

'Added by Morgan 2012/8/21
'檢查申請案號是否重複
Public Function PUB_ChkAppNo(pPA10 As String, pPA01 As String, pPA02 As String, pPA09 As String, Optional pPA23 As String) As Boolean
   Dim stSQL As String, adoRst As ADODB.Recordset, intR As Integer
   'Modified by Morgan 2016/3/24 +判斷申請案 pa23='1',因會同時收文舉發案 Ex.P114078, P114079
   'Modified by Morgan 2019/2/20 只需考慮申請國家不必限制相同系統別--秀玲
   stSQL = "select pa01||'-'||pa02||decode(pa03||pa04,'000','','-'||pa03||'-'||pa04)" & _
      " from patent where pa11='" & pPA10 & "' and pa23='1' and pa09='" & pPA09 & "' and pa01||pa02<>'" & pPA01 & pPA02 & "'"
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   If intR = 0 Then
      PUB_ChkAppNo = True
   ElseIf intR = 1 Then
      'Modified by Morgan 2016/3/24 非申請案改確認後可繼續
      If pPA23 = "1" Then
         MsgBox "本案申請號與 " & adoRst(0) & " 案重複！"
      Else
         If MsgBox("本案申請號與 " & adoRst(0) & " 案重複，是否確定要繼續？", vbQuestion + vbYesNo + vbDefaultButton2) = vbYes Then
            PUB_ChkAppNo = True
         End If
      End If
   End If
End Function

'Add by Sindy 2012/9/26
'檢查是否為一申請書多件並更新資料
Public Function PUB_UpdateCP148(pTM01 As String, pTM02 As String, pTM03 As String, pTM04 As String, pCP10 As String, pCP27 As String) As Boolean
   Dim stSQL As String, adoRst As ADODB.Recordset, intR As Integer
   
   PUB_UpdateCP148 = False
   
'   stSQL = "SELECT c1.* " & _
'           "FROM caseprogress c1,trademark t1,(select tm01,tm02,tm03,tm04,tm23,tm78,tm79,tm80,tm81 from trademark where TM01='" & pTM01 & "' AND TM02='" & pTM02 & "' AND TM03='" & pTM03 & "' AND TM04='" & pTM04 & "') t2 " & _
'           "WHERE c1.CP01='" & pTM01 & "' AND c1.CP27=" & DBDATE(pCP27) & " AND c1.CP10='" & pCP10 & "' " & _
'           "AND c1.CP01=t1.TM01(+) AND c1.CP02=t1.TM02(+) AND c1.CP03=t1.TM03(+) AND c1.CP04=t1.TM04(+) " & _
'           "AND t1.TM23||t1.TM78||t1.TM79||t1.TM80||t1.TM81=t2.TM23||t2.TM78||t2.TM79||t2.TM80||t2.TM81 " & _
'           "ORDER BY c1.CP01,c1.CP02,c1.CP03,c1.CP04 asc "
   'Modify By Sindy 2012/10/1
   'Modify By Sindy 2012/11/08 +, "", False
   stSQL = PUB_GetOneAppMuchCaseSql(pTM01, pTM02, pTM03, pTM04, pCP10, pCP27, "", False)
   '2012/10/1 End
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      If adoRst.RecordCount > 1 Then '抓出來的筆數必須大於1,代表才是一申請書多件
         PUB_UpdateCP148 = True
         adoRst.MoveFirst
         Do While Not adoRst.EOF
            strSql = "update caseprogress set cp148='Y' where cp09='" & adoRst.Fields("cp09") & "'"
            cnnConnection.Execute strSql
            adoRst.MoveNext
         Loop
      End If
   End If
   Set adoRst = Nothing
End Function

'Add by Sindy 2012/10/1
'取得一申請書多件的SQL
'Modify By Sindy 2012/11/08 +pCP28,bolSendAfter
Public Function PUB_GetOneAppMuchCaseSql(pTM01 As String, pTM02 As String, pTM03 As String, pTM04 As String, pCP10 As String, pCP27 As String, pCP28 As String, Optional bolSendAfter As Boolean = True) As String
Dim strSQL_1 As String, strSQL_2 As String
   
   PUB_GetOneAppMuchCaseSql = ""
   
   pCP27 = DBDATE(pCP27) 'Add By Sindy 2012/11/26
   'Add By Sindy 2012/11/08
   If bolSendAfter = True And pCP28 <> "" Then
      strSQL_1 = " AND CP28='" & pCP28 & "' "
      strSQL_2 = " AND c1.CP28='" & pCP28 & "' "
   End If
   '2012/11/08 End
   
   Select Case pCP10
      Case "301" '變更
         'Modify By Sindy 2015/7/1 +,t1.tm131
         'Modify By Sindy 2018/1/30 若已發文,則抓發文日期,發文字號相同的資料即可
         If bolSendAfter = True And pCP28 <> "" Then
            PUB_GetOneAppMuchCaseSql = "SELECT c1.*,t1.tm05,t1.tm09,t1.tm12,t1.tm15,t1.tm22,t1.tm45,t1.tm131 " & _
               "FROM caseprogress c1,trademark t1, " & _
               "(select tm01,tm02,tm03,tm04,tm23,tm78,tm79,tm80,tm81 from trademark where TM01='" & pTM01 & "' AND TM02='" & pTM02 & "' AND TM03='" & pTM03 & "' AND TM04='" & pTM04 & "') t2 " & _
               "WHERE c1.CP01='" & pTM01 & "' AND c1.CP27=" & pCP27 & " AND c1.CP10='" & pCP10 & "' " & strSQL_2 & _
               "AND c1.CP01=t1.TM01(+) AND c1.CP02=t1.TM02(+) AND c1.CP03=t1.TM03(+) AND c1.CP04=t1.TM04(+) " & _
               "AND t1.TM23||t1.TM78||t1.TM79||t1.TM80||t1.TM81=t2.TM23||t2.TM78||t2.TM79||t2.TM80||t2.TM81 " & _
               "ORDER BY c1.CP09 asc "
         Else
         '2018/1/30 END
            PUB_GetOneAppMuchCaseSql = "SELECT c1.*,t1.tm05,t1.tm09,t1.tm12,t1.tm15,t1.tm22,t1.tm45,t1.tm131 " & _
               "FROM caseprogress c1,trademark t1, " & _
               "(select tm01,tm02,tm03,tm04,tm23,tm78,tm79,tm80,tm81 from trademark where TM01='" & pTM01 & "' AND TM02='" & pTM02 & "' AND TM03='" & pTM03 & "' AND TM04='" & pTM04 & "') t2, " & _
               "changeevent e1, " & _
               "(select changeevent.* from caseprogress,changeevent where CP01='" & pTM01 & "' AND CP02='" & pTM02 & "' AND CP03='" & pTM03 & "' AND CP04='" & pTM04 & "' AND CP10='" & pCP10 & "' AND CP27=" & pCP27 & strSQL_1 & " and ce01=cp09) e2 " & _
               "WHERE c1.CP01='" & pTM01 & "' AND c1.CP27=" & pCP27 & " AND c1.CP10='" & pCP10 & "' " & strSQL_2 & _
               "AND c1.CP01=t1.TM01(+) AND c1.CP02=t1.TM02(+) AND c1.CP03=t1.TM03(+) AND c1.CP04=t1.TM04(+) " & _
               "AND t1.TM23||t1.TM78||t1.TM79||t1.TM80||t1.TM81=t2.TM23||t2.TM78||t2.TM79||t2.TM80||t2.TM81 " & _
               "AND e1.ce01=c1.cp09 " & _
               "AND ((e1.ce02 is null and e2.ce02 is null) or e1.ce02=e2.ce02) " & _
               "AND ((e1.ce04 is null and e2.ce04 is null) or e1.ce04=e2.ce04) " & _
               "AND ((e1.ce05 is null and e2.ce05 is null) or e1.ce05=e2.ce05) " & _
               "AND ((e1.ce06 is null and e2.ce06 is null) or e1.ce06=e2.ce06) " & _
               "AND ((e1.ce07 is null and e2.ce07 is null) or e1.ce07=e2.ce07) " & _
               "AND ((e1.ce08 is null and e2.ce08 is null) or e1.ce08=e2.ce08) " & _
               "AND ((e1.ce10 is null and e2.ce10 is null) or e1.ce10=e2.ce10) " & _
               "AND ((e1.ce11 is null and e2.ce11 is null) or e1.ce11=e2.ce11) " & _
               "AND ((e1.ce12 is null and e2.ce12 is null) or e1.ce12=e2.ce12) " & _
               "AND ((e1.ce13 is null and e2.ce13 is null) or e1.ce13=e2.ce13) " & _
               "AND ((e1.ce14 is null and e2.ce14 is null) or e1.ce14=e2.ce14) " & _
               "AND ((e1.ce15 is null and e2.ce15 is null) or e1.ce15=e2.ce15) " & _
               "AND ((e1.ce17 is null and e2.ce17 is null) or e1.ce17=e2.ce17) " & _
               "AND ((e1.ce18 is null and e2.ce18 is null) or e1.ce18=e2.ce18) " & _
               "AND ((e1.ce19 is null and e2.ce19 is null) or e1.ce19=e2.ce19) " & _
               "AND ((e1.ce20 is null and e2.ce20 is null) or e1.ce20=e2.ce20) "
            PUB_GetOneAppMuchCaseSql = PUB_GetOneAppMuchCaseSql & _
               "AND ((e1.ce21 is null and e2.ce21 is null) or e1.ce21=e2.ce21) " & _
               "AND ((e1.ce23 is null and e2.ce23 is null) or e1.ce23=e2.ce23) " & _
               "AND ((e1.ce24 is null and e2.ce24 is null) or e1.ce24=e2.ce24) " & _
               "AND ((e1.ce25 is null and e2.ce25 is null) or e1.ce25=e2.ce25) " & _
               "AND ((e1.ce26 is null and e2.ce26 is null) or e1.ce26=e2.ce26) " & _
               "AND ((e1.ce27 is null and e2.ce27 is null) or e1.ce27=e2.ce27) " & _
               "AND ((e1.ce28 is null and e2.ce28 is null) or e1.ce28=e2.ce28) " & _
               "AND ((e1.ce29 is null and e2.ce29 is null) or e1.ce29=e2.ce29) " & _
               "AND ((e1.ce30 is null and e2.ce30 is null) or e1.ce30=e2.ce30) " & _
               "AND ((e1.ce31 is null and e2.ce31 is null) or e1.ce31=e2.ce31) " & _
               "AND ((e1.ce32 is null and e2.ce32 is null) or e1.ce32=e2.ce32) " & _
               "AND ((e1.ce33 is null and e2.ce33 is null) or e1.ce33=e2.ce33) " & _
               "AND ((e1.ce34 is null and e2.ce34 is null) or e1.ce34=e2.ce34) " & _
               "AND ((e1.ce35 is null and e2.ce35 is null) or e1.ce35=e2.ce35) " & _
               "AND ((e1.ce36 is null and e2.ce36 is null) or e1.ce36=e2.ce36) " & _
               "AND ((e1.ce37 is null and e2.ce37 is null) or e1.ce37=e2.ce37) " & _
               "AND ((e1.ce39 is null and e2.ce39 is null) or e1.ce39=e2.ce39) " & _
               "AND ((e1.ce41 is null and e2.ce41 is null) or e1.ce41=e2.ce41) " & _
               "AND ((e1.ce42 is null and e2.ce42 is null) or e1.ce42=e2.ce42) " & _
               "AND ((e1.ce43 is null and e2.ce43 is null) or e1.ce43=e2.ce43) " & _
               "AND ((e1.ce45 is null and e2.ce45 is null) or e1.ce45=e2.ce45) " & _
               "AND ((e1.ce47 is null and e2.ce47 is null) or e1.ce47=e2.ce47) " & _
               "AND ((e1.ce49 is null and e2.ce49 is null) or e1.ce49=e2.ce49) " & _
               "AND ((e1.ce51 is null and e2.ce51 is null) or e1.ce51=e2.ce51) "
            PUB_GetOneAppMuchCaseSql = PUB_GetOneAppMuchCaseSql & _
               "AND ((e1.ce53 is null and e2.ce53 is null) or e1.ce53=e2.ce53) " & _
               "AND ((e1.ce55 is null and e2.ce55 is null) or e1.ce55=e2.ce55) " & _
               "AND ((e1.ce57 is null and e2.ce57 is null) or e1.ce57=e2.ce57) " & _
               "AND ((e1.ce59 is null and e2.ce59 is null) or e1.ce59=e2.ce59) " & _
               "AND ((e1.ce61 is null and e2.ce61 is null) or e1.ce61=e2.ce61) " & _
               "AND ((e1.ce63 is null and e2.ce63 is null) or e1.ce63=e2.ce63) " & _
               "AND ((e1.ce64 is null and e2.ce64 is null) or e1.ce64=e2.ce64) " & _
               "AND ((e1.ce66 is null and e2.ce66 is null) or e1.ce66=e2.ce66) " & _
               "AND ((e1.ce68 is null and e2.ce68 is null) or e1.ce68=e2.ce68) " & _
               "AND ((e1.ce69 is null and e2.ce69 is null) or e1.ce69=e2.ce69) " & _
               "AND ((e1.ce70 is null and e2.ce70 is null) or e1.ce70=e2.ce70) " & _
               "AND ((e1.ce71 is null and e2.ce71 is null) or e1.ce71=e2.ce71) " & _
               "AND ((e1.ce72 is null and e2.ce72 is null) or e1.ce72=e2.ce72) " & _
               "AND ((e1.ce73 is null and e2.ce73 is null) or e1.ce73=e2.ce73) " & _
               "AND ((e1.ce74 is null and e2.ce74 is null) or e1.ce74=e2.ce74) " & _
               "AND ((e1.ce75 is null and e2.ce75 is null) or e1.ce75=e2.ce75) " & _
               "AND ((e1.ce76 is null and e2.ce76 is null) or e1.ce76=e2.ce76) " & _
               "AND ((e1.ce77 is null and e2.ce77 is null) or e1.ce77=e2.ce77) " & _
               "AND ((e1.ce78 is null and e2.ce78 is null) or e1.ce78=e2.ce78) " & _
               "AND ((e1.ce79 is null and e2.ce79 is null) or e1.ce79=e2.ce79) " & _
               "AND ((e1.ce80 is null and e2.ce80 is null) or e1.ce80=e2.ce80) " & _
               "AND ((e1.ce81 is null and e2.ce81 is null) or e1.ce81=e2.ce81) " & _
               "AND ((e1.ce82 is null and e2.ce82 is null) or e1.ce82=e2.ce82) " & _
               "AND ((e1.ce83 is null and e2.ce83 is null) or e1.ce83=e2.ce83) "
            PUB_GetOneAppMuchCaseSql = PUB_GetOneAppMuchCaseSql & _
               "AND ((e1.ce84 is null and e2.ce84 is null) or e1.ce84=e2.ce84) " & _
               "AND ((e1.ce85 is null and e2.ce85 is null) or e1.ce85=e2.ce85) " & _
               "AND ((e1.ce86 is null and e2.ce86 is null) or e1.ce86=e2.ce86) " & _
               "AND ((e1.ce87 is null and e2.ce87 is null) or e1.ce87=e2.ce87) " & _
               "AND ((e1.ce88 is null and e2.ce88 is null) or e1.ce88=e2.ce88) " & _
               "AND ((e1.ce89 is null and e2.ce89 is null) or e1.ce89=e2.ce89) " & _
               "AND ((e1.ce90 is null and e2.ce90 is null) or e1.ce90=e2.ce90) " & _
               "AND ((e1.ce91 is null and e2.ce91 is null) or e1.ce91=e2.ce91) " & _
               "AND ((e1.ce92 is null and e2.ce92 is null) or e1.ce92=e2.ce92) " & _
               "AND ((e1.ce93 is null and e2.ce93 is null) or e1.ce93=e2.ce93) " & _
               "AND ((e1.ce94 is null and e2.ce94 is null) or e1.ce94=e2.ce94) " & _
               "AND ((e1.ce95 is null and e2.ce95 is null) or e1.ce95=e2.ce95) " & _
               "AND ((e1.ce96 is null and e2.ce96 is null) or e1.ce96=e2.ce96) " & _
               "AND ((e1.ce97 is null and e2.ce97 is null) or e1.ce97=e2.ce97) " & _
               "AND ((e1.ce98 is null and e2.ce98 is null) or e1.ce98=e2.ce98) " & _
               "AND ((e1.ce99 is null and e2.ce99 is null) or e1.ce99=e2.ce99) " & _
               "ORDER BY c1.CP09 asc "
               'Modify By Sindy 2012/11/01
               '"ORDER BY c1.CP01,c1.CP02,c1.CP03,c1.CP04 asc "
         End If
      Case "501" '移轉
         'Modify By Sindy 2015/7/1 +,t1.tm131
         'Modify By Sindy 2018/1/30 若已發文,則抓發文日期,發文字號相同的資料即可
         If bolSendAfter = True And pCP28 <> "" Then
            PUB_GetOneAppMuchCaseSql = "SELECT c1.*,t1.tm05,t1.tm09,t1.tm12,t1.tm15,t1.tm22,t1.tm45,t1.tm131 " & _
               "FROM caseprogress c1,trademark t1, " & _
               "(select tm01,tm02,tm03,tm04,tm23,tm78,tm79,tm80,tm81 from trademark where TM01='" & pTM01 & "' AND TM02='" & pTM02 & "' AND TM03='" & pTM03 & "' AND TM04='" & pTM04 & "') t2 " & _
               "WHERE c1.CP01='" & pTM01 & "' AND c1.CP27=" & pCP27 & " AND c1.CP10='" & pCP10 & "' " & strSQL_2 & _
               "AND c1.CP01=t1.TM01(+) AND c1.CP02=t1.TM02(+) AND c1.CP03=t1.TM03(+) AND c1.CP04=t1.TM04(+) " & _
               "AND t1.TM23||t1.TM78||t1.TM79||t1.TM80||t1.TM81=t2.TM23||t2.TM78||t2.TM79||t2.TM80||t2.TM81 " & _
               "ORDER BY c1.CP09 asc "
         Else
         '2018/1/30 END
            PUB_GetOneAppMuchCaseSql = "SELECT c1.*,t1.tm05,t1.tm09,t1.tm12,t1.tm15,t1.tm22,t1.tm45,t1.tm131 " & _
               "FROM caseprogress c1,trademark t1, " & _
               "(select tm01,tm02,tm03,tm04,tm23,tm78,tm79,tm80,tm81 from trademark where TM01='" & pTM01 & "' AND TM02='" & pTM02 & "' AND TM03='" & pTM03 & "' AND TM04='" & pTM04 & "') t2, " & _
               "(select cp55,cp93,cp94,cp95,cp96 from caseprogress where CP01='" & pTM01 & "' AND CP02='" & pTM02 & "' AND CP03='" & pTM03 & "' AND CP04='" & pTM04 & "' AND CP10='" & pCP10 & "' AND CP27=" & pCP27 & strSQL_1 & ") c2 " & _
               "WHERE c1.CP01='" & pTM01 & "' AND c1.CP27=" & pCP27 & " AND c1.CP10='" & pCP10 & "' " & strSQL_2 & _
               "AND c1.CP01=t1.TM01(+) AND c1.CP02=t1.TM02(+) AND c1.CP03=t1.TM03(+) AND c1.CP04=t1.TM04(+) " & _
               "AND t1.TM23||t1.TM78||t1.TM79||t1.TM80||t1.TM81=t2.TM23||t2.TM78||t2.TM79||t2.TM80||t2.TM81 " & _
               "AND ((c1.cp55 is null and c2.cp55 is null) or c1.cp55=c2.cp55) " & _
               "AND ((c1.cp93 is null and c2.cp93 is null) or c1.cp93=c2.cp93) " & _
               "AND ((c1.cp94 is null and c2.cp94 is null) or c1.cp94=c2.cp94) " & _
               "AND ((c1.cp95 is null and c2.cp95 is null) or c1.cp95=c2.cp95) " & _
               "AND ((c1.cp96 is null and c2.cp96 is null) or c1.cp96=c2.cp96) " & _
               "ORDER BY c1.CP09 asc "
               'Modify By Sindy 2012/11/01
               '"ORDER BY c1.CP01,c1.CP02,c1.CP03,c1.CP04 asc "
         End If
      Case "502", "504" '授權,再授權
         'Modify By Sindy 2015/7/1 +,t1.tm131
         'Modify By Sindy 2018/1/30 若已發文,則抓發文日期,發文字號相同的資料即可
         If bolSendAfter = True And pCP28 <> "" Then
            PUB_GetOneAppMuchCaseSql = "SELECT c1.*,t1.tm05,t1.tm09,t1.tm12,t1.tm15,t1.tm22,t1.tm45,t1.tm131 " & _
               "FROM caseprogress c1,trademark t1, " & _
               "(select tm01,tm02,tm03,tm04,tm23,tm78,tm79,tm80,tm81 from trademark where TM01='" & pTM01 & "' AND TM02='" & pTM02 & "' AND TM03='" & pTM03 & "' AND TM04='" & pTM04 & "') t2 " & _
               "WHERE c1.CP01='" & pTM01 & "' AND c1.CP27=" & pCP27 & " AND c1.CP10='" & pCP10 & "' " & strSQL_2 & _
               "AND c1.CP01=t1.TM01(+) AND c1.CP02=t1.TM02(+) AND c1.CP03=t1.TM03(+) AND c1.CP04=t1.TM04(+) " & _
               "AND t1.TM23||t1.TM78||t1.TM79||t1.TM80||t1.TM81=t2.TM23||t2.TM78||t2.TM79||t2.TM80||t2.TM81 " & _
               "ORDER BY c1.CP09 asc "
         Else
         '2018/1/30 END
            PUB_GetOneAppMuchCaseSql = "SELECT c1.*,t1.tm05,t1.tm09,t1.tm12,t1.tm15,t1.tm22,t1.tm45,t1.tm131 " & _
               "FROM caseprogress c1,trademark t1, " & _
               "(select tm01,tm02,tm03,tm04,tm23,tm78,tm79,tm80,tm81 from trademark where TM01='" & pTM01 & "' AND TM02='" & pTM02 & "' AND TM03='" & pTM03 & "' AND TM04='" & pTM04 & "') t2, " & _
               "(select cp50,cp51,cp52,cp53,cp54,cp72 from caseprogress where CP01='" & pTM01 & "' AND CP02='" & pTM02 & "' AND CP03='" & pTM03 & "' AND CP04='" & pTM04 & "' AND CP10='" & pCP10 & "' AND CP27=" & pCP27 & strSQL_1 & ") c2 " & _
               "WHERE c1.CP01='" & pTM01 & "' AND c1.CP27=" & pCP27 & " AND c1.CP10='" & pCP10 & "' " & strSQL_2 & _
               "AND c1.CP01=t1.TM01(+) AND c1.CP02=t1.TM02(+) AND c1.CP03=t1.TM03(+) AND c1.CP04=t1.TM04(+) " & _
               "AND t1.TM23||t1.TM78||t1.TM79||t1.TM80||t1.TM81=t2.TM23||t2.TM78||t2.TM79||t2.TM80||t2.TM81 " & _
               "AND ((c1.cp50 is null and c2.cp50 is null) or c1.cp50=c2.cp50) " & _
               "AND ((c1.cp51 is null and c2.cp51 is null) or c1.cp51=c2.cp51) " & _
               "AND ((c1.cp52 is null and c2.cp52 is null) or c1.cp52=c2.cp52) " & _
               "AND ((c1.cp53 is null and c2.cp53 is null) or c1.cp53=c2.cp53) " & _
               "AND ((c1.cp54 is null and c2.cp54 is null) or c1.cp54=c2.cp54) " & _
               "AND ((c1.cp72 is null and c2.cp72 is null) or c1.cp72=c2.cp72) " & _
               "ORDER BY c1.CP09 asc "
               'Modify By Sindy 2012/11/01
               '"ORDER BY c1.CP01,c1.CP02,c1.CP03,c1.CP04 asc "
         End If
   End Select
End Function

'Add by Sindy 2012/10/17
'組合定稿中一申請書多件的清單內容(英文)
'Modify By Sindy 2012/11/08 +pCP28
Public Function PUB_GetFCTAppendix(pTM01 As String, pTM02 As String, pTM03 As String, pTM04 As String, _
   pCP10 As String, pCP27 As String, pET01 As String, pCP28 As String, pET02 As String, pET03 As String) As String
Dim intRow As Integer, strTmp As String, intETRow As Integer
   
   PUB_GetFCTAppendix = Empty
   intRow = 0
   intETRow = 0 'Add By Sindy 2013/5/2
   'Modify By Sindy 2012/11/08 +pCP28
   strSql = PUB_GetOneAppMuchCaseSql(pTM01, pTM02, pTM03, pTM04, pCP10, pCP27, pCP28)
   RsTemp.Close
   intI = 1
   Set RsTemp = ClsLawReadRstMsg(intI, strSql)
   If intI = 1 Then
      RsTemp.MoveFirst
      Do While Not RsTemp.EOF
         'Add By Sindy 2013/5/2
         If intRow > 0 And (intRow Mod 20) = 0 Then
            '每20筆案件存一個例外欄位
            '一案多件清單
            intETRow = intETRow + 1
            strSql = "INSERT INTO EXCEPTCONDITION (ET01,ET02,ET03,ET04,ET05,ET06) " & _
                     "VALUES ('" & pET01 & "','" & pET02 & "','" & pET03 & "','" & strUserNum & _
                     "','一案多件清單" & intETRow & "','" & ChgSQL(Trim(PUB_GetFCTAppendix)) & "')"
            cnnConnection.Execute strSql
            PUB_GetFCTAppendix = Empty
         End If
         '2013/5/2 End
         intRow = intRow + 1
         If Len(Trim("" & RsTemp.Fields("tm09"))) >= 11 Then
            PUB_GetFCTAppendix = PUB_GetFCTAppendix & "(" & intRow & ") Reg. No.：" & Trim("" & RsTemp.Fields("tm15")) & " "
            PUB_GetFCTAppendix = PUB_GetFCTAppendix & "Class：" & Trim("" & RsTemp.Fields("tm09")) & " " & vbCrLf
         Else
            PUB_GetFCTAppendix = PUB_GetFCTAppendix & "(" & intRow & ") Reg. No.：" & Left(("" & RsTemp.Fields("tm15")) & "            ", 12)
            PUB_GetFCTAppendix = PUB_GetFCTAppendix & "Class：" & Left(("" & RsTemp.Fields("tm09")) & "           ", 11) & vbCrLf
         End If
         '商標名稱
         'Modify By Sindy 2015/7/1 RsTemp.Fields("tm05") ==> IIf("" & RsTemp.Fields("tm131") <> "", RsTemp.Fields("tm131"), RsTemp.Fields("tm05"))
         'PUB_GetFCTAppendix = PUB_GetFCTAppendix & "   Trademark：" & RsTemp.Fields("tm05") & vbCrLf
         PUB_GetFCTAppendix = PUB_GetFCTAppendix & "   Trademark：" & IIf("" & RsTemp.Fields("tm131") <> "", RsTemp.Fields("tm131"), RsTemp.Fields("tm05")) & vbCrLf
         '2015/7/1 END
         If pET01 = "03" And pCP10 = "501" Then '501.移轉
            '專用權止日
            strTmp = Empty
            'Modify By Sindy 2012/11/23
            'PUB_GetFCTAppendix = PUB_GetFCTAppendix & "   Expiry Date：" & IIf("" & RsTemp.Fields("tm22") = "", "", TranslateKeyWord(incCNV_ENGLISH_DATE, RsTemp.Fields("tm22"), strTmp)) & vbCrLf
            
            'Add By Sindy 2016/8/8 若是移轉核准，檢查半年前後發文的延展，抓其授權期間止日，若無，還是抓基本檔的專用期止日
            '參考frm03020401_04:InsExpField單筆的寫法(add by nickc 2008/05/08)
            Dim m_tmpday As String
            Dim m_rs As New ADODB.Recordset
            m_tmpday = ""
            Set m_rs = New ADODB.Recordset
            'Modify By Sindy 2018/9/6
            'strSql = "select cp54 from caseprogress where cp09 in (select max(cp09) from caseprogress where cp10='102' and cp01='" & pTM01 & "' and cp02='" & pTM02 & "' and cp03='" & pTM03 & "' and cp04='" & pTM04 & "' and cp27>='" & DBDATE(DateAdd("m", -6, ChangeWStringToWDateString(DBDATE(pCP27)))) & "' and cp27<='" & DBDATE(DateAdd("m", 6, ChangeWStringToWDateString(DBDATE(pCP27)))) & "' )"
            strSql = "select cp54 from caseprogress where cp09 in (select max(cp09) from caseprogress where cp10='102' and cp01='" & RsTemp.Fields("cp01") & "' and cp02='" & RsTemp.Fields("cp02") & "' and cp03='" & RsTemp.Fields("cp03") & "' and cp04='" & RsTemp.Fields("cp04") & "' and cp27>='" & DBDATE(DateAdd("m", -6, ChangeWStringToWDateString(DBDATE(pCP27)))) & "' and cp27<='" & DBDATE(DateAdd("m", 6, ChangeWStringToWDateString(DBDATE(pCP27)))) & "' )"
            '2018/9/6 END
            If m_rs.State = 1 Then m_rs.Close
            m_rs.CursorLocation = adUseClient
            m_rs.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
            If Not m_rs.EOF And Not m_rs.BOF Then
                m_tmpday = "" & m_rs.Fields("cp54")
            End If
            If m_tmpday = "" Then
                m_tmpday = "" & RsTemp.Fields("tm22")
            End If
            'If "" & RsTemp.Fields("tm22") = "" Then
            If m_tmpday = "" Then
               PUB_GetFCTAppendix = PUB_GetFCTAppendix & "   Expiry Date：" & vbCrLf
            Else
               'PUB_GetFCTAppendix = PUB_GetFCTAppendix & "   Expiry Date：" & TranslateKeyWord(incCNV_ENGLISH_DATE, RsTemp.Fields("tm22"), strTmp) & vbCrLf
               PUB_GetFCTAppendix = PUB_GetFCTAppendix & "   Expiry Date：" & TranslateKeyWord(incCNV_ENGLISH_DATE, m_tmpday, strTmp) & vbCrLf
            End If
            m_rs.Close
            '2016/8/8 END
            '2012/11/23 End
         End If
         '本所案號
         If RsTemp.Fields("cp03") = "0" And RsTemp.Fields("cp04") = "00" Then
            PUB_GetFCTAppendix = PUB_GetFCTAppendix & "   Our Ref：" & RsTemp.Fields("cp01") & "-" & RsTemp.Fields("cp02")
         Else
            PUB_GetFCTAppendix = PUB_GetFCTAppendix & "   Our Ref：" & RsTemp.Fields("cp01") & "-" & RsTemp.Fields("cp02") & "-" & RsTemp.Fields("cp03") & "-" & RsTemp.Fields("cp04")
         End If
         '彼所案號
         PUB_GetFCTAppendix = PUB_GetFCTAppendix & "     Your Ref：" & RsTemp.Fields("tm45") & vbCrLf & vbCrLf
         RsTemp.MoveNext
      Loop
   End If
   'Add By Sindy 2013/5/2
   If PUB_GetFCTAppendix <> Empty Then
      '一案多件清單
      intETRow = intETRow + 1
      strSql = "INSERT INTO EXCEPTCONDITION (ET01,ET02,ET03,ET04,ET05,ET06) " & _
               "VALUES ('" & pET01 & "','" & pET02 & "','" & pET03 & "','" & strUserNum & _
               "','一案多件清單" & intETRow & "','" & ChgSQL(Trim(PUB_GetFCTAppendix)) & "')"
      cnnConnection.Execute strSql
   End If
   '2013/5/2 End
End Function

'Add by Sindy 2018/11/22
'組合定稿中一申請書多件的清單內容(日文)
Public Function PUB_GetFCTAppendix_JP(pTM01 As String, pTM02 As String, pTM03 As String, pTM04 As String, _
   pCP10 As String, pCP27 As String, pET01 As String, pCP28 As String, pET02 As String, pET03 As String, _
   Optional ByRef intCnt As Integer) As String
Dim intRow As Integer, intETRow As Integer
'Dim strTmp As String
   
   PUB_GetFCTAppendix_JP = Empty
   intRow = 0
   intETRow = 0
   intCnt = 0
   strSql = PUB_GetOneAppMuchCaseSql(pTM01, pTM02, pTM03, pTM04, pCP10, pCP27, pCP28)
   RsTemp.Close
   intI = 1
   Set RsTemp = ClsLawReadRstMsg(intI, strSql)
   If intI = 1 Then
      intCnt = RsTemp.RecordCount
      RsTemp.MoveFirst
      Do While Not RsTemp.EOF
         If pET01 <> "03" Then
            If intRow > 0 And (intRow Mod 20) = 0 Then
               '每20筆案件存一個例外欄位
               '一案多件清單
               intETRow = intETRow + 1
               strSql = "INSERT INTO EXCEPTCONDITION (ET01,ET02,ET03,ET04,ET05,ET06) " & _
                        "VALUES ('" & pET01 & "','" & pET02 & "','" & pET03 & "','" & strUserNum & _
                        "','一案多件清單" & intETRow & "','" & ChgSQL(PUB_GetFCTAppendix_JP) & "')"
               cnnConnection.Execute strSql
               PUB_GetFCTAppendix_JP = Empty
            End If
         End If
         
         intRow = intRow + 1
         If pET01 = "03" Then '核准,全部列出
            '登鰷00062430A、登鰷00062431A、...
            'Modifed by Lydia 2023/04/21 更換Unicode
            'PUB_GetFCTAppendix_JP = PUB_GetFCTAppendix_JP & IIf(intRow = 1, "　", "") & "登鰷" & Trim("" & RsTemp.Fields("tm15")) & "A、"
            PUB_GetFCTAppendix_JP = PUB_GetFCTAppendix_JP & IIf(intRow = 1, "　", "") & "登" & PUB_GetUniText("共用", "錄") & "第" & Trim("" & RsTemp.Fields("tm15")) & PUB_GetUniText("共用", "號") & "、"
         Else 'If pET01 = "01" Then '發文
            '1.登鰷01763677A「SANTEN」
            '2.登鰷01763678A「Santen／駍z天及形」
            'PUB_GetFCTAppendix_JP = PUB_GetFCTAppendix_JP & "　　" & intRow & ".登鰷" & Trim("" & RsTemp.Fields("tm15")) & "A「" & Trim("" & RsTemp.Fields("tm05")) & "」" & vbCrLf
            '1.登鰽fA：01754779 (註冊號數)
            '  商標名鵅G舞臺巡禮 (商標名稱)
            '2.登鰽fA：01754780
            '  商標名鵅GButaimeguri
            'Modify By Sindy 2019/1/15 多一行空白列
            If intRow > 1 Then
               PUB_GetFCTAppendix_JP = PUB_GetFCTAppendix_JP & vbCrLf
            End If
            '2019/1/15 END
            'Modifed by Lydia 2023/04/21 更換Unicode
            'PUB_GetFCTAppendix_JP = PUB_GetFCTAppendix_JP & IIf(intRow = 1, "　", "　　") & intRow & ".登鰽fA：" & Trim("" & RsTemp.Fields("tm15")) & vbCrLf
            'PUB_GetFCTAppendix_JP = PUB_GetFCTAppendix_JP & "　　  商標名鵅G「" & Trim("" & RsTemp.Fields("tm05")) & "」" & vbCrLf
            PUB_GetFCTAppendix_JP = PUB_GetFCTAppendix_JP & IIf(intRow = 1, "　", "　　") & intRow & ".登" & PUB_GetUniText("共用", "錄") & "番" & PUB_GetUniText("共用", "號") & "：" & Trim("" & RsTemp.Fields("tm15")) & vbCrLf
            PUB_GetFCTAppendix_JP = PUB_GetFCTAppendix_JP & "　　  商標名" & PUB_GetUniText("共用", "稱") & "：「" & Trim("" & RsTemp.Fields("tm05")) & "」" & vbCrLf
         End If
         
         RsTemp.MoveNext
      Loop
   End If
   If PUB_GetFCTAppendix_JP <> Empty Then
      If pET01 = "03" Then
         If Right(PUB_GetFCTAppendix_JP, 1) = "、" Then
            PUB_GetFCTAppendix_JP = Left(PUB_GetFCTAppendix_JP, Len(PUB_GetFCTAppendix_JP) - 1) & "。"
         End If
      End If
      '一案多件清單
      intETRow = intETRow + 1
      strSql = "INSERT INTO EXCEPTCONDITION (ET01,ET02,ET03,ET04,ET05,ET06) " & _
               "VALUES ('" & pET01 & "','" & pET02 & "','" & pET03 & "','" & strUserNum & _
               "','一案多件清單" & intETRow & "','" & ChgSQL(PUB_GetFCTAppendix_JP) & "')"
      cnnConnection.Execute strSql
   End If
End Function

'Add By Sindy 2012/11/08
'檢查發文字號是否有多筆
Public Function PUB_ChkIsOneAppMuchCase(pCP28 As String) As Boolean
   Dim stSQL As String, adoRst As ADODB.Recordset, intR As Integer
   
   PUB_ChkIsOneAppMuchCase = False
   
   stSQL = "SELECT count(*) " & _
           "FROM CaseProgress " & _
           "WHERE CP28='" & pCP28 & "'"
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      If adoRst.Fields(0) > 1 Then
         PUB_ChkIsOneAppMuchCase = True
      End If
   End If
End Function

'Add by Sindy 2012/10/4
'外->台,智權人員是葉雪貞及巨京,發文規費和收文規費不相同時,系統自動更改進度檔內規費費用及計算點數
'Modified by 2015/10/16 +更新CP84的判斷(nCP84)
Public Function PUB_TSendUpdateCP1718(pCP09 As String, pCP84 As String, ptextPrint As String, pTM10 As String, pCP13 As String, nCP84 As String) As Boolean
Dim stSQL As String, adoRst As ADODB.Recordset, intR As Integer
Dim dblCP16 As Double, dblCP18 As Double, strNation As String
   
   PUB_TSendUpdateCP1718 = False
   
   stSQL = "select tm23,tm44 from caseprogress,trademark where cp09='" & pCP09 & "' " & _
           "and tm01(+)=cp01 and tm02(+)=cp02 and tm03(+)=cp03 and tm04(+)=cp04"
   'Added by Lydia 2015/10/16 +服務業務檔
   stSQL = stSQL & " Union select sp08 as tm23,sp26 as tm44 from caseprogress,ServicePractice where cp09='" & pCP09 & "' " & _
           "and sp01(+)=cp01 and sp02(+)=cp02 and sp03(+)=cp03 and sp04(+)=cp04"
   stSQL = "select * from (" & stSQL & ") where not(tm23||tm44 is null) "
   
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      If Not IsNull(adoRst.Fields("tm44")) Then
         '代理人國籍代號
         strNation = GetPrjNationNumber(adoRst.Fields("tm44"))
      ElseIf Not IsNull(adoRst.Fields("tm23")) Then
         '申請人國籍代號
         strNation = GetPrjNationNumber1(adoRst.Fields("tm23"))
      End If
   End If
   adoRst.Close
   
   'Modify By Sindy 2013/8/22 strNation = "020" ==> strNation <> "000" ex.T-186224
   'modify by sonia 2014/4/11 strNation <> "000" 改為 strNation > "010"  T-191757
   'Modified by Lydia 2016/08/03 +判斷系統特殊設定"MCTF"開頭 的人員
   'If (pCP13 = "67002" Or pCP13 = "96029" Or pCP13 = "96030") And _
      pTM10 = "000" And strNation > "010" And _
      Val(pCP84) > 0 Then
   stSQL = Pub_GetSpecMan("MCTF", True)
   If (pCP13 = "67002" Or pCP13 = "96029" Or pCP13 = "96030" Or InStr(stSQL, pCP13) > 0) And pTM10 = "000" And strNation > "010" And Val(pCP84) > 0 Then
      stSQL = "select cp16,cp17,cp18 from caseprogress where cp09='" & pCP09 & "'"
      intR = 1
      Set adoRst = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         If Val("" & adoRst.Fields("cp16")) > 0 And Val("" & adoRst.Fields("cp17")) <> Val(pCP84) Then
            PUB_TSendUpdateCP1718 = True
            dblCP16 = Val(adoRst.Fields("cp16"))
            If dblCP16 <= Val(pCP84) Then
               dblCP16 = Val(pCP84)
               dblCP18 = 0
            Else
               dblCP18 = Format(((dblCP16 - Val(pCP84)) / 1000), "0.0")
            End If
            strSql = "update caseprogress set cp16=" & dblCP16 & ",cp17=" & pCP84 & ",cp18=" & dblCP18 & " where cp09='" & pCP09 & "'"
            cnnConnection.Execute strSql
            nCP84 = pCP84 'Modified by 2015/10/16 +更新CP84的判斷
         End If
      End If
      Set adoRst = Nothing
   End If
End Function

'Added by Morganq 2012/10/12 改frm060104_a.GetPatentYearFee為共用
Public Sub PUB_GetPatentYearFee( _
    strYF01 As String, strYF02 As String, strYF03 As String, _
    strYF04 As String, strYF05From As String, strYF05To As String, blnDouble As Boolean, strCP81 As String, strPA14 As String, _
    strAppDate As String, Optional p_strOfficalFee As String, Optional p_strServiceFee As String, Optional p_lngDisc As Long, _
    Optional p_bol2ndY As Boolean)
'傳入
'strYF01  申請國家
'strYF02  專利種類
'strYF03  代理人
'strYF04  案件性質
'strYF05From  起始年度
'strYF05To  終止年度
'blnDouble  規費是否雙倍
'strCP81  是否可減免(Y:是)
'strPA14  公告日
'strAppDate  發文日
'回傳
'p_strOfficalFee 規費
'p_strServiceFee  服務費
'p_lngDisc  減免金額
'p_bol2ndY  次年是否補繳

Dim rsA As New ADODB.Recordset
Dim StrSQLa As String
Dim ii As Integer
Dim iYear As Integer '繳費年度

Dim strApplyDate As String
Dim lngOfficalFee As Long
Dim lngDiscount As Long
Dim dblMultiple1 As Double '起始年倍數
Dim dblMultiple2 As Double '次年倍數
Dim strStartDate As String
Dim strTmpDate As String
   
   dblMultiple1 = 1
   dblMultiple2 = 1
   p_bol2ndY = False
   If blnDouble = True Then
      '102新法
      strApplyDate = DBDATE(strAppDate)
      If Val(strApplyDate) >= 20130101 Then
         '起始年起算日=公告日+已繳年度
         strStartDate = CompDate(0, Val(strYF05From) - 1, strPA14)
         
         '補繳期限(起算日+6個月-1天,遇假日順延)
         strTmpDate = CompDate(1, 6, strStartDate)
         strTmpDate = CompDate(2, -1, strTmpDate)
         strTmpDate = PUB_GetWorkDay1(strTmpDate, False)
         '6個月內每月+20%,最多+100%
         If strApplyDate <= strTmpDate Then
            dblMultiple1 = 1.2
            For ii = 1 To 4
               strTmpDate = CompDate(1, ii, strStartDate)
               strTmpDate = CompDate(2, -1, strTmpDate)
               strTmpDate = PUB_GetWorkDay1(strTmpDate, False)
               If strApplyDate <= strTmpDate Then Exit For
               dblMultiple1 = dblMultiple1 + 0.2
            Next
         '超過6個月補繳3倍
         Else
            dblMultiple1 = 3
            '有繳次年且超過法限也要加成
            If Val(strYF05To) > Val(strYF05From) Then
               '次年法定期限(起算日+1年-1天,遇假日順延)
               strStartDate = CompDate(0, 1, strStartDate)
               strTmpDate = CompDate(2, -1, strStartDate)
               strTmpDate = PUB_GetWorkDay1(strTmpDate, False)
               If strApplyDate > strTmpDate Then
                  p_bol2ndY = True
                  dblMultiple2 = 1.2
                  For ii = 1 To 4
                     strTmpDate = CompDate(1, ii, strStartDate)
                     strTmpDate = CompDate(2, -1, strTmpDate)
                     strTmpDate = PUB_GetWorkDay1(strTmpDate, False)
                     If strApplyDate <= strTmpDate Then Exit For
                     dblMultiple2 = dblMultiple2 + 0.2
                  Next
               End If
            End If
         End If
      Else
         dblMultiple1 = 2
      End If
   End If

   p_strOfficalFee = 0
   p_strServiceFee = 0
   p_lngDisc = 0
    
   ii = 1
   '取得案件性質為年費的相關費用
   StrSQLa = "Select * From PatentYearFee Where YF01='" & strYF01 & "' AND YF02='" & strYF02 & "' AND YF03='" & strYF03 & "' AND YF04='" & 年費 & "' AND YF05>=" & Val(strYF05From) & " AND YF05<=" & Val(strYF05To) & " Order By YF05 "
   rsA.CursorLocation = adUseClient
   rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
   While Not rsA.EOF
      lngOfficalFee = Val(rsA.Fields("YF07").Value)
      lngDiscount = 0
      iYear = Val(rsA.Fields("YF05").Value)
      If strCP81 = "Y" Then
         If iYear >= 1 And iYear <= 3 Then
            lngDiscount = 800
            lngOfficalFee = lngOfficalFee - lngDiscount
         ElseIf iYear >= 4 And iYear <= 6 Then
            lngDiscount = 1200
            lngOfficalFee = lngOfficalFee - lngDiscount
         End If
      End If
            
         '起始那年年費是否雙倍
      If blnDouble = True Then
         If ii = 1 Then
            lngOfficalFee = lngOfficalFee * dblMultiple1
            lngDiscount = lngDiscount * dblMultiple1
         ElseIf ii = 2 Then
            lngOfficalFee = lngOfficalFee * dblMultiple2
            lngDiscount = lngDiscount * dblMultiple2
         End If
      End If
         
      p_lngDisc = p_lngDisc + lngDiscount
      p_strOfficalFee = Val(p_strOfficalFee) + lngOfficalFee
      p_strServiceFee = Val(p_strServiceFee) + Val(rsA.Fields("YF06").Value)
      rsA.MoveNext
      ii = ii + 1
   Wend
   If rsA.State <> adStateClosed Then rsA.Close
   Set rsA = Nothing
End Sub

'Added by Morgan 2012/12/7
'取得預設列印幣別格式及請款幣別
'Public Function PUB_GetDefaultCurrPrintType(stSysCode As String, stAgentNo As String, stA1K18 As String) As Integer
'Modify By Sindy 2016/11/29 + ,Optional ByVal stCP02 As String, _
      Optional ByVal stCP03 As String, Optional ByVal stCP04 As String
'Modified by Morgan 2018/4/27 +stA1K27,列印對象設定優先於請款對象(Ex.請款單:X10705570)--David 確認
'Modify By Sindy 2021/3/3 + Optional ByRef stFA126 As String:商標請款單之本所帳戶
Public Function PUB_GetDefaultCurrPrintType(ByVal stSysCode As String, ByVal stAgentNo As String, _
      ByVal stA1K18 As String, Optional ByRef strCurr As String, Optional ByVal stCP02 As String, _
      Optional ByVal stCP03 As String, Optional ByVal stCP04 As String, Optional ByVal stA1K27 As String, _
      Optional ByRef stFA126 As String) As Integer
      
   Dim stSysKind As String, stSQL As String, intR As Integer
   Dim adoTmp As ADODB.Recordset
   Dim strType As String 'Add By Sindy 2013/1/17
      
   'Modify By Sindy 2013/1/28
'   If strSrvDate(1) >= AccFMPImputCurrStarDate Then
      PUB_GetDefaultCurrPrintType = 2 '預設台幣+外幣
      stSysKind = CheckSys(stSysCode)
      
      'Add By Sindy 2021/3/3 內商
      stFA126 = ""
      If Left(stSysCode, 1) = "T" Then stFA126 = 2 '台銀帳戶+董事長
      '2021/3/3 END
      
      'Add By Sindy 2016/11/29 若有輸入個案先檢查個案是否有設定值
      If stSysCode <> "" And stCP02 <> "" Then
         If stCP03 = "" Then stCP03 = "0"
         If stCP04 = "" Then stCP04 = "00"
         stSQL = "select pa170,pa171 from patent where pa01='" & stSysCode & "' and pa02='" & stCP02 & "' and pa03='" & stCP03 & "' and pa04='" & stCP04 & "'" & _
                 " union select tm134 pa170,tm135 pa171 from trademark where tm01='" & stSysCode & "' and tm02='" & stCP02 & "' and tm03='" & stCP03 & "' and tm04='" & stCP04 & "'" & _
                 " union select sp88 pa170,sp89 pa171 from servicepractice where sp01='" & stSysCode & "' and sp02='" & stCP02 & "' and sp03='" & stCP03 & "' and sp04='" & stCP04 & "'" & _
                 " union select lc49 pa170,lc50 pa171 from lawcase where lc01='" & stSysCode & "' and lc02='" & stCP02 & "' and lc03='" & stCP03 & "' and lc04='" & stCP04 & "'"
         intR = 1
         Set adoTmp = ClsLawReadRstMsg(intR, stSQL)
         If intR = 1 Then
            strCurr = "" & adoTmp("pa170")
            strType = "" & adoTmp("pa171")
            'Add By Sindy 2017/2/2
            If Trim(strType) <> "" Then
               PUB_GetDefaultCurrPrintType = Val(strType)
            End If
            '2017/2/2 END
         End If
      End If
      
      'Added by Morgan 2018/4/27 列印對象設定優先於請款對象
      If strType = "" Then
         If stA1K27 <> "" Then
            'Add By Sindy 2021/3/3 +fa126
            If Left(stA1K27, 1) = "Y" Then
               stSQL = "select fa43,fa108,fa115,fa116,fa126 from fagent where fa01='" & Left(stA1K27, 8) & "' and fa02='" & Mid(stA1K27, 9) & "'"
            Else
               stSQL = "select cu76 as fa43,cu148 as fa108,cu156 as fa115,cu157 as fa116,'' as fa126 from customer where cu01='" & Left(stA1K27, 8) & "' and cu02='" & Mid(stA1K27, 9) & "'"
            End If
            intR = 1
            Set adoTmp = ClsLawReadRstMsg(intR, stSQL)
            If intR = 1 Then
               'Add By Sindy 2021/3/3 內商
               If Left(stSysCode, 1) = "T" Then
                  If "" & adoTmp("fa126") <> "" Then
                     stFA126 = "" & adoTmp("fa126")
                  End If
               End If
               '2021/3/3 END
               
               '商標
               If stSysKind = "2" Or stSysKind = "6" Then
                  strCurr = "" & adoTmp("fa108")
                  strType = "" & adoTmp("fa116")
               '非商標
               Else
                  strCurr = "" & adoTmp("fa43")
                  strType = "" & adoTmp("fa115")
               End If
               If Trim(strType) <> "" Then
                  PUB_GetDefaultCurrPrintType = Val(strType)
               End If
            End If
         End If
      End If
      'end 2018/4/27
         
      If strType = "" Then
       '2016/11/29 END
         'Add By Sindy 2021/3/3 +fa126
         If Left(stAgentNo, 1) = "Y" Then
            'Modify By Sindy 2013/1/17 +,fa115,fa116
            stSQL = "select fa43,fa108,fa115,fa116,fa126 from fagent where fa01='" & Left(stAgentNo, 8) & "' and fa02='" & Mid(stAgentNo, 9) & "'"
         Else
            'Modify By Sindy 2013/1/17 +,cu156 as fa115,cu157 as fa116
            stSQL = "select cu76 as fa43,cu148 as fa108,cu156 as fa115,cu157 as fa116,'' as fa126 from customer where cu01='" & Left(stAgentNo, 8) & "' and cu02='" & Mid(stAgentNo, 9) & "'"
         End If
         intR = 1
         Set adoTmp = ClsLawReadRstMsg(intR, stSQL)
         If intR = 1 Then
            'Add By Sindy 2021/3/3 內商
            If Left(stSysCode, 1) = "T" Then
               If "" & adoTmp("fa126") <> "" Then
                  stFA126 = "" & adoTmp("fa126")
               End If
            End If
            '2021/3/3 END
            
            '商標
            If stSysKind = "2" Or stSysKind = "6" Then
               strCurr = "" & adoTmp("fa108")
               strType = "" & adoTmp("fa116") 'Add By Sindy 2013/1/17
            '非商標
            Else
               strCurr = "" & adoTmp("fa43")
               strType = "" & adoTmp("fa115") 'Add By Sindy 2013/1/17
            End If
            
      '2013/1/10 modify by sonia
      '      '台幣
      '      If strCurr = "N" Or stA1K18 = "NTD" Then
      '         PUB_GetDefaultCurrPrintType = 1 '純台幣
      '      '人民幣
      '      ElseIf strCurr = "R" Then
      '         PUB_GetDefaultCurrPrintType = 4 '外幣+美金合計
      '      '其他外幣
      '      ElseIf strCurr <> "" Then
      '         PUB_GetDefaultCurrPrintType = 3 '純外幣
      '      '未設定
      '      Else
      '         '美金請款
      '         If stA1K18 = "USD" Then
      '            PUB_GetDefaultCurrPrintType = 2 '台幣+外幣
      '         '人民幣請款
      '         ElseIf stA1K18 = "RMB" Then
      '            PUB_GetDefaultCurrPrintType = 4 '外幣+美金合計
      '         Else
      '            PUB_GetDefaultCurrPrintType = 3 '純外幣
      '         End If
      '      End If
            'Modify By Sindy 2013/1/17
      '      '台幣
      '      If strCurr = "N" Then
      '         PUB_GetDefaultCurrPrintType = 1 '純台幣
      '      '人民幣
      '      ElseIf strCurr = "R" Then
      '         PUB_GetDefaultCurrPrintType = 4 '外幣+美金合計
      '      '美金
      '      ElseIf strCurr = "U" Then
      '         PUB_GetDefaultCurrPrintType = 3 '純外幣
      '      '未設定
      '      Else
      '         '台幣
      '         If stA1K18 = "NTD" Then
      '            PUB_GetDefaultCurrPrintType = 1 '純台幣
      '         '人民幣
      '         ElseIf stA1K18 = "RMB" Then
      '            PUB_GetDefaultCurrPrintType = 4 '外幣+美金合計
      '         '其他幣別(列印3純外幣由人工自行修改)
      '         ElseIf stA1K18 = "USD" Then
      '            PUB_GetDefaultCurrPrintType = 2 '台幣+外幣
      '         End If
      '      End If
      ''2013/1/10 end
            If Trim(strType) <> "" Then
               PUB_GetDefaultCurrPrintType = Val(strType)
            '未設定
            Else
               '台幣
               If stA1K18 = "NTD" Then
                  PUB_GetDefaultCurrPrintType = 1 '純台幣
               '人民幣
               ElseIf stA1K18 = "RMB" Then
                  PUB_GetDefaultCurrPrintType = 4 '外幣+美金合計
               End If
            End If
            '2013/1/17 End
         End If
      End If
      
      '新增請款單,且請款對象又沒設定幣別及格式時
      If strType = "" And stA1K18 = "" Then
         strCurr = "USD"
         PUB_GetDefaultCurrPrintType = 2 '預設台幣+外幣
      End If
'   Else
'   '2013/1/28 End
'
'      PUB_GetDefaultCurrPrintType = 2 '預設台幣+外幣
'      stSysKind = CheckSys(stSysCode)
'      If Left(stAgentNo, 1) = "Y" Then
'         stSQL = "select fa43,fa108 from fagent where fa01='" & Left(stAgentNo, 8) & "' and fa02='" & Mid(stAgentNo, 9) & "'"
'      Else
'         stSQL = "select cu76 as fa43,cu148 as fa108 from customer where cu01='" & Left(stAgentNo, 8) & "' and cu02='" & Mid(stAgentNo, 9) & "'"
'      End If
'      intR = 1
'      Set adoTmp = ClsLawReadRstMsg(intR, stSQL)
'      If intR = 1 Then
'         '商標
'         If stSysKind = "2" Or stSysKind = "6" Then
'            strCurr = "" & adoTmp("fa108")
'         '非商標
'         Else
'            strCurr = "" & adoTmp("fa43")
'         End If
'
'   '2013/1/10 modify by sonia
'   '      '台幣
'   '      If strCurr = "N" Or stA1K18 = "NTD" Then
'   '         PUB_GetDefaultCurrPrintType = 1 '純台幣
'   '      '人民幣
'   '      ElseIf strCurr = "R" Then
'   '         PUB_GetDefaultCurrPrintType = 4 '外幣+美金合計
'   '      '其他外幣
'   '      ElseIf strCurr <> "" Then
'   '         PUB_GetDefaultCurrPrintType = 3 '純外幣
'   '      '未設定
'   '      Else
'   '         '美金請款
'   '         If stA1K18 = "USD" Then
'   '            PUB_GetDefaultCurrPrintType = 2 '台幣+外幣
'   '         '人民幣請款
'   '         ElseIf stA1K18 = "RMB" Then
'   '            PUB_GetDefaultCurrPrintType = 4 '外幣+美金合計
'   '         Else
'   '            PUB_GetDefaultCurrPrintType = 3 '純外幣
'   '         End If
'   '      End If
'         '台幣
'         If strCurr = "N" Then
'            PUB_GetDefaultCurrPrintType = 1 '純台幣
'         '人民幣
'         ElseIf strCurr = "R" Then
'            PUB_GetDefaultCurrPrintType = 4 '外幣+美金合計
'         '美金
'         ElseIf strCurr = "U" Then
'            PUB_GetDefaultCurrPrintType = 3 '純外幣
'         '未設定
'         Else
'            '台幣
'            If stA1K18 = "NTD" Then
'               PUB_GetDefaultCurrPrintType = 1 '純台幣
'            '人民幣
'            ElseIf stA1K18 = "RMB" Then
'               PUB_GetDefaultCurrPrintType = 4 '外幣+美金合計
'            '其他幣別(列印3純外幣由人工自行修改)
'            ElseIf stA1K18 = "USD" Then
'               PUB_GetDefaultCurrPrintType = 2 '台幣+外幣
'            End If
'         End If
'   '2013/1/10 end
'      End If
'   End If
   
End Function

'Added by Lydia 2014/12/15
'判斷案件的FC代理人和申請人是否有預設請款幣別,匯率及列印幣別格式,回傳為請款單的預設設定
'Modify By Sindy 2016/11/30 + ,Optional ByVal stCP02 As String, Optional ByVal stCP03 As String, Optional ByVal stCP04 As String
Public Function PUB_GetInitCurrPrintType(inSys As String, inFA01 As String, ByRef inCurr As String, ByRef inRate As Double, _
      Optional ByVal stCP02 As String, Optional ByVal stCP03 As String, Optional ByVal stCP04 As String, Optional ByVal stA1K27 As String) As Integer

    '依請款對象抓請款幣別
    'Modify By Sindy 2016/11/30
    'PUB_GetInitCurrPrintType = PUB_GetDefaultCurrPrintType(inSys, inFA01, "", inCurr)
    PUB_GetInitCurrPrintType = PUB_GetDefaultCurrPrintType(inSys, inFA01, "", inCurr, stCP02, stCP03, stCP04, stA1K27)
    '2016/11/30 END
    
    '匯率
    inRate = PUB_GetUSXRate_1(strSrvDate(2), inCurr)
End Function

'Added by Morgan 2012/11/2
'更新請款單外幣金額
Public Sub PUB_UpdateA1k08(pA1k01 As String)
   Dim stSQL As String, intR As Integer, adoTmp As ADODB.Recordset, iType As Integer
   '外幣合計抓明細外幣加總
   'Modified by Morgan 2012/12/7
   'stSQL = "update acc1k0 set a1k08=(select sum(round((a1l05-nvl(a1l07,0))/decode(a1k10,0,1,a1k10),2)) from acc1l0 where a1l01=a1k01) where a1k01='" & pA1k01 & "'"
   'cnnConnection.Execute stSQL, intR
   stSQL = "select * from acc1k0 where a1k01='" & pA1k01 & "' and a1k10>0"
   intR = 1
   Set adoTmp = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      With adoTmp
      
      'Modify By Sindy 2016/11/29
      'iType = PUB_GetDefaultCurrPrintType(.Fields("a1k13"), .Fields("a1k27"), .Fields("a1k18"))
      'Modified by Morgan 2018/4/27
      'iType = PUB_GetDefaultCurrPrintType(.Fields("a1k13"), .Fields("a1k27"), .Fields("a1k18"), , .Fields("a1k14"), .Fields("a1k15"), .Fields("a1k16"))
      iType = PUB_GetDefaultCurrPrintType(.Fields("a1k13"), .Fields("a1k28"), .Fields("a1k18"), , .Fields("a1k14"), .Fields("a1k15"), .Fields("a1k16"), .Fields("a1k27"))
      '2016/11/29 END
      
      Select Case iType
      Case 3, 4
         stSQL = "update acc1k0 set a1k08=(select sum(trunc((a1l05-nvl(a1l07,0))/a1k10)) from acc1l0 where a1l01=a1k01),a1k33='" & iType & "' where a1k01='" & pA1k01 & "'"
         cnnConnection.Execute stSQL, intR
      Case Else
         stSQL = "update acc1k0 set a1k08=trunc(a1k11/a1k10),a1k33='" & iType & "' where a1k01='" & pA1k01 & "'"
         'Added by Morgan 2013/12/4 請款日期>=1021205改用新格式
         If Val(.Fields("a1k02")) >= 1021205 Then
            'Modified by Morgan 2014/2/25 +傳本所案號
            If PUB_GetBillFormat(.Fields("a1k28"), .Fields("a1k13"), .Fields("a1k14"), .Fields("a1k15"), .Fields("a1k16")) = 0 Then
               stSQL = "update acc1k0 set a1k08=(select trunc(sum(decode(substrb(a1l04,-2),'99',a1l05-nvl(a1l07,0),0))/a1k10)+trunc(sum(decode(substrb(a1l04,-2),'99',0,a1l05-nvl(a1l07,0)))/a1k10) from acc1l0 where a1l01=a1k01),a1k33='" & iType & "' where a1k01='" & pA1k01 & "'"
            End If
         End If
         'end 2013/12/4
         cnnConnection.Execute stSQL, intR
      End Select
      End With
   End If
   
   Set adoTmp = Nothing
End Sub

'Added by Morgan 2013/1/3
'計算技術報告規費
'Modify By Sindy 2014/6/18 + lngOverItemFee
Public Function PUB_GetReportFee(ByVal pSys As String, ByVal pCountry As String, ByVal pPorpertyCode As String, pItemCount As Integer, _
                                 Optional ByRef lngOverItemFee As Long) As Long
   Dim stSQL As String, lngFee As Long
   Dim intQ As Integer, rsQuery As ADODB.Recordset
   
   lngOverItemFee = 0
   stSQL = "SELECT cf08 FROM CASEFEE WHERE CF01 = '" & pSys & "' AND CF02 = '" & pCountry & "' AND CF03 = '" & pPorpertyCode & "' and cf08>0"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      lngFee = Val("" & rsQuery(0))
      If Val(pItemCount) > 10 Then
         lngFee = lngFee + 600 * (Val(pItemCount) - 10)
         lngOverItemFee = 600 * (Val(pItemCount) - 10)
      End If
   End If
   PUB_GetReportFee = lngFee
   Set rsQuery = Nothing
End Function
'Added by Morgan 2013/1/10
'取得再審發文日(或再審延期發文日)
Public Function PUB_GetReExamDate(cp() As String) As String
   Dim stSQL As String
   Dim intQ As Integer
   Dim rsQuery As ADODB.Recordset
   
   'FCP有可能延期多次
   stSQL = "select min(cp27) cp27 from (select a.cp27 from caseprogress a" & _
      " where a.cp01='" & cp(1) & "' and a.cp02='" & cp(2) & "' and a.cp03='" & cp(3) & "' and a.cp04='" & cp(4) & "'" & _
      " and a.cp10='107' and a.cp27>0 and a.cp57 is null" & _
      " union select b.cp27 from caseprogress a,caseprogress b" & _
      " where a.cp01='" & cp(1) & "' and a.cp02='" & cp(2) & "' and a.cp03='" & cp(3) & "' and a.cp04='" & cp(4) & "'" & _
      " and a.cp10='107' and a.cp27>0 and a.cp57 is null and b.cp43(+)=a.cp09 and b.cp10='404' and b.cp27>0 and b.cp57 is null" & _
      " union select b.cp27 from caseprogress a,caseprogress b" & _
      " where a.cp01='" & cp(1) & "' and a.cp02='" & cp(2) & "' and a.cp03='" & cp(3) & "' and a.cp04='" & cp(4) & "'" & _
      " and a.cp10='107' and a.cp27>0 and a.cp57 is null and b.cp43(+)=a.cp43 and b.cp10='404' and b.cp27>0 and b.cp57 is null) X"
      
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      PUB_GetReExamDate = "" & rsQuery("cp27")
   End If
            
   Set rsQuery = Nothing
End Function

'Added by Morgan 2013/1/14
'檢查移轉或讓與的受讓人(5個)與基本檔是否相同
Public Function PUB_ChkAsignCaseCustNo(pCP09 As String) As Boolean
   Dim stSQL As String
   Dim intQ As Integer
   Dim rsQuery As ADODB.Recordset
   
   'Modified by Lydia 2018/06/05 修改顯示案件性質 '020',CPM04,CPM03 => '000',CPM03,CPM04
   stSQL = "select cp56||cp89||cp90||cp91||cp92 C1,decode(pa09||tm10,'000',cpm03,cpm04) C2" & _
      ",decode(tm01,null,pa26||pa27||pa28||pa29||pa30,tm23||tm78||tm79||tm80||tm81) C3" & _
      " from caseprogress,casepropertymap,patent,trademark" & _
      " where cp09='" & pCP09 & "' and cpm01(+)=cp01 and cpm02(+)=cp10" & _
      " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04" & _
      " and tm01(+)=cp01 and tm02(+)=cp02 and tm03(+)=cp03 and tm04(+)=cp04"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      With rsQuery
      If .Fields("C1") = .Fields("C3") Then
         PUB_ChkAsignCaseCustNo = True
      Else
         MsgBox "此案基本檔申請人與" & .Fields("C2") & "申請人不同, 請確認資料 !", vbExclamation
      End If
      End With
   End If
   Set rsQuery = Nothing
End Function

'Added by Morgan 2013/1/14
'計算項目數
Public Function PUB_GetItemCount(ByVal pText As String) As Integer
   Dim arrItem
   Dim ii As Integer, iCount, iPos As Integer
   pText = Replace(pText, "第", "")
   pText = Replace(pText, "項", "")
   arrItem = Split(pText, ",")
   iCount = 0
   For ii = LBound(arrItem) To UBound(arrItem)
      iPos = InStr(arrItem(ii), "-")
      If iPos > 0 Then
         iCount = iCount + 1 + Val(Mid(arrItem(ii), iPos + 1)) - Val(Left(arrItem(ii), iPos - 1))
         
      Else
         iCount = iCount + 1
      End If
   Next
   PUB_GetItemCount = iCount
End Function
'Added by Morgan 2013/1/15
'檢查撤銷部分請求項格式
Public Function PUB_ChkItemList(ByVal pText As String) As Boolean
   Dim arrItem
   Dim ii As Integer, iPos As Integer
   pText = Replace(pText, "第", "")
   pText = Replace(pText, "項", "")
   arrItem = Split(pText, ",")
   For ii = LBound(arrItem) To UBound(arrItem)
      iPos = InStr(arrItem(ii), "-")
      If iPos > 0 Then
         If Not IsNumeric(Left(arrItem(ii), iPos - 1)) Then
            Exit For
         End If
         If Not IsNumeric(Mid(arrItem(ii), iPos + 1)) Then
            Exit For
         End If
         If Val(Mid(arrItem(ii), iPos + 1)) < Val(Left(arrItem(ii), iPos - 1)) Then
            Exit For
         End If
      ElseIf Not IsNumeric(arrItem(ii)) Then
         Exit For
      End If
   Next
   If ii > UBound(arrItem) Then
      PUB_ChkItemList = True
   End If
End Function

'Added by Morgan 2013/3/19
'檢查使否符合微個體資格
'pNo:申請人或發明人編號
'pNoType:1=申請人No,2=發明人ID,3=發明人No
'pMode:1=收文,2=發文
Public Function PUB_CheckMicroEntity(ByVal pNo As String, ByVal pType As Integer, ByVal pMode As Integer, Optional pCaseNo As String) As Boolean
   Dim stSQL As String, intQ As Integer, stName As String
   Dim rsQuery As ADODB.Recordset
   Dim pInvId As String, pInvNo As String
   
   '申請人
   If pType = 1 Then
      If Len(pNo) >= 6 Then pNo = Left(pNo & "000", 9)
      '申請人不可減免或為學校者不符合
      stSQL = "SELECT AD03,CU15,CU04 FROM CUSTOMER,applicantdiscount WHERE CU01='" & Left(pNo, 8) & "' AND CU02='" & Mid(pNo, 9, 1) & "' AND AD01(+)=CU01 AND AD02(+)='101'"
      intQ = 1
      Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
      If intQ = 1 Then
         stName = "" & rsQuery("cu04")
         If rsQuery("ad03") = "N" Then
            PUB_CheckMicroEntity = False
            MsgBox "申請人【" & pNo & " " & stName & "】已設定為不可減免，本案不可以微個體申請！", vbCritical
            Exit Function
         ElseIf rsQuery("cu15") = "2" Then
            MsgBox "申請人【" & pNo & " " & stName & "】為學校，本案不可以微個體申請！", vbCritical
            PUB_CheckMicroEntity = False
            Exit Function
         End If
      End If
      '原意是要統計申請人新案申請件數,但因基本檔並未紀錄初始申請人,故與慧汶同意以目前申請人來統計(本所申請案件若有讓渡雖可由進度檔取得原申請人,但由於資料讀取速度問題先不考慮；中間來所案件一率要算；另外還有非本所案件的誤差。)
      stSQL = "SELECT count(*) FROM patent WHERE pa01='CFP' and pa09='101' and instr(pa26||pa27||pa28||pa29||pa30,'" & pNo & "')>0 and pa23='1' and pa46 is null" & _
            " and not exists(select * from caseprogress where cp01=pa01 and cp02=pa02 and cp03=pa03 and cp04=pa04 and cp10='118')"
      '收文件數
      If pMode = 1 Then
         stSQL = stSQL & " and not exists(select * from caseprogress where cp01=pa01 and cp02=pa02 and cp03=pa03 and cp04=pa04 and cp10 in ('101','103') and cp57>0)"
      '發文件數
      Else
         stSQL = stSQL & " and (pa10>0 or exists(select * from caseprogress where cp01=pa01 and cp02=pa02 and cp03=pa03 and cp04=pa04 and cp10 in ('101','103') and cp57 is null and cp27>0))"
      End If
      
      If pCaseNo <> "" Then
         stSQL = stSQL & " and pa01||pa02||pa03||pa04<>'" & pCaseNo & "'"
      End If
      intQ = 1
      Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
      If intQ = 1 Then
         'modify by sonia 2014/7/9 X35284已收CFP-008479,009146,016187,016187-1,不可再收微個體
         'If rsQuery(0) > 4 Then
         '   MsgBox "申請人【" & pNo & " " & stName & "】的美國申請案件數已超過 4 件，本案不可以微個體申請！", vbCritical
         If rsQuery(0) >= 4 Then
            MsgBox "申請人【" & pNo & " " & stName & "】的美國申請案件數已達 4 件，本案不可以微個體申請！", vbCritical
         'end 2014/7/9
            PUB_CheckMicroEntity = False
            Exit Function
         End If
      End If
      
   '發明人
   Else
      'ID
      If pType = 2 Then
         pInvId = pNo
      'No
      Else
         pInvNo = pNo
         stSQL = "select in03 from inventor where in01='" & Left(pNo, 8) & "' and in02='" & Mid(pNo, 9) & "'"
         intQ = 1
         Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
         If intQ = 1 Then
            If Not IsNull(rsQuery(0)) Then
               pInvId = rsQuery(0)
            End If
         End If
      End If
      
      'Modify By Sindy 2014/11/13
      If strSrvDate(1) >= 專利發明人檔啟用日 Then
         stSQL = "select count(distinct pa01||pa02||pa03||pa04) c1,max(in04) c2 from inventor,patent,patentinventor"
         If pInvId <> "" Then
            stSQL = stSQL & " where in03='" & pInvId & "'"
         Else
            stSQL = stSQL & " where in01='" & Left(pInvNo, 8) & "' and in02='" & Left(pInvNo, 9) & "'"
         End If
         stSQL = stSQL & " and in01=substr(pi06,1,8) and in02=substr(pi06,9,2) and pi01=pa01(+) and pi02=pa02(+) and pi03=pa03(+) and pi04=pa04(+)" & _
                 " and pa01='CFP' and pa09='101' and pa23='1' and pa46 is null" & _
                 " and not exists(select * from caseprogress where cp01=pa01 and cp02=pa02 and cp03=pa03 and cp04=pa04 and cp10='118')"
      Else
      '2014/11/13 END
         'Memo by Lydia 2021/08/17 刪除舊程式碼：專利發明人在專利基本檔60~69
      End If
      
      '收文件數
      If pMode = 1 Then
         stSQL = stSQL & " and not exists(select * from caseprogress where cp01=pa01 and cp02=pa02 and cp03=pa03 and cp04=pa04 and cp10 in ('101','103') and cp57>0)"
      '發文件數
      Else
         stSQL = stSQL & " and (pa10>0 or exists(select * from caseprogress where cp01=pa01 and cp02=pa02 and cp03=pa03 and cp04=pa04 and cp10 in ('101','103') and cp57 is null and cp27>0))"
      End If
      
      If pCaseNo <> "" Then
         stSQL = stSQL & " and pa01||pa02||pa03||pa04<>'" & pCaseNo & "'"
      End If
      intQ = 1
      Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
      If intQ = 1 Then
         stName = "" & rsQuery("c2")
         'modify by sonia 2014/7/9
         'If rsQuery(0) > 4 Then
         '   MsgBox "發明人【" & pNo & " " & stName & "】的美國申請案件數已超過 4 件，本案不可以微個體申請！", vbCritical
         If rsQuery(0) >= 4 Then
            MsgBox "發明人【" & pNo & " " & stName & "】的美國申請案件數已達 4 件，本案不可以微個體申請！", vbCritical
            'end 2014/7/9
            PUB_CheckMicroEntity = False
            Exit Function
         End If
      End If
   End If
   
   PUB_CheckMicroEntity = True
End Function

'Added by Morgan 2013/4/17
'讀取表單最後查詢的日期條件
Public Function PUB_GetLastDate(pFormName As String, pFieldName As String) As String
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   
   stSQL = "select fd03 from FormDate where FD01='" & pFormName & "' and fd02='" & pFieldName & "'"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      PUB_GetLastDate = "" & rsQuery(0)
   End If
   Set rsQuery = Nothing
End Function

'Added by Morgan 2013/4/17
'紀錄表單最後查詢的日期條件
Public Sub PUB_SaveLastDate(pFormName As String, pFieldName As String, pDate As String)
   Dim stSQL As String, intQ As Integer
   
   'Modify by Amy 2014/07/15 FD03改型態 原Number
   'stSQL = "update FormDate set FD03=" & Val(pDate) & ",FD04='" & strUserNum & "',FD05=to_char(sysdate,'YYYYMMDD'),FD06=to_char(sysdate,'HH24MiSS') where FD01='" & pFormName & "' and fd02='" & pFieldName & "'"
    stSQL = "update FormDate set FD03='" & pDate & "',FD04='" & strUserNum & "',FD05=to_char(sysdate,'YYYYMMDD'),FD06=to_char(sysdate,'HH24MiSS') where FD01='" & pFormName & "' and fd02='" & pFieldName & "'"
   cnnConnection.Execute stSQL, intQ
   If intQ = 0 Then
      stSQL = "insert into FormDate(FD01,FD02,FD03,FD04,FD05,FD06) values('" & pFormName & "','" & pFieldName & "','" & pDate & "','" & strUserNum & "',to_char(sysdate,'YYYYMMDD'),to_char(sysdate,'HH24MiSS'))"
      cnnConnection.Execute stSQL, intQ
   End If
End Sub

'Add By Sindy 2013/7/5 儲存卷宗區
'Modify By Sindy 2014/11/11 +, Optional strDataSrc As String = ""
'Modify By Sindy 2015/1/7 +, Optional strCPP10 As String = ""
'Modified by Morgan 2015/3/24 +, Optional pRaiseErr As Boolean = False
'Modify By Sindy 2015/5/18 +, Optional strCPP11 As String = ""
'Modify By Sindy 2016/1/22 + Optional ByRef stFtpPath As String
'Modify By Sindy 2017/4/6 + Optional strCPP04 As String = "", Optional ByRef stErrMsg As String = "", _
                                optional bolShowMsg as Boolean=True
'Modified by Morgan 2017/8/11 +, Optional strCPP15 As String = ""
Public Function SaveAttFile_PDF(strCP09 As String, strFullFileName As String, strReName As String, UpdModifyDate As Double, _
                                UpdModifyTime As Double, bolCPP10isY As Boolean, Optional strDataSrc As String = "", _
                                Optional strCPP10 As String = "", Optional pRaiseErr As Boolean = False, _
                                Optional strCPP11 As String = "", Optional ByRef stFtpPath As String, _
                                Optional strCPP04 As String = "", Optional ByRef stErrMsg As String = "", _
                                Optional bolShowMsg As Boolean = True, Optional strCPP15 As String = "") As Boolean
Dim stFilePath As String
Dim iFileNo As Integer
Dim bytes() As Byte
Dim lngSize As Long '檔案大小
Dim adoRst As New ADODB.Recordset
Const BlockSize = 500000
Dim Numblocks As Integer
Dim LeftOver As Long
Dim jj As Integer
Dim stSQL As String 'Added by Morgan 2014/11/18 替代原來的全域變數 strexc(0)
'Dim stErrMsg As String 'Added by Morgan 2015/3/24
'Dim stFtpPath As String 'Added by Morgan 2015/4/16
Dim iRecords As Integer 'Added by Morgan 2015/6/5
   
On Error GoTo ErrHand
   
   'Added by Morgan 2015/6/5
   cnnConnection.Execute "update CasePaperPDF set cpp13=cpp13 where cpp01='" & strCP09 & "' and upper(cpp02)=upper('" & ChgSQL(strReName) & "')", iRecords
   If iRecords > 0 Then
      Err.Raise 999, , " 檔案重複!!"
   End If
   'end 2015/6/5
   
   SaveAttFile_PDF = True
   If iFileNo > 0 Then Close #iFileNo
   iFileNo = FreeFile
   Open strFullFileName For Binary Access Read As #iFileNo
   lngSize = LOF(iFileNo)
   
   With adoRst
      If adoRst.State = adStateClosed Then
         stSQL = "select * from CasePaperPDF where rownum<1"
         .CursorLocation = adUseClient
         .Open stSQL, cnnConnection, adOpenStatic, adLockOptimistic
      End If
      .AddNew
      .Fields("cpp01").Value = strCP09
      .Fields("cpp02").Value = strReName
      .Fields("cpp03").Value = lngSize
      
'Removed by Morgan 2015/5/22 不再存DB
'      Numblocks = lngSize \ BlockSize
'      LeftOver = lngSize Mod BlockSize
'
'      ReDim bytes(LeftOver)
'      Get #iFileNo, , bytes()
'      .Fields("cpp04").AppendChunk bytes()
'
'      ReDim bytes(BlockSize)
'      For jj = 1 To Numblocks
'          Get #iFileNo, , bytes()
'          .Fields("cpp04").AppendChunk bytes()
'      Next jj
'end 2015/5/22
      
      'Add By Sindy 2017/4/6
      If strCPP04 <> "" Then '郵件主旨...
         .Fields("cpp04").Value = strCPP04
      End If
      '2017/4/6 END
      
      .Fields("cpp08").Value = UpdModifyDate
      .Fields("cpp09").Value = UpdModifyTime
      'Add By Sindy 2015/1/7
      'Modify By Sindy 2015/5/27 非PDF檔時，CPP10=Y
      If UCase(Right(strReName, Len(strReName) - InStrRev(strReName, ".") + 1)) <> UCase(".PDF") Then
         .Fields("cpp10").Value = "Y"
      Else
      '2015/5/27 END
         If strCPP10 <> "" Then
            .Fields("cpp10").Value = strCPP10
         Else
         '2015/1/7 END
            If bolCPP10isY = True Then
               .Fields("cpp10").Value = "Y"
            Else
               .Fields("cpp10").Value = "X" '預設值
            End If
         End If
      End If
      
      'Add By Sindy 2015/5/18 結案單下一程序序號
      If strCPP11 <> "" Then
         .Fields("cpp11").Value = strCPP11
      End If
      '2015/5/18 END
      'Add By Sindy 2014/11/11 資料來源
      If strDataSrc <> "" Then
         .Fields("cpp12").Value = strDataSrc
      End If
      '2014/11/11 END
      
      Close #iFileNo
      
      'Added by Morgan 2015/4/16 檔案改放FTP
      PUB_PutFtpFile strFullFileName, strCP09, strReName, stFtpPath
      If stFtpPath <> "" Then
         .Fields("cpp13") = strSrvDate(1)
         .Fields("cpp14") = stFtpPath
      End If
      'end 2015/4/16
      .Fields("cpp15") = strCPP15 'Added by Morgan 2017/8/11
      .UPDATE
   End With
   Exit Function
   
ErrHand:
   SaveAttFile_PDF = False
   If iFileNo > 0 Then Close #iFileNo 'Add By Sindy 2016/3/23
   
   'Modified by Morgan 2015/3/24
   'MsgBox " 新增檔案（" & strFullFileName & "）至卷宗區（" & strReName & "）失敗！" & vbCrLf & Err.Description
   stErrMsg = " 新增檔案（ " & strFullFileName & " ）至卷宗區 " & strCP09 & "（ " & strReName & " ）失敗！" & vbCrLf & Trim(Err.Number) & vbCrLf & Trim(Err.Description)
   'Modify By Sindy 2017/4/6 + if
   If bolShowMsg = True Then
   '2017/4/6 END
      'Add By Sindy 2024/11/1
'      'Modify By Sindy 2024/11/18
'      If CheckIsPersonRest("97038", strSrvDate(1), Left(Right("000000" & ServerTime, 6), 2) & ":" & Mid(Right("000000" & ServerTime, 6), 3, 2)) = False Then
'         PUB_SendMail strUserNum, "97038", "", "[113/11/1 開始 偵查用 (SaveAttFile_PDF)] " & strCP09 & " " & strReName, _
'            stErrMsg & vbCrLf & vbCrLf & "操作人員=" & strUserNum & strUserName, , , , , , , , , , True, False
'      End If
'      '2024/11/1 END
      
      If pRaiseErr = False Then
         MsgBox stErrMsg, vbCritical
      Else
         Err.Raise 999, , stErrMsg
      End If
   End If
   'end 2015/3/24
End Function

'Add By Sindy 2013/7/5 儲存原始檔區
'Modify By Sindy 2014/11/11 +, Optional strDataSrc As String = ""
'Modified by Lydia 2020/02/12 指定檔名strCPF02
'Modified by Lydia 2020/03/24 +Optional ByRef strErrMsg As String = "" '回傳錯誤訊息
'Modified by Morgan 2022/8/16 +Optional bolShowMsg As Boolean = True
Public Function SaveAttFile_Org(strCP09 As String, strFullFileName As String, strReName As String, UpdModifyDate As Double, UpdModifyTime As Double, _
                                Optional strDataSrc As String = "", Optional strCPF02 As String, Optional ByRef strErrMsg As String = "", Optional bolShowMsg As Boolean = True) As Boolean
Dim stFilePath As String
Dim iFileNo As Integer
Dim bytes() As Byte
Dim lngSize As Long '檔案大小
Dim adoRst As New ADODB.Recordset
Const BlockSize = 500000
Dim Numblocks As Integer
Dim LeftOver As Long
Dim jj As Integer
Dim stFtpPath As String 'Added by Morgan 2015/4/28
Dim iRecords As Integer 'Added by Morgan 2015/6/5

On Error GoTo ErrHand

   'Added by Morgan 2015/6/5
   cnnConnection.Execute "update CasePaperFile set cpf12=cpf12 where cpf01='" & strCP09 & "' and upper(cpf02)=upper('" & ChgSQL(strReName) & "')", iRecords
   If iRecords > 0 Then
      Err.Raise 999, , " 檔案重複!!"
   End If
   'end 2015/6/5
   
   strErrMsg = "" 'Added by Lydia 2020/03/24
   SaveAttFile_Org = True
   If iFileNo > 0 Then Close #iFileNo
   iFileNo = FreeFile
   Open strFullFileName For Binary Access Read As #iFileNo
   lngSize = LOF(iFileNo)

   With adoRst
      If adoRst.State = adStateClosed Then
         strExc(0) = "select * from CasePaperFile where rownum<1"
         .CursorLocation = adUseClient
         .Open strExc(0), cnnConnection, adOpenStatic, adLockOptimistic
      End If
      .AddNew
      .Fields("cpf01").Value = strCP09
      'Added by Lydia 2020/02/12 專利案件和English_Vers檔案：上傳到原始檔區，儘量顯示與原檔名相同
      If strCPF02 <> "" Then
           .Fields("cpf02").Value = strCPF02
      Else
      'end 2020/02/12
           .Fields("cpf02").Value = strReName
      End If 'Added by Lydia 2020/02/12
      .Fields("cpf03").Value = lngSize
      
'Removed by Morgan 2015/5/22 不再存DB
'      Numblocks = lngSize / BlockSize
'      LeftOver = lngSize Mod BlockSize
'
'      ReDim bytes(LeftOver)
'      Get #iFileNo, , bytes()
'      .Fields("cpf04").AppendChunk bytes()
'
'      ReDim bytes(BlockSize)
'      For jj = 1 To Numblocks
'          Get #iFileNo, , bytes()
'          .Fields("cpf04").AppendChunk bytes()
'      Next jj
'end 2015/5/22
      
      .Fields("cpf08").Value = UpdModifyDate
      .Fields("cpf09").Value = UpdModifyTime
      .Fields("cpf10").Value = "X" '預設值
      'Add By Sindy 2014/11/11 資料來源
      If strDataSrc <> "" Then
         .Fields("cpf11").Value = strDataSrc
      End If
      '2014/11/11 END
      
      Close #iFileNo
      
      'Added by Morgan 2015/4/28 檔案改放FTP
      PUB_PutFtpFile strFullFileName, strCP09, strReName, stFtpPath, "CASEPAPERFILE"
      If stFtpPath <> "" Then
         .Fields("cpf12") = strSrvDate(1)
         .Fields("cpf13") = stFtpPath
      End If
      'end 2015/4/28
      
      .UPDATE
   End With
   Exit Function
   
ErrHand:
   SaveAttFile_Org = False
   'Added by Lydia 2020/03/23 批次搬檔不彈錯誤訊息
   'Modified by Morgan 2022/8/16+bolShowMsg
   If strDataSrc = "B" Or bolShowMsg = False Then
        strErrMsg = " 新增檔案（" & strFullFileName & "）至原始檔案區（" & strReName & "）失敗！" & vbCrLf & Err.Description
   Else
   'end 2020/03/23
        MsgBox " 新增檔案（" & strFullFileName & "）至原始檔案區（" & strReName & "）失敗！" & vbCrLf & Err.Description
   End If 'Added by Lydia 2020/03/23
End Function

'Add By Sindy 2025/10/20 儲存承辦電子簽核附件檔
'Optional ByRef strErrMsg As String = "": 回傳錯誤訊息
Public Function SaveAttFile_EEF(strCP09 As String, strEEF02 As String, strFullFileName As String, strReName As String, UpdModifyDate As Double, UpdModifyTime As Double, _
                                Optional ByRef strErrMsg As String = "", Optional bolShowMsg As Boolean = True) As Boolean
Dim stFilePath As String
Dim iFileNo As Integer
Dim bytes() As Byte
Dim lngSize As Long '檔案大小
Dim adoRst As New ADODB.Recordset
Const BlockSize = 500000
Dim Numblocks As Integer
Dim LeftOver As Long
Dim jj As Integer
Dim stFtpPath As String
Dim iRecords As Integer

On Error GoTo ErrHand

   cnnConnection.Execute "update EmpElectronFile set eef11=eef11" & _
                         " where eef01='" & strCP09 & "' and eef02=" & strEEF02 & _
                         " and upper(eef03)=upper('" & ChgSQL(strReName) & "')", iRecords
   If iRecords > 0 Then
      Err.Raise 999, , " 檔案重複!!"
   End If
   
   strErrMsg = ""
   SaveAttFile_EEF = True
   If iFileNo > 0 Then Close #iFileNo
   iFileNo = FreeFile
   Open strFullFileName For Binary Access Read As #iFileNo
   lngSize = LOF(iFileNo)

   With adoRst
      If adoRst.State = adStateClosed Then
         strExc(0) = "select * from EmpElectronFile where rownum<1"
         .CursorLocation = adUseClient
         .Open strExc(0), cnnConnection, adOpenStatic, adLockOptimistic
      End If
      .AddNew
      .Fields("eef01").Value = strCP09
      .Fields("eef02").Value = strEEF02
      .Fields("eef03").Value = strReName
      .Fields("eef04").Value = lngSize
      .Fields("eef09").Value = UpdModifyDate
      .Fields("eef10").Value = UpdModifyTime
      
      Close #iFileNo
      
      '檔案改放FTP
      PUB_PutFtpFile strFullFileName, strCP09, strReName, stFtpPath, "EmpElectronFile", strEEF02
      If stFtpPath <> "" Then
         .Fields("eef11") = strSrvDate(1)
         .Fields("eef12") = stFtpPath
      End If
      
      .UPDATE
   End With
   Exit Function
   
ErrHand:
   SaveAttFile_EEF = False
   If bolShowMsg = False Then
      strErrMsg = " 新增檔案（" & strFullFileName & "）至承辦電子簽核附件檔（" & strReName & "）失敗！" & vbCrLf & Err.Description
   Else
      MsgBox " 新增檔案（" & strFullFileName & "）至承辦電子簽核附件檔（" & strReName & "）失敗！" & vbCrLf & Err.Description
   End If
End Function

'Add By Sindy 2013/7/5 刪除卷宗區電子檔
'strCaseNo : 必須為完整的本所案號
'strCPP01  : 總收文號
'strCPP02  : 電子檔名
'Modify By Sindy 2014/11/11 +, Optional strDataSrc As String = "" 資料來源
'Modify By Sindy 2018/7/16 +, Optional bolConn As Boolean = False
'Modified by Lydia 2019/12/05 + bolDelete 直接刪除檔案
Public Function DelAttFile_PDF(strCaseNo As String, strCPP01 As String, strCPP02 As String, _
Optional strDataSrc As String = "", Optional bolConn As Boolean = False, Optional bolDelete As Boolean = False) As Boolean
   Dim intQ As Integer
   Dim rsQuery As ADODB.Recordset
   Dim strCP01 As String, strCP02 As String, strCP03 As String, strCP04 As String
   
On Error GoTo ErrHand
   
   DelAttFile_PDF = True
   
   strCP01 = SystemNumber(strCaseNo, 1)
   strCP02 = SystemNumber(strCaseNo, 2)
   strCP03 = SystemNumber(strCaseNo, 3)
   strCP04 = SystemNumber(strCaseNo, 4)
   strCaseNo = Replace(strCaseNo, "-", "")
   
   '先檢查是否有檔案存在,若無檔案則離開函數
   'Modify By Sindy 2014/11/11 刪除檔案時逐筆刪除或依資料來源刪除
'   If Trim(strCPP02) = "" Then
'      strSql = "select cpp01 from casepaperpdf where cpp01='" & strCPP01 & "'"
'   Else
'      strSql = "select cpp01 from casepaperpdf where cpp01='" & strCPP01 & "' and upper(cpp02)='" & ChgSQL(UCase(strCPP02)) & "'"
'   End If
   If Trim(strCPP02) <> "" Then
      'Modify By Sindy 2016/6/13 不要轉換大小寫做刪除
      'strSql = "select cpp01 from casepaperpdf where cpp01='" & strCPP01 & "' and upper(cpp02)='" & ChgSQL(UCase(strCPP02)) & "'"
      strSql = "select cpp01 from casepaperpdf where cpp01='" & strCPP01 & "' and cpp02='" & ChgSQL(strCPP02) & "'"
   Else
      'strSql = "select cpp01 from casepaperpdf where cpp01='" & strCPP01 & "'"
      If Trim(strDataSrc) <> "" Then
         strSql = "select cpp01 from casepaperpdf where cpp01='" & strCPP01 & "' and cpp12='" & strDataSrc & "'"
      Else
         Exit Function
      End If
   End If
   '2014/11/11 END
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, strSql)
   If intQ <> 1 Then
      Exit Function
   End If
   
   'Modify By Sindy 2018/7/16
   'cnnConnection.BeginTrans
   If bolConn = False Then cnnConnection.BeginTrans
   '2018/7/16 END
   
   'Modify By Sindy 2015/1/27 Mark:1.因已無產生合併檔 2.清除已上合併註記再重新合併這樣檔案越來越多,AutoBatchDay在測試合併也會是個問題
'   '檢查此文號是否已合併
'   If Trim(strCPP02) = "" Then
'      strSql = "select CPP01 from casepaperpdf where cpp01='" & strCPP01 & "' and CPP10='Y'"
'   '檢查此電子檔是否已合併
'   Else
'      strSql = "select CPP01 from casepaperpdf where cpp01='" & strCPP01 & "' and upper(cpp02)='" & ChgSQL(UCase(strCPP02)) & "' and CPP10='Y'"
'   End If
'   intQ = 1
'   Set rsQuery = ClsLawReadRstMsg(intQ, strSql)
'   If intQ = 1 Then
'      If rsQuery.RecordCount > 0 Then
'         '已合併時,必須刪除整份卷宗
'         strSql = "delete from casepaperpdf where cpp01='000000000' and upper(cpp02)='" & UCase(strCaseNo & ".pdf") & "'"
'         'Pub_SeekTbLog strSql
'         cnnConnection.Execute strSql
'         '並且要將此本所案號的全部附件已合併欄位值改成X,晚上批次作業必須再全部合併一次
'         strSql = "update casepaperpdf set cpp10='X' where cpp01 in(" & _
'                  "select cp09 from caseprogress where cp01='" & strCP01 & "' and cp02='" & strCP02 & "' and cp03='" & strCP03 & "' and cp04='" & strCP04 & "')" & _
'                  " and cpp10||''='Y'"
'         'Pub_SeekTbLog strSql
'         cnnConnection.Execute strSql
'      End If
'   End If
   
   '刪除此筆電子檔
   If Trim(strCPP02) <> "" Then
      'Modify By Sindy 2013/10/31 電腦中心執行刪除檔案不備份
      'Added by Lydia 2015/11/16 查名單電子化-刪除時卷宗區檔案不備份,檔案直接回到查覆區
      'Modified by Lydia 2019/12/05 + 直接刪除檔案 (frm060302只保留最新的通知函)
      'If Pub_StrUserSt03 = "M51" Or InStr(UCase(strCPP02), "." & UCase(TMQ_查名作業 & ".pdf")) > 0 Then
      If Pub_StrUserSt03 = "M51" Or InStr(UCase(strCPP02), "." & UCase(TMQ_查名作業 & ".pdf")) > 0 Or bolDelete = True Then
         'Modify By Sindy 2016/6/13 不要轉換大小寫做刪除
         'PUB_DelFtpFile2 strCPP01, " and upper(cpp02)='" & ChgSQL(UCase(strCPP02)) & "'" 'Added by Morgan 2015/3/24 檔案改放 FTP,必須在DB資料刪除前執行
         PUB_DelFtpFile2 strCPP01, " and cpp02='" & ChgSQL(strCPP02) & "'" 'Added by Morgan 2015/3/24 檔案改放 FTP,必須在DB資料刪除前執行
         'strSql = "delete from casepaperpdf where cpp01='" & strCPP01 & "' and upper(cpp02)='" & ChgSQL(UCase(strCPP02)) & "'"
         strSql = "delete from casepaperpdf where cpp01='" & strCPP01 & "' and cpp02='" & ChgSQL(strCPP02) & "'"
      Else
      '2013/10/31 END
         'Modify By Sindy 2016/6/13 不要轉換大小寫做刪除
         'PUB_DelFtpFile2 strCPP01, " and upper(cpp02)='" & ChgSQL(UCase(strCPP02 & ".del")) & "'" 'Added by Morgan 2015/3/24 檔案改放 FTP,必須在DB資料刪除前執行
         PUB_DelFtpFile2 strCPP01, " and cpp02='" & ChgSQL(strCPP02 & ".del") & "'" 'Added by Morgan 2015/3/24 檔案改放 FTP,必須在DB資料刪除前執行
         '先將上一次備份的刪除檔做刪除
         'strSql = "delete from casepaperpdf where cpp01='" & strCPP01 & "' and upper(cpp02)='" & ChgSQL(UCase(strCPP02 & ".del")) & "'"
         strSql = "delete from casepaperpdf where cpp01='" & strCPP01 & "' and cpp02='" & ChgSQL(strCPP02 & ".del") & "'"
         'Pub_SeekTbLog strSql
         cnnConnection.Execute strSql
         
         'Modify By Sindy 2016/6/13 不要轉換大小寫做刪除
         '再將欲刪除的電子檔做Rename即可
         'strSql = "update casepaperpdf set cpp02=cpp02||'.del',cpp10='D' where cpp01='" & strCPP01 & "' and upper(cpp02)='" & ChgSQL(UCase(strCPP02)) & "'"
         strSql = "update casepaperpdf set cpp02=cpp02||'.del',cpp10='D' where cpp01='" & strCPP01 & "' and cpp02='" & ChgSQL(strCPP02) & "'"
      End If
      'Pub_SeekTbLog strSql
      'Modify By Sindy 2015/4/28
      'Pub_SaveLog strUserNum, "刪除卷宗區附件：" & strCPP02, strCP01, strCP02, strCP03, strCP04, strCPP01
      Pub_SaveLog strUserNum, "刪除卷宗區附件：" & strCPP02, strCP01, strCP02, strCP03, strCP04, IIf(Len(strCPP01) = 9, strCPP01, "")
      '2015/4/28 END
      cnnConnection.Execute strSql
      
      
   Else
      '刪除此文號整批電子檔 - 僅待送件區裡程序整批全部列印時,系統會整批刪除,再從承辦簽核電子檔最後一道判發流程裡重新產生一份電子檔
      If Trim(strDataSrc) <> "" Then
         
         PUB_DelFtpFile2 strCPP01, " and cpp12='" & strDataSrc & "'"  'Added by Morgan 2015/3/24 檔案改放 FTP,必須在DB資料刪除前執行
         
         'Modify By Sindy 2014/11/24
         'strSql = "delete from casepaperpdf where cpp01='" & strCPP01 & "'"
         strSql = "delete from casepaperpdf where cpp01='" & strCPP01 & "' and cpp12='" & strDataSrc & "'"
         '2014/11/24 END
         'Pub_SeekTbLog strSql
         cnnConnection.Execute strSql
      End If
   End If
   
   'Modify By Sindy 2018/7/16
   'cnnConnection.CommitTrans
   If bolConn = False Then cnnConnection.CommitTrans
   '2018/7/16 END
   Set rsQuery = Nothing
   Exit Function
   
ErrHand:
   'Modify By Sindy 2018/7/16
   'cnnConnection.RollbackTrans
   If bolConn = False Then cnnConnection.RollbackTrans
   '2018/7/16 END
   DelAttFile_PDF = False
   Set rsQuery = Nothing
   MsgBox " 刪除卷宗區（" & strCPP01 & IIf(strCPP02 <> "", " - " & strCPP02, "") & "）失敗！" & vbCrLf & Err.Description
End Function

'Add By Sindy 2013/7/16 刪除原始檔區
'strCaseNo : 必須為完整的本所案號
'strCPF01  : 總收文號
'strCPF02  : 電子檔名
'Modify By Sindy 2014/11/11 +, Optional strDataSrc As String = "" 資料來源
'Modify By Sindy 2018/7/16 +, Optional bolConn As Boolean = False
'Modified by Lydia 2020/03/23 +,Optional ByRef strMsg As String = "Y" '是否彈錯誤訊息
'Modified by Lydia 2022/08/16 + bolDelete 直接刪除檔案
Public Function DelAttFile_File(ByVal strCaseNo As String, ByVal strCPF01 As String, ByVal strCPF02 As String, _
Optional ByVal strDataSrc As String = "", Optional ByVal bolConn As Boolean = False, Optional ByRef strMsg As String = "Y", Optional ByVal bolDelete As Boolean = False) As Boolean
   Dim intQ As Integer
   Dim rsQuery As ADODB.Recordset
   Dim strCP01 As String, strCP02 As String, strCP03 As String, strCP04 As String
   Dim strST03 As String 'Added by Lydia 2020/03/30
   
On Error GoTo ErrHand
   
   DelAttFile_File = True
   
   strCP01 = SystemNumber(strCaseNo, 1)
   strCP02 = SystemNumber(strCaseNo, 2)
   strCP03 = SystemNumber(strCaseNo, 3)
   strCP04 = SystemNumber(strCaseNo, 4)
   strCaseNo = Replace(strCaseNo, "-", "")
   
   '先檢查是否有檔案存在,若無檔案則離開函數
   'Modify By Sindy 2014/11/11 刪除檔案時逐筆刪除或依資料來源刪除
'   If Trim(strCPF02) = "" Then
'      strSql = "select cpf01 from casepaperfile where cpf01='" & strCPF01 & "'"
'   Else
'      strSql = "select cpf01 from casepaperfile where cpf01='" & strCPF01 & "' and upper(cpf02)='" & UCase(strCPF02) & "'"
'   End If

   'Modified by Morgan 2020/3/24 檔名可能有單引號，語法內的 strCPF02 加 ChgSQL
   If Trim(strCPF02) <> "" Then
      'Modify By Sindy 2016/6/13 不要轉換大小寫做刪除
      'strSql = "select cpf01 from casepaperfile where cpf01='" & strCPF01 & "' and upper(cpf02)='" & UCase(strCPF02) & "'"
      strSql = "select cpf01 from casepaperfile where cpf01='" & strCPF01 & "' and cpf02='" & ChgSQL(strCPF02) & "'"
   Else
      'strSql = "select cpf01 from casepaperfile where cpf01='" & strCPF01 & "'"
      If Trim(strDataSrc) <> "" Then
         strSql = "select cpf01 from casepaperfile where cpf01='" & strCPF01 & "' and cpf11='" & strDataSrc & "'"
      Else
         Exit Function
      End If
   End If
   '2014/11/11 END
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, strSql)
   If intQ <> 1 Then
      Exit Function
   End If
   
   'Modify By Sindy 2018/7/16
   'cnnConnection.BeginTrans
   If bolConn = False Then cnnConnection.BeginTrans
   '2018/7/16 END
   
   strST03 = PUB_GetST03(strUserNum) 'Added by Lydia 2020/03/30 frmAutoBatchDay沒有設定 Pub_StrUserSt03,無法直接刪檔; ex.FCP062404.992因為改成.del,所以欄位長度超過100字
      
   '刪除此筆電子檔
   If Trim(strCPF02) <> "" Then
      'Modify By Sindy 2013/10/31 電腦中心執行刪除檔案不備份
      'Modified by Lydia 2020/03/30
      'If Pub_StrUserSt03 = "M51" Then
      'Modified by Lydia 2023/08/16  + 直接刪除檔案bolDelete = True  (frm060504只保留最新檔案)
      If strST03 = "M51" Or bolDelete = True Then
         'Modify By Sindy 2016/6/13 不要轉換大小寫做刪除
         'PUB_DelFtpFile2 strCPF01, " and upper(cpf02)='" & UCase(strCPF02) & "'", "CASEPAPERFILE" 'Added by Morgan 2015/4/28 檔案改放 FTP,必須在DB資料刪除前執行
         PUB_DelFtpFile2 strCPF01, " and cpf02='" & ChgSQL(strCPF02) & "'", "CASEPAPERFILE" 'Added by Morgan 2015/4/28 檔案改放 FTP,必須在DB資料刪除前執行
         'Memo by Morgan 2015/4/28 刪除條件要和前面刪除FTP檔的同步
         'strSql = "delete from casepaperfile where cpf01='" & strCPF01 & "' and upper(cpf02)='" & UCase(strCPF02) & "'"
         strSql = "delete from casepaperfile where cpf01='" & strCPF01 & "' and cpf02='" & ChgSQL(strCPF02) & "'"
      Else
      '2013/10/31 END
         'Modify By Sindy 2016/6/13 不要轉換大小寫做刪除
         'PUB_DelFtpFile2 strCPF01, " and upper(cpf02)='" & UCase(strCPF02 & ".del") & "'", "CASEPAPERFILE" 'Added by Morgan 2015/4/28 檔案改放 FTP,必須在DB資料刪除前執行
         PUB_DelFtpFile2 strCPF01, " and cpf02='" & ChgSQL(strCPF02) & ".del" & "'", "CASEPAPERFILE" 'Added by Morgan 2015/4/28 檔案改放 FTP,必須在DB資料刪除前執行
         '先將上一次備份的刪除檔做刪除
         'Memo by Morgan 2015/4/28 刪除條件要和前面刪除FTP檔的同步
         'strSql = "delete from casepaperfile where cpf01='" & strCPF01 & "' and upper(cpf02)='" & UCase(strCPF02 & ".del") & "'"
         strSql = "delete from casepaperfile where cpf01='" & strCPF01 & "' and cpf02='" & ChgSQL(strCPF02) & ".del" & "'"
         'Pub_SeekTbLog strSql
         cnnConnection.Execute strSql
         
         'Modify By Sindy 2016/6/13 不要轉換大小寫做刪除
         '再將欲刪除的電子檔做Rename即可
         'strSql = "update casepaperfile set cpf02=cpf02||'.del',cpf10='D' where cpf01='" & strCPF01 & "' and upper(cpf02)='" & UCase(strCPF02) & "'"
         strSql = "update casepaperfile set cpf02=cpf02||'.del',cpf10='D' where cpf01='" & strCPF01 & "' and cpf02='" & ChgSQL(strCPF02) & "'"
      End If
      'Pub_SeekTbLog strSql
      Pub_SaveLog strUserNum, "刪除原始檔區附件：" & strCPF02, strCP01, strCP02, strCP03, strCP04, strCPF01
      cnnConnection.Execute strSql
   Else
      '刪除此文號整批電子檔 - 僅待送件區裡程序整批全部列印時,系統會整批刪除,再從承辦簽核電子檔最後一道判發流程裡重新產生一份電子檔
      If Trim(strDataSrc) <> "" Then
         
         PUB_DelFtpFile2 strCPF01, " and cpf11='" & strDataSrc & "'", "CASEPAPERFILE" 'Added by Morgan 2015/4/28 檔案改放 FTP,必須在DB資料刪除前執行
         'Modify By Sindy 2014/11/24
         'strSql = "delete from casepaperfile where cpf01='" & strCPF01 & "'"
         'Memo by Morgan 2015/4/28 刪除條件要和前面刪除FTP檔的同步
         strSql = "delete from casepaperfile where cpf01='" & strCPF01 & "' and cpf11='" & strDataSrc & "'"
         '2014/11/24 END
         'Pub_SeekTbLog strSql
         cnnConnection.Execute strSql
      End If
   End If
   
   'Modify By Sindy 2018/7/16
   'cnnConnection.CommitTrans
   If bolConn = False Then cnnConnection.CommitTrans
   '2018/7/16 END
   Set rsQuery = Nothing
   Exit Function
   
ErrHand:
   'Modify By Sindy 2018/7/16
   'cnnConnection.RollbackTrans
   If bolConn = False Then cnnConnection.RollbackTrans
   '2018/7/16 END
   DelAttFile_File = False
   Set rsQuery = Nothing
   'Added by Lydia 2020/03/23 是否彈錯誤訊息
   If strMsg = "N" Then
       strMsg = " 刪除原始檔區（" & strCPF01 & IIf(strCPF02 <> "", " - " & strCPF02, "") & "）失敗！" & vbCrLf & Err.Description
   Else
   'end 2020/03/23
       MsgBox " 刪除原始檔區（" & strCPF01 & IIf(strCPF02 <> "", " - " & strCPF02, "") & "）失敗！" & vbCrLf & Err.Description
   End If 'Added by Lydia 2020/03/23
End Function

'Add By Sindy 2013/8/23 產生整份卷宗批次
Public Function PDFMergeFile_Batch(bolAutoBatch As Boolean) As Boolean
Dim strAttachPath As String
Dim intRow As Integer
Dim strCP01 As String, strCP02 As String, strCP03 As String, strCP04 As String ', strCPP01 As String
Dim saveCPP02 As String, strCPP02 As String
Dim rsTmp As New ADODB.Recordset
Dim Rs As New ADODB.Recordset
Dim strSql As String
Dim strMergeFile As String
Dim strCmd As String
Dim iTimes As Integer
Dim fs, f
Dim process_id As Long
Dim process_handle As Long
Dim strMergeFN As String 'Add By Sindy 2017/8/25
Dim bolConnect As Boolean 'Add By Sindy 2019/9/4
Dim strErrText As String 'Add By Sindy 2020/10/15
   
On Error GoTo ErrHand
   
   PDFMergeFile_Batch = False
   
   If bolAutoBatch = True Then
      strAttachPath = "C:" & Pub_GetSpecMan("EmpFlowAttPath")
   Else
      strAttachPath = App.path & Pub_GetSpecMan("EmpFlowAttPath")
   End If
   If Dir(strAttachPath, vbDirectory) = "" Then
      MkDir strAttachPath
   'Add By Sindy 2017/8/24
   Else
      '清空資料夾暫存區
      'Modified by Lydia 2020/03/19 改用模組
      'If Dir(strAttachPath & "\.") <> "" Then
      '   Kill strAttachPath & "\*.*"
      '   DoEvents
      'End If
      Call PUB_KillAnyFile(strAttachPath)
      DoEvents
      'end 2020/03/19
   End If
   '2017/8/24 END
   
   '切換至來源目錄
   If strAttachPath <> "." Then ChDir strAttachPath
   DoEvents
   
   'Add By Sindy 2023/2/7 卷宗區Flag註記為X且非PDF檔者,直接上cpp10=Y
   strSql = "update casepaperpdf set cpp10='Y'" & _
            " where cpp01||cpp02 in(select cpp01||cpp02 from caseprogress,casepaperpdf where cpp10='X'" & _
                                  " and cpp01=cp09(+) and upper(substr(cpp02,-4))<>upper('.PDF') and cp09 is not null" & _
            ")"
   cnnConnection.Execute strSql, intI
   '2023/2/7 END
   
'   'Add By Sindy 2015/12/22 國外部的ORI檔會有加密狀況,因此排除檢查合併狀況,直接上cpp10=Y
'   strSql = "update casepaperpdf set cpp10='Y' where cpp01||cpp02 in(select cpp01||cpp02 from caseprogress,casepaperpdf where cpp10='X' and cpp01=cp09(+) and upper(substr(cpp02,-4))=upper('.PDF')" & _
'            " and (substr(cp12,1,2)='F2' and instr(upper(cpp02),upper('.ORI.'))>0))"
   'Modify By Sindy 2016/2/15 國外部的電子檔會有加密狀況,因此排除檢查合併狀況,直接上cpp10=Y
   '                          不限制只有ORI檔
   'Modify By Sindy 2018/4/12 + FCP增加了客戶提供文件記錄資料進卷宗區
   'Modify By Sindy 2023/11/13 取消 select cpp01||cpp02 from caseprogress,casepaperpdf where cpp10='X' and cpp01=cp09(+) and upper(substr(cpp02,-4))=upper('.PDF')" & _
            " and substr(cp12,1,2)='F2' union
'   strSql = "update casepaperpdf set cpp10='Y' where cpp01||cpp02 in(select cpp01||cpp02 from caseprogress,casepaperpdf where cpp10='X' and cpp01=cp09(+) and upper(substr(cpp02,-4))=upper('.PDF')" & _
'            " and substr(cp12,1,2)='F2' union " & _
'            " select cpp01||cpp02 from custsupportdoc,casepaperpdf where cpp10='X'" & _
'            " and cpp01=CSD05 and upper(substr(cpp02,-4))=upper('.PDF'))"
   strSql = "update casepaperpdf set cpp10='Y'" & _
            " where cpp01||cpp02 in(" & _
            " select cpp01||cpp02 from custsupportdoc,casepaperpdf where cpp10='X'" & _
            " and cpp01=CSD05 and upper(substr(cpp02,-4))=upper('.PDF'))"
   '2023/11/13 END
   '2016/2/15 END
   cnnConnection.Execute strSql, intI
   '2015/12/22 END
   
   '查詢尚待合併的電子檔
   strSql = "select cp01,cp02,cp03,cp04,count(*) as cpCnt" & _
            " from caseprogress,casepaperpdf where cpp10='X' and cpp01=cp09(+) AND cp01 IS NOT NULL" & _
            " and upper(substr(cpp02,-4))=upper('.PDF') group by cp01,cp02,cp03,cp04"
   rsTmp.CursorLocation = adUseClient
   rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If rsTmp.RecordCount > 0 Then
      rsTmp.MoveFirst
      Do While Not rsTmp.EOF
         strCP01 = rsTmp.Fields("cp01")
         strCP02 = rsTmp.Fields("cp02")
         strCP03 = rsTmp.Fields("cp03")
         strCP04 = rsTmp.Fields("cp04")
         saveCPP02 = strCP01 & strCP02 & strCP03 & strCP04 & ".pdf"
         'Add By Sindy 2017/8/24
         If bolAutoBatch = False Then
         '2017/8/24 END
            '清空資料夾暫存區
             'Modified by Lydia 2020/03/19 改用模組
             'If Dir(strAttachPath & "\.") <> "" Then
             '   Kill strAttachPath & "\*.*"
             '   DoEvents
             'End If
             Call PUB_KillAnyFile(strAttachPath)
             DoEvents
             'end 2020/03/19
         End If
         '先讀待合併電子檔,以發文先後順序合併
         'sort : 1.承辦單 2.其他或說明書 3.圖 4.存卷資料
         'Modify By Sindy 2013/10/7 原Sort方式:decode(sign(instr(upper(cpp02),upper('." & EMP_承辦單 & "'))),1,1,decode(sign(instr(upper(cpp02),upper('DWG'))),1,3,decode(sign(instr(upper(cpp02),upper('info'))),1,4,2))) as sort
         'Modify By Sindy 2015/1/27 取消 and cpp01<>'000000000' 因已無產生合併檔
         'Modify By Sindy 2015/5/27 + and (upper(substr(cpp02,-4))=upper('.PDF') or upper(substr(cpp02,-8))=upper('.PDF.DEL'))
         'Modify By Sindy 2019/7/10 取消 or upper(substr(cpp02,-8))=upper('.PDF.DEL')
         strExc(0) = "select cpp01,cpp02,cpp03,cp27" & _
                     " from caseprogress,casepaperpdf" & _
                     " where cp01='" & strCP01 & "' and cp02='" & strCP02 & "' and cp03='" & strCP03 & "' and cp04='" & strCP04 & "'" & _
                     " and cp09=cpp01(+) and cpp10='X'" & _
                     " and upper(substr(cpp02,-4))=upper('.PDF')" & _
                     " order by cp27 desc,cpp01 desc,cpp02 asc"
         intI = 1
         Set Rs = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            intRow = 0
            cnnConnection.BeginTrans: bolConnect = True 'Add By Sindy 2019/9/4
            strMergeFN = "" 'Add By Sindy 2017/8/25
            
            If Rs.RecordCount > 0 Then
               Rs.MoveFirst
               Do While Not Rs.EOF
                  intRow = intRow + 1
                  strCPP02 = CStr(intRow) & "." & PUB_GetSimpleName(Rs.Fields("cpp02")) 'Add By Sindy 2023/2/13
                  'If GetAttachFile_Merge(Rs.Fields("cpp01"), Rs.Fields("cpp02"), CStr(intRow) & "." & Rs.Fields("cpp02"), strAttachPath, bolAutoBatch) = False Then
                  If GetAttachFile_Merge(Rs.Fields("cpp01"), Rs.Fields("cpp02"), strCPP02, strAttachPath, bolAutoBatch) = False Then
                     'GoTo ErrHand2
                     'Add By Sindy 2017/8/4 無法儲存檔案[ 1.P90582.1913.CUS.PDF ]！檔案讀取失敗！(999)
                     If bolAutoBatch = True Then
                        cnnConnection.RollbackTrans: bolConnect = False 'Add By Sindy 2019/9/4
                        GoTo ReadNext
                     Else
                        GoTo ErrHand
                     End If
                     '2017/8/4 END
                  'Add By Sindy 2017/8/25
                  Else
                     If Dir(strAttachPath & "\" & strCPP02) <> "" Then
                        strMergeFN = strMergeFN & IIf(strMergeFN <> "", " ", "") & ".\" & strCPP02
                     End If
                  '2017/8/25 END
                  End If
                  DoEvents
                  '逐筆上已合併註記
                  strSql = "update casepaperpdf set cpp10='Y' where cpp01='" & Rs.Fields("cpp01") & "' and cpp02='" & ChgSQL(Rs.Fields("cpp02")) & "'"
                  cnnConnection.Execute strSql, intI
                  Rs.MoveNext
               Loop
            End If
            Rs.Close
            
            '執行合併動作
            'strMergeFile = strAttachPath & "\" & saveCPP02
            strMergeFile = ".\" & saveCPP02
            'strCmd = "pdftk.exe " & strAttachPath & "\*.pdf" & " cat output " & strMergeFile
            strCmd = "pdftk.exe " & strMergeFN & " cat output " & strMergeFile
            DoEvents
            
            'Modify By Sindy 2013/8/30
            'SHELL strCmd
            process_id = SHELL(strCmd, vbHide)
            process_handle = OpenProcess(PROCESS_TERMINATE, 0, process_id)
'            process_handle = OpenProcess(SYNCHRONIZE, 0, process_id)
            If process_handle <> 0 Then
'               WaitForSingleObject process_handle, INFINITE
               For iTimes = 1 To 10
                  If PUB_CheckIsRunning("pdftk.exe") = True Then
                     Sleep 2000
                  Else
                     Exit For
                  End If
               Next
               If iTimes > 10 Then
                  'Exit Function
                  TerminateProcess process_handle, 0&
                  CloseHandle process_handle
               End If
            End If
            '2013/8/30 END
            
            '檢查是否有產生合併PDF檔
            DoEvents 'Add By Sindy 2013/8/30
            If Dir(strMergeFile) <> "" Then
               'Add By Sindy 2017/8/25
               If bolAutoBatch = True Then
                  '刪除合併檔
                  Kill strMergeFile
                  DoEvents
               End If
               '2017/8/25 END
               'On Error GoTo 0 'Add By Sindy 2020/12/1 取消目前程序堛瑪欞~處理; 感覺(70:沒有使用權限)有時有在ErrHand控制內,有時無
               'Add By Sindy 2020/12/7
               If bolConnect = True Then
               '2020/12/7 END
                  cnnConnection.CommitTrans
                  bolConnect = False
               End If
            Else
               'Modify By Sindy 2024/11/4 Mark;因為下面程式會再試單檔合併看看,所以不用再次處產出訊息,反而有可能重覆顯示了
'               If bolAutoBatch = False Then
'                  MsgBox strMergeFile & " 檔案合併失敗!!"
'               Else
'                  WLog strMergeFile & " 檔案合併失敗!!"
'               End If
               If bolAutoBatch = True Then
                  cnnConnection.RollbackTrans: bolConnect = False 'Add By Sindy 2019/9/4
               Else
                  GoTo ErrHand
               End If
            End If
         End If
ReadNext: 'Add By Sindy 2017/8/4 合併時檔案讀取失敗,讀取下一筆
         rsTmp.MoveNext
      Loop
   Else
      PDFMergeFile_Batch = True
      If bolAutoBatch = False Then
         ShowNoData
      Else
         WLog "無待合併PDF檔,完成!!"
      End If
      rsTmp.Close
      Set rsTmp = Nothing
      Exit Function
   End If
   
   'Add By Sindy 2022/6/16 上列整卷未合併成功的再單檔合併
   strExc(0) = "select cpp01,cpp02,cpp03,cp27,cp01,cp02,cp03,cp04" & _
               " from caseprogress,casepaperpdf" & _
               " where cp09(+)=cpp01 and cpp10='X'" & _
               " and upper(substr(cpp02,-4))=upper('.PDF')" & _
               " order by cp27 desc,cpp01 desc,cpp02 asc"
   intI = 1
   Set Rs = ClsLawReadRstMsg(intI, strExc(0))
   If intI = 1 Then
      If Rs.RecordCount > 0 Then
         Rs.MoveFirst
         Do While Not Rs.EOF
            cnnConnection.BeginTrans: bolConnect = True
            strMergeFN = ""
            intRow = 99
            strCPP02 = CStr(intRow) & "." & PUB_GetSimpleName(Rs.Fields("cpp02")) 'Add By Sindy 2023/2/13
            'If GetAttachFile_Merge(Rs.Fields("cpp01"), Rs.Fields("cpp02"), CStr(intRow) & "." & Rs.Fields("cpp02"), strAttachPath, bolAutoBatch) = False Then
            If GetAttachFile_Merge(Rs.Fields("cpp01"), Rs.Fields("cpp02"), strCPP02, strAttachPath, bolAutoBatch) = False Then
               'GoTo ErrHand2
               'Add By Sindy 2017/8/4 無法儲存檔案[ 1.P90582.1913.CUS.PDF ]！檔案讀取失敗！(999)
               If bolAutoBatch = True Then
                  cnnConnection.RollbackTrans: bolConnect = False 'Add By Sindy 2019/9/4
                  GoTo ReadNext2
               Else
                  GoTo ErrHand
               End If
               '2017/8/4 END
            'Add By Sindy 2017/8/25
            Else
               If Dir(strAttachPath & "\" & strCPP02) <> "" Then
                  strMergeFN = ".\" & strCPP02
               End If
            '2017/8/25 END
            End If
            DoEvents
            '逐筆上已合併註記
            strSql = "update casepaperpdf set cpp10='Y' where cpp01='" & Rs.Fields("cpp01") & "' and cpp02='" & ChgSQL(Rs.Fields("cpp02")) & "'"
            cnnConnection.Execute strSql, intI
            
            '執行合併動作
            'Modify By Sindy 2024/8/29
            'strMergeFile = ".\tmp_" & saveCPP02
            strMergeFile = ".\tmp_" & strCPP02
            '2024/8/29 END
            strCmd = "pdftk.exe " & strMergeFN & " cat output " & strMergeFile
            DoEvents
            
            process_id = SHELL(strCmd, vbHide)
            process_handle = OpenProcess(PROCESS_TERMINATE, 0, process_id)
            If process_handle <> 0 Then
               For iTimes = 1 To 10
                  If PUB_CheckIsRunning("pdftk.exe") = True Then
                     Sleep 2000
                  Else
                     Exit For
                  End If
               Next
               If iTimes > 10 Then
                  TerminateProcess process_handle, 0&
                  CloseHandle process_handle
               End If
            End If
            
            '檢查是否有產生合併PDF檔
            DoEvents
            If Dir(strMergeFile) <> "" Then
               If bolAutoBatch = True Then
                  '刪除合併檔
                  Kill strMergeFile
                  DoEvents
               End If
               If bolConnect = True Then
                  cnnConnection.CommitTrans
                  bolConnect = False
               End If
      
            Else
               If bolAutoBatch = False Then
                  MsgBox strMergeFile & " 檔案合併失敗!!"
               Else
                  WLog strMergeFile & " 檔案合併失敗!!"
               End If
               If bolAutoBatch = True Then
                  cnnConnection.RollbackTrans: bolConnect = False 'Add By Sindy 2019/9/4
               Else
                  GoTo ErrHand
               End If
            End If
ReadNext2: 'Add By Sindy 2024/8/27 合併時檔案讀取失敗,讀取下一筆
            Rs.MoveNext
         Loop
      End If
   End If
   Rs.Close
   '2022/6/16 END
   
   'Add By Sindy 2017/8/24
   If bolAutoBatch = True Then
      '清空資料夾暫存區
      'Modified by Lydia 2020/03/19 改用模組
      'If Dir(strAttachPath & "\.") <> "" Then
      '   Kill strAttachPath & "\*.*"
      '   DoEvents
      'End If
      Call PUB_KillAnyFile(strAttachPath)
      DoEvents
      'end 2020/03/19
   End If
   '2017/8/24 END
   
   PDFMergeFile_Batch = True
   If bolAutoBatch = False Then
      MsgBox "卷宗合併完成!!!"
   Else
      WLog "卷宗合併完成!!!"
   End If
   rsTmp.Close
   Set rsTmp = Nothing
   Set Rs = Nothing
   Exit Function
      
ErrHand:
   If bolConnect = True Then
      cnnConnection.RollbackTrans: bolConnect = False 'Add By Sindy 2019/9/4
   End If
   If bolAutoBatch = False Then
      MsgBox "本所案號：" & strCP01 & strCP02 & strCP03 & strCP04 & " " & Err.Description, vbCritical
   Else
      'Modify By Sindy 2019/10/18
      WLog "本所案號：" & strCP01 & strCP02 & strCP03 & strCP04 & " " & Err.Number & ":" & Err.Description & "(PDFMergeFile_Batch)" '& IIf(strErrText <> "", vbCrLf & strErrText, "")
      'Add By Sindy 2019/9/4 2019/9/4 上午 12:23:11  ==>  本所案號：FCT043937000 沒有使用權限
      If Err.Number = 70 Then '70:沒有使用權限 -2147217406:Not found
         Sleep 1000
         'Modify By Sindy 2019/10/18
         'WLog "GoTo ReadNext"
         'GoTo ReadNext 'Modify By Sindy 2019/10/30 Mark 改用 Resume Next
         Resume Next 'Modify By Sindy 2019/10/24 Mark:不可使用,AutoBatchDay會無法繼續往下Run
      End If
      '2019/9/4 END
   End If
   Set rsTmp = Nothing
   Set Rs = Nothing
End Function

Public Function GetAttachFile_Merge(ByVal strCP09 As String, ByVal pFileName As String, ByVal strNewFile As String, _
                                    m_AttachPath As String, bolAutoBatch As Boolean) As Boolean
   Dim stAttPath As String
   Dim lngSize As Long
   Dim iFileNo As Integer
   Dim bytes() As Byte
   
On Error GoTo ErrHnd
   
   stAttPath = m_AttachPath & "\" & strNewFile
   
   'Added by Morgan 2015/3/26
   
      'Modified by Morgan 2025/3/27 +cpp19
      strExc(0) = "select cpp14,cpp19 from casepaperpdf where cpp01='" & strCP09 & "' and cpp02='" & ChgSQL(pFileName) & "'"
      intI = 1
      Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
      If intI = 1 Then
         If Not IsNull(RsTemp("cpp14")) Then
            'Modified by Morgan 2015/4/22 +傳bolAutoBatch
            GetAttachFile_Merge = PUB_GetFtpFile(RsTemp("cpp14"), stAttPath, , bolAutoBatch, , "" & RsTemp("cpp19") <> "")
         End If
      'Added by Morgan 2015/5/13
      Else
         GetAttachFile_Merge = True
      'end 2015/5/13
      End If
      Exit Function
   
   'end 2015/3/26
   
'Removed by Morgan 2015/5/22 不再存DB
'   strExc(0) = "select * from casepaperpdf where cpp01='" & strCP09 & "' and cpp02='" & ChgSQL(pFileName) & "'"
'   intI = 1
'   Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
'   If intI = 1 Then
'      If Dir(stAttPath) <> "" Then Kill stAttPath
'      With RsTemp
'         lngSize = Val(.Fields("cpp03").Value)
'         ReDim bytes(lngSize)
'         If lngSize > 0 Then
'            bytes() = .Fields("cpp04").GetChunk(lngSize)
'         End If
'      End With
'      iFileNo = FreeFile
'      Open stAttPath For Binary Access Write As #iFileNo
'      If lngSize > 0 Then Put #iFileNo, , bytes()
'      Close #iFileNo
'   End If
'
'   GetAttachFile_Merge = True
'   Exit Function
'end 2015/5/22
   
ErrHnd:
   GetAttachFile_Merge = False
   If bolAutoBatch = False Then
      MsgBox "無法儲存檔案[ " & strNewFile & " ]！" & Err.Description, vbCritical
   Else
      WLog "無法儲存檔案[ " & strNewFile & " ]！" & Err.Description, vbCritical
   End If
   If iFileNo > 0 Then Close #iFileNo
End Function

''Add By Sindy 2015/3/2 參考 PUB_AddCP1913 撰寫
''pCountry:申請國家
''pNewCP09:通知期限收文號
''Modify By Sindy 2021/1/11 內商整批期限通知 + , Optional pCP27 As String = "" : 定稿日期=發文日
'Public Function PUB_AddCP1725(pCP01 As String, pCP02 As String, pCP03 As String, pCP04 As String, pCP06 As String, pCP07 As String, pNP01 As String, pNP22 As String, _
'   Optional pCountry As String, Optional pCustNo As String, Optional ByRef pNewCP09 As String, _
'   Optional pFcAgentNo As String, Optional pCP27 As String = "") As Boolean
'
'   Dim stSQL As String, iR As Integer
'   Dim rsQuery As ADODB.Recordset
'   Dim stCP09 As String, stCP13 As String, stCP12 As String
'   Dim stJudge As String
'   Dim bolConn As Boolean
'   Dim strChkDate As String
'
'On Error GoTo ErrHnd
'
'   strChkDate = Format(DateAdd("M", -1, ChangeWStringToWDateString(strSrvDate(1))), "YYYYMMDD")
'   stSQL = "select * from caseprogress where cp01='" & pCP01 & "' and cp02='" & pCP02 & "' and cp03='" & pCP03 & "' and cp04='" & pCP04 & "' and cp10='1725' and cp30='" & pNP22 & "' and cp05>=" & strChkDate
'   iR = 1
'   Set rsQuery = ClsLawReadRstMsg(iR, stSQL)
'
'   'cnnConnection.BeginTrans
'   cnnConnection.BeginTrans: bolConn = True
'   If iR = 1 Then
'      pNewCP09 = rsQuery("cp09")
'   Else
'      '收文號
'      'Modified by Lydia 2016/12/22 本所管控C類進度自2017/01/01起改用D類收文
'      'stCP09 = AutoNo("C", 6)
'      If strSrvDate(1) >= 本所D類收文啟用日 Then
'          stCP09 = AutoNo("D", 6)
'      Else
'          stCP09 = AutoNo("C", 6)
'      End If
'      'end 2016/12/22
'      stCP13 = PUB_GetAKindSalesNo(pCP01, pCP02, pCP03, pCP04)
'      stCP12 = GetSalesArea(stCP13)
'      'Modify By Sindy 2021/1/11 發文日 : strSrvDate(1) => IIf(Val(pCP27) > 0, DBDATE(pCP27), strSrvDate(1))
'      stSQL = "insert into caseprogress( cp01,cp02,cp03,cp04,cp05,cp06,cp07,cp09,cp10" & _
'         ",cp12,cp13,cp14,cp20,cp26,cp27,cp30,cp32,cp43 ) values ('" & pCP01 & "'" & _
'         ",'" & pCP02 & "','" & pCP03 & "','" & pCP04 & "'," & strSrvDate(1) & _
'         "," & CNULL(pCP06, True) & "," & CNULL(pCP07, True) & ",'" & stCP09 & "','1725','" & stCP12 & "'" & _
'         ",'" & stCP13 & "','" & strUserNum & "','N','N'," & IIf(Val(pCP27) > 0, DBDATE(pCP27), strSrvDate(1)) & ",'" & pNP22 & "','N','" & pNP01 & "')"
'      cnnConnection.Execute stSQL, intI
'
'      pNewCP09 = stCP09
'   End If
'
'   'Add By Sindy 2019/10/18
'   If strSrvDate(1) >= T商標電子化啟用日 Then
'      '新增信函進度
'      '傳FC代理人(pa75)
'      '傳是否大宗發文(pbolBulk=True)
'      'Modify By Sindy 2022/3/11 pRegisteredMail = False: 是平信非掛號
'      PUB_AddLetterProgress pNewCP09, 0, True, "", False, pCustNo, "1725", pFcAgentNo, , , True
'   End If
'   '2019/10/18 END
'
'   If bolConn = True Then cnnConnection.CommitTrans: bolConn = False
'
'   PUB_AddCP1725 = True
'   Exit Function
'
'ErrHnd:
'   If bolConn = True Then cnnConnection.RollbackTrans: bolConn = False
'   MsgBox Err.Description, vbCritical
'End Function

'Added by Morgan 2015/8/28
'更新信函進度費用點數
Public Sub PUB_UpdateLP2930(pLP01 As String, pLP29 As String, pLP30 As String)
   cnnConnection.Execute "update letterprogress set lp29=" & CNULL(pLP29, True) & ",lp30=" & CNULL(pLP30, True) & " where lp01='" & pLP01 & "'"
End Sub

'Memo by Lydia 2019/08/16 產生通知期限-xxx的進度
'Modified by Morgan 2014/6/12 +pCountry:申請國家,pNewCP09:通知期限收文號
'Modified by Morgan 2016/6/15 +pbolInTrans:是否已有transaction
'Modified by Morgan 2016/11/7 +pbolBulk:是否大宗發文
'Modified by Lydia 2019/08/16 +傳入表單名稱pFromFrm
Public Function PUB_AddCP1913(pCP01 As String, pCP02 As String, pCP03 As String, pCP04 As String, pCP06 As String, pCP07 As String, pNP01 As String, pNP22 As String, _
                                            Optional pCountry As String, Optional pCustNo As String, Optional ByRef pNewCP09 As String, _
                                            Optional pFcAgentNo As String, Optional pNoDate As Boolean = False, Optional pbolInTrans As Boolean = False, Optional pbolBulk As Boolean = False, _
                                            Optional pFromFrm As String) As Boolean
   Dim stSQL As String, iR As Integer
   Dim rsQuery As ADODB.Recordset
   Dim stCP09 As String, stCP13 As String, stCP12 As String
   Dim stJudge As String
   Dim strCP48 As String 'Added by Lydia 2019/08/16
   
On Error GoTo ErrHnd
   
   'Modified by Morgan 2016/3/8 改判斷發文室未發文的才更新,否則就要新增(表示有再次通知)。
   'Modified by Morgan 2016/6/24 改只抓1年內有通知過的,CFP催實審不只一次 Ex.CFP026045
  'Modified by Morgan 2017/3/20 CFP案若已發文一律新增進度檔 Ex.CFP-025977--慧汶,秀玲
   'stSQL = "select * from caseprogress where cp01='" & pCP01 & "' and cp02='" & pCP02 & "' and cp03='" & pCP03 & "' and cp04='" & pCP04 & "' and cp10='1913' and cp30='" & pNP22 & "' and cp127 is null and cp05>" & (strSrvDate(1) - 10000)
   'Modified by Morgan 2021/10/4 有發文室發文日(CP127)但發文人(CP154)是QPGM的是E化案件,也不必新增。另若有EMail寄送日期(LP39)的先新增(沒發生過，需人工確認是否保留)
   stSQL = "select * from caseprogress where cp01='" & pCP01 & "' and cp02='" & pCP02 & "' and cp03='" & pCP03 & "' and cp04='" & pCP04 & "' and cp10='1913' and cp30='" & pNP22 & "' and (cp127 is null or cp154='QPGMR') and not (cp01='CFP' and cp158>0)"
   stSQL = stSQL & " and not exists(select * From letterprogress where lp01=cp09 and lp39>0)"
   'Added by Morgan 2023/12/6 下一程序法限相同才不新增 Ex:FCP-052000(前一年度有催但非本所繳納,法限手動更新為次年)
   stSQL = stSQL & " and exists(select * from nextprogress where np01='" & pNP01 & "' and np22=" & pNP22 & " and np09=cp07 )"
   'end 2023/12/6
   iR = 1
   Set rsQuery = ClsLawReadRstMsg(iR, stSQL)
   
   If Not pbolInTrans Then cnnConnection.BeginTrans
On Error GoTo ErrHnd2

   If iR = 1 Then
      pNewCP09 = rsQuery("cp09")
      'Added by Morgan 2016/1/13 記錄最後一次通知的人和日期
      'Modified by Lydia 2017/12/25 原通知日=發文日,未發文則註解
      'stSQL = "update caseprogress set cp14='" & strUserNum & "'" & IIf(pNoDate = False, ",cp27=" & strSrvDate(1), ",cp27=null") & ",cp64='原通知日'||cp27||'('||cp14||');'||cp64 where cp09='" & pNewCP09 & "'"
      'Modified by Lydia 2018/05/31 第2次以後通知,更新CreateDate=系統日,並且在備註註明原日期(ex.CFP-22354在107/5/28第一次跑期限通知管制表,5/29跑第2次,之後智權人員確認後轉定稿未能寫報價備註)
      'stSQL = "update caseprogress set cp14='" & strUserNum & "'" & IIf(pNoDate = False, ",cp27=" & strSrvDate(1), ",cp27=null") & ",cp64='原通知日'||decode(cp158,0,'未發文',cp158)||'('||cp14||');'||cp64 where cp09='" & pNewCP09 & "'"
      stSQL = "update caseprogress set cp14='" & strUserNum & "'" & IIf(pNoDate = False, ",cp27=" & strSrvDate(1), ",cp27=null") & _
                   " ,cp66=" & strSrvDate(1) & " ,cp64='原通知日'||sqldatet(cp66)||decode(cp158,0,'未發文','已發文'||sqldatet(cp158))||'('||cp14||');'||cp64 " & _
                   " where cp09='" & pNewCP09 & "'"
      cnnConnection.Execute stSQL, intI
      'end 2016/1/13
   'end 2016/6/24
   Else
      '收文號
      'Modified by Lydia 2016/12/22 本所管控C類進度自2017/01/01起改用D類收文
      'stCP09 = AutoNo("C", 6)
      If strSrvDate(1) >= 本所D類收文啟用日 Then
          stCP09 = AutoNo("D", 6)
      Else
          stCP09 = AutoNo("C", 6)
      End If
      'end 2016/12/22
      
      'Modified by Morgan 2018/2/27
      'stCP13 = PUB_GetAKindSalesNo(pCP01, pCP02, pCP03, pCP04)
      If pCP01 = "FCP" Then
         stCP13 = PUB_GetFCPSalesNo(pCP01, pCP02, pCP03, pCP04)
      Else
         stCP13 = PUB_GetAKindSalesNo(pCP01, pCP02, pCP03, pCP04)
      End If
      'end 2018/2/27
      
      'Added by Lydia 2019/08/16 FCP程序大項工作整批發文(對外通知函-->繳年費通知函)
      strCP48 = Empty
      If UCase(pFromFrm) = "FRM060304" Then
          strCP48 = CompDate(2, 10, strSrvDate(1))
      End If
      'Added by Lydia 2025/06/05 FCP程序大項工作整批發文(對外通知函-->實審通知函)
      If UCase(pFromFrm) = "FRM060325" Then
          strCP48 = CompDate(2, 15, strSrvDate(1))
      End If
      'end 2025/06/05
      
      stCP12 = GetSalesArea(stCP13)
      'Modified by Morgan 2016/1/13 +不上發文日控制
      'Modified by Lydia 2019/08/16 +承辦期限CP48
      stSQL = "insert into caseprogress( cp01,cp02,cp03,cp04,cp05,cp06,cp07,cp09,cp10" & _
         ",cp12,cp13,cp14,cp20,cp26,cp27,cp30,cp32,cp43,cp48 ) values ('" & pCP01 & "'" & _
         ",'" & pCP02 & "','" & pCP03 & "','" & pCP04 & "'," & strSrvDate(1) & _
         "," & CNULL(pCP06, True) & "," & CNULL(pCP07, True) & ",'" & stCP09 & "','1913','" & stCP12 & "'" & _
         ",'" & stCP13 & "','" & strUserNum & "','N','N'," & IIf(pNoDate = False, strSrvDate(1), "Null") & ",'" & pNP22 & "','N','" & pNP01 & "'," & CNULL(strCP48, True) & ")"
      cnnConnection.Execute stSQL, intI

      pNewCP09 = stCP09
   End If
   
   'Added by Morgan 2014/6/18
   '台灣案新增信函進度
   'Modified by Morgan 2015/8/27 改所有P案
   'If pCountry = "000" Then
   If pCP01 = "P" Then
      'Modified by Morgan 2018/8/1 判發人改抓設定檔
      stJudge = PUB_GetLetterJudgeNew("1", pCP01, "1913", pCountry)
      PUB_AddLetterProgress pNewCP09, 0, True, stJudge, True, pCustNo, "1913", pFcAgentNo, , , pbolBulk
      
      'Added by Morgan 2020/4/10
      'FMP有期限之案件EMAIL通知
      If Left(stCP12, 1) = "F" Then
         'Modified by Morgan 2020/9/15 +寰華案,改通知智權人員
         'If Left(Pub_StrUserSt03, 1) <> "F" Then
         '   PUB_FMPCaseInform pNewCP09, False
         'End If
         PUB_FMPCaseInform pNewCP09, False, True, Left(Pub_StrUserSt03, 1) = "F"
         'end 2020/9/15
      End If
      'end 2020/4/10
   
   'Added by Morgan 2017/12/14 CFP電子化
   ElseIf pCP01 = "CFP" And strSrvDate(1) >= CFP第一階段電子化啟用日 Then
      stJudge = PUB_GetLetterJudgeNew("1", pCP01, "1913", pCountry)
      PUB_AddLetterProgress pNewCP09, 0, True, stJudge, True, pCustNo, "1913", pFcAgentNo, , , pbolBulk
   End If
   'end 2014/6/18
   
   If Not pbolInTrans Then cnnConnection.CommitTrans
   
   PUB_AddCP1913 = True
   Exit Function
   
ErrHnd2:
   If Not pbolInTrans Then cnnConnection.RollbackTrans
ErrHnd:
   MsgBox Err.Description, vbCritical
   
End Function

'Add By Sindy 2021/2/1 T案C類有發文日，沒有產出定稿時
'才詢問是否有客戶函
Public Sub PUB_TCaseAskIsPost_C(pCRecNo As String)
Dim stSQL As String, intR As Integer
Dim rsQuery As ADODB.Recordset
Dim bolNotCUS As Boolean
Dim strCP01 As String, strCP14 As String, strCP27 As String, strCP10 As String
   
   bolNotCUS = False
   stSQL = "select cp01,cp09,cp10,cp14,cp27 from caseprogress where cp09='" & pCRecNo & "'"
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      strCP01 = rsQuery.Fields("cp01")
      strCP10 = rsQuery.Fields("cp10") 'Add By Sindy 2021/2/25
      strCP14 = "" & rsQuery.Fields("cp14")
      strCP27 = "" & rsQuery.Fields("cp27")
      '內商操作FCT時,也不會有客戶函
      If strCP01 = "FCT" Then
         bolNotCUS = True
      End If
   End If
   If bolNotCUS = True Or Val(strCP27) = 0 Then
      Call PUB_NotCusLP(pCRecNo) '沒有客戶函
   Else
      'TF要詢問
      'Modify By Sindy 2021/2/25 + 1001.核准 無定稿也要詢問
      'Modify By Sindy 2022/10/12 + 1801.服務業務結果 也要詢問
      If strCP01 = "TF" Or strCP10 = "1001" Or strCP10 = "1801" Then
         If MsgBox("是否寄通知函給客戶?", vbYesNo + vbQuestion + vbDefaultButton1) = vbYes Then
            strSql = "update letterprogress set lp04=null,lp05=decode(lp03,0,0," & strSrvDate(1) & ")" & _
                     ",lp08='" & strUserNum & "',lp09=" & strSrvDate(1) & _
                     " where lp01='" & pCRecNo & "'"
         Else
            If Val(strCP27) = 19221111 Then
               strExc(0) = "不通知客戶;"
            Else
               strExc(0) = "不寄紙本通知函給客戶;"
            End If
            strSql = "update letterprogress set lp04=null,lp05=decode(lp03,0,0," & strSrvDate(1) & ")" & _
                     ",lp06='" & strUserNum & "',lp07=" & strSrvDate(1) & ",lp08='" & strCP14 & "'" & _
                     ",lp09=" & strSrvDate(1) & ",lp10='N',lp12='" & strExc(0) & "'" & _
                     " where lp01='" & pCRecNo & "'"
         End If
         cnnConnection.Execute strSql, intI
      Else
         Call PUB_NotCusLP(pCRecNo) '沒有客戶函
      End If
   End If
   
   Set rsQuery = Nothing
End Sub

'Add By Sindy 2021/1/8 T案AB類發文沒有產出定稿時
'才檢查卷宗區是否有CUS,若沒有,才詢問是否有客戶函
Public Sub PUB_TCaseAskIsPost(pCRecNo As String)
Dim stSQL As String, intR As Integer
Dim rsQuery As ADODB.Recordset
Dim bolNotCUS As Boolean
Dim strCP01 As String, strCP02 As String, strCP03 As String, strCP04 As String
Dim strCP14 As String, strCP27 As String, strCP07 As String, strCP10 As String
Dim strTM23 As String, strTM44 As String, strLP31 As String ', strLP11 As String
Dim bolRegMail As Boolean
   
   bolNotCUS = False
   'Modify By Sindy 2021/6/7 + ,cp02,cp03,cp04
   stSQL = "select cp01,cp02,cp03,cp04,cp07,cp09,cp10,cp14,cp27,tm23,tm44 from caseprogress,trademark" & _
      " where cp09='" & pCRecNo & "'" & _
      " and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+) and tm01 is not null" & _
      " union select cp01,cp02,cp03,cp04,cp07,cp09,cp10,cp14,cp27,sp08,sp26 from caseprogress,servicepractice" & _
      " where cp09='" & pCRecNo & "'" & _
      " and cp01=sp01(+) and cp02=sp02(+) and cp03=sp03(+) and cp04=sp04(+) and sp01 is not null"
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      strCP01 = rsQuery.Fields("cp01")
      strCP02 = rsQuery.Fields("cp02")
      strCP03 = rsQuery.Fields("cp03")
      strCP04 = rsQuery.Fields("cp04")
      strCP10 = rsQuery.Fields("cp10")
      strCP07 = "" & rsQuery.Fields("cp07")
      strCP14 = "" & rsQuery.Fields("cp14")
      strCP27 = "" & rsQuery.Fields("cp27")
      strTM23 = "" & rsQuery.Fields("tm23")
      strTM44 = "" & rsQuery.Fields("tm44")
      
      '沒有客戶函的案件性質:101.申請
      '內商操作FCT發文時,也不會有客戶函 FCT-044843,FCT-044844,FCT-044845,FCT-045989
      'Modify By Sindy 2021/4/13 + Or strCP10 = "1728" : 收款寄證不需要詢問
      If (rsQuery.Fields("cp10") = "101" And strCP01 <> "TF") Or _
         strCP01 = "FCT" Or strCP10 = "1728" Then
         bolNotCUS = True
      End If
   End If
   If bolNotCUS = True Then
      Call PUB_NotCusLP(pCRecNo) '沒有客戶函
   Else
      'Modify By Sindy 2021/2/25 ex:T-228523 承辦人輸入案件副檔名為DATA而不是CUS,程序人員事後改
      '  因此不管卷宗區有無CUS, 且程序也有可能會自己做客戶函
      'Modify By Sindy 2025/8/18 *****
      '檢查卷宗區是否有CUS客戶函,”無”才要詢問
'      stSQL = "select cp09,cp10 from caseprogress where cp09='" & pCRecNo & "'" & _
'              " AND EXISTS (SELECT * FROM CasePaperPdf WHERE InStr(Upper(cpp02),'.CUS.PDF')>0 AND cpp01=cp09 AND cpp10<>'D')"
      stSQL = "SELECT * FROM CasePaperPdf WHERE cpp01='" & pCRecNo & "'" & _
              " AND InStr(Upper(cpp02),'.CUS.PDF')>0 AND cpp10<>'D'"
      intR = 1
      Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
'      '或是TF要詢問
'      If intR = 1 Or strCP01 = "TF" Then
      If intR = 0 Then
      '2025/8/18 END *****
      
         'Add By Sindy 2021/4/8
         stSQL = "update LetterProgress set lp01=lp01 where lp01='" & pCRecNo & "'"
         intR = 0
         cnnConnection.Execute stSQL, intR
         If intR = 0 Then
            PUB_AddLetterProgress pCRecNo, 0, True, , False, strTM23, strCP10, strTM44
         End If
         '2021/4/8 END
         
         If MsgBox("是否寄通知函給客戶?", vbYesNo + vbQuestion + vbDefaultButton1) = vbYes Then
'            strLP11 = PUB_SetLP11(strTM23, strTM44, strLP31)
'            If strLP11 = "Y" Then '直寄,無地址不會是Y
'               If GetPrjNationNumber1(strTM23) < "010" Then '台灣申請人
'                  '有期限為掛號直寄
'                  If Val(strCP07) > 0 Then bolRegMail = True
'               End If
''            If strLP11 <> "Y" Then '無地址不會是Y
''               bolRegMail = False
''            Else
               '非台灣申請人要詢問是否掛號直寄
               'ex:T-214110(台灣申請人).對方補充理由沒有期限,但是要直寄
                  If MsgBox("通知函是否掛號直寄?", vbYesNo + vbQuestion + vbDefaultButton1) = vbYes Then
                     bolRegMail = True
                  End If
''            End If
            'Modify By Sindy 2021/6/7 + ",lp06='" & PUB_GetAKindSalesNo(strCP01, strCP02, strCP03, strCP04) & "'"
            strSql = "update letterprogress set lp04=null,lp05=decode(lp03,0,0," & strSrvDate(1) & ")" & _
                     ",lp06='" & PUB_GetAKindSalesNo(strCP01, strCP02, strCP03, strCP04) & "'" & _
                     ",lp08='" & strUserNum & "',lp09=" & strSrvDate(1) & _
                     ",lp10='Y',lp11='" & IIf(bolRegMail = True, "Y", "") & "',LP31='" & strLP31 & "'" & _
                     " where lp01='" & pCRecNo & "'"
         Else
            If Val(strCP27) = 19221111 Then
               strExc(0) = "不通知客戶;"
            Else
               strExc(0) = "不寄紙本通知函給客戶;"
            End If
            strSql = "update letterprogress set lp04=null,lp05=decode(lp03,0,0," & strSrvDate(1) & ")" & _
                     ",lp06='" & strUserNum & "',lp07=" & strSrvDate(1) & ",lp08='" & strCP14 & "'" & _
                     ",lp09=" & strSrvDate(1) & ",lp10='N',lp12='" & strExc(0) & "'" & _
                     " where lp01='" & pCRecNo & "'"
         End If
         cnnConnection.Execute strSql, intI
         
      Else '卷宗區有CUS客戶函
         'Add By Sindy 2025/8/28
         PUB_AddLetterProgress pCRecNo, 0, True, , False, strTM23, strCP10, strTM44
         '2025/8/28 END
'      Else
'         Call PUB_NotCusLP(pCRecNo) '沒有客戶函
      End If
      Call PUB_UpdateLP19_T(strCP01, strCP02, strCP03, strCP04, pCRecNo, TransDate(strCP27, 1)) 'Add by Sindy 2025/9/2 收據/回執設定
   End If
   
   Set rsQuery = Nothing
End Sub

'Add By Sindy 2021/1/7 沒有客戶函,要清空相關欄位值
Public Sub PUB_NotCusLP(pCRecNo As String)
Dim stSQL As String, intR As Integer
   
   stSQL = "update LetterProgress set lp10=null where lp01='" & pCRecNo & "'"
   cnnConnection.Execute stSQL, intI
   stSQL = "update caseprogress set cp127=null,cp128=null,cp154=null where cp09='" & pCRecNo & "' and cp154='QPGMR'"
   cnnConnection.Execute stSQL, intR
End Sub

'Add By Sindy 2025/8/11 檢查卷宗區裡面是否有此副檔名存在
Public Function PUB_CPPChkFileExists(pCRecNo As String, strFileType) As Boolean
Dim stSQL As String, intR As Integer
Dim rsQuery As ADODB.Recordset
   
   PUB_CPPChkFileExists = False
   stSQL = "SELECT * FROM CasePaperPdf WHERE cpp01='" & pCRecNo & "' and InStr(Upper(cpp02),'." & UCase(strFileType) & ".')>0" & _
            " AND cpp10<>'D'"
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      PUB_CPPChkFileExists = True
   End If
   
   Set rsQuery = Nothing
End Function

'Added by Morgan 2014/4/11
'新增客戶函進度檔
'pCRecNo=來函收文號, pPDFQty=檔案數量, pLetterExist=是否有客戶函, pJudger=判發人, pRegisteredMail=是否掛號, pCustNo=申請人
'pReceipt=是否有收據 'Add by Amy 2014/08/08
'Modified by Morgan 2016/1/11 +pLP26 是否E化(回傳)
'Modified by Morgan 2016/11/7 +pbolBulk:是否大宗發文
'Modified by Morgan 2019/12/20 pPDFQty 設為 ByVal(因若用 intI 傳入時數值會被改變)
'Modified by Morgan 2020/1/8 +pEngJudge:是否工程師判發
'Modified by Sindy 2020/12/7 + , Optional stLP20 As String = "" : 改發後補看人員也可以從外部傳入
Public Sub PUB_AddLetterProgress(ByVal pCRecNo As String, ByVal pPDFQty As Integer, ByVal pLetterExist As Boolean, _
      Optional ByVal pJudge As String, Optional ByVal pRegisteredMail As Boolean = False, _
      Optional ByVal pCustNo As String, Optional ByVal pCP10 As String, Optional ByVal pFCAgent As String, _
      Optional pReceipt As Boolean = False, Optional ByRef pLP26 As String, _
      Optional pbolBulk As Boolean = False, Optional pEngJudge As Boolean = False, Optional stLP20 As String = "")
      
   Dim stSQL As String, intR As Integer, stCaseNo As String
   Dim stLP11 As String, stLP10 As String
   Dim stLP19 As String '是否有收據 Add by Amy 2014/08/08
   Dim bolOrdinaryMail As Boolean '平信 Added by Morgan 2014/6/18
   'Dim stLP20 As String 'Added by Morgan 2014/12/17
   'Added by Morgan 2015/3/26
   Dim rsQuery As ADODB.Recordset
   Dim stFromDir As String, stToDir As String
   Dim stLP26 As String 'Added by Morgan 2015/6/23
   'Added by Morgan 2015/8/27
   Dim bolFee As Boolean '是否有發文規費
   Dim bolFMP As Boolean '是否FMP案
   Dim bolFMT As Boolean '是否FMT案 Add By Sindy 2025/5/21
   Dim stLP31 As String  'Added by Morgan 2015/10/8
   Dim stPA09 As String 'Added by Morgan 2016/9/19
   Dim stCP27 As String 'Added by Morgan 2017/12/14
   Dim stCP01 As String 'Added by Morgan 2018/10/9
   Dim stCustNo As String 'Added by Morgan 2019/4/19
   Dim stLP06 As String, stCP02 As String, stCP03 As String, stCP04 As String 'Added by Morgan 2019/9/6
   Dim salesArea As String, salesNo As String, bolMCTF As Boolean 'Add by Sindy 2019/10/24
   Dim stRefCP10 As String '相關號案件性質 Added by Morgan 2020/2/17
   Dim stLP51 As String '有無實體 Added by Morgan 2021/10/18
   Dim stPA08 As String '專利種類 Added by Morgan 2021/12/16
   Dim stLP38 As String 'Added by Morgan 2022/6/29
   Dim stPA178 As String '證書形式 Added by Morgan 2023/1/16
   Dim cp(4) As String 'Added by Morgan 2023/6/13
   Dim stSubj As String, stTO As String, stCP10N As String 'Added by Morgan 2023/7/24
   Dim bolNoCP127 As Boolean 'Added by Morgan 2025/7/24
   Dim stRefCP05 As String 'Added by Morgan 2025/7/28 相關收文號收文日
   
   pFCAgent = ChangeCustomerL(pFCAgent) 'Added by Morgan 2025/7/24
   
   'Added by Morgan 2015/5/14 是否E化
   'Modified by Morgan 2015/6/23 +LP26
   'Modified by Morgan 2016/9/19 非臺灣案目前只有1208,1803的定稿是平信
   'Modified by Morgan 2019/4/19 +pa26
   'Modified by Morgan 2020/2/17 +cp43
   'Modified by Morgan 2021/12/16 +pa08
   'Modified by Morgan 2023/1/16 +pa178
   'Modified by Morgan 2025/7/28 +RCP05 相關收文號收文日
   stSQL = "select c1.cp01||c1.cp02||c1.cp03||c1.cp04 CaseNo,c1.cp01,c1.cp02,c1.cp03,c1.cp04,c1.cp12,c1.cp27,c1.cp84,pa09,pa26,'P' dSys,c1.cp43,pa08,pa178,c2.cp05 RCP05" & _
      " from caseprogress c1,patent,caseprogress c2 where c1.cp09='" & pCRecNo & "'" & _
      " and pa01=c1.cp01 and pa02=c1.cp02 and pa03=c1.cp03 and pa04=c1.cp04 and c2.cp09(+)=c1.cp43"
   'Add By Sindy 2019/10/22
   'Modified by Morgan 2025/7/28 +RCP05 相關收文號收文日並改用(+)
   stSQL = stSQL & " union " & _
           "select c1.cp01||c1.cp02||c1.cp03||c1.cp04 CaseNo,c1.cp01,c1.cp02,c1.cp03,c1.cp04,c1.cp12,c1.cp27,c1.cp84,tm10,tm23,'T' dSys,c1.cp43,'' pa08,tm136 pa178,c2.cp05 RCP05" & _
      " from caseprogress c1,trademark,caseprogress c2 where c1.cp09='" & pCRecNo & "'" & _
      " and tm01(+)=c1.cp01 and tm02(+)=c1.cp02 and tm03(+)=c1.cp03 and tm04(+)=c1.cp04 and c2.cp09(+)=c1.cp43"
   stSQL = stSQL & " union " & _
           "select c1.cp01||c1.cp02||c1.cp03||c1.cp04 CaseNo,c1.cp01,c1.cp02,c1.cp03,c1.cp04,c1.cp12,c1.cp27,c1.cp84,sp09,sp08,'S' dSys,c1.cp43,'' pa08,'' pa178,c2.cp05 RCP05" & _
      " from caseprogress c1,servicepractice,caseprogress c2 where c1.cp09='" & pCRecNo & "'" & _
      " and sp01(+)=c1.cp01 and sp02(+)=c1.cp02 and sp03(+)=c1.cp03 and sp04(+)=c1.cp04 and c2.cp09(+)=c1.cp43"
   '2019/10/22 END
   
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   stCaseNo = rsQuery("CaseNo")
   stCP01 = "" & rsQuery("cp01") 'Added by Morgan 2018/10/9
   stCP02 = "" & rsQuery("cp02") 'Added by Morgan 2019/9/6
   stCP03 = "" & rsQuery("cp03") 'Added by Morgan 2019/9/6
   stCP04 = "" & rsQuery("cp04") 'Added by Morgan 2019/9/6
   stRefCP05 = "" & rsQuery("rcp05") 'Added by Morgan 2025/7/28
   cp(1) = stCP01: cp(2) = stCP02: cp(3) = stCP03: cp(4) = stCP04 'Added by Morgan 2023/6/13
   
   'Add By Sindy 2024/4/12 FCT案不應產生信函進度
   If stCP01 = "FCT" Then
      Exit Sub
   End If
   '2024/4/12 END
   
   'Added by Morgan 2014/11/14
   stSQL = "delete LetterProgress where lp01='" & pCRecNo & "'"
   cnnConnection.Execute stSQL, intR
   'Added by Morgan 2018/11/16 要清除自動發文相關資料，否則再次發文時 LP15 不會上 Y
   If intR = 1 Then
      'Modify By Sindy 2021/1/8 取消更新cp28 => cp28=null,
      stSQL = "update caseprogress set cp127=null,cp128=null,cp154=null where cp09='" & pCRecNo & "' and cp154='QPGMR'"
      cnnConnection.Execute stSQL, intR
   End If
   'end 2018/11/16
   'end 2014/11/14
   
   stCP27 = "" & rsQuery("cp27") 'Added by Morgan 2017/12/14
   stPA09 = "" & rsQuery("pa09") 'Added by Morgan 2016/9/19
   stPA178 = "" & rsQuery("pa178") 'Added by Morgan 2023/1/16
   'Added by Morgan 2022/3/21
   'Removed by Morgan 2022/5/24 改分開判斷，有傳客戶編號且與案件申請人不同時，是否E化直接用客戶編號判斷
   'If pCustNo <> "" Then
   '   stCustNo = pCustNo
   'Else
   'end 2022/5/24
   'end 2022/3/21
   
      If pCustNo <> "" Then pCustNo = ChangeCustomerL(pCustNo) 'Added by Morgan 2022/5/31
      
      stCustNo = "" & rsQuery("pa26")  'Added by Morgan 2019/4/19
      
   'End If'Removed by Morgan 2022/5/24
   stPA08 = "" & rsQuery("pa08") 'Added by Morgan 2021/12/16
   
   'Added by Morgan 2015/8/27
   'Modified by Morgan 2021/12/24 +判斷台灣案，因為T大陸案也會輸發文規費
   If stPA09 = "000" And rsQuery("cp84") > 0 Then bolFee = True ' 有發文規費
   'If rsQuery("cp84") > 0 Then bolFee = True ' 有發文規費 'Removed by Morgan 2023/6/14 不知為有這段,與上面衝突
   'Modify By Sindy 2023/7/26 + And (stCP01 = "P" Or stCP01 = "CFP")
   If Left(rsQuery("cp12"), 1) = "F" And (stCP01 = "P" Or stCP01 = "CFP") Then bolFMP = True
   'Modify By Sindy 2020/1/10 + (stCP01 = "P" Or stCP01 = "PS" Or stCP01 = "CFP" Or stCP01 = "CPS")
'   If Left(rsQuery("cp12"), 1) = "F" And _
'      (stCP01 = "P" Or stCP01 = "PS" Or stCP01 = "CFP" Or stCP01 = "CPS") Then
'      bolFMP = True
'   End If
   'end 2015/8/27
   If Left(rsQuery("cp12"), 1) = "F" And Left(stCP01, 1) = "T" Then bolFMT = True 'Add By Sindy 2025/5/21
   
   'Added by Morgan 2020/2/17
   '讀取相關收文號案件性質
   If Not IsNull(rsQuery("cp43")) Then
      stSQL = "select cp10 from caseprogress where cp09='" & rsQuery("cp43") & "'"
      intR = 1
      Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         stRefCP10 = "" & rsQuery("cp10")
      End If
   End If
   'end 2020/2/17
   
   'Add By Sindy 2019/10/24 巨京也是走MCTF流程
   salesArea = GetCuSales(pCustNo, salesNo)
   bolMCTF = False
   If Mid(PUB_GetAKindSalesNo(stCP01, stCP02, stCP03, stCP04), 1, 4) = "MCTF" Or _
      salesNo = "96029" Or salesNo = "96030" Then
      bolMCTF = True
   End If
   '2019/10/24 END
   
   If pLetterExist = True Then
      stLP10 = "Y" '有客戶函
      
   End If 'Added by Morgan 2020/4/13 沒有客戶函也要設定 LP11,LP26,LP31(因C類可能是工程師承辦，收文時會設不印通知函，發文時才確認是否紙本通知)
   
      'Added by Morgan 2018/10/25 FMP不必檢查
      'Modify By Sindy 2019/10/24 + Or bolMCTF = True
      'Modify By Sindy 2020/11/12 + Or (bolMCTF = True And strSrvDate(1) < T商標電子化第2階段啟用日)
      If bolFMP Then
         stLP31 = "Y"
         'Added by Morgan 2023/2/7
         'FMP案不判發
         If stCP01 & pCP10 <> "CFP1909" Then
            pJudge = ""
         End If
         'end 2023/2/7
      'Add By Sindy 2025/5/21
      ElseIf bolFMT Then
         stLP31 = "Y"
         pJudge = "" '不判發
      '2025/5/21 END
      Else
      'end 2018/10/25
      
         'Added by Morgan 2022/5/24
         '有傳客戶編號且與案件申請人不同時(副本信函)，是否E化直接用客戶編號判斷
         If pCustNo <> "" And stCustNo <> pCustNo Then
            If PUB_ChkECust(pCustNo, stCP01, , intR) = True Then
               '有指定信箱
               If intR = 1 Then
                  stLP26 = "E"
               Else
                  stLP26 = "Y"
               End If
            Else
               stLP26 = ""
            End If
         Else
         'end 2022/5/24
         
            If PUB_GetEMailFlag(stCaseNo) = True Then
               'Modified by Morgan 2017/10/26 改比照領證仍顯示E化但不自動發文(有跟郭確認)
               'If pCP10 <> "1008" Then 'Added by Morgan 2016/10/28 來函性質為核發(1008)時不E化--玲玲
                  stLP26 = "Y" '純E
               'End If
               'pRegisteredMail = False 'Removed by Morgan 2015/7/9
            
            
               'Added by Morgan 2019/4/19 E化客戶
               'Modified by Morgan 2019/12/20 intI-->intR
               If PUB_ChkECust(stCustNo, stCP01, , intR) = True Then
                  '有指定信箱
                  If intR = 1 Then
                     stLP26 = "E"
                  Else
                     stLP26 = "Y"
                  End If
               End If
               'end 2019/4/19
               
            End If
            'end 2015/5/14
            
         End If 'Added by Morgan 2022/5/24
         
         '平信
         'Modified by Morgan 2014/6/24 +1228,1229
         'If pCP10 <> "" And InStr("1204,1207,1208,1217,1803,1804", pCP10) > 0 Then
         'Modified by Morgan 2015/1/12 AB類發文已上線，要加判斷C類收文號
         'Modified by Morgan 2015/4/10 +1911(暫不續行審查)改為平信直寄 Ex.P108362
         'Modified by Morgan 2018/10/9 +stCP01 = "P"
         If stCP01 = "P" And pCRecNo > "C" And pCP10 <> "" And InStr("1204,1207,1208,1217,1803,1804,1228,1229,1911", pCP10) > 0 Then
            'Modified by Morgan 2016/9/19 非臺灣案目前只有1208,1803的定稿是平信
            If stPA09 = "000" Or InStr("1208,1803", pCP10) > 0 Then
               'pRegisteredMail = True 'Removed by Morgan 2015/7/9
               'Modified by Morgan 2015/7/9 純E化不平信直寄
               'bolOrdinaryMail = True 'Added by Morgan 2014/6/18
               If stLP26 = "" Then
                  bolOrdinaryMail = True
                  
               'Added by Morgan 2018/11/16 指定e化客戶由程序直接EMail,不必智權確認
               ElseIf stLP26 = "E" Then
                  bolOrdinaryMail = True
                  
               End If
            End If
         'Modify By Sindy 2019/11/5 商標平信直寄,不經發文室
         'Modify By Sindy 2020/2/12 + And Len(pCP10) = 4
         ElseIf Left(stCP01, 1) = "T" Then
            'Add By Sindy 2021/1/6 MCT的註冊證為掛號, 其他都要經MCTF智權人員先確認
            If bolMCTF = True Then
               'Modify By Sindy 2021/4/6 有關MCT的註冊證原被歸類為直寄，
               '商標處決定將MCT註冊證改為非直寄(親送/寄送/不寄)之方式。
'               If pCP10 = "1701" Then
'                  pRegisteredMail = True
'               Else
               '2021/4/6 END
                  pRegisteredMail = False
'               End If
            End If
            '2021/1/6 END
            '整批的催期限
            '1729(撤三開拓)/1725(通知期限)/1717(通知延展)/1720(通知繳納註冊費)
            'Modify By Sindy 2025/4/17
            'If InStr("1729,1725,1717,1720", pCP10) > 0 And Len(pCP10) = 4 Then
            'Modify By Sindy 2025/4/23 1720(通知繳納註冊費)件數不多,取消為大宗
            'If InStr("1725,1717,1720", pCP10) > 0 And Len(pCP10) = 4 Then
            If InStr("1725,1717", pCP10) > 0 And Len(pCP10) = 4 Then
            '2025/4/17 END
               'Modify By Sindy 2025/4/17 mark:有傳入值不需在此處設定
'               pbolBulk = True
'               'Add By Sindy 2022/1/3 撤三開拓沒有直寄,退回給智權人員處理
'               If pCP10 = "1729" Then
'                  pRegisteredMail = False
'               'end 2022/3/10
'               Else
'               '2022/1/3 END
               '2025/4/17 END
               
                  'Modify By Sindy 2025/4/17 mark:改掛號經發文室
'                  'Added by Morgan 2022/3/10
'                  '通知期限1725是平信非掛號
'                  If pCP10 = "1725" Then
'                     pRegisteredMail = False
'                  End If
'                  'end 2022/3/10
                  
                  '純E化不平信直寄
                  'bolOrdinaryMail = True
                  If stLP26 = "" Then
                     bolOrdinaryMail = True
                  ElseIf stLP26 = "E" Then
                     bolOrdinaryMail = True
                  End If
                  '2019/11/5 END
'               End If
            End If
         End If
         
         '直寄:掛號或平信
         If pRegisteredMail Or bolOrdinaryMail Then
            'Added by Morgan 2025/7/24
            '寶齡富錦 Y55435 代理的案件通知繳年費要印紙本直寄
            If pFCAgent = "Y55435000" And pCP10 = "1913" And InStr("605,606,607", stRefCP10) > 0 Then
               stLP11 = "Y"
            Else
            'end 2025/7/24
               stLP11 = PUB_SetLP11(pCustNo, pFCAgent, stLP31)
            End If
         'Added by Morgan 2018/11/14
         '非直寄也要設定 LP31(E化客戶信函判斷會用)
         Else
            PUB_SetLP11 pCustNo, pFCAgent, stLP31
         'end 2018/11/14
         End If
      End If
      
   'End If 'Removed by Morgan 2020/4/13
   
   'Modify by Amy 2014/08/08 增加lp19=是否有收據
   If pReceipt = True Then
      stLP19 = "Y"
   End If
   
   'Modified by Morgan 2014/12/17
   '+LP20=發後補看人員
   If stCP01 = "P" Then
      If pCP10 = "1101" Or (pCRecNo < "C" And pCP10 <> "601" And pCP10 <> "605" And pCP10 <> "907" And pCP10 <> "913") Then
         'Modified by Morgan 2025/2/21
         'stLP20 = "73022"
         pub_PMan = Pub_GetSpecMan("專利處特定編號")
         stLP20 = Right(pub_PMan, 5)
         'end 2025/2/21
      End If
   'Added by Morgan 2018/10/11 +CFP發後補看(先都設補看人,進補看程式再過濾)
   '1.第1次有客戶函的通知申請案號(1101)。
   '2.所有工程師承辦有客戶函的進度。
   '3.專利權公告作廢(1606)、消滅(1604)、公告異議期滿通知(1223)、形式審查合格通知(1213)。(程序承辦)
   '4.詢問代理人(957)。(無客戶函)
   ElseIf stCP01 = "CFP" And pCRecNo < "D" Then
      'Added by Lydia 2023/04/24 修改王副總退休之相關控制; 5/1直接換成李柏翰99050
      If strSrvDate(1) >= "20230501" Then
         stLP20 = "99050"
      Else
      'end 2023/04/24
         stLP20 = "71011"
      End If 'Added by Lydia 2023/04/24
   End If
   
   'Modified by Morgan 2019/10/30 從下面移上來(沒有通知函也預設,因為CFP來函可能發文時會改要通知)
   'Added by Morgan 2019/9/6
   '預設確認人員
   'Add By Sindy 2019/10/24
   'If bolMCTF = True Then
   'MCTF案,整批或不是C類均為內商程序處理確認
   '1101.通知申請案號,1001.核准,1701.註冊證=>也是程序發E-Mail
   'Modify By Sindy 2020/9/15 定稿由程序產生的(Pub_StrUserSt03 = "P22"),MCTF案由程序確認(就不用寫死案件性質:Or pCP10 = "1101" Or pCP10 = "1001" Or pCP10 = "1701")
'   If bolMCTF = True And _
'      (Left(pCRecNo, 1) <> "C" Or pbolBulk = True Or Pub_StrUserSt03 = "P22") Then
   '*****
   'Modify By Sindy 2020/12/2 MCTF發郵件工作,要退回給MCTF智權人員自行處理
   '  只有整批定稿1717...和部份案件性質維持由程序操作 1001.核准
   'Modify By Sindy 2025/5/13 因通知期限為大宗案件性質但有開放人員可以輸入個案不經發文室,所以加判斷 + Or (InStr("1725,1717", pCP10) > 0 And Len(pCP10) = 4)
   If bolMCTF = True And _
      (pCP10 = "1001" Or pbolBulk = True Or (InStr("1725,1717", pCP10) > 0 And Len(pCP10) = 4)) Then
      'P2002:內商程序
      stLP06 = "P2002"
      'If pCP10 = "1001" Then '1001.核准,檢查有無發文日
      If pbolBulk = False Then
         'Modify By Sindy 2025/7/24 排除"核准-暫緩審理"因通知函均為智權自行書寫後EMAIL寄大陸代理人
         If pCP10 = "1001" And stRefCP10 = "310" Then
            stLP06 = PUB_GetAKindSalesNo(stCP01, stCP02, stCP03, stCP04)
         Else
         '2025/7/24 END
            stSQL = "select cp09,cp27 from caseprogress where cp09='" & pCRecNo & "'"
            intR = 1
            Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
            If intR = 1 Then
               If Val("" & rsQuery.Fields("cp27")) = 0 Then '無發文日,MCTF智權人員自行處理
                  stLP06 = PUB_GetAKindSalesNo(stCP01, stCP02, stCP03, stCP04)
               End If
            End If
         End If
      End If
   Else
   '2019/10/24 END
      stLP06 = PUB_GetAKindSalesNo(stCP01, stCP02, stCP03, stCP04)
      'stSQL = "update LetterProgress set lp06='" & stLP06 & "' where lp01='" & pCRecNo & "'" 'Removed by Morgan 2019/10/30
   End If
   'cnnConnection.Execute stSQL, intR 'Removed by Morgan 2019/10/30
   'end 2019/9/6
   
   'Added by Morgan 2021/10/18
   'LP51有無實體
   '有發文規費
   '專利:證書/核發.../專利權讓與核准/台灣案通知申請案號
   '商標:註冊證/補換發證書、申請中英文證明核准/台灣案通知申請案號
   'Modified by Morgan 2021/11/17 專利核發 405申請優先權證明書,436申請優先權存取碼要設為無實體--郭
   'Modified by Morgan 2023/1/16 +專利核發 443申請證書副本,商標 314申請註冊證副本 核准
   'Modified by Morgan 2024/8/7 +P大陸案核發 421申請檢索報告,423申請專利權評價報告,426新穎性調查設為無實體--韻丞
   'Modified by Morgan 2025/7/28 專利權讓與核准要排除假收文(本所為副本不會有證書) Ex:P-128764
   stLP51 = ""
   '證書/註冊證
   If ((stCP01 = "P" Or stCP01 = "CFP") And (pCP10 = "1603" Or (pCP10 = "1008" And stRefCP10 = "604") Or (pCP10 = "1001" And stRefCP10 = "708" And stRefCP05 <> "19221111"))) _
      Or (Left(stCP01, 1) = "T" And (pCP10 = "1701" Or (pCP10 = "1001" And stRefCP10 = "103"))) Then
      stLP51 = "Y"
      
      'Added by Morgan 2021/11/29 全E化客戶上線後電子證書的國家發證也為非實體--簡協理
      'Modified by Morgan 2023/9/7 全E化客戶才不印紙本 And stLP26 = "E"
      'Modified by Morgan 2023/9/15 取消 And stLP26 = "E" (因寄發文件台灣案電子證書要變色)
      If strSrvDate(1) >= e化客戶啟用日 Then
         If PUB_IsECertificate(stPA09, stCP01, stPA08) = True Then
            'Modified by Morgan 2023/6/13
            'stLP51 = ""
            If stCP01 = "CFP" Then
               If PUB_ChkCPExist(cp, "443", 2) = False Then
                  If stLP26 = "E" Then 'Added by Morgan 2023/9/18 全E才不印紙本
                     stLP51 = ""
                  End If
               End If
            Else
               stLP51 = ""
            End If
            'end 2023/6/13
         ElseIf stPA178 = "1" Then
            stLP51 = ""
         End If
      End If
      'end 2021/11/29
   
   '核發/核准
   ElseIf ((stCP01 = "P" Or stCP01 = "CFP") And (pCP10 = "1008" And stRefCP10 <> "405" And stRefCP10 <> "436" And Not (stPA09 = "020" And (stRefCP10 = "421" Or stRefCP10 = "423" Or stRefCP10 = "426")))) _
      Or (Left(stCP01, 1) = "T" And pCP10 = "1001" And (stRefCP10 = "304" Or stRefCP10 = "309" Or stRefCP10 = "314")) Then
      
      stLP51 = "Y"
   
   '有發文規費/台灣案通知申請案號
   ElseIf bolFee = True _
      Or ((stCP01 = "P" Or Left(stCP01, 1) = "T") And stPA09 = "000" And pCP10 = "1101") Then
      stLP51 = "Y"
      
      'Added by Morgan 2025/2/27
      '全E化客戶若有設不寄官方收據時也設無實體
      If stLP26 = "E" Then
         If PUB_ChkECustSetting(pCustNo, 不寄官方收據) = True Then
            stLP51 = ""
         End If
      End If
      'end 2025/2/27
      
      'Added by Morgan 2025/3/3 郭經理案件收據都設無實體--韻丞
      If salesNo = "79075" Then
         stLP51 = ""
      End If
      'end 2025/3/3
   
   End If
   'end 2023/1/16
   'end 2021/11/19
   'end 2021/10/18
   
   'Added by Morgan 2025/2/17 MCT案件都設無實體,因要依代理人要求決定是否要寄紙本,系統都不印,智權要寄送時才由程序自行列印--桂英
   If bolMCTF Then
      stLP51 = ""
   End If
   'end 2025/2/17

   
   'Added by Morgan 2022/6/29
   If stLP26 = "E" Then
      If stCP01 = "CFP" Or stCP01 = "CPS" Then
         stLP38 = PUB_GetCFPHandler(stCaseNo)
      End If
   End If
   'end 2022/6/29
   
   'Modified by Morgan 2015/10/8 +LP31
   'Modified by Morgan 2016/11/7 +LP32
   'Modified by Morgan 2019/10/30 +LP06
   'Modified by Morgan 2020/1/8 +LP43
   'Modified by Morgan 2021/10/18 +LP51
   'Modified by Morgan 2022/1/26 +LP52
   'Modified by Morgan 2022/6/29 +LP38
   stSQL = "insert into LetterProgress(LP01,LP02,LP04,LP06,LP10,LP11,LP19,LP20,LP26,LP31,LP32,LP38,LP43,LP51,LP52) values('" & pCRecNo & "'," & pPDFQty & ",'" & pJudge & "','" & stLP06 & "','" & stLP10 & "','" & stLP11 & "','" & stLP19 & "','" & stLP20 & "','" & stLP26 & "','" & stLP31 & "','" & IIf(pbolBulk, "Y", "") & "','" & stLP38 & "','" & IIf(pEngJudge, "Y", "") & "','" & stLP51 & "','" & IIf(pRegisteredMail, "Y", "") & "')"
   'end 2014/08/08
   'end 2014/12/17
   cnnConnection.Execute stSQL, intR
   
   pLP26 = stLP26 'Added by Morgan 2016/1/11
   
   'Added by Morgan 2014/12/31
   '+LP22=繪圖發後補看人員(有繪圖人員且判發人非72006)
   'Modified by Morgan 2016/3/3 改87025
   'Modify By Sindy 2019/12/19
   If stCP01 = "P" Or stCP01 = "CFP" Then
   '2019/12/19 END
      If pCP10 = "1101" Then
         stSQL = "update LetterProgress set LP22='87025' where lp01='" & pCRecNo & "' and exists(select * from caseprogress a,caseprogress b where a.cp09=lp01 and b.cp09(+)=a.cp43 and b.cp29<>'99999')" & _
         " and not exists(select * from caseprogress a,caseprogress b,empelectronprocess where a.cp09=lp01 and b.cp09(+)=a.cp43 and b.cp29<>'99999' and eep01(+)=b.cp09 and eep04(+)='13' and eep03='87025')"
         cnnConnection.Execute stSQL, intR
      End If
      'end 2014/12/31
   End If
   
   '抓收文號為本所案號的pdf檔(輸過來函又刪除的)
   If Left(pCRecNo, 1) = "C" Then
      stSQL = "update casepaperpdf set cpp01='" & pCRecNo & "',cpp10='Y' where cpp01=(select cp01||cp02||cp03||cp04 from caseprogress where cp09='" & pCRecNo & "') and cpp10='C'"
      cnnConnection.Execute stSQL, intR
   End If
   
   '檢查若沒有缺檔則更新齊備日,若有客戶函且為自行判發則一併上判發日
   'Modified by Morgan 2014/9/25
   'stSQL = "UPDATE letterprogress SET lp03=" & strSrvDate(1) & ",lp05=decode(lp04||lp10,'Y'," & strSrvDate(1) & ",lp05) WHERE lp01='" & pCRecNo & "' AND EXISTS(SELECT 1 FROM casepaperpdf WHERE cpp01=lp01 HAVING COUNT(*)=lp02)"
   'cnnConnection.Execute stSQL, intR
   'Modified by Morgan 2017/12/14 +判斷已發文才要更新(CFP報價定稿轉定稿才上發文)
   If stCP27 <> "" Then PUB_UpdateLP03 pCRecNo
   'end 2014/9/25
   
   If stLP10 = "Y" Then
      'Added by Morgan 2014/6/18
      '平信直寄不必確認自動上確認人員
      'Modified by Morgan 2015/9/1 +FMP案也自動確認
      'Modified by Morgan 2018/11/19 e化客戶上線後直寄改不寄紙本,由程序直接EMail,智權會收到副本所以也不必確認
      'Modify By Sindy 2019/11/5 T,大宗,非MCTF,直寄:不必確認自動上確認人員(Left(stCP01, 1) = "T" And pbolBulk = True And bolMCTF = False And stLP11 = "Y")
      'Modify By Sindy 2021/1/12 (stLP11 = "Y" And bolOrdinaryMail And bolMCTF = False) => (stLP11 = "Y" And bolOrdinaryMail)
      'Modified by Morgan 2021/4/1 改回全E化客戶直寄也要確認(保留停一天可抽信機制) - Or (strSrvDate(1) >= e化客戶啟用日 And stLP26 = "E" And stLP11 = "Y")
      'Modified by Morgan 2024/12/2 確認人改為QPGMR以識別為系統自動確認 strUserNum->QPGMR
      'Add By Sindy 2025/5/21 + Or bolFMT
      If bolFMP Or bolFMT Or _
         (stLP11 = "Y" And bolOrdinaryMail) Then
         stSQL = "update LetterProgress set lp06='QPGMR',lp07=to_char(sysdate,'YYYYMMDD') where lp01='" & pCRecNo & "'"
         cnnConnection.Execute stSQL, intR
      End If
      'end 2014/6/18
      
      
      'Added by Morgan 2025/7/24
      '寶齡富錦 Y55435 代理的案件年費發文或已提申都要印紙本
      bolNoCP127 = False
      If pFCAgent = "Y55435000" And ((pCP10 = "605" Or pCP10 = "606" Or pCP10 = "607") Or (pCP10 = "1909" And InStr("605,606,607", stRefCP10) > 0)) Then
         bolNoCP127 = True
      End If
      
      'Added by Morgan 2015/6/23
      'E化非直寄的上發文室發文
      'Modified by Morgan 2015/8/24 證書1603除外
      'Modified by Morgan 2015/8/27 +FMP案,發文規費改用變數判斷
      'Modified by Morgan 2015/10/12 +通知申請號 1101 除外
      'Modified by Morgan 2015/10/21 +判斷非直寄
      'Modified by Morgan 2016/11/7 +通知申請號 1101 只排除台灣案--玲玲 P115763
      'Modified by Morgan 2017/10/26 +核發1008也除外(原控制不E化,改不自動發文)
      'Modified by Morgan 2018/11/19 e化客戶上線後直寄改不寄紙本,由程序直接EMail
      'If bolFMP Or (stLP26 = "Y" And stLP11 <> "Y" And pCP10 <> "1603" And pCP10 <> "1008" And Not (stPA09 = "000" And pCP10 = "1101") And bolFee = False) Then
      'Modify By Sindy 2019/11/5 T,大宗:不必經過發文室
      '                          (Left(stCP01, 1) = "T" And pbolBulk = True)
      'Modified by Morgan 2020/2/17 +核准-專利權讓與除外(會有證書,Ex:P-123596)--潘韻丞
      'Modify By Sindy 2021/1/8 T商標MCTF的1701.註冊證要進發文室(E化非直寄的上發文室發文)
      'Modified by Morgan 2021/11/17 專利是否實體改判斷 stLP51,另商標先改非全E化非直寄的上發文(需再確認)
      'Modified by Morgan 2025/2/17 商標實體要紙本的規則同專利--桂英
      'If bolFMP Or _
         (Left(stCP01, 1) <> "T" And stLP26 <> "" And stLP11 <> "Y" And stLP51 <> "Y") Or _
         (Left(stCP01, 1) = "T" And stLP26 = "Y" And stLP11 <> "Y") Or _
         (stLP26 = "E" And stLP51 <> "Y") Or _
         (Left(stCP01, 1) = "T" And pbolBulk = True) Then
      'Modify By Sindy 2025/4/17 取消T大宗,原不必經發文室; 改跟內專一樣要經發文室
      '                          但MCT,大陸撤三維持 + And pRegisteredMail = False
      'Add By Sindy 2025/5/21 + Or bolFMT
      'Modified by Morgan 2025/7/24 + bolNoCP127 = False And
      If bolFMP Or bolFMT Or _
         (bolNoCP127 = False And stLP51 <> "Y" And stLP26 <> "" And (stLP11 <> "Y" Or stLP26 = "E")) Or _
         (Left(stCP01, 1) = "T" And pbolBulk = True And pRegisteredMail = False) Then
      'end 2021/11/17
'         'Add By Sindy 2020/11/11
'         If Left(stCP01, 1) = "T" And pbolBulk = True And bolFMP = False Then
'            If strSrvDate(1) >= T商標電子化第2階段啟用日 And stLP11 <> "Y" Then
'               GoTo ExitEnd '給智權人員確認,先不上發文
'            End If
'         End If
'         '2020/11/11 END
         
         'Modify By Sindy 2021/1/8 取消更新cp28 => cp28=cp09,
         'Modify By Sindy 2024/7/11 有發文日且為未來日期者,發文室發文日=發文日,發文室發文時間=0
         If Val(stCP27) > Val(strSrvDate(1)) Then
            stSQL = "update caseprogress set cp127='" & stCP27 & "',cp128=0 where cp09='" & pCRecNo & "'"
         Else
         '2024/7/11 END
            stSQL = "update caseprogress set cp127=to_char(sysdate,'YYYYMMDD'),cp128=to_char(sysdate,'HH24MISS') where cp09='" & pCRecNo & "'"
         End If
         cnnConnection.Execute stSQL, intR
         If intR = 1 Then
            'Trigger 會寫發文人故要另外更新
            stSQL = "update caseprogress set cp154='QPGMR' where cp09='" & pCRecNo & "'"
            cnnConnection.Execute stSQL, intR
         End If
         
'ExitEnd: 'Add By Sindy 2020/11/11
      End If
      
      'Added by Morgan 2023/7/24
      'FMP案A類發文有客戶函時要EMail通知承辦(智權人員)
      If bolFMP And pCRecNo < "B" Then
         Call ClsPDGetCaseProperty(stCP01, pCP10, stCP10N, True)
         stSubj = stCP01 & "-" & stCP02 & IIf(stCP03 & stCP04 = "000", "", "-" & stCP03 & "-" & stCP04)
         stSubj = stSubj & "專利乙案，業於" & TranslateKeyWord(incCNV_CHINESE_CUN1, stCP27, "") & "寄交中國大陸代理人，委託其代為提出" & stCP10N & "。"
         stTO = PUB_GetFCPSalesNo(stCP01, stCP02, stCP03, stCP04, pCP10)
         stSQL = "insert into MailCache(MC01,MC02,MC03,MC04,MC07,MC08)" & _
            " values ('" & strUserNum & "','" & stTO & "',to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss'),'" & stSubj & "','如旨')"
         cnnConnection.Execute stSQL, intR
      End If
      'end 2023/7/24
   End If
   'end 2015/6/23
   
   Set rsQuery = Nothing
End Sub

'Added by Morgan 2022/11/11
'E化無實體自動發文室發文
Public Sub PUB_ECaseAuotPost(pLP01 As String, pCP01 As String)
   Dim stSQL As String, intR As Integer
   Dim rsQuery As ADODB.Recordset
   
   If pCP01 <> "" And pCP01 <> "P" And pCP01 <> "CFP" Then Exit Sub
   
   stSQL = "select * from letterprogress,caseprogress where lp01='" & pLP01 & "' and cp09(+)=lp01"
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      With rsQuery
      'E化無實體+(全E化or非直寄)自動發文室發文
      If "" & .Fields("lp26") <> "" And "" & .Fields("lp51") <> "Y" And _
         (.Fields("lp26") = "E" Or "" & .Fields("lp11") <> "Y") Then
         stSQL = "update caseprogress set cp127=to_char(sysdate,'YYYYMMDD'),cp128=to_char(sysdate,'HH24MISS') where cp09='" & pLP01 & "' and nvl(cp127,0)=0"
         cnnConnection.Execute stSQL, intR
         If intR = 1 Then
            'Trigger 會寫發文人故要另外更新
            stSQL = "update caseprogress set cp154='QPGMR' where cp09='" & pLP01 & "'"
            cnnConnection.Execute stSQL, intR
         End If
      '取消發文室發文
      ElseIf .Fields("cp154") = "QPGMR" Then
         stSQL = "update caseprogress set cp154=null,cp127=null,cp128=null where cp09='" & pLP01 & "'"
         cnnConnection.Execute stSQL, intR
      End If
      End With
   End If
   
EXITSUB:
   Set rsQuery = Nothing
End Sub

'Added by Morgan 2021/11/19
'是否電子證書
Public Function PUB_IsECertificate(pNA01 As String, pSys As String, Optional pKind As String) As Boolean
   Dim strSql As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   
   strSql = "select sk02,NA87,NA88 from nation,SYSTEMKIND where na01='" & pNA01 & "' and sk01='" & pSys & "'"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, strSql)
   If intQ = 1 Then
      With rsQuery
      '專利(要判斷專利種類)
      If .Fields("sk02") = "1" Then
         If InStr("" & .Fields("NA87"), pKind) > 0 Then
            PUB_IsECertificate = True
         End If
      '商標
      ElseIf .Fields("sk02") = "2" Then
         If "" & .Fields("NA87") = "Y" Then
            PUB_IsECertificate = True
         End If
      End If
      End With
   End If
End Function

'Added by Morgan 2014/12/15 自 PUB_AddLetterProgress 移來
'是否可直寄
'Modify By Sindy 2021/3/18 Optional ByRef pbolAddrIsNull As Boolean = False : 地址是否為空的
Public Function PUB_SetLP11(ByVal pCustNum As String, ByVal pAgentNum As String, _
   Optional ByRef pLP31 As String, Optional ByRef pbolAddrIsNull As Boolean = False) As String
   
   Dim stAddress As String 'Added by Morgan 2014/7/14
   Dim salesArea As String, salesNo As String 'Added by Morgan 2015/10/8
   
   'Added by Morgan 2021/6/9
   'Modified by Morgan 2021/11/16 有值才要補9碼
   If pCustNum <> "" Then pCustNum = Left(pCustNum & "000", 9)
   If pAgentNum <> "" Then pAgentNum = Left(pAgentNum & "000", 9)
   'end 2021/11/16
   'end 2021/6/9

   
   'Added by Morgan 2014/7/22 +FC案件
   'Modified by Morgan 2015/10/8 大對台案件改參考 PUB_CheckCuNation
   'If pAgentNum <> "" Then
   '   PUB_SetLP11 = "Y"
   pLP31 = ""
   pbolAddrIsNull = False 'Add By Sindy 2021/3/18
   
   salesArea = GetCuSales(pCustNum, salesNo)
   
'Modified by Morgan 2024/10/23 79075客戶，不論是否有代理人，都不直寄--郭
'   If (salesNo = "79075" And pAgentNum <> "") Or salesNo = "96031" Or salesNo = "96032" Then
'      pLP31 = "Y"
'      If pAgentNum <> "" Then
'         'Modified by Morgan 2018/1/10 Y30953,Y52512 不直寄(E化)--郭
'         'PUB_SetLP11 = "Y"
'         'Modified by Morgan 2018/10/16 不直寄+Y53842--郭
'         'Modified by Morgan 2018/11/2 不直寄+Y53374北京寰華--郭
'         'Modified by Morgan 2018/11/19 不直寄+Y54456--郭
'         'Modified by Morgan 2019/7/19 不直寄+Y54925--玲玲
'         'Modified by Morgan 2019/9/5 不直寄+Y5301200--郭
'         'Modified by Morgan 2019/9/5 不直寄+Y5550400--郭
'         'Modified by Morgan 2021/6/1 不直寄+Y5523100--郭
'         'Modified by Morgan 2021/6/10 不直寄+Y5534500,Y5534501--郭
'         'modify by sonia 2021/9/9 +Y53779,Y52537--郭
'         'Modified by Morgan 2021/9/29 +Y54691 北京匯思誠業及 Y31435 貿促會--郭
'         'Modified by Morgan 2022/3/30 +Y52404 上海唯源,Y5245902 萬慧達,Y53288 北京超凡,Y21399 永新,Y53751 成都希盛,Y50516 北京集佳,Y5372901 北京旭知行--韻丞
'         'Modified by Morgan 2022/4/1 +Y4577601 北京金信立方--韻丞
'         'Modified by Morgan 2022/4/13 +Y52749,Y5170203--韻丞
'         'Modified by Morgan 2022/4/21 +Y52754 北京律誠,Y55428 江蘇聖典,Y55531 北京惠利爾--韻丞
'         'Modified by Morgan 2022/5/31 +Y54527,Y5372901,Y5364102,Y52749,Y53195--韻丞
'         'Modified by Morgan 2022/6/8 +Y55342--韻丞
'         'Modified by Morgan 2022/8/9 +Y5245902,Y55583,Y5372901,Y2139902,Y55342--韻丞
'         'Modified by Morgan 2022/9/23 +Y52459,Y55791--韻丞
'         'Modified by Morgan 2022/11/11 +Y53839廣州聯瑞--韻丞
'         'Modified by Morgan 2023/2/4 +Y5584300 東方億思--韻丞
'         'Modified by Morgan 2023/2/4 +Y51566上海建毅--韻丞
'         'Modified by Morgan 2023/5/2 +Y55466 廈門龍格思匯--韻丞
'         'Modified by Morgan 2023/7/11 +Y55347 浙江數問,Y55782 北京智信禾--韻丞
'         'Modified by Morgan 2023/11/15 +Y5446801 南通商專知識產權事務有限公司,Y52692 濟南舜源天鴻知識產權代理有限公司,Y54926 廣州維智林專利代理事務所--韻丞
'         'Modified by Morgan 2023/12/27 +Y40717中科 --韻丞
'         'Modified by Morgan 2024/4/15 +Y55428 國浩律師(南京)事務所科 --韻丞
'         'Modified by Morgan 2024/7/8 +Y5328801 超凡明遠知識產權代理有限公司 --韻丞
'         'Modified by Morgan 2024/7/26 +Y5556101 北京市安倫律師事務所 --韻丞
'         'Modified by Morgan 2024/8/20 +Y5605900 北京盛詢知識產權代理有限公司 --韻丞
'         'Modified by Morgan 2024/9/20 +Y5204401 上海東創  --韻丞
'         If Not (salesNo = "79075" And InStr("Y3095300,Y5251200,Y5384200,Y5337400,Y5445600,Y5492500,Y5301200,Y5550400,Y5523100,Y5534500,Y5534501,Y5377900,Y5253700,Y5469100,Y3143500,Y5240400,Y5245902,Y5328800,Y2139900,Y5375100,Y5051600,Y5372901,Y4577601,Y5274900,Y5170203,Y5275400,Y5275400,Y5553100,Y5452700,Y5372901,Y5364102,Y5274900,Y5319500,Y5534200,Y5558300,Y5372901,Y2139902,Y5534200,Y5245900,Y5579100,Y5383900,Y5584300,Y5156600,Y5546600,Y5534700,Y5578200,Y5446801,Y5269200,Y5492600,Y4071700,Y5542800,Y5328801,Y5556101,Y5605900,Y5204401", Left(pAgentNum, 8)) > 0) Then
'            PUB_SetLP11 = "Y"
'         End If
'         'end 2018/1/10
'      End If
   If salesNo = "79075" Then
      If pAgentNum <> "" Then pLP31 = "Y"
      PUB_SetLP11 = ""
      
   ElseIf salesNo = "96031" Or salesNo = "96032" Then
      pLP31 = "Y"
      PUB_SetLP11 = "Y"
'end 2024/10/23

      'end 2018/1/10
   'end 2015/10/8
   'Modified by Morgan 2014/7/14 要判斷會印地址的
   ElseIf PUB_GetAddrRef(pCustNum, , , , , , , , stAddress) = True Then
      If stAddress <> "" Then
         PUB_SetLP11 = "Y"
      Else
         pbolAddrIsNull = True 'Add By Sindy 2021/3/18 地址空的
      End If
   End If
   'end 2014/7/14
   
   'Added by Morgan 2019/9/24 和碩公司無紙化,除了實體專利證書等外均以EMAIL通知--郭雅娟
   'Modified by Morgan 2020/12/3 +X83531,X83534 -- 潘韻丞,郭雅娟
   'Modified by Morgan 2021/6/4 +X83843 溢泰(南京)環保科技有限公司,X79602 北京強新生物科技有限公司,X79603 強新科技研究院 --郭雅娟
   'Modified by Morgan 2021/12/22 +X8002701 寧波盧米藍新材料有限公司 --郭雅娟
   'Modified by Morgan 2022/8/9 X8384301,X86352--韻丞
   'Modified by Morgan 2023/3/3 X87145--韻丞
   If (Left(pCustNum, 8) >= "X7001700" And Left(pCustNum, 8) <= "X7001703") Or _
      InStr("X8353100,X8353400,X8384300,X7960200,X7960300,X8002701,X8384301,X8635200,X8714500", Left(pCustNum, 8)) > 0 Then
      PUB_SetLP11 = ""
   End If
   'end 2019/9/24
   
   'Add By Sindy 2021/1/20 MCTF不管申請人地址狀況,因寄大陸代理人
   If salesNo <> "" Then
      '巨京也是走MCTF流程
      If Left(salesNo, 4) = "MCTF" Or salesNo = "96029" Or salesNo = "96030" Then
         pLP31 = "Y"
         PUB_SetLP11 = "Y"
      End If
   End If
   '2019/10/23 END
End Function

'Removed by Morgan 2018/8/1 取消,改用PUB_GetLetterJudgeNew
''Added by Morgan 2014/4/11
''Modify by Morgan 2016/6/7 +pCountry:申請國家
''Modify by Morgan 2016/7/6 +pPA01,pPA02,pPA03,pPA04:本所案號
''客戶函判發人
'Public Function PUB_GetLetterJudge(pSys As String, pProperty As String, Optional pRefProperty As String, Optional pCountry As String = "000", Optional pPA01 As String, Optional pPA02 As String, Optional pPA03 As String, Optional pPA04 As String) As String
'   Dim stSQL As String, intR As Integer
'   Dim rsQuery As ADODB.Recordset
'   Dim bolFMP As Boolean
'   Dim stJudge As String
'
'   If pCountry = "000" Then
'      'P核准(1001):相關收文號案件性質為5,8開頭(救濟,爭議程序)或421者抓判發人，其他自行判發
'      'Modified by Lydia 2015/10/05 + 1008
'      If pSys = "P" And (pProperty = "1001" Or pProperty = "1008") Then
'         If Not (pRefProperty = "421" Or Left(pRefProperty, 1) = "5" Or Left(pRefProperty, 1) = "8") Then
'            GoTo ExitFlag
'         End If
'      End If
'
''Removed by Morgan 2018/7/26 取消--郭
''      'Added by Morgan 2017/5/10 品薇處理的台灣案之專利證書(1603)及消滅函(1604)的判發人設定為韻丞(A2027)--郭
''      If strUserNum = "98012" And pSys = "P" And (pProperty = "1603" Or pProperty = "1604") Then
''         PUB_GetLetterJudge = "A2027"
''         GoTo ExitFlag
''      End If
''      'end 2017/5/10
''end 2018/7/26
'
'      stSQL = "select cpm30 from casepropertymap where cpm01='" & pSys & "' and cpm02='" & pProperty & "' and cpm30 is not null"
'      intR = 1
'      Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
'      If intR = 1 Then
'         If rsQuery(0) <> strUserNum Then
'            PUB_GetLetterJudge = rsQuery(0)
'         End If
'      End If
'   'Add by Morgan 2016/6/7
'   '非臺灣案
'   Else
'      If pSys = "P" Then
'         'Added by Morgan 2016/7/14
'         stSQL = "select cp12 from caseprogress where cp01='" & pPA01 & "' and cp02='" & pPA02 & "' and cp03='" & pPA03 & "' and cp04='" & pPA04 & "' order by cp05 desc,cp09"
'         intR = 1
'         Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
'         If intR = 1 Then
'            If Left("" & rsQuery(0), 1) = "F" Then
'               bolFMP = True
'            End If
'         End If
'
'         'end 2016/7/14
'
'         'Added by Morgan 2016/7/6 PCT案都給郭判發, FMP案維持紙本作業都不用在系統判發--郭
'         If bolFMP Then
'            PUB_GetLetterJudge = ""
'         'Modified by Morgan 2016/8/1 改照一般規則--玲玲,郭
'         'ElseIf pCountry = "056" Then
'         '   PUB_GetLetterJudge = Pub_GetSpecMan("PS5")
'         Else
'         'end 2016/7/6
'            'Modified by Morgan 2016/6/28
'            Select Case pProperty
'               '核准
'               Case "1001"
'                  'Added by Morgan 2016/8/11
'                  '107復審,503行政訴訟...等交游經理判發--玲玲
'                  If InStr("107,503,506,507,508,803,804", pRefProperty) > 0 Then
'                     stJudge = Pub_GetSpecMan("PS7")
'                  ''新案(郭)
'                  ElseIf InStr(NewCasePtyList, pRefProperty) > 0 Then
'                     stJudge = Pub_GetSpecMan("PS5")
'                  '非新案(自判,品薇->玲)
'                  ElseIf strUserNum = "98012" Then
'                     stJudge = Pub_GetSpecMan("PS6")
'                  End If
'               '核駁...
'               'Modified by Morgan 2016/8/11 +1301,1302,1402 --玲玲
'               Case "1002", "1201", "1202", "1231", "1301", "1302", "1307", "1401", "1402", "1503", "1505", "1802"
'                  stJudge = Pub_GetSpecMan("PS7")
'
'               '專利權消滅
'               Case "1604"
'                  stJudge = Pub_GetSpecMan("PS5")
'
'               'Added by Morgan 2016/7/25 判發人比照台灣案 Ex.P-104010 --韻丞
'               '通知放棄專利權(一案兩請發明核准)
'               Case "1914"
'                  stSQL = "select cpm30 from casepropertymap where cpm01='" & pSys & "' and cpm02='" & pProperty & "' and cpm30 is not null"
'                  intR = 1
'                  Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
'                  If intR = 1 Then
'                     If rsQuery(0) <> strUserNum Then
'                        stJudge = rsQuery(0)
'                     End If
'                  End If
'               'end 2016/7/25
'
'               '自行判發
'               Case Else
'                  If strUserNum = "98012" Then
'                     'Modified by Morgan 2017/10/17 改除特定的來函外其他(含AB類發文)都改自行判發--郭
'                     'If pProperty <> "1224" Then
'                     If Len(pProperty) = 4 And InStr("1204,1207,1213,1214,1215,1224,1605", pProperty) = 0 Then
'                        stJudge = Pub_GetSpecMan("PS6")
'                     End If
'                  End If
'            End Select
'            'end 2016/6/28
'            'Modified by Morgan 2018/5/2 自行判發不用設
'            'PUB_GetLetterJudge = stJudge
'            If strUserNum <> stJudge Then
'               PUB_GetLetterJudge = stJudge
'            End If
'            'end 2018/5/2
'         End If 'Added by Morgan 2016/7/6
'      End If
'   'end 2016/6/7
'   End If
'
'ExitFlag:
'   Set rsQuery = Nothing
'End Function

'Added by Morgan 2014/11/17
'Modify By Sindy 2020/12/28 + pstrCP09 As String : 該筆文號
Private Function CheckMultiNoOrder(pCP01 As String, pCP02 As String, pCP03 As String, pCP04 As String, _
   pCP05 As String, pCP156 As String, pCP09CopyList As String, pCP10CopyList As String, _
   pstrCP09 As String) As Boolean
   
   Dim stSQL As String, intR As Integer
   Dim rsQuery As ADODB.Recordset
   
   pCP09CopyList = ""
   pCP10CopyList = ""
   
   'Modified by Morgan 2015/1/12 要排除有刪除註記的
   'Modified by Morgan 2015/2/25 取消未發文限制 Ex.P110111 補收款
   'Modify By Sindy 2020/12/28 + ,cp14
   stSQL = "select cp09,cp10,cp14 from caseprogress where cp01='" & pCP01 & "' and cp02='" & pCP02 & "' and cp03='" & pCP03 & "' and cp04='" & pCP04 & "' and cp05=" & pCP05 & " and cp09<'B' and cp57 is null and cp156=" & Val(pCP156) & _
      " and NOT exists(select * from casepaperpdf where cpp01=cp09 and cpp10<>'D' and instr(upper(cpp02),'.ORDER.PDF')>0)"
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      With rsQuery
      If .RecordCount = Val(pCP156) Then
'         Do While Not .EOF
'            pCP09CopyList = pCP09CopyList & "," & .Fields("cp09")
'            pCP10CopyList = pCP10CopyList & "," & .Fields("cp10")
'            .MoveNext
'         Loop
'         CheckMultiNoOrder = True
         'Modify By Sindy 2020/12/28 該筆文號未分案,其它文號均要分案完畢
         '   多文號時, 最後一筆分案才吸入接洽單電子檔
         Do While Not .EOF
            If "" & .Fields("cp14") <> "" Or .Fields("cp09") = pstrCP09 Then
               pCP09CopyList = pCP09CopyList & "," & .Fields("cp09")
               pCP10CopyList = pCP10CopyList & "," & .Fields("cp10")
            Else
               pCP09CopyList = ""
               pCP10CopyList = ""
               Exit Do
            End If
            '2020/12/28 END
            .MoveNext
         Loop
         CheckMultiNoOrder = True
      End If
      End With
   End If
   Set rsQuery = Nothing
End Function
'end 2014/11/17

'Added by Morgan 2014/11/18
Private Function SaveMultiNoOrder(pFileName As String, pCP09CopyList As String, pCP10CopyList As String, pExtFileName As String, pImpFile As String, pModifyDate As Double, pModifyTime As Double) As Boolean
   Dim ArrCP09() As String, arrCP10() As String
   Dim strFileName As String, ii As Integer
   
   cnnConnection.BeginTrans
   
On Error GoTo ErrHnd

   If pCP09CopyList <> "" Then
   
      ArrCP09() = Split(pCP09CopyList, ",")
      arrCP10() = Split(pCP10CopyList, ",")
      For ii = LBound(ArrCP09) To UBound(ArrCP09)
         If ArrCP09(ii) <> "" Then
            strFileName = pFileName & "." & arrCP10(ii) & pExtFileName
            'Modify By Sindy 2015/5/14
            'If SaveAttFile_PDF(arrCP09(ii), pImpFile, strFileName, pModifyDate, pModifyTime, False, "4") = False Then
            If SaveAttFile_PDF(ArrCP09(ii), pImpFile, strFileName, pModifyDate, pModifyTime, False) = False Then
            '2015/5/14 END
               GoTo ErrHnd
            End If
         End If
      Next
   End If
                          
   cnnConnection.CommitTrans
   SaveMultiNoOrder = True
   Exit Function
   
ErrHnd:
   cnnConnection.RollbackTrans
   
End Function
'end 2014/11/18

'Added by Morgan 2014/11/26
'以本所案號檢查該案所有A類已分案程序是否有缺接洽單
Public Function PUB_CheckPDF3(pCP01 As String, pCP02 As String, pCP03 As String, pCP04 As String) As Boolean
   Dim stSQL As String, intR As Integer
   Dim rsQuery As ADODB.Recordset
   Dim strFolder As String, strCon As String
   Dim oFileSys As New FileSystemObject
   Dim oFolder As Folder
   Dim oFiles As files
   Dim oFile
   Dim strFileName As String, strExtFileName As String
   Dim bolOK As Boolean
   Dim stMsg As String
   Dim strCP02 As String, strCP03 As String, strCP04 As String
   
   'Modify By Sindy 2022/10/25
   'strFolder = "\\Pat1\Order_SCAN"
   strFolder = str_P_OrderPath
   '2022/10/25 END
   
   'Added by Morgan 2016/9/7
   '測試抓桌面的相同資料夾以免誤刪真實檔案
   If UCase(pub_DbTerminalName) <> 正式資料庫電腦名稱 Then
      strFolder = PUB_Getdesktop & "\" & Mid(strFolder, InStrRev(strFolder, "\") + 1)
   End If
   'end 2016/9/7
   strExtFileName = ".ORDER.PDF"
   stMsg = ""
   
   'Modified by Morgan 2016/6/29 +判斷非臺灣案件性質
   'stSQL = "select cp09,cp10,cpm03 from caseprogress,casepropertymap where cp01='" & pCP01 & "' and cp02='" & pCP02 & "' and cp03='" & pCP03 & "' and cp04='" & pCP04 & "' and cp09<'B' and cp14 is not null" & _
      " and cp27||cp57 is null and not exists(select 1 from casepaperpdf where cpp01=cp09 and cpp10<>'D' and (instr(lower(cpp02),'.'||cp10||'.order.pdf')>0 or instr(lower(cpp02),'.'||cp10||'.order.menu')>0))" & _
      " and cpm01(+)=cp01 and cpm02(+)=cp10"
   stSQL = "select cp09,cp10,decode(pa09,'000',cpm03,cpm04) cpm03 from caseprogress,casepropertymap,patent where cp01='" & pCP01 & "' and cp02='" & pCP02 & "' and cp03='" & pCP03 & "' and cp04='" & pCP04 & "' and cp09<'B' and cp14 is not null" & _
      " and cp27||cp57 is null and not exists(select 1 from casepaperpdf where cpp01=cp09 and cpp10<>'D' and (instr(lower(cpp02),'.'||cp10||'.order.pdf')>0 or instr(lower(cpp02),'.'||cp10||'.order.menu')>0))" & _
      " and cpm01(+)=cp01 and cpm02(+)=cp10 and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04"
   'end by Morgan 2016/6/29

   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      With rsQuery
      Do While Not .EOF
         bolOK = False
         If Dir(strFolder & "\*.pdf") <> "" Then
            Set oFolder = oFileSys.GetFolder(strFolder)
            Set oFiles = oFolder.files
            For Each oFile In oFiles
               If UCase(Right(oFile.Name, 4)) = ".PDF" Then
                  If InStr(oFile.Name, pCP01) = 1 Then
                     If PUB_GetCaseNoFromFileName(oFile.Name, pCP01, strCP02, strCP03, strCP04) = True Then
                        If strCP02 = pCP02 And strCP03 = pCP03 And strCP04 = pCP04 Then
                           If Mid(oFile.Name, InStr(oFile.Name, ".") + 1) = .Fields("cp10") & ".pdf" Then
                              'Modified by Morgan 2015/1/26 本所號的追加聯合碼改各自判斷 Ex.P123456-1,P123456-0-01
                              'Modify By Sindy 2022/5/6 Val(pCP02) ==> pCP02
                              strFileName = pCP01 & pCP02 & IIf(pCP04 <> "000", "-" & pCP03 & "-" & pCP04, IIf(pCP03 <> "0", "-" & pCP03, ""))
                              strFileName = strFileName & "." & .Fields("cp10") & strExtFileName
                              'Modify By Sindy 2015/5/14
                              'BolOk = SaveAttFile_PDF(.Fields("cp09"), oFile.path, strFileName, Format(oFile.DateLastModified, "YYYYMMDD"), Format(oFile.DateLastModified, "HHMMSS"), False, "4")
                              bolOK = SaveAttFile_PDF(.Fields("cp09"), oFile.path, strFileName, Format(oFile.DateLastModified, "YYYYMMDD"), Format(oFile.DateLastModified, "HHMMSS"), False)
                              '2015/5/14 END
                              If bolOK Then oFile.Delete True
                              Exit For
                           End If
                        End If
                     End If
                  End If
               End If
            Next
         End If
         
         If Not bolOK Then
            stMsg = stMsg & vbCrLf & .Fields("cpm03") & " (" & .Fields("cp09") & ")"
         End If
         
         .MoveNext
      Loop
      End With
   End If
   
   If stMsg <> "" Then
      '考慮可能同時發文其他案件性質情形(如 超頁費、超項費、延緩公告...)，接洽單要都掃描才不會漏
      MsgBox "本案下列程序尚缺接洽單，請先掃描上傳卷宗區後再發文！" & vbCrLf & stMsg, vbExclamation
   Else
      PUB_CheckPDF3 = True
   End If
   
   Set rsQuery = Nothing
   Set oFileSys = Nothing
   Set oFolder = Nothing
   Set oFiles = Nothing
   Set oFile = Nothing
End Function

'Added by Morgan 2016/7/6
'檢查代理人已收達檔案
'Modified by Morgan 2016/7/22 +pCP10
Public Function PUB_CheckAck(pCP09 As String, pCP01 As String, pCP02 As String, pCP03 As String, pCP04 As String, pCP10 As String, Optional pSilence As Boolean = False) As Boolean
   Dim stSQL As String, intQ As Integer, rsQuery As ADODB.Recordset
   Dim strFolder As String
   Dim oFileSys As New FileSystemObject
   Dim oFolder As Folder
   Dim oFiles As files
   Dim oFile
   Dim strCP02 As String, strCP03 As String, strCP04 As String
   Dim strSaveName As String, strErr As String
   
   '檢查卷宗區
   'Modified by Morgan 2017/10/18 +可放 MSG 格式
   'stSQL = "select cpp02 from casepaperpdf where cpp01='" & pCP09 & "' and cpp10<>'D' and substr(upper(cpp02),-4)='.PDF'and instr(upper(cpp02),'.ACK.')>0"
   stSQL = "select cpp02 from casepaperpdf where cpp01='" & pCP09 & "' and cpp10<>'D' and (substr(upper(cpp02),-4)='.PDF' or substr(upper(cpp02),-4)='.MSG') and instr(upper(cpp02),'.ACK.')>0"
   'end 2017/10/18
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      PUB_CheckAck = True
   Else
      strFolder = Pub_GetSpecMan("PathAckP")
      '測試抓桌面的相同資料夾以免誤刪真實檔案
      If pub_DbTerminalName <> 正式資料庫電腦名稱 Then
         strFolder = PUB_Getdesktop & "\" & Mid(strFolder, InStrRev(strFolder, "\") + 1)
      End If
      If strFolder <> "" Then
         If Dir(strFolder & "\*.pdf") <> "" Then
            Set oFolder = oFileSys.GetFolder(strFolder)
            Set oFiles = oFolder.files
            For Each oFile In oFiles
               If UCase(Right(oFile.Name, 4)) = ".PDF" And InStr(oFile.Name, pCP01) = 1 Then
                  If PUB_GetCaseNoFromFileName(oFile.Name, pCP01, strCP02, strCP03, strCP04) = True Then
                     If strCP02 = pCP02 And strCP03 = pCP03 And strCP04 = pCP04 Then
                        strSaveName = PUB_CaseNo2FileName(pCP01, strCP02, strCP03, strCP04) & "." & pCP10 & ".ACK.PDF"
                        If SaveAttFile_PDF(pCP09, oFile.path, strSaveName, Format(oFile.DateLastModified, "YYYYMMDD"), Format(oFile.DateLastModified, "HHMMSS"), False) Then
                           oFile.Delete True
                           PUB_CheckAck = True
                        ElseIf Not pSilence Then
                           MsgBox "代理人已收達電子檔(ACK)上傳失敗:" & vbCrLf & vbCrLf & strErr, vbCritical
                        End If
                        Exit For
                     End If
                  End If
               End If
            Next
         End If
      End If
   End If

   Set oFileSys = Nothing
   Set oFolder = Nothing
   Set oFiles = Nothing
   Set oFile = Nothing
   Set rsQuery = Nothing
End Function

'Added by Morgan 2016/7/22
'檢查代理人來函檔案
Public Function PUB_CheckAltr(pCP01 As String, pCP02 As String, pCP03 As String, pCP04 As String, pCP10 As String, Optional pSilence As Boolean = False) As Boolean
   Dim stSQL As String, intQ As Integer, rsQuery As ADODB.Recordset
   Dim strFolder As String
   Dim oFileSys As New FileSystemObject
   Dim oFolder As Folder
   Dim oFiles As files
   Dim oFile
   Dim strCP02 As String, strCP03 As String, strCP04 As String
   Dim strSaveName As String, strErr As String
   
   '檢查卷宗區
   'Modified by Morgan 2017/10/18 +可放 MSG 格式
   'stSQL = "select cpp02 from casepaperpdf where cpp01='" & pCP01 & pCP02 & pCP03 & pCP04 & "' and cpp10<>'D' and substr(upper(cpp02),-4)='.PDF'and instr(upper(cpp02),'.ALTR.')>0"
   stSQL = "select cpp02 from casepaperpdf where cpp01='" & pCP01 & pCP02 & pCP03 & pCP04 & "' and cpp10<>'D' and (substr(upper(cpp02),-4)='.PDF' or substr(upper(cpp02),-4)='.MSG') and instr(upper(cpp02),'.ALTR.')>0"
   'end 2017/10/18
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      PUB_CheckAltr = True
   Else
      strFolder = Pub_GetSpecMan("PathAltrP")
      '測試抓桌面的相同資料夾以免誤刪真實檔案
      If UCase(pub_DbTerminalName) <> 正式資料庫電腦名稱 Then
         strFolder = PUB_Getdesktop & "\" & Mid(strFolder, InStrRev(strFolder, "\") + 1)
      End If
      If strFolder <> "" Then
         If Dir(strFolder & "\*.pdf") <> "" Then
            Set oFolder = oFileSys.GetFolder(strFolder)
            Set oFiles = oFolder.files
            For Each oFile In oFiles
               If UCase(Right(oFile.Name, 9)) = ".ALTR.PDF" And InStr(oFile.Name, pCP01) = 1 Then
                  If PUB_GetCaseNoFromFileName(oFile.Name, pCP01, strCP02, strCP03, strCP04) = True Then
                     If strCP02 = pCP02 And strCP03 = pCP03 And strCP04 = pCP04 Then
                        strSaveName = PUB_CaseNo2FileName(pCP01, strCP02, strCP03, strCP04) & "." & pCP10 & ".ALTR.PDF"
                        If SaveAttFile_PDF(pCP01 & pCP02 & pCP03 & pCP04, oFile.path, strSaveName, Format(oFile.DateLastModified, "YYYYMMDD"), Format(oFile.DateLastModified, "HHMMSS"), False, , "C") Then
                           oFile.Delete True
                           PUB_CheckAltr = True
                        ElseIf Not pSilence Then
                           MsgBox "代理人來函電子檔(ALTR)上傳失敗:" & vbCrLf & vbCrLf & strErr, vbCritical
                        End If
                        Exit For
                     End If
                  End If
               End If
            Next
         End If
      End If
   End If

   Set oFileSys = Nothing
   Set oFolder = Nothing
   Set oFiles = Nothing
   Set oFile = Nothing
   Set rsQuery = Nothing
End Function

'Added by Morgan 2014/10/1
'Modified by Morgan 2014/11/25 +pCP10
'發文/通知申請號 檢查卷宗區或匯入區是否有接洽單/申請書pdf檔
'pCP09:收文號, pType:檢查類別(0=接洽單,1=申請書), pImport:是否匯入(True=是, False=否), pImpFile:待匯入檔名, pCP10:案件性質碼, pChkFolderOnly:只檢查匯入區
'Modify By Sindy 2020/12/28 Optional ByRef bolHadPoMsg As Boolean = False : 已彈訊息
Public Function PUB_CheckPDF2(pCP09 As String, Optional pType As Integer = 0, Optional pImport As Boolean = False, _
   Optional ByRef pImpFile As String, Optional pCP10 As String, Optional pChkFolderOnly As Boolean = False, _
   Optional ByRef bolHadPoMsg As Boolean = False) As Boolean
   
   Dim stSQL As String, intR As Integer
   Dim rsQuery As ADODB.Recordset
   Dim strFolder As String, strCon As String
   Dim strCP01 As String, strCP02 As String, strCP03 As String, strCP04 As String
   Dim oFileSys As New FileSystemObject
   Dim oFolder As Folder
   Dim oFiles As files
   Dim oFile
   Dim strFileName As String, strExtFileName As String
   Dim bolOK As Boolean, strNum As String
   Dim strCP09List As String, strCP10List As String
   Dim stCP10 As String 'Added by Morgan 2015/3/23
   Dim m_SysType As String, strSK02 As String 'Add By Sindy 2019/7/19
   Dim bolFMP As Boolean 'Added by Morgan 2012/8/18
   
   bolHadPoMsg = False
   'Add By Sindy 2019/7/19 取得屬於何系統
   m_SysType = "P"
   'Modified by Morgan 2021/8/18 +cp12 以便判斷是否FMP案
   stSQL = "select cp01,cp12 from caseprogress where cp09='" & pCP09 & "'"
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      strCP01 = rsQuery.Fields("cp01")
      'Added by Morgan 2021/8/18
      If strCP01 = "P" And Left(rsQuery.Fields("cp12"), 1) = "F" Then
         bolFMP = True
      End If
      'end 2021/8/18
      'Modify By Sindy 2020/12/17
      strSK02 = CheckSys(strCP01, 1)
      If Left(strSK02, 1) = "2" Or Left(strSK02, 1) = "6" Then
         If Mid(strSK02, 2) = "0" Then
            m_SysType = "T"
         Else
            If strCP01 = "FCT" And Left(Pub_StrUserSt03, 2) = "P2" Then
               m_SysType = "T"
            Else
               m_SysType = "FCT"
            End If
         End If
      '2020/12/17 END
      'Modif by Amy 2021/07/12 +ACS
      ElseIf strCP01 = "ACS" Then
         m_SysType = "ACS"
      End If
   End If
   '2019/7/19 END
   
   stCP10 = pCP10 'Added by Morgan 2015/3/23
   pImpFile = ""
   '接洽單
   If pType = 0 Then
      'Modify By Sindy 2022/10/25
'      'Modify By Sindy 2019/7/19
'      If m_SysType = "T" Then
'         strFolder = "\\SALE1\tm_order_scan"
'      'Modify By Sindy 2020/12/18
'      ElseIf m_SysType = "FCT" Then
'         strFolder = "\\SALE1\FCT_Order_SCAN"
'      'Modify by Amy 2021/07/12
'      ElseIf m_SysType = "ACS" Then
'        strFolder = "\\SALE1\ACS01_Order_SCAN"
'      Else
'         strFolder = "\\Pat1\Order_SCAN"
'      End If
      'Modify By Sindy 2019/7/19
      If m_SysType = "T" Then
         strFolder = str_T_OrderPath
      'Modify By Sindy 2020/12/18
      ElseIf m_SysType = "FCT" Then
         strFolder = str_FCT_OrderPath
      'Modify by Amy 2021/07/12
      ElseIf m_SysType = "ACS" Then
        strFolder = str_ACS_OrderPath
      'Added by Morgan 2022/12/8
      ElseIf strCP01 = "CFP" Or strCP01 = "CPS" Then
        strFolder = str_CFP_OrderPath
      'end 2022/12/8
      Else
         strFolder = str_P_OrderPath
      End If
      '2022/10/25 END
      
      'Added by Morgan 2016/9/7
      '測試抓桌面的相同資料夾以免誤刪真實檔案
      If UCase(pub_DbTerminalName) <> 正式資料庫電腦名稱 Then
         strFolder = PUB_Getdesktop & "\" & Mid(strFolder, InStrRev(strFolder, "\") + 1)
      End If
      'end 2016/9/7
      'Modified by Morgan 2020/7/13 +.ORDER.MSG --潘韻丞
      If pCP10 <> "" Then
         strCon = " and ( instr(upper(cpp02),'." & pCP10 & ".ORDER.MENU')>0 or instr(upper(cpp02),'." & pCP10 & ".ORDER.PDF')>0 or (instr(upper(cpp02),'." & pCP10 & ".')>0 and instr(upper(cpp02),'.ORDER.MSG')>0) )"
      Else
         strCon = " and ( instr(upper(cpp02),'.ORDER.MENU')>0 or instr(upper(cpp02),'.ORDER.PDF')>0 or instr(upper(cpp02),'.ORDER.MSG')>0 )"
      End If
      strExtFileName = ".ORDER.PDF"
   '申請書
   ElseIf pType = 1 Then
      'Modified by Lydia 2024/07/22 改用變數
      'strFolder = "\\Pat1\Data_SCAN"
      strFolder = "\\" & strPat1Path & "\Data_SCAN"
      'Added by Morgan 2016/9/7
      '測試抓桌面的相同資料夾以免誤刪真實檔案
      If UCase(pub_DbTerminalName) <> 正式資料庫電腦名稱 Then
         strFolder = PUB_Getdesktop & "\" & Mid(strFolder, InStrRev(strFolder, "\") + 1)
      End If
      'end 2016/9/7
      
      If pCP10 <> "" Then
         strCon = " and instr(upper(cpp02),'." & pCP10 & ".DATA.PDF')>0"
      Else
         strCon = " and instr(upper(cpp02),'.DATA.PDF')>0"
      End If
      strExtFileName = ".DATA.PDF"
   Else
      Exit Function
   End If
   
   bolOK = False
   If Not pChkFolderOnly Then
      stSQL = "select cpp02 from casepaperpdf where cpp01='" & pCP09 & "' and cpp10<>'D'" & strCon
      intR = 1
      Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         bolOK = True
         PUB_CheckPDF2 = True
      End If
   End If
   
   'Modified by Morgan 2021/8/18 FMP案若有檔案還是要匯入
   'If BolOk = False Then
   If bolOK = False Or bolFMP Then
   'end 2021/8/18
      stSQL = "select cp01,cp02,cp03,cp04,cp05,cp10,cp156 from caseprogress where cp09='" & pCP09 & "'"
      intR = 1
      Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         With rsQuery
         If stCP10 = "" Then stCP10 = .Fields("cp10") 'Added by Morgan 2015/3/23
         If Dir(strFolder & "\*.pdf") <> "" Then
            Set oFolder = oFileSys.GetFolder(strFolder)
            Set oFiles = oFolder.files
            For Each oFile In oFiles
               If UCase(Right(oFile.Name, 4)) = ".PDF" Then
                  If InStr(UCase(oFile.Name), .Fields("cp01")) = 1 Then
                     If PUB_GetCaseNoFromFileName(oFile.Name, .Fields("cp01"), strCP02, strCP03, strCP04) = True Then
                        If strCP02 = .Fields("cp02") And strCP03 = .Fields("cp03") And strCP04 = .Fields("cp04") Then
                           bolOK = False
                           strNum = ""
                           strCP09List = ""
                           strCP10List = ""
                           'Added by Morgan 2014/11/17
                           '接洽單改為檔名內要有案件性質碼或接洽單收文數
                           If pType = 0 Then
                              If InStrRev(oFile.Name, ".") > InStr(oFile.Name, ".") Then
                                 strNum = Mid(oFile.Name, InStr(oFile.Name, ".") + 1, InStrRev(oFile.Name, ".") - InStr(oFile.Name, ".") - 1)
                                 '案件性質
                                 'Modified by Morgan 2015/3/23 分案時可能會改案件性質
                                 'If strNum = .Fields("cp10") Then
                                 If strNum = stCP10 Then
                                 'end 2015/3/23
                                    bolOK = True
                                 '接洽單收文數
                                 ElseIf IsNumeric(strNum) And Len(strNum) = 1 Then
                                    'Modify By Sindy 2020/12/28 + pCP09 : 該筆文號
                                    bolOK = CheckMultiNoOrder(.Fields("cp01"), .Fields("cp02"), .Fields("cp03"), .Fields("cp04"), .Fields("cp05"), strNum, strCP09List, strCP10List, pCP09)
                                    'Modify By Sindy 2020/12/28 最後一筆才匯入
                                    If bolOK = True And strCP09List = "" Then
                                       bolOK = False
                                       PUB_CheckPDF2 = True
                                    End If
                                    '2020/12/28 END
                                 End If
                              End If
                           Else
                              bolOK = True
                           End If
                           
                           If bolOK Then
                              pImpFile = oFile.path
                              If pImport = True Then
                                 'Add By Sindy 2020/12/28 檔案是否正在使用中
                                 If PUB_ChkFileOpening(pImpFile, True) = True Then
                                    MsgBox pImpFile & vbCrLf & "檔案正在使用中，請關閉才可執行匯入！", vbExclamation
                                    bolHadPoMsg = True
                                    PUB_CheckPDF2 = False
                                    Exit Function
                                 End If
                                 '2020/12/28 END
                                 'Modified by Morgan 2015/1/26 本所號的追加聯合碼改各自判斷 Ex.P123456-1,P123456-0-01
                                 'Modify By Sindy 2021/3/29 cp02=流水號要放6碼
                                 'strFileName = .Fields("cp01") & Val(.Fields("cp02")) & IIf(.Fields("cp04") <> "00", "-" & .Fields("cp03") & "-" & .Fields("cp04"), IIf(.Fields("cp03") <> "0", "-" & .Fields("cp03"), ""))
                                 strFileName = .Fields("cp01") & .Fields("cp02") & IIf(.Fields("cp04") <> "00", "-" & .Fields("cp03") & "-" & .Fields("cp04"), IIf(.Fields("cp03") <> "0", "-" & .Fields("cp03"), ""))
                                 '2021/3/29 END
                                 If strCP09List <> "" Then
                                    PUB_CheckPDF2 = SaveMultiNoOrder(strFileName, strCP09List, strCP10List, strExtFileName, pImpFile, Format(oFile.DateLastModified, "YYYYMMDD"), Format(oFile.DateLastModified, "HHMMSS"))
                                 Else
                                    'Modified by Morgan 2015/3/23 分案時可能會改案件性質
                                    'strFileName = strFileName & "." & .Fields("cp10") & strExtFileName
                                    strFileName = strFileName & "." & stCP10 & strExtFileName
                                    'end 2015/3/23
                                    'Modify By Sindy 2015/5/14
                                    'PUB_CheckPDF2 = SaveAttFile_PDF(pCP09, pImpFile, strFileName, Format(oFile.DateLastModified, "YYYYMMDD"), Format(oFile.DateLastModified, "HHMMSS"), False, "4")
                                    PUB_CheckPDF2 = SaveAttFile_PDF(pCP09, pImpFile, strFileName, Format(oFile.DateLastModified, "YYYYMMDD"), Format(oFile.DateLastModified, "HHMMSS"), False)
                                    '2015/5/14 END
                                 End If
                                 If PUB_CheckPDF2 = True Then oFile.Delete True
                              Else
                                 PUB_CheckPDF2 = True
                              End If
                              Exit For
                           End If
                        End If
                     End If
                  End If
               End If
            Next
         End If
         End With
      End If
   End If

   Set rsQuery = Nothing
   Set oFileSys = Nothing
   Set oFolder = Nothing
   Set oFiles = Nothing
   Set oFile = Nothing
End Function

'Added by Morgan 2014/4/11
'來函輸入檢查檔案數量是否符合
Public Function PUB_CheckPDF(pCP01 As String, pCP02 As String, pCP03 As String, pCP04 As String, iFileQty As Integer, Optional pDocNo As String) As Boolean
   Dim stSQL As String, intR As Integer
   Dim rsQuery As ADODB.Recordset
   Dim stCPP01 As String
   Dim oFileSys As New FileSystemObject
   Dim oFolder As Folder
   Dim oFiles As files
   Dim oFile
   Dim iQty As Integer
   Dim strCP02 As String, strCP03 As String, strCP04 As String
   Dim DocImportPath As String '來函匯入區 Added by Morgan 2014/4/18
   
   'Modified Morgan 2014/4/30 改先抓電腦設定
   DocImportPath = GetSetting("TAIE", "P", UCase("frm040112") & "Dir", "")
   If DocImportPath = "" Then
      DocImportPath = strDocImportPath
   End If
   'end 2014/4/30
   
   'Modified by Morgan 2014/5/2
   ''先檢查資料庫
   'If pDocNo <> "" Then
   '   stCPP01 = pDocNo
   ''非電子公文可能會有文檔(來函收文後刪除會保留原文檔收文號放本所案號)
   'Else
   '   stCPP01 = pCP01 & pCP02 & pCP03 & pCP04
   'End If
   'stSQL = "select nvl(count(*),0) from casepaperpdf where cpp01='" & stCPP01 & "'"
   '考慮電子公文也可能有非公文的檔案(Ex.引證前案),改發文號和本所案號都抓
   stSQL = "select nvl(count(*),0) from casepaperpdf where (cpp01='" & pDocNo & "' or cpp01='" & pCP01 & pCP02 & pCP03 & pCP04 & "')  and instr(upper(cpp02),'.CUS.PDF')=0 and cpp10<>'D' AND SUBSTR(UPPER(CPP02),-4)='.PDF'"
   'end 2014/5/2
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      iQty = rsQuery(0)
   End If
   
   '若數量不足時再檢查匯入區
   If iQty < iFileQty Then
      If Dir(DocImportPath & "\*.pdf") <> "" Then
         Set oFolder = oFileSys.GetFolder(DocImportPath)
         Set oFiles = oFolder.files
         For Each oFile In oFiles
            If UCase(Right(oFile.Name, 4)) = ".PDF" Then
               If InStr(oFile.Name, pCP01) = 1 Then
                  If PUB_GetCaseNoFromFileName(oFile.Name, pCP01, strCP02, strCP03, strCP04) = True Then
                     If strCP02 = pCP02 And strCP03 = pCP03 And strCP04 = pCP04 Then
                        iQty = iQty + 1
                     End If
                  End If
               End If
            End If
         Next
      End If
   End If
   
   If iQty >= iFileQty Then
      PUB_CheckPDF = True
   ElseIf MsgBox("PDF檔案尚未放入來函匯入區(" & DocImportPath & ")，是否仍然要繼續!!", vbYesNo + vbDefaultButton2 + vbExclamation) = vbYes Then
      PUB_CheckPDF = True
   End If
   
   Set rsQuery = Nothing
   Set oFileSys = Nothing
   Set oFolder = Nothing
   Set oFiles = Nothing
   Set oFile = Nothing
End Function

'檔名轉案號並檢查格式是否正確
'Modified by Morgan 2025/8/14 +pChkLike
Public Function PUB_GetCaseNoFromFileName(ByVal pFileName As String, ByRef pCP01 As String, Optional ByRef pCP02 As String, Optional ByRef pCP03 As String, Optional ByRef pCP04 As String, Optional ByRef ErrMsg As String, Optional pChkLike As Boolean = False) As Boolean
   Dim iPos As Integer, stCP01 As String
   
   '去除路徑
   iPos = InStrRev(pFileName, "\")
   If iPos > 0 Then
      pFileName = Mid(pFileName, iPos + 1)
   End If
   
   '抓主檔名
   iPos = InStr(pFileName, ".")
   If iPos > 0 Then
      pFileName = Left(pFileName, iPos - 1)
   End If
   
   'Added by Morgan 2018/10/18 系統別
   If pCP01 = "" Then
      iPos = 0
      Do While Not IsNumeric(Mid(pFileName, iPos + 1, 1))
         If Mid(pFileName, iPos + 1, 1) = "-" Then Exit Do 'Added by Morgan 2020/1/7 系統別後的-
         iPos = iPos + 1
         If iPos = 3 Then Exit Do
      Loop
      If iPos > 0 Then
         pCP01 = Left(pFileName, iPos)
      'Added by Morgan 2020/1/7
      Else
         ErrMsg = "系統別有誤"
         Exit Function
      'end 2020/1/7
      End If
   End If
   'end 2018/10/18
   
   If InStr(UCase(pFileName), pCP01) <> 1 Then
      ErrMsg = "系統別有誤"
      Exit Function
   End If
   
   '轉本所案號格式(追加或多國碼用-分隔)
   pFileName = Mid(pFileName, Len(pCP01) + 1)
   If Left(pFileName, 1) = "-" Then pFileName = Mid(pFileName, 2) 'Added by Morgan 2020/1/7 系統別後的-
   
   iPos = InStr(pFileName, "-")
   If iPos = 0 Then
      'Added by Morgan 2025/8/14
      If pChkLike Then
         pCP02 = Format(Val(pFileName), "000000")
      Else
      'end 2025/8/14
         pCP02 = Format(pFileName, "000000")
      End If
      pCP03 = "0"
      pCP04 = "00"
   Else
      pCP02 = Format(Left(pFileName, iPos - 1), "000000")
      pCP03 = Mid(pFileName, iPos + 1, 1)
      iPos = InStr(iPos + 1, pFileName, "-")
      If iPos > 0 Then
         pCP04 = Format(Mid(pFileName, iPos + 1), "00")
      Else
         pCP04 = "00"
      End If
   End If
   
   If Len(pCP02) <> 6 Then
      ErrMsg = "案號CP02超過6碼有誤"
   ElseIf Not IsNumeric(pCP02) Then
      ErrMsg = "案號CP02非數字型態有誤"
   ElseIf Len(pCP03) <> 1 Then
      ErrMsg = "案號CP03長度非1碼有誤"
   'Modify By Sindy 2021/1/18 ex:FCT-016029-T-00.1.pdf
'   ElseIf Not IsNumeric(pCP03) Then
'      ErrMsg = "案號CP03非數字型態有誤"
   ElseIf Len(pCP04) <> 2 Then
      ErrMsg = "案號CP04長度非2碼有誤"
   ElseIf Not IsNumeric(pCP04) Then
      ErrMsg = "案號CP04非數字型態有誤"
   Else
      PUB_GetCaseNoFromFileName = True
   End If
   
End Function

'Added by Morgan 2014/4/17
'電子來函收文更新來函紀錄收文號及卷宗區收文號檔名
'Modified by Morgan 2024/5/22 +pSubTxt:通知信主旨附加文字
Public Sub PUB_UpdateEdocRec(pDocNo As String, pRecNo As String, pCP01 As String, pCP02 As String, pCP03 As String, pCP04 As String, pCP10 As String, Optional pCP24 As String, Optional pSubTxt As String)
   Dim stSQL As String, intR As Integer, stFileName As String
   Dim stFtpDir As String, stErrMsg As String 'Added by Morgan 2015/3/24
   Dim stRefCPM03 As String  'Added by Morgan 2017/8/16
   'Added by Lydia 2019/06/25
   Dim mStrMemo As String '加入C 類接洽單備註內容
   Dim rsAD As New ADODB.Recordset
   Dim stSubjAdd As String, stContAdd As String 'Added by Morgan 2021/7/26
   Dim stCC As String 'Added by Morgan 2022/5/19
   Dim stPA89Memo As String 'Add by Amy 2025/08/05
   
   'Modified by Morgan 2022/3/18
   '+and ed11='C' 沒有收文號才更新(因為發現有變數殘留問題)
   stSQL = "update edocument set ed11='" & pRecNo & "' where ed01='" & pDocNo & "' and ed11='C'"
   cnnConnection.Execute stSQL, intR
   
   stSQL = "update casepaperpdf set cpp01='" & pRecNo & "',cpp10='Y' where cpp01='" & pDocNo & "'"
   cnnConnection.Execute stSQL, intR
   '電子檔更名為 本所案號.案件性質.pdf
   'Modified by Morgan 2014/5/2 CP02
   'stFileName = pCP01 & pCP02 & IIf(pCP03 & pCP04 = "000", "", "-" & pCP03 & "-" & pCP04) & "." & pCP10 & ".pdf"
   'Modified by Morgan 2015/1/26 本所號的追加聯合碼改各自判斷 Ex.P123456-1,P123456-0-01
   'Modified by Moragn 2017/4/12
   'stFileName = pCP01 & Val(pCP02) & IIf(pCP04 <> "00", "-" & pCP03 & "-" & pCP04, IIf(pCP03 <> "0", "-" & pCP03, "")) & "." & pCP10 & ".pdf"
   'Modified by Morgan 2017/5/16
   'stFileName = PUB_CaseNo2FileName(pCP01, pCP02, pCP03, pCP04) & "." & pCP10 & ".pdf"
   stFileName = PUB_GetEDocFileName(pCP01, pCP02, pCP03, pCP04, pCP10)
   'end 2017/5/16
   'end 2017/4/12
   stSQL = "update casepaperpdf set cpp02='" & stFileName & "' where cpp01='" & pRecNo & "' and cpp02='$" & pDocNo & ".pdf'"
   cnnConnection.Execute stSQL, intR
   
   
   'Added by Morgan 2022/12/19
   'Modified by Morgan 2023/2/2
   'stFileName = PUB_GetEDocFileName(pCP01, pCP02, pCP03, pCP04, pCP10, True)
   'stSQL = "update casepaperpdf set cpp02='" & stFileName & "' where cpp01='" & pRecNo & "' and cpp02='$" & pDocNo & ".CERT.pdf'"
   stFileName = PUB_CaseNo2FileName(pCP01, pCP02, pCP03, pCP04) & "." & pCP10
   stSQL = "update casepaperpdf set cpp02=replace(cpp02,'$" & pDocNo & "','" & stFileName & "')  where cpp01='" & pRecNo & "' and cpp02 like '$" & pDocNo & ".%.pdf'"
   'end 2023/2/2
   cnnConnection.Execute stSQL, intR
   'end 2022/12/19
   
   'Added by Morgan 2017/6/2 原始附件上刪除註記
   stSQL = "update casepaperpdf set cpp02=cpp02||'.del',cpp10='D' where cpp01='" & pRecNo & "' and cpp02 like '$" & pDocNo & ".pdf.%' and cpp10<>'D'"
   cnnConnection.Execute stSQL, intR
   'end 2017/6/2
   
   'Added by Morgan 2017/8/15
   'FCP OA 輸入要通知承辦人(工程師)及其主管
   'FCT 電子公文輸入要通知承辦人(業務)及其主管
   If strSrvDate(1) >= 20170821 Then
      'Modifid by Morgan 2018/12/10 FCP的OA副檔名已改
      'If (pCP01 = "FCP" And InStr(UCase(stFileName), "OA.PDF") > 0) Or pCP01 = "FCT" Then
      'Modified by Morgan 2021/6/11 FCP改承辦人掛工程師的都要通知(排除核准)
      'If (pCP01 = "FCP" And (pCP10 = "1202" Or pCP10 = "1002" Or pCP10 = "1007" Or (pCP10 = "1503" And pCP24 = "2"))) Or pCP01 = "FCT" Then
      'Modified by Morgan 2021/8/20 +判斷收文號>C(要排除歸卷)
      If pRecNo > "C" And ((pCP01 = "FCP" And pCP10 <> "1001") Or pCP01 = "FCT") Then
      'end 2018/12/10
         stRefCPM03 = PUB_GetRelateCasePropertyName(pRecNo, "1")
         'Added by Lydia 2019/06/25 加入C 類接洽單備註內容
         'Modified by Lydia 2020/03/06 +被舉發理由1802
         'Modified by Lydia 2022/01/21 改成共用模組
'         If (pCP01 = "FCP" Or pCP01 = "P") And InStr("1202,1227,1002,1802", pCP10) > 0 Then
'              stSQL = "select pa75,pa26,pa27,pa28,pa29,pa30 from patent where pa01='" & pCP01 & "' and pa02='" & pCP02 & "' and pa03='" & pCP03 & "' and pa04='" & pCP04 & "' "
'              intR = 1
'              Set rsAD = ClsLawReadRstMsg(intR, stSQL)
'              If intR = 1 Then
'                  'Modified by Lydia 2021/11/05 模組修改
'                  'mStrMemo = PUB_GetIncomMemoNew(pCP01 & pCP02 & pCP03 & pCP04, pCP01, "", "" & rsAD.Fields("pa75"), "" & rsAD.Fields("pa26"), "Y", , , "" & rsAD.Fields("pa27"), "" & rsAD.Fields("pa28"), "" & rsAD.Fields("pa29"), "" & rsAD.Fields("pa30"))
'                  mStrMemo = PUB_GetIncomMemoNew(pCP01 & pCP02 & pCP03 & pCP04, pCP01, "" & rsAD.Fields("pa75"), rsAD.Fields("pa26") & "," & "" & rsAD.Fields("pa27") & "," & "" & rsAD.Fields("pa28") & "," & "" & rsAD.Fields("pa29") & "," & "" & rsAD.Fields("pa30"), "Y", "", pCP10)
'                  'Modified by Lydia 2021/11/23 減一個跳行||chr(13)||chr(10)||chr(13)||chr(10)||=> ||chr(13)||chr(10)||
'                  If mStrMemo <> "" Then mStrMemo = "||chr(13)||chr(10)||'備註:" & ChgSQL(mStrMemo) & "' "
'              End If
'              Set rsAD = Nothing
'         End If
         If (pCP01 = "FCP" Or pCP01 = "P") Then
            mStrMemo = PUB_FCPCFormMemo(pRecNo)
            If mStrMemo <> "" Then mStrMemo = "||chr(13)||chr(10)||'備註:" & ChgSQL(mStrMemo) & "' "
         End If
         'end 2022/01/21
         
         If pCP01 = "FCP" Then
            'Added by Morgan 2021/7/26 檢查是否有內部收文告代，主旨加提醒並於內文帶承辦期限及所限 --Sharon
            '，同時內部收文【告代】
            stSQL = "select sqldatet(cp48) dt1,sqldatet(cp06) dt2 from caseprogress where cp43='" & pRecNo & "' and cp10='901'"
            intR = 1
            Set rsAD = ClsLawReadRstMsg(intR, stSQL)
            If intR = 1 Then
               stSubjAdd = "，同時內部收文【告代】"
               stContAdd = "||chr(13)||chr(10)||chr(13)||chr(10)||'案件性質：告代'||chr(13)||chr(10)||'承辦期限：" & rsAD("dt1") & "'"
               '約定期限上線前沒有所限不必帶--Sharon
               If Not IsNull(rsAD("dt2")) Then
                  stContAdd = stContAdd & "||chr(13)||chr(10)||'本所期限：" & rsAD("dt2") & "'"
               End If
            End If
            'end 2021/7/26
            
            'Added by Lydia 2021/11/23 依David的要求，C類來函請於email及接洽單上，加上一句話「※請工程師務必進系統看【各項指示】內容，謝謝。」放置位置在備註的上面並且獨立一行，並非併入備註內容。
            mStrMemo = "||chr(13)||chr(10)||chr(13)||chr(10)||'※請工程師務必進系統看【各項指示】內容，謝謝。'" & mStrMemo
            'end 2021/11/23
            
            'Modified by Lydia 2019/06/25 + mStrMemo
            'Modify By Sindy 2020/4/6 oMan => decode(st16,'3',st52||';'||st53,oMan)
            'Modified by Morgan 2021/6/11 +判斷承辦人為工程師
            'Modify By Sindy 2021/7/7 + 約定期限 ,nextprogress and np01(+)=cp09 and np06(+) is null
            '                           IIf(strSrvDate(1) >= 外專台灣案約定期限啟用日, "||decode(np23,null,'',chr(13)||chr(10)||'約定期限：'||sqldatet(np23))", "")
            'Modified by Morgan 2021/7/26 +內部收文告代提醒 stSubjAdd,stContAdd --Sharon
            'Modified by Lydia 2021/10/27 凡是key C類工程師的來函，發給工程師來函的Mail請CC程序人員
            'stSQL = "insert into MailCache(MC01,MC02,MC03,MC04,MC07,MC08,MC09)" & _
               " select '" & strUserNum & "',nvl(cp14,decode(st16,'3',st52||';'||st53,oMan))" & _
               ",to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss')" & _
               ",cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04)||' 案【'||cpm03||'" & stRefCPM03 & "'||'】電子公文已輸入" & stSubjAdd & "!!'" & _
               ",chr(13)||chr(10)||'收文號：'||CP09" & _
               "||chr(13)||chr(10)||'本所案號：'||cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04)" & _
               "||chr(13)||chr(10)||'案件名稱：'||pa05" & _
               "||chr(13)||chr(10)||'案件性質：'||cpm03||'" & stRefCPM03 & "'" & _
               "||chr(13)||chr(10)||'收文日：'||sqldatet(cp05)" & _
               "||decode(cp06,null,'',chr(13)||chr(10)||'本所期限：'||sqldatet(cp06))" & _
               IIf(strSrvDate(1) >= 外專台灣案約定期限啟用日, "||decode(np23,null,'',chr(13)||chr(10)||'約定期限：'||sqldatet(np23))", "") & _
               "||chr(13)||chr(10)||'承辦人：'||decode(cp14,'','未分案',cp14||' '||cp14n)" & stContAdd & _
               "||chr(13)||chr(10)||chr(13)||chr(10)||'卷宗區電子公文檔名：" & stFileName & "'" & mStrMemo & _
               ",decode(nvl(cp14,decode(st16,'3',st52||';'||st53,oMan)),decode(st16,'3',st52||';'||st53,oMan),'',decode(st16,'3',st52||';'||st53,oMan))" & _
               " from ( select cp01,cp02,cp03,cp04,cp05,cp06,cp10,cp09,cp13,cp14,pa05,cpm03,st02 cp14n" & _
               " ,decode(nvl(st16,pa150),'1','T','2','R','3','S','4','T1','O') Cod,st16,st52,st53,np23" & _
               " From caseprogress, casepropertymap, patent, staff,nextprogress" & _
               " where cp09='" & pRecNo & "' and cpm01(+)=cp01 and cpm02(+)=cp10" & _
               " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04" & _
               " and st01(+)=cp14 and st03='F21' and np01(+)=cp09 and np06(+) is null) X,SetSpecMan where oCode(+)=Cod"
            'Modified by Morgan 2021/11/10 本所期限改為承辦期限--淑華
            'Modified by Morgan 2021/11/16 再加本所期限--淑華
            'Modified by Morgan 2022/5/19 工程師&工程師主管語法修改
            'stSQL = "insert into MailCache(MC01,MC02,MC03,MC04,MC07,MC08,MC09)" & _
               " select '" & strUserNum & "' as MC01,nvl(cp14,decode(st16,'3',st52||';'||st53,oMan)) as MC02" & _
               ",to_char(sysdate,'yyyymmdd') as MC03,to_char(sysdate,'hh24miss') as MC04" & _
               ",cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04)||' 案【'||cpm03||'" & stRefCPM03 & "'||'】電子公文已輸入" & stSubjAdd & "!!' as MC07" & _
               ",chr(13)||chr(10)||'收文號：'||CP09" & _
               "||chr(13)||chr(10)||'本所案號：'||cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04)" & _
               "||chr(13)||chr(10)||'案件名稱：'||pa05" & _
               "||chr(13)||chr(10)||'案件性質：'||cpm03||'" & stRefCPM03 & "'" & _
               "||chr(13)||chr(10)||'收文日：'||sqldatet(cp05)" & _
               "||decode(cp06,null,'',chr(13)||chr(10)||'本所期限：'||sqldatet(cp06))" & _
               "||decode(cp48,null,'',chr(13)||chr(10)||'承辦期限：'||sqldatet(cp48))" & _
               IIf(strSrvDate(1) >= 外專台灣案約定期限啟用日, "||decode(np23,null,'',chr(13)||chr(10)||'約定期限：'||sqldatet(np23))", "") & _
               "||chr(13)||chr(10)||'承辦人：'||decode(cp14,'','未分案',cp14||' '||cp14n)" & stContAdd & _
               "||chr(13)||chr(10)||chr(13)||chr(10)||'卷宗區電子公文檔名：" & stFileName & "'" & mStrMemo & " as mc08 " & _
               ",decode(nvl(cp14,decode(st16,'3',st52||';'||st53,oMan)),decode(st16,'3',st52||';'||st53,oMan),'',decode(st16,'3',st52||';'||st53,oMan))||decode(cod,'O','',';'||na16) as mc09" & _
               " from ( select cp01,cp02,cp03,cp04,cp05,cp06,cp48,cp10,cp09,cp13,cp14,pa05,cpm03,st02 cp14n" & _
               " ,decode(nvl(st16,pa150),'1','T','2','R','3','S','4','T1','O') Cod,st16,st52,st53,np23,na16" & _
               " From caseprogress, casepropertymap, patent, staff,nextprogress,fagent,nation" & _
               " where cp09='" & pRecNo & "' and cpm01(+)=cp01 and cpm02(+)=cp10" & _
               " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04" & _
               " and st01(+)=cp14 and st03='F21' and np01(+)=cp09 and np06(+) is null" & _
               " and substr(pa75,1,8)=fa01(+) and substr(pa75,9,1)=fa02(+) and fa10=na01(+)) X,SetSpecMan where oCode(+)=Cod"
               
            stSQL = "select cp14 from caseprogress where cp09='" & pRecNo & "' and cp14 is not null"
            intR = 1
            Set rsAD = ClsLawReadRstMsg(intR, stSQL)
            If intR = 1 Then
               stCC = PUB_GetFCPEngSup(rsAD("cp14"))
               'Added by Lydia 2024/07/04 判斷若承辦人已是內專工程師，增加副本收受者和內文
               If Mid("" & rsAD.Fields("CP14"), 4, 1) = "9" Then
                  'Modified by Lydia 2024/08/07 debug: 原本副本就有部門主管
                  'stCC = PUB_GetFCPEngSup(rsAD("cp14"), , , True)
                  stSQL = PUB_GetFCPEngSup(rsAD("cp14"), , , True)
                  If stSQL <> "" Then
                     stCC = stCC & ";" & stSQL
                  End If
                  'end 2024/08/07
                  stCC = PUB_GetFCPEngSup(rsAD("cp14"), , , True)
                  mStrMemo = "||chr(13)||chr(10)||chr(13)||chr(10)||'※請外專主管確認本案OA如有不能請款之情形，則通知Wilson是否轉回外專處理，以及通知Sharon不分舜禹翻譯OA (1日以內)'" & mStrMemo
                  'Added by Lydia 2024/10/25 增加sharon為 副本收受者
                  stSQL = Pub_GetSpecMan("M")
                  If stSQL <> "" And InStr(stCC & ";", stSQL) = 0 Then
                     stCC = stCC & IIf(stCC <> "", ";", "") & stSQL
                  End If
                  'end 2024/10/25
               End If
               'end 2024/07/04
            End If
            'Add by Amy 2025/08/05 後續准駁簡單報告=Y,輸C類來函[主旨]最前面加【請簡單報告】-Winfrey
            If Pub_GetField("Patent", "pa01='" & pCP01 & "' And pa02='" & pCP02 & "' And pa03='" & pCP03 & "' And pa04='" & pCP04 & "'", "pa89") = "Y" Then
               stPA89Memo = "【請簡單報告】"
            End If
            
            'Modified by Morgan 2022/8/5 +已閉卷案件主旨加【本案已閉卷】本文加 "※若無需通知客戶則請不予理會此email"
            'Modified b Lydia 2023/01/09 FCP和寰華案 key C類來函，若key來函人員沒有在系統自動發Outlook的收件者中，副本請加上key來函人員;
                                  'na16=> decode(substr(cp01,1,1),'F',na16,na79) as na16, decode(cod,'O','',';'||na16) as mc09=>decode(cod,'O','',decode(na16,'" & strUserNum & "',';'||na16,';'||na16||';'||'" & strUserNum & "')) as mc09
            'Modified by Morgan 2024/2/29 機械組案件承辦人為鄭光益87003時主旨加【機械設計組】
            'Modified by Morgan 2024/3/5 改機械組案件主旨都加【機械設計組】--Sharon
            'Modify by Amy 2025/08/05 +stPA89Memo
            stSQL = "insert into MailCache(MC01,MC02,MC03,MC04,MC07,MC08,MC09)" & _
               " select '" & strUserNum & "' as MC01,cp14 as MC02" & _
               ",to_char(sysdate,'yyyymmdd') as MC03,to_char(sysdate,'hh24miss') as MC04" & _
               ",'" & stPA89Memo & "'||decode(pa150,'4','【機械設計組】')||cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04)||' 案【'||cpm03||'" & stRefCPM03 & "】'||decode(pa57,'Y','【本案已閉卷】','')||'電子公文已輸入" & stSubjAdd & "!!" & pSubTxt & "' as MC07" & _
               ",decode(pa57,'Y','※若無需通知客戶則請不予理會此email','')||chr(13)||chr(10)||chr(13)||chr(10)||'收文號：'||CP09" & _
               "||chr(13)||chr(10)||'本所案號：'||cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04)" & _
               "||chr(13)||chr(10)||'案件名稱：'||pa05" & _
               "||chr(13)||chr(10)||'案件性質：'||cpm03||'" & stRefCPM03 & "'" & _
               "||chr(13)||chr(10)||'收文日：'||sqldatet(cp05)" & _
               "||decode(cp06,null,'',chr(13)||chr(10)||'本所期限：'||sqldatet(cp06))" & _
               "||decode(cp48,null,'',chr(13)||chr(10)||'承辦期限：'||sqldatet(cp48))" & _
               IIf(strSrvDate(1) >= 外專台灣案約定期限啟用日, "||decode(np23,null,'',chr(13)||chr(10)||'約定期限：'||sqldatet(np23))", "") & _
               "||chr(13)||chr(10)||'承辦人：'||decode(cp14,'','未分案',cp14||' '||cp14n)" & stContAdd & _
               "||chr(13)||chr(10)||chr(13)||chr(10)||'卷宗區電子公文檔名：" & stFileName & "'" & mStrMemo & " as mc08 " & _
               ",'" & stCC & "'||decode(cod,'O','',decode(na16,'" & strUserNum & "',';'||na16,';'||na16||';'||'" & strUserNum & "')) as mc09" & _
               " from ( select cp01,cp02,cp03,cp04,cp05,cp06,cp48,cp10,cp09,cp13,cp14,pa05,cpm03,st02 cp14n" & _
               " ,decode(nvl(st16,pa150),'1','T','2','R','3','S','4','T1','O') Cod,st16,st52,st53,np23,decode(substr(cp01,1,1),'F',na16,na79) as na16,pa57,pa150" & _
               " From caseprogress, casepropertymap, patent, staff,nextprogress,fagent,nation" & _
               " where cp09='" & pRecNo & "' and cpm01(+)=cp01 and cpm02(+)=cp10" & _
               " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04" & _
               " and st01(+)=cp14 and st03='F21' and np01(+)=cp09 and np06(+) is null" & _
               " and substr(pa75,1,8)=fa01(+) and substr(pa75,9,1)=fa02(+) and fa10=na01(+)) X,SetSpecMan where oCode(+)=Cod"
         'end 2022/5/19
         Else
            'Modified by Morgan 2017/8/22 因英文組要多發給核稿人故改發給 ST52(英文組為核稿人或80030,日文組78011,其他68005),ST53(英文組有核稿人時80030,其他則無)
            'Modified by Morgan 2017/10/5 8/18 +(CP07>0 or ED18 is not null or ED19 is not null) 陳經理說有期限的來函才要通知
            'Modified by Lydia 2019/06/25 + mStrMemo
            'Modify By Sindy 2021/7/7 + 約定期限 ,nextprogress and np01(+)=cp09 and np06(+) is null
            '                           IIf(strSrvDate(1) >= 外專台灣案約定期限啟用日, "||decode(np23,null,'',chr(13)||chr(10)||'約定期限：'||sqldatet(np23))", "")
            stSQL = "insert into MailCache(MC01,MC02,MC03,MC04,MC07,MC08,MC09)" & _
               " select '" & strUserNum & "',cp13" & _
               ",to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss')" & _
               ",cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04)||' 案【'||cpm03||'" & stRefCPM03 & "'||'】電子公文已輸入!!" & pSubTxt & "'" & _
               ",chr(13)||chr(10)||'收文號：'||CP09" & _
               "||chr(13)||chr(10)||'本所案號：'||cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04)" & _
               "||chr(13)||chr(10)||'案件名稱：'||tm05" & _
               "||chr(13)||chr(10)||'案件性質：'||cpm03||'" & stRefCPM03 & "'" & _
               "||chr(13)||chr(10)||'收文日：'||sqldatet(cp05)" & _
               "||decode(cp06,null,'',chr(13)||chr(10)||'本所期限：'||sqldatet(cp06))" & _
               IIf(strSrvDate(1) >= 外專台灣案約定期限啟用日, "||decode(np23,null,'',chr(13)||chr(10)||'約定期限：'||sqldatet(np23))", "") & _
               "||chr(13)||chr(10)||'承辦人：'||decode(cp14,'','未分案',cp14||' '||cp14n)" & _
               "||chr(13)||chr(10)||'智權人員：'||cp13||' '||cp13n" & _
               "||chr(13)||chr(10)||chr(13)||chr(10)||'卷宗區電子公文檔名：" & stFileName & "'" & mStrMemo & _
              ",st52||decode(st53,'','',';'||st53)" & _
               " from ( select distinct cp01,cp02,cp03,cp04,cp05,cp06,cp10,cp09,cp13,cp14,tm05,cpm03,s1.st02 cp14n,s2.st02 cp13n,s2.st52,s2.st53,np23" & _
               " from caseprogress,edocument,casepropertymap, trademark, staff s1,staff s2,nextprogress where cp09='" & pRecNo & "'" & _
               " and ed11(+)=cp09 and ed20 is null and (CP07>0 or ED18 is not null or ED19 is not null) and cpm01(+)=cp01 and cpm02(+)=cp10" & _
               " and tm01(+)=cp01 and tm02(+)=cp02 and tm03(+)=cp03 and tm04(+)=cp04  and s1.st01(+)=cp14 and s2.st01(+)=cp13 and np01(+)=cp09 and np06(+) is null) X"
         End If
         cnnConnection.Execute stSQL, intR
      End If
   End If
   'end 2017/8/15
End Sub

'Added by Morgan 2021/6/11
'Modified by Morgan 2024/5/22 +pSubTxt:通知信主旨附加文字
'FCP來函通知(紙本)
Public Function PUB_FCPOAInform(pRecNo As String, pCP01 As String, pCP02 As String, pCP03 As String, pCP04 As String, pCP10 As String, Optional pSubTxt As String)
   Dim stFileName As String, stRefCPM03 As String, mStrMemo As String
   Dim intR As Integer, stSQL As String
   Dim rsAD As ADODB.Recordset
   Dim stSubjAdd As String, stContAdd As String 'Added by Morgan 2021/7/26
   Dim stCC As String 'Added by Morgan 2022/5/19
   Dim stPA89Memo As String 'Add by Amy 2025/08/05
   
   '承辦人為工程師(排除核准)
   'Modified by Morgan 2025/3/20 +FG
   If ((pCP01 = "FCP" Or pCP01 = "FG") And pCP10 <> "1001") Then
      stFileName = PUB_GetEDocFileName(pCP01, pCP02, pCP03, pCP04, pCP10)
      stRefCPM03 = PUB_GetRelateCasePropertyName(pRecNo, "1")
      'Modified by Lydia 2022/01/21 改成共用模組
'      If (pCP01 = "FCP" Or pCP01 = "P") And InStr("1202,1227,1002,1802", pCP10) > 0 Then
'           stSQL = "select pa75,pa26,pa27,pa28,pa29,pa30 from patent where pa01='" & pCP01 & "' and pa02='" & pCP02 & "' and pa03='" & pCP03 & "' and pa04='" & pCP04 & "' "
'           intR = 1
'           Set rsAD = ClsLawReadRstMsg(intR, stSQL)
'           If intR = 1 Then
'               'Modified by Lydia 2021/11/05 模組修改
'               'mStrMemo = PUB_GetIncomMemoNew(pCP01 & pCP02 & pCP03 & pCP04, pCP01, "", "" & rsAD.Fields("pa75"), "" & rsAD.Fields("pa26"), "Y", , , "" & rsAD.Fields("pa27"), "" & rsAD.Fields("pa28"), "" & rsAD.Fields("pa29"), "" & rsAD.Fields("pa30"))
'               mStrMemo = PUB_GetIncomMemoNew(pCP01 & pCP02 & pCP03 & pCP04, pCP01, "" & rsAD.Fields("pa75"), rsAD.Fields("pa26") & "," & "" & rsAD.Fields("pa27") & "," & "" & rsAD.Fields("pa28") & "," & "" & rsAD.Fields("pa29") & "," & "" & rsAD.Fields("pa30"), "Y", "", pCP10)
'               'Modified by Lydia 2021/11/23 減一個跳行||chr(13)||chr(10)||chr(13)||chr(10)||=> ||chr(13)||chr(10)||
'               If mStrMemo <> "" Then mStrMemo = "||chr(13)||chr(10)||'備註:" & ChgSQL(mStrMemo) & "' "
'           End If
'      End If
      mStrMemo = PUB_FCPCFormMemo(pRecNo)
      If mStrMemo <> "" Then mStrMemo = "||chr(13)||chr(10)||'備註:" & ChgSQL(mStrMemo) & "' "
      'end 2022/01/21
         
      'Added by Morgan 2021/7/26 檢查是否有內部收文告代，主旨加提醒並於內文帶承辦期限及所限 --Sharon
      '，同時內部收文【告代】
      stSQL = "select sqldatet(cp48) dt1,sqldatet(cp06) dt2 from caseprogress where cp43='" & pRecNo & "' and cp10='901'"
      intR = 1
      Set rsAD = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         stSubjAdd = "，同時內部收文【告代】"
         stContAdd = "||chr(13)||chr(10)||chr(13)||chr(10)||'案件性質：告代'||chr(13)||chr(10)||'承辦期限：" & rsAD("dt1") & "'"
         '約定期限上線前沒有所限不必帶--Sharon
         If Not IsNull(rsAD("dt2")) Then
            stContAdd = stContAdd & "||chr(13)||chr(10)||'本所期限：" & rsAD("dt2") & "'"
         End If
      End If
      'end 2021/7/26
      'Added by Lydia 2021/11/23 依David的要求，C類來函請於email及接洽單上，加上一句話「※請工程師務必進系統看【各項指示】內容，謝謝。」放置位置在備註的上面並且獨立一行，並非併入備註內容。
      mStrMemo = "||chr(13)||chr(10)||chr(13)||chr(10)||'※請工程師務必進系統看【各項指示】內容，謝謝。'" & mStrMemo
      'end 2021/11/23
                        
      'Modify By Sindy 2021/7/7 + 約定期限 ,nextprogress and np01(+)=cp09 and np06(+) is null
      '                           IIf(strSrvDate(1) >= 外專台灣案約定期限啟用日, "||decode(np23,null,'',chr(13)||chr(10)||'約定期限：'||sqldatet(np23))", "")
      'Modified by Morgan 2021/7/26 +內部收文告代提醒 stSubjAdd,stContAdd --Sharon
      'Modified by Lydia 2021/10/27 凡是key C類工程師的來函，發給工程師來函的Mail請CC程序人員
      'stSQL = "insert into MailCache(MC01,MC02,MC03,MC04,MC07,MC08,MC09)" & _
               " select '" & strUserNum & "',nvl(cp14,decode(st16,'3',st52||';'||st53,oMan))" & _
               ",to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss')" & _
               ",cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04)||' 案【'||cpm03||'" & stRefCPM03 & "'||'】" & "公文已輸入" & stSubjAdd & "!!'" & _
               ",chr(13)||chr(10)||'收文號：'||CP09" & _
               "||chr(13)||chr(10)||'本所案號：'||cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04)" & _
               "||chr(13)||chr(10)||'案件名稱：'||pa05" & _
               "||chr(13)||chr(10)||'案件性質：'||cpm03||'" & stRefCPM03 & "'" & _
               "||chr(13)||chr(10)||'收文日：'||sqldatet(cp05)" & _
               "||decode(cp06,null,'',chr(13)||chr(10)||'本所期限：'||sqldatet(cp06))" & _
               IIf(strSrvDate(1) >= 外專台灣案約定期限啟用日, "||decode(np23,null,'',chr(13)||chr(10)||'約定期限：'||sqldatet(np23))", "") & _
               "||chr(13)||chr(10)||'承辦人：'||decode(cp14,'','未分案',cp14||' '||cp14n)" & stContAdd & _
               "||chr(13)||chr(10)||chr(13)||chr(10)||'卷宗區電子公文檔名：" & stFileName & "'" & mStrMemo & _
               ",decode(nvl(cp14,decode(st16,'3',st52||';'||st53,oMan)),decode(st16,'3',st52||';'||st53,oMan),'',decode(st16,'3',st52||';'||st53,oMan))" & _
               " from ( select cp01,cp02,cp03,cp04,cp05,cp06,cp10,cp09,cp13,cp14,pa05,cpm03,st02 cp14n" & _
               " ,decode(nvl(st16,pa150),'1','T','2','R','3','S','4','T1','O') Cod,st16,st52,st53,np23" & _
               " From caseprogress, casepropertymap, patent, staff,nextprogress" & _
               " where cp09='" & pRecNo & "' and cpm01(+)=cp01 and cpm02(+)=cp10" & _
               " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04" & _
               " and st01(+)=cp14 and st03='F21' and np01(+)=cp09 and np06(+) is null) X,SetSpecMan where oCode(+)=Cod"
      'Modified by Morgan 2021/11/10 本所期限改為承辦期限--淑華
      'Modified by Morgan 2021/11/16 再加本所期限--淑華
      'Modified by Morgan 2022/5/19 工程師&工程師主管語法修改
      'stSQL = "insert into MailCache(MC01,MC02,MC03,MC04,MC07,MC08,MC09)" & _
               " select '" & strUserNum & "' as MC01,nvl(cp14,decode(st16,'3',st52||';'||st53,oMan)) as MC02" & _
               ",to_char(sysdate,'yyyymmdd') as MC03,to_char(sysdate,'hh24miss') as MC04" & _
               ",cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04)||' 案【'||cpm03||'" & stRefCPM03 & "'||'】" & "公文已輸入" & stSubjAdd & "!!'  as MC07" & _
               ",chr(13)||chr(10)||'收文號：'||CP09" & _
               "||chr(13)||chr(10)||'本所案號：'||cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04)" & _
               "||chr(13)||chr(10)||'案件名稱：'||pa05" & _
               "||chr(13)||chr(10)||'案件性質：'||cpm03||'" & stRefCPM03 & "'" & _
               "||chr(13)||chr(10)||'收文日：'||sqldatet(cp05)" & _
               "||decode(cp06,null,'',chr(13)||chr(10)||'本所期限：'||sqldatet(cp06))" & _
               "||decode(cp48,null,'',chr(13)||chr(10)||'承辦期限：'||sqldatet(cp48))" & _
               IIf(strSrvDate(1) >= 外專台灣案約定期限啟用日, "||decode(np23,null,'',chr(13)||chr(10)||'約定期限：'||sqldatet(np23))", "") & _
               "||chr(13)||chr(10)||'承辦人：'||decode(cp14,'','未分案',cp14||' '||cp14n)" & stContAdd & _
               "||chr(13)||chr(10)||chr(13)||chr(10)||'卷宗區電子公文檔名：" & stFileName & "'" & mStrMemo & " as mc08 " & _
               ",decode(nvl(cp14,decode(st16,'3',st52||';'||st53,oMan)),decode(st16,'3',st52||';'||st53,oMan),'',decode(st16,'3',st52||';'||st53,oMan))||decode(cod,'O','',';'||na16) as mc09" & _
               " from ( select cp01,cp02,cp03,cp04,cp05,cp06,cp48,cp10,cp09,cp13,cp14,pa05,cpm03,st02 cp14n" & _
               " ,decode(nvl(st16,pa150),'1','T','2','R','3','S','4','T1','O') Cod,st16,st52,st53,np23,na16" & _
               " From caseprogress, casepropertymap, patent, staff,nextprogress,fagent,nation" & _
               " where cp09='" & pRecNo & "' and cpm01(+)=cp01 and cpm02(+)=cp10" & _
               " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04" & _
               " and st01(+)=cp14 and st03='F21' and np01(+)=cp09 and np06(+) is null" & _
               " and substr(pa75,1,8)=fa01(+) and substr(pa75,9,1)=fa02(+) and fa10=na01(+)) X,SetSpecMan where oCode(+)=Cod"
               
      stSQL = "select cp14 from caseprogress where cp09='" & pRecNo & "' and cp14 is not null"
      intR = 1
      Set rsAD = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         stCC = PUB_GetFCPEngSup(rsAD("cp14"))
         'Added by Lydia 2024/07/04 判斷若承辦人已是內專工程師，增加副本收受者和內文
         If Mid("" & rsAD.Fields("CP14"), 4, 1) = "9" Then
            'Modified by Lydia 2024/08/07 debug: 原本副本就有部門主管
            'stCC = PUB_GetFCPEngSup(rsAD("cp14"), , , True)
            stSQL = PUB_GetFCPEngSup(rsAD("cp14"), , , True)
            If stSQL <> "" Then
               stCC = stCC & ";" & stSQL
            End If
            'end 2024/08/07
            mStrMemo = "||chr(13)||chr(10)||chr(13)||chr(10)||'※請外專主管確認本案OA如有不能請款之情形，則通知Wilson是否轉回外專處理，以及通知Sharon不分舜禹翻譯OA (1日以內)'" & mStrMemo
            'Added by Lydia 2024/10/25 增加sharon為 副本收受者
            stSQL = Pub_GetSpecMan("M")
            If stSQL <> "" And InStr(stCC & ";", stSQL) = 0 Then
               stCC = stCC & IIf(stCC <> "", ";", "") & stSQL
            End If
            'end 2024/10/25
         End If
         'end 2024/07/04
      End If
      'Add by Amy 2025/08/05 後續准駁簡單報告=Y,輸C類來函[主旨]最前面加【請簡單報告】-Winfrey
      If Pub_GetField("Patent", "pa01='" & pCP01 & "' And pa02='" & pCP02 & "' And pa03='" & pCP03 & "' And pa04='" & pCP04 & "'", "pa89") = "Y" Then
         stPA89Memo = "【請簡單報告】"
      End If
      'Modified by Morgan 2022/8/5 +已閉卷案件主旨加【本案已閉卷】本文加 "※若無需通知客戶則請不予理會此email"
      'Modified b Lydia 2023/01/09 FCP和寰華案 key C類來函，若key來函人員沒有在系統自動發Outlook的收件者中，副本請加上key來函人員;
                                   'na16=> decode(substr(cp01,1,1),'F',na16,na79) as na16, decode(cod,'O','',';'||na16) as mc09=>decode(cod,'O','',decode(na16,'" & strUserNum & "',';'||na16,';'||na16||';'||'" & strUserNum & "')) as mc09
      'Modified by Morgan 2024/2/29 機械組案件承辦人為鄭光益87003時主旨加【機械設計組】
      'Modified by Morgan 2024/3/5 改機械組案件主旨都加【機械設計組】--Sharon
      'Modify by Amy 2025/08/05 +stPA89Memo
      stSQL = "insert into MailCache(MC01,MC02,MC03,MC04,MC07,MC08,MC09)" & _
               " select '" & strUserNum & "' as MC01,cp14 as MC02" & _
               ",to_char(sysdate,'yyyymmdd') as MC03,to_char(sysdate,'hh24miss') as MC04" & _
               ",'" & stPA89Memo & "'||decode(pa150,'4','【機械設計組】')||cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04)||' 案【'||cpm03||'" & stRefCPM03 & "】'||decode(pa57,'Y','【本案已閉卷】','')||'公文已輸入" & stSubjAdd & "!!" & pSubTxt & "'  as MC07" & _
               ",decode(pa57,'Y','※若無需通知客戶則請不予理會此email','')||chr(13)||chr(10)||chr(13)||chr(10)||'收文號：'||CP09" & _
               "||chr(13)||chr(10)||'本所案號：'||cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04)" & _
               "||chr(13)||chr(10)||'案件名稱：'||pa05" & _
               "||chr(13)||chr(10)||'案件性質：'||cpm03||'" & stRefCPM03 & "'" & _
               "||chr(13)||chr(10)||'收文日：'||sqldatet(cp05)" & _
               "||decode(cp06,null,'',chr(13)||chr(10)||'本所期限：'||sqldatet(cp06))" & _
               "||decode(cp48,null,'',chr(13)||chr(10)||'承辦期限：'||sqldatet(cp48))" & _
               IIf(strSrvDate(1) >= 外專台灣案約定期限啟用日, "||decode(np23,null,'',chr(13)||chr(10)||'約定期限：'||sqldatet(np23))", "") & _
               "||chr(13)||chr(10)||'承辦人：'||decode(cp14,'','未分案',cp14||' '||cp14n)" & stContAdd & _
               "||chr(13)||chr(10)||chr(13)||chr(10)||'卷宗區電子公文檔名：" & stFileName & "'" & mStrMemo & " as mc08 "
      'Modified by Morgan 2025/3/20
      'stSQL = stSQL & _
               ",'" & stCC & "'||decode(cod,'O','',decode(na16,'" & strUserNum & "',';'||na16,';'||na16||';'||'" & strUserNum & "')) as mc09" & _
               " from ( select cp01,cp02,cp03,cp04,cp05,cp06,cp48,cp10,cp09,cp13,cp14,pa05,cpm03,st02 cp14n" & _
               " ,decode(nvl(st16,pa150),'1','T','2','R','3','S','4','T1','O') Cod,st16,st52,st53,np23,decode(substr(cp01,1,1),'F',na16,na79) as na16,pa57,pa150" & _
               " From caseprogress, casepropertymap, patent, staff,nextprogress,fagent,nation" & _
               " where cp09='" & pRecNo & "' and cpm01(+)=cp01 and cpm02(+)=cp10" & _
               " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04" & _
               " and st01(+)=cp14 and st03='F21' and np01(+)=cp09 and np06(+) is null" & _
               " and substr(pa75,1,8)=fa01(+) and substr(pa75,9,1)=fa02(+) and fa10=na01(+)) X,SetSpecMan where oCode(+)=Cod"
      stSQL = stSQL & _
               ",'" & stCC & "'||decode(cod,'O','',replace(';'||decode(substr(cp01,1,1),'F',na16,na79),';" & strUserNum & "',''))||';" & strUserNum & "' as mc09" & _
               " from ( select cp01,cp02,cp03,cp04,cp05,cp06,cp48,cp10,cp09,cp13,cp14,nvl(pa05,sp05) pa05,st02 cp14n" & _
               " ,decode(nvl(st16,nvl(pa150,sp79)),'1','T','2','R','3','S','4','T1','O') Cod,st16,st52,st53,np23,nvl(pa57,sp15) pa57,nvl(sp26,pa75) pa75,nvl(pa150,sp79) pa150" & _
               " From caseprogress, staff, patent,servicepractice,nextprogress" & _
               " where cp09='" & pRecNo & "' and st01(+)=cp14 and st03='F21'" & _
               " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04" & _
               " and sp01(+)=cp01 and sp02(+)=cp02 and sp03(+)=cp03 and sp04(+)=cp04" & _
               " and np01(+)=cp09 and np06(+) is null" & _
               " ) X, casepropertymap,fagent,nation,SetSpecMan where cpm01(+)=cp01 and cpm02(+)=cp10" & _
               " and fa01(+)=substr(pa75,1,8) and fa02(+)=substr(pa75,9,1) and na01(+)=fa10 and oCode(+)=Cod"
      'end 2025/3/20
      'end 2022/5/19
      cnnConnection.Execute stSQL, intR
   End If
   
   Set rsAD = Nothing
End Function

'Added by Morgan 2017/5/16
'電子公文檔案名稱
'pCert:是否為專利證書/註冊證
Public Function PUB_GetEDocFileName(pCP01 As String, pCP02 As String, pCP03 As String, pCP04 As String, Optional ByVal pCP10 As String, Optional ByVal pCert As Boolean = False) As String
   Dim stFileName As String
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   
'Modified by Morgan 2018/10/17 規則統一
'   If pCP01 = "FCP" Then
'      stFileName = pCP01 & pCP02 & IIf(pCP03 & pCP04 = "000", "", "-" & pCP03 & pCP04)
'      'Modified by Morgan 2017/5/25 歸卷會傳簽收日期
'      'Modifid by Morgan 2017/6/29
'      'If Len(pCP10) > 4 Then
'      '   stFileName = stFileName & "OA" & pCP10 & ".pdf"
'      'Else
'      '   stFileName = stFileName & "OA.pdf"
'      '重為處分1503要以該來函的結果判斷准駁
'      If pCP10 = "1503" Then
'         If pCP24 = "1" Then
'            pCP10 = "1001"
'         ElseIf pCP24 = "2" Then
'            pCP10 = "1002"
'         End If
'      End If
'      If pCP10 = "1001" Or pCP10 = "1008" Then '核准,核發
'         stFileName = stFileName & "Notice of Allowance.pdf"
'      ElseIf pCP10 = "1202" Or pCP10 = "1002" Or pCP10 = "1007" Then '審查意見,核駁,裁定駁回
'         stFileName = stFileName & "OA.pdf"
'      ElseIf Len(pCP10) > 4 Then '歸卷
'         stFileName = stFileName & "." & pCP10 & ".pdf"
'      Else '其他
'         stFileName = stFileName & ".pdf"
'      End If
'      'end 2017/6/29
'   Else
      stFileName = PUB_CaseNo2FileName(pCP01, pCP02, pCP03, pCP04) & "." & pCP10 & IIf(pCert = True, ".CERT", "") & ".pdf"
'   End If
   PUB_GetEDocFileName = stFileName
End Function

''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' 取得智權人員收文所屬部門
' Input : strSalesNo ==> 智權人員代號
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Public Function GetSalesArea(ByVal strSalesNo As String) As String
   Dim rsTmp As New ADODB.Recordset
   Dim strSql As String
   
   GetSalesArea = Empty
   strSql = "SELECT * FROM STAFF " & _
            "WHERE ST01 = '" & strSalesNo & "' "
   rsTmp.CursorLocation = adUseClient
   rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If rsTmp.RecordCount > 0 Then
      rsTmp.MoveFirst
      If IsNull(rsTmp.Fields("ST15")) = False Then
         If IsEmptyText(rsTmp.Fields("ST15")) = False Then
            GetSalesArea = rsTmp.Fields("ST15")
         End If
      End If
   End If
   rsTmp.Close
   
   Set rsTmp = Nothing
End Function

'Added by Morgan 2015/5/25
'多國主案(所有國家)詢問是否更新相同承辦人的子案相關欄位(齊備日、完稿日、預定會稿日、會稿日、會稿完成日，不管副案是否齊備)
Public Sub PUB_AskUpdateRelationCase(pCP09 As String)
   Dim stSQL As String, intR As Integer, stCon As String
   Dim rsQuery As ADODB.Recordset
   Dim stCaseNo As String
   Dim stMsg As String, stRelCaseNo As String, bInTrans As Boolean
   
   bInTrans = False
   stCon = ""
   stMsg = ""
      
On Error GoTo ErrHnd
   
   'Modified by Morgan 2016/3/8 --柄佑 105/1/25 請作單
   '改會稿完成才問  and ep06||ep09||ep28||ep07||ep08 is not null -> ep08>0
   stSQL = "select cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04)||'('||na03||')' CaseNo,cp01,cp02,cp03,cp04,cp14,ep06,ep09,ep28,ep07,ep08" & _
      " from caseprogress,engineerprogress,patent,nation where cp09='" & pCP09 & "' and cp01='CFP' and cp21 is null" & _
      " and cp10 in (" & NewCasePtyList & ") and ep02(+)=cp09 and ep08>0" & _
      " and exists(select * from caserelation where cr01=cp01 and cr02=cp02 and cr03=cp03 and cr04=cp04)" & _
      " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04 and na01(+)=pa09"
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      stCaseNo = rsQuery("CaseNo")
      
      'Modified by Morgan 2016/3/8 --柄佑 105/1/25 請作單
      '系統在主案「會稿」及「送會」時，不詢問工程師其他多國CFP案是否同步處理。
      'If rsQuery("ep06") > 0 Then
      '   stCon = stCon & IIf(stCon <> "", " or ", "") & " ep06 is null"
      '   stMsg = stMsg & IIf(stMsg <> "", " 、 ", "") & "齊備日"
      'End If
      
      'If rsQuery("ep09") > 0 Then
      '   stCon = stCon & IIf(stCon <> "", " or ", "") & " ep09 is null"
      '   stMsg = stMsg & IIf(stMsg <> "", " 、 ", "") & "完稿日"
      'End If
      'If rsQuery("ep28") > 0 Then
      '   stCon = stCon & IIf(stCon <> "", " or ", "") & " ep28 is null"
      '   stMsg = stMsg & IIf(stMsg <> "", " 、 ", "") & "預定會稿日"
      'End If
      'If rsQuery("ep07") > 0 Then
      '   stCon = stCon & IIf(stCon <> "", " or ", "") & " ep07 is null"
      '   stMsg = stMsg & IIf(stMsg <> "", " 、 ", "") & "會稿日"
      'End If
      'If rsQuery("ep08") > 0 Then
      '   stCon = stCon & IIf(stCon <> "", " or ", "") & " ep08 is null"
      '   stMsg = stMsg & IIf(stMsg <> "", " 、 ", "") & "會稿完成日"
      'End If
      'If stCon <> "" Then stCon = " and (" & stCon & ")"
      stCon = " and ep08 is null "
      'end 2016/3/8
      
      'Modified by Morgan 2017/6/16 排除會稿中案件--柄佑
      stSQL = "select ep02,cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04)||'('||na03||')' CaseNo from caserelation,caseprogress,engineerprogress,patent,nation" & _
         " where cr01='" & rsQuery("cp01") & "' and cr02='" & rsQuery("cp02") & "' and cr03='" & rsQuery("cp03") & "' and cr04='" & rsQuery("cp04") & "'" & _
         " and cp01(+)=cr05 and cp02(+)=cr06 and cp03(+)=cr07 and cp04(+)=cr08 and cp21='Y' and cp14='" & rsQuery("cp14") & "' and cp57||cp27 is null" & _
         " and cp10 in (" & NewCasePtyList & ") and ep02(+)=cp09 " & stCon & " and ep02 is not null and ep07 is null and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04 and na01(+)=pa09 and pa57||pa108 is null"
      intR = 1
      Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         'Modified by Morgan 2016/3/8 --柄佑 105/1/25 請作單
         '在「主案」會稿完成時，其他多國CFP案設定「齊備日」(主案的會稿完成日)，並詢問工程師其他多國CFP案是否設定「完稿日」、「會稿日」及「會稿完成日」。
         'stMsg = stCaseNo & "案已輸入" & stMsg & "，是否在同承辦人之關聯副案的相同事項輸入相同日期？"
         stMsg = stCaseNo & "案已輸入會稿完成日，是否在同承辦人之關聯副案未輸入的「完稿日」、「會稿日」及「會稿完成日」輸入此會稿完成日？"
         'end 2016/3/8
         
         stMsg = stMsg & vbCrLf & vbCrLf & "待更新關聯副案：" & vbCrLf
         With rsQuery
         .MoveFirst
         Do While Not .EOF
            stMsg = stMsg & vbCrLf & vbTab & .Fields("CaseNo")
            .MoveNext
         Loop
         
         'Modified by Morgan 2016/3/8 --柄佑 105/1/25 請作單
         '在「主案」會稿完成時，其他多國CFP案設定「齊備日」(主案的會稿完成日)，並詢問工程師其他多國CFP案是否設定「完稿日」、「會稿日」及「會稿完成日」。
         'stMsg = stMsg & vbCrLf & vbCrLf & vbCrLf & "若選擇 ""否"" ，則請自行輸入關聯副案之齊備日、完稿日、預定會稿日、會稿日及會稿完成日。" & vbCrLf & "若選擇 ""取消"" ，則下次將會再度詢問。"
         stMsg = stMsg & vbCrLf & vbCrLf & vbCrLf & "若選擇 ""否"" ，則請自行輸入關聯副案的「完稿日」、「會稿日」及「會稿完成日」。" & vbCrLf & "若選擇 ""取消"" ，則下次將會再度詢問。"
         'end 2016/3/8
         
         intR = MsgBox(stMsg, vbQuestion + vbYesNoCancel + vbDefaultButton3, "多國主案更新關聯副案確認")
         If intR = vbYes Then
            
            cnnConnection.BeginTrans
            bInTrans = True
            .MoveFirst
            Do While Not .EOF
            
               'Modified by Morgan 2016/3/8 --柄佑 105/1/25 請作單
               'stSQL = " update engineerprogress a set (ep06,ep09,ep28,ep07,ep08)=(select nvl(a.ep06,b.ep06),nvl(a.ep09,b.ep09),nvl(a.ep28,b.ep28),nvl(a.ep07,b.ep07),nvl(a.ep08,b.ep08)" & _
                  " from engineerprogress b where b.ep02='" & pCP09 & "')" & _
                  " where ep02='" & .Fields("ep02") & "'"
               stSQL = " update engineerprogress a set (ep09,ep07,ep08)=(select nvl(a.ep09,b.ep08),nvl(a.ep07,b.ep08),nvl(a.ep08,b.ep08)" & _
                  " from engineerprogress b where b.ep02='" & pCP09 & "')" & _
                  " where ep02='" & .Fields("ep02") & "'"
               'end 2016/3/8
               
               cnnConnection.Execute stSQL, intR
               .MoveNext
            Loop
            stSQL = "delete AskList where al01='" & pCP09 & "'"
            cnnConnection.Execute stSQL, intR
            cnnConnection.CommitTrans
            
            
         ElseIf intR = vbNo Then
            stSQL = "delete AskList where al01='" & pCP09 & "'"
            cnnConnection.Execute stSQL, intR
            
         End If
         End With
      ElseIf intR = 0 Then
         stSQL = "delete AskList where al01='" & pCP09 & "'"
         cnnConnection.Execute stSQL, intR
      End If
   ElseIf intR = 0 Then
      stSQL = "delete AskList where al01='" & pCP09 & "'"
      cnnConnection.Execute stSQL, intR
   End If
   
ErrHnd:
   If Err.Number <> 0 Then
      If bInTrans = True Then cnnConnection.RollbackTrans
      MsgBox Err.Description, vbCritical, Err.Number
   End If
   
   Set rsQuery = Nothing
End Sub

'#######################################'
'                                       '
' 若有修改記得也要Compile [HTAauto.exe] '
'                                       '
'#######################################'
'Added by Morgan 2013/10/7
'新案上會稿完成日更新相關案及發Mail
Public Sub UpdateEp08(ByVal pCP09 As String, ByVal pEP08 As String)
   Dim stCP01 As String, stCP02 As String, stCP03 As String, stCP04 As String
   Dim stCP10 As String, stCP12 As String, stCP13 As String, stCP14 As String, stCP21 As String, stCP26 As String
   Dim stEP34 As String, stPA09 As String, stEP08 As String, stRefCP48 As String
   Dim stSQL As String, bolSkip As Boolean, stCaseNo As String, stTemp As String, BolIsUpdate As Boolean
   Dim rsQuery As ADODB.Recordset, rsQuery2 As ADODB.Recordset, intR As Integer
   Dim strTo As String 'Add By Sindy 2016/5/25
   
   stSQL = "select cp01,cp02,cp03,cp04,cp06,cp07,cp10,cp12,cp13,cp14,cp21,CP26,ep08,ep34,pa09" & _
      " from caseprogress,engineerprogress,patent where cp09='" & pCP09 & "'" & _
      " and ep02(+)=cp09 and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04"
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      With rsQuery
      stCP01 = .Fields("cp01")
      stCP02 = .Fields("cp02")
      stCP03 = .Fields("cp03")
      stCP04 = .Fields("cp04")
      stCP10 = .Fields("cp10")
      stCP12 = .Fields("cp12")
      stCP13 = .Fields("cp13")
      stCP21 = "" & .Fields("cp21") 'Added by Morgan 2016/3/8
      stCP26 = "" & .Fields("cp26") 'Added by Morgan 2016/5/4
      stCP14 = "" & .Fields("cp14")
      stEP08 = "" & .Fields("EP08")
      stEP34 = "" & .Fields("ep34")
      stPA09 = "" & .Fields("pa09")
      If .Fields("ep08") > 0 Then
         BolIsUpdate = True
      End If
      End With
   End If
   
   pEP08 = DBDATE(pEP08)
   stSQL = "update engineerprogress set ep08=" & CNULL(pEP08, True) & " where ep02='" & pCP09 & "'"
   cnnConnection.Execute stSQL, intR
   
   If Val(pEP08) = 0 Then Exit Sub
   
   stCaseNo = stCP01 & "-" & stCP02 & IIf(stCP03 & stCP04 = "000", "", "-" & stCP03 & "-" & stCP04)
   
   If InStr(CaseMapIn, stCP10) > 0 And (stCP01 = "CFP" Or stCP01 = "P") Then
      '翻譯若有收文其他新案案件性質則不動作
      bolSkip = False
      If stCP10 = "201" Then
         stSQL = "select * from caseprogress a where cp09='" & pCP09 & "'" & _
            " and exists(select * from caseprogress b where b.cp01=a.cp01 and b.cp02=a.cp02 and b.cp03=a.cp03 and b.cp04=a.cp04" & _
            " and b.cp09<>a.cp09 and b.cp10 in (" & CaseMapIn & ") and b.cp57 is null)"
         intR = 1
         Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
         If intR = 1 Then
            bolSkip = True
         End If
      End If
      
      If bolSkip = False Then
         '更新多國子案齊備日,完稿日,會稿日,會稿完成日(日本案只更新齊備日,其他因時間不同不更新)
         'Modified by Morgan 2016/3/8 +主案條件
         If stCP01 = "CFP" And stCP21 = "" Then
'Modified by Morgan 2015/5/25 改詢問後才更新(PUB_UpdateRelationCase)
'            'Memo by Morgan 2014/8/11 若主案相關欄位日期小於子案的收文日時 Trigger( ENGINEERPROGRESS_BEFORE8 ) 將會改為收文日 -- 柄佑
'            '齊備
'            stSQL = "update EngineerProgress A set EP06=(select B.ep06 from engineerprogress B where B.ep02='" & pCP09 & "')" & _
'               " Where EP02 in (select cp09 from caseprogress,caserelation,engineerprogress where cr01='" & stCP01 & "' and cr02='" & stCP02 & "' and cr03='" & stCP03 & "' and cr04='" & stCP04 & "' " & _
'                                  " and cr05=cp01(+) and cr06=cp02(+) and cr07=cp03(+) and cr08=cp04(+) and cp21='Y' and cp09=ep02(+) and ep06 is null and ep08 is null  and ep05='" & stCP14 & "' and cp27 is null and cp57 is null ) "
'            cnnConnection.Execute stSQL, intR
'            '完稿
'            stSQL = "update EngineerProgress A set EP09=(select B.ep09 from engineerprogress B where B.ep02='" & pCP09 & "')" & _
'               " Where EP02 in (select cp09 from caseprogress,caserelation,engineerprogress,patent where cr01='" & stCP01 & "' and cr02='" & stCP02 & "' and cr03='" & stCP03 & "' and cr04='" & stCP04 & "' " & _
'                                  " and cr05=cp01(+) and cr06=cp02(+) and cr07=cp03(+) and cr08=cp04(+) and cp21='Y' and cp09=ep02(+) and ep09 is null and ep08 is null  and ep05='" & stCP14 & "' and cp27 is null and cp57 is null and cp01=pa01(+) and cp02=pa02(+) and cp03=pa03(+) and cp04=pa04(+) and pa09<>'011' ) "
'            cnnConnection.Execute stSQL, intR
'            '會稿
'            stSQL = "update EngineerProgress A set EP07=(select B.ep07 from engineerprogress B where B.ep02='" & pCP09 & "')" & _
'               " Where EP02 in (select cp09 from caseprogress,caserelation,engineerprogress,patent where cr01='" & stCP01 & "' and cr02='" & stCP02 & "' and cr03='" & stCP03 & "' and cr04='" & stCP04 & "' " & _
'                                  " and cr05=cp01(+) and cr06=cp02(+) and cr07=cp03(+) and cr08=cp04(+) and cp21='Y' and cp09=ep02(+) and ep07 is null and ep08 is null  and ep05='" & stCP14 & "' and cp27 is null and cp57 is null and cp01=pa01(+) and cp02=pa02(+) and cp03=pa03(+) and cp04=pa04(+) and pa09<>'011' ) "
'            cnnConnection.Execute stSQL, intR
'            '會稿完成日
'            stSQL = "update EngineerProgress A set EP08=" & pEP08 & _
'               " Where EP02 in (select cp09 from caseprogress,caserelation,engineerprogress,patent where cr01='" & stCP01 & "' and cr02='" & stCP02 & "' and cr03='" & stCP03 & "' and cr04='" & stCP04 & "' " & _
'                                  " and cr05=cp01(+) and cr06=cp02(+) and cr07=cp03(+) and cr08=cp04(+) and cp21='Y' and cp09=ep02(+) and ep08 is null  and ep05='" & stCP14 & "' and cp27 is null and cp57 is null and cp01=pa01(+) and cp02=pa02(+) and cp03=pa03(+) and cp04=pa04(+) and pa09<>'011' ) "
'            cnnConnection.Execute stSQL, intR
            
            stSQL = "delete asklist where al01='" & pCP09 & "'"
            cnnConnection.Execute stSQL, intR
            
            stSQL = "insert into asklist(al01,al02) values('" & pCP09 & "','" & stCP14 & "')"
            cnnConnection.Execute stSQL, intR
'end 2015/5/25
         End If

      
         '台灣專利申請案上會稿完成日時,發E-MAIL通知大陸案之工程師
         If stPA09 = "000" And BolIsUpdate = False Then
            'Modified by Morgan 2016/2/23 +上墨通知
            stSQL = "select cm01||'-'||cm02||decode(cm03||cm04,'000','','-'||cm03||'-'||cm04) C1,cp14,cp09,cp29,EP14,ep20,EP17,ep29,ep34,na03,PA09" & _
               " from casemap,patent,caseprogress,engineerprogress,staff,nation where cm05='" & stCP01 & "' and cm06='" & stCP02 & "'" & _
               " and cm07='" & stCP03 & "' and cm08='" & stCP04 & "' and cm01='P' and cm10='0'" & _
               " and pa01(+)=cm01 and pa02(+)=cm02 and pa03(+)=cm03 and pa04(+)=cm04 and pa57 is null" & _
               " and cp01(+)=cm01 and cp02(+)=cm02 and cp03(+)=cm03 and cp04(+)=cm04 and cp10 in (" & GetAddStr(CaseMapOut) & ") and ep02(+)=cp09 and na01(+)=pa09" & _
               " and cp14=st01(+) and cp27||cp57 is null"
            intR = 1
            Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
            If intR = 1 Then
               With rsQuery
               Do While Not .EOF
                  'Added by  Morgan 2016/2/24 臺灣案會稿完成更新國外P案草齊日,墨齊日並通知繪圖上墨(參考臺灣案發文)
                  '要會稿:草齊日=系統日
                  If .Fields("ep34") = "Y" Then
                     If IsNull(.Fields("ep14")) And IsNull(.Fields("ep20")) Then
                        strSql = "update engineerprogress set ep14=to_char(sysdate,'yyyymmdd') where ep02='" & .Fields("cp09") & "'"
                        cnnConnection.Execute strSql, intI
                     End If
                  '不會稿:草齊日=系統日,墨齊日=系統日,通知繪圖上墨
                  Else
                  
                     'Modified by Morgan 2016/2/24
                     '改除香港案外都要寄委托書並移到不會稿的條件內(要會稿的是工程師辦不必通知)--郭雅娟
                     'If .Fields("pa09") = "020" Then
                     If .Fields("pa09") <> "013" Then
                        'Modify By Sindy 2014/1/27 +IIf(UCase(strUserNum) = "QPGMR", "系統自動會稿完成！", "已會稿完成！")
                        'Modified by Morgan 2016/2/24 改信件內容--郭雅娟
                        'stTemp = vbCrLf + .Fields("c1") & " 案之台灣案 " & stCaseNo & " 已會稿完成,可先行寄委托書給大陸代理人！"
                        stTemp = vbCrLf + .Fields("c1") & " 案之台灣案 " & stCaseNo & " 已會稿完成,可準備提申作業並確認申請文件！"
                        stSQL = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08)" & _
                           " values('" & strUserNum & "','" & rsQuery("cp14") & "',to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss')" & _
                           ",'" & .Fields("c1") & " 案之台灣案" & IIf(UCase(strUserNum) = "QPGMR", "系統自動會稿完成！", "已會稿完成！") & "','" & stTemp & "')"
                        cnnConnection.Execute stSQL, intR
                     End If
                     
                     'Added by Morgan 2016/3/14
                     '程序人員承辦之非臺灣案,請在台灣案會稿完成時,同時上齊備日--郭雅娟
                     stSQL = "update engineerprogress set ep06=to_char(sysdate,'yyyymmdd') where ep02='" & .Fields("cp09") & "' and ep06 is null"
                     cnnConnection.Execute stSQL, intR
                     'end 2016/3/14

                     strSql = "update engineerprogress set ep14=nvl(ep14,decode(ep20,null,to_char(sysdate,'yyyymmdd')))" & _
                        ",ep17=nvl(ep17,decode(ep29,null,to_char(sysdate,'yyyymmdd'))) where ep02='" & .Fields("cp09") & "'"
                     cnnConnection.Execute strSql, intI
                  
                     If IsNull(.Fields("ep17")) And IsNull(.Fields("ep29")) And Not IsNull(.Fields("cp29")) Then
                        stTemp = "台灣案 " & stCaseNo & " 已會稿完成," & IIf(.Fields("pa09") = "020", "大陸", .Fields("na03")) & "案 " & .Fields("c1") & " 請上墨處理！"
                        strSql = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08)" & _
                           " values('" & strUserNum & "','" & .Fields("cp29") & "',to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss'),'" & stTemp & "','如旨')"
                        cnnConnection.Execute strSql, intI
                        
                        strSql = "insert into empelectronprocess(eep01,eep02,eep03,eep04,eep05,eep06,eep07,eep08) select '" & .Fields("cp09") & "',nvl(max(eep02),0)+1" & _
                           ",'QPGMR','22','" & .Fields("cp29") & "',to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss'),'國內案已會稿完成，請上墨處理！'" & _
                           " FROM empelectronprocess WHERE eep01='" & .Fields("cp09") & "'"
                        cnnConnection.Execute strSql, intI
                     End If
                     
                  End If
                  'end 2016/2/24
                  .MoveNext
               Loop
               End With
            End If
         End If
      End If
   End If
   
   '要會稿且會稿完成日有變更
   If stEP34 <> "N" And stEP08 <> pEP08 And (stCP01 = "CFP" Or stCP01 = "P") Then
      '通知業務已會稿完成(承辦人非程序者)
      If (stCP10 >= "101" And stCP10 <= "107") Or (stCP10 >= "201" And stCP10 <= "206") Or (stCP10 >= "501" And stCP10 <= "504") Or (stCP10 >= "801" And stCP10 <= "804") Then
         If GetStaffDepartment(stCP14) <> "P12" Then
            stSQL = "select NVL(CU04,DECODE(CU05,NULL,CU06,CU05||' '||CU88||' '||CU89||' '||CU90)) C01" & _
               ",NVL(PA05,NVL(PA06,PA07)) C02,decode(pa09,'000',cpm03,cpm04) C03,sqldatet(CP06) C04,sqldatet(CP07) C05" & _
               " From caseprogress,patent,casepropertymap,customer where cp09='" & pCP09 & "' and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04" & _
               " and cpm01(+)=cp01 and cpm02(+)=cp10 and cu01(+)=substrb(pa26,1,8) and cu02(+)=substrb(pa26,9)"
            intR = 1
            Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
            If intR = 1 Then
               stTemp = vbCrLf & "客戶名稱： " & rsQuery("C01") & vbCrLf & "本所案號： " & stCaseNo & vbCrLf & "案件名稱： " & rsQuery("C02") & vbCrLf & "案件性質： " & rsQuery("C03") & vbCrLf & "本所期限： " & rsQuery("C04") & vbCrLf & "法定期限： " & rsQuery("C05") & vbCrLf & "會稿完成日：" & ChangeWStringToTDateString(pEP08) & vbCrLf & vbCrLf & "已完成會稿！"
            End If
            'Modify By Sindy 2014/1/27 +IIf(UCase(strUserNum) = "QPGMR", "系統自動會稿完成！", "已會稿完成！")
            'Add By Sindy 2016/5/25 檢查人員是否離職,改抓歷程的發送者
            strTo = PUB_ChkPersonToGetEEP03(pCP09, stCP13, EMP_會完)
'            stSQL = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08)" & _
'               " values('" & strUserNum & "','" & stCP13 & "',to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss')" & _
'               ",'" & stCaseNo & " 案" & IIf(UCase(strUserNum) = "QPGMR", "系統自動會稿完成！", "已會稿完成！") & "','" & stTemp & "')"
            stSQL = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08)" & _
               " values('" & strUserNum & "','" & strTo & "',to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss')" & _
               ",'" & stCaseNo & " 案" & IIf(UCase(strUserNum) = "QPGMR", "系統自動會稿完成！", "已會稿完成！") & "','" & stTemp & "')"
            '2016/5/25 END
            cnnConnection.Execute stSQL, intR
         End If
      End If
   End If
   
   '要會稿且第一次上會稿完成日
   If stEP34 <> "N" And BolIsUpdate = False Then
      '############ 多國案關聯要同步修改 #######'
      
      '通知國外案/多國案工程師已會稿完成
      'P:更新國外案新案未發文(應該只會有不同工程師承辦的案件,因為相同工程師的案件在輸入完稿日就已經做了)
      'Modified by Morgan 2025/8/21 +判斷案件性質為101、102、103 --郭 (Ex:P-135774)
      If stCP01 = "P" And (stCP10 = "101" Or stCP10 = "102" Or stCP10 = "103") Then
         'Modified by Morgan 2016/5/5 +判斷未齊備者(有更新齊備日才要EMail通知),另控制CFP只更新主案(要計件者,不用CP21判斷,因為日本案可能要計件又是多國子案但還是要上齊備日)--柄佑
         'Modified by Morgan 2016/5/17 +改判斷是主案或日本要計件案--柄佑
         stSQL = "select cp01,cp02,cp03,cp04,cp14,cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) RefCNo,st03,cp09 From CASEMAP, CASEPROGRESS,engineerprogress, STAFF,patent where cm05='" & stCP01 & "' and cm06='" & stCP02 & "' and cm07='" & stCP03 & "' and cm08='" & stCP04 & "' and cm10='0' and cm01=cp01(+) and cm02=cp02(+) and cm03=cp03(+) and cm04=cp04(+) and cp57 is null and cp27 is null and cp31='Y' and cp10 in (" & GetAddStr(CaseMapOut) & ") and (cp01='P' or (cp01='CFP' and (cp21 is null or (pa09='011' and cp26 is null)))) and ep02(+)=cp09  and st01(+)=cp14 and ep06 is null and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04"
         'Modify By Sindy 2014/1/27 +IIf(UCase(strUserNum) = "QPGMR", "系統自動會稿完成！", "已會稿完成！")
         stTemp = stCaseNo & " 案" & IIf(UCase(strUserNum) = "QPGMR", "系統自動會稿完成！", "已會稿完成！") & "(相關國外案："
         
      'CFP:更新多國案新案未發文未齊備
      'Modified by Morgan 2016/5/5 主案會稿完成更新相同承辦的多國案--柄佑
      ElseIf stCP01 = "CFP" And stCP21 = "" Then
         stSQL = "select cp01,cp02,cp03,cp04,cp14,cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) RefCNo,st03,cp09  From caserelation, CASEPROGRESS,engineerprogress, STAFF where cr01='" & stCP01 & "' and cr02='" & stCP02 & "' and cr03='" & stCP03 & "' and cr04='" & stCP04 & "' and cr05=cp01(+) and cr06=cp02(+) and cr07=cp03(+) and cr08=cp04(+) and cp57 is null and cp27 is null and cp31='Y' and cp10 in (" & GetAddStr(CaseMapOut) & ")　and cp14='" & stCP14 & "' and ep02(+)=cp09 and st01(+)=cp14 and ep06 is null"
         'Modify By Sindy 2014/1/27 +IIf(UCase(strUserNum) = "QPGMR", "系統自動會稿完成！", "已會稿完成！")
         stTemp = stCaseNo & " 案" & IIf(UCase(strUserNum) = "QPGMR", "系統自動會稿完成！", "已會稿完成！") & "(相關多國案："
      Else
      stSQL = ""
      End If
      
      If stSQL <> "" Then
         intR = 1
         Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
         If intR = 1 Then
            Do While Not rsQuery.EOF
               'Modified by Morgan 2016/5/5 改用收文號抓,內層不需要跑迴圈
               'stSQL = "select cp01,cp06,cp10,cp12,cp09,pa01,pa09 from caseprogress,engineerprogress,patent where pa01='" & rsQuery("cp01") & "' and pa02='" & rsQuery("cp02") & "' and pa03='" & rsQuery("cp03") & "' and pa04='" & rsQuery("cp04") & "' " & _
                  " and pa01=cp01(+) and pa02=cp02(+) and pa03=cp03(+) and pa04=cp04(+)  and cp10 in (" & GetAddStr(CaseMapOut) & ") and cp09=ep02(+) and ep06 is null "
               stSQL = "select cp01,cp06,cp10,cp12,cp09,pa01,pa09 from caseprogress,engineerprogress,patent where cp09='" & rsQuery("cp09") & "' and ep02(+)=cp09 and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04"
               'end 2016/5/4
               intR = 1
               Set rsQuery2 = ClsLawReadRstMsg(intR, stSQL)
               If intR = 1 Then
                  'Do While Not rsQuery2.EOF
                     '上齊備日
                     cnnConnection.Execute "update engineerprogress set ep06=" & pEP08 & " where ep02='" & rsQuery2("cp09") & "' ", intR
                     
                     'FMP要設承辦期限
                     If rsQuery2("cp01") = "P" And Left(rsQuery2("cp12"), 1) = "F" Then
                        stRefCP48 = Pub_GetHandleDay(rsQuery2("cp01"), rsQuery2("pa09"), rsQuery2("cp10"), pEP08, "" & rsQuery2("cp06"), rsQuery2("cp09"))
                        If stRefCP48 <> "" Then
                           cnnConnection.Execute "update caseprogress set cp48=" & stRefCP48 & " Where cp09='" & rsQuery2("cp09") & "'  "
                        End If
                     End If
                  '   rsQuery2.MoveNext
                  'Loop
                  
               'End If
               
                  'Modified by Morgan 2016/2/26 P案承辦人為程序時不用發Mail --郭雅娟
                  'If Not IsNull(rsQuery("cp14")) Then
                  If Not IsNull(rsQuery("cp14")) And Not (rsQuery("cp01") = "P" And rsQuery("st03") = "P12") Then
                     stSQL = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08)" & _
                        " values('" & strUserNum & "','" & rsQuery("cp14") & "',to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss')" & _
                        ",'" & stTemp & rsQuery("RefCNo") & ")','如旨')"
                     cnnConnection.Execute stSQL, intR
                  End If
               
               End If
               'end 2016/5/5
               rsQuery.MoveNext
            Loop
         End If
      End If
   End If
   
   Set rsQuery = Nothing
   Set rsQuery2 = Nothing
End Sub

'Add By Sindy 2013/10/15 檢查電子送件的電子檔是否全數歸檔
Public Function UpdateCP121(ByVal strCP09 As String, ByVal strCP10 As String, ByVal strCPM26 As String) As String
Dim bolCP121isY As Boolean
Dim strFNm As String
Dim strCP110 As String
Dim strCP01 As String, strCP02 As String, strCP03 As String, strCP04 As String 'Add By Sindy 2014/1/16
Dim AgainCheckNewCase As Boolean 'Add By Sindy 2014/5/21
Dim boxChkExists As Boolean, ii As Integer 'Add By Sindy 2015/1/29
Dim strNewCP10 As String 'Added by Lydia 2019/03/06

   AgainCheckNewCase = False 'Add By Sindy 2014/5/21
   'Add By Sindy 2014/1/16
   'Modified by Lydia 2019/03/06 +CP10
   strSql = "select cp01,cp02,cp03,cp04,cp10,cp64" & _
            " From caseprogress" & _
            " where cp09='" & strCP09 & "'"
   intI = 1
   Set RsTemp = ClsLawReadRstMsg(intI, strSql)
   If intI = 1 Then
      strCP01 = RsTemp.Fields("cp01")
      strCP02 = RsTemp.Fields("cp02")
      strCP03 = RsTemp.Fields("cp03")
      strCP04 = RsTemp.Fields("cp04")
      strNewCP10 = "" & RsTemp.Fields("cp10")
   End If
   '2014/1/16 END
   
   'Added by Lydia 2019/03/06 FCP之公告公報1228增加判斷是否有公告本
   If strCP01 = "FCP" And strCP10 = "1228" And strCPM26 = "GAZ" Then
        If strNewCP10 = strCP10 Then '判斷收文號是否為公告公報(例如:移檔), 不是公告公報就不變更
            strSql = "SELECT CPP01,CPP02,CPP14 FROM CASEPROGRESS A,CASEPAPERPDF B " & _
                          "WHERE CP09='" & strCP09 & "' AND CP159=0 AND CP09=CPP01(+) " & _
                          "AND NVL(CPP10,'N') <> 'D' AND UPPER(CPP02) LIKE '%." & strCPM26 & ".PDF' " & _
                          "ORDER BY CPP06 DESC, CPP07 DESC "
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strSql)
            strSql = ""
            If intI = 1 Then
               strSql = "update caseprogress set cp121='Y' where cp09='" & strCP09 & "' and cp121 is null "
            ElseIf intI = 0 Then
               strSql = "update caseprogress set cp121=null where cp09='" & strCP09 & "' "
            End If
            If strSql <> "" Then cnnConnection.Execute strSql, intI
        End If
        Exit Function
   End If
   'end 2019/03/06
   
AgainCheck:
   '檢查電子檔是否已歸檔完成:
   '新申請案要有4個檔案(.contact/.poa/.data/.副檔名)
   '其他,有CPM26副檔名者,含.副檔名及.data要有2個
   '     無             ,至少要有一個.data檔
   '1.先檢查是否有.DATA.PDF
   strSql = "select cpp01,cpp02,cp110" & _
            " From casepaperpdf,caseprogress" & _
            " where cpp01='" & strCP09 & "'" & _
            " and substr(upper(cpp02)," & Len(".DATA.PDF") & "*-1)='.DATA.PDF'" & _
            " and cpp01=cp09(+)"
   intI = 1
   Set RsTemp = ClsLawReadRstMsg(intI, strSql)
   bolCP121isY = False
   If intI = 1 Then '存在
      strCP110 = "" & RsTemp.Fields("cp110") 'Add By Sindy 2013/10/28
      If InStr(NewCasePtyList, strCP10) > 0 Or Trim(strCPM26) <> "" Then
         '2.檢查是否有CPM26副檔名
         'Add By Sindy 2014/1/16
         If strCP10 = "307" Then '分割
            strSql = "select dc05,dc06,dc07,dc08,pa08 from divisioncase,patent" & _
                     " where dc01='" & strCP01 & "' and dc02='" & strCP02 & "' and dc03='" & strCP03 & "' and dc04='" & strCP04 & "'" & _
                     " and dc05=pa01(+) and dc06=pa02(+) and dc07=pa03(+) and dc08=pa04(+)"
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strSql)
            If intI = 1 Then
               '1.發明 2.新型 3.設計
               If RsTemp.Fields("pa08") = "1" Then
                  strFNm = UCase(".inv.PDF")
               ElseIf RsTemp.Fields("pa08") = "2" Then
                  strFNm = UCase(".utl.PDF")
               End If
            End If
'         Else
'         '2014/1/16 END
'            strFNm = UCase("." & Trim(strCPM26) & ".PDF")
         End If
         'Modify By Sindy 2015/1/29 因副檔名有的是可以+序號的,如:FIX1,FIX2,EX2 ex.P-102610
         boxChkExists = False
         For ii = 0 To 20
            If ii = 0 Then
               strFNm = UCase("." & Trim(strCPM26) & ".PDF")
            Else
               strFNm = UCase("." & Trim(strCPM26) & ii & ".PDF")
            End If
            strSql = "select cpp01,cpp02" & _
                     " From casepaperpdf" & _
                     " where cpp01='" & strCP09 & "'" & _
                     " and substr(upper(cpp02),-" & Len(strFNm) & ")='" & strFNm & "'"
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strSql)
            If intI = 0 Then '不存在
               'Add By Sindy 2014/5/21 新案的副檔名有可能從其他道程序補進來
               If AgainCheckNewCase = True Then
                  strSql = "select cpp01,cpp02" & _
                           " From casepaperpdf,caseprogress" & _
                           " where cp01='" & strCP01 & "' and cp02='" & strCP02 & "' and cp03='" & strCP03 & "' and cp04='" & strCP04 & "'" & _
                           " and cp09=cpp01(+)" & _
                           " and substr(upper(cpp02),-" & Len(strFNm) & ")='" & strFNm & "'"
                  intI = 1
                  Set RsTemp = ClsLawReadRstMsg(intI, strSql)
                  If intI = 0 Then '不存在
'                     Exit Function
                  Else '存在
                     boxChkExists = True
                     Exit For
                  End If
'               Else
'               '2014/5/21 END
'                  Exit Function
               End If
            Else '存在
               boxChkExists = True
               Exit For
            End If
         Next ii
         If boxChkExists = False Then '不存在
            Exit Function
         End If
         '2015/1/29 END
         
         '新申請案時
         If InStr(NewCasePtyList, strCP10) > 0 Then
            '3.檢查是否有.POA.PDF
            'Modify By Sindy 2013/10/28 不出名代理人則無POA檔
            If strCP110 <> "" Then
            '2013/10/28 END
               strSql = "select cpp01,cpp02" & _
                        " From casepaperpdf" & _
                        " where cpp01='" & strCP09 & "'" & _
                        " and substr(upper(cpp02),-8)='.POA.PDF'"
               intI = 1
               Set RsTemp = ClsLawReadRstMsg(intI, strSql)
               If intI = 0 Then '不存在
                  'Add By Sindy 2014/5/21 新案的POA檔有可能從其他道程序補進來
                  If AgainCheckNewCase = True Then
                     strSql = "select cpp01,cpp02" & _
                              " From casepaperpdf,caseprogress" & _
                              " where cp01='" & strCP01 & "' and cp02='" & strCP02 & "' and cp03='" & strCP03 & "' and cp04='" & strCP04 & "'" & _
                              " and cp09=cpp01(+)" & _
                              " and substr(upper(cpp02),-8)='.POA.PDF'"
                     intI = 1
                     Set RsTemp = ClsLawReadRstMsg(intI, strSql)
                     If intI = 0 Then '不存在
                        Exit Function
                     End If
                  Else
                  '2014/5/21 END
                     Exit Function
                  End If
               End If
            End If
            '4.檢查是否有.CONTACT.PDF
            strSql = "select cpp01,cpp02" & _
                     " From casepaperpdf" & _
                     " where cpp01='" & strCP09 & "'" & _
                     " and substr(upper(cpp02),-12)='.CONTACT.PDF'"
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strSql)
            If intI = 1 Then '存在
               bolCP121isY = True
            Else '不存在
               Exit Function
            End If
         Else '其他,有CPM26副檔名者
            bolCP121isY = True
         End If
      Else '其他,無CPM26副檔名者
         bolCP121isY = True
      End If
   Else '不存在
      Exit Function
   End If
   If bolCP121isY = True Then
      strSql = "update caseprogress set cp121='Y' where cp09='" & strCP09 & "'"
      cnnConnection.Execute strSql
   End If
   'Add By Sindy 2014/5/21 檢查此案號的新申請案是否已歸足檔案
   If AgainCheckNewCase = False Then
      If InStr(NewCasePtyList, strCP10) = 0 Then '一進來的文號為非新案時
         strSql = "select cp09,cp10,cpm26 from caseprogress,casepropertymap" & _
                  " where cp01='" & strCP01 & "' and cp02='" & strCP02 & "' and cp03='" & strCP03 & "' and cp04='" & strCP04 & "'" & _
                  " and cp10 in(" & NewCasePtyList & ")" & _
                  " and cp57 is null and cp118 is not null and cp120='Y' and cp121 is null" & _
                  " and cp01=cpm01(+) and cp10=cpm02(+)"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strSql)
         If intI = 1 Then
            strCP09 = RsTemp.Fields("cp09")
            strCP10 = RsTemp.Fields("cp10")
            strCPM26 = RsTemp.Fields("cpm26")
            AgainCheckNewCase = True
            GoTo AgainCheck
         End If
      End If
   End If
   '2014/5/21 END
End Function

'Add By Sindy 2013/11/28
'更改承辦人時,一併更新最後一筆歷程的收受者
'pEmpKind:1.承辦人 2.繪圖人員 3.智權人員
Public Sub PUB_ChgEmpUpdEEP05(ByVal pCP09 As String, ByVal pEmpOld As String, ByVal pEmpNew As String, ByVal pEmpKind As String)
   Dim rsQuery As ADODB.Recordset, stSQL As String, intR As Integer
   Dim strEMPOldNM As String, strEMPNewNM As String
   
   If pEmpOld <> "" And pEmpNew <> "" And pEmpOld <> pEmpNew Then
      stSQL = "select * from empelectronprocess where eep01='" & pCP09 & "'" & _
              " and eep02=(select nvl(max(eep02),0) from empelectronprocess where eep01='" & pCP09 & "')"
      If pEmpKind = "1" Then
         stSQL = stSQL & " and eep04 in(" & EMP_收受者為承辦人 & ")"
      ElseIf pEmpKind = "2" Then
         stSQL = stSQL & " and eep04 in(" & EMP_收受者為繪圖人員 & ")"
      ElseIf pEmpKind = "3" Then
         stSQL = stSQL & " and eep04 in(" & EMP_收受者為智權人員 & ")"
      End If
      intR = 1
      Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         With rsQuery
            If .Fields("eep05") = pEmpOld Then
               strEMPOldNM = GetPrjSalesNM(pEmpOld)
               strEMPNewNM = GetPrjSalesNM(pEmpNew)
               stSQL = "update empelectronprocess set eep05=" & CNULL(pEmpNew) & ",eep08='" & ChangeWStringToTDateString(strSrvDate(1)) & "轉案，原承辦人" & strEMPOldNM & "。'||eep08 where eep01='" & pCP09 & "' and eep02=" & .Fields("eep02")
               cnnConnection.Execute stSQL, intR
            End If
         End With
      End If
      
      'Add By Sindy 2015/11/27 CFP-028121 原承辦人是林建志(送日核),改為李秉濤(送英核),所以要把核稿語言清掉
      If PUB_ChkEmpFlowExists(pCP09, EMP_核完) = False And PUB_ChkEmpFlowExists(pCP09, EMP_判發) = False Then
         stSQL = "update engineerprogress set ep41=null where ep02='" & pCP09 & "'"
         cnnConnection.Execute stSQL, intR
      End If
      '2015/11/27 END
   End If
   
   Set rsQuery = Nothing
End Sub

'Add by Amy 2014/08/14
'新增申請書轉檔記錄
'Modified by Morgan 2015/11/4 +pNoAutoPdf:不自動轉Pdf,pAF06 判發人
'Modified by Morgan 2016/5/12 +pAF13:主旨
Public Sub PUB_AddAppForm(pAF01 As String, Optional pNoAutoPdf As Boolean = False, Optional pAF06 As String, Optional pAF13 As String)
   Dim stSQL As String, intR As Integer
   
   stSQL = "delete Appform where af01='" & pAF01 & "'"
   cnnConnection.Execute stSQL, intR
   
   If pNoAutoPdf Then
      'Modified by Morgan 2018/8/30 因已新增建立日期欄位,AF03改放19221111以便識別為不自動轉Pdf)
      'stSQL = "Insert Into AppForm (AF01,AF02,AF03,AF06,AF13) Values('" & pAF01 & "','" & strUserNum & "',TO_CHAR(sysdate,'yyyymmdd'),'" & pAF06 & "','" & ChgSQL(pAF13) & "')"
      stSQL = "Insert Into AppForm (AF01,AF02,AF03,AF06,AF13) Values('" & pAF01 & "','" & strUserNum & "',19221111,'" & pAF06 & "','" & ChgSQL(pAF13) & "')"
   Else
      stSQL = "Insert Into AppForm (AF01,AF06,AF13) Values('" & pAF01 & "','" & pAF06 & "','" & ChgSQL(pAF13) & "')"
   End If
   cnnConnection.Execute stSQL, intR
End Sub

'Added by Morgan 2014/9/11
Public Function PUB_UpdateLP03(Optional pCRecNo As String) As Boolean
   Dim stSQL As String, intR As Integer, stCon As String
   Dim rsA As New ADODB.Recordset
   
   '剔除客戶函
   'Modified by Morgan 2018/7/3 +剔除空白回覆單(.BLANK.PDF)
   'Modified by Morgan 2021/3/19 排除 .info. (IDS報價會先上傳卷宗區)--玲玲
   stCon = " and instr(upper(cpp02),'.CUS.PDF')=0 and instr(upper(cpp02),'.BLANK.PDF')=0 and instr(upper(cpp02),'.INFO.')=0"
   
   'Added by Morgan 2014/10/1
   '非來函目前附件只有收據，將來若有其他附件時需要剔除申請書(.DATA.PDF)、接洽單(.MENU,.ORDER.PDF)
   stCon = stCon & " and (cpp01>'C' or (cpp01<'C' and substr(upper(cpp02),-12)='.RECEIPT.PDF'))"
   'end 2014/10/1
   
   'Modified by Morgan 2016/6/2
   '齊備規則:
   '1.卷宗區pdf檔案數>=LP02
   '2.設有收據(LP19='Y')時卷宗區要有.RECEIPT.PDF檔
   '3.非臺灣案除通知期限(1913,1915)外都要檢查cp121='Y'(因為匯入程式要做缺檔檢查如 altr,inv...)
   'Modified by Morgan 2018/1/30 +代理人來函(ALTR) 可放 MSG 格式
   'Modified by Morgan 2018/8/29 cp121檢查+cp09<'D'條件(只抓C類)
   'Modified by Morgan 2018/10/8 收據
   'Modified by Morgan 2018/12/5 1913,1915已改D類，檢查altr副檔不必再特別剔除
   'Modify By Sindy 2021/1/5 剔除台灣商標案-通知申請案號
   'Modify By Sindy 2021/3/24 有2張收據 T-228505 612.補充理由(經濟部,經濟部智慧財產局)
   '" And (lp19 is null or Exists (Select * From CasePaperPdf Where InStr(Upper(cpp02),'.RECEIPT.PDF')+InStr(Upper(cpp02),'.FIL.PDF')>0 And cpp01=lp01 And cpp10<>'D'))"
   '=>
   '" And (lp19 is null or Exists (" & _
      "SELECT * FROM caseprogress WHERE cp09=lp01" & _
      " AND Decode(cp130,NULL,0,Counting(cp130))<=(SELECT count(*) FROM CasePaperPdf WHERE InStr(Upper(cpp02),'.RECEIPT.PDF')+InStr(Upper(cpp02),'.FIL.PDF')>0 AND cpp01=cp09 AND cpp10<>'D'))" & _
      ")"
   'Modified by Morgan 2022/11/23 若有收據(LP19='Y')時不論是否有主管機關至少要有1張收據:Decode(cp130,NULL,0 --> Decode(cp130,NULL,1
   stSQL = "UPDATE letterprogress SET lp03=" & strSrvDate(1) & ",lp05=decode(lp04||lp10,'Y'," & strSrvDate(1) & ",lp05) WHERE lp03=0 " & IIf(pCRecNo <> "", " and lp01='" & pCRecNo & "'", "") & _
      " AND EXISTS(SELECT 1 FROM casepaperpdf WHERE cpp01=lp01 and cpp10<>'D' AND (SUBSTR(UPPER(CPP02),-4)='.PDF' or (SUBSTR(UPPER(CPP02),-4)='.MSG' and instr(upper(cpp02),'.ALTR.')>0))" & stCon & " HAVING COUNT(*)>=lp02)" & _
      " And (lp19 is null or Exists (" & _
      "SELECT * FROM caseprogress WHERE cp09=lp01" & _
      " AND Decode(cp130,NULL,1,Counting(cp130))<=(SELECT count(*) FROM CasePaperPdf WHERE InStr(Upper(cpp02),'.RECEIPT.')+InStr(Upper(cpp02),'.FIL.')>0 AND cpp01=cp09 AND cpp10<>'D')" & _
      "))" & _
      " And not exists(select * from caseprogress,patent where cp09=lp01 and cp09>'C' and cp09<'D' and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04 and pa09<>'000' and cp121 is null)" & _
      " And not exists(select * from caseprogress,trademark where cp09=lp01 and cp10='1101' and tm01(+)=cp01 and tm02(+)=cp02 and tm03(+)=cp03 and tm04(+)=cp04 and tm10='000')"
   'end 2016/6/2
   cnnConnection.Execute stSQL, intR
   If intR > 0 Then PUB_UpdateLP03 = True
   
   'Modify By Sindy 2021/4/6 更新台灣案分割(308)子案, 要等母案電子收據回來後才能出現在發文室
   stSQL = "UPDATE letterprogress SET lp03=" & strSrvDate(1) & ",lp05=decode(lp04||lp10,'Y'," & strSrvDate(1) & ",lp05)" & _
           " WHERE lp01 in(" & _
           "SELECT lp01 FROM letterprogress,caseprogress,trademark,divisioncase" & _
           " WHERE lp03=0 AND lp01=cp09(+) AND cp10='308' AND cp01='T'" & _
           " AND cp01=tm01(+) AND cp02=tm02(+) AND cp03=tm03(+) AND cp04=tm04(+) AND tm10='000'" & _
           " AND dc01=cp01 AND dc02=cp02 AND dc03=cp03 AND dc04=cp04" & _
           " AND EXISTS (SELECT * FROM CasePaperPdf,caseprogress c2 WHERE InStr(Upper(cpp02),'.RECEIPT.PDF')>0 AND cpp10<>'D'" & _
           " AND c2.cp01=dc05 AND c2.cp02=dc06 AND c2.cp03=dc07 AND c2.cp04=dc08" & _
           " AND cpp01=c2.cp09 AND c2.cp10='308')" & _
           " AND EXISTS (SELECT * FROM CasePaperPdf WHERE InStr(Upper(cpp02),'.CUS.PDF')>0 AND cpp01=cp09 AND cpp10<>'D')" & _
           ")"
   cnnConnection.Execute stSQL, intR
   If intR > 0 Then PUB_UpdateLP03 = True
   
   'Add By Sindy 2021/1/5 更新商標的通知申請案號-申請
   stSQL = "UPDATE letterprogress SET lp03=" & strSrvDate(1) & ",lp05=decode(lp04||lp10,'Y'," & strSrvDate(1) & ",lp05)" & _
           " WHERE lp01 in(" & _
           "SELECT lp01 FROM letterprogress,caseprogress,trademark" & _
           " WHERE lp03=0 AND lp01=cp09(+) AND cp10='1101' AND cp01='T'" & _
           " AND cp01=tm01(+) AND cp02=tm02(+) AND cp03=tm03(+) AND cp04=tm04(+) AND tm10='000'" & _
           " AND EXISTS (SELECT * FROM CasePaperPdf WHERE InStr(Upper(cpp02),'.RECEIPT.PDF')>0 AND cpp01=cp43 AND cpp10<>'D')" & _
           " AND EXISTS (SELECT * FROM CasePaperPdf WHERE InStr(Upper(cpp02),'.CUS.PDF')>0 AND cpp01=cp09 AND cpp10<>'D')" & _
           ")"
   cnnConnection.Execute stSQL, intR
   If intR > 0 Then PUB_UpdateLP03 = True
   
   Set rsA = Nothing
End Function

'Mark by Lydia 2025/04/30 (2022/8/5) 已改成Trigger: SETSPECMAN_BEFORE
''Add By Sindy 2014/9/11
''CFT承辦人有異動時,更新CFT該國案件之下一程序未處理催審期限之智權人員
'Public Function PUB_UpdNpCFT305Np10(strEmp As String, strNA01 As String, Optional ByVal int011Area As Integer) As Boolean
''str011Area : 1=CFT_011B '北所
''             2=CFT_011A '中南高所
''Modified by Lydia 2016/11/16 +CFT101239A,CFT101239B
''             3=未指定(保留給其他國家)
''             4=CFT_101239A '南高所
''             5=CFT_101239B '北所 'Modified by Lydia 2018/10/03
''             6=CFT_101239C '中所  'Added by Lydia 2018/10/03  分成CFT_101239B(北所)和CFT_101239C(中所)
'
'On Error GoTo ErrHand
'
'   '只更新大於等於系統日的催審期限,且未閉卷未銷卷
'   strSql = "update nextprogress set np10='" & Trim(strEmp) & "'" & _
'            " where np02='CFT' and np07 in('305','997','998','1711','312') and np06 is null and np08>=" & strSrvDate(1) & _
'              " and exists (select tm01 from trademark where np02=tm01 and np03=tm02 and np04=tm03 and np05=tm04 and tm10='" & Left(Trim(strNA01), 3) & "' and tm29 is null and tm57 is null)"
'   If int011Area = 1 Then
'      strSql = strSql & "and exists (select cp09 from caseprogress,staff where np01=cp09 and cp13=st01 and st06='1')"
'   ElseIf int011Area = 2 Then
'      strSql = strSql & "and exists (select cp09 from caseprogress,staff where np01=cp09 and cp13=st01 and st06<>'1')"
'   'Added by Lydia 2016/11/16 +CFT101239A,CFT101239B
'   ElseIf int011Area = 4 Then
'      strSql = strSql & "and exists (select cp09 from caseprogress,staff where np01=cp09 and cp13=st01 and st06 not in ('1','2'))"
'   ElseIf int011Area = 5 Then
'      'Modified by Lydia 2018/10/03 分成CFT_101239B(北所)
'      'strSql = strSql & "and exists (select cp09 from caseprogress,staff where np01=cp09 and cp13=st01 and st06 in ('1','2'))"
'      strSql = strSql & "and exists (select cp09 from caseprogress,staff where np01=cp09 and cp13=st01 and st06='1')"
'   'end 2016/11/16
'   'Added by Lydia 2018/10/03 分成CFT_101239C(中所)
'   ElseIf int011Area = 6 Then
'      strSql = strSql & "and exists (select cp09 from caseprogress,staff where np01=cp09 and cp13=st01 and st06='2')"
'   'end 2018/10/03
'   End If
'   cnnConnection.Execute strSql
'   PUB_UpdNpCFT305Np10 = True
'   Exit Function
'
'ErrHand:
'   PUB_UpdNpCFT305Np10 = False
'   MsgBox (Err.Description)
'End Function
'end ---- Mark by Lydia 2025/04/30

'Add By Sindy 2014/7/17
'儲存卷和代表圖檔
'Modify By Sindy 2014/10/8 +strIBF06
Public Function SaveImgByteFile(ByVal strFilePath As String, ByVal strIBF01 As String, ByVal strIBF02 As String, _
                                ByVal strIBF03 As String, ByVal strIBF04 As String, ByVal strIBF05 As String, _
                                ByVal strIBF06 As String) As Boolean
Dim stFilePath As String
Dim iFileNo As Integer
Dim bytes() As Byte
Dim lngSize As Long '檔案大小
Dim adoRst As New ADODB.Recordset
Const BlockSize = 500000
Dim Numblocks As Integer
Dim LeftOver As Long
Dim rsA As New ADODB.Recordset
Dim strReName As String, strFtpPath As String
'Modified by Lydai 2021/01/08 改宣告變數
'Dim jj As Integer
Dim intA As Integer, strA1 As String

   SaveImgByteFile = False
   If strFilePath = "" Then
      MsgBox "請輸入欲存檔的檔案路徑及名稱！"
      Exit Function
   End If
   stFilePath = strFilePath
   If iFileNo > 0 Then Close #iFileNo
   iFileNo = FreeFile
   Open stFilePath For Binary Access Read As #iFileNo
   lngSize = LOF(iFileNo)

   strA1 = "select count(*) from imgbytefile where ibf01='" & strIBF01 & "' and ibf02='" & strIBF02 & "' and ibf03='" & strIBF03 & "' and ibf04='" & strIBF04 & "' and ibf05='" & strIBF05 & "'"
   intA = 1
   Set rsA = ClsLawReadRstMsg(intA, strA1)
   If intA = 1 Then
      If rsA.Fields(0) = 1 Then
         'Modified by Lydia 2024/03/14 +加註【上傳卷和代表圖檔】
         If MsgBox(strIBF01 & "-" & strIBF02 & "-" & strIBF03 & "-" & strIBF04 & "資料已存在，確定是否覆蓋舊檔？", vbExclamation + vbYesNo + vbDefaultButton2, "【上傳卷和代表圖檔】重要訊息！") = vbNo Then
            Exit Function
         Else
            strSql = "delete from imgbytefile where ibf01='" & strIBF01 & "' and ibf02='" & strIBF02 & "' and ibf03='" & strIBF03 & "' and ibf04='" & strIBF04 & "' and ibf05='" & strIBF05 & "'"
            cnnConnection.Execute strSql
         End If
      ElseIf rsA.Fields(0) > 1 Then
         'Modified by Lydia 2024/03/14 +加註【上傳卷和代表圖檔】重要訊息！
         MsgBox strIBF01 & "-" & strIBF02 & "-" & strIBF03 & "-" & strIBF04 & "目前有" & rsA.Fields(0) & "筆資料存在，請檢查資料是否有誤！", , "【上傳卷和代表圖檔】重要訊息！"
         Exit Function
      End If
   End If
   With adoRst
      If adoRst.State = adStateClosed Then
         strA1 = "select * from ImgByteFile where rownum<1"
         .CursorLocation = adUseClient
         .Open strA1, cnnConnection, adOpenStatic, adLockOptimistic
      End If
      .AddNew
      .Fields("IBF01").Value = strIBF01
      .Fields("IBF02").Value = strIBF02
      .Fields("IBF03").Value = strIBF03
      .Fields("IBF04").Value = strIBF04
      .Fields("IBF05").Value = strIBF05 '1.代表圖 2.卷 3.人事員工照片 4.報表樣本 5.請作單
      .Fields("IBF06").Value = strIBF06 '格式：1.圖檔(黑白位圖) 2.圖檔(彩色位圖) 3.圖檔(黑白向量圖) 4.圖檔(彩色向量圖) 5.多頁檔(PDF,XDW,TIFF)
      .Fields("IBF07").Value = strUserNum
      .Fields("IBF08").Value = Format(Now, "yyyymmdd")
      .Fields("IBF09").Value = Format(Now, "hhmm")
      .Fields("IBF13").Value = lngSize

      Numblocks = lngSize / BlockSize
      LeftOver = lngSize Mod BlockSize

'      ReDim bytes(LeftOver)
'      Get #iFileNo, , bytes()
'      .Fields("IBF14").AppendChunk bytes()

'      ReDim bytes(BlockSize)
'      For jj = 1 To Numblocks
'          Get #iFileNo, , bytes()
'          .Fields("IBF14").AppendChunk bytes()
'      Next jj
      Close #iFileNo

      'Modify By Sindy 2017/8/10
      '檔案改放FTP
      strReName = strIBF01 & "-" & strIBF02 & "-" & strIBF03 & "-" & strIBF04 & "-" & strIBF05
      PUB_PutFtpFile stFilePath, strReName, strReName, strFtpPath, UCase("imgbytefile")
      If strFtpPath <> "" Then
         .Fields("ibf15") = strFtpPath
      End If
      '2017/8/10 END

      .UPDATE

      SaveImgByteFile = True
   End With

   Set rsA = Nothing
   Exit Function

ErrHnd:
   Set rsA = Nothing
   'Modified by Lydia 2024/03/14 +加註【上傳卷和代表圖檔】
   MsgBox Err.Description, vbCritical, "【上傳卷和代表圖檔】"
   If iFileNo > 0 Then Close #iFileNo
End Function

'Removed by Lydia 2014/12/11 原本在acc_fun
'Add by Amy 2014/11/13 取得會計科目借貸方別(大項)
Public Function GetClassDebitCredit(ByVal stCode As String) As String
    GetClassDebitCredit = "" '1.借 2.貸
     Select Case stCode
        Case "1"
            GetClassDebitCredit = "1"
        Case "2"
            GetClassDebitCredit = "2"
        Case "3"
            GetClassDebitCredit = "2"
        Case "4"
            GetClassDebitCredit = "2"
        Case "6"
            GetClassDebitCredit = "1"
        Case "7"
            GetClassDebitCredit = "2"
    End Select
End Function

'Add by Lydia 2014/12/19
'判斷傳入excel檔的值,若為0則以0顯示
'cSysType=1 判斷單一數值, =2 判斷運算式
'cValCode=0 , 則回傳0
'WorkString 原運算式
'PUB_ChkExcelZero 回傳excel之運算式
Public Function PUB_ChkExcelZero(cSysType As Integer, Optional cValCode As String, Optional WorkString As String) As String
Dim tmpStrA As String
   
If cSysType = 1 Then
   If Len(Trim(cValCode)) = 0 Or Val(cValCode) = 0 Then
      PUB_ChkExcelZero = "0"
   Else
      PUB_ChkExcelZero = cValCode
   End If
ElseIf cSysType = "2" Then
    '重組excel為IF函數
    tmpStrA = Replace(WorkString, "=", "")
    tmpStrA = "=IF(" & cValCode & " =0,0," & tmpStrA & ")"
    PUB_ChkExcelZero = tmpStrA
End If

End Function

''Added by Morgan 2014/12/24 改 frm04010502_3.GetFee 為共用
''設定大陸領證費
''Added by Lydia 2015/03/27 + PA01
'Public Function PUB_GetFee(ByVal pPA01 As String, pPA09 As String, pPA08 As String, pPA26 As String, pYear As String, Optional ByRef p601OfficialFee As Double, Optional pCP44 As String) As Long
'   Dim lTmp As Long, lBase As Long, lPlus As Long
'
'   '客戶只抓服務費,規費改抓代理人設定,否則調價後會不同步
'   '服務費
'   lTmp = PUB_GetYF06(pPA09, pPA08, ChangeCustomerL(pPA26), "601", "1", "1", pPA01)
'   If lTmp = 0 Then
'      lTmp = PUB_GetYF06(pPA09, pPA08, "Y00000001", "601", "1", "1", pPA01)
'   End If
'
'
'   '規費
'   p601OfficialFee = 0 'Added by Morgan 2018/2/27 要先設0否則若沒有代理人時會用原值而不會重抓領證規費Ex.P117457
'   '目前代理人都沒有設定,考慮取消此功能(因為填寫接洽單時不會知道發文代理人)
'   If pCP44 <> "" Then
'      p601OfficialFee = PUB_GetYF07(pPA09, pPA08, ChangeCustomerL(pCP44), "601", "1", "1", pPA01)
'   End If
'   If p601OfficialFee = 0 Then
'      p601OfficialFee = PUB_GetYF07(pPA09, pPA08, "Y00000001", "601", "1", "1", pPA01)
'   End If
'
'   '年費(先抓1-3年的Base金額,再抓輸入大陸年度的金額, 計算出差額, 再加上上面之領證則為大陸領證費)
'   If Val(pYear) > 0 And pYear <> "3" Then
'      If pCP44 <> "" Then
'         lBase = PUB_GetYF07(pPA09, pPA08, ChangeCustomerL(pCP44), "605", "3", "3", pPA01)
'      End If
'      If lBase = 0 Then
'         lBase = PUB_GetYF07(pPA09, pPA08, "Y00000001", "605", "3", "3", pPA01)
'      End If
'
'      If pCP44 <> "" Then
'         lPlus = PUB_GetYF07(pPA09, pPA08, ChangeCustomerL(pCP44), "605", pYear, pYear, pPA01)
'      End If
'      If lPlus = 0 Then
'         lPlus = PUB_GetYF07(pPA09, pPA08, "Y00000001", "605", pYear, pYear, pPA01)
'      End If
'      p601OfficialFee = p601OfficialFee + lPlus - lBase
'   End If
'   PUB_GetFee = lTmp + p601OfficialFee
'End Function

'Added by Morgan 2014/12/24
'大陸年費起始年度(核准日起算)
Public Function PUB_GetChina605StartYear(pPA20 As String, pPA10 As String) As String
   'Memo by Morgan 2009/10/20 核准日+5個月為預定公告日--敏惠
   PUB_GetChina605StartYear = Int((TransDate(CompDate(1, 5, pPA20), 2) - TransDate(pPA10, 2)) / 10000) + 1
End Function

'Added by Morgan 2014/12/24
'大陸年費起始年度(抓核准記錄的年度)
Public Function PUB_GetChina605StartYear2(pPA01 As String, pPA02 As String, pPA03 As String, pPA04 As String) As String
   Dim stSQL As String
   Dim intR As Integer
   Dim rsQuery As ADODB.Recordset
   
   stSQL = "select cp53 from caseprogress where cp01='" & pPA01 & "' and cp02='" & pPA02 & "' and cp03='" & pPA03 & "' and cp04='" & pPA04 & "' and cp01='1001' and exists(select * from nextprogress where np01=cp09 and np07='601') and cp53 is not null"
   Set rsQuery = Nothing
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      PUB_GetChina605StartYear2 = Val(rsQuery(0))
   End If
End Function
'Add by Lydia 2014/12/30
'抓EPC主張優先權之案件其所主張優先權案件(Pridate)之狀態列出(C類),供工程師報告時參考。
Public Function PUB_GetEPCPriDLatest(eAppNo As String, eNa As String, ByRef eMs01 As String, ByRef eMs02 As String, ByRef eMs03 As String, msgKind As String) As String
   Dim stSQL As String, intR As Integer
   Dim adoRst As ADODB.Recordset
   Dim mCheck As Boolean
   stSQL = "select distinct RPAD(CP01||'-'||CP02||'-'||CP03||'-'||CP04,15) E01, RPAD(NA03,16) E02, RPAD(PTM03,6) E03,cp05,cp09,c05,cp10,cpm03 " & _
           "from caseprogress,casepropertymap,PatentTrademarkMap,nation, (" & _
           "select 1 od1 ,PA08 od2,PA09 od3,PA01 c01,PA02 c02,PA03 c03,PA04 c04,PA16 c05 from patent where PA11='" & eAppNo & "' and PA09='" & eNa & "' " & _
           "union select 2 od1,TM08 od2,TM10 od3,TM01 c01,TM02 c02,TM03 c03,TM04 c04,TM16 c05 from trademark where TM12='" & eAppNo & "' and TM10='" & eNa & "' ) X " & _
           "where cp01=c01 and cp02=c02 and cp03=c03 and cp04=c04 and cp01=cpm01 and cp10=cpm02 and substr(cp09,1,1)='C' and od3=na01(+) " & _
           "and ptm01=od1 and ptm02=od2 order by cp05 desc "
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      If msgKind = "1" Then
         PUB_GetEPCPriDLatest = adoRst!e01
         eMs01 = "" & adoRst!e02
         eMs02 = "" & adoRst!e03
         eMs03 = "" & Trim(adoRst!cpm03) & PUB_GetRelateCasePropertyName(adoRst!CP09, "1")
      Else
         '回覆檢索報告(218)發文(作業)時,再次檢查所主張之案件,若已有審查結果(如審查意見通知函、檢索報告1202+1209)時,則show訊息提醒
         adoRst.MoveFirst
         Do While Not adoRst.EOF
            'Modified by Lydia 2016/05/06 +""
            If Val("" & adoRst!C05) >= 1 Then '已准/駁
               mCheck = True
            Else
               If InStr("1202,1209", adoRst!CP10) > 0 Then mCheck = True
            End If
            If mCheck = True Then
                'Modified by Lydia 2016/05/06 +""
                PUB_GetEPCPriDLatest = "" & adoRst!e01
                eMs01 = "" & adoRst!e02
                eMs02 = "" & adoRst!e03
                eMs03 = "" & Trim(adoRst!cpm03) & PUB_GetRelateCasePropertyName(adoRst!CP09, "1")
                Exit Do
            End If
            adoRst.MoveNext
         Loop

      End If
   Else
      PUB_GetEPCPriDLatest = ""
   End If
   Set adoRst = Nothing
End Function

'Add By Sindy 2015/1/7 儲存回覆單
'Modify By Sindy 2015/5/18 +Optional strCPP11 As String = "" 結案單下一程序序號/電子表單單號
'Modified by Lydia 2015/10/30 +上傳開庭通知附件(strTyp)
'Modify By Sindy 2016/6/24 Optional strTyp As String = "" ==> Optional strTyp As String = EMP_回覆單
'Modify By Sindy 2022/10/11 + , Optional strCPP15 As String = "" : 檔案類別=1.官方文件(電子收文) 2.內部文件(電子收文) 3.案件回覆單
'Modify by Amy 2025/05/13 +strFormN/strCPP12/strCCM17
Public Function PUB_UpdReplyFile(m_strSaveFiles As String, strCP09 As String, _
   strCP01 As String, strCP02 As String, strCP03 As String, strCP04 As String, _
   Optional strCP10 As String = "", Optional strCPP11 As String = "", Optional strTyp As String = EMP_回覆單, _
   Optional strCPP15 As String = "", Optional strFormN As String = "", Optional strCPP12 As String = "", Optional strCCM17 As String = "") As Boolean

Dim fs, f, sFile
Dim stFileName As String, stReName As String
Dim varTemp As Variant
Dim ii As Integer, jj As Integer
Dim TypKind As String 'Added By Lydia 2015/10/30
Dim intSeqno As Integer 'Add By Sindy 2016/6/27
Dim strCase2 As String, strWord As String
Dim strKey As String, strCPP10 As String 'Add By Sindy 2022/12/21
Dim old_strTyp As String 'Add By Sindy 2023/7/19
Dim strWhr As String 'Add by Amy 2025/05/13

   Select Case UCase(strFormN)
      Case "FRM210133"
      Case "FRM210133_F" 'FC結案單
   End Select
   
   old_strTyp = strTyp 'Add By Sindy 2023/7/19 記錄傳入的副檔名
   PUB_UpdReplyFile = True
   If m_strSaveFiles <> "" Then
      Set fs = CreateObject("Scripting.FileSystemObject")
      varTemp = Split(m_strSaveFiles, "&")
      intSeqno = 0
      For ii = 0 To UBound(varTemp)
         stFileName = varTemp(ii)
         If InStrRev(varTemp(ii), " (") > 0 Then
            'Add By Sindy 2021/8/6 排除 C:\Program Files (x86) 狀況
            If UCase(Mid(varTemp(ii), InStrRev(varTemp(ii), " (") + 1, Len("(X86)"))) <> "(X86)" Then
            '2021/8/6 END
               stFileName = Left(varTemp(ii), InStrRev(varTemp(ii), " (") - 1)
            End If
         End If
         Set f = fs.GetFile(stFileName)
         
         '**********************************
         '新案
         '**********************************
         'Add By Sindy 2022/9/7 接洽單編號+.+新案附件
         If Trim(strCP02) = "" Then
            If InStrRev(stFileName, "\") > 0 Then
               strExc(10) = Mid(stFileName, InStrRev(stFileName, "\") + 1)
            Else
               strExc(10) = stFileName
            End If
            'Add By Sindy 2023/8/23 2=內部文件,若未有副檔名者,一律更名為客戶資料(case)
            If strCPP15 = "2" Then
               'Modify By Sindy 2025/9/22 and efc02<>'PROC' 改為 and efc02 not in('PROC','CUS')
               strSql = "select EFC01,EFC02 from efilecaption where EFC06='Y'" & _
                        " and instr(upper('." & strExc(10) & "'),upper('.'||EFC02||'.'))>0" & _
                        " and efc01 in('ALL','" & strCP01 & "') and efc02 not in('PROC','CUS')"
               intI = 1
               Set RsTemp = ClsLawReadRstMsg(intI, strSql)
               If intI = 0 Then
                  stReName = strCPP11 & "." & strTyp & Mid(strExc(10), InStrRev(strExc(10), "."))
               Else
                  stReName = strCPP11 & "." & Replace(strExc(10), "'", "")
               End If
            Else
            '2023/8/23 END
               stReName = strCPP11 & "." & Replace(strExc(10), "'", "")
            End If
            
'            '新案還沒有給號,去掉電子檔名最前面的案號 Ex:英國脫歐
'            If InStr(stFileName, ".") > 0 Then
'               strExc(0) = Mid(strExc(10), 1, InStr(strExc(10), ".") - 1)
'               '有系統別
'               If strCP01 <> "" And strCP01 = Mid(strExc(0), 1, Len(strCP01)) Then
'                  strCase2 = ""
'                  For jj = Len(strCP01) + 1 To Len(strExc(0))
'                     strWord = Mid(strExc(0), jj, 1)
'                     If IsNumeric(strWord) = True Then
'                        strCase2 = strCase2 & strWord
'                     Else
'                        Exit For
'                     End If
'                  Next jj
'                  '檢查是否為案號
'                  If strCase2 <> "" Then
'                     strCase2 = Format(strCase2, "000000") '補足6碼
'                     strSql = "SELECT count(*) FROM caseprogress WHERE CP01='" & strCP01 & "' and CP02='" & strCase2 & "'"
'                     intI = 1
'                     Set RsTemp = ClsLawReadRstMsg(intI, strSql)
'                     If intI = 1 Then
'                        '去掉案號
'                        If RsTemp.Fields(0) > 0 Then
'                           strExc(10) = Mid(strExc(10), InStr(strExc(10), ".") + 1)
'                        End If
'                     End If
'                  End If
'               End If
'            End If
'
'            '2.內部文件(電子收文)
'            TypKind = ""
'            If strCPP15 = "2" Then
'               TypKind = "Case"
'            Else '1.官方文件(電子收文)
'               strSql = "select EFC01,EFC02 from efilecaption where EFC06='Y'" & _
'                        " and instr(upper('." & strExc(10) & "'),upper('.'||EFC02||'.'))>0" & _
'                        " and efc01 in('ALL','" & strCP01 & "') and efc02<>'PROC'"
'               intI = 1
'               Set RsTemp = ClsLawReadRstMsg(intI, strSql)
'               If intI = 1 Then
'                  TypKind = RsTemp.Fields("EFC02")
'               End If
'            End If
'            strExc(9) = Mid(strExc(10), InStrRev(strExc(10), "."), Len(strExc(10))) '取得檔案類型
'            stReName = strCPP11
'            If UBound(varTemp) > 0 Then
'               intSeqno = intSeqno + 1
'               stReName = stReName & "." & intSeqno & IIf(TypKind <> "", "." & TypKind, "") & strExc(9)
'            Else
'               stReName = stReName & IIf(TypKind <> "", "." & TypKind, "") & strExc(9)
'            End If
         Else
         '2022/9/7 END
         
            '更名
            'Modify By Sindy 2020/2/12 本所案號流水號要完整6碼
   '         stReName = Trim(strCP01) & Val(Trim(strCP02)) & _
   '                    IIf(strCP03 & strCP04 <> "000", "-" & strCP03, IIf(strCP04 <> "00", "-" & strCP04, ""))
            'Modified by Morgan 2020/12/21
            'stReName = Trim(strCP01) & Trim(strCP02) & _
                       IIf(strCP03 & strCP04 <> "000", "-" & strCP03, IIf(strCP04 <> "00", "-" & strCP04, ""))
            stReName = Trim(strCP01) & Trim(strCP02) & _
                       IIf(strCP03 & strCP04 <> "000", "-" & strCP03, "") & IIf(strCP04 <> "00", "-" & strCP04, "")
            'end 2020/12/21
            '2020/2/12 END
            If strCP10 <> "" Then
               stReName = stReName & "." & strCP10
            End If
            'Add By Sindy 2015/5/18
            If strCPP11 <> "" Then
               stReName = stReName & "." & strCPP11
            End If
            '2015/5/18 END
            'Add by Amy 2025/05/22 FC結案單,若為系統收件區夾帶者,檔名=案號+.結案單號+strCCM17+.副檔名
            If UCase(strFormN) = "FRM210133_F" And strCCM17 <> "" And InStr(stFileName, strCCM17) > 0 Then
               stReName = stReName & "." & strCCM17
            End If
            'end 2025/05/15
            
            'Add By Sindy 2023/1/13 接洽單回覆單匯入區開放可以存其它副檔名
            'Modify By Sindy 2025/9/22 and efc02<>'PROC' 改為 and efc02 not in('PROC','CUS')
            If strCPP15 = "3" Then
               strSql = "select EFC01,EFC02 from efilecaption where EFC06='Y'" & _
                        " and instr(upper('." & stFileName & "'),upper('.'||EFC02||'.'))>0" & _
                        " and efc01 in('ALL','" & strCP01 & "') and efc02 not in('PROC','CUS')"
               intI = 1
               Set RsTemp = ClsLawReadRstMsg(intI, strSql)
               If intI = 1 Then
                  strTyp = RsTemp.Fields("EFC02")
               Else
                  strTyp = old_strTyp 'Add By Sindy 2023/7/19 電子檔本身沒有指定副檔名,則用傳入的副檔名命名
               End If
            End If
            '2023/1/13 END
            
            'Added by Lydia 2015/10/30 +上傳開庭通知附件
            Select Case strTyp
                'Case "OA": TypKind = "pdf"
                'Modify By Sindy 2016/6/27 +原檔案類型副檔名(不含前面的.)
                Case "OA": TypKind = Mid(stFileName, InStrRev(stFileName, ".") + 1)
                'Modify By Sindy 2016/6/27 原檔案類型副檔名(含前面的.)
                'Case Else: TypKind = EMP_回覆單 & ".pdf" '預設
                Case Else: TypKind = strTyp & Mid(stFileName, InStrRev(stFileName, "."))
                '2016/6/24 END
            End Select
            'Modify By Sindy 2023/8/24 mark
'            If UBound(varTemp) > 0 Then
'               intSeqno = intSeqno + 1
'               'stReName = stReName & "." & ii + 1 & "." & EMP_回覆單 & ".pdf"
'               stReName = stReName & "." & intSeqno & "." & TypKind
'            Else
            '2023/8/24 END
               'stReName = stReName & "." & EMP_回覆單 & ".pdf"
               stReName = stReName & "." & TypKind
'            End If
            'end 2015/10/30
         End If
         
         '存檔：
         '接洽單：直接存總收文號 或 新案存接洽單編號
         '結案單：統一先存本所案號收進系統，等產生B類文號時再掛進回覆單
         'Add by Amy 2025/05/13 +RX-FC結案單用
         If UCase(strTyp) = "RX" Then
            strKey = strCP01 & strCP02 & strCP03 & strCP04
            strCPP10 = "Y" '設定同FCP系統收件區
         ElseIf strCP09 <> "" Then
            strKey = strCP09
            strCPP10 = "X"
         Else
            strKey = strCP01 & strCP02 & strCP03 & strCP04
            strCPP10 = "U"
         End If
         'Add by Amy 2025/05/13 因加RX.MSG,故結案單需傳單號,避免刪到不該刪的檔(與Sindy討論後)
         If (UCase(strFormN) = "FRM210133" Or UCase(strFormN) = "FRM210133_F") And strCPP11 <> "" Then
            strWhr = " And CPP11='" & strCPP11 & "' "
         End If
         
         'Add By Sindy 2016/6/27 檢查此序號電子檔是否存在,若是,則遞增
         'If intSeqno > 0 Then
CheckFileName:
            'Modify by Amy 2025/05/13 +strWhr
            strSql = "SELECT CPP01 FROM CasePaperPDF WHERE CPP01='" & strKey & "' and upper(CPP02)=upper('" & stReName & "')" & strWhr
            intI = 1: intSeqno = 0
            Set RsTemp = ClsLawReadRstMsg(intI, strSql)
            If intI = 1 Then
               'Modify By Sindy 2022/10/26
               If TypKind = "" Then
                  'Modify By Sindy 2023/8/23
                  'Modify By Sindy 2025/9/22 and efc02<>'PROC' 改為 and efc02 not in('PROC','CUS')
                  strSql = "select EFC01,EFC02 from efilecaption where EFC06='Y'" & _
                           " and instr(upper('." & stReName & "'),upper('.'||EFC02||'.'))>0" & _
                           " and efc01 in('ALL','" & strCP01 & "') and efc02 not in('PROC','CUS')"
                  intI = 1
                  Set RsTemp = ClsLawReadRstMsg(intI, strSql)
                  If intI = 1 Then
                     TypKind = RsTemp.Fields("EFC02")
                  Else
                  '2023/8/23 END
                     stReName = Replace(stReName, "." & intSeqno & ".", "." & intSeqno + 1 & ".")
                  End If
               End If
               '2022/10/26 END
               If TypKind <> "" Then
                  If intSeqno = 0 Then
                     stReName = Replace(UCase(stReName), "." & UCase(TypKind), "." & intSeqno + 1 & "." & UCase(TypKind))
                  Else
                     stReName = Replace(UCase(stReName), "." & intSeqno & "." & UCase(TypKind), "." & intSeqno + 1 & "." & UCase(TypKind))
                  End If
               End If
               intSeqno = intSeqno + 1
               GoTo CheckFileName
            End If
         'End If
         '2016/6/27 END
         
         'Modify By Sindy 2015/5/14
         'If SaveAttFile_PDF(strCP09, stFileName, stReName, Format(f.DateLastModified, "YYYYMMDD"), Format(f.DateLastModified, "HHMMSS"), False, "4") = False Then
         'Modify By Sindy 2022/9/7 + , strCPP11, , , , , strCPP15
         'Modify by Amy 2025/05/13 +strCPP12
         'If SaveAttFile_PDF(strKey, stFileName, stReName, Format(f.DateLastModified, "YYYYMMDD"), Format(f.DateLastModified, "HHMMSS"), False, , strCPP10, , strCPP11, , , , , strCPP15) = False Then
         If SaveAttFile_PDF(strKey, stFileName, stReName, Format(f.DateLastModified, "YYYYMMDD"), Format(f.DateLastModified, "HHMMSS"), False, strCPP12, strCPP10, , strCPP11, , , , , strCPP15) = False Then
         'end 2025/05/13
            PUB_UpdReplyFile = False
            Exit Function
         End If
      Next ii
      Set fs = Nothing
   End If
End Function

'Add By Sindy 2023/1/17 接洽單電子檔更名
Public Function PUB_UpdCRLFileName(strCRL01 As String) As Boolean
Dim rsTmp As New ADODB.Recordset
Dim intA As Integer
Dim strCRL07 As String
Dim stFileName As String, TypKind As String, stReName As String
Dim strCPP15 As String
Dim intSeqno As Integer, intFileCnt As Integer
Dim strCPP01 As String, strCPP02 As String
   
   PUB_UpdCRLFileName = False
   
   '**********************************
   '新案要改電子檔名
   '**********************************
   strSql = "select CRL06,CRL07 from CONSULTRECORDLIST" & _
            " where CRL01='" & strCRL01 & "'"
   intA = 1
   Set RsTemp = ClsLawReadRstMsg(intA, strSql)
   If intA = 1 Then
      If "" & RsTemp.Fields("CRL06") = "Y" Then '新案
         strCRL07 = RsTemp.Fields("CRL07") '系統別
         'CPP15=1.官方文件 2.內部文件
         'Modify By Sindy 2023/3/10 + and length(CPP01)<>9:排除已收文的電子檔
         strSql = "SELECT CPP01,CPP02,CPP15 FROM casepaperpdf" & _
                  " WHERE CPP11='" & strCRL01 & "' and CPP15 in('1','2') and length(CPP01)<>9 order by CPP15 asc"
         intI = 1
         Set rsTmp = ClsLawReadRstMsg(intI, strSql)
         If intI = 1 Then
            rsTmp.MoveFirst
            Do While Not rsTmp.EOF
               strCPP01 = rsTmp.Fields("CPP01")
               strCPP02 = rsTmp.Fields("CPP02")
               stFileName = rsTmp.Fields("CPP02")
               intSeqno = 0
'               If strCPP15 <> rsTmp.Fields("CPP15") Then
'                  intSeqno = 0
'                  strSql = "SELECT count(*) FROM casepaperpdf WHERE CPP11='" & strCRL01 & "' and CPP15 ='" & rsTmp.Fields("CPP15") & "'"
'                  intI = 1
'                  Set RsTemp = ClsLawReadRstMsg(intI, strSql)
'                  If intI = 1 Then
'                     intFileCnt = RsTemp.Fields(0)
'                  End If
'               End If
               strCPP15 = rsTmp.Fields("CPP15")
'               '新案還沒有給號,去掉電子檔名最前面的案號 Ex:英國脫歐
'               If InStr(stFileName, ".") > 0 Then
'                  strExc(0) = Mid(stFileName, 1, InStr(stFileName, ".") - 1)
'                  '有系統別
'                  If strCRL07 = Mid(strExc(0), 1, Len(strCRL07)) Then
'                     strCase2 = ""
'                     For jj = Len(strCRL07) + 1 To Len(strExc(0))
'                        strWord = Mid(strExc(0), jj, 1)
'                        If IsNumeric(strWord) = True Then
'                           strCase2 = strCase2 & strWord
'                        Else
'                           Exit For
'                        End If
'                     Next jj
'                     '檢查是否為案號
'                     If strCase2 <> "" Then
'                        strCase2 = Format(strCase2, "000000") '補足6碼
'                        strSql = "SELECT count(*) FROM caseprogress WHERE CP01='" & strCRL07 & "' and CP02='" & strCase2 & "'"
'                        intI = 1
'                        Set RsTemp = ClsLawReadRstMsg(intI, strSql)
'                        If intI = 1 Then
'                           '去掉案號
'                           If RsTemp.Fields(0) > 0 Then
'                              stFileName = Mid(stFileName, InStr(stFileName, ".") + 1)
'                           End If
'                        End If
'                     End If
'                  End If
'               End If
               
'               '2.內部文件(電子收文)
'               TypKind = ""
'               If strCPP15 = "2" Then
'                  TypKind = "Case"
'               Else '1.官方文件(電子收文)
'                  strSql = "select EFC01,EFC02 from efilecaption where EFC06='Y'" & _
'                           " and instr(upper('." & stFileName & "'),upper('.'||EFC02||'.'))>0" & _
'                           " and efc01 in('ALL','" & strCRL07 & "') and efc02<>'PROC'"
'                  intI = 1
'                  Set RsTemp = ClsLawReadRstMsg(intI, strSql)
'                  If intI = 1 Then
'                     TypKind = RsTemp.Fields("EFC02")
'                  End If
'               End If
               'Modify By Sindy 2023/1/13 不管是 官方文件 或 內部文件 都先檢查有沒有配對到的副檔名
               'Modify By Sindy 2025/9/22 and efc02<>'PROC' 改為 and efc02 not in('PROC','CUS')
               TypKind = ""
               strSql = "select EFC01,EFC02 from efilecaption where EFC06='Y'" & _
                        " and instr(upper('." & stFileName & "'),upper('.'||EFC02||'.'))>0" & _
                        " and efc01 in('ALL','" & strCRL07 & "') and efc02 not in('PROC','CUS')"
               intI = 1
               Set RsTemp = ClsLawReadRstMsg(intI, strSql)
               If intI = 1 Then
                  TypKind = RsTemp.Fields("EFC02")
               End If
               '2.內部文件(電子收文)
               If TypKind = "" And strCPP15 = "2" Then
                  TypKind = "Case"
               End If
               '2023/1/13 END
               
               strExc(9) = Mid(stFileName, InStrRev(stFileName, "."), Len(stFileName)) '取得檔案類型
               stReName = strCRL01
               'If intFileCnt > 1 Then
               If TypKind = "" Then
                  intSeqno = intSeqno + 1
                  stReName = stReName & "." & intSeqno & strExc(9)
               Else
                  stReName = stReName & IIf(TypKind <> "", "." & TypKind, "") & strExc(9)
               End If
               
CheckFileName:
               'Modify By Sindy 2024/9/4 欲更名的檔名和現行的檔名不同時,才需要更名
               If UCase(stReName) <> UCase(strCPP02) Then
               '2024/9/4 END
                  strSql = "SELECT CPP01 FROM CasePaperPDF WHERE CPP01='" & strCRL01 & "' and upper(CPP02)=upper('" & stReName & "')"
                  intI = 1
                  Set RsTemp = ClsLawReadRstMsg(intI, strSql)
                  If intI = 1 Then
                     'Modify By Sindy 2022/10/26
                     If TypKind = "" Then
                        stReName = Replace(UCase(stReName), "." & intSeqno & ".", "." & intSeqno + 1 & ".")
                     Else
                     '2022/10/26 END
                        If intSeqno = 0 Then
                           stReName = Replace(UCase(stReName), "." & UCase(TypKind), "." & intSeqno + 1 & "." & UCase(TypKind))
                        Else
                           stReName = Replace(UCase(stReName), "." & intSeqno & "." & UCase(TypKind), "." & intSeqno + 1 & "." & UCase(TypKind))
                        End If
                     End If
                     
                     intSeqno = intSeqno + 1
                     GoTo CheckFileName
                  End If
                  strSql = "update casepaperpdf set CPP02='" & stReName & "' WHERE CPP01='" & strCPP01 & "' and CPP02 ='" & strCPP02 & "'"
                  cnnConnection.Execute strSql, intI
               End If
               
               rsTmp.MoveNext
            Loop
         End If
         rsTmp.Close
      End If
   End If
   
   PUB_UpdCRLFileName = True
   Set rsTmp = Nothing
End Function

'Add By Sindy 2015/1/27 刪除匯入的來源檔
'Memo by Lydia 2020/03/19 刪除檔案：傳入完整檔案路徑，可用&區隔多筆檔案，可區分檔名後有註記KB
'Modify By Sindy 2015/8/19 +, Optional bolChkSymbol As Boolean = True
'Modified by Lydia 2020/03/20 +Optional ByVal bolMsg = True, Optional ByRef pErrMsg As String = ""
Public Function PUB_DelPCOrgFile(ByVal m_strSaveFiles As String, Optional ByVal bolChkSymbol As Boolean = True, Optional ByVal bolMsg = True, Optional ByRef pErrMsg As String = "") As Boolean
Dim stFileName As String
Dim strTemp As Variant
Dim ii As Integer
   
On Error GoTo ErrHand
   
   PUB_DelPCOrgFile = False
   If m_strSaveFiles <> "" Then
      'Add By Sindy 2017/6/23
      'Modify By Sindy 2017/8/16 + eml
      'Remove by Lydia 2020/03/19 全部用多筆判斷
      'If Right(Trim(UCase(m_strSaveFiles)), 4) = UCase(".MSG") Or _
      '   Right(Trim(UCase(m_strSaveFiles)), 4) = UCase(".EML") Then
      '   Kill m_strSaveFiles
      'Else
      ''2017/6/23 END
         strTemp = Split(m_strSaveFiles, "&")
         For ii = 0 To UBound(strTemp)
            stFileName = strTemp(ii)
            If stFileName <> "" Then 'Added by Lydia 2020/03/19
                'Modify By Sindy 2015/8/19
                If bolChkSymbol = True Then
                '2015/8/19 END
                   If InStrRev(strTemp(ii), " (") > 0 Then
                     'Add By Sindy 2021/8/6 排除 C:\Program Files (x86) 狀況
                     If UCase(Mid(strTemp(ii), InStrRev(strTemp(ii), " (") + 1, Len("(X86)"))) <> "(X86)" Then
                     '2021/8/6 END
                        stFileName = Left(strTemp(ii), InStrRev(strTemp(ii), " (") - 1)
                     End If
                   End If
                End If
                SetAttr stFileName, vbNormal 'Added by Lydia 2020/03/19 預設檔案為正常
                Kill stFileName
            End If 'Added by Lydia 2020/03/19
         Next ii
      'End If
   End If
   PUB_DelPCOrgFile = True
   Exit Function
   
ErrHand:
   'Added by Lydia 2020/03/20
   If bolMsg = False Then
        pErrMsg = "欲刪除匯入的來源檔：" & Err.Description
   Else
   'end 2020/03/20
        MsgBox "欲刪除匯入的來源檔：" & Err.Description
   End If
End Function

'Add By Sindy 2015/1/7 檢查是否有此案號回覆單
'Modify By Sindy 2015/5/18
'Modify by Amy 2025/05/13 +intState:0-智權部回覆單/1-外商用/2-外專用 及 strLoadPath 下載檔案之實體位置多個回覆單,沒路徑會抓不到檔(讓strCPP02傳入目前檔案要下載之路徑)
Public Function PUB_ChkIsReplyFile(ByVal strQCPP01 As String, Optional ByRef strCPP02 As String, Optional ByVal strFlowNo As String = "", _
                                   Optional ByRef strCPP01 As String, Optional ByVal strQCPP11 As String, _
                                   Optional ByVal intState As Integer = 0, Optional ByVal strLoadPath As String) As Boolean
   Dim stSQL As String
   Dim intR As Integer
   Dim rsQuery As ADODB.Recordset
   Dim stWhere1 As String, stWhere2 As String 'Add by Amy 2025/05/13
   
   PUB_ChkIsReplyFile = False: strCPP02 = ""
   
   'Add by Amy 2025/05/13 +FC結案單
   If strLoadPath <> "" And Right(strLoadPath, "1") <> "\" Then strLoadPath = strLoadPath & "\"
   Select Case intState
      Case 0 '智權 用
         stWhere1 = " and instr(upper(cpp02),upper('" & EMP_回覆單 & ".pdf'))>0 and cpp10='U'"
         stWhere2 = " and instr(upper(cpp02),upper('" & EMP_回覆單 & ".pdf'))>0"
      Case 1 '外商 用
         stWhere1 = " And ((instr(upper(cpp02),upper('.pdf'))>0 and cpp10='U') Or (instr(upper(cpp02),upper('.Msg'))>0))"
         stWhere2 = " And (instr(upper(cpp02),upper('.pdf'))>0 Or instr(upper(cpp02),upper('.Msg'))>0)"
      Case 2 '外專 用
         stWhere1 = " And ((instr(upper(cpp02),upper('.pdf'))>0 and cpp10='U') Or (instr(upper(cpp02),upper('.Msg'))>0))"
         stWhere2 = " And (instr(upper(cpp02),upper('.pdf'))>0 Or instr(upper(cpp02),upper('.Msg'))>0)"
      Case Else
   End Select
   'end 2025/05/13
   
   'Modify By Sindy 2019/4/25 排除已註記為刪除的檔案 +  and substr(upper(cpp02),-4)<>upper('.del')
   'Modify by Amy 2025/05/13 +stWhere1/stWhere2 (for FC結案單)
   stSQL = "select cpp01,cpp02,'N' from casepaperpdf where cpp01='" & strQCPP01 & "' and substr(upper(cpp02),-4)<>upper('.del') " & _
                     stWhere1
   If strQCPP11 <> "" Then
      stSQL = stSQL & " and cpp11='" & strQCPP11 & "' "
   End If
   If strFlowNo <> "" Then
      'Modify By Sindy 2019/4/25 排除已註記為刪除的檔案 +  and substr(upper(cpp02),-4)<>upper('.del')
      stSQL = stSQL & " union select cpp01,cpp02,'Y' from casepaperpdf,caseprogress where cp140='" & strFlowNo & "' and cp09=cpp01(+) and substr(upper(cpp02),-4)<>upper('.del') " & _
                     stWhere2
   End If
   'end 2025/05/13
   Set rsQuery = Nothing
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      rsQuery.MoveFirst 'Add By Sindy 2018/2/9
      PUB_ChkIsReplyFile = True
      If rsQuery.Fields(2) = "Y" Then '已轉總收文號
         strCPP01 = rsQuery.Fields("cpp01")
      End If
      'Modify By Sindy 2018/2/9 回覆單有可能多筆
      Do While Not rsQuery.EOF
         'Modify by Amy 2025/05/08 改用& 避免結案單按回覆單鈕,多筆不會換行
         '                              不可使用[:]因退回再加檔時,會顯示C:\xxx 不易切多檔
         'If strCPP02 <> "" Then strCPP02 = strCPP02 & ":"
         If strCPP02 <> "" Then strCPP02 = strCPP02 & "&"
         strCPP02 = strCPP02 & strLoadPath & rsQuery.Fields("cpp02")
         'end 2025/05/08
         rsQuery.MoveNext
      Loop
   End If
End Function

'Add By Sindy 2015/1/23
'Modified by Morgan 2015/4/13 +bolIsFullPath
'Modify by Amy 2025/06/30 stBackMsg:傳入"0"-於此函數內彈訊息 /"1"-回傳組的訊息
Public Function PUB_GetAttachFile_CPP(ByVal strCP09 As String, ByRef pFileName As String, pSavePath As String, Optional bolIsFullPath As Boolean = False _
  , Optional ByRef stBackMsg As String = "0") As Boolean
   Dim stAttPath As String
   Dim lngSize As Long
   Dim iFileNo As Integer
   Dim bytes() As Byte
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   Dim intMsgType As Integer, stMsg As String 'Add by Amy 2025/06/30
   Dim stModifyDateTime As String 'Added by Morgan 2025/7/18
   
On Error GoTo ErrHnd
   
   'Add by Amy 2025/06/30 回傳訊息
   intMsgType = Val(stBackMsg)
   stBackMsg = ""
   'end 2025/06/30
   
   'Modified by Morgan 2015/4/13
   'If Right(stAttPath, 1) = "\" Then
   '   stAttPath = Left(stAttPath, Len(stAttPath) - 1)
   'End If
   If bolIsFullPath = True Then
      stAttPath = pSavePath
   Else
   'end 2015/4/13
   
      If Dir(pSavePath, vbDirectory) = "" Then
         MkDir pSavePath
      End If
      stAttPath = pSavePath & "\" & pFileName
      
   End If 'Added by Morgan 2015/4/13
   
   
   'Added by Morgan 2015/3/24
   'Modified by Morgan 2015/5/22 FTP上線
      'Modified by Morgan 2025/3/27 +cpp19
      'Modified by Morgan 2025/7/18 +cpp08,cpp09
      stSQL = "select cpp14,cpp19,cpp08,cpp09 from casepaperpdf where cpp01='" & strCP09 & "' and upper(cpp02)=upper('" & ChgSQL(pFileName) & "')"
      intQ = 1
      Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
      If intQ = 1 Then
         If Not IsNull(rsQuery(0)) Then
            pFileName = stAttPath
            'Modified by Morgan 2025/7/18 +更新檔案修改時間
            stModifyDateTime = rsQuery("cpp08") & Format("" & rsQuery("cpp09"), "000000")
            PUB_GetAttachFile_CPP = PUB_GetFtpFile(rsQuery("cpp14"), stAttPath, , , , "" & rsQuery("cpp19") <> "", , stModifyDateTime)
            'end 2025/7/18
         End If
      End If
      Exit Function
   
   'end 2015/3/24
   
'Removed by Morgan 2015/5/22 不再存DB
'   stSQL = "select * from casepaperpdf where cpp01='" & strCP09 & "' and cpp02='" & ChgSQL(pFileName) & "'"
'   intQ = 1
'   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
'   If intQ = 1 Then
'      If Dir(stAttPath) <> "" Then Kill stAttPath
'      With rsQuery
'         lngSize = Val(.Fields("cpp03").Value)
'         ReDim bytes(lngSize)
'         If lngSize > 0 Then
'            bytes() = .Fields("cpp04").GetChunk(lngSize)
'         End If
'      End With
'      iFileNo = FreeFile
'      Open stAttPath For Binary Access Write As #iFileNo
'      If lngSize > 0 Then Put #iFileNo, , bytes()
'      Close #iFileNo
'
'      pFileName = stAttPath
'      PUB_GetAttachFile_CPP = True
'   End If
'   Exit Function
'end 2015/5/22

ErrHnd:
   'Modify by Amy 2025/06/30 +stMsg
   If Err.Number = 70 Then
      'MsgBox ChgSQL(pFileName) & " 檔案已開啟！", vbCritical
      stMsg = ChgSQL(pFileName) & " 檔案已開啟！"
   Else
      'MsgBox Err.Description, vbCritical
      stMsg = Err.Description
   End If
   If stMsg <> "" Then
      If intMsgType = 0 Then
         MsgBox stMsg, vbCritical
      Else
         stBackMsg = stMsg
      End If
   End If
   'end 2025/06/30
   
   If iFileNo > 0 Then Close #iFileNo
   Set rsQuery = Nothing
End Function

'Add By Sindy 2021/11/1
Public Function PUB_GetAttachFile_Org(ByVal strCP09 As String, ByRef pFileName As String, pSavePath As String, Optional bolIsFullPath As Boolean = False) As Boolean
   Dim stAttPath As String
   Dim lngSize As Long
   Dim iFileNo As Integer
   Dim bytes() As Byte
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   Dim stModifyDateTime As String 'Add by Sindy 2025/7/21
   
On Error GoTo ErrHnd
   
   If bolIsFullPath = True Then
      stAttPath = pSavePath
   Else
   
      If Dir(pSavePath, vbDirectory) = "" Then
         MkDir pSavePath
      End If
      stAttPath = pSavePath & "\" & pFileName
      
   End If
   
   'Modify by Sindy 2025/7/21 +,cpf08,cpf09
   stSQL = "select cpf13,cpf08,cpf09 from casepaperfile where cpf01='" & strCP09 & "' and upper(cpf02)=upper('" & ChgSQL(pFileName) & "')"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      If Not IsNull(rsQuery(0)) Then
         pFileName = stAttPath
         'Modify by Sindy 2025/7/21 +更新檔案修改時間
         stModifyDateTime = rsQuery("cpf08") & Format("" & rsQuery("cpf09"), "000000")
         PUB_GetAttachFile_Org = PUB_GetFtpFile(rsQuery(0), stAttPath, "casepaperfile", , , , , stModifyDateTime)
         '2025/7/21 END
      End If
   End If
   Exit Function
   
ErrHnd:
   If Err.Number = 70 Then
      MsgBox ChgSQL(pFileName) & " 檔案已開啟！", vbCritical
   Else
      MsgBox Err.Description, vbCritical
   End If
   If iFileNo > 0 Then Close #iFileNo
   Set rsQuery = Nothing
End Function

'Add By Sindy 2020/6/20
Public Function PUB_GetAttachFile_EEF(ByVal m_EEP01 As String, intEEP02 As Integer, _
   ByRef pFileName As String, pSavePath As String, Optional bolIsFullPath As Boolean = False) As Boolean
   
   Dim stAttPath As String
   Dim lngSize As Long
   Dim iFileNo As Integer
   Dim bytes() As Byte
   Dim rsQuery As ADODB.Recordset
   Dim bolHadShowMsg As Boolean 'Add By Sindy 2018/9/26
   Dim strSql As String 'Add By Sindy 2020/9/28
   Dim stModifyDateTime As String 'Added by Morgan 2025/7/18
   
On Error GoTo ErrHnd
   
   If bolIsFullPath = True Then
      stAttPath = pSavePath
      
   Else
      If Dir(pSavePath, vbDirectory) = "" Then
         MkDir pSavePath
      End If
      stAttPath = pSavePath & "\" & pFileName
         
      '檔案已存在時
      If Dir(stAttPath) <> "" Then
         '檢查檔案是否正在使用中
         If PUB_ChkFileOpening(stAttPath, bolHadShowMsg) = True Then
            'Modify By Sindy 2018/9/26
            If bolHadShowMsg = False Then
            '2018/9/26 END
               MsgBox stAttPath & vbCrLf & "檔案正在使用中（請關閉），方可繼續操作。", vbExclamation
            End If
            Screen.MousePointer = vbDefault 'Add By Sindy 2019/1/21
            Exit Function
         End If
                     
         SetAttr stAttPath, vbNormal 'Add By Sindy 2020/1/17 檔案設定為正常屬性
            
         Kill stAttPath
         
         '不必重新下載
'         pFileName = stAttPath
'         GetAttachFile = True
'         Exit Function
      End If
   End If
   
   'Added by Morgan 2015/4/28
   'Modified by Morgan 2015/5/22 FTP上線
   'Modify By Sindy 2018/9/4 + and eef12 is not null
   'Modified by Morgan 2025/7/18 +eef09,eef10
      strSql = "select eef12,eef09,eef10 from EmpElectronFile where eef01='" & m_EEP01 & "' and eef02=" & intEEP02 & _
               " and eef03='" & ChgSQL(pFileName) & "' and eef12 is not null"
      intI = 1
      Set rsQuery = ClsLawReadRstMsg(intI, strSql)
      If intI = 1 Then
         If Not IsNull(rsQuery.Fields(0)) Then
            pFileName = stAttPath
            'Modified by Morgan 2025/7/18 +更新檔案修改時間
            stModifyDateTime = rsQuery("eef09") & Format("" & rsQuery("eef10"), "000000")
            PUB_GetAttachFile_EEF = PUB_GetFtpFile(rsQuery.Fields(0), stAttPath, "EMPELECTRONFILE", True, , , , stModifyDateTime)
            'end 2025/7/18
         End If
      End If
      
      Set rsQuery = Nothing
      Exit Function
   'end 2015/4/28
   
'Removed by Morgan 2015/5/22 不再存DB
'   strExc(0) = "select * from EmpElectronFile where eef01='" & m_EEP01 & "' and eef02=" & intEEP02 & _
'               " and eef03='" & ChgSQL(pFileName) & "'"
'   intI = 1
'   Set rsQuery = ClsLawReadRstMsg(intI, strExc(0))
'   If intI = 1 Then
'      If Dir(stAttPath) <> "" Then Kill stAttPath
'      With RsTemp
'      lngSize = Val(.Fields("eef04").Value)
'      ReDim bytes(lngSize)
'      If lngSize > 0 Then bytes() = .Fields("eef05").GetChunk(lngSize)
'      End With
'      iFileNo = FreeFile
'      Open stAttPath For Binary Access Write As #iFileNo
'      If lngSize > 0 Then Put #iFileNo, , bytes()
'      Close #iFileNo
'
'      pFileName = stAttPath
'      GetAttachFile = True
'   End If
'   Exit Function
'end 2015/5/22
   
ErrHnd:
   If Err.Number = 70 Then
      MsgBox ChgSQL(pFileName) & " 檔案已開啟！", vbCritical
   Else
      strExc(10) = Err.Number & ":" & Err.Description
      MsgBox strExc(10), vbCritical
   End If
   Set rsQuery = Nothing
End Function

'Add By Sindy 2016/1/21
'Modify By Sindy 2019/5/2 判斷信件類別,開啟不同的信箱信件
Public Function PUB_GetAttachFile_IImsg(ByVal strPkey1 As String, ByVal strPkey2 As String, ByVal strPkey3 As String, _
               ByRef pFileName As String, pSavePath As String, Optional bolIsFullPath As Boolean = False) As Boolean
Dim stAttPath As String
Dim lngSize As Long
Dim iFileNo As Integer
Dim bytes() As Byte
Dim stModifyDateTime As String 'Add by Sindy 2025/7/21
   
On Error GoTo ErrHnd
   
   If bolIsFullPath = True Then
'      'Modify By Sindy 2016/4/12 檔名前再加日期時間,因信件的檔名很容易重覆
'      'stAttPath = pSavePath
'      If InStr(UCase(pSavePath), UCase("\" & pFileName)) > 0 Then
'         'Modify By Sindy 2016/10/4
'         If InStr(pFileName, strPkey1 & Format(strPkey2, "000000")) = 0 Then
'            stAttPath = Mid(pSavePath, 1, InStrRev(pSavePath, "\")) & strPkey1 & Format(strPkey2, "000000") & pFileName
'         Else
'            stAttPath = pSavePath
'         End If
'         '2016/10/4 END
'      Else
         stAttPath = pSavePath
'      End If
'      '2016/4/12 END
   Else
      If Dir(pSavePath, vbDirectory) = "" Then
         MkDir pSavePath
      End If
'      'Modify By Sindy 2016/4/12 檔名前再加日期時間,因信件的檔名很容易重覆
'      'stAttPath = pSavePath & "\" & pFileName
'      'Modify By Sindy 2016/10/4
'      If InStr(pFileName, strPkey1 & Format(strPkey2, "000000")) = 0 Then
'         stAttPath = pSavePath & "\" & strPkey1 & Format(strPkey2, "000000") & pFileName
'      Else
'      '2016/10/4 END
'      '2016/4/12 END
         stAttPath = pSavePath & "\" & pFileName
'      End If
   End If
   
   'Modify By Sindy 2019/5/2
   If Len(strPkey3) = 5 And Left(strPkey3, 1) = "P" Then
      'Modify by Sindy 2025/7/21 +,Pi01,Pi02
      strExc(0) = "select Pi14,Pi01,Pi02 from Patentinput where Pi01=" & strPkey1 & " and Pi02=" & strPkey2 & _
                  " and Pi03='" & ChgSQL(strPkey3) & "'"
   ElseIf Len(strPkey3) = 5 And Left(strPkey3, 1) = "T" Then
      'Modify by Sindy 2025/7/21 +,Ti01,Ti02
      strExc(0) = "select Ti14,Ti01,Ti02 from TMinput where Ti01=" & strPkey1 & " and Ti02=" & strPkey2 & _
                  " and Ti03='" & ChgSQL(strPkey3) & "'"
   Else
   '2019/5/2 END
      'Modify by Sindy 2025/7/21 +,ii01,ii02
      strExc(0) = "select ii14,ii01,ii02 from ipdeptinput where ii01=" & strPkey1 & " and ii02=" & strPkey2 & _
                  " and ii03='" & ChgSQL(strPkey3) & "'"
   End If
   intI = 1
   Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
   If intI = 1 Then
      If Not IsNull(RsTemp(0)) Then
         pFileName = stAttPath
         'Modify by Sindy 2025/7/21 +更新檔案修改時間
         stModifyDateTime = RsTemp(1) & Format("" & RsTemp(2), "000000")
         PUB_GetAttachFile_IImsg = PUB_GetFtpFile(RsTemp(0), stAttPath, IIf(Left(strPkey3, 1) = "P", "PatentINPUT", IIf(Left(strPkey3, 1) = "T", "TMINPUT", "IPDEPTINPUT")), , , , , stModifyDateTime)
         '2025/7/21 END
      End If
   End If
   Exit Function
   
ErrHnd:
   If Err.Number = 70 Then
      MsgBox ChgSQL(pFileName) & " 檔案已開啟！", vbCritical
   Else
      MsgBox Err.Description, vbCritical
   End If
   If iFileNo > 0 Then Close #iFileNo
End Function

'Add By Sindy 2016/9/12
Public Function PUB_GetAttachFile_PImsg(ByVal strPkey1 As String, ByVal strPkey2 As String, ByVal strPkey3 As String, _
                  ByRef pFileName As String, pSavePath As String, Optional bolIsFullPath As Boolean = False) As Boolean
Dim stAttPath As String
Dim lngSize As Long
Dim iFileNo As Integer
Dim bytes() As Byte
Dim stModifyDateTime As String 'Add by Sindy 2025/7/21
   
On Error GoTo ErrHnd
   
   If bolIsFullPath = True Then
      stAttPath = pSavePath
   Else
      If Dir(pSavePath, vbDirectory) = "" Then
         MkDir pSavePath
      End If
      stAttPath = pSavePath & "\" & pFileName
   End If
   
   'Modify by Sindy 2025/7/21 +,pi01,pi02
   strExc(0) = "select pi14,pi01,pi02 from patentinput where pi01=" & strPkey1 & " and pi02=" & strPkey2 & _
               " and pi03='" & strPkey3 & "'"
   intI = 1
   Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
   If intI = 1 Then
      If Not IsNull(RsTemp(0)) Then
         pFileName = stAttPath
         'Modify by Sindy 2025/7/21 +更新檔案修改時間
         stModifyDateTime = RsTemp(1) & Format("" & RsTemp(2), "000000")
         PUB_GetAttachFile_PImsg = PUB_GetFtpFile(RsTemp(0), stAttPath, "PATENTINPUT", , , , , stModifyDateTime)
         '2025/7/21 END
      End If
   End If
   Exit Function
   
ErrHnd:
   If Err.Number = 70 Then
      MsgBox ChgSQL(pFileName) & " 檔案已開啟！", vbCritical
   Else
      MsgBox Err.Description, vbCritical
   End If
   If iFileNo > 0 Then Close #iFileNo
End Function

'Add By Sindy 2019/4/15
Public Function PUB_GetAttachFile_TImsg(ByVal strPkey1 As String, ByVal strPkey2 As String, ByVal strPkey3 As String, _
                  ByRef pFileName As String, pSavePath As String, Optional bolIsFullPath As Boolean = False) As Boolean
Dim stAttPath As String
Dim lngSize As Long
Dim iFileNo As Integer
Dim bytes() As Byte
Dim stModifyDateTime As String 'Add by Sindy 2025/7/21
   
On Error GoTo ErrHnd
   
   If bolIsFullPath = True Then
      stAttPath = pSavePath
   Else
      If Dir(pSavePath, vbDirectory) = "" Then
         MkDir pSavePath
      End If
      stAttPath = pSavePath & "\" & pFileName
   End If
   
   'Modify by Sindy 2025/7/21 +,Ti01,Ti02
   strExc(0) = "select Ti14,Ti01,Ti02 from TMinput where Ti01=" & strPkey1 & " and Ti02=" & strPkey2 & _
               " and Ti03='" & strPkey3 & "'"
   intI = 1
   Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
   If intI = 1 Then
      If Not IsNull(RsTemp(0)) Then
         pFileName = stAttPath
         'Modify by Sindy 2025/7/21 +更新檔案修改時間
         stModifyDateTime = RsTemp(1) & Format("" & RsTemp(2), "000000")
         PUB_GetAttachFile_TImsg = PUB_GetFtpFile(RsTemp(0), stAttPath, "TMINPUT", , , , , stModifyDateTime)
         '2025/7/21 END
      End If
   End If
   Exit Function
   
ErrHnd:
   If Err.Number = 70 Then
      MsgBox ChgSQL(pFileName) & " 檔案已開啟！", vbCritical
   Else
      MsgBox Err.Description, vbCritical
   End If
   If iFileNo > 0 Then Close #iFileNo
End Function

'Add By Morgan 2016/4/15
Public Function PUB_GetAttachFile_Invoice(ByVal pInvoiceNo As String, ByVal pFileName As String, ByVal pSavePath As String, ByRef pSaveName As String) As Boolean
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   Dim stAttPath As String
   
On Error GoTo ErrHnd
   
   If pSaveName = "" Then pSaveName = pFileName
   
   
   If UCase(Right(pSavePath, Len(pSaveName))) = UCase(pSaveName) Then
      stAttPath = pSavePath
   Else
      If Dir(pSavePath, vbDirectory) = "" Then
         MkDir pSavePath
      End If
      stAttPath = pSavePath & "\" & pSaveName
   End If
   
   stSQL = "select ayf06 from ACC152 where ayf01='" & pInvoiceNo & "' and ayf02='" & ChgSQL(pFileName) & "'"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      If Not IsNull(rsQuery(0)) Then
         PUB_GetAttachFile_Invoice = PUB_GetFtpFile(rsQuery(0), stAttPath, "ACC152")
         'pSaveName = stAttPath
      End If
   End If
   
ErrHnd:
   If Err.Number <> 0 Then
      If Err.Number = 70 Then
         MsgBox pFileName & " 檔案已開啟！", vbCritical
      Else
         MsgBox Err.Description, vbCritical
      End If
   End If
   Set rsQuery = Nothing
End Function

'Add By Sindy 2015/1/19 檢查是否有需要新增電子檔次要副檔名說明
Public Function PUB_InsEfileCaption(strCP01 As String, strCPM26 As String, intRow As Integer) As Boolean
Dim strEFC03 As String
Dim strEFC04 As String
Dim intEFC05 As Integer
   
   PUB_InsEfileCaption = False
   strCPM26 = UCase(Trim(strCPM26)) '大寫
   If strCP01 <> "" And strCPM26 <> "" And intRow > 0 Then
      '檢查主要副檔名是否存在,若存在,取得說明及排序值
      strSql = "select *" & _
               " From EfileCaption" & _
               " where EFC01='" & strCP01 & "'" & _
               " and EFC02='" & strCPM26 & "'"
      intI = 1
      Set RsTemp = ClsLawReadRstMsg(intI, strSql)
      If intI = 1 Then
         strEFC03 = RsTemp.Fields("EFC03")
         strEFC04 = RsTemp.Fields("EFC04")
         intEFC05 = RsTemp.Fields("EFC05")
         '檢查次要副檔名是否已存在
         strSql = "select *" & _
                  " From EfileCaption" & _
                  " where EFC01='" & strCP01 & "'" & _
                  " and EFC02='" & strCPM26 & intRow & "'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strSql)
         If intI = 0 Then
            PUB_InsEfileCaption = True
            '不存在則新增一筆
            strSql = "insert into EfileCaption(EFC01,EFC02,EFC03,EFC04,EFC05,EFC06)" & _
                     " values(" & CNULL(strCP01) & "," & CNULL(strCPM26 & intRow) & "," & CNULL(strEFC03) & "," & CNULL(strEFC04) & "," & intEFC05 & ",null)"
            cnnConnection.Execute strSql
         End If
      End If
   End If
End Function

'Added by Morgan 2015/1/20
Public Function PUB_GetEDocData(ByVal pDocNo As String, Optional ByRef pED25 As String, Optional ByRef pED26 As String) As Boolean
   Dim stSQL As String
   Dim intR As Integer
   Dim rsQuery As ADODB.Recordset
   
   stSQL = "select ed25,ed26 from edocument where ed01='" & pDocNo & "'"
   Set rsQuery = Nothing
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      pED25 = "" & rsQuery("ed25")
      pED26 = "" & rsQuery("ed26")
      PUB_GetEDocData = True
   End If
   Set rsQuery = Nothing
End Function

'Added by Lydia 2025/02/05 輸入中間程序來函時自動產生行事曆(核駁及審查意見通知)
Public Function PUB_AddSCforIncomMemo(ByVal pCP01 As String, ByVal pCP02 As String, ByVal pCP03 As String, ByVal pCP04 As String, ByVal pCP09 As String, ByVal pCP10 As String, ByVal pFagent As String, ByVal pCustList As String) As Boolean
Dim strA1 As String, strA2 As String, strDate0 As String
Dim intA As Integer, rsAD As New ADODB.Recordset
   
   'Bobbie: Y19893030 Fresenius Medical Care AG 請管制以下C類來函性質，於輸入完中間程序來函後，自動產生行事曆
   If pFagent = "Y19893030" Then
      strA1 = "select nvl(cp07,nvl(cp06,cp05)) tdate1 from caseprogress where cp09='" & pCP09 & "' "
      Set rsAD = ClsLawReadRstMsg(intA, strA1)
      If intA = 1 Then
         strDate0 = "" & rsAD.Fields("tdate1")
      End If
      If strDate0 < strSrvDate(1) Then
         strDate0 = strSrvDate(1)
      Else
         strA1 = CompWorkDay(1, CompDate(1, -1, strDate0), 1)
         If strA1 < strSrvDate(1) Then
            strDate0 = strSrvDate(1)
         Else
            strDate0 = strA1
         End If
      End If
      
      '(1)期限: 法定期限前一個月工作日
      '(2)事由: 催客戶指示(法定期限前一個月催期限)
      '(3)提醒人員: 該區程序+承辦
      '(4)解除人員: 該區程序(及其第一案件職代)+承辦
      strA1 = PUB_GetFCPHandler(pCP01, pCP02, pCP03, pCP04)
      strA2 = PUB_GetFCPSalesNo(pCP01, pCP02, pCP03, pCP04)
      '傳入本所案號，解除人員會自動新增第一案件職代
      If PUB_AddFCPStaffCalendar(strDate0, "1", strA1 & "," & strA2, "催客戶指示(法定期限前一個月催期限)", strA1 & "," & strA2, "1", pCP01, pCP02, pCP03, pCP04) = False Then
         PUB_AddSCforIncomMemo = False
         GoTo EXITSUB
      End If
   End If
   
   PUB_AddSCforIncomMemo = True
   
EXITSUB:
   Set rsAD = Nothing
   
End Function

'Add by Lydia 2015/02/09
'核駁及審查意見通知函備註(複數筆備註)
'iCno:本所案號,iC10:案件性質,iPA75:代理人編號,iCust01:申請人編號
'Modified by Lydia 2021/11/02  iToCp48,iToCP142：有「客戶C類來函承辦天數」變更C類來函承辦期限和指定送件日
'Modified by Lydiad 2021/11/05 重新整理
'Public Function PUB_GetIncomMemoNew(iCno As String, iSys01 As String, ByRef iC10 As String, iPA75 As String, iCust01 As String, Optional iPmemo As String, _
        Optional ByRef iCp48 As String, Optional iCP133 As String, Optional iCust02 As String, Optional iCust03 As String, Optional iCust04 As String, Optional iCust05 As String, _
        Optional ByRef iToCp48 As String, Optional ByRef iToCp142 As String) As String
Public Function PUB_GetIncomMemoNew(ByVal iCno As String, ByVal iSys01 As String, ByVal iPA75 As String, ByVal iCustList As String, Optional ByVal iPmemo As String, _
        Optional ByVal iCP133 As String, Optional ByRef iCCP10 As String, Optional ByRef iCCP48 As String, Optional ByRef iCCP142 As String, _
        Optional ByRef iBCP10 As String, Optional ByRef iBCP48 As String, Optional ByRef iBCP06 As String) As String
'iCno、iSys01、iPA75、iCustList、iCP133：傳入本所案號 、系統別、Y編號代理人、X1~X5編號申請人1~5、官方發文日
'iPmemo：(空白)另外要抓B類收文設定; 基本以抓C類來函設定為主
'iCPP10、iCPP48、iCPP142：C類來函的案件性質、承辦期限、指定送件日期(對客戶)
'iBCP10、iBCP48、iBCP06：新增B類收文的案件性質、承辦期限、本所期限
    Dim stSQL As String, iR As Integer, mSQL As String, mSQL2 As String
    Dim rsQuery As ADODB.Recordset
    Dim strStartDate As String, iDays As Integer
    Dim ixR As Integer, strMemo As String, midRep As String
    Dim BolExit As Boolean '是否繼續讀取Recordset
    'Dim bolEnd As Boolean '是否停止讀取申請人1~5 'Remove by Lydia 2021/11/01
    Dim iPA26(1 To 5) As String
    'Added by Lydia 2021/11/01
    Dim strLevel As String '記錄符合的階段
    Dim bolThisJump As Boolean  '是否跳過這次讀取
    'end 2021/11/01
    Dim tmpArr As Variant    'Added by Lydia 2021/11/05
    Dim stCon1 As String 'Added by Lydia 2022/01/06
    Dim stCon2 As String 'Added by Lydia 2022/10/13
    
    '當系統別為P案且代理人為Y20065時，預設承辦期限＝官方發文日＋承辦天數。
    'Mark by Lydia 2022/10/13 改成欄位設定IM20,IM21
    'If iSys01 = "P" And Left(iPA75, 6) = "Y20065" And Len(iCP133) > 0 Then
    '  strStartDate = iCP133
    'Else
    '  strStartDate = strSrvDate(1) '預設系統日起算
    'End If
    'end 2022/10/13
    
    iCCP48 = "": iCCP142 = ""  'Added by Lydia 2021/11/02 預設不變更
    
    '以FCP代表國外案如FG
    If Left(iSys01, 1) = "F" Then iSys01 = "FCP"

    'IM09 is null = 自動產生B類單 => 產生B類單也可列印備註
    'Remob by Lydia 2021/11/15 依照新規則讀取第一筆符合的設定=>所以不是單獨抓B類設定來判斷
    'If Len(iPmemo) = 0 Then
    '   mSQL = " and IM09='Y'"
    'End If
    'end 2021/11/15

   '以系統判斷,所以只有本所案號時要排除
   If Len(iSys01) > 0 Then
      mSQL2 = " and (IM08 = '" & iSys01 & "' or IM08 is null)"
   End If
      
   '複數筆備註
   'Modified by Lydia 2021/11/05
   'iPA26(1) = iCust01:  iPA26(2) = iCust02:  iPA26(3) = iCust03:  iPA26(4) = iCust04:  iPA26(5) = iCust05
   tmpArr = Split(iCustList, ",")
   For ixR = 0 To UBound(tmpArr)
      If Trim((tmpArr(ixR))) <> "" Then
          iPA26(ixR + 1) = tmpArr(ixR)
      End If
   Next ixR
   'end 2021/11/05
   
   For ixR = 1 To 5
   '順序 1.本所案號 2.代理人+申請人 3.代理人 4.申請人
   '承辦天數IM07預設7天
      'Modified by Lydia 2021/11/01
      'If Len(iPA26(ixR)) > 0 And Not IsNull(iPA26(ixR)) And bolEnd = False Then
      If Len(iPA26(ixR)) > 0 Then
        'Modified by Morgan 2015/7/3 個案及X+Y取消 mSQL 條件並調整順序,+im09
        'Modified by Lydia 2021/11/01 +「客戶C類來函承辦天數」IM11,IM18
        'Modified by Lydia 2021/11/11 + 「B類內部收文IM06承辦期限類型」IM10;
        'Modified by Lydia 2021/11/15
        'stSQL = "select IM02, 0 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10,im11,im18  from IncomMemo where IM19 is null and IM03='" & iCno & "' and not(IM06 is null)" & _
        " union Select IM02, 1 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10,im11,im18  from IncomMemo where IM19 is null and IM03='" & iCno & "' and IM06 is null" & _
        " union Select IM02, 2 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10,im11,im18  from IncomMemo where IM19 is null and IM04='" & Left(iPA75, 8) & "' and IM05='" & Left(iPA26(ixR), 8) & "' and not(IM06 is null)" & mSQL2 & _
        " union Select IM02, 3 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10,im11,im18  from IncomMemo where IM19 is null and IM04='" & Left(iPA75, 8) & "' and IM05='" & Left(iPA26(ixR), 8) & "' and IM06 is null" & mSQL2 & _
        " union Select IM02, 4 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10,im11,im18  from IncomMemo where IM19 is null and IM04='" & Left(iPA75, 8) & "' and IM05='" & Left(iPA26(ixR), 6) & "' and not(IM06 is null)" & mSQL2 & _
        " union Select IM02, 5 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10,im11,im18  from IncomMemo where IM19 is null and IM04='" & Left(iPA75, 8) & "' and IM05='" & Left(iPA26(ixR), 6) & "' and IM06 is null" & mSQL2 & _
        " union Select IM02, 6 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10,im11,im18  from IncomMemo where IM19 is null and IM04='" & Left(iPA75, 6) & "' and IM05='" & Left(iPA26(ixR), 8) & "' and not(IM06 is null)" & mSQL2 & _
        " union Select IM02, 7 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10,im11,im18  from IncomMemo where IM19 is null and IM04='" & Left(iPA75, 6) & "' and IM05='" & Left(iPA26(ixR), 8) & "' and IM06 is null" & mSQL2 & _
        " union Select IM02, 8 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10,im11,im18  from IncomMemo where IM19 is null and IM04='" & Left(iPA75, 6) & "' and IM05='" & Left(iPA26(ixR), 6) & "' and not(IM06 is null)" & mSQL2 & _
        " union Select IM02, 9 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10,im11,im18  from IncomMemo where IM19 is null and IM04='" & Left(iPA75, 6) & "' and IM05='" & Left(iPA26(ixR), 6) & "' and IM06 is null" & mSQL2 & _
        " union Select IM02, 10 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10,im11,im18  from IncomMemo where IM19 is null and IM04='" & Left(iPA75, 8) & "' and IM05 is null and not(IM06 is null)" & mSQL & mSQL2 & _
        " union Select IM02, 11 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10,im11,im18  from IncomMemo where IM19 is null and IM04='" & Left(iPA75, 8) & "' and IM05 is null and IM06 is null" & mSQL & mSQL2 & _
        " union Select IM02, 12 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10,im11,im18  from IncomMemo where IM19 is null and IM04='" & Left(iPA75, 6) & "' and IM05 is null and not(IM06 is null)" & mSQL & mSQL2 & _
        " union Select IM02, 13 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10,im11,im18  from IncomMemo where IM19 is null and IM04='" & Left(iPA75, 6) & "' and IM05 is null and IM06 is null" & mSQL & mSQL2 & _
        " union Select IM02, 14 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10,im11,im18  from IncomMemo where IM19 is null and IM04 is null and IM05='" & Left(iPA26(ixR), 8) & "' and not(IM06 is null)" & mSQL & mSQL2 & _
        " union Select IM02, 15 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10,im11,im18  from IncomMemo where IM19 is null and IM04 is null and IM05='" & Left(iPA26(ixR), 8) & "' and IM06 is null" & mSQL & mSQL2 & _
        " union Select IM02, 16 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10,im11,im18  from IncomMemo where IM19 is null and IM04 is null and IM05='" & Left(iPA26(ixR), 6) & "' and not(IM06 is null)" & mSQL & mSQL2 & _
        " union Select IM02, 17 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10,im11,im18  from IncomMemo where IM19 is null and IM04 is null and IM05='" & Left(iPA26(ixR), 6) & "' and IM06 is null" & mSQL & mSQL2 & _
        " order by Od1 "
        '-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        '抽出pType, pKind為共同語法: pType: 1.個案, 2.Y+X, 3.Y or X ; pKind 區分C類來函性質: 符合傳入性質則優先，其次為空白=預設
                                                '因為C類來函性質>B類收文性質，所以除了原本Od1另外增加pType
        stCon1 = "decode(im03,null,decode(im04,null,'3',decode(im05,null,'3','2')),'1') pType, decode(im19,'1202','A',decode(im19,null,'B','C')) pKind"
        stCon2 = ", IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10,im11,im18, im19, nvl(im20,'1') im20, nvl(im21,'1') im21" 'Added by Lydia 2022/10/13 同樣語法改用變數
        'Modified by Lydia 2021/12/30 + im19
        'Modified by Lydia 2022/10/13 +IM20, IM21 ; 同樣語法改用變數
'        stSQL = "select Im02, " & stCon1 & " ,0 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10,im11,im18, im19 from IncomMemo where IM03='" & iCno & "' and not(IM06 is null)" & _
'        " union Select Im02, " & stCon1 & " ,1 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10,im11,im18, im19  from IncomMemo where IM03='" & iCno & "' and IM06 is null" & _
'        " union Select Im02, " & stCon1 & " ,2 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10,im11,im18, im19  from IncomMemo where IM04='" & Left(iPA75, 8) & "' and IM05='" & Left(iPA26(ixR), 8) & "' and not(IM06 is null)" & mSQL2 & _
'        " union Select Im02, " & stCon1 & " ,3 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10,im11,im18, im19  from IncomMemo where IM04='" & Left(iPA75, 8) & "' and IM05='" & Left(iPA26(ixR), 8) & "' and IM06 is null" & mSQL2 & _
'        " union Select Im02, " & stCon1 & " ,4 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10,im11,im18, im19  from IncomMemo where IM04='" & Left(iPA75, 8) & "' and IM05='" & Left(iPA26(ixR), 6) & "' and not(IM06 is null)" & mSQL2 & _
'        " union Select Im02, " & stCon1 & " ,5 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10,im11,im18, im19  from IncomMemo where IM04='" & Left(iPA75, 8) & "' and IM05='" & Left(iPA26(ixR), 6) & "' and IM06 is null" & mSQL2 & _
'        " union Select Im02, " & stCon1 & " ,6 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10,im11,im18, im19  from IncomMemo where IM04='" & Left(iPA75, 6) & "' and IM05='" & Left(iPA26(ixR), 8) & "' and not(IM06 is null)" & mSQL2 & _
'        " union Select Im02, " & stCon1 & " ,7 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10,im11,im18, im19  from IncomMemo where IM04='" & Left(iPA75, 6) & "' and IM05='" & Left(iPA26(ixR), 8) & "' and IM06 is null" & mSQL2 & _
'        " union Select Im02, " & stCon1 & " ,8 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10,im11,im18, im19  from IncomMemo where IM04='" & Left(iPA75, 6) & "' and IM05='" & Left(iPA26(ixR), 6) & "' and not(IM06 is null)" & mSQL2 & _
'        " union Select Im02, " & stCon1 & " ,9 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10,im11,im18, im19  from IncomMemo where IM04='" & Left(iPA75, 6) & "' and IM05='" & Left(iPA26(ixR), 6) & "' and IM06 is null" & mSQL2 & _
'        " union Select Im02, " & stCon1 & " ,10 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10,im11,im18, im19  from IncomMemo where IM04='" & Left(iPA75, 8) & "' and IM05 is null and not(IM06 is null)" & mSQL & mSQL2 & _
'        " union Select Im02, " & stCon1 & " ,11 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10,im11,im18, im19  from IncomMemo where IM04='" & Left(iPA75, 8) & "' and IM05 is null and IM06 is null" & mSQL & mSQL2 & _
'        " union Select Im02, " & stCon1 & " ,12 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10,im11,im18, im19  from IncomMemo where IM04='" & Left(iPA75, 6) & "' and IM05 is null and not(IM06 is null)" & mSQL & mSQL2 & _
'        " union Select Im02, " & stCon1 & " ,13 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10,im11,im18, im19  from IncomMemo where IM04='" & Left(iPA75, 6) & "' and IM05 is null and IM06 is null" & mSQL & mSQL2 & _
'        " union Select Im02, " & stCon1 & " ,14 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10,im11,im18, im19  from IncomMemo where IM04 is null and IM05='" & Left(iPA26(ixR), 8) & "' and not(IM06 is null)" & mSQL & mSQL2 & _
'        " union Select Im02, " & stCon1 & " ,15 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10,im11,im18, im19  from IncomMemo where IM04 is null and IM05='" & Left(iPA26(ixR), 8) & "' and IM06 is null" & mSQL & mSQL2 & _
'        " union Select Im02, " & stCon1 & " ,16 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10,im11,im18, im19  from IncomMemo where IM04 is null and IM05='" & Left(iPA26(ixR), 6) & "' and not(IM06 is null)" & mSQL & mSQL2 & _
'        " union Select Im02, " & stCon1 & " ,17 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10,im11,im18, im19  from IncomMemo where IM04 is null and IM05='" & Left(iPA26(ixR), 6) & "' and IM06 is null" & mSQL & mSQL2
        stSQL = "select Im02, " & stCon1 & " ,0 Od1" & stCon2 & " from IncomMemo where IM03='" & iCno & "' and not(IM06 is null)" & _
        " union Select Im02, " & stCon1 & " ,1 Od1" & stCon2 & " from IncomMemo where IM03='" & iCno & "' and IM06 is null" & _
        " union Select Im02, " & stCon1 & " ,2 Od1" & stCon2 & " from IncomMemo where IM04='" & Left(iPA75, 8) & "' and IM05='" & Left(iPA26(ixR), 8) & "' and not(IM06 is null)" & mSQL2 & _
        " union Select Im02, " & stCon1 & " ,3 Od1" & stCon2 & " from IncomMemo where IM04='" & Left(iPA75, 8) & "' and IM05='" & Left(iPA26(ixR), 8) & "' and IM06 is null" & mSQL2 & _
        " union Select Im02, " & stCon1 & " ,4 Od1" & stCon2 & " from IncomMemo where IM04='" & Left(iPA75, 8) & "' and IM05='" & Left(iPA26(ixR), 6) & "' and not(IM06 is null)" & mSQL2 & _
        " union Select Im02, " & stCon1 & " ,5 Od1" & stCon2 & " from IncomMemo where IM04='" & Left(iPA75, 8) & "' and IM05='" & Left(iPA26(ixR), 6) & "' and IM06 is null" & mSQL2 & _
        " union Select Im02, " & stCon1 & " ,6 Od1" & stCon2 & " from IncomMemo where IM04='" & Left(iPA75, 6) & "' and IM05='" & Left(iPA26(ixR), 8) & "' and not(IM06 is null)" & mSQL2 & _
        " union Select Im02, " & stCon1 & " ,7 Od1" & stCon2 & " from IncomMemo where IM04='" & Left(iPA75, 6) & "' and IM05='" & Left(iPA26(ixR), 8) & "' and IM06 is null" & mSQL2 & _
        " union Select Im02, " & stCon1 & " ,8 Od1" & stCon2 & " from IncomMemo where IM04='" & Left(iPA75, 6) & "' and IM05='" & Left(iPA26(ixR), 6) & "' and not(IM06 is null)" & mSQL2 & _
        " union Select Im02, " & stCon1 & " ,9 Od1" & stCon2 & " from IncomMemo where IM04='" & Left(iPA75, 6) & "' and IM05='" & Left(iPA26(ixR), 6) & "' and IM06 is null" & mSQL2 & _
        " union Select Im02, " & stCon1 & " ,10 Od1" & stCon2 & " from IncomMemo where IM04='" & Left(iPA75, 8) & "' and IM05 is null and not(IM06 is null)" & mSQL & mSQL2 & _
        " union Select Im02, " & stCon1 & " ,11 Od1" & stCon2 & " from IncomMemo where IM04='" & Left(iPA75, 8) & "' and IM05 is null and IM06 is null" & mSQL & mSQL2 & _
        " union Select Im02, " & stCon1 & " ,12 Od1" & stCon2 & " from IncomMemo where IM04='" & Left(iPA75, 6) & "' and IM05 is null and not(IM06 is null)" & mSQL & mSQL2 & _
        " union Select Im02, " & stCon1 & " ,13 Od1" & stCon2 & " from IncomMemo where IM04='" & Left(iPA75, 6) & "' and IM05 is null and IM06 is null" & mSQL & mSQL2 & _
        " union Select Im02, " & stCon1 & " ,14 Od1" & stCon2 & " from IncomMemo where IM04 is null and IM05='" & Left(iPA26(ixR), 8) & "' and not(IM06 is null)" & mSQL & mSQL2 & _
        " union Select Im02, " & stCon1 & " ,15 Od1" & stCon2 & " from IncomMemo where IM04 is null and IM05='" & Left(iPA26(ixR), 8) & "' and IM06 is null" & mSQL & mSQL2 & _
        " union Select Im02, " & stCon1 & " ,16 Od1" & stCon2 & " from IncomMemo where IM04 is null and IM05='" & Left(iPA26(ixR), 6) & "' and not(IM06 is null)" & mSQL & mSQL2 & _
        " union Select Im02, " & stCon1 & " ,17 Od1" & stCon2 & " from IncomMemo where IM04 is null and IM05='" & Left(iPA26(ixR), 6) & "' and IM06 is null" & mSQL & mSQL2
        '-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        stSQL = stSQL & " order by pType, pKind,Od1 "
        'Modified by Lydia 2022/01/06 debug-申請人有一個以上並且都有設定;  ex.FCP-057744的審查意見通知1202，申請人有一個以上並且都有設定核駁
        'strLevel = ""
        If ixR = 1 Then strLevel = ""
        'end 2022/01/06
        
        'end 2021/11/15
          BolExit = False
          iR = 1
          Set rsQuery = ClsLawReadRstMsg(iR, stSQL)
          If iR = 1 Then
             rsQuery.MoveFirst
             
             'Added by Morgan 2015/7/3
             '若為判斷是否內部收文,當個案或X+Y符合且設定不內部收文時
             'Remove by Lydia 2021/11/01 只處理C類備註內容；後面處理B類收文GetIncomMemoBCP
             'Memo by Lydia 2021/11/15 改成依照新規則讀取第一筆符合的設定
             'If Len(iPmemo) = 0 And IsNull(rsQuery("im09")) And rsQuery("Od1") < 10 Then
             '  Exit For
             ''End If
             ''end 2015/7/3
             'end 2011/11/01
             
             '第一次符合條件
             If Len(strMemo) = 0 Then
                'Remove by Lydia 2021/11/01 將C類備註內容和B類收文設定分開抓取內容
                'If Len(rsQuery(2)) > 0 Then
                '  iBCP10 = rsQuery(2) '傳回-案件性質
                'End If
               'iDays = rsQuery(3)
               'iBCP48 = Val(CompDate(2, iDays, strStartDate)) '傳回-承辦期限
               'end 2021/11/01
               'Added by Lydia 2022/01/06 判斷C類性質; 若有修改，需要一併修改Loop內的判斷； ex.FCP-057744的審查意見通知1202，申請人有一個以上並且都有設定核駁
               If ("" & rsQuery.Fields("pKind") = "A" And iCCP10 = "1202") Or "" & rsQuery.Fields("pKind") = "B" _
                      Or ("" & rsQuery.Fields("pKind") = "C" And iCCP10 = "" & rsQuery.Fields("im19")) Then
               'end 2022/01/06
                    strMemo = strMemo & rsQuery(0) '傳回-備註
                    '不同申請人-> 記上一次條件的title
                    If Not IsNull(rsQuery.Fields("k01")) Then
                       midRep = "(" & rsQuery.Fields("k01") & ")" & vbCrLf
                       strLevel = "1.個案:" & "(" & rsQuery.Fields("k01") & ")" 'Added by Lydia 2021/11/01
                    ElseIf Not IsNull(rsQuery.Fields("k02")) And Not IsNull(rsQuery.Fields("k03")) Then
                          midRep = "(" & rsQuery.Fields("k02") & " + " & rsQuery.Fields("k03") & ")" & vbCrLf
                          strLevel = "2.Y+X:" & "(" & rsQuery.Fields("k02") & " + " & rsQuery.Fields("k03") & ")"  'Added by Lydia 2021/11/01
                    Else
                         '３－只有代理人符合
                         If Not IsNull(rsQuery.Fields("k02")) And IsNull(rsQuery.Fields("k03")) Then
                            If ixR = 1 Then
                               midRep = "(" & rsQuery.Fields("k02") & ")" & vbCrLf
                               strLevel = "3.Y:" & "(" & rsQuery.Fields("k02") & ")"  'Added by Lydia 2021/11/01
                            Else
                               midRep = ""
                            End If
                         End If
                         '４－只有申請人符合
                         If IsNull(rsQuery.Fields("k02")) And Not IsNull(rsQuery.Fields("k03")) Then
                             midRep = "(" & rsQuery.Fields("k03") & ")" & vbCrLf
                             strLevel = "3.X:" & "(" & rsQuery.Fields("k03") & ")"  'Added by Lydia 2021/11/01
                         End If
                    End If
               End If 'Added by Lydia 2022/01/06
             End If
             
             'Modified by Lydia 2021/11/01 第一次迴圈的個案在內部判斷
             'If (ixR = 1 And rsQuery.RecordCount > 1) Or (ixR > 1 And rsQuery.RecordCount > 0) Then
             'Modified by Lydia 2022/01/06 + Len(strMemo) = 0
             If ixR = 1 Or (ixR > 1 And rsQuery.RecordCount > 0) Or Len(strMemo) = 0 Then
                Do While Not rsQuery.EOF
                    'Added by Lydia 2022/01/06 判斷C類性質; ex.FCP-057744的審查意見通知1202，申請人有一個以上並且都有設定核駁
                    If ("" & rsQuery.Fields("pKind") = "A" And iCCP10 = "1202") Or "" & rsQuery.Fields("pKind") = "B" _
                           Or ("" & rsQuery.Fields("pKind") = "C" And iCCP10 = "" & rsQuery.Fields("im19")) Then
                        '因為判斷C類性質，所以第一筆不見得符合條件，所以要重新確認第一筆符合
                        If Len(strMemo) = 0 Then
                            strMemo = strMemo & rsQuery(0) '傳回-備註
                            '不同申請人-> 記上一次條件的title
                            If Not IsNull(rsQuery.Fields("k01")) Then
                               midRep = "(" & rsQuery.Fields("k01") & ")" & vbCrLf
                               strLevel = "1.個案:" & "(" & rsQuery.Fields("k01") & ")" 'Added by Lydia 2021/11/01
                            ElseIf Not IsNull(rsQuery.Fields("k02")) And Not IsNull(rsQuery.Fields("k03")) Then
                                  midRep = "(" & rsQuery.Fields("k02") & " + " & rsQuery.Fields("k03") & ")" & vbCrLf
                                  strLevel = "2.Y+X:" & "(" & rsQuery.Fields("k02") & " + " & rsQuery.Fields("k03") & ")"  'Added by Lydia 2021/11/01
                            Else
                                 '３－只有代理人符合
                                 If Not IsNull(rsQuery.Fields("k02")) And IsNull(rsQuery.Fields("k03")) Then
                                    If ixR = 1 Then
                                       midRep = "(" & rsQuery.Fields("k02") & ")" & vbCrLf
                                       strLevel = "3.Y:" & "(" & rsQuery.Fields("k02") & ")"  'Added by Lydia 2021/11/01
                                    Else
                                       midRep = ""
                                    End If
                                 End If
                                 '４－只有申請人符合
                                 If IsNull(rsQuery.Fields("k02")) And Not IsNull(rsQuery.Fields("k03")) Then
                                     midRep = "(" & rsQuery.Fields("k03") & ")" & vbCrLf
                                     strLevel = "3.X:" & "(" & rsQuery.Fields("k03") & ")"  'Added by Lydia 2021/11/01
                                 End If
                            End If
                        End If
                    'end 2022/01/06
                    
                           'Remove by Lydia 2021/11/01 改新規則
                           ''優先備註: 1.案號->全部終止 2.代理人+申請人->不讀代理人或申請人->本次迴圈終止 3.代理人或申請人->逐筆讀取
                           ''有1. -> 無2. 3. ,有複數備註(2.代理人+申請人 ,  3.代理人或申請人)
                           ''１－案號
                           'If Not IsNull(rsQuery.Fields("k01")) Then
                           '   BolExit = True: bolEnd = True: Exit Do '符合->唯一備註
                           ''２－代理人+申請人
                           'ElseIf Not IsNull(rsQuery.Fields("k02")) And Not IsNull(rsQuery.Fields("k03")) Then
                           '   BolExit = True
                           'Else
                           'End If
                      '------------------------------------------------------------------------------------------------------------------------------------
                           'Memo by Lydia 2021/11/01 新規則順位修改成三階段，依序符合階段就不再抓資料
                           '(1)有個案：個案+ (Y+X1~X5) => 個案+Y or X  (2)Y+X  (3)Y or X
                           '=>整合來看只要有Y+X之後就不單獨讀取Y or X
                           bolThisJump = False
                            '第一次迴圈有判斷個案，之後要跳過個案
                            If InStr(strLevel, "1.個案") > 0 And ixR > 1 And Not IsNull(rsQuery.Fields("k01")) Then
                                bolThisJump = True
                            End If
                            '個案+ (Y+X1~X5)
                            If Not IsNull(rsQuery.Fields("k02")) And Not IsNull(rsQuery.Fields("k03")) Then
                                 'BolExit = True 'Y+X1之後就不單獨讀取Y or X 'Mark by Lydia 2021/11/11 可以讀取Y+X1~X5
                                 'Added by Lydia 2021/11/15 曾經抓到Y+X編號，就不用讀取；1.先抓到8碼XY,後抓到6碼，2.因為設定C類來函性質可以同一Y+X有一筆以上的設定
                                 'If InStr(strLevel, Left(rsQuery.Fields("k02"), 8) & " + " & Left(rsQuery.Fields("k03"), 8)) > 0 Or InStr(strLevel, Left(rsQuery.Fields("k02"), 6) & " + " & Left(rsQuery.Fields("k03"), 6)) > 0 _
                                         Or InStr(strLevel, Left(rsQuery.Fields("k02"), 6) & " + " & Left(rsQuery.Fields("k03"), 8)) > 0 Or InStr(strLevel, Left(rsQuery.Fields("k02"), 8) & " + " & Left(rsQuery.Fields("k03"), 6)) > 0 Then
                                 If InStr(strLevel, ";Y+X:(" & Left(rsQuery.Fields("k02"), 8) & " + " & Left(rsQuery.Fields("k03"), 8)) > 0 Or (InStr(strLevel, ";Y+X:(" & Left(rsQuery.Fields("k02"), 6)) > 0 And InStr(strLevel, " + " & Left(rsQuery.Fields("k03"), 6)) > 0) Then
                                    bolThisJump = True
                                 End If
                                 'end 2021/11/15
                                 'Modified by Lydia 2021/11/15 + pKind, Jump
                                 strLevel = strLevel & ";Y+X:(" & rsQuery.Fields("k02") & " + " & rsQuery.Fields("k03") & ")" & ",pKind=" & rsQuery.Fields("pkind") & ",Jump=" & IIf(bolThisJump = True, "T", "F")
                            '個案+ Y or X
                            ElseIf Not IsNull(rsQuery.Fields("k02")) Or Not IsNull(rsQuery.Fields("k03")) Then
                                 If InStr(strLevel & ",", "Y+X") > 0 Then
                                     bolThisJump = True
                                     BolExit = True 'Memo by Lydia 2021/11/11 Y+X1之後就不單獨讀取Y or X
                                 End If
                                 'Added by Lydia 2021/11/15 曾經抓到Y or X編號，就不用讀取；1.先抓到8碼XY,後抓到6碼，2.因為設定C類來函性質可以同一Y or X有一筆以上的設定
                                 If Not IsNull(rsQuery.Fields("k02")) And InStr(strLevel, ";Y:(" & rsQuery.Fields("k02")) > 0 Then      'Y編號
                                    bolThisJump = True
                                 End If
                                 If Not IsNull(rsQuery.Fields("k03")) And InStr(strLevel, ";X:(" & rsQuery.Fields("k03")) > 0 Then   'X編號
                                    bolThisJump = True
                                 End If
                                 strLevel = strLevel & IIf(Not IsNull(rsQuery.Fields("k02")), ";Y:(" & rsQuery.Fields("k02") & ")", _
                                               ";X:(" & rsQuery.Fields("k03") & ")") & ",pKind=" & rsQuery.Fields("pkind") & ",Jump=" & IIf(bolThisJump = True, "T", "F")
                                 'end 2021/11/15
                            End If
                            'Debug.Print strLevel
                            
                            'Memo by Lydia 2021/11/02 C類來函的指定送件日期=官方發文日+X個(1.日曆天，2.工作天)，承辦期限改為指定送件日期提前2個工作天 (Sharon與Owen協商過)
                            'Modified by Lydia 2021/11/12 +  bolThisJump = False
                            'Modified by Lydia 2025/08/13 讀取第一筆符合的設定，包含沒有設定；ex.P-130133個案有備註+C類來函設定但是沒有B類來函設定，表示不用產生B類收文，不用抓Y+X的B類收文設定
                            'If iCCP142 = "" And "" & rsQuery.Fields("im11") <> "" And bolThisJump = False Then
                            'Modified by Lydia 2025/08/25 經過Morgan+Sharon+Bobbie討論，還原B類和C類分別判斷
                            'If iCCP142 = "" And "" & rsQuery.Fields("im11") <> "" And bolThisJump = False And ixR = 1 And rsQuery.AbsolutePosition = 1 Then
                            If iCCP142 = "" And "" & rsQuery.Fields("im11") <> "" And bolThisJump = False Then
                                'Added by Lydia 2021/12/30  pKind 區分C類來函性質: 符合傳入性質則優先，其次為空白=預設 ; FCP-059418的12/24實審通知誤抓到核駁
                                If ("" & rsQuery.Fields("pKind") = "A" And iCCP10 = "1202") Or "" & rsQuery.Fields("pKind") = "B" _
                                    Or ("" & rsQuery.Fields("pKind") = "C" And iCCP10 = "" & rsQuery.Fields("im19")) Then
                                'end 2021/12/29
                                        'Added by Lydia 2022/10/13 判斷客戶C類來函期限起算類型
                                        If "" & rsQuery.Fields("im20") = "1" Or Len(iCP133) = 0 Then
                                            strStartDate = strSrvDate(1)
                                        Else
                                            strStartDate = DBDATE(iCP133)
                                        End If
                                        'end 2022/10/13
                                        If "" & rsQuery.Fields("im18") = "2" Then  '以工作天計算：期限皆不包含當天
                                            iCCP142 = CompWorkDay(Val("" & rsQuery.Fields("im11")) + 1, strStartDate)
                                        Else   '預設以日曆天計算：期限皆不包含當天，若使用日曆天的期限遇到非工作日往前移到工作日。
                                            iCCP142 = CompWorkDay(1, CompDate(2, Val("" & rsQuery.Fields("im11")), strStartDate), 1)
                                        End If
                                        iCCP48 = CompWorkDay(3, iCCP142, 1)
                                        If iCCP48 < strSrvDate(1) Then iCCP48 = strSrvDate(1)
                                End If 'Added by Lydia 2021/12/30
                            End If
                            
                            'Added by Lydia 2021/11/11 B類收文設定：依照新規則讀取第一筆符合的設定；
                            'Modified by Lydia 2021/11/12 +  bolThisJump = False
                            'Modified by Lydia 2025/08/13 讀取第一筆符合的設定，包含沒有設定；ex.P-130133個案有備註+C類來函設定但是沒有B類來函設定，表示不用產生B類收文，不用抓Y+X的B類收文設定
                            'If Len(iPmemo) = 0 And iBCP10 = "" And "" & rsQuery.Fields("IM06") <> "" And bolThisJump = False Then
                            'Modified by Lydia 2025/08/25 經過Morgan+Sharon+Bobbie討論，還原B類和C類分別判斷
                            'If Len(iPmemo) = 0 And iBCP10 = "" And "" & rsQuery.Fields("IM06") <> "" And bolThisJump = False And ixR = 1 And rsQuery.AbsolutePosition = 1 Then
                            'Modified by Lydia 2025/08/26 是否新增內部收文IM09：Y=新增收文；N=不新增收文；(8/26新增) 空白=不新增收文，繼續讀取其他規則設定。
                            'If Len(iPmemo) = 0 And iBCP10 = "" And "" & rsQuery.Fields("IM06") <> "" And bolThisJump = False Then
                            If Len(iPmemo) = 0 And iBCP10 = "" And "" & rsQuery.Fields("IM06") & rsQuery.Fields("IM09") <> "" And bolThisJump = False Then
                               If "" & rsQuery.Fields("IM09") = "N" Then
                                  iBCP10 = "N"
                               Else
                            'end 2025/08/26
                                  iBCP10 = "" & rsQuery.Fields("IM06")
                                  'Added by Lydia 2022/10/13 判斷內部收文期限起算類型
                                  If "" & rsQuery.Fields("im21") = "1" Or Len(iCP133) = 0 Then
                                     strStartDate = strSrvDate(1)
                                  Else
                                     strStartDate = DBDATE(iCP133)
                                  End If
                                  'end 2022/10/13
                                  'B類內部收文的官方發文日+承辦天數=所限，然後所限-2個工作天=承辦期限
                                  If "" & rsQuery.Fields("im10") = "2" Then  '以工作天計算：期限皆不包含當天
                                     iBCP06 = CompWorkDay(Val("" & rsQuery.Fields("im07")) + 1, strStartDate)
                                  Else    '預設以日曆天計算：期限皆不包含當天，若使用日曆天的期限遇到非工作日往前移到工作日。
                                     iBCP06 = CompWorkDay(1, CompDate(2, Val("" & rsQuery.Fields("im07")), strStartDate), 1)
                                  End If
                                  iBCP48 = CompWorkDay(3, iBCP06, 1)
                                  If iBCP48 < strSrvDate(1) Then iBCP48 = strSrvDate(1)
                               End If 'Added by Lydia 2025/08/26
                            End If
                            'end 2021/11/11
                           
                           If bolThisJump = False Then
                           'end 2021/11/01
                      '------------------------------------------------------------------------------------------------------------------------------------
                                If Left(strMemo, 10) <> Left(rsQuery(0), 10) Then
                                   If Not IsNull(rsQuery.Fields("k02")) And IsNull(rsQuery.Fields("k03")) Then
                                      If ixR = 1 Then strMemo = strMemo & "PS-SPACES" & rsQuery(0)
                                   Else
                                      strMemo = strMemo & "PS-SPACES" & rsQuery(0)
                                   End If
                                   '不同申請人-> 記上一次條件的title
                                   'Modified by Lydia 2021/11/01 +FCP,P
                                   If Not (Left(strMemo, 2) = "(X" Or Left(strMemo, 2) = "(Y" Or Left(strMemo, 2) = "(F" Or Left(strMemo, 2) = "(P") Then
                                      strMemo = midRep & strMemo
                                   End If
                                Else
                                  ' strMemo = "PSSPACES-" & strMemo
                                End If
                            
                                If Not IsNull(rsQuery.Fields("k01")) Then
                                   strMemo = Replace(strMemo, "PSSPACES-", "(" & rsQuery.Fields("k01") & ")" & vbCrLf)
                                   strMemo = Replace(strMemo, "PS-SPACES", "" & vbCrLf & "(" & rsQuery.Fields("k01") & ")" & vbCrLf)
                                   midRep = "(" & rsQuery.Fields("k01") & ")" & vbCrLf
                                ElseIf Not IsNull(rsQuery.Fields("k02")) And Not IsNull(rsQuery.Fields("k03")) Then
                                      strMemo = Replace(strMemo, "PSSPACES-", "(" & rsQuery.Fields("k02") & " + " & rsQuery.Fields("k03") & ")" & vbCrLf)
                                      strMemo = Replace(strMemo, "PS-SPACES", "" & vbCrLf & "(" & rsQuery.Fields("k02") & " + " & rsQuery.Fields("k03") & ")" & vbCrLf)
                                      midRep = "(" & rsQuery.Fields("k02") & " + " & rsQuery.Fields("k03") & ")" & vbCrLf
                                Else
                                    '３－只有代理人符合 (代理人只取第一次的值)
                                        '有系統別之分
                                     If Not IsNull(rsQuery.Fields("k02")) And IsNull(rsQuery.Fields("k03")) And ixR = 1 _
                                        And (IsNull(rsQuery.Fields("k04")) Or Left(rsQuery.Fields("k04"), 1) = Left(iSys01, 1)) Then
                                         strMemo = Replace(strMemo, "PSSPACES-", "(" & rsQuery.Fields("k02") & ")" & vbCrLf)
                                         strMemo = Replace(strMemo, "PS-SPACES", "" & vbCrLf & "(" & rsQuery.Fields("k02") & ")" & vbCrLf)
                                         midRep = "(" & rsQuery.Fields("k02") & ")" & vbCrLf
                                     End If
                                     '４－只有申請人符合
                                     If IsNull(rsQuery.Fields("k02")) And Not IsNull(rsQuery.Fields("k03")) Then
                                         strMemo = Replace(strMemo, "PSSPACES-", "(" & rsQuery.Fields("k03") & ")" & vbCrLf)
                                         strMemo = Replace(strMemo, "PS-SPACES", "" & vbCrLf & "(" & rsQuery.Fields("k03") & ")" & vbCrLf)
                                         midRep = "(" & rsQuery.Fields("k03") & ")" & vbCrLf
                                     End If
                                End If
        
                            If BolExit = True Then Exit Do
                           End If 'Added by Lydia 2021/11/01 bolThisJump
                   End If 'Added by Lydia 2022/01/06 判斷C類性質
                   rsQuery.MoveNext
                Loop
             End If
          End If
      End If
   Next ixR
   
   PUB_GetIncomMemoNew = strMemo
   If iBCP10 = "N" Then iBCP10 = "" 'Added by Lydia 2025/08/26
   
   Exit Function 'Added by Lydia 2021/11/11 (11/9 重新整理)依照新規則讀取第一筆符合的設定=>所以不是單獨抓B類設定來判斷
   
   'Added by Lydia 2021/11/01 B類收文設定
   If Len(iPmemo) = 0 Then
       'Modified by Lydia 2021/11/05
       'iBCP10 = GetIncomMemoBCP(iCno, iSys01, iCP133, iBCP48, iPA75, iCust01, iCust02, iCust03, iCust04, iCust05)
       iBCP10 = GetIncomMemoBCP(iCno, iSys01, iCP133, iBCP48, iPA75, iCustList, iBCP06)
   End If
   'end 2021/11/01
   Set rsQuery = Nothing
End Function

'Added by Lydia 2021/11/01　核駁及審查意見通知函（中間程序C類接洽單備註）：將C類備註內容和B類收文設定分開抓取內容；
                                            'B類收文設定：依照規則(個案->Y+X->Y->X)讀取第一筆符合的設定；
'Modified by Lydia 2021/11/05 +iCP06 所限
Private Function GetIncomMemoBCP(iCno As String, iSys01 As String, iCP133 As String, ByRef iCp48 As String, iPA75 As String, iCustList As String, Optional ByRef iCP06 As String) As String
'GetIncomMemoBCP=B類收文的案件性質
'iCp48=B類收文的承辦期限
    Dim stSQL As String, intR As Integer, mSQL As String, mSQL2 As String
    Dim strStartDate As String
    Dim rsR1 As ADODB.Recordset
    Dim ixR As Integer
    Dim iPA26(1 To 5) As String
    Dim tmpArr As Variant    'Added by Lydia 2021/11/05
    
    '當系統別為P案且代理人為Y20065時，預設承辦期限＝官方發文日＋承辦天數。
    If iSys01 = "P" And Left(iPA75, 6) = "Y20065" And Len(iCP133) > 0 Then
      strStartDate = iCP133
    Else
      strStartDate = strSrvDate(1) '預設系統日起算
    End If
    '以FCP代表國外案如FG
    If Left(iSys01, 1) = "F" Then iSys01 = "FCP"
    
    mSQL = " and IM09='Y'" '新增B類內部收文
    
   '以系統判斷,所以只有本所案號時要排除
   If Len(iSys01) > 0 Then
      mSQL2 = " and (IM08 = '" & iSys01 & "' or IM08 is null)"
   End If
      
   '複數筆備註
   'Modified by Lydia 2021/11/05
   'iPA26(1) = iCust01:  iPA26(2) = iCust02:  iPA26(3) = iCust03:  iPA26(4) = iCust04:  iPA26(5) = iCust05
   tmpArr = Split(iCustList, ",")
   For ixR = 0 To UBound(tmpArr)
      If Trim((tmpArr(ixR))) <> "" Then
          iPA26(ixR + 1) = tmpArr(ixR)
      End If
   Next ixR
   'end 2021/11/05
   
   For ixR = 1 To 5

   '順序 1.本所案號 2.代理人+申請人 3.代理人 4.申請人
   '承辦天數IM07預設7天
      If Len(iPA26(ixR)) > 0 And Not IsNull(iPA26(ixR)) Then
        stSQL = "select IM02,0 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10  from IncomMemo where IM03='" & iCno & "' and not(IM06 is null)" & _
        " union select IM02,1 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10  from IncomMemo where IM03='" & iCno & "' and IM06 is null" & _
        " union select IM02,2 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10  from IncomMemo where IM04='" & Left(iPA75, 8) & "' and IM05='" & Left(iPA26(ixR), 8) & "' and not(IM06 is null)" & mSQL2 & _
        " union select IM02,3 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10  from IncomMemo where IM04='" & Left(iPA75, 8) & "' and IM05='" & Left(iPA26(ixR), 8) & "' and IM06 is null" & mSQL2 & _
        " union select IM02,4 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10  from IncomMemo where IM04='" & Left(iPA75, 8) & "' and IM05='" & Left(iPA26(ixR), 6) & "' and not(IM06 is null)" & mSQL2 & _
        " union select IM02,5 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10  from IncomMemo where IM04='" & Left(iPA75, 8) & "' and IM05='" & Left(iPA26(ixR), 6) & "' and IM06 is null" & mSQL2 & _
        " union select IM02,6 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10  from IncomMemo where IM04='" & Left(iPA75, 6) & "' and IM05='" & Left(iPA26(ixR), 8) & "' and not(IM06 is null)" & mSQL2 & _
        " union select IM02,7 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10  from IncomMemo where IM04='" & Left(iPA75, 6) & "' and IM05='" & Left(iPA26(ixR), 8) & "' and IM06 is null" & mSQL2 & _
        " union select IM02,8 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10  from IncomMemo where IM04='" & Left(iPA75, 6) & "' and IM05='" & Left(iPA26(ixR), 6) & "' and not(IM06 is null)" & mSQL2 & _
        " union select IM02,9 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10  from IncomMemo where IM04='" & Left(iPA75, 6) & "' and IM05='" & Left(iPA26(ixR), 6) & "' and IM06 is null" & mSQL2 & _
        " union select IM02,10 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10  from IncomMemo where IM04='" & Left(iPA75, 8) & "' and IM05 is null and not(IM06 is null)" & mSQL & mSQL2 & _
        " union select IM02,11 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10  from IncomMemo where IM04='" & Left(iPA75, 8) & "' and IM05 is null and IM06 is null" & mSQL & mSQL2 & _
        " union select IM02,12 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10  from IncomMemo where IM04='" & Left(iPA75, 6) & "' and IM05 is null and not(IM06 is null)" & mSQL & mSQL2 & _
        " union select IM02,13 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10  from IncomMemo where IM04='" & Left(iPA75, 6) & "' and IM05 is null and IM06 is null" & mSQL & mSQL2 & _
        " union select IM02,14 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10  from IncomMemo where IM04 is null and IM05='" & Left(iPA26(ixR), 8) & "' and not(IM06 is null)" & mSQL & mSQL2 & _
        " union select IM02,15 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10  from IncomMemo where IM04 is null and IM05='" & Left(iPA26(ixR), 8) & "' and IM06 is null" & mSQL & mSQL2 & _
        " union select IM02,16 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10  from IncomMemo where IM04 is null and IM05='" & Left(iPA26(ixR), 6) & "' and not(IM06 is null)" & mSQL & mSQL2 & _
        " union select IM02,17 Od1, IM06,NVL(IM07,7) IM07 ,im03 K01,im04 K02,im05 K03,im08 K04,im09,im10  from IncomMemo where IM04 is null and IM05='" & Left(iPA26(ixR), 6) & "' and IM06 is null" & mSQL & mSQL2 & _
        " order by od1"
          intR = 1
          Set rsR1 = ClsLawReadRstMsg(intR, stSQL)
          If intR = 1 Then
             rsR1.MoveFirst
             Do While Not rsR1.EOF
                '以第一次符合條件為值
                If GetIncomMemoBCP = "" And "" & rsR1.Fields("im06") <> "" Then
                    GetIncomMemoBCP = "" & rsR1.Fields("im06")
                    'Memo by Lydia 2021/11/05 修改B類內部收文的官方發文日+承辦天數=所限，然後所限-2個工作天=承辦期限
                    If "" & rsR1.Fields("im10") = "2" Then  '以工作天計算：期限皆不包含當天
                        iCP06 = CompWorkDay(Val("" & rsR1.Fields("im07")) + 1, strStartDate)
                    Else    '預設以日曆天計算：期限皆不包含當天，若使用日曆天的期限遇到非工作日往前移到工作日。
                        iCP06 = CompWorkDay(1, CompDate(2, Val("" & rsR1.Fields("im07")), strStartDate), 1)
                    End If
                    iCp48 = CompWorkDay(3, iCP06, 1)
                    If iCp48 < strSrvDate(1) Then iCp48 = strSrvDate(1)
                    'end 2021/11/05
                    Exit For
                End If
                rsR1.MoveNext
             Loop
          End If
      End If
   Next ixR
   
   Set rsR1 = Nothing
End Function

'Add by Amy 2015/02/12 一案同時發文多筆且紙本送件,無新案或改請程序收據/回執設定
'收據/回執優先設定順位:
  '1.    有客戶函就有回執,歸入有客戶函那道
  '2.沒有客戶函要計件,歸入要計件那道
'Modify by Amy 2015/03/06
  '1.該案當日若有新案或改請程序發文則全部設無 (歸在通知申請日案號)。
  '2.該案當日若皆為電子送件且無發文規費則全部設無。
  '3.該案當日發文有信函時，A.電子送件有規費的才設有否則設無 B.紙本送件都設有 C.無信函的設無。
  '4.該案當日發文皆無信函時，電子送件有發文規費的收文號設有，紙本送件要計件的收文號設有。
Public Sub PUB_UpdateLP19(cp01 As String, cp02 As String, cp03 As String, cp04 As String, CP09s As String, CP123s As String, Optional stCP27 As String = "")
   'Dim arrCP09, arrCP123
   Dim strUpdY As String, strUpdN As String, strTmp As String
   Dim adoCPData As New ADODB.Recordset
   Dim stSqlCp As String, ii As Integer, intR As Integer
   'Add by Amy 2015/02/26
   'Dim arrUpdN() As String,bolIsCus As Boolean
   'Add by Amy 2015/03/06
   Dim strCP09s As String ', strCP123 As String
   Dim strHasLP10 As String, strNoLP10 As String
   '有紙本送件/是否為新案或改請/是否有規費/是否計件
   Dim bolCP118 As Boolean, bolIsNewCase As Boolean, bolHasCP84 As Boolean, bolCP123 As Boolean
   Dim strOurReceipt As String 'Added by Morgan 2020/3/18 事務所收據(有發文規費但無費用的程序 Ex:變更代理人為閻+林)
  
    If cp01 <> "P" Then Exit Sub

    
    '抓取同一天發文的資料
    'Modified by Morgan 2015/3/24 + and cp118||cp123 is not null 排除非電子送件且不經發文室者(Ex. P109993 分析)
    stSqlCp = "Select cp09,cp10,cp84,cp118,Decode(lp01,null,'*',Nvl(lp10,'')) as lp10,cp123,cp16 From CaseProgress,LetterProgress " & _
                    "Where cp01='" & cp01 & "' And cp02='" & cp02 & "' And cp03='" & cp03 & "' And cp04='" & cp04 & "' " & _
                    " And CP27=" & Val(stCP27) + 19110000 & " And CP09<'C' and cp118||cp123 is not null And cp09=lp01(+) "
    adoCPData.CursorLocation = adUseClient
    adoCPData.Open stSqlCp, cnnConnection, adOpenStatic, adLockReadOnly
    
    If adoCPData.RecordCount > 0 Then
        Do While adoCPData.EOF = False
            'Added by Morgan 2020/3/18
            If adoCPData.Fields("cp84") > 0 And Val("" & adoCPData.Fields("cp16")) = 0 Then
               strOurReceipt = adoCPData.Fields("cp09")
            End If
            'End 2020/3/18
            
            strCP09s = strCP09s & "'" & adoCPData.Fields("cp09") & "',"
            'Modified by Morgan 2015/4/2 衍生設計除外(發文就出客戶通知函，不必輸通知申請日案號)
            'Modified by Morgan 2015/8/21 +改請衍生設計308除外
            'Modified by Morgan 2021/6/30 +衍生設計改也要輸通知申請日案號--玲玲
            If (InStr(NewCasePtyList, "" & adoCPData.Fields("cp10")) > 0 Or (Len(adoCPData.Fields("cp10")) = 3 And Left(adoCPData.Fields("cp10"), 1) = "3")) Then
                bolIsNewCase = True
                strOurReceipt = "" 'Added by Morgan 2025/5/28 新申請案除外 Ex:P-135518
            End If
            
            If Val("" & adoCPData.Fields("cp84")) <> 0 Then bolHasCP84 = True
            If "" & adoCPData.Fields("cp118") = "" Then bolCP118 = True '紙本送件
            If "" & adoCPData.Fields("lp10") = "Y" Then strHasLP10 = strHasLP10 & "'" & adoCPData.Fields("cp09") & "'," '有信函
            If "" & adoCPData.Fields("lp10") = "" Then strNoLP10 = strNoLP10 & "'" & adoCPData.Fields("cp09") & "',"  '沒信函
            adoCPData.MoveNext
        Loop
        '1.新案或改請程序發文或 2.皆為電子送件且無發文規費 ,則全部設無
        If bolIsNewCase Or (bolCP118 = False And bolHasCP84 = False) Then
            If strCP09s <> "" Then
            
                'Modified by Morgan 2018/12/19 新案送件同日可能會申請優先權證明且另有客戶函及收據 Ex:P121245
                'strUpdN = "Update LetterProgress Set LP19=null,LP02=0 Where LP01 in (" & Left(strCP09s, Len(strCP09s) - 1) & ")"
                strUpdN = "Update LetterProgress Set LP19=null,LP02=0 Where LP01 in (" & Left(strCP09s, Len(strCP09s) - 1) & ") and LP19='Y'"
                cnnConnection.Execute strUpdN, intR
                'Modified by Morgan 2020/1/20 +,LP03=0,LP05=0 (原先設無收據時LP03會自動上系統日) Ex:P124049申請優先權證明
                'strUpdN = "Update LetterProgress Set LP19='Y',LP02=1 Where LP01 in (" & Left(strCP09s, Len(strCP09s) - 1) & ") and LP10='Y' and exists(select * from caseprogress where cp09=lp01 and cp84>0)"
                'Modified by Morgan 2020/4/9 客戶收據加判斷cp16>0
                strUpdN = "Update LetterProgress Set LP19='Y',LP02=1,LP03=0,LP05=0 Where LP01 in (" & Left(strCP09s, Len(strCP09s) - 1) & ") and LP10='Y' and exists(select * from caseprogress where cp09=lp01 and cp84>0 and cp16>0)"
                'end 2018/12/19
                cnnConnection.Execute strUpdN, intR
            End If
        '3.判斷發文有信函
        ElseIf strHasLP10 <> "" Then
            'Modified by Morgan 2015/3/19 +齊備日及判發日要清除
            'Modified by Morgan 2015/4/27 +電子送件有規費的才設有否則設無,紙本送件設有
            'strUpdY = "Update LetterProgress Set LP19='Y',LP02=1,LP03=0,LP05=0 Where LP01 in(" & Left(strHasLP10, Len(strHasLP10) - 1) & ") "
            'cnnConnection.Execute strUpdY, intR
            
            'Modified by Morgan 2019/3/5 規則修改
            'If strNoLP10 <> "" Then
            '    strUpdN = "Update LetterProgress Set LP19=null,LP02=0 Where LP01 in (" & Left(strNoLP10, Len(strNoLP10) - 1) & ")"
            '    cnnConnection.Execute strUpdN, intR
            'End If
            '電子送件無規費
            'strUpdY = "Update LetterProgress Set LP19=null,LP02=0 Where LP01 in(select cp09 from caseprogress where  cp01='" & cp01 & "' And cp02='" & cp02 & "' And cp03='" & cp03 & "' And cp04='" & cp04 & "' " & _
              " And CP27=" & DBDATE(stCP27) & " And CP09<'C' and cp118 is not null and nvl(cp84,0)=0) and lp10='Y'"
            'cnnConnection.Execute strUpdY, intR
            
            '電子送件有規費
            'strUpdY = "Update LetterProgress Set LP19='Y',LP02=1,LP03=0,LP05=0 Where LP01 in(select cp09 from caseprogress where  cp01='" & cp01 & "' And cp02='" & cp02 & "' And cp03='" & cp03 & "' And cp04='" & cp04 & "' " & _
              " And CP27=" & DBDATE(stCP27) & " And CP09<'C' and cp118 is not null and cp84>0) and lp10='Y'"
            'cnnConnection.Execute strUpdY, intR
            
            '先清除收據註記
            strUpdN = "Update LetterProgress Set LP19=null,LP02=0 Where LP01 in (select cp09 from caseprogress" & _
               " where  cp01='" & cp01 & "' And cp02='" & cp02 & "' And cp03='" & cp03 & "' And cp04='" & cp04 & "' " & _
               " And CP27=" & DBDATE(stCP27) & " And CP09<'C') and lp19='Y'"
            cnnConnection.Execute strUpdN, intR
             
            '電子送件有規費-->收據都歸到有信函的收文號
            'Added by Morgan 2019/4/8 可能不只一道程序有信函，無規費的程序不要設有收據 Ex:P-119863 申復
            'Modified by Morgan 2020/4/9 客戶收據加判斷cp16>0
            strUpdY = "Update LetterProgress Set LP19='Y',LP02=1,LP03=0,LP05=0 Where LP01 in(" & Left(strHasLP10, Len(strHasLP10) - 1) & ") " & _
               " and exists(select * from caseprogress where cp09=lp01 and cp118 is not null and cp84>0 and cp16>0) and lp10='Y'"
            cnnConnection.Execute strUpdY, intR
            If intR = 0 Then
            'end 2019/4/8
            
               strUpdY = "Update LetterProgress Set LP19='Y',LP02=1,LP03=0,LP05=0 Where LP01 in(" & Left(strHasLP10, Len(strHasLP10) - 1) & ") " & _
                  " and exists(select * from caseprogress where  cp01='" & cp01 & "' And cp02='" & cp02 & "' And cp03='" & cp03 & "' And cp04='" & cp04 & "'" & _
                  " And CP27=" & DBDATE(stCP27) & " And CP09<'C'  and cp118 is not null and cp84>0 and cp16>0) and lp10='Y'"
               cnnConnection.Execute strUpdY, intR
               
            End If 'Added by Morgan 2019/4/8
            'end 2019/3/5
            
            '紙本送件有經發文室
            strUpdY = "Update LetterProgress Set LP19='Y',LP02=1,LP03=0,LP05=0 Where LP01 in(select cp09 from caseprogress where  cp01='" & cp01 & "' And cp02='" & cp02 & "' And cp03='" & cp03 & "' And cp04='" & cp04 & "' " & _
              " And CP27=" & DBDATE(stCP27) & " And CP09<'C' and cp118 is null and cp123 is not null) and lp10='Y'"
            cnnConnection.Execute strUpdY, intR
            
        '4.皆無信函
        Else
            adoCPData.MoveFirst
            Do While adoCPData.EOF = False
                '電子送件有發文規費 或 紙本送件 的收文號設有
                If ("" & adoCPData.Fields("cp118") <> "" And Val("" & adoCPData.Fields("cp84")) > 0) Or "" & adoCPData.Fields("cp123") = "Y" Then
                    If adoCPData.Fields("lp10") = "*" Then
                        strUpdY = "Insert into LetterProgress (LP01,LP02,LP19) Values ('" & adoCPData.Fields("cp09") & "',1,'Y')"
                    Else
                        'Modified by Morgan 2022/6/27 +,LP05=0
                        strUpdY = "Update LetterProgress Set LP19='Y',LP02=1,LP03=0,LP05=0 Where LP01='" & adoCPData.Fields("cp09") & "' "
                    End If
                    cnnConnection.Execute strUpdY, intR
                Else
                    '紙本案件且不計件的收文號設沒有
                    strUpdN = strUpdN & "'" & adoCPData.Fields("cp09") & "',"
                End If
                adoCPData.MoveNext
            Loop
            If strUpdN <> "" Then
                strUpdN = "Update LetterProgress Set LP19=null,LP02=0 Where LP01 in (" & Left(strUpdN, Len(strUpdN) - 1) & ")"
                cnnConnection.Execute strUpdN, intR
            End If
        End If
        
        'Added by Morgan 2020/3/18
        If strOurReceipt <> "" Then
            'Modified by Morgan 2022/6/27 +,LP05=0 可能會有客戶函,Ex:P-128632 更正(AB1025616)規費收在申復
            strUpdY = "Update LetterProgress Set LP19='Y',LP02=1,LP03=0,LP05=0 Where LP01='" & strOurReceipt & "' "
            cnnConnection.Execute strUpdY, intR
            If intR = 0 Then
               strUpdY = "Insert into LetterProgress (LP01,LP02,LP19) Values ('" & strOurReceipt & "',1,'Y')"
               cnnConnection.Execute strUpdY, intR
            End If
        End If
        'end 2020/3/18
    End If
End Sub

'Add by Sindy 2020/2/12 收據/回執設定
'電子送件有發文規費的才設有,否則設無
'紙本送件要有算件數的才設有,否則設無
Public Sub PUB_UpdateLP19_T(cp01 As String, cp02 As String, cp03 As String, cp04 As String, stCP09 As String, stCP27 As String)
Dim strUpd As String
Dim adoCPData As New ADODB.Recordset
Dim stSqlCp As String
Dim intR As Integer
   
   If Not (Left(cp01, 1) = "T" Or cp01 = "FCT") Then Exit Sub
   If strSrvDate(1) < T商標電子化第2階段啟用日 Then Exit Sub '未啟用
   
   '抓取同一天發文的資料
   'and cp118||cp123 is not null 排除非電子送件且不經發文室者
   stSqlCp = "Select cp09,cp10,cp84,cp118,Decode(lp01,null,'*',Nvl(lp10,'')) as lp10,cp123,cp31" & _
             " From CaseProgress,LetterProgress" & _
             " Where cp01='" & cp01 & "' And cp02='" & cp02 & "' And cp03='" & cp03 & "' And cp04='" & cp04 & "'" & _
             " And CP27=" & Val(stCP27) + 19110000 & " And CP09<'C' and cp118||cp123 is not null And cp09=lp01(+)" & _
             " And cp09='" & stCP09 & "'"
   adoCPData.CursorLocation = adUseClient
   adoCPData.Open stSqlCp, cnnConnection, adOpenStatic, adLockReadOnly
   If adoCPData.RecordCount > 0 Then
      '有收據或回執
      'Modify By Sindy 2021/4/6 台灣案分割(308)子案沒有發文規費
      '   子案(案件性質分割且是否新案件CP31='Y')要等母案電子收據回來後才能出現在發文室
      ' Or ("" & adoCPData.Fields("cp118") <> "" And "" & adoCPData.Fields("cp10") = "308")
      'Modify By Sindy 2022/5/6 雅雯:有關TC案發文作業，目前系統有預設管制收據/回執，
      '                         但實際操作上,不管台灣或中國大陸的著作權在送件後都不會收到官方的回執或收據
      If (("" & adoCPData.Fields("cp118") <> "" And Val(adoCPData.Fields("cp84")) > 0) Or _
          ("" & adoCPData.Fields("cp118") = "" And "" & adoCPData.Fields("cp123") = "Y") Or _
          ("" & adoCPData.Fields("cp118") <> "" And "" & adoCPData.Fields("cp10") = "308") _
         ) And (cp01 <> "TC") Then
         '無信函,先新增
         If adoCPData.Fields("lp10") = "*" Then
             strUpd = "Insert into LetterProgress (LP01,LP02,LP19) Values ('" & adoCPData.Fields("cp09") & "',1,'Y')"
             cnnConnection.Execute strUpd, intR
         End If
         
         strUpd = "Update LetterProgress Set LP19='Y',LP02=1,LP03=0,LP05=0 Where LP01 in('" & adoCPData.Fields("cp09") & "')"
         cnnConnection.Execute strUpd, intR
      Else
         strUpd = "Update LetterProgress Set LP19=null,LP02=0 Where LP01 in('" & adoCPData.Fields("cp09") & "')"
         cnnConnection.Execute strUpd, intR
      End If
   End If
End Sub

'Added by Morgan 2025/3/25
'FTP檔案搬到封存區
Public Function PUB_MoveToArchive(ByVal pFtpPath As String, pTableName As String, ByRef pByCopy As Boolean, Optional pBack As Boolean) As Boolean
   Dim stSavePath As String, stFileName As String
   Dim stFullFtpPath As String, stFtpIP As String, stArcFtpIP As String
   Dim stTableDirFrom As String, stTableDirTo As String, stDir As String
   
   If pBack Then
      stTableDirFrom = PUB_GetFtpTableDir(pTableName, stFtpIP, True)
      stTableDirTo = PUB_GetFtpTableDir(pTableName, stArcFtpIP)
   Else
      stTableDirFrom = PUB_GetFtpTableDir(pTableName, stFtpIP)
      stTableDirTo = PUB_GetFtpTableDir(pTableName, stArcFtpIP, True)
   End If
   
   If InStr(pFtpPath, "/") > 0 Then
      stFileName = Mid(pFtpPath, InStrRev(pFtpPath, "/") + 1)
      stDir = stTableDirTo & "/" & Left(pFtpPath, InStrRev(pFtpPath, "/") - 1)
   Else
      stFileName = pFtpPath
      stDir = stTableDirTo
   End If
   
   '若Ftp的IP相同(同主機)則用
   If stFtpIP = stArcFtpIP Then
      pByCopy = False
      PUB_MoveToArchive = PUB_FtpRenFile(stTableDirFrom & "/" & pFtpPath, stDir, stFileName)
   Else
      pByCopy = True
      stSavePath = App.path & "\" & strUserNum & "\" & stFileName
      If PUB_GetFtpFile(pFtpPath, stSavePath, pTableName) Then
         If Dir(stSavePath) <> "" Then
            stFullFtpPath = PUB_GetFtpTableDir(pTableName, stArcFtpIP, True) & "/" & pFtpPath
            If PUB_FtpPutFile(stSavePath, stFullFtpPath, , , stArcFtpIP) Then
               PUB_MoveToArchive = True
               Kill stSavePath 'Added by Morgan 2025/4/28
            End If
         End If
      End If
   End If
End Function

'FTP檔案從封存區搬出
Public Function PUB_MoveFromArchive(ByVal pFtpPath As String, pTableName As String) As Boolean
   Dim stSavePath As String, stFileName As String
   Dim stFullFtpPath As String, stFtpIP As String

   If InStr(pFtpPath, "/") > 0 Then
      stFileName = Mid(pFtpPath, InStrRev(pFtpPath, "/") + 1)
   Else
      stFileName = pFtpPath
   End If
   
   stSavePath = App.path & "\" & strUserNum & "\" & stFileName
   If PUB_GetFtpFile(pFtpPath, stSavePath, pTableName, , , True) Then
      If Dir(stSavePath) <> "" Then
         stFullFtpPath = PUB_GetFtpTableDir(pTableName, stFtpIP) & "/" & pFtpPath
         If PUB_FtpPutFile(stSavePath, stFullFtpPath, , , stFtpIP) Then
            PUB_MoveFromArchive = True
         End If
      End If
   End If
End Function

'Added by Morgan 2015/3/12
'Modified by Morgan 2025/3/27 +pArchive
'Modify by Amy 2025/06/30 stBackMsg:傳入"0"-於此函數內彈訊息 /"1"-回傳組的訊息
'Modified by Morgan 2025/7/18 +pUpdateTime
Public Function PUB_GetFtpFile(ByVal pFtpPath As String, pSavePath As String, Optional pTableName As String = "CASEPAPERPDF", Optional pRaiseErr As Boolean = False, Optional pFtpIp As String, Optional pArchive As Boolean _
  , Optional ByRef stBackMsg As String = "0", Optional ByVal pUpdateTime As String) As Boolean
   
   Dim stAttDir As String
   Dim stErrMsg As String
   Dim stTableDir As String
   Dim stFullFtpPath As String 'Added by Morgan 2025/3/24
   Dim intMsgType As Integer 'Add by Amy 2025/06/30

On Error GoTo ErrHnd
   
   'Add by Amy 2025/06/30 回傳訊息
   intMsgType = Val(stBackMsg)
   stBackMsg = ""
   'end 2025/06/30
   
   '只考慮最後一層目錄是否已建立
   If InStr(pSavePath, "\") > 0 Then
      stAttDir = Left(pSavePath, InStrRev(pSavePath, "\") - 1)
      If Dir(stAttDir, vbDirectory) = "" Then
         MkDir stAttDir
      End If
   End If
   If Dir(pSavePath) <> "" Then
      SetAttr pSavePath, vbNormal 'Add By Sindy 2020/1/17 檔案設定為正常屬性
      Kill pSavePath
   End If
   
   'Added by Morgan 2025/3/27
   If pTableName = "CASEPAPERPDF" Then
      stTableDir = PUB_GetFtpTableDir(pTableName, pFtpIp, pArchive)
   Else
   'end 2025/3/27
      stTableDir = PUB_GetFtpTableDir(pTableName)
   End If
   
   If PUB_FtpGetFile(stTableDir & "/" & pFtpPath, pSavePath, pFtpIp) Then
      PUB_GetFtpFile = True
      'Added by Morgan 2025/7/18
      If pUpdateTime <> "" Then
         PUB_SetFileTime pSavePath, pUpdateTime
      End If
      'end 2025/7/18
   End If
   Exit Function

ErrHnd:
   
   If Err.Number = 70 Then
      stErrMsg = pSavePath & " 檔案已開啟！"
   Else
      stErrMsg = Err.Description
   End If
      
   If pRaiseErr = False Then
      'Modify by Amy 2025/06/30 +if 可回傳訊息
      If intMsgType = 0 Then
         MsgBox stErrMsg, vbCritical
      Else
         stBackMsg = stErrMsg
      End If
      'end 2025/06/30
   Else
      Err.Raise 999, , stErrMsg & IIf(Err.Number <> 0, "(" & Err.Number & ")", "")
   End If
End Function

'Added by Morgan 2015/3/12
'FTP檔案下載
Public Function PUB_FtpGetFile(pFromPath As String, pToPath As String, Optional pFtpIp As String) As Boolean
      
   Dim stErrMsg As String
   Dim hConnection As Long
   Dim dwInternetFlags As Long
   
   hConnection = PUB_GetFtpConnect(, , , pFtpIp)
   If hConnection <> 0 Then
      'Modified by Morgan 2018/8/3 +強制重新下載參數(INTERNET_FLAG_RELOAD)
      dwInternetFlags = &H2 'INTERNET_FLAG_TRANSFER_BINARY
      dwInternetFlags = dwInternetFlags + &H80000000 'INTERNET_FLAG_RELOAD
      If FtpGetFile(hConnection, pFromPath, pToPath, False, FILE_ATTRIBUTE_ARCHIVE, dwInternetFlags, 0) <> 1 Then
         stErrMsg = "檔案讀取失敗！"
         GoTo OutPort
      End If
      
      PUB_AddFTPAuditLog AL_下載, pFromPath 'Added by Morgan 2025/7/31
      
      PUB_FtpGetFile = True
   End If
   
OutPort:
   If Err.Number <> 0 Then stErrMsg = Err.Description
   If hConnection <> 0 Then InternetCloseHandle (hConnection)
   
   If PUB_FtpGetFile = False Then
      Err.Raise 999, , stErrMsg & IIf(Err.Number <> 0, "(" & Err.Number & ")", "")
   End If
End Function

'Added by Morgan 2015/3/12
Public Function PUB_PutFtpFile(pFromPath As String, pKeyNo As String, pFileName As String, Optional pGoodToPath As String, Optional pTableName As String = "CASEPAPERPDF", Optional pEEF02 As String) As Boolean
Dim stFtpPath As String, stFilePath As String, stTableDir As String
'Add By Sindy 2017/8/10
Dim strSql As String, intR As Integer
Dim rsA As New ADODB.Recordset
Dim Str01 As String, Str02 As String
'2017/8/10 END
   
   'Add By Sindy 2016/1/14
   'Modified by Morgan 2016/4/15
   'If pTableName = "IPDEPTINPUT" Then
   'Modify By Sindy 2016/9/12
   'If pTableName = "IPDEPTINPUT" Or pTableName = "ACC152" Then
   'Modified by Lydia 2017/08/09 + CONTACTRECORD : 往來記錄 (取前4碼)
   'Modify By Sindy 2019/2/25 "CONTACTRECORD" 改為 "CONTACTFILE"
   'Modify By Sindy 2019/4/11 + TMINPUT
   If pTableName = "IPDEPTINPUT" Or pTableName = "ACC152" Or pTableName = "PATENTINPUT" _
      Or pTableName = "CONTACTFILE" Or pTableName = "TMINPUT" Then
   '2016/9/12 END
   'end 2016/4/15
      'Modify By Sindy 2016/4/14 增加年度資料夾,再放日期資料夾,以免未來同一層資料夾過多
      'stFtpPath = pKeyNo
      stFtpPath = Left(pKeyNo, 4) & "/" & pKeyNo
      '2016/4/14 END
   'Add By Sindy 2017/5/22 + SEMINARATTACHMENT : 研討會附件,依編號100號為1個資料夾
   ElseIf pTableName = "SEMINARATTACHMENT" Then
      stFtpPath = (Int(pKeyNo / 100) + 1) * 100 & "/" & pKeyNo
   'Add By Sindy 2017/5/25 + CUSTWEBFILE : 客戶平台,不另建子資料夾
   'Add By Sindy 2017/5/31 + PRICELISTFILE : 價目表電子檔,不另建子資料夾
   'Add By Sindy 2017/5/31 + PRICELISTBULLETIN : 價目表公文電子檔,不另建子資料夾
   'Add By Sindy 2017/5/31 + CONSULTRECIMAGEF : 接洽記錄單代表圖檔,不另建子資料夾
   'Add By Sindy 2017/7/26 + MAILSCHEDULETEMPLET : 郵件排程樣本檔,不另建子資料夾
   ElseIf pTableName = "CUSTWEBFILE" Or pTableName = "PRICELISTFILE" Or _
      pTableName = "PRICELISTBULLETIN" Or pTableName = "CONSULTRECIMAGEF" Or _
      pTableName = "MAILSCHEDULETEMPLET" Then
      stFtpPath = ""
   '2016/1/14 END
   'Add By Sindy 2017/8/9 + IMGBYTEFILE : 卷和代表圖檔
   ElseIf pTableName = "IMGBYTEFILE" Then
      Str01 = SystemNumber(pKeyNo, 1)
      Str02 = SystemNumber(pKeyNo, 2)
      strSql = "select * from systemkind where sk01='" & Str01 & "'"
      intR = 1
      Set rsA = ClsLawReadRstMsg(intR, strSql)
      If intR = 1 Then '是系統別
         stFilePath = Str01 & CStr(Left(Str02, 3)) & "/" & pFileName
      Else
         stFilePath = Str01 & "/" & pFileName
      End If
   '2017/8/9 END
   'Add By Sindy 2023/10/24
   ElseIf pTableName = "STAFF_EVALU_FILE" Then
      stFilePath = Replace(pKeyNo, "-", "/") & "/" & pFileName
   '2023/10/24 END
   'Added by Lydia 2017/08/09 CASEPROGRESSAPPENDIX 案件進度附件存放路徑 (取收文號,建子資料夾)
   ElseIf pTableName = "CASEPROGRESSAPPENDIX" Then
      stFtpPath = Left(pKeyNo, 9)
   'end 2017/08/09
   'Added by Lydia 2017/08/16 + NOTAGENT : 不得代理案件
   ElseIf pTableName = "NOTAGENT" Then
      stFtpPath = pKeyNo
   'Added by Lydia 2017/08/16  CFQUOTATION CF代理人報價附件記錄 (取前2碼)
   ElseIf pTableName = "CFQUOTATION" Then
      stFilePath = Left(pKeyNo, 2) & "/" & Left(pKeyNo, 9) & "/" & pFileName
   'end 2017/08/16
   'Add by Amy 2018/01/11 +合約資料
   ElseIf UCase(pTableName) = "CONTRACT" Then
      stFtpPath = Left(pKeyNo, 3) & "/" & pKeyNo
   
   'Added by Morgan 2019/5/16
   ElseIf UCase(pTableName) = "PATENTSEARCH" Or UCase(pTableName) = "PATENTSEARCHDETAIL" Then
      stFtpPath = Left(Format(pKeyNo, "000000"), 3) & "/" & Format(pKeyNo, "000")
   'Added by Morgan 2023/2/15
   ElseIf UCase(pTableName) = UCase("TMGoodsAtt") Then
      stFtpPath = Left(pKeyNo, Len(pKeyNo) - 6) & "/" & pKeyNo
   'end 2023/2/15
   Else
      stFtpPath = PUB_GetFtpDir(pKeyNo)
   End If
   'Modified by Morgan 2015/5/6 取消收文號目錄改檔名前加收文號
   'stFilePath = stFtpPath & IIf(pEEF02 <> "", "/" & pEEF02, "") & "/" & pFileName
   'Modified by Lydia 2017/08/16 +CFQUOTATION
   'Add By Sindy 2017/8/10 + if
   If pTableName <> "IMGBYTEFILE" And pTableName <> "CFQUOTATION" And pTableName <> "STAFF_EVALU_FILE" Then
      If InStr(stFtpPath, pKeyNo) > 0 Then
         stFilePath = stFtpPath & "/" & pFileName
      Else
         stFilePath = stFtpPath & "/" & pKeyNo & "." & IIf(pEEF02 <> "", pEEF02 & ".", "") & pFileName
      End If
   End If
   'end 2015/5/6
   If Left(stFilePath, 1) = "/" Then stFilePath = Mid(stFilePath, 2) 'Add By Sindy 2017/5/26
   If PUB_GetGoodName(stFilePath, pGoodToPath, pTableName, pKeyNo) = True Then
      stTableDir = PUB_GetFtpTableDir(pTableName)
      PUB_PutFtpFile = PUB_FtpPutFile(pFromPath, stTableDir & "/" & pGoodToPath)
   End If
   
End Function

'Added by Morgan 2016/9/5
'檔名去除非英數字
'Modified by Lydia 2017/09/08 保留英數字(含空白) bolSpace =Aacii(0~255)
'Modified by Lydia 2018/03/29 保留中間空白 bMidSpace
'Modified by Lydia 2025/09/10 保留.,& bMidSingle
Public Function PUB_GetSimpleName(pFilePath As String, Optional ByVal bolSpace As Boolean = False, Optional ByVal bMidSpace As Boolean, Optional ByVal bMidSingle As Boolean) As String
   Dim stSimpleName As String
   Dim iPos As Integer, ii As Integer, ICode As Integer
   
   iPos = InStrRev(pFilePath, "/")
   If iPos > 0 Then
      stSimpleName = Left(pFilePath, iPos)
   End If
   'Added by Lydia 2024/08/30 傳入地址，去除特定字
   If InStr(pFilePath, "竹曆退件") > 0 And InStr(pFilePath, """") > 0 Then
      pFilePath = Mid(pFilePath, 1, InStr(pFilePath, """") - 1)
   End If
   'end 2024/08/30
   For ii = iPos + 1 To Len(pFilePath)
      'Modified by Lydia 2022/03/31 原:Asc 導致 UniCode 的Asc會是?的Ascii
      'ICode = Asc(Mid(pFilePath, ii, 1))
      ICode = AscW(Mid(pFilePath, ii, 1))
      'Added by Lydia 2017/09/08 保留英數字(含空白)
      If bolSpace = True Then
         'Modified by Lydia 2022/03/31 排除?=63
         If ICode > 0 And ICode <= 255 And ICode <> 63 Then stSimpleName = stSimpleName & Mid(pFilePath, ii, 1)
      Else
      'end 2017/09/08
      '檔名限制改為只可為英數字及"_","-"(因中文在FTP系統會有Unicode與Big5碼轉換問題)
      'Modified by Lydia 2018/03/29 保留中間空白
      'If (ICode >= 48 And ICode <= 57) Or (ICode >= 65 And ICode <= 90) Or (ICode >= 97 And ICode <= 122) Or ICode = 45 Or ICode = 46 Or ICode = 95 Then
      'Modified by Lydia 2025/09/10 bMidSingle 保留:.,'&()#
      If (ICode >= 48 And ICode <= 57) Or (ICode >= 65 And ICode <= 90) Or (ICode >= 97 And ICode <= 122) _
               Or ICode = 45 Or ICode = 46 Or ICode = 95 Or (bMidSpace = True And ICode = 32) Or (bMidSingle = True And (ICode = 47 Or ICode = 44 Or ICode = 38 Or ICode = 39 Or ICode = 40 Or ICode = 41 Or ICode = 35)) Then
         stSimpleName = stSimpleName & Mid(pFilePath, ii, 1)
      End If
      End If 'end 2017/09/08
   Next
   'Added by Lydia 2018/03/29 保留中間空白
   If bMidSpace = True Then stSimpleName = Trim(stSimpleName)
   
   'Added by Morgan 2022/8/11 最後一個字元不可為"."，否則檔案總管無法正常顯示
   If bMidSingle = False Then 'Added by Lydia 2025/09/10 排除ACC220檢查短地址A2218
     Do While Right(stSimpleName, 1) = "."
        stSimpleName = Mid(stSimpleName, 1, Len(stSimpleName) - 1)
     Loop
   End If
   'end 2022/8/11
   
   PUB_GetSimpleName = stSimpleName
End Function

Public Function PUB_GetGoodName(pFilePath As String, pGoodFilePath As String, _
   Optional pTableName As String = "CASEPAPERPDF", Optional pKeyNo As String = "") As Boolean

Dim stFilePath As String, stBody As String, stTail As String, stAdd As String
Dim stSQL As String, intR As Integer
Dim rsQuery As ADODB.Recordset
Dim iSNo As Integer
Dim iPos As Integer
Dim Str01 As String, Str02 As String, Str03 As String, Str04 As String, Str05 As String 'Add By Sindy 2017/8/10
Dim stIdxCon As String 'Added by Morgan 2024/10/18 會用到index的條件
   
   'Modified by Morgan 2015/6/4 去除空白,否則 FtpFindFirstFile 會找不到
   'stFilePath = pFilePath
   'Modified by Morgan 2016/9/5
   'stFilePath = Replace(pFilePath, " ", "")
   stFilePath = PUB_GetSimpleName(pFilePath)
   iPos = InStrRev(stFilePath, ".")
   If iPos > 0 Then
      stBody = Left(stFilePath, iPos - 1)
      stTail = Mid(stFilePath, iPos)
   Else
      stBody = stFilePath
      stTail = ""
   End If
   'end 2016/9/5
   'end 2015/6/4
   
   'Added by Morgan 2024/10/18
   iPos = InStrRev(stBody, "/")
   If iPos > 0 Then
      stIdxCon = Left(stBody, iPos)
   End If
   'end 2024/10/18
   
   Do
      pTableName = UCase(pTableName)
      'Modified by Morgan 2016/6/13 檔名大小寫不同也要算重覆
      'Modify By Sindy 2015/6/24 +ChgSQL
      
      If pTableName = "CASEPAPERPDF" Then
         stSQL = "select cpp14 from casepaperpdf where upper(cpp14)='" & ChgSQL(UCase(stFilePath)) & "'"
         'Added by Morgan 2024/10/18 原語法無法使用index會比較慢，增加前面資料夾字串的條件
         If stIdxCon <> "" Then stSQL = stSQL & " and cpp14 like '" & ChgSQL(stIdxCon) & "%'"
      'Added by Morgan 2015/4/27
      ElseIf pTableName = "CASEPAPERFILE" Then
         stSQL = "select cpf13 from CASEPAPERFILE where upper(cpf13)='" & ChgSQL(UCase(stFilePath)) & "'"
         'Added by Morgan 2024/10/18 原語法無法使用index會比較慢，增加前面資料夾字串的條件
         If stIdxCon <> "" Then stSQL = stSQL & " and cpf13 like '" & ChgSQL(stIdxCon) & "%'"
      ElseIf pTableName = "EMPELECTRONFILE" Then
         stSQL = "select eef12 from EMPELECTRONFILE where upper(eef12)='" & ChgSQL(UCase(stFilePath)) & "'"
         'Added by Morgan 2024/10/18 原語法無法使用index會比較慢，增加前面資料夾字串的條件
         If stIdxCon <> "" Then stSQL = stSQL & " and eef12 like '" & ChgSQL(stIdxCon) & "%'"
      'end 2015/4/27
      'Add By Sindy 2016/1/14
      ElseIf pTableName = "IPDEPTINPUT" Then
         stSQL = "select ii14 from IPDEPTINPUT where upper(ii14)='" & ChgSQL(UCase(stFilePath)) & "'"
         'Added by Morgan 2024/10/18 原語法無法使用index會比較慢，增加前面資料夾字串的條件
         If stIdxCon <> "" Then stSQL = stSQL & " and ii14 like '" & ChgSQL(stIdxCon) & "%'"
      '2016/1/14 END
      'Add By Sindy 2016/1/14
      ElseIf pTableName = "PATENTINPUT" Then
         stSQL = "select pi14 from PATENTINPUT where upper(pi14)='" & ChgSQL(UCase(stFilePath)) & "'"
         'Added by Morgan 2024/10/18 原語法無法使用index會比較慢，增加前面資料夾字串的條件
         If stIdxCon <> "" Then stSQL = stSQL & " and pi14 like '" & ChgSQL(stIdxCon) & "%'"
      '2016/1/14 END
      'Add By Sindy 2019/4/11
      ElseIf pTableName = "TMINPUT" Then
         stSQL = "select ti14 from TMINPUT where upper(ti14)='" & ChgSQL(UCase(stFilePath)) & "'"
         'Added by Morgan 2024/10/18 原語法無法使用index會比較慢，增加前面資料夾字串的條件
         If stIdxCon <> "" Then stSQL = stSQL & " and ti14 like '" & ChgSQL(stIdxCon) & "%'"
      '2019/4/11 END
      'Added by Morgan 2016/4/15
      ElseIf pTableName = "ACC152" Then
         stSQL = "select AYF06 from ACC152 where upper(AYF06)='" & ChgSQL(UCase(stFilePath)) & "'"
         'Added by Morgan 2024/10/18 原語法無法使用index會比較慢，增加前面資料夾字串的條件
         If stIdxCon <> "" Then stSQL = stSQL & " and AYF06 like '" & ChgSQL(stIdxCon) & "%'"
      'end 2016/4/15
      'Added by Lydia 2016/06/23
      'Memo by Lydia 2016/06/30 因為檔名由系統給予一律為大寫，直接用INDEX查詢
      ElseIf InStr(pTableName, "TMQFILE") > 0 Then
         stSQL = "select TQF12 from TMQFILE where TQF12='" & ChgSQL(UCase(stFilePath)) & "'"
      'end 2016/06/23
      'Added by Lydia 2024/09/26 查名單-網中TMQAPPFILE
      ElseIf InStr(pTableName, "TMQAPPFILE") > 0 Then
         stSQL = "select TMF09 from TMQAPPFILE where TMF09='" & ChgSQL(UCase(stFilePath)) & "'"
      'end 2024/09/26
      'Add By Sindy 2017/5/22
      ElseIf pTableName = "SEMINARATTACHMENT" Then
         stSQL = "select sa07 from SEMINARATTACHMENT where sa01='" & pKeyNo & "' and upper(sa07)='" & ChgSQL(UCase(stFilePath)) & "'"
      '2017/5/22 END
      'Add By Sindy 2017/5/25
      ElseIf pTableName = "CUSTWEBFILE" Then
         stSQL = "select cf08 from CUSTWEBFILE where upper(cf08)='" & ChgSQL(UCase(stFilePath)) & "'"
         'Added by Morgan 2024/10/18 原語法無法使用index會比較慢，增加前面資料夾字串的條件
         If stIdxCon <> "" Then stSQL = stSQL & " and cf08 like '" & ChgSQL(stIdxCon) & "%'"
      '2017/5/25 END
      'Add By Sindy 2017/5/31
      ElseIf pTableName = "PRICELISTFILE" Then
         stSQL = "select PLF11 from PRICELISTFILE where upper(PLF11)='" & ChgSQL(UCase(stFilePath)) & "'"
         'Added by Morgan 2024/10/18 原語法無法使用index會比較慢，增加前面資料夾字串的條件
         If stIdxCon <> "" Then stSQL = stSQL & " and PLF11 like '" & ChgSQL(stIdxCon) & "%'"
      ElseIf pTableName = "PRICELISTBULLETIN" Then
         stSQL = "select PLB13 from PRICELISTBULLETIN where upper(PLB13)='" & ChgSQL(UCase(stFilePath)) & "'"
         'Added by Morgan 2024/10/18 原語法無法使用index會比較慢，增加前面資料夾字串的條件
         If stIdxCon <> "" Then stSQL = stSQL & " and PLB13 like '" & ChgSQL(stIdxCon) & "%'"
      ElseIf pTableName = "CONSULTRECIMAGEF" Then
         stSQL = "select crif05 from CONSULTRECIMAGEF where upper(crif05)='" & ChgSQL(UCase(stFilePath)) & "'"
         'Added by Morgan 2024/10/18 原語法無法使用index會比較慢，增加前面資料夾字串的條件
         If stIdxCon <> "" Then stSQL = stSQL & " and crif05 like '" & ChgSQL(stIdxCon) & "%'"
      '2017/5/31 END
      'Add By Sindy 2017/7/26
      ElseIf pTableName = "MAILSCHEDULETEMPLET" Then
         stSQL = "select MST06 from MAILSCHEDULETEMPLET where upper(MST06)='" & ChgSQL(UCase(stFilePath)) & "'"
         'Added by Morgan 2024/10/18 原語法無法使用index會比較慢，增加前面資料夾字串的條件
         If stIdxCon <> "" Then stSQL = stSQL & " and MST06 like '" & ChgSQL(stIdxCon) & "%'"
      '2017/7/26 END
      'Add By Sindy 2017/8/10 + IMGBYTEFILE : 卷和代表圖檔
      ElseIf pTableName = "IMGBYTEFILE" Then
         Str01 = SystemNumber(pKeyNo, 1)
         Str02 = SystemNumber(pKeyNo, 2)
         Str03 = SystemNumber(pKeyNo, 3)
         Str04 = SystemNumber(pKeyNo, 4)
         If InStr(Str04, "-") > 0 Then
            Str04 = Left(Str04, InStr(Str04, "-") - 1)
         End If
         Str05 = Right(pKeyNo, Len(pKeyNo) - InStrRev(pKeyNo, "-"))
         'Modify By Sindy 2018/10/31 TF馬德里商標圖檔-子案的圖同母案
         '固定都以IBF01=tm01 AND IBF02=substr(tm02,1,5)||'0' AND IBF03='0' AND IBF04='00' 去抓代表圖
         If Str01 = "TF" Then
            stSQL = "select IBF15 from IMGBYTEFILE where upper(IBF15)='" & ChgSQL(UCase(stFilePath)) & "'" & _
                    " and IBF01='" & Str01 & "' and IBF02='" & Mid(Str02, 1, 5) & "0" & "'" & _
                    " and ibf03='0' And ibf04='00'" & _
                    " and IBF05='" & Str05 & "'"
         Else
         '2018/10/31 END
            stSQL = "select IBF15 from IMGBYTEFILE where upper(IBF15)='" & ChgSQL(UCase(stFilePath)) & "'" & _
                    " and IBF01='" & Str01 & "' and IBF02='" & Str02 & "'" & _
                    " and IBF03='" & Str03 & "' and IBF04='" & Str04 & "'" & _
                    " and IBF05='" & Str05 & "'"
         End If
      '2017/8/10 END
      'Add By Sindy 2023/10/24
      ElseIf pTableName = "STAFF_EVALU_FILE" Then
         Str01 = SystemNumber(pKeyNo, 1)
         Str02 = SystemNumber(pKeyNo, 2)
         Str03 = SystemNumber(pKeyNo, 3)
         stSQL = "select SJF05 from STAFF_EVALU_FILE where SJF01='" & Str01 & "'" & _
                    " and SJF02='" & Str02 & "' and SJF03=" & Str03 & " and upper(SJF05)='" & ChgSQL(UCase(stFilePath)) & "'"
      '2023/10/24 END
      'Added by Lydia 2017/08/09 往來記錄
      'Modify By Sindy 2019/2/25 "CONTACTRECORD" 改為 "CONTACTFILE"
      ElseIf pTableName = "CONTACTFILE" Then
         'Modify By Sindy 2019/2/25
         'stSQL = "select CR20 from CONTACTRECORD where CR01='" & pKeyNo & "' AND instr(upper(CR20),'" & UCase(stFilePath) & "') > 0"
         stSQL = "select CF06 from CONTACTFILE where upper(cf06)='" & ChgSQL(UCase(stFilePath)) & "'"
         '2019/2/25 END
         'Added by Morgan 2024/10/18 原語法無法使用index會比較慢，增加前面資料夾字串的條件
         If stIdxCon <> "" Then stSQL = stSQL & " and cf06 like '" & ChgSQL(stIdxCon) & "%'"
      'Added by Lydia 2017/08/09 不得代理案件
      ElseIf UCase(pTableName) = "NOTAGENT" Then
         stSQL = "select NT31 from notagent where NT01='" & pKeyNo & "' AND instr(upper(NT31),'" & UCase(stFilePath) & "') > 0"
      'end 2017/08/09
      'Added by Lydia 2017/08/09 CF代理人報價附件記錄
      ElseIf UCase(pTableName) = "CFQUOTATION" Then
         stSQL = "select CQ11 from CFQUOTATION where CQ01||CQ02='" & pKeyNo & "' AND instr(upper(CQ11),'" & UCase(stFilePath) & "') > 0"
      'end 2017/08/09
      'Added by Lydia 2017/08/09 + CASEPROGRESSAPPENDIX 案件進度附件存放路徑
      ElseIf UCase(pTableName) = "CASEPROGRESSAPPENDIX" Then
         stSQL = "select CPA06 from CASEPROGRESSAPPENDIX where CPA01='" & pKeyNo & "' AND instr(upper(CPA06),'" & UCase(stFilePath) & "') > 0"
      'end 2017/08/09
      'Add by Amy 2018/01/11 +合約資料CONTRACT
      ElseIf UCase(pTableName) = "CONTRACT" Then
         stSQL = "select CT09 from CONTRACT where CT01='" & pKeyNo & "' AND instr(upper(CT09),'" & UCase(stFilePath) & "') > 0"
      'Added by Morgan 2019/5/15
      ElseIf UCase(pTableName) = "PATENTSEARCH" Then
         stSQL = "select PS04 from PATENTSEARCH where upper(PS04)='" & ChgSQL(UCase(stFilePath)) & "'"
         'Added by Morgan 2024/10/18 原語法無法使用index會比較慢，增加前面資料夾字串的條件
         If stIdxCon <> "" Then stSQL = stSQL & " and PS04 like '" & ChgSQL(stIdxCon) & "%'"
      ElseIf UCase(pTableName) = "PATENTSEARCHDETAIL" Then
         stSQL = "select PSD08 from PATENTSEARCHDETAIL where upper(PSD08)='" & ChgSQL(UCase(stFilePath)) & "'"
         'Added by Morgan 2024/10/18 原語法無法使用index會比較慢，增加前面資料夾字串的條件
         If stIdxCon <> "" Then stSQL = stSQL & " and PSD08 like '" & ChgSQL(stIdxCon) & "%'"
      'end 2019/5/15
      'Added by Morgan 2023/2/15
      ElseIf UCase(pTableName) = "TMGOODSATT" Then
         stSQL = "select TGA09 from TMGOODSATT where upper(TGA09)='" & ChgSQL(UCase(stFilePath)) & "'"
         'Added by Morgan 2024/10/18 原語法無法使用index會比較慢，增加前面資料夾字串的條件
         If stIdxCon <> "" Then stSQL = stSQL & " and TGA09 like '" & ChgSQL(stIdxCon) & "%'"
      'end 2023/2/15
      'Added by Lydia 2024/05/07
      ElseIf UCase(pTableName) = "TMQAPPFILE" Then
         stSQL = "select TMF09 from TMQAPPFILE where upper(TMF09)='" & ChgSQL(UCase(stFilePath)) & "'"
         'Added by Morgan 2024/10/18 原語法無法使用index會比較慢，增加前面資料夾字串的條件
         If stIdxCon <> "" Then stSQL = stSQL & " and TMF09 like '" & ChgSQL(stIdxCon) & "%'"
      'end 2024/05/07
      Else
         Exit Function
      End If
      intR = 1
      Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         iSNo = iSNo + 1
         'Modified by Morgan 2016/9/5
         'stFilePath = pFilePath & "." & Format(iSNo, "000")
         stAdd = Format(iSNo, "000")
         stFilePath = stBody & stTail & "." & stAdd
         'end 2016/9/5
      ElseIf intR = 0 Then
         pGoodFilePath = stFilePath
         PUB_GetGoodName = True
         Exit Do
      Else
          Err.Raise 999, , "FTP檔名檢查失敗！"
      End If
   Loop
   
   Set rsQuery = Nothing
End Function

'Added by Morgan 2015/3/12
'FTP檔案上傳
Public Function PUB_FtpPutFile(pLocalPath As String, pFtpPath As String, Optional pErrMsg As String, Optional pRaiseErr As Boolean = True, Optional pFtpIp As String) As Boolean
      
   Dim stDir As String, stFileName As String
   Dim hConnection As Long
   Dim hFind As Long
   Dim pData As WIN32_FIND_DATA
   Dim dwInternetFlags As Integer

   stDir = Left(pFtpPath, InStrRev(pFtpPath, "/") - 1)
   stFileName = Mid(pFtpPath, InStrRev(pFtpPath, "/") + 1)
   
   hConnection = PUB_GetFtpConnect(pErrMsg, , , pFtpIp)
   If hConnection <> 0 Then
      '切換目錄來檢查是否存在
      If PUB_SetFtpDirectory(hConnection, stDir, pErrMsg, pRaiseErr) = False Then GoTo OutPort
       
      '一定要先刪除,否則同檔名時 Server 會自動更名為.1
      'Modified by Morgan 2015/6/4 FtpFindFirstFile 的路徑參數不可含空白字元
      'Modified by Morgan 2015/6/10 檔名有中文可能會找不到,先用模糊找再檢查
      hFind = FtpFindFirstFile(hConnection, pFtpPath & "*", pData, 0, 0)
      If hFind <> 0 Then
         InternetCloseHandle hFind
         hFind = 0
         If InStr(pData.cFileName, stFileName & Chr(0)) = 1 Then
            If FtpDeleteFile(hConnection, pFtpPath) = 0 Then
               pErrMsg = pFtpPath & "檔案已存在且無法刪除！"
               GoTo OutPort
            End If
         End If
      End If
      'end 2015/6/4
      
      'dwInternetFlags = FTP_TRANSFER_TYPE_BINARY
      dwInternetFlags = 2 'INTERNET_FLAG_TRANSFER_BINARY
      ' Upload successfully
      If FtpPutFile(hConnection, pLocalPath, pFtpPath, dwInternetFlags, 0) <> 1 Then
         pErrMsg = pLocalPath & "檔案上傳失敗！"
         GoTo OutPort
         
      'Added by Morgan 2016/11/9 因有發生檔案上傳成功但下載時檔案卻不存在問題,故上傳後再做一次檢查
      'End If
      'PUB_FtpPutFile = True
      Else
         '已取消中文檔名,不必再模糊比對
         hFind = FtpFindFirstFile(hConnection, pFtpPath, pData, 0, 0)
         If hFind = 0 Then
            pErrMsg = pLocalPath & "檔案上傳失敗！"
            GoTo OutPort
         Else
            InternetCloseHandle hFind
            hFind = 0
            'Added by Morgan 2025/7/31
            'Modified by Morgan 2025/8/6 +pLocalPath
            PUB_AddFTPAuditLog AL_上傳, pFtpPath, pLocalPath
            'end 2025/8/6
            'end 2025/7/31
            
            PUB_FtpPutFile = True
         End If
      'end 2016/11/9
      End If
      
   End If
   
OutPort:
   If Err.Number <> 0 Then pErrMsg = Err.Description
   If hConnection <> 0 Then InternetCloseHandle hConnection
   
   If PUB_FtpPutFile = False And pRaiseErr = True Then
      Err.Raise 999, , pErrMsg & IIf(Err.Number <> 0, "(" & Err.Number & ")", "")
   End If
End Function

'Added by Lydia 2016/08/12
'FTP檔案上傳(DHL)
Public Function PUB_FtpPutFileDHL(pFtpSrv As String, pLocalPath As String, pFtpPath As String, Optional pErrMsg As String, Optional pRaiseErr As Boolean = True) As Boolean
      
   Dim stDir As String, stFileName As String
   Dim hConnection As Long
   Dim hFind As Long
   Dim pData As WIN32_FIND_DATA
   Dim dwInternetFlags As Integer
      
   stDir = Left(pFtpPath, InStrRev(pFtpPath, "/") - 1)
   stFileName = Mid(pFtpPath, InStrRev(pFtpPath, "/") + 1)

   hConnection = PUB_GetFtpConnect(pErrMsg, , pFtpSrv)

   If hConnection <> 0 Then
      '切換所在地目錄
      If PUB_SetFtpDirectory(hConnection, stDir, pErrMsg, pRaiseErr) = False Then GoTo OutPort
      
      'dwInternetFlags = FTP_TRANSFER_TYPE_BINARY
      dwInternetFlags = 2 'INTERNET_FLAG_TRANSFER_BINARY
      '上傳目的檔案(只傳檔名)
      'DHL若有同檔名,則會直接覆蓋
      If FtpPutFile(hConnection, pLocalPath, stFileName, dwInternetFlags, 0) <> 1 Then
         pErrMsg = pLocalPath & "檔案上傳失敗！"
         GoTo OutPort
      End If
      PUB_FtpPutFileDHL = True
   End If
   
OutPort:
   If Err.Number <> 0 Then pErrMsg = Err.Description
   If hConnection <> 0 Then InternetCloseHandle (hConnection)
   
   If PUB_FtpPutFileDHL = False And pRaiseErr = True Then
      Err.Raise 999, , pErrMsg & IIf(Err.Number <> 0, "(" & Err.Number & ")", "")
   End If
End Function

'Added by Morgan 2015/3/20
'建立/切換目錄
'Modified by Lydia 2018/02/23 是否建立目錄bolMD
Public Function PUB_SetFtpDirectory(pConnection As Long, pFtpPath As String, Optional pErrMsg As String, Optional pRaiseErr As Boolean = True, Optional bolMD As Boolean = False) As Boolean
   Dim arrDir() As String, ii As Integer
   Dim hDir As Long
   
   arrDir = Split(pFtpPath, "/")
   For ii = LBound(arrDir) To UBound(arrDir)
      If arrDir(ii) <> "" Then
         If FtpSetCurrentDirectory(pConnection, arrDir(ii)) <> 1 Then
            hDir = FtpCreateDirectory(pConnection, arrDir(ii))
            If hDir = 0 Then
               pErrMsg = arrDir(ii) & "目錄建立失敗！"
               GoTo OutPort
            'Modified by Lydia 2018/02/23
            'ElseIf FtpSetCurrentDirectory(pConnection, arrDir(ii)) <> 1 Then
            Else
                 bolMD = True
                 If FtpSetCurrentDirectory(pConnection, arrDir(ii)) <> 1 Then
            'end 2018/02/23
                     pErrMsg = arrDir(ii) & "目錄切換失敗！"
                     GoTo OutPort
                 End If 'end 2018/02/23
            End If
         End If
      End If
   Next
   PUB_SetFtpDirectory = True
   
OutPort:
   If Err.Number <> 0 Then pErrMsg = Err.Description
   
   If PUB_SetFtpDirectory = False And pRaiseErr = True Then
      Err.Raise 999, , pErrMsg
   End If
End Function

'Added by Morgan 2015/3/19
'刪除FTP檔案
Public Function PUB_DelFtpFile2(pKeyNo As String, Optional pAndSQL As String, Optional pTableName As String = "CASEPAPERPDF") As Boolean
Dim stTableDir As String
Dim stSQL As String, intR As Integer
Dim rsQuery As ADODB.Recordset
Dim Str01 As String, Str02 As String, Str03 As String, Str04 As String, Str05 As String 'Add By Sindy 2017/8/10
Dim stFtpIP As String, bolArchive As Boolean 'Added by Morgan 2025/3/27
   
   'stTableDir = PUB_GetFtpTableDir(pTableName) 'Removed by Morgan 2025/3/27
   
   If UCase(pTableName) = "CASEPAPERPDF" Then
      'Modify By Sindy 2020/5/26 多筆文號資料
      If pKeyNo = "" Then
         'Modified by Morgan 2025/3/27 +cpp19
         stSQL = "select cpp14,cpp19 from CASEPAPERPDF where " & pAndSQL
      Else
      '2020/5/26 END
         'Modified by Morgan 2025/3/27 +cpp19
         stSQL = "select cpp14,cpp19 from CASEPAPERPDF where cpp01='" & pKeyNo & "' " & pAndSQL
      End If
      
   'Added by Morgan 2015/4/27
   ElseIf UCase(pTableName) = "CASEPAPERFILE" Then
      'Modify By Sindy 2020/5/26 多筆文號資料
      If pKeyNo = "" Then
         stSQL = "select cpf13 from CASEPAPERFILE where " & pAndSQL
      Else
      '2020/5/26 END
         stSQL = "select cpf13 from CASEPAPERFILE where cpf01='" & pKeyNo & "' " & pAndSQL
      End If
      
   ElseIf UCase(pTableName) = "EMPELECTRONFILE" Then
      stSQL = "select eef12 from EMPELECTRONFILE where eef01='" & pKeyNo & "' " & pAndSQL
   'end 2015/4/27
   'Add By Sindy 2016/1/22
   ElseIf UCase(pTableName) = "IPDEPTINPUT" Then
      stSQL = "select ii14 from IPDEPTINPUT where ii01='" & pKeyNo & "' " & pAndSQL
   '2016/1/22 END
   'Add By Sindy 2016/10/17
   ElseIf UCase(pTableName) = "PATENTINPUT" Then
      stSQL = "select pi14 from PATENTINPUT where pi01='" & pKeyNo & "' " & pAndSQL
   '2016/10/17 END
   'Add By Sindy 2019/4/11
   ElseIf UCase(pTableName) = "TMINPUT" Then
      stSQL = "select ti14 from TMINPUT where ti01='" & pKeyNo & "' " & pAndSQL
   '2019/4/11 END
   'Added by Morgan 2016/4/15
   ElseIf UCase(pTableName) = "ACC152" Then
      stSQL = "select AYF06 from ACC152 where AYF01='" & pKeyNo & "' " & pAndSQL
   'end 2016/4/15
   'Added by Lydia 2016/06/23 查名單
   ElseIf pTableName = "TMQFILE" Then
      stSQL = "select TQF12 from TMQFILE where " & pAndSQL
   'end 2016/06/23
   'Added by Lydia 2024/09/26 查名單-網中
   ElseIf pTableName = "TMQAPPFILE" Then
      stSQL = "select TMF09 from TMQAPPFILE where " & pAndSQL
   'Eend 2024/09/26
   'Add By Sindy 2017/5/23
   ElseIf UCase(pTableName) = "SEMINARATTACHMENT" Then
      stSQL = "select sa07 from SEMINARATTACHMENT where sa01='" & pKeyNo & "' " & pAndSQL
   '2017/5/23 END
   'Add By Sindy 2017/5/25
   ElseIf UCase(pTableName) = "CUSTWEBFILE" Then
      stSQL = "select cf08 from CUSTWEBFILE where cf01='" & pKeyNo & "' " & pAndSQL
   '2017/5/25 END
   'Add By Sindy 2017/5/31
   ElseIf UCase(pTableName) = "PRICELISTFILE" Then
      stSQL = "select PLF11 from PRICELISTFILE where PLF01='" & pKeyNo & "' " & pAndSQL
   ElseIf UCase(pTableName) = "PRICELISTBULLETIN" Then
      stSQL = "select PLB13 from PRICELISTBULLETIN where PLB01='" & pKeyNo & "' " & pAndSQL
   '2017/5/31 END
   'Add By Sindy 2017/7/26
   ElseIf UCase(pTableName) = "MAILSCHEDULETEMPLET" Then
      stSQL = "select MST06 from MAILSCHEDULETEMPLET where MST01='" & pKeyNo & "' " & pAndSQL
   '2017/7/26 END
   'Add By Sindy 2017/8/10 + IMGBYTEFILE : 卷和代表圖檔
   ElseIf UCase(pTableName) = "IMGBYTEFILE" Then
      Str01 = SystemNumber(pKeyNo, 1)
      Str02 = SystemNumber(pKeyNo, 2)
      Str03 = SystemNumber(pKeyNo, 3)
      Str04 = SystemNumber(pKeyNo, 4)
      If InStr(Str04, "-") > 0 Then
         Str04 = Left(Str04, InStr(Str04, "-") - 1)
      End If
      Str05 = Right(pKeyNo, Len(pKeyNo) - InStrRev(pKeyNo, "-"))
      'Modify By Sindy 2018/10/31 TF馬德里商標圖檔-子案的圖同母案
      '固定都以IBF01=tm01 AND IBF02=substr(tm02,1,5)||'0' AND IBF03='0' AND IBF04='00' 去抓代表圖
      If Str01 = "TF" Then
         stSQL = "select IBF15 from IMGBYTEFILE where IBF01='" & Str01 & "' and IBF02='" & Mid(Str02, 1, 5) & "0" & "'" & _
                 " and ibf03='0' And ibf04='00'" & _
                 " and IBF05='" & Str05 & "'" & pAndSQL
      Else
      '2018/10/31 END
         stSQL = "select IBF15 from IMGBYTEFILE where IBF01='" & Str01 & "' and IBF02='" & Str02 & "'" & _
                 " and IBF03='" & Str03 & "' and IBF04='" & Str04 & "'" & _
                 " and IBF05='" & Str05 & "'" & pAndSQL
      End If
   '2017/8/10 END
   'Add By Sindy 2023/10/24
   ElseIf UCase(pTableName) = "STAFF_EVALU_FILE" Then
         Str01 = SystemNumber(pKeyNo, 1)
         Str02 = SystemNumber(pKeyNo, 2)
         Str03 = SystemNumber(pKeyNo, 3)
         stSQL = "select SJF05 from STAFF_EVALU_FILE" & _
                 " where SJF01='" & Str01 & "' AND SJF02='" & Str02 & "' AND SJF03=" & Str03 & pAndSQL
   '2023/10/24 END
   'Added by Lydia 2017/08/09 往來記錄 (注意是一個欄位記錄多筆附件)
   'Modify By Sindy 2019/2/25 "CONTACTRECORD" 改為 "CONTACTFILE"
   ElseIf UCase(pTableName) = "CONTACTFILE" Then
         'Modify By Sindy 2019/2/25
         'stSQL = "select DECODE(CR20,NULL,'','" & pAndSQL & "') from CONTACTRECORD where CR01='" & pKeyNo & "' AND INSTR(CR20,'" & pAndSQL & "') > 0 "
         stSQL = "select DECODE(CF06,NULL,'','" & pAndSQL & "') from CONTACTFILE where CF01='" & pKeyNo & "' AND INSTR(CF06,'" & pAndSQL & "') > 0 "
         '2019/2/25 END
   'Added by Lydia 2017/08/09 不得代理案件 (注意是一個欄位記錄多筆附件)
   ElseIf UCase(pTableName) = "NOTAGENT" Then
         stSQL = "select DECODE(NT31,NULL,'','" & pAndSQL & "') from notagent where NT01='" & pKeyNo & "' AND INSTR(NT31,'" & pAndSQL & "') > 0 "
   'end 2017/08/09
   'Added by Lydia 2017/08/09 CF代理人報價附件記錄
   ElseIf UCase(pTableName) = "CFQUOTATION" Then
         stSQL = "select DECODE(CQ11,NULL,'','" & pAndSQL & "') from CFQUOTATION where CQ01||CQ02='" & pKeyNo & "' AND instr(CQ11,'" & pAndSQL & "') > 0"
   'end 2017/08/09
   'Add by Amy 2018/01/11 合約資料
   ElseIf UCase(pTableName) = "CONTRACT" Then
         stSQL = "select DECODE(CT09,NULL,'','" & pAndSQL & "') from CONTRACT where CT01='" & pKeyNo & "' AND INSTR(CT09,'" & pAndSQL & "') > 0 "
   'Added by Morgan 2019/5/15
   ElseIf UCase(pTableName) = "PATENTSEARCH" Then
      stSQL = "select PS04 from PATENTSEARCH where PS01='" & pKeyNo & "' " & pAndSQL
   ElseIf UCase(pTableName) = "PATENTSEARCHDETAIL" Then
      stSQL = "select PSD08 from PATENTSEARCHDETAIL where PSD01='" & pKeyNo & "' " & pAndSQL
   'end 2019/5/15
   Else
      Exit Function
   End If
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      With rsQuery
      Do While Not .EOF
         If Not IsNull(.Fields(0)) Then
            'Modified by Morgan 2025/3/27
            'PUB_FtpDelFile2 stTableDir & "/" & .Fields(0)
            stFtpIP = ""
            bolArchive = False
            If UCase(pTableName) = "CASEPAPERPDF" Then
               If Not IsNull(.Fields(1)) Then
                  bolArchive = True
               End If
            End If
            stTableDir = PUB_GetFtpTableDir(pTableName, stFtpIP, bolArchive)
            PUB_FtpDelFile2 stTableDir & "/" & .Fields(0), , , stFtpIP
            'end 2025/3/27
         End If
         .MoveNext
      Loop
      End With
      PUB_DelFtpFile2 = True
   End If
   Set rsQuery = Nothing
End Function

'Added by Morgan 2015/3/12
'FTP刪除檔案或目錄
'Modified by Lydia 2018/02/23 +pFtpIP
Public Function PUB_FtpDelFile(pFtpPath As String, Optional pFileName As String, Optional pErrMsg As String, Optional pRaiseErr As Boolean = True, Optional ByVal pFtpIp As String = "") As Boolean
   
   Dim hConnection As Long
   Dim pData As WIN32_FIND_DATA
   Dim hFind As Long, LRet  As Long, stFileName As String
   
   'Modified by Lydia 2018/02/23
   'hConnection = PUB_GetFtpConnect(pErrMsg)
   hConnection = PUB_GetFtpConnect(pErrMsg, , , pFtpIp)
   
   If hConnection <> 0 Then
      'FTP的API回傳值似乎都是數值(不管宣告為何),無法用布林判斷
      If FtpSetCurrentDirectory(hConnection, pFtpPath) = 1 Then
         '刪除目錄內全部檔案
         If pFileName = "" Then
            pData.cFileName = String(MAX_PATH, 0)
            hFind = FtpFindFirstFile(hConnection, "*.*", pData, 0, 0)
            If hFind <> 0 Then
               Do
                  stFileName = Left(pData.cFileName, InStr(1, pData.cFileName, String(1, 0), vbBinaryCompare) - 1)
                  If stFileName <> "." And stFileName <> ".." Then
                     'Modified by Morgan 2015/4/14 改直接刪除
                     'If LCase(Right(stFileName, 4)) = ".del" Then
                        If FtpDeleteFile(hConnection, stFileName) <> 1 Then
                           pErrMsg = pFileName & "檔案刪除失敗！"
                           GoTo OutPort
                        End If
                     'Else
                     '   If FtpRenameFile(hConnection, stFileName, stFileName & ".del") <> 1 Then
                     '      pErrMsg = pFileName & "檔案刪除失敗！"
                     '      GoTo OutPort
                     '   End If
                     'End If
                     'end 2015/4/14
                  End If
                  LRet = InternetFindNextFile(hFind, pData)
               Loop While LRet <> 0
               
               If FtpRemoveDirectory(hConnection, pFtpPath) <> 1 Then
                  pErrMsg = pFileName & "目錄刪除失敗！"
                  GoTo OutPort
               End If
               
               InternetCloseHandle hFind
               hFind = 0
            End If
            
         '刪除單一檔案
         Else
            'Modified by Morgan 2015/6/4 FtpFindFirstFile 的路徑參數不可含空白字元
            If FtpDeleteFile(hConnection, pFileName) <> 1 Then
               If InStr(pFileName, " ") = 0 Then
                  hFind = FtpFindFirstFile(hConnection, pFileName, pData, 0, 0)
                  If hFind <> 0 Then
                     InternetCloseHandle hFind
                     hFind = 0
                     pErrMsg = pFileName & "檔案刪除失敗！"
                     GoTo OutPort
                  End If
               End If
            End If
            'end 2015/6/4
         End If
      End If
      PUB_AddFTPAuditLog AL_刪除, pFtpPath 'Added by Morgan 2025/7/31
      
      PUB_FtpDelFile = True
   End If
   
OutPort:
   If Err.Number <> 0 Then pErrMsg = Err.Description
   If hConnection <> 0 Then InternetCloseHandle (hConnection)
   If hFind <> 0 Then InternetCloseHandle hFind
   
   If PUB_FtpDelFile = False And pRaiseErr = True Then
      Err.Raise 999, , pErrMsg
   End If
End Function

'Added by Morgan 2015/3/12
'Modified by Morgan 2025/3/26+pFtpIp
'FTP刪除檔案
Public Function PUB_FtpDelFile2(pFtpPath As String, Optional pErrMsg As String, Optional pRaiseErr As Boolean = True, Optional pFtpIp As String) As Boolean
      
   Dim hConnection As Long
   Dim pData As WIN32_FIND_DATA
   Dim hFind As Long
   Dim stDelDir As String
   Dim stFileName As String
      
   'Modified by Morgan 2025/3/26+pFtpIp
   hConnection = PUB_GetFtpConnect(pErrMsg, , , pFtpIp)
   If hConnection <> 0 Then
      If FtpDeleteFile(hConnection, pFtpPath) <> 1 Then
         'Modified by Morgan 2015/6/4 FtpFindFirstFile 的路徑參數不可含空白字元
         If InStr(pFtpPath, " ") = 0 Then
            'Modified by Morgan 2015/6/10 檔名有中文可能會找不到,先用模糊找再檢查
            'hFind = FtpFindFirstFile(hConnection, pFtpPath, pData, 0, 0)
            hFind = FtpFindFirstFile(hConnection, pFtpPath & "*", pData, 0, 0)
            If hFind <> 0 Then
               InternetCloseHandle hFind
               hFind = 0
               stFileName = Mid(pFtpPath, InStrRev(pFtpPath, "/") + 1)
               If InStr(pData.cFileName, stFileName & Chr(0)) = 1 Then
                  pErrMsg = pFtpPath & "檔案刪除失敗！"
                  GoTo OutPort
               End If
            End If
         End If
         'end 2015/6/4
      End If
      
      PUB_AddFTPAuditLog AL_刪除, pFtpPath 'Added by Morgan 2025/7/31
      
      PUB_FtpDelFile2 = True
      
      '暫存資料夾無檔案時刪除
      'Modify By Sindy 2016/6/21 + ipdeptinput 檢查信件資料夾是否已無檔案,一併刪除
      'If InStr(pFtpPath, "/TEMP/") > 0 Then
      'Modified by Lydia 2016/06/23 + TMQFILE
      'Modified by Lydia 2017/08/09 + 往來記錄 contactrecord、不得代理案件notagent、CF代理人報價附件記錄cfquotation
      'Modify By Sindy 2019/2/25 + Or InStr(UCase(pFtpPath), UCase("/contactrecord/")) > 0 ==> Or InStr(UCase(pFtpPath), UCase("/contactfile/")) > 0
      'Modified by Lydia 2024/09/26 + 查名單-網中TMQAPPFILE
      If InStr(pFtpPath, "/TEMP/") > 0 Or InStr(UCase(pFtpPath), UCase("/ipdeptinput/")) > 0 _
          Or InStr(UCase(pFtpPath), UCase("/tmqfile/")) > 0 Or InStr(UCase(pFtpPath), UCase("/contactfile/")) > 0 _
          Or InStr(UCase(pFtpPath), UCase("/notagent/")) > 0 Or InStr(UCase(pFtpPath), UCase("/cfquotation/")) > 0 _
          Or InStr(UCase(pFtpPath), UCase("/tmqappfile/")) > 0 Then
      '2016/6/21 END
         stDelDir = Left(pFtpPath, InStrRev(pFtpPath, "/") - 1)
         PUB_FtpDelEmptyFolder stDelDir, hConnection, , False
         
         'Modify By Sindy 2016/6/21 檢查信件資料夾後,一併檢查年度資料夾
         If InStr(UCase(pFtpPath), UCase("/ipdeptinput/")) > 0 Then
            stDelDir = Left(stDelDir, InStrRev(stDelDir, "/") - 1)
            PUB_FtpDelEmptyFolder stDelDir, hConnection, , False
         End If
         '2016/6/21 END
      End If
   End If
   
OutPort:
   If Err.Number <> 0 Then pErrMsg = Err.Number & vbCrLf & Err.Description
   If hConnection <> 0 Then InternetCloseHandle (hConnection)
   
   If PUB_FtpDelFile2 = False And pRaiseErr = True Then
      Err.Raise 999, , pErrMsg
   End If
End Function

'Added by Morgan 2015/4/24
'FTP刪除空目錄
Public Function PUB_FtpDelEmptyFolder(pFtpFolder As String, Optional pConnection As Long, Optional pErrMsg As String, Optional pRaiseErr As Boolean = True) As Boolean
   
   Dim hConnection As Long
   Dim pData As WIN32_FIND_DATA
   Dim hFind As Long, LRet  As Long, stFileName As String
   Dim bolIsEmpty As Boolean
   
   If pConnection <> 0 Then
      hConnection = pConnection
   Else
      hConnection = PUB_GetFtpConnect(pErrMsg)
   End If
   
   If hConnection <> 0 Then
      bolIsEmpty = True
      
      'FTP的API回傳值似乎都是數值(不管宣告為何),無法用布林判斷
      If FtpSetCurrentDirectory(hConnection, pFtpFolder) = 1 Then
         pData.cFileName = String(MAX_PATH, 0)
         hFind = FtpFindFirstFile(hConnection, "*.*", pData, 0, 0)
         If hFind <> 0 Then
            Do
               stFileName = Left(pData.cFileName, InStr(1, pData.cFileName, String(1, 0), vbBinaryCompare) - 1)
               If stFileName <> "." And stFileName <> ".." Then
                  bolIsEmpty = False
                  Exit Do
               End If
               LRet = InternetFindNextFile(hFind, pData)
            Loop While LRet <> 0
            InternetCloseHandle hFind
            hFind = 0
         End If
      End If
      
      If bolIsEmpty = True Then
         If FtpRemoveDirectory(hConnection, pFtpFolder) <> 1 Then
            pErrMsg = pFtpFolder & "目錄刪除失敗！"
            GoTo OutPort
         End If
         PUB_FtpDelEmptyFolder = True
      End If
   End If
   
OutPort:
   If Err.Number <> 0 Then pErrMsg = Err.Number & vbCrLf & Err.Description
   If pConnection = 0 And hConnection <> 0 Then InternetCloseHandle (hConnection)
   If hFind <> 0 Then InternetCloseHandle hFind
   
   If PUB_FtpDelEmptyFolder = False And pRaiseErr = True Then
      Err.Raise 999, , pErrMsg
   End If
End Function
'Added by Lydia 2016/06/23 從db下載檔案,搬移到FTP
Public Function PUB_TMQfile2FTP(ByVal PF01 As String, ByVal PF02 As String, ByVal pF03 As String, ByVal PF04 As String, ByVal PF05 As String) As Boolean
Dim dfs As New FileSystemObject
Dim strPath As String
Dim strFuPath As String
Dim strReName As String


On Error GoTo ErrHand01
    
    strPath = App.path & "\TMQFILE"
    If Dir(strPath, vbDirectory) = "" Then
       MkDir strPath
    End If

    strFuPath = strPath & "\" & IIf(PF02 = "0", PF01, "") & PF02 & pF03 & PF04 & "." & PF05

    If Dir(strFuPath) <> "" Then
         SetAttr strFuPath, vbNormal 'Added by Lydia 2020/03/19 預設檔案為正常
         Kill strFuPath
    End If
    
    '從DB下載附件
    If PUB_TMQGetAFile("", strFuPath, PF01, PF02, pF03, PF04, PF05) Then
       '複製到目的資料夾
        If PF02 = "0" Then '查名內容附件
           PUB_PutFtpFile strFuPath, PF01, PF01 & PF02 & pF03 & PF04 & "." & PF05, strReName, "TMQFILE"
        Else
           PUB_PutFtpFile strFuPath, PF02, PF02 & pF03 & PF04 & "." & PF05, strReName, "TMQFILE"
        End If
       '刪除來源檔案
        SetAttr strFuPath, vbNormal 'Added by Lydia 2020/03/19 預設檔案為正常
        Kill strFuPath
    Else
       Exit Function
    End If
    
    PUB_TMQfile2FTP = True
    Exit Function
    
ErrHand01:
    If Err.Number <> 0 Then
       PUB_TMQfile2FTP = False
    End If
End Function
'Added by Morgan 2015/3/16
'更正FTP檔案位置
'Modified by Lydia 2016/06/23 +卷宗區位置pCPP14
'Modified by Morgan 2025/3/27 -pCPP14,沒有再使用了
Public Function PUB_UpdateFtpPath(pKeyNo As String, Optional pAndSQL As String, Optional ByRef pTableName As String = "CASEPAPERPDF", Optional pReNameWhenDup As Boolean = False) As Boolean
   
   Dim stFtpPath As String, stTableDir As String, stFtpDir As String, stFileName As String, stFilePath As String, stGoodPath As String, bolReName As Boolean
   Dim stSQL As String, intR As Integer
   Dim rsQuery As ADODB.Recordset
   'Added by Lydia 2016/06/23
   Dim mTQF02 As String
   Dim strDirCPP As String '卷宗區資料夾
   Dim bolInTrans As Boolean 'Added by Morgan 2016/8/31
   
   
On Error GoTo ErrHnd

   'Modified by Lydia 2016/06/23
   'stTableDir = PUB_GetFtpTableDir(pTableName)
   'stFtpPath = PUB_GetFtpDir(pKeyNo)
   If InStr(pTableName, "TMQFILE") = 0 Then
      stTableDir = PUB_GetFtpTableDir(pTableName)
      'Add By Sindy 2019/11/25
      If pTableName = "CONTACTFILE" Then
         stFtpPath = Left(pKeyNo, 4) & "/" & pKeyNo
      Else
      '2019/11/25 END
         stFtpPath = PUB_GetFtpDir(pKeyNo)
      End If
   Else
      stTableDir = PUB_GetFtpTableDir(Replace(pTableName, "00", ""))
      If Left(pKeyNo, 2) <> "HM" Then
         mTQF02 = Mid(pAndSQL, InStr(pAndSQL, TMQ_查名作業 & ".PDF") - 13, 9)
      Else
         If Mid(pKeyNo, 11, 1) = "0" Then '查名內容附件,以申請編號來放資料夾
            mTQF02 = Mid(pKeyNo, 1, 10)
         Else
            mTQF02 = Mid(pKeyNo, 11, 9)
         End If
         strExc(1) = Mid(pKeyNo, 1, 10)
         strExc(2) = Mid(pKeyNo, 11, Len(pKeyNo) - 13)
         strExc(3) = Left(Right(pKeyNo, 3), 1)
         strExc(4) = Right(pKeyNo, 2)
      End If
      stFtpPath = PUB_GetFtpDir(mTQF02)
      strDirCPP = PUB_GetFtpTableDir("CASEPAPERPDF")
   End If
   'end 2016/06/23
   
   pTableName = UCase(pTableName)
   If pTableName = "CASEPAPERPDF" Then
      'Modified by Morgan 2025/3/27 + and cpp19 is null (排除封存區的檔案)
      stSQL = "select cpp14,cpp02 from casepaperpdf where cpp01='" & pKeyNo & "' and cpp14 is not null and cpp19 is null " & pAndSQL
   'Added by Morgan 2015/4/27
   ElseIf pTableName = "CASEPAPERFILE" Then
      stSQL = "select cpf13,cpf02 from CASEPAPERFILE where cpf01='" & pKeyNo & "' " & pAndSQL
   'end 2015/4/27
   
   ElseIf pTableName = "EMPELECTRONFILE" Then
      stSQL = "select eef12,eef03,eef02 from EMPELECTRONFILE where eef01='" & pKeyNo & "' " & pAndSQL
   
   'Add By Sindy 2019/11/25
   ElseIf pTableName = "CONTACTFILE" Then
      stSQL = "select CF06,CF02 from CONTACTFILE where CF01='" & pKeyNo & "' and CF06 is not null " & pAndSQL
   '2019/11/25 END
   
   'Added by Lydia 2016/06/23 已收文的查名單從卷宗區搬到查名單區
   ElseIf pTableName = "TMQFILE" Then
      stSQL = "select TQF02 PK00,TQF02||TQF03||TQF04||'.'||TQF05 PK01,TQF01,TQF02,TQF03,TQF04,TQF05,TQF12 CPP02 from TMQFILE where tqf02='" & mTQF02 & "' and tqf05='" & TMQ_查名作業 & ".PDF" & "' and tqf12='" & pAndSQL & "' "
   ElseIf pTableName = "TMQFILE00" Then '查名內容附件和未收文查名單從DB搬到查名單區
      stSQL = "select TQF02 PK00,TQF02||TQF03||TQF04||'.'||TQF05 PK01,TQF01,TQF02,TQF03,TQF04,TQF05 from TMQFILE where TQF01='" & strExc(1) & "' AND TQF02='" & strExc(2) & "' AND TQF03='" & strExc(3) & "' AND TQF04='" & strExc(4) & "' "
   'end 2016/06/23
   Else
      Exit Function
   End If
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      With rsQuery
      Do While Not .EOF
         stFileName = .Fields(1)

         'Modified by Morgan 2015/5/6 取消收文號目錄改檔名前加收文號
         'If pTableName = "EMPELECTRONFILE" Then
         '   stFtpDir = stFtpPath & "/" & .Fields(2)
         'Else
         '   stFtpDir = stFtpPath
         'End If
         stFtpDir = stFtpPath
         'Modified by Lydia 2016/06/23
         'If InStr(stFtpPath, pKeyNo) = 0 Then
         If InStr(stFtpPath, pKeyNo) = 0 And InStr(pTableName, "TMQFILE") = 0 Then
            If pTableName = "EMPELECTRONFILE" Then
               stFileName = .Fields(2) & "." & stFileName
            End If
            stFileName = pKeyNo & "." & stFileName
         ElseIf InStr(pTableName, "TMQFILE") > 0 And Left(stFileName, 1) <> "H" Then
            stFileName = .Fields("TQF01") & .Fields("TQF02") & .Fields("TQF03") & .Fields("TQF04") & "." & .Fields("TQF05")
         End If
         'end 2015/5/6
         'END 2016/06/23
         
         stFilePath = stFtpDir & "/" & stFileName
         
         'Modified by Morgan 2016/6/29 實體路徑含空白有些API無法正常執行，程式更名時會去除
         'If .Fields(0) <> stFilePath Then
         'Modified by Morgan 2016/9/5
         'If .Fields(0) <> Replace(stFilePath, " ", "") Then
         If .Fields(0) <> PUB_GetSimpleName(stFilePath) Then
         'end 2016/9/5
         'end 2016/6/29
            'Added by Morgan 2015/8/25
            '檔名重複時自動更名
            bolReName = False
            If pReNameWhenDup Then
               If PUB_GetGoodName(stFilePath, stGoodPath, pTableName, pKeyNo) = True Then
                  If stFilePath <> stGoodPath Then
                     bolReName = True
                     stFileName = Mid(stGoodPath, InStrRev(stGoodPath, "/") + 1)
                     stFilePath = stGoodPath
                  End If
               Else
                  Err.Raise 999, , stFilePath & "檢查檔名失敗!!"
               End If
            End If
            'end 2015/8/25
               
            '檢查FTP檔案是否已存在
            If pTableName = "CASEPAPERPDF" Then
               stSQL = "update casepaperpdf set cpp13=cpp13 where cpp14='" & ChgSQL(stFilePath) & "'"
               
            ElseIf pTableName = "CASEPAPERFILE" Then
               stSQL = "update CASEPAPERFILE set cpf12=cpf12 where cpf13='" & ChgSQL(stFilePath) & "'"
               
            ElseIf pTableName = "EMPELECTRONFILE" Then
               stSQL = "update EMPELECTRONFILE set eef11=eef11 where eef12='" & ChgSQL(stFilePath) & "'"
            
            'Add By Sindy 2019/11/25
            ElseIf pTableName = "CONTACTFILE" Then
               stSQL = "update CONTACTFILE set CF08=CF08 where CF06='" & ChgSQL(stFilePath) & "'"
            '2019/11/25 END
            End If
            cnnConnection.Execute stSQL, intR
            If intR > 0 Then
               Err.Raise 999, , stFilePath & "檔案已存在!!"
            End If
            
            'Remove by Lydia 2016/06/23 移到下方
            'PUB_FtpRenFile stTableDir & "/" & .Fields(0), stTableDir & "/" & stFtpPath, stFileName
            
            cnnConnection.BeginTrans 'Added by Lydia 2016/06/28
            bolInTrans = True 'Added by Morgan 2016/8/31
            bolReName = False 'Added by Morgan 2022/9/6 實體檔名不同也上FTP更新日期(資料夾及收文號正確就好)
                If pTableName = "CASEPAPERPDF" Then
                   If bolReName Then
                      stSQL = "update casepaperpdf set cpp14='" & ChgSQL(stFilePath) & "' where cpp01='" & pKeyNo & "' and cpp02='" & ChgSQL(.Fields("cpp02")) & "'"
                   Else
                      stSQL = "update casepaperpdf set cpp13=to_char(sysdate,'yyyymmdd'), cpp14='" & ChgSQL(stFilePath) & "' where cpp01='" & pKeyNo & "' and cpp02='" & ChgSQL(.Fields("cpp02")) & "'"
                   End If
                ElseIf pTableName = "CASEPAPERFILE" Then
                   If bolReName Then
                      stSQL = "update CASEPAPERFILE set cpf13='" & ChgSQL(stFilePath) & "' where cpf01='" & pKeyNo & "' and cpf02='" & ChgSQL(.Fields("cpf02")) & "'"
                   Else
                      stSQL = "update CASEPAPERFILE set cpf12=to_char(sysdate,'yyyymmdd'), cpf13='" & ChgSQL(stFilePath) & "' where cpf01='" & pKeyNo & "' and cpf02='" & ChgSQL(.Fields("cpf02")) & "'"
                   End If
                ElseIf pTableName = "EMPELECTRONFILE" Then
                   If bolReName Then
                      stSQL = "update EMPELECTRONFILE set eef12='" & ChgSQL(stFilePath) & "' where eef01='" & pKeyNo & "' and eef02=" & .Fields("eef02") & " and eef03='" & ChgSQL(.Fields("eef03")) & "'"
                   Else
                      stSQL = "update EMPELECTRONFILE set eef11=to_char(sysdate,'yyyymmdd'), eef12='" & ChgSQL(stFilePath) & "' where eef01='" & pKeyNo & "' and eef02=" & .Fields("eef02") & " and eef03='" & ChgSQL(.Fields("eef03")) & "'"
                   End If
                'Add By Sindy 2019/11/25
                ElseIf pTableName = "CONTACTFILE" Then
'                   If bolReName Then
'                      stSQL = "update CONTACTFILE set CF06='" & ChgSQL(stFilePath) & "' where CF01='" & pKeyNo & "' and CF02='" & ChgSQL(.Fields("CF02")) & "'"
'                   Else
                      stSQL = "update CONTACTFILE set CF08=to_char(sysdate,'yyyymmdd'), CF06='" & ChgSQL(stFilePath) & "' where CF01='" & pKeyNo & "' and CF02='" & ChgSQL(.Fields("CF02")) & "'"
'                   End If
                '2019/11/25 END
                
                'Added by Lydia 2016/06/23 已收文的查名單從卷宗區搬到查名單區
                'Removed by Morgan 2025/3/27 已完成過渡不會再觸發
                'ElseIf pTableName = "TMQFILE" Then
                '       stSQL = "delete from casepaperpdf where cpp01='" & pKeyNo & "' and cpp02='" & ChgSQL(.Fields("cpp02")) & "'"
                '       cnnConnection.Execute stSQL, intR
                '       stSQL = "update TMQFILE set tqf07=null,tqf12='" & ChgSQL(stFilePath) & "' where tqf01='" & .Fields("TQF01") & "' AND tqf02='" & .Fields("TQF02") & "' AND tqf03='" & .Fields("TQF03") & "' AND tqf04='" & .Fields("TQF04") & "' "
                'end 2025/3/27
                
               '查名內容附件和未收文查名單
                ElseIf pTableName = "TMQFILE00" Then
                   If PUB_TMQfile2FTP(.Fields("TQF01"), .Fields("TQF02"), .Fields("TQF03"), .Fields("TQF04"), .Fields("TQF05")) Then
                       stSQL = "update TMQFILE set tqf07=null,tqf12='" & ChgSQL(stFilePath) & "' where tqf01='" & .Fields("TQF01") & "' AND tqf02='" & .Fields("TQF02") & "' AND tqf03='" & .Fields("TQF03") & "' AND tqf04='" & .Fields("TQF04") & "' "
                   Else
                       stSQL = ""
                   End If
                'end 2016/06/23
                End If
                'Modified by Lydia 2016/06/23
                'cnnConnection.Execute stSQL, intR
                If stSQL <> "" Then cnnConnection.Execute stSQL, intR
                
                'Added by Lydia 2016/06/28
                If InStr(pTableName, "TMQFILE") = 0 Then
                   PUB_FtpRenFile stTableDir & "/" & .Fields(0), stTableDir & "/" & stFtpPath, stFileName
                
                'Removed by Moran 2025/3/27 已完成過渡不會再觸發
                'Else '只搬卷宗區到查名單區(FTP更名)
                '   If pTableName = "TMQFILE" Then
                '      PUB_FtpRenFile strDirCPP & "/" & pCPP14, stTableDir & "/" & stFtpPath, stFileName
                '   End If
                'end 2025/3/27
                End If
                'END 2016/06/28
            cnnConnection.CommitTrans
            bolInTrans = False 'Added by Morgan 2016/8/31
         Else
            cnnConnection.BeginTrans 'Added by Lydia 2016/06/28
            bolInTrans = True 'Added by Morgan 2016/8/31
                If pTableName = "CASEPAPERPDF" Then
                   stSQL = "update casepaperpdf set cpp13=to_char(sysdate,'yyyymmdd') where cpp01='" & pKeyNo & "' and cpp02='" & ChgSQL(.Fields("cpp02")) & "'"
                   
                ElseIf pTableName = "CASEPAPERFILE" Then
                   stSQL = "update CASEPAPERFILE set cpf12=to_char(sysdate,'yyyymmdd') where cpf01='" & pKeyNo & "' and cpf02='" & ChgSQL(.Fields("cpf02")) & "'"
                   
                ElseIf pTableName = "EMPELECTRONFILE" Then
                   stSQL = "update EMPELECTRONFILE set eef11=to_char(sysdate,'yyyymmdd') where eef01='" & pKeyNo & "' and eef02=" & .Fields("eef02") & " and eef03='" & ChgSQL(.Fields("eef03")) & "'"
                
                'Added by Morgan 2022/9/20
                ElseIf pTableName = "CONTACTFILE" Then
                  stSQL = "update CONTACTFILE set CF08=to_char(sysdate,'yyyymmdd') where CF01='" & pKeyNo & "' and CF02='" & ChgSQL(.Fields("CF02")) & "'"
                'end 2022/9/20
                End If
                cnnConnection.Execute stSQL, intR
                
            cnnConnection.CommitTrans 'Added by Lydia 2016/06/28
            bolInTrans = False 'Added by Morgan 2016/8/31
         End If
         
         .MoveNext
      Loop
      End With
      PUB_UpdateFtpPath = True
   End If
   
'Added by Morgan 2016/8/31
ErrHnd:
   If bolInTrans Then cnnConnection.RollbackTrans
   If Err.Number <> 0 Then
      If Err.Number = 999 Then
         Err.Raise Err.Number, , Err.Description
      Else
         Err.Raise Err.Number
      End If
   End If
'end 2016/8/31

   Set rsQuery = Nothing
End Function

'Added by Morgan 2015/3/16
'FTP更改檔名
Public Function PUB_FtpRenFile(pFromPath As String, pToDir As String, pToName As String, Optional pErrMsg As String, Optional pRaiseErr As Boolean = True) As Boolean
      
   Dim hConnection As Long
   Dim hReturn As Long
   Dim stFromDir As String
   
   hConnection = PUB_GetFtpConnect(pErrMsg)
   If hConnection <> 0 Then
      If PUB_SetFtpDirectory(hConnection, pToDir, pErrMsg, pRaiseErr) = False Then GoTo OutPort
      hReturn = FtpRenameFile(hConnection, pFromPath, pToDir & "/" & pToName)
      If hReturn = 1 Then
         PUB_FtpRenFile = True
         '暫存資料夾無檔案時刪除
         'Modified by Lydia 2016/06/28 從卷宗區搬到查名單區,才刪除卷宗區的空資料夾
         'If InStr(pFromPath, "/TEMP/") > 0 And InStr(pFromPath, pToDir) = 0 Then
         'Modify By Sindy 2019/11/26 + Or InStr(pFromPath, "/CONTACTFILE/") > 0)
         'Modified by Lydia 2024/09/26 比照PUB_FtpDelFile2
         'If ((InStr(pFromPath, "/TEMP/") > 0 Or InStr(pFromPath, "/CONTACTFILE/") > 0) And _
             InStr(pFromPath, pToDir) = 0) Or _
            (InStr(pFromPath, "/CASEPAPERPDF/") > 0 And InStr(pToDir, "/TMQFILE/") > 0) Then
         If InStr(pFromPath, "/TEMP/") > 0 Or InStr(UCase(pFromPath), UCase("/ipdeptinput/")) > 0 _
            Or InStr(UCase(pFromPath), UCase("/tmqfile/")) > 0 Or InStr(UCase(pFromPath), UCase("/contactfile/")) > 0 _
            Or InStr(UCase(pFromPath), UCase("/notagent/")) > 0 Or InStr(UCase(pFromPath), UCase("/cfquotation/")) > 0 _
            Or InStr(UCase(pFromPath), UCase("/casepaperpdf/")) > 0 Or InStr(UCase(pFromPath), UCase("/tmqappfile/")) > 0 Then
            stFromDir = Left(pFromPath, InStrRev(pFromPath, "/") - 1)
            PUB_FtpDelEmptyFolder stFromDir, hConnection, , False
         End If
         
      Else
         pErrMsg = pFromPath & vbCrLf & vbTab & "=>" & pToDir & "/" & pToName & vbCrLf & "檔案更名/移動失敗！"
      End If
   End If
   
   
OutPort:
   If Err.Number <> 0 Then pErrMsg = Err.Number & vbCrLf & Err.Description
   If hConnection <> 0 Then InternetCloseHandle (hConnection)
   
   If PUB_FtpRenFile = False And pRaiseErr = True Then
      Err.Raise 999, , pErrMsg
   End If
End Function

'Added by Morgan 2015/3/26
'Ftp資料夾更名
Public Function PUB_FtpRenDir(pOldDir As String, pNewDir As String, Optional pErrMsg As String, Optional pRaiseErr As Boolean = True) As Boolean
      
   Dim hConnection As Long
   Dim pData As WIN32_FIND_DATA
   Dim hReturn As Long, hFind As Long, LRet  As Long, stFileName As String
   
   hConnection = PUB_GetFtpConnect(pErrMsg)
   If PUB_SetFtpDirectory(hConnection, pNewDir, pErrMsg, pRaiseErr) = False Then GoTo OutPort
   
   If FtpSetCurrentDirectory(hConnection, pOldDir) = 1 Then
      pData.cFileName = String(MAX_PATH, 0)
      hFind = FtpFindFirstFile(hConnection, "*.*", pData, 0, 0)
      If hFind <> 0 Then
         Do
            stFileName = Left(pData.cFileName, InStr(1, pData.cFileName, String(1, 0), vbBinaryCompare) - 1)
            If stFileName <> "." And stFileName <> ".." Then
               If FtpRenameFile(hConnection, stFileName, pNewDir & "/" & stFileName) <> 1 Then
                  pErrMsg = "檔案 " & stFileName & " 移動失敗！"
                  GoTo OutPort
               End If
            End If
            LRet = InternetFindNextFile(hFind, pData)
         Loop While LRet <> 0
         InternetCloseHandle hFind
         hFind = 0
         
         If FtpRemoveDirectory(hConnection, pOldDir) <> 1 Then
            pErrMsg = pOldDir & "舊目錄刪除失敗！"
            GoTo OutPort
         End If
      End If
   Else
      pErrMsg = "FTP目錄 " & pOldDir & " 切換失敗！"
      GoTo OutPort
   End If
   PUB_FtpRenDir = True
      
OutPort:
   If Err.Number <> 0 Then pErrMsg = Err.Number & vbCrLf & Err.Description
   If hConnection <> 0 Then InternetCloseHandle hConnection
   If hFind <> 0 Then InternetCloseHandle hFind
   
   If PUB_FtpRenDir = False And pRaiseErr = True Then
      Err.Raise 999, , pErrMsg
   End If
   
End Function

'Added by Morgan 2021/3/26
'以本所案號取得FTP目錄名稱
Public Function PUB_GetFtpDir2(pCP01 As String, pCP02 As String, pCP03 As String, pCP04 As String) As String
   Dim stFtpDir As String
   stFtpDir = pCP01 & Left(pCP02, 3)
   stFtpDir = stFtpDir & "/" & pCP01 & pCP02 & IIf(pCP04 <> "00", "-" & pCP03 & "-" & pCP04, IIf(pCP03 <> "0", "-" & pCP03, ""))
   PUB_GetFtpDir2 = stFtpDir
End Function

'Added by Morgan 2015/3/17
'取得FTP目錄名稱
Public Function PUB_GetFtpDir(pCP09 As String, Optional pRaiseErr As Boolean = True) As String
   Dim stSQL As String, intR As Integer
   Dim rsQuery As ADODB.Recordset
   Dim stFtpDir As String
   
   'Added by Lydia 2016/06/23 查名單區(前6碼)
   If Left(pCP09, 1) = "H" Then
       pCP09 = Replace(pCP09, "M", "") '申請編號去掉M
       stFtpDir = Mid(pCP09, 1, 6) & "/" & pCP09
   '非收文號
   ElseIf Len(pCP09) <> 9 Then
      stFtpDir = "TEMP/" & pCP09
      
   Else
      stSQL = "select cp01,cp02,cp03,cp04 from caseprogress where cp09='" & pCP09 & "'"
      'Added by Morgan 2024/10/14
      '客戶提供文件發文若沒有內部收文會沒有進度檔
      If Left(pCP09, 1) = "D" Then
         stSQL = stSQL & " union select csd01,csd02,csd03,csd04 from CustSupportDoc where csd05='" & pCP09 & "'"
      End If
      'end 2024/10/14
      intR = 1
      Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         With rsQuery
         'Modified by Morgan 2021/3/26 改寫函數以方便共用
         'stFtpDir = .Fields("cp01") & Left(.Fields("cp02"), 3)
         ''Modified by Lydia 2020/02/17 配合卷宗區檔名格式統一
         ''stFtpDir = stFtpDir & "/" & .Fields("cp01") & .Fields("cp02") & IIf(.Fields("cp03") & .Fields("cp04") <> "000", .Fields("cp03") & .Fields("cp04"), "")
         'stFtpDir = stFtpDir & "/" & .Fields("cp01") & .Fields("cp02") & IIf(.Fields("cp04") <> "00", "-" & .Fields("cp03") & "-" & .Fields("cp04"), IIf(.Fields("cp03") <> "0", "-" & .Fields("cp03"), ""))
         stFtpDir = PUB_GetFtpDir2(.Fields("cp01"), .Fields("cp02"), .Fields("cp03"), .Fields("cp04"))
         'end 2021/3/26
         End With
         'Removed by Morgan 2015/5/6 取消收文號目錄改檔名前加收文號
         'stFtpDir = stFtpDir & "/" & pCP09
      '9碼非收文號
      ElseIf intR = 0 Then
         stFtpDir = stFtpDir & "/TEMP/" & pCP09
      Else
         Err.Raise 999, , "無法取得 " & pCP09 & " 的FTP目錄名稱！"
      End If
   End If
   
   PUB_GetFtpDir = stFtpDir
   Set rsQuery = Nothing
   
End Function

'Memo by Morgan 2025/3/27 edm.bas 要同步修改
'Modified by Morgan 2016/6/16 以 IP 判斷起始目錄
'Modified by Morgan 2022/7/13 FTP前置路徑改抓特殊設定(備份主機的層數可能與正式的不同)
'Modified by Morgan 2025/3/27 +pFtpIp,pArchive:是否存於封存區
Public Function PUB_GetFtpTableDir(Optional pTableName As String = "CASEPAPERPDF", Optional ByRef pFtpIp As String, Optional ByVal pArchive As Boolean = False) As String
   Dim stPreDir As String
   
   If 正式資料庫電腦名稱 = "" Then
      正式資料庫電腦名稱 = Pub_GetSpecMan("正式資料庫電腦名稱")
   End If
   
   'Modified by Morgan 2018/6/21 取消舊 FTP Server 檢查
   'Modified by Morgan 2022/8/10 前置路徑改每次都抓
   If UCase(pub_DbTerminalName) = 正式資料庫電腦名稱 Then
      'Added by Morgan 2025/3/27
      If pArchive Then
         stPreDir = Pub_GetSpecMan("FTP_VOL_DIR_ARC")
         pFtpIp = Pub_GetSpecMan("FTP_VOL_IP_ARC")
      Else
         pFtpIp = Pub_GetSpecMan("FTP_VOL_IP")
      'end 2025/3/27
      
         'PUB_GetFtpTableDir = "//TAIENT2/VOLUME/" & UCase(pTableName)
         stPreDir = Pub_GetSpecMan("FTP_VOL_DIR")
      End If
   Else
      'Added by Morgan 2025/3/27
      If pArchive Then
         pFtpIp = Pub_GetSpecMan("FTP_VOL_IP_2_ARC")
         stPreDir = Pub_GetSpecMan("FTP_VOL_DIR_2_ARC")
      Else
         pFtpIp = Pub_GetSpecMan("FTP_VOL_IP_2")
      'end 2025/3/27
      
         'PUB_GetFtpTableDir = "//M51-1/VOLUME/" & UCase(pTableName)
         stPreDir = Pub_GetSpecMan("FTP_VOL_DIR_2")
      End If
   End If
   
   PUB_GetFtpTableDir = "//" & stPreDir & "/" & UCase(pTableName)
End Function

'Added by Morgan 2015/3/16
'建立FTP連線
'Modified by Lydia 2016/08/12 + pOutFtp
Public Function PUB_GetFtpConnect(Optional pErrMsg As String, Optional pRaiseErr As Boolean = True, Optional pOutFtp As String, Optional pFtpIp As String) As Long
   
   Dim stFtpIP As String, stID As String, stPwd As String
   Dim hOpen As Long
   Dim IsTimeOut As Boolean
'   Dim oWinSock As Winsock
   Dim SeekTimer
   Dim hConnection As Long
   Dim stAccount As String
   Dim ii As Integer
   
   'Added by Morgan 2016/9/1
   If pFtpIp <> "" Then
      stFtpIP = pFtpIp
   Else
      'Modified by Morgan 2016/6/16
      'stFtpIP = "192.168.1.253"
      'Modified by Lydia 2016/08/12 +判斷
      If pOutFtp = "" Then
         'Modified by Morgan 2022/6/7 備份將改放另一台電腦
         'stFtpIP = Pub_GetSpecMan("FTP_VOL_IP")
         If UCase(pub_DbTerminalName) <> 正式資料庫電腦名稱 Then
            stFtpIP = Pub_GetSpecMan("FTP_VOL_IP_2")
         Else
            stFtpIP = Pub_GetSpecMan("FTP_VOL_IP")
         End If
         'end 2022/6/7
      Else
          stFtpIP = Pub_GetSpecMan(pOutFtp)
      End If
      'end 2016/08/12
   End If
   
   If stFtpIP = "" Then
      pErrMsg = "無法取得FTP Sever IP！"
      GoTo OutPort
   End If
   'End 2016/6/16
   'Modified by Lydia 2016/08/12 +判斷
   If pOutFtp = "FTP_DHL_IP" Then
      hOpen = InternetOpen("ftptaie", INTERNET_OPEN_TYPE_DIRECT, vbNullString, vbNullString, 0)
   Else
      hOpen = InternetOpen("Taie FTP", INTERNET_OPEN_TYPE_DIRECT, vbNullString, vbNullString, 0)
   End If
   'end 2016/08/12
   
   If hOpen = 0 Then
      pErrMsg = "網路錯誤！"
      GoTo OutPort
   Else

'      If Forms.Count > 0 Then
'         IsTimeOut = True
'         Set oWinSock = Forms(0).Winsock1
'         If oWinSock.State Then oWinSock.Close
'         oWinSock.Connect stFtpIP, 21
'         IsTimeOut = False
'         SeekTimer = Timer
'         Do While oWinSock.State = 6 And IsTimeOut = False
'            DoEvents
'            If Timer - SeekTimer > 1 Then
'               IsTimeOut = True
'            End If
'         Loop
'         If oWinSock.State Then oWinSock.Close
'         If IsTimeOut = True Then
'            pErrMsg = "WinSock無法與FTP Server建立連線！"
'            GoTo OutPort
'         End If
'      End If

      'Modified by Lydia 2016/08/12 +判斷
      If pOutFtp = "" Then
         stAccount = Pub_GetSpecMan("FTP_Account")
      ElseIf pOutFtp = "FTP_DHL_IP" Then
         stAccount = Pub_GetSpecMan("FTP_DHL_Account")
      'Added by Morgan 2019/5/20
      ElseIf pOutFtp = "FTP_WWW_IP" Then
         stAccount = Pub_GetSpecMan("FTP_WWW_Account")
      End If
      'end 2016/08/12
      
      If InStr(stAccount, ":") > 0 Then
         stID = Left(stAccount, InStr(stAccount, ":") - 1)
         stPwd = Mid(stAccount, InStr(stAccount, ":") + 1)
   
         'Modified by Morgan 2018/2/6 FTP有時會連不上(如經理更新AD資料時),加重試3次功能
         For ii = 1 To 3
            hConnection = InternetConnect(hOpen, stFtpIP, FTP_Port, _
               stID, stPwd, INTERNET_SERVICE_FTP, INTERNET_FLAG_PASSIVE, 0)
            If hConnection = 0 Then
               Sleep 1000
            Else
               Exit For
            End If
         Next
         'end 2018/2/6
         
         If hConnection = 0 Then
            If UCase(App.EXEName) = UCase("teAutoPdf") Then
               PUB_SendMail "QPGMR", "92012", "", "定稿轉PDF >> 無法與FTP Server建立連線！", "請至" & pub_HostName & "電腦關閉錯誤訊息並確認定稿內容是否正確。" & vbCrLf & vbCrLf & "如:定稿轉至卷宗後確認是否有信頭..."
            End If
            'Modify By Sindy 2023/3/29 + (PUB_GetFtpConnect: hConnection = 0)
            pErrMsg = "無法與FTP Server建立連線！(PUB_GetFtpConnect: hConnection = 0)"
            GoTo OutPort
          End If
      Else
         pErrMsg = "無法取得FTP帳號！"
         GoTo OutPort
      End If
   End If
   PUB_GetFtpConnect = hConnection
   Exit Function
   
OutPort:
   If Err.Number <> 0 Then pErrMsg = Err.Number & vbCrLf & Err.Description
   If hOpen <> 0 Then InternetCloseHandle hOpen
'   If oWinSock.State Then oWinSock.Close
   If hConnection <> 0 Then InternetCloseHandle hConnection
   
   If PUB_GetFtpConnect = 0 And pRaiseErr = True Then
      Err.Raise 999, , pErrMsg
   End If
End Function

'Added by Morgan 2020/2/18
'Modified by Morgan 2020/2/20 清除暫存資料夾
'Memo by Lydia 2020/03/19 刪除檔案：傳入完整路徑,刪除子資料夾和檔案
Public Sub PUB_ClearTempFolder(pTempPath As String)
   Dim stTemp As String

'Modified by Morgan 2022/4/8 若有檔案開啟中仍要繼續刪除其他檔案
'On Error GoTo OutPort
On Error Resume Next
'end 2022/4/8

   stTemp = Dir(pTempPath & "\.", vbDirectory)
   Do While (stTemp <> "")
      If stTemp <> "." And stTemp <> ".." Then
         '子資料夾
         If (GetAttr(pTempPath & "\" & stTemp) And vbDirectory) = vbDirectory Then
            PUB_KillTempFolder stTemp, pTempPath
         '檔案
         Else
            SetAttr pTempPath & "\" & stTemp, vbNormal
            Kill pTempPath & "\" & stTemp
         End If
      End If
      stTemp = Dir
   Loop
   Exit Sub
   
OutPort:
   Debug.Print Err.Description
End Sub

'Added by Lydia 2015/05/29
'配合新版查名順序,抽出委查單據(查名單)的分類規則
Public Function PUB_GetTMQClass(ByVal iMode As String, Optional ByVal iC01 As Integer, Optional ByVal iC02 As Integer, Optional ByVal iP01 As Integer, Optional ByVal iPcla As String, _
             Optional ByRef oSStr As String, Optional ByRef oQC02 As String) As String
    Dim idR As Integer, strR As String
    Dim rsR As ADODB.Recordset
    Dim oStr01 As String, oStr02 As String, oStr03 As String, oStr04 As String, oStr05 As String
'iMode = 1.僅取得判斷條件SQL ; 2.判斷輸入單據是何種類
'iC01=委查中文筆數,iC02=委查英文筆數,iP01=委查圖形筆數,iPcla=商品組群
'oQC02 =商品組群本數
'oStr01=文字A類(單張查名單筆數>6)
'oStr02=文字B類(單張查名單筆數<=6)
'oStr03=圖形A類(tmqc02>=14,tmqc02<50)
'oStr04=圖形B類(tmqc02<14)
'oStr05=圖形C類(tmqc02>=50)
'I.  當日拿到的查名單量(TMQSR12~TMQSR16)：由少到多
'II. 前２個工作天當統計單量(TMQSR02~ TMQSR06)：由少到多
'III.    亂數順序來決定下一個查名人員，系統會每日重新排亂數 (TMQSR07~ TMQSR11)：由少到多
    'Modified by Lydia 2016/03/28 電子化後,一個文字一張委查單,文A和文B降到3
    'Remove by Lydia 2016/04/06 查名報告可多次申請,所以依舊是2個文字
    'If strSrvDate(1) >= TMQ電子化啟用日 Then
    '    oStr01 = " (tmq09=0 or tmq09 is null) and (nvl(tmq07,0)+nvl(tmq08,0)) > 3 "
    '    oStr02 = " (tmq09=0 or tmq09 is null) and (nvl(tmq07,0)+nvl(tmq08,0))<= 3 "
    'Else
        'Modified by Lydia 2016/08/25 改變判斷
        'oStr01 = " (tmq09=0 or tmq09 is null) and (nvl(tmq07,0)+nvl(tmq08,0)) > 6 "
        'oStr02 = " (tmq09=0 or tmq09 is null) and (nvl(tmq07,0)+nvl(tmq08,0))<= 6 "
        oStr01 = " nvl(tmq09,0)='0' and (nvl(tmq07,0)+nvl(tmq08,0)) > 6 "
        oStr02 = " nvl(tmq09,0)='0' and (nvl(tmq07,0)+nvl(tmq08,0))<= 6 and (nvl(tmq07,0)+nvl(tmq08,0))>0 "
    'End If
    oStr03 = " tmq09>0 and (nvl(tmq07,0)+nvl(tmq08,0))=0 and tmqc02>=14 and tmqc02<50 "
    oStr04 = " tmq09>0 and (nvl(tmq07,0)+nvl(tmq08,0))=0 and tmqc02<14 "
    oStr05 = " tmq09>0 and (nvl(tmq07,0)+nvl(tmq08,0))=0 and tmqc02>=50 "
        
    Select Case Left(iMode, 1)
        Case "1"
            Select Case Right(iMode, 1)
                Case "2"
                    PUB_GetTMQClass = oStr01
                Case "3"
                    PUB_GetTMQClass = oStr02
                Case "4"
                    PUB_GetTMQClass = oStr03
                Case "5"
                    PUB_GetTMQClass = oStr04
                Case "6"
                    PUB_GetTMQClass = oStr05
            End Select
        Case "2"
           If iC01 + iC02 + iP01 = 0 And iPcla = "" Then
              MsgBox "本委查單無法分類,請確認是否輸入正確資料!!", vbCritical
              Exit Function
           Else
              strR = "select TMQC02 from tmqclass where tmqc01=" & CNULL(iPcla)
              idR = 1
              Set rsR = ClsLawReadRstMsg(idR, strR)
              If idR = 1 Then
                 oQC02 = rsR.Fields(0)
              Else
                 oQC02 = 0
              End If
              
              '當日拿到的查名單量(TMQSR12~TMQSR16)
              If iC01 + iC02 > 0 And iP01 = 0 Then
                 'Modified by Lydia 2016/03/28 電子化後,一個文字一張委查單,文A和文B降到3
                 'Remove by Lydia 2016/04/06
                 'If (strSrvDate(1) < TMQ電子化啟用日 And iC01 + iC02 > 6) Or (strSrvDate(1) >= TMQ電子化啟用日 And iC01 + iC02 > 3) Then
                 If iC01 + iC02 > 6 Then
                    PUB_GetTMQClass = "文A12": oSStr = oStr01
                 Else
                    PUB_GetTMQClass = "文B13": oSStr = oStr02
                 End If
              ElseIf iC01 + iC02 = 0 And iP01 > 0 Then
                     If oQC02 >= 50 Then
                         PUB_GetTMQClass = "圖C16": oSStr = oStr05
                     ElseIf oQC02 >= 14 And oQC02 < 50 Then
                         PUB_GetTMQClass = "圖A14": oSStr = oStr03
                     ElseIf oQC02 < 14 Then
                         PUB_GetTMQClass = "圖B15": oSStr = oStr04
                     End If
              End If
           End If
    End Select
   
End Function

'Added by Lydia 2015/06/04  排班新規則(委查單分5類,依當日拿單量、前2日統計單量和亂數排序三種排序組成排班規則)
'bNext = True (下一查名人) , bNext = False (上一查名人)
Public Function PUB_GetTMQUserPos(ByVal bNext As Boolean, Optional ByVal rankNO As String, Optional ByVal iC01 As Integer, Optional ByVal iC02 As Integer, Optional ByVal iP01 As Integer, Optional ByVal iPcla As String _
             , Optional ByRef oCls As String, Optional ByRef oSStr As String, Optional ByRef oQC02 As String) As String
Dim iR As Integer, strR As String
Dim rsQR As New ADODB.Recordset
Dim strP1 As String, strP2 As String
Dim iMin As Integer, iMax As Integer
'Added by Lydia 2017/06/23
Dim rsB As New ADODB.Recordset
'Added by Lydia 2019/01/28
Dim bolRest As Boolean '查名人員是否請假
Dim strTime As String
Dim bolAllRest As Boolean 'Added by Lydia 2025/04/11

   strR = PUB_GetTMQClass(2, iC01, iC02, iP01, iPcla, oSStr, oQC02)
   oCls = strR
   
On Error GoTo OutPos

   If Len(strR) = 0 Then Exit Function '無法分類
   
   'Added by Lydia 2025/04/11 (模組)有多數查名同仁請假半，為了公平採用全部人員都分發查名單，但是期限+2天(天數依設定)
   If Pub_GetTmqAllDate(strSrvDate(1)) = True Then
      bolAllRest = True
   End If
   'end 2025/04/11
   
   Select Case Right(strR, 2)
        Case "12"
            strP2 = " order by tmqsr12,tmqsr02,tmqsr07 "
        Case "13"
            strP2 = " order by tmqsr13,tmqsr03,tmqsr08 "
        Case "14"
            strP2 = " order by tmqsr14,tmqsr04,tmqsr09 "
        Case "15"
            strP2 = " order by tmqsr15,tmqsr05,tmqsr10 "
        Case "16"
            strP2 = " order by tmqsr16,tmqsr06,tmqsr11 "
   End Select
   
   'Added by Lydia 2019/01/28 判斷出缺勤時間
   strTime = Format(ServerTime, "000000")
   If Val(strTime) < 80000 Then '每日批次於凌晨執行
       strTime = "08:00"
   Else
       strTime = Mid(strTime, 1, 2) & ":" & Mid(strTime, 3, 2) 'Left(Right("000000" & ServerTime, 6), 2) & ":" & Mid(Right("000000" & ServerTime, 6), 3, 2)
   End If
   'end 2019/01/28
   
   '排班等級(tmqsr18) ='1'-> 直接分派查名單; '2'->統計人員群組，再分派一次
   strP1 = " select tmqm02,tmqm03,a1.* from tmqsumr a1,tmqmember a2 where tmqsr01=tmqm01(+) and " & _
        "tmqsr17 is null" & IIf(rankNO = "1", " and tmqsr18='1'", " and tmqsr18='2' and tmqm02='" & rankNO & "'")
  
  'Added by Lydia 2021/01/08 因A4021鄭天雲和A7027金筱凌工作內容調整緣故，經呈 林經理同意，更改為此二人只查詢文字，圖形不查，煩請協助修改分發條件。
  'Memo by Lydia 2022/07/08 P2003人員雖然有變動,但是設定不變----與嘉雯確認過
  If InStr("14,15,16,", Right(strR, 2)) > 0 Then
        If rankNO = "1" Then
            'A4021鄭天雲和A7027金筱凌=>P2003
            strP1 = strP1 & " and tmqsr01 <> 'P2003' "
        Else
            strP1 = strP1 & " and tmqsr01 not in ('A4021','A7027') "
        End If
  End If
  'end 2021/01/08
  'Added by Lydia 2024/03/14 排除指定查名人員不分派查名單(從某一天開始)
   strP1 = strP1 & " and tmqsr01 not in (select nvl(aal04,'AAAA') ul01 from addressa4list where aal01 ='TSdel' and aal02 <=to_char(sysdate,'yyyymmdd')) "
  
   strP2 = strP1 & strP2
   iR = 1
   Set rsQR = ClsLawReadRstMsg(iR, strP2)
   If iR = 1 Then
      rsQR.MoveFirst: iMin = rsQR.Fields("TMQSR" & Right(strR, 2))
      'Added by Lydia 2019/01/28 逐筆判斷是否請假中
      Do While Not rsQR.EOF And PUB_GetTMQUserPos = ""
      'end 2019/01/28
            '抓前一查名人
            If bNext = False Then
               rsQR.MoveLast: iMax = rsQR.Fields("TMQSR" & Right(strR, 2))
               '當日尚未有同類的前一查名人
               If iMin = iMax And iMax = 0 Then
                  PUB_GetTMQUserPos = "": Exit Function
               End If
               '如何判斷有請假的前一查名人
            End If
            
            '當排班等級=1,並且屬於統計人員代號
            If rankNO = "1" And IsNull(rsQR.Fields("TMQM02")) Then
               '抓統計人員的群組排序，傳統計人員代號
               'Modified by Lydia 2017/06/23 如果遇到組別人員請假，沒有人可拿；照順序一直排
               'PUB_GetTMQUserPos = PUB_GetTMQUserPos(bNext, rsQR.Fields("TMQSR01"), iC01, iC02, iP01, iPcla, oCls, oSStr, oQC02)
               'Remove by Lydia 2019/01/28
               'Do While Not rsQR.EOF And PUB_GetTMQUserPos = ""
               '   If IsNull(rsQR.Fields("TMQM02")) Then
               'end 2019/01/28
                      'Modified by Lydia 2021/01/08 因A4021鄭天雲和A7027金筱凌工作內容調整緣故，經呈 林經理同意，更改為此二人只查詢文字，圖形不查，煩請協助修改分發條件。
                      'strP1 = Replace(strP2, " and tmqsr18='1'", " and tmqsr18='2' and tmqm02='" & rsQR.Fields("TMQSR01") & "'")
                      strP1 = Replace(strP2, " and tmqsr18='1'", " and tmqsr18='2' and tmqm02='" & rsQR.Fields("TMQSR01") & "'" & IIf(InStr("14,15,16,", Right(strR, 2)) > 0, " and tmqsr01 not in ('A4021','A7027') ", ""))
                      
                      If rsB.State <> adStateClosed Then rsB.Close
                        Set rsB = New ADODB.Recordset
                        rsB.CursorLocation = adUseClient
                        rsB.Open strP1, cnnConnection, adOpenStatic, adLockReadOnly
                        If rsB.RecordCount > 0 Then
                           PUB_GetTMQUserPos = "" & rsB.Fields("TMQSR01")
                           'Modified by Lydia 2019/01/28 逐筆判斷是否請假中
                           'Set rsB = Nothing
                           Do While Not rsB.EOF
                                'Added by Lydia 2022/07/08 因為查名中心人員請假過半，為了公平採用全部人員都分發查名單，但是期限+2天
                                'Modified by Lydia 2023/07/07 (7/7發現漏掉,改成模組) 因7月7日(Fri.)及10日(Mon.)有多數查名同仁請假半，為了公平採用全部人員都分發查名單，但是期限+2天
                                'If strSrvDate(1) >= "20220707" And strSrvDate(1) <= "20220711" Then '111/7/8發現漏掉
                                'Modified by Lydia 2025/04/11 改成變數
                                'If Pub_GetTmqAllDate(strSrvDate(1)) = True Then
                                If bolAllRest = True Then
                                    bolRest = False
                                Else
                                'end 2022/07/08
                                    bolRest = CheckIsPersonRest(rsB.Fields("TMQSR01"), strSrvDate(1), strTime)
                                End If  'Added by Lydia 2022/07/08
                                If "" & rsB.Fields("tmqm03") = "Y" Then '組別有人請假,就不拿單(一起放假)
                                     If bolRest = True Then
                                        PUB_GetTMQUserPos = ""
                                        Exit Do 'rsB
                                     End If
                                Else
                                     If bolRest = True Then
                                          PUB_GetTMQUserPos = ""
                                     Else
                                          PUB_GetTMQUserPos = "" & rsB.Fields("TMQSR01") '組別有人上班,就拿單
                                          Exit Do 'rsB
                                     End If
                                End If
                                rsB.MoveNext
                           Loop
                           'end 2019/01/28
                        End If
               'Remove by Lydia 2019/01/28
               '   Else
               '       PUB_GetTMQUserPos = rsQR.Fields("TMQSR01")
               '   End If
               '   rsQR.MoveNext
               'Loop
               ''end 2017/06/23
               'end 2019/01/28
            Else
               'Modified by Lydia 2019/01/28 查名人員是否請假(by個人)
               'PUB_GetTMQUserPos = rsQR.Fields("TMQSR01")
               'Added by Lydia 2022/07/08 因為查名中心人員請假過半，為了公平採用全部人員都分發查名單，但是期限+2天
               'Modified by Lydia 2023/07/07 (7/7發現漏掉,改成模組) 因7月7日(Fri.)及10日(Mon.)有多數查名同仁請假半，為了公平採用全部人員都分發查名單，但是期限+2天
               'If strSrvDate(1) >= "20220707" And strSrvDate(1) <= "20220711" Then '111/7/8發現漏掉
               'Modified by Lydia 2025/04/11 改成變數
               'If Pub_GetTmqAllDate(strSrvDate(1)) = True Then
               If bolAllRest = True Then
                   bolRest = False
               Else
               'end 2022/07/08
                   bolRest = CheckIsPersonRest(rsQR.Fields("TMQSR01"), strSrvDate(1), strTime)
               End If 'Added by Lydia 2022/07/08
               If bolRest = False Then
                   PUB_GetTMQUserPos = rsQR.Fields("TMQSR01")
               End If
               'end 2019/01/28
            End If
      'Added by Lydia 2019/01/28
        rsQR.MoveNext
      Loop
      'end 2019/01/28
   End If
   
   Set rsQR = Nothing 'Added by Lydia 2017/06/23
OutPos:
   If Err.Number <> 0 Then MsgBox Err.Number & vbCrLf & Err.Description & " !", vbCritical, "查名排班"
End Function

'Added by Lydia 2015/06/01  排班新規則(當日拿單量計算)
'iKind = 寫入模式(1-新增, 2-修改)
'修改: 傳入Quser有值=>個人重新計算,不傳入Quser值=>所有人重新計算
'rankCol = 指定欄位(0-前2日統計量TMQSR02~TMQSR06,1-當日累計量TMQSR12~TMQSR16)
'Modified by Lydia 2017/06/23 +是否要包Transaction (bolTrans)
Public Function PUB_TMQtake(ByVal iKind As String, Optional ByVal Quser As String, Optional ByVal iC01 As Integer, Optional ByVal iC02 As Integer, Optional ByVal iP01 As Integer, Optional ByVal iPcla As String, Optional ByVal rankCol As String = "1", Optional ByVal bolTrans As Boolean = True) As String
   Dim iR As Integer, strR As String
   Dim rsQR As New ADODB.Recordset
   Dim strP1 As String, strP2 As String, strP3 As String
   
On Error GoTo OutTake

 'Modified by Lydia 2017/06/23
 'cnnConnection.BeginTrans
 If bolTrans = True Then cnnConnection.BeginTrans
 
    Select Case iKind
        Case "1" '新增
           If Len(Quser) > 0 Then
             strR = PUB_GetTMQClass(2, iC01, iC02, iP01, iPcla)
             
             strP1 = " update tmqsumr set tmqsr" & Trim(Right(strR, 2)) & "=tmqsr" & Trim(Right(strR, 2)) & "+1 where tmqsr01=" & CNULL(Quser)
             cnnConnection.Execute strP1
             If rsQR.State <> adStateClosed Then rsQR.Close
                Set rsQR = New ADODB.Recordset
                rsQR.CursorLocation = adUseClient
                rsQR.Open "select tmqm02 from tmqmember where tmqm01='" & Quser & "' and tmqm02<>tmqm01 ", cnnConnection, adOpenStatic, adLockReadOnly
                If rsQR.RecordCount > 0 Then
                    strP1 = " update tmqsumr set tmqsr" & Trim(Right(strR, 2)) & "=tmqsr" & Trim(Right(strR, 2)) & "+1 where tmqsr01=" & CNULL(rsQR(0))
                    cnnConnection.Execute strP1
                End If
                
           End If
        Case "2" '修改,刪除->重算 (因為查名單修改不會觸發PUB_GetTMQUserPos,所以查名人不會變)
        
             '先清空記錄欄位
            If rankCol = "0" Then   '0-前2日統計量
               strP1 = " update tmqsumr set tmqsr02=0,tmqsr03=0,tmqsr04=0,tmqsr05=0,tmqsr06=0"
               strP2 = "tmq05>=" & CNULL(CompWorkDay(3, strSrvDate(1), 1), True) & " and tmq05<" & CNULL(strSrvDate(1), True) & " "
            Else '1-當日累計量
               strP1 = " update tmqsumr set tmqsr12=0,tmqsr13=0,tmqsr14=0,tmqsr15=0,tmqsr16=0"
               strP2 = "tmq05=" & CNULL(strSrvDate(1), True)
            End If
            '指定查名人員
            If Len(Quser) > 0 Then strP1 = strP1 & " Where tmqsr01 = " & CNULL(Quser)

            cnnConnection.Execute strP1
            
            'Modified by Lydia 2017/06/23 +排除未分派查名人的單據 and nvl(tmq10,'N') <> 'N'
            strP1 = "select tmq10,tmq01,nvl(tmq07,0) tmq07,nvl(tmq08,0) tmq08,nvl(tmq09,0) tmq09,tmq03,tmqc02 " & _
                    "from trademarkquery,tmqmember,tmqclass " & _
                    "where " & strP2 & " and tmq10=tmqm01(+) and tmq03=tmqc01(+) and nvl(tmq10,'N') <> 'N'"
            '指定查名人員
            If Len(Quser) > 0 Then strP1 = strP1 & " and tmq10 = " & CNULL(Quser)
            
            '2.1 文字A類(單張查名單筆數>6)
             strP2 = "select '12' OR1,x1.tmq10,count(tmq01) cnt from (" & strP1 & ") X1 where" & Replace(PUB_GetTMQClass("1-2"), "tmq", "x1.tmq") & " group by x1.tmq10"
            '2.2 文字B類(單張查名單筆數<=6)
             strP2 = strP2 & " union all select '13' OR1,x1.tmq10,count(tmq01) cnt from (" & strP1 & ") X1 where" & Replace(PUB_GetTMQClass("1-3"), "tmq", "x1.tmq") & " group by x1.tmq10"
            '2.3 圖形A類(tmqc02>=14,tmqc02<50)
             strP2 = strP2 & " union all select '14' OR1,x1.tmq10,count(tmq01) cnt from (" & strP1 & ") X1 where" & Replace(PUB_GetTMQClass("1-4"), "tmq", "x1.tmq") & " group by x1.tmq10"
            '2.4 圖形B類(tmqc02<14)
             strP2 = strP2 & " union all select '15' OR1,x1.tmq10,count(tmq01) cnt from (" & strP1 & ") X1 where" & Replace(PUB_GetTMQClass("1-5"), "tmq", "x1.tmq") & "group by x1.tmq10"
            '2.5 圖形C類(tmqc02>=50)
             strP2 = strP2 & " union all select '16' OR1,x1.tmq10,count(tmq01) cnt from (" & strP1 & ") X1 where" & Replace(PUB_GetTMQClass("1-6"), "tmq", "x1.tmq") & "group by x1.tmq10"
             strP2 = strP2 & " order by 1,2"
             
             If rankCol = "0" Then strP2 = Replace(strP2, "select '1", "select '0")
             
                 If rsQR.State <> adStateClosed Then rsQR.Close
                   Set rsQR = New ADODB.Recordset
                   rsQR.CursorLocation = adUseClient
                   rsQR.Open strP2, cnnConnection, adOpenStatic, adLockReadOnly
                     If rsQR.RecordCount > 0 Then
                       rsQR.MoveFirst
                       Do While Not rsQR.EOF
                          strP2 = "update TMQSumR set TMQSR" & Trim(rsQR.Fields("OR1")) & "=" & rsQR.Fields("cnt") & " where TMQSR01=" & CNULL(rsQR.Fields("tmq10"))
                          cnnConnection.Execute strP2
                          rsQR.MoveNext
                       Loop
                     End If
            '統計人員合計
            If Len(Quser) = 0 Then
                strP1 = "select TMQM02,sum(TMQSR12) s2,sum(TMQSR13) s3,sum(TMQSR14) s4,sum(TMQSR15) s5,sum(TMQSR16) s6 " & _
                        "from tmqsumr,tmqmember where tmqsr01=tmqm01(+) and tmqm01<>tmqm02 group by TMQM02"
            Else
                strP1 = "select TMQM02,sum(TMQSR12) s2,sum(TMQSR13) s3,sum(TMQSR14) s4,sum(TMQSR15) s5,sum(TMQSR16) s6 " & _
                        "from tmqsumr,tmqmember where tmqsr01=tmqm01(+) and tmqm01 in (select tmqm01 from tmqmember where tmqm02 in (select tmqm02 from tmqmember where tmqm01<>tmqm02 and tmqm01='" & Quser & "')) group by TMQM02"
            End If
            If rankCol = "0" Then strP1 = Replace(strP1, "SR1", "SR0")
            
            If rsQR.State <> adStateClosed Then rsQR.Close
              Set rsQR = New ADODB.Recordset
              rsQR.CursorLocation = adUseClient
              rsQR.Open strP1, cnnConnection, adOpenStatic, adLockReadOnly
              With rsQR
                If rsQR.RecordCount > 0 Then
                  rsQR.MoveFirst
                  Do While Not rsQR.EOF
                     strP2 = "update TMQSumR set TMQSR12=" & rsQR.Fields("s2") & ",TMQSR13=" & rsQR.Fields("s3") & ",TMQSR14=" & rsQR.Fields("s4") & _
                     ",TMQSR15=" & rsQR.Fields("s5") & ",TMQSR16=" & rsQR.Fields("s6") & " where TMQSR01=" & CNULL(rsQR.Fields(0))
                     
                     If rankCol = "0" Then strP2 = Replace(strP2, "SR1", "SR0")
                     
                     cnnConnection.Execute strP2
                     rsQR.MoveNext
                  Loop
                End If
              End With
    End Select
 'Modified by Lydia 2017/06/23
 'cnnConnection.CommitTrans
 If bolTrans = True Then cnnConnection.CommitTrans
 
OutTake:
   'Modified by Lydia 2017/06/23
   'If Err.Number <> 0 Then MsgBox Err.Number & vbCrLf & Err.Description & " !", vbCritical, "查名排班"
   If Err.Number <> 0 Then
      If bolTrans = True Then
         cnnConnection.RollbackTrans
         MsgBox Err.Number & vbCrLf & Err.Description & " !", vbCritical, "查名排班"
      End If
   End If
   'end 2017/06/23
End Function
'Added by Lydia 2015/07/27 P大陸發明案之公開期限
Public Function PUB_GetOpenLimit020(ByVal sPA01 As String, ByVal sPA02 As String, ByVal sPA03 As String, ByVal sPA04 As String, Optional ByRef Ldate As String, Optional ByRef Ltitle As String) As Boolean
   Dim Str1 As String, Str2 As String
   Dim idR As Integer
   Dim rsA As New ADODB.Recordset
   
On Error GoTo OutMode
   PUB_GetOpenLimit020 = False
   'Modified by Lydia 2015/07/31 分割案原本用新案性質,現改為307
   Str1 = "select '1' ord1,decode(dc01,null,' ','Y') YN, (cp47) SDate from caseprogress,divisioncase where cp01='" & sPA01 & "' and cp02='" & sPA02 & "' and cp03='" & sPA03 & "' and cp04='" & sPA04 & "' and cp10='307' and cp01=dc01(+) and cp02=dc02(+) and cp03=dc03(+) and cp04=dc04(+) "
   Str1 = Str1 & "union select '2' ord1,(PA46) YN,(cp47) SDate From patent, caseprogress where pa01='" & sPA01 & "' and pa02='" & sPA02 & "' and pa03='" & sPA03 & "' and pa04='" & sPA04 & "' and pa46='Y' and cp01(+)=pa01 and cp02(+)=pa02 and cp03(+)=pa03 and cp04(+)=pa04 and cp10 in (" & NewCasePtyList & ") and cp57 is null "
   Str1 = Str1 & "union select '3' ord1,' ' YN,min(pd05) SDate from patent,pridate where pa01='" & sPA01 & "' and pa02='" & sPA02 & "' and pa03='" & sPA03 & "' and pa04='" & sPA04 & "' and (pa46 is null or pa46='') and pd01(+)=pa01 and pd02(+)=pa02 and pd03(+)=pa03 and pd04(+)=pa04 "
   Str1 = Str1 & "union select '4' ord1,(PA46) YN,(PA10) SDate from patent where pa01='" & sPA01 & "' and pa02='" & sPA02 & "' and pa03='" & sPA03 & "' and pa04='" & sPA04 & "' "
   Str1 = Str1 & "order by 1"
   
   idR = 1
   Set rsA = ClsLawReadRstMsg(idR, Str1)
   If idR = 1 Then
      rsA.MoveFirst
      Do While Not rsA.EOF
         Str1 = "" & rsA.Fields("ord1")
         Str2 = "" & rsA.Fields("SDate")
         Ldate = "": Ltitle = ""
         '分割案(即存在於DivisionCase的dc01~dc04)，則以代理人提申日(CP47)+6個月為公開期限(P-111894),  無CP47者剔除
         If Str1 = "1" And rsA.Fields("YN") = "Y" And Len(Str2) = 0 Then Exit Do
         'PCT案無CP47者剔除
         If Str1 = "2" And rsA.Fields("YN") = "Y" And Len(Str2) = 0 Then Exit Do
         
         If Val(Str2) > 0 Then
            Select Case Str1
                Case "1"
                     If rsA.Fields("YN") = "Y" Then
                        Ldate = CompDate(1, 6, Str2)
                        Ltitle = "分割案提交日 " & ChangeWStringToWDateString(Str2) & " + 6個月"
                     End If
                Case "2"
                     Ldate = CompDate(1, 3, Str2)
                     Ltitle = "PCT提交日 " & ChangeWStringToWDateString(Str2) & " + 3個月"
                Case "3"
                     Ldate = CompDate(1, 18, Str2)
                     Ltitle = "最早優先權日 " & ChangeWStringToWDateString(Str2) & " + 18個月"
                Case "4"
                     Ldate = CompDate(1, 18, Str2)
                     Ltitle = "申請日 " & ChangeWStringToWDateString(Str2) & " + 18個月"
            End Select
         End If
         If Len(Ltitle) > 0 Then
            PUB_GetOpenLimit020 = True: Exit Do
         End If
         rsA.MoveNext
      Loop
   End If
   
OutMode:
   If Err.Number <> 0 Then MsgBox Err.Number & vbCrLf & Err.Description & " !", vbCritical, "大陸發明案之公開期限"
   Set rsA = Nothing
End Function

'Add By Sindy 2015/8/3 發文時,若工程師各項日期未輸入者,自動更新為發文日
Public Sub PUB_UpdEmpDate(strCP09 As String, strCP01 As String, strCP10 As String, strCP27 As String)
Dim rsA As New ADODB.Recordset
   
   If (strCP01 = "P" Or strCP01 = "CFP") And Val(strCP27) > 0 Then
      Select Case strCP10
         '106.主張國際優先權
         '121.主張國內優先權
         '416.實體審查
         '417.提早公開
         '909.後金
         '911.補收款
         '917.超頁,超項費
         '920.急件費
         '938.超頁費
         '939.超項費
         '946.摘要英譯
         Case "106", "121", "416", "417", "909", "911", "917", "920", "938", "939", "946"
            '完稿日
            strSql = "select ep02 from engineerprogress where ep02='" & strCP09 & "' and nvl(ep09,0)=0"
            intI = 1
            Set rsA = ClsLawReadRstMsg(intI, strSql)
            If intI = 1 Then
               strSql = "update engineerprogress set ep09=" & strCP27 & " where ep02='" & strCP09 & "'"
               cnnConnection.Execute strSql
            End If
            '會稿日
            strSql = "select ep02 from engineerprogress where ep02='" & strCP09 & "' and nvl(ep07,0)=0"
            intI = 1
            Set rsA = ClsLawReadRstMsg(intI, strSql)
            If intI = 1 Then
               strSql = "update engineerprogress set ep07=" & strCP27 & " where ep02='" & strCP09 & "'"
               cnnConnection.Execute strSql
            End If
            '會稿完成日
            strSql = "select ep02 from engineerprogress where ep02='" & strCP09 & "' and nvl(ep08,0)=0"
            intI = 1
            Set rsA = ClsLawReadRstMsg(intI, strSql)
            If intI = 1 Then
               strSql = "update engineerprogress set ep08=" & strCP27 & " where ep02='" & strCP09 & "'"
               cnnConnection.Execute strSql
            End If
            Set rsA = Nothing
      End Select
   End If
End Sub
'Added by Lydia 2015/08/14 固定PictureBox中的image,載入圖片後調整圖片大小
Public Sub Pub_PicToObj(oFileNameAndPath As String, ByRef GSpic As PictureBox, ByRef tgPic As PictureBox, ByRef tgImg As Image)
'oFileNameAndPath = 載入圖片的路徑
'GSpic = 判斷的基準圖片
'tgPic =固定PictureBox
'tgImg =  固定PictureBox中的image

GSpic.AutoSize = True
tgPic.AutoSize = False
tgImg.Stretch = True

    Dim objImg As StdPicture
    Dim nSrcWidth, nSrcHeight, nWidth, nHeight
    Dim tBI      As BITMAP

    On Error GoTo BE
        Set objImg = pvGetStdPicture(oFileNameAndPath)

        Set GSpic.Picture = objImg
        If GSpic.Picture <> 0 Then
            Call GetObject(objImg.handle, Len(tBI), tBI)
            If tBI.bmWidth = 0 Or tBI.bmHeight = 0 Then
                MsgBox "發生錯誤！", vbExclamation, "圖檔格式錯誤"
                Exit Sub
            End If
            If tBI.bmWidth > 2000 Or tBI.bmHeight > 2000 Then
                nSrcWidth = tBI.bmWidth
                nSrcHeight = tBI.bmHeight
                If nSrcWidth > nSrcHeight Then
                    nWidth = 1200
                    nHeight = nSrcHeight / (nSrcWidth / nWidth)
                ElseIf nSrcWidth < nSrcHeight Then
                    nHeight = 1200
                    nWidth = nSrcWidth / (nSrcHeight / nHeight)
                Else
                    nHeight = 1200
                    nWidth = 1200
                End If
                GSpic.Width = nWidth
                GSpic.Height = nHeight
            End If
        End If
        Dim t_hd As Double
        Dim t_wd As Double
        t_hd = GSpic.ScaleHeight / tgPic.ScaleHeight
        t_wd = GSpic.ScaleWidth / tgPic.ScaleWidth
        If t_hd > t_wd Then
            t_wd = GSpic.ScaleWidth / t_hd
            t_hd = GSpic.ScaleHeight / t_hd
        Else
            t_hd = GSpic.ScaleHeight / t_wd
            t_wd = GSpic.ScaleWidth / t_wd
        End If
            tgImg.Width = t_wd
            tgImg.Height = t_hd
            tgImg.Move (tgPic.ScaleWidth - tgImg.Width) / 2, (tgPic.ScaleHeight - tgImg.Height) / 2, t_wd, t_hd
        
        Set tgImg.Picture = GSpic.Picture
        Set objImg = Nothing

    Exit Sub
BE:
    Resume Next
End Sub
'Added by Lydia 2015/09/09 依大陸案更新香港澳門期限
Public Sub PUB_UpdCP07by020(PField() As String, bFMP As Boolean, pCM10 As String, Optional pEP06 As String, Optional pPA1214 As String)
'pfield =大陸案號,  bFMP 是否為FMP案
'pPA1214 =輸入公開日
Dim rsRW As New ADODB.Recordset
Dim iR As Integer
Dim strCP06 As String, strCP07 As String
Dim strCP64 As String
 
   '關聯-香港案
   If pCM10 = "4" Then
        'Modified by Lydia 2016/02/04 若下一程序續辦有值,會抓不到資料,將語法改成子查詢抓條件 (ex.P108724大陸案下一程序公開(999)已上續辦,P113790香港案分案未更新期限)
        'strSql = "select pa12 sdate1,np09 sdate2,cm01,cm02,cm03,cm04,cp05,cp09,cp64 from patent,casemap,caseprogress,nextprogress where pa01=" & CNULL(pfield(1)) & " and pa02=" & CNULL(pfield(2)) & " and pa03=" & CNULL(pfield(3)) & " and pa04=" & CNULL(pfield(4))
        'strSql = strSql & " and pa01=cm05(+) and pa02=cm06(+) and pa03=cm07(+) and pa04=cm08(+) and cm10='" & pCM10 & "' and cm01=cp01(+) and cm02=cp02(+) and cm03=cp03(+) and cm04=cp04(+) and cp10='110' and cp27||cp57 is null"
        'strSql = strSql & " and pa01=np02(+) and pa02=np03(+) and pa03=np04(+) and pa04=np05(+) and np06 is null and np07(+)='999'"
        strSql = " select pa12 sdate1,np09 sdate2,cm01,cm02,cm03,cm04,cp05,cp09,cp64 from patent,casemap," & _
                 "(select np02,np03,np04,np05,np09 from nextprogress where np02=" & CNULL(PField(1)) & " and np03=" & CNULL(PField(2)) & " and np04=" & CNULL(PField(3)) & " and np05=" & CNULL(PField(4)) & " and np06 is null and np07='999'), " & _
                 "(select cp01,cp02,cp03,cp04,cp05,cp09,cp64 from caseprogress ,casemap where cm10='" & pCM10 & "' and cm05=" & CNULL(PField(1)) & " and cm06=" & CNULL(PField(2)) & " and cm07=" & CNULL(PField(3)) & " and cm08=" & CNULL(PField(4)) & " and cm01=cp01(+) and cm02=cp02(+) and cm03=cp03(+) and cm04=cp04(+) and cp10='110' and cp27||cp57 is null ) " & _
                 "where pa01=" & CNULL(PField(1)) & " and pa02=" & CNULL(PField(2)) & " and pa03=" & CNULL(PField(3)) & " and pa04=" & CNULL(PField(4)) & _
                 " and pa01=cm05(+) and pa02=cm06(+) and pa03=cm07(+) and pa04=cm08(+) and cm10='" & pCM10 & "' " & _
                 " and cm01=cp01(+) and cm02=cp02(+) and cm03=cp03(+) and cm04=cp04(+) " & _
                 " and pa01=np02(+) and pa02=np03(+) and pa03=np04(+) and pa04=np05(+) "
        iR = 1
        Set rsRW = ClsLawReadRstMsg(iR, strSql)
        If iR = 1 Then
           strCP64 = ""
           '有公開日pa12，以公開日+6個月更新香港案進度檔(110)且未發文未取消收文的法定期限
           If pPA1214 <> "" Then
             strCP07 = CompDate(1, 6, pPA1214)
             strCP64 = "期限來源:" & Right("  " & PField(1), 3) & "-" & PField(2) & "-" & PField(3) & "-" & PField(4) & "(大陸公開日" & ChangeWStringToWDateString(pPA1214) & "+6個月);"
           ElseIf Not IsNull(rsRW.Fields("sdate1")) Then
             strCP07 = CompDate(1, 6, rsRW.Fields("sdate1"))
             strCP64 = "期限來源:" & Right("  " & PField(1), 3) & "-" & PField(2) & "-" & PField(3) & "-" & PField(4) & "(大陸公開日" & ChangeWStringToWDateString(rsRW.Fields("sdate1")) & "+6個月);"
           '以公開期限999(np06 is null)之法限
           ElseIf Not IsNull(rsRW.Fields("sdate2")) Then
             strCP07 = CompDate(1, 6, rsRW.Fields("sdate2"))
             strCP64 = "期限來源:" & Right("  " & PField(1), 3) & "-" & PField(2) & "-" & PField(3) & "-" & PField(4) & "(大陸公開期限" & ChangeWStringToWDateString(rsRW.Fields("sdate2")) & "+6個月);"
           End If
        
           If strCP07 <> "" Then
             'Added by Lydia 2025/10/31 屬於2025/10/29更新所限 ; 非台灣案(大陸、香港、澳門和PCT)都是相同算法---郭經理(電話)
             If PField(1) = "P" And PUB_ChkIsFMP(PField(1), PField(2), PField(3), PField(4)) = False Then
                strCP06 = PUB_GetPOurDeadline(strCP07, "020")
             Else
             'end 2025/10/31
                '所限=法限-1個月又5天
                strCP06 = PUB_GetWorkDay1(CompDate(2, -5, CompDate(1, -1, strCP07)), True)
             End If
             '取代原期限來源
             strSql = "update caseprogress set cp06=" & strCP06 & " ,cp07=" & strCP07 & " ,CP64=SUBSTR(CP64,1,INSTR(CP64,'期限來源:')-1)||'" & strCP64 & "'||SUBSTR(CP64,INSTR(CP64,';',instr(CP64,'期限來源:'))+1) where cp09='" & rsRW.Fields("cp09") & "' "
             cnnConnection.Execute strSql, intI
             'Modified by Lydia 2020/01/15 判斷大陸案公開後才更新齊備日; ex.大陸案預掛公開期限999,P-124314和P-124316在內專分案時上齊備日
             'If pEP06 <> "" Then
             If pEP06 <> "" And pPA1214 & rsRW.Fields("sdate1") <> "" Then
                strSql = "UPDATE engineerPROGRESS SET ep06=" & strSrvDate(1) & " WHERE ep02='" & rsRW.Fields("cp09") & "' "
               cnnConnection.Execute strSql, intI
             End If
           End If
        End If
   End If
   
   '關聯-澳門案
   If pCM10 = "5" Then
        'Modified by Lydia 2016/02/04  若下一程序續辦有值,會抓不到資料,將語法改成子查詢抓條件
'        strSql = "select pa14 sdate1,nvl(np09,c2.cp07) sdate2,nvl(np08,c2.cp06) sdate3,cm01,cm02,cm03,cm04,c1.cp05,c1.cp09,c1.cp64 from patent,casemap,caseprogress c1,nextprogress,caseprogress c2 where pa01=" & CNULL(pfield(1)) & " and pa02=" & CNULL(pfield(2)) & " and pa03=" & CNULL(pfield(3)) & " and pa04=" & CNULL(pfield(4))
'        strSql = strSql & " and pa01=cm05(+) and pa02=cm06(+) and pa03=cm07(+) and pa04=cm08(+) and cm10='" & pCM10 & "' and cm01=c1.cp01(+) and cm02=c1.cp02(+) and cm03=c1.cp03(+) and cm04=c1.cp04(+) and c1.cp10='101' and c1.cp27||c1.cp57 is null"
'        strSql = strSql & " and pa01=np02(+) and pa02=np03(+) and pa03=np04(+) and pa04=np05(+) and np06 is null and np07(+)='601'"
'        strSql = strSql & " and pa01=c2.cp01(+) and pa02=c2.cp02(+) and pa03=c2.cp03(+) and pa04=c2.cp04(+) and c2.cp10(+)='601'"
        'Modified by Lydia 2018/05/30 debug-澳門案記錄在cm01~04,所以大陸案在cm05~cm08 (ex.P-109275大陸案輸入核准，P-109278澳門發明案未更新期限)
        'strSql = "select pa14 sdate1,nvl(v209,v307) sdate2,nvl(v208,v306) sdate3,cm01,cm02,cm03,cm04,v105 cp05,v109 cp09,v164 cp64 " & _
                 "from patent,casemap," & _
                 "(select cp01 v101,cp02 v102,cp03 v103,cp04 v104,cp05 v105,cp09 v109,cp64 v164 from caseprogress,casemap where cm10='" & pCM10 & "' and cm05=" & CNULL(pfield(1)) & " and cm06=" & CNULL(pfield(2)) & " and cm07=" & CNULL(pfield(3)) & " and cm08=" & CNULL(pfield(4)) & " and cm01=cp01(+) and cm02=cp02(+) and cm03=cp03(+) and cm04=cp04(+) and cp10='101' and cp27||cp57 is null), " & _
                 "(select np02 v202,np03 v203,np04 v204,np05 v205,np08 v208,np09 v209 from nextprogress,casemap where cm10='" & pCM10 & "' and cm05=" & CNULL(pfield(1)) & " and cm06=" & CNULL(pfield(2)) & " and cm07=" & CNULL(pfield(3)) & " and cm08=" & CNULL(pfield(4)) & " and cm01=np02(+) and cm02=np03(+) and cm03=np04(+) and cm04=np05(+) and np07='601' and np06 is null), " & _
                 "(select cp01 v301,cp02 v302,cp03 v303,cp04 v304,cp07 v307,cp06 v306 from caseprogress where cp01=" & CNULL(pfield(1)) & " and cp02=" & CNULL(pfield(2)) & " and cp03=" & CNULL(pfield(3)) & " and cp04=" & CNULL(pfield(4)) & " and cp10='601' ) " & _
                 "where pa01=" & CNULL(pfield(1)) & " and pa02=" & CNULL(pfield(2)) & " and pa03=" & CNULL(pfield(3)) & " and pa04=" & CNULL(pfield(4)) & _
                 "and pa01=cm05(+) and pa02=cm06(+) and pa03=cm07(+) and pa04=cm08(+) and cm10='" & pCM10 & "' " & _
                 "and pa01=v101(+) and pa01=v102(+) and pa03=v103(+) and pa04=v104(+) and pa01=v202(+) and pa02=v203(+) and pa03=v204(+) and pa04=v205(+) " & _
                 "and pa01=v301(+) and pa01=v302(+) and pa03=v303(+) and pa04=v304(+) "
        strSql = "select pa14 sdate1,nvl(v209,v307) sdate2,nvl(v208,v306) sdate3,cm01,cm02,cm03,cm04,v105 cp05,v109 cp09,v164 cp64 " & _
                 "from patent,casemap," & _
                 "(select cp01 v101,cp02 v102,cp03 v103,cp04 v104,cp05 v105,cp09 v109,cp64 v164 from caseprogress,casemap where cm10='" & pCM10 & "' and cm05=" & CNULL(PField(1)) & " and cm06=" & CNULL(PField(2)) & " and cm07=" & CNULL(PField(3)) & " and cm08=" & CNULL(PField(4)) & " and cm01=cp01(+) and cm02=cp02(+) and cm03=cp03(+) and cm04=cp04(+) and cp10='101' and cp27||cp57 is null), " & _
                 "(select np02 v202,np03 v203,np04 v204,np05 v205,np08 v208,np09 v209 from nextprogress where np02=" & CNULL(PField(1)) & " and np03=" & CNULL(PField(2)) & " and np04=" & CNULL(PField(3)) & " and np05=" & CNULL(PField(4)) & " and np07='601' and np06 is null), " & _
                 "(select cp01 v301,cp02 v302,cp03 v303,cp04 v304,cp07 v307,cp06 v306 from caseprogress where cp01=" & CNULL(PField(1)) & " and cp02=" & CNULL(PField(2)) & " and cp03=" & CNULL(PField(3)) & " and cp04=" & CNULL(PField(4)) & " and cp10='601' ) " & _
                 "where pa01=" & CNULL(PField(1)) & " and pa02=" & CNULL(PField(2)) & " and pa03=" & CNULL(PField(3)) & " and pa04=" & CNULL(PField(4)) & _
                 "and pa01=cm05(+) and pa02=cm06(+) and pa03=cm07(+) and pa04=cm08(+) and cm10='" & pCM10 & "' " & _
                 "and cm01=v101(+) and cm02=v102(+) and cm03=v103(+) and cm04=v104(+) and pa01=v202(+) and pa02=v203(+) and pa03=v204(+) and pa04=v205(+) " & _
                 "and pa01=v301(+) and pa01=v302(+) and pa03=v303(+) and pa04=v304(+) "
        iR = 1
        Set rsRW = ClsLawReadRstMsg(iR, strSql)
        If iR = 1 Then
           strCP64 = ""
           '有發證日pa14，以大陸發證日+3個月更新澳門發明案且未發文未取消收文的法定期限
           If Not IsNull(rsRW.Fields("sdate1")) Then
             strCP07 = CompDate(1, 3, rsRW.Fields("sdate1"))
             'Added by Lydia 2025/10/31 屬於2025/10/29更新所限 ; 非台灣案(大陸、香港、澳門和PCT)都是相同算法---郭經理(電話)
             If PField(1) = "P" And PUB_ChkIsFMP(PField(1), PField(2), PField(3), PField(4)) = False Then
                 strCP06 = PUB_GetPOurDeadline(strCP07, "020")
             Else
             'end 2025/10/31
                '所限=法限-1個月又5天
                 strCP06 = PUB_GetWorkDay1(CompDate(2, -5, CompDate(1, -1, strCP07)), True)
             End If
             strCP64 = "期限來源:" & Right("  " & PField(1), 3) & "-" & PField(2) & "-" & PField(3) & "-" & PField(4) & "(大陸發證日" & ChangeWStringToWDateString(rsRW.Fields("sdate1")) & "+3個月);"
           '以領證601之期限(np06 is null)之法限和所限,更新澳門案101的期限
           ElseIf Not IsNull(rsRW.Fields("sdate2")) Then
             strCP07 = rsRW.Fields("sdate2")
             strCP06 = rsRW.Fields("sdate3")
             strCP64 = "期限來源:" & Right("  " & PField(1), 3) & "-" & PField(2) & "-" & PField(3) & "-" & PField(4) & "(大陸領證期限" & ChangeWStringToWDateString(rsRW.Fields("sdate2")) & ");"
           End If
           
           If strCP07 <> "" Then
             '取代原期限來源
             strSql = "update caseprogress set cp06=" & strCP06 & " ,cp07=" & strCP07 & " ,CP64=SUBSTR(CP64,1,INSTR(CP64,'期限來源:')-1)||'" & strCP64 & "'||SUBSTR(CP64,INSTR(CP64,';',instr(CP64,'期限來源:'))+1) where cp09='" & rsRW.Fields("cp09") & "' "
             cnnConnection.Execute strSql, intI
           End If
        End If
   End If
End Sub
'Added by Lydia 2015/09/04 讀取Grid指定名稱的行位置
Public Function PUB_MGridGetId(pFieldName As String, ByRef FlexGrid As MSHFlexGrid) As Integer
   Dim iRow As Integer
   With FlexGrid
   For iRow = 0 To .Cols - 1
      'Modified by Lydia 2024/02/29 +Trim
      If Trim(UCase(.TextMatrix(0, iRow))) = Trim(UCase(pFieldName)) Then
         PUB_MGridGetId = iRow
         Exit For
      End If
   Next
   End With
End Function
'Added by Lydia 2015/09/04 讀取Grid指定名稱和列的內容
Public Function PUB_MGridGetValue(pRow As Integer, pFieldName As String, ByRef FlexGrid As MSHFlexGrid) As String
   Dim iRow As Integer
   With FlexGrid
   For iRow = 0 To .Cols - 1
      If UCase(.TextMatrix(0, iRow)) = UCase(pFieldName) Then
         PUB_MGridGetValue = .TextMatrix(pRow, iRow)
         Exit For
      End If
   Next
   End With
End Function
'Added by Lydia 2015/09/04 變更Grid指定名稱和列的內容
Public Function PUB_MGridSetValue(pRow As Integer, pFieldName As String, pValue As String, ByRef FlexGrid As MSHFlexGrid) As Boolean
   Dim iRow As Integer
   With FlexGrid
   For iRow = 0 To .Cols - 1
      If UCase(.TextMatrix(0, iRow)) = UCase(pFieldName) Then
         .TextMatrix(pRow, iRow) = pValue
         PUB_MGridSetValue = True
         Exit Function
      End If
   Next
   End With
End Function
'Added by Lydia 2015/09/22 查名單電子化:判斷textbox內是否含有數字,中文,英文
Public Sub PUB_CountTxtNEC(ByRef intE As Integer, ByRef intC As Integer, Optional ByRef tInput)
Dim midClass As String
Dim readStr As String
Dim jj As Integer
   If tInput = "" Then
     
   Else
       midClass = ""

       For jj = 1 To Len(tInput)
           readStr = Mid(tInput, jj, 1)
           If (Left(readStr, 1) >= Chr(48) And Left(readStr, 1) <= Chr(57)) Then
                  If InStr(midClass, "N") = 0 Then midClass = midClass & "N;"
           ElseIf (Left(readStr, 1) >= Chr(65) And Left(readStr, 1) <= Chr(90)) Or (Left(readStr, 1) >= Chr(97) And Left(readStr, 1) <= Chr(122)) Then
                  If InStr(midClass, "E") = 0 Then midClass = midClass & "E;"
           ElseIf readStr <> " " Then
                  '中文=非英文和數字皆算是中文
                  If InStr(midClass, "C") = 0 Then midClass = midClass & "C;"
           End If
       Next jj
    
       '數字：中文、英文各一筆
       If InStr(midClass, "N") > 0 Then
          intE = intE + 1: intC = intC + 1
       End If
       If InStr(midClass, "E") > 0 Then
          intE = intE + 1
       End If
       If InStr(midClass, "C") > 0 Then
          intC = intC + 1
       End If
   End If
End Sub

'Added by Lydia 2016/04/06 取得查名單收文之查名代號(原:收文組群)之號碼
Public Function PUB_GetTMQCaseMapNo(Optional ByRef iQC02 As String = "", Optional ByRef iQC03 As String = "", Optional ByRef bolAdd As Boolean = False) As String
'iQC02: 案件進度檔之收文號 (CP09)
'iQC03: 委查單號 (查名單之分單)
'bolAdd:是否要新增收文對照檔
Dim strNo As String
Dim strQC As String
Dim inQ As Integer
Dim adoRecord As New ADODB.Recordset
     
   '已有查名代號
   If iQC02 <> "" Or iQC03 > "" Then
      inQ = 1
      If iQC03 <> "" Then
         'Modified by Lydia 2023/08/18 +排除記錄
         strQC = "select '1' ord1,TQC01 from tmqcasemap where tqc03='" & iQC03 & "' and tqc03<>'" & cntTQC自動記錄 & "' " & IIf(iQC02 = "", " and tqc02 is null ", " and tqc02=" & CNULL(iQC02))
      End If
      If iQC02 <> "" Then
          'Modified by Lydia 2023/08/18 +排除記錄
          strQC = strQC & IIf(Len(strQC) > 0, " Union ", "") & "select '2' ord1,TQC01 from tmqcasemap where tqc02='" & iQC02 & "' and tqc03<>'" & cntTQC自動記錄 & "' "
      End If
      strQC = strQC & " order by ord1"
      Set adoRecord = ClsLawReadRstMsg(inQ, strQC)
      If inQ = 1 Then
         strNo = adoRecord.Fields("TQC01")
      End If
   End If
   '取得新編號
   If strNo = "" Then
ReGetNo: 'Addes by Lydia 2023/08/17
      inQ = 1
      strQC = "select to_number(nvl(max(tqc01),'" & Mid(strSrvDate(2), 1, Len(strSrvDate(2)) - 4) & "'||'000000'))+1 from tmqcasemap where substr(tqc01,1,3)='" & Mid(strSrvDate(2), 1, Len(strSrvDate(2)) - 4) & "' "
      Set adoRecord = ClsLawReadRstMsg(inQ, strQC)
      If inQ = 1 Then
         strNo = adoRecord(0)
         bolAdd = True
      End If
      'Added by Lydia 2023/08/17 直接新增假記錄,避免重複流水號; ex.接洽單1120017027與商標承辦人員變更T-245219的委查流水號重疊
      If bolAdd = True Then
         'Modified by Lydia 2023/08/18 改用常數
         strQC = "select tqc01 from tmqcasemap where tqc01='" & strNo & "' and tqc03<>'" & cntTQC自動記錄 & "' "
         inQ = 1
         Set adoRecord = ClsLawReadRstMsg(inQ, strQC)
         If inQ = 1 Then
            GoTo ReGetNo
         Else
            'Modified by Lydia 2023/08/18 改用常數
            strQC = "insert into tmqcasemap (tqc01,tqc03,tqc04,tqc05,tqc06) values ('" & strNo & "','" & cntTQC自動記錄 & "','" & strUserNum & "',to_char(sysdate,'YYYYMMDD'),substr(lpad(to_char(sysdate,'hh24miss'),6,'0'),1,4))"
            cnnConnection.Execute strQC
            '每日批次刪除=>execDelSql.sql
         End If
      End If
      'end 2023/08/17
   '判斷是否要追加收文對照檔
   ElseIf iQC03 <> "" Then
      inQ = 1
      'Modified by Lydia 2023/08/18 +排除記錄
      strQC = "select * from tmqcasemap where tqc01='" & strNo & "' and tqc03='" & iQC03 & "' and tqc03<>'" & cntTQC自動記錄 & "' "
      Set adoRecord = ClsLawReadRstMsg(inQ, strQC)
      If inQ = 0 Then
         bolAdd = True
      End If
   End If
   
   PUB_GetTMQCaseMapNo = strNo
   Set adoRecord = Nothing
End Function

'Added by Lydia 2016/04/27 查名單電子化:櫃台收文輸入查名代號,輸出可做收文的委查單
'Modified by Lydia 2019/08/23 +strCP12
'Modified by Lydia 2024/03/14 是否彈訊息+bolMsg
Public Function PUB_TQCtoTMQ(ByVal bolMsg As Boolean, ByVal strCP12 As String, ByVal strCP13 As String, ByVal strTQC01 As String, ByRef strOut As String) As Boolean
Dim intC As Integer
Dim rsRD As New ADODB.Recordset
Dim strR As String


PUB_TQCtoTMQ = False
strOut = ""

If strCP13 = "" Then
   'Modified by Lydia 2024/03/14 +bolMsg
   If bolMsg = True Then MsgBox "請先輸入智權人員!", vbInformation
   GoTo JumpExit
Else
   'Modified by Lydia 2016/06/16 判斷撤回
   'strR = "SELECT TMQ01,TMQ02,ST02,TQC02 From TMQCASEMAP, TRADEMARKQUERY,STAFF,TMQAPP " & _
          "WHERE TQC01='" & strTQC01 & "' AND TQC03=TMQ01(+) AND TMQ02=ST01(+) AND TMQ18=TQA01(+) AND TQC07 IS NULL AND TQA20 IS NULL"
   'Modified by Lydia 2016/07/06 改TQC07
   'Modified by Lydia 2019/08/23 +ST15
   'Modified by Lydia 2023/08/18 +排除記錄
   'Added by Lydia 2024/03/14 增加收文前的檢查
   If Mid(strTQC01, 1, 1) = "B" Then
      strR = "SELECT TMQ01,TMQ02,ST02,'' AS TQC02,TQA20,ST15 From TRADEMARKQUERY,STAFF,TMQAPP " & _
             "WHERE TMQ01 IN (" & GetAddStr(Mid(strTQC01, 2)) & ") AND TMQ02=ST01(+) AND TMQ18=TQA01(+) "
      'Added by Lydia 2024/11/11 查名單(網中)：先行測試
      If strSrvDate(1) >= 查名單網中系統平行測試 Then
         strR = strR & "Union SELECT TMA01,TMA08,ST02,'' AS TQC02,TMA13,ST15 From TMQAPPFORM,STAFF " & _
                "WHERE TMA01 IN (" & GetAddStr(Mid(strTQC01, 2)) & ") AND TMA08=ST01(+) "
      End If
      'end 2024/11/11
   Else
   'end 2024/03/14
      strR = "SELECT TMQ01,TMQ02,ST02,TQC02,TQA20,ST15 From TMQCASEMAP,TRADEMARKQUERY,STAFF,TMQAPP " & _
             "WHERE TQC01='" & strTQC01 & "' and tqc03<>'" & cntTQC自動記錄 & "' AND TQC03=TMQ01(+) AND TMQ02=ST01(+) AND TMQ18=TQA01(+) AND NVL(TMQ01,'N')<>'N' "
      'Added by Lydia 2024/11/11 查名單(網中)：先行測試
      If strSrvDate(1) >= 查名單網中系統平行測試 Then
         strR = strR & "Union SELECT TMA01,TMA08,ST02,TQC02,TMA13,ST15 From TMQCASEMAP,TMQAPPFORM,STAFF " & _
                "WHERE TQC01='" & strTQC01 & "' and tqc03<>'" & cntTQC自動記錄 & "' AND TQC03=TMA01(+) AND TMA08=ST01(+) AND NVL(TMA01,'N')<>'N' "
      End If
      'end 2024/11/11
   End If
   intC = 1
   Set rsRD = ClsLawReadRstMsg(intC, strR)
   If intC = 1 Then
      rsRD.MoveFirst
      Do While Not rsRD.EOF
         If "" & rsRD.Fields("TQC02") <> "" Then
            'Modified by Lydia 2024/03/14 +bolMsg
            If bolMsg = True Then MsgBox "查名代號已收文 !", vbInformation
            GoTo JumpExit
         End If
         'Modified by Lydia 2019/08/23 WXX部門的人可以操作自己部門所有人的資料
         'If strCP13 <> rsRd.Fields("TMQ02") Then
         If Left(strCP12, 1) <> "W" And strCP13 <> rsRD.Fields("TMQ02") Then
            'Modified by Lydia 2016/06/16
            'MsgBox "查名代號的申請人(" & rsRd.Fields("ST02") & ")與接洽單的智權人員不同，請確認資料!", vbCritical
            'Modified by Lydia 2024/03/14 +bolMsg
            If bolMsg = True Then MsgBox "查名代號的申請人(" & rsRD.Fields("ST02") & ")與接洽單的智權人員不同，請確認輸入代號是否正確!", vbCritical
            GoTo JumpExit
         End If
         'Added by Lydia 2019/08/23 WXX部門的人可以操作自己部門所有人的資料
         If Left(strCP12, 1) = "W" And strCP12 <> "" & rsRD.Fields("ST15") Then
             'Modified by Lydia 2024/03/14 +bolMsg
             If bolMsg = True Then MsgBox "查名代號的申請人(" & rsRD.Fields("ST02") & ")與接洽單的收文部門不同，請確認輸入代號是否正確!", vbCritical
             GoTo JumpExit
         End If
         
         'Added by Lydia 2016/06/16
         If "" & rsRD.Fields("TQA20") = "Y" Then
            'Modified by Lydia 2024/03/14 +bolMsg
            If bolMsg = True Then MsgBox "查名代號勾選的委查單:" & rsRD.Fields("TMQ01") & " 已被申請人撤回，不可做收文!", vbInformation
            GoTo JumpExit
         End If
         'end 2016/06/16
         If Len(Trim("" & rsRD.Fields("TQC02"))) = 0 Then
            strOut = strOut & "+" & rsRD.Fields("TMQ01") & ","
         End If
         rsRD.MoveNext
      Loop
   Else
      'Modified by Lydia 2016/11/28 查名代號若未收文,只保留一個月
      'MsgBox "資料庫無資料 !", vbInformation
      'Modified by Lydia 2024/03/14 +bolMsg
      If bolMsg = True Then MsgBox "資料庫無資料,請注意接洽單的列印日期是否超過一個月 !", vbInformation
      GoTo JumpExit
   End If
End If

Set rsRD = Nothing
PUB_TQCtoTMQ = True

Exit Function

JumpExit:
   strOut = ""
   Exit Function
End Function

'Added by Lydia 2015/09/22 查名單電子化:將查名報告從查覆區搬到卷宗區(收文),或從卷宗區搬回查覆區(取消收文)
'Modified by Lydia 2016/05/25 +bJumpCP57:跳過已發文的判斷
'Modified by Lydia 2018/12/12 bolMove=>bChkCP143 更新-查名是否齊備
'Public Function PUB_TMQtoCP(ByVal iSavePath As String, iCp09 As String, iStrArra As String, iBatch As String, Optional ByVal bolMove As Boolean = False, Optional ByVal bJumpCP27 As Boolean = False) As Boolean
'Modify By Sindy 2022/9/27 + Optional bolTrans As Boolean = True : 要下Connection Trans的判斷
'Modified by Lydia 2024/03/14 是否彈訊息+bolMsg
Public Function PUB_TMQtoCP(ByVal bolMsg As Boolean, ByVal iSavePath As String, iCp09 As String, iStrArra As String, iBatch As String, _
                           Optional ByVal bChkCP143 As Boolean = False, Optional ByVal bJumpCP27 As Boolean = False, _
                           Optional bolTrans As Boolean = True) As Boolean

'iSavePath = 儲存路徑
'iCP09 = 收文號, 櫃台收文要到進度檔產生後才有收文號
'iStrArrA = +/-委查單號 (以,區隔不同張委查單,前綴的+或-表示收文或取消收文)
'iBatch=查名代號 ,D=刪除案件進度(整批還原)
Dim SNo As String, sAct As String
Dim C01 As String, C02 As String, C03 As String, C04 As String, C10 As String
Dim strM As String
Dim tmpArr As Variant
Dim inA As Integer, inB As Integer, inC As Integer
Dim SaveTxt As String, exSQL As String
Dim rsAD As New ADODB.Recordset
Dim intQ As Integer 'Added by Lydia 2024/05/06
Dim stFName As String
Dim fs, f
Dim stReName As String
Dim strFile As String
Dim strSecName As String
   
Dim bytes() As Byte
Dim adoRst As New ADODB.Recordset
Dim file_num1 As Integer
'Added by Lydia 2016/04/06
Dim bolNewRec As Boolean '是否新增收文對照檔
Dim strTQC01 As String '查名代號
Dim FirstCP09 As String '第一次收文=TMQ21 'Memo by Lydia 2024/11/11 查名單(網中)：TMA34
Dim strUpd As String ' 記錄需重整收文號
'Added by Lydia 2019/01/30
Dim strDate As String
Dim bolBegin As Boolean 'Added by Lydia 2020/02/11

PUB_TMQtoCP = False
strUpd = ""

   If iCp09 <> "" And iStrArra <> "" Then
      strSql = " select cp01,cp02,cp03,cp04,cp10,cp12,cp13,cp14,cp27 from caseprogress where cp09='" & iCp09 & "' and cp57 is null "
      inA = 1
      Set rsAD = ClsLawReadRstMsg(inA, strSql)
      If inA = 0 Then
         'Modified by Lydia 2024/03/14 +bolMsg
         If bolMsg = True Then MsgBox "尚未有收文號或已取消收文!", vbCritical
         Exit Function
      Else
         'Modified by Lydia 2016/05/25
         'If Not IsNull(rsAD.Fields("CP27")) Then
         If Not IsNull(rsAD.Fields("CP27")) And bJumpCP27 = False Then
            'Modified by Lydia 2024/03/14 +bolMsg
            If bolMsg = True Then MsgBox "收文號已發文不可變更!", vbCritical
            Exit Function
         End If
         C01 = rsAD.Fields("CP01")
         C02 = rsAD.Fields("CP02")
         C03 = rsAD.Fields("CP03")
         C04 = rsAD.Fields("CP04")
         C10 = rsAD.Fields("CP10")
      End If
      
      tmpArr = Split(iStrArra, ",")
      SaveTxt = ""

      '先判斷卷宗區是否有記錄
      For inC = 0 To UBound(tmpArr)
         If Left(tmpArr(inC), 1) = "+" Then
            'Modified by Lydia 2016/05/31 改成以menu(查名單主檔)來判斷,在附件搬到卷宗區時先做刪除(ex.發生櫃台未輸入查名代號,卻有部份結果加到卷宗區)
            'strSql = "SELECT cpp01 FROM casepaperpdf WHERE cpp01 ='" & iCP09 & "' and instr(upper(cpp02),'" & Mid(TmpArr(inC), 2) & "') > 0 "
            strSql = "SELECT cpp01 FROM casepaperpdf WHERE cpp01 ='" & iCp09 & "' and instr(upper(cpp02),'" & Mid(tmpArr(inC), 2) & "') > 0 and instr(upper(cpp02),'" & UCase(TMQ_查名作業 & ".menu") & "') > 0 "
            inA = 1
            Set rsAD = ClsLawReadRstMsg(inA, strSql)
            If inA = 1 Then
               'Modified by Lydia 2024/03/14 +bolMsg
               If bolMsg = True Then MsgBox rsAD.Fields("CPP01") & " 已有" & Mid(tmpArr(inC), 2) & " 查名報告", vbCritical
               Exit Function
            End If
         End If
      Next inC
      
      inC = 0
      For inA = 0 To UBound(tmpArr)
          If tmpArr(inA) <> "" Then
             sAct = Mid(tmpArr(inA), 1, 1)
             SNo = Mid(tmpArr(inA), 2, Len(tmpArr(inA)) - 1)
             strSql = " select tmq01,tmq11,tmq18,tmq19,tmq21,nvl(cnt1,0) cnt1 from trademarkquery,(select tqf02,count(*) cnt1 from tmqfile where tqf02>'H' and tqf05='" & UCase(TMQ_查名作業 & ".pdf") & "' group by tqf02) where tmq01='" & SNo & "' and tmq01=tqf02(+) "
             'Added by Lydia 2024/11/11 查名單(網中)：先行測試
             If strSrvDate(1) >= 查名單網中系統平行測試 Then
                strSql = strSql & " union select tma01,tma14,tma01 as tmq18,'Y' as tmq19,tma34,nvl(cnt1,0) cnt1 from tmqappform,(select tmf01,count(*) cnt1 from tmqappfile where tmf01='" & SNo & "' and instr(upper(tmf10),'.PDF') > 0 group by tmf01) where tma01='" & SNo & "' and tma01=tmf01(+) "
             End If
             'end 2024/11/11
             inB = 1
             Set rsAD = ClsLawReadRstMsg(inB, strSql)
             If inB = 0 Then
                'Modified by Lydia 2024/03/14 +bolMsg
                If bolMsg = True Then MsgBox "委查單號 " & SNo & " 查無資料!", vbCritical
                Exit Function
             End If
             'Modified by Lydia 2016/03/28 控制是否已查覆完畢
             If TMQ_CtrRead And IsNull(rsAD.Fields("tmq19")) Then
                 'Modified by Lydia 2024/03/14 +bolMsg
                 If bolMsg = True Then MsgBox "尚未讀取委查單號 " & SNo & " 的查名報告，請確認資料!", vbCritical
                 Exit Function
             End If
             
             'Added by Lydia 2016/04/07 讀取第一次收文號
             'Modified by Lydia 2016/08/22
             'If IsNull(rsAD.Fields("tmq21")) Then
             If Trim("" & rsAD.Fields("tmq21")) = "" Then
                FirstCP09 = iCp09
             Else
                FirstCP09 = rsAD.Fields("tmq21")
             End If
             
             'Added by Lydia 2016/04/06 讀取查名代號
             If iBatch <> "D" And Len(iBatch) = 9 Then
                strTQC01 = iBatch: bolNewRec = False
             Else
                'Modified by Lydia 2019/05/21
                'strExc(0) = PUB_GetTMQCaseMapNo(IIf(FirstCP09 = iCp09, FirstCP09, iCp09), SNo, bolNewRec)
                'If strTQC01 = "" Then strTQC01 = strExc(0)
                If strTQC01 = "" Then
                    strTQC01 = PUB_GetTMQCaseMapNo(IIf(FirstCP09 = iCp09, FirstCP09, iCp09), SNo, bolNewRec)
                End If
                'end 2019/05/21
             End If

             'Modified by Lydia 2016/03/28 無結果附件,或第2次收文
             'Modified by Lydia 2016/06/23 改放在FTP,所以檔案不用移動
             'If rsAD.Fields("cnt1") = 0 Or FirstCP09 <> iCP09 Then
             'Modified by Lydia 2016/07/07
             'If rsAD.Fields("cnt1") = 0 Or FirstCP09 <> iCP09 Or strSrvDate(1) >= TMQFileFTP Then
             If strSrvDate(1) >= TMQFileFTP Then
                'Modified by Lydia 2022/05/17 案號補足6碼
                'strFile = Trim(C01) & CStr(Val(C02)) & IIf(C03 <> "0" Or C04 <> "00", "-" & C03, "") & IIf(C04 <> "00", "-" & C04, "")
                strFile = Trim(C01) & Format(C02, "000000") & IIf(C03 <> "0" Or C04 <> "00", "-" & C03, "") & IIf(C04 <> "00", "-" & C04, "")
                strM = strFile & "." & Trim(C10) & "." & SNo & "." & TMQ_查名作業 & ".menu"
                'Added by Lydia 2016/04/08 改用模組處理
                exSQL = PUB_TMQtoCaseMapStr(sAct, strTQC01, strM, SNo, FirstCP09, iCp09, bolNewRec, strUpd)
                'Modified by Lydia 2016/08/22
                'saveTxt = saveTxt & exSQL & ";"
                SaveTxt = SaveTxt & exSQL
                
             'Remove by Lydia 2016/07/07
             'Else
             '  'Modified by Lydia 2016/03/28 有結果附件(第一次收文會在DB與卷宗區間搬移檔案)
             '    strSql = "select tqf01,tqf02,tqf03,tqf04,tqf05,tqf06 from tmqfile where tqf02='" & sNO & "' and tqf05='" & UCase(TMQ_查名作業 & ".pdf") & "' "
             '    inB = 1
             '    Set rsAD = ClsLawReadRstMsg(inB, strSql)
             '    rsAD.MoveFirst
             '    Do While Not rsAD.EOF
             '  '-----------下載附件 BEGIN
             '       stFName = rsAD.Fields("TQF02") & rsAD.Fields("TQF03") & rsAD.Fields("TQF04") & "." & rsAD.Fields("TQF05")
             '       strFile = Trim(C01) & CStr(Val(C02)) & IIf(C03 <> TMQ_附件F02 Or C04 <> TMQ_附件F04, "-" & C03, "") & IIf(C04 <> TMQ_附件F04, "-" & C04, "")
             '       strFile = strFile & "." & Trim(C10) & "." & stFName
             '
             '       If sAct = "+" Then '收文
             '          '讀取DB -> 檔符合卷宗區命名
             '          If PUB_TMQGetAFile("", iSavePath & "\" & strFile, rsAD.Fields("TQF01"), rsAD.Fields("TQF02"), rsAD.Fields("TQF03"), rsAD.Fields("TQF04"), rsAD.Fields("TQF05")) = False Then
             '             Exit Function
             '          End If
             '       ElseIf sAct = "-" Then '取消收文
             '          '讀取FTP -> 檔名依照TQF的PK
             '          If PUB_GetAttachFile_CPP(FirstCP09, strFile, iSavePath & "\" & stFName, True) = False Then
             '             Exit Function
             '          Else
             '             strFile = stFName
             '          End If
             '       End If
             '
             '       strFile = iSavePath & "\" & strFile
             '       Set fs = CreateObject("Scripting.FileSystemObject")
             '       Set f = fs.GetFile(strFile)
             '       If f.Size = 0 Then
             '          ShowMsg strFile & MsgText(9221)
             '          Exit Function
             '       End If
             '  '-----------下載附件 END
          ''---------檔案移動 BEGIN
             '       strFile = Trim(C01) & CStr(Val(C02)) & IIf(C03 <> "0" Or C04 <> "00", "-" & C03, "") & IIf(C04 <> "00", "-" & C04, "")
             '       strFile = strFile & "." & Trim(C10) & "." & stFName
             '       '查覆明細作業->表單
             '       StrM = Mid(strFile, 1, InStr(strFile, "." & TMQ_查名作業) - 4) & "." & TMQ_查名作業 & ".menu"
             '     '收文:從DB搬到卷宗區
             '     If sAct = "+" Then
             '       '檢查檔名規則
             '       If PUB_ChkEmpFlowFNMRule(C01 & "-" & C02 & "-" & C03 & "-" & C04, strFile, "Y", C10, , , False, , , strSecName) = False Then
             '          Exit Function
             '       End If
             '       If PUB_GetEmpFlowReNameFile(C01, C02, C03, C04, C10, strFile, stReName, True, 1, , , FirstCP09, strSecName) = False Then Exit Function
             '          'Added by Lydia 2016/05/31 搬到卷宗區時先做刪除(ex.發生櫃台未輸入查名代號,卻有部份結果加到卷宗區)
             '           If DelAttFile_PDF(C01 & "-" & C02 & "-" & C03 & "-" & C04, FirstCP09, strFile) = False Then
             '           End If
             '          'end 2016/05/31
             '          strFile = iSavePath & "\" & strFile
             '          '存檔
             '          If SaveAttFile_PDF(FirstCP09, strFile, stReName, Format(f.DateLastModified, "YYYYMMDD"), Format(f.DateLastModified, "HHMMSS"), False, "A") = False Then
             '             Exit Function
             '          End If
             '          Call PUB_DelPCOrgFile(strFile) '一併將PC上的實體檔案刪除
             '
             '            If rsAD.AbsolutePosition = 1 Then
             '               'Added by Lydia 2016/04/08 改用模組處理
             '               exSQL = PUB_TMQtoCaseMapStr(sAct, strTQC01, StrM, sNO, FirstCP09, iCP09, bolNewRec, strUpd)
             '               saveTxt = saveTxt & exSQL & ";"
             '            End If
             '            'Modified by Lydia 2016/04/06 記錄CPP02
             '            'exsql = "update tmqfile set tqf07=null where tqf01='" & rsAD.Fields("TQF01") & "' and tqf02='" & rsAD.Fields("TQF02") & "' and tqf03='" & rsAD.Fields("TQF03") & "' and tqf04='" & rsAD.Fields("TQF04") & "' "
             '            If FirstCP09 = iCP09 Then
             '               exSQL = "update tmqfile set tqf07=null,tqf12='" & Trim(Replace(strFile, iSavePath & "\", "")) & "' where tqf01='" & rsAD.Fields("TQF01") & "' and tqf02='" & rsAD.Fields("TQF02") & "' and tqf03='" & rsAD.Fields("TQF03") & "' and tqf04='" & rsAD.Fields("TQF04") & "' "
             '               saveTxt = saveTxt & exSQL & ";"
             '            End If
             '     '收文:從卷宗區搬到DB
             '     ElseIf sAct = "-" Then
             '            If rsAD.AbsolutePosition = 1 Then
             '               'Added by Lydia 2016/04/08 改用模組處理
             '               exSQL = PUB_TMQtoCaseMapStr(sAct, strTQC01, StrM, sNO, FirstCP09, iCP09, bolNewRec, strUpd)
             '               saveTxt = saveTxt & exSQL & ";"
             '            End If
             '            If FirstCP09 = iCP09 Then
             '               If DelAttFile_PDF(C01 & "-" & C02 & "-" & C03 & "-" & C04, FirstCP09, strFile) = False Then
             '                  Exit Function
             '               End If
             '               exSQL = "SAVE " & stFName
             '               saveTxt = saveTxt & exSQL & ";"
             '            End If
             '     End If
          ''---------檔案移動 END
             '    rsAD.MoveNext
             '    Loop
             'end Remove by Lydia 2016/07/07
             End If
          End If
      Next inA
      
      '整批處理查名區DB
      If Len(SaveTxt) > 0 Then
        tmpArr = Empty
        tmpArr = Split(SaveTxt, ";")
      On Error GoTo ErrToCP
        
        'Modify By Sindy 2022/9/27
        If bolTrans = True Then
        '2022/9/27 END
            cnnConnection.BeginTrans
        End If
        For inB = 0 To UBound(tmpArr)
          If tmpArr(inB) <> "" Then
             If bolBegin = False Then bolBegin = True 'Added by Lydia 2020/02/11
             
             If InStr(tmpArr(inB), "SAVE") = 0 Then
                 cnnConnection.Execute tmpArr(inB), intQ
             Else
             'Remove by Lydia 2016/07/07
             '  'TS.PDF從卷宗區搬到DB
             '  strExc(1) = Mid(TmpArr(inB), 6, Len(TmpArr(inB)) - 5)
             '  strExc(2) = Mid(strExc(1), 1, 9)
             '  strExc(3) = Mid(strExc(1), 10, 1)
             '  strExc(4) = Mid(strExc(1), 11, Len(TMQ_附件F04)) 'TQF04
             '  strExc(5) = Mid(strExc(1), InStr(strExc(1), UCase(TMQ_查名作業) & "."))
             '  If adoRst.State <> adStateClosed Then adoRst.Close
             '  '----------------------------
             '      Set adoRst = Nothing
             '       adoRst.CursorLocation = adUseClient
             '       adoRst.Open "select * from TMQFile where TQF02='" & strExc(2) & "' AND TQF03='" & strExc(3) & "' AND TQF04='" & strExc(4) & "' AND TQF05='" & strExc(5) & "' ", cnnConnection, adOpenStatic, adLockOptimistic
             '
             '       file_num1 = FreeFile
             '       Open iSavePath & "\" & strExc(1) For Binary Access Read As #file_num1
             '       ReDim bytes(LOF(file_num1))
             '
             '       Get #file_num1, , bytes()
             '       adoRst.Fields("TQF07").AppendChunk bytes() '附件寫回DB
             '       adoRst.Fields("TQF12").Value = Null 'Added by Lydia 2016/04/06 清空CPP02
             '       adoRst.UPDATE
             '       Close #file_num1
             '  '----------------------------
             End If
          End If
        Next inB
        'Added by Lydia 2016/08/22 檢查TMQ21是否沒有更新到
        'Modified by Lydia 2023/08/18 +排除記錄
        strSql = "update trademarkquery set tmq21='" & iCp09 & "' where NVL(TMQ21,'N')='N' and tmq01 in (select tqc03 from tmqcasemap where tqc02='" & iCp09 & "' and tqc03<>'" & cntTQC自動記錄 & "') "
        cnnConnection.Execute strSql, intQ
        'Added by Lydia 2024/11/11 查名單(網中)：先行測試
        If strSrvDate(1) >= 查名單網中系統平行測試 Then
           strSql = "update tmqappform set tma34='" & iCp09 & "' where NVL(TMA34,'N')='N' and tma01 in (select tqc03 from tmqcasemap where tqc02='" & iCp09 & "' and tqc03<>'" & cntTQC自動記錄 & "') "
           cnnConnection.Execute strSql, intQ
        End If
        'end 2024/11/11
        
        'Added by Lydia 2018/12/10 增加判斷查名是否齊備
        If strSrvDate(1) >= T案收文齊備啟用日 And bChkCP143 = True Then
            '更新查名齊備日(CP143)
            strM = PUB_TMQchkCP143(iCp09)
            strSql = "update caseprogress set cp143= " & IIf(strM = "Y", strSrvDate(1), IIf(strM = "N", "0", "Null")) & _
                       " where cp09='" & iCp09 & "' " & IIf(strM = "Y", " and nvl(cp143,0)=0 ", "")
            cnnConnection.Execute strSql
            
            'Added by Lydia 2019/01/30 文件+查名齊備=>更新承辦期限
            'Modified by Lydia 2019/04/19
            'strSql = "select cp09,cp06,cp13,cp14,cp48,cp122,cp143,cp158,cp159,ep06 from caseprogress, engineerprogress where cp09='" & iCp09 & "' and cp09=ep02(+) "
            'Modified by Lydia 2020/02/10 +TS案 (TS-001775後補委查結果)
            'strSql = "select cp09,cp10,cp06,cp13,cp14,cp48,cp122,cp143,cp158,cp159,ep06,tm01,tm10 " & _
                        "from caseprogress, engineerprogress,trademark where cp09='" & iCp09 & "' and cp09=ep02(+) and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+) "
            strSql = "select cp09,cp10,cp06,cp13,cp14,cp48,cp122,cp143,cp158,cp159,ep06,nvl(tm01,sp01) tm01,nvl(tm10,sp09) tm10  " & _
                        "from caseprogress, engineerprogress,trademark,servicepractice  where cp09='" & iCp09 & "' and cp09=ep02(+) and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+) and cp01=sp01(+) and cp02=sp02(+) and cp03=sp03(+) and cp04=sp04(+)"
            inA = 1
            Set rsAD = ClsLawReadRstMsg(inA, strSql)
            If inA = 1 Then
                 If "" & rsAD.Fields("CP14") <> "" And Val("" & rsAD.Fields("EP06")) > 0 And "" & rsAD.Fields("CP158") = "0" And "" & rsAD.Fields("CP159") = "0" Then
                     '文件+查名齊備
                     If strM = "Y" Then
                         '追加已完成的查名單, 不變更原承辦期限(by嘉雯)
                         'Modified by Lydia 2019/04/19 承辦期限以齊備日+案件性質所設工作天數
                          'strDate = PUB_TMdebateCountCP48("" & rsAD.Fields("CP06"), "" & rsAD.Fields("CP122"), "" & rsAD.Fields("EP06"), iCp09, "" & rsAD.Fields("CP13"))
                          strDate = Pub_GetHandleDay("" & rsAD.Fields("tm01"), "" & rsAD.Fields("tm10"), "" & rsAD.Fields("cp10"), strSrvDate(1), "" & rsAD.Fields("CP06"), "" & rsAD.Fields("CP09"))
                          If strDate <> "" Then 'Added by Lydia 2020/02/11
                            strSql = "update CaseProgress SET CP48=" & strDate & " WHERE CP09='" & iCp09 & "' and nvl(cp48,0)=0 "
                            cnnConnection.Execute strSql
                          End If
                     Else
                         '追加未完成的查名單, 取消原承辦期限
                         strSql = "update CaseProgress SET CP48=null WHERE CP09='" & iCp09 & "'"
                         cnnConnection.Execute strSql
                     End If
                 End If
            End If
            'end 2019/01/30
            
            'Added by Lydia 2019/12/12 查名單近似本所案經核可後，設定" 是否出名 "=2不出名，更新進度檔
            strM = Pub_ChkTQD11(iCp09, C01)
            If Left(C01, 1) = "2" Then
                strSql = "Update CaseProgress SET CP22='N',CP110=NULL WHERE CP22 IS NULL AND CP09='" & iCp09 & "' "
                cnnConnection.Execute strSql
            Else
                strSql = "Update CaseProgress SET CP22=NULL WHERE CP22 IS NULL AND CP09='" & iCp09 & "' AND CP22='N' "
                cnnConnection.Execute strSql
            End If
            'end 2019/12/12
        End If
        'end 2018/12/10
        
        'Modify By Sindy 2022/9/27
        If bolTrans = True Then
        '2022/9/27 END
            cnnConnection.CommitTrans
        End If
      End If
      
      PUB_TMQtoCP = True
      'Remove by Lydia 2016/07/07
      '重整收文的卷宗區
      'If strSrvDate(1) < TMQFileFTP Then 'Added by Lydia 2016/06/23
      '  If Len(strUpd) > 10 And bolMove = False Then
      '     TmpArr = Empty
      '     TmpArr = Split(strUpd, ";")
      '     For inC = 0 To UBound(TmpArr)
      '        If Len(TmpArr(inC)) > 10 Then
      '           '"|"區隔收文號和要收的委查單
      '           If PUB_TMQtoCP(iSavePath, Mid(TmpArr(inC), 1, InStr(TmpArr(inC), "|") - 1), Mid(TmpArr(inC), InStr(TmpArr(inC), "|") + 1), "", True) = False Then
      '           End If
      '        End If
      '     Next inC
      '  End If
      'End If
   Else
      If iCp09 = "" Then
         'Modified by Lydia 2024/03/14 +bolMsg
         If bolMsg = True Then MsgBox "尚未有收文號!", vbCritical
      Else
         'Modified by Lydia 2024/03/14 +bolMsg
         If bolMsg = True Then MsgBox "委查結果無變更!", vbCritical
      End If
      Exit Function
   End If
   
ErrToCP:
   If Err.Number <> 32755 And Err.Number > 0 Then
      If bolBegin = True Then
         'Modify By Sindy 2022/9/27
         If bolTrans = True Then
         '2022/9/27 END
            cnnConnection.RollbackTrans 'Added by Lydia 2020/02/10
         End If
      End If
      MsgBox Err.Description, vbCritical + vbOKOnly, "委查結果存檔失敗"
   End If
End Function

'Added by Lydia 2016/04/08 取得更新收文對照檔,TMQ21,卷宗區(TS.menu)
Public Function PUB_TMQtoCaseMapStr(ByVal sAct As String, ByVal strTQC01, ByVal strM As String, ByVal SNo As String, ByVal FirstCP09, ByVal iCp09 As String, ByVal bolNew As Boolean, ByRef strUpd As String) As String
Dim inD As Integer
Dim rsD1 As New ADODB.Recordset
Dim exSQL As String
Dim strDetail As String

    If sAct = "+" Then '收文
       '新增收文對照檔
       If bolNew Then
          exSQL = "insert into tmqcasemap(tqc01,tqc02,tqc03,tqc04,tqc05,tqc06)" & _
                   " values('" & strTQC01 & "','" & iCp09 & "','" & SNo & "','" & strUserNum & "'," & strSrvDate(1) & "," & Left(Format(ServerTime, "000000"), 4) & ") "
          strDetail = strDetail & exSQL & ";"
       Else
          'Modified by Lydia 2016/07/06 改TQC07為通知送件日
          'exSQL = "update tmqcasemap set tqc02='" & iCP09 & "' where tqc01='" & strTQC01 & "' and tqc02 is null and tqc03='" & sNO & "' "
          'Modified by Lydia 2023/08/18 +排除記錄
          exSQL = "update tmqcasemap set tqc02='" & iCp09 & "',tqc07=null where tqc01='" & strTQC01 & "' and tqc03='" & SNo & "' and tqc03<>'" & cntTQC自動記錄 & "' "
          strDetail = strDetail & exSQL & ";"
       End If
       If FirstCP09 = iCp09 Then
          'Modified by Lydia 2016/07/07
          'exSQL = "update trademarkquery set tmq21='" & FirstCP09 & "',tmq20=null where tmq01='" & sNO & "' and NVL(TMQ21,'N')='N' "
          exSQL = "update trademarkquery set tmq21='" & FirstCP09 & "' where tmq01='" & SNo & "' and NVL(TMQ21,'N')='N' "
          strDetail = strDetail & exSQL & ";"
          'Added by Lydia 2024/11/11 查名單(網中)：先行測試
          If strSrvDate(1) >= 查名單網中系統平行測試 Then
             exSQL = "update tmqappform set tma34='" & FirstCP09 & "' where tma01='" & SNo & "' and NVL(TMA34,'N')='N' "
             strDetail = strDetail & exSQL & ";"
          End If
          'end 2024/11/11
       End If

       '新增TS.menu 至卷宗區
       exSQL = "insert into casepaperpdf(cpp01,cpp02,cpp03,CPP05,CPP06,CPP07,cpp08,cpp09,cpp10)" & _
           " values('" & iCp09 & "','" & strM & "',0,'" & strUserNum & "'," & strSrvDate(1) & "," & Right("000000" & ServerTime, 6) & "," & strSrvDate(1) & "," & Right("000000" & ServerTime, 6) & ",'Y')"
       strDetail = strDetail & exSQL & ";"
    ElseIf sAct = "-" Or sAct = "D" Then '取消收文 , D=刪除案件進度
         '因為卷宗區是依據第一次收文號擺放,若刪除第一次收文的結果
         'Modified by Lydia 2016/06/23
         'If FirstCP09 = iCP09 Then
         'Modified by Lydia 2016/07/06
         'If FirstCP09 = iCP09 And strSrvDate(1) < TMQFileFTP Then
         '   inD = 1
         '   exSQL = "select TQC01,TQC02,cp01,cp02,cp03,cp04,cp09,cp10 from tmqcasemap,caseprogress where tqc07 is null and tqc03='" & sNO & "' and tqc02<>'" & FirstCP09 & "' and tqc02=cp09(+) and cp57 is null order by cp09"
         '   Set rsD1 = ClsLawReadRstMsg(inD, exSQL)
         '   If inD = 1 Then
         '      '先刪除要重做之收文號的menu
         '      exSQL = "delete from casepaperpdf where cpp01='" & rsD1.Fields("TQC02") & "' and instr(upper(cpp02),'" & UCase(sNO & "." & TMQ_查名作業 & ".menu") & "')> 0"
         '      strDetail = strDetail & exSQL & ";"
         '      '記錄需重做收文(卷宗區改放在第2次收文的案件),"|"區隔收文號和要收的委查單
         '      strUpd = strUpd & rsD1.Fields("TQC02") & "|+" & sNO & ";"
         '   End If
         '   exSQL = "update trademarkquery set tmq21=null where tmq01='" & sNO & "' "
         '   strDetail = strDetail & exSQL & ";"
         'End If
         If FirstCP09 = iCp09 Then
            'Added by Lydia 2019/05/21 判斷有無其他案件勾這張查名單 ; ex. T-221600和T-221601先填接洽單後勾查名單
            'Modified by Lydia 2023/08/18 +排除記錄
            exSQL = "select tqc02 from tmqcasemap where nvl(tqc02,'N') <>'" & iCp09 & "' and tqc02 is not null and tqc03='" & SNo & "' and tqc03<>'" & cntTQC自動記錄 & "' order by tqc05 asc, tqc06 asc "
            inD = 1
            Set rsD1 = ClsLawReadRstMsg(inD, exSQL)
            If inD = 1 Then
               exSQL = "update trademarkquery set tmq21='" & rsD1.Fields("tqc02") & "' where tmq01='" & SNo & "' "
               strDetail = strDetail & exSQL & ";"
               'Added by Lydia 2024/11/11 查名單(網中)：先行測試
               If strSrvDate(1) >= 查名單網中系統平行測試 Then
                  exSQL = "update tmqappform set tma34='" & rsD1.Fields("tqc02") & "' where tma01='" & SNo & "' "
                  strDetail = strDetail & exSQL & ";"
               End If
               'end 2024/11/11
            Else
            'end 2019/05/21
               exSQL = "update trademarkquery set tmq21=null where tmq01='" & SNo & "' "
               strDetail = strDetail & exSQL & ";"
               'Added by Lydia 2024/11/11 查名單(網中)：先行測試
               If strSrvDate(1) >= 查名單網中系統平行測試 Then
                  exSQL = "update tmqappform set tma34=null where tma01='" & SNo & "' "
                  strDetail = strDetail & exSQL & ";"
               End If
            End If 'end 2019/05/21
            
         End If
         'end 2016/07/06
         
         '清空收文對照檔
         'Modified by Lydia 2016/07/06 刪除不留記錄
          'exSQL = "update tmqcasemap set tqc07='N' where tqc01='" & strTQC01 & "' and tqc03='" & sNO & "' "
          exSQL = "delete from tmqcasemap where tqc01='" & strTQC01 & "' and tqc03='" & SNo & "' "
          strDetail = strDetail & exSQL & ";"
         '刪除TS.menu
         exSQL = "DELETE FROM casepaperpdf WHERE CPP01='" & iCp09 & "' and upper(cpp02)=upper('" & ChgSQL(strM) & "')"
         strDetail = strDetail & exSQL & ";"
    End If
    
    PUB_TMQtoCaseMapStr = strDetail
    Set rsD1 = Nothing
End Function

'Added by Lydia 2015/09/22 查名單電子化:讀取DB附件檔
Public Function PUB_TMQGetAFile(ByRef pSavePath As String, pFileName As String, iD01 As String, iD02 As String, iD03 As String, iD04 As String, iD05 As String) As Boolean
   Dim stAttPath As String
   Dim lngSize As Long
   Dim iFileNo As Integer
   Dim bytes() As Byte
   Dim Rs2 As New ADODB.Recordset
   Dim intQ As Integer, strQuery As String 'Added by Lydia 2024/05/06
   Dim strTT As String 'Added by Lydia 2016/06/23
On Error GoTo ErrHnd

   '預設路徑
   If pSavePath <> "" Then
      If Dir(pSavePath, vbDirectory) = "" Then
         MkDir pSavePath
      End If
      'Modified by Lydia 2016/06/23
      'stAttPath = pSavePath & "\" & iD02 & iD03 & iD04 & "." & iD05
      stAttPath = pSavePath & "\" & IIf(iD02 = "0", iD01, "") & iD02 & iD03 & iD04 & "." & iD05
   Else
      '傳入完整檔案路徑
      stAttPath = pFileName
   End If
    '檔案已存在時
    If Dir(stAttPath) <> "" Then
       '檢查檔案是否正在使用中
       If PUB_ChkFileOpening(stAttPath) = True Then
          MsgBox stAttPath & vbCrLf & "檔案正在使用中（請關閉），方可繼續操作。", vbExclamation
          Exit Function
       End If
       SetAttr stAttPath, vbNormal 'Added by Lydia 2020/03/19 預設檔案為正常
       Kill stAttPath
    End If

   strQuery = "select * from TMQFILE where TQF01='" & iD01 & "' and TQF02='" & iD02 & "' and TQF03='" & iD03 & "' and TQF04='" & iD04 & "' "
   intQ = 1
   Set Rs2 = ClsLawReadRstMsg(intQ, strQuery)
   If intQ = 1 Then
      'Modified by Lydia 2016/06/23 改放在FTP
      strTT = "" & Rs2.Fields("TQF12")
      
      'Removed by Morgan 2025/3/27 已都在查名單區
      'If strTT = "" Then '最初放在DB
      '    With Rs2
      '    lngSize = Val(.Fields("TQF06").Value)
      '    ReDim bytes(lngSize)
      '    If lngSize > 0 Then bytes() = .Fields("TQF07").GetChunk(lngSize)
      '    End With
      '    iFileNo = FreeFile
      '    Open stAttPath For Binary Access Write As #iFileNo
      '    If lngSize > 0 Then Put #iFileNo, , bytes()
      '    Close #iFileNo
      '
      '    pFileName = stAttPath
      '    PUB_TMQGetAFile = True
      '
      'ElseIf Left(strTT, 1) = "T" Then  '收文後放在卷宗區
      '    strQuery = "select cpp14 from casepaperpdf where upper(cpp02)='" & UCase(strTT) & "' "
      '    intQ = 1
      '    Set Rs2 = ClsLawReadRstMsg(intQ, strQuery)
      '    If intQ = 1 Then
      '       strTT = "" & Rs2(0)
      '       pFileName = stAttPath
      '       PUB_TMQGetAFile = PUB_GetFtpFile(strTT, stAttPath)
      '
      '       pFileName = stAttPath
      '       PUB_TMQGetAFile = True
      '    End If
      'end 2025/3/27
      'ElseIf Left(strTT, 1) = "H" Then  'Mark by Lydia 2016/06/23  TMQFileFTP以後全在查名單區
      'end 2025/3/27
      
           pFileName = stAttPath
           PUB_TMQGetAFile = PUB_GetFtpFile(strTT, stAttPath, "TMQFILE")
      
           pFileName = stAttPath
           PUB_TMQGetAFile = True
           
      'End If 'Removed by Morgan 2025/3/27

   End If
   
   Exit Function

ErrHnd:
   MsgBox Err.Description, vbCritical
   If iFileNo > 0 Then Close #iFileNo
End Function

'Added by Lydia 2015/11/25 查名單電子化:儲存查名作業的附件內容(先刪除,後寫入)
Public Function PUB_TMQAFileSave(ByVal fID01 As String, fID02 As String, fID03 As String, fID04 As String, fID05 As String, sfFileName As String, Optional fRead As String) As Boolean
'fID01:申請編號
'fID02:委查單號
'fID03:0-圖形,1-文字1,2-文字2
'fID04:流水號
'fID05:檔案類型
'sfFileName:完整檔案來源路徑
'fRead:附件已讀上N
Dim bytes() As Byte
Dim adoRst As New ADODB.Recordset
Dim sf1 As Integer
Dim intA As Integer
Dim strFtpPath As String 'Added by Lydia 2016/06/23

On Error GoTo ErrHand

cnnConnection.BeginTrans
    
    'Modified by Lydia 2016/06/23
    'Remove by Lydia 2016/07/07
    'If strSrvDate(1) < TMQFileFTP Then
    '   strExc(0) = "delete from TMQFILE where TQF01='" & fID01 & "' AND TQF02='" & fID02 & "' AND TQF03='" & fID03 & "' AND TQF04='" & fID04 & "'"
    '   cnnConnection.Execute strExc(0), IntA
    'Else
       '先刪除在FTP的附件,後刪除記錄
       If PUB_TMQAFileDel(fID01, fID02, fID03, fID04) Then
       End If
    'End If
    ''end 2016/06/23
    
    If adoRst.State <> adStateClosed Then adoRst.Close
    Set adoRst = Nothing
     adoRst.CursorLocation = adUseClient
     adoRst.Open "select * from TMQFile where 1=0", cnnConnection, adOpenStatic, adLockOptimistic
     
     sf1 = FreeFile
     Open sfFileName For Binary Access Read As #sf1
     ReDim bytes(LOF(sf1))
     
     Get #sf1, , bytes()
     adoRst.AddNew
     adoRst.Fields("TQF01").Value = Trim(fID01)
     adoRst.Fields("TQF02").Value = Trim(fID02)
     adoRst.Fields("TQF03").Value = Trim(fID03)
     adoRst.Fields("TQF04").Value = Trim(fID04)
     '直接存檔案類型
     adoRst.Fields("TQF05").Value = UCase(Trim(fID05))
     adoRst.Fields("TQF06").Value = Trim(LOF(sf1))
     'Modified by Lydia 2016/06/23 改放FTP
     'Remove by Lydia 2016/07/07
     'If strSrvDate(1) < TMQFileFTP Then adoRst.Fields("TQF07").AppendChunk bytes()
     
     adoRst.Fields("TQF08").Value = strUserNum
     adoRst.Fields("TQF09").Value = Val(strSrvDate(1))
     adoRst.Fields("TQF10").Value = Val(Format(time, "HHMM"))
     'Added by Lydia 2016/06/23 檔案改放FTP
     'Remove by Lydia 2016/07/07
     'If strSrvDate(1) >= TMQFileFTP Then
        If fID02 = TMQ_附件F02 Then
           PUB_PutFtpFile sfFileName, fID01, fID01 & fID02 & fID03 & fID04 & "." & UCase(Trim(fID05)), strFtpPath, "TMQFILE"
        Else
           PUB_PutFtpFile sfFileName, fID02, fID02 & fID03 & fID04 & "." & UCase(Trim(fID05)), strFtpPath, "TMQFILE"
        End If
        If strFtpPath <> "" Then
            adoRst.Fields("TQF12").Value = strFtpPath
        End If
     'End If
     'end 2016/06/23
     
     adoRst.UPDATE
     Close #sf1
     '附件已讀上N
     If UCase(fRead) = "N" Then
        'Modidife by Lydia 2016/01/27
        'strSql = "update TMQDETAIL SET TQD08='N' where TQD01='" & fID01 & "' AND TQD02='" & fID02 & "' AND TQD03='" & fID03 & "' AND TQD04='" & fID04 & "' "
        strSql = "update trademarkquery SET TMQ19=NULL where TMQ01='" & fID02 & "' AND TMQ19 IS NOT NULL "
        cnnConnection.Execute strSql, intA
     End If

cnnConnection.CommitTrans
     
     PUB_TMQAFileSave = True
     Exit Function
 
ErrHand:
   If Err.Number <> 32755 Then
      MsgBox Err.Description
      cnnConnection.RollbackTrans
   End If

End Function
'Added by Lydia 2015/11/25 查名單電子化-查名作業附件或查覆結果附件檔是否存在
Public Function PUB_TMQFileIsExist(Tq01 As String, Tq02 As String, Tq03 As String, Tq04 As String) As Boolean
Dim sStr01 As String
Dim ii As Integer
Dim rsChk As New ADODB.Recordset

    PUB_TMQFileIsExist = False
    If Tq01 <> "" And Tq02 <> "" And Tq03 <> "" And Tq04 <> "" Then
        ii = 1
        sStr01 = "select count(*) from tmqfile where tqf01='" & Tq01 & "' and tqf02='" & Tq02 & "' and tqf03='" & Tq03 & "' and tqf04='" & Tq04 & "' "
        Set rsChk = ClsLawReadRstMsg(ii, sStr01)
        If ii = 1 Then
           If rsChk.Fields(0) > 0 Then
              PUB_TMQFileIsExist = True
           End If
        End If
    End If
    Set rsChk = Nothing
    
End Function

'Added by Lydia 2015/11/03 判斷本所案號是否有國內外案件關聯表記錄
'Modified by Lydia 2016/06/14 +strNa01 判斷相關案件的國別
Public Function PUB_GetRefCaseChk(ByVal sCP01 As String, sCP02 As String, sCP03 As String, sCP04 As String, sTable As String, Optional sCM10 As String, Optional sType As String = "A", Optional strNA01 As String) As Boolean
Dim strA1 As String, strA2 As String, strAA As String
Dim rsA1 As New ADODB.Recordset
Dim idR As Integer

PUB_GetRefCaseChk = False
'SType 1=國外案/子案,2=國內案/母案,A=兩方
sTable = UCase(sTable)
If sTable = "CASEMAP" Then
   strAA = "SELECT 'Q' TYP,COUNT(*) CNT1 FROM CASEMAP WHERE CM10='" & sCM10 & "' "
   'Added by Lydia 2016/06/14
   If strNA01 <> "" Then strAA = "SELECT 'Q' TYP,COUNT(*) CNT1 FROM CASEMAP,PATENT WHERE CM10='" & sCM10 & "' "
ElseIf sTable = "DIVISIONCASE" Then
   strAA = "SELECT 'Q' TYP,COUNT(*) CNT1 FROM DIVISIONCASE WHERE 1=1 "
End If

strA1 = Replace(strAA, "'Q'", "'1'") & "AND CM01='" & sCP01 & "' AND CM02='" & sCP02 & "' AND CM03='" & sCP03 & "' AND CM04='" & sCP04 & "' "
strA2 = Replace(strAA, "'Q'", "'2'") & "AND CM05='" & sCP01 & "' AND CM06='" & sCP02 & "' AND CM07='" & sCP03 & "' AND CM08='" & sCP04 & "' "
'Added by Lydia 2016/06/14
If strNA01 <> "" And sTable = "CASEMAP" Then
   strA1 = strA1 & "AND CM05=PA01(+) AND CM06=PA02(+) AND CM07=PA03(+) AND CM08=PA04(+) AND PA09=" & CNULL(strNA01)
   strA2 = strA2 & "AND CM01=PA01(+) AND CM02=PA02(+) AND CM03=PA03(+) AND CM04=PA04(+) AND PA09=" & CNULL(strNA01)
End If

    Select Case sType
        Case "1": strAA = strA1
        Case "2": strAA = strA2
        Case "A": strAA = strA1 & " Union " & strA2
    End Select
    
    If sTable = "DIVISIONCASE" Then strAA = Replace(strAA, "CM", "DC")

    idR = 1
    Set rsA1 = ClsLawReadRstMsg(idR, strAA)
    If idR = 1 Then
       Do While Not rsA1.EOF
          If rsA1.Fields("CNT1") > 0 Then
             PUB_GetRefCaseChk = True: Exit Function
          End If
          rsA1.MoveNext
       Loop
    End If
End Function
'end 2015/11/03

'Added by Morgan 2015/11/12
'收文號轉數字(前兩碼英文用16進位轉10進位)
Public Function PUB_DocNo2Num(pDocNo As String) As Long
   'Modified by Morgan 2017/1/7 收文號D字頭會溢位,改前兩碼分別轉換且第二碼只取個位數
   'PUB_DocNo2Num = Val("&H" & Left(pDocNo, 2)) * 10 ^ 7 + Val(Mid(pDocNo, 3))
   PUB_DocNo2Num = Val("&H" & Left(pDocNo, 1)) * 10 ^ 8 + (Val("&H" & Mid(pDocNo, 2, 1)) - 10) * 10 ^ 7 + Val(Mid(pDocNo, 3))
End Function

'Added by Morgan 2015/11/12
'數字轉收文號(後7碼以前數字用10進位轉16進位)
Public Function PUB_Num2DocNo(pNum As Long) As String
   'Modified by Morgan 2017/1/7 收文號D字頭會溢位,改前兩碼分別轉換且第二碼只取個位數
   'PUB_Num2DocNo = Hex(pNum \ 10 ^ 7) & Right(pNum, 7)
   PUB_Num2DocNo = Hex(pNum \ 10 ^ 8) & Hex(pNum \ 10 ^ 7 Mod 10 + 10) & Right(pNum, 7)
End Function


'Added by Morgan 2015/12/2
'進度備註更新特定備註
'pCP09=收文號,pTagName=特定備註名稱,pText=特定備註內容
Public Sub PUB_UpdateCP64Tag(pCP09 As String, pTagName As String, pText As String)
   Dim stSQL As String, intR As Integer
   Dim stTag1 As String, stTag2 As String, stNew As String
   
   stTag1 = "<" & pTagName & ">"
   stTag2 = "</" & pTagName & ">"
   If pText <> "" Then stNew = stTag1 & pText & stTag2
   
   stSQL = "update caseprogress set cp64=cp64 where cp09='" & pCP09 & "' and instr(cp64,'" & ChgSQL(stTag1) & "')>0 and instr(cp64,'" & ChgSQL(stTag2) & "',instr(cp64,'" & ChgSQL(stTag1) & "'))>0"
   cnnConnection.Execute stSQL, intR
   '更新
   If intR = 1 Then
      '左邊內容+新內容+右邊內容
      stSQL = "update caseprogress set cp64=substr(cp64,1,instr(cp64,'" & ChgSQL(stTag1) & "')-1)||'" & ChgSQL(stNew) & "'||substr(cp64,instr(cp64,'" & ChgSQL(stTag2) & "',instr(cp64,'" & ChgSQL(stTag1) & "'))+" & Len(stTag2) & ") where cp09='" & pCP09 & "'"
      cnnConnection.Execute stSQL, intR
   '新增
   Else
      stSQL = "update caseprogress set cp64='" & ChgSQL(stNew) & "'||cp64 where cp09='" & pCP09 & "'"
      cnnConnection.Execute stSQL, intR
   End If
End Sub

'Added by Morgan 2015/12/2
'進度備註讀取特定備註
'pCP09=收文號,pTagName=特定備註名稱,pText=特定備註內容
Public Function PUB_ReadCP64Tag(pCP09 As String, pTagName As String) As String
   Dim rsQuery As ADODB.Recordset
   Dim stSQL As String, intR As Integer, stCP64 As String
   Dim iPos1 As Integer, iPos2 As Integer
   
   stSQL = "select cp64 from caseprogress where cp09='" & pCP09 & "'"
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      If Not IsNull(rsQuery(0)) Then
         stCP64 = rsQuery(0)
         iPos1 = InStr(stCP64, "<" & pTagName & ">")
         If iPos1 > 0 Then
            iPos1 = iPos1 + Len("<" & pTagName & ">")
            iPos2 = InStr(iPos1, stCP64, "</" & pTagName & ">")
            If iPos2 > iPos1 Then
               PUB_ReadCP64Tag = Mid(stCP64, iPos1, iPos2 - iPos1)
            End If
         End If
      End If
   End If
   Set rsQuery = Nothing
End Function

'Added by Lydia 2015/12/03 取得特定字串
Public Function PUB_GetMidString(ByRef iText As String, iStart As String, iEnd As String) As String
'iText=完整字串
'iStart=尋找的字串
'iEnd=終止的字串
Dim inA As Integer, inB As Integer

PUB_GetMidString = ""
    
    '無尋找和終止的字串=>全選
    If iStart = "" And iEnd = "" Then
       PUB_GetMidString = iText
    '有尋找的字串
    ElseIf InStr(iText, iStart) > 0 And iStart <> "" Then
       inA = InStr(iText, iStart)
       If iEnd = "" Then
          PUB_GetMidString = Mid(iText, inA)
       Else
          inB = InStr(inA + Len(iStart), iText, iEnd)
          If inB = 0 Then
             PUB_GetMidString = Mid(iText, inA)
          Else
             PUB_GetMidString = Mid(iText, inA, inB - 1)
          End If
       End If
    '沒有尋找的字串,但是有終止的字串
    ElseIf InStr(iText, iEnd) > 0 And iEnd <> "" Then
          PUB_GetMidString = Mid(iText, 1, InStr(iText, iEnd) - 1)
    End If
End Function

'Added by Morgan 2015/12/21 原P核准函輸入改共用
'以臺灣核准日+1個月更新國外案所限
Public Sub PUB_UpdCP06byTwPA20(ByRef p_PA() As String, ByVal p_PA20 As String)
   Dim stCP06 As String, stCP07 As String, stVTB As String, stMemo As String, stSubject As String
   Dim stSQL As String, intR As Integer, rsQuery As ADODB.Recordset
   
   'Added by Morgan 2015/9/16
   '台灣案核准時,若多國案仍未發文,且未設定期限,則請預設自核准日起算1個月為該多國案之本所期限,並發MAIL告知工程師
   'Modified by Morgan 2015/12/1 改原來無所限或較晚時更新，若法限晚於核准日+7個月時一併清除
   stCP07 = CompDate(1, 7, p_PA20) '最晚預定公告日=核准日+7個月(3個月領證+3個月延緩+1個月預估)
   stCP06 = PUB_GetWorkDay1(CompDate(1, 1, p_PA20), True)
   stVTB = PUB_GetRefCaseMapSQL(p_PA)
   stMemo = "期限來源:" & Right("  " & p_PA(1), 3) & "-" & p_PA(2) & "-" & p_PA(3) & "-" & p_PA(4) & "(所限=核准日" & ChangeWStringToWDateString(DBDATE(p_PA20)) & "+1個月);"
   stSQL = "SELECT CP09,CP01||'-'||CP02||decode(CP03||CP04,'000','','-'||CP03||'-'||CP04) RefNo,CP14,cp07" & _
      " FROM CASEPROGRESS C1 WHERE (CP01,CP02,CP03,CP04) IN (" & stVTB & ") AND CP01<>'FCP'" & _
      " AND CP10 IN (" & SameCaseProperty4Update & ") AND CP27||CP57 IS NULL and (cp06 is null or cp06>" & stCP06 & ")" & _
      " AND NOT EXISTS(SELECT * FROM patent WHERE PA01=C1.CP01 AND PA02=C1.CP02 AND PA03=C1.CP03 AND PA04=C1.CP04 AND PA46='Y')" & _
      " AND NOT EXISTS(SELECT * FROM CASEPROGRESS C2 WHERE C2.CP01=C1.CP01 AND C2.CP02=C1.CP02 AND C2.CP03=C1.CP03 AND C2.CP04=C1.CP04 AND C2.CP10='106' AND C2.CP57 IS NULL)"
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      With rsQuery
      Do While Not .EOF
         If "" & .Fields("cp07") > stCP07 Then
            strSql = "update caseprogress set cp06=" & stCP06 & ",cp07=null,CP64=SUBSTR(CP64,1,INSTR(CP64,'期限來源:')-1)||'" & stMemo & "'||SUBSTR(CP64,INSTR(CP64,';',instr(CP64,'期限來源:'))+1) where cp09='" & .Fields("cp09") & "'"
         Else
            strSql = "update caseprogress set cp06=" & stCP06 & ",CP64='" & stMemo & "'||CP64 where cp09='" & .Fields("cp09") & "'"
         End If
         cnnConnection.Execute strSql, intR
         
         If Not IsNull(.Fields("CP14")) Then
            'modify by sonia 2019/11/26 incCNV_CHINESE_MINKO改用incCNV_CHINESE_MINKO1
            stSubject = .Fields("RefNo") & "之相對應" & p_PA(1) & "-" & p_PA(2) & IIf(p_PA(3) & p_PA(4) = "000", "", "-" & p_PA(3) & "-" & p_PA(4)) & "已核准,預設本所期限為" & TranslateKeyWord(incCNV_CHINESE_MINKO1, stCP06, "") & ",請儘速作業!!"
            stSQL = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08)" & _
               " values( '" & strUserNum & "','" & .Fields("CP14") & "',to_char(sysdate,'yyyymmdd')" & _
               ",to_char(sysdate,'hh24miss'),'" & stSubject & "','如旨')"
            cnnConnection.Execute stSQL, intR
         End If
         .MoveNext
      Loop
      End With
   End If
   'end 2015/9/16
   Set rsQuery = Nothing
End Sub
'end 2015/12/21

'Added by Lydia 2015/12/25 新增-國外部行事曆資料
'Modified by Lydia 2023/07/04 +來源收文號sC20
Public Function PUB_AddFCPStaffCalendar(ByVal sDate1 As String, ByVal iTyp As String, ByVal sC03 As String, ByVal sC04 As String, ByVal sC09 As String, ByVal sC10 As String, _
          Optional ByVal sC05 As String, Optional ByVal sC06 As String, Optional ByVal sC07 As String, Optional ByVal sC08 As String, _
          Optional ByRef sC01 As String, Optional ByRef sC02 As Integer, Optional ByVal sC11 As String, Optional ByVal sC20 As String) As Boolean
          
'iTyp:2~3=管制日期+週期
'sDate1: 管制日期

   Dim stSQL As String
   Dim StrStr As String
   Dim idA As Integer
   Dim rsAA As New ADODB.Recordset
   Dim dUser01 As String, dUser02 As String 'Added by Lydia 2017/10/18
   Dim strUser(1 To 3) As String 'Added by Lydia 2025/05/16
   
On Error GoTo ErrHand

   PUB_AddFCPStaffCalendar = False

   If sDate1 = "" Then Exit Function
   Select Case iTyp
       Case "2" '每週
           sDate1 = CompDate(2, 7, DBDATE(sDate1))
       Case "3" '每月
           sDate1 = CompDate(1, 1, DBDATE(sDate1))
       'Added by Lydia 2016/06/28
       Case "4" '每3個月
           sDate1 = CompDate(1, 3, DBDATE(sDate1))
       'Added by Lydia 2017/11/14
       Case "5" '每3個月
           sDate1 = CompDate(0, 1, DBDATE(sDate1))
   End Select
    
   'Added by Lydia 2017/10/18 國外部行事曆資料維護若有輸入案號時，可解除人員自動多掛FCP程序人員的案件第一職代
   If sC05 <> "" And sC06 <> "" And sC07 <> "" And sC08 <> "" Then
      'FCP程序管制人員
      dUser01 = PUB_GetFCPHandler(sC05, sC06, sC07, sC08)
      '案件第一職代
      'Modified by Lydia 2025/05/16 改抓全部職代; Ex. Winfrey第一職代Teresa不處理案件
      'If dUser01 <> "" Then dUser02 = GetABS001_17(dUser01)
      If dUser01 <> "" Then
         Call GetABS001_1(dUser01, strUser(1), strUser(2), strUser(3))
      End If
      'end 2025/05/16
      
      '追蹤會稿結果:通知人員和解除人員,增加FCP管制人員
      If InStr(sC04, "追蹤會稿結果") > 0 And sC04 <> "" Then
        If InStr(sC03, dUser01) = 0 And dUser01 <> "" Then
           sC03 = sC03 & IIf(sC03 <> "", ",", "") & dUser01
        End If
        If InStr(sC09, dUser01) = 0 And dUser01 <> "" Then
           sC09 = sC09 & IIf(sC09 <> "", ",", "") & dUser01
        End If
      End If
      
      '預設可解除人員自動多掛FCP程序人員的案件第一職代
      'Modified by Lydia 2018/10/30 有FCP管制人
      'If InStr(sC09, dUser02) = 0 And dUser02 <> "" Then
      'Modified by Lydia 2025/11/14 debug : 改抓全部職代
      'If InStr(sC09, dUser01) > 0 And InStr(sC09, dUser02) = 0 And dUser02 <> "" Then
      '   'Modified by Lydia 2025/05/16 + & IIf(strUser(3) <> "", "," & strUser(3), "")
      '   sC09 = sC09 & IIf(sC09 <> "", ",", "") & dUser02 & IIf(strUser(3) <> "", "," & strUser(3), "")
      'End If
      If strUser(1) <> "" And InStr(sC09, strUser(1)) = 0 Then sC09 = sC09 & IIf(sC09 <> "", ",", "") & strUser(1)
      If strUser(2) <> "" And InStr(sC09, strUser(2)) = 0 Then sC09 = sC09 & IIf(sC09 <> "", ",", "") & strUser(2)
      If strUser(3) <> "" And InStr(sC09, strUser(3)) = 0 Then sC09 = sC09 & IIf(sC09 <> "", ",", "") & strUser(3)
      'end 2025/11/14
   End If
   'end 2017/10/18
    
   'Added by Lydia 2017/10/18 檢查人員的長度
   If GetTextLength(sC03) > 100 Then
      MsgBox "提醒人員超過最大長度!", vbCritical
      sC03 = Mid(sC03, 1, 100)
   End If
   'Modified by Lydia 2025/05/16 改長度23=>59
   If GetTextLength(sC09) > 59 Then
      MsgBox "解除人員超過最大長度!", vbCritical
      sC09 = Mid(sC09, 1, 59)
   End If
   'end 2017/10/18
   
   sC01 = sDate1
   idA = 1
   StrStr = "select nvl(max(sc02),0) from staff_calendar where sc01=" & CNULL(sDate1, True)
   Set rsAA = ClsLawReadRstMsg(idA, StrStr)
   If idA = 1 Then
      sC02 = rsAA.Fields(0) + 1
   End If
   
   If IsNull(sC11) Or sC11 = "" Then
        sC11 = strUserNum
   'Added by Lydia 2020/09/10 判斷建檔人員是否在職
   Else
        StrStr = "select st01,st03,st52,st53,st54,st55 from staff where st01='" & sC11 & "' and st04 <> '1'"
        idA = 1
        Set rsAA = ClsLawReadRstMsg(idA, StrStr)
        If idA = 1 Then
           sC11 = strUserNum
           '有案號抓同部門的該區程序／承辦；沒案號設為解除人員。
           If sC05 <> "" And sC06 <> "" Then
                If "" & rsAA.Fields("st03") = "F22" Then '程序
                    sC11 = PUB_GetFCPHandler(sC05, sC06, sC07, sC08)
                ElseIf "" & rsAA.Fields("st03") = "F23" Then '承辦
                    sC11 = PUB_GetFCPSalesNo(sC05, sC06, sC07, sC08)
                End If
           End If
        End If
   'end 2020/09/10
   End If
   
   'Modified by Lydia 2023/07/04 +來源收文號SC20
   stSQL = "INSERT INTO Staff_Calendar (SC01,SC02,SC03,SC04,SC05,SC06,SC07,SC08,SC09,SC10,SC11,SC12,SC13,SC20) " & _
           "Values (" & CNULL(sDate1, True) & "," & sC02 & ",'" & sC03 & "','" & sC04 & "'," & CNULL(sC05) & "," & CNULL(sC06) & "," & CNULL(sC07) & "," & CNULL(sC08) & _
           "," & CNULL(sC09) & "," & sC10 & ",'" & sC11 & "'," & strSrvDate(1) & "," & CNULL(Mid(Right("000000" & ServerTime, 6), 1, 4), True) & "," & CNULL(sC20) & ")"
   cnnConnection.Execute stSQL, idA

   PUB_AddFCPStaffCalendar = True
   Exit Function
   
ErrHand:
   If Err.Number > 0 Then
       MsgBox Err.Description, vbCritical
   End If
End Function
'end 2015/12/25

'Added by Lydia 2016/1/12 抓指定定稿的延展費次數
Public Function PUB_GetExpYF607(pPA09 As String, pPA01 As String, pPA02 As String, pPA03 As String, pPA04 As String, pPA10 As String) As String

Dim StrSQLa As String
Dim rsA As New ADODB.Recordset
Dim strTmp As String
Dim ii As Integer

PUB_GetExpYF607 = ""
    Select Case pPA09
        '馬來西亞新型延展費
        Case "018"
            strTmp = "select '第'||decode(sign(trunc(np09/10000)- trunc(pa10/10000)-15),-1,1,2)||'次' from nextprogress,patent " & _
                        "where NP02='" & pPA01 & "' And NP03='" & pPA02 & "' AND NP04='" & pPA03 & "' AND NP05='" & pPA04 & "' " & _
                        " and np07='607' and np06 is null and pa57 is null " & _
                        "and pa01(+)=np02 and pa02(+)=np03 and pa03(+)=np04 and pa04(+)=np05 order by np09 desc  "
            ii = 1
            Set rsA = ClsLawReadRstMsg(ii, strTmp)
            If ii = 1 Then
                StrSQLa = Trim(rsA.Fields(0))
            End If
        'Modified by Morgan 2017/7/3 俄羅斯5/2改國家代碼 "233"->"023"
        Case "023"
            '俄羅斯設計延展費有分新舊制
            '申請日2015/1/1以前->舊制,第16年可延展一次,一次10年
             If Val(pPA10) < 20150101 Then
                StrSQLa = PUB_GetYF15(pPA09, "3", "Y00000010", "607", 16)
             '申請日2015/1/1以後->新制,第6年開始延展,一次5年,最多4次
             Else
                strTmp = "select count(*) cnt from caseprogress where CP01='" & pPA01 & "' And CP02='" & pPA02 & "' AND CP03='" & pPA03 & "' AND CP04='" & pPA04 & "' and cp10='607' and cp27 is not null "
                ii = 1
                Set rsA = ClsLawReadRstMsg(ii, strTmp)
                If ii = 1 Then
                    strTmp = Format(RsTemp.Fields(0) + 1, "0")
                End If
                StrSQLa = PUB_GetYF15(pPA09, "3", "Y00000000", "607", CDbl(Val(strTmp) * 5))
             End If
    End Select
    
    If StrSQLa <> "" Then PUB_GetExpYF607 = StrSQLa
    
End Function

'Added by Morgan 2016/1/4
'關閉所有薪資畫面
Public Sub Pub_CloseSalaryQueryForm()
   Dim frmTemp As Form
   For Each frmTemp In Forms
      If LCase(Left(frmTemp.Name, 5)) = "frm17" Then Unload frmTemp
   Next
End Sub


'Added by Lydia 2016/02/03 回傳FCP特殊承辦設定的case句
'Modified by Lydia 2023/02/19 檢查過目前沒有使用回傳Y編號
'Public Function Pub_GetSpecFCP(Optional ByRef mStr01 As String, Optional ByRef mStr02 As String) As String
Public Function Pub_GetSpecFCP() As String
Dim mStr01 As String, mStr02 As String, mStr03 As String
'end 2023/02/19
   
   'Modified by Lydia 2024/05/27 改成用Y編號+日文承辦業務
   'mStr01 = Pub_GetSpecMan("北京銀龍FCP案承辦業務")
   'mStr02 = Pub_GetSpecMan("金杜FCP案日文承辦業務")
   ''Modified by Lydia 2023/02/19
   ''Pub_GetSpecFCP = "'Y51333010','" & mStr01 & "','Y51817040','" & mStr02 & "'"
   'mStr03 = Pub_GetSpecMan("大金FCP案日文承辦業務")
   'Pub_GetSpecFCP = "'Y51333010','" & mStr01 & "','Y51817040','" & mStr02 & "','Y55856000','" & mStr03 & "'"
   Dim intA As Integer, rsA As New ADODB.Recordset
   mStr01 = "select ocode,oman from setspecman where ocode like 'Y%日文承辦業務' "
   intA = 1
   Set rsA = ClsLawReadRstMsg(intA, mStr01)
   If intA = 1 Then
      rsA.MoveFirst
      Do While Not rsA.EOF
         If "" & rsA.Fields("oman") <> "" Then
           mStr02 = mStr02 & ",'" & Left(rsA.Fields("ocode"), 9) & "','" & rsA.Fields("oman") & "'"
         End If
         rsA.MoveNext
      Loop
      If mStr02 <> "" Then
         Pub_GetSpecFCP = Mid(mStr02, 2)
      End If
   End If
   Set rsA = Nothing
   'end 2024/05/27
End Function

'Add By Sindy 2016/2/17 境外公司欄由未勾選改為有勾選存檔時,要再更新此抬頭之收據ACC0K0的A0K05='1'
'回傳是否要發mail
Public Function CU158isYUpdAccData(ByVal strCuName As String, ByRef strNo As String, Optional ByVal strCUNo As String = "") As Boolean
   CU158isYUpdAccData = False
   '條件如下:
   '1. 該抬頭未收齊(A0K37 IS NULL)且未作廢的收據
   strSql = "update acc0k0 set a0k05='1' where a0k04='" & strCuName & "' and a0k05<>'1' and nvl(a0k16,0)=0 and a0k37 is null and nvl(a0k09,0)=0"
   adoTaie.Execute strSql
   '2. 該抬頭之扣繳年度A0K16=系統年度
   strSql = "update acc0k0 set a0k05='1' where a0k04='" & strCuName & "' and a0k05<>'1' and nvl(a0k16,0)=" & Left(strSrvDate(2), 3) & " and nvl(a0k09,0)=0"
   adoTaie.Execute strSql
   '另該抬頭之扣繳年度A0K16<系統年度且A0K05<>'1'
   '且未輸扣繳憑單(以A0K01抓ACC1V0之A1V15)者,
   '以郵件寄給操作人員自己 (待後續有空再清查是否要改)
   strSql = "select a0k01 from acc0k0,acc1v0" & _
            " where a0k04='" & strCuName & "' and a0k05<>'1'" & _
            " and nvl(a0k16,0)<" & Left(strSrvDate(2), 3) & _
            " and nvl(a0k09,0)=0 and a0k01=a1v02 and a1v15 is null"
   intI = 1
   Set RsTemp = ClsLawReadRstMsg(intI, strSql)
   If intI = 1 Then
      RsTemp.MoveFirst
      strNo = ""
      Do While Not RsTemp.EOF
         strNo = strNo & RsTemp.Fields("a0k01") & vbCrLf
         RsTemp.MoveNext
      Loop
      'Modify By Sindy 2016/3/21
      'PUB_SendMail strUserNum, strUserNum, "", strCUNo & strCuName & "改為境外公司,過去年度之收據請再確認是否改為個人收據", "Dear Sirs," & vbCrLf & vbCrLf & strNo & vbCrLf & vbCrLf & vbCrLf & "                                                        電腦中心"
      CU158isYUpdAccData = True
      '2016/3/21 END
   End If
End Function
'2016/2/17 END

'Added by Lydia 2016/02/22 共同查詢\以收發文日(量)查詢,判斷跨部門權限
Public Function PUB_CheckSKAddCross(ByVal strUser As String, ByVal oSkind As String, ByVal bolCross As Boolean, ByVal chkSK As String, Optional ByRef nSKrange As String, Optional ByRef bMsg As Boolean = True) As Boolean
Dim tmpVar1  As Variant, tmpVar2 As Variant
Dim inJ As Integer, inK As Variant
Dim tmpSK As String
Dim strTmp As String
Dim rsAD As New ADODB.Recordset
Dim bolTmp As Boolean

    If Len(Trim(oSkind)) = 0 Then
       oSkind = GetSystemKindByNick
    End If
    tmpSK = oSkind
    If bolCross = True Then
        '個人權限
        strTmp = "select sdr02 from staff_dept_right,systemkind where sdr01='" & strUser & "' and sdr03='Y' and sdr02=sk01(+) "
        '等級權限
        strTmp = strTmp & "union select sdr02 from staff,staff_dept_right,systemkind where st01='" & strUser & "' and st05=sdr01(+) and sdr03='Y' and sdr02=sk01(+) "
        inJ = 1
        Set rsAD = ClsLawReadRstMsg(inJ, strTmp)
        If inJ = 1 Then
           strTmp = rsAD.GetString(adClipString, , , ",")
           tmpSK = tmpSK & strTmp
        End If
    End If
    nSKrange = tmpSK '回傳全部權限
    
    'ALL=回傳全部權限
    If Len(Trim(chkSK)) = 0 Or chkSK = "ALL" Then
       PUB_CheckSKAddCross = True
    Else
       PUB_CheckSKAddCross = False
       strTmp = ""
       tmpVar1 = Split(chkSK, ",") '輸入部門
       tmpVar2 = Split(tmpSK, ",") '全部權限
       For inJ = 0 To UBound(tmpVar1)
          If Trim(tmpVar1(inJ)) <> "" Then
            bolTmp = False
            For inK = 0 To UBound(tmpVar2)
               If Trim(tmpVar2(inK)) = Trim(tmpVar1(inJ)) Then
                  bolTmp = True
                  Exit For
               End If
            Next inK
            If bolTmp = False Then strTmp = strTmp & Trim(tmpVar1(inJ)) & ","
          End If
       Next inJ
       If Len(strTmp) > 0 Then
          If bMsg Then MsgBox "您沒有跨部門查詢" & Mid(strTmp, 1, Len(strTmp) - 1) & "案件明細的權限", vbOKOnly, "檢核資料"
       Else
          PUB_CheckSKAddCross = True
       End If
    End If
    
End Function
'Added by Morgan 2016/3/1 從寄件確認移來
'IN:
'     strCPP01 =  收文號
'     pSavePath=  附件存放的資料夾(預設App.path & "\" & strUserNum)
'     pJoinDoc =  附件是否合併(檔名自動設為"$" & strCPP01 & ".pdf",若已存在則不重新下載)
'     pCP10    =  案件性質
'     pNoDown  =  不下載檔案(只要清單)
'
'OUT:
'     pFileName=  附件檔名(含路徑,多檔以[;]號區隔)
'     pFileDescs= 附件檔名及說明(不含路徑,多檔以[;]號區隔)
'Modified by Morgan 2019/3/4 +pFileDescs
'Modified by Morgan 2025/5/6 +pForUpdate
Public Function PUB_GetAttachFile4Cust(ByVal strCPP01 As String, Optional ByRef pFileName As String, Optional ByRef pSavePath As String, Optional pJoinDoc As Boolean = False, Optional pCP10 As String, Optional pFileDescs As String, Optional pNoDown As Boolean = False, Optional ForUpdate As Boolean = False) As Boolean
   Dim stAttPath As String
   Dim stTempFile As String
   Dim stExceptCon As String '過濾不要顯示的檔案
   Dim stSort2 As String, stSort2x As String '順序
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   Dim stSavePath As String
   Dim stFileList As String
   Dim stCountry As String
   'Added by Morgan 2016/6/1
   Dim strRefCP10 As String
   Dim strPA08 As String
   Dim strCPM26 As String '相關號副檔
   Dim bolIsCopy As Boolean, str990CP09 As String
   Dim strCP01 As String 'Added by Morgan 2018/10/15
   Dim strCPM26a As String 'Added by Morgan 2018/10/22 本程序副檔
   Dim strCP163 As String
   Dim stFileName As String 'Added by Morgan 2025/5/6
   
On Error GoTo ErrHnd
   
   If pSavePath = "" Then
      pSavePath = App.path & "\" & strUserNum
      stSavePath = pSavePath & "\"
   End If
   
   '建立暫存資料夾
   If Dir(pSavePath, vbDirectory) = "" Then
      MkDir pSavePath
   End If
   
   If pJoinDoc = True Then
      'Add By Sindy 2020/2/10 經理說同卷宗區用本所案號命名
      'stTempFile = "$" & strCPP01 & ".pdf"
      stSQL = "select cp09,cp01,cp02,cp03,cp04 from caseprogress where cp09='" & strCPP01 & "'"
      intQ = 1
      Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
     If intQ = 1 Then
         stTempFile = rsQuery.Fields("cp01") & rsQuery.Fields("cp02") & IIf(rsQuery.Fields("cp03") & rsQuery.Fields("cp04") = "000", "", rsQuery.Fields("cp03") & rsQuery.Fields("cp04")) & ".pdf"
      End If
      '2020/2/10 END
      
      'Removed by Morgan 2020/2/18 合併前檢查就好,取消此處檢查,否則會無法回pFileDescs
      'If Dir(pSavePath & "\" & stTempFile) <> "" Then
      '   pFileName = stSavePath & stTempFile
      '   PUB_GetAttachFile4Cust = True
      'End If
      'end 2020/2/18
      
   End If
   
   If PUB_GetAttachFile4Cust = False Then
      'Added by Morgan 2016/11/8
      '副本信函改用相關收文號處理但客戶函要用副本
      'Modified by Morgan 2018/9/19 +轉公文1998
      If pCP10 = "990" Or pCP10 = "1998" Then
         str990CP09 = strCPP01
         bolIsCopy = True
         stSQL = "select b.cp09,b.cp10 from caseprogress a,caseprogress b where a.cp09='" & strCPP01 & "' and b.cp09(+)=a.cp43 and b.cp01 is not null"
         intQ = 1
         Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
         If intQ = 1 Then
            strCPP01 = rsQuery("cp09")
            pCP10 = rsQuery("cp10")
         End If
      End If
      'end 2016/11/8
   
      'Added by Morgan 2016/5/27
      'Modified by Morgan 2018/10/22 +cpm26a
      'Modify By Sindy 2020/2/3 +TM,SP
      stSQL = "select pa09,c2.cp10,pa08,c3.cpm26,c1.cp01,c4.cpm26 cpm26a from caseprogress c1,patent,caseprogress c2,casepropertymap c3,casepropertymap c4 where c1.cp09='" & strCPP01 & "'" & _
         " and pa01=c1.cp01 and pa02=c1.cp02 and pa03=c1.cp03 and pa04=c1.cp04 and c2.cp09(+)=c1.cp43 and c3.cpm01(+)=c2.cp01 and c3.cpm02(+)=c2.cp10 and c4.cpm01(+)=c1.cp01 and c4.cpm02(+)=c1.cp10"
      stSQL = stSQL & " union " & _
         "select tm10,c2.cp10,tm08,c3.cpm26,c1.cp01,c4.cpm26 cpm26a from caseprogress c1,trademark,caseprogress c2,casepropertymap c3,casepropertymap c4 where c1.cp09='" & strCPP01 & "'" & _
         " and tm01=c1.cp01 and tm02=c1.cp02 and tm03=c1.cp03 and tm04=c1.cp04 and c2.cp09(+)=c1.cp43 and c3.cpm01(+)=c2.cp01 and c3.cpm02(+)=c2.cp10 and c4.cpm01(+)=c1.cp01 and c4.cpm02(+)=c1.cp10"
      stSQL = stSQL & " union " & _
         "select sp09,c2.cp10,'' pa08,c3.cpm26,c1.cp01,c4.cpm26 cpm26a from caseprogress c1,servicepractice,caseprogress c2,casepropertymap c3,casepropertymap c4 where c1.cp09='" & strCPP01 & "'" & _
         " and sp01=c1.cp01 and sp02=c1.cp02 and sp03=c1.cp03 and sp04=c1.cp04 and c2.cp09(+)=c1.cp43 and c3.cpm01(+)=c2.cp01 and c3.cpm02(+)=c2.cp10 and c4.cpm01(+)=c1.cp01 and c4.cpm02(+)=c1.cp10"
      '2020/2/3 END
      intQ = 1
      Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
      If intQ = 1 Then
         stCountry = "" & rsQuery("pa09")
         strRefCP10 = "" & rsQuery("cp10")
         strPA08 = "" & rsQuery("pa08")
         strCPM26 = "" & rsQuery("cpm26") '相關收文號副檔
         strCP01 = "" & rsQuery("cp01") 'Added by Morgan 2018/10/15
         strCPM26a = "" & rsQuery("cpm26a") '本程序副檔 Added by Morgan 2018/10/22
      End If
      'end 2016/5/27
      
      '排除條件
      '排除 ".INFO."
      'Modified by Morgan 2016/5/24 +排除 ".ALTR."
      'Modified by Morgan 2017/4/18 +排除 ".WORKSHEET."
      'Modified by Morgan 2018/11/6 +排除 ".ORDER.",".INVOICE."
      'modify by sonia 2018/12/22 '.INFO.'改為'.INFO',否則CFP-028921之INFO1及INFO2不會剔除
      'stExceptCon = " and INSTR(UPPER(CPP02),'.INFO.')=0 and INSTR(UPPER(CPP02),'.ALTR.')=0 and INSTR(UPPER(CPP02),'.WORKSHEET.')=0 and INSTR(UPPER(CPP02),'.ORDER.')=0 and INSTR(UPPER(CPP02),'.INVOICE.')=0"
      'Modified by Morgan 2019/1/21 +排除 ".ACK."
      'Modified by Morgan 2019/4/18 +排除 ".LTR." --郭
      'Modified by Morgan 2019/6/18 +排除 ".REQ." --郭
      'Modified by Morgan 2020/2/17 +排除 ".QUOTE." --郭
      'Modified by Morgan 2021/1/14 +排除 ".EMAIL.",".TX.",".RX."
      'Modified by Morgan 2021/4/1 +排除 ".CACK." 客戶確收
      'Modified by Morgan 2021/8/25 +排除 ".OFF." 銷案銷帳單
      'Modify By Sindy 2021/9/22 + 排除 ".REPLY." 回覆單
      'Modified by Morgan 2021/8/25 +排除 ".INCOM." 內部聯絡
      'Modified by Morgan 2022/8/31 +排除 ".CASE." 客戶資料
      'Modified by Morgan 2023/6/7 +排除 ".RMDR." 提醒
      'Modified by Morgan 2025/6/11 +CPP11 is null (排除接洽單匯入的檔案) Ex:T-25149註冊費(客戶用客戶函回覆，智權直接匯入)
      stExceptCon = " and INSTR(UPPER(CPP02),'.INFO')=0 and INSTR(UPPER(CPP02),'.ALTR.')=0 and INSTR(UPPER(CPP02),'.WORKSHEET.')=0 and INSTR(UPPER(CPP02),'.ORDER.')=0 and INSTR(UPPER(CPP02),'.INVOICE.')=0 and INSTR(UPPER(CPP02),'.ACK.')=0 and INSTR(UPPER(CPP02),'.LTR.')=0 and INSTR(UPPER(CPP02),'.REQ.')=0 and INSTR(UPPER(CPP02),'.QUOTE.')=0 and INSTR(UPPER(CPP02),'.EMAIL.')=0 and INSTR(UPPER(CPP02),'.TX.')=0 and INSTR(UPPER(CPP02),'.RX.')=0 and INSTR(UPPER(CPP02),'.CACK.')=0 and INSTR(UPPER(CPP02),'.OFF.')=0 and INSTR(UPPER(CPP02),'.REPLY.')=0 and INSTR(UPPER(CPP02),'.INCOM.')=0 and INSTR(UPPER(CPP02),'.CASE.')=0 and INSTR(UPPER(CPP02),'.RMDR.')=0 and CPP11 is null"
      'Added by Morgan 2020/6/18 非台灣案要排除指示信
      If stCountry <> "000" Then
         stExceptCon = stExceptCon & " and INSTR(UPPER(CPP02),'.DATA.')=0"
      End If
      'Added by Morgan 2016/11/8
      '副本信函要排除客戶函正本
      If bolIsCopy Then
         stExceptCon = stExceptCon & " and instr(UPPER(cpp02),'.CUS.')=0"
      End If
      'end 2016/11/8
      
      'Modified by Morgan 2020/11/4 配合商標一文多案需求排序統一加本所案號
      '專利
      If strCP01 = "P" Or strCP01 = "PS" Or strCP01 = "CFP" Or strCP01 = "CPS" Then
         stSort2 = PUB_GetAttSort("P") 'Modified by Morgan 2019/6/27 整合並改寫函數
         '客戶函在最上面
         'Modified by Morgan 2019/3/4 +FDesc
         '臺灣案
         If stCountry = "000" Then
            '來函 C 類
            If Left(strCPP01, 1) = "C" Then
               stSQL = " select '1' Srt1," & stSort2 & " Srt2,length(cpp02) Srt3,cpp01,cpp02,cp01,cp02,cp03,cp04" & _
                  ",'('||Round(cpp03 / 1024, 2)||' KB) '||GETFILEDESC(cpp02,CP01,CP10,'" & stCountry & "') as FDesc" & _
                  " from casepaperpdf c,caseprogress where cpp01='" & strCPP01 & "' and cp09(+)=cpp01 and SUBSTR(UPPER(CPP02),-4)='.PDF' And cpp10<>'D'" & stExceptCon
               '證書要一併抓公報檔
               If pCP10 = "1603" Then
                  stSQL = stSQL & " union all select '2' Srt1,9 Srt2,length(cpp02) Srt3,cpp01,cpp02,a.cp01,a.cp02,a.cp03,a.cp04" & _
                     ",'('||Round(cpp03 / 1024, 2)||' KB) '||GETFILEDESC(cpp02,b.CP01,b.CP10,'" & stCountry & "') as FDesc" & _
                     " from caseprogress a,caseprogress b,casepaperpdf c" & _
                     " where a.cp09='" & strCPP01 & "' and b.cp01(+)=a.cp01 and b.cp02(+)=a.cp02 and b.cp03(+)=a.cp03 and b.cp04(+)=a.cp04 and b.cp10='1228'" & _
                     " and cpp01(+)=b.cp09 and SUBSTR(UPPER(CPP02),-9)='.1228.PDF' And cpp10<>'D'" & stExceptCon
                  
               '通知申請號一併抓申請程序的檔案
               ElseIf pCP10 = "1101" Then
                  stSort2x = PUB_GetAttSort("P", "a.cp10") 'Modified by Morgan 2019/6/27 整合並改寫函數
                  stSQL = stSQL & " union all"
                  stSQL = stSQL & " select '1' Srt1," & stSort2x & " Srt2,length(cpp02) Srt3,cpp01,cpp02,a.cp01,a.cp02,a.cp03,a.cp04" & _
                     ",'('||Round(cpp03 / 1024, 2)||' KB) '||GETFILEDESC(cpp02,b.CP01,b.CP10,'" & stCountry & "') as FDesc" & _
                     " from caseprogress a,caseprogress b,casepaperpdf c" & _
                     " where a.cp09='" & strCPP01 & "' and b.cp09(+)=a.cp43 and cpp01(+)=a.cp43 and SUBSTR(UPPER(CPP02),-4)='.PDF' And cpp10<>'D'" & stExceptCon & _
                     " and (instr(upper(cpp02),'.RECEIPT.')>0 OR exists(select * from custletterrefext where cle05=b.cp01 and cle01=b.cp10 and cle02='" & stCountry & "'" & _
                     " and instr(upper(cpp02),'.'||upper(cle03)||'.')>0 AND ( CLE04 IS NULL OR CLE04=DECODE(b.CP118,NULL,2,1) ) ) )"
               End If
            
            '發文 A,B 類
            Else
               'pdf檔只列給看得
               '收據要判斷有發文規費的才抓否則為回執不用給客戶
               stSQL = "select '1' Srt1," & stSort2 & " Srt2,length(cpp02) Srt3,cpp01,cpp02,cp01,cp02,cp03,cp04" & _
                  ",'('||Round(cpp03 / 1024, 2)||' KB) '||GETFILEDESC(cpp02,CP01,CP10,'" & stCountry & "') as FDesc" & _
                  " from casepaperpdf c,caseprogress where cpp01='" & strCPP01 & "' and SUBSTR(UPPER(CPP02),-4)='.PDF' And cpp10<>'D'" & stExceptCon & _
                  " and cp09(+)=cpp01 and (instr(upper(cpp02),'.CUS.')>0 OR (instr(UPPER(cpp02),'.RECEIPT.')>0 and cp84>0)" & _
                  " OR exists(select * from custletterrefext where cle05=cp01 and cle01=cp10 and cle02='" & stCountry & "'" & _
                  " and instr(upper(cpp02),'.'||upper(cle03)||'.')>0 AND ( CLE04 IS NULL OR CLE04=DECODE(CP118,NULL,2,1))))"
            End If
            
         'Added by Morgan 2016/6/1
         '非臺灣案
         Else
            stSQL = " select '1' Srt1," & stSort2 & " Srt2,length(cpp02) Srt3,cpp01,cpp02,cp01,cp02,cp03,cp04" & _
               ",'('||Round(cpp03 / 1024, 2)||' KB) '||GETFILEDESC(cpp02,CP01,CP10,'" & stCountry & "') as FDesc" & _
               " from casepaperpdf,caseprogress c1 where cpp01='" & strCPP01 & "' and SUBSTR(UPPER(CPP02),-4)='.PDF' And cpp10<>'D'" & stExceptCon & _
               " and cp09(+)=cpp01 and ( instr(upper(cpp02),'.CUS.')>0"
            If Left(strCPP01, 1) = "C" Then
               'Add by Morgan 2019/2/25 CFP已提申代理人可能會給別的文件但不用給客戶故改為只抓可以給的
               If strCP01 = "CFP" And (pCP10 = "1909" Or pCP10 = "1101") Then
                  stSQL = stSQL & " or instr(UPPER(cpp02),'.RECEIPT.')>0"
                  stSQL = stSQL & " or instr(UPPER(cpp02),'.DWG.')>0"
                  stSQL = stSQL & " or instr(UPPER(cpp02),'.FIL.')>0" 'Added by Morgan 2019/2/27 +.FIL受理通知書 --郭
                  stSQL = stSQL & " or instr(UPPER(cpp02),'.ATT.')>0" 'Added by Morgan 2020/4/9 +.ATT其他各式附件
               End If
               'end 2019/2/25
               
               If pCP10 = "1101" And strRefCP10 = "307" Then
                  If strPA08 = "1" Then
                     stSQL = stSQL & " or instr(UPPER(cpp02),'.INV.')>0"
                  Else
                     stSQL = stSQL & " or instr(UPPER(cpp02),'.UTL.')>0"
                  End If
               
               'Modified by Morgan 2019/7/18 改抓相關收文號的 custletterrefext 設定
               '年費提申要附收據
               'ElseIf pCP10 = "1909" And strRefCP10 = "605" Then
               '   stSQL = stSQL & " or instr(UPPER(cpp02),'.RECEIPT.')>0"
               ''Modified by Morgan 2019/2/25 CFP也要
               ''ElseIf strCP01 = "P" And (pCP10 = "1909" Or pCP10 = "1101") Then
               'ElseIf (pCP10 = "1909" Or pCP10 = "1101") Then
               '   If strCPM26 <> "" Then
               '      stSQL = stSQL & " or instr(UPPER(cpp02),'." & UCase(strCPM26) & ".')>0"
               '   End If
               ElseIf (pCP10 = "1909" Or pCP10 = "1101") Then
                  stSQL = stSQL & " OR exists(select * from caseprogress c2,custletterrefext" & _
                     " where c2.cp09=c1.cp43 and cle05=c2.cp01 and cle01=c2.cp10 and cle02 in ('999','" & stCountry & "')" & _
                     " and instr(upper(cpp02),'.'||upper(cle03)||'.')>0)"
               
               'end 2019/7/18
               '來函
               Else
                  'Modified by Morgan 2016/6/28 考慮引證前案不固定檔不必限制
                  'stSQL = stSQL & " or SUBSTR(UPPER(cpp02),-9)='." & pCP10 & ".PDF' "
                  stSQL = stSQL & " or  SUBSTR(UPPER(CPP02),-4)='.PDF' "
                  'end 2016/6/28
               End If
               
            '非臺灣案發文通知函只有信沒有其他文件
            'Modified by Morgan 2018/10/22 CFP發文通知可能會有說明書或圖示 --玫音 Ex:CFP-30459
            'Modified by Morgan 2019/7/18 非台灣案的 異同分析906,報告客戶956 也改抓 custletterrefext 設定(B類收文且附件可能不只一種)
            'ElseIf strCP01 = "CFP" And strCPP01 < "B" Then
            '   If strCPM26a <> "" Then
            '      stSQL = stSQL & " or instr(UPPER(cpp02),'." & UCase(strCPM26a) & ".')>0"
            '   ElseIf pCP10 = "307" Then
            '      If strPA08 = "1" Then
            '         stSQL = stSQL & " or instr(UPPER(cpp02),'.INV.')>0"
            '      Else
            '         stSQL = stSQL & " or instr(UPPER(cpp02),'.UTL.')>0"
            '      End If
            '   End If
            Else
               'CFP發文目前會給客戶本所文件(大陸案只給提申本)
               'Modified by Morgan 2022/6/9 CFP發文除新案的說明書及圖示外其他都不會給--玫音
               'If (strCP01 = "CFP" Or pCP10 = "906" Or pCP10 = "956") Then
               'Modified by Morgan 2023/2/16 +903專利調查 Ex:CFP-033660
               If (strCP01 = "CFP" And InStr(NewCasePtyList, pCP10) > 0) Or pCP10 = "903" Or pCP10 = "906" Or pCP10 = "956" Then
               'end 2022/6/9
                  stSQL = stSQL & " OR exists(select * from custletterrefext where cle05=cp01 and cle01=cp10 and cle02 in ('999','" & stCountry & "')" & _
                     " and instr(upper(cpp02),'.'||upper(cle03)||'.')>0)"
               End If
               
               'Modified by Morgan 2022/6/9 CFP發文除新案的說明書及圖示外其他都不會給--玫音
               'If strCP01 = "CFP" Then
               If strCP01 = "CFP" And InStr(NewCasePtyList, pCP10) > 0 Then
               'end 2022/6/9
                  stSQL = stSQL & " or instr(UPPER(cpp02),'.DWG.')>0"
               End If
               'end 2022/6/9
               
            End If
            'end 2019/7/18
            stSQL = stSQL & ")"
         'end 2016/6/1
         End If
         
         'Added by Morgan 2018/10/15
         'C類來函另外再抓被合併定稿的收文號 LP42
         'Removed by Morgan 2018/11/15 取消,可能會抓錯附件,請User將相關附件移到通知函的收文號
         'Modified by Morgan 2019/10/5 改先開放公文,若有其他文件時再調整 Ex:CFP-31115 通知申請案號+讓渡准
         If Left(strCPP01, 1) = "C" Then
            stSQL = stSQL & " union all"
            stSQL = stSQL & " select '1' Srt1,5 Srt2,length(cpp02) Srt3,cpp01,cpp02,cp01,cp02,cp03,cp04"
            stSQL = stSQL & " ,'('||Round(cpp03 / 1024, 2)||' KB) '||GETFILEDESC(cpp02,CP01,CP10,'" & stCountry & "') as FDesc"
            stSQL = stSQL & " from letterprogress a,letterprogress b,casepaperpdf c,caseprogress" & _
               " where a.LP01='" & strCPP01 & "' and b.lp42(+)=a.lp01 and cpp01(+)=b.lp01 and cp09(+)=cpp01" & _
               " and SUBSTR(UPPER(CPP02),-9)='.'||cp10||'.PDF' And cpp10<>'D'" & stExceptCon
         End If
         'end 2019/10/5
         'end 2018/11/15
         'end 2018/10/15
        
      'Modify By Sindy 2020/11/5 參考專利修改
      '商標
      Else
         stSort2 = PUB_GetAttSort("T")
         '客戶函在最上面
         '臺灣案
         If stCountry = "000" Then
            '來函 C, D 類
            If Left(strCPP01, 1) = "C" Or Left(strCPP01, 1) = "D" Then
               stSQL = " select '1' Srt1," & stSort2 & " Srt2,length(cpp02) Srt3,cpp01,cpp02,cp01,cp02,cp03,cp04" & _
                  ",'('||Round(cpp03 / 1024, 2)||' KB) '||GETFILEDESC(cpp02,CP01,CP10,'" & stCountry & "') as FDesc" & _
                  " from casepaperpdf c,caseprogress where cpp01='" & strCPP01 & "' and cp09(+)=cpp01 And cpp10<>'D'" & stExceptCon & _
                  " and SUBSTR(UPPER(CPP02),-4)='.PDF'"
               'Add By Sindy 2020/11/30 1717剔除官方來函
               If pCP10 = "1717" Then
                  stSQL = stSQL & " and SUBSTR(UPPER(CPP02),-9)<>'.'||cp10||'.PDF'"
               End If
               '通知申請號一併抓申請程序的檔案
               '抓收據 instr(upper(cpp02),'.RECEIPT.')>0
               '有設定檔的(custletterrefext)
               If pCP10 = "1101" Then
                  stSort2x = PUB_GetAttSort("T", "a.cp10")
                  stSQL = stSQL & " union all"
                  stSQL = stSQL & " select '1' Srt1," & stSort2x & " Srt2,length(cpp02) Srt3,cpp01,cpp02,a.cp01,a.cp02,a.cp03,a.cp04" & _
                     ",'('||Round(cpp03 / 1024, 2)||' KB) '||GETFILEDESC(cpp02,b.CP01,b.CP10,'" & stCountry & "') as FDesc" & _
                     " from caseprogress a,caseprogress b,casepaperpdf c" & _
                     " where a.cp09='" & strCPP01 & "' and b.cp09(+)=a.cp43 and cpp01(+)=a.cp43 and SUBSTR(UPPER(CPP02),-4)='.PDF' And cpp10<>'D'" & stExceptCon & _
                     " and (instr(upper(cpp02),'.RECEIPT.')>0 OR exists(select * from custletterrefext where cle05=b.cp01 and cle01=b.cp10 and cle02='" & stCountry & "'" & _
                     " and instr(upper(cpp02),'.'||upper(cle03)||'.')>0 AND ( CLE04 IS NULL OR CLE04=DECODE(b.CP118,NULL,2,1) ) ) )"
               End If
               
            '發文 A,B 類
            Else
               'pdf檔只列給看得
               '收據要判斷有發文規費的才抓否則為回執不用給客戶
               'Modify By Sindy 2020/11/26 + DATA,CONTACT
               'Modify By Sindy 2021/5/31 + CDATA
               stSQL = "select '1' Srt1," & stSort2 & " Srt2,length(cpp02) Srt3,cpp01,cpp02,cp01,cp02,cp03,cp04" & _
                  ",'('||Round(cpp03 / 1024, 2)||' KB) '||GETFILEDESC(cpp02,CP01,CP10,'" & stCountry & "') as FDesc" & _
                  " from casepaperpdf c,caseprogress where cpp01='" & strCPP01 & "' and SUBSTR(UPPER(CPP02),-4)='.PDF' And cpp10<>'D'" & stExceptCon & _
                  " and cp09(+)=cpp01 and (instr(upper(cpp02),'.CUS.')>0 OR (instr(upper(cpp02),'.DATA.')>0 and cp10<>'717')" & _
                  " OR instr(upper(cpp02),'.CONTACT.')>0 OR instr(upper(cpp02),'.CDATA.')>0" & _
                  " OR (instr(UPPER(cpp02),'.RECEIPT.')>0 and cp84>0)" & _
                  " OR exists(select * from custletterrefext where cle05=cp01 and cle01=cp10 and cle02='" & stCountry & "'" & _
                  " and instr(upper(cpp02),'.'||upper(cle03)||'.')>0 AND ( CLE04 IS NULL OR CLE04=DECODE(CP118,NULL,2,1))))"
            End If
            
         '非臺灣案：排除指示信
         Else
            stSQL = " select '1' Srt1," & stSort2 & " Srt2,length(cpp02) Srt3,cpp01,cpp02,cp01,cp02,cp03,cp04" & _
               ",'('||Round(cpp03 / 1024, 2)||' KB) '||GETFILEDESC(cpp02,CP01,CP10,'" & stCountry & "') as FDesc" & _
               " from casepaperpdf,caseprogress c1 where cpp01='" & strCPP01 & "' and SUBSTR(UPPER(CPP02),-4)='.PDF' And cpp10<>'D'" & stExceptCon & _
               " and cp09(+)=cpp01 and ( instr(upper(cpp02),'.CUS.')>0"
            '來函 C, D 類
            If Left(strCPP01, 1) = "C" Or Left(strCPP01, 1) = "D" Then
'               '已提申代理人可能會給別的文件但不用給客戶故改為只抓可以給的
'               '1909.已提申 1101.通知申請案號
'               If (pCP10 = "1909" Or pCP10 = "1101") Then
''                  stSQL = stSQL & " or instr(UPPER(cpp02),'.RECEIPT.')>0"
''                  stSQL = stSQL & " or instr(UPPER(cpp02),'.FIL.')>0" '.FIL受理通知書
''                  stSQL = stSQL & " or instr(UPPER(cpp02),'.ATT.')>0" '.ATT其他各式附件
'                  stSQL = stSQL & " or SUBSTR(UPPER(CPP02),-9)='.'||cp10||'.PDF'" '公文 T-229314(大陸案)
'               '來函
'               Else
                  stSQL = stSQL & " Or SUBSTR(UPPER(CPP02),-4)='.PDF'"
'               End If
               
'               'Add by Amy 2019/12/02 T字頭1729(撤三開拓)/1725(通知期限)/1717(通知延展)/1720(通知繳納註冊費)另夾帶ATT檔
'               If Left(strCP01, 1) = "T" And (pCP10 = "1729" Or pCP10 = "1725" Or pCP10 = "1717" Or pCP10 = "1720") Then
'                  stSQL = stSQL & " Or Exists(Select * From CustLetterRefExt Where cle05=cp01 and cle01=cp10 and cle02 in ('999','" & stCountry & "')" & _
'                     " and instr(upper(cpp02),'.'||upper(cle03)||'.')>0)"
'               End If
'               '2019/12/02 END
               
               '加抓相關收文號的 custletterrefext 設定
               If (pCP10 = "1909" Or pCP10 = "1101") Then
                  stSQL = stSQL & " Or exists(select * from caseprogress c2,custletterrefext" & _
                     " where c2.cp09=c1.cp43 and cle05=c2.cp01 and cle01=c2.cp10 and cle02 in ('999','" & stCountry & "')" & _
                     " and instr(upper(cpp02),'.'||upper(cle03)||'.')>0)"
               End If
            
            '發文 A,B 類
            Else
               'pdf檔只列給看得
'               '發文目前會給客戶本所文件(大陸案只給提申本)
'               'If (pCP10 = "906" Or pCP10 = "956") Then
                  stSQL = stSQL & " OR (instr(upper(cpp02),'.CDATA.')>0 and substr(cp09,1,1)='A')" & _
                     " OR exists(select * from custletterrefext where cle05=cp01 and cle01=cp10 and cle02 in ('999','" & stCountry & "')" & _
                     " and instr(upper(cpp02),'.'||upper(cle03)||'.')>0)"
'               'End If
            End If
            stSQL = stSQL & ")"
            'Modify By Sindy 2023/6/21 取消:跑歷程時承辦人就會拆檔案存放各案號的.CDATA.
'            'Add By Sindy 2021/1/7 非台灣案A類若為"多案單筆歷程"操作的送件，複合案要夾帶主要操作"多案單筆歷程的附件.CDATA."
'            If Left(strCPP01, 1) = "A" Then
'               strExc(10) = "select cp09,cp01,cp02,cp03,cp04,cp163 from caseprogress where cp09='" & strCPP01 & "' and cp09<>cp163 and cp163 is not null"
'               intQ = 1
'               Set rsQuery = ClsLawReadRstMsg(intQ, strExc(10))
'               If intQ = 1 Then
'                  strCP163 = rsQuery.Fields("CP163")
'                  stSQL = stSQL & " union all"
'                  stSQL = stSQL & " select '1' Srt1," & stSort2 & " Srt2,length(cpp02) Srt3,cpp01,cpp02,cp01,cp02,cp03,cp04" & _
'                     ",'('||Round(cpp03 / 1024, 2)||' KB) '||GETFILEDESC(cpp02,CP01,CP10,'" & stCountry & "') as FDesc" & _
'                     " from casepaperpdf,caseprogress c1 where cpp01='" & strCP163 & "' and SUBSTR(UPPER(CPP02),-4)='.PDF' And cpp10<>'D'" & _
'                     " and cp09(+)=cpp01 and instr(upper(cpp02),'.CDATA.')>0"
'               End If
'            End If
'            '2021/1/7 END
         End If
         
         'C,D類來函另外再抓被合併定稿的收文號 LP42
         'Modify By Sindy 2020/11/30 1717剔除官方來函
         If (Left(strCPP01, 1) = "C" Or Left(strCPP01, 1) = "D") And pCP10 <> "1717" Then
            '抓公文
            stSQL = stSQL & " union all"
            stSQL = stSQL & " select '1' Srt1,5 Srt2,length(cpp02) Srt3,cpp01,cpp02,cp01,cp02,cp03,cp04"
            stSQL = stSQL & " ,'('||Round(cpp03 / 1024, 2)||' KB) '||GETFILEDESC(cpp02,CP01,CP10,'" & stCountry & "') as FDesc"
            stSQL = stSQL & " from letterprogress a,letterprogress b,casepaperpdf c,caseprogress" & _
               " where a.LP01='" & strCPP01 & "' and b.lp42(+)=a.lp01 and cpp01(+)=b.lp01 and cp09(+)=cpp01" & _
               " and SUBSTR(UPPER(CPP02),-9)='.'||cp10||'.PDF' And cpp10<>'D'" & stExceptCon
'            及 設定檔
'               " and (SUBSTR(UPPER(CPP02),-9)='.'||cp10||'.PDF'" & _
'               " or Exists(Select * From CustLetterRefExt Where cle05=b.cp01 and cle01=b.cp10 and cle02 in ('999','" & stCountry & "')" & _
'                                    " and instr(upper(cpp02),'.'||upper(cle03)||'.')>0)" & _
'               ")"
         End If
         
         'Add By Sindy 2020/2/3
         '1717(通知延展)要一併抓相關總收文號的通知期限Att檔
         If pCP10 = "1717" Then
            stSQL = stSQL & " union all select '2' Srt1,9 Srt2,length(cpp02) Srt3,cpp01,cpp02,a.cp01,a.cp02,a.cp03,a.cp04" & _
               ",'('||Round(cpp03 / 1024, 2)||' KB) '||GETFILEDESC(cpp02,b.CP01,b.CP10,'" & stCountry & "') as FDesc" & _
               " from caseprogress a,caseprogress b,casepaperpdf c" & _
               " where a.cp09='" & strCPP01 & "' and a.cp43 is not null" & _
               " and b.cp01(+)=a.cp01 and b.cp02(+)=a.cp02 and b.cp03(+)=a.cp03 and b.cp04(+)=a.cp04 and b.cp43=a.cp43 and b.cp10='1725'" & _
               " and cpp01(+)=b.cp09 And cpp10<>'D'" & _
               " and Exists(Select * From CustLetterRefExt Where cle05=b.cp01 and cle01=b.cp10 and cle02='999' " & _
                                    "and instr(upper(cpp02),'.'||upper(cle03)||'.')>0)"
            'Add By Sindy 2020/10/26 抓合併定稿的電子檔
            stSQL = stSQL & " union all select '2' Srt1,9 Srt2,length(cpp02) Srt3,cpp01,cpp02,a.cp01,a.cp02,a.cp03,a.cp04" & _
               ",'('||Round(cpp03 / 1024, 2)||' KB) '||GETFILEDESC(cpp02,b.CP01,b.CP10,'" & stCountry & "') as FDesc" & _
               " from letterprogress,caseprogress a,caseprogress b,casepaperpdf c" & _
               " where lp42='" & strCPP01 & "' and a.cp09=lp01 and a.cp43 is not null" & _
               " and b.cp01(+)=a.cp01 and b.cp02(+)=a.cp02 and b.cp03(+)=a.cp03 and b.cp04(+)=a.cp04 and b.cp43=a.cp43 and b.cp10='1725'" & _
               " and cpp01(+)=b.cp09 And cpp10<>'D'" & _
               " and Exists(Select * From CustLetterRefExt Where cle05=b.cp01 and cle01=b.cp10 and cle02='999' " & _
                                    "and instr(upper(cpp02),'.'||upper(cle03)||'.')>0)"
         End If
         '2020/2/3 END
     '2020/11/5 END
      End If
      
      'Added by Morgan 2016/11/8
      '副本信函
      If bolIsCopy Then
         stSQL = stSQL & " union select '1' Srt1,1 Srt2,0 Srt3,cpp01,cpp02,cp01,cp02,cp03,cp04" & _
            ",'('||Round(cpp03 / 1024, 2)||' KB) '||GETFILEDESC(cpp02,CP01,CP10,'" & stCountry & "') as FDesc" & _
            " from casepaperpdf,caseprogress where cpp01='" & str990CP09 & "' and SUBSTR(UPPER(cpp02),-8)='.CUS.PDF' and cp09(+)=cpp01"
      End If
      'end 2016/11/8
      
      'Modified by Morgan 2020/11/4 配合商標一文多案需求排序統一加本所案號
      ''專利
      'If strCP01 = "P" Or strCP01 = "PS" Or strCP01 = "CFP" Or strCP01 = "CPS" Then
      '   stSQL = stSQL & " order by Srt1,Srt2,Srt3"
      ''Add By Sindy 2020/10/26 商標要先依本所案號排序,因有多案
      'Else
      '   stSQL = stSQL & " order by cp01,cp02,cp03,cp04,Srt1,Srt2,Srt3"
      'End If
      ''2020/10/26 END
      'Modified by Morgan 2023/6/7 +排除EFileCaption有設定要排除的副檔名
      'stSQL = stSQL & " order by cp01,cp02,cp03,cp04,Srt1,Srt2,Srt3"
      stSQL = "select * from (" & stSQL & ") where not exists(select * from EFileCaption where (efc01='ALL' or efc01=cp01) and instr(upper(cpp02),'.'||efc02||'.')>0 and efc07='Y') order by cp01,cp02,cp03,cp04,Srt1,Srt2,Srt3"
      'end 2023/6/7
      'end 2020/11/4
      
      intQ = 1
      Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
      If intQ = 1 Then
         With rsQuery
         
         Do While Not .EOF
            '檔名含空白無法合併
            'Modified by Morgan 2025/5/7 pdf加confidential要存成收文號+原檔名以便更換檔案
            'stAttPath = pSavePath & "\" & Replace(.Fields("cpp02"), " ", "_")
            If pJoinDoc Then
               stFileName = Replace(.Fields("cpp02"), " ", "_")
            Else
               stFileName = .Fields("cpp02")
            End If
            If ForUpdate Then
               stFileName = .Fields("cpp01") & "." & stFileName
            End If
            stAttPath = pSavePath & "\" & stFileName
            'end 2025/5/7
            
            If Dir(stAttPath) = "" And pNoDown = False Then '檔案存在時不必再下載
               If PUB_GetAttachFile_CPP(.Fields("cpp01"), .Fields("cpp02"), stAttPath, True) = False Then
                  Exit Function
               End If
            End If
            '檔名含空白無法合併
            'Modified by Morgan 2025/5/7
            'pFileName = IIf(pFileName = "", "", pFileName & ";") & stSavePath & Replace(.Fields("cpp02"), " ", "_")
            'stFileList = IIf(stFileList = "", "", stFileList & ";") & Replace(.Fields("cpp02"), " ", "_")
            'pFileDescs = pFileDescs & Replace(.Fields("cpp02"), " ", "_") & Chr(9) & .Fields("FDesc") & ";"
            pFileName = IIf(pFileName = "", "", pFileName & ";") & stSavePath & stFileName
            stFileList = IIf(stFileList = "", "", stFileList & ";") & stFileName
            pFileDescs = pFileDescs & stFileName & Chr(9) & .Fields("FDesc") & ";"
            'end 2025/5/7
            .MoveNext
         Loop
         End With
         PUB_GetAttachFile4Cust = True
         
         'Modified by Morgan 2020/9/21 從外層移來
         If pJoinDoc And pNoDown = False Then
            'If InStr(stFileList, ";") > 0 Then 'Removed by Morgan 2019/1/29 一個也要更名，否則EMail當作附件時會有鎖住問題
               If Dir(pSavePath & "\" & stTempFile) = "" Then
                  If PUB_JoinPdf(stFileList, stTempFile, pSavePath) = True Then
                     pFileName = stSavePath & stTempFile
                  End If
               Else
                  pFileName = stSavePath & stTempFile
               End If
            'End If
         End If
         'end 2020/9/21
      End If
   End If
   
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
   Set rsQuery = Nothing
   
End Function

'Added by Morgan 2019/6/27
'客戶函/公文判發附件排序
Public Function PUB_GetAttSort(pSys As String, Optional pCP10 As String = "cp10") As String
   '專利
   If pSys = "P" Then
      'Modified by Morgan 2018/9/19 +回覆單(blank,CFP來函有簡單報告時會有)
      'Modified by Morgan 2019/9/20 +公文
      '文件順序1.客戶函(cus) 2.回覆單(blank) 3.收據(receipt) 4.申請書(data) 5.公文 6.說明書(inv,utl,des...), 7.圖(dwg), 8.代理人來函(altr)
      PUB_GetAttSort = " decode(instr(lower(cpp02),'.cus.'),0" & _
                       ",decode(instr(lower(cpp02),'.blank.'),0" & _
                       ",decode(instr(lower(cpp02),'.receipt.'),0" & _
                       ",decode(instr(lower(cpp02),'.data.'),0" & _
                       ",decode(instr(lower(cpp02),'.'||" & pCP10 & "||'.pdf'),0" & _
                       ",decode(instr(lower(cpp02),'.dwg.'),0" & _
                       ",decode(instr(lower(cpp02),'.altr.'),0" & _
                       ",6,8),7),5),4),3),2),1)"
   '商標
   ElseIf pSys = "T" Then
      '文件順序1.客戶函(cus) 2.回覆單(blank) 3.收據(receipt) 4.申請書(data) 5.公文 6.說明書(inv,utl,des...), 7.代理人來函(altr)
      PUB_GetAttSort = " decode(instr(lower(cpp02),'.cus.'),0" & _
                       ",decode(instr(lower(cpp02),'.blank.'),0" & _
                       ",decode(instr(lower(cpp02),'.receipt.'),0" & _
                       ",decode(instr(lower(cpp02),'.data.'),0" & _
                       ",decode(instr(lower(cpp02),'.'||" & pCP10 & "||'.pdf'),0" & _
                       ",decode(instr(lower(cpp02),'.altr.'),0" & _
                       ",6,7),5),4),3),2),1)"
   End If
End Function

'pdf合併(檔名以分號區隔),目的預設與來源相同
Public Function PUB_JoinPdf(pFromFiles As String, pToFileName As String, pFromPath As String) As Boolean
   Dim strCmd As String
   Dim stNewFiles As String
   Dim process_id As Long
   Dim process_handle As Long
   Dim bolRetry As Boolean
   Dim oFileSys As New FileSystemObject
   'Modified by Morgan 2016/3/3 不可指定File型態,因與File專案同名會錯
   'Dim oFile As File
   Dim oFile

On Error GoTo ErrHnd
   
   '切換至來源目錄
      If pFromPath <> "." Then ChDir pFromPath
      stNewFiles = pFromFiles
   
   '1個檔案用更名
   If InStr(stNewFiles, ";") = 0 Then
      Set oFile = oFileSys.GetFile(stNewFiles)
      bolRetry = False
      'Modified by Morgan 2019/3/4 改用複製(考慮EMail檢查附件及下拉選單問題)
      'oFile.Name = pToFileName
      oFile.Copy pToFileName
   '合併
   Else
      '刪舊檔
      If Dir(".\" & pToFileName) <> "" Then
          Kill ".\" & pToFileName
      End If
      
      '特殊路徑無法存檔故先就地合併
      'Modified by Morgan 2016/3/3 加雙引號可允許空白路徑
      stNewFiles = Replace(stNewFiles, ";", """ """)
      strCmd = pub_PdftkEXE & " """ & stNewFiles & """ cat output "".\" & pToFileName & """"
      
      process_id = SHELL(strCmd, vbHide)
      process_handle = OpenProcess(PROCESS_TERMINATE, 0, process_id)
      If process_handle <> 0 Then
         For intI = 1 To 10
            If PUB_CheckIsRunning(pub_PdftkName) = True Then
               Sleep 1000
            Else
               Exit For
            End If
         Next
         If intI > 10 Then
            TerminateProcess process_handle, 0&
            CloseHandle process_handle
            GoTo ExitPoint
         Else
            CloseHandle process_handle
         End If
      Else
         GoTo ExitPoint
      End If
   End If
      
   PUB_JoinPdf = True
   
ErrHnd:
   If Err.Number <> 0 Then
      '檔案可能不會馬上釋放,會無法更名
      If Err.Number = 70 And bolRetry = False Then
         Sleep 1000
         bolRetry = True
         Resume
      Else
         MsgBox Err.Description, vbCritical
      End If
   End If
   
ExitPoint:
   
   ChDir App.path '目錄切回
   Set oFile = Nothing
   Set oFileSys = Nothing
End Function

'Add By Sindy 2016/4/13 從收文作業(frm010005)抽出來，變共用Func
Public Sub PUB_UpdRelationCaseFixEP(pa01 As String, pa02 As String, pa03 As String, pa04 As String, _
                                    CP10 As String, Optional lblCaseProperty As String = "")
Dim IsEmpFlow08 As Boolean, IsEmpFlow15 As Boolean, strEmpFlow15Num As String
Dim strCP14 As String, strText As String
Dim intMaxEEP02 As Integer
Dim strCP13 As String, strEEP05 As String
Dim rsQuery As ADODB.Recordset
Dim strEEP10 As String 'Added by Lydia 2017/06/14 副本收受者
Dim strTmp(4) As String 'Added by Morgan 2024/7/29 原使用全域變數 strExc 的都改為區域變數 strTMP ,否則會錯亂 Ex:P133405通知修正 的EMail主旨

   'Added by Morgan 2013/8/1
   'P或CFP案收文主動修正203或修正204時若有相關新案已齊備未發文則清除完稿日及會稿日並EMail通知承辦人
   If (pa01 = "CFP" Or pa01 = "P") And (CP10 = "203" Or CP10 = "204") Then
      'Modify By Sindy 2016/3/25 + ep08,ep38,cp13,cp01,cp02,cp03,cp04
      'Modified by Morgan 2016/7/26 相關案要排除FCP
      strTmp(0) = "select cp09,cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) CNo,cp14,ep09,ep07,ep08,ep38,cp13,cp01,cp02,cp03,cp04" & _
         " from (select cm01,cm02,cm03,cm04 from casemap where cm10='0' and cm05='" & pa01 & "' and cm06='" & pa02 & "' and cm07='" & pa03 & "' and cm08='" & pa04 & "'" & _
         " union select cm05,cm06,cm07,cm08 from casemap where cm10='0' and cm01='" & pa01 & "' and cm02='" & pa02 & "' and cm03='" & pa03 & "' and cm04='" & pa04 & "'" & _
         " union select cr01,cr02,cr03,cr04 from caserelation where cr05='" & pa01 & "' and cr06='" & pa02 & "' and cr07='" & pa03 & "' and cr08='" & pa04 & "'" & _
         "),caseprogress,engineerprogress where cp01(+)=cm01 and cp02(+)=cm02 and cp03(+)=cm03 and cp04(+)=cm04 and instr('" & NewCasePtyList & "',cp10)>0" & _
         " and cp27||cp57 is null and ep02(+)=cp09 and ep06>0 and cp01<>'FCP'"
      intI = 1
      Set rsQuery = ClsLawReadRstMsg(intI, strTmp(0))
      If intI = 1 Then
         'Modify By Sindy 2025/1/13 秀玲提,收受者原帶QPGMR,應改為操作人員較合適
         Do While Not rsQuery.EOF
            strTmp(1) = rsQuery("Cno") & " 的相關案 " & pa01 & "-" & pa02 & IIf(pa03 & pa04 = "000", "", "-" & pa03 & "-" & pa04) & " 已收文" & lblCaseProperty & "，請於2日內確認預定修正的內容..."
            If IsNull(rsQuery("ep09")) Then
               strTmp(2) = "無"
            Else
               'modify by sonia 2019/11/26 incCNV_CHINESE_MINKO改用incCNV_CHINESE_MINKO1
               strTmp(2) = TranslateKeyWord(incCNV_CHINESE_MINKO1, rsQuery("ep09"), "")
            End If
            If IsNull(rsQuery("ep07")) Then
               strTmp(3) = "無"
            Else
               'modify by sonia 2019/11/26 incCNV_CHINESE_MINKO改用incCNV_CHINESE_MINKO1
               strTmp(3) = TranslateKeyWord(incCNV_CHINESE_MINKO1, rsQuery("ep07"), "")
            End If
            strTmp(4) = rsQuery("Cno") & " 的相關案 " & pa01 & "-" & pa02 & IIf(pa03 & pa04 = "000", "", "-" & pa03 & "-" & pa04) & " 已收文" & lblCaseProperty & "，請於2日內確認預定修正的內容，" & _
               "若修正內容已實質改變原齊備內容，請修改齊備日；若修正內容未實質改變原齊備內容，請將原完稿日及原會稿日(若有)填入系統。" & _
               vbCrLf & "原完稿日：" & strTmp(2) & _
               vbCrLf & "原會稿日：" & strTmp(3)
               
            '105/2/19 林柄佑:P案收文主動修正對CFP案的影響
            '對於已經會稿的案件，將保留原有的齊備日、完稿日及會稿日，由系統自動產生一道「會修」的程序。(通知信內容：CFP-XXXXXX 的相關案 P-XXXXXX 已收文主動修正，請確認修正的內容，並重新送會。)
            'Add By Sindy 2016/3/25
            '是否送會中
            IsEmpFlow08 = False
            strSql = "select eep01,eep02,eep04,eep05,eep09 from empelectronprocess Where eep01='" & rsQuery("cp09") & "' and eep04='" & EMP_送會 & "' and eep09='Y'"
            CheckOC3
            AdoRecordSet3.CursorLocation = adUseClient
            AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
            If AdoRecordSet3.RecordCount <> 0 Then
               IsEmpFlow08 = True
            End If
            '是否判發中
            IsEmpFlow15 = False
            strSql = "select eep01,eep02,eep04,eep05,eep09 from empelectronprocess Where eep01='" & rsQuery("cp09") & "' and (eep04='" & EMP_判發 & "' or eep04='" & EMP_退件重送 & "') and eep13='Y'"
            CheckOC3
            AdoRecordSet3.CursorLocation = adUseClient
            AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
            If AdoRecordSet3.RecordCount <> 0 Then
               IsEmpFlow15 = True
               strEmpFlow15Num = AdoRecordSet3.Fields("eep02")
               strEEP05 = AdoRecordSet3.Fields("eep05")
            End If
            '2016/3/25 END
            'Add By Sindy 2016/3/25
            '承辦人
            If "" & rsQuery("cp14") <> "" Then
               strCP14 = rsQuery("cp14")
               '若為外翻人員
               If Left(strCP14, 1) = "F" Then
                  strText = Trim(PUB_GetST14(strCP14))
                  If strText <> "" Then
                     strCP14 = strText
                  Else
                     strText = Trim(Pub_GetSpecMan("H"))
                     If strText <> "" Then
                        strCP14 = strText
                     End If
                  End If
                  'Added by Lydia 2017/03/28 ST14改成多個編號,所以只取第一位
                  If InStr(strCP14, ",") > 0 Or InStr(strCP14, ";") > 0 Then
                     strCP14 = Replace(Replace(Mid(strCP14, 1, 6), ",", ""), ";", "")
                     'Added by Lydia 2017/06/15 若內部郵件收件員工編號有1人以上，第一人設收受者，其他設為副本。
                     If Len(strText) > 6 Then
                        strText = Replace(strText, ";", ",")
                        strEEP10 = Mid(strText, InStr(strText, ",") + 1)
                     End If
                     'end 2017/06/15
                  End If
                  'end 2017/03/28
               End If
            End If
            '智權人員
            If "" & rsQuery("cp13") <> "" Then
               strCP13 = rsQuery("cp13")
               '檢查智權人員是否離職
               If ChkStaffST04(strCP13, False) = True Then
                  strCP13 = PUB_GetAKindSalesNo(rsQuery("cp01"), rsQuery("cp02"), rsQuery("cp03"), rsQuery("cp04"))
               End If
            End If
            If rsQuery("ep09") > 0 Then
'*************************************************************************************************
               '1.會稿中(有會稿日,無會完日,有送會待回)：會修
               If IsEmpFlow08 = True And strCP14 <> "" Then
                  '將送會待回覆更新為Null
                  strSql = "update empelectronprocess set" & _
                           " EEP09=null" & _
                           " where eep01='" & rsQuery("cp09") & "' and eep04='" & EMP_送會 & "' and eep09='Y'"
                  cnnConnection.Execute strSql
                  '取得最大序號
                  intMaxEEP02 = 0
                  strSql = "select eep02 From empelectronprocess where eep01='" & rsQuery("cp09") & "' order by eep02 desc"
                  intI = 1
                  CheckOC3
                  Set AdoRecordSet3 = ClsLawReadRstMsg(intI, strSql)
                  If intI = 1 Then
                     AdoRecordSet3.MoveFirst
                     If AdoRecordSet3.RecordCount > 0 Then
                        intMaxEEP02 = AdoRecordSet3.Fields(0)
                     End If
                  End If
                  '新增會修歷程
                  'Modify By Sindy 2016/12/21 " & CNULL(strUserNum) & " ==> 'QPGMR' ex:CFP-029009
                  'Modified by by Lydia 2017/06/15 若內部郵件收件員工編號有1人以上，第一人設收受者，其他設為副本。+eep10
                  strSql = "insert into empelectronprocess(eep01,eep02,eep03,eep04,eep05,eep06,eep07,eep08,eep10) values(" & _
                           CNULL(rsQuery("cp09")) & "," & intMaxEEP02 + 1 & ",'" & strUserNum & "'," & _
                           CNULL(EMP_會修) & "," & _
                           CNULL(strCP14) & "," & _
                           strSrvDate(1) & "," & Right("000000" & ServerTime, 6) & ",'相關案 " & pa01 & "-" & pa02 & IIf(pa03 & pa04 = "000", "", "-" & pa03 & "-" & pa04) & " 已收文" & lblCaseProperty & "，請確認修正的內容，並重新送會','" & strEEP10 & "')"
                  cnnConnection.Execute strSql
                  'E-mail
                  strTmp(1) = rsQuery("Cno") & " 的相關案 " & pa01 & "-" & pa02 & IIf(pa03 & pa04 = "000", "", "-" & pa03 & "-" & pa04) & " 已收文" & lblCaseProperty & "，請確認修正的內容，並重新送會"
                  'Modified by by Lydia 2017/06/15 若內部郵件收件員工編號有1人以上，第一人設收受者，其他設為副本。
                  'strSql = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08,MC09) values ('" & strUserNum & "','" & strCP14 & "',to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss'),'" & strTMP(1) & "','" & strTMP(1) & "'," & IIf(strCP13 = strCP14, "NULL", CNULL(strCP13)) & ")"
                  If strCP13 <> "" And InStr(strEEP10, strCP13) = 0 Then
                     strTmp(2) = strCP13 & ";" & Replace(strEEP10, ",", ";")
                  Else
                     strTmp(2) = Replace(strEEP10, ",", ";")
                  End If
                  strSql = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08,MC09) values ('" & strUserNum & "','" & strCP14 & "',to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss'),'" & strTmp(1) & "','" & strTmp(1) & "','" & strTmp(2) & "')"
                  'end 2017/06/15
                  cnnConnection.Execute strSql, intI
'*************************************************************************************************
               '2.會完未判發(有會完日,無判發及退件重送)：會完重修
               ElseIf rsQuery("ep08") > 0 And IsEmpFlow15 = False And strCP14 <> "" Then
                  '記錄原日期於進度備註裡
                  strSql = "update caseprogress" & _
                           " set cp64=(select '系統自動會完重修:原會稿完成日='||ep08||'原智權人員會稿完成日='||ep38||';'||cp64 from caseprogress,engineerprogress where cp09='" & rsQuery("cp09") & "' and cp09=ep02(+))" & _
                           " where cp09='" & rsQuery("cp09") & "'"
                  cnnConnection.Execute strSql
                  '清除EP08.會稿完成日,EP38.業務會稿完成日
                  strSql = "update engineerprogress set" & _
                                 " EP08=null,EP38=null" & _
                           " where ep02='" & rsQuery("cp09") & "'"
                  cnnConnection.Execute strSql
                  '取得最大序號
                  intMaxEEP02 = 0
                  strSql = "select eep02 From empelectronprocess where eep01='" & rsQuery("cp09") & "' order by eep02 desc"
                  intI = 1
                  CheckOC3
                  Set AdoRecordSet3 = ClsLawReadRstMsg(intI, strSql)
                  If intI = 1 Then
                     AdoRecordSet3.MoveFirst
                     If AdoRecordSet3.RecordCount > 0 Then
                        intMaxEEP02 = AdoRecordSet3.Fields(0)
                     End If
                  End If
                  '新增會完重修歷程
                  'Modify By Sindy 2016/12/21 " & CNULL(strUserNum) & " ==> 'QPGMR'
                  'Modified by by Lydia 2017/06/15 若內部郵件收件員工編號有1人以上，第一人設收受者，其他設為副本。+eep10
                  strSql = "insert into empelectronprocess(eep01,eep02,eep03,eep04,eep05,eep06,eep07,eep08,eep10) values(" & _
                           CNULL(rsQuery("cp09")) & "," & intMaxEEP02 + 1 & ",'" & strUserNum & "'," & _
                           CNULL(EMP_會完重修) & "," & _
                           CNULL(strCP14) & "," & _
                           strSrvDate(1) & "," & Right("000000" & ServerTime, 6) & ",'相關案 " & pa01 & "-" & pa02 & IIf(pa03 & pa04 = "000", "", "-" & pa03 & "-" & pa04) & " 已收文" & lblCaseProperty & "，請確認修正的內容，並重新送會','" & strEEP10 & "')"
                  cnnConnection.Execute strSql
                  'E-mail
                  strTmp(1) = rsQuery("Cno") & " 的相關案 " & pa01 & "-" & pa02 & IIf(pa03 & pa04 = "000", "", "-" & pa03 & "-" & pa04) & " 已收文" & lblCaseProperty & "，請確認修正的內容，並重新送會"
                  'Modified by Lydia 2017/06/15 若內部郵件收件員工編號有1人以上，第一人設收受者，其他設為副本。+mc09
                  strSql = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08,mc09) values ('" & strUserNum & "','" & strCP14 & "',to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss'),'" & strTmp(1) & "','" & strTmp(1) & "','" & Replace(strEEP10, ",", ";") & "')"
                  cnnConnection.Execute strSql, intI
'*************************************************************************************************
               '3.判發中(已判發或退件重送)：退件
               ElseIf IsEmpFlow15 = True And strCP14 <> "" Then
                  '刪除歷程附件承辦單電子檔(刪除條件要和前面刪除FTP檔的同步)
                  PUB_DelFtpFile2 rsQuery("cp09"), " and eef02=" & strEmpFlow15Num & " and instr(upper(eef03),upper('." & EMP_承辦單 & "'))>0 ", "EMPELECTRONFILE"
                  strSql = "delete from empelectronfile" & _
                           " where eef01='" & rsQuery("cp09") & "' and eef02=" & strEmpFlow15Num & " and instr(upper(eef03),upper('." & EMP_承辦單 & "'))>0"
                  cnnConnection.Execute strSql
                  '取得最大序號
                  intMaxEEP02 = 0
                  strSql = "select eep02 From empelectronprocess where eep01='" & rsQuery("cp09") & "' order by eep02 desc"
                  intI = 1
                  CheckOC3
                  Set AdoRecordSet3 = ClsLawReadRstMsg(intI, strSql)
                  If intI = 1 Then
                     AdoRecordSet3.MoveFirst
                     If AdoRecordSet3.RecordCount > 0 Then
                        intMaxEEP02 = AdoRecordSet3.Fields(0)
                     End If
                  End If
                  '新增退件歷程
                  'Modify By Sindy 2016/12/21 " & CNULL(strUserNum) & " ==> 'QPGMR'
                  'Modified by Lydia 2017/06/15 若內部郵件收件員工編號有1人以上，第一人設收受者，其他設為副本。+eep10
                  strSql = "insert into empelectronprocess(eep01,eep02,eep03,eep04,eep05,eep06,eep07,eep08,eep10) values(" & _
                           CNULL(rsQuery("cp09")) & "," & intMaxEEP02 + 1 & ",'" & strUserNum & "'," & _
                           CNULL(EMP_退件) & "," & _
                           CNULL(strCP14) & "," & _
                           strSrvDate(1) & "," & Right("000000" & ServerTime, 6) & ",'相關案 " & pa01 & "-" & pa02 & IIf(pa03 & pa04 = "000", "", "-" & pa03 & "-" & pa04) & " 已收文" & lblCaseProperty & "，請確認修正的內容，是否需要重新送會','" & strEEP10 & "')"
                  cnnConnection.Execute strSql
                  '將附件檔一併移到退件流程中
                  strSql = "update empelectronfile" & _
                           " set eef02=" & (intMaxEEP02 + 1) & _
                           " where eef01='" & rsQuery("cp09") & "' and eef02=" & strEmpFlow15Num
                  cnnConnection.Execute strSql
                  '刪除原始檔區(刪除條件要和前面刪除FTP檔的同步)
                  PUB_DelFtpFile2 rsQuery("cp09"), " and cpf11='S' ", "CASEPAPERFILE"
                  strSql = "delete from casepaperfile where cpf01='" & rsQuery("cp09") & "' and cpf11='S'"
                  cnnConnection.Execute strSql
                  '刪除卷宗區(刪除條件要和前面刪除FTP檔的同步)
                  PUB_DelFtpFile2 rsQuery("cp09"), " and cpp12='S'"
                  strSql = "delete from casepaperpdf where cpp01='" & rsQuery("cp09") & "' and cpp12='S'"
                  cnnConnection.Execute strSql
                  'E-mail
                  strTmp(1) = rsQuery("Cno") & " 的相關案 " & pa01 & "-" & pa02 & IIf(pa03 & pa04 = "000", "", "-" & pa03 & "-" & pa04) & " 已收文" & lblCaseProperty & "，請確認修正的內容，是否需要重新送會"
                  'Modified by Lydia 2017/06/15 若內部郵件收件員工編號有1人以上，第一人設收受者，其他設為副本。
                  'strSql = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08,MC09) values ('" & strUserNum & "','" & strCP14 & "',to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss'),'" & strTMP(1) & "','" & strTMP(1) & "'," & CNULL(strEEP05) & ")"
                  strSql = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08,MC09) values ('" & strUserNum & "','" & strCP14 & "',to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss'),'" & strTmp(1) & "','" & strTmp(1) & "','" & IIf(Len(strEEP05) > 0, strEEP05 & ";" & Replace(strEEP10, ",", ";"), Replace(strEEP10, ",", ";")) & "')"
                  'end 2017/06/15
                  cnnConnection.Execute strSql, intI
               '2016/3/25 END
'*************************************************************************************************
               'Modify By Sindy 2017/10/2 ex:關於CFP-029206事件的補充修正
               '有「會稿日」的案件，由系統產生一道「聯絡」的程序，通知承辦工程師，「對應的P案收文修正，請留意本案是否一併修正」。
               ElseIf Val("" & rsQuery("ep07")) > 0 And strCP14 <> "" Then
                  '取得最大序號
                  intMaxEEP02 = 0
                  strSql = "select eep02 From empelectronprocess where eep01='" & rsQuery("cp09") & "' order by eep02 desc"
                  intI = 1
                  CheckOC3
                  Set AdoRecordSet3 = ClsLawReadRstMsg(intI, strSql)
                  If intI = 1 Then
                     AdoRecordSet3.MoveFirst
                     If AdoRecordSet3.RecordCount > 0 Then
                        intMaxEEP02 = AdoRecordSet3.Fields(0)
                     End If
                  End If
                  '新增聯絡
                  strSql = "insert into empelectronprocess(eep01,eep02,eep03,eep04,eep05,eep06,eep07,eep08,eep10) values(" & _
                           CNULL(rsQuery("cp09")) & "," & intMaxEEP02 + 1 & ",'" & strUserNum & "'," & _
                           CNULL(EMP_聯絡) & "," & _
                           CNULL(strCP14) & "," & _
                           strSrvDate(1) & "," & Right("000000" & ServerTime, 6) & ",'相關案 " & pa01 & "-" & pa02 & IIf(pa03 & pa04 = "000", "", "-" & pa03 & "-" & pa04) & " 已收文" & lblCaseProperty & "，請留意本案是否一併修正！','" & strEEP10 & "')"
                  cnnConnection.Execute strSql
                  'E-mail
                  strTmp(1) = rsQuery("Cno") & " 的相關案 " & pa01 & "-" & pa02 & IIf(pa03 & pa04 = "000", "", "-" & pa03 & "-" & pa04) & " 已收文" & lblCaseProperty & "，請留意本案是否一併修正！"
                  strSql = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08,mc09) values ('" & strUserNum & "','" & strCP14 & "',to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss'),'" & strTmp(1) & "','" & strTmp(1) & "','" & Replace(strEEP10, ",", ";") & "')"
                  cnnConnection.Execute strSql, intI
               '2017/10/2 END
               Else
                  'Modify By Sindy 2017/10/2 Mark,不需清除日期,增加聯絡歷程
'                  'Modify By Sindy 2014/1/10 +EP12
'                  'strSql = "update engineerprogress set ep09=null,ep07=null where ep02='" & rsQuery("cp09") & "'"
'                  strSql = "update engineerprogress set ep09=null,ep07=null,ep12='" & ChangeTStringToTDateString(strSrvDate(2)) & "因相關案" & PA01 & "-" & PA02 & IIf(PA03 & PA04 = "000", "", "-" & PA03 & "-" & PA04) & "已收文" & lblCaseProperty & "故清除相關日期,原完稿日：'||ep09||'原會稿日：'||ep07||';'||ep12 where ep02='" & rsQuery("cp09") & "'"
'                  cnnConnection.Execute strSql, intI
                  '取得最大序號
                  intMaxEEP02 = 0
                  strSql = "select eep02 From empelectronprocess where eep01='" & rsQuery("cp09") & "' order by eep02 desc"
                  intI = 1
                  CheckOC3
                  Set AdoRecordSet3 = ClsLawReadRstMsg(intI, strSql)
                  If intI = 1 Then
                     AdoRecordSet3.MoveFirst
                     If AdoRecordSet3.RecordCount > 0 Then
                        intMaxEEP02 = AdoRecordSet3.Fields(0)
                     End If
                  End If
                  '新增聯絡
                  strSql = "insert into empelectronprocess(eep01,eep02,eep03,eep04,eep05,eep06,eep07,eep08,eep10) values(" & _
                           CNULL(rsQuery("cp09")) & "," & intMaxEEP02 + 1 & ",'" & strUserNum & "'," & _
                           CNULL(EMP_聯絡) & "," & _
                           CNULL(strCP14) & "," & _
                           strSrvDate(1) & "," & Right("000000" & ServerTime, 6) & ",'" & strTmp(4) & "','" & strEEP10 & "')"
                  cnnConnection.Execute strSql
                  '2017/10/2 END
                  'E-mail
                  strSql = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08) values ('" & strUserNum & "','" & rsQuery("cp14") & "',to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss'),'" & strTmp(1) & "','" & strTmp(4) & "')"
                  cnnConnection.Execute strSql, intI
               End If
            Else
               'Modify By Sindy 2017/10/2 增加聯絡歷程
               '取得最大序號
               intMaxEEP02 = 0
               strSql = "select eep02 From empelectronprocess where eep01='" & rsQuery("cp09") & "' order by eep02 desc"
               intI = 1
               CheckOC3
               Set AdoRecordSet3 = ClsLawReadRstMsg(intI, strSql)
               If intI = 1 Then
                  AdoRecordSet3.MoveFirst
                  If AdoRecordSet3.RecordCount > 0 Then
                     intMaxEEP02 = AdoRecordSet3.Fields(0)
                  End If
               End If
               '新增聯絡
               strSql = "insert into empelectronprocess(eep01,eep02,eep03,eep04,eep05,eep06,eep07,eep08,eep10) values(" & _
                        CNULL(rsQuery("cp09")) & "," & intMaxEEP02 + 1 & ",'" & strUserNum & "'," & _
                        CNULL(EMP_聯絡) & "," & _
                        CNULL(strCP14) & "," & _
                        strSrvDate(1) & "," & Right("000000" & ServerTime, 6) & ",'" & strTmp(4) & "','" & strEEP10 & "')"
               cnnConnection.Execute strSql
               '2017/10/2 END
               'E-mail
               strSql = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08) values ('" & strUserNum & "','" & rsQuery("cp14") & "',to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss'),'" & strTmp(1) & "','" & strTmp(4) & "')"
               cnnConnection.Execute strSql, intI
            End If
            rsQuery.MoveNext
         Loop
      End If
   End If
   'end 2013/8/1
   
   Set rsQuery = Nothing
End Sub

'Added by Morgan 2016/4/29
Public Sub PUB_AddDebugLog(pFormName As String, pDebugLog As String)
   cnnConnection.Execute "insert into DebugLog(DL01,DL02,DL03,DL04) values('" & pFormName & "','" & strUserNum & "',sysdate,'" & ChgSQL(pDebugLog) & "')"
End Sub

'Added by Morgan 2016/5/12
'本所案號轉檔名　(Memo by Lydia 2018/03/09 內專P使用)
'Memo by Morgan 2025/6/26 本函數需與DB函數fnCaseNo同步修改
Public Function PUB_CaseNo2FileName(ByVal pCP01 As String, ByVal pCP02 As String, ByVal pCP03 As String, ByVal pCP04 As String) As String
   If pCP03 = "" Then pCP03 = "0"
   If pCP04 = "" Then pCP04 = "00"
   'Modified by Morgan 2020/2/3 配合卷宗區檔名格式統一,CP02改抓全部
   'PUB_CaseNo2FileName = pCP01 & Val(pCP02) & IIf(pCP04 <> "00", "-" & pCP03 & "-" & pCP04, IIf(pCP03 <> "0", "-" & pCP03, ""))
   PUB_CaseNo2FileName = pCP01 & pCP02 & IIf(pCP04 <> "00", "-" & pCP03 & "-" & pCP04, IIf(pCP03 <> "0", "-" & pCP03, ""))
End Function

'Add By Sindy 2016/5/20
'智權人員離職時,調整待會稿區正在送會中及會圖文中的收受者
'Memo by Lydia 2019/08/08 待會稿區 => 專利／商標會稿
Public Sub PUB_SalseLeaveUpEEP05(ByVal strSalse As String, Optional ByVal strCustID As String, _
                                      Optional ByVal bolWLog As Boolean = True)
Dim rsQuery As ADODB.Recordset
Dim strConPA As String, strConSP As String
   
   If ChkStaffST04(strSalse, False) = True Then '已離職
      Screen.MousePointer = vbHourglass
      If strCustID <> "" Then
         strCustID = ChangeCustomerL(strCustID)
         strConPA = " and pa26='" & strCustID & "'"
         strConSP = " and sp08='" & strCustID & "'"
      End If
      '已離職人員正在送會中及會圖文中的歷程
      strExc(0) = "select eep01,eep02,eep04,eep05,cu13,eep09,cu01||cu02" & _
                  " From empelectronprocess,caseprogress,patent,CUSTOMER,staff" & _
                  " where eep04 in('" & EMP_送會 & "','" & EMP_會圖 & "') and eep09='Y' and eep05='" & strSalse & "'" & _
                  " and eep01=cp09(+)" & _
                  " and cp27 is null and cp57 is null" & _
                  " and cp01=pa01(+) and cp02=pa02(+) and cp03=pa03(+) and cp04=pa04(+)" & _
                  " and substr(pa26,1,8)=cu01(+) and substr(pa26,9,1)=cu02(+)" & _
                  " and cu13=st01(+) and st04='1'" & _
                  " and cu13<>eep05" & strConPA & _
                  " Union" & _
                  " select eep01,eep02,eep04,eep05,cu13,eep09,cu01||cu02" & _
                  " From empelectronprocess,caseprogress,servicepractice,CUSTOMER,staff" & _
                  " where eep04 in('" & EMP_送會 & "','" & EMP_會圖 & "') and eep09='Y' and eep05='" & strSalse & "'" & _
                  " and eep01=cp09(+)" & _
                  " and cp27 is null and cp57 is null" & _
                  " and cp01=sp01(+) and cp02=sp02(+) and cp03=sp03(+) and cp04=sp04(+)" & _
                  " and substr(sp08,1,8)=cu01(+) and substr(sp08,9,1)=cu02(+)" & _
                  " and cu13=st01(+) and st04='1'" & _
                  " and cu13<>eep05" & strConSP
      intI = 1
      Set rsQuery = ClsLawReadRstMsg(intI, strExc(0))
      If intI = 1 Then
         rsQuery.MoveFirst
         Do While Not rsQuery.EOF
            'cnnConnection.BeginTrans
            
            strSql = "UPDATE empelectronprocess SET eep05='" & rsQuery.Fields("cu13") & "'" & _
                     " WHERE eep01='" & rsQuery.Fields("eep01") & "' and eep02=" & rsQuery.Fields("eep02")
            If bolWLog = True Then
               Pub_SeekTbLog strSql
            End If
            cnnConnection.Execute strSql
            
            'cnnConnection.CommitTrans
            rsQuery.MoveNext
         Loop
      End If
      Screen.MousePointer = vbDefault
   End If
   Set rsQuery = Nothing
   Exit Sub
   
ErrHand:
   Screen.MousePointer = vbDefault
   'cnnConnection.RollbackTrans
   'Modified by Lydia 2019/08/08 改名稱
   'MsgBox (Err.Description), vbExclamation, "智權人員離職,調整待會稿區正在送會中及會(圖/文)中的收受者"
   MsgBox (Err.Description), vbExclamation, "智權人員離職,調整專利／商標會稿正在送會中及會(圖/文)中的收受者"
End Sub

'Add By Sindy 2016/5/25 檢查人員是否離職,改抓歷程的發送者
Public Function PUB_ChkPersonToGetEEP03(strEEP01 As String, strEmp As String, strEEP04 As String) As String
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset
   
   PUB_ChkPersonToGetEEP03 = strEmp
   If ChkStaffST04(strEmp, False) = True Then '人員是否已離職
      '改抓歷程的發送者
      StrSQLa = "SELECT eep03" & _
                " FROM empelectronprocess" & _
                " WHERE eep01='" & strEEP01 & "' and eep04='" & strEEP04 & "'" & _
                " order by eep06 desc,eep07 desc"
      If rsA.State <> adStateClosed Then rsA.Close
      rsA.CursorLocation = adUseClient
      rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
      If rsA.RecordCount > 0 Then
         rsA.MoveFirst
         PUB_ChkPersonToGetEEP03 = rsA.Fields("eep03")
      End If
   End If
   Set rsA = Nothing
End Function

Public Function PUB_GetFolder(ByVal hWndModal As Long, Optional StartFolder As String = "", Optional Title As String = "Please select a folder:", _
   Optional IncludeFiles As Boolean = False, Optional IncludeNewFolderButton As Boolean = False) As String
    Dim bInf As BrowseInfo
    Dim RetVal As Long
    Dim PathID As Long
    Dim RetPath As String
    Dim Offset As Integer
    'Set the properties of the folder dialog
    bInf.hwndOwner = hWndModal
    bInf.pIDLRoot = 0
    bInf.lpszTitle = Title
    bInf.ulFlags = BIF_RETURNONLYFSDIRS Or BIF_STATUSTEXT
    If IncludeFiles Then bInf.ulFlags = bInf.ulFlags Or BIF_BROWSEINCLUDEFILES
    If IncludeNewFolderButton Then bInf.ulFlags = bInf.ulFlags Or BIF_NEWDIALOGSTYLE
    If StartFolder <> "" Then
       mstrSTARTFOLDER = StartFolder & vbNullChar
       bInf.lpfnCallback = GetAddressofFunction(AddressOf BrowseCallbackProc) 'get address of function.
   End If
    'Show the Browse For Folder dialog
    PathID = SHBrowseForFolder(bInf)
    RetPath = Space$(512)
    RetVal = SHGetPathFromIDList(ByVal PathID, ByVal RetPath)
    If RetVal Then
         'Trim off the null chars ending the path
         'and display the returned folder
         Offset = InStr(RetPath, Chr$(0))
         PUB_GetFolder = Left$(RetPath, Offset - 1)
         'Free memory allocated for PIDL
         CoTaskMemFree PathID
    Else
         PUB_GetFolder = ""
    End If
End Function

Private Function BrowseCallbackProc(ByVal hWnd As Long, ByVal uMsg As Long, ByVal lp As Long, ByVal pData As Long) As Long
   On Error Resume Next
   Dim lpIDList As Long
   Dim ret As Long
   Dim sBuffer As String
   Select Case uMsg
       Case BFFM_INITIALIZED
           Call SendMessage(hWnd, BFFM_SETSELECTION, 1, mstrSTARTFOLDER)
       Case BFFM_SELCHANGED
           sBuffer = Space(MAX_PATH)
           ret = SHGetPathFromIDList(lp, sBuffer)
           If ret = 1 Then
               Call SendMessage(hWnd, BFFM_SETSTATUSTEXT, 0, sBuffer)
           End If
   End Select
   BrowseCallbackProc = 0
End Function

Private Function GetAddressofFunction(add As Long) As Long
 GetAddressofFunction = add
End Function

'Added by Lydia 2016/06/02 抓查名單的結果說明
Public Function PUB_GetTMQans(ByVal aKind As String, ByVal bolA As Boolean) As String
'aKind= 1:近似本所案的結果 2:結果的下拉清單, 3:結果的SQL
'bolA=核可權限
Dim tmpAns As String
    If strSrvDate(1) < TMQFileFTP Then '資料更新之前
        Select Case aKind
            Case "1"
                  TMQ_無 = "6" 'Added by Lydia 2016/07/06
                  TMQ_不查 = "9"
                  TMQ_近似1 = "1": TMQ_近似2 = "2"
                  TMQ_近似T1 = "相同△": TMQ_近似T2 = "近似△"
            Case "2": tmpAns = "1 相同△,2 近似△,3 相同,4 近似,5 稍近似,6 無,9 不查"
            Case "3": tmpAns = "'1','相同△','2','近似△','3','相同','4','近似','5','稍近似','6','無','9','不查',''"
        End Select
    Else
        Select Case aKind
            Case "1"
                  TMQ_無 = "7" 'Added by Lydia 2016/07/06
                  TMQ_不查 = "9"
                  TMQ_近似1 = "2": TMQ_近似2 = "3"
                  TMQ_近似T1 = "相同△": TMQ_近似T2 = "近似△"
            Case "2"
                tmpAns = "1 核可,2 相同△,3 近似△,4 相同,5 近似,6 稍近似,7 無,9 不查"
                If bolA = False Then
                   tmpAns = Replace(tmpAns, "1 核可,", "")
                End If
            Case "3": tmpAns = "'1','核可','2','相同△','3','近似△','4','相同','5','近似','6','稍近似','7','無','9','不查',''"
        End Select
    End If
    PUB_GetTMQans = tmpAns
End Function

'Added by Lydia 2016/06/23 刪除圖檔或附件
Public Function PUB_TMQAFileDel(ByVal tF01 As String, ByVal tF02 As String, ByVal tF03 As String, ByVal tF04 As String) As Boolean
Dim intR As Integer
Dim rsRD As New ADODB.Recordset
Dim strR1 As String
    
On Error GoTo Err01
    
    'Modified by Lydia 2021/11/02 +建檔人 tqf08
    strR1 = "select tqf01,tqf02,tqf03,tqf04,tqf05,tqf08,tqf12 from tmqfile where tqf01='" & tF01 & "' and tqf02='" & tF02 & "' "
    If InStr(tF03, "<>") > 0 And tF03 <> "" Then
      strR1 = strR1 & "and tqf03" & tF03 & " "
    ElseIf tF03 <> "" Then
      strR1 = strR1 & "and tqf03='" & tF03 & "' "
    End If
    strR1 = strR1 & "and tqf04='" & tF04 & "' order by tqf04 "
    intR = 1
    Set rsRD = ClsLawReadRstMsg(intR, strR1)
    If intR = 1 Then
       rsRD.MoveFirst
       Do While Not rsRD.EOF
          '刪除FTP檔案
          If "" & rsRD.Fields("tqf12") <> "" Then
             If PUB_DelFtpFile2(rsRD.Fields("tqf02"), "TQF01='" & rsRD.Fields("tqf01") & "' AND TQF02='" & rsRD.Fields("tqf02") & "' AND TQF03='" & rsRD.Fields("tqf03") & "' AND TQF04='" & rsRD.Fields("tqf04") & "' ", "TMQFILE") = False Then
                Exit Function
             End If
          End If
          strR1 = "delete from TMQFILE where TQF01='" & rsRD.Fields("tqf01") & "' and TQF02='" & rsRD.Fields("tqf02") & "' and TQF03='" & rsRD.Fields("tqf03") & "' and TQF04='" & rsRD.Fields("tqf04") & "' "
          'Added by Lydia 2021/11/02 判斷非建檔人刪除附件，記錄log ; ex.T-234290的HB0040687、HB0040686查名附件不存在
          If strUserNum <> "" & rsRD.Fields("tqf08") Then
               Pub_SeekTbLog strR1
          End If
          'end 2021/11/02
          cnnConnection.Execute strR1, intR

          rsRD.MoveNext
       Loop
       PUB_TMQAFileDel = True
    Else
       PUB_TMQAFileDel = True
    End If
    
    Exit Function
    
Err01:
    If Err.Number <> 0 Then
       MsgBox Err.Description
       cnnConnection.RollbackTrans
    End If
End Function

'Added by Morgan 2016/6/29
'檢查是否有帳單電子檔
'傳入:本所案號(pCP01,pCP02,pCP03,pCP04),案件性質(pCP10),是否更新電子檔的帳單編號(pbolUpdate),帳單編號(pInvoiceNo)
'回傳:錯誤訊息(pErrMsg),電子檔案名稱(pPdfName)
Public Function PUB_CheckInvoicePDF(pCP01 As String, pCP02 As String, pCP03 As String, pCP04 As String, pCP10 As String, Optional ByRef pErrMsg As String, Optional ByRef pFileName As String, Optional pbolUpdate As Boolean = False, Optional pInvoiceNo As String) As Boolean
   Dim stSQL As String, intR As Integer
   Dim rsQuery As ADODB.Recordset
   Dim strFileName As String
   
   strFileName = PUB_CaseNo2FileName(pCP01, pCP02, pCP03, pCP04)
   stSQL = "SELECT ayf02 FROM ACC152 WHERE AYF01='U' AND instr(AYF02,'" & strFileName & "')=1"
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      If rsQuery.RecordCount = 1 Then
         pFileName = rsQuery(0)
         If pbolUpdate And pInvoiceNo <> "" Then
            stSQL = "update ACC152 set ayf01='" & pInvoiceNo & "' where AYF01='U' AND ayf02='" & ChgSQL(rsQuery(0)) & "'"
            cnnConnection.Execute stSQL, intR
            If intR = 1 Then
               PUB_CheckInvoicePDF = True
            Else
               pErrMsg = "帳單 " & pInvoiceNo & " 電子檔 " & rsQuery(0) & " 設定失敗！"
            End If
         Else
            PUB_CheckInvoicePDF = True
         End If
      Else
         stSQL = "SELECT ayf02 FROM ACC152 WHERE AYF01='U' AND instr(AYF02,'" & strFileName & "." & pCP10 & "." & "')=1"
         intR = 1
         Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
         If intR = 1 Then
            If rsQuery.RecordCount = 1 Then
               pFileName = "" & rsQuery(0)
               If pbolUpdate And pInvoiceNo <> "" Then
                  stSQL = "update ACC152 set ayf01='" & pInvoiceNo & "' where AYF01='U' AND ayf02='" & ChgSQL(rsQuery(0)) & "'"
                  cnnConnection.Execute stSQL, intR
                  If intR = 1 Then
                     PUB_CheckInvoicePDF = True
                  Else
                     pErrMsg = "帳單 " & pInvoiceNo & " 電子檔 " & rsQuery(0) & " 設定失敗！"
                  End If
               Else
                  PUB_CheckInvoicePDF = True
               End If
            Else
               pErrMsg = strFileName & "." & pCP10 & "." & "開頭的帳單電子檔有一筆以上，請更正！"
            End If
         Else
               pErrMsg = strFileName & "的帳單電子檔有一筆以上但並無檔案為" & strFileName & "." & pCP10 & "" & "開頭，請更正！"
         End If
      End If
   Else
      pErrMsg = strFileName & "尚未匯入帳單電子檔！"
   End If
   Set rsQuery = Nothing
End Function
 
'Added by Morgan 2016/6/30
'匯入指定案號的帳單電子檔
'Modified by Morgan 2025/8/15 +pImpFolder
Public Function PUB_ImportInvoice(pCP01 As String, pCP02 As String, pCP03 As String, pCP04 As String, Optional pSilence As Boolean = False, Optional pImpFolder As String) As Boolean
   Dim strFolder As String
   Dim oFileSys As New FileSystemObject
   Dim oFolder As Folder
   Dim oFiles As files
   Dim oFile
   Dim strCP02 As String, strCP03 As String, strCP04 As String
   Dim strSaveName As String, strErr As String
   
   'Modified by Morgan 2025/8/15
   'strFolder = Pub_GetSpecMan("PathInvoiceP")
   If pImpFolder <> "" Then
      strFolder = pImpFolder
   Else
      strFolder = GetSetting("TAIE", "P", UCase("Frmacc21u0") & "Dir", "")
      If strFolder = "" Then
         MsgBox "帳單匯入區尚未設定，請先至[共同程序->代理人帳目->資料維護->帳單輸入-整批]指定帳單PDF檔存放路徑！"
         GoTo ExitFlag
      End If
   End If
   'end 2025/8/15
   
   'Added by Morgan 2016/7/28
   '測試抓桌面的相同資料夾以免誤刪真實檔案
   If UCase(pub_DbTerminalName) <> 正式資料庫電腦名稱 And InStr(strFolder, "\\") = 1 Then
      strFolder = PUB_Getdesktop & "\" & Mid(strFolder, InStrRev(strFolder, "\") + 1)
   End If
   'end 2016/7/28
   If strFolder <> "" Then
      If Dir(strFolder & "\*.pdf") <> "" Then
         Set oFolder = oFileSys.GetFolder(strFolder)
         Set oFiles = oFolder.files
         For Each oFile In oFiles
            If UCase(Right(oFile.Name, 4)) = ".PDF" And InStr(oFile.Name, pCP01) = 1 Then
               'Modified by Morgan 2025/8/14 +檔名可忽略後面非本所號部分
               If PUB_GetCaseNoFromFileName(oFile.Name, pCP01, strCP02, strCP03, strCP04, , True) = True Then
                  If strCP02 = pCP02 And strCP03 = pCP03 And strCP04 = pCP04 Then
                     strSaveName = PUB_CaseNo2FileName(pCP01, strCP02, strCP03, strCP04) & Mid(oFile.Name, InStr(oFile.Name, "."))
                     oFile.Name = strSaveName 'Added by Morgan 2025/8/14 檔案先更名，若含Unicode才不會錯
                     If PUB_UploadInvoice(oFile, strSaveName, strErr) Then
                        oFile.Delete True
                     ElseIf Not pSilence Then
                        MsgBox "帳單電子檔匯入失敗:" & vbCrLf & vbCrLf & strErr, vbCritical
                        Exit For
                     End If
                  End If
               End If
            End If
         Next
      End If
   End If
   PUB_ImportInvoice = True
ExitFlag:

   Set oFileSys = Nothing
   Set oFolder = Nothing
   Set oFiles = Nothing
   Set oFile = Nothing
End Function
 
'Added by Morgan 2016/6/30
'上傳帳單電子檔到Acc152
Public Function PUB_UploadInvoice(ByRef oFile, pSaveName As String, Optional pErr As String) As Boolean
   Dim stSQL As String, iRecords As Integer
   Dim bolInTrans As Boolean
   Dim stFullPath As String
   Dim stFtpPath As String
 
On Error GoTo ErrHand
   
   stFullPath = oFile.path
   
   cnnConnection.BeginTrans
   bolInTrans = True
   
   stSQL = "update ACC152 set ayf01=ayf01 where ayf01='U' and upper(ayf02)='" & ChgSQL(UCase(pSaveName)) & "'"
   cnnConnection.Execute stSQL, iRecords
   If iRecords > 0 Then
      Err.Raise 999, , " 檔名重複!!"
   End If
   
   If PUB_PutFtpFile(stFullPath, strSrvDate(1), pSaveName, stFtpPath, "ACC152") Then
      stSQL = "insert into ACC152(ayf01,ayf02,ayf03,ayf04,ayf05,ayf06,ayf07,ayf08,ayf09) values('U','" & ChgSQL(pSaveName) & "'," & oFile.Size & "," & Format(oFile.DateLastModified, "YYYYMMDD") & "," & Format(oFile.DateLastModified, "HHMMSS") & ",'" & ChgSQL(stFtpPath) & "','" & strUserNum & "',to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss'))"
      cnnConnection.Execute stSQL, iRecords
   Else
      Err.Raise 999, , " 檔案上傳失敗!!"
   End If
   cnnConnection.CommitTrans
   PUB_UploadInvoice = True
   
ErrHand:
   If Err.Number <> 0 Then
      pErr = Err.Description
      If bolInTrans Then cnnConnection.RollbackTrans
   End If
End Function

'Added by Lydia 2016/07/07 傳收文號判斷委查單是否查覆完畢
Public Function PUB_TMQCheckOver(ByVal iNoList As String, Optional bMsg As Boolean = True) As Boolean
Dim inC As Integer, StrStr As String
Dim rsCK As New ADODB.Recordset

    PUB_TMQCheckOver = True
    
    'Modified by Lydia 2023/08/18 +排除記錄
    StrStr = "select tqc01,tqc02,tqc03,tqc07,tmq01,st02 from tmqcasemap ,trademarkquery,staff " & _
             "where tqc02 in (" & GetAddStr(iNoList) & ") and tqc03<>'" & cntTQC自動記錄 & "' and tqc02=tmq21 and tqc03=tmq01 and tmq10=st01(+) and tmq11 is null "
    inC = 1
    Set rsCK = ClsLawReadRstMsg(inC, StrStr)
    If inC = 1 Then
       StrStr = ""
       If bMsg = True Then
          rsCK.MoveFirst
          Do While Not rsCK.EOF
             StrStr = StrStr & "委查單號:" & rsCK.Fields("tmq01") & "，查名人:" & rsCK.Fields("st02") & vbCrLf
             rsCK.MoveNext
          Loop
          MsgBox "下列單據尚未查覆完畢，不可通知送件!" & vbCrLf & vbCrLf & StrStr
       End If
       PUB_TMQCheckOver = False
    End If
    
    Set rsCK = Nothing
    
End Function


'Removed by Morgan 2021/3/25 改用 PUB_GetUSCaseNo
''CFP案美國IDS檢查
'Public Function PUB_CFPGetUSCaseNo(pPA01 As String, pPA02 As String, pPA03 As String, pPA04 As String, Optional pFee As String) As String
'   Dim stSQL As String, intQ As Integer
'   Dim rsQuery As ADODB.Recordset
'
'   '分割母案有美國關聯案也要
'   '美國案排除領證已發文
'   'Modified by Morgan 2020/12/25 美國領證發文4週後的才不要 --郭雅娟 109/8/21 請作
'   stSQL = "SELECT CR05||'-'||CR06||DECODE(CR07,'0',NULL,'-'||CR07||'-'||CR08) USCNo,pa91" & _
'      " FROM CASERELATION,PATENT WHERE (CR01,CR02,CR03,CR04) IN (" & _
'      " SELECT '" & pPA01 & "','" & pPA02 & "','" & pPA03 & "','" & pPA04 & "' FROM DUAL" & _
'      " UNION ALL SELECT DC05,DC06,DC07,DC08 FROM DIVISIONCASE" & _
'      " WHERE DC01='" & pPA01 & "' AND DC02='" & pPA02 & "' AND DC03='" & pPA03 & "' AND DC04='" & pPA04 & "')" & _
'      " AND CR05=PA01(+) AND CR06=PA02(+) AND CR07=PA03(+) AND CR08=PA04(+) AND PA09='101' and pa08='1' and pa57 is null" & _
'      " and exists(select * from caseprogress where  CP01 = PA01 And cp02 = pa02" & _
'      " And cp03 = pa03 And cp04 = pa04 and cp10 in ('101','113','114','122','307') and cp27>0 and cp159=0)" & _
'      " and not exists(select * from caseprogress Where CP01 = PA01 And cp02 = pa02" & _
'      " And cp03 = pa03 And cp04 = pa04 and cp10='601' and cp27>0 and cp27<to_char(sysdate-28,'yyyymmdd') and cp159=0)" & _
'      " order by 1 asc"
'   intQ = 1
'   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
'   If intQ = 1 Then
'      PUB_CFPGetUSCaseNo = rsQuery("USCNo")
'      If InStr("" & rsQuery("pa91"), "個體") > 0 Then
'         If InStr(rsQuery("pa91"), "大個體") > 0 Then
'            pFee = "貳萬陸仟元"
'         ElseIf InStr(rsQuery("pa91"), "小個體") > 0 Then
'            pFee = "貳萬參仟元"
'         ElseIf InStr(rsQuery("pa91"), "微個體") > 0 Then
'            pFee = "貳萬壹仟元"
'         End If
'      End If
'
'      'Modified by Morgan 2021/2/25 考慮有多個美國案
'      rsQuery.MoveNext
'      Do While Not rsQuery.EOF
'         PUB_CFPGetUSCaseNo = PUB_CFPGetUSCaseNo & "、" & rsQuery("USCNo")
'         rsQuery.MoveNext
'      Loop
'      'end 2021/2/25
'   End If
'End Function


'Added by Morgan 2021/3/25
'相同案
Public Function PUB_GetRelCaseVTB2(pPA01 As String, pPA02 As String, pPA03 As String, pPA04 As String, Optional p4IDS As Boolean = False) As String
   Dim stVTB As String
   
   '相同案
   cnnConnection.Execute "delete from r100101_h where id='" & strUserNum & "' "
   cnnConnection.Execute "insert into r100101_h select '" & pPA01 & "','" & pPA02 & "','" & pPA03 & "','" & pPA04 & "',0,'1','" & strUserNum & "' from dual "
   cnnConnection.Execute "begin db_r100101_h('" & strUserNum & "'); end;"
   
   stVTB = " select r001001 x01,r001002 x02,r001003 x03,r001004 x04 from r100101_h where id='" & strUserNum & "' and r001001 is not null"
   
   If p4IDS = True Then
      '主張優先權
      stVTB = stVTB & " union select pa01,pa02,pa03,pa04 from r100101_h, pridate,patent" & _
         " where id='" & strUserNum & "' and r001001 is not null" & _
         " and pd01(+)=r001001 and pd02(+)=r001002 and pd03(+)=r001003 and pd04(+)=r001004" & _
         " and pa11(+)=pd06 and pa09(+)=pd07 and pa01 is not null"
         
      '被主張優先權
      stVTB = stVTB & " union select p2.pa01,p2.pa02,p2.pa03,p2.pa04 from r100101_h,patent p1, pridate, patent p2" & _
         " where id='" & strUserNum & "' and r001001 is not null" & _
         " and p1.pa01(+)=r001001 and p1.pa02(+)=r001002 and p1.pa03(+)=r001003 and p1.pa04(+)=r001004" & _
         " and pd06(+)=p1.pa11 and pd07(+)=p1.pa09 and pd01 is not null" & _
         " and p2.pa01(+)=pd01 and p2.pa02(+)=pd02 and p2.pa03(+)=pd03 and p2.pa04(+)=pd04 and p2.pa01 is not null"
   
      '美國接續案 CIP,CPA,CA(本所案號12相同者)
      stVTB = stVTB & " union select p2.pa01,p2.pa02,p2.pa03,p2.pa04" & _
         " from r100101_h,patent p1,patent p2" & _
         " where id='" & strUserNum & "' and r001001 is not null" & _
         " and p1.pa01(+)=r001001 and p1.pa02(+)=r001002 and p1.pa03(+)=r001003 and p1.pa04(+)=r001004 and p1.pa09='101'" & _
         " and p2.pa01(+)=p1.pa01 and p2.pa02(+)=p1.pa02 and p2.pa01 is not null"
   End If
   PUB_GetRelCaseVTB2 = stVTB
End Function

'Added by Morgan 2016/8/23
'檢查收文號是否已收款
Public Function PUB_ChkPaidByCP09(pCP09 As String) As Boolean
   
   Dim rsQuery As ADODB.Recordset, intQ As Integer
   Dim stSQL As String, strVtbX As String, strVtbY As String, strVtbZ
   
'Removed by Morgan 2023/11/16 改不含出納確認--秀玲/財務處
'   '出納已確認,抓收款單號Null或是X(目前確認中的繳款紀錄)
'   strVtbX = "select axd05 X1,sum(nvl(axd06,0)+nvl(axd07,0)) X2" & _
'      " from acc441,acc440 where axd05='" & pCP09 & "'" & _
'      " and a4401(+)=axd01 and a4402(+)=axd02 and a4403(+)=axd03" & _
'      " and nvl(a4416,'X')='X' and a4413>0 group by axd05"
'end 2023/11/16

   '已收款
   strVtbY = "select a1u03 Y1,sum(nvl(a1u04,0)+nvl(a1u07,0)-nvl(a1u08,0)+nvl(a1u05,0)+nvl(a1u09,0)-nvl(a1u10,0)) Y2,sum(nvl(a1u06,0)) Y3" & _
      " from acc1u0 where a1u03='" & pCP09 & "' group by a1u03"

   'Modified by Morgan 2016/9/19
   'stSQL = "select cp01,cp09 from caseprogress,(" & strVtbX & ") X,(" & strVtbY & ") Y where cp09='" & pCP09 & "' and X1(+)=cp09 and Y1(+)=cp09 and cp16=nvl(X2,0)+nvl(Y2,0)"
   '請款單(判斷已結清 Ex.P113044)
   strVtbZ = "select cp09 Z1,1 Z2" & _
      " from caseprogress,acc1k0 where cp09='" & pCP09 & "' and substr(cp60,1,1)='X' and a1k01(+)=cp60 and a1k29='Y'"

   'Modified by Morgan 2023/11/16 改不含出納確認--秀玲/財務處
   'stSQL = "select cp01,cp09 from caseprogress,(" & strVtbX & ") X,(" & strVtbY & ") Y,(" & strVtbZ & ") Z where cp09='" & pCP09 & "' and X1(+)=cp09 and Y1(+)=cp09 and Z1(+)=cp09 and (cp16=nvl(X2,0)+nvl(Y2,0) or Z2>0)"
   stSQL = "select cp01,cp09 from caseprogress,(" & strVtbY & ") Y,(" & strVtbZ & ") Z where cp09='" & pCP09 & "' and Y1(+)=cp09 and Z1(+)=cp09 and (cp16=nvl(Y2,0) or Z2>0)"
   'end 2023/11/16
   'end 2016/9/19
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      PUB_ChkPaidByCP09 = True
   End If
   Set rsQuery = Nothing
End Function

'Added by Morgan 2016/8/22
'已收款可發文通知
'pInformType: 1=財務處收款, 2=出納繳款確認(2023/11/16 取消以免誤發，出納確認不再呼叫此模組), pA0M01=收款單號, pA4401,pA4402,pA4403=繳款記錄
Public Sub PUB_AccDeliverInform(pInformType As String, Optional pA0M01 As String, Optional pA4401 As String, Optional pA4402 As String, Optional pA4403 As String)
   
   Dim rsQuery As ADODB.Recordset, rsQuery2 As ADODB.Recordset, intQ As Integer
   Dim stSQL As String, strVtbA As String, strVtbX As String, strVtbY As String
   Dim stLstCP09 As String, stSubject As String, stContent As String
   Dim stRvr As String 'Added by Morgan 2021/6/30
   
On Error GoTo ErrHnd
   
   If pInformType = 1 Then
      '本次收款的收文號
      'Added by Morgan 2025/10/15 +國外收款
      If Left(pA0M01, 1) = "M" Then
         stSQL = "select cp01,cp09 from acc0z0,acc1k0,caseprogress where a0z01='" & pA0M01 & "' and a1k01(+)=a0z02 and a1k29='Y' and cp60(+)=a1k01 and cp27||cp57 is null and cp09 is not null"
      Else
      'end 2025/10/15
         stSQL = "select distinct cp01,cp09 from acc0m0,acc0j0,caseprogress" & _
            " where a0m01='" & pA0M01 & "' and a0j13(+)=a0m02 and cp09(+)=a0j01 and cp79=0 and cp27||cp57 is null"
      End If
   Else
      '本次確認的收文號
      strVtbA = "select distinct axd05 as A1 From acc440, acc441" & _
         " where axd01(+)=a4401 and axd02(+)=a4402 and axd03(+)=a4403" & _
         " and a4401='" & pA4401 & "' and a4402=" & pA4402 & " And A4403 = " & pA4403
         
      '出納已確認,抓收款單號Null或是X(目前確認中的繳款紀錄)
      '2023/11/16 取消以免誤發，出納確認不再呼叫此模組
      strVtbX = "select A1 as X1,sum(nvl(axd06,0)+nvl(axd07,0)) X2" & _
         " from (" & strVtbA & "),acc441,acc440 where axd05(+)=A1" & _
         " and a4401(+)=axd01 and a4402(+)=axd02 and a4403(+)=axd03" & _
         " and nvl(a4416,'X')='X' and a4413>0 group by A1"
      
      '已收款
      strVtbY = "select A1 as Y1,sum(nvl(a1u04,0)+nvl(a1u07,0)-nvl(a1u08,0)+nvl(a1u05,0)+nvl(a1u09,0)-nvl(a1u10,0)) Y2,sum(nvl(a1u06,0)) Y3" & _
         " from (" & strVtbA & "),acc1u0 where a1u03(+)=A1 group by A1"
         
      stSQL = "select cp01,cp09 from (" & strVtbX & "),(" & strVtbY & "),caseprogress where Y1(+)=X1 and cp09(+)=X1 and cp16=nvl(X2,0)+nvl(Y2,0) and cp27||cp57 is null"
   End If
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      Do While Not rsQuery.EOF
         'CFT抓承辦人(無承辦則給陳經理)
         If rsQuery("cp01") = "CFT" Then
            'Modified by Lydia 2018/06/05 修改顯示案件性質 '020',CPM04,CPM03 => '000',CPM03,CPM04
            'Modified by Morgan 2021/6/22 陳經理退休改寄洪琬姿80030及葉易雲78011
            'Modified by Morgan 2021/6/30 改用函數抓
            stRvr = "cp14"
            stSQL = "select cp01,cp02,cp03,cp04,cp14 from caseprogress where cp09='" & rsQuery("cp09") & "'"
            intQ = 1
            Set rsQuery2 = ClsLawReadRstMsg(intQ, stSQL)
            If intQ = 1 Then
               If IsNull(rsQuery2("cp14")) Then
                  stRvr = "'" & GetCFTSt16Manager(rsQuery2("cp01"), rsQuery2("cp02"), rsQuery2("cp03"), rsQuery2("cp04")) & "'"
               End If
            End If
           stSQL = "select st02 as 智權人員,decode(tm10,'000',cpm03,cpm04) as 案件性質, na03 as 申請國家, cu04 as 申請人" & _
               ",cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) as 本所案號,tm05 as 案件名稱" & _
               "," & stRvr & " as 收件人,sqldatet(cp05) 收文日" & _
               " From CASEPROGRESS, TRADEMARK, STAFF, CASEPROPERTYMAP, NATION, CUSTOMER" & _
               " where cp09='" & rsQuery("cp09") & "' and cpm01(+)=cp01 and cpm02(+)=cp10" & _
               " and tm01(+)=cp01 and tm02(+)=cp02 and tm03(+)=cp03 and tm04(+)=cp04 and na01(+)=tm10" & _
               " and cu01(+)=substr(tm23,1,8) and cu02(+)=substr(tm23,9) and st01(+)=cp13"
               
         '所有T*案申請國家非台灣之非FMT案(即CP12非'F'字頭)，或是收款後送件CP141='2'之台灣案，於全額收款時發E-MAIL給承辦人
         ElseIf Left(rsQuery("cp01"), 1) = "T" Then
            'Modified by Lydia 2018/06/05 修改顯示案件性質 '020',CPM04,CPM03 => '000',CPM03,CPM04
            stSQL = "SELECT st02 as 智權人員,decode(tm10,'000',cpm03,cpm04) as 案件性質, na03 as 申請國家, cu04 as 申請人,X.*" & _
               " FROM (select cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) as 本所案號" & _
               ",tm05||sp05 as 案件名稱,CP14 as 收件人,sqldatet(cp05) as 收文日,TM10||SP09 as tm10,TM23||SP08 as tm23,CP01,CP10,CP13" & _
               " from CASEPROGRESS, TRADEMARK, SERVICEPRACTICE" & _
               " where cp09='" & rsQuery("cp09") & "' and cp14 is not null" & _
               " and tm01(+)=cp01 and tm02(+)=cp02 and tm03(+)=cp03 and tm04(+)=cp04" & _
               " and sp01(+)=cp01 and sp02(+)=cp02 and sp03(+)=cp03 and sp04(+)=cp04" & _
               " and ((tm10||sp09<>'000' and cp12 not like 'F%') or cp141='2')" & _
               ") X, STAFF, CASEPROPERTYMAP, NATION, CUSTOMER" & _
               " WHERE ST01(+)=CP13 AND CPM01(+)=CP01 AND CPM02(+)=CP10" & _
               " and NA01(+)=tm10 AND CU01(+)=SUBSTR(tm23,1,8) AND CU02(+)=SUBSTR(tm23,9)"
               
         '抓無法發文紀錄通知最後的記錄人員(一個收文號多筆記錄時）
         Else
            'Modified by Lydia 2018/06/05 修改顯示案件性質 '020',CPM04,CPM03 => '000',CPM03,CPM04
            'Modified by Morgan 2021/4/8 若承辦人為程序時設為收件人(工作輪替時會改承辦人Ex:P-108699)
            'Modified by Morgan 2024/2/22 改判斷有設定收款後送件(cp141='2')通知P台灣(PS1)，大陸(PS2)，CFP管制人
            'stSQL = "select st02 as 智權人員,decode(pa09,'000',cpm03,cpm04) as 案件性質, na03 as 申請國家, cu04 as 申請人,X.*" & _
               " From (select cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) as 本所案號" & _
               ",pa05||sp05 as 案件名稱,decode(st03,'P12',cp14,ud04) as 收件人,sqldatet(cp05) 收文日,pa09||SP09 as pa09,pa26||SP08 as pa26,CP01,CP10,CP13,ud02" & _
               " from undeliveredrec, caseprogress, patent, servicepractice,staff" & _
               " where ud01='" & rsQuery("cp09") & "' and cp09(+)=ud01" & _
               " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04" & _
               " and sp01(+)=cp01 and sp02(+)=cp02 and sp03(+)=cp03 and sp04(+)=cp04" & _
               " and st01(+)=cp14) X, STAFF, CASEPROPERTYMAP, NATION, CUSTOMER" & _
               " WHERE ST01(+)=CP13 and cpm01(+)=cp01 and cpm02(+)=cp10" & _
               " and NA01(+)=pa09 AND CU01(+)=SUBSTR(pa26,1,8) AND CU02(+)=SUBSTR(pa26,9)" & _
               " order by ud02 desc"
            
            stRvr = "cp14"
            'modify by sonia 2024/6/27 +cp10
            'modify by sonia 2024/7/19 再改2024/6/27規則，只要是P或PS承辦人為程序人員都通知CP14，故改cp10為ST03
            'stSQL = "select cp01,cp02,cp03,cp04,nvl(pa09,sp09) pa09,cp10 from caseprogress,patent, servicepractice" & _
               " where cp09='" & rsQuery("cp09") & "' and cp141='2'" & _
               " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04" & _
               " and sp01(+)=cp01 and sp02(+)=cp02 and sp03(+)=cp03 and sp04(+)=cp04"
            stSQL = "select cp01,cp02,cp03,cp04,nvl(pa09,sp09) pa09,st03 from caseprogress,patent,servicepractice,staff" & _
               " where cp09='" & rsQuery("cp09") & "' and cp141='2' and cp14=st01(+)" & _
               " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04" & _
               " and sp01(+)=cp01 and sp02(+)=cp02 and sp03(+)=cp03 and sp04(+)=cp04"
            intQ = 1
            Set rsQuery2 = ClsLawReadRstMsg(intQ, stSQL)
            If intQ = 1 Then
               With rsQuery2
               If .Fields("cp01") = "CFP" Or .Fields("cp01") = "CPS" Then
                  stRvr = "'" & PUB_GetCFPHandler(.Fields("cp01") & .Fields("cp02") & .Fields("cp03") & .Fields("cp04")) & "'"
                  
                  
               'Added by Morgan 2025/1/14
               ElseIf strSrvDate(1) >= P業務區劃分啟用日 Then
                  stRvr = "'" & PUB_GetPHandler(.Fields("cp01") & .Fields("cp02") & .Fields("cp03") & .Fields("cp04")) & "'"
               'end 2025/1/14
               'add by sonia 2024/6/27 玲玲說P案要剔除領證601及年費605，不管申請國家，都通知CP14。 P-132525
               'modify by sonia 2024/7/19 再改2024/6/27規則，只要是P或PS承辦人為程序人員都通知CP14。 P-122811
               'ElseIf .Fields("cp10") = "601" Or .Fields("cp10") = "605" Then
               ElseIf (.Fields("cp01") = "P" Or .Fields("cp01") = "PS") And .Fields("st03") = "P12" Then
               'end 2024/6/27
               ElseIf .Fields("pa09") = "000" Then
                  stRvr = "'" & Pub_GetSpecMan("PS1") & "'"
               Else
                  stRvr = "'" & Pub_GetSpecMan("PS2") & "'"
               End If
               End With
            
               stSQL = "select st02 as 智權人員,decode(pa09,'000',cpm03,cpm04) as 案件性質, na03 as 申請國家, cu04 as 申請人,X.*" & _
                  " From (select cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) as 本所案號" & _
                  ",pa05||sp05 as 案件名稱," & stRvr & " as 收件人,sqldatet(cp05) 收文日,pa09||SP09 as pa09,pa26||SP08 as pa26,CP01,CP10,CP13" & _
                  " from caseprogress, patent, servicepractice" & _
                  " where cp09='" & rsQuery("cp09") & "'" & _
                  " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04" & _
                  " and sp01(+)=cp01 and sp02(+)=cp02 and sp03(+)=cp03 and sp04(+)=cp04" & _
                  " ) X, STAFF, CASEPROPERTYMAP, NATION, CUSTOMER" & _
                  " WHERE ST01(+)=CP13 and cpm01(+)=cp01 and cpm02(+)=cp10" & _
                  " and NA01(+)=pa09 AND CU01(+)=SUBSTR(pa26,1,8) AND CU02(+)=SUBSTR(pa26,9)"
            End If
            'end 2024/2/22
         End If
         
         intQ = 1
         Set rsQuery2 = ClsLawReadRstMsg(intQ, stSQL)
         If intQ = 1 Then
            With rsQuery2
            If CheckAccDeliverInform(.Fields("收件人"), rsQuery("cp09")) = False Then
               'Memo by Morgan 2016/8/18 ##### 主旨若變動 CheckDeliverInform 要同步 #####
               stSubject = .Fields("本所案號") & "【" & .Fields("申請國家") & "】之" & .Fields("案件性質") & "【" & rsQuery("cp09") & "】已收款，請送件！"
               stContent = "本所案號：" & .Fields("本所案號") & vbCrLf & _
                  "案件名稱：" & .Fields("案件名稱") & vbCrLf & _
                  "申請國家：" & .Fields("申請國家") & vbCrLf & _
                  "申請人　：" & .Fields("申請人") & vbCrLf & _
                  "智權人員：" & .Fields("智權人員") & vbCrLf & _
                  "案件性質：" & .Fields("案件性質") & vbCrLf & _
                  "收文日　：" & .Fields("收文日")
            
               bolMailSendOk = False
               PUB_SendMail strUserNum, .Fields("收件人"), rsQuery("cp09"), stSubject, stContent, , , , , , , , , , , False
               If bolMailSendOk = True Then
                  stSQL = "insert into mailcache(mc01,mc02,mc03,mc04,mc05,mc06,mc07,mc08)" & _
                     " values( '" & strUserNum & "','" & .Fields("收件人") & "',to_char(sysdate,'yyyymmdd')" & _
                     ",to_char(sysdate,'hh24miss'),to_char(sysdate,'YYYYMMDD'),to_char(sysdate,'HH24MISS'),'" & ChgSQL(stSubject) & "','" & ChgSQL(stContent) & "')"
                  cnnConnection.Execute stSQL, intQ
                  
                  
                  'Added by Morgan 2020/11/23
                  '繳款確認也要上已收款，否則會無法發文 Ex:P-108316
                  If pInformType = 2 Then
                     stSQL = "update ReceivablesDay set rd06='Y' where rd01='" & rsQuery("cp09") & "'"
                     cnnConnection.Execute stSQL, intQ
                  End If
                  'end 2020/11/23
               End If
            End If
            End With
         End If
         rsQuery.MoveNext
      Loop
   End If
   
ErrHnd:
   If Err.Number <> 0 Then
      MsgBox Err.Description
   End If
   
   Set rsQuery = Nothing
   Set rsQuery2 = Nothing
End Sub

'Added by Morgan 2016/8/18
'檢查當天是否有已收款可發文通知
Public Function CheckAccDeliverInform(pReceiver As String, pCP09 As String) As Boolean
   Dim stSQL As String, intR As Integer
   'Modified by Morgan 2016/8/24 婧瑄認為只要通知一次就好
   'stSQL = "update mailcache set mc01=mc01 where mc02='" & pReceiver & "' and mc03=" & strSrvDate(1) & " and instr(mc07,'【" & pCP09 & "】已收款，請送件！')>0"
   stSQL = "update mailcache set mc01=mc01 where mc02='" & pReceiver & "' and instr(mc07,'【" & pCP09 & "】已收款，請送件！')>0"
   cnnConnection.Execute stSQL, intR
   If intR > 0 Then
      CheckAccDeliverInform = True
   End If
End Function

'Add By Sindy 2019/5/13 商標處人員要從信件切檔案出來,讓系統自動歸入卷宗區
Public Sub PUB_TMFilePathToCPP(Optional strSaveFilePath As String, Optional strCP09 As String)
Dim rsQuery As ADODB.Recordset
Dim stSQL As String, intQ As Integer
Dim strCP01 As String, strCP02 As String, strCP03 As String, strCP04 As String, strCP10 As String
Dim fs, f
Dim strFileName As String, stReName As String
Dim ii As Integer, strDirFName As String
Dim bolSave As Boolean, jj As Integer 'Add By Sindy 2020/8/28
Dim strCP10_cp43 As String 'Add By Sindy 2020/11/10
   
   'Modify By Sindy 2020/3/10
   If Dir(strSaveFilePath, vbDirectory) = "" Then
      MkDir strSaveFilePath
   End If
   'If Dir(strSaveFilePath, vbDirectory) <> "" And strCP09 <> "" Then
   If strCP09 <> "" Then
   '2020/3/10 END
      stSQL = "select c1.cp01 cp01,c1.cp02 cp02,c1.cp03 cp03,c1.cp04 cp04,c1.cp10 cp10,c1.cp43 cp43,c2.cp09 cp09_2,c2.cp10 cp10_2" & _
               " From caseprogress c1,caseprogress c2" & _
               " where c1.cp09='" & strCP09 & "' and c1.cp43=c2.cp09(+)"
      intQ = 1
      Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
      If intQ = 1 Then
         strCP01 = rsQuery.Fields("cp01")
         strCP02 = rsQuery.Fields("cp02")
         strCP03 = rsQuery.Fields("cp03")
         strCP04 = rsQuery.Fields("cp04")
         strCP10 = rsQuery.Fields("cp10")
         strCP10_cp43 = "" & rsQuery.Fields("cp10_2") '相關總收文號的案件性質 Add By Sindy 2020/11/10
         '檢視資料夾中的電子檔
         strSaveFilePath = IIf(Right(strSaveFilePath, 1) = "\", Mid(strSaveFilePath, 1, Len(strSaveFilePath) - 1), strSaveFilePath)
         If PUB_ChkDir(strSaveFilePath) = False Then
            'MsgBox "無法讀取資料夾(" & strSaveFilePath & ")，歸卷取消！", vbCritical
            Exit Sub
         Else
            Set fs = CreateObject("Scripting.FileSystemObject")
            For ii = 1 To 4
               If ii = 1 Then
                  '本所案號狀況1:strCP01 & strCP02
                  strDirFName = strSaveFilePath & "\" & strCP01 & strCP02 & IIf(strCP03 <> "0" Or strCP04 <> "00", "-" & strCP03, "") & IIf(strCP04 <> "00", "-" & strCP04, "") & "*.pdf"
               ElseIf ii = 2 Then
                  '本所案號狀況2:strCP01 & Val(strCP02)
                  strDirFName = strSaveFilePath & "\" & strCP01 & Val(strCP02) & IIf(strCP03 <> "0" Or strCP04 <> "00", "-" & strCP03, "") & IIf(strCP04 <> "00", "-" & strCP04, "") & "*.pdf"
               ElseIf ii = 3 Then
                  '本所案號狀況3:strCP01 & "-" & strCP02
                  strDirFName = strSaveFilePath & "\" & strCP01 & "-" & strCP02 & IIf(strCP03 <> "0" Or strCP04 <> "00", "-" & strCP03, "") & IIf(strCP04 <> "00", "-" & strCP04, "") & "*.pdf"
               ElseIf ii = 4 Then
                  '本所案號狀況4:strCP01 & "-" & Val(strCP02)
                  strDirFName = strSaveFilePath & "\" & strCP01 & "-" & Val(strCP02) & IIf(strCP03 <> "0" Or strCP04 <> "00", "-" & strCP03, "") & IIf(strCP04 <> "00", "-" & strCP04, "") & "*.pdf"
               End If
               'Add By Sindy 2020/8/28
               'strFileName = Dir(strDirFName)
               Forms(0).List1.Clear
               f = Dir(strDirFName)
               While f <> ""
                   Forms(0).List1.AddItem f
                   f = Dir()
               Wend
               'Do While strFileName <> ""
               For jj = 0 To Forms(0).List1.ListCount - 1
                  '逐筆歸卷宗區
                  'strFileName = UCase(strFileName)
                  strFileName = UCase(Forms(0).List1.List(jj))
               '2020/8/28 END
'                  If Right(strFileName, 4) = ".PDF" And _
'                     (InStr(strFileName, strCP01 & Val(strCP02) & IIf(strCP03 <> "0" Or strCP04 <> "00", "-" & strCP03, "") & IIf(strCP04 <> "00", "-" & strCP04, "")) > 0 Or _
'                      InStr(strFileName, strCP01 & strCP02 & IIf(strCP03 <> "0" Or strCP04 <> "00", "-" & strCP03, "") & IIf(strCP04 <> "00", "-" & strCP04, "")) > 0) Then
                  If Right(strFileName, 4) = ".PDF" Then
                  
                     'Add By Sindy 2020/8/28 無指定案件性質或有指定到同案件性質時,才要歸入
                     '傳入多筆PDF(ex.案號.案件性質.POA.PDF)
                     If InStr(strFileName, ".") <> InStrRev(strFileName, ".") Then
                        '案號後第一組 .. ; ex. 判斷data.1.pdf
                        strExc(2) = InStr(strFileName, ".")
                        strExc(1) = Mid(strFileName, Val(strExc(2)) + 1, InStr(Mid(strFileName, Val(strExc(2)) + 1), ".") - 1)
                     Else
                        strExc(1) = Mid(strFileName, InStrRev(strFileName, ".") + 1)
                     End If
                     '檢查傳入檔案的案件性質:判斷是數值,長度是3碼或4碼
                     If Val(strExc(1)) > 0 And _
                        (Len(strExc(1)) >= 3 Or Len(strExc(1)) <= 4) Then
                        'Modify By Sindy 2020/11/10 + Or strCP10_cp43 = strExc(1)
                        If strCP10 = strExc(1) Or strCP10_cp43 = strExc(1) Then
                           bolSave = True
                        Else
                           bolSave = False
                        End If
                     Else
                        bolSave = True
                     End If
                     '2020/8/28 END
                  
                     '檢查檔名規則
                     If bolSave = True Then 'Add By Sindy 2020/8/28 + if
                        If PUB_ChkEmpFlowFNMRule(strCP01 & "-" & strCP02 & "-" & strCP03 & "-" & strCP04, strFileName, "Y", strCP10, , , False, False, "") = True Then
                           '更名
                           If PUB_GetEmpFlowReNameFile(strCP01, strCP02, strCP03, strCP04, strCP10, strFileName, stReName, True, 1, False) = True Then
                              'Add By Sindy 2020/11/10
                              If InStr(stReName, "." & strCP10_cp43 & ".") > 0 And strCP10_cp43 <> strCP10 Then
                                 stReName = Replace(stReName, "." & strCP10_cp43 & ".", ".")
                              End If
                              '2020/11/10 END
                              '檢查卷宗區是否有同檔名
                              stReName = PUB_ChkCPPIsSameFileName(strCP01, strCP09, stReName)
                              Set f = fs.GetFile(strSaveFilePath & "\" & strFileName)
                              '檔案大小為 0 KB 有誤
                              If f.Size > 0 Then
                                 If SaveAttFile_PDF(strCP09, strSaveFilePath & "\" & strFileName, stReName, Format(f.DateLastModified, "YYYYMMDD"), Format(f.DateLastModified, "HHMMSS"), False) = True Then
                                    PUB_UpdateLP03 strCP09 'Add By Sindy 2020/11/6
                                    '刪除電子檔
                                    SetAttr strSaveFilePath & "\" & strFileName, vbNormal 'Added by Lydia 2020/03/19 預設檔案為正常
                                    Kill strSaveFilePath & "\" & strFileName
                                 End If
                              End If
                           End If
                        End If
                     End If
                  End If
                  'strFileName = Dir(strDirFName)
               'Loop
               Next jj
            Next ii
            Set fs = Nothing
         End If
      End If
   End If
End Sub

'Add By Sindy 2019/6/6
'檢查卷宗區是否有同檔名
Public Function PUB_ChkCPPIsSameFileName(strCP01 As String, strCP09 As String, strFileName As String) As String
Dim rsQuery As ADODB.Recordset
Dim strSql As String, intQ As Integer
Dim bolGetFileName As Boolean
Dim intRow As Integer
   
   PUB_ChkCPPIsSameFileName = strFileName
   
   strSql = "select cpp02" & _
            " From casepaperpdf" & _
            " where cpp01='" & strCP09 & "'" & _
            " and upper(cpp02)=upper('" & strFileName & "')"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, strSql)
   If intQ = 1 Then
      strSql = "select EFC01,EFC02 from efilecaption where EFC06='Y'" & _
               " and instr(upper('" & ChgSQL(strFileName) & "'),upper('.'||EFC02||'.'))>0" & _
               " and efc01 in('ALL','" & strCP01 & "')" & _
               " order by efc01 desc,efc02 asc"
      intQ = 1
      Set rsQuery = ClsLawReadRstMsg(intQ, strSql)
      If intQ = 1 Then
         If rsQuery.RecordCount = 1 Then '只有一筆副檔名,系統才自動ReName
            '比對檔名
            bolGetFileName = False: intRow = 1
            Do While bolGetFileName = False
               Do While InStr(UCase(strFileName), UCase("." & rsQuery.Fields("EFC02") & "." & intRow & ".")) > 0
                  intRow = intRow + 1
               Loop
               If intRow = 1 Then
                  strFileName = Replace(UCase(strFileName), UCase("." & rsQuery.Fields("EFC02") & "."), UCase("." & rsQuery.Fields("EFC02") & "." & intRow & "."))
               Else
                  strFileName = Replace(UCase(strFileName), UCase("." & rsQuery.Fields("EFC02") & "." & intRow - 1 & "."), UCase("." & rsQuery.Fields("EFC02") & "." & intRow & "."))
               End If
               '比對不到就用此組檔名
               strSql = "select cpp02" & _
                        " From casepaperpdf" & _
                        " where cpp01='" & strCP09 & "'" & _
                        " and upper(cpp02)=upper('" & strFileName & "')"
               intI = 1
               Set RsTemp = ClsLawReadRstMsg(intI, strSql)
               If intI = 0 Then
                  bolGetFileName = True
               End If
            Loop
            If bolGetFileName = True Then
               PUB_ChkCPPIsSameFileName = strFileName
            End If
         End If
      End If
   End If
End Function

'Added by Lydia 2016/11/15 新增請款單作業:以請款對象檢查是否存在於ACC225且下次寄發日期＞系統日，若存在則顯示訊息提醒操作人員
Public Function PUB_ChkAcc225MsgList(ByVal pNo As String, ByVal pAno As String, ByVal pCase01 As String, ByVal pCase02 As String, ByVal pCase03 As String, ByVal pCase04 As String, Optional ByVal pFrmName As String) As Boolean
'pNo 請款單號
'pAno 請款對象
'pCase01 ~ pCase04 本所案號
'pFrmName  記錄新增列印清單的表單名稱
Dim inR As Integer
Dim strCont As String
Dim stNA16 As String 'mail給程序人員
Dim rsRD As New ADODB.Recordset
Dim strNo(1 To 4) As String
'Added Lydia 2017/03/09
Dim pAname As String '請款對象名稱
Dim stNA16n As String '通知人員名稱

   PUB_ChkAcc225MsgList = False
   
   If pNo = "" Or pAno = "" Or pCase01 = "" Or pCase02 = "" Then Exit Function
   If pCase03 = "" Then pCase03 = "0"
   If pCase04 = "" Then pCase04 = "00"
   
   'Modified by Lydia 2017/03/09 先判斷Acc225
'   If Left(pAno, 1) = "X" Then
'      'Modified by Lydia 2017/02/13 +FMP管制人
'      If strSrvDate(1) < FMP管制人啟用日 Then
'        strSql = "select a2259,a2251||'0' as ANO,nvl(cu05,nvl(cu04,cu06)) ANAME,na16,st02 from acc225,customer,nation,staff " & _
'                 "where a2251=substr('" & pAno & "',1,8) and a2251=cu01(+) and cu02='0' and cu10=na01(+) and na16=st01(+)"
'      Else
'        strSql = "select a2259,a2251||'0' as ANO,nvl(cu05,nvl(cu04,cu06)) ANAME,na16,s1.st02,na79,s2.st02 na79n from acc225,customer,nation,staff s1, staff s2 " & _
'                 "where a2251=substr('" & pAno & "',1,8) and a2251=cu01(+) and cu02='0' and cu10=na01(+) and na16=s1.st01(+) and na79=s2.st01(+)"
'      End If
'      'end 2017/02/13
'   Else
'      'Modified by Lydia 2017/02/13 +FMP管制人
'      If strSrvDate(1) < FMP管制人啟用日 Then
'        strSql = "select a2259,a2251||'0' as ANO,nvl(fa05,nvl(fa04,fa06)) ANAME,na16,st02 from acc225,fagent,nation,staff " & _
'                 "where a2251=substr('" & pAno & "',1,8) and a2251=fa01(+) and fa02='0' and fa10=na01(+) and na16=st01(+)"
'      Else
'        strSql = "select a2259,a2251||'0' as ANO,nvl(fa05,nvl(fa04,fa06)) ANAME,na16,s1.st02,na79,s2.st02 na79n from acc225,fagent,nation,staff s1,staff s2 " & _
'                 "where a2251=substr('" & pAno & "',1,8) and a2251=fa01(+) and fa02='0' and fa10=na01(+) and na16=s1.st01(+) and na79=s2.st01(+)"
'      End If
'      'end 2017/02/13
'   End If
   strSql = "select a2259,a2251||'0' as ANO,decode(substr(a2251,1,1),'Y',nvl(fa05,nvl(fa04,fa06)),nvl(cu05,nvl(cu04,cu06))) ANAME from acc225,fagent,customer where a2251=substr('" & pAno & "',1,8) and a2251=fa01(+) and fa02(+)='0' and a2251=cu01(+) and cu02(+)='0' "
   'end 2017/03/09
   inR = 1
   Set rsRD = ClsLawReadRstMsg(inR, strSql)
   
   If inR = 1 Then
      If "" & rsRD.Fields("a2259") < strSrvDate(2) Then
         GoTo JumpExit
      Else
         'Modified by Lydia 2017/03/09 改用模組
         'stNA16 = "" & rsRd.Fields("na16")
         ''Added by Lydia 2017/02/13 +FMP案管制人
         'If (pCase01 = "P" Or pCase01 = "PS") And strSrvDate(1) >= FMP管制人啟用日 Then
         '   If "" & rsRd.Fields("na79") <> "" Then stNA16 = "" & rsRd.Fields("na79")
         'End If
         ''end 2017/02/13
         pAname = "" & rsRD.Fields("Aname")
         strSql = "select cp01,cp02,cp03,cp04,count(*) cnt from caseprogress where cp01='" & pCase01 & "' and cp02='" & pCase02 & "' and cp03='" & pCase03 & "' and cp04='" & pCase04 & "' " & _
                  "and cp60='" & pNo & "' and cp10 in ('601','605') group by  cp01,cp02,cp03,cp04 "
         inR = 1: strExc(0) = ""
         Set rsRD = ClsLawReadRstMsg(inR, strSql)
         If inR = 1 Then strExc(0) = "" & rsRD.Fields("cnt")
         
          'Remove by Lydia 2019/12/05 改成FCP程序管制人員by Phoebe
         'If Val(strExc(0)) > 0 Then
         '   stNA16 = Pub_GetSpecMan("外專領證年費請款程序")
        ' Else
            stNA16 = PUB_GetFCPHandler(pCase01, pCase02, pCase03, pCase04)
         'End If 'end 2019/12/05

         stNA16n = GetStaffName(stNA16, True)
         strExc(1) = pAno & " " & pAname
         strExc(8) = "" '清空
         'end 2017/03/09
         If Left(Pub_StrUserSt03, 2) <> "F2" And pFrmName = "" Then
            MsgBox "此請款對象為固定寄催款單，請款單請在月底前寄出！", vbOKOnly, "國外固定寄催款單"
         Else
            'Remove by Lydia 2017/03/09
            'strExc(1) = rsRd.Fields("ANO") & " " & rsRd.Fields("ANAME")
            'strExc(2) = "" & rsRd.Fields("st02")
            ''Added by Lydia 2017/02/13 +FMP案管制人
            'If (pCase01 = "P" Or pCase01 = "PS") And strSrvDate(1) >= FMP管制人啟用日 Then
            '   If "" & rsRd.Fields("na79") <> "" Then strExc(2) = "" & rsRd.Fields("na79n")
            'End If
            'end 2017/02/13

            'Remove by Lydia 2017/01/17 不顯示案件性質
            '(未取消收文)案件性質：抓收文日+收文號最小之A或B類，若無則抓收文日+收文號最小之C類
            'Modified by Lydia 2017/01/17 抓請款單的最小收文號
            'strSql = "select min(cp05||cp09||cp10) mno from caseprogress where cp01='" & pCase01 & "' and cp02='" & pCase02 & "' and cp03='" & pCase03 & "' and cp04='" & pCase04 & "' and cp09 < 'C' and cp159=0"
            'Remove by Lydia 2017/01/17 不顯示案件性質
            'strSql = "select min(cp05||cp09||cp10) mno from caseprogress where cp60='" & pNo & "' and cp09 < 'C' and cp159=0"
            'inR = 1: strExc(3) = ""
            'Set rsRd = ClsLawReadRstMsg(inR, strSql)
            'If inR = 1 Then
            '   strExc(3) = "" & rsRd.Fields("mno")
            '   If strExc(3) = "" Then
            '      'Modified by Lydia 2017/01/17 抓請款單的最小收文號
            '      'strSql = "select min(cp05||cp09||cp10) mno from caseprogress where cp01='" & pCase01 & "' and cp02='" & pCase02 & "' and cp03='" & pCase03 & "' and cp04='" & pCase04 & "' and cp09 > 'C' and cp159=0"
            '      strSql = "select min(cp05||cp09||cp10) mno from caseprogress where cp60='" & pNo & "' and cp09 > 'C' and cp159=0"
            '      inR = 1
            '      Set rsRd = ClsLawReadRstMsg(inR, strSql)
            '      If inR = 1 Then
            '         strExc(3) = "" & rsRd.Fields("mno")
            '      End If
            '   End If
            'End If
            'If strExc(3) <> "" Then
               If ClsPDCheckCaseCodeIsExist(pCase01, pCase02, pCase03, pCase04, strExc(5), strExc(6), strExc(7), , strExc(9)) Then
                  'Remove by Lydia 2017/01/17 不顯示案件性質
                  'If ClsPDGetCaseProperty(pCase01, Mid(strExc(3), 18), strExc(8), IIf(strExc(9) <> "000", True, False)) Then
                  'End If
               End If
            'End If
            'end 2017/01/17
            
            If pFrmName = "" Then
                'Modified by Lydia 2017/03/09  strExc(2)=>stNA16n
                MsgBox "請款單請在月底前寄出！卷請退 " & stNA16n & "！", vbOKOnly, "國外固定寄催款單"
                
                'Modifeid by Lydia 2017/01/17 不顯示案件性質
                'strCont = "本所案號：" & pCase01 & "-" & pCase02 & "-" & pCase03 & "-" & pCase04 & vbCrLf & _
                          "案件名稱：" & IIf(strExc(5) <> "", strExc(5), IIf(strExc(6) <> "", strExc(6), strExc(7))) & vbCrLf & _
                          "案件性質：" & strExc(8) & vbCrLf & _
                          "請款單號：" & pNo & vbCrLf & _
                          "請款對象：" & strExc(1) & vbCrLf & vbCrLf & _
                          "PS：此請款對象為固定寄催款單，請款單請在月底前寄出！"
                strCont = "本所案號：" & pCase01 & "-" & pCase02 & "-" & pCase03 & "-" & pCase04 & vbCrLf & _
                          "案件名稱：" & IIf(strExc(5) <> "", strExc(5), IIf(strExc(6) <> "", strExc(6), strExc(7))) & vbCrLf & _
                          "請款單號：" & pNo & vbCrLf & _
                          "請款對象：" & strExc(1) & vbCrLf & vbCrLf & _
                          "PS：此請款對象為固定寄催款單，請款單請在月底前寄出！"


                PUB_SendMail strUserNum, stNA16, "", "請款單" & pNo & "，請在月底前寄出！", vbCrLf & strCont
            Else
                '整批列印時,新增國外固定寄催款單清單
                'Modified by Lydia 2019/04/02 PK: 使用者帳號@電腦名稱(pub_HostName)
                strSql = "INSERT INTO ACC225LIST(AL01,AL02,AL03,AL04,AL05,AL06,AL07,AL08,AL09) VALUES (" & _
                         CNULL(strUserNum & "@" & pub_HostName) & "," & strSrvDate(1) & ",'" & PUB_StrToStr(pFrmName, 20) & "'," & CNULL(pCase01 & "-" & pCase02 & "-" & pCase03 & "-" & pCase04) & _
                         "," & CNULL(PUB_StrToStr(IIf(strExc(5) <> "", strExc(5), IIf(strExc(6) <> "", strExc(6), strExc(7))), 160)) & "," & CNULL(PUB_StrToStr(strExc(8), 40)) & "," & CNULL(pNo) & _
                         "," & CNULL(Trim(Mid(strExc(1), 1, 9))) & "," & CNULL(Trim(Mid(strExc(1), 10))) & ")"
                cnnConnection.Execute strSql
            End If
         End If
      End If
   Else
      GoTo JumpExit
   End If
   
   PUB_ChkAcc225MsgList = True
   Exit Function
   
JumpExit:
      Set rsRD = Nothing
End Function

'Added by Lydia 2016/11/21 刪除:國外固定寄催款單清單
'刪除定稿整批列印清單資料
Public Sub PUB_DeleteAcc225List(strUserNumber As String)
Dim StrSQLa As String
'Modified by Lydia 2019/04/02 PK: 使用者帳號@電腦名稱(pub_HostName)
'StrSQLa = "Delete From Acc225List Where AL01='" & strUserNumber & "' "
StrSQLa = "Delete From Acc225List Where AL01='" & strUserNumber & "@" & pub_HostName & "' "
cnnConnection.Execute StrSQLa
End Sub

'Added by Lydia 2016/11/21 列印:國外固定寄催款單清單
Public Sub PUB_PrintAcc225List(strUserNo As String, Optional ByVal strNewPrinter As String = "", Optional ByVal strOldPrinter As String = "")
Dim rsPrt As New ADODB.Recordset
Dim inA As Integer
Dim oOrt As Integer
Dim iPrint As Long 'Y軸
Dim intPage As Integer '頁數
Dim iSubCnt As Integer '小計筆數
Dim strAL03 As String '來源表單名稱
        
    'Modified by Lydia 2019/04/02 PK: 使用者帳號@電腦名稱(pub_HostName)
    'strSql = "select * from Acc225List where AL01=" & CNULL(strUserNo) & " order by AL03,AL07 "
    strSql = "select * from Acc225List where AL01=" & CNULL(strUserNo & "@" & pub_HostName) & " order by AL03,AL07 "
    inA = 1
    Set rsPrt = ClsLawReadRstMsg(inA, strSql)
    If inA = 1 Then
       If rsPrt.RecordCount > 0 Then
          '設定印表機
          If strNewPrinter <> "" Then
             PUB_RestorePrinter strNewPrinter
          End If
          MsgBox "準備列印國外固定寄催款單清單!!!", vbExclamation + vbOKOnly
          oOrt = Printer.Orientation
RePrint:
          Printer.PaperSize = 9
          Printer.Orientation = 1
          Printer.FontName = "細明體"
          rsPrt.MoveFirst
          strAL03 = "" & rsPrt.Fields("AL03")
          intPage = 1
          iSubCnt = 0
          
          Call PUB_PrintAcc225ListHead(strAL03, iPrint, intPage) '列印表頭
          '---------------
          With rsPrt
              Do While Not .EOF
                '不同表單名稱或超出可印範圍
                If strAL03 <> "" & rsPrt.Fields("AL03") Or iPrint >= Printer.ScaleHeight - 1300 Then
                   '印頁尾線
                   iPrint = iPrint + 300
                   Printer.CurrentX = 350
                   Printer.CurrentY = iPrint
                   Printer.Print String(95, "-")
                   If strAL03 <> "" & rsPrt.Fields("AL03") Then
                     iPrint = iPrint + 300
                     Printer.CurrentX = 350
                     Printer.CurrentY = iPrint
                     Printer.Print "共" & iSubCnt & "筆"
                     iSubCnt = 0
                   End If
                   
                   '跳頁印表頭
                   strAL03 = "" & rsPrt.Fields("AL03")
                   Printer.NewPage
                   intPage = intPage + 1
                   Call PUB_PrintAcc225ListHead(strAL03, iPrint, intPage)
                End If
                iPrint = iPrint + 300
                Printer.CurrentX = 350
                Printer.CurrentY = iPrint
                'Modified by Lydia 2017/02/07 案件性質已不顯示
                'strExc(1) = convForm(.Fields("AL04"), 15) & " " & convForm(.Fields("AL05"), 24) & " " & convForm(.Fields("AL06"), 8) & " " & convForm(.Fields("AL07"), 10) & " " & convForm(.Fields("AL08") & " " & .Fields("AL09"), 36)
                strExc(1) = convForm(.Fields("AL04"), 15) & " " & convForm(.Fields("AL05"), 24) & " " & convForm(.Fields("AL07"), 10) & " " & convForm(.Fields("AL08") & " " & .Fields("AL09"), 36)
                Printer.Print strExc(1)

                iSubCnt = iSubCnt + 1
                .MoveNext
              Loop
          End With
          
          '印表尾
          iPrint = iPrint + 300
          Printer.CurrentX = 350
          Printer.CurrentY = iPrint
          Printer.Print String(95, "-")
          iPrint = iPrint + 300
          Printer.CurrentX = 350
          Printer.CurrentY = iPrint
          Printer.Print "共" & iSubCnt & "筆"
          
          Printer.EndDoc
          
          '可重覆列印
          If MsgBox("國外固定寄催款單清單已列印完畢，您是否要重新列印???", vbExclamation + vbYesNo + vbDefaultButton2) = vbYes Then
              GoTo RePrint
          End If
          
          '還原印表機
          Printer.Orientation = oOrt
          
          If strOldPrinter <> "" Then
             PUB_RestorePrinter strOldPrinter
          End If
       End If
    End If
End Sub

'Added by Lydia 2016/11/21 列印:國外固定寄催款單清單表頭
Private Sub PUB_PrintAcc225ListHead(ByVal strLetterName As String, ByRef iPrint As Long, ByRef intPage As Integer)
   Dim lngX As Long
   
   iPrint = 500
   Printer.Font.Size = 22
   Printer.Font.Bold = True
   Printer.Font.Underline = True
   Printer.CurrentX = 3700
   Printer.CurrentY = iPrint
   Printer.Print "國外固定寄催款單清單"
   
   iPrint = iPrint + 500
   Printer.Font.Size = 12
   Printer.Font.Bold = False
   Printer.Font.Underline = False
   Printer.CurrentX = 350
   Printer.CurrentY = iPrint
   Printer.Print "列印人：" & strUserName
   Printer.CurrentX = 8500
   Printer.CurrentY = iPrint
   Printer.Print "列印日期：" & Format(strSrvDate(2), "###/##/##")
   
   iPrint = iPrint + 300
   Printer.CurrentX = 350
   Printer.CurrentY = iPrint
   strExc(1) = "來源名稱：" & strLetterName
   Printer.Print strExc(1)

   Printer.CurrentX = 8500
   Printer.CurrentY = iPrint
   Printer.Print "頁　　次：" & str(intPage)
   
   iPrint = iPrint + 300
   Printer.FontBold = True
   Printer.CurrentX = 350
   Printer.CurrentY = iPrint
   Printer.Print "此清單為固定寄催款單對象的資料，請款單請在月底前寄出！"
   
   iPrint = iPrint + 300
   Printer.FontBold = False
   Printer.CurrentX = 350
   Printer.CurrentY = iPrint
   'Modified by Lydia 2017/02/07 案件性質已不顯示
   'strExc(1) = convForm("本所案號", 15) & " " & convForm("案件名稱", 24) & " " & convForm("案件性質", 8) & " " & convForm("請款單號", 10) & " " & convForm("請款對象名稱", 36)
   strExc(1) = convForm("本所案號", 15) & " " & convForm("案件名稱", 24) & " " & convForm("請款單號", 10) & " " & convForm("請款對象名稱", 36)
   Printer.Print strExc(1)
   
   iPrint = iPrint + 300
   Printer.CurrentX = 350
   Printer.CurrentY = iPrint
   Printer.Print String(95, "-")
   
End Sub

'Added by Lydia 2016/11/23 取得各項指示資料的屬性
Public Function Pub_GetITS01Type(ByVal pKeyNo As String) As String
'1代理人2客戶3案件

   If pKeyNo = "" Then
      Pub_GetITS01Type = ""
   Else
      Pub_GetITS01Type = IIf(Left(pKeyNo, 1) = "Y", "1", IIf(Left(pKeyNo, 1) = "X", "2", "3"))
   End If
End Function

'Added by Lydia 2020/06/02 各項指示：直接讀基本檔的欄位另外組成指示，存入暫存檔
Private Sub GetInstRpt(ByVal pFrm As String, ByVal pKeyNo As String)
'pFrm:表單名稱
'pKeyNo: 對象編號=>X/Y/個案
Dim intP As Integer, intQ As Integer
Dim strP1 As String, strP2 As String
Dim pSKey As String '判斷欄位的種類
Dim rsPD  As New ADODB.Recordset
Dim pCase(1 To 4)  As String
Dim arrTmp As Variant

    '***********************
    '暫存檔Inst_Rpt
    'ITR01 VARCHAR2(6) 員工編號
    'ITR02 VARCHAR2(30) 表單名稱
    'ITR03 VARCHAR2(12) X/Y/個案
    'ITR04 VARCHAR2(3) 分類:分類部門+代號
    'ITR05 NUMBER(8) 記錄日期:預設空白
    'ITR06 VARCHAR2(500) 內容
    '***********************
    
    cnnConnection.Execute "delete from inst_rpt where itr01='" & strUserNum & "' and itr02='" & pFrm & "' "

    '逐筆讀取分類檔
    strP1 = "SELECT IT01,IT02,IT03,IT10,IT11,IT12 FROM INSTTYPE WHERE IT11 IS NOT NULL"
    If Left(pKeyNo, 1) = "X" Then
        pSKey = "CU"
        pKeyNo = ChangeCustomerL(pKeyNo)
    ElseIf Left(pKeyNo, 1) = "Y" Then
        pSKey = "FA"
        pKeyNo = ChangeCustomerL(pKeyNo)
    Else
        '個案-排除項目
        strP1 = strP1 & " AND IT01||IT02 NOT IN ('A01','A02','A03','A04','C04','F02' )"
        Call ChgCaseNo(pKeyNo, pCase)
        If pCase(1) = "P" Or pCase(1) = "FCP" Or pCase(1) = "CFP" Then
            pSKey = "PA"
        ElseIf pCase(1) = "T" Or pCase(1) = "FCT" Or pCase(1) = "CFT" Or pCase(1) = "TF" Then
            pSKey = "TM"
        ElseIf InStr(pCase(1), "L") = 0 Then
            pSKey = "SP"
        Else
            pSKey = "HC"
        End If
    End If
    strP1 = strP1 & " ORDER BY 1,2"
    intP = 1
    Set rsPD = ClsLawReadRstMsg(intP, strP1)
    If intP = 1 Then
        rsPD.MoveFirst
        Do While Not rsPD.EOF
            arrTmp = Empty
            arrTmp = Split(UCase("" & rsPD.Fields("IT11")), ";")
            strP1 = "SELECT '" & strUserNum & "' AS ITR01, '" & pFrm & "' AS ITR02, '" & pKeyNo & "' AS ITR03 "
            strP2 = ""
            If InStr("A01,A02,A03,A04", "" & rsPD.Fields("IT01") & rsPD.Fields("IT02")) > 0 Then  '客戶狀態/代理人狀態
                For intP = 0 To UBound(arrTmp)
                   If arrTmp(intP) <> "" Then
                      If Left(arrTmp(intP), Len(pSKey)) = pSKey Then
                         If pSKey = "CU" Then
                            '基本檔的欄位設定日期=99999999
                            strP2 = strP1 & ", " & CNULL(rsPD.Fields("IT01") & rsPD.Fields("IT02")) & " AS ITR04,99999999 AS ITR05, " & IIf(arrTmp(intP) = "CU142", " 'Y' ", arrTmp(intP)) & " AS ITR06 FROM CUSTOMER WHERE CU01='" & Mid(pKeyNo, 1, 8) & "' AND CU02='" & Mid(pKeyNo, 9, 1) & "' "
                            If arrTmp(intP) = "CU80" Then
                               strP2 = strP2 & " AND " & arrTmp(intP) & "=" & CNULL("" & rsPD.Fields("IT03"))
                            ElseIf arrTmp(intP) = "CU111" Then
                                strP2 = strP2 & " AND " & arrTmp(intP) & "='Y' "
                            ElseIf arrTmp(intP) = "CU142" Then
                                strP2 = strP2 & " AND " & arrTmp(intP) & "='B' "
                            End If
                         Else
                            '基本檔的欄位設定日期=99999999
                            strP2 = strP1 & ", " & CNULL(rsPD.Fields("IT01") & rsPD.Fields("IT02")) & " AS ITR04,99999999 AS ITR05, " & IIf(arrTmp(intP) = "FA103", " 'Y' ", arrTmp(intP)) & " AS ITR06  FROM FAGENT WHERE FA01='" & Mid(pKeyNo, 1, 8) & "' AND FA02='" & Mid(pKeyNo, 9, 1) & "' "
                            If arrTmp(intP) = "FA69" Then
                               strP2 = strP2 & " AND " & arrTmp(intP) & "=" & CNULL("" & rsPD.Fields("IT03"))
                            ElseIf arrTmp(intP) = "FA77" Then
                                strP2 = strP2 & " AND " & arrTmp(intP) & "='Y' "
                            ElseIf arrTmp(intP) = "FA103" Then
                                strP2 = strP2 & " AND " & arrTmp(intP) & "='B' "
                            End If
                         End If
                         cnnConnection.Execute "INSERT INTO INST_RPT(ITR01,ITR02,ITR03,ITR04,ITR05,ITR06) " & strP2, intQ
                      End If
                   End If
                Next intP
            ElseIf InStr("C04,F02", "" & rsPD.Fields("IT01") & rsPD.Fields("IT02")) > 0 Then  '案件平台、帳單平台
                '基本檔的欄位設定日期=99999999
                strP2 = strP1 & ", " & CNULL(rsPD.Fields("IT01") & rsPD.Fields("IT02")) & " AS ITR04, 99999999 AS ITR05, LISTAGG(CW03,',') WITHIN GROUP (ORDER BY CW03)  AS ITR06 " & _
                           "FROM (Select CW03 FROM CUSTWEB WHERE INSTR(CW04,'" & pKeyNo & "') > 0 " & IIf(rsPD.Fields("IT01") & rsPD.Fields("IT02") = "C04", "AND CW03 IN ('1','2','4') ", "AND CW03='3' ") & " GROUP BY CW03) "
                cnnConnection.Execute "INSERT INTO INST_RPT(ITR01,ITR02,ITR03,ITR04,ITR05,ITR06) " & strP2, intQ
            Else
                For intP = 0 To UBound(arrTmp)
                   If arrTmp(intP) <> "" Then
                      If Left(arrTmp(intP), Len(pSKey)) = pSKey Then
                         Select Case pSKey
                             '基本檔的欄位設定日期=99999999
                             Case "CU"
                                  strP2 = strP1 & ", " & CNULL(rsPD.Fields("IT01") & rsPD.Fields("IT02")) & " AS ITR04,99999999 AS ITR05, " & arrTmp(intP) & " AS ITR06 FROM CUSTOMER WHERE CU01='" & Mid(pKeyNo, 1, 8) & "' AND CU02='" & Mid(pKeyNo, 9, 1) & "' AND " & arrTmp(intP) & " IS NOT NULL "
                             Case "FA"
                                  strP2 = strP1 & ", " & CNULL(rsPD.Fields("IT01") & rsPD.Fields("IT02")) & " AS ITR04,99999999 AS ITR05, " & arrTmp(intP) & " AS ITR06 FROM FAGENT WHERE FA01='" & Mid(pKeyNo, 1, 8) & "' AND FA02='" & Mid(pKeyNo, 9, 1) & "' AND " & arrTmp(intP) & " IS NOT NULL "
                             Case Else
                                  strP2 = strP1 & ", " & CNULL(rsPD.Fields("IT01") & rsPD.Fields("IT02")) & " AS ITR04,99999999 AS ITR05, " & arrTmp(intP) & " AS ITR06 FROM PATENT WHERE PA01='" & pCase(1) & "' AND PA02='" & pCase(2) & "' AND PA03='" & pCase(3) & "' AND PA04='" & pCase(4) & "'  AND " & arrTmp(intP) & " IS NOT NULL "
                                  If pSKey = "TM" Then
                                      strP2 = Replace(Replace(strP2, "PATENT", "TRADEMARK"), "PA", "TM")
                                  ElseIf pSKey = "SP" Then
                                      strP2 = Replace(Replace(strP2, "PATENT", "ServicePractice"), "PA", "SP")
                                  ElseIf pSKey = "LC" Then
                                      strP2 = Replace(Replace(strP2, "PATENT", "LAWCASE"), "PA", "LC")
                                  ElseIf pSKey = "HC" Then
                                      strP2 = Replace(Replace(strP2, "PATENT", "HIRECASE"), "PA", "HC")
                                  End If
                         End Select
                         cnnConnection.Execute "INSERT INTO INST_RPT(ITR01,ITR02,ITR03,ITR04,ITR05,ITR06) " & strP2, intQ
                      End If
                   End If
                Next intP
            End If
            rsPD.MoveNext
        Loop
        cnnConnection.Execute "delete from inst_rpt where itr01='" & strUserNum & "' and itr02='" & pFrm & "' and itr06 is null " '刪除空白記錄
    End If
    Set rsPD = Nothing
End Sub

'Added by Lydia 2016/11/23 取得各項指示資料
Public Function Pub_GetInstructions(ByVal iFrmName As String, ByVal iKeyNo As String, ByRef outStr As String, Optional ByVal sType As String, Optional ByVal outType As String = "", _
                                                Optional ByVal bolAll As Boolean = False, Optional ByVal pIT10 As String, Optional ByVal SrcType As String = "0") As Boolean
'iFrmName   表單名稱
'iKeyNo     X/Y、案件編號
'outStr     輸出內容
'sType      分類: F-財務通用、非F->A案件通用
'outType    輸出類型 W: word, E: e-mail(html)
'bolAll     是否包含無效指示
'pIT10      使用部門pIT10 (P,T用逗號區隔)
'srcType    資料來源: 0-全部, 1-各項指示Instructions, 2-指示=基本檔的欄位
Dim intY As Integer, strQ1 As String
Dim rsB1 As New ADODB.Recordset
Dim strB1 As String, strCon As String
Dim strGrpB1 As String
Dim strT01 As String, strT02 As String '經過處理的分類說明、內容

   Pub_GetInstructions = False
   outStr = ""
   
   If iKeyNo = "" Then Exit Function
   'Memo by Lydia 2020/08/31 上線前: 清除多餘備註
   
   '分類: F-財務通用、非F->A案件通用
   If sType = "F" Then
      strCon = strCon & " AND SUBSTR(ITS03,1,1)='F'"
   ElseIf sType <> "" Then
      'Added by Lydia 2023/01/18 增加Y:命名作業的判斷
      If Left(sType, 1) = "Y" Then
         strCon = strCon & " AND ITS03=" & CNULL(sType)
      Else
      'end 2023/01/18
         strCon = strCon & " AND SUBSTR(ITS03,1,1)<>'F'"
      End If 'Added by Lydia 2023/01/18
   End If
   '使用部門pIT10 (P,T用逗號區隔)
   If pIT10 <> "" Then
        strCon = strCon & " AND NVL(IT10,'N') IN (" & GetAddStr(pIT10 & ",N") & ") "
   End If
   
   '讀取各項指示檔
   If SrcType = "0" Or SrcType = "1" Then
      'Modified by Lydia 2022/11/24 +ITS13複製對象編號；另外判斷複製指示加註〔111/xx/xx(複製系統日)複製來源：X or Y編號〕
      'strQ1 = strQ1 & " UNION SELECT ITS03,IT03,ITS04,ITS06,ITS05,IT12 FROM INSTRUCTIONS, INSTTYPE " & _
                  "WHERE SUBSTR(ITS03,1,1)=IT01(+) AND SUBSTR(ITS03,2,2)=IT02(+)"
      strQ1 = strQ1 & " UNION SELECT ITS03,IT03,ITS04,DECODE(ITS13,'0',NULL,'〔'||SQLDATET(ITS08)||' 複製來源：'||ITS13||' '||DECODE(FA01,NULL,NVL(CU05,NVL(CU04,CU06)),NVL(FA05,NVL(FA04,FA06)))||'〕'" & IIf(outType = "W", "||CHR(13)", "") & ")" & "||ITS06 as ITS06 " & _
                  ",ITS05,IT12 FROM INSTRUCTIONS, INSTTYPE, FAGENT, CUSTOMER " & _
                  "WHERE SUBSTR(ITS03,1,1)=IT01(+) AND SUBSTR(ITS03,2,2)=IT02(+) AND ITS13=FA01(+) AND '0'=FA02(+) AND ITS13=CU01(+) AND '0'=CU02(+)"
      'end 2022/11/24
      strQ1 = strQ1 & IIf(bolAll = False, " AND NVL(ITS05,'Y')<>'N'", "") & " AND ITS01=" & CNULL(Pub_GetITS01Type(iKeyNo)) & " AND ITS02=" & CNULL(IIf(InStr("X,Y", Left(iKeyNo, 1)) > 0, Mid(iKeyNo & "00000000", 1, 8), iKeyNo))
      strQ1 = strQ1 & strCon
   End If
   
   '直接讀基本檔的欄位另外組成指示，存入暫存檔
   If SrcType = "0" Or SrcType = "2" Then
       Call GetInstRpt(iFrmName, iKeyNo)
       strQ1 = strQ1 & " UNION SELECT ITR04 as ITS03,IT03,ITR05 as ITS04,ITR06 as ITS06,'' as ITS05,IT12 FROM INST_RPT,INSTTYPE" & _
                  " WHERE ITR01='" & strUserNum & "' AND ITR02='" & iFrmName & "' AND " & IIf(InStr("X,Y", Left(iKeyNo, 1)) > 0, "SUBSTR(ITR03,1,8)='" & Mid(iKeyNo & "00000000", 1, 8) & "' ", "ITR03=" & CNULL(iKeyNo)) & _
                  " AND SUBSTR(ITR04,1,1)=IT01 AND SUBSTR(ITR04,2,2)=IT02(+)" & Replace(strCon, "ITS03", "ITR04")
   End If
      
   '分類+記錄日期
   strQ1 = Mid(strQ1, 7) & " ORDER BY ITS03 asc,ITS04 desc"
   intY = 1
   Set rsB1 = ClsLawReadRstMsg(intY, strQ1)
   If intY = 1 Then
      If rsB1.RecordCount > 0 Then
         With rsB1
             .MoveFirst
             Do While Not .EOF
                Call GetFormatITS0306("" & .Fields("ITS03"), "" & .Fields("ITS06"), "" & .Fields("IT03"), "" & .Fields("IT12"), strT01, strT02) 'Added by Lydia 2020/05/14
                '區分輸出類型
                Select Case outType
                Case "W" 'Word: 分隔欄位|+| , 分隔記錄|;|
                    '記錄日期99999999=欄位設定
                    strB1 = strB1 & IIf(Len(strB1) > 0, "|;|", "") & Mid(.Fields("ITS03"), 1, 1) & ":" & strT01 & "|+|" & strT02 & "|+|" & IIf(.Fields("ITS05") = "N", "*", "") & IIf("" & .Fields("ITS04") = "99999999", "欄位設定", ChangeWStringToTDateString(.Fields("ITS04")))
                Case "E" 'E-mail
                    If strB1 = "" Then
                        strB1 = "<TABLE BORDER CELLSPACING=2 CELLPADDING=2 WIDTH=500px STYLE=""border:2px solid;"">"
                        '經過處理的分類說明、內容
                        strB1 = strB1 & "<TR><TD WIDTH=""18%"" VALIGN=""MIDDLE"" HEIGHT=20><span style=""font-size:14px""><P ALIGN=""CENTER"">" & Mid(.Fields("ITS03"), 1, 1) & ":" & strT01 & "</span></TD>"
                        strB1 = strB1 & "<TD WIDTH=""70%"" VALIGN=""MIDDLE"" HEIGHT=20><span style=""font-size:14px""><P ALIGN=""LEFT"">" & strT02 & "</span></TD>"
                        '記錄日期99999999=欄位設定
                         strB1 = strB1 & "<TD WIDTH=""12%"" VALIGN=""MIDDLE"" HEIGHT=20><span style=""font-size:14px""><P ALIGN=""CENTER"">" & IIf("" & .Fields("ITS04") = "99999999", "欄位設定", ChangeWStringToTDateString(.Fields("ITS04"))) & "</span></TD>"
                        strB1 = strB1 & "</TR>"
                        strGrpB1 = "" & .Fields("IT03")
                    Else
                        If strGrpB1 = "" & .Fields("IT03") Then
                            strB1 = strB1 & "<TR><TD VALIGN=""MIDDLE"" HEIGHT=20><span style=""font-size:14px""><P ALIGN=""CENTER""> </span></TD>"
                        Else
                            '經過處理的分類說明
                            strB1 = strB1 & "<TR><TD VALIGN=""MIDDLE"" HEIGHT=20><span style=""font-size:14px""><P ALIGN=""CENTER"">" & Mid(.Fields("ITS03"), 1, 1) & ":" & strT01 & "</span></TD>"
                        End If
                        '經過處理的分類內容
                        strB1 = strB1 & "<TD VALIGN=""MIDDLE"" HEIGHT=20><span style=""font-size:14px""><P ALIGN=""LEFT"">" & strT02 & "</span></TD>"
                        '記錄日期99999999=欄位設定
                        strB1 = strB1 & "<TD VALIGN=""MIDDLE"" HEIGHT=20><span style=""font-size:14px""><P ALIGN=""CENTER"">" & IIf("" & .Fields("ITS04") = "99999999", "欄位設定", ChangeWStringToTDateString(.Fields("ITS04"))) & "</span></TD>"
                        strB1 = strB1 & "</TR>"
                        strGrpB1 = "" & .Fields("IT03")
                    End If
                Case Else
                    '經過處理的分類說明、內容 ; 記錄日期99999999=欄位設定
                    strB1 = strB1 & IIf(Len(strB1) > 0, vbCrLf, "") & IIf("" & .Fields("ITS04") = "99999999", "欄位設定", ChangeWStringToTDateString(.Fields("ITS04"))) & " " & Mid(.Fields("ITS03"), 1, 1) & ":" & strT01 & ":" & strT02
                End Select
                .MoveNext
             Loop
         End With
         
         If outType = "E" Then strB1 = strB1 & "</TABLE>"
         outStr = strB1
         Pub_GetInstructions = True
      End If
   End If
   
   Set rsB1 = Nothing
End Function

'Added by Lydia 2020/05/12 各項指示：分類第1碼，改用Table控制
Public Function PUB_GetInType(ByVal iKind As String) As String
Dim strA As String, intA As Integer
Dim rsAD As New ADODB.Recordset
     
    If iKind = "1" Then
        '取得代碼
        strA = "select AAL04 from AddressA4List where AAL01='INTYPE' and AAL02='19221111' order by AAL03 "
    ElseIf iKind = "2" Then
        '取得代碼+名稱
        strA = "Select A.AAL04||B.AAL04 From AddressA4List A, AddressA4List B " & _
                  "where a.AAL01='INTYPE' and a.AAL02='19221111' and a.AAL01=b.AAL01 and a.AAL03=b.AAL03 and b.AAL02='99999999' order by a.AAL03 "
    ElseIf iKind = "3" Then
        '取得代碼+名稱(用逗號區隔)
        strA = "Select A.AAL04||','||B.AAL04 From AddressA4List A, AddressA4List B " & _
                  "where a.AAL01='INTYPE' and a.AAL02='19221111' and a.AAL01=b.AAL01 and a.AAL03=b.AAL03 and b.AAL02='99999999' order by a.AAL03 "
    End If
    intA = 1
    Set rsAD = ClsLawReadRstMsg(intA, strA)
    If intA = 1 Then
        If iKind = "3" Then
            PUB_GetInType = rsAD.GetString(adClipString, , , ",")
        Else
            PUB_GetInType = rsAD.GetString(adClipString, , , "、")
        End If
        PUB_GetInType = Mid(PUB_GetInType, 1, Len(PUB_GetInType) - 1)
    End If
    Set rsAD = Nothing
End Function

'Added by Lydia 2020/05/14 各項指示：輸出分類說明的例外處理
Public Sub GetFormatITS0306(ByVal pITS03 As String, ByVal pITS06 As String, ByVal pIT03 As String, ByVal pIT12 As String, Optional ByRef outStr01 As String, Optional ByRef outStr02 As String)
'pITS03: 各項指示的分類代碼
'pITS06: 各項指示的內容
'pIT03: 各項指示的分類說明
'pIT12: 各項指示的顯示格式
'outStr01、outStr02:經過處理的分類說明、outStr02:內容
Dim strTmp As String
    If pIT03 = "" Then
        outStr01 = pIT03
        outStr02 = pITS06
    Else
        Select Case pIT12
            Case "N" '讀取X/Y編號的名稱
                   strTmp = pITS06 & "  " & Pub_GetNameBYnation(pITS06)
            Case "D" '顯示民國年/月/日
                   strTmp = ChangeWStringToTDateString(pITS06)
            Case Else
                   strTmp = pITS06
        End Select
        If InStr(pIT03, "-") > 0 Then
            outStr01 = Mid(pIT03, 1, InStr(pIT03, "-") - 1)
            outStr02 = strTmp & Mid(pIT03, InStr(pIT03, "-") + 1)
        Else
            outStr01 = pIT03
            outStr02 = strTmp
        End If
    End If
End Sub

'Added by Lydia 2020/05/14  依國籍取得客戶名稱／依國籍取得代理人名稱
'Modified by Lydia 2022/03/23
Public Function Pub_GetNameBYnation(ByVal pNo As String, Optional ByVal pType As String = "") As String
Dim rsTmp As New ADODB.Recordset
Dim strA1 As String
Dim intJ As Integer
Dim strMidName As String

   Pub_GetNameBYnation = ""
   If pNo = "" Then Exit Function
   
   pNo = ChangeCustomerL(pNo)
   
   Select Case Left(pNo, 1)
      Case "Y" '代理人
           strA1 = "select fa01 No,fa04 name1,fa05||' '||fa63||' '||fa64||' '||fa65 name2,fa06 name3,fa69 istatus,substr(na01,1,3) na01 " & _
                   " from fagent,nation where fa01='" & Mid(pNo, 1, 8) & "' and fa02='" & Mid(pNo, 9, 1) & "' and fa10=na01(+)"
      Case "X"  '客戶
           strA1 = "select cu01 No,cu04 name1,cu05||' '||cu88||' '||cu89||' '||cu90 name2,cu06 name3,cu80 istatus,substr(na01,1,3) na01 " & _
                   " from customer,nation where cu01='" & Mid(pNo, 1, 8) & "' and cu02='" & Mid(pNo, 9, 1) & "'  and cu10=na01(+) "
      'Added by Lydia 2020/11/03 潛在客戶
      Case "R"
           'Added by Lydia 2022/03/23 排除國內潛在客戶
           If pType = "1" Then
              strA1 = "select pcu01 No,pcu08 name1,pcu03||' '||pcu04||' '||pcu05||' '||pcu06 name2,pcu06 name3,pcu07 istatus,substr(na01,1,3) na01 " & _
                      "from potcustomer,nation where pcu01='" & Mid(pNo, 1, 8) & "' and pcu02='" & Mid(pNo, 9, 1) & "'  and pcu10=na01(+) "
           Else
           'end 2022/03/23
              strA1 = "select pcu01 No,pcu08 name1,pcu03||' '||pcu04||' '||pcu05||' '||pcu06 name2,pcu06 name3,pcu07 istatus,substr(na01,1,3) na01 " & _
                      "from potcustomer,nation where pcu01='" & Mid(pNo, 1, 8) & "' and pcu02='" & Mid(pNo, 9, 1) & "'  and pcu10=na01(+) " & _
                      "union all select poc01 no, poc03 name1,poc23||' '||poc24||' '||poc25||' '||poc26 name3,poc27 name3,poc04 istatus,substr(na01,1,3) " & _
                      "from potcustomer1,nation where poc01='" & Mid(pNo, 1, 8) & "' and poc02='" & Mid(pNo, 9, 1) & "'  and poc04=na01(+) "
           End If 'Added by Lydia 2022/03/23
      'end 2020/11/03
   End Select
   
   If strA1 <> "" Then
       intJ = 1
       Set rsTmp = ClsLawReadRstMsg(intJ, strA1)
       If intJ = 1 Then
            If Val("" & rsTmp.Fields("na01")) < 10 And InStr("020,013,044", "" & rsTmp.Fields("na01")) > 0 Then
                '台灣、大陸、香港、澳門地區(台陸港澳)：中->英->日
                strMidName = "" & rsTmp.Fields("name1")
                If Trim(strMidName) = "" Then strMidName = "" & rsTmp.Fields("name2")
                If Trim(strMidName) = "" Then strMidName = "" & rsTmp.Fields("name3")
            Else
                '其他：英->中->日
                strMidName = "" & rsTmp.Fields("name2")
                If Trim(strMidName) = "" Then strMidName = "" & rsTmp.Fields("name1")
                If Trim(strMidName) = "" Then strMidName = "" & rsTmp.Fields("name3")
            End If
            Pub_GetNameBYnation = strMidName
       End If
       
       Set rsTmp = Nothing
   End If
   
End Function

'Added by Lydia 2020/08/25 各項指示：檢查是否已完成確認(依使用者部門)
Public Function PUB_GetInstConfirm(ByVal pUserDept As String, ByVal pKeyNo As String) As Boolean
'------------------------------
'IC03,IC04 確認人員1+日期1(FCP)         => ST03=F2X
'IC05,IC06 確認人員2+日期2(P,CFP)      => ST03=P1X
'IC07,IC08 確認人員3+日期3(FCT,CFT) => ST03=F1X
'IC09,IC10 確認人員4+日期4(T)             =>ST03=P2X
'------------------------------

'pUserDept :使用者部門ST03
'pKeyNo: X/Y/個案編號
Dim strR1 As String, intR As Integer
Dim rsRead As New ADODB.Recordset
Dim pAllKey As String

    PUB_GetInstConfirm = False
    strR1 = ""
    Select Case Left(pUserDept, 2)
         Case "F2"
              strR1 = " and nvl(IC03,'N')<>'N' and nvl(IC04,0) > 0 "
         Case "P1"
              strR1 = " and nvl(IC05,'N')<>'N' and nvl(IC06,0) > 0 "
         Case "F1"
              strR1 = " and nvl(IC07,'N')<>'N' and nvl(IC08,0) > 0 "
         Case "P2"
              strR1 = " and nvl(IC09,'N')<>'N' and nvl(IC10,0) > 0 "
         Case Else
    End Select
    If strR1 <> "" And pKeyNo <> "" Then
         If InStr("X,Y", Left(pKeyNo, 1)) > 0 Then
             pAllKey = Left(ChangeCustomerL(pKeyNo), 8)
         Else
             pAllKey = pKeyNo
         End If
         strR1 = "select 1 from InstConfirm where IC02=" & CNULL(pAllKey) & strR1
         intR = 1
         Set rsRead = ClsLawReadRstMsg(intR, strR1)
         If intR = 1 Then
              PUB_GetInstConfirm = True
         End If
    End If
    Set rsRead = Nothing
    
End Function

'Added by Lydia 2016/11/29 設定關聯代號清單
Public Sub Pub_SetFTypeList(ByRef iCmb As ComboBox, ByVal iLen As Integer)
'iLen: 控制字數長度
Dim idR As Integer
Dim rsAD As New ADODB.Recordset
Dim strR As String

    iCmb.Clear
    iCmb.AddItem "", 0
    strR = "SELECT FT01,FT02 FROM FTYPE ORDER BY 1"
    idR = 1
    Set rsAD = ClsLawReadRstMsg(idR, strR)
    If idR = 1 Then
       rsAD.MoveFirst
       idR = 1
       Do While Not rsAD.EOF
          iCmb.AddItem rsAD.Fields(0) & " " & Trim(Mid(rsAD.Fields(1), 1, iLen))
          iCmb.ItemData(idR) = PUB_Id2Num("" & rsAD.Fields(0))  '傳入文字改成數字
          idR = idR + 1
          rsAD.MoveNext
       Loop
    Else
       MsgBox "查無關聯代號！"
    End If
    
    Set rsAD = Nothing
End Sub

'Added by Lydia 2016/11/29 選取關聯代號,增加到關聯清單
'Modified by Lydia 2017/06/28 回傳iAns數字改成文字
Public Sub Pub_AddFRelationList(ByRef iCbo1 As ComboBox, ByRef iLst1 As ListBox, ByRef iAns As String)
'iAns : 回傳選取的資料代號
   Dim iX As Integer, tmpX  As Integer
   Dim strT As String, iPos As Integer
   
   If iCbo1.Text = "" Then
      MsgBox "請選擇關聯代號!", vbExclamation
      Exit Sub
   Else
      iPos = iCbo1.ListIndex
   End If
   
   If iLst1.ListCount > 0 Then
      For iX = 0 To iLst1.ListCount - 1
         If iLst1.ItemData(iX) = iCbo1.ItemData(iPos) Then
            MsgBox "關聯代號已存在!", vbExclamation
            Exit Sub
         End If
      Next
   End If
   
   tmpX = IIf(iLst1.ListCount = -1, 0, iLst1.ListCount)
   iLst1.AddItem Trim(Mid(iCbo1.Text, 3))
   iLst1.ItemData(tmpX) = iCbo1.ItemData(iPos)
   iCbo1.ListIndex = -1
   iAns = PUB_Num2Id(iCbo1.ItemData(iPos))  '轉成文字
End Sub

'Added by Lydia 2016/11/29 傳入字串,比照combobox的資料項目,新增到List清單中
Public Sub Pub_ShowSelectList(ByRef iCmb As ComboBox, ByRef iLst As ListBox, ByVal iPut As String)
Dim arrTmp As Variant
Dim inX As Integer, inJ As Integer

    If iPut <> "" Then
       arrTmp = Empty: iLst.Clear
       arrTmp = Split(iPut, ",") '逗號區隔
       For inX = 0 To UBound(arrTmp)
          If arrTmp(inX) <> "" Then
             For inJ = 0 To iCmb.ListCount - 1
               If PUB_Num2Id(iCmb.ItemData(inJ)) = arrTmp(inX) Then  '統一用文字, 比對ItemData
                  iLst.AddItem Trim(Mid(iCmb.List(inJ), 3))
                  iLst.ItemData(inX) = PUB_Id2Num(Trim(arrTmp(inX)))  '改成數字
               End If
             Next inJ
          End If
       Next inX
    End If
End Sub

'Added by Lydia 2016/11/29 選取List,從List清單中移除
Public Sub Pub_RemSelectList(ByRef oList As ListBox, Optional ByRef outData As String)
'outData : 被移除的資料項目ItemData
 Dim ii As Integer
 
   outData = ""
   If oList.ListCount > 0 Then
      ii = 0
      Do While ii < oList.ListCount
         If oList.Selected(ii) = True Then
            outData = PUB_Num2Id(oList.ItemData(ii))  '改成文字
            oList.RemoveItem ii
            ii = ii - 1
         End If
         ii = ii + 1
      Loop
   End If
End Sub

'Added by Lydia 2016/12/02 共同查詢抓所有關聯企業
'Memo by Lydia 2020/08/20 重新整理
'Modified by Lydia 2023/09/07 +傳入使用者 pUserNo
Public Function PUB_GetR100114_1(ByVal bolDel As Boolean, ByVal sFrmName As String, ByVal strToGrd As String, Optional ByVal pUserNo As String) As Integer
'UCASE(sFrmName):  來源表單名稱
'strToGrd:  傳入客戶/代理人/潛在客戶代號
'bolDel 是否清除先前記錄
Dim intJ As Integer, intK As Integer, intA As Integer, intQ As Integer
Dim stSQL As String
Dim strTemp(1 To 7) As String
Dim Str01 As String, Str02 As String, Str03 As String
Dim strNoList As String, strChkList As String
Dim rsA1 As New ADODB.Recordset
Dim rsA2 As New ADODB.Recordset
Dim rsA3 As New ADODB.Recordset
Dim bolDup As Boolean
Dim bolTrans As Boolean

On Error GoTo ErrHandle
    
    
    'Added by Lydia 2023/09/07 id從strUserNum改成可傳入
    If pUserNo = "" Then pUserNo = strUserNum
    
    If bolDel = True Then '判斷是否清除先前記錄
       stSQL = "delete from R100114_1 where id=" & CNULL(pUserNo) & " and formid=" & CNULL(UCase(sFrmName))
       cnnConnection.Execute stSQL
    '抓先前傳入客戶/代理人代號已新增的資料
    Else
       stSQL = "select distinct r11402 dno from R100114_1 where r11402 is not null and id=" & CNULL(pUserNo) & " and formid=" & CNULL(UCase(sFrmName)) & _
                " union all select distinct r11409 dno from R100114_1 where r11409 is not null and id=" & CNULL(pUserNo) & " and formid=" & CNULL(UCase(sFrmName))
       intA = 1
       Set rsA2 = ClsLawReadRstMsg(intA, stSQL)
       If intA = 1 Then
          strNoList = rsA2.GetString(adClipString, , , ",")
       End If
    End If
   
    PUB_GetR100114_1 = 0
    'Memo by Lydia 2020/08/21 名稱的抓法: X/Y若為台灣,大陸地區,則抓中->英->日,其他抓英->中->日;
                                          '但是來源的共同查詢ex.申請人是抓中->英->日,因為有些國內客戶設籍為國外,所以先抓中文
    If Len(strToGrd) >= 6 Then
       intJ = 1
JumpExp:
       If intJ = 1 Then
            '客戶
            stSQL = "SELECT '" & Format(intJ, "00") & "' C00,CU01||CU02||Decode(CU02,'0','','＊')||Decode(cu111,'Y','$','')||Decode(cu121,'Y','●','') C01," & _
                    "Decode(sign(instr('000,001,002,003,004,005,006,007,008,009,013,020,044',CU10)),1,NVL(CU04,Decode(CU05,NULL,CU06,CU05||' '||CU88||' '||CU89||' '||CU90)),Decode(CU05,NULL,NVL(CU04,CU06),CU05||' '||CU88||' '||CU89||' '||CU90 )) C02," & _
                    "'' C03,NA03 C04,CU13 C05,CU80 C06,CU79 C07,'' U01,'' U02 " & _
                    "from CUSTOMER,NATION WHERE CU10=NA01(+) AND CU01>='" & Mid(strToGrd, 1, 6) & "00" & "' AND CU01<='" & Mid(strToGrd, 1, 6) & "zz" & "' "
            '代理人
            stSQL = stSQL & "union ALL SELECT '" & Format(intJ, "00") & "' C00,FA01||FA02||Decode(FA02,'0','','＊')||Decode(fa77,'Y','$','') C01," & _
                    "Decode(sign(instr('000,001,002,003,004,005,006,007,008,009,013,020,044',FA10)),1,NVL(FA04,Decode(FA05,NULL,FA06,FA05||' '||FA63||' '||FA64||' '||FA65)),Decode(FA05,NULL,NVL(FA04,FA06),FA05||' '||FA63||' '||FA64||' '||FA65)) C02," & _
                    "'' C03,NA03 C04,'' C05,FA69 C06,FA29 C07,'','' " & _
                    "from FAGENT,NATION WHERE FA10=NA01(+) AND FA01>='" & Mid(strToGrd, 1, 6) & "00" & "' AND FA01<='" & Mid(strToGrd, 1, 6) & "zz" & "' "
            '潛在客戶
            'Modified by Lydia 2021/01/06 潛在客戶不使用關聯企業設定; PCU49=> '' U02
            'Modify By Sindy 2021/6/28 + '1','廠商','2','事務所' => 國外潛在客戶類別
            stSQL = stSQL & "union ALL SELECT '" & Format(intJ, "00") & "' C00,PCU01||PCU02||Decode(PCU02,'0','','＊') C01," & _
                    "Decode(Sign(Instr('000,001,002,003,004,005,006,007,008,009,013,020',Pcu09)),1,Nvl(Pcu08,Decode(Pcu03,Null,Pcu07,Pcu03||' '||Pcu04||' '||Pcu05||' '||Pcu06)),Decode(Pcu03,Null,Nvl(Pcu07,Pcu08),Pcu03||' '||Pcu04||' '||Pcu05||' '||Pcu06)) C02," & _
                    "DECODE(PCU11," & 國外潛在客戶類別 & ",PCU11) C03,NA03 C04,substr(LTrim(PCU38),1,5) C05,PCU39,PCU40,PCU47,'' U02 " & _
                    "from PotCustomer,NATION WHERE PCU09=NA01(+) AND PCU01>='" & Mid(strToGrd, 1, 6) & "00" & "' AND PCU01<='" & Mid(strToGrd, 1, 6) & "zz" & "' "
            '國內潛在客戶
            stSQL = stSQL & "union ALL SELECT '" & Format(intJ, "00") & "' C00,POC01||POC02||Decode(POC02,'0','','＊') C01," & _
                    "Decode(Sign(Instr('000,001,002,003,004,005,006,007,008,009,013,020',Poc04)),1,Nvl(Poc03,Decode(Poc23,Null,Poc28,Poc23||' '||Poc24||' '||Poc25||' '||Poc26)),Decode(Poc23,Null,Nvl(Poc03,Poc28),Poc23||' '||Poc24||' '||Poc25||' '||Poc26)) C02," & _
                    " '' C03,NA03 C04,POC13 C05,POC14 C06,POC15 C07,'','' from PotCustomer1,NATION " & _
                    "WHERE POC04=NA01(+) AND POC01>='" & Mid(strToGrd, 1, 6) & "00" & "' AND POC01<='" & Mid(strToGrd, 1, 6) & "zz" & "' "
            '傳入R1時找出相關的X
            stSQL = stSQL & "UNION ALL SELECT '" & Format(intJ, "00") & "' C00,CU01||CU02||Decode(CU02,'0','','＊')||Decode(cu111,'Y','$','')||Decode(cu121,'Y','●','') C01," & _
                    "Decode(sign(instr('000,001,002,003,004,005,006,007,008,009,013,020,044',CU10)),1,NVL(CU04,Decode(CU05,NULL,CU06,CU05||' '||CU88||' '||CU89||' '||CU90)),Decode(CU05,NULL,NVL(CU04,CU06),CU05||' '||CU88||' '||CU89||' '||CU90 )) C02," & _
                    "'' C03,NA03 C04,CU13 C05,CU80 C06,CU79 C07,'','' " & _
                    "from CUSTOMER, NATION, PotCustomer1 WHERE POC01>='" & Mid(strToGrd, 1, 6) & "00" & "' AND POC01<='" & Mid(strToGrd, 1, 6) & "zz" & "' AND CU01>=(substr(POC16,1,6)||'00') AND CU01<=(substr(POC16,1,6)||'zz') AND POC16 is not null AND CU10=NA01(+) "
            '找出R1的關係企業
            stSQL = stSQL & "union ALL SELECT '" & Format(intJ, "00") & "' C00,POC01||POC02||Decode(POC02,'0','','＊') C01," & _
                        "Decode(Sign(Instr('000,001,002,003,004,005,006,007,008,009,013,020',Poc04)),1,Nvl(Poc03,Decode(Poc23,Null,Poc28,Poc23||' '||Poc24||' '||Poc25||' '||Poc26)),Decode(Poc23,Null,Nvl(Poc03,Poc28),Poc23||' '||Poc24||' '||Poc25||' '||Poc26)) C02, " & _
                        " '' C03,NA03 C04,POC13 C05,POC14 C06,POC15 C07,'','' from PotCustomer1,NATION " & _
                        "WHERE POC04=NA01(+) AND POC16>='" & Mid(strToGrd, 1, 6) & "00" & "' AND POC16<='" & Mid(strToGrd, 1, 6) & "zz" & "' AND POC16 is not null "

            '傳入R1時找出相關的R
            'Modified by Lydia 2021/01/06 潛在客戶不使用關聯企業設定; PCU49=> '' U02
            'Modify By Sindy 2021/6/28 + '1','廠商','2','事務所' => 國外潛在客戶類別
            stSQL = stSQL & "union ALL SELECT '" & Format(intJ, "00") & "' C00,PCU01||PCU02||Decode(PCU02,'0','','＊') C01," & _
                    "Decode(Sign(Instr('000,001,002,003,004,005,006,007,008,009,013,020',Pcu09)),1,Nvl(Pcu08,Decode(Pcu03,Null,Pcu07,Pcu03||' '||Pcu04||' '||Pcu05||' '||Pcu06)),Decode(Pcu03,Null,Nvl(Pcu07,Pcu08),Pcu03||' '||Pcu04||' '||Pcu05||' '||Pcu06)) C02," & _
                    "DECODE(PCU11," & 國外潛在客戶類別 & ",PCU11) C03,NA03 C04,substr(LTrim(PCU38),1,5) C05,PCU39,PCU40,PCU47,'' U02 from PotCustomer, PotCustomer1,NATION WHERE POC01>='" & Mid(strToGrd, 1, 6) & "00" & "' AND POC01<='" & Mid(strToGrd, 1, 6) & "zz" & "' " & _
                    "AND PCU47>=(substr(POC16,1,6)||'00') AND PCU47<=(substr(POC16,1,6)||'zz') AND POC16 is not null AND PCU47 is not null AND PCU09=NA01(+)"

             '傳入R時找出相關的X
            stSQL = stSQL & "union ALL SELECT '" & Format(intJ, "00") & "' C00,CU01||CU02||Decode(CU02,'0','','＊')||Decode(cu111,'Y','$','')||Decode(cu121,'Y','●','') C01," & _
                    "Decode(sign(instr('000,001,002,003,004,005,006,007,008,009,013,020,044',CU10)),1,NVL(CU04,Decode(CU05,NULL,CU06,CU05||' '||CU88||' '||CU89||' '||CU90)),Decode(CU05,NULL,NVL(CU04,CU06),CU05||' '||CU88||' '||CU89||' '||CU90 )) C02," & _
                    "'' C03,NA03 C04,CU13 C05,CU80 C06,CU79 C07,'','' " & _
                    "from CUSTOMER, PotCustomer, NATION  WHERE PCU01>='" & Mid(strToGrd, 1, 6) & "00" & "' AND PCU01<='" & Mid(strToGrd, 1, 6) & "zz" & "' AND CU01>=(substr(PCU47,1,6)||'00') AND CU01<=(substr(PCU47,1,6)||'zz') " & _
                    "AND PCU47 is not null AND CU10=NA01(+)  "

            '傳入R時找出相關的Y
            stSQL = stSQL & "union ALL SELECT '" & Format(intJ, "00") & "' C00,FA01||FA02||Decode(FA02,'0','','＊') C01," & _
                    "Decode(sign(instr('000,001,002,003,004,005,006,007,008,009,013,020,044',FA10)),1,NVL(FA04,Decode(FA05,NULL,FA06,FA05||' '||FA63||' '||FA64||' '||FA65)),Decode(FA05,NULL,NVL(FA04,FA06),FA05||' '||FA63||' '||FA64||' '||FA65)) C02," & _
                    "'' C03,NA03 C04,'' C05,FA69 C06,FA29 C07,'','' " & _
                    "from Fagent, PotCustomer, NATION WHERE PCU01>='" & Mid(strToGrd, 1, 6) & "00" & "' AND PCU01<='" & Mid(strToGrd, 1, 6) & "zz" & "' AND FA01>=(substr(PCU47,1,6)||'00') AND FA01<=(substr(PCU47,1,6)||'zz') " & _
                    "AND PCU47 is not null AND NA01(+)=FA10 "
                     
            '找出R的關係企業
            'Modified by Lydia 2021/01/06 潛在客戶不使用關聯企業設定; PCU49=> '' U02
            'Modify By Sindy 2021/6/28 + '1','廠商','2','事務所' => 國外潛在客戶類別
            stSQL = stSQL & "union ALL SELECT '" & Format(intJ, "00") & "' C00,PCU01||PCU02||Decode(PCU02,'0','','＊') C01," & _
                    "Decode(Sign(Instr('000,001,002,003,004,005,006,007,008,009,013,020',Pcu09)),1,Nvl(Pcu08,Decode(Pcu03,Null,Pcu07,Pcu03||' '||Pcu04||' '||Pcu05||' '||Pcu06)),Decode(Pcu03,Null,Nvl(Pcu07,Pcu08),Pcu03||' '||Pcu04||' '||Pcu05||' '||Pcu06)) C02," & _
                    "DECODE(PCU11," & 國外潛在客戶類別 & ",PCU11) C03,NA03 C04,substr(LTrim(PCU38),1,5) C05,PCU39,PCU40,PCU47,'' U02 " & _
                    "from PotCustomer,NATION WHERE PCU47>='" & Mid(strToGrd, 1, 6) & "00" & "' AND PCU47<='" & Mid(strToGrd, 1, 6) & "zz" & "' AND PCU09=NA01(+) AND PCU47 is not null "

            '傳入R時找出相關的R1
            stSQL = stSQL & "union ALL SELECT '" & Format(intJ, "00") & "' C00,POC01||POC02||Decode(POC02,'0','','＊') C01," & _
                     "Decode(Sign(Instr('000,001,002,003,004,005,006,007,008,009,013,020',Poc04)),1,Nvl(Poc03,Decode(Poc23,Null,Poc28,Poc23||' '||Poc24||' '||Poc25||' '||Poc26)),Decode(Poc23,Null,Nvl(Poc03,Poc28),Poc23||' '||Poc24||' '||Poc25||' '||Poc26)) C02," & _
                    " '' C03,NA03 C04,POC13 C05,POC14 C06,POC15 C07,'','' from PotCustomer1, PotCustomer,NATION WHERE PCU01>='" & Mid(strToGrd, 1, 6) & "00" & "' AND PCU01<='" & Mid(strToGrd, 1, 6) & "zz" & "' " & _
                    "AND POC16>=(substr(PCU47,1,6)||'00') AND POC16<=(substr(PCU47,1,6)||'zz') AND NA04=POC04(+) AND PCU47 is not null AND POC16 is not null "
                     
       Else '從關聯客戶抓資料：在上一層抓到關聯關係會直接先丟到下一層
            '客戶 : 抓所有相關編號(前6碼)人
            stSQL = "SELECT '" & Format(intJ, "00") & "' C00,CU01||CU02||Decode(CU02,'0','','＊')||Decode(cu111,'Y','$','')||Decode(cu121,'Y','●','') C01," & _
                    "Decode(sign(instr('000,001,002,003,004,005,006,007,008,009,013,020,044',CU10)),1,NVL(CU04,Decode(CU05,NULL,CU06,CU05||' '||CU88||' '||CU89||' '||CU90)),Decode(CU05,NULL,NVL(CU04,CU06),CU05||' '||CU88||' '||CU89||' '||CU90 )) C02," & _
                    "'' C03,NA03 C04,CU13 C05,CU80 C06,CU79 C07,'' U01,'' U02 " & _
                    "from CUSTOMER,NATION  WHERE CU10=NA01(+) AND SUBSTR(CU01,1,6) IN (SELECT SUBSTR(R11402,1,6) FROM R100114_1 WHERE ID='" & pUserNo & "' AND FORMID='" & UCase(sFrmName) & "' AND R11401='" & Format(intJ, "00") & "' ) " & _
                    "AND CU01||CU02 NOT IN (SELECT R11409 FROM R100114_1 WHERE ID='" & pUserNo & "' AND FORMID='" & UCase(sFrmName) & "' AND R11409 IS NOT NULL) "
         
            '代理人 :  抓所有相關編號(前6碼)人
            stSQL = stSQL & "union ALL SELECT '" & Format(intJ, "00") & "' C00,FA01||FA02||Decode(FA02,'0','','＊')||Decode(fa77,'Y','$','') C01," & _
                    "Decode(sign(instr('000,001,002,003,004,005,006,007,008,009,013,020,044',FA10)),1,NVL(FA04,Decode(FA05,NULL,FA06,FA05||' '||FA63||' '||FA64||' '||FA65)),Decode(FA05,NULL,NVL(FA04,FA06),FA05||' '||FA63||' '||FA64||' '||FA65)) C02," & _
                    "'' C03,NA03 C04,'' C05,FA69 C06,FA29 C07,'','' " & _
                    "from FAGENT,NATION  WHERE FA10=NA01(+) AND SUBSTR(FA01,1,6) IN (SELECT SUBSTR(R11402,1,6) FROM R100114_1 WHERE ID='" & pUserNo & "' AND FORMID='" & UCase(sFrmName) & "' AND R11401='" & Format(intJ, "00") & "' ) " & _
                    "AND FA01||FA02 NOT IN (SELECT R11409 FROM R100114_1 WHERE ID='" & pUserNo & "' AND FORMID='" & UCase(sFrmName) & "' AND R11409 IS NOT NULL) "

            '潛在客戶 :  抓所有相關編號(前6碼)人
            'Modified by Lydia 2021/01/06 潛在客戶不使用關聯企業設定; PCU49=> '' U02
            'Modify By Sindy 2021/6/28 + '1','廠商','2','事務所' => 國外潛在客戶類別
            stSQL = stSQL & "union ALL SELECT '" & Format(intJ, "00") & "' C00,PCU01||PCU02||Decode(PCU02,'0','','＊') C01," & _
                    "Decode(Sign(Instr('000,001,002,003,004,005,006,007,008,009,013,020',Pcu09)),1,Nvl(Pcu08,Decode(Pcu03,Null,Pcu07,Pcu03||' '||Pcu04||' '||Pcu05||' '||Pcu06)),Decode(Pcu03,Null,Nvl(Pcu07,Pcu08),Pcu03||' '||Pcu04||' '||Pcu05||' '||Pcu06)) C02," & _
                    "DECODE(PCU11," & 國外潛在客戶類別 & ",PCU11) C03,NA03 C04,substr(LTrim(PCU38),1,5) C05,PCU39,PCU40,PCU47, '' U02 from PotCustomer,NATION WHERE PCU09=NA01(+) AND SUBSTR(PCU01,1,6) IN (SELECT SUBSTR(R11402,1,6) FROM R100114_1 WHERE ID='" & pUserNo & "' AND FORMID='" & UCase(sFrmName) & "' AND R11401='" & Format(intJ, "00") & "' ) " & _
                    "AND PCU01||PCU02 NOT IN (SELECT R11409 FROM R100114_1 WHERE ID='" & pUserNo & "' AND FORMID='" & UCase(sFrmName) & "' AND R11409 IS NOT NULL) "
                    
            '國內潛在客戶 :  抓所有相關編號(前6碼)人
            stSQL = stSQL & "union ALL SELECT '" & Format(intJ, "00") & "' C00,POC01||POC02||Decode(POC02,'0','','＊') C01," & _
                    "Decode(Sign(Instr('000,001,002,003,004,005,006,007,008,009,013,020',Poc04)),1,Nvl(Poc03,Decode(Poc23,Null,Poc28,Poc23||' '||Poc24||' '||Poc25||' '||Poc26)),Decode(Poc23,Null,Nvl(Poc03,Poc28),Poc23||' '||Poc24||' '||Poc25||' '||Poc26)) C02," & _
                    " '' C03,NA03 C04,POC13 C05,POC14 C06,POC15 C07,'','' from PotCustomer1,NATION WHERE POC04=NA01(+) AND SUBSTR(POC01,1,6) IN (SELECT SUBSTR(R11402,1,6) FROM R100114_1 WHERE ID='" & pUserNo & "' AND FORMID='" & UCase(sFrmName) & "' AND R11401='" & Format(intJ, "00") & "' ) " & _
                    "AND POC01||POC02 NOT IN (SELECT R11409 FROM R100114_1 WHERE ID='" & pUserNo & "' AND FORMID='" & UCase(sFrmName) & "' AND R11409 IS NOT NULL) "
                     
            '傳入R1時找出相關的X :  抓所有相關編號(前6碼)人
            stSQL = stSQL & "UNION ALL SELECT '" & Format(intJ, "00") & "' C00,CU01||CU02||Decode(CU02,'0','','＊')||Decode(cu111,'Y','$','')||Decode(cu121,'Y','●','') C01," & _
                    "Decode(sign(instr('000,001,002,003,004,005,006,007,008,009,013,020,044',CU10)),1,NVL(CU04,Decode(CU05,NULL,CU06,CU05||' '||CU88||' '||CU89||' '||CU90)),Decode(CU05,NULL,NVL(CU04,CU06),CU05||' '||CU88||' '||CU89||' '||CU90 )) C02," & _
                    "'' C03,NA03 C04,CU13 C05,CU80 C06,CU79 C07,'','' from CUSTOMER, NATION, PotCustomer1 " & _
                    "WHERE SUBSTR(POC01,1,6) IN (SELECT SUBSTR(R11402,1,6) FROM R100114_1 WHERE ID='" & pUserNo & "' AND FORMID='" & UCase(sFrmName) & "' AND R11401='" & Format(intJ, "00") & "' ) " & _
                    "AND POC01||POC02 NOT IN (SELECT R11409 FROM R100114_1 WHERE ID='" & pUserNo & "' AND FORMID='" & UCase(sFrmName) & "' AND R11409 IS NOT NULL) " & _
                    "AND CU01>=(substr(POC16,1,6)||'00') AND CU01<=(substr(POC16,1,6)||'zz') AND POC16 is not null AND CU10=NA01(+) "
                     
            '找出R1的關係企業 :  抓所有相關編號(前6碼)人
            stSQL = stSQL & "union ALL SELECT '" & Format(intJ, "00") & "' C00,POC01||POC02||Decode(POC02,'0','','＊') C01," & _
                    "Decode(Sign(Instr('000,001,002,003,004,005,006,007,008,009,013,020',Poc04)),1,Nvl(Poc03,Decode(Poc23,Null,Poc28,Poc23||' '||Poc24||' '||Poc25||' '||Poc26)),Decode(Poc23,Null,Nvl(Poc03,Poc28),Poc23||' '||Poc24||' '||Poc25||' '||Poc26)) C02," & _
                    " '' C03,NA03 C04,POC13 C05,POC14 C06,POC15 C07,'','' from PotCustomer1,NATION WHERE POC04=NA01(+) " & _
                    "AND SUBSTR(POC16,1,6) IN (SELECT SUBSTR(R11402,1,6) FROM R100114_1 WHERE ID='" & pUserNo & "' AND FORMID='" & UCase(sFrmName) & "' AND R11401='" & Format(intJ, "00") & "' ) " & _
                    "AND POC16 NOT IN (SELECT R11409 FROM R100114_1 WHERE ID='" & pUserNo & "' AND FORMID='" & UCase(sFrmName) & "' AND R11409 IS NOT NULL) AND POC16 is not null "
                     
            '傳入R1時找出相關的R :  抓所有相關編號(前6碼)人
            'Modified by Lydia 2021/01/06 潛在客戶不使用關聯企業設定; PCU49=> '' U02
            'Modify By Sindy 2021/6/28 + '1','廠商','2','事務所' => 國外潛在客戶類別
            stSQL = stSQL & "union ALL SELECT '" & Format(intJ, "00") & "' C00,PCU01||PCU02||Decode(PCU02,'0','','＊')," & _
                     "Decode(Sign(Instr('000,001,002,003,004,005,006,007,008,009,013,020',Pcu09)),1,Nvl(Pcu08,Decode(Pcu03,Null,Pcu07,Pcu03||' '||Pcu04||' '||Pcu05||' '||Pcu06)),Decode(Pcu03,Null,Nvl(Pcu07,Pcu08),Pcu03||' '||Pcu04||' '||Pcu05||' '||Pcu06)) C02," & _
                    "DECODE(PCU11," & 國外潛在客戶類別 & ",PCU11) C03,NA03 C04,substr(LTrim(PCU38),1,5) C05,PCU39,PCU40,PCU47,'' U02 " & _
                    "from PotCustomer, PotCustomer1,NATION WHERE SUBSTR(POC01,1,6) IN (SELECT SUBSTR(R11402,1,6) FROM R100114_1 WHERE ID='" & pUserNo & "' AND FORMID='" & UCase(sFrmName) & "' AND R11401='" & Format(intJ, "00") & "' ) " & _
                    "AND POC01||POC02 NOT IN (SELECT R11409 FROM R100114_1 WHERE ID='" & pUserNo & "' AND FORMID='" & UCase(sFrmName) & "' AND R11409 IS NOT NULL) " & _
                    "AND PCU47>=(substr(POC16,1,6)||'00') AND PCU47<=(substr(POC16,1,6)||'zz') AND POC16 is not null AND PCU47 is not null AND PCU09=NA01(+) "
     
            '傳入R時找出相關的X :  抓所有相關編號(前6碼)人
            stSQL = stSQL & "union ALL SELECT '" & Format(intJ, "00") & "' C00,CU01||CU02||Decode(CU02,'0','','＊')||Decode(cu111,'Y','$','')||Decode(cu121,'Y','●','') C01," & _
                    "Decode(sign(instr('000,001,002,003,004,005,006,007,008,009,013,020,044',CU10)),1,NVL(CU04,Decode(CU05,NULL,CU06,CU05||' '||CU88||' '||CU89||' '||CU90)),Decode(CU05,NULL,NVL(CU04,CU06),CU05||' '||CU88||' '||CU89||' '||CU90 )) C02,'' C03," & _
                    "NA03 C04,CU13 C05,CU80 C06,CU79 C07,'','' from CUSTOMER, NATION, PotCustomer " & _
                    "WHERE SUBSTR(PCU01,1,6) IN (SELECT SUBSTR(R11402,1,6) FROM R100114_1 WHERE ID='" & pUserNo & "' AND FORMID='" & UCase(sFrmName) & "' AND R11401='" & Format(intJ, "00") & "' ) " & _
                    "AND PCU01||PCU02 NOT IN (SELECT R11409 FROM R100114_1 WHERE ID='" & pUserNo & "' AND FORMID='" & UCase(sFrmName) & "' AND R11409 IS NOT NULL) " & _
                    "AND CU01>=(substr(PCU47,1,6)||'00') AND CU01<=(substr(PCU47,1,6)||'zz') AND PCU47 is not null AND CU10=NA01(+) "
             
            '傳入R時找出相關的Y :  抓所有相關編號(前6碼)人
            stSQL = stSQL & "union ALL SELECT '" & Format(intJ, "00") & "' C00,FA01||FA02||Decode(FA02,'0','','＊') C01," & _
                    "Decode(sign(instr('000,001,002,003,004,005,006,007,008,009,013,020,044',FA10)),1,NVL(FA04,Decode(FA05,NULL,FA06,FA05||' '||FA63||' '||FA64||' '||FA65)),Decode(FA05,NULL,NVL(FA04,FA06),FA05||' '||FA63||' '||FA64||' '||FA65)) C02," & _
                    "'' C03,NA03 C04,'' C05,FA69 C06,FA29 C07,'','' from Fagent, PotCustomer, NATION " & _
                    "WHERE SUBSTR(PCU01,1,6) IN (SELECT SUBSTR(R11402,1,6) FROM R100114_1 WHERE ID='" & pUserNo & "' AND FORMID='" & UCase(sFrmName) & "' AND R11401='" & Format(intJ, "00") & "' ) " & _
                    "AND PCU01||PCU02 NOT IN (SELECT R11409 FROM R100114_1 WHERE ID='" & pUserNo & "' AND FORMID='" & UCase(sFrmName) & "' AND R11409 IS NOT NULL) " & _
                    "AND FA01>=(substr(PCU47,1,6)||'00') AND FA01<=(substr(PCU47,1,6)||'zz') AND PCU47 is not null AND NA01(+)=FA10 "
                 
            '找出R的關係企業 : 抓所有相關編號(前6碼)人
            'Modified by Lydia 2021/01/06 潛在客戶不使用關聯企業設定; PCU49=> '' U02
            'Modify By Sindy 2021/6/28 + '1','廠商','2','事務所' => 國外潛在客戶類別
            stSQL = stSQL & "union ALL SELECT '" & Format(intJ, "00") & "' C00,PCU01||PCU02||Decode(PCU02,'0','','＊') C01," & _
                    "Decode(Sign(Instr('000,001,002,003,004,005,006,007,008,009,013,020',Pcu09)),1,Nvl(Pcu08,Decode(Pcu03,Null,Pcu07,Pcu03||' '||Pcu04||' '||Pcu05||' '||Pcu06)),Decode(Pcu03,Null,Nvl(Pcu07,Pcu08),Pcu03||' '||Pcu04||' '||Pcu05||' '||Pcu06)) C02," & _
                    "DECODE(PCU11," & 國外潛在客戶類別 & ",PCU11) C03,NA03 C04,substr(LTrim(PCU38),1,5) C05,PCU39,PCU40,PCU47,'' U02 from PotCustomer,NATION " & _
                    "WHERE SUBSTR(PCU47,1,6) IN (SELECT SUBSTR(R11402,1,6) FROM R100114_1 WHERE ID='" & pUserNo & "' AND FORMID='" & UCase(sFrmName) & "' AND R11401='" & Format(intJ, "00") & "' ) " & _
                    "AND PCU47 NOT IN (SELECT R11409 FROM R100114_1 WHERE ID='" & pUserNo & "' AND FORMID='" & UCase(sFrmName) & "' AND R11409 IS NOT NULL) " & _
                    "AND PCU09=NA01(+) AND PCU47 is not null "
                     
            '傳入R時找出相關的R1 :  抓所有相關編號(前6碼)人
            stSQL = stSQL & "union ALL SELECT '" & Format(intJ, "00") & "' C00,POC01||POC02||Decode(POC02,'0','','＊') C01," & _
                    "Decode(Sign(Instr('000,001,002,003,004,005,006,007,008,009,013,020',Poc04)),1,Nvl(Poc03,Decode(Poc23,Null,Poc28,Poc23||' '||Poc24||' '||Poc25||' '||Poc26)),Decode(Poc23,Null,Nvl(Poc03,Poc28),Poc23||' '||Poc24||' '||Poc25||' '||Poc26)) C02, " & _
                    " '' C03,NA03 C04,POC13 C05,POC14 C06,POC15 C07,'','' from PotCustomer1, PotCustomer,NATION " & _
                    "WHERE SUBSTR(PCU01,1,6) IN (SELECT SUBSTR(R11402,1,6) FROM R100114_1 WHERE ID='" & pUserNo & "' AND FORMID='" & UCase(sFrmName) & "' AND R11401='" & Format(intJ, "00") & "' ) " & _
                    "AND PCU01||PCU02 NOT IN (SELECT R11409 FROM R100114_1 WHERE ID='" & pUserNo & "' AND FORMID='" & UCase(sFrmName) & "' AND R11409 IS NOT NULL) " & _
                    "AND POC16>=(substr(PCU47,1,6)||'00') AND POC16<=(substr(PCU47,1,6)||'zz') AND NA04=POC04(+) AND PCU47 is not null AND POC16 is not null "
       End If
       stSQL = stSQL & " ORDER BY C00 ASC, C01 ASC "
       
       Set rsA1 = ClsLawReadRstMsg(intK, stSQL)
       If intK = 0 Then
'-------主查詢沒有資料=>最後逐筆檢查，刪除重複資料
          stSQL = "select r11401,r11402,r11403,r11409,r11410,r11411 from r100114_1 WHERE ID='" & pUserNo & "' AND FORMID='" & UCase(sFrmName) & "' order by r11401 asc ,r11402 asc ,r11409 asc"
          Set rsA1 = ClsLawReadRstMsg(intK, stSQL)
          If intK = 1 Then
               rsA1.MoveFirst
               Do While Not rsA1.EOF
                  If strChkList = "" Or (strChkList <> "" And InStr(strChkList, "," & rsA1.Fields("r11402")) = 0) Then
                      strChkList = strChkList & "," & rsA1.Fields("r11402")
                  Else
                      stSQL = "DELETE FROM R100114_1 WHERE ID='" & pUserNo & "' AND FORMID='" & UCase(sFrmName) & "' AND R11402||R11409='" & Trim(rsA1.Fields("R11402") & rsA1.Fields("R11409")) & "' AND R11401='" & Trim(rsA1.Fields("R11401")) & "' "
                      cnnConnection.Execute stSQL, intQ
                  End If
                  rsA1.MoveNext
               Loop
          End If
          PUB_GetR100114_1 = intJ
          Set rsA1 = Nothing
          Set rsA2 = Nothing
          Set rsA3 = Nothing
          Exit Function
       End If
'-------主查詢有抓到資料
       If intK = 1 Then
            With rsA1
                rsA1.MoveFirst
                bolTrans = True
                cnnConnection.BeginTrans
                Do While Not .EOF
                   '客戶/代理人/國內潛在客戶 X,Y,R1 : 更名後的編號不判斷關聯企業
                   If Mid(.Fields("C01"), 9, 1) = "0" And Trim("" & .Fields("U01")) = "" Then
                       stSQL = "select fr01,fr02,fr03,fr04," & _
                               "c1.cu01||c1.cu02||Decode(c1.cu02,'0','','＊')||Decode(c1.cu111,'Y','$','')||Decode(c1.cu121,'Y','●','') AC01,Decode(instr('000,001,002,003,004,005,006,007,008,009,013,020,044',c1.cu10),0,Decode(c1.cu05,NULL,NVL(c1.cu04,c1.cu06),c1.cu05||' '||c1.cu88||' '||c1.cu89||' '||c1.cu90),NVL(c1.cu04,Decode(c1.cu05,NULL,c1.cu06,c1.cu05||' '||c1.cu88||' '||c1.cu89||' '||c1.cu90)) ) AC02,'' AC03,c1.CU10 AC04,c1.CU13 AC05,c1.CU80 AC06,c1.CU79 AC07," & _
                               "c2.cu01||c2.cu02||Decode(c2.cu02,'0','','＊')||Decode(c2.cu111,'Y','$','')||Decode(c2.cu121,'Y','●','') BC01,Decode(instr('000,001,002,003,004,005,006,007,008,009,013,020,044',c2.cu10),0,Decode(c2.cu05,NULL,NVL(c2.cu04,c2.cu06),c2.cu05||' '||c2.cu88||' '||c2.cu89||' '||c2.cu90),NVL(c2.cu04,Decode(c2.cu05,NULL,c2.cu06,c2.cu05||' '||c2.cu88||' '||c2.cu89||' '||c2.cu90)) ) BC02,'' BC03,c2.CU10 BC04,c2.CU13 BC05,c2.CU80 BC06,c2.CU79 BC07," & _
                               "f1.fa01||f1.fa02||Decode(f1.fa02,'0','','＊')||Decode(f1.fa77,'Y','$','') af01,Decode(instr('000,001,002,003,004,005,006,007,008,009,013,020,044',f1.fa10),0,Decode(f1.fa05,NULL,NVL(f1.fa04,f1.fa06),f1.fa05||' '||f1.fa63||' '||f1.fa64||' '||f1.fa65),NVL(f1.fa04,Decode(f1.fa05,NULL,f1.fa06,f1.fa05||' '||f1.fa63||' '||f1.fa64||' '||f1.fa65)) ) af02,'' af03,f1.fa10 af04,'' af05,f1.FA69 af06,f1.FA29 af07," & _
                               "f2.fa01||f2.fa02||Decode(f2.fa02,'0','','＊')||Decode(f2.fa77,'Y','$','') bf01,Decode(instr('000,001,002,003,004,005,006,007,008,009,013,020,044',f2.fa10),0,Decode(f2.fa05,NULL,NVL(f2.fa04,f2.fa06),f2.fa05||' '||f2.fa63||' '||f2.fa64||' '||f2.fa65),NVL(f2.fa04,Decode(f2.fa05,NULL,f2.fa06,f2.fa05||' '||f2.fa63||' '||f2.fa64||' '||f2.fa65)) ) bf02,'' bf03,f2.fa10 bf04,'' bf05,f2.FA69 bf06,f2.FA29 bf07 " & _
                               "from frelation,customer c1,customer c2,fagent f1,fagent f2 where (fr01=" & CNULL(Mid(.Fields("C01"), 1, 8)) & " or fr02=" & CNULL(Mid(.Fields("C01"), 1, 8)) & ") " & _
                               "and fr01=c1.cu01(+) and '0'=c1.cu02(+) and fr02=c2.cu01(+) and '0'=c2.cu02(+) and fr01=f1.fa01(+) and '0'=f1.fa02(+) and fr02=f2.fa01(+) and '0'=f2.fa02(+) " & _
                               "order by fr01,fr02"
                       intA = 1
                       Set rsA2 = ClsLawReadRstMsg(intA, stSQL)
                       If intA = 1 Then
                            rsA2.MoveFirst
                            Do While Not rsA2.EOF
                               '檢查是否有重複關聯
                               If strNoList = "" Or InStr(strNoList, IIf(rsA2.Fields("fr01") = Mid(.Fields("C01"), 1, 8), rsA2.Fields("fr02"), rsA2.Fields("fr01"))) = 0 Then
                                    '若無重複關聯,原編號資料+顯示關聯關係
                                    Str01 = Mid(IIf(rsA2.Fields("fr01") = Mid(.Fields("C01"), 1, 8), rsA2.Fields("fr02"), rsA2.Fields("fr01")) & "0", 1, 9)
                                    Str02 = PUB_GetFR03desc("" & rsA2.Fields("fr03"))
                                    Str03 = PUB_StrToStr(Replace(ChgSQL("" & rsA2.Fields("fr04")), vbCrLf, " & "), 200)
                                    If strNoList = "" Or (strNoList <> "" And InStr(strNoList, "" & .Fields("C01")) = 0) Then
                                        stSQL = "INSERT INTO R100114_1 (ID,FORMID,R11401,R11402,R11403,R11404,R11405,R11406,R11407,R11408,R11409,R11410,R11411) " & _
                                                 "VALUES ('" & pUserNo & "','" & UCase(sFrmName) & "'," & CNULL("" & .Fields("C00")) & "," & CNULL("" & .Fields("C01")) & "," & CNULL(PUB_StrToStr(ChgSQL("" & .Fields("C02")), 180)) & _
                                                 "," & CNULL("" & .Fields("C03")) & "," & CNULL("" & .Fields("C04")) & "," & CNULL("" & .Fields("C05")) & "," & CNULL("" & .Fields("C06")) & "," & CNULL(PUB_StrToStr(Replace(ChgSQL("" & .Fields("C07")), vbCrLf, " & "), 200)) & _
                                                 ", null , null, null)"
                                        cnnConnection.Execute stSQL, intQ
                                        strNoList = strNoList & Left("" & .Fields("C01"), 9) & ","
                                    End If
                                    '將關聯關係丟到下一層
                                    'Modify By Sindy 2021/6/28 + '1','廠商','2','事務所' => 國外潛在客戶類別
                                    stSQL = "SELECT '01' C00,CU01||CU02||Decode(CU02,'0','','＊')||Decode(cu111,'Y','$','')||Decode(cu121,'Y','●','') C01,Decode(sign(instr('000,001,002,003,004,005,006,007,008,009,013,020,044',CU10)),1,NVL(CU04,Decode(CU05,NULL,CU06,CU05||' '||CU88||' '||CU89||' '||CU90)),Decode(CU05,NULL,NVL(CU04,CU06),CU05||' '||CU88||' '||CU89||' '||CU90 )) C02,'' C03,NA03 C04,CU13 C05,CU80 C06,CU79 C07 from CUSTOMER,NATION WHERE CU10=NA01(+) AND CU01='" & Left(Str01, 8) & "' AND CU02='0' "
                                    stSQL = stSQL & "Union ALL SELECT '01' C00,FA01||FA02||Decode(FA02,'0','','＊')||Decode(fa77,'Y','$','') C01,Decode(sign(instr('000,001,002,003,004,005,006,007,008,009,013,020,044',FA10)),1,NVL(FA04,Decode(FA05,NULL,FA06,FA05||' '||FA63||' '||FA64||' '||FA65)),Decode(FA05,NULL,NVL(FA04,FA06),FA05||' '||FA63||' '||FA64||' '||FA65)) C02,'' C03,NA03 C04,'' C05,FA69 C06,FA29 C07 from FAGENT,NATION WHERE FA10=NA01(+) AND FA01='" & Left(Str01, 8) & "' AND FA02='0' "
                                    stSQL = stSQL & "Union ALL SELECT '01' C00,PCU01||PCU02||Decode(PCU02,'0','','＊') C01,Decode(Sign(Instr('000,001,002,003,004,005,006,007,008,009,013,020',Pcu09)),1,Nvl(Pcu08,Decode(Pcu03,Null,Pcu07,Pcu03||' '||Pcu04||' '||Pcu05||' '||Pcu06)),Decode(Pcu03,Null,Nvl(Pcu07,Pcu08),Pcu03||' '||Pcu04||' '||Pcu05||' '||Pcu06)) C02,DECODE(PCU11," & 國外潛在客戶類別 & ",PCU11) C03,NA03 C04,substr(LTrim(PCU38),1,5) C05,PCU39,PCU40 from PotCustomer,NATION WHERE PCU09=NA01(+) AND PCU01='" & Left(Str01, 8) & "' AND PCU02='0' "
                                    stSQL = stSQL & "Union ALL SELECT '01' C00,POC01||POC02||Decode(POC02,'0','','＊') C01,Decode(Sign(Instr('000,001,002,003,004,005,006,007,008,009,013,020',Poc04)),1,Nvl(Poc03,Decode(Poc23,Null,Poc28,Poc23||' '||Poc24||' '||Poc25||' '||Poc26)),Decode(Poc23,Null,Nvl(Poc03,Poc28),Poc23||' '||Poc24||' '||Poc25||' '||Poc26)) C02,'' C03,NA03 C04,POC13 C05,POC14 C06,POC15 C07 from PotCustomer1,NATION WHERE POC04=NA01(+) AND POC01='" & Left(Str01, 8) & "' AND POC02='0' "
                                    intA = 1
                                    Set rsA3 = ClsLawReadRstMsg(intA, stSQL)
                                    If intA = 1 Then
                                        stSQL = "INSERT INTO R100114_1 (ID,FORMID,R11401,R11402,R11403,R11404,R11405,R11406,R11407,R11408,R11409,R11410,R11411) " & _
                                                 "VALUES ('" & pUserNo & "','" & UCase(sFrmName) & "'," & CNULL(Format(intJ + 1, "00")) & "," & CNULL(Str01) & "," & CNULL(PUB_StrToStr(ChgSQL("" & rsA3.Fields("C02")), 180)) & _
                                                 "," & CNULL("" & rsA3.Fields("C03")) & "," & CNULL("" & rsA3.Fields("C04")) & "," & CNULL("" & rsA3.Fields("C05")) & "," & CNULL("" & rsA3.Fields("C06")) & "," & CNULL(PUB_StrToStr(Replace(ChgSQL("" & rsA3.Fields("C07")), vbCrLf, " & "), 200)) & _
                                                 "," & CNULL("" & .Fields("C01")) & "," & CNULL(Str02) & "," & CNULL(Str03) & ")"
                                        cnnConnection.Execute stSQL, intQ
                                        strNoList = strNoList & Str01 & ","
                                    End If
                               Else
                                    '......
                               End If
                               rsA2.MoveNext
                            Loop
                       Else '無關聯企業
                            Str01 = "": Str02 = "": Str03 = ""
                            '若同時勾選多個客戶代號,在第1次迴圈判斷抓基本關係企業是否有重複
                            bolDup = False
                            If bolDel = False And "" & .Fields("C00") = "01" And "" & .Fields("C01") <> "" Then
                                If InStr(strNoList, "" & .Fields("C01")) > 0 Then bolDup = True
                            End If
                            If bolDup = False Then
                                stSQL = "INSERT INTO R100114_1 (ID,FORMID,R11401,R11402,R11403,R11404,R11405,R11406,R11407,R11408,R11409,R11410,R11411) " & _
                                         "VALUES ('" & pUserNo & "','" & UCase(sFrmName) & "'," & CNULL("" & .Fields("C00")) & "," & CNULL("" & .Fields("C01")) & "," & CNULL(PUB_StrToStr(ChgSQL("" & .Fields("C02")), 180)) & _
                                         "," & CNULL("" & .Fields("C03")) & "," & CNULL("" & .Fields("C04")) & "," & CNULL("" & .Fields("C05")) & "," & CNULL("" & .Fields("C06")) & "," & CNULL(PUB_StrToStr(Replace(ChgSQL("" & .Fields("C07")), vbCrLf, " & "), 200)) & _
                                         "," & CNULL(Str01) & "," & CNULL(Str02) & "," & CNULL(Str03) & ")"
                                cnnConnection.Execute stSQL, intQ
                                strNoList = strNoList & Left("" & .Fields("C01"), 9) & ","
                            End If
                       End If
                   Else '潛在客戶 R
                       '重複關聯不顯示
                       If Trim("" & .Fields("U01")) <> "" Then
                          stSQL = "select r11402,r11409 from r100114_1 where ID='" & pUserNo & "' AND FORMID='" & UCase(sFrmName) & "' AND ((r11402='" & .Fields("C01") & "' and r11409='" & .Fields("U01") & "') or (r11402='" & .Fields("U01") & "' and r11409='" & .Fields("C01") & "')) "
                          intA = 1
                          Set rsA2 = ClsLawReadRstMsg(intA, stSQL)
                          If intA = 1 Then GoTo JumpNextRec
                          Str01 = Mid("" & .Fields("U01") & "0", 1, 9)
                          Str02 = IIf(Trim("" & .Fields("U02")) = "", "", PUB_GetFR03desc("" & .Fields("U02")))
                          Str03 = ""
                       Else
                          Str01 = "": Str02 = "": Str03 = ""
                       End If
                       
                       '若同時勾選多個客戶代號,在第1次迴圈判斷抓基本關係企業是否有重複
                       bolDup = False
                       If bolDel = False And "" & .Fields("C00") = "01" And "" & .Fields("C01") <> "" Then
                           If InStr(strNoList, "" & .Fields("C01")) > 0 Then bolDup = True
                       End If
                       If bolDup = False Then
                           stSQL = "INSERT INTO R100114_1 (ID,FORMID,R11401,R11402,R11403,R11404,R11405,R11406,R11407,R11408,R11409,R11410,R11411) " & _
                                    "VALUES ('" & pUserNo & "','" & UCase(sFrmName) & "'," & CNULL("" & .Fields("C00")) & "," & CNULL("" & .Fields("C01")) & "," & CNULL(PUB_StrToStr(ChgSQL("" & .Fields("C02")), 180)) & _
                                    "," & CNULL("" & .Fields("C03")) & "," & CNULL("" & .Fields("C04")) & "," & CNULL("" & .Fields("C05")) & "," & CNULL("" & .Fields("C06")) & "," & CNULL(PUB_StrToStr(Replace(ChgSQL("" & .Fields("C07")), vbCrLf, " & "), 200)) & _
                                    "," & CNULL(Str01) & "," & CNULL(Str02) & "," & CNULL(Str03) & ")"
                           cnnConnection.Execute stSQL, intQ
                           strNoList = strNoList & Left("" & .Fields("C01"), 9) & ","
                       End If
                   End If
JumpNextRec:
                   .MoveNext
                Loop
                cnnConnection.CommitTrans
                bolTrans = False
            End With
            intJ = intJ + 1
            GoTo JumpExp '抓關聯企業
       End If
    End If
    
   '例外處理
    Exit Function
    
ErrHandle:
    If Err.Number <> 0 Then
        MsgBox Err.Description, vbCritical, "關聯企業查詢"
        If bolTrans = True Then
           cnnConnection.RollbackTrans
        End If
    End If
End Function

'Added by Lydia 2016/12/05 傳入關聯代號字串(以逗號區隔),抓對應的代號說明(以;區隔)
Public Function PUB_GetFR03desc(ByVal pFR03 As String) As String
Dim intB As Integer
Dim rsB As New ADODB.Recordset
       
    PUB_GetFR03desc = ""
    If pFR03 = "" Then Exit Function
    strSql = "select instr(" & CNULL(pFR03) & ",ft01) ord, ft02 from ftype where instr(" & CNULL(pFR03) & ",ft01) > 0 order by 1 "
    intB = 1
    Set rsB = ClsLawReadRstMsg(intB, strSql)
    If intB = 1 Then
       rsB.MoveFirst
       Do While Not rsB.EOF
          PUB_GetFR03desc = PUB_GetFR03desc & IIf(PUB_GetFR03desc <> "", ";", "") & rsB(1)
          rsB.MoveNext
       Loop
    End If
End Function

'Added by Lydia 2016/12/06 指定MSHFlexGrid的底色
Public Sub PUB_SetMSFGridColor(ByRef nGRD As MSHFlexGrid, ByVal strColor As String)
'strColor : 0~15為QBcolor ; 其他輸入16進位的數值
Dim intC As Integer
Dim intR As Integer

    If strColor = "" Then Exit Sub
    
    For intR = 1 To nGRD.Rows - 1
        For intC = 0 To nGRD.Cols - 1
            nGRD.row = intR
            nGRD.col = intC
            If Val(strColor) >= 0 And Val(strColor) <= 15 Then
                nGRD.CellBackColor = QBColor(Val(strColor))
            Else
                nGRD.CellBackColor = strColor
            End If
        Next intC
    Next intR
End Sub

'Added by Lydia 2017/01/11 傳入Table和欄位名稱,傳出最大編號
Public Function Pub_GetDefColMaxNo(ByVal gTbl As String, ByVal gCol As String) As String
'gTbl: Table名稱
'gCol: 欄位名稱
Dim inM As Integer
Dim rsM As New ADODB.Recordset
Dim strP As String

   strP = "select nvl(max(" & gCol & "),0)+1 from " & gTbl
   Set rsM = ClsLawReadRstMsg(inM, strP)
   If inM = 1 Then
      Pub_GetDefColMaxNo = rsM(0)
   Else
      Pub_GetDefColMaxNo = "1"
   End If
   
   Set rsM = Nothing
End Function

'Added by Morgan 2017/1/12
'因主機若為NAS,用FileSystemObject檢查資料夾結果會不穩定,改用Dir加上錯誤控制似乎沒問題
Public Function PUB_ChkDir(ByVal pathname As String) As Boolean
On Error GoTo ErrHnd
   
   '若檢查網路分享資料夾沒有指定子資料夾時後面要補 "\",否則會錯
   If Left(pathname, 2) = "\\" And InStr(3, pathname, "\") = InStrRev(pathname, "\") Then pathname = pathname & "\"
   If Dir(pathname, vbDirectory) <> "" Then
      PUB_ChkDir = True
   End If
ErrHnd:
End Function

'Added by Morgan 2017/1/13
'取得非臺灣案催年費區間(催年費和領證發文都會用)
Public Function Get605InformPeriod4NonTwCase(pDate As String, pFMP As Boolean, pFromDate As String, Optional pToDate As String, Optional pFcAgentNo As String, Optional pRaiseError As Boolean = False) As Boolean
   Dim stBaseDate As String
   'Added by Lydia 2025/07/25
   Dim intR As Integer, strR1 As String, intExp As Integer
   Dim rsRD As New ADODB.Recordset
   'end 2025/07/25
   
On Error GoTo ErrHnd
   
   'Added by Lydia 2025/07/25 改用formdate控制
   If pFcAgentNo <> "" Then
      strR1 = "select fd02,fd08 from formdate where fd01='frm040303' AND nvl(fd08,0)<>0 and fd02='" & pFcAgentNo & "' "
      intR = 1
      Set rsRD = ClsLawReadRstMsg(intR, strR1)
      If intR = 1 Then
         intExp = Val("" & rsRD.Fields("fd08"))
      End If
   End If
   'end 2025/07/25
   
   stBaseDate = TransDate(pDate, 2)
   '10號
   If Val(Right(stBaseDate, 2)) <= 10 Or Val(Right(stBaseDate, 2)) > 20 Then
      stBaseDate = Left(stBaseDate, 6) & "10"
      'P:下月16號-該月底
      If Not pFMP Then
         pToDate = CompDate(2, -1, Left(CompDate(1, 2, stBaseDate), 6) & "01")
         pFromDate = Left(pToDate, 6) & "16"
      'FMP:+3月的11-次月20
      Else
         pFromDate = Left(CompDate(1, 3, stBaseDate), 6) & "11"
         pToDate = Left(pFromDate, 6) & "20"
         
         If pFcAgentNo = "Y52323000" Then
            pFromDate = CompDate(1, 1, pFromDate)
            pToDate = CompDate(1, 1, pToDate)
         End If
      End If
      'Added by Lydia 2025/07/25 改用formdate控制
      If cntFrm040303New = "Y" Then
         If pFcAgentNo <> "" And intExp <> 0 Then
             pFromDate = CompDate(1, intExp, Left(stBaseDate, 6) & "01")
             pToDate = Left(pFromDate, 6) & "20"
         End If
      Else
      'end 2025/07/25
         'Added by Lydia 2021/10/18 和碩案件在法限-6個月時就催; ex. P-112859
         If pFcAgentNo = "X70017000" Then
            'Modified by Lydia 2022/02/23 和碩P案年費通知為法限-6個月，直接使用畫面上的執行日期+6個月判斷
            'If Not pFMP Then 'P:下月16號-該月底
            '    pFromDate = CompDate(1, 3, pFromDate)
            '    'Modified by Lydia 2022/02/21 debug: 110/12/6 P-112983被催年費, 應該是在111/2/15催
            '    'pToDate = CompDate(2, -1, CompDate(1, 4, Left(pFromDate, 6) & "01"))
            '    pToDate = CompDate(2, -1, CompDate(1, 1, Left(pFromDate, 6) & "01"))
            'Else
            '    pFromDate = CompDate(1, 3, pFromDate)  '比一般期限提早3個月
            '    pToDate = CompDate(1, 3, pToDate)
            'End If
            pFromDate = CompDate(1, 6, Left(stBaseDate, 6) & "01")
            pToDate = Left(pFromDate, 6) & "20"
            'end 2022/02/23
         End If
         'end 2021/10/18
   
         'Added by Lydia 2022/08/12 信邦案之指定客戶(晚催期限，法定期限前一個月通知)
         If pFcAgentNo = "X39056000" Then
            'Modified by Morgan 2023/7/7 改法限前2個月--文雄
            'pFromDate = CompDate(1, 1, Left(stBaseDate, 6) & "01")
            pFromDate = CompDate(1, 2, Left(stBaseDate, 6) & "01")
            'end 2023/7/7
            pToDate = Left(pFromDate, 6) & "20"
         End If
         'end 2022/08/12
         'Added by Lydia 2022/08/25 大亞(X60601000)法定期限前4個月通知
         If pFcAgentNo = "X60601000" Then
            pFromDate = CompDate(1, 4, Left(stBaseDate, 6) & "01")
            pToDate = Left(pFromDate, 6) & "20"
         End If
         'end 2022/08/25
         'Added by Lydia 2023/11/09 康舒科技(X00497070)年費期限通知由三個月前改為一個月前
         If pFcAgentNo = "X00497070" Then
            pFromDate = CompDate(1, 1, Left(stBaseDate, 6) & "01")
            pToDate = Left(pFromDate, 6) & "20"
         End If
         'end 2023/11/09
   
         'Added by Lydia 2024/04/22 立德電子(X01506000)、江蘇領先(X01506010) 年費期限通知由三個月前改為一個月前
         'Memo by Lydia 2024/05/02 增加新編號:東莞立德(X01506020)
         If pFcAgentNo = "X01506000" Then
            pFromDate = CompDate(1, 1, Left(stBaseDate, 6) & "01")
            pToDate = Left(pFromDate, 6) & "20"
         End If
         'end 2024/04/22
         'Added by Lydia 2024/07/23 X38120000/ X38120030碩天科技/寧遠縣碩寧電子，中國專利年費通知程序，提早期限前兩個月前通知
         If pFcAgentNo = "X38120000" Then
            pFromDate = CompDate(1, 2, Left(stBaseDate, 6) & "01")
            pToDate = Left(pFromDate, 6) & "20"
         End If
         'end 2024/07/23
      End If
      
   '20號
   Else
      stBaseDate = Left(stBaseDate, 6) & "20"
      'P:下下月1號-15號
      If Not pFMP Then
         pFromDate = Left(CompDate(1, 2, stBaseDate), 6) & "01"
         pToDate = Left(pFromDate, 6) & "15"
      Else
      'FMP:+3月的21-次月10
         pFromDate = Left(CompDate(1, 3, stBaseDate), 6) & "21"
         pToDate = Left(CompDate(1, 1, pFromDate), 6) & "10"
         
         If pFcAgentNo = "Y52323000" Then
            pFromDate = CompDate(1, 1, pFromDate)
            pToDate = CompDate(1, 1, pToDate)
         End If
      End If
      'Added by Lydia 2025/07/25 改用formdate控制
      If cntFrm040303New = "Y" Then
         If pFcAgentNo <> "" And intExp <> 0 Then
             pToDate = CompDate(2, -1, Left(CompDate(1, intExp + 1, stBaseDate), 6) & "01")
             pFromDate = Left(pToDate, 6) & "21"
         End If
      Else
      'end 2025/07/25
         'Added by Lydia 2021/10/18 和碩案件在法限-6個月時就催; ex. P-112859
         If pFcAgentNo = "X70017000" Then
            'Modified by Lydia 2022/02/23 和碩P案年費通知為法限-6個月，直接使用執行日期+6個月判斷，不受大陸案催期限影響
            'pFromDate = CompDate(1, 3, pFromDate)  '比一般期限提早3個月
            'pToDate = CompDate(1, 3, pToDate)
            pToDate = CompDate(2, -1, Left(CompDate(1, 7, stBaseDate), 6) & "01")
            pFromDate = Left(pToDate, 6) & "21"
            'end 2022/02/23
         End If
         'end 2021/10/18
   
         'Added by Lydia 2022/08/12 信邦案之指定客戶(晚催期限，法定期限前一個月通知)
         If pFcAgentNo = "X39056000" Then
            'Modified by Morgan 2023/7/7 改法限前2個月--文雄
            'pToDate = CompDate(2, -1, Left(CompDate(1, 2, stBaseDate), 6) & "01")
            pToDate = CompDate(2, -1, Left(CompDate(1, 3, stBaseDate), 6) & "01")
            'end 2023/7/7
            pFromDate = Left(pToDate, 6) & "21"
         End If
         'end 2022/08/12
         'Added by Lydia 2022/08/25 大亞(X60601000)法定期限前4個月通知
         If pFcAgentNo = "X60601000" Then
            pToDate = CompDate(2, -1, Left(CompDate(1, 5, stBaseDate), 6) & "01")
            pFromDate = Left(pToDate, 6) & "21"
         End If
         'end 2022/08/25
         'Added by Lydia 2023/11/09 康舒科技(X00497070)年費期限通知由三個月前改為一個月前
         If pFcAgentNo = "X00497070" Then
            pToDate = CompDate(2, -1, Left(CompDate(1, 2, stBaseDate), 6) & "01")
            pFromDate = Left(pToDate, 6) & "21"
         End If
         'end 2023/11/09
         'Added by Lydia 2024/04/22 立德電子(X01506000)、江蘇領先(X01506010) 年費期限通知由三個月前改為一個月前
         'Memo by Lydia 2024/05/02 增加新編號:東莞立德(X01506020)
         If pFcAgentNo = "X01506000" Then
            pToDate = CompDate(2, -1, Left(CompDate(1, 2, stBaseDate), 6) & "01")
            pFromDate = Left(pToDate, 6) & "21"
         End If
         'end 2024/04/10
         'Added by Lydia 2024/07/23 X38120000/ X38120030碩天科技/寧遠縣碩寧電子，中國專利年費通知程序，提早期限前兩個月前通知
         If pFcAgentNo = "X38120000" Then
            pToDate = CompDate(2, -1, Left(CompDate(1, 3, stBaseDate), 6) & "01")
            pFromDate = Left(pToDate, 6) & "21"
         End If
         'end 2024/07/23
      End If

   End If
   Get605InformPeriod4NonTwCase = True
   Set rsRD = Nothing 'Added by Lydia 2025/07/25
   Exit Function
   
ErrHnd:
   If pRaiseError Then
      Err.Raise Err.Number
   Else
      MsgBox Err.Description, vbCritical
   End If
End Function

'Added by Morgan 2017/2/10
'翻譯費計算
Public Function PUB_GetTransFee(pChineseCount As Long, pJapaneseCount As Long, pMathCount As Long, pEnglishRate As Long, pJapaneseRate As Long, pTypingRate As Long, pSimilarFactor As Long, pDefectFactor As Long, pAdditionFactor As Long, pEnglishCount As Long, pEnglishRate2 As Long) As Long
   Dim lngPay As Long
   '日文翻譯費=日文字數*日文翻譯費率+(中文字數+數學式數)*中文打字費率
   If pJapaneseCount > 0 Then
      '翻譯費,打字費要個別四捨五入
      lngPay = Round(pJapaneseCount * pJapaneseRate / 1000) + Round((pChineseCount + pMathCount) * pTypingRate / 1000)
   
   '英文翻譯費(英文字數計費)=英文字數*英文翻譯費率2*80%
   ElseIf pEnglishCount > 0 Then
      lngPay = Round(pEnglishCount * pEnglishRate2 / 1000 * 0.8)
      
   '英文翻譯費=(中文字數+數學式數)*英文翻譯費率+(中文字數+數學式數)*中文打字費率
   Else
      '翻譯費,打字費要個別四捨五入
      lngPay = Round((pChineseCount + pMathCount) * pEnglishRate / 1000) + Round((pChineseCount + pMathCount) * pTypingRate / 1000)
   End If
   
   '翻譯費=原翻譯費*相似折扣%*瑕疵折扣%*加成比率%
   PUB_GetTransFee = Round(lngPay * IIf(pSimilarFactor = 0, 100, pSimilarFactor) / 100 * IIf(pDefectFactor = 0, 100, pDefectFactor) / 100 * IIf(pAdditionFactor = 0, 100, pAdditionFactor) / 100)
End Function

'Added by Morgan 2019/8/14
'108.8.15 以後完稿案件改以原文字數計算翻譯費並取消中文打字費
Public Function PUB_GetTransFeeNew(pWordCount As Long, pRate As Long, pSimilarFactor As Long, pDefectFactor As Long, pAdditionFactor As Long) As Long
   Dim lngPay As Long
   '原翻譯費=原文字數*翻譯費率
   lngPay = Round(pWordCount * pRate / 1000)
   
   '翻譯費=原翻譯費*相似折扣%*瑕疵折扣%*加成比率%
   PUB_GetTransFeeNew = Round(lngPay * IIf(pSimilarFactor = 0, 100, pSimilarFactor) / 100 * IIf(pDefectFactor = 0, 100, pDefectFactor) / 100 * IIf(pAdditionFactor = 0, 100, pAdditionFactor) / 100)
End Function

'Added by Morgan 2017/3/6
'大陸非發明案主動修正期限
Public Function PUB_GetNon101CN203Date(ByVal pPA10 As String, Optional ByRef pCP06 As String, Optional ByRef pCP07 As String) As Boolean
   Dim stTmpDate As String
   If pPA10 <> "" Then
      'Modified by Morgan 2017/3/6 郭確認改回法限=申請日起兩個月(不必-10天)
      '法限=申請日起兩個月
      '所限=法限-10天(非假日)
      stTmpDate = CompDate(1, 2, pPA10)
      pCP07 = stTmpDate
      
      'Added by Lydia 2025/10/29 改用模組
      'stTmpDate = CompDate(2, -10, pCP07)
      stTmpDate = PUB_GetPOurDeadline(pCP07, 大陸國家代號)
      stTmpDate = PUB_GetWorkDay1(stTmpDate, True)
      pCP06 = stTmpDate
      PUB_GetNon101CN203Date = True
   End If
End Function

'Added by Lydia 2017/06/01 商標案延展期滿的日期(次日=第一天)
'Modified by Lydia 2017/06/08 +期限當天=1,期滿之前X月pMonths
Public Function PUB_Get102DeadLine(ByVal pKind As String, ByVal pCP07 As String, Optional pNow As Integer = 0, Optional pMonths As Integer = 0) As String
'pKind 1:台灣案 2:大陸案 3:T發文控制
'pCP07 法限

    If pCP07 = "" Or pKind = "" Then Exit Function
    
    Select Case pKind
        Case "1" '台灣延展案可辦期限=延展期滿前6個月+1天
            '台灣案延展期滿=(法限+1天)-6個月 ; 先+1天因為有大小月的問題 (每日批次strMenu12,strMenu18)
            'Modified by Lydia 2017/06/08 +期滿之前X月,期限當天(每日批次strMenu86)
            'PUB_Get102DeadLine = "TO_CHAR(ADD_MONTHS((TO_date(" & pCP07 & " ,'YYYYMMDD') + 1) , - 6),'YYYYMMDD')"
            'Modified by Lydia 2017/07/03 台灣延展期滿可辦日要推算到工作天(往後抓) ex.2017/12/31 的可辦日7/1為假日,往後抓7/3
            'Memo by Lydia 2017/07/03 與strMenu86分開
            'PUB_Get102DeadLine = "TO_CHAR(ADD_MONTHS((TO_date(" & pCP07 & " ,'YYYYMMDD') + 1) , - " & 6 + pMonths & ") - " & pNow & ",'YYYYMMDD')"
            PUB_Get102DeadLine = "WORKDAYADD(1, TO_CHAR(ADD_MONTHS((TO_date(" & pCP07 & " ,'YYYYMMDD') + 1) , - 6),'YYYYMMDD'))"
        Case "2"
            '大陸案延展期滿=(法限+1天)-12個月 ; 先+1天因為有大小月的問題 (每日批次strMenu12)
            PUB_Get102DeadLine = "TO_CHAR(ADD_MONTHS((TO_date(" & pCP07 & " ,'YYYYMMDD') + 1) , - 12),'YYYYMMDD')"
        Case "3"
           '台灣案延展案發文:可辦期限=延展期滿前6個月+1天
           'Modified by Lydia 2017/07/03 台灣延展期滿要推算到工作天(往後抓)
            'PUB_Get102DeadLine = CompDate(1, -6, CompDate(2, 1, pCP07))
            PUB_Get102DeadLine = CompWorkDay(1, CompDate(1, -6, CompDate(2, 1, pCP07)))
        'Added by Lydia 2017/07/03 台灣延展案期滿之前X月,期限當天(每日批次strMenu86),不推算到實際可辦日期
        Case "4"
           PUB_Get102DeadLine = "TO_CHAR(ADD_MONTHS((TO_date(" & pCP07 & " ,'YYYYMMDD') + 1) , - " & 6 + pMonths & ") - " & pNow & ",'YYYYMMDD')"
        'Added by Lydia 2019/03/21 台灣延展案期滿之前12月,期限當天(每日批次strMenu95),不推算到實際可辦日期
        Case "5"
           PUB_Get102DeadLine = "TO_CHAR(ADD_MONTHS((TO_date(" & pCP07 & " ,'YYYYMMDD') + 1) , - " & 12 + pMonths & ") - " & pNow & ",'YYYYMMDD')"
    
    End Select
End Function

'Added by Morgan 2015/11/18
'最新發文CF代理人
'Move by Lydia 2017/06/02 從basPublic移過來,原本是Private改Public; + 抓代理人名稱
'Modified by Lydia 2019/01/15 +排除特定收文號pExNo
Public Function PUB_GetCP44(pCP01 As String, pCP02 As String, pCP03 As String, pCP04 As String, ByRef pCP44 As String, ByRef pCP116, Optional ByRef pCP45 As String, Optional ByRef pCP44name As String, Optional ByRef pExNo As String) As Boolean
   Dim stSQL As String, intR As Integer
   Dim rsQuery As ADODB.Recordset
   
   pCP44 = ""
   pCP116 = ""
   pCP45 = ""
   
   '排除香港案技術報告421,因為cp44不見得是真的代理人
   'Modified by Lydia 2017/06/02 抓代理人名稱
   'stSQL = "SELECT  CP44,cp116,CP45 FROM CASEPROGRESS" & _
               " WHERE CP01='" & pCP01 & "' AND CP02='" & pCP02 & "'" & _
               " AND CP03='" & pCP03 & "' AND CP04='" & pCP04 & "'" & _
               " AND CP44 IS NOT NULL AND CP27>0 AND CP09<'C' AND NOT (CP10='421' AND  EXISTS(SELECT * FROM PATENT WHERE PA01=CP01 AND PA02=CP02 AND PA03=CP03 AND PA04=CP04 AND PA09='013'))" & _
               " Order By cp27 desc,cp09 desc "
   'Modified by Lydia 2019/01/15 +pExNo
   'Modified by Morgan 2023/11/13
   'Modified by Morgan 2023/11/13 +排除CFP的IDS(214)或相關收文號為IDS的進度,因IDS會固定給Y20825000且不變更原案件的代理人--郭
   stSQL = "SELECT  CP44,cp116,CP45,NVL(FA04,NVL(FA04,FA06)) FNAME FROM CASEPROGRESS a,FAGENT" & _
               " WHERE CP01='" & pCP01 & "' AND CP02='" & pCP02 & "'" & _
               " AND CP03='" & pCP03 & "' AND CP04='" & pCP04 & "'" & _
               " AND CP44 IS NOT NULL AND CP27>0 AND CP09<'C' AND NOT (CP10='421' AND  EXISTS(SELECT * FROM PATENT WHERE PA01=CP01 AND PA02=CP02 AND PA03=CP03 AND PA04=CP04 AND PA09='013'))" & _
               " AND SUBSTR(CP44,1,8)=FA01(+) AND SUBSTR(CP44,9,1)=FA02(+) " & IIf(pExNo <> "", "AND CP09 NOT IN (" & GetAddStr(pExNo) & ") ", "") & _
               " and not (cp01='CFP' and cp10='214')" & _
               " and not exists(select * from caseprogress b,caseprogress c where b.cp09=a.cp43 and b.cp01='CFP' and c.cp09(+)=b.cp43 and (b.cp10='214' or c.cp10='214'))" & _
               " Order By cp27 desc,cp09 desc "
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      pCP44 = "" & rsQuery.Fields("cp44")
      pCP116 = "" & rsQuery.Fields("CP116")
      pCP45 = "" & rsQuery.Fields("cp45")
      pCP44name = "" & rsQuery.Fields("FNAME") 'Added by Lydia 2017/06/02
      PUB_GetCP44 = True 'Added by Lydia 2017/12/01
   End If
   Set rsQuery = Nothing
End Function

'Added by Lydia 2019/01/31 CFP之EPC准後案:子案年費代理人
'Modified by Lydia 2019/02/26 +pCP09 抓的收文號
Public Function PUB_GetEPCtoCP44(pCP01 As String, pCP02 As String, pCP03 As String, pCP04 As String, ByRef pCP44 As String, ByRef pCP116 As String, Optional ByRef pCP45 As String, Optional ByRef pExNo As String, Optional pCP09 As String) As Boolean
'年費期限在發證日後之年費發文指示信及期限通知管制表之子案代理人抓取順序如下:
'1.前次年費(准後)發文之代理人
'2.指定國註冊之代理人
'3.領證(含指定國註冊費)之代理人
Dim stSQL As String, intR As Integer
Dim rsQuery As ADODB.Recordset
    
    pCP44 = ""
    pCP116 = ""
    pCP45 = ""
    pCP09 = "" 'Added by Lydia 2019/02/26
    
    'Modified by Lydia 2019/02/26 +CP09
   stSQL = "SELECT decode(cp10,'605','1','224','2','601','3','9') ord1, CP44,CP116,CP45,CP09 FROM CASEPROGRESS,FAGENT" & _
               " WHERE CP01='" & pCP01 & "' AND CP02='" & pCP02 & "'" & _
               " AND CP03='" & pCP03 & "' AND CP04='" & pCP04 & "'" & _
               " AND CP44 IS NOT NULL AND CP27>0 AND CP09<'C' AND NOT (CP10='421' AND  EXISTS(SELECT * FROM PATENT WHERE PA01=CP01 AND PA02=CP02 AND PA03=CP03 AND PA04=CP04 AND PA09='013'))" & _
               " AND SUBSTR(CP44,1,8)=FA01(+) AND SUBSTR(CP44,9,1)=FA02(+) " & IIf(pExNo <> "", "AND CP09 NOT IN (" & GetAddStr(pExNo) & ") ", "") & _
               " Order By ord1 asc, cp27 desc,cp09 desc "
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      pCP44 = "" & rsQuery.Fields("cp44")
      pCP116 = "" & rsQuery.Fields("CP116")
      pCP45 = "" & rsQuery.Fields("cp45")
      pCP09 = "" & rsQuery.Fields("CP09") 'Added by Lydia 2019/02/26
      PUB_GetEPCtoCP44 = True
   End If
   Set rsQuery = Nothing
   
End Function

'Added by Morgan 2017/6/5
'電子公文發文號(一文多案時系統會拆成多筆記錄，第2筆之後的發文號=原發文號+流水號)
Public Function PUB_GetEDocNo(pDocNo As String) As String
   PUB_GetEDocNo = Left(pDocNo, 11)
End Function

'Added by Lydia 2017/06/12 控制非國外(F開頭),當客戶在分案或基本檔後補時,檢查收文智權人員和客戶智權人員不同業務區要發mail通知秀玲(參考frm010004~7)
'Modified by Lydia 2021/06/18 +法律所案源收文-介紹人(第一位) pLOS04_n1
'Modified by Lydia 2021/12/24 +分案畫面的智權人員
Public Function PUB_ChkSameCustSales(ByVal pCP01 As String, ByVal pCP02 As String, ByVal pCP03 As String, ByVal pCP04 As String, ByVal nCP09 As String, _
                                           ByVal nCU01 As String, ByVal nCU02 As String, ByVal nCU03 As String, ByVal nCU04 As String, ByVal nCU05 As String, _
                                           ByRef pUser As String, Optional ByVal pLOS04_n1 As String, Optional ByVal pNowCP13 As String) As String
'pCP01~pCP09 本所案號
'pUser 通知人員
'nCU01~nCU05 要存檔的客戶1~5
Dim oStrCu(1 To 5) As String '客戶1~5
Dim oStrCuSales(1 To 5) As String '客戶智權人員1~5
Dim pContext As String
Dim IsMail As Boolean
Dim intCaseKind As Integer
Dim oCaseName As String
Dim intR As Integer
Dim rsAD As New ADODB.Recordset
Dim strA1 As String
Dim nSales As String '案件進度的智權人員
Dim bolCPM04 As Boolean
Dim nSalesDept As String 'Added by Lydia 2021/06/18 案件進度的智權人員部門

PUB_ChkSameCustSales = ""

   If pCP01 <> "" And UCase(Mid(pCP01, 1, 1)) = "F" Then
      Exit Function
   End If
   
   strA1 = Trim(Replace(nCU01 & nCU02 & nCU03 & nCU04 & nCU05, " ", ""))
   If strA1 = "" Then
      Exit Function
   Else
      '申請人1~5為 X65299 或 X03072 的所有關係企業都不檢查業務區
      If InStr(strA1, "X65299") > 0 Or InStr(strA1, "X03072") > 0 Then
         Exit Function
      End If
   End If
   
   bolCPM04 = False
   
   '專利
   strA1 = "SELECT pa26 c01,pa27 c02,pa28 c03,pa29 c04,pa30 c05,nvl(pa05,nvl(pa06,pa07)) c06,pa09 c07 FROM PATENT WHERE pa01='" & pCP01 & "' and pa02='" & pCP02 & "' and pa03='" & pCP03 & "' and pa04='" & pCP04 & "' "
   '商標
   strA1 = strA1 & " union all SELECT tm23 c01,tm78 c02,tm79 c03,tm80 c04,tm81 c05,nvl(tm05,nvl(tm06,tm07)) c06,tm10 c07 FROM TRADEMARK WHERE tm01='" & pCP01 & "' and tm02='" & pCP02 & "' and tm03='" & pCP03 & "' and tm04='" & pCP04 & "' "
   '法務
   strA1 = strA1 & " union all SELECT lc11 c01,lc43 c02,lc44 c03,lc45 c04,lc46 c05,nvl(lc05,nvl(lc06,lc07)) c06,lc15 c07 FROM LAWCASE WHERE lc01='" & pCP01 & "' and lc02='" & pCP02 & "' and lc03='" & pCP03 & "' and lc04='" & pCP04 & "' "
   '顅問
   strA1 = strA1 & " union all SELECT hc05 c01,hc24 c02,hc25 c03,hc26 c04,hc27 c05,hc06 c06,'000' c07 FROM HIRECASE WHERE hc01='" & pCP01 & "' and hc02='" & pCP02 & "' and hc03='" & pCP03 & "' and hc04='" & pCP04 & "' "
   '服務
   strA1 = strA1 & " union all SELECT sp08 c01,sp58 c02,sp59 c03,sp65 c04,sp66 c05,nvl(sp06,nvl(sp06,sp07)) c06,sp09 c07 FROM SERVICEPRACTICE WHERE sp01='" & pCP01 & "' and sp02='" & pCP02 & "' and sp03='" & pCP03 & "' and sp04='" & pCP04 & "' "
   intR = 1
   Set rsAD = ClsLawReadRstMsg(intR, strA1)
   If intR = 0 Then
      Exit Function
   End If
   
   '補客戶代號才發mail
   If Trim("" & rsAD.Fields("c01") & rsAD.Fields("c02") & rsAD.Fields("c03") & rsAD.Fields("c04") & rsAD.Fields("c05")) <> "" Then
      Exit Function
   End If

   If "" & rsAD.Fields("c07") <> "000" Then bolCPM04 = True
   oCaseName = "" & rsAD.Fields("c06")
   
   '案件進度
   If nCP09 = "" Then
      '抓最新的A類收文
      strA1 = "select sqldatet(cp05) cp05,cp09,cp12,cp13,st02,cp14," & IIf(bolCPM04 = True, "cpm04", "cpm03") & " cpm0304 from caseprogress,casepropertymap,staff " & _
              "where cp01='" & pCP01 & "' and cp02='" & pCP02 & "' and cp03='" & pCP03 & "' and cp04='" & pCP04 & "' " & _
              "and cp05||cp09 = (select max(cp05||cp09) from caseprogress where cp01='" & pCP01 & "' and cp02='" & pCP02 & "' and cp03='" & pCP03 & "' and cp04='" & pCP04 & "' and cp09 <'B' and cp159=0) " & _
              "and cp01=cpm01(+) and cp10=cpm02(+) and cp13=st01(+)"
   Else
      strA1 = "select sqldatet(cp05) cp05,cp09,cp12,cp13,st02,cp14," & IIf(bolCPM04 = True, "cpm04", "cpm03") & " cpm0304 from caseprogress,casepropertymap,staff " & _
              "where cp01='" & pCP01 & "' and cp02='" & pCP02 & "' and cp03='" & pCP03 & "' and cp04='" & pCP04 & "' " & _
              "and cp09 ='" & nCP09 & "' and cp01=cpm01(+) and cp10=cpm02(+) and cp13=st01(+)"
   End If
   
   intR = 1
   Set rsAD = ClsLawReadRstMsg(intR, strA1)
   If intR = 0 Then
      Exit Function
   End If
   
   'Added by Lydia 2021/12/24 分案畫面的智權人員; 因為分案要在存檔前才能檢查出要通知的範圍,所以另外傳入畫面的智權人員
   If pNowCP13 <> "" Then
       nSales = pNowCP13
   Else
   'end 2021/12/24
       nSales = Trim("" & rsAD.Fields("cp13"))
   End If  'Added by Lydia 2021/12/24
   If nSales = "" Then Exit Function
   'Added by Lydia 2021/06/18 法律所案源收文-介紹人(第一位)
   If pLOS04_n1 <> "" Then
       nSales = pLOS04_n1
   End If
   nSalesDept = GetST15(nSales)
   'end 2021/06/18
   
   IsMail = True
   oStrCu(1) = ChangeCustomerL(nCU01)
   oStrCu(2) = ChangeCustomerL(nCU02)
   oStrCu(3) = ChangeCustomerL(nCU03)
   oStrCu(4) = ChangeCustomerL(nCU04)
   oStrCu(5) = ChangeCustomerL(nCU05)
   
   pContext = "本所案號： " + pCP01 + "-" + pCP02 + "-" + pCP03 + "-" + pCP04 + vbCrLf + "案件名稱： " + oCaseName + vbCrLf + "收文日： " + Trim("" & rsAD.Fields("cp05")) + vbCrLf + "案件性質： " + Trim("" & rsAD.Fields("cpm0304")) + vbCrLf
   
   For intR = 1 To 5
      If oStrCu(intR) <> "" Then
        'modify by sonia 2021/11/25加傳本所案號ChkSameCuArea，MCT案以FC代理人來判斷
        If ChkSameCuArea(oStrCu(intR), nSales, pCP01, pCP02, pCP03, pCP04) = False Then
           'Modified by Lydia 2021/06/18
           'If Left(Trim("" & rsAD.Fields("cp12")), 1) = "F" And Left(Trim(GetCuSales(oStrCu(intR), oStrCuSales(intR))), 1) = "F" Then
           If Left(Trim(nSalesDept), 1) = "F" And Left(Trim(GetCuSales(oStrCu(intR), oStrCuSales(intR))), 1) = "F" Then
              '若收文智權人員之ST15為F字頭並且客戶智權人員之ST15也為F字頭則不發Mail
           Else
              pUser = pUser & oStrCuSales(intR) & ";"
              pContext = pContext & vbCrLf + "申請人" & intR & "： " + GetCustomerName(oStrCu(intR)) + vbCrLf + "原智權人員： " + GetPrjSalesNM(oStrCuSales(intR))
           End If
        '其中一個符合就不發了
        Else
             IsMail = False
        End If
      End If
   Next intR
   
   If IsMail = True Then
      If nCP09 <> "" Then MsgBox "收文智權人員與客戶智權人員不同業務區，準備發 mail ！", , "注意！"
      '通知所有相關智權人員和電腦中心人員
      pUser = pUser & nSales & ";" & Pub_GetSpecMan("程式管理人員")
      'Added by Lydia 2021/12/24
      If pNowCP13 <> "" Then
          pContext = pContext & vbCrLf + "收文智權人員： " + GetStaffName(pNowCP13, True) + vbCrLf + vbCrLf + "智權人員(區)不同！"
      Else
      'end 2021/12/24
          pContext = pContext & vbCrLf + "收文智權人員： " + Trim("" & rsAD.Fields("st02")) + vbCrLf + vbCrLf + "智權人員(區)不同！"
      End If
      PUB_ChkSameCustSales = pContext
      '延到存檔後,判斷有值才發
   Else
       pUser = ""
   End If
   
   Set rsAD = Nothing
   
End Function

'Added by Lydia 2017/08/09  傳入有副檔名的檔名,傳出檔名=西元年月日.時分秒.副檔名
Public Function PUB_GetNewFileNameSec(ByVal pOldName As String, Optional ByVal pListType As String = "1", Optional ByRef pChkList As String, Optional ByVal pKey As String = "") As String
'pListType 串接檔名的排列方式 (1.堆疊法:從最前方新增檔案,如ListBox ; 2.排序:逐筆放在最後面)
Dim strNewName As String
Dim inP As Integer, inA As Integer
Dim strA1 As String, strA2 As String
Dim sTime As String
Dim IntF As Integer '取得名稱的長度

    PUB_GetNewFileNameSec = ""
    
    If pOldName = "" Then Exit Function
    strNewName = pOldName
    sTime = Val(Format(ServerTime, "000000"))
    IntF = Len(sTime) + 9
    strNewName = strSrvDate(1) & "." & sTime & Mid(strNewName, InStrRev(strNewName, "."))
        
    '檢查是否有重複
    If pChkList <> "" Then
       strA2 = Mid(strNewName, 1, IntF)
       If pListType = "1" Then '堆疊
          inP = InStr(pChkList, strA2)
       Else
          inP = InStrRev(pChkList, strA2)
       End If
       inA = 1
       Do While inP > 0
          '抓第一個找到檔名
          If pListType = "1" Then '堆疊
             strA1 = Mid(pChkList, inP, IntF + InStr(Mid(pChkList, inP + IntF), ","))
          Else
             strA1 = Mid(pChkList, inP)
          End If
          '已有.x.副檔名
          If InStrRev(strA1, ".") > 10 And Len(strA1) <> InStrRev(strA1, ".") Then
             inA = Val(Mid(strA1, IntF + 2, InStrRev(strA1, ".") - (IntF + 1))) + 1
          End If
          
          strNewName = Mid(strA1, 1, IntF) & "." & inA & Mid(strNewName, InStrRev(strNewName, "."))
          inA = inA + 1
          inP = InStr(pChkList, strNewName)
       Loop
    End If
    
    If pKey <> "" Then
       strNewName = pKey & "_" & strNewName
    End If
    
    If pListType = "1" Then '堆疊
       pChkList = strNewName & IIf(pChkList <> "", ",", "") & pChkList
    Else
       pChkList = pChkList & IIf(pChkList <> "", ",", "") & strNewName
    End If
    PUB_GetNewFileNameSec = strNewName
End Function

'Add By Sindy 2017/10/23 下載信件檔,上傳卷宗區
'strPI01:轉入日期
'strPI03:流水號
'strCP09:歸檔的總收文號
'strTyp:副檔名 如:P收達==>.ACK.msg
'Modify By Sindy 2019/7/24 + , Optional ByRef strFullFileName As String = "" : 取得實體檔完整檔案路徑
'                            , Optional ByVal bolOnlyGetFile As Boolean = False : 只純下載實體檔
'Modify By Sindy 2020/2/14 + , Optional ByRef stReName As String : 回傳儲存的CPP02檔案名稱,方便後續更新資料使用
'Modify By Sindy 2023/8/24 + , Optional ByRef bolChkFileisExistsCPP As Boolean = False : 電子檔是否已存在
'Modify by Amy 2025/05/14 +strFormN
Public Function PUB_UploadPatentLetterFile(strPI01 As String, strPI03 As String, strCP09 As String, _
   Optional strTyp As String = "", Optional ByRef strFullFileName As String = "", _
   Optional ByVal bolOnlyGetFile As Boolean = False, Optional ByRef stReName As String, _
   Optional ByRef bolChkFileisExistsCPP As Boolean = False, Optional ByVal strFormN As String = "") As Boolean
Dim strCP01 As String, strCP02 As String, strCP03 As String, strCP04 As String
Dim strCP10 As String
Dim strPI14 As String, strPI17 As String
Dim strFileName As String
Dim fs, f
Dim stModifyDateTime As String, strPI02 As String 'Add by Sindy 2025/7/21
   
   '讀取信件檔
   If Left(strPI03, 1) = "P" Then
      'Modify by Sindy 2025/7/21 +,pi02
      strExc(0) = "select pi14,pi17,pi02 from patentinput" & _
                  " where PI01=" & strPI01 & " and PI03='" & strPI03 & "' and pi14 is not null"
   ElseIf Left(strPI03, 1) = "T" Then
      'Modify by Sindy 2025/7/21 +,Ti02
      strExc(0) = "select Ti14,Ti17,Ti02 from TMinput" & _
                  " where TI01=" & strPI01 & " and TI03='" & strPI03 & "' and Ti14 is not null"
   'Add By Sindy 2022/6/15
   Else
      'Modify by Sindy 2025/7/21 +,ii02
      strExc(0) = "select ii14,ii17,ii02 from IPDEPTinput" & _
                  " where iI01=" & strPI01 & " and iI03='" & strPI03 & "' and ii14 is not null"
      '2022/6/15 END
   End If
   intI = 1
   Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
   If intI = 1 Then
      strPI14 = RsTemp.Fields(0)
      strFileName = Mid(strPI14, InStrRev(strPI14, "/") + 1)
      strPI17 = "" & RsTemp.Fields(1) 'Modify By Sindy 2019/12/4 會有無主旨狀況
      strPI02 = RsTemp.Fields(2) 'Add by Sindy 2025/7/21
   Else
      MsgBox "無檔案可上傳！", vbExclamation, "警告！"
      Exit Function
   End If
   
   'Modify by Amy 2025/05/14 +if,檔案直接存到結案單資料夾中
   If UCase(strFormN) = "FRM210133_F" And strFullFileName <> "" Then
      If Right(UCase(strFileName), 4) = ".MSG" Then
         strFullFileName = Replace(strFullFileName, strFileName, "")
         stReName = Replace(strFileName, ".msg", ".rx.msg")
      End If
      strFullFileName = strFullFileName & stReName
   Else
      strFullFileName = App.path & "\" & strUserNum & "\" & strFileName
      stReName = IIf(strTyp <> "", Replace(strFileName, ".msg", "." & strTyp & ".msg"), Replace(strFileName, ".msg", ".rx.msg"))
   End If
   'end 2025/05/14
   
   '檢查電子檔是否存在,不存在,則下載電子檔
   If PUB_ChkDir(strFullFileName) = False Then
      'Modify by Sindy 2025/7/21 +更新檔案修改時間
      stModifyDateTime = strPI01 & Format("" & strPI02, "000000")
      If Left(strPI03, 1) = "P" Then
         If PUB_GetFtpFile(strPI14, strFullFileName, "PATENTINPUT", , , , , stModifyDateTime) = False Then Exit Function
      ElseIf Left(strPI03, 1) = "T" Then
         If PUB_GetFtpFile(strPI14, strFullFileName, "TMINPUT", , , , , stModifyDateTime) = False Then Exit Function
      'Add By Sindy 2022/6/15
      Else
         If PUB_GetFtpFile(strPI14, strFullFileName, "IPDEPTINPUT", , , , , stModifyDateTime) = False Then Exit Function
         '2022/6/15 END
      End If
      '2025/7/21 END
   'Add By Sindy 2024/4/18
   ElseIf bolOnlyGetFile = False Then
      If PUB_ChkFileOpening2(strFullFileName, "後續才能一併歸卷！") = True Then
         Exit Function
      End If
      '2024/4/18 END
   End If
   'Add By Sindy 2019/7/24
   If bolOnlyGetFile = True Then
      PUB_UploadPatentLetterFile = True
      Exit Function
   End If
   '2019/7/24 END
   
   Set fs = CreateObject("Scripting.FileSystemObject")
   Set f = fs.GetFile(strFullFileName)
   '讀取案件檔
   strExc(0) = "select cp01,cp02,cp03,cp04,cp10 from Caseprogress" & _
               " where cp09='" & strCP09 & "'"
   intI = 1
   Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
   If intI = 1 Then
      strCP01 = RsTemp.Fields("cp01")
      strCP02 = RsTemp.Fields("cp02")
      strCP03 = RsTemp.Fields("cp03")
      strCP04 = RsTemp.Fields("cp04")
      strCP10 = RsTemp.Fields("cp10")
   Else
      MsgBox "無此總收文號(" & strCP09 & ")！", vbExclamation, "警告！"
      Exit Function
   End If
   'Modify By Sindy 2022/5/6 Val(Trim(strCP02)) ==> Trim(strCP02)
   stReName = Trim(strCP01) & Trim(strCP02) & _
               IIf(Val(Trim(strCP03)) = 0 And Val(Trim(strCP04)) = 0, "", "-" & strCP03) & _
               IIf(Val(Trim(strCP04)) = 0, "", "-" & Format(strCP04, "00")) & "." & strCP10 & "." & stReName
   'Add By Sindy 2022/8/18
   '檢查卷宗區是否已有此信件,若有,無需重覆歸卷
   strExc(0) = "select count(*) from casepaperpdf" & _
               " where instr(cpp02,'" & stReName & "')>0" & _
                 " and cpp01='" & strCP09 & "'"
   intI = 1
   strExc(10) = ""
   Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
   If intI = 1 Then
      If RsTemp.Fields(0) > 0 Then
         strExc(10) = "Y"
      End If
   End If
   If strExc(10) = "" Then
   '2022/8/18 END
      '歸卷
      If SaveAttFile_PDF(strCP09, strFullFileName, stReName, Format(f.DateLastModified, "YYYYMMDD"), Format(f.DateLastModified, "HHMMSS"), True, IIf(Left(strPI03, 1) = "P", "P", IIf(Left(strPI03, 1) = "T", "T", "F")), "Y", , , , ChgSQL(strPI17)) = False Then
         'MsgBox "下載檔案失敗，無法歸檔！", vbExclamation, "警告！"
         Exit Function
      End If
   Else
      bolChkFileisExistsCPP = True 'Add By Sindy 2023/8/24 欲歸的信件早已歸卷
   End If
   
   PUB_UploadPatentLetterFile = True
End Function

'Added by Lydia 2017/11/07 內商查名單電子化：計算期限日期
'Modified by Lydia 2018/05/25 +內商查名單分單狀態
Public Function PUB_GetNewTmq06(ByVal iTyp As Integer, ByVal iClass As String, ByVal IDate As String, ByVal iTime As String, Optional ByVal iAllStatus As String = "") As String
Dim Inputtm As String, InputWDay As String, tmpWorkday As Integer
Dim tmpClass As String, tmpQC02  As String
Dim bWorkday As Boolean 'Added by Lydia 2018/04/23 判斷是否為工作天
Dim tmpDays As Integer 'Added by Lydia 2023/07/07

    '預設工作天
    If iTyp = 1 Then
       tmpWorkday = 2 '文字
    Else
       tmpWorkday = 3 '圖形
       '本數決定工作天數
       tmpClass = PUB_GetTMQClass(2, 0, 0, 1, iClass, , tmpQC02)
       If Val(tmpQC02) >= 14 Then tmpWorkday = 4
    End If
    'Added by Lydia 2022/07/05 因為查名中心人員請假過半，為了公平採用全部人員都分發查名單，但是期限+2天
    'Modified by Lydia 2023/07/06 因7月7日(Fri.)及10日(Mon.)有多數查名同仁請假半，為了公平採用全部人員都分發查名單，但是期限+2天
    'If strSrvDate(1) >= "20220707" And strSrvDate(1) <= "20220711" Then
    'Modified by Lydia 2023/07/07 (7/7發現漏掉,改成模組)
    'If strSrvDate(1) >= "20230707" And strSrvDate(1) <= "20230710" Then
    '    tmpWorkday = tmpWorkday + 2
    If Pub_GetTmqAllDate(strSrvDate(1), tmpDays) = True Then
         tmpWorkday = tmpWorkday + tmpDays
    'end 2023/07/07
    End If
    'end 2022/07/05
    
    'Added by Lydia 2018/04/23 判斷是否為工作天
    If ChkWorkDay(IDate) = True Then
         bWorkday = True
    Else
         bWorkday = False
    End If
    'end 2018/04/23
    
    '大於13:30,期限+1天
    'Modified by Lydia 2018/04/23 在非上班日的下午申請查名單,期限不用+1天(=次日早上)
    'If Val(iTime) > 1330 Then
    'Modified by Lydia 2018/05/25 +狀態
    'If Val(iTime) > 1330 And bWorkday = True Then
    If (UCase(iAllStatus) = "N" Or Val(iTime) > 1330) And bWorkday = True Then
       PUB_GetNewTmq06 = CompWorkDay(tmpWorkday + 1, IDate, 0)
    Else
       PUB_GetNewTmq06 = CompWorkDay(tmpWorkday, IDate, 0)
    End If
End Function


'Add By Sindy 2018/5/9 FCP案母案資料複製到子案
'pa():分割案
'strDivCaseNo():母案
Public Sub PUB_FCPCopyDataToCase(pa() As String, strDivCaseNo() As String)
Dim rsB As New ADODB.Recordset
Dim StrSqlB As String
Dim strPA05 As String, strPA06 As String, strPA07 As String
'Add By Sindy 2017/3/3
Dim strPA79 As String, strPA80 As String, strPA81 As String
Dim strPA82 As String, strPA83 As String, strPA84 As String
Dim strPA109 As String, strPA110 As String, strPA111 As String
Dim strPA112 As String, strPA113 As String, strPA114 As String
Dim strPA115 As String, strPA116 As String, strPA117 As String
Dim strPA118 As String, strPA119 As String, strPA120 As String
Dim strPA121 As String, strPA122 As String, strPA123 As String
Dim strPA124 As String, strPA125 As String, strPA126 As String
Dim strPA127 As String, strPA128 As String, strPA129 As String
Dim strPA130 As String, strPA131 As String, strPA132 As String
'2017/3/3 END
Dim strPA158 As String 'Added by Lydia 2019/0/4/03
Dim strPA150 As String 'Added by Lydia 2019/07/30

   '將母案的優先權資料新增到分割案
   strSql = "INSERT INTO PRIDATE A (PD01,PD02,PD03,PD04,PD05,PD06,PD07,PD08,PD09)" & _
      " select '" & pa(1) & "','" & pa(2) & "','" & pa(3) & "','" & pa(4) & "',B.PD05,B.PD06,B.PD07,PD08,PD09 from pridate B" & _
      " where B.pd01='" & strDivCaseNo(1) & "' and B.pd02='" & strDivCaseNo(2) & "' and B.pd03='" & strDivCaseNo(3) & "' and B.pd04='" & strDivCaseNo(4) & "'" & _
      " AND NOT EXISTS(SELECT * FROM PRIDATE C WHERE C.pd01='" & pa(1) & "' and C.pd02='" & pa(2) & "' and C.pd03='" & pa(3) & "' and C.pd04='" & pa(4) & "' and c.pd06=B.pd06 and c.pd07=B.pd07)"
   cnnConnection.Execute strSql
   
   '將母案的發明人資料新增到分割案
   strSql = "INSERT INTO PatentInventor A (PI01,PI02,PI03,PI04,PI05,PI06)" & _
      " select '" & pa(1) & "','" & pa(2) & "','" & pa(3) & "','" & pa(4) & "',B.PI05,B.PI06 from PatentInventor B" & _
      " where B.PI01='" & strDivCaseNo(1) & "' and B.PI02='" & strDivCaseNo(2) & "' and B.PI03='" & strDivCaseNo(3) & "' and B.PI04='" & strDivCaseNo(4) & "'" & _
      " AND NOT EXISTS(SELECT * FROM PatentInventor C WHERE C.PI01='" & pa(1) & "' and C.PI02='" & pa(2) & "' and C.PI03='" & pa(3) & "' and C.PI04='" & pa(4) & "' and c.PI05=B.PI05)"
   Pub_SeekTbLog strSql 'Add By Sindy 2017/8/23
   cnnConnection.Execute strSql
   
   '將母案的代表人資料,案件名稱,個案地址複製到分割案
   If rsB.State <> adStateClosed Then rsB.Close
   '讀取母案的代表人資料,案件名稱,個案地址
   StrSqlB = " select * from Patent" & _
      " where PA01='" & strDivCaseNo(1) & "' and PA02='" & strDivCaseNo(2) & "' and PA03='" & strDivCaseNo(3) & "' and PA04='" & strDivCaseNo(4) & "'"
   rsB.CursorLocation = adUseClient
   rsB.Open StrSqlB, cnnConnection, adOpenStatic, adLockReadOnly
   If rsB.RecordCount > 0 Then
      '讀取案件名稱
      strPA05 = "" & rsB.Fields("pa05")
      strPA06 = "" & rsB.Fields("pa06")
      strPA07 = "" & rsB.Fields("pa07")
      '讀取代表人資料
      strPA79 = "" & rsB.Fields("pa79")
      strPA80 = "" & rsB.Fields("pa80")
      strPA81 = "" & rsB.Fields("pa81")
      strPA82 = "" & rsB.Fields("pa82")
      strPA83 = "" & rsB.Fields("pa83")
      strPA84 = "" & rsB.Fields("pa84")
      strPA109 = "" & rsB.Fields("pa109")
      strPA110 = "" & rsB.Fields("pa110")
      strPA111 = "" & rsB.Fields("pa111")
      strPA112 = "" & rsB.Fields("pa112")
      strPA113 = "" & rsB.Fields("pa113")
      strPA114 = "" & rsB.Fields("pa114")
      strPA115 = "" & rsB.Fields("pa115")
      strPA116 = "" & rsB.Fields("pa116")
      strPA117 = "" & rsB.Fields("pa117")
      strPA118 = "" & rsB.Fields("pa118")
      strPA119 = "" & rsB.Fields("pa119")
      strPA120 = "" & rsB.Fields("pa120")
      strPA121 = "" & rsB.Fields("pa121")
      strPA122 = "" & rsB.Fields("pa122")
      strPA123 = "" & rsB.Fields("pa123")
      strPA124 = "" & rsB.Fields("pa124")
      strPA125 = "" & rsB.Fields("pa125")
      strPA126 = "" & rsB.Fields("pa126")
      strPA127 = "" & rsB.Fields("pa127")
      strPA128 = "" & rsB.Fields("pa128")
      strPA129 = "" & rsB.Fields("pa129")
      strPA130 = "" & rsB.Fields("pa130")
      strPA131 = "" & rsB.Fields("pa131")
      strPA132 = "" & rsB.Fields("pa132")
      strPA150 = "" & rsB.Fields("pa150") 'Added by Lydia 2019/07/30 工程師組別
      strPA158 = "" & rsB.Fields("pa158") 'Added by Lydia 2019/04/03 設計案屬性
      
      '更新資料:
      strSql = ""
      '案件名稱
'      If strPA05 <> "" And pa(5) = "" Then strSql = strSql & ",pa05='" & ChgSQL(strPA05) & "'"
'      If strPA06 <> "" And pa(6) = "" Then strSql = strSql & ",pa06='" & ChgSQL(strPA06) & "'"
'      If strPA07 <> "" And pa(7) = "" Then strSql = strSql & ",pa07='" & ChgSQL(strPA07) & "'"
      strSql = strSql & ",pa05=" & CNULL(ChgSQL(strPA05))
      strSql = strSql & ",pa06=" & CNULL(ChgSQL(strPA06))
      strSql = strSql & ",pa07=" & CNULL(ChgSQL(strPA07))
      '代表人資料
      If strPA79 <> "" And pa(79) = "" Then strSql = strSql & ",pa79='" & ChgSQL(strPA79) & "'"
      If strPA80 <> "" And pa(80) = "" Then strSql = strSql & ",pa80='" & ChgSQL(strPA80) & "'"
      If strPA81 <> "" And pa(81) = "" Then strSql = strSql & ",pa81='" & ChgSQL(strPA81) & "'"
      If strPA82 <> "" And pa(82) = "" Then strSql = strSql & ",pa82='" & ChgSQL(strPA82) & "'"
      If strPA83 <> "" And pa(83) = "" Then strSql = strSql & ",pa83='" & ChgSQL(strPA83) & "'"
      If strPA84 <> "" And pa(84) = "" Then strSql = strSql & ",pa84='" & ChgSQL(strPA84) & "'"
      If strPA109 <> "" And pa(109) = "" Then strSql = strSql & ",pa109='" & ChgSQL(strPA109) & "'"
      If strPA110 <> "" And pa(110) = "" Then strSql = strSql & ",pa110='" & ChgSQL(strPA110) & "'"
      If strPA111 <> "" And pa(111) = "" Then strSql = strSql & ",pa111='" & ChgSQL(strPA111) & "'"
      If strPA112 <> "" And pa(112) = "" Then strSql = strSql & ",pa112='" & ChgSQL(strPA112) & "'"
      If strPA113 <> "" And pa(113) = "" Then strSql = strSql & ",pa113='" & ChgSQL(strPA113) & "'"
      If strPA114 <> "" And pa(114) = "" Then strSql = strSql & ",pa114='" & ChgSQL(strPA114) & "'"
      If strPA115 <> "" And pa(115) = "" Then strSql = strSql & ",pa115='" & ChgSQL(strPA115) & "'"
      If strPA116 <> "" And pa(116) = "" Then strSql = strSql & ",pa116='" & ChgSQL(strPA116) & "'"
      If strPA117 <> "" And pa(117) = "" Then strSql = strSql & ",pa117='" & ChgSQL(strPA117) & "'"
      If strPA118 <> "" And pa(118) = "" Then strSql = strSql & ",pa118='" & ChgSQL(strPA118) & "'"
      If strPA119 <> "" And pa(119) = "" Then strSql = strSql & ",pa119='" & ChgSQL(strPA119) & "'"
      If strPA120 <> "" And pa(120) = "" Then strSql = strSql & ",pa120='" & ChgSQL(strPA120) & "'"
      If strPA121 <> "" And pa(121) = "" Then strSql = strSql & ",pa121='" & ChgSQL(strPA121) & "'"
      If strPA122 <> "" And pa(122) = "" Then strSql = strSql & ",pa122='" & ChgSQL(strPA122) & "'"
      If strPA123 <> "" And pa(123) = "" Then strSql = strSql & ",pa123='" & ChgSQL(strPA123) & "'"
      If strPA124 <> "" And pa(124) = "" Then strSql = strSql & ",pa124='" & ChgSQL(strPA124) & "'"
      If strPA125 <> "" And pa(125) = "" Then strSql = strSql & ",pa125='" & ChgSQL(strPA125) & "'"
      If strPA126 <> "" And pa(126) = "" Then strSql = strSql & ",pa126='" & ChgSQL(strPA126) & "'"
      If strPA127 <> "" And pa(127) = "" Then strSql = strSql & ",pa127='" & ChgSQL(strPA127) & "'"
      If strPA128 <> "" And pa(128) = "" Then strSql = strSql & ",pa128='" & ChgSQL(strPA128) & "'"
      If strPA129 <> "" And pa(129) = "" Then strSql = strSql & ",pa129='" & ChgSQL(strPA129) & "'"
      If strPA130 <> "" And pa(130) = "" Then strSql = strSql & ",pa130='" & ChgSQL(strPA130) & "'"
      If strPA131 <> "" And pa(131) = "" Then strSql = strSql & ",pa131='" & ChgSQL(strPA131) & "'"
      If strPA132 <> "" And pa(132) = "" Then strSql = strSql & ",pa132='" & ChgSQL(strPA132) & "'"
      If strPA150 <> "" And pa(150) = "" Then strSql = strSql & ",pa150='" & ChgSQL(strPA150) & "'"  'Added by Lydia 2019/07/30 工程師組別
      If strPA158 <> "" And pa(158) = "" Then strSql = strSql & ",pa158='" & ChgSQL(strPA158) & "'" 'Added by Lydia 2019/04/03 將設計母案的設計案屬性回寫到子案
      
      If strSql <> "" Then
         strSql = Mid(strSql, 2)
         strSql = "update patent set " & strSql & " where pa01='" & pa(1) & "' and pa02='" & pa(2) & "' and pa03='" & pa(3) & "' and pa04='" & pa(4) & "'"
         cnnConnection.Execute strSql
      End If
      
      'Add By Sindy 2018/4/19
      '個案地址
      strExc(9) = ""
      '申請人1
      If "" & rsB.Fields("pa26") <> ChangeCustomerL(pa(26)) Then
         If strExc(9) <> "" Then strExc(9) = strExc(9) & vbCrLf
         strExc(9) = strExc(9) & "母案申請人1(" & "" & rsB.Fields("pa26") & ")與子案申請人1(" & ChangeCustomerL(pa(26)) & ")不同"
      Else
         If pa(26) <> "" Then
            'Modified by Morgan 2021/9/27 分割及衍生設計申請地址改抓申請人--何淑華
            'strSql = "update patent set pa31=" & CNULL(ChgSQL("" & rsB.Fields("pa31"))) & _
                                      ",pa36=" & CNULL(ChgSQL("" & rsB.Fields("pa36"))) & _
                                      ",pa41=" & CNULL(ChgSQL("" & rsB.Fields("pa41"))) & _
                     " where pa01='" & pa(1) & "' and pa02='" & pa(2) & "' and pa03='" & pa(3) & "' and pa04='" & pa(4) & "'"
            strSql = "update patent set (pa31,pa36,pa41)=(select cu23,rtrim(cu24||' '||cu25||' '||cu26||' '||cu27||' '||cu28||' '||cu102),cu29" & _
                     " from customer where cu01=substr(pa26,1,8) and cu02=substr(pa26,9))" & _
                     " where pa01='" & pa(1) & "' and pa02='" & pa(2) & "' and pa03='" & pa(3) & "' and pa04='" & pa(4) & "'"
            'end 2021/9/27
            cnnConnection.Execute strSql
         End If
      End If
      '申請人2
      If "" & rsB.Fields("pa27") <> ChangeCustomerL(pa(27)) Then
         If strExc(9) <> "" Then strExc(9) = strExc(9) & vbCrLf
         strExc(9) = strExc(9) & "母案申請人2(" & "" & rsB.Fields("pa27") & ")與子案申請人2(" & ChangeCustomerL(pa(27)) & ")不同"
      Else
         If pa(27) <> "" Then
            'Modified by Morgan 2021/9/27 分割及衍生設計申請地址改抓申請人--何淑華
            'strSql = "update patent set pa32=" & CNULL(ChgSQL("" & rsB.Fields("pa32"))) & _
                                      ",pa37=" & CNULL(ChgSQL("" & rsB.Fields("pa37"))) & _
                                      ",pa42=" & CNULL(ChgSQL("" & rsB.Fields("pa42"))) & _
                     " where pa01='" & pa(1) & "' and pa02='" & pa(2) & "' and pa03='" & pa(3) & "' and pa04='" & pa(4) & "'"
            strSql = "update patent set (pa32,pa37,pa42)=(select cu23,rtrim(cu24||' '||cu25||' '||cu26||' '||cu27||' '||cu28||' '||cu102),cu29" & _
                     " from customer where cu01=substr(pa27,1,8) and cu02=substr(pa27,9))" & _
                     " where pa01='" & pa(1) & "' and pa02='" & pa(2) & "' and pa03='" & pa(3) & "' and pa04='" & pa(4) & "'"
            'end 2021/9/27
            cnnConnection.Execute strSql
         End If
      End If
      '申請人3
      If "" & rsB.Fields("pa28") <> ChangeCustomerL(pa(28)) Then
         If strExc(9) <> "" Then strExc(9) = strExc(9) & vbCrLf
         strExc(9) = strExc(9) & "母案申請人3(" & "" & rsB.Fields("pa28") & ")與子案申請人3(" & ChangeCustomerL(pa(28)) & ")不同"
      Else
         If pa(28) <> "" Then
            'Modified by Morgan 2021/9/27 分割及衍生設計申請地址改抓申請人--何淑華
            'strSql = "update patent set pa33=" & CNULL(ChgSQL("" & rsB.Fields("pa33"))) & _
                                      ",pa38=" & CNULL(ChgSQL("" & rsB.Fields("pa38"))) & _
                                      ",pa43=" & CNULL(ChgSQL("" & rsB.Fields("pa43"))) & _
                     " where pa01='" & pa(1) & "' and pa02='" & pa(2) & "' and pa03='" & pa(3) & "' and pa04='" & pa(4) & "'"
            strSql = "update patent set (pa33,pa38,pa43)=(select cu23,rtrim(cu24||' '||cu25||' '||cu26||' '||cu27||' '||cu28||' '||cu102),cu29" & _
                     " from customer where cu01=substr(pa28,1,8) and cu02=substr(pa28,9))" & _
                     " where pa01='" & pa(1) & "' and pa02='" & pa(2) & "' and pa03='" & pa(3) & "' and pa04='" & pa(4) & "'"
            'end 2021/9/27
            cnnConnection.Execute strSql
         End If
      End If
      '申請人4
      If "" & rsB.Fields("pa29") <> ChangeCustomerL(pa(29)) Then
         If strExc(9) <> "" Then strExc(9) = strExc(9) & vbCrLf
         strExc(9) = strExc(9) & "母案申請人4(" & "" & rsB.Fields("pa29") & ")與子案申請人4(" & ChangeCustomerL(pa(29)) & ")不同"
      Else
         If pa(29) <> "" Then
            'Modified by Morgan 2021/9/27 分割及衍生設計申請地址改抓申請人--何淑華
            'strSql = "update patent set pa34=" & CNULL(ChgSQL("" & rsB.Fields("pa34"))) & _
                                      ",pa39=" & CNULL(ChgSQL("" & rsB.Fields("pa39"))) & _
                                      ",pa44=" & CNULL(ChgSQL("" & rsB.Fields("pa44"))) & _
                     " where pa01='" & pa(1) & "' and pa02='" & pa(2) & "' and pa03='" & pa(3) & "' and pa04='" & pa(4) & "'"
            strSql = "update patent set (pa34,pa39,pa44)=(select cu23,rtrim(cu24||' '||cu25||' '||cu26||' '||cu27||' '||cu28||' '||cu102),cu29" & _
                     " from customer where cu01=substr(pa29,1,8) and cu02=substr(pa29,9))" & _
                     " where pa01='" & pa(1) & "' and pa02='" & pa(2) & "' and pa03='" & pa(3) & "' and pa04='" & pa(4) & "'"
            'end 2021/9/27
            cnnConnection.Execute strSql
         End If
      End If
      '申請人5
      If "" & rsB.Fields("pa30") <> ChangeCustomerL(pa(30)) Then
         If strExc(9) <> "" Then strExc(9) = strExc(9) & vbCrLf
         strExc(9) = strExc(9) & "母案申請人5(" & "" & rsB.Fields("pa30") & ")與子案申請人5(" & ChangeCustomerL(pa(30)) & ")不同"
      Else
         If pa(30) <> "" Then
            'Modified by Morgan 2021/9/27 分割及衍生設計申請地址改抓申請人--何淑華
            'strSql = "update patent set pa35=" & CNULL(ChgSQL("" & rsB.Fields("pa35"))) & _
                                      ",pa40=" & CNULL(ChgSQL("" & rsB.Fields("pa40"))) & _
                                      ",pa45=" & CNULL(ChgSQL("" & rsB.Fields("pa45"))) & _
                     " where pa01='" & pa(1) & "' and pa02='" & pa(2) & "' and pa03='" & pa(3) & "' and pa04='" & pa(4) & "'"
            strSql = "update patent set (pa35,pa40,pa45)=(select cu23,rtrim(cu24||' '||cu25||' '||cu26||' '||cu27||' '||cu28||' '||cu102),cu29" & _
                     " from customer where cu01=substr(pa30,1,8) and cu02=substr(pa30,9))" & _
                     " where pa01='" & pa(1) & "' and pa02='" & pa(2) & "' and pa03='" & pa(3) & "' and pa04='" & pa(4) & "'"
            'end 2021/9/27
            cnnConnection.Execute strSql
         End If
      End If
      If strExc(9) <> "" Then
         MsgBox strExc(9), vbExclamation
      End If
      '2018/4/19 END
   End If
   
   Set rsB = Nothing
End Sub

'Modify By Sindy 2018/5/30 從frm140404搬過來,改寫成共用function
'Added by Lydia 2017/08/09 新增／刪除附件
'Modified by Lydia 2022/01/11 TextBox=> Control, ListBox=>Control
Public Function PUB_UpdateCRAttFile(ByVal stKey As String, ByRef txtFTPPath As Control, _
   ByVal strFTPPath_Tag As String, ByVal lstAtt As Control, Optional ByRef iErrNo As Integer, _
   Optional ByRef stErrMsg As String) As Boolean
   
'Modify By Sindy 2019/2/25 "CONTACTRECORD" 改為 "CONTACTFILE"
Const cTableName As String = "CONTACTFILE" 'Added by Lydia 2017/08/09 指定FTP資料夾名稱
Dim arrTmp As Variant, arrOldTmp As Variant
Dim stFtpPath As String
Dim ii As Integer
Dim strMid As String
Dim stFileName As String
Dim intLen As Integer 'Add By Sindy 2021/8/6

On Error GoTo OutPort
   
   iErrNo = 0
   stErrMsg = ""

   arrTmp = Empty: arrOldTmp = Empty
   arrTmp = Split(txtFTPPath.Text, ",")
   arrOldTmp = Split(strFTPPath_Tag, ",")
   
   '先：刪除附件
   If strFTPPath_Tag <> "" Then
    For ii = 0 To UBound(arrOldTmp)
       If Trim(arrOldTmp(ii)) <> "" And InStr(txtFTPPath.Text, Trim(arrOldTmp(ii))) = 0 Then
          If PUB_DelFtpFile2(stKey, Trim(arrOldTmp(ii)), cTableName) = False Then
             GoTo OutPort
          End If
       End If
    Next ii
   End If
   
   '後：新增附件
   If txtFTPPath.Text <> "" Then
    For ii = 0 To UBound(arrTmp)
       If Trim(arrTmp(ii)) <> "" And InStr(strFTPPath_Tag, Trim(arrTmp(ii))) = 0 Then
       
          'Add By Sindy 2021/8/6 排除 C:\Program Files (x86) 狀況
          intLen = Len(lstAtt.List(ii))
          If InStrRev(lstAtt.List(ii), "(") > 0 Then
            If UCase(Mid(lstAtt.List(ii), InStrRev(lstAtt.List(ii), "("), Len("(X86)"))) <> "(X86)" Then
               intLen = InStrRev(lstAtt.List(ii), "(") - 1
            End If
          End If
          '2021/8/6 END
         
          stFileName = Trim(Mid(lstAtt.List(ii), 1, intLen))
          If PUB_PutFtpFile(stFileName, stKey, IIf(InStr(Trim(arrTmp(ii)), stKey & "_") = 0, stKey & "_", "") & Trim(arrTmp(ii)), stFtpPath, cTableName) = False Then
             GoTo OutPort
          Else
             strMid = strMid & IIf(strMid <> "", ",", "") & stFtpPath
          End If
       ElseIf Trim(arrTmp(ii)) <> "" Then
          strMid = strMid & IIf(strMid <> "", ",", "") & Trim(arrTmp(ii))
       End If
    Next ii
    txtFTPPath.Text = strMid
   End If
   
   PUB_UpdateCRAttFile = True
   
   Exit Function
   
OutPort:
   iErrNo = Err.Number
   stErrMsg = Err.Description
End Function

'Created by Morgan 2018/7/26
'取得客戶函/指示信判發人員
'pType=1:客戶函/2:指示信,pSys=系統別, pProperty=案件性質, pCountry=申請國家, pRefProperty=相關號案件性質
Public Function PUB_GetLetterJudgeNew(pType As String, pSys As String, pProperty As String, Optional pCountry As String = "000", Optional pRefProperty As String, Optional pUser As String, Optional pFMP As Boolean = False) As String
   Dim stSQL As String, intR As Integer
   Dim rsQuery As ADODB.Recordset
   Dim stJudge As String
      
   If pUser = "" Then pUser = strUserNum
   
   'Modify By Sindy 2019/10/22 暫定T沒有判發
   If Left(pSys, 1) = "T" Then PUB_GetLetterJudgeNew = "": Exit Function
   '2019/10/22 END
   
   'FMP->自判(紙本判發)
   If pFMP Then
      If pType = "1" Then
         PUB_GetLetterJudgeNew = ""
      End If
      Exit Function
   End If
      
   stSQL = "select LR07,1 Srt from LETTERREVIEWER where LR01='" & pUser & "' and LR02='" & pType & "' and LR03='" & pSys & "' and LR04='" & pCountry & "' and LR05='" & pProperty & "' and LR06='" & pRefProperty & "'" & _
      " union all select LR07,2 Srt from LETTERREVIEWER where LR01='" & pUser & "' and LR02='" & pType & "' and LR03='" & pSys & "' and LR04='" & pCountry & "' and LR05='" & pProperty & "' and LR06='*'" & _
      " union all select LR07,3 Srt from LETTERREVIEWER where LR01='" & pUser & "' and LR02='" & pType & "' and LR03='" & pSys & "' and LR04='" & pCountry & "' and LR05='*' and LR06='*'"
   
   If pSys = "P" And pCountry <> "000" Then
      stSQL = stSQL & _
         " union all select LR07,4 Srt from LETTERREVIEWER where LR01='" & pUser & "' and LR02='" & pType & "' and LR03='" & pSys & "' and LR04='999' and LR05='" & pProperty & "' and LR06='" & pRefProperty & "'" & _
         " union all select LR07,5 Srt from LETTERREVIEWER where LR01='" & pUser & "' and LR02='" & pType & "' and LR03='" & pSys & "' and LR04='999' and LR05='" & pProperty & "' and LR06='*'" & _
         " union all select LR07,6 Srt from LETTERREVIEWER where LR01='" & pUser & "' and LR02='" & pType & "' and LR03='" & pSys & "' and LR04='999' and LR05='*' and LR06='*'"
   End If
   stSQL = stSQL & _
      " union all select LR07,7 Srt from LETTERREVIEWER where LR01='" & pUser & "' and LR02='" & pType & "' and LR03='" & pSys & "' and LR04='*' and LR05='" & pProperty & "' and LR06='" & pRefProperty & "'" & _
      " union all select LR07,8 Srt from LETTERREVIEWER where LR01='" & pUser & "' and LR02='" & pType & "' and LR03='" & pSys & "' and LR04='*' and LR05='" & pProperty & "' and LR06='*'" & _
      " union all select LR07,9 Srt from LETTERREVIEWER where LR01='" & pUser & "' and LR02='" & pType & "' and LR03='" & pSys & "' and LR04='*' and LR05='*' and LR06='*'"
         
   stSQL = stSQL & _
      " union all select LR07,10 Srt from LETTERREVIEWER where LR01='00000' and LR02='" & pType & "' and LR03='" & pSys & "' and LR04='" & pCountry & "' and LR05='" & pProperty & "' and LR06='" & pRefProperty & "'" & _
      " union all select LR07,11 Srt from LETTERREVIEWER where LR01='00000' and LR02='" & pType & "' and LR03='" & pSys & "' and LR04='" & pCountry & "' and LR05='" & pProperty & "' and LR06='*'" & _
      " union all select LR07,12 Srt from LETTERREVIEWER where LR01='00000' and LR02='" & pType & "' and LR03='" & pSys & "' and LR04='" & pCountry & "' and LR05='*' and LR06='*'"
   
   If pSys = "P" And pCountry <> "000" Then
      stSQL = stSQL & _
         " union all select LR07,13 Srt from LETTERREVIEWER where LR01='00000' and LR02='" & pType & "' and LR03='" & pSys & "' and LR04='999' and LR05='" & pProperty & "' and LR06='" & pRefProperty & "'" & _
         " union all select LR07,14 Srt from LETTERREVIEWER where LR01='00000' and LR02='" & pType & "' and LR03='" & pSys & "' and LR04='999' and LR05='" & pProperty & "' and LR06='*'" & _
         " union all select LR07,15 Srt from LETTERREVIEWER where LR01='00000' and LR02='" & pType & "' and LR03='" & pSys & "' and LR04='999' and LR05='*' and LR06='*'"
   End If
   stSQL = stSQL & _
      " union all select LR07,16 Srt from LETTERREVIEWER where LR01='00000' and LR02='" & pType & "' and LR03='" & pSys & "' and LR04='*' and LR05='" & pProperty & "' and LR06='" & pRefProperty & "'" & _
      " union all select LR07,17 Srt from LETTERREVIEWER where LR01='00000' and LR02='" & pType & "' and LR03='" & pSys & "' and LR04='*' and LR05='" & pProperty & "' and LR06='*'" & _
      " union all select LR07,18 Srt from LETTERREVIEWER where LR01='00000' and LR02='" & pType & "' and LR03='" & pSys & "' and LR04='*' and LR05='*' and LR06='*'"
      
   stSQL = "select nvl(st01,OMAN) LR07,Srt from (" & stSQL & ") X,staff,SetSpecMan where st01(+)=LR07 and OCODE(+)=LR07  order by Srt"
   
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      If IsNull(rsQuery(0)) Then
         stJudge = pUser
      Else
         stJudge = rsQuery(0)
      End If
   End If
   
   If stJudge = "" Then stJudge = pUser '沒設算自判
   
   '指示信自判也要回傳
   If pType = "2" Then
      PUB_GetLetterJudgeNew = stJudge
   '客戶函非自判才回傳
   ElseIf stJudge <> pUser Then
      PUB_GetLetterJudgeNew = stJudge
   End If
   Set rsQuery = Nothing
End Function

'Added by Lydia 2018/08/27 判斷FCP案的新案翻譯(201)是否為固定報價
Public Function Pub_GetPa62Flag(ByVal pNo As String) As String
Dim strB1 As String
Dim intB As Integer
Dim rsB As New ADODB.Recordset
Dim strTmp1 As String

On Error GoTo ErrorHandle
    If Left(pNo, 1) <> "X" And Left(pNo, 1) <> "Y" And Left(pNo, 1) <> "P" And Left(pNo, 3) <> "FCP" Then
        Exit Function
    End If
    
    Pub_GetPa62Flag = ""
    '抓固定報價之XY清單
    strTmp1 = "select AAL04 from AddressA4List where AAL01='FCPtct' order by AAL03"
    intB = 1
    Set rsB = ClsLawReadRstMsg(intB, strTmp1)
    If intB = 1 Then
       strTmp1 = rsB.GetString(adClipString, , , ",")
    End If
    
    '判斷範圍：固定報價對象除了判斷FC代理人(PA75)和申請人1~5(PA26~PA30)以外，
    '必須額外判斷個案(PA88)、FC代理人(FA30)和申請人(CU57)基本檔的專利固定請款對象是否在固定報價清單中
    If Left(pNo, 1) = "X" Or Left(pNo, 1) = "Y" Then
         strB1 = "select '' as A00, cu01||cu02 as A01,cu57 as A02,'' as A03,'' as A04,'' as A05,'' as b02,'' as b03,'' as b04,'' as b05,'' as c02,'' as c03,'' as c04,'' as c05" & _
                     " from customer where cu01||cu02=" & CNULL(ChangeCustomerL(pNo))
         strB1 = strB1 & "union all select '' as A00,cu01||cu02 as A01,cu57 as A02,'' as A03,'' as b02,'' as b03,'' as b04,'' as b05,'' as c02,'' as c03,'' as c04,'' as c05" & _
                     " from customer where cu01||cu02=" & CNULL(ChangeCustomerL(pNo))
    Else
         strB1 = "select pa62 as a00,pa26 as A01,pa75 as A02,pa88 as A03,c1.cu57 as A04,fa30 as A05," & _
                     " pa27 as b02,pa28 as b03,pa29 as b04,pa30 as b05," & _
                     " c2.cu57 as c02,c3.cu57 as c03,c4.cu57 as c04,c5.cu57 as c05" & _
                     " from patent,fagent,customer c1,customer c2,customer c3,customer c4,customer c5 where " & ChgPatent(pNo) & _
                     " and substr(pa26,1,8)=c1.cu01(+) and substr(pa26,9,1)=c1.cu02(+) and substr(pa75,1,8)=fa01(+) and substr(pa75,9,1)=fa02(+)" & _
                     " and substr(pa27,1,8)=c2.cu01(+) and substr(pa27,9,1)=c2.cu02(+)" & _
                     " and substr(pa28,1,8)=c3.cu01(+) and substr(pa28,9,1)=c3.cu02(+)" & _
                     " and substr(pa29,1,8)=c4.cu01(+) and substr(pa29,9,1)=c4.cu02(+)" & _
                     " and substr(pa30,1,8)=c5.cu01(+) and substr(pa30,9,1)=c5.cu02(+)"
    End If
    intB = 1
    Set rsB = ClsLawReadRstMsg(intB, strB1)
    If intB = 1 Then
        If "" & rsB.Fields("a00") <> "" Then '個案預設-固定報價
                    Pub_GetPa62Flag = "Y"
        '判斷X,Y編號或基本檔的固定請款對象
        ElseIf (InStr(strTmp1, "" & rsB.Fields("a01")) > 0 And "" & rsB.Fields("a01") <> "") Or (InStr(strTmp1, "" & rsB.Fields("a02")) > 0 And "" & rsB.Fields("a02") <> "") Or (InStr(strTmp1, "" & rsB.Fields("a03")) > 0 And "" & rsB.Fields("a03") <> "") Or (InStr(strTmp1, "" & rsB.Fields("a04")) > 0 And "" & rsB.Fields("a04") <> "") Or (InStr(strTmp1, "" & rsB.Fields("a05")) > 0 And "" & rsB.Fields("a05") <> "") _
                  Or (InStr(strTmp1, "" & rsB.Fields("b02")) > 0 And "" & rsB.Fields("b02") <> "") Or (InStr(strTmp1, "" & rsB.Fields("b03")) > 0 And "" & rsB.Fields("b03") <> "") Or (InStr(strTmp1, "" & rsB.Fields("b04")) > 0 And "" & rsB.Fields("b04") <> "") Or (InStr(strTmp1, "" & rsB.Fields("b05")) > 0 And "" & rsB.Fields("b05") <> "") _
                  Or (InStr(strTmp1, "" & rsB.Fields("c02")) > 0 And "" & rsB.Fields("c02") <> "") Or (InStr(strTmp1, "" & rsB.Fields("c03")) > 0 And "" & rsB.Fields("c03") <> "") Or (InStr(strTmp1, "" & rsB.Fields("c04")) > 0 And "" & rsB.Fields("c04") <> "") Or (InStr(strTmp1, "" & rsB.Fields("c05")) > 0 And "" & rsB.Fields("c05") <> "") Then
                    Pub_GetPa62Flag = "Y"
        End If
    End If
    
    Set rsB = Nothing
    Exit Function
    
ErrorHandle:
If Err.Number <> 0 Then
     MsgBox Err.Description, vbCritical
End If
End Function

'Add by Amy 2018/09/05 增加D進度檔-參考PUB_AddCP1725撰寫
'stCP10:案件性質
'pCP06:本所期限
'pCP07:法定期限
'pCP30:下一程序序號
'pCP43:相關總收文號
'stWhere:其他條件
'pNewCP09:通知期限收文號
'pCountry:申請國家
'pCustNo:客戶編號
'pFcAgentNo:代理人編號
'Modify By Sindy 2021/1/11 內商整批期限通知 + , Optional pCP27 As String = "" : 定稿日期=發文日
'Modify By Sindy 2025/4/30 + , Optional pbolBulk As Boolean = True:是否大宗發文
Public Function PUB_AddCaseProgressD(stCP10 As String, pCP01 As String, pCP02 As String, pCP03 As String, pCP04 As String, pCP06 As String, pCP07 As String, pCP30 As String, pCP43 As String, _
            Optional ByVal stWhere As String = "", Optional ByRef pNewCP09 As String, _
            Optional pCountry As String = "", Optional pCustNo As String = "", _
            Optional pFcAgentNo As String = "", Optional pCP27 As String = "", _
            Optional pbolBulk As Boolean = True) As Boolean
   Dim iR As Integer
   Dim stSQL As String, stField As String, stValue As String
   Dim RsQ As ADODB.Recordset
   Dim stCP09 As String, stCP13 As String, stCP12 As String
   Dim stJudge As String
   Dim bolConn As Boolean
   
On Error GoTo ErrHnd

    stSQL = "Select * From CaseProgress Where cp01='" & pCP01 & "' and cp02='" & pCP02 & "' and cp03='" & pCP03 & "' and cp04='" & pCP04 & "' " & _
                 "and cp10='" & stCP10 & "' " & stWhere
    iR = 1
    Set RsQ = ClsLawReadRstMsg(iR, stSQL)
    
    'cnnConnection.BeginTrans
    cnnConnection.BeginTrans: bolConn = True
    If iR = 1 Then
        pNewCP09 = RsQ("cp09")
    Else
        '收文號
        stCP09 = AutoNo("D", 6)
        stCP13 = PUB_GetAKindSalesNo(pCP01, pCP02, pCP03, pCP04)
        stCP12 = GetSalesArea(stCP13)
        
        '                             收文日,本限,法限
        stField = "cp01,cp02,cp03,cp04,cp05,cp06,cp07"
        '                     文號,案性,業務區,智權,承辦
        stField = stField & ",cp09,cp10,cp12,cp13,cp14"
        '                     收款?,算件?,發文日,開收據,下一程序序號,相關總收文號
        stField = stField & ",cp20,cp26,cp27,cp32,cp30,cp43"
        'Modify By Sindy 2021/1/11 發文日 : strSrvDate(1) => IIf(Val(pCP27) > 0, DBDATE(pCP27), strSrvDate(1))
        stValue = "'" & pCP01 & "','" & pCP02 & "','" & pCP03 & "','" & pCP04 & "'," & strSrvDate(1) & "," & CNULL(pCP06, True) & "," & CNULL(pCP07, True) & _
                        ",'" & stCP09 & "','" & stCP10 & "'," & CNULL(stCP12) & "," & CNULL(stCP13) & ",'" & strUserNum & "'" & _
                        ",'N','N'," & IIf(Val(pCP27) > 0, DBDATE(pCP27), strSrvDate(1)) & ",'N'," & CNULL(pCP30) & "," & CNULL(pCP43)
        
        stSQL = "Insert into CaseProgress(" & stField & " ) values (" & stValue & ")"
        cnnConnection.Execute stSQL, intI
        
        pNewCP09 = stCP09
    End If
   
   'Add By Sindy 2019/10/18
   'Modify By Sindy 2020/5/19 + And Left(pCP01, 1) = "T"
   If strSrvDate(1) >= T商標電子化啟用日 And Left(pCP01, 1) = "T" Then
      '新增信函進度
      '傳FC代理人(pa75)
      '傳是否大宗發文(pbolBulk=True)
      'Modify By Sindy 2022/3/11 pRegisteredMail = False: 是平信非掛號
      'Modify By Sindy 2025/4/17 1729大陸撤三維持,其他改掛號經發文室
      'Modify By Sindy 2025/4/30 個案出定稿時,改不經發文室為平信非掛號
      If pbolBulk = False Then
         PUB_AddLetterProgress pNewCP09, 0, True, "", True, pCustNo, stCP10, pFcAgentNo, , , False
      '2025/4/30 END
      ElseIf stCP10 = "1729" Then
         PUB_AddLetterProgress pNewCP09, 0, True, "", False, pCustNo, stCP10, pFcAgentNo, , , True
      Else
         PUB_AddLetterProgress pNewCP09, 0, True, "", True, pCustNo, stCP10, pFcAgentNo, , , True
      End If
      '2025/4/17 END
   End If
   '2019/10/18 END
   
   If bolConn = True Then cnnConnection.CommitTrans: bolConn = False
   
   PUB_AddCaseProgressD = True
   Exit Function
   
ErrHnd:
    If bolConn = True Then cnnConnection.RollbackTrans: bolConn = False
    MsgBox Err.Description, vbCritical
End Function

'Added by Lydia 2018/09/11 FCP案電子送件發文時,設定電子送件自動扣款日
Public Function Pub_FcpSetPayToday(ByVal iKind As String, ByVal Cp27 As String, ByVal ChkVal As String) As String
   Pub_FcpSetPayToday = ""
   
   If iKind = "1" Then  '判斷電子送件是否當日扣款
        If ChkVal = "Y" Then 'CP118
           '當日3點半以前預設當日扣款否則要人工輸入
           If TransDate(Cp27, 1) > strSrvDate(2) Or (TransDate(Cp27, 1) = strSrvDate(2) And Val(ServerTime) <= 153000) Then
              Pub_FcpSetPayToday = "Y"
           End If
        End If
   Else
      If ChkVal <> "" Then '電子送件是否當日扣款
         '若是當天扣款=Y則抓隔一工作天，若當天扣款"N"則抓隔二工作天
         If ChkVal = "Y" Then
            Pub_FcpSetPayToday = CompWorkDay(2, DBDATE(Cp27))
         Else
            Pub_FcpSetPayToday = CompWorkDay(3, DBDATE(Cp27))
         End If
      End If
   End If
End Function

'Added by Lydia 2018/09/11 FCP電子送件若發文時若有規費，則自動產生行事曆。
Public Function Pub_AddReceiptCalendar1(ByVal cp01 As String, ByVal cp02 As String, ByVal cp03 As String, ByVal cp04 As String, ByVal CP10 As String, ByVal Cp152 As String) As Boolean
Dim strA01 As String, strA02 As String
Dim strT01 As String
   
'Modofied by Lydia 2019/01/09 因為改成整批下載收據，取消行事曆
'   Pub_AddReceiptCalendar1 = False
'   strA01 = PUB_GetFCPHandler(cp01, cp02, cp03, cp04, CP10)
'   strA02 = GetABS001_17(strA01)
'   If strA01 <> "" Then
'        strT01 = "請當日下午下載電子送件之收據"
'        strA02 = strA01 & IIf(strA02 <> "", ",", "") & strA02
'        '發文人員不是期限管制人請增加"發文人員"到提醒人員及解除人員
'        If strUserNum <> strA01 Then
'              strA01 = strA01 & "," & strUserNum
'              If InStr(strA02, strUserNum) = 0 Then
'                   strA02 = strA02 & "," & strUserNum
'              End If
'        End If
'
'        '提醒人員=管制人+案件第一職代+發文人(非管制人)
'        If PUB_AddFCPStaffCalendar(Cp152, "1", strA01, strT01, strA02, "1", cp01, cp02, cp03, cp04) = True Then
'             Pub_AddReceiptCalendar1 = True
'        End If
'   End If
Pub_AddReceiptCalendar1 = True
'end 2019/01/09
End Function

'Added by Morgan 2018/10/2
'Modified by Morgan 2023/6/27 +pCC
Public Sub Pub_COrderInform(pCP09 As String, Optional pIs941 As Boolean, Optional pCC As String)
    Dim stSQL As String, intR As Integer
    stSQL = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08,mc09)" & _
      " select '" & strUserNum & "' mc01,cp14 mc02,to_char(sysdate,'yyyymmdd') mc03,to_char(sysdate,'hh24miss') mc04" & _
      ",cp01||'-'||cp02||'-'||cp03||'-'||cp04||'「'||nvl(pa05,nvl(pa06,pa07))||'」-->'||decode(pa09,'000',cpm03,cpm04) mc07" & _
      ",'本所案號：'||cp01||'-'||cp02||'-'||cp03||'-'||cp04||chr(13)||chr(10)" & _
      "||'案件名稱：'||nvl(pa05,nvl(pa06,pa07))||chr(13)||chr(10)" & _
      "||'申請人　：'||nvl(cu04,nvl(trim(cu05||' '||cu88||' '||cu89||' '||cu90),cu06))||chr(13)||chr(10)" & _
      "||'本所期限：'||sqldatet(cp06)||chr(13)||chr(10)" & _
      "||'來函內容：請至卷宗區參看來函" & IIf(pIs941, "並做分析", "") & "' mc08,'" & pCC & "' mc09" & _
      " from caseprogress,patent,customer,casepropertymap" & _
      " where cp09='" & pCP09 & "' and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04" & _
      " and cu01(+)=substr(pa26,1,8) and cu02(+)=substr(pa26,9) and cpm01(+)=cp01 and cpm02(+)=cp10"
   cnnConnection.Execute stSQL, intR
   
   'Added by Morgan 2018/10/3
   '自動上收卷日(因已電子化無紙本)--郭雅娟
   stSQL = "update engineerprogress set EP27=to_char(sysdate,'yyyymmdd') where ep02='" & pCP09 & "' and ep27 is null"
   cnnConnection.Execute stSQL, intR
   
End Sub

'Added by Lydia 2018/11/20 抓DB中的欄位實際長度
Public Function PUB_GetFieldDefSize(ByVal pTBname As String, pTFname As String) As String
Dim stSQL As String, intR As Integer
Dim rsR As ADODB.Recordset
Dim stMid As String
    If pTBname = "" Then Exit Function

    stSQL = "SELECT TABLE_NAME,COLUMN_NAME,DECODE(DATA_TYPE,'NUMBER',DATA_PRECISION,CHAR_LENGTH) AS DEFSIZE " & _
                 "FROM ALL_TAB_COLUMNS WHERE TABLE_NAME='" & UCase(pTBname) & "' " & _
                 IIf(pTFname <> "", "AND COLUMN_NAME='" & UCase(pTFname) & "' ", "") & "ORDER BY COLUMN_ID "
    intR = 1
    Set rsR = ClsLawReadRstMsg(intR, stSQL)
    If intR = 1 Then
        rsR.MoveFirst
        Do While Not rsR.EOF
            stMid = stMid & "," & rsR.Fields("DEFSIZE")
            rsR.MoveNext
        Loop
    End If
    If stMid <> "" Then
        PUB_GetFieldDefSize = Mid(stMid, 2)
    End If
    Set rsR = Nothing
End Function

'Add By Sindy 2018/12/4
'發文/通知申請號 檢查卷宗區或匯入區是否有接洽單/申請書pdf檔
'pCP09:收文號, pType:檢查類別(0=接洽單,1=申請書), pImport:是否匯入(True=是, False=否)
'pImpFile:待匯入檔名, pCP10:案件性質碼, pChkFolderOnly:只檢查匯入區
Public Function PUB_TCheckCppPDF(pCP09 As String, Optional pType As Integer = 0, Optional pImport As Boolean = False, _
   Optional ByRef pImpFile As String, Optional pCP10 As String, Optional pChkFolderOnly As Boolean = False) As Boolean
   
   Dim stSQL As String, intR As Integer
   Dim rsQuery As ADODB.Recordset
   Dim strFolder As String, strCon As String
   Dim strCP02 As String, strCP03 As String, strCP04 As String
   Dim oFileSys As New FileSystemObject
   Dim oFolder As Folder
   Dim oFiles As files
   Dim oFile
   Dim strFileName As String
   Dim strExtFileName As String
   Dim bolOK As Boolean ', strNum As String
'   Dim strCP09List As String, strCP10List As String
   Dim stCP10 As String
   Dim stCP01 As String, stCP02 As String, stCP03 As String, stCP04 As String, strFileNm As String 'Add By Sindy 2019/1/28
   Dim f, fs
   
'   '接洽單
'   If pType = 0 Then
'      strFolder = "\\Pat1\Order_SCAN"
'      '測試抓桌面的相同資料夾以免誤刪真實檔案
'      If UCase(pub_DbTerminalName) <> 正式資料庫電腦名稱 Then
'         strFolder = PUB_Getdesktop & "\" & Mid(strFolder, InStrRev(strFolder, "\") + 1)
'      End If
'
'      If pCP10 <> "" Then
'         strCon = " and ( instr(upper(cpp02),'." & pCP10 & ".ORDER.MENU')>0 or instr(upper(cpp02),'." & pCP10 & ".ORDER.PDF')>0 )"
'      Else
'         strCon = " and ( instr(upper(cpp02),'.ORDER.MENU')>0 or instr(upper(cpp02),'.ORDER.PDF')>0 )"
'      End If
'      strExtFileName = ".ORDER.PDF"
   '申請書
   '註冊費繳費單
   If pType = 1 And pCP10 = "717" Then
      strFolder = strTFeeForm
      '測試抓桌面的相同資料夾以免誤刪真實檔案
      If UCase(pub_DbTerminalName) <> 正式資料庫電腦名稱 Then
         strFolder = PUB_Getdesktop & "\" & Mid(strFolder, InStrRev(strFolder, "\") + 1)
      End If
      
      If pCP10 <> "" Then
         strCon = " and instr(upper(cpp02),'." & pCP10 & ".DATA.PDF')>0"
      Else
         strCon = " and instr(upper(cpp02),'.DATA.PDF')>0"
      End If
      strExtFileName = ".DATA.PDF"
   Else
      Exit Function
   End If
   
   bolOK = False
   If Not pChkFolderOnly Then
      stSQL = "select cpp02 from casepaperpdf where cpp01='" & pCP09 & "' and cpp10<>'D'" & strCon
      intR = 1
      Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         bolOK = True
         PUB_TCheckCppPDF = True
      End If
   End If
   
   stCP10 = pCP10
   pImpFile = ""
   If bolOK = False Then
      stSQL = "select cp01,cp02,cp03,cp04,cp05,cp10,cp156 from caseprogress where cp09='" & pCP09 & "'"
      intR = 1
      Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         With rsQuery
         'Add By Sindy 2019/1/28
         If stCP01 = "" Then stCP01 = .Fields("cp01")
         If stCP02 = "" Then stCP02 = .Fields("cp02")
         If stCP03 = "" Then stCP03 = .Fields("cp03")
         If stCP04 = "" Then stCP04 = .Fields("cp04")
         '2019/1/28 END
         If stCP10 = "" Then stCP10 = .Fields("cp10")
         Dim stFileName As String
         strFileNm = strFolder & "\" & stCP01 & stCP02 & IIf(stCP03 & stCP04 = "000", "", "-" & stCP03 & "-" & stCP04) & "*.pdf"
         stFileName = Dir(strFileNm)
         If stFileName <> "" Then
'         If Dir(strFolder & "\*.pdf") <> "" Then
'            Set oFolder = oFileSys.GetFolder(strFolder)
'            Set oFolder = oFileSys.GetFolder(strFileNm)
'            Set oFiles = oFolder.files
'            For Each oFile In oFiles
'               If UCase(Right(oFile.Name, 4)) = ".PDF" Then
'                  If InStr(oFile.Name, .Fields("cp01")) = 1 Then
'                     If PUB_GetCaseNoFromFileName(oFile.Name, .Fields("cp01"), strCP02, strCP03, strCP04) = True Then
                     If PUB_GetCaseNoFromFileName(stFileName, .Fields("cp01"), strCP02, strCP03, strCP04) = True Then
                        If strCP02 = .Fields("cp02") And strCP03 = .Fields("cp03") And strCP04 = .Fields("cp04") Then
'                           BolOk = True
'                           strNum = ""
'                           strCP09List = ""
'                           strCP10List = ""
'                           'Added by Morgan 2014/11/17
'                           '接洽單改為檔名內要有案件性質碼或接洽單收文數
'                           If pType = 0 Then
'                              If InStrRev(oFile.Name, ".") > InStr(oFile.Name, ".") Then
'                                 strNum = Mid(oFile.Name, InStr(oFile.Name, ".") + 1, InStrRev(oFile.Name, ".") - InStr(oFile.Name, ".") - 1)
'                                 '案件性質
'                                 'Modified by Morgan 2015/3/23 分案時可能會改案件性質
'                                 'If strNum = .Fields("cp10") Then
'                                 If strNum = stCP10 Then
'                                 'end 2015/3/23
'                                    BolOk = True
'                                 '接洽單收文數
'                                 ElseIf IsNumeric(strNum) And Len(strNum) = 1 Then
'                                    BolOk = CheckMultiNoOrder(.Fields("cp01"), .Fields("cp02"), .Fields("cp03"), .Fields("cp04"), .Fields("cp05"), strNum, strCP09List, strCP10List)
'
'                                 End If
'                              End If
'                           Else
'                              BolOk = True
'                           End If

'                           If BolOk Then
                              If pImport = True Then
'                                 pImpFile = oFile.path
                                 'Modify By Sindy 2022/5/6 Val(.Fields("cp02")) ==> .Fields("cp02")
                                 strFileName = .Fields("cp01") & .Fields("cp02") & IIf(.Fields("cp04") <> "00", "-" & .Fields("cp03") & "-" & .Fields("cp04"), IIf(.Fields("cp03") <> "0", "-" & .Fields("cp03"), ""))
                                 strFileName = strFileName & "." & stCP10 & strExtFileName
                                 Set fs = CreateObject("Scripting.FileSystemObject")
                                 Set f = fs.GetFile(strFolder & "\" & stFileName)
                                 'PUB_TCheckCppPDF = SaveAttFile_PDF(pCP09, pImpFile, strFileName, Format(oFile.DateLastModified, "YYYYMMDD"), Format(oFile.DateLastModified, "HHMMSS"), False)
                                 PUB_TCheckCppPDF = SaveAttFile_PDF(pCP09, strFolder & "\" & stFileName, strFileName, Format(f.DateLastModified, "YYYYMMDD"), Format(f.DateLastModified, "HHMMSS"), False)
                                 '批次會刪除3個月後的電子檔
                                 'If PUB_TCheckCppPDF = True Then oFile.Delete True
                              Else
                                 PUB_TCheckCppPDF = True
                              End If
'                              Exit For
'                           End If
                        End If
                     End If
'                  End If
'               End If
'            Next
         End If
         End With
      End If
   End If

   Set rsQuery = Nothing
   Set oFileSys = Nothing
   Set oFolder = Nothing
   Set oFiles = Nothing
   Set oFile = Nothing
   Set fs = Nothing
   Set f = Nothing
End Function

'Added by Lydia 2018/12/10 判斷查名是否齊備
'Modified by Lydia 2018/12/18 +nDate 查名齊備日
Public Function PUB_TMQchkCP143(ByVal InputNo As String, Optional ByRef nDate As String) As String
Dim intR As Integer, strR1 As String
Dim rsR As New ADODB.Recordset

    intR = 1
    nDate = "" 'Added by Lydia 2018/12/18
    If Left(InputNo, 1) = "H" Then '接洽單(傳入查名單號HAxxxx以,區隔)
        'Modified by Lydia 2018/12/18 +NDATE
        strR1 = "select '' as NDATE, count(distinct(tmq01)) 查名單量,sum(decode(tmq11,null,0,1)) 已查覆 " & _
                "from trademarkquery where tmq01 in (" & GetAddStr(InputNo) & ") "
        'Added by Lydia 2024/11/11 查名單(網中)：先行測試
        If strSrvDate(1) >= 查名單網中系統平行測試 Then
           strR1 = strR1 & "Union select '' as NDATE, count(distinct(tma01)) 查名單量,sum(decode(tma14,null,0,1)) 已查覆 " & _
                  "from tmqappform where tma01 in (" & GetAddStr(InputNo) & ") "
        End If
        'end 2024/11/11
    Else    '其他(傳入收文號)
        'Modified by Lydia 2023/08/18 +排除記錄
        strR1 = "select count(distinct(tmq01)) 查名單量,sum(decode(tmq11,null,0,1)) 已查覆 " & _
                "from trademarkquery where tmq01 in ( select tqc03 from tmqcasemap where tqc02='" & InputNo & "' and tqc03<>'" & cntTQC自動記錄 & "') "
        'Added by Lydia 2024/11/11 查名單(網中)：先行測試
        If strSrvDate(1) >= 查名單網中系統平行測試 Then
           strR1 = strR1 & "Union select count(distinct(tma01)) 查名單量,sum(decode(tma14,null,0,1)) 已查覆 " & _
                   "from tmqappform where tma01 in ( select tqc03 from tmqcasemap where tqc02='" & InputNo & "' and tqc03<>'" & cntTQC自動記錄 & "') "
        End If
        'end 2024/11/11
        'Added by Lydia 2018/12/18 抓cp143查名齊備日
        strR1 = "select cp143 as NDATE,x.* from caseprogress, (" & strR1 & ") x where cp09=" & CNULL(InputNo)
    End If
    Set rsR = ClsLawReadRstMsg(intR, strR1)
    If intR = 1 Then
        If Val("" & rsR.Fields("查名單量")) = 0 Then
            PUB_TMQchkCP143 = ""
        Else
            If Val("" & rsR.Fields("查名單量")) <> Val("" & rsR.Fields("已查覆")) Then
                PUB_TMQchkCP143 = "N"
            Else
                PUB_TMQchkCP143 = "Y"
            End If
        End If
        nDate = "" & rsR.Fields("NDATE") 'Added by Lydia 2018/12/18 查名齊備日
    End If
    Set rsR = Nothing
End Function

'Added by Lydia 2019/02/12 創新業務部人員收文控管
Public Function PUB_ChkIsT10T20(ByVal kType As String, ByVal kUserNo As String, Optional ByRef pMaxNo As String, Optional ByRef pMaxName As String) As Boolean
'pMaxNo,pMaxName '部門代表號, 名稱
'kType 1.取得部門代表號, 2.判斷是否為創新業務部代表號
'2019/2/12美珍提供：
'一、    T字頭部門人員，不可個人收文，除了特殊設定人員' TSpecial'：
'    1.  接洽記錄單：員工代號預設其部門最大員工編號T1001或T2001，若修改不可改為T字頭部門除特殊設定人員' TSpecial'外的人員，顯示訊息'此人員不可個人收文，請改收部門代表號T1001或T2001！'。
'             2019/02/22 非T字頭部門人員代填T字頭部門人員要檢查
'    2.  客戶檔維護、各系統類別之收文、內部收文、分案：依第1點規則限制。
'    3.  財務處各項功能不受上述限制(瑞婷說保留彈性)。
'Modified by Lydia 2019/05/07
'1.  已新ㄢ〞靉00創新業務部主管；
'已新增員工W1001、W2001；
'已新增系統特殊設定WSpecial。
'2.  原T10改為W10、T20改為W20，
Dim strM1 As String
Dim pUserDept As String
Dim intM As Integer
Dim rsR1 As New ADODB.Recordset

    pMaxNo = ""
    pMaxName = ""
    pUserDept = ""
    If kType = "" Or kUserNo = "" Then Exit Function
     
    strM1 = "select st15,st01 as mno, st02 as mname from staff where st01 in (" & _
                 "select max(st01) mno from staff where st15 in (" & _
                 "select a0901 from staff,acc090 where st01='" & kUserNo & "' and st15=a0901(+)) and st04='1' group by st15) "
                 
    intM = 1
    Set rsR1 = ClsLawReadRstMsg(intM, strM1)
    If intM = 1 Then
        pUserDept = "" & rsR1.Fields("st15")
        'Modified by Lydia 2019/05/07 原T10改為W10、T20改為W20
        'If pUserDept <> "" And InStr("T1,T2", Left(pUserDept, 2)) > 0 Then
        'Modify By Sindy 2024/1/17 秀玲說不管2碼,改1碼,因現在又加入了開發組W3
        'If pUserDept <> "" And InStr("W1,W2", Left(pUserDept, 2)) > 0 Then
        If pUserDept <> "" And Left(pUserDept, 1) = "W" Then
        '2024/1/17 END
            If kType = "1" Then
                '創新業務部人員: 員工代號預設其部門最大員工編號
                pMaxNo = "" & rsR1.Fields("mno")
                pMaxName = "" & rsR1.Fields("mname")
                PUB_ChkIsT10T20 = False
            Else
                pMaxNo = "" & rsR1.Fields("mno")
                pMaxName = "" & rsR1.Fields("mname")
                '檢查T字頭部門不可輸入除特殊設定人員' TSpecial'外的人員
                'Modified by Lydia 2019/05/07
                'strM1 = Pub_GetSpecMan("TSpecial")
                strM1 = Pub_GetSpecMan("WSpecial")
                If InStr(strM1, kUserNo) = 0 Then
                     MsgBox "此人員不可個人收文，請改收部門代表號" & pMaxNo & "！", vbCritical, "收文控管"
                     PUB_ChkIsT10T20 = True
                End If
            End If
        End If
    End If
    Set rsR1 = Nothing
End Function

''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' 取得國外代理人的性質
' Input : strAgent ==> 代理人的代碼
' Output : 傳回國外代理人的性質
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Public Function PUB_GetFAgentFA76(ByVal strAgent As String) As String
Dim rsTmp As New ADODB.Recordset
Dim strSql As String
Dim strFA01 As String
Dim strFA02 As String
   
   ' 設定 KEY 值
   strFA01 = Mid(strAgent, 1, 8)
   If Len(strFA01) < 8 Then: strFA01 = strFA01 & String(8 - Len(strFA01), "0")
   strFA02 = Mid(strAgent, 9, 1)
   If strFA02 = Empty Then: strFA02 = "0"
   
   ' 設定初始值
   PUB_GetFAgentFA76 = Empty
   
   ' 組成SQL語法
   strSql = "SELECT * FROM FAGENT " & _
            "WHERE FA01 = '" & strFA01 & "' AND " & _
                  "FA02 = '" & strFA02 & "' "
   rsTmp.CursorLocation = adUseClient
   rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   
   ' 判斷是否有資料
   If rsTmp.RecordCount > 0 Then
      If IsNull(rsTmp.Fields("FA76")) = False Then
         PUB_GetFAgentFA76 = rsTmp.Fields("FA76")
      End If
   End If
   rsTmp.Close
   Set rsTmp = Nothing
End Function

'Added by Lydia 2019/04/09 將Word搬移到視窗外的位置(從Frmacc2480搬來)
Public Function Pub_NewWordDoc(ByRef p_WordAp, Optional ByRef pVisible As Boolean, Optional ByRef PLeft As Long, Optional ByRef pTop As Long) As Boolean

   Dim iResumeCnt As Integer
   
On Error GoTo ErrHnd
   
   If TypeName(p_WordAp) <> "Application" Then
      Set p_WordAp = New Word.Application
   End If
   PLeft = p_WordAp.Left
   pTop = p_WordAp.Top
   
   p_WordAp.Documents.add
   
   pVisible = p_WordAp.Visible
   
   '不顯示可能會有問題
      p_WordAp.Visible = True
      If Not g_LetterDebug Then
         p_WordAp.WindowState = wdWindowStateNormal
         If p_WordAp.WindowState = wdWindowStateNormal Then
            p_WordAp.Move Screen.Width / 20, Screen.Height / 20
         End If
      End If
      p_WordAp.ActiveWindow.ActivePane.View.Zoom.Percentage = 100

   Pub_NewWordDoc = True
   Exit Function
   
ErrHnd:
   If Err.Number <> 0 Then
      If iResumeCnt > 3 Then
         MsgBox "錯誤 : " & Err.Description, vbCritical
      Else
         iResumeCnt = iResumeCnt + 1
         Select Case Err.Number
            Case 91:
               p_WordAp.Documents.add
               Resume Next
            Case 462:
               Set p_WordAp = New Word.Application
               Resume
            Case Else:
               MsgBox "錯誤 : " & Err.Description, vbCritical
         End Select
      End If
   End If
End Function

'Added by Lydia 2019/04/09 還原Word在視窗的位置(從Frmacc2480搬來)
Public Sub Pub_RePosWord(ByRef p_WordAp, ByRef pVisible As Boolean, ByRef PLeft As Long, ByRef pTop As Long)
   p_WordAp.Visible = pVisible
   p_WordAp.Move PLeft, pTop
End Sub

'Added by Morgan 2019/5/27
'CFP案管制人
'pCaseNo:本所案號
'Modify By Sindy 2020/3/18 回傳人員的ST17專業代號-國外 , Optional ByRef strST17 As String = ""
Public Function PUB_GetCFPHandler(pCaseNo As String, Optional ByRef strST17 As String = "") As String
   Dim stSQL As String, intQ As Integer, ii As Integer
   Dim rsQuery As ADODB.Recordset
   Dim stNo As String, arrTxt() As String
   Dim pa(4) As String
   Dim stCP12 As String, stCP13 As String
   
   If InStr(pCaseNo, "-") > 0 Then
      arrTxt = Split(pCaseNo, "-")
      intQ = 1
      For ii = LBound(arrTxt) To UBound(arrTxt)
         pa(intQ) = arrTxt(ii)
         intQ = intQ + 1
      Next
      If pa(3) = "" Then pa(3) = "0"
      If pa(4) = "" Then pa(4) = "00"
   Else
      ChgCaseNo pCaseNo, pa
   End If
   
   'Added by Morgan 2020/2/21
   '109/4/1以後改業務區劃分
   'Modified by Lydia 2020/03/05 改成常數
   'If strSrvDate(1) >= 20200401 Then
   If strSrvDate(1) >= CFP業務區劃分啟用日 Then
      stCP13 = PUB_GetAKindSalesNo(pa(1), pa(2), pa(3), pa(4))
      'Modify By Sindy 2020/3/18 +,ST17 +staff s2
      stSQL = "select a0916,s2.ST17 from staff s1,staff s2,acc090 where s1.st01='" & stCP13 & "' and a0901(+)=s1.st15 and a0916=s2.st01(+)"
      intQ = 1
      Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
      If intQ = 1 Then
         PUB_GetCFPHandler = "" & rsQuery(0)
         strST17 = "" & rsQuery(1) 'Add By Sindy 2020/3/18
      End If
   Else
   'end 2020/2/21
   
      stSQL = "select decode(mod(pa02,2),1,na73,na74) from patent,nation" & _
         " where pa01='" & pa(1) & "' and pa02='" & pa(2) & "' and pa03='" & pa(3) & "' and pa04='" & pa(4) & "' and na01(+)=pa09"
      intQ = 1
      Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
      If intQ = 1 Then
         PUB_GetCFPHandler = "" & rsQuery(0)
      End If
      
   End If 'Added by Morgan 2020/2/21
   
   Set rsQuery = Nothing
End Function

'Added by Morgan 2024/12/27
'P案管制人
'pCaseNo:本所案號
'strST17:管制人專業代號-國外
'strCP13:智權人員
Public Function PUB_GetPHandler(pCaseNo As String, Optional ByRef strST17 As String = "", Optional ByRef strCP13 As String = "") As String
   Dim stSQL As String, intQ As Integer, ii As Integer
   Dim rsQuery As ADODB.Recordset
   Dim arrTxt() As String
   Dim pa(4) As String
   
   If InStr(pCaseNo, "-") > 0 Then
      arrTxt = Split(pCaseNo, "-")
      intQ = 1
      For ii = LBound(arrTxt) To UBound(arrTxt)
         pa(intQ) = arrTxt(ii)
         intQ = intQ + 1
      Next
      If pa(3) = "" Then pa(3) = "0"
      If pa(4) = "" Then pa(4) = "00"
   Else
      ChgCaseNo pCaseNo, pa
   End If
   
   strCP13 = PUB_GetAKindSalesNo(pa(1), pa(2), pa(3), pa(4))
   stSQL = "select a0917,s2.ST17 from staff s1,staff s2,acc090 where s1.st01='" & strCP13 & "' and a0901(+)=s1.st15 and a0917=s2.st01(+)"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      PUB_GetPHandler = "" & rsQuery(0)
      strST17 = "" & rsQuery(1)
   End If
   
   Set rsQuery = Nothing
End Function

'Added by Morgan 2019/6/17
'刪除台一網站資料夾
Public Function PUB_DeleteWWW(pPS01 As String) As Boolean
   Dim stDir As String, stFolder As String, stFileName As String
   Dim hConnection As Long, hFind As Long, LRet As Long
   Dim pData As WIN32_FIND_DATA
   
   
   stDir = Pub_GetSpecMan("FTP_WWW_Path")
   If stDir = "" Then
      MsgBox "台一網站FTP目錄(FTP_WWW_Path)未設定", vbExclamation
      Exit Function
   End If
   
   stFolder = Format(pPS01, "000000")
   
On Error GoTo ErrHnd
   
   hConnection = PUB_GetFtpConnect(, , "FTP_WWW_IP")
   If hConnection <> 0 Then
      '切換目錄來檢查是否存在
      If PUB_SetFtpDirectory(hConnection, stDir) = True Then
         If FtpSetCurrentDirectory(hConnection, stFolder) = 1 Then
            pData.cFileName = String(MAX_PATH, 0)
            hFind = FtpFindFirstFile(hConnection, "*.*", pData, 0, 0)
            If hFind <> 0 Then
               Do
                  stFileName = Left(pData.cFileName, InStr(1, pData.cFileName, String(1, 0), vbBinaryCompare) - 1)
                  If stFileName <> "." And stFileName <> ".." Then
                     If FtpDeleteFile(hConnection, stFileName) <> 1 Then
                        MsgBox "台一網站FTP檔案 " & stDir & "/" & stFileName & " 刪除失敗！", vbCritical
                        GoTo ErrHnd
                     End If
                  End If
                  LRet = InternetFindNextFile(hFind, pData)
               Loop While LRet <> 0
               
               InternetCloseHandle hFind
               hFind = 0
            End If
            
            If FtpSetCurrentDirectory(hConnection, "..") <> 1 Then
               MsgBox "台一網站FTP目錄切換失敗！", vbCritical
               GoTo ErrHnd
            End If
         
         'End If 'Removed by Morgan 2020/7/23 目錄不存在不必刪
         
            If FtpRemoveDirectory(hConnection, stFolder) <> 1 Then
               MsgBox "台一網站FTP目錄 " & stDir & "/" & stFolder & " 刪除失敗！", vbCritical
               GoTo ErrHnd
            End If
            
         End If 'Added by Morgan 2020/7/23 目錄不存在不必刪
      End If
   End If
   PUB_DeleteWWW = True
   
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
   If hConnection <> 0 Then InternetCloseHandle hConnection
   
End Function

'Added by Morgan 2019/6/19
'設定客戶為不可減免
'pAppNo=客戶編號, pCountry=申請國家
Public Sub PUB_SetNoDisc(pAppNo As String, pCountry As String)
   Dim stSQL As String, intR As Integer
   stSQL = "insert into applicantdiscount(AD01,AD02,AD03,AD04,AD05,AD06) values('" & Left(pAppNo & "000", 8) & "','" & pCountry & "','N','" & strUserNum & "',TO_NUMBER(TO_CHAR(SYSDATE,'YYYYMMDD')),TO_NUMBER(TO_CHAR(SYSDATE,'HH24MI')))"
   cnnConnection.Execute stSQL, intR
End Sub

'Added by Morgan 2019/6/20 刪除檔案：指定資料夾的PDF檔
Public Sub PUB_KillAttach(pAttPath As String)
On Error Resume Next
   If Dir(pAttPath & "\.") <> "" Then
      SetAttr pAttPath & "\*.pdf", vbNormal 'Added by Lydia 2020/03/19 預設檔案為正常
      Kill pAttPath & "\*.pdf"
   End If
End Sub

'Added by Lydia 2020/03/19 刪除檔案：指定資料夾的所有檔案
Public Sub PUB_KillAnyFile(pAttPath As String, Optional ByVal pDelName As String = "*.*")
Dim strFile01 As String
On Error Resume Next
    
   strFile01 = Dir(pAttPath & "\" & pDelName)
   Do While strFile01 <> ""
        SetAttr pAttPath & "\" & strFile01, vbNormal '預設檔案為正常
        Kill pAttPath & "\" & strFile01
        strFile01 = Dir()
   Loop
End Sub

'Added by Lydia 2019/06/21 FCP台灣新型年費解除期限一案兩請提醒
Public Function Pub_ChkFCPDualCaseBYcancel(ByVal iPA01 As String, ByVal iPA02 As String, ByVal iPA03 As String, ByVal iPA04 As String, ByVal iPA08 As String, ByVal iPA09 As String, ByVal iCP10 As String, Optional ByVal bolMsg As Boolean = True) As String
Dim strB1 As String, intB As Integer
Dim rsB As New ADODB.Recordset
   
   Pub_ChkFCPDualCaseBYcancel = ""
   
   If iCP10 = "605" And iPA01 = "FCP" And iPA09 = "000" And iPA08 = "2" Then
      '若發明案尚未審定或核駁且未閉卷時，提醒使用者
      strB1 = "select pa01||'-'||pa02||decode(pa03||pa04,'000','','-'||pa03||'-'||pa04)" & _
         " from (select cm05,cm06,cm07,cm08 from casemap where cm10='3' and cm01='" & iPA01 & "' and cm02='" & iPA02 & "' and cm03='" & iPA03 & "' and cm04='" & iPA04 & "'" & _
         " union select cm01,cm02,cm03,cm04 from casemap where cm10='3' and cm05='" & iPA01 & "' and cm06='" & iPA02 & "' and cm07='" & iPA03 & "' and cm08='" & iPA04 & "') X" & _
         ",patent where pa01(+)=cm05 and pa02(+)=cm06 and pa03(+)=cm07 and pa04(+)=cm08 and pa08='1' AND pa57 is null and (pa16 is null or pa16='2')"
      
      intB = 1
      Set rsB = ClsLawReadRstMsg(intB, strB1)
      If intB = 1 Then
         Pub_ChkFCPDualCaseBYcancel = "此案為一案兩請且發明案 " & rsB.Fields(0) & " 尚未審定，請將卷宗交業務承辦告知客戶新型專利權若因未繳年費而當然消滅者，則將不予專利！"
         If bolMsg = True Then MsgBox Pub_ChkFCPDualCaseBYcancel, vbExclamation
      End If
      Set rsB = Nothing
   End If

End Function
'Added by Morgan 2019/7/8
'檢查是否為Y53374寰華代理的CFP案(不可輸入帳單)
Public Function PUB_ChkIsNoBillCase(pPA01 As String, pPA02 As String, pPA03 As String, pPA04 As String) As Boolean
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   
   If pPA01 = "CFP" Then
      stSQL = "select pa01||'-'||pa02||decode(pa03||pa04,'000','','-'||pa03||'-'||pa04),fa04 from patent,fagent where pa01='" & pPA01 & "' and pa02='" & pPA02 & "' and pa03='" & pPA03 & "' and pa04='" & pPA04 & "' and pa75='Y53374000' and fa01(+)=substr(pa75,1,8) and fa02(+)=substr(pa75,9)"
      intQ = 1
      Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
      If intQ = 1 Then
         MsgBox "本案的FC代理人為【" & rsQuery(1) & "】" & vbCrLf & vbCrLf & "請勿輸入帳單，並留意該帳單是否開立寰華名義，並轉交郭經理處理！", vbCritical, rsQuery(0)
   
         PUB_ChkIsNoBillCase = True
      End If
   End If
   Set rsQuery = Nothing
End Function

'Added by Lydia 2019/07/01 新增個人使用記錄(智權部-個人常用區) 'Memo by Lydia 2019/07/09 從basPublic搬來
Public Sub Pub_AddPersonRec(ByVal pFormName As String)
Dim stExec As String
Dim intB As Integer
    
On Error GoTo ErrHandleAdd
    
    If pFormName = "" Then Exit Sub
    cnnConnection.BeginTrans
        stExec = "UPDATE UseForm Set UF04=UF04+1 Where UF01='" & pFormName & "' and UF02='" & strUserNum & "' and UF03=" & strSrvDate(1)
        cnnConnection.Execute stExec, intB
        If intB = 0 Then
            stExec = "INSERT INTO UseForm (UF01,UF02,UF03,UF04) VALUES ('" & pFormName & "', '" & strUserNum & "', " & strSrvDate(1) & ", 1 ) "
            cnnConnection.Execute stExec, intB
        End If
    cnnConnection.CommitTrans
    
    Exit Sub
    
ErrHandleAdd:
    If Err.Number <> 0 Then
        cnnConnection.RollbackTrans
        Resume Next
    End If
End Sub

'Added by Morgan 2019/7/9
Public Function PUB_ReadTextFile(pFileName As String, Optional pCharset As String = "big5") As String
   Dim adoStream As ADODB.Stream
   Dim var_String As Variant
  
   Set adoStream = New ADODB.Stream
   'adoStream.Charset = "UTF-8"
   adoStream.Charset = pCharset
   adoStream.Open
   adoStream.LoadFromFile pFileName
   PUB_ReadTextFile = adoStream.ReadText
   adoStream.Close
   Set adoStream = Nothing
End Function

'Added by Morgan 2019/7/9
'下載台銀匯率CSV檔
Public Function PUB_GetTwBankRate(pINet As Variant, Optional pDate As String, Optional pShowMsg As Boolean = True, Optional pErrMsg As String) As String
   
   Dim strURL As String
   Dim strFile As String
   Dim bytes() As Byte
   Dim fnum As Integer
   Dim strText As String
   Dim strDate As String
   
On Error GoTo ErrHnd
   
   If pDate <> "" Then
      strDate = Format(DBDATE(pDate), "@@@@-@@-@@")
   Else
      strDate = Format(Now, "YYYY-MM-DD")
   End If
   
   If Not IsDate(strDate) Then
      pErrMsg = "日期錯誤！"
      If pShowMsg Then MsgBox pErrMsg, vbCritical
      Exit Function
      
   ElseIf strDate > Format(Now, "YYYY-MM-DD") Then
      pErrMsg = "日期不可大於系統日！"
      If pShowMsg Then MsgBox pErrMsg, vbCritical
      Exit Function
      
   ElseIf strDate = Format(Now, "YYYY-MM-DD") And Format(Now, "HHMM") < "1600" Then
      pErrMsg = "目前尚未過 16:00，無法下載當日匯率！"
      If pShowMsg Then If pShowMsg Then MsgBox pErrMsg, vbCritical
      Exit Function
   End If
      
   strURL = "https://rate.bot.com.tw/xrt/flcsv/0/" & strDate
   
   strFile = App.path & "\TwRate.CSV"
   If Dir(strFile) <> "" Then Kill strFile
   
   DoEvents

   ' Get the file.
   'bytes() = pINet.OpenURL(strURL, icByteArray)
   bytes() = pINet.OpenURL(strURL, 1)

   ' Save the file.
   fnum = FreeFile
   Open strFile For Binary Access Write As #fnum
   Put #fnum, , bytes()
   Close #fnum
   
   ' Read the file
   strText = PUB_ReadTextFile(strFile, "UTF-8")
   If InStr(strText, "幣別,匯率,現金,即期,遠期10天,遠期30天,遠期60天,遠期90天,遠期120天,遠期150天,遠期180天,匯率,現金,即期,遠期10天,遠期30天,遠期60天,遠期90天,遠期120天,遠期150天,遠期180天") = 1 Then
      PUB_GetTwBankRate = strText
   Else
      pErrMsg = "下載失敗！"
      If pShowMsg Then MsgBox pErrMsg, vbCritical
   End If
   Exit Function
   
ErrHnd:
   If fnum <> 0 Then Close #fnum
   pErrMsg = Err.Description
   If pShowMsg Then MsgBox pErrMsg, vbCritical
   
End Function
'Added by Morgan 2019/7/9
'匯入預估結匯匯率
Public Function PUB_ImportRate(pText As String, Optional pDate As String, Optional pShowMsg As Boolean = True, Optional pErrMsg As String) As Boolean
   Dim arrRow() As String
   Dim arrCell() As String
   Dim stSQL As String, intR As Integer, ii As Integer
   Dim stDate As String
   Dim stUSDbuy As String '美金即期買入
   Dim stRMBbuy As String '人民幣即期買入
   Dim dblExRate As Double '交叉匯率
   Dim dblNewRate As Double, dblOldRate As Double, dblRateUp As Double, dblRateDn As Double
   Dim bolInTran As Boolean
   Dim rsQuery As ADODB.Recordset
   Dim stSubj As String, stContent As String, stTO As String, stCC As String, bolMail As Boolean
   Dim stData As String, stInfoDate As String, stEffDate As String
   Dim bolUpdUSD As Boolean, bolUpdRMB As Boolean, strOldRMB As String 'Added by Morgan 2022/3/30
   Dim dblOldRMBExRate As Double, dblRMBExRate As Double 'Added by Morgan 2022/9/26
   
On Error GoTo ErrHnd

   If pDate = "" Then
      stDate = strSrvDate(2)
   Else
      stDate = TransDate(pDate, 1)
   End If
     
   'Added by Morgan 2019/11/15
   If strSrvDate(1) = CompWorkDay(1, Left(strSrvDate(1), 6) & "01") Then
      dblRateUp = 0.01
      dblRateDn = 0.03
   Else
      dblRateUp = 0.02
      dblRateDn = 0.05
   End If
   stInfoDate = CompDate(2, 1, strSrvDate(1))
   stEffDate = CompWorkDay(4, stInfoDate)
   'end 2019/11/15
            
   cnnConnection.BeginTrans
   bolInTran = True
   bolMail = False 'Added by Morgan 2019/11/1
   arrRow = Split(pText, vbCrLf)
   For ii = 1 To UBound(arrRow)
      'Debug.Print arrRow(ii)
      'arrCell(0)=幣別, arrCell(3)=即期買入, arrCell(10)=遠期180天買入, arrCell(13)=即期賣出
      If arrRow(ii) <> "" Then
         arrCell = Split(arrRow(ii), ",")
         If arrCell(0) = "CNY" Then arrCell(0) = "RMB" 'Added by Morgan 2019/7/12 目前台銀人民幣代碼為CNY
         
         '檢查系統是否有設定該幣別
         stSQL = "update acc1y0 set a1y02=a1y02 where a1y01='" & arrCell(0) & "'"
         cnnConnection.Execute stSQL, intR
         If intR = 1 Then
            stSQL = "update acc210 set a2103=" & arrCell(13) & ",a2107='" & strUserNum & "',a2108=to_char(sysdate,'yyyymmdd'),a2109=to_char(sysdate,'hh24miss'),a2110=1.03" & _
               " where a2101=" & stDate & " and a2102='" & arrCell(0) & "'"
            cnnConnection.Execute stSQL, intR
            If intR = 0 Then
               stSQL = "insert into acc210(a2101,a2102,a2103,a2104,a2105,a2106,a2110)" & _
                  " values(" & stDate & ",'" & arrCell(0) & "'," & arrCell(13) & ",'" & strUserNum & "',to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss'),1.03)"
               cnnConnection.Execute stSQL, intR
            End If
            
            'Added by Morgan 2019/10/4 請款匯率
            '匯率計算基準:
            'A.美金：台灣銀行牌告180天期遠期買入匯率減2元。
            'B.歐元: 台灣銀行牌告180天期遠期買入匯率減2元
            'C.日幣：台灣銀行牌告180天遠期買入匯率減0.015元。
            'Modified by Morgan 2023/2/7
            ''D.人民幣：台灣銀行牌告180天遠期買入匯率減0.25元。(人民幣對美金的交叉匯率=人民幣即期賣出/美金即期買入--婧瑄)
            'D.人民幣：台灣銀行牌告180天遠期買入匯率減0.25元。(人民幣對美金的交叉匯率=人民幣即期買入/美金即期買入--婉莘)
            'end 2023/2/7
            'E.其他幣別依以上計算基準6%計算。
            
            '與本所目前對外FC/MC報價相比，當新臺幣升值超過1%或貶值超過3%，即進行調整,但已報價部份不在調整範圍(新臺幣升值意指匯率變低--婧瑄)
            
            'Modified by Morgan 2019/11/15 11/1 先暫停自動調整功能,11/14 決定修改如下
            '調整時點:
            '1.系統在下午4點偵測需調整
            '2.於隔日凌晨發"調整通知"
            '3.生效日為通知後的第4個工作日,EX:11/2通知,11/5生效適用
            
            '調整條件:
            '1.每月第一個工作日匯率變動在"新臺幣升值超過1%或貶值超過3%"時
            '2.當匯率急遽變動在"新臺幣升值超過2%或貶值超過5%"時
            
            'A.美金
            If arrCell(0) = "USD" Then
               stUSDbuy = arrCell(3) '美金即期買入
               stSQL = "select usxr02 from usxrate a where not exists(select * from usxrate x where x.usxr01>a.usxr01)"
               intR = 1
               Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
               If intR = 1 Then
                  dblOldRate = rsQuery(0)
                  dblNewRate = Val(arrCell(10)) - 2
                  
                  dblNewRate = Round(dblNewRate, 2) '美金取小數兩位
                  If (dblNewRate / dblOldRate) < (1 - dblRateUp) Or (dblNewRate / dblOldRate) > (1 + dblRateDn) Then
                     stSQL = "insert into usxrate(usxr01,usxr02) values(" & TransDate(stEffDate, 1) & "," & dblNewRate & ")"
                     cnnConnection.Execute stSQL, intR
                     'stData = stData & "美金:" & dblNewRate & ";"
                     stData = stData & "USD/" & dblOldRate & "-->" & dblNewRate & ";"
                     bolMail = True
                     bolUpdUSD = True 'Added by Morgan 2022/3/30
                  End If
               End If
            '其他幣別
            Else
               stSQL = "select a.*,nvl(a1y02,dnr01) CName from debitnoterate a,acc1y0 where dnr01='" & arrCell(0) & "' and a1y01(+)=dnr01" & _
                  " and not exists(select * from debitnoterate x where x.dnr01=a.dnr01 and x.dnr02>a.dnr02)"
               intR = 1
               Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
               If intR = 1 Then
                  dblExRate = 0
                  dblOldRate = rsQuery("dnr03")
                  'B.歐元-2
                  If arrCell(0) = "EUR" Then
                     dblNewRate = Val(arrCell(10)) - 2
                  'C.日幣-0.015
                  ElseIf arrCell(0) = "JPY" Then
                     dblNewRate = Val(arrCell(10)) - 0.015
                  'D.人民幣-0.25
                  ElseIf arrCell(0) = "RMB" Then
                     'Modified by Morgan 2023/2/8
                     'stRMBsell = arrCell(3) '人民幣即期賣出
                     'dblExRate = Round(Val(stRMBsell) / Val(stUSDbuy), 6) '交叉匯率與RMB同步更新
                     stRMBbuy = arrCell(3) '人民幣即期賣出
                     dblExRate = Round(Val(stRMBbuy) / Val(stUSDbuy), 6) '交叉匯率與RMB同步更新
                     'end 2023/2/8
                     dblNewRate = Val(arrCell(10)) - 0.25
                     strOldRMB = dblOldRate 'Added by Morgan 2022/3/30
                     'Added by Morgan 2022/9/26
                     dblOldRMBExRate = Val("" & rsQuery("dnr04"))
                     dblRMBExRate = dblExRate
                     'end 2022/9/26
                  'E.其他-6%
                  Else
                     dblNewRate = Val(arrCell(10)) * (1 - 0.06)
                  End If
                  
                  If (dblNewRate / dblOldRate) < (1 - dblRateUp) Or (dblNewRate / dblOldRate) > (1 + dblRateDn) Then
                     stSQL = "delete debitnoterate where dnr01='" & arrCell(0) & "' and dnr02=" & TransDate(stEffDate, 1)
                     cnnConnection.Execute stSQL, intR
                     stSQL = "insert into debitnoterate(dnr01,dnr02,dnr03,dnr04) values('" & arrCell(0) & "'," & TransDate(stEffDate, 1) & "," & dblNewRate & "," & dblExRate & ")"
                     cnnConnection.Execute stSQL, intR
                     'stData = stData & rsQuery("CName") & ":" & dblNewRate & ";"
                     stData = stData & arrCell(0) & "/" & dblOldRate & "-->" & dblNewRate & ";"
                     bolMail = True
                     If arrCell(0) = "RMB" Then bolUpdRMB = True 'Added by Morgan 2022/3/30
                  End If
               End If
            End If
'            'end 2019/10/4
         End If
      End If
   Next ii
   
   'Added by Morgan 2022/3/30
   '若美金有調整但人民幣沒調整時也要更新交叉匯率
   If bolUpdUSD And Not bolUpdRMB Then
      If dblRMBExRate <> dblOldRMBExRate Then
         stSQL = "update debitnoterate set dnr04=" & dblRMBExRate & " where dnr01='RMB' and dnr02=" & TransDate(stEffDate, 1)
         cnnConnection.Execute stSQL, intR
         If intR = 0 Then
            stSQL = "insert into debitnoterate(dnr01,dnr02,dnr03,dnr04) values('RMB'," & TransDate(stEffDate, 1) & "," & strOldRMB & "," & dblRMBExRate & ")"
            cnnConnection.Execute stSQL, intR
         End If
      End If
   End If
   'end 2022/3/30
   
   'Added by Morgan 2019/11/1
   If bolMail Then
      '對象：杜主秘;CFTFCT全部人員 <CFTFCT@taie.com.tw>; FCP承辦全部人員 <FCP_2@taie.com.tw>; 葉雪貞(jennie.特助) <67002@taie.com.tw>; 林純貞(內商.經理) <69008@taie.com.tw>; 王文安(William,經理) 88003@taie.com.tw;郭雅娟(專利處.經理);
      'Modified by Morgan 2020/1/3 非員工號要加@taie.com.tw否則outlook不會轉為群組名稱
      'Modified by Morgan 2020/3/2 取消 68006--婧瑄
      'modify by sonia 2020/5/5 取消67002
      'Modified by Morgan 2021/5/11 +86024葉敏莉--何淑華
      'Modified by Morgan 2021/11/11 林經理2021/11/15退休,改寄沈佳穎 96003 、鄭天雲 A4021
      'Modified by Morgan 2022/3/2 CFTFCT已取消，改發TM2及TM31
      'If strSrvDate(1) >= "20211115" Then
      '   stTO = "CFTFCT@taie.com.tw;FCP_2@taie.com.tw;96003;A4021;88003;79075;86024"
      'Else
      '   stTO = "CFTFCT@taie.com.tw;FCP_2@taie.com.tw;69008;88003;79075;86024"
      'End If
      'Added by Morgan 2022/11/24 88003退休改發99037
      If strSrvDate(1) >= "20221130" Then
         stTO = "TM2@taie.com.tw;TM31@taie.com.tw;FCP_2@taie.com.tw;96003;A4021;99037;79075;86024"
      Else
      'end 2022/11/24
         stTO = "TM2@taie.com.tw;TM31@taie.com.tw;FCP_2@taie.com.tw;96003;A4021;88003;79075;86024"
      End If 'Added by Morgan 2022/11/24
      'end 2022/3/2
      'end 2021/11/11
      '副本：吳婧瑄;邱秀玲
      'Modified by Morgan 2023/2/21
      'stCC = "70004;83002"
      stCC = "account;" & Pub_GetSpecMan("程式管理人員")
      
'Modified by Morgan 2019/11/15 改在主旨說明,一幣別一通知
      arrRow = Split(stData, ";")
      For ii = LBound(arrRow) To UBound(arrRow)
         If arrRow(ii) <> "" Then
            stSubj = "請款匯率調整通知: " & arrRow(ii) & "/生效日" & Format(stEffDate, "@@@@.@@.@@")
            'Added by Morgan 2022/9/27
            If dblRMBExRate <> dblOldRMBExRate And (InStr(arrRow(ii), "USD") > 0 Or InStr(arrRow(ii), "RMB") > 0) Then
               stSubj = stSubj & " [RMB對USD/" & dblOldRMBExRate & "-->" & dblRMBExRate & "]"
            End If
            'end 2022/9/27
            stSQL = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08,mc09,mc12)" & _
               " values( '" & strUserNum & "','" & stTO & "',to_char(sysdate,'yyyymmdd')" & _
               ",to_char(sysdate,'hh24miss'),'" & stSubj & "','如旨','" & stCC & "'," & stInfoDate & ")"
            cnnConnection.Execute stSQL, intR
         End If
      Next
'end 2019/11/15
   End If
   'end 2019/11/1

   cnnConnection.CommitTrans
   PUB_ImportRate = True
   
   'Removed by Morgan 2019/11/15 改隔天凌晨通知(AutoPdf)
   'PUB_SendMailCache 'Added by Morgan 2019/11/1
   
   Set rsQuery = Nothing
   Exit Function
   
ErrHnd:
   If bolInTran Then cnnConnection.RollbackTrans
   pErrMsg = Err.Description
   If pShowMsg Then MsgBox pErrMsg, vbCritical
   Set rsQuery = Nothing
End Function

'Added by Morgan 2017/11/29
'勞工退休金提繳工資調整表
Public Sub PUB_ExportSalaryUpdate(Optional pSU01 As String, Optional pSU02 As String, Optional pMail As Boolean = False, Optional pAutoBatch As Boolean = False)
   Dim stSQL As String, intR As Integer, stCon As String
   Dim rsQuery As ADODB.Recordset
   Dim strText As String, strTempFile As String, strSaveFile As String, strSaveName As String
   Dim ii As Integer, iPageNo As Integer, iRecNo As Integer, stLastComp As String
   Dim strAttList As String, strSubject As String, strContent As String
   Dim ff As Integer, stTxtFilePath As String, stFileName As String, stText As String, lngRecs As Long, bolTxtRpt As Boolean
   Dim bolUpdated As Boolean 'Added by Morgan 2024/7/30
   
On Error GoTo ErrHandle

   bolTxtRpt = False
   stCon = ""
   If pSU01 <> "" Then
      stCon = stCon & " and su01='" & pSU01 & "'"
   End If
   
   If pSU02 <> "" Then
      stCon = stCon & " and su02=" & DBDATE(pSU02)
   Else
      'Modified by Morgan 2023/3/29 辜會提早輸異動,加只抓當月的條件
      'Added by Morgan 2024/11/29 若月初才跑,改5號前抓上月的異動
      If Right(strSrvDate(1), 2) < "05" Then
         stCon = stCon & " and su02>=" & CompDate(1, -1, Left(strSrvDate(1), 6) & "01") & " and su02<" & Left(strSrvDate(1), 6) & "01"
      Else
      'end 2024/11/29
         stCon = stCon & " and su02>=" & Left(strSrvDate(1), 6) & "01 and su02<=" & Left(strSrvDate(1), 6) & "31"
      End If
   End If
   
   'Modified by Morgan 2019/9/9 調整語法，修正多檔輸出問題
   'Modified by Morgan 2019/9/26 只抓在職
   'Modify By Sindy 2020/6/25 + 證照津貼
   'Modified by Morgan 2024/7/30 薪資異動應該要先抓SL18特殊退休金投保薪資,且若薪資基本已更新時要改抓薪資前次的薪資異動(修改薪資異動)
   'stSQL = "SELECT su01,st02 員工,st26 身分證號,st23 出生日,sd19 公司別" & _
      ",NVL(SD27,NVL(SD43,0)) 原投保薪資,a.si02 原月提繳工資" & _
      ",NVL(SL11,0)+NVL(SL12,0)+NVL(SL39,0)+NVL(SL14,0) 調整後投保薪資,c.si02 調整後月提繳工資" & _
      ",a0824,a0802" & _
      " From salaryupdate, salarydata, salarylog, SalaryInsurance a, SalaryInsurance c, staff,acc080" & _
      " where su03='2'" & stCon & _
      " and sd01(+)=su01 and sd16='Y' and sl01(+)=su01 and sl02(+)=su02" & _
      " and a.si01(+)='R' and a.si03<=NVL(SD27,NVL(SD43,0)) and a.si04>=NVL(SD27,NVL(SD43,0))" & _
      " and c.si01(+)='R' and c.si03<=NVL(SL11,0)+NVL(SL12,0)+NVL(SL39,0)+NVL(SL14,0) and c.si04>=NVL(SL11,0)+NVL(SL12,0)+NVL(SL39,0)+NVL(SL14,0)" & _
      " and c.si02<>a.si02 and st01(+)=su01 and st04='1' and a0801(+)=sd19" & _
      " order by sd19,a.si02,st26"
   bolUpdated = False
   '若薪資基本已更新時要改抓薪資前次的薪資異動
   If pSU01 <> "" And pSU02 <> "" Then
      stSQL = "select * from salaryupdate where su03='2' and su01='" & pSU01 & "' and su02=" & DBDATE(pSU02) & " and su05>0"
      intR = 1
      Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         bolUpdated = True
      End If
   End If
   If bolUpdated Then
      'Modified by Morgan 2025/5/20 語法修正
      stSQL = "SELECT su01,st02 員工,st26 身分證號,st23 出生日,sd19 公司別" & _
         ",NVL(SD27,NVL(SD43,0)) 原投保薪資,a.si02 原月提繳工資" & _
         ",NVL(SL11,0)+NVL(SL12,0)+NVL(SL39,0)+NVL(SL14,0) 調整後投保薪資,c.si02 調整後月提繳工資" & _
         ",a0824,a0802" & _
         " From salaryupdate,(select SL01 SD01,SD16,SD19, SL18 SD27,NVL(SL11,0)+NVL(SL12,0)+NVL(SL39,0)+NVL(SL14,0) SD43 from salarydata,salarylog" & _
         " where sd01='" & pSU01 & "' and sl01(+)=sd01 and sl02=(select max(sl02) from salarylog where sl01='" & pSU01 & "' and sl02<" & DBDATE(pSU02) & ")" & _
         ") s, salarylog, SalaryInsurance a, SalaryInsurance c, staff,acc080" & _
         " where su03='2'" & stCon & _
         " and sd01(+)=su01 and sd16='Y' and sl01(+)=su01 and sl02(+)=su02" & _
         " and a.si01(+)='R' and a.si03<=NVL(SD27,NVL(SD43,0)) and a.si04>=NVL(SD27,NVL(SD43,0))" & _
         " and c.si01(+)='R' and c.si03<=NVL(SL18,NVL(SL11,0)+NVL(SL12,0)+NVL(SL39,0)+NVL(SL14,0)) and c.si04>=NVL(SL18,NVL(SL11,0)+NVL(SL12,0)+NVL(SL39,0)+NVL(SL14,0))" & _
         " and c.si02<>a.si02 and st01(+)=su01 and st04='1' and a0801(+)=sd19" & _
         " order by sd19,a.si02,st26"
   Else
      stSQL = "SELECT su01,st02 員工,st26 身分證號,st23 出生日,sd19 公司別" & _
         ",NVL(SD27,NVL(SD43,0)) 原投保薪資,a.si02 原月提繳工資" & _
         ",NVL(SL11,0)+NVL(SL12,0)+NVL(SL39,0)+NVL(SL14,0) 調整後投保薪資,c.si02 調整後月提繳工資" & _
         ",a0824,a0802" & _
         " From salaryupdate, salarydata, salarylog, SalaryInsurance a, SalaryInsurance c, staff,acc080" & _
         " where su03='2'" & stCon & _
         " and sd01(+)=su01 and sd16='Y' and sl01(+)=su01 and sl02(+)=su02" & _
         " and a.si01(+)='R' and a.si03<=NVL(SD27,NVL(SD43,0)) and a.si04>=NVL(SD27,NVL(SD43,0))" & _
         " and c.si01(+)='R' and c.si03<=NVL(SL18,NVL(SL11,0)+NVL(SL12,0)+NVL(SL39,0)+NVL(SL14,0)) and c.si04>=NVL(SL18,NVL(SL11,0)+NVL(SL12,0)+NVL(SL39,0)+NVL(SL14,0))" & _
         " and c.si02<>a.si02 and st01(+)=su01 and st04='1' and a0801(+)=sd19" & _
         " order by sd19,a.si02,st26"
   End If
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      If pSU01 <> "" Then
         strSubject = rsQuery("員工") & "(" & rsQuery("su01") & ")勞工退休金提繳工資調整表"
         strContent = "如旨"
      Else
         strSubject = Format(Left(strSrvDate(2), 5), "@@@/@@") & "勞工退休金提繳工資調整表"
         strContent = Format(Left(strSrvDate(2), 5), "@@@/@@") & "共有 " & rsQuery.RecordCount & " 筆薪資調整資料需申報！"
         
         'Added by Morgan 2019/9/10
         bolTxtRpt = True
         stFileName = "勞工退休金提繳工資調整表"
         lngRecs = 0
         
         If ff > 0 Then Close #ff
         ff = FreeFile
         stTxtFilePath = App.path & "\" & stFileName & ".txt"
         Open stTxtFilePath For Output As ff
         Print #ff, Space(25) & stFileName
         Print #ff, ""
         Print #ff, "日期：" & Format(strSrvDate(2), "###/##/##")
         Print #ff, ""
         Print #ff, "員工          公司 原投保薪資 原月提繳工資 調整後投保薪資 調整後月提繳工資"
         Print #ff, "------------- ---- ---------- ------------ -------------- ----------------"
         
         strAttList = stTxtFilePath & "*"
         'end 2019/9/10
      End If
      
      strTempFile = App.path & "\$勞工退休金提繳工資調整表.doc"
      If Dir(strTempFile) <> "" Then
         Kill strTempFile
      End If
      
      'Modified by Morgan 2019/9/9 不必寄第2頁(分級表&信封)--辜
      If PUB_ReadDB2File(strTempFile, 1, "M21") = False Then
         MsgBox "勞工退休金提繳工資調整表.doc下載失敗！", vbCritical
         Exit Sub
      End If
      
      strSaveName = "勞工退休金提繳工資調整表"
      strSaveFile = App.path & "\" & strSaveName
      If Dir(strSaveFile & "*.doc") <> "" Then
         Kill strSaveFile & "*.doc"
      End If
      
      If TypeName(g_WordAp) <> "Application" Then
         Set g_WordAp = New Word.Application
      End If
      With g_WordAp
      .Visible = True
      stLastComp = ""
      Do While Not rsQuery.EOF
         
         'Added by Morgan 2019/9/10
         If bolTxtRpt Then
            lngRecs = lngRecs + 1
            stText = ""
            With rsQuery
            stText = stText & convForm(.Fields("員工"), 13)
            stText = stText & " " & convForm(.Fields("公司別"), 4)
            stText = stText & " " & Right(String(10, " ") & .Fields("原投保薪資"), 10)
            stText = stText & " " & Right(String(10, " ") & .Fields("原月提繳工資"), 12)
            stText = stText & " " & Right(String(10, " ") & .Fields("調整後投保薪資"), 14)
            stText = stText & " " & Right(String(10, " ") & .Fields("調整後月提繳工資"), 16)
            End With
            Print #ff, stText
         End If
         'end 2019/9/10
         
         '檔名要加公司別
         If stLastComp <> rsQuery("公司別") Then
            If stLastComp <> "" Then
               If iPageNo = 1 Then
                  strSaveFile = App.path & "\" & strSaveName & ".doc"
               Else
                  strSaveFile = App.path & "\" & strSaveName & "_" & Format(iPageNo, "000") & ".doc"
               End If
               .ActiveDocument.SaveAs strSaveFile
               .ActiveDocument.Close wdDoNotSaveChanges
               strAttList = strAttList & strSaveFile & "*"
            End If
         
            stLastComp = rsQuery("公司別")
            strSaveName = "勞工退休金提繳工資調整表" & strSrvDate(2) & IIf(pSU01 <> "", "(" & pSU01 & ")", "(" & stLastComp & ")")
            strSaveFile = App.path & "\" & strSaveName
            iPageNo = 0
            iRecNo = 0
         End If
         
         iRecNo = iRecNo + 1
         '每一頁的第一筆要印表頭
         If iRecNo Mod 5 = 1 Then
            '超過一頁檔名加序號
            If iPageNo > 0 Then
               strSaveFile = App.path & "\" & strSaveName & "_" & Format(iPageNo, "000") & ".doc"
               .ActiveDocument.SaveAs strSaveFile
               .ActiveDocument.Close wdDoNotSaveChanges
               strAttList = strAttList & strSaveFile & "*"
            End If
            
            iPageNo = iPageNo + 1
            .Documents.Open FileName:=strTempFile, ReadOnly:=True
            '表頭
            strText = "" & rsQuery.Fields("a0824") '勞工保險證號
            If strText <> "" Then
               .ActiveDocument.Shapes("Text Box 53").Select
               .Selection.HomeKey
               .Selection.TypeText Mid(strText, 1, 1)
               For ii = 2 To Len(strText)
                  .Selection.MoveRight Unit:=wdCharacter, Count:=1 '右移一格
                  .Selection.TypeText Mid(strText, ii, 1)
               Next
            End If
            .Selection.HomeKey Unit:=wdStory
            .Selection.Find.ClearFormatting
            If .Selection.Find.Execute(" ：") = True Then
               .Selection.MoveRight Unit:=wdCharacter, Count:=1 '右移一格
               strText = "" & rsQuery("a0802")
               'Modified by Morgan 2020/5/29
               'If rsQuery("公司別") = "1" Then
               '   strText = strText & "(林景郁商標代理人)"
               'ElseIf rsQuery("公司別") = "2" Then
               '   strText = strText & "(桂齊恆專利代理人)"
               If rsQuery("公司別") = "2" Then
                  strText = strText & "(林景郁專利師)"
               ElseIf rsQuery("公司別") = "L" Then
                  'Modified by Morgan 2023/7/6
                  'strText = strText & "(桂齊恆律師)"
                  strText = strText & "(江郁仁律師)"
                  'end 2023/7/6
               'end 2020/5/29
               End If
               .Selection.Delete Unit:=wdCharacter, Count:=GetTextLength(strText)
               .Selection.TypeText Text:=strText
            End If
            If .Selection.Find.Execute("民國") = True Then
               .Selection.MoveRight Unit:=wdCharacter, Count:=1 '右移一格
               strText = strSrvDate(2) \ 10000
               .Selection.Delete Unit:=wdCharacter, Count:=GetTextLength(strText)
               .Selection.TypeText Text:=strText
            End If
            If .Selection.Find.Execute("年") = True Then
               .Selection.MoveRight Unit:=wdCharacter, Count:=1 '右移一格
               strText = Right(strSrvDate(2), 4) \ 100
               .Selection.Delete Unit:=wdCharacter, Count:=GetTextLength(strText)
               .Selection.TypeText Text:=strText
            End If
            If .Selection.Find.Execute("月") = True Then
               .Selection.MoveRight Unit:=wdCharacter, Count:=1 '右移一格
               strText = Right(strSrvDate(2), 2)
               .Selection.Delete Unit:=wdCharacter, Count:=GetTextLength(strText)
               .Selection.TypeText Text:=strText
            End If
            If .Selection.Find.Execute("日") = True Then
               .Selection.MoveRight Unit:=wdCharacter, Count:=1 '右移一格
               strText = Format(iPageNo, "000")
               .Selection.Delete Unit:=wdCharacter, Count:=GetTextLength(strText)
               .Selection.TypeText Text:=strText
            End If
            
            If .Selection.Find.Execute("單位地址：") = True Then
               .Selection.MoveRight Unit:=wdCharacter, Count:=1 '右移一格
               strText = "台北市中山區朱園里7鄰長安東路二段112號9樓"
               .Selection.TypeText Text:=strText
            End If
            If .Selection.Find.Execute("聯絡電話：") = True Then
               .Selection.MoveRight Unit:=wdCharacter, Count:=1 '右移一格
               strText = "(02)25061023"
               .Selection.TypeText Text:=strText
            End If
            .Selection.HomeKey Unit:=wdStory
            If .Selection.Find.Execute("備     註") = False Then
               Exit Sub
            End If
         End If
         '姓名...
         .Selection.MoveRight Unit:=wdCharacter, Count:=3 '右移一格
         strText = "" & rsQuery.Fields("員工")
         .Selection.TypeText Text:=strText
         strText = "" & rsQuery.Fields("身分證號")
         .Selection.MoveRight Unit:=wdCharacter, Count:=1 '右移一格
         .Selection.TypeText Mid(strText, 1, 1)
         For ii = 2 To Len(strText)
            .Selection.MoveRight Unit:=wdCharacter, Count:=1 '右移一格
            .Selection.TypeText Mid(strText, ii, 1)
         Next
         strText = "" & rsQuery.Fields("出生日")
         strText = (strText \ 10000 - 1911) & "年" & Mid(strText, 5, 2) & "月" & Right(strText, 2) & "日"
         .Selection.MoveRight Unit:=wdCharacter, Count:=1 '右移一格
         .Selection.EndKey Unit:=wdLine, Extend:=wdExtend
         .Selection.TypeText strText
         
         strText = "" & rsQuery.Fields("原月提繳工資")
         strText = Format(strText, DDollar)
         .Selection.MoveRight Unit:=wdCharacter, Count:=1 '右移一格
         .Selection.TypeText strText

         strText = "" & rsQuery.Fields("調整後月提繳工資")
         strText = Format(strText, DDollar)
         .Selection.MoveRight Unit:=wdCharacter, Count:=1 '右移一格
         .Selection.TypeText strText
         rsQuery.MoveNext
      Loop
      
      'Added by Morgan 2019/9/10
      If bolTxtRpt Then
         Print #ff, "------------- ---- ---------- ------------ -------------- ----------------"
         Print #ff, "共" & lngRecs & "筆"
         Close ff
         ff = 0
      End If
      'end 2019/9/10
      
      If iPageNo = 1 Then
         strSaveFile = App.path & "\" & strSaveName & ".doc"
         
      Else
         strSaveFile = App.path & "\" & strSaveName & "_" & Format(iPageNo, "000") & ".doc"
      End If
      .ActiveDocument.SaveAs strSaveFile
      .ActiveDocument.Close wdDoNotSaveChanges
      strAttList = strAttList & strSaveFile
      End With
      g_WordAp.Quit wdDoNotSaveChanges

      If pMail Then
         'Modified by Morgan 2019/9/4 婧蓉要退休,通知信改發劉經理,等新人接手後再改
         'Modified by Morgan 2019/10/30 改寄財處指定人員(目前為71005)，確認內容無誤後再自行轉寄給人事--辜
         'Modified by Morgan 2024/3/4 收信人改抓系統特殊設定 "試用期滿追蹤薪資人員"
         'PUB_SendMail strUserNum, "71005", "", strSubject, strContent, , strAttList, , , , , , , , True
         PUB_SendMail strUserNum, Pub_GetSpecMan("試用期滿追蹤薪資人員"), "", strSubject, strContent, , strAttList, , , , , , , , True
      End If
      
      strSaveFile = App.path & "\勞工退休金提繳工資調整表"
      If Dir(strSaveFile & "*.*") <> "" Then
         Kill strSaveFile & "*.*"
      End If
      
   ElseIf pSU01 = "" And pMail Then
      strSubject = Format(Left(strSrvDate(2), 5), "@@@/@@") & "勞工退休金提繳工資調整表"
      strContent = Format(Left(strSrvDate(2), 5), "@@@/@@") & "無薪資調整資料需申報！"
      'Modified by Morgan 2019/10/30 改寄財處指定人員(目前為71005)，確認內容無誤後再自行轉寄給人事--辜
      'Modified by Morgan 2024/3/4 收信人改抓系統特殊設定 "試用期滿追蹤薪資人員"
      'PUB_SendMail strUserNum, "71005", "", strSubject, strContent, , , , , , , , , , True
      PUB_SendMail strUserNum, Pub_GetSpecMan("試用期滿追蹤薪資人員"), "", strSubject, strContent, , , , , , , , , , True
   End If
   
ErrHandle:
   If Err.Number <> 0 Then
      If pAutoBatch Then
         WLog "每月勞工退休金提繳工資調整表:" & Err.Description
      Else
         MsgBox Err.Description, vbCritical
      End If
   End If
   If ff > 0 Then Close #ff: ff = 0
   Set rsQuery = Nothing
End Sub

'Added by Morgan 2019/9/10
'勞健保二合一(2~7月調薪於8/20 通知,8~1月調薪於2/20 通知,退休金固定次月就申報不再列入)
Public Sub PUB_ExportSalaryUpdate2(Optional pTxtPath As String = "\", Optional pAutoBatch As Boolean = False)
   Dim stSQL As String, intR As Integer, stCon As String
   Dim rsQuery As ADODB.Recordset
   Dim ff As Integer
   Dim strAttList As String, strSubject As String, strContent As String
   Dim tmpnext As String
   Dim lngRecs As Long
   Dim stFileName As String, stTxtFilePath As String
   
   'Added by Morgan 2019/9/23
   Dim stLastComp As String
   Dim strTempFile As String, stXLSFileName As String, stXLSFullPath As String
   Dim iRow As Integer
   'Dim xlsReport As New Excel.Application
   'Dim wksReport As New Worksheet
   Dim xlsReport
   Dim wksReport
   
On Error GoTo ErrHandle

   stCon = ""
   '8月份後跑2-7月調薪,否則跑8-1月調薪
   If Right(strSrvDate(1), 4) > "0800" Then
      stCon = " and su02>" & Left(strSrvDate(1), 4) & "0200" & " and su02<" & Left(strSrvDate(1), 4) & "0800"
      stFileName = (Left(strSrvDate(1), 4) - 1911) & "年2~7月勞健保薪資調整表"
   Else
      stCon = " and su02>" & (Left(strSrvDate(1), 4) - 1) & "0800" & " and su02<" & Left(strSrvDate(1), 4) & "0200"
      stFileName = ((Left(strSrvDate(1), 4) - 1) - 1911) & "年8~" & (Left(strSrvDate(1), 4) - 1911) & "年1月勞健保薪資調整表"
   End If
   
   '抓最新異動
   'Modified by Morgan 2019/9/26 只抓在職
   'Modified by Morgan 2020/2/20 勞/健保投保薪資要先抓特殊
   'Modify By Sindy 2020/6/25 + 證照津貼
   'Modified by Morgan 2024/4/26
   '113/1 薪資異動調整午餐津貼勞保已退休同仁勞保特殊投保薪資設0導致勞保級距抓不到資料而未列出(健保有跨級)
   '113/4/26人事確認有投保職災所以還是有投保薪資只是沒有勞保費,因此勞保特殊投保薪資不可設0
   stSQL = "SELECT su01||decode(sd16,'Y',' ','*')||substr(st02,1,3) 員工" & _
      ",sd19 公司別" & _
      ",NVL(sd13,SD45) 原投保薪資" & _
      ",a.si02 原勞保級數" & _
      ",SD14 原勞保費" & _
      ",b.si02 原健保級數" & _
      ",SD15 原健保費" & _
      ",NVL(SL08,NVL(SL11,0)+NVL(SL12,0)+NVL(SL39,0)+NVL(SL14,0)) 新投保薪資" & _
      ",c.si02 新勞保級數" & _
      ",SL09 新勞保費" & _
      ",d.si02 新健保級數" & _
      ",SL10 新健保費" & _
      ",st02,st23,st24,st26,a0821,a0824 From salaryupdate x, staff, salarydata, salarylog" & _
      ",SalaryInsurance a,SalaryInsurance b" & _
      ",SalaryInsurance c,SalaryInsurance d" & _
      ",acc080 where su03='3'" & stCon & _
      " and not exists(select * from salaryupdate y where y.su01=x.su01 and y.su03=x.su03 and y.su02>x.su02)" & _
      " and sd01(+)=su01 and sl01(+)=su01 and sl02(+)=su02" & _
      " and st01(+)=su01 and st04='1'" & _
      " and a.si01(+)='L' and a.si03(+)<=nvl(sd12,sd45) and a.si04(+)>=nvl(sd12,sd45)" & _
      " and b.si01(+)='H' and b.si03(+)<=nvl(sd13,sd45) and b.si04(+)>=nvl(sd13,sd45)" & _
      " and c.si01(+)='L' and c.si03(+)<=NVL(SL07,NVL(SL11,0)+NVL(SL12,0)+NVL(SL39,0)+NVL(SL14,0)) and c.si04(+)>=NVL(SL07,NVL(SL11,0)+NVL(SL12,0)+NVL(SL39,0)+NVL(SL14,0))" & _
      " and d.si01(+)='H' and d.si03(+)<=NVL(SL08,NVL(SL11,0)+NVL(SL12,0)+NVL(SL39,0)+NVL(SL14,0)) and d.si04(+)>=NVL(SL08,NVL(SL11,0)+NVL(SL12,0)+NVL(SL39,0)+NVL(SL14,0))" & _
      " and b.si02<>d.si02 and a0801(+)=sd19 order by sd19,d.si02,st26"
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      strTempFile = App.path & "\$勞健退三合一批次上傳媒體檔.xls"
      If PUB_ReadDB2File(strTempFile, 2, "M21") = False Then
         MsgBox "勞健退三合一批次上傳媒體檔.xls下載失敗！", vbCritical
         Exit Sub
      End If
      
      Set xlsReport = CreateObject("Excel.Application")
      xlsReport.Visible = True
      
      With rsQuery
      .MoveFirst
      If ff > 0 Then Close #ff
      ff = FreeFile
      stTxtFilePath = App.path & pTxtPath & stFileName & ".txt"
      Open stTxtFilePath For Output As ff
      Print #ff, Space(40) & stFileName
      Print #ff, ""
      Print #ff, "日期：" & Format(strSrvDate(2), "###/##/##")
      Print #ff, ""
      Print #ff, "員工(*舊制)   公司 原投保薪資 原勞保級數 原勞保費 原健保級數 原健保費 新投保薪資 新勞保級數 新勞保費 新健保級數 新健保費"
      Print #ff, "------------- ---- ---------- ---------- -------- ---------- -------- ---------- ---------- -------- ---------- --------"
      
      strAttList = stTxtFilePath & "*"
      
      lngRecs = 0
      tmpnext = "開檔中..."
      Do While Not .EOF
         lngRecs = lngRecs + 1
         strContent = ""
         strContent = strContent & convForm(.Fields("員工"), 13)
         strContent = strContent & " " & convForm(.Fields("公司別"), 4)
         strContent = strContent & " " & Right(String(10, " ") & .Fields("原投保薪資"), 10)
         strContent = strContent & " " & Right(String(10, " ") & .Fields("原勞保級數"), 10)
         strContent = strContent & " " & Right(String(10, " ") & .Fields("原勞保費"), 8)
         strContent = strContent & " " & Right(String(10, " ") & .Fields("原健保級數"), 10)
         strContent = strContent & " " & Right(String(10, " ") & .Fields("原健保費"), 8)
         strContent = strContent & " " & Right(String(10, " ") & .Fields("新投保薪資"), 10)
         strContent = strContent & " " & Right(String(10, " ") & .Fields("新勞保級數"), 10)
         strContent = strContent & " " & Right(String(10, " ") & .Fields("新勞保費"), 8)
         strContent = strContent & " " & Right(String(10, " ") & .Fields("新健保級數"), 10)
         strContent = strContent & " " & Right(String(10, " ") & .Fields("新健保費"), 8)
         
         tmpnext = "寫檔..."
         Print #ff, strContent
         
         'XLS
         If stLastComp <> rsQuery("公司別") Then
            iRow = 1
            If stLastComp <> "" Then
               xlsReport.Workbooks(1).SaveAs stXLSFullPath
               xlsReport.Workbooks.Close
               
               strAttList = strAttList & stXLSFullPath & "*"
            End If
            
            stLastComp = rsQuery("公司別")
            stXLSFileName = "勞健退三合一批次上傳媒體檔(" & stLastComp & ").xls"
            stXLSFullPath = App.path & pTxtPath & stXLSFileName
            xlsReport.Workbooks.Open strTempFile
            Set wksReport = xlsReport.Worksheets(1)
            wksReport.Cells.NumberFormatLocal = "@"
         End If
         
         
         iRow = iRow + 1
         '異動別
         wksReport.Range("A" & iRow) = "3"
         '勞工保險證號(8位數字)
         wksReport.Range("B" & iRow) = Left(.Fields("a0824"), 8)
         '勞工保險證號檢查碼(1位英文)
         wksReport.Range("C" & iRow) = Mid(.Fields("a0824"), 9, 1)
         '健保投保單位代號(9位數字)
         wksReport.Range("D" & iRow) = .Fields("a0821")
         '健保業務組別
         wksReport.Range("E" & iRow) = "1"
         '被保險人(外籍專用)
         If .Fields("st24") = "F" Then
            wksReport.Range("F" & iRow) = "Y"
         Else
            wksReport.Range("F" & iRow) = ""
         End If
         '被保險人姓名
         wksReport.Range("G" & iRow) = .Fields("st02")
         '被保險人身分證號(勞保專用)
         wksReport.Range("H" & iRow) = .Fields("st26")
         '被保險人身分證號(健保專用)(外籍專用)
         If .Fields("st24") = "F" Then
            wksReport.Range("I" & iRow) = .Fields("st26")
         Else
            wksReport.Range("I" & iRow) = ""
         End If
         '被保險人出生日期(例如：0620301)
         wksReport.Range("J" & iRow) = Format(.Fields("st23") - 19110000, "0000000")
         '調後月實際工資(勞保、勞退用)
         wksReport.Range("K" & iRow) = .Fields("新投保薪資")
         '健保調前投保薪資
         wksReport.Range("L" & iRow) = .Fields("原健保級數")
         '健保調後投保薪資
         wksReport.Range("M" & iRow) = .Fields("新健保級數")
         '特殊身分別
         wksReport.Range("N" & iRow) = ""
         .MoveNext
      Loop
      Print #ff, "------------- ---- ---------- ---------- -------- ---------- -------- ---------- ---------- -------- ---------- --------"
      Print #ff, "共" & lngRecs & "筆"
      Close ff
      ff = 0
      
      xlsReport.Workbooks(1).SaveAs stXLSFullPath
      xlsReport.Workbooks.Close
      xlsReport.Quit
      
      strAttList = strAttList & stXLSFullPath
      
      
      strSubject = stFileName & "(" & Format(strSrvDate(2) \ 100, "###/##") & ")"
      strContent = "如旨"
      
      '婧蓉要退休,通知信改發劉經理,等新人接手後再改
      'Modified by Morgan 2019/10/30 改寄財處指定人員(目前為 71005)，確認內容無誤後再自行轉寄給人事--辜
      'Modified by Morgan 2024/3/4 收信人改抓系統特殊設定 "試用期滿追蹤薪資人員"
      'PUB_SendMail strUserNum, "71005", "", strSubject, strContent, , strAttList, , , , , , , , True
      PUB_SendMail strUserNum, Pub_GetSpecMan("試用期滿追蹤薪資人員"), "", strSubject, strContent, , strAttList, , , , , , , , True
On Error Resume Next
      Kill stTxtFilePath
      Kill App.path & pTxtPath & "勞健退三合一批次上傳媒體檔*.xls"
      End With
   End If
   
ErrHandle:
   If Err.Number <> 0 Then
      If pAutoBatch Then
         WLog stFileName & "-" & tmpnext & ":" & Err.Description
      Else
         MsgBox Err.Description, vbCritical
      End If
   End If
   
   If ff > 0 Then Close #ff: ff = 0
   Set rsQuery = Nothing
   Set wksReport = Nothing
   Set xlsReport = Nothing
End Sub

'Added by Lydia 2019/12/12 查名單: 近似本所案核可後,控管出名代理人
Public Function Pub_ChkTQD11(ByVal pNoList As String, ByRef outAns As String) As String
Dim intJ As Integer
Dim rsB As New ADODB.Recordset
Dim strTempB As String
Dim strChkList As String

     Pub_ChkTQD11 = ""
     outAns = ""
     If pNoList = "" Then Exit Function

     If Left(pNoList, 1) = "H" Then
         strTempB = "SELECT TQD01,TQD02,TQD03,TQD04,TQD11,TQC02 From TMQDETAIL, TMQCASEMAP"
         If Left(pNoList, 2) = "HM" Then '查名->申請編號
            strTempB = strTempB & " WHERE TQD01 IN (" & IIf(InStr(pNoList, "'") > 0, "'" & pNoList & "'", GetAddStr(pNoList)) & ")"
         Else
            strTempB = strTempB & " WHERE TQD02 IN (" & IIf(InStr(pNoList, "'") > 0, "'" & pNoList & "'", GetAddStr(pNoList)) & ")"
         End If
         'Modified by Lydia 2023/08/18 +排除記錄
         strTempB = strTempB & " AND TQD02=TQC03(+) and tqc03<>'" & cntTQC自動記錄 & "' "
     Else  '收文號
         strTempB = "SELECT TQD01,TQD02,TQD03,TQD04,TQD11,TQC02 From TMQCASEMAP,TMQDETAIL"
         strTempB = strTempB & " WHERE TQC02 IN (" & IIf(InStr(pNoList, "'") > 0, "'" & pNoList & "'", GetAddStr(pNoList)) & ")"
         'Modified by Lydia 2023/08/18 +排除記錄
         strTempB = strTempB & " AND TQC03=TQD02(+) and tqc03<>'" & cntTQC自動記錄 & "' "
     End If
     strTempB = strTempB & " AND TQD11 IS NOT NULL ORDER BY TQD11"
     intJ = 1
     Set rsB = ClsLawReadRstMsg(intJ, strTempB)
     If intJ = 1 Then
        rsB.MoveFirst
        Do While Not rsB.EOF
            If "" & rsB.Fields("TQC02") <> "" Then  '逐筆抓收文號
                If strChkList = "" Then
                    strChkList = "," & rsB.Fields("TQC02")
                ElseIf InStr(strChkList, rsB.Fields("TQC02")) = 0 Then
                    strChkList = strChkList & "," & rsB.Fields("TQC02")
                End If
            End If
            If outAns = "" Then  '逐筆抓是否出名
                outAns = "" & rsB.Fields("TQD11")
            ElseIf outAns <> "" & rsB.Fields("TQD11") Then
                outAns = outAns & "," & rsB.Fields("TQD11")
            End If
            rsB.MoveNext
        Loop
        Pub_ChkTQD11 = strChkList
     End If
     
End Function

'Added by Morgan 2019/12/16
'是否領證一併請核對已准專利
'Removed by Morgan 2025/8//11 已併入PUB_Get601605SpecDN
'Public Function PUB_If601Plus926(ByVal pFNo As String, Optional ByVal pPA01 As String, Optional ByVal pPA02 As String, Optional ByVal pPA03 As String, Optional ByVal pPA04 As String, Optional ByRef p926CP09 As String) As Boolean
'   Dim stSQL As String, intQ As Integer
'   Dim rsQuery As ADODB.Recordset
'   'Modified by Morgan 2020/3/25 +Y48526 --Franny
'   'Modified by Morgan 2021/3/4 +Y52418 --Franny
'   If InStr("Y52709000,Y27696000,Y48526000,Y52418000", Left(pFNo, 8)) > 0 Then
'      PUB_If601Plus926 = True
'      If pPA02 <> "" Then
'         stSQL = "select cp09 from caseprogress where cp01='" & pPA01 & "' and cp02='" & pPA02 & "' and cp03='" & pPA03 & "' and cp04='" & pPA04 & "' and cp10='926' and cp57 is null and cp60 is null"
'         intQ = 1
'         Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
'         If intQ = 1 Then
'            p926CP09 = rsQuery("cp09")
'         End If
'      End If
'   End If
'   Set rsQuery = Nothing
'End Function

'Added by Lydia 2020/01/15 行事曆提醒成員檔(非外專),檢查是否有符合條件的行事曆期限需提醒
Public Function PUB_CheckStaffCalendarDue() As Boolean
Dim stSQL As String, intQ As Integer
Dim rsQuery As ADODB.Recordset
     
     PUB_CheckStaffCalendarDue = False
     
     stSQL = "select * from staff_calendar_member where scm01='" & strUserNum & "' "
     intQ = 1
     Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
     If intQ = 1 Then
         '上午、下午第一次連線時, 自動執行
         stSQL = "select * from executelog where el01='frm060209' and el02='" & strUserNum & "' and el03=" & strSrvDate(1) & " and el04>=decode(sign(to_char(sysdate,'hh24')-12),1,130000,0)"
         intQ = 1
         Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
         If intQ <> 1 Then
            '管制日期預設抓系統日前、後2個工作天
            stSQL = " and sc01>=" & CompWorkDay(3, strSrvDate(1), 1) & " and sc01<=" & CompWorkDay(3, strSrvDate(1))
            '當天之前未解除的行事曆一併出現
            stSQL = "((sc18 is null " & stSQL & ") or (sc18 is null and sc01<=" & strSrvDate(1) & ")) "
            stSQL = "select sc01,sc02,sc03 from staff_calendar where" & stSQL & _
                        "and instr(sc03,'" & strUserNum & "') > 0 "
            stSQL = stSQL & "order by 1,2,3 "
            intQ = 1
            Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
            If intQ = 1 Then
                 PUB_CheckStaffCalendarDue = True
            End If
         End If
     End If
     
     Set rsQuery = Nothing
     
End Function

'Added by Morgan 2020/1/16
'讀取客戶檔欄位值
'Modified by Lydia 2024/04/17 +pType
Public Function PUB_GetCustomerValue(ByVal pCU0102 As String, ByVal PColName As String, Optional ByVal pType As String) As String
   Dim stCU01 As String, stCU02 As String
   Dim stSQL As String, iQ As Integer
   Dim RsQ As ADODB.Recordset
   
   If Len(pCU0102) = 9 Then
      stCU01 = Left(pCU0102, 8)
      stCU02 = Right(pCU0102, 1)
   Else
      stCU01 = Left(pCU0102 & "000", 8)
      stCU02 = "0"
   End If
   
   stSQL = "select " & PColName & " from customer where cu01='" & stCU01 & "' and cu02='" & stCU02 & "'"
   iQ = 1
   Set RsQ = ClsLawReadRstMsg(iQ, stSQL)
   If iQ = 1 Then
      PUB_GetCustomerValue = "" & RsQ(0)
      'Added by Lydia 2024/04/17
      If pType = "CU15" Then
         Select Case "" & RsQ(0)
            Case "0": PUB_GetCustomerValue = "台端"
            Case "1": PUB_GetCustomerValue = "貴公司"
            Case Else: PUB_GetCustomerValue = "貴單位"
         End Select
      End If
      'end 2024/04/17
   End If
   Set RsQ = Nothing
End Function

'Added by Lydia 2020/01/20  傳入檔案完整路徑，直接上傳到原始檔區；(批次作業：櫃台收文frm010005、客戶提供文件frm060120、工程師上傳作業frm090905)
Public Function PUB_UploadCPFfile(ByVal pType As String, ByVal pFrmPath As String, ByVal pCP01 As String, ByVal pCP02 As String, ByVal pCP03 As String, ByVal pCP04 As String, ByVal pCP10 As String, _
                 Optional ByRef pCP09 As String, Optional ByVal pCP05 As String = "19221111", Optional ByVal pStiu As String = "", Optional ByVal bKillSource As Boolean = True, Optional ByRef outMsgTxt As String, _
                 Optional ByRef outFinalName As String) As Boolean
'pType  : 0=Typing2批次搬檔, 1=預設FCP承辦人, 2=預設操作者
'pFrmPath　傳入檔案完整路徑
'pCP01~pCP04　傳入本所案號
'pCP10              傳入案件性質
'pCP09, pCP05   可傳入指定收文號和收文日
'pStiu                上傳前先檢查有重複檔案，D=刪除舊檔,     A=自動+系統日期(+時間), 空白=不上傳
'bKillSource      上傳後是否刪除來源檔案
'outFinalName   上傳到原始檔區的檔名: 傳回
Dim arrTmpA As Variant
Dim intA As Integer, intK As Integer
Dim rsAD As New ADODB.Recordset
Dim NowCP09 As String, NowCP05 As String
Dim strTemp1 As String
Dim m_FS, m_f, m_s
Dim stReName As String, stFileName As String, stMidName As String
Dim stNameDef As String
Dim bolRep As Boolean
Dim NowCP12 As String, NowCP13 As String, NowCP14 As String
Dim intN As Integer
Dim strCPF02Name As String
'Added by Lydia 2020/03/20
Dim strExcept As String
Dim strOldName As String
Dim fs
Dim strErr As String 'Added by Lydia 2020/03/24 回傳錯誤訊息

    PUB_UploadCPFfile = False
    If pFrmPath = "" Or pCP01 = "" Or pCP02 = "" Or pCP10 = "" Then Exit Function
    outMsgTxt = ""
    outFinalName = ""
    
    arrTmpA = Split(pFrmPath, "*") '檔案分隔字元
    NowCP05 = pCP05
    NowCP09 = pCP09
    'Added by Lydia 2020/03/20 Typing2批次搬檔：判斷有無基本檔
    If pType = "0" Then
        strTemp1 = "select pa01,pa02,pa03,pa04 from patent where pa01='" & pCP01 & "' and pa02='" & pCP02 & "' and pa03='" & pCP03 & "' and pa04='" & pCP04 & "' "
        intA = 1
        Set rsAD = ClsLawReadRstMsg(intA, strTemp1)
        If intA = 0 Then
            outMsgTxt = outMsgTxt & vbCrLf & "無基本檔:" & pFrmPath & "，請確認檔名是否正確！"
            Exit Function
        End If
    End If
    'end 2020/03/20
    If pCP09 = "" Then '判斷收文號
        strTemp1 = "select cp09,cp10,cp05 from caseprogress where cp01='" & pCP01 & "' and cp02='" & pCP02 & "' and cp03='" & pCP03 & "' and cp04='" & pCP04 & "' " & _
                         "and cp159=0 and cp10='" & pCP10 & "' and substr(cp09,1,1)='D' "
        strTemp1 = strTemp1 & " order by cp05 desc "
        intA = 1
        Set rsAD = ClsLawReadRstMsg(intA, strTemp1)
        If intA = 1 Then
             NowCP09 = "" & rsAD.Fields("cp09")
             NowCP05 = "" & rsAD.Fields("cp05")
        Else
              '無收文號，新增D類收文
             'Modified by Lydia 2020/03/030 CP13和CP14 放反
             'NowCP13 = PUB_GetFCPHandler(pCP01, pCP02, pCP03, pCP04) 'FCP程序
             'NowCP12 = GetSalesArea(NowCP13)
             'NowCP14 = strUserNum
             'If pType = "1" Then
             '   NowCP14 = PUB_GetFCPSalesNo(pCP01, pCP02, pCP03, pCP04)   'FCP承辦
             'End If
             NowCP13 = PUB_GetFCPSalesNo(pCP01, pCP02, pCP03, pCP04)   'FCP承辦
             NowCP12 = GetSalesArea(NowCP13)
             NowCP14 = strUserNum
             If pType = "1" Then
                NowCP14 = PUB_GetFCPHandler(pCP01, pCP02, pCP03, pCP04) 'FCP程序
             End If
             'end 2020/03/30
             
             NowCP09 = AutoNo("D", 6)
             strTemp1 = "insert into caseprogress( cp01,cp02,cp03,cp04,cp05,cp09,cp10" & _
                ",cp12,cp13,cp14,cp20,cp26,cp27,cp32 ) values ('" & pCP01 & "'" & _
                 ",'" & pCP02 & "','" & pCP03 & "','" & pCP04 & "'," & NowCP05 & ",'" & NowCP09 & "','" & pCP10 & "' " & _
                 ",'" & NowCP12 & "','" & NowCP13 & "','" & NowCP14 & "','N','N'," & NowCP05 & ",'N')"
             cnnConnection.Execute strTemp1
        End If
    End If
    
    stNameDef = PUB_FCPCaseNo2FileName(pCP01, pCP02, pCP03, pCP04)
    'Added by Lydia 2020/03/24
    Set fs = CreateObject("Scripting.FileSystemObject")
    Set m_FS = CreateObject("Scripting.FileSystemObject")
    
    For intK = 0 To UBound(arrTmpA)
       If Trim(arrTmpA(intK)) <> "" Then
            stFileName = GetFileName("" & arrTmpA(intK))
            'Added by Lydia 2020/02/25 GetFileName會去除#以後的文字
            If InStr("" & arrTmpA(intK), "#") > 0 And InStr(stFileName, ".") = 0 Then
               stFileName = stFileName & Mid("" & arrTmpA(intK), InStrRev("" & arrTmpA(intK), "."))
            End If
            strOldName = stFileName

            'Added by Lydia 2021/03/24 客戶提供文件：現在選原文說明書直接統一命名為"案號.ORI.PDF"
            If Pub_StrUserSt03 = "F23" And pType = "2" And Right(UCase(strOldName), Len(".ORI.PDF")) = ".ORI.PDF" Then
                strCPF02Name = UCase(PUB_FCPCaseNo2FileName(pCP01, pCP02, pCP03, pCP04)) & "." & pCP10 & ".ORI.PDF"
            'end 2021/03/24
            Else
                bolRep = False '替換本
                strCPF02Name = PUB_GetReNameCPF02(stFileName, pCP01, pCP02, pCP03, pCP04, pCP10, "A")
                If pCP10 = cntEnglish_Vers And InStr(UCase(strCPF02Name), ".ORI.REP") > 0 And Right(UCase(strCPF02Name), 4) = ".PDF" Then
                    bolRep = True
                End If
            End If  'Added by Lydia 2021/03/24
            
            'Added by Lydia 2020/03/30 工程師上傳->最終版之中說 =>案號.送件日.FIX_U或FIG.PDF
            If pType = "2" And pCP10 = cnt專利案件 And Not (InStr(".FIX.DOC;.COR.DOC;.DES.DOC;.ORI.TXT;.FIX.TXT;.COR.TXT", Right(UCase(strCPF02Name), 8)) > 0 Or InStr(".FIX.DOCX;.COR.DOCX;.DES.DOCX", Right(UCase(strCPF02Name), 9)) > 0) Then
                strCPF02Name = UCase(strCPF02Name)
                If InStr(stFileName, pCP01 & pCP02 & IIf(pCP03 <> "0", pCP03, "") & IIf(pCP04 <> "00", pCP04, "") & "-") = 0 Then   'Added by Lydia 2021/02/22 判斷檔名非人工加上送件日，才預設為系統日；ex.FCP60399預定送件日為2/22，但是1/19上傳檔案，所以檔案命名為FCP060399-1100222.FIX_U
                    If InStr(strCPF02Name, strSrvDate(2)) = 0 Then
                        strCPF02Name = Replace(strCPF02Name, stNameDef & "." & pCP10 & ".", _
                                             stNameDef & "." & pCP10 & "." & strSrvDate(2) & ".")
                    Else '更名：案號6碼.案件性質.系統日期.時間
                        strCPF02Name = Replace(strCPF02Name, stNameDef & "." & pCP10 & "." & strSrvDate(2) & ".", _
                                             stNameDef & "." & pCP10 & "." & strSrvDate(2) & "." & Format(ServerTime + intN, "000000") & ".")
                    End If
                End If 'Added by Lydia 2021/02/22
            End If
            'end 2020/03/30
            
            stFileName = arrTmpA(intK) '檔名(含路徑)
            'Set m_FS = CreateObject("Scripting.FileSystemObject") 'Mark by Lydia 2020/03/24
            Set m_f = m_FS.GetFile(stFileName)
            '存檔
            'Modified by Lydia 2020/03/02 批次搬檔: 因為密碼檔可能是0KB,所以不判斷檔案大小
            'If m_f.Size > 0 Then
            If (pType <> "0" And m_f.Size > 0) Or pType = "0" Then
                '檢查有無重覆檔案
JumpToResearch:
                If bolRep = True Then
                    strTemp1 = "select max(cpf02) cpf02 from casepaperfile where cpf01='" & NowCP09 & "' and upper(cpf02) like '%.ORI.REP%.PDF' "
                Else
                    strTemp1 = "select cpf02 from casepaperfile where cpf01='" & NowCP09 & "' and upper(cpf02)='" & UCase(strCPF02Name) & "' " & _
                                      "order by cpf08 desc,cpf09 desc "
                End If

                intA = 1
                Set rsAD = ClsLawReadRstMsg(intA, strTemp1)
                If intA = 1 Then
                   If pStiu = "D" Then
                       '刪除原始檔區的舊檔
                       If DelAttFile_File(pCP01 & "-" & pCP02 & "-" & pCP03 & "-" & pCP04, pCP09, strCPF02Name) = False Then
                          outMsgTxt = outMsgTxt & vbCrLf & "原始檔區已有重覆檔案:" & strCPF02Name & "，請先確認原始檔區的檔案！"
                          GoTo JumpToNext
                       End If
                   ElseIf pStiu = "A" Then
                        If bolRep = True Then '替換本: 自動+流水號
                            If "" & rsAD.Fields("cpf02") <> "" Then 'Added by Lydia 2020/04/30
                                 strTemp1 = Mid("" & rsAD.Fields("cpf02"), InStr(UCase("" & rsAD.Fields("cpf02")), ".ORI.REP") + Len(".ORI.REP"))
                                 intA = Val(Mid(strTemp1, 1, InStr(strTemp1, ".") - 1))
                                 strCPF02Name = Mid(strCPF02Name, 1, InStr(UCase(strCPF02Name), ".ORI.REP") + 7) & intA + 1 & ".PDF"
                            End If 'Added by Lydia 2020/04/30
                        Else
                            '更名：案號6碼.案件性質.系統日期
                            'stMidName = stReName
                            stMidName = strCPF02Name
                            If InStr(stReName, strSrvDate(2)) = 0 Then
                                strCPF02Name = Replace(stMidName, stNameDef & "." & pCP10 & ".", _
                                                     stNameDef & "." & pCP10 & "." & strSrvDate(2) & ".")
                            Else '更名：案號6碼.案件性質.系統日期.時間
                                strCPF02Name = Replace(stMidName, stNameDef & "." & pCP10 & "." & strSrvDate(2) & ".", _
                                                     stNameDef & "." & pCP10 & "." & strSrvDate(2) & "." & Format(ServerTime + intN, "000000") & ".")
                                intN = intN + 1
                            End If
                            stMidName = PUB_GetReNameMax(stMidName, pCP01, pCP02, pCP03, pCP04, pCP10)
                            GoTo JumpToResearch
                        End If
                   Else
                       'Added by Lydia 2020/03/20 若大小寫不同／檔名過長／Typing2批次搬檔,先自動+檔案日期
                       If ("" & rsAD.Fields("cpf02") <> strCPF02Name And UCase("" & rsAD.Fields("cpf02")) = UCase(strCPF02Name)) Or pType = "0" Then
                             strCPF02Name = Mid(strCPF02Name, 1, InStrRev(strCPF02Name, ".") - 1) & "." & Format(m_f.DateLastModified, "YYYYMMDD") & "." & Format(m_f.DateLastModified, "HHMMSS") & Mid(strCPF02Name, InStrRev(strCPF02Name, "."))
                             If GetTextLength(strCPF02Name) > 100 Then '檔名過長
                                  strCPF02Name = Mid(strCPF02Name, 1, 75) & "." & Format(m_f.DateLastModified, "YYYYMMDD") & "." & Format(m_f.DateLastModified, "HHMMSS") & Mid(strCPF02Name, InStrRev(strCPF02Name, "."))
                             End If
                       Else
                       'end 2020/03/20
                            '回傳錯誤訊息
                            outMsgTxt = outMsgTxt & vbCrLf & "原始檔區已有重覆檔案:" & strCPF02Name & "，請先確認原始檔區的檔案！"
                            GoTo JumpToNext
                       End If 'Added by Lydia 2020/03/20
                   End If
                End If
                
                'Move by Lydia 2020/02/12 先將名稱統一，再檢查名稱
                If PUB_GetEmpFlowReNameFile(pCP01, pCP02, pCP03, pCP04, pCP10, strCPF02Name, stReName, True, 0) = False Then
                    'Added by Lydia 2020/02/18 + 回傳錯誤訊息
                    outMsgTxt = outMsgTxt & vbCrLf & "無法更名:" & stFileName & "，請確認檔名是否正確！"
                    GoTo JumpToNext
                End If
                
                '上傳到原始檔區: 指定檔名 'Memo by Lydia 2020/02/15 資料來源：增加"B"-Typing2搬檔
                'Modified by Lydia 2020/03/24 + strErr 回傳錯誤訊息
                'Modified by Lydia 2025/05/07 + bolShowMsg=False
                If SaveAttFile_Org(NowCP09, stFileName, stReName, Format(m_f.DateLastModified, "YYYYMMDD"), Format(m_f.DateLastModified, "HHMMSS"), IIf(pType = "0", "B", "A"), strCPF02Name, strErr, False) = True Then
                    outFinalName = outFinalName & "," & strCPF02Name
                    If bKillSource = True Then
                        'Modified by Lydia 2020/03/02 跳過檔名有(符號的檢查
                        'Call PUB_DelPCOrgFile(stFileName)   '刪除實體檔案
                        'Modified by Lydia 2020/03/20 改成直接刪除,避免彈訊息
                        'Call PUB_DelPCOrgFile(stFileName, False)
                        If Not fs.FileExists(stFileName) Then '注意不能用Dir() 會造成來源程式判斷問題
                             strExcept = strExcept & vbCrLf & "無檔案可刪除:" & stFileName & "，請確認檔名是否正確！"
                        Else
                             SetAttr stFileName, vbNormal
                             Kill stFileName
                        End If
                        'end 2020/03/20
                    End If
                Else
                    If strErr <> "" Then outMsgTxt = outMsgTxt & vbCrLf & strErr  'Added by Lydia 2020/03/24
                    GoTo JumpToNext
                End If
            End If
       End If
       
JumpToNext: '重覆檔案，跳過

    Next intK
    
    pCP09 = NowCP09
    If outMsgTxt = "" Then
        PUB_UploadCPFfile = True
        outFinalName = Mid(outFinalName, 2)
    End If
    If strExcept <> "" Then outMsgTxt = outMsgTxt & strExcept 'Added by Lydia 2020/03/20
    
ExitTask:
    'Added by Lydia 2020/03/24
    Set m_FS = Nothing
    Set m_f = Nothing
    Set fs = Nothing
    'end 2020/03/24
    Exit Function
End Function

'Added by Lydia 2020/02/12 案件文件原始檔：CPF02檔名處理
Public Function PUB_GetReNameCPF02(ByVal pOldName As String, ByVal pCP01 As String, ByVal pCP02 As String, ByVal pCP03 As String, ByVal pCP04 As String, ByVal pCP10 As String, _
                               Optional ByRef pDataSrc As String = "A") As String
'pOldName：傳入檔名
'pCP01~pCP04 、pCP10：本所案號和案件性質
'pDataSrc : 來源程式：M=>原始檔區人工作業； A=>批次作業：客戶提供文件frm060120、工程師上傳作業frm090905
Dim stNameDef  As String '本所案號開頭
Dim stMidName As String
Dim stFileName2 As String 'Add By Sindy 2023/12/12
   
   If pOldName = "" Then Exit Function
   If pCP01 = "" Or pCP02 = "" Or pCP10 = "" Then
       PUB_GetReNameCPF02 = pOldName
   Else

       stNameDef = UCase(PUB_FCPCaseNo2FileName(pCP01, pCP02, pCP03, pCP04))
       
       '更名：流水號6碼
       stMidName = pOldName
       If InStr(UCase(pOldName), pCP01 & Val(pCP02)) = 1 Then
           stMidName = Replace(stMidName, UCase(pCP01 & Val(pCP02)), UCase(pCP01 & Format(pCP02, "000000")))
           stMidName = Replace(stMidName, LCase(pCP01 & Val(pCP02)), UCase(pCP01 & Format(pCP02, "000000")))
       End If
       stMidName = Replace(stMidName, LCase(pCP01 & Format(pCP02, "000000")), UCase(pCP01 & Format(pCP02, "000000"))) 'Added by Lydia 2020/02/20
       
       If pDataSrc <> "A" Then
           '案號.案件性質，直接使用原檔名
           If InStr(stMidName, stNameDef & "." & pCP10) = 1 Then
                stMidName = PUB_GetReNameMax(stMidName, pCP01, pCP02, pCP03, pCP04, pCP10) '限制檔名長度
           '案號開頭無案件性質
           ElseIf InStr(stMidName, stNameDef) = 1 And InStr(stMidName, stNameDef & "." & pCP10) = 0 Then
               stMidName = Replace(stMidName, stNameDef & ".", stNameDef & "." & pCP10 & ".")
               stMidName = PUB_GetReNameMax(stMidName, pCP01, pCP02, pCP03, pCP04, pCP10) '限制檔名長度
           End If
       ElseIf pDataSrc = "A" Then '批次作業：符合命名原則
           '1. 案號.案件性質，直接使用原檔名
           If InStr(stMidName, stNameDef & "." & pCP10) = 1 Then
                stMidName = PUB_GetReNameMax(stMidName, pCP01, pCP02, pCP03, pCP04, pCP10) '限制檔名長度
               
           '2. 案號-送件日期.FIX_U(最終版本中說word) / 案號-送件日期.FIG.PDF(最終版圖式)，另外更名
           'Modified by Lydia 2020/03/04  工程師上傳作業:送到English_Vers(等)，若遇到重覆檔名會自動加上"-民國年月日"
           'ElseIf InStr(stMidName, stNameDef & "-") = 1 And _
                       (InStr(UCase(stMidName), "FIX_U") > 0 Or InStr(UCase(stMidName), "FIG.PDF") > 0) Then
           ElseIf InStr(stMidName, stNameDef & "-") = 1 And _
                       CheckIsTaiwanDate(Mid(stMidName, Len(stNameDef & "-") + 1, 7), False) = True Then
               '更名：案號6碼.案件性質.送件日期
               stMidName = Replace(stMidName, stNameDef & "-", stNameDef & "." & pCP10 & ".")
               stMidName = PUB_GetReNameMax(stMidName, pCP01, pCP02, pCP03, pCP04, pCP10) '限制檔名長度
               
           '3. 案號開頭無案件性質
           ElseIf InStr(stMidName, stNameDef) = 1 And InStr(stMidName, stNameDef & "." & pCP10) = 0 Then
               stMidName = Replace(stMidName, stNameDef & ".", stNameDef & "." & pCP10 & ".")
               stMidName = PUB_GetReNameMax(stMidName, pCP01, pCP02, pCP03, pCP04, pCP10) '限制檔名長度
           '其他: 自動+案號.案件性質
           Else
               stMidName = PUB_GetReNameMax(stMidName, pCP01, pCP02, pCP03, pCP04, pCP10, 75) '限制檔名長度,檔名最大100字元(先減掉案號+案件性質14, 系統日期8)
               stMidName = stNameDef & "." & pCP10 & "." & stMidName
           End If
           
           '客戶提供文件:替換本.ORI.REP.PDF,預設檔名.ORI.REP1.PDF
           If pCP10 = cntEnglish_Vers And InStr(UCase(stMidName), ".ORI.REP") > 0 And Right(UCase(stMidName), 4) = ".PDF" Then
               stMidName = UCase(stMidName) '統一大寫
               If InStr(stMidName, ".ORI.REP.PDF") > 0 Then
                   stMidName = Replace(stMidName, ".ORI.REP.PDF", ".ORI.REP1.PDF")
               End If
           End If
       End If
       PUB_GetReNameCPF02 = stMidName
   End If
   
   'Add By Sindy 2023/12/12 雅娟跟薛經理反應:USPTO檔案命名規則 (本所卷宗區的副檔名可否修正為小寫.其餘不變,目前官方不接受大寫副檔名)
   stMidName = PUB_GetReNameCPF02
   stFileName2 = LCase(Right(stMidName, Len(stMidName) - InStrRev(stMidName, ".") + 1)) '副檔名
   PUB_GetReNameCPF02 = Left(stMidName, InStrRev(stMidName, ".") - 1) & stFileName2 '檔名+.副檔名
   '2023/12/12 END
   
   Exit Function
End Function

'Added by Lydia 2020/01/20 上傳檔名限制長度(原始檔區CPF02和卷宗區CPP02的欄位長度為100)
Public Function PUB_GetReNameMax(ByVal pOldName As String, ByVal pCP01 As String, ByVal pCP02 As String, ByVal pCP03 As String, ByVal pCP04 As String, ByVal pCP10 As String, Optional ByVal pMax As Integer = 95) As String
Dim stMid As String
Dim intM As Integer, intA As Integer
     
     stMid = pOldName
     '先處理空白: 因為PUB_GetEmpFlowReNameFile模組,將空白化為"."
     stMid = Replace(stMid, "　", " ")
     intM = InStr(stMid, "  ")
     Do While intM > 0  '清除重覆空白
          stMid = Replace(stMid, "  ", " ")
          intM = InStr(stMid, "  ")
     Loop

     '檔名最大100字元
     intM = GetTextLength(stMid)
     If intM > pMax Then
        intA = InStrRev(stMid, ".")
        '從後端去掉檔名; pMax指定保留檔名長度
        'stMid = Mid(stMid, 1, intA - (100 - pMax)) & Mid(stMid, intA) 'Test
        'Added by Lydia 2020/02/25 如果沒有副檔名
        If intA = 0 Then
           stMid = Mid(stMid, 1, pMax)
        Else
        'end 2020/02/25
           stMid = Mid(stMid, 1, pMax) & Mid(stMid, intA)
        End If 'end 2020/02/25
     End If
     
     PUB_GetReNameMax = stMid
End Function

'Added by Lydia 2020/01/21 所有系統別分案，若該收文號存在於下一程序(NP24)，若修改案件性質則彈訊息
Public Function Pub_CheckNP24Exists(ByVal pNP24 As String, Optional ByVal bolMsg As Boolean = True) As Boolean
Dim strA1 As String, intB As Integer
Dim rsAD As New ADODB.Recordset
    
    Pub_CheckNP24Exists = False
    If pNP24 = "" Then Exit Function
    strA1 = "select np24 from NextProgress where np24='" & pNP24 & "' "
    intB = 1
    Set rsAD = ClsLawReadRstMsg(intB, strA1)
    If intB = 1 Then
        If bolMsg = True Then
           MsgBox "請至下一程序檔維護，確認期限是否需恢復管制。", vbInformation + vbOKOnly, "下一程序收文"
        End If
        Pub_CheckNP24Exists = True
    End If
    Set rsAD = Nothing
End Function

'Added by Morgan 2020/2/6
'計算 P大陸案OA法限, 「在途期間」=15日
'法限=OA發文日+15日+OA上要求回覆的月數(一般來說第一次OA為4個月，第二次以上OA為2個月)+延期的月數(一般為2個月)
'pCP43:相關收文號(OA或後續收文), pDeadLine:法限, pAdd15Day: 是否加在途
Public Function PUB_GetOADeadline(pCP43 As String, pDeadLine As String, Optional pAdd15Day As Boolean = True) As Boolean
   Dim strQ As String, intQ As Integer
   Dim RsQ As ADODB.Recordset
   Dim stOACP09 As String 'OA收文號
   Dim stOADate As String 'OA發文日
   Dim intOAMonth As Integer 'OA上要求回覆的月數
   Dim intDelayMonth As Integer '延期月數
   
On Error GoTo ErrHnd
   
   pDeadLine = ""
   If pCP43 < "C" Then
      'Modified by Morgan 2020/2/13 改抓未提申(原抓未發文)--郭
      strQ = "select cp09,cp43 from caseprogress where cp09='" & pCP43 & "' and cp57 is null and cp47 is null"
   Else
      strQ = "select np01 from nextprogress where np01='" & pCP43 & "' and np06 is null"
   End If
   
   intQ = 1
   Set RsQ = ClsLawReadRstMsg(intQ, strQ)
   If intQ = 1 Then
      If pCP43 < "C" Then
         If IsNull(RsQ("cp43")) Then
            MsgBox "無法取得來函收文號！", vbCritical
            GoTo ErrHnd
         Else
            stOACP09 = RsQ("cp43")
         End If
      Else
         stOACP09 = pCP43
      End If
   Else
      MsgBox "相關收文號(" & pCP43 & ")沒有" & IIf(pCP43 < "C", "未提申", "未收文") & "資料！", vbCritical
      GoTo ErrHnd
   End If

   'Modified by Morgan 2024/1/19
   'strQ = "select cp133,cp134 from caseprogress where cp09='" & stOACP09 & "'"
   strQ = "select a.cp133,a.cp134,b.cp118 from caseprogress a,caseprogress b where a.cp09='" & stOACP09 & "' and b.cp09(+)=a.cp43"
   'end 2024/1/19
   intQ = 1
   Set RsQ = ClsLawReadRstMsg(intQ, strQ)
   If intQ = 1 Then
      stOADate = "" & RsQ("cp133")
      intOAMonth = Val("" & RsQ("cp134"))
      If Not ChkDate(stOADate) Then
         MsgBox "OA發文日錯誤！", vbCritical
      ElseIf intOAMonth <= 0 Then
         MsgBox "OA期限月數錯誤！", vbCritical
      Else
         'Added by Morgan 2024/1/9
         '官方發文日是否是2024年1月20日（不含）前發出才可使用在15日在途期間
         If pAdd15Day Then
            If stOADate >= 20240120 And RsQ("cp118") = "Y" Then
               MsgBox "相關來函的官方發文日為113年1月20日(含)之後發出，無在途期間之適用！" & vbCrLf & vbCrLf & "官方發文日: " & ChangeWStringToTDateString(stOADate), vbCritical
               GoTo ErrHnd
            End If
         End If
         'end 2024/1/9
         
         strQ = "select cp71 from caseprogress where cp43='" & stOACP09 & "' and cp10='404' and cp27>0 and cp57 is null" & _
            " union select c2.cp71 from nextprogress,caseprogress c1,caseprogress c2" & _
            " where np01='" & stOACP09 & "' and np06='Y' and c1.cp43(+)=np01 and c1.cp10(+)=np07 and c2.cp43(+)=c1.cp09 and c2.cp10='404' and c2.cp27>0 and c2.cp57 is null"
         intQ = 1
         Set RsQ = ClsLawReadRstMsg(intQ, strQ)
         If intQ = 1 Then
            intDelayMonth = Val("" & RsQ("cp71"))
            If intDelayMonth <= 0 Then
               MsgBox "相關號有延期但紀錄之延期月數有誤，請先更正！", vbCritical
               GoTo ErrHnd
            End If
         End If
         
         If pAdd15Day = True Then
            pDeadLine = CompDate(2, 15, stOADate)
         Else
            pDeadLine = stOADate
         End If
         pDeadLine = AddMonth(pDeadLine, intOAMonth)
         If intDelayMonth > 0 Then
            pDeadLine = AddMonth(pDeadLine, intDelayMonth)
         End If
         PUB_GetOADeadline = True
      End If
   End If
   
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
   Set RsQ = Nothing
End Function

'Added by Morgan 2020/2/7
'更新「在途期間」相關號期限
Public Sub PUB_442UpdateDeadline(pCP43 As String, pNewDeadLine As String, pbolFMP As Boolean)
   Dim stCP06 As String, stNP08 As String, stSQL As String, intR As Integer
   '所限
   stCP06 = PUB_GetWorkDay1(CompDate(2, IIf(pbolFMP, -7, -10), pNewDeadLine), True)
   If pCP43 < "C" Then
      'Modified by Morgan 2020/2/13 改更新未提申的程序及最終提申管制(原更新未發文)
      'Modified by Morgan 2020/2/14 取消備註(因延期會重算且不含在途)
      'stSQL = "update caseprogress set cp06=" & stCP06 & ",cp07=" & pNewDeadLine & ",cp64='法限已加在途期間;'||cp64 where cp09='" & pCP43 & "' and cp57 is null and cp47 is null"
      'Modified by Morgan 2020/5/19 +備註,另控制延期時刪除備註
      stSQL = "update caseprogress set cp06=" & stCP06 & ",cp07=" & pNewDeadLine & ",cp64='法限已加在途15天;'||cp64 where cp09='" & pCP43 & "' and cp57 is null and cp47 is null"
      cnnConnection.Execute stSQL, intR
      
      stNP08 = PUB_GetWorkDay1(pNewDeadLine, True)
      stSQL = "update nextprogress set np08=" & stNP08 & ",np09=" & pNewDeadLine & " where np01='" & pCP43 & "' and np07='996' and np06 is null"
      cnnConnection.Execute stSQL, intR
   Else
      'Modified by Morgan 2020/2/14 取消備註(因延期會重算且不含在途)
      'stSQL = "update nextprogress set np08=" & stCP06 & ",np09=" & pNewDeadLine & ",np15='法限已加在途期間;'||np15 where np01='" & pCP43 & "' and np06 is null"
      'Modified by Morgan 2020/5/19 +備註,另控制延期時刪除備註
      stSQL = "update nextprogress set np08=" & stCP06 & ",np09=" & pNewDeadLine & ",np15='法限已加在途15天;'||np15 where np01='" & pCP43 & "' and np06 is null"
      cnnConnection.Execute stSQL, intR
   End If
End Sub

'Added by Morgan 2020/2/13
'更新相關國外案的發明人及案件名稱(從發文移來)
Public Sub PUB_UpdateRefCaseInventorAndCaseName(pa01 As String, pa02 As String, pa03 As String, pa04 As String)
   Dim stSQL As String, intQ As Integer
   Dim RsQ As ADODB.Recordset
   
   '新申請案程序未發文的國外案
   stSQL = "Select CM01,CM02,CM03,CM04 From CaseMap Where CM05='" & pa01 & "' AND CM06='" & pa02 & "' AND CM07='" & pa03 & "' AND CM08='" & pa04 & "' AND CM10='0' " & _
      " and exists(select * from caseprogress where cp01=cm01 and cp02=cm02 and cp03=cm03 and cp04=cm04 and cp10 in (" & NewCasePtyList & ") and cp27||cp57 is null)"
   intQ = 1
   Set RsQ = ClsLawReadRstMsg(intQ, stSQL)
   'Modified by Morgan 2023/5/25
   'If intI = 1 Then
   If intQ = 1 Then
   'end 2023/5/25
      With RsQ
      While Not .EOF
         '更新案件名稱
         stSQL = "UPDATE PATENT A SET (PA05,PA06,PA07)=(SELECT B.PA05,B.PA06,B.PA07 FROM PATENT B where" & _
            " B.PA01='" & pa01 & "' AND B.PA02='" & pa02 & "' AND B.PA03='" & pa03 & "' AND PA04='" & pa04 & "')" & _
            " WHERE " & ChgPatent(.Fields("CM01") & .Fields("CM02") & .Fields("CM03") & .Fields("CM04"))
         cnnConnection.Execute stSQL, intQ
         
         '更新國外案發明人
         CopyInventor pa01 & pa02 & pa03 & pa04, .Fields("CM01") & .Fields("CM02") & .Fields("CM03") & .Fields("CM04")
         .MoveNext
      Wend
      End With
   End If
   Set RsQ = Nothing
End Sub

'Added by Morgan 2020/3/3
'FCP發文提醒(從發文程式抽出共用)
Public Sub PUB_FCPAlert(pCP09 As String)
   Dim strQ As String, intQ As Integer
   Dim rstQ As ADODB.Recordset
   
   strQ = "select cp130,st03,pa75,cp10 from caseprogress,patent,staff" & _
      " where cp09='" & pCP09 & "' and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04" & _
      " and st01(+)=cp14"
   intQ = 1
   Set rstQ = ClsLawReadRstMsg(intQ, strQ)
   If intQ = 1 Then
      With rstQ
      '有主管機關
      If "" & .Fields("cp130") <> "" Then
         '工程師中間程序(例: 申復、再審、訴願、補充說明、...)發文
         If InStr("F21,F51,F52", "" & .Fields("st03")) > 0 Then
            If "" & .Fields("pa75") = "Y48292030" Then
               MsgBox "請優先請款並且在提申當天上傳報告!!", vbInformation
               
            '排除901.告代、902.回代、1202.審查意見、1002.核駁
            ElseIf InStr("901,902,1202,1002", "" & .Fields("cp10")) = 0 Then
               
               Select Case "" & .Fields("pa75")
               Case "Y33844000"
                  MsgBox "請在送件後3天內並且要當月優先請款!!", vbInformation
               Case "Y51982000"
                  MsgBox "申復/再審/修正等送智慧局的案件，於收到指示後7天內送程序送件同時請款(由Wilson指示備註)!!", vbInformation
               Case "Y20272000"
                  MsgBox "中間程序送件當日簡單報告!!", vbInformation
               Case "Y34440B30"
                  MsgBox "請當日優先請款報告!!", vbInformation
                  
               Case "Y30053010", "Y54171000", "Y54682000"
                  MsgBox "請當天簡單報告!!", vbInformation
               Case "Y20088000"
                  MsgBox "中間程序送件後、法限前報告+請款。如無法，請先退承辦當天簡單報告!!", vbInformation
               Case "Y21042000"
                  MsgBox "所有程序送件後退承辦簡單報告!!", vbInformation
                  
               'Added by Morgan 2020/3/3--林芳如
               Case "Y21071000"
                  MsgBox "所有中間(核准前)程序送件後、法限前報告+優先請款。如無法，（新案提申、再審、 申復、分割須當天）請先退承辦簡單報告!!", vbInformation
               End Select
            End If
         End If
      End If
      
      '實審及補文件
      If "" & .Fields("cp10") = "416" Or "" & .Fields("cp10") = "202" Then
         If "" & .Fields("pa75") = "Y20088000" Then
            MsgBox "中間程序送件後、法限前報告+請款。如無法，請先退承辦當天簡單報告!!", vbInformation
            
         ElseIf "" & .Fields("pa75") = "Y21042000" Then
            MsgBox "所有程序送件後退承辦簡單報告!!", vbInformation
         End If
         
         'Added by Morgan 2020/3/3--林芳如
         If "" & .Fields("cp10") = "202" Then
            If "" & .Fields("pa75") = "Y21071000" Then
               MsgBox "所有中間(核准前)程序送件後、法限前報告+優先請款。如無法，（新案提申、再審、 申復、分割須當天）請先退承辦簡單報告!!", vbInformation
            End If
         End If
         'end 2020/3/3
      End If
      
      End With
   End If
   Set rstQ = Nothing
End Sub

'Added by Morgan 2020/3/20
'最後發文之A或B類(不續辦、閉卷、取消收文除外)之出名代理人
Public Function PUB_GetLastAgent(cp01 As String, cp02 As String, cp03 As String, cp04 As String) As String
   Dim stSQL As String, intQ As Integer
   Dim RsQ As ADODB.Recordset
   
   stSQL = "select cp110,cp27,cp09 from caseprogress" & _
      " where cp01='" & cp01 & "' and cp02='" & cp02 & "' and cp03='" & cp03 & "' and cp04='" & cp04 & "'" & _
      " and cp09<'C' and cp27>0 and cp159=0 and cp10 not in('913','907','925') and cp110 is not null" & _
      " order by cp27 desc,cp82 desc"
   intQ = 1
   Set RsQ = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      PUB_GetLastAgent = "" & RsQ("cp110")
   End If
   Set RsQ = Nothing
End Function
'Added by Morgan 2020/3/16
'檢查最後發文之A或B類之出名代理人有76012桂所長且未公告且無專用期的案件
Public Function PUB_ChkIsGuiCase(cp01 As String, cp02 As String, cp03 As String, cp04 As String, Optional pPOACaseNo As String, Optional pNoPOACustList As String) As Boolean
   Dim strCP110 As String
   Dim stSQL As String, intQ As Integer
   Dim RsQ As ADODB.Recordset
   Dim strTempName As String, strPOACaseNo As String
   
   pPOACaseNo = ""
   pNoPOACustList = ""
   
   strCP110 = PUB_GetLastAgent(cp01, cp02, cp03, cp04)
   If InStr(strCP110, "76012") > 0 Then
   
      '未公告且無專用期的案件
      stSQL = "select pa26,pa27,pa28,pa29,pa30 from patent" & _
         " where pa01='" & cp01 & "' and pa02='" & cp02 & "' and pa03='" & cp03 & "' and pa04='" & cp04 & "'" & _
         " and pa14 is null and pa25 is null"
      intQ = 1
      Set RsQ = ClsLawReadRstMsg(intQ, stSQL)
      If intQ = 1 Then
         PUB_ChkIsGuiCase = True
         With RsQ
         If Not IsNull(.Fields("pa26")) Then
            If PUB_ChkPA165IsY(.Fields("pa26"), strPOACaseNo) = True Then
               pPOACaseNo = pPOACaseNo & strPOACaseNo & " "
            Else
               pNoPOACustList = pNoPOACustList & vbCrLf & .Fields("pa26")
               If ClsPDGetCustomer(.Fields("pa26"), strTempName) = True Then
                  pNoPOACustList = pNoPOACustList & " " & strTempName
               End If
            End If
         End If
         If Not IsNull(.Fields("pa27")) Then
            If PUB_ChkPA165IsY(.Fields("pa27"), strPOACaseNo) = True Then
               pPOACaseNo = pPOACaseNo & strPOACaseNo & " "
            Else
               pNoPOACustList = pNoPOACustList & vbCrLf & .Fields("pa27")
               If ClsPDGetCustomer(.Fields("pa27"), strTempName) = True Then
                  pNoPOACustList = pNoPOACustList & " " & strTempName
               End If
            End If
         End If
         If Not IsNull(.Fields("pa28")) Then
            If PUB_ChkPA165IsY(.Fields("pa28"), strPOACaseNo) = True Then
               pPOACaseNo = pPOACaseNo & strPOACaseNo & " "
            Else
               pNoPOACustList = pNoPOACustList & vbCrLf & .Fields("pa28")
               If ClsPDGetCustomer(.Fields("pa28"), strTempName) = True Then
                  pNoPOACustList = pNoPOACustList & " " & strTempName
               End If
            End If
         End If
         If Not IsNull(.Fields("pa29")) Then
            If PUB_ChkPA165IsY(.Fields("pa29"), strPOACaseNo) = True Then
               pPOACaseNo = pPOACaseNo & strPOACaseNo & " "
            Else
               pNoPOACustList = pNoPOACustList & vbCrLf & .Fields("pa29")
               If ClsPDGetCustomer(.Fields("pa29"), strTempName) = True Then
                  pNoPOACustList = pNoPOACustList & " " & strTempName
               End If
            End If
         End If
         If Not IsNull(.Fields("pa30")) Then
            If PUB_ChkPA165IsY(.Fields("pa30"), strPOACaseNo) = True Then
               pPOACaseNo = pPOACaseNo & strPOACaseNo & " "
            Else
               pNoPOACustList = pNoPOACustList & vbCrLf & .Fields("pa30")
               If ClsPDGetCustomer(.Fields("pa30"), strTempName) = True Then
                  pNoPOACustList = pNoPOACustList & " " & strTempName
               End If
            End If
         End If
         End With
      End If
   End If
   Set RsQ = Nothing
End Function

'Added by Morgan 2020/3/18
'桂所長案件內部收文變更
Public Sub PUB_Add401ForGuiCase(cp01 As String, cp02 As String, cp03 As String, cp04 As String, CP09 As String, cp12 As String, cp13 As String)
   Dim stPOACaseNo As String, stCP14 As String, stSubject As String
   Dim stSQL As String, intR As Integer
   
   If PUB_ChkIsGuiCase(cp01, cp02, cp03, cp04, stPOACaseNo) Then
      stSQL = "update caseprogress set cp64=cp64 where cp01='" & cp01 & "' and cp02='" & cp02 & "' and cp03='" & cp03 & "' and cp04='" & cp04 & "' and cp10='401' and cp64='變更代理人為閻+林'"
      cnnConnection.Execute stSQL, intR
      If intR = 0 Then
         '變更承辦人
         'Modified by Morgan 2020/4/1 --玲玲
         'stCP14 = Pub_GetSpecMan("PS1")
         'Added by Morgan 2025/1/24
         If strSrvDate(1) >= P業務區劃分啟用日 Then
            stCP14 = PUB_GetPHandler(cp01 & cp02 & cp03 & cp04)
         Else
         'end 2025/1/24
            stCP14 = Pub_GetSpecMan("AB202")
         End If 'Added by Morgan 2025/1/24
         'end 2020/4/1
         '內部收文變更401(費用:0,規費:300,點數:-0.3)
         stSQL = "INSERT INTO CASEPROGRESS (CP01,CP02,CP03,CP04,CP05," & _
            "CP09,CP10,CP11,CP12,CP13,CP14,CP16,CP17,CP18,CP20,CP26,CP32,CP43,CP64) VALUES " & _
            "('" & cp01 & "','" & cp02 & "','" & cp03 & "','" & cp04 & "'," & strSrvDate(1) & _
            ",'" & AutoNo("B", 6) & "','401','90','" & cp12 & "','" & cp13 & "'" & _
            ",'" & stCP14 & "',0,300,-0.3,'N','N','N','" & CP09 & "','變更代理人為閻+林') "
         cnnConnection.Execute stSQL, intR
   
         'E-MAIL通知承辦人
         stSubject = "本所案號 " & cp01 & "-" & cp02 & IIf(cp03 & cp04 = "000", "", "-" & cp03 & "-" & cp04)
         stSubject = stSubject & " 請辦理變更代理人為「閻K泰、林景郁」。"
         If stPOACaseNo <> "" Then
            stSubject = stSubject & "總委任書存於:" & stPOACaseNo
         End If
   
         stSQL = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08)" & _
            " values ('" & strUserNum & "','" & stCP14 & "',to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss')" & _
            ",'" & ChgSQL(stSubject) & "','" & ChgSQL(stSubject) & "')"
         cnnConnection.Execute stSQL, intR
      End If
   End If
End Sub


'Add by Amy 2020/03/24 傳入公司別或系統類別確認收據公司
'intChoose:0-公司別/2-系統別
'stNo:公司別 or 系統別
'Move by Lydia 2020/03/26 從aacc_fun搬來
Public Function ChkAccReceiptComp(intChoose As Integer, stNo As String, Optional ByRef stMsg As String = "") As Boolean
   Dim stTmp As String
   
   ChkAccReceiptComp = False
    '傳入公司別
    If intChoose = 0 Then
        If stNo <> "2" And stNo <> "9" And stNo <> "J" And stNo <> "L" Then
            stMsg = "收據公司別只可輸入２或９或Ｊ或 L"
            Exit Function
        End If
    '傳入系統別
    Else
        'Modify by Amy 2020/04/10 改抓系統別,因ACS SK02=3
'        stTmp = CheckSys(stNo)
'        'SK02為3、4(法務案)及7、8(顧問案)
'        If stTmp <> "3" And stTmp <> "4" And stTmp And "7" And stTmp <> "8" Then
'            stMsg = "收據公司別有誤請確認！"
'            Exit Function
'        End If
        If InStr(stNo, "L") = 0 Then
            stMsg = "收據公司別有誤請確認！"
            Exit Function
        End If
        'end 2020/04/10
    End If
    ChkAccReceiptComp = True
End Function

'Add by Morgan 2011/9/21
'讀取相關收據號碼
'Move by Lydia 2020/03/26 從aacc_fun搬來
Public Function PUB_GetRelateNo(pNo As String) As String
   Dim strNoList As String, strNewNoList As String
   Dim stSQL As String, intR As Integer
   Dim adoTmp As ADODB.Recordset
   
   strNoList = pNo
   strNewNoList = strNoList
   
   '相同總收文號的其他收據號碼
   Do While strNewNoList <> ""
      stSQL = "select distinct a0j13 from acc0j0 where a0j01 in (select a0j01 from acc0j0 where a0j13 in ('" & Replace(strNewNoList, ",", "','") & "')) and instr('" & strNoList & "',a0j13)=0"
      intR = 1
      Set adoTmp = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         With adoTmp
         strNewNoList = .Fields("a0j13")
         .MoveNext
         Do While Not .EOF
            strNewNoList = strNewNoList & "," & .Fields("a0j13")
            .MoveNext
         Loop
         strNoList = strNoList & "," & strNewNoList
         End With
      Else
         strNewNoList = ""
      End If
   Loop
   PUB_GetRelateNo = strNoList
   Set adoTmp = Nothing
End Function

'Add By Sindy 2020/3/23 列印法律所收據
'pFileFullPath:收據的Word範本
'pintPrintUniNo:列印統一編號,pintPrintCustCaseNo:列印客戶案件案號
'pstrRePrint:是否補開(Y/N),pstrNewDesc1:案件性質名稱1,pstrNewDesc2:案件性質名稱2,pstrPritDate:列印日期
'pbolUpdateTimes:是否更新列印次數
'Move by Lydia 2020/03/26 從aacc_fun搬來
'Modify by Sindy 2020/11/20
'   + , Optional strPdfFileNm As String = "" : 產生PDF電子檔
'   + , Optional bolTextEffect As Boolean = False : 加浮水印
Public Sub PUB_PrintCaseReceipt_L(pFileFullPath As String, padoacc0k0 As ADODB.Recordset, pintPrintUniNo As Integer, _
   pintPrintCustCaseNo As Integer, _
   Optional pstrRePrint As String, Optional pstrNewDesc1 As String, Optional pstrNewDesc2 As String, _
   Optional pstrPritDate As String, Optional pbolUpdateTimes As Boolean = True, Optional strPdfFileNm As String = "", _
   Optional bolTextEffect As Boolean = False)

Dim intTimes As Integer
Dim strTemp As String, strTempA As String
Dim StrSQLa As String, intR As Integer
Dim adocaseprogress As ADODB.Recordset
Dim adoquery As ADODB.Recordset
Dim douService As Double '已銷服務費
Dim douFee As Double '已銷規費
Dim lngAmount1 As Long '服務費
Dim lngAmount2 As Long '規費
Dim strAmount1 As String
Dim strAmount2 As String
Dim lngItemAmount1 As Long '單項服務費
Dim lngItemAmount2 As Long '單項規費
Dim intRecPos As Integer '目前指向第幾筆資料
Dim ii As Integer
Dim strItemDesc As String '帳款類別
Dim strCaseNo As String
Dim strCustCaseNo As String '客戶案件案號
Dim strName As String, strText As String
Dim i As Integer, j As Integer
Dim strTmp As String, strTmp2 As String, strPCC05 As String
Dim strFileName As String
Dim strCaseName As String, strNation As String
Dim strCaseNum(1 To 6) As String '請參 m_intRecMaxItem
Dim strCaseNote(1 To 6) As String
Dim strAmount1F(1 To 6) As String
Dim strAmount2F(1 To 6) As String
Dim dblTotAmt As Double
Dim strAddr As String
Dim strLOS02 As String, strLOSCName As String
Dim strLOScp12 As String, strLOScp13 As String
Dim TmpDirNm As String, strSaveFileName As String 'Add By Sindy 2020/11/20
Dim strPath As String 'Add By Sindy 2025/9/18
   
On Error GoTo ErrHand
   
   With padoacc0k0
   If IsNull(.Fields("a0k19").Value) Then
      intTimes = 1
   ElseIf pbolUpdateTimes = False Then
      intTimes = Val(.Fields("a0k19").Value)
   Else
      intTimes = Val(.Fields("a0k19").Value) + 1
   End If
   
   'Add By Sindy 2020/4/30 抓案源資料:
   '以收據號抓ACC0J0之收文號，再抓法律所案源檔LAWOFFICESOURCE之法律所總收文號LOS06欄，
   '再抓案件進度檔等相關法務資料
   '例:E10910184
   'Modified by Morgan 2023/8/14 要用進度的案源單號來抓資料，法律案先收的收文號可能沒有費用(收據只開後收的收文號) Ex:L-006685
   'StrSQLa = "SELECT cp01,cp02,cp03,cp04,cp12,cp13,LOS02,LC11,NVL(CU04,DECODE(CU05,NULL,CU06,CU05||' '||CU88||' '||CU89||' '||CU90)) as CUname" & _
             " From LawOfficeSource, CaseProgress, acc0j0, lawcase, customer" & _
             " WHERE a0j13='" & padoacc0k0.Fields("a0k01").Value & "' AND LOS06(+)=a0j01" & _
             " AND LOS06=cp09(+)" & _
             " AND cp01=LC01(+) AND cp02=LC02(+) AND cp03=LC03(+) AND cp04=LC04(+) AND LC01 is not null" & _
             " AND substr(LC11,1,8)=cu01(+) AND substr(LC11,9,1)=cu02(+)" & _
             " union all " & _
             "SELECT cp01,cp02,cp03,cp04,cp12,cp13,LOS02,hc05,NVL(CU04,DECODE(CU05,NULL,CU06,CU05||' '||CU88||' '||CU89||' '||CU90)) as CUname" & _
             " From LawOfficeSource, CaseProgress, acc0j0, hirecase, customer" & _
             " WHERE a0j13='" & padoacc0k0.Fields("a0k01").Value & "' AND LOS06(+)=a0j01" & _
             " AND LOS06=cp09(+)" & _
             " AND cp01=HC01(+) AND cp02=HC02(+) AND cp03=HC03(+) AND cp04=HC04(+) AND HC01 is not null" & _
             " AND substr(hc05,1,8)=cu01(+) AND substr(hc05,9,1)=cu02(+)"
   StrSQLa = "SELECT cp01,cp02,cp03,cp04,cp12,cp13,LOS02,LC11,NVL(CU04,DECODE(CU05,NULL,CU06,CU05||' '||CU88||' '||CU89||' '||CU90)) as CUname" & _
             " From acc0j0, CaseProgress, LawOfficeSource, lawcase, customer" & _
             " WHERE a0j13='" & padoacc0k0.Fields("a0k01").Value & "' and cp09(+)=a0j01 and los15(+)=cp162" & _
             " AND cp01=LC01(+) AND cp02=LC02(+) AND cp03=LC03(+) AND cp04=LC04(+) AND LC01 is not null" & _
             " AND substr(LC11,1,8)=cu01(+) AND substr(LC11,9,1)=cu02(+)" & _
             " union all " & _
             "SELECT cp01,cp02,cp03,cp04,cp12,cp13,LOS02,hc05,NVL(CU04,DECODE(CU05,NULL,CU06,CU05||' '||CU88||' '||CU89||' '||CU90)) as CUname" & _
             " From acc0j0, CaseProgress, LawOfficeSource, hirecase, customer" & _
             " WHERE a0j13='" & padoacc0k0.Fields("a0k01").Value & "' and cp09(+)=a0j01 and los15(+)=cp162" & _
             " AND cp01=HC01(+) AND cp02=HC02(+) AND cp03=HC03(+) AND cp04=HC04(+) AND HC01 is not null" & _
             " AND substr(hc05,1,8)=cu01(+) AND substr(hc05,9,1)=cu02(+)"
   intR = 1
   Set RsTemp = ClsLawReadRstMsg(intR, StrSQLa)
    If RsTemp.RecordCount > 0 Then
      strLOS02 = "" & RsTemp.Fields("LOS02").Value
      strLOSCName = "" & RsTemp.Fields("CUname").Value
      '以收據號抓ACC0J0之收文號，再抓法律所案源檔LAWOFFICESOURCE之法律所總收文號LOS06欄，
      '抓出TT總收文號(收據)LOS10，再抓案件進度檔的CP12及CP13。
      '例:E10909604
      'Modified by Morgan 2023/8/14 要用進度的案源單號來抓資料，法律案先收的收文號可能沒有費用(收據只開後收的收文號) Ex:L-006685
      'StrSQLa = "SELECT cp12,cp13" & _
                " From LawOfficeSource, CaseProgress, acc0j0" & _
                " WHERE a0j13='" & padoacc0k0.Fields("a0k01").Value & "' AND LOS06(+)=a0j01" & _
                " AND LOS10=cp09(+) AND LOS10 is not null"
      StrSQLa = "SELECT c2.cp12,c2.cp13" & _
                " From acc0j0, CaseProgress c1, LawOfficeSource, CaseProgress c2" & _
                " WHERE a0j13='" & padoacc0k0.Fields("a0k01").Value & "' and c1.cp09(+)=a0j01 and los15(+)=c1.cp162" & _
                " AND LOS10=c2.cp09(+) AND LOS10 is not null"
      intR = 1
      Set RsTemp = ClsLawReadRstMsg(intR, StrSQLa)
      If RsTemp.RecordCount > 0 Then
         strLOScp12 = "" & RsTemp.Fields("cp12").Value
         strLOScp13 = "" & RsTemp.Fields("cp13").Value
      End If
   End If
   '2020/4/23 END
   
   '檢查是否已全銷
   If Not IsNull(.Fields("a0k10")) Then '銷帳退費單號
      StrSQLa = "select nvl(sum(a1u07),0)+nvl(sum(a1u09),0) from acc1u0 where a1u02='" & .Fields("a0k01") & "'"
      intR = 1
      Set adoquery = ClsLawReadRstMsg(intR, StrSQLa)
      If intR = 1 Then
         If adoquery.Fields(0) >= Val("" & .Fields("a0k06")) + Val("" & .Fields("a0k07")) Then
            adoquery.Close
            GoTo EXITSUB
         End If
      End If
      adoquery.Close
   End If
   
   '帳款類別變更
   If IsNull(.Fields("a0k33")) = False Then
      '收文日(最小)
      StrSQLa = "select * " & _
         " from acc0j0,caseprogress,nation where a0j13='" & .Fields("a0k01").Value & "' and cp09(+)=a0j01 and na01(+)=a0j04 and (cp79 <> 0 or (cp79 = 0 and cp75 <> 0)) " & _
         " order by a0j25 asc"
      intR = 1
      Set adocaseprogress = ClsLawReadRstMsg(intR, StrSQLa)
      If intR = 1 Then
         strItemDesc = adocaseprogress.Fields("a0j22") '帳款類別
         lngAmount1 = 0
         lngAmount2 = 0
         '服務費規費合併
         Do While Not adocaseprogress.EOF
            '本所案號
            strCaseNo = adocaseprogress.Fields("a0j02")
            If Right(strCaseNo, 3) = "000" Then
               strCaseNo = Left(strCaseNo, Len(strCaseNo) - 3)
            'Add By Sindy 2024/9/20 客戶反應同定稿要有-
               strCaseNo = Left(strCaseNo, Len(strCaseNo) - 6) & "-" & Right(strCaseNo, 6)
            Else
               strExc(9) = Left(strCaseNo, Len(strCaseNo) - 3)
               strExc(10) = Right(strCaseNo, 3)
               strCaseNo = Left(strExc(9), Len(strExc(9)) - 6) & "-" & Right(strExc(9), 6) & _
                           "-" & Left(strExc(10), 1) & "-" & Right(strExc(10), 2)
            '2024/9/20 END
            End If
            
            strCaseName = "": strCustCaseNo = ""
            If IsNull(adocaseprogress.Fields("a0j24")) Then
               '案件名稱(以總收文號查詢)及客戶案件案號(Optional)
               strCaseName = CaseNameQuery(adocaseprogress.Fields("a0j01").Value, 1, strCustCaseNo)
               If strCaseName = "" Then
                  strCaseName = CaseNameQuery(adocaseprogress.Fields("a0j01").Value, 2)
               End If
            End If
            '申請國家
            strNation = ""
            If IsNull(adocaseprogress.Fields("a0j23")) Then
               If IsNull(adocaseprogress.Fields("na03").Value) = False Then
                  strNation = "" & adocaseprogress.Fields("na03").Value
               End If
            End If
            
            If strItemDesc <> adocaseprogress.Fields("a0j22") Then
               If lngItemAmount1 > 0 Or lngItemAmount2 > 0 Then
                  intRecPos = intRecPos + 1
                  '帳款類別
                  For ii = 0 To 3
                     'Modify By Sindy 2022/3/3 E11105975:顧問聘任:111/03/02-112/03/01(大陸專利監控-12間)
'                     strTemp = PUB_StrToStr(strItemDesc, 30)
'                     If strTemp = "" Then
'                        Exit For
'                     Else
'                        strCaseNote(intRecPos) = strTemp
'                        strItemDesc = Mid(strItemDesc, Len(strTemp) + 1)
'                     End If
                     strCaseNote(intRecPos) = strItemDesc
                  Next
                  'Add By Sindy 2020/4/30 若案源類型為C類時，在案件性質後加印'－申請人名稱前6個中文
                  strCaseNote(intRecPos) = strCaseNote(intRecPos) & IIf(strLOS02 = "C", "-" & Mid(strLOSCName, 1, 6), "")
                  '2020/4/30 END
                  
                  '列印本所案號,申請國家,案件名稱,客戶案件案號
                  strCaseNum(intRecPos) = strCaseNo '案號
                  If strCaseName <> "" Then
                     '若案件名稱太長時縮小
                     strTemp = Trim(strCaseName)
                     strTempA = ReOrgPrintTemp(strTemp, 22)
                     If strTemp = strTempA Then
                        strCaseNote(intRecPos) = IIf(strCaseNote(intRecPos) <> "", strCaseNote(intRecPos) & vbCrLf, "") & _
                                    strTemp
                     Else
                        strCaseNote(intRecPos) = IIf(strCaseNote(intRecPos) <> "", strCaseNote(intRecPos) & vbCrLf, "") & _
                                    ReOrgPrintTemp(strTemp, 26)
                     End If
                  End If
                  If strNation <> "" Then
                     strCaseNote(intRecPos) = strCaseNote(intRecPos) & "/" & strNation
                  End If
'                  '列印客戶案件案號
'                  If pintPrintCustCaseNo = 1 And strCustCaseNo <> "" Then
'                     strCaseNote(intRecPos) = IIf(strCaseNote(intRecPos) <> "", strCaseNote(intRecPos) & vbCrLf, "") & _
'                                 "客戶案件案號：" & strCustCaseNo
'                  End If
                  
                  lngAmount1 = lngAmount1 + lngItemAmount1
                  lngAmount2 = lngAmount2 + lngItemAmount2
                  
                  If lngItemAmount1 > 0 Then
                     strAmount1 = Format(lngItemAmount1, DDollar)
                  Else
                     strAmount1 = 0
                  End If
                  If lngItemAmount2 > 0 Then
                     strAmount2 = Format(lngItemAmount2, DDollar)
                  Else
                     strAmount2 = 0
                  End If
                  
                  '服務費
                  strAmount1F(intRecPos) = strAmount1
                  '規費
                  strAmount2F(intRecPos) = strAmount2
               End If
               
               lngItemAmount1 = 0
               lngItemAmount2 = 0
               
               '帳款類別
               strItemDesc = adocaseprogress.Fields("a0j22")
            End If
         
            douService = 0
            douFee = 0
            '有銷帳
            If IsNull(.Fields("a0k10")) = False Then
               StrSQLa = "select sum(a1u07), sum(a1u09) from acc1u0 where a1u02 = '" & .Fields("a0k01").Value & "' and a1u03='" & adocaseprogress.Fields("a0j01") & "'"
               intR = 1
               Set adoquery = ClsLawReadRstMsg(intR, StrSQLa)
               If intR = 1 Then
                  If IsNull(adoquery.Fields(0).Value) = False Then
                     douService = Val(adoquery.Fields(0).Value)
                  End If
                  If IsNull(adoquery.Fields(1).Value) = False Then
                     douFee = Val(adoquery.Fields(1).Value)
                  End If
               End If
               adoquery.Close
            End If
         
            If IsNull(adocaseprogress.Fields("a0j07").Value) = False Then
               lngItemAmount1 = lngItemAmount1 + Val("" & adocaseprogress.Fields("a0j09")) + Val("" & adocaseprogress.Fields("a0j10")) - douService - douFee
            Else
               If Val("" & adocaseprogress.Fields("a0j09")) - douService > 0 Then
                  lngItemAmount1 = lngItemAmount1 + Val("" & adocaseprogress.Fields("a0j09")) - douService
                  lngItemAmount2 = lngItemAmount2 + Val("" & adocaseprogress.Fields("a0j10")) - douFee
               Else
                  lngItemAmount2 = lngItemAmount2 + Val("" & adocaseprogress.Fields("a0j10")) - douFee + Val("" & adocaseprogress.Fields("a0j09")) - douService
               End If
            End If
            adocaseprogress.MoveNext
         Loop
         adocaseprogress.Close
         
         lngAmount1 = lngAmount1 + lngItemAmount1
         lngAmount2 = lngAmount2 + lngItemAmount2
         
         If lngItemAmount1 > 0 Or lngItemAmount2 > 0 Then
            intRecPos = intRecPos + 1
            '帳款類別
            For ii = 0 To 3
               'Modify By Sindy 2022/3/3 E11105975:顧問聘任:111/03/02-112/03/01(大陸專利監控-12間)
'               strTemp = PUB_StrToStr(strItemDesc, 30)
'               If strTemp = "" Then
'                  Exit For
'               Else
'                  strCaseNote(intRecPos) = strTemp
'                  strItemDesc = Mid(strItemDesc, Len(strTemp) + 1)
'               End If
               strCaseNote(intRecPos) = strItemDesc
            Next
            
            '列印本所案號,申請國家,案件名稱,客戶案件案號
            strCaseNum(intRecPos) = strCaseNo '案號
            If strCaseName <> "" Then
               '若案件名稱太長時縮小
               strTemp = Trim(strCaseName)
               strTempA = ReOrgPrintTemp(strTemp, 22)
               If strTemp = strTempA Then
                  strCaseNote(intRecPos) = IIf(strCaseNote(intRecPos) <> "", strCaseNote(intRecPos) & vbCrLf, "") & _
                              strTemp
               Else
                  strCaseNote(intRecPos) = IIf(strCaseNote(intRecPos) <> "", strCaseNote(intRecPos) & vbCrLf, "") & _
                              ReOrgPrintTemp(strTemp, 26)
               End If
            End If
            If strNation <> "" Then
               strCaseNote(intRecPos) = strCaseNote(intRecPos) & "/" & strNation
            End If
'            '列印客戶案件案號
'            If pintPrintCustCaseNo = 1 And strCustCaseNo <> "" Then
'               strCaseNote(intRecPos) = IIf(strCaseNote(intRecPos) <> "", strCaseNote(intRecPos) & vbCrLf, "") & _
'                           "客戶案件案號：" & strCustCaseNo
'            End If
            
            If lngItemAmount1 > 0 Then
               strAmount1 = Format(lngItemAmount1, DDollar)
            Else
               strAmount1 = 0
            End If
            If lngItemAmount2 > 0 Then
               strAmount2 = Format(lngItemAmount2, DDollar)
            Else
               strAmount2 = 0
            End If
                     
            '服務費
            strAmount1F(intRecPos) = strAmount1
            '規費
            strAmount2F(intRecPos) = strAmount2
         End If
      End If
      
   Else
      '收據明細資料
      StrSQLa = "select a.*,b.*,getcp10desc(cp01,cp10,a0j04) cp10N,na03 from acc0j0 a,caseprogress b,nation where a0j13 = '" & .Fields("a0k01").Value & "' And cp09(+)=a0j01 and (cp79 <> 0 or (cp79 = 0 and cp75 <> 0)) and na01(+)=a0j04 ORDER BY CP09 "
      intR = 1
      Set adocaseprogress = ClsLawReadRstMsg(intR, StrSQLa)
      If intR = 1 Then
         intRecPos = 0
         Do While adocaseprogress.EOF = False
            intRecPos = intRecPos + 1
            
            douService = 0
            douFee = 0
            '有銷帳
            If adocaseprogress.Fields("cp77") > 0 Then
               '銷帳=費用時不印
               If adocaseprogress.Fields("cp77") = adocaseprogress.Fields("cp16") Then
                  GoTo NextRecord
               Else
                  '抓收款資料
                  StrSQLa = "select sum(a1u07), sum(a1u09) from acc1u0 where a1u03 = '" & adocaseprogress.Fields("cp09").Value & "' and a1u02='" & .Fields("a0k01").Value & "'"
                  intR = 1
                  Set adoquery = ClsLawReadRstMsg(intR, StrSQLa)
                  If intR = 1 Then
                     If IsNull(adoquery.Fields(0).Value) = False Then
                        douService = Val(adoquery.Fields(0).Value)
                     End If
                     If IsNull(adoquery.Fields(1).Value) = False Then
                        douFee = Val(adoquery.Fields(1).Value)
                     End If
                  End If
                  adoquery.Close
               End If
            End If
            
            '案件性質名稱直接抓0j0的以免資料不一致卻沒發現(程式有修剪)
            If intRecPos = 1 And pstrNewDesc1 <> "" Then
               strCaseNote(intRecPos) = pstrNewDesc1
            ElseIf intRecPos = 2 And pstrNewDesc2 <> "" Then
               strCaseNote(intRecPos) = pstrNewDesc2
            Else
               strCaseNote(intRecPos) = adocaseprogress.Fields("cp10N").Value
            End If
            'Add By Sindy 2020/4/30 若案源類型為C類時，在案件性質後加印'－申請人名稱前6個中文
            strCaseNote(intRecPos) = strCaseNote(intRecPos) & IIf(strLOS02 = "C", "-" & Mid(strLOSCName, 1, 6), "")
            '2020/4/30 END
            
            '顧問案的顧問聘任(0)時要印顧問期間
            If adocaseprogress("CP01") = "LA" And adocaseprogress("CP10") = "0" Then
               '顧問期間
               strCaseNote(intRecPos) = strCaseNote(intRecPos) & _
                     "：" & _
                     Format(TransDate("" & adocaseprogress("CP53"), 1), "###/##/##") & " - " & Format(TransDate("" & adocaseprogress("CP54"), 1), "###/##/##") & vbCrLf
            End If
            
            '只要印一次,若設定金額合併則不印
            'If intRecPos = 1 And IsNull(.Fields("a0k33")) Then
               '列印本所案號
               If (adocaseprogress.Fields("cp03").Value & adocaseprogress.Fields("cp04").Value) = "000" Then
                  'Modify By Sindy 2024/9/20 客戶反應同定稿要有-
                  'strCaseNum(intRecPos) = adocaseprogress.Fields("cp01").Value & adocaseprogress.Fields("cp02").Value
                  strCaseNum(intRecPos) = adocaseprogress.Fields("cp01").Value & "-" & adocaseprogress.Fields("cp02").Value
               Else
                  'Modify By Sindy 2024/9/20 客戶反應同定稿要有-
                  'strCaseNum(intRecPos) = adocaseprogress.Fields("cp01").Value & adocaseprogress.Fields("cp02").Value & adocaseprogress.Fields("cp03").Value & adocaseprogress.Fields("cp04").Value
                  strCaseNum(intRecPos) = adocaseprogress.Fields("cp01").Value & "-" & adocaseprogress.Fields("cp02").Value & "-" & adocaseprogress.Fields("cp03").Value & "-" & adocaseprogress.Fields("cp04").Value
               End If
               'Modify By Sindy 2020/5/13 LA不列印案件名稱
               If adocaseprogress("CP01") = "LA" Then
                  '列印申請國家名稱
                  If IsNull(adocaseprogress.Fields("na03").Value) = False Then
                     strCaseNote(intRecPos) = strCaseNote(intRecPos) & adocaseprogress.Fields("na03").Value
                  End If
               Else
               '2020/5/13 END
                  '列印案件名稱(以總收文號查詢)及客戶案件名稱(Optional)
                  strTemp = CaseNameQuery(adocaseprogress.Fields("cp09").Value, 1, strCustCaseNo)
                  If strTemp = "" Then
                     strTemp = CaseNameQuery(adocaseprogress.Fields("cp09").Value, 2)
                  End If
                  '若案件名稱太長時縮小
                  strTemp = Trim(strTemp)
                  strTempA = ReOrgPrintTemp(strTemp, 22)
                  If strTemp = strTempA Then
                     strCaseNote(intRecPos) = IIf(strCaseNote(intRecPos) <> "", strCaseNote(intRecPos) & vbCrLf, "") & _
                                 strTemp
                  Else
                     strCaseNote(intRecPos) = IIf(strCaseNote(intRecPos) <> "", strCaseNote(intRecPos) & vbCrLf, "") & _
                                 ReOrgPrintTemp(strTemp, 26)
                  End If
                  '列印申請國家名稱
                  If IsNull(adocaseprogress.Fields("na03").Value) = False Then
                     strCaseNote(intRecPos) = strCaseNote(intRecPos) & "/" & adocaseprogress.Fields("na03").Value
                  End If
               End If
'               '列印客戶案件案號
'               If pintPrintCustCaseNo = 1 And strCustCaseNo <> "" Then
'                  strCaseNote(intRecPos) = IIf(strCaseNote(intRecPos) <> "", strCaseNote(intRecPos) & vbCrLf, "") & _
'                              "客戶案件案號：" & strCustCaseNo
'               End If
            'End If
            
            If Val("" & adocaseprogress.Fields("a0j09").Value) + Val("" & adocaseprogress.Fields("a0j10").Value) > 0 Then
               '有規費不合併
               If Val("" & adocaseprogress.Fields("a0j10").Value) > 0 And IsNull(adocaseprogress.Fields("a0j07").Value) Then
                  '服務費
                  If Val("" & adocaseprogress.Fields("a0j09").Value) - douService > 0 Then
                     strAmount1 = Format(Val("" & adocaseprogress.Fields("a0j09").Value) - douService, DDollar)
                  Else
                     strAmount1 = "0"
                  End If
                  strAmount1F(intRecPos) = strAmount1
                  
                  '服務費累計
                  lngAmount1 = lngAmount1 + Val(Format(strAmount1))
                  
                  '規費
                  If Val("" & adocaseprogress.Fields("a0j10").Value) - douFee > 0 Then
                     '若為負點數時規費印費用
                     If Val("" & adocaseprogress.Fields("a0j09").Value) - douService < 0 Then
                        strAmount2 = Format(Val("" & adocaseprogress.Fields("a0j10").Value) - douFee + Val("" & adocaseprogress.Fields("a0j09").Value) - douService, DDollar)
                     Else
                        strAmount2 = Format(Val("" & adocaseprogress.Fields("a0j10").Value) - douFee, DDollar)
                     End If
                  Else
                     strAmount2 = "0"
                  End If
                  strAmount2F(intRecPos) = strAmount2
                  
                  '規費累計
                  lngAmount2 = lngAmount2 + Val(Format(strAmount2))
                  
               '合併列印或無規費
               Else
                  strAmount1 = Format(Val("" & adocaseprogress.Fields("a0j09").Value) + Val("" & adocaseprogress.Fields("a0j10").Value) - douService - douFee, DDollar)
                  '列印費用
                  If strAmount1 = "" Then
                     strAmount1F(intRecPos) = 0
                  Else
                     strAmount1F(intRecPos) = strAmount1
                  End If
                  lngAmount1 = lngAmount1 + Val(Format(strAmount1))
                  
                  strAmount2 = "0"
                  strAmount2F(intRecPos) = 0
                  strAmount2 = lngAmount2 + 0
               End If
            End If
NextRecord:
            adocaseprogress.MoveNext
         Loop
         adocaseprogress.Close
      End If
   End If
   End With
   
   '判斷word是否已開啟
   If g_WordAp Is Nothing Then
RestarWord:
      Set g_WordAp = New Word.Application
      g_WordAp.Visible = False
   End If
   'Modify By Sindy 2025/9/18
   '另存檔名:+收據編號.doc
   'strFileName = "$$法律所收據-" & padoacc0k0.Fields("a0k01").Value & ".doc"
   strFileName = "$$" & strSrvDate(2) & ServerTime & "_L_" & padoacc0k0.Fields("a0k01").Value & ".doc"
   strPath = Mid(pFileFullPath, 1, InStrRev(pFileFullPath, "\")) 'Add By Sindy 2025/9/18
   'strFileName = App.path & "\" & strFileName
   strFileName = strPath & strFileName
   '2025/9/18 END
   If Dir(strFileName) <> "" Then
      Kill strFileName
   End If
   g_WordAp.Documents.Open pFileFullPath
   g_WordAp.ActiveDocument.SaveAs strFileName
   g_WordAp.ActiveDocument.Close
   g_WordAp.Documents.Open strFileName
   With g_WordAp
      .Selection.WholeStory
      .Selection.Copy
'      'Add By Sindy 2014/12/15
'      '先檢查是否為多筆的收據編號,若是,先複製/貼上儲存格
'      If GRD1.Rows > 2 Then
'         .Selection.Find.ClearFormatting
'         .Selection.Find.Text = "Re:"
'         .Selection.Find.Execute
'         .Selection.MoveDown Unit:=wdLine, Count:=2, Extend:=wdExtend
'         .Selection.SelectRow
'         .Selection.Copy
'         For ii = 1 To GRD1.Rows - 2
'            .Selection.Paste
'         Next ii
'      End If
'      '2014/12/15 END
'
'      'Add By Sindy 2019/9/24
'      strNo = ""
'      For j = 1 To GRD1.Rows - 1 '可多筆收據編號
'         If GRD1.TextMatrix(j, 1) <> "" Then
'            If strNo = "" Then
'               strNo = GRD1.TextMatrix(j, 1)
'            Else
'               strNo = strNo & "、" & GRD1.TextMatrix(j, 1)
'            End If
'         End If
'      Next j
'      '2019/9/24 END
      
      '標題
      For i = 1 To 6
         strName = ""
         strText = ""
         Select Case i
            Case 1 '客戶資料
               strName = "客戶資料"
               strText = "編號：" & padoacc0k0.Fields("a0k03").Value & vbCrLf
               '收據抬頭
               strTmp = "名稱："
               If IsNull(padoacc0k0.Fields("a0k04").Value) = False Then
                  strTmp = strTmp & Trim(padoacc0k0.Fields("a0k04").Value)
               End If
               strTmp = strTmp & vbCrLf
               strText = strText & strTmp
               '客戶地址
               Call PUB_PrintReceiptHead_Addr(padoacc0k0, strAddr, strPCC05)
               strTmp = "地址：" & strAddr
               If LenB(strTmp) > 44 Then
                  strTmp2 = MidB(strTmp, 1, 44) & vbCrLf
                  strTmp2 = strTmp2 & "　　　" & RightB(strTmp, LenB(strTmp) - 44)
                  strTmp = strTmp2 & vbCrLf
               Else
                  strTmp = strTmp & vbCrLf
               End If
               '接洽人
               If strAddr <> "" Then '有地址才要帶接洽人
                  If strPCC05 <> "" Then
                     strTmp = strTmp & "　　　" & strPCC05
                  End If
               End If
               strText = strText & strTmp
            Case 2 '收據日期
               strName = "收據日期"
               If pstrPritDate <> "" Then
                  strDate = pstrPritDate
               Else
                  strDate = padoacc0k0.Fields("a0k02")
               End If
               strText = CFDate(strDate)
            Case 3 '客戶案號
               strName = "客戶案號"
               If pintPrintCustCaseNo = 1 Then
                  '帳款類別變更
                  If IsNull(padoacc0k0.Fields("a0k33")) = False Then
                     '收文日(最小)
                     StrSQLa = "select * " & _
                        " from acc0j0,caseprogress,nation where a0j13='" & padoacc0k0.Fields("a0k01").Value & "' and cp09(+)=a0j01 and na01(+)=a0j04 and (cp79 <> 0 or (cp79 = 0 and cp75 <> 0)) " & _
                        " order by a0j25 asc"
                     intR = 1
                     Set RsTemp = ClsLawReadRstMsg(intR, StrSQLa)
                  Else
                     '收據明細資料
                     StrSQLa = "select a.*,b.*,getcp10desc(cp01,cp10,a0j04) cp10N,na03 from acc0j0 a,caseprogress b,nation where a0j13 = '" & padoacc0k0.Fields("a0k01").Value & "' And cp09(+)=a0j01 and (cp79 <> 0 or (cp79 = 0 and cp75 <> 0)) and na01(+)=a0j04 ORDER BY CP09 "
                     intR = 1
                     Set RsTemp = ClsLawReadRstMsg(intR, StrSQLa)
                  End If
                  If RsTemp.RecordCount > 0 Then
                     RsTemp.MoveFirst
                     Do While Not RsTemp.EOF
                        strTmp = CaseNameQuery(RsTemp.Fields("a0j01"), 1, strCustCaseNo)
                        If strCustCaseNo <> "" Then
                           strText = strCustCaseNo
                           Exit Do
                        End If
                        RsTemp.MoveNext
                     Loop
                  End If
               End If
            Case 4 '補開
               strName = "補開"
               If pstrRePrint = "Y" Then
                  strText = "***  補開  ***"
               End If
            Case 5 '收據號碼
               strName = "收據號碼"
               strText = padoacc0k0.Fields("a0k01").Value
            Case 6 '智權人員
               strName = "智權人員"
               '智權人員代號
               If IsNull(padoacc0k0.Fields("a0k20").Value) = False Then
                  '業務區
                  If IsNull(padoacc0k0.Fields("a0k22").Value) = False Then
                     strText = padoacc0k0.Fields("a0k22").Value
                  End If
                  strText = strText & " " & padoacc0k0.Fields("a0k20").Value
               End If
               'Add By Sindy 2020/4/23 加印介紹人之部門及員工編號
               '例:E10909604　L02 82021 / S22 A3023
               If strLOS02 <> "" Then
                  'Modify By Sindy 2020/4/30 例:E10910184 L02 88028
                  '不存在法律所案源檔或案源案件類型LOS02為C類時則不加印，也不要斜線
                  If strLOS02 <> "C" Then
                     strText = strText & " / " & strLOScp12 & " " & strLOScp13
                  End If
               End If
               '2020/4/23 END
         End Select
         If Trim(strName) <> "" Then
            .Selection.Find.ClearFormatting
            .Selection.Find.Text = "|#" & strName & "#|"
            .Selection.Find.Replacement.Text = ""
            .Selection.Find.Forward = True
            .Selection.Find.Wrap = wdFindContinue
            .Selection.Find.Format = False
            .Selection.Find.MatchCase = False
            .Selection.Find.MatchWholeWord = False
            .Selection.Find.MatchWildcards = False
            .Selection.Find.MatchSoundsLike = False
            .Selection.Find.MatchAllWordForms = False
            .Selection.Find.MatchByte = True
            .Selection.Find.Execute
            .Selection.Delete
            .Selection.Font.ColorIndex = wdBlack
            .Selection.TypeText strText
         End If
      Next i
      '收據明細
      For j = 1 To m_intRecMaxItem
         For i = 1 To 4
            strName = ""
            strText = ""
            Select Case i
               Case 1
                  strName = "本所案號" & j
                  strText = strCaseNum(j)
               Case 2
                  strName = "委辦事項" & j
                  strText = strCaseNote(j)
               Case 3
                  strName = "服務費" & j
                  If strAmount1F(j) <> "0" Then
                     strText = strAmount1F(j)
                  End If
               Case 4
                  strName = "規費" & j
                  If strAmount2F(j) <> "0" Then
                     strText = strAmount2F(j)
                  End If
            End Select
            If Trim(strName) <> "" Then
               .Selection.Find.ClearFormatting
               .Selection.Find.Text = "|#" & strName & "#|"
               .Selection.Find.Replacement.Text = ""
               .Selection.Find.Forward = True
               .Selection.Find.Wrap = wdFindContinue
               .Selection.Find.Format = False
               .Selection.Find.MatchCase = False
               .Selection.Find.MatchWholeWord = False
               .Selection.Find.MatchWildcards = False
               .Selection.Find.MatchSoundsLike = False
               .Selection.Find.MatchAllWordForms = False
               .Selection.Find.MatchByte = True
               .Selection.Find.Execute
               .Selection.Delete
               .Selection.Font.ColorIndex = wdBlack
               .Selection.TypeText strText
            End If
         Next i
      Next j
      '合計\付款方式
      For i = 1 To 6
         strName = ""
         strText = ""
         Select Case i
            Case 1
               strName = "服務小計"
               If lngAmount1 > 0 Then
                  strText = Format(lngAmount1, DDollar)
'               Else
'                  strText = "0"
               End If
            Case 2
               strName = "規費小計"
               If lngAmount2 > 0 Then
                  strText = Format(lngAmount2, DDollar)
'               Else
'                  strText = "0"
               End If
            Case 3
               strName = "總計"
               dblTotAmt = lngAmount1 + lngAmount2
               strText = "NTD" & Format(dblTotAmt, DDollar)
            Case 4
               strName = "總計新台幣"
               strText = ChangeNumber(CStr(dblTotAmt))
            Case 5
               strName = "戶名"
               strText = A0802Query("L")
            Case 6
               strName = "支票抬頭"
               strText = A0802Query("L")
         End Select
         If Trim(strName) <> "" Then
            .Selection.Find.ClearFormatting
            .Selection.Find.Text = "|#" & strName & "#|"
            .Selection.Find.Replacement.Text = ""
            .Selection.Find.Forward = True
            .Selection.Find.Wrap = wdFindContinue
            .Selection.Find.Format = False
            .Selection.Find.MatchCase = False
            .Selection.Find.MatchWholeWord = False
            .Selection.Find.MatchWildcards = False
            .Selection.Find.MatchSoundsLike = False
            .Selection.Find.MatchAllWordForms = False
            .Selection.Find.MatchByte = True
            .Selection.Find.Execute
            .Selection.Delete
            .Selection.Font.ColorIndex = wdBlack
            .Selection.TypeText strText
         End If
      Next i
      
      'Add By Sindy 2020/11/20 加浮水印
      If bolTextEffect = True Then
         .ActiveDocument.Sections(1).Range.Select
         .ActiveDocument.Shapes.AddTextEffect( _
             1, "非正式收據", "新細明體", 90, False, False, 0, 0).Select
         .Selection.ShapeRange.TextEffect.NormalizedHeight = False
         .Selection.ShapeRange.Line.Visible = False
         .Selection.ShapeRange.Fill.Visible = True
         .Selection.ShapeRange.Fill.Solid
         .Selection.ShapeRange.Fill.ForeColor.RGB = RGB(255, 0, 0)
         .Selection.ShapeRange.Fill.Transparency = 0.5
         .Selection.ShapeRange.Rotation = 315
         .Selection.ShapeRange.LockAspectRatio = True
         .Selection.ShapeRange.Height = .CentimetersToPoints(3.17)
         .Selection.ShapeRange.Width = .CentimetersToPoints(12.7)
'         .Selection.ShapeRange.WrapFormat.AllowOverlap = True
         .Selection.ShapeRange.WrapFormat.Side = wdWrapNone
         .Selection.ShapeRange.WrapFormat.Type = 3
         .Selection.ShapeRange.RelativeHorizontalPosition = _
             wdRelativeVerticalPositionMargin
         .Selection.ShapeRange.RelativeVerticalPosition = _
             wdRelativeVerticalPositionMargin
         .Selection.ShapeRange.Left = -999995 'wdShapeCenter
         .Selection.ShapeRange.Top = -999995 'wdShapeCenter
         .ActiveWindow.ActivePane.View.SeekView = wdSeekMainDocument
      End If
      '2020/11/20 END
      
      'Add By Sindy 2020/11/20 用Word轉Pdf功能
      If strPdfFileNm <> "" Then
         TmpDirNm = Mid(strPdfFileNm, 1, InStrRev(strPdfFileNm, "\") - 1)
         strSaveFileName = Mid(strPdfFileNm, InStrRev(strPdfFileNm, "\") + 1, Len(strPdfFileNm) - 4 - InStrRev(strPdfFileNm, "\"))
         frmPDF.Show
         If pub_Word2Pdf Then
            g_WordAp.ActiveDocument.ExportAsFixedFormat OutputFileName:=TmpDirNm & "\" & strSaveFileName & ".pdf", ExportFormat:=17, OpenAfterExport:=False
         Else
            '轉PDF
            frmPDF.StartProcess TmpDirNm, strSaveFileName
            '切換印表機
            If PUB_PdfCreatorNameInWord = "" Then PUB_PdfCreatorNameInWord = PUB_GetCreatorNameInWord
            g_WordAp.ActivePrinter = PUB_PdfCreatorNameInWord
            g_WordAp.ActiveDocument.PrintOut Background:=False, Copies:=1, Collate:=True
            frmPDF.EndtProcess
         End If
         Unload frmPDF
         g_WordAp.Quit wdDoNotSaveChanges
         Set g_WordAp = Nothing 'Added by Morgan 2025/9/10
      Else
         .ActiveDocument.Save
         .ActiveDocument.PrintOut Background:=False, Copies:=1, Collate:=True
         'Modified by Morgan 2025/9/11 換變數
         'If pub_OsPrinter <> "" Then PUB_WaitUntilNoJob pub_OsPrinter 'Added by Morgan 2025/9/3 有發生漏印，加檢查印表機已清空才繼續
         If pub_OsPrinterA <> "" Then PUB_WaitUntilNoJob pub_OsPrinterA
         g_WordAp.ActiveDocument.Close
         'g_WordAp.Quit 'Removed by Morgan 2025/9/8 改系統結束時執行，因重複啟動Word會慢
      End If
   End With
   'Set g_WordAp = Nothing 'Removed by Morgan 2025/9/8 改系統結束時執行，因重複啟動Word會慢
   
   If pstrPritDate <> "" Then
      adoTaie.Execute "update acc0k0 set a0k02=" & pstrPritDate & ",a0k19 = " & intTimes & " where a0k01 = '" & padoacc0k0.Fields("a0k01").Value & "'"
   Else
      adoTaie.Execute "update acc0k0 set a0k19 = " & intTimes & " where a0k01 = '" & padoacc0k0.Fields("a0k01").Value & "'"
   End If
   
EXITSUB:
   Set adocaseprogress = Nothing
   Set adoquery = Nothing
   
   Exit Sub
   
ErrHand:
   If Err.Number = 462 Then '遠端伺服器不存在或無法使用
      GoTo RestarWord
   ElseIf Err.Number <> 0 Then
      MsgBox (Err.Description)
      If Not g_WordAp Is Nothing Then
         g_WordAp.Quit
         Set g_WordAp = Nothing
      End If
   End If
   
   Set adocaseprogress = Nothing
   Set adoquery = Nothing
End Sub

''Add By Sindy 2013/12/4
''pintTimes:列印次數,pintPrintUniNo:列印統一編號,pintPrintCustCaseNo:列印客戶案件案號,pintNoPrintPatentYear:不列印專利年費年度
''pstrRePrint:是否補開(Y/N),pstrNewDesc1:案件性質名稱1,pstrNewDesc2:案件性質名稱2,pstrPritDate:列印日期
''Move by Lydia 2020/03/26 從aacc_fun搬來
''Modify by Sindy 2020/11/23 + , Optional bolTextEffect As Boolean = False : 加浮水印
'Public Sub PUB_PrintCaseReceipt_J(padoacc0k0 As ADODB.Recordset, pintPrintUniNo As Integer, _
'   pintPrintCustCaseNo As Integer, Optional pintNoPrintPatentYear As Integer, _
'   Optional pstrRePrint As String, Optional pstrNewDesc1 As String, Optional pstrNewDesc2 As String, _
'   Optional pstrPritDate As String, Optional pbolUpdateTimes As Boolean = True, _
'   Optional bolTextEffect As Boolean = False)
'
'   Dim intTimes As Integer
'   Dim strTemp As String
'   Dim StrSQLa As String, intR As Integer
'   Dim adocaseprogress As ADODB.Recordset
'   Dim adoquery As ADODB.Recordset
'   Dim douService As Double '已銷服務費
'   Dim douFee As Double '已銷規費
'   Dim lngAmount1 As Long, lngAmount2 As Long
'   Dim strAmount1 As String, strAmount2 As String
'   Dim intList As Integer
'   Dim strPA08 As String, strPA09 As String
'   Dim strFeeType As String, strYF15 As String
'   Dim strKey(5) As String
'   Dim strCaseFee(1 To 2) As String
'   Dim bFind As Boolean
'   Dim varRef As Variant
'   Dim strProduct As String '商品類別
'   Dim strCustCaseNo As String '客戶案件案號
'   Dim m_FixNo As Integer   '2010/2/12 add by sonia 修法次數
'   'Dim strDesc As String, ii As Integer
'   Dim strItemDesc As String '帳款類別
'   Dim lngItemAmount1 As Long, lngItemAmount2 As Long
'   Dim lngX As Long, lngXE As Long
'   Dim PLeft(1 To 5) As Integer
'   Dim lngAmt As Long
'   Dim strCaseName As String, strNation As String, strCaseNo As String
'   Dim strA0j20 As String, strA0j21 As String, strA0j23 As String, strA0j24 As String 'Modified by Morgan 2017/11/16 +a0j21
'   Dim intRow As Integer 'Add By Sindy 2014/4/8
'   Dim m_strCP01 As String, m_strCP10 As String 'Add By Sindy 2020/11/11
'
'   With padoacc0k0
'
'   'Add By Sindy 2020/11/11
'   m_strCP01 = .Fields("CP01").Value
'   m_strCP10 = .Fields("CP10").Value
'   '2020/11/11 END
'
'   If IsNull(.Fields("a0k19").Value) Then
'      intTimes = 1
'   ElseIf pbolUpdateTimes = False Then
'      intTimes = Val(.Fields("a0k19").Value)
'   Else
'      intTimes = Val(.Fields("a0k19").Value) + 1
'   End If
'
''   If .Fields("a0k01").Value = "E10229695" Then
''      MsgBox .Fields("a0k01").Value
''   End If
'
'   '檢查是否已全銷
'   If Not IsNull(padoacc0k0.Fields("a0k10")) Then
'      StrSQLa = "select nvl(sum(a1u07),0)+nvl(sum(a1u09),0) from acc1u0 where a1u02='" & padoacc0k0.Fields("a0k01") & "'"
'      intR = 1
'      Set adoquery = ClsLawReadRstMsg(intR, StrSQLa)
'      If intR = 1 Then
'         If adoquery.Fields(0) >= Val("" & padoacc0k0.Fields("a0k06")) + Val("" & padoacc0k0.Fields("a0k07")) Then
'            adoquery.Close
'            GoTo EXITSUB
'         End If
'      End If
'      adoquery.Close
'   End If
'
'   'Modify by Sindy 2020/11/23 加浮水印
'   If bolTextEffect = True Then
'      Dim tObj As New StdPicture
'      Set tObj = pvGetStdPicture(App.path & "\" & strUserNum & "\$$M51000089000.jpg")
''      pTop = 0 '7780 + ((iLineCount - 35) * iLineHeight)
''      PLeft_P = 0
''      pWidth = 4200
''      pHeight = 4380
''      If tObj.Height >= tObj.Width Then  '以高為準
''          pWidthNew = tObj.Width / (tObj.Height / pHeight)
''          PLeft_P = PLeft_P + ((pWidth - pWidthNew) / 2)
''          pWidth = pWidthNew
''      Else   '已寬為準
''          pHeightNew = tObj.Height / (tObj.Width / pWidth)
''          pTop = pTop + ((pHeight - pHeightNew) / 2)
''          pHeight = pHeightNew
''      End If
'      '改乘於比例的方式來調整圖片大小
'      'Printer.PaintPicture tObj, 100, pTop, (pWidth / 100 * 85), (pHeight / 100 * 85)
'      'Printer.PaintPicture tObj, 4000, 5500, tObj.Width / 1.8, tObj.Height / 1.8
'      Printer.PaintPicture tObj, 4000, 5500, tObj.Width / 2.8, tObj.Height / 2.8
'   End If
'   '2020/11/23 END
'
'   PUB_PrintReceiptHead_J padoacc0k0, intTimes, pintPrintUniNo, pstrRePrint, pstrPritDate, pintPrintCustCaseNo
'
'   '畫表格
'   lngX = 700
'   lngXE = 11000
'   Printer.DrawStyle = vbSolid
'   Printer.DrawWidth = 1
'   For intList = 0 To 7
'      If intList >= 6 Then
'         'Printer.Line (9000, 5100 + (intList * 800))-(lngXE, 5100 + ((intList + 1) * 800)), , B
'         If intList = 7 Then
'            Printer.Line (9000, 5100 + ((intList - 2) * 800))-(lngXE, 5100 + ((intList + 1) * 800)), , B
'            Printer.Line (lngX, 5100 + ((intList - 1) * 800))-(9000, 5100 + ((intList + 1) * 800)), , B
'            '橫線
'            Printer.Line (7500, 10450)-(lngXE, 10450), , B
'            Printer.Line (7500, 11000)-(lngXE, 11000), , B
'         End If
'      Else
'         If intList = 0 Then
'            Printer.DrawWidth = 15
'         Else
'            Printer.DrawWidth = 1
'         End If
'         Printer.Line (lngX, 5100 + (intList * 800))-(lngXE, 5100 + ((intList + 1) * 800)), , B
'      End If
'   Next intList
'
'   '直線
'   Printer.Line (lngX, 5100)-(2250, 9900), , B
'   'Printer.Line (lngX, 5100)-(8000, 11500), , B
'   Printer.Line (7500, 9900)-(7500, 11500), , B
'   Printer.Line (9000, 5100)-(9000, 9900), , B
'
'   PLeft(1) = 700 + 30
'   PLeft(2) = 2250 + 30
'   'PLeft(3) = 9750 - 50
'   PLeft(3) = lngXE - 50
'   lngXE = 5180
'
'   Printer.CurrentX = PLeft(1)
'   Printer.CurrentY = lngXE + (0 * 400)
'   Printer.Print "本所案號"
'   Printer.CurrentX = PLeft(2)
'   Printer.CurrentY = lngXE + (0 * 400)
'   Printer.Print "案件性質"
'   Printer.CurrentX = PLeft(2)
'   Printer.CurrentY = lngXE + (1 * 400)
'   Printer.Print "案件名稱/申請國家"
'   Printer.CurrentX = PLeft(3) - Printer.TextWidth("應收金額")
'   Printer.CurrentY = lngXE + (0 * 400)
'   Printer.Print "應收金額"
''   Printer.CurrentX = PLeft(4) - Printer.TextWidth("營業稅")
''   Printer.CurrentY = lngXE + (0 * 400)
''   Printer.Print "營業稅"
'   Printer.CurrentX = PLeft(1)
'   Printer.CurrentY = lngXE + (12 * 400)
'   Printer.Print "總計新台幣"
'   Printer.CurrentX = 7530
'   Printer.CurrentY = lngXE + (12 * 400)
'   Printer.Print "小　計"
'   Printer.CurrentX = 7530
'   Printer.CurrentY = 10480
'   Printer.Print "營業稅"
'   Printer.CurrentX = 7530
'   Printer.CurrentY = 11030
'   Printer.Print "總　計"
'
'   '帳款類別變更
'   If IsNull(.Fields("a0k33")) = False Then
'      '收文日(最小)
'      StrSQLa = "select * " & _
'         " from acc0j0,caseprogress,nation where a0j13='" & .Fields("a0k01").Value & "' and cp09(+)=a0j01 and na01(+)=a0j04 and (cp79 <> 0 or (cp79 = 0 and cp75 <> 0)) " & _
'         " order by a0j25 asc"
'      intR = 1
'      Set adocaseprogress = ClsLawReadRstMsg(intR, StrSQLa)
'      intRow = 0 'Add By Sindy 2014/4/8
'      If intR = 1 Then
'         strItemDesc = adocaseprogress.Fields("a0j22") '帳款類別
'         lngAmount1 = 0 '累計的
'         lngAmount2 = 0
'         intList = 2
'         strNation = "": strCaseName = "": strProduct = "": strCaseNo = "": strA0j20 = "": strA0j21 = "": strA0j23 = "": strA0j24 = ""
'         Do While Not adocaseprogress.EOF
'            intRow = intRow + 1 'Add By Sindy 2014/4/8
'            If strItemDesc <> adocaseprogress.Fields("a0j22") Then '帳款類別
'               If lngItemAmount1 > 0 Then
'                  '列印本所案號,申請國家,案件名稱,客戶案件案號
'                  If strA0j20 = "" Or strA0j21 = "" Or strA0j23 = "" Or strA0j24 = "" Then
'                     If strA0j21 = "" Then '否不印案號
'                        '案號
'                        Printer.CurrentX = PLeft(1)
'                        Printer.CurrentY = lngXE + (intList * 400)
'                        Printer.Print strCaseNo
'                     End If
'                     strTemp = IIf(strProduct <> "", " ", "") & Trim(strProduct & IIf(strNation <> "", "/", "") & strNation)
'                     Printer.CurrentX = PLeft(2)
'                     Printer.CurrentY = lngXE + (intList * 400) + 400
'                     If Len(Trim(strCaseName) & strTemp) > 28 Then
'                        strTemp = Left(Trim(strCaseName), 28 - Len(strTemp)) & "..." & strTemp
'                     Else
'                        strTemp = Trim(strCaseName) & strTemp
'                     End If
'                     Printer.Print strTemp
'                  End If
'
'                  '帳款類別
'                  Printer.CurrentX = PLeft(2)
'                  Printer.CurrentY = lngXE + (intList * 400)
'                  Printer.Print strItemDesc
'
'                  lngAmount2 = lngAmount2 + lngItemAmount2
'                  'Added by Sindy 2021/10/18 J公司請款單之收文若為ACS案且案件性質706代收代付時，列印請款單營業稅固定為0，不算稅
'                  If m_strCP01 = "ACS" And m_strCP10 = "706" Then
'                     '應收金額
'                     If lngItemAmount1 > 0 Then
'                        strAmount1 = Format(lngItemAmount1, DDollar)
'                     Else
'                        strAmount1 = 0
'                     End If
'                  Else
'                  '2021/10/18 END
'                     '應收金額
'                     If lngItemAmount1 > 0 Then
'                        'Add By Sindy 2014/4/8 計算後可能會有差額1,2元;最後一筆要攤平 ex.E10309340
'                        If intRow = adocaseprogress.RecordCount Then
'                           lngItemAmount1 = Round((lngAmount2 / 1.05)) - lngAmount1
'                        End If
'                        '2014/4/8 END
'                        strAmount1 = Format(lngItemAmount1, DDollar)
'                     Else
'                        strAmount1 = 0
'                     End If
'                  End If
'                  lngAmount1 = lngAmount1 + lngItemAmount1
'
'                  Printer.CurrentX = PLeft(3) - Printer.TextWidth(strAmount1)
'                  Printer.CurrentY = lngXE + (intList * 400)
'                  Printer.Print strAmount1
'
''                  '營業稅
''                  If lngItemAmount2 > 0 Then
''                     strAmount2 = Format(lngItemAmount2, DDollar)
''                  Else
''                     strAmount2 = 0
''                  End If
''                  Printer.CurrentX = PLeft(4) - Printer.TextWidth(strAmount2)
''                  Printer.CurrentY = lngXE + (intList * 400)
''                  Printer.Print strAmount2
'               End If
'
'               lngItemAmount1 = 0
'               lngItemAmount2 = 0
'               strNation = "": strCaseName = "": strProduct = "": strCaseNo = "": strA0j21 = "": strA0j23 = "": strA0j24 = ""
'
'               '帳款類別
'               strItemDesc = adocaseprogress.Fields("a0j22")
'               intList = intList + 2
'            End If
'
'            If strCaseNo = "" Then
'               '列印本所案號,申請國家,案件名稱,客戶案件案號
'               strCaseNo = adocaseprogress.Fields("a0j02") '本所案號
'               strA0j20 = "" & adocaseprogress.Fields("a0j20")
'               strA0j21 = "" & adocaseprogress.Fields("a0j21")
'               strA0j23 = "" & adocaseprogress.Fields("a0j23")
'               strA0j24 = "" & adocaseprogress.Fields("a0j24")
'               If Right(strCaseNo, 3) = "000" Then
'                  strCaseNo = Left(strCaseNo, Len(strCaseNo) - 3)
'               End If
'
'               'Modified by Morgan 2017/11/17 案號、國家與商類別都拆開設定
'               'If strA0j23 = "" Then
'               If strA0j20 = "" Then '是否不印商品類別
'               'end 2017/11/17
'                  '查名案加印商品類別
'                  If adocaseprogress.Fields("cp01").Value = "S" Or adocaseprogress.Fields("cp01").Value = "TS" Then
'                     StrSQLa = "select SP18 as tm09 from SERVICEPRACTICE where SP01 = '" & adocaseprogress.Fields("cp01").Value & "' and SP02 = '" & adocaseprogress.Fields("cp02").Value & "' and SP03 = '" & adocaseprogress.Fields("cp03").Value & "' and SP04 = '" & adocaseprogress.Fields("cp04").Value & "'"
'                  Else
'                     StrSQLa = "select tm09 from trademark where tm01 = '" & adocaseprogress.Fields("cp01").Value & "' and tm02 = '" & adocaseprogress.Fields("cp02").Value & "' and tm03 = '" & adocaseprogress.Fields("cp03").Value & "' and tm04 = '" & adocaseprogress.Fields("cp04").Value & "'"
'                  End If
'                  intR = 1
'                  Set adoquery = ClsLawReadRstMsg(intR, StrSQLa)
'                  If intR = 1 Then
'                     If IsNull(adoquery.Fields("tm09").Value) = False Then
'                        varRef = Split(adoquery.Fields("tm09").Value, ",")
'                        If UBound(varRef) > 4 Then
'                           strProduct = "第" & varRef(0) & "," & varRef(1) & "," & varRef(2) & "," & varRef(3) & "," & varRef(4) & "...類"
'                        Else
'                           strProduct = "第" & adoquery.Fields("tm09").Value & " 類"
'                        End If
'                     End If
'                  End If
'                  adoquery.Close
'               End If
'               If strA0j23 = "" Then
'                  '國家
'                  If IsNull(adocaseprogress.Fields("na03").Value) = False Then
'                     strNation = adocaseprogress.Fields("na03").Value
'                  End If
'               End If
'               If strA0j24 = "" Then '是否不印案件名稱
'                  '列印案件名稱(以總收文號查詢)及客戶案件名稱(Optional)
'                  strCaseName = CaseNameQuery(adocaseprogress.Fields("a0j01").Value, 1, strCustCaseNo)
'                  If strCaseName = "" Then
'                     strCaseName = CaseNameQuery(adocaseprogress.Fields("a0j01").Value, 2)
'                  End If
'               End If
'            End If
'
'            douService = 0
'            douFee = 0
'            '有銷帳
'            If IsNull(.Fields("a0k10")) = False Then
'               StrSQLa = "select sum(a1u07), sum(a1u09) from acc1u0 where a1u02 = '" & .Fields("a0k01").Value & "' and a1u03='" & adocaseprogress.Fields("a0j01") & "'"
'               intR = 1
'               Set adoquery = ClsLawReadRstMsg(intR, StrSQLa)
'               If intR = 1 Then
'                  If IsNull(adoquery.Fields(0).Value) = False Then
'                     douService = Val(adoquery.Fields(0).Value)
'                  End If
'                  If IsNull(adoquery.Fields(1).Value) = False Then
'                     douFee = Val(adoquery.Fields(1).Value)
'                  End If
'               End If
'               adoquery.Close
'            End If
'
'            '應收金額=服務費+規費-銷帳服務費-銷帳規費
'            lngAmt = Val("" & adocaseprogress.Fields("a0j09")) + Val("" & adocaseprogress.Fields("a0j10")) - douService - douFee
'            'Added by Sindy 2021/10/18 J公司請款單之收文若為ACS案且案件性質706代收代付時，列印請款單營業稅固定為0，不算稅
'            If m_strCP01 = "ACS" And m_strCP10 = "706" Then
'               lngItemAmount1 = lngItemAmount1 + lngAmt
'               lngItemAmount2 = 0
'            Else
'            '2021/10/18 END
'               'lngItemAmount1 = lngItemAmount1 + lngAmt - (lngAmt - Round((lngAmt / 1.05)))
'               lngItemAmount1 = lngItemAmount1 + Round((lngAmt / 1.05))
'   '            '營業稅
'   '            lngItemAmount2 = lngItemAmount2 + (lngAmt - Round((lngAmt / 1.05)))
'               lngItemAmount2 = lngItemAmount2 + lngAmt
'            End If
'
'            adocaseprogress.MoveNext
'         Loop
'         adocaseprogress.Close
'
'         If lngItemAmount1 > 0 Then
'            '列印本所案號,申請國家,案件名稱,客戶案件案號
'            If strA0j20 = "" Or strA0j21 = "" Or strA0j23 = "" Or strA0j24 = "" Then
'               If strA0j21 = "" Then
'                  '案號
'                  Printer.CurrentX = PLeft(1)
'                  Printer.CurrentY = lngXE + (intList * 400)
'                  Printer.Print strCaseNo
'               End If
'               strTemp = IIf(strProduct <> "", " ", "") & Trim(strProduct & IIf(strNation <> "", "/", "") & strNation)
'               Printer.CurrentX = PLeft(2)
'               Printer.CurrentY = lngXE + (intList * 400) + 400
'               If Len(Trim(strCaseName) & strTemp) > 28 Then
'                  strTemp = Left(Trim(strCaseName), 28 - Len(strTemp)) & "..." & strTemp
'               Else
'                  strTemp = Trim(strCaseName) & strTemp
'               End If
'               Printer.Print strTemp
'            End If
'
'            '帳款類別
'            Printer.CurrentX = PLeft(2)
'            Printer.CurrentY = lngXE + (intList * 400)
'            Printer.Print strItemDesc
'
'            lngAmount2 = lngAmount2 + lngItemAmount2
'            'Added by Sindy 2021/10/18 J公司請款單之收文若為ACS案且案件性質706代收代付時，列印請款單營業稅固定為0，不算稅
'            If m_strCP01 = "ACS" And m_strCP10 = "706" Then
'               '應收金額
'               If lngItemAmount1 > 0 Then
'                  strAmount1 = Format(lngItemAmount1, DDollar)
'               Else
'                  strAmount1 = 0
'               End If
'            Else
'            '2021/10/18 END
'               '應收金額
'               If lngItemAmount1 > 0 Then
'                  'Add By Sindy 2014/4/8 計算後可能會有差額1,2元;最後一筆要攤平 ex.E10309340
'                  'If intRow = adocaseprogress.RecordCount Then
'                     lngItemAmount1 = Round((lngAmount2 / 1.05)) - lngAmount1
'                  'End If
'                  '2014/4/8 END
'                  strAmount1 = Format(lngItemAmount1, DDollar)
'               Else
'                  strAmount1 = 0
'               End If
'            End If
'            lngAmount1 = lngAmount1 + lngItemAmount1
'
'            Printer.CurrentX = PLeft(3) - Printer.TextWidth(strAmount1)
'            Printer.CurrentY = lngXE + (intList * 400)
'            Printer.Print strAmount1
'
''            '營業稅
''            If lngItemAmount2 > 0 Then
''               strAmount2 = Format(lngItemAmount2, DDollar)
''            Else
''               strAmount2 = 0
''            End If
''            Printer.CurrentX = PLeft(4) - Printer.TextWidth(strAmount2)
''            Printer.CurrentY = lngXE + (intList * 400)
''            Printer.Print strAmount2
'         End If
'      End If
'
'   Else
'      intList = 2
'      '收據明細資料
'      StrSQLa = "select a.*,b.*,getcp10desc(cp01,cp10,a0j04) cp10N,na03 from acc0j0 a,caseprogress b,nation where a0j13 = '" & .Fields("a0k01").Value & "' And cp09(+)=a0j01 and (cp79 <> 0 or (cp79 = 0 and cp75 <> 0)) and na01(+)=a0j04 ORDER BY CP09 "
'      intR = 1
'      Set adocaseprogress = ClsLawReadRstMsg(intR, StrSQLa)
'      intRow = 0 'Add By Sindy 2014/4/8
'      lngAmount1 = 0: lngAmount2 = 0 '累計的
'      If intR = 1 Then
'         Do While adocaseprogress.EOF = False
'            intRow = intRow + 1 'Add By Sindy 2014/4/8
'            douService = 0
'            douFee = 0
'            '有銷帳
'            If adocaseprogress.Fields("cp77") > 0 Then
'               '銷帳=費用時不印
'               If adocaseprogress.Fields("cp77") = adocaseprogress.Fields("cp16") Then
'                  GoTo NextRecord
'               Else
'                  '抓收款資料
'                  StrSQLa = "select sum(a1u07), sum(a1u09) from acc1u0 where a1u03 = '" & adocaseprogress.Fields("cp09").Value & "' and a1u02='" & .Fields("a0k01").Value & "'"
'                  intR = 1
'                  Set adoquery = ClsLawReadRstMsg(intR, StrSQLa)
'                  If intR = 1 Then
'                     If IsNull(adoquery.Fields(0).Value) = False Then
'                        douService = Val(adoquery.Fields(0).Value)
'                     End If
'                     If IsNull(adoquery.Fields(1).Value) = False Then
'                        douFee = Val(adoquery.Fields(1).Value)
'                     End If
'                  End If
'                  adoquery.Close
'               End If
'            End If
'
'            strTemp = adocaseprogress.Fields("cp10N").Value
'            '不列印專利年費年度
'            If pintNoPrintPatentYear > 0 Then
'               Printer.CurrentX = PLeft(2)
'               Printer.CurrentY = lngXE + (intList * 400)
'               Printer.Print strTemp '案件性質
'
'            Else
'               '加印繳費年度說明
'               If ((adocaseprogress.Fields("cp01").Value = "P" And adocaseprogress.Fields("cp10").Value = "601") Or _
'                     ((adocaseprogress.Fields("cp01").Value = "P" Or adocaseprogress.Fields("cp01").Value = "CFP") And _
'                     (adocaseprogress.Fields("cp10").Value = "605" Or adocaseprogress.Fields("cp10").Value = "606" Or adocaseprogress.Fields("cp10").Value = "607"))) And _
'                  adocaseprogress.Fields("cp53").Value <> "" And _
'                  adocaseprogress.Fields("cp54").Value <> "" Then
'                  strSql = "SELECT * FROM patent WHERE pa01='" & adocaseprogress.Fields("cp01").Value & "' and pa02='" & adocaseprogress.Fields("cp02").Value & "' and pa03='" & adocaseprogress.Fields("cp03").Value & "' and pa04='" & adocaseprogress.Fields("cp04").Value & "' "
'                  intI = 1
'                  Set RsTemp = ClsLawReadRstMsg(intI, strSql)
'                  If intI = 1 Then
'                     strPA08 = RsTemp("PA08")
'                     strPA09 = RsTemp("PA09")
'                  End If
'                  strKey(0) = ""
'                  strKey(1) = adocaseprogress.Fields("cp01").Value
'                  strKey(2) = adocaseprogress.Fields("cp02").Value
'                  strKey(3) = adocaseprogress.Fields("cp03").Value
'                  strKey(4) = adocaseprogress.Fields("cp04").Value
'                  '抓修法次數
'                  bFind = GetMoneyDate(strPA08, strPA09, strKey, strCaseFee(1), strCaseFee(2), , , m_FixNo)
'                  If bFind Then
'                     If IsEmptyText(strCaseFee(2)) = False Then
'                        varRef = Split(strCaseFee(2), ",")
'                        strFeeType = PUB_GetNa20Na22Na24(strPA09, strPA08)
'                        If adocaseprogress.Fields("cp10").Value = "605" Or _
'                           adocaseprogress.Fields("cp10").Value = "601" Then
'                           strYF15 = PUB_GetYF15(strPA09, strPA08, "Y000000" & m_FixNo, strFeeType, CDbl(Val(adocaseprogress.Fields("cp53").Value)))
'                        Else
'                           strYF15 = PUB_GetYF15(strPA09, strPA08, "Y000000" & m_FixNo, strFeeType, Val(varRef(Val(adocaseprogress.Fields("cp53").Value) - 1)))
'                        End If
'                        Printer.FontSize = 11
'                        Printer.CurrentX = PLeft(2)
'                        Printer.CurrentY = lngXE + (intList * 400)
'                        If Val(adocaseprogress.Fields("cp53").Value) = Val(adocaseprogress.Fields("cp54").Value) Then
'                           Printer.Print strTemp & " " & strYF15
'                        Else
'                           If adocaseprogress.Fields("cp10").Value = "605" Or _
'                              adocaseprogress.Fields("cp10").Value = "601" Then
'                              Printer.Print strTemp & " (" & strYF15 & "至" & PUB_GetYF15(strPA09, strPA08, "Y000000" & m_FixNo, strFeeType, CDbl(Val(adocaseprogress.Fields("cp54").Value))) & ")"
'                           Else
'                              Printer.Print strTemp & " (" & strYF15 & "至" & PUB_GetYF15(strPA09, strPA08, "Y000000" & m_FixNo, strFeeType, Val(varRef(Val(adocaseprogress.Fields("cp54").Value) - 1))) & ")"
'                           End If
'                        End If
'                     End If
'                  End If
'               Else
'                  Printer.CurrentX = PLeft(2)
'                  Printer.CurrentY = lngXE + (intList * 400)
'                  Printer.Print strTemp '案件性質
'               End If
'            End If
'
'            '有應收金額
'            If Val("" & adocaseprogress.Fields("a0j09").Value) + Val("" & adocaseprogress.Fields("a0j10").Value) > 0 Then
'               '應收金額=服務費+規費-銷帳服務費-銷帳規費
'               lngAmt = Val("" & adocaseprogress.Fields("a0j09")) + Val("" & adocaseprogress.Fields("a0j10")) - douService - douFee
'               'strAmount1 = Format(lngAmt - (lngAmt - Round((lngAmt / 1.05))), DDollar)
'               'Added by Sindy 2020/11/11 J公司請款單之收文若為ACS案且案件性質706代收代付時，列印請款單營業稅固定為0，不算稅
'               If m_strCP01 = "ACS" And m_strCP10 = "706" Then
'                  strAmount1 = Format(lngAmt, DDollar)
'                  lngAmount2 = 0 'lngAmount2 + lngAmt
'                  lngAmount1 = lngAmount1 + Val(Format(strAmount1))
'               Else
'               '2020/11/11 END
'                  strAmount1 = Round((lngAmt / 1.05))
'                  lngAmount2 = lngAmount2 + lngAmt
'                  'Add By Sindy 2014/4/8 計算後可能會有差額1,2元;最後一筆要攤平 ex.E10309340
'                  If Val(strAmount1) > 0 Then
'                     If intRow = adocaseprogress.RecordCount Then
'                        strAmount1 = Round((lngAmount2 / 1.05)) - lngAmount1
'                     End If
'                     strAmount1 = Format(strAmount1, DDollar)
'                  End If
'                  '2014/4/8 END
'                  lngAmount1 = lngAmount1 + Val(Format(strAmount1))
'               End If
'
'               Printer.CurrentX = PLeft(3) - Printer.TextWidth(strAmount1)
'               Printer.CurrentY = lngXE + (intList * 400)
'               If strAmount1 = "" Then
'                  Printer.Print "0"
'               Else
'                  Printer.Print strAmount1
'               End If
'
''               '營業稅
''               strAmount2 = Format(lngAmt - Round((lngAmt / 1.05)), DDollar)
''               Printer.CurrentX = PLeft(4) - Printer.TextWidth(strAmount2)
''               Printer.CurrentY = lngXE + (intList * 400)
''               If strAmount2 = "" Then
''                  Printer.Print "0"
''               Else
''                  Printer.Print strAmount2
''               End If
'               'lngAmount2 = lngAmount2 + Val(Format(strAmount2))
'            End If
'
'            '列印本所案號
'            Printer.CurrentX = PLeft(1)
'            Printer.CurrentY = lngXE + (intList * 400)
'            If (adocaseprogress.Fields("cp03").Value & adocaseprogress.Fields("cp04").Value) = "000" Then
'               Printer.Print adocaseprogress.Fields("cp01").Value & adocaseprogress.Fields("cp02").Value
'            Else
'               Printer.Print adocaseprogress.Fields("cp01").Value & adocaseprogress.Fields("cp02").Value & adocaseprogress.Fields("cp03").Value & adocaseprogress.Fields("cp04").Value
'            End If
'
'            strNation = "": strCaseName = "": strProduct = ""
'            '查名案加印商品類別
'            If adocaseprogress.Fields("cp01").Value = "S" Or adocaseprogress.Fields("cp01").Value = "TS" Then
'               StrSQLa = "select SP18 as tm09 from SERVICEPRACTICE where SP01 = '" & adocaseprogress.Fields("cp01").Value & "' and SP02 = '" & adocaseprogress.Fields("cp02").Value & "' and SP03 = '" & adocaseprogress.Fields("cp03").Value & "' and SP04 = '" & adocaseprogress.Fields("cp04").Value & "'"
'            Else
'               StrSQLa = "select tm09 from trademark where tm01 = '" & adocaseprogress.Fields("cp01").Value & "' and tm02 = '" & adocaseprogress.Fields("cp02").Value & "' and tm03 = '" & adocaseprogress.Fields("cp03").Value & "' and tm04 = '" & adocaseprogress.Fields("cp04").Value & "'"
'            End If
'            intR = 1
'            Set adoquery = ClsLawReadRstMsg(intR, StrSQLa)
'            If intR = 1 Then
'               If IsNull(adoquery.Fields("tm09").Value) = False Then
'                  varRef = Split(adoquery.Fields("tm09").Value, ",")
'                  If UBound(varRef) > 4 Then
'                     strProduct = "第" & varRef(0) & "," & varRef(1) & "," & varRef(2) & "," & varRef(3) & "," & varRef(4) & "...類"
'                  Else
'                     strProduct = "第" & adoquery.Fields("tm09").Value & " 類"
'                  End If
'               End If
'            End If
'            adoquery.Close
'            '列印案件名稱(以總收文號查詢)及客戶案件名稱(Optional)
'            strCaseName = CaseNameQuery(adocaseprogress.Fields("cp09").Value, 1, strCustCaseNo)
'            If strCaseName = "" Then
'               strCaseName = CaseNameQuery(adocaseprogress.Fields("cp09").Value, 2)
'            End If
'            '列印申請國家名稱
'            If IsNull(adocaseprogress.Fields("na03").Value) = False Then
'               strNation = adocaseprogress.Fields("na03").Value
'            End If
'            strTemp = IIf(strProduct <> "", " ", "") & Trim(strProduct & IIf(strNation <> "", "/", "") & strNation)
'            Printer.CurrentX = PLeft(2)
'            Printer.CurrentY = lngXE + (intList * 400) + 400
'            If Len(Trim(strCaseName) & Trim(strTemp)) > 40 Then '28
'               If Len(Trim(strTemp)) < 40 Then
'                  strTemp = Left(Trim(strCaseName), 40 - Len(Trim(strTemp))) & "..." & Trim(strTemp)
'               End If
'            Else
'               strTemp = Trim(strCaseName) & strTemp
'            End If
'            Printer.Print strTemp
'
'            intList = intList + 2
'
'NextRecord:
'            adocaseprogress.MoveNext
'         Loop
'         adocaseprogress.Close
'      End If
'
'   End If
'
'   'Modify By Sindy 2020/11/11 + , m_strCP01, m_strCP10
'   PUB_PrintReceiptSum_J lngAmount1, lngAmount2, m_strCP01, m_strCP10
'
'   If pstrPritDate <> "" Then
'      adoTaie.Execute "update acc0k0 set a0k02=" & pstrPritDate & ",a0k19 = " & intTimes & " where a0k01 = '" & .Fields("a0k01").Value & "'"
'   Else
'      adoTaie.Execute "update acc0k0 set a0k19 = " & intTimes & " where a0k01 = '" & .Fields("a0k01").Value & "'"
'   End If
'   End With
'
'EXITSUB:
'
'   Set adocaseprogress = Nothing
'   Set adoquery = Nothing
'End Sub

'Add By Sindy 2013/12/4
'pintTimes:列印次數,pintPrintUniNo:列印統一編號,pintPrintCustCaseNo:列印客戶案件案號,pintNoPrintPatentYear:不列印專利年費年度
'pstrRePrint:是否補開(Y/N),pstrNewDesc1:案件性質名稱1,pstrNewDesc2:案件性質名稱2,pstrPritDate:列印日期
'Move by Lydia 2020/03/26 從aacc_fun搬來
'Modify by Sindy 2020/11/23 + , Optional bolTextEffect As Boolean = False : 加浮水印
'Modify By Sindy 2021/12/29 因Form2.0不能用Printer, 改用Word範本
'pFileFullPath:收據的Word範本
'Modify By Sindy 2022/8/12 + , Optional strPdfFileNm As String = "" : 產生PDF電子檔
Public Sub PUB_PrintCaseReceipt_J_Doc(pFileFullPath As String, _
   padoacc0k0 As ADODB.Recordset, pintPrintUniNo As Integer, _
   pintPrintCustCaseNo As Integer, Optional pintNoPrintPatentYear As Integer, _
   Optional pstrRePrint As String, Optional pstrNewDesc1 As String, Optional pstrNewDesc2 As String, _
   Optional pstrPritDate As String, Optional pbolUpdateTimes As Boolean = True, _
   Optional bolTextEffect As Boolean = False, Optional strPdfFileNm As String = "")
   
   Dim intTimes As Integer
   Dim strTemp As String
   Dim StrSQLa As String, intR As Integer
   Dim adocaseprogress As ADODB.Recordset
   Dim adoquery As ADODB.Recordset
   Dim douService As Double '已銷服務費
   Dim douFee As Double '已銷規費
   Dim lngAmount1 As Long, lngAmount2 As Long
   Dim strCaseNote(1 To 6) As String '請參 m_intRecMaxItem
   Dim strAmount1(1 To 6) As String, strAmount2 As String, strAmount1T As String
   Dim strKey(6) As String
   Dim strCaseName As String, strNation As String, strCaseNo(1 To 6) As String
   Dim strCaseFee(1 To 2) As String
   Dim PLeft(1 To 5) As Integer
   Dim intList As Integer
   Dim strPA08 As String, strPA09 As String
   Dim strFeeType As String, strYF15 As String
   Dim bFind As Boolean
   Dim varRef As Variant
   Dim strProduct As String '商品類別
   Dim strCustCaseNo As String '客戶案件案號
   Dim m_FixNo As Integer   '2010/2/12 add by sonia 修法次數
   'Dim strDesc As String, ii As Integer
   Dim strItemDesc As String '帳款類別
   Dim lngItemAmount1 As Long, lngItemAmount2 As Long
   Dim lngX As Long, lngXE As Long
   Dim lngAmt As Long
   Dim strA0j20 As String, strA0j21 As String, strA0j23 As String, strA0j24 As String 'Modified by Morgan 2017/11/16 +a0j21
   Dim intRecPos As Integer 'Add By Sindy 2014/4/8 目前指向第幾筆資料
   Dim m_strCP01 As String, m_strCP10 As String 'Add By Sindy 2020/11/11
   Dim strFileName As String
   Dim i As Integer, j As Integer
   Dim strName As String, strText As String
   Dim strTmp As String, strTmp2 As String, strAddr As String, strPCC05 As String
   Dim strPA10 As String 'Added by Morgan 2022/6/13
   Dim TmpDirNm As String, strSaveFileName As String 'Add By Sindy 2022/8/12
   Dim strAccPerson As String 'Add by Amy 2024/05/14
   
   With padoacc0k0
   
   'Modify By Sindy 2022/1/17
   StrSQLa = "select * from acc0k0,acc0j0,caseprogress where a0k01='" & .Fields("a0k01").Value & "'" & _
             " and a0j13=a0k01 and a0j01=cp09"
   intR = 1
   Set adoquery = ClsLawReadRstMsg(intR, StrSQLa)
   If intR = 1 Then
      m_strCP01 = adoquery.Fields("CP01").Value
      m_strCP10 = adoquery.Fields("CP10").Value
   End If
   adoquery.Close
   'Add By Sindy 2020/11/11
'   m_strCP01 = .Fields("CP01").Value
'   m_strCP10 = .Fields("CP10").Value
   '2020/11/11 END
   
   If IsNull(.Fields("a0k19").Value) Then
      intTimes = 1
   ElseIf pbolUpdateTimes = False Then
      intTimes = Val(.Fields("a0k19").Value)
   Else
      intTimes = Val(.Fields("a0k19").Value) + 1
   End If
   
'   If .Fields("a0k01").Value = "E10229695" Then
'      MsgBox .Fields("a0k01").Value
'   End If

   '清空變數值
   intRecPos = 0
   For i = 1 To m_intRecMaxItem
      strCaseNo(i) = ""
      strCaseNote(i) = ""
      strAmount1(i) = ""
   Next i
   
   '檢查是否已全銷
   If Not IsNull(padoacc0k0.Fields("a0k10")) Then
      StrSQLa = "select nvl(sum(a1u07),0)+nvl(sum(a1u09),0) from acc1u0 where a1u02='" & padoacc0k0.Fields("a0k01") & "'"
      intR = 1
      Set adoquery = ClsLawReadRstMsg(intR, StrSQLa)
      If intR = 1 Then
         If adoquery.Fields(0) >= Val("" & padoacc0k0.Fields("a0k06")) + Val("" & padoacc0k0.Fields("a0k07")) Then
            adoquery.Close
            GoTo EXITSUB
         End If
      End If
      adoquery.Close
   End If
   
   '帳款類別變更
   If IsNull(.Fields("a0k33")) = False Then 'a0k33=Y
      '收文日(最小)
      StrSQLa = "select * " & _
         " from acc0j0,caseprogress,nation where a0j13='" & .Fields("a0k01").Value & "' and cp09(+)=a0j01 and na01(+)=a0j04 and (cp79 <> 0 or (cp79 = 0 and cp75 <> 0)) " & _
         " order by a0j25 asc"
      intR = 1
      Set adocaseprogress = ClsLawReadRstMsg(intR, StrSQLa)
      intRecPos = 1 'Add By Sindy 2022/3/17
      If intR = 1 Then
         strItemDesc = adocaseprogress.Fields("a0j22") '帳款類別
         lngAmount1 = 0 '累計的
         lngAmount2 = 0
         intList = 2
         strNation = "": strCaseName = "": strProduct = "": strA0j20 = "": strA0j21 = "": strA0j23 = "": strA0j24 = ""
         Do While Not adocaseprogress.EOF
            If strItemDesc <> adocaseprogress.Fields("a0j22") Then '帳款類別
               If lngItemAmount1 > 0 Then
                  '帳款類別
'                  Printer.CurrentX = PLeft(2)
'                  Printer.CurrentY = lngXE + (intList * 400)
'                  Printer.Print strItemDesc
                  strCaseNote(intRecPos) = strItemDesc
                  
                  '列印本所案號,申請國家,案件名稱,客戶案件案號
                  If strA0j20 = "" Or strA0j21 = "" Or strA0j23 = "" Or strA0j24 = "" Then
                     If strA0j21 = "" Then
                        '案號
'                        Printer.CurrentX = PLeft(1)
'                        Printer.CurrentY = lngXE + (intList * 400)
'                        Printer.Print strCaseNo
                     End If
                     strTemp = IIf(strProduct <> "", " ", "") & Trim(strProduct & IIf(strNation <> "", "/", "") & strNation)
'                     Printer.CurrentX = PLeft(2)
'                     Printer.CurrentY = lngXE + (intList * 400) + 400
                     If Len(Trim(strCaseName) & strTemp) > 28 Then
                        strTemp = Left(Trim(strCaseName), 28 - Len(strTemp)) & "..." & strTemp
                     Else
                        strTemp = Trim(strCaseName) & strTemp
                     End If
'                     Printer.Print strTemp
                     strCaseNote(intRecPos) = IIf(strCaseNote(intRecPos) <> "", strCaseNote(intRecPos) & vbCrLf, "") & strTemp
                  End If
                  
                  lngAmount2 = lngAmount2 + lngItemAmount2
                  'Added by Sindy 2021/10/18 J公司請款單之收文若為ACS案且案件性質706代收代付時，列印請款單營業稅固定為0，不算稅
                  If m_strCP01 = "ACS" And m_strCP10 = "706" Then
                     '應收金額
                     If lngItemAmount1 > 0 Then
                        strAmount1(intRecPos) = Format(lngItemAmount1, DDollar)
                     Else
                        strAmount1(intRecPos) = 0
                     End If
                  Else
                  '2021/10/18 END
                     '應收金額
                     If lngItemAmount1 > 0 Then
                        'Add By Sindy 2014/4/8 計算後可能會有差額1,2元;最後一筆要攤平 ex.E10309340
                        If intRecPos = adocaseprogress.RecordCount Then
                           lngItemAmount1 = Round((lngAmount2 / 1.05)) - lngAmount1
                        End If
                        '2014/4/8 END
                        strAmount1(intRecPos) = Format(lngItemAmount1, DDollar)
                     Else
                        strAmount1(intRecPos) = 0
                     End If
                  End If
                  lngAmount1 = lngAmount1 + lngItemAmount1
                  
'                  Printer.CurrentX = PLeft(3) - Printer.TextWidth(strAmount1)
'                  Printer.CurrentY = lngXE + (intList * 400)
'                  Printer.Print strAmount1
               End If
               
               lngItemAmount1 = 0
               lngItemAmount2 = 0
               strNation = "": strCaseName = "": strProduct = "": strA0j21 = "": strA0j23 = "": strA0j24 = ""
               
               '帳款類別
               strItemDesc = adocaseprogress.Fields("a0j22")
               intList = intList + 2
               intRecPos = intRecPos + 1 'Add By Sindy 2022/3/17
            End If
            'intRecPos = intRecPos + 1 'Add By Sindy 2014/4/8
            
            If strCaseNo(intRecPos) = "" Then
               '列印本所案號,申請國家,案件名稱,客戶案件案號
               strCaseNo(intRecPos) = adocaseprogress.Fields("a0j02") '本所案號
               strA0j20 = "" & adocaseprogress.Fields("a0j20")
               strA0j21 = "" & adocaseprogress.Fields("a0j21")
               strA0j23 = "" & adocaseprogress.Fields("a0j23")
               strA0j24 = "" & adocaseprogress.Fields("a0j24")
               If Right(strCaseNo(intRecPos), 3) = "000" Then
                  strCaseNo(intRecPos) = Left(strCaseNo(intRecPos), Len(strCaseNo(intRecPos)) - 3)
               'Add By Sindy 2024/9/20 客戶反應同定稿要有-
                  strCaseNo(intRecPos) = Left(strCaseNo(intRecPos), Len(strCaseNo(intRecPos)) - 6) & "-" & Right(strCaseNo(intRecPos), 6)
               Else
                  strExc(9) = Left(strCaseNo(intRecPos), Len(strCaseNo(intRecPos)) - 3)
                  strExc(10) = Right(strCaseNo(intRecPos), 3)
                  strCaseNo(intRecPos) = Left(strExc(9), Len(strExc(9)) - 6) & "-" & Right(strExc(9), 6) & _
                                         "-" & Left(strExc(10), 1) & "-" & Right(strExc(10), 2)
               '2024/9/20 END
               End If
               
               'Modified by Morgan 2017/11/17 案號、國家與商類別都拆開設定
               'If strA0j23 = "" Then
               If strA0j20 = "" Then '是否不印商品類別
               'end 2017/11/17
                  '查名案加印商品類別
                  If adocaseprogress.Fields("cp01").Value = "S" Or adocaseprogress.Fields("cp01").Value = "TS" Then
                     StrSQLa = "select SP18 as tm09 from SERVICEPRACTICE where SP01 = '" & adocaseprogress.Fields("cp01").Value & "' and SP02 = '" & adocaseprogress.Fields("cp02").Value & "' and SP03 = '" & adocaseprogress.Fields("cp03").Value & "' and SP04 = '" & adocaseprogress.Fields("cp04").Value & "'"
                  Else
                     StrSQLa = "select tm09 from trademark where tm01 = '" & adocaseprogress.Fields("cp01").Value & "' and tm02 = '" & adocaseprogress.Fields("cp02").Value & "' and tm03 = '" & adocaseprogress.Fields("cp03").Value & "' and tm04 = '" & adocaseprogress.Fields("cp04").Value & "'"
                  End If
                  intR = 1
                  Set adoquery = ClsLawReadRstMsg(intR, StrSQLa)
                  If intR = 1 Then
                     If IsNull(adoquery.Fields("tm09").Value) = False Then
                        varRef = Split(adoquery.Fields("tm09").Value, ",")
                        If UBound(varRef) > 4 Then
                           strProduct = "第" & varRef(0) & "," & varRef(1) & "," & varRef(2) & "," & varRef(3) & "," & varRef(4) & "...類"
                        Else
                           strProduct = "第" & adoquery.Fields("tm09").Value & " 類"
                        End If
                     End If
                  End If
                  adoquery.Close
               End If
               If strA0j23 = "" Then '是否不印國家
                  '國家
                  If IsNull(adocaseprogress.Fields("na03").Value) = False Then
                     strNation = adocaseprogress.Fields("na03").Value
                  End If
               End If
               If strA0j24 = "" Then '是否不印案件名稱
                  '列印案件名稱(以總收文號查詢)及客戶案件名稱(Optional)
                  strCaseName = CaseNameQuery(adocaseprogress.Fields("a0j01").Value, 1, strCustCaseNo)
                  If strCaseName = "" Then
                     strCaseName = CaseNameQuery(adocaseprogress.Fields("a0j01").Value, 2)
                  End If
               End If
            End If
            
            douService = 0
            douFee = 0
            '有銷帳
            If IsNull(.Fields("a0k10")) = False Then
               StrSQLa = "select sum(a1u07), sum(a1u09) from acc1u0 where a1u02 = '" & .Fields("a0k01").Value & "' and a1u03='" & adocaseprogress.Fields("a0j01") & "'"
               intR = 1
               Set adoquery = ClsLawReadRstMsg(intR, StrSQLa)
               If intR = 1 Then
                  If IsNull(adoquery.Fields(0).Value) = False Then
                     douService = Val(adoquery.Fields(0).Value)
                  End If
                  If IsNull(adoquery.Fields(1).Value) = False Then
                     douFee = Val(adoquery.Fields(1).Value)
                  End If
               End If
               adoquery.Close
            End If
            
            '應收金額=服務費+規費-銷帳服務費-銷帳規費
            lngAmt = Val("" & adocaseprogress.Fields("a0j09")) + Val("" & adocaseprogress.Fields("a0j10")) - douService - douFee
            'Added by Sindy 2021/10/18 J公司請款單之收文若為ACS案且案件性質706代收代付時，列印請款單營業稅固定為0，不算稅
            If m_strCP01 = "ACS" And m_strCP10 = "706" Then
               lngItemAmount1 = lngItemAmount1 + lngAmt
               lngItemAmount2 = 0
            Else
            '2021/10/18 END
               'lngItemAmount1 = lngItemAmount1 + lngAmt - (lngAmt - Round((lngAmt / 1.05)))
               lngItemAmount1 = lngItemAmount1 + Round((lngAmt / 1.05))
   '            '營業稅
   '            lngItemAmount2 = lngItemAmount2 + (lngAmt - Round((lngAmt / 1.05)))
               lngItemAmount2 = lngItemAmount2 + lngAmt
            End If
            
            adocaseprogress.MoveNext
         Loop
         adocaseprogress.Close
         
         If lngItemAmount1 > 0 Then
            '帳款類別
'            Printer.CurrentX = PLeft(2)
'            Printer.CurrentY = lngXE + (intList * 400)
'            Printer.Print strItemDesc
            strCaseNote(intRecPos) = strItemDesc
            
            '列印本所案號,申請國家,案件名稱,客戶案件案號
            If strA0j20 = "" Or strA0j21 = "" Or strA0j23 = "" Or strA0j24 = "" Then
               If strA0j21 = "" Then
                  '案號
'                  Printer.CurrentX = PLeft(1)
'                  Printer.CurrentY = lngXE + (intList * 400)
'                  Printer.Print strCaseNo
               End If
               strTemp = IIf(strProduct <> "", " ", "") & Trim(strProduct & IIf(strNation <> "", "/", "") & strNation)
'               Printer.CurrentX = PLeft(2)
'               Printer.CurrentY = lngXE + (intList * 400) + 400
               If Len(Trim(strCaseName) & strTemp) > 28 Then
                  strTemp = Left(Trim(strCaseName), 28 - Len(strTemp)) & "..." & strTemp
               Else
                  strTemp = Trim(strCaseName) & strTemp
               End If
'               Printer.Print strTemp
               strCaseNote(intRecPos) = IIf(strCaseNote(intRecPos) <> "", strCaseNote(intRecPos) & vbCrLf, "") & strTemp
            End If
            
            lngAmount2 = lngAmount2 + lngItemAmount2
            'Added by Sindy 2021/10/18 J公司請款單之收文若為ACS案且案件性質706代收代付時，列印請款單營業稅固定為0，不算稅
            If m_strCP01 = "ACS" And m_strCP10 = "706" Then
               '應收金額
               If lngItemAmount1 > 0 Then
                  strAmount1(intRecPos) = Format(lngItemAmount1, DDollar)
               Else
                  strAmount1(intRecPos) = 0
               End If
            Else
            '2021/10/18 END
               '應收金額
               If lngItemAmount1 > 0 Then
                  'Add By Sindy 2014/4/8 計算後可能會有差額1,2元;最後一筆要攤平 ex.E10309340
                  'If intRecPos = adocaseprogress.RecordCount Then
                     lngItemAmount1 = Round((lngAmount2 / 1.05)) - lngAmount1
                  'End If
                  '2014/4/8 END
                  strAmount1(intRecPos) = Format(lngItemAmount1, DDollar)
               Else
                  strAmount1(intRecPos) = 0
               End If
            End If
            lngAmount1 = lngAmount1 + lngItemAmount1
            
'            Printer.CurrentX = PLeft(3) - Printer.TextWidth(strAmount1)
'            Printer.CurrentY = lngXE + (intList * 400)
'            Printer.Print strAmount1
         End If
      End If
   
   Else
      intList = 2
      '收據明細資料
      StrSQLa = "select a.*,b.*,getcp10desc(cp01,cp10,a0j04) cp10N,na03 from acc0j0 a,caseprogress b,nation where a0j13 = '" & .Fields("a0k01").Value & "' And cp09(+)=a0j01 and (cp79 <> 0 or (cp79 = 0 and cp75 <> 0)) and na01(+)=a0j04 ORDER BY CP09 "
      intR = 1
      Set adocaseprogress = ClsLawReadRstMsg(intR, StrSQLa)
      intRecPos = 0 'Add By Sindy 2014/4/8
      lngAmount1 = 0: lngAmount2 = 0 '累計的
      If intR = 1 Then
         Do While adocaseprogress.EOF = False
            intRecPos = intRecPos + 1 'Add By Sindy 2014/4/8
            douService = 0
            douFee = 0
            '有銷帳
            If adocaseprogress.Fields("cp77") > 0 Then
               '銷帳=費用時不印
               If adocaseprogress.Fields("cp77") = adocaseprogress.Fields("cp16") Then
                  GoTo NextRecord
               Else
                  '抓收款資料
                  StrSQLa = "select sum(a1u07), sum(a1u09) from acc1u0 where a1u03 = '" & adocaseprogress.Fields("cp09").Value & "' and a1u02='" & .Fields("a0k01").Value & "'"
                  intR = 1
                  Set adoquery = ClsLawReadRstMsg(intR, StrSQLa)
                  If intR = 1 Then
                     If IsNull(adoquery.Fields(0).Value) = False Then
                        douService = Val(adoquery.Fields(0).Value)
                     End If
                     If IsNull(adoquery.Fields(1).Value) = False Then
                        douFee = Val(adoquery.Fields(1).Value)
                     End If
                  End If
                  adoquery.Close
               End If
            End If
            
            strTemp = adocaseprogress.Fields("cp10N").Value
            '不列印專利年費年度
            If pintNoPrintPatentYear > 0 Then
'               Printer.CurrentX = PLeft(2)
'               Printer.CurrentY = lngXE + (intList * 400)
'               Printer.Print strTemp '案件性質
            Else
               '加印繳費年度說明
               If ((adocaseprogress.Fields("cp01").Value = "P" And adocaseprogress.Fields("cp10").Value = "601") Or _
                     ((adocaseprogress.Fields("cp01").Value = "P" Or adocaseprogress.Fields("cp01").Value = "CFP") And _
                     (adocaseprogress.Fields("cp10").Value = "605" Or adocaseprogress.Fields("cp10").Value = "606" Or adocaseprogress.Fields("cp10").Value = "607"))) And _
                  adocaseprogress.Fields("cp53").Value <> "" And _
                  adocaseprogress.Fields("cp54").Value <> "" Then
                  strSql = "SELECT * FROM patent WHERE pa01='" & adocaseprogress.Fields("cp01").Value & "' and pa02='" & adocaseprogress.Fields("cp02").Value & "' and pa03='" & adocaseprogress.Fields("cp03").Value & "' and pa04='" & adocaseprogress.Fields("cp04").Value & "' "
                  intI = 1
                  Set RsTemp = ClsLawReadRstMsg(intI, strSql)
                  If intI = 1 Then
                     strPA08 = RsTemp("PA08")
                     strPA09 = RsTemp("PA09")
                     strPA10 = "" & RsTemp("PA10") 'Added by Morgan 2022/6/13
                  End If
                  strKey(0) = ""
                  strKey(1) = adocaseprogress.Fields("cp01").Value
                  strKey(2) = adocaseprogress.Fields("cp02").Value
                  strKey(3) = adocaseprogress.Fields("cp03").Value
                  strKey(4) = adocaseprogress.Fields("cp04").Value
                  '抓修法次數
                  bFind = GetMoneyDate(strPA08, strPA09, strKey, strCaseFee(1), strCaseFee(2), , , m_FixNo)
                  If bFind Then
                     If IsEmptyText(strCaseFee(2)) = False Then
                        varRef = Split(strCaseFee(2), ",")
                        'Modified by Morgan 2022/6/13 +strPA10
                        strFeeType = PUB_GetNa20Na22Na24(strPA09, strPA08, strPA10)
                        If adocaseprogress.Fields("cp10").Value = "605" Or _
                           adocaseprogress.Fields("cp10").Value = "601" Then
                           strYF15 = PUB_GetYF15(strPA09, strPA08, "Y000000" & m_FixNo, strFeeType, CDbl(Val(adocaseprogress.Fields("cp53").Value)))
                        Else
                           strYF15 = PUB_GetYF15(strPA09, strPA08, "Y000000" & m_FixNo, strFeeType, Val(varRef(Val(adocaseprogress.Fields("cp53").Value) - 1)))
                        End If
'                        Printer.FontSize = 11
'                        Printer.CurrentX = PLeft(2)
'                        Printer.CurrentY = lngXE + (intList * 400)
                        If Val(adocaseprogress.Fields("cp53").Value) = Val(adocaseprogress.Fields("cp54").Value) Then
'                           Printer.Print strTemp & " " & strYF15
                           strTemp = strTemp & " " & strYF15
                        Else
                           If adocaseprogress.Fields("cp10").Value = "605" Or _
                              adocaseprogress.Fields("cp10").Value = "601" Then
'                              Printer.Print strTemp & " (" & strYF15 & "至" & PUB_GetYF15(strPA09, strPA08, "Y000000" & m_FixNo, strFeeType, CDbl(Val(adocaseprogress.Fields("cp54").Value))) & ")"
                              strTemp = strTemp & " (" & strYF15 & "至" & PUB_GetYF15(strPA09, strPA08, "Y000000" & m_FixNo, strFeeType, CDbl(Val(adocaseprogress.Fields("cp54").Value))) & ")"
                           Else
'                              Printer.Print strTemp & " (" & strYF15 & "至" & PUB_GetYF15(strPA09, strPA08, "Y000000" & m_FixNo, strFeeType, Val(varRef(Val(adocaseprogress.Fields("cp54").Value) - 1))) & ")"
                              strTemp = strTemp & " (" & strYF15 & "至" & PUB_GetYF15(strPA09, strPA08, "Y000000" & m_FixNo, strFeeType, Val(varRef(Val(adocaseprogress.Fields("cp54").Value) - 1))) & ")"
                           End If
                        End If
                     End If
                  End If
               Else
'                  Printer.CurrentX = PLeft(2)
'                  Printer.CurrentY = lngXE + (intList * 400)
'                  Printer.Print strTemp '案件性質
               End If
            End If
            strCaseNote(intRecPos) = strTemp 'Add By Sindy 2022/1/17
            'Add by Morgan 2005/9/15 顧問案的顧問聘任(0)時要印顧問期間
            'Modify By Sindy 2022/5/20 請加入ACS之智財顧問(112)也要印出期間。例：ACS-000106(E11109383)。
            If (adocaseprogress("CP01") = "LA" And adocaseprogress("CP10") = "0") Or _
               (adocaseprogress("CP01") = "ACS" And adocaseprogress("CP10") = "112") Then
               strCaseNote(intRecPos) = strCaseNote(intRecPos) & "(期間：" & Format(TransDate("" & adocaseprogress("CP53"), 1), "###/##/##") & " - " & Format(TransDate("" & adocaseprogress("CP54"), 1), "###/##/##") & ")"
            End If
            
            '有應收金額
            If Val("" & adocaseprogress.Fields("a0j09").Value) + Val("" & adocaseprogress.Fields("a0j10").Value) > 0 Then
               '應收金額=服務費+規費-銷帳服務費-銷帳規費
               lngAmt = Val("" & adocaseprogress.Fields("a0j09")) + Val("" & adocaseprogress.Fields("a0j10")) - douService - douFee
               'strAmount1 = Format(lngAmt - (lngAmt - Round((lngAmt / 1.05))), DDollar)
               'Added by Sindy 2020/11/11 J公司請款單之收文若為ACS案且案件性質706代收代付時，列印請款單營業稅固定為0，不算稅
               If m_strCP01 = "ACS" And m_strCP10 = "706" Then
                  strAmount1(intRecPos) = Format(lngAmt, DDollar)
                  lngAmount2 = 0 'lngAmount2 + lngAmt
                  lngAmount1 = lngAmount1 + Val(Format(strAmount1(intRecPos)))
               Else
               '2020/11/11 END
                  strAmount1(intRecPos) = Round((lngAmt / 1.05))
                  lngAmount2 = lngAmount2 + lngAmt
                  'Add By Sindy 2014/4/8 計算後可能會有差額1,2元;最後一筆要攤平 ex.E10309340
                  If Val(strAmount1(intRecPos)) > 0 Then
                     If intRecPos = adocaseprogress.RecordCount Then
                        strAmount1(intRecPos) = Round((lngAmount2 / 1.05)) - lngAmount1
                     End If
                     strAmount1(intRecPos) = Format(strAmount1(intRecPos), DDollar)
                  End If
                  '2014/4/8 END
                  lngAmount1 = lngAmount1 + Val(Format(strAmount1(intRecPos)))
               End If
               
'               Printer.CurrentX = PLeft(3) - Printer.TextWidth(strAmount1)
'               Printer.CurrentY = lngXE + (intList * 400)
               If strAmount1(intRecPos) = "" Then
                  strAmount1(intRecPos) = 0
'                  Printer.Print "0"
               Else
'                  Printer.Print strAmount1
               End If
               
            End If
            
            '列印本所案號
'            Printer.CurrentX = PLeft(1)
'            Printer.CurrentY = lngXE + (intList * 400)
            If (adocaseprogress.Fields("cp03").Value & adocaseprogress.Fields("cp04").Value) = "000" Then
               'Modify By Sindy 2024/9/20 客戶反應同定稿要有-
               'strCaseNo(intRecPos) = adocaseprogress.Fields("cp01").Value & adocaseprogress.Fields("cp02").Value
               strCaseNo(intRecPos) = adocaseprogress.Fields("cp01").Value & "-" & adocaseprogress.Fields("cp02").Value
'               Printer.Print adocaseprogress.Fields("cp01").Value & adocaseprogress.Fields("cp02").Value
            Else
               'Modify By Sindy 2024/9/20 客戶反應同定稿要有-
               'strCaseNo(intRecPos) = adocaseprogress.Fields("cp01").Value & adocaseprogress.Fields("cp02").Value & adocaseprogress.Fields("cp03").Value & adocaseprogress.Fields("cp04").Value
               strCaseNo(intRecPos) = adocaseprogress.Fields("cp01").Value & "-" & adocaseprogress.Fields("cp02").Value & "-" & adocaseprogress.Fields("cp03").Value & "-" & adocaseprogress.Fields("cp04").Value
'               Printer.Print adocaseprogress.Fields("cp01").Value & adocaseprogress.Fields("cp02").Value & adocaseprogress.Fields("cp03").Value & adocaseprogress.Fields("cp04").Value
            End If
            
            strNation = "": strCaseName = "": strProduct = ""
            '查名案加印商品類別
            If adocaseprogress.Fields("cp01").Value = "S" Or adocaseprogress.Fields("cp01").Value = "TS" Then
               StrSQLa = "select SP18 as tm09 from SERVICEPRACTICE where SP01 = '" & adocaseprogress.Fields("cp01").Value & "' and SP02 = '" & adocaseprogress.Fields("cp02").Value & "' and SP03 = '" & adocaseprogress.Fields("cp03").Value & "' and SP04 = '" & adocaseprogress.Fields("cp04").Value & "'"
            Else
               StrSQLa = "select tm09 from trademark where tm01 = '" & adocaseprogress.Fields("cp01").Value & "' and tm02 = '" & adocaseprogress.Fields("cp02").Value & "' and tm03 = '" & adocaseprogress.Fields("cp03").Value & "' and tm04 = '" & adocaseprogress.Fields("cp04").Value & "'"
            End If
            intR = 1
            Set adoquery = ClsLawReadRstMsg(intR, StrSQLa)
            If intR = 1 Then
               If IsNull(adoquery.Fields("tm09").Value) = False Then
                  varRef = Split(adoquery.Fields("tm09").Value, ",")
                  If UBound(varRef) > 4 Then
                     strProduct = "第" & varRef(0) & "," & varRef(1) & "," & varRef(2) & "," & varRef(3) & "," & varRef(4) & "...類"
                  Else
                     strProduct = "第" & adoquery.Fields("tm09").Value & " 類"
                  End If
               End If
            End If
            adoquery.Close
            '列印案件名稱(以總收文號查詢)及客戶案件名稱(Optional)
            strCaseName = CaseNameQuery(adocaseprogress.Fields("cp09").Value, 1, strCustCaseNo)
            If strCaseName = "" Then
               strCaseName = CaseNameQuery(adocaseprogress.Fields("cp09").Value, 2)
            End If
            '列印申請國家名稱
            If IsNull(adocaseprogress.Fields("na03").Value) = False Then
               strNation = adocaseprogress.Fields("na03").Value
            End If
            strTemp = IIf(strProduct <> "", " ", "") & Trim(strProduct & IIf(strNation <> "", "/", "") & strNation)
'            Printer.CurrentX = PLeft(2)
'            Printer.CurrentY = lngXE + (intList * 400) + 400
            If Len(Trim(strCaseName) & Trim(strTemp)) > 40 Then '28
               If Len(Trim(strTemp)) < 40 Then
                  strTemp = Left(Trim(strCaseName), 40 - Len(Trim(strTemp))) & "..." & Trim(strTemp)
               End If
            Else
               strTemp = Trim(strCaseName) & strTemp
            End If
'            Printer.Print strTemp
            strCaseNote(intRecPos) = IIf(strCaseNote(intRecPos) <> "", strCaseNote(intRecPos) & vbCrLf, "") & strTemp 'Add By Sindy 2022/1/17
            
            intList = intList + 2
            
NextRecord:
            adocaseprogress.MoveNext
         Loop
         adocaseprogress.Close
      End If
   End If
   End With
   
   '判斷word是否已開啟
   If g_WordAp Is Nothing Then
RestarWord:
      Set g_WordAp = New Word.Application
      g_WordAp.Visible = False
   End If
   '另存檔名:+收據編號.doc
   strFileName = "$$J公司請款單-" & padoacc0k0.Fields("a0k01").Value & ".doc"
   strFileName = App.path & "\" & strFileName
   If Dir(strFileName) <> "" Then
      Kill strFileName
   End If
   g_WordAp.Documents.Open pFileFullPath
   g_WordAp.ActiveDocument.SaveAs strFileName
   g_WordAp.ActiveDocument.Close
   g_WordAp.Documents.Open strFileName
   With g_WordAp
      .Selection.WholeStory
      .Selection.Copy
      '標題
      For i = 1 To 6
         strName = ""
         strText = ""
         Select Case i
            Case 1 '客戶資料
               strName = "客戶資料"
               strText = "編號：" & padoacc0k0.Fields("a0k03").Value & vbCrLf
               '收據抬頭
               strTmp = "名稱："
               If IsNull(padoacc0k0.Fields("a0k04").Value) = False Then
                  strTmp = strTmp & Trim(padoacc0k0.Fields("a0k04").Value)
               End If
               strTmp = strTmp & vbCrLf
               strText = strText & strTmp
               '客戶地址
               Call PUB_PrintReceiptHead_Addr(padoacc0k0, strAddr, strPCC05)
               strTmp = "地址：" & strAddr
               If LenB(strTmp) > 44 Then
                  strTmp2 = MidB(strTmp, 1, 44) & vbCrLf
                  strTmp2 = strTmp2 & "　　　" & RightB(strTmp, LenB(strTmp) - 44)
                  strTmp = strTmp2 & vbCrLf
               Else
                  strTmp = strTmp & vbCrLf
               End If
               '接洽人
               If strAddr <> "" Then '有地址才要帶接洽人
                  If strPCC05 <> "" Then
                     strTmp = strTmp & "　　　" & strPCC05
                  End If
               End If
               strText = strText & strTmp
            Case 2 '請款日期
               strName = "請款日期"
               If pstrPritDate <> "" Then
                  strText = CFDate(pstrPritDate)
               Else
                  strText = CFDate(padoacc0k0.Fields("a0k02"))
               End If
            Case 3 '客戶案號
               strName = "客戶案號"
               If pintPrintCustCaseNo = 1 Then
                  '帳款類別變更
                  If IsNull(padoacc0k0.Fields("a0k33")) = False Then
                     '收文日(最小)
                     StrSQLa = "select * " & _
                        " from acc0j0,caseprogress,nation where a0j13='" & padoacc0k0.Fields("a0k01").Value & "' and cp09(+)=a0j01 and na01(+)=a0j04 and (cp79 <> 0 or (cp79 = 0 and cp75 <> 0)) " & _
                        " order by a0j25 asc"
                     intR = 1
                     Set RsTemp = ClsLawReadRstMsg(intR, StrSQLa)
                  Else
                     '收據明細資料
                     StrSQLa = "select a.*,b.*,getcp10desc(cp01,cp10,a0j04) cp10N,na03 from acc0j0 a,caseprogress b,nation where a0j13 = '" & padoacc0k0.Fields("a0k01").Value & "' And cp09(+)=a0j01 and (cp79 <> 0 or (cp79 = 0 and cp75 <> 0)) and na01(+)=a0j04 ORDER BY CP09 "
                     intR = 1
                     Set RsTemp = ClsLawReadRstMsg(intR, StrSQLa)
                  End If
                  If RsTemp.RecordCount > 0 Then
                     RsTemp.MoveFirst
                     Do While Not RsTemp.EOF
                        strTmp = CaseNameQuery(RsTemp.Fields("a0j01"), 1, strCustCaseNo)
                        If strCustCaseNo <> "" Then
                           strText = strCustCaseNo
                           Exit Do
                        End If
                        RsTemp.MoveNext
                     Loop
                  End If
                  strText = "客戶案號：" & strText
               End If
            Case 4 '補開
               strName = "補開"
               If pstrRePrint = "Y" Then
                  strText = "***  補開  ***"
               End If
            Case 5 '請款單號
               strName = "請款單號"
               strText = padoacc0k0.Fields("a0k01").Value
            Case 6 '智權人員
               strName = "智權人員"
               '智權人員代號
               If IsNull(padoacc0k0.Fields("a0k20").Value) = False Then
                  '業務區
                  If IsNull(padoacc0k0.Fields("a0k22").Value) = False Then
                     strText = padoacc0k0.Fields("a0k22").Value
                  End If
                  strText = strText & " " & padoacc0k0.Fields("a0k20").Value
               End If
         End Select
         If Trim(strName) <> "" Then
            .Selection.Find.ClearFormatting
            .Selection.Find.Text = "|#" & strName & "#|"
            .Selection.Find.Replacement.Text = ""
            .Selection.Find.Forward = True
            .Selection.Find.Wrap = wdFindContinue
            .Selection.Find.Format = False
            .Selection.Find.MatchCase = False
            .Selection.Find.MatchWholeWord = False
            .Selection.Find.MatchWildcards = False
            .Selection.Find.MatchSoundsLike = False
            .Selection.Find.MatchAllWordForms = False
            .Selection.Find.MatchByte = True
            .Selection.Find.Execute
            .Selection.Delete
            .Selection.Font.ColorIndex = wdBlack
            .Selection.TypeText strText
         End If
      Next i
      '收據明細
      For j = 1 To m_intRecMaxItem
         For i = 1 To 3
            strName = ""
            strText = ""
            Select Case i
               Case 1
                  strName = "本所案號" & j
                  strText = strCaseNo(j)
               Case 2
                  strName = "委辦事項" & j
                  strText = strCaseNote(j)
               Case 3
                  strName = "金額" & j
                  strText = strAmount1(j)
            End Select
            If Trim(strName) <> "" Then
               .Selection.Find.ClearFormatting
               .Selection.Find.Text = "|#" & strName & "#|"
               .Selection.Find.Replacement.Text = ""
               .Selection.Find.Forward = True
               .Selection.Find.Wrap = wdFindContinue
               .Selection.Find.Format = False
               .Selection.Find.MatchCase = False
               .Selection.Find.MatchWholeWord = False
               .Selection.Find.MatchWildcards = False
               .Selection.Find.MatchSoundsLike = False
               .Selection.Find.MatchAllWordForms = False
               .Selection.Find.MatchByte = True
               .Selection.Find.Execute
               .Selection.Delete
               .Selection.Font.ColorIndex = wdBlack
               .Selection.TypeText strText
            End If
         Next i
      Next j
      '合計\付款方式
      '應收金額小計
      If lngAmount1 = 0 Then
         strAmount1T = "0"
      Else
         strAmount1T = Format(lngAmount1, DDollar)
      End If
      '營業稅小計
      If lngAmount2 = 0 Then
         strAmount2 = "0"
      Else
         'strAmount2 = Format(lngAmount2, DDollar)
         strAmount2 = Format((lngAmount2 - Round((lngAmount2 / 1.05))), DDollar)
      End If
      '總計
      'lngTotal = plngAmount1 + lngAmount2
      'Added by Sindy 2020/11/11 J公司請款單之收文若為ACS案且案件性質706代收代付時，稅固定為0
      If m_strCP01 = "ACS" And m_strCP10 = "706" Then
         lngTotal = lngAmount1 + lngAmount2
      Else
      '2020/11/11 END
         lngTotal = lngAmount2
      End If
      For i = 1 To 5
         strName = ""
         strText = ""
         Select Case i
            Case 1
               strName = "小計"
               strText = strAmount1T
            Case 2
               strName = "營業稅"
               strText = strAmount2
            Case 3
               strName = "總計"
               strText = "NTD" & Format(lngTotal, DDollar)
            Case 4
               strName = "總計新台幣"
               strText = ChangeNumber(CStr(lngTotal))
            Case 5
               'Modify by Amy 2024/05/17 財務2個特殊設定拆成3個
               If Val(strSrvDate(1)) >= Val(財務拆總帳出納國內應收啟用日) Then
                   strAccPerson = Pub_GetSpecMan("財務處應收處理人員")
               Else
                  strAccPerson = Pub_GetSpecMan("財務處出納人員")
               End If
               '取第一個人
               If InStr(strAccPerson, ";") > 0 Then strAccPerson = Mid(strAccPerson, 1, Val(InStr(strAccPerson, ";")) - 1)
               strName = "備註"
               'Added by Sindy 2020/11/11 J公司請款單之收文若為ACS案且案件性質706代收代付時，取消備註1
               If m_strCP01 = "ACS" And m_strCP10 = "706" Then
                  strText = "備註：1.付款時請將相關請款單號以E-mail通知 " & strAccPerson & "@taie.com.tw" & vbCrLf & _
                            "　　　或請傳真 (02)2506-8147 會計室收，以利沖帳，謝謝您的支持與合作。"
               Else
               '2020/11/11 END
                  strText = "備註：1.發票將於收款後，另行寄發。" & vbCrLf & _
                            "　　　2.付款時請將相關請款單號以E-mail通知 " & strAccPerson & "@taie.com.tw" & vbCrLf & _
                            "　　　或請傳真 (02)2506-8147 會計室收，以利沖帳，謝謝您的支持與合作。"
               End If
               'end 2024/05/17
         End Select
         If Trim(strName) <> "" Then
            .Selection.Find.ClearFormatting
            .Selection.Find.Text = "|#" & strName & "#|"
            .Selection.Find.Replacement.Text = ""
            .Selection.Find.Forward = True
            .Selection.Find.Wrap = wdFindContinue
            .Selection.Find.Format = False
            .Selection.Find.MatchCase = False
            .Selection.Find.MatchWholeWord = False
            .Selection.Find.MatchWildcards = False
            .Selection.Find.MatchSoundsLike = False
            .Selection.Find.MatchAllWordForms = False
            .Selection.Find.MatchByte = True
            .Selection.Find.Execute
            .Selection.Delete
            .Selection.Font.ColorIndex = wdBlack
            .Selection.TypeText strText
         End If
      Next i
      
      '加浮水印
      If bolTextEffect = True Then
         .ActiveDocument.Sections(1).Range.Select
         .ActiveDocument.Shapes.AddTextEffect( _
             1, "非正式收據", "新細明體", 90, False, False, 0, 0).Select
         .Selection.ShapeRange.TextEffect.NormalizedHeight = False
         .Selection.ShapeRange.Line.Visible = False
         .Selection.ShapeRange.Fill.Visible = True
         .Selection.ShapeRange.Fill.Solid
         .Selection.ShapeRange.Fill.ForeColor.RGB = RGB(255, 0, 0)
         .Selection.ShapeRange.Fill.Transparency = 0.5
         .Selection.ShapeRange.Rotation = 315
         .Selection.ShapeRange.LockAspectRatio = True
         .Selection.ShapeRange.Height = .CentimetersToPoints(3.17)
         .Selection.ShapeRange.Width = .CentimetersToPoints(12.7)
'         .Selection.ShapeRange.WrapFormat.AllowOverlap = True
         .Selection.ShapeRange.WrapFormat.Side = wdWrapNone
         .Selection.ShapeRange.WrapFormat.Type = 3
         .Selection.ShapeRange.RelativeHorizontalPosition = _
             wdRelativeVerticalPositionMargin
         .Selection.ShapeRange.RelativeVerticalPosition = _
             wdRelativeVerticalPositionMargin
         .Selection.ShapeRange.Left = -999995 'wdShapeCenter
         .Selection.ShapeRange.Top = -999995 'wdShapeCenter
         .ActiveWindow.ActivePane.View.SeekView = wdSeekMainDocument
      End If
      
      'Add By Sindy 2022/8/12 用Word轉Pdf功能
      If strPdfFileNm <> "" Then
         TmpDirNm = Mid(strPdfFileNm, 1, InStrRev(strPdfFileNm, "\") - 1)
         strSaveFileName = Mid(strPdfFileNm, InStrRev(strPdfFileNm, "\") + 1, Len(strPdfFileNm) - 4 - InStrRev(strPdfFileNm, "\"))
         frmPDF.Show
         If pub_Word2Pdf Then
            g_WordAp.ActiveDocument.ExportAsFixedFormat OutputFileName:=TmpDirNm & "\" & strSaveFileName & ".pdf", ExportFormat:=17, OpenAfterExport:=False
         Else
            '轉PDF
            frmPDF.StartProcess TmpDirNm, strSaveFileName
            '切換印表機
            If PUB_PdfCreatorNameInWord = "" Then PUB_PdfCreatorNameInWord = PUB_GetCreatorNameInWord
            g_WordAp.ActivePrinter = PUB_PdfCreatorNameInWord
            g_WordAp.ActiveDocument.PrintOut Background:=False, Copies:=1, Collate:=True
            frmPDF.EndtProcess
         End If
         Unload frmPDF
         g_WordAp.Quit wdDoNotSaveChanges
         Set g_WordAp = Nothing 'Added by Morgan 2025/9/10
      Else
         .ActiveDocument.Save
         .ActiveDocument.PrintOut Background:=False, Copies:=1, Collate:=True
         'Modified by Morgan 2025/9/11 換變數
         'If pub_OsPrinter <> "" Then PUB_WaitUntilNoJob pub_OsPrinter 'Added by Morgan 2025/9/3 有發生漏印，加檢查印表機已清空才繼續
         If pub_OsPrinterA <> "" Then PUB_WaitUntilNoJob pub_OsPrinterA
         g_WordAp.ActiveDocument.Close
         'g_WordAp.Quit 'Removed by Morgan 2025/9/8 改系統結束時執行，因重複啟動Word會慢
      End If
   End With
   'Set g_WordAp = Nothing 'Removed by Morgan 2025/9/8 改系統結束時執行，因重複啟動Word會慢
   
   If pstrPritDate <> "" Then
      adoTaie.Execute "update acc0k0 set a0k02=" & pstrPritDate & ",a0k19 = " & intTimes & " where a0k01 = '" & padoacc0k0.Fields("a0k01").Value & "'"
   Else
      adoTaie.Execute "update acc0k0 set a0k19 = " & intTimes & " where a0k01 = '" & padoacc0k0.Fields("a0k01").Value & "'"
   End If
      
EXITSUB:
   Set adocaseprogress = Nothing
   Set adoquery = Nothing
   
   Exit Sub
   
ErrHand:
   If Err.Number = 462 Then '遠端伺服器不存在或無法使用
      GoTo RestarWord
   ElseIf Err.Number <> 0 Then
      MsgBox (Err.Description)
      If Not g_WordAp Is Nothing Then
         g_WordAp.Quit
         Set g_WordAp = Nothing
      End If
   End If
   
   Set adocaseprogress = Nothing
   Set adoquery = Nothing
End Sub

'Add By Sindy 2020/3/23 抓收據編號客戶地址
'Move by Lydia 2020/03/26 從aacc_fun搬來
Private Sub PUB_PrintReceiptHead_Addr(padoacc0k0 As ADODB.Recordset, ByRef strTmp As String, ByRef strPCC05 As String)
Dim stSQL As String, intR As Integer
'   Dim strDate As String
'   Dim iLine As Integer, lngX As Long
'   Dim stra0k03 As String
Dim m_Contact As String, m_Address As String 'add by sonia 2017/9/6放案件接洽人名稱及其地址
   
   With padoacc0k0
      'add by sonia 2017/9/6 地址及接洽人要先抓案件的 E10613664
      m_Contact = "": m_Address = ""
      stSQL = "select nvl(nvl(nvl(nvl(p1.pcc21||p1.pcc22,p2.pcc21||p2.pcc22),p3.pcc21||p3.pcc22),p4.pcc21||p4.pcc22),p5.pcc21||p5.pcc22) 案件接洽人地址," & _
              " nvl(nvl(nvl(nvl(nvl(p1.pcc05,nvl(p1.pcc03,p1.pcc04)),nvl(p2.pcc05,nvl(p2.pcc03,p2.pcc04))),nvl(p3.pcc05,nvl(p3.pcc03,p3.pcc04))),nvl(p4.pcc05,nvl(p4.pcc03,p4.pcc04))),nvl(p5.pcc05,nvl(p5.pcc03,p5.pcc04))) 案件接洽人 " & _
              " from acc0j0,patent,trademark,lawcase,hirecase,servicepractice,potcustcont p1,potcustcont p2,potcustcont p3,potcustcont p4,potcustcont p5 where a0j13='" & .Fields("a0k01").Value & "' " & _
              " and pa01(+) = substr(a0j02, 1, Length(a0j02) - 9) and pa02(+) = substr(a0j02, Length(a0j02) - 8, 6) and pa03(+) = substr(a0j02, Length(a0j02) - 2, 1) and pa04(+) = substr(a0j02, Length(a0j02) - 1, 2) and substr(pa26,1,8)=p1.pcc01(+) and pa149=p1.pcc02(+) " & _
              " and tm01(+) = substr(a0j02, 1, Length(a0j02) - 9) and tm02(+) = substr(a0j02, Length(a0j02) - 8, 6) and tm03(+) = substr(a0j02, Length(a0j02) - 2, 1) and tm04(+) = substr(a0j02, Length(a0j02) - 1, 2) and substr(tm23,1,8)=p2.pcc01(+) and tm123=p2.pcc02(+) " & _
              " and lc01(+) = substr(a0j02, 1, Length(a0j02) - 9) and lc02(+) = substr(a0j02, Length(a0j02) - 8, 6) and lc03(+) = substr(a0j02, Length(a0j02) - 2, 1) and lc04(+) = substr(a0j02, Length(a0j02) - 1, 2) and substr(lc11,1,8)=p3.pcc01(+) and lc42=p3.pcc02(+) " & _
              " and hc01(+) = substr(a0j02, 1, Length(a0j02) - 9) and hc02(+) = substr(a0j02, Length(a0j02) - 8, 6) and hc03(+) = substr(a0j02, Length(a0j02) - 2, 1) and hc04(+) = substr(a0j02, Length(a0j02) - 1, 2) and substr(hc05,1,8)=p4.pcc01(+) and hc23=p4.pcc02(+) " & _
              " and sp01(+) = substr(a0j02, 1, Length(a0j02) - 9) and sp02(+) = substr(a0j02, Length(a0j02) - 8, 6) and sp03(+) = substr(a0j02, Length(a0j02) - 2, 1) and sp04(+) = substr(a0j02, Length(a0j02) - 1, 2) and substr(sp08,1,8)=p5.pcc01(+) and sp78=p5.pcc02(+) " & _
              " order by a0j25 asc"
      intR = 1
      Set RsTemp = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         If Trim("" & RsTemp.Fields(1)) <> "" Then
            m_Address = Trim("" & RsTemp.Fields(0))
            m_Contact = "（接洽人：" & RsTemp.Fields(1) & "）"
         End If
      End If
      'end 2017/9/6
      
      '地址
      strTmp = "" ': stra0k03 = ""
'      stSQL = "select distinct a0k03 from acc0k0 where a0k04='" & Trim("" & .Fields("a0k04").Value) & "'"
'      intR = 1
'      Set RsTemp = ClsLawReadRstMsg(intR, stSQL)
'      If intR = 1 Then
'         If RsTemp.RecordCount = 1 Then
'            stra0k03 = RsTemp.Fields(0)
'         Else
'            stSQL = "select distinct substr(a0k03,1,6) from acc0k0 where a0k04='" & Trim("" & .Fields("a0k04").Value) & "'"
'            intR = 1
'            Set RsTemp = ClsLawReadRstMsg(intR, stSQL)
'            If intR = 1 Then
'               If RsTemp.RecordCount = 1 Then '無跨關係企業
'                  stSQL = "select cu01||cu02 from customer where cu04='" & Trim("" & .Fields("a0k04").Value) & "'"
'                  intR = 1
'                  Set RsTemp = ClsLawReadRstMsg(intR, stSQL)
'                  If intR = 1 Then
'                     stra0k03 = RsTemp.Fields(0)
'                  End If
'               Else
'                  '跨關係企業則不印地址
'               End If
'            End If
'         End If
'      End If
'      If stra0k03 <> "" Then
'         stSQL = "select cu01,cu02,cu04,cu112,cu23,cu30,cu31 from customer where cu01='" & Left(stra0k03, 8) & "' and cu02='" & Mid(stra0k03, 9, 1) & "'"
'         intR = 1
'         Set RsTemp = ClsLawReadRstMsg(intR, stSQL)
'         If intR = 1 Then
'            '聯絡地址優先
'            If Trim("" & RsTemp.Fields("cu31")) <> "" Then
'               strTmp = Trim("" & RsTemp.Fields("cu30")) & " " & Trim("" & RsTemp.Fields("cu31"))
'            '再來中文地址
'            ElseIf Trim("" & RsTemp.Fields("cu23")) <> "" Then
'               strTmp = Trim("" & RsTemp.Fields("cu112")) & " " & Trim("" & RsTemp.Fields("cu23"))
'            End If
'         End If
'      End If
      '收據抬頭為3個字以下(含3個字)以a0k03為主
      If Len(Trim("" & .Fields("a0k04").Value)) <= 3 Then
         stSQL = "select cu01,cu02,cu04,cu112,cu23,cu30,cu31 from customer where cu01='" & Left(Trim("" & .Fields("a0k03").Value), 8) & "' and cu02='" & Mid(Trim("" & .Fields("a0k03").Value), 9, 1) & "'"
         intR = 1
         Set RsTemp = ClsLawReadRstMsg(intR, stSQL)
         If intR = 1 Then
            'Add By Sindy 2015/12/8
            '聯絡地址優先
            If Trim("" & RsTemp.Fields("cu31")) <> "" Then
               strTmp = Trim("" & RsTemp.Fields("cu30")) & " " & Trim("" & RsTemp.Fields("cu31"))
            '2015/12/8 END
            '再抓中文地址
            ElseIf Trim("" & RsTemp.Fields("cu23")) <> "" Then
               strTmp = Trim("" & RsTemp.Fields("cu112")) & " " & Trim("" & RsTemp.Fields("cu23"))
            End If
         End If
      Else
         '以收據抬頭抓客戶檔之CU04,若為客戶資料則抓中文地址
         '                         若不存在,則再抓收據抬頭資料檔acc420的營業地址
         'Modify By Sindy 2014/8/15 +and (cu80 is null or cu80='其他' or cu80='業務自行處理')
         'Modify By Sindy 2016/1/7 收據抬頭只抓到1筆才使用
         'Modify By Sindy 2019/6/3 取消 cu80='其他' or cu80='業務自行處理',不列印地址 ex:PU14798050 / E10810732
         'stSQL = "select cu01,cu02,cu04,cu112,cu23,cu30,cu31 from customer where cu04='" & Trim("" & .Fields("a0k04").Value) & "' and cu02=0 and (cu80 is null or cu80='其他' or cu80='業務自行處理')"
         stSQL = "select cu01,cu02,cu04,cu112,cu23,cu30,cu31 from customer where cu04='" & Trim("" & .Fields("a0k04").Value) & "' and cu02=0 and cu80 is null"
         intR = 1
         Set RsTemp = ClsLawReadRstMsg(intR, stSQL)
         If intR = 1 And RsTemp.RecordCount = 1 Then
            'Add By Sindy 2015/12/8
            '聯絡地址優先
            If Trim("" & RsTemp.Fields("cu31")) <> "" Then
               strTmp = Trim("" & RsTemp.Fields("cu30")) & " " & Trim("" & RsTemp.Fields("cu31"))
            '2015/12/8 END
            '再抓中文地址
            ElseIf Trim("" & RsTemp.Fields("cu23")) <> "" Then
               strTmp = Trim("" & RsTemp.Fields("cu112")) & " " & Trim("" & RsTemp.Fields("cu23"))
            End If
         Else
            'Add By Sindy 2016/1/7 收據抬頭+客戶編號
            'Modify By Sindy 2019/6/3 取消 cu80='其他' or cu80='業務自行處理',不列印地址 ex:PU14798050 / E10810732
'            stSQL = "select cu01,cu02,cu04,cu112,cu23,cu30,cu31 from customer where cu04='" & Trim("" & .Fields("a0k04").Value) & "' and cu02=0 and (cu80 is null or cu80='其他' or cu80='業務自行處理')" & _
'                    " and cu01='" & Left(Trim("" & .Fields("a0k03").Value), 8) & "' and cu02='" & Mid(Trim("" & .Fields("a0k03").Value), 9, 1) & "'"
            stSQL = "select cu01,cu02,cu04,cu112,cu23,cu30,cu31 from customer where cu04='" & Trim("" & .Fields("a0k04").Value) & "' and cu02=0 and cu80 is null" & _
                    " and cu01='" & Left(Trim("" & .Fields("a0k03").Value), 8) & "' and cu02='" & Mid(Trim("" & .Fields("a0k03").Value), 9, 1) & "'"
            intR = 1
            Set RsTemp = ClsLawReadRstMsg(intR, stSQL)
            If intR = 1 And RsTemp.RecordCount = 1 Then
               '聯絡地址優先
               If Trim("" & RsTemp.Fields("cu31")) <> "" Then
                  strTmp = Trim("" & RsTemp.Fields("cu30")) & " " & Trim("" & RsTemp.Fields("cu31"))
               '再抓中文地址
               ElseIf Trim("" & RsTemp.Fields("cu23")) <> "" Then
                  strTmp = Trim("" & RsTemp.Fields("cu112")) & " " & Trim("" & RsTemp.Fields("cu23"))
               End If
            Else
            '2016/1/7 END
               stSQL = "select * from acc420 where a4201='" & Trim("" & .Fields("a0k04").Value) & "'"
               intR = 1
               Set RsTemp = ClsLawReadRstMsg(intR, stSQL)
               If intR = 1 Then
                  '營業地址
                  If Trim("" & RsTemp.Fields("a4215")) <> "" Then
                     strTmp = Trim("" & RsTemp.Fields("a4215"))
                  End If
               End If
            End If
         End If
      End If
      
      'Add By Sindy 2017/8/21 接洽人
      strPCC05 = "" ': iLine_PCC05 = iLine
      stSQL = "select nvl(pcc05,nvl(pcc03,pcc04)) from customer,potcustcont" & _
              " where cu01='" & Left(Trim("" & .Fields("a0k03").Value), 8) & "' and cu02='" & Mid(Trim("" & .Fields("a0k03").Value), 9, 1) & "'" & _
              " and cu01=pcc01 and cu127=pcc02"
      intR = 1
      Set RsTemp = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         If Trim("" & RsTemp.Fields(0)) <> "" Then
            strPCC05 = "（接洽人：" & RsTemp.Fields(0) & "）"
         End If
      End If
      '2017/8/21 END
      
      'add by sonia 2017/9/6 地址及接洽人要先抓案件的 E10613664
      If m_Address <> "" Then strTmp = m_Address
      If m_Contact <> "" Then strPCC05 = m_Contact
      'end 2017/9/6
   End With
End Sub

'Add By Sindy 2013/12/4
'列印收據抬頭
'Move by Lydia 2020/03/26 從aacc_fun搬來
Public Sub PUB_PrintReceiptHead_J(padoacc0k0 As ADODB.Recordset, pintTimes As Integer, pintPrintUniNo As Integer, _
                                  Optional pstrRePrint As String, Optional pstrPritDate As String, Optional pintPrintCustCaseNo As Integer)
   Dim stSQL As String, intR As Integer, strTmp As String
   Dim strDate As String
   Dim iLine As Integer, lngX As Long
   Dim stra0k03 As String, strCustCaseNo As String
   Dim strPCC05 As String, iLine_PCC05 As Integer
   
   With padoacc0k0
      If pstrPritDate <> "" Then
         strDate = pstrPritDate
      Else
         strDate = .Fields("a0k02")
      End If
      
'      Printer.Font = "標楷體"
      If pstrRePrint = "Y" Then
         Printer.FontSize = 12
         Printer.CurrentX = 8500
         Printer.CurrentY = 600
         Printer.Print "***  補開  ***"
      End If
      
      lngX = 700
      iLine = 3
      
      '公司名稱
      Printer.FontSize = 24
      Printer.FontBold = True
      Printer.CurrentX = Printer.ScaleWidth / 2 - (Printer.TextWidth("台一智權股份有限公司") / 2)
      Printer.CurrentY = iLine * 300
      Printer.Print "台一智權股份有限公司"
      
      iLine = iLine + 4
      Printer.FontSize = 12
      Printer.FontBold = False
      '電話
      Printer.CurrentX = lngX
      Printer.CurrentY = iLine * 300
      Printer.Print "總機：(02)2506-1023"
      
      'E-Mail
      Printer.CurrentX = 8000
      Printer.CurrentY = iLine * 300
      Printer.Print "E-mail：taie@seed.net.tw"
      
      '雙線
      Printer.Line (lngX, 2400)-(11000, 2400), , B
      Printer.Line (lngX, 2450)-(11000, 2450), , B
      
      iLine = iLine + 2
      Printer.FontSize = 12
      '客戶編號
      Printer.CurrentX = lngX
      Printer.CurrentY = iLine * 300
      'Printer.Print "客戶編號：" & "" & .Fields("a0k03").Value
      Printer.Print "編號：" & "" & .Fields("a0k03").Value
      
      '請款日期
      Printer.CurrentX = 7800
      Printer.CurrentY = iLine * 300
      Printer.Print "請款日期：" & CFDate(strDate)
      
      iLine = iLine + 1
      '收據抬頭
      strTmp = ""
      If IsNull(.Fields("a0k04").Value) = False Then
         strTmp = Trim(.Fields("a0k04").Value)
      End If
      Printer.CurrentX = lngX
      Printer.CurrentY = iLine * 300
      'Printer.Print "客戶名稱：" & strTmp
      Printer.Print "名稱：" & strTmp
      
      If pintPrintCustCaseNo = 1 Then
         '帳款類別變更
         If IsNull(.Fields("a0k33")) = False Then
            '收文日(最小)
            stSQL = "select * " & _
               " from acc0j0,caseprogress,nation where a0j13='" & .Fields("a0k01").Value & "' and cp09(+)=a0j01 and na01(+)=a0j04 and (cp79 <> 0 or (cp79 = 0 and cp75 <> 0)) " & _
               " order by a0j25 asc"
            intR = 1
            Set RsTemp = ClsLawReadRstMsg(intR, stSQL)
         Else
            '收據明細資料
            stSQL = "select a.*,b.*,getcp10desc(cp01,cp10,a0j04) cp10N,na03 from acc0j0 a,caseprogress b,nation where a0j13 = '" & .Fields("a0k01").Value & "' And cp09(+)=a0j01 and (cp79 <> 0 or (cp79 = 0 and cp75 <> 0)) and na01(+)=a0j04 ORDER BY CP09 "
            intR = 1
            Set RsTemp = ClsLawReadRstMsg(intR, stSQL)
         End If
         If RsTemp.RecordCount > 0 Then
            RsTemp.MoveFirst
            Do While Not RsTemp.EOF
               strTmp = CaseNameQuery(RsTemp.Fields("a0j01"), 1, strCustCaseNo)
               If strCustCaseNo <> "" Then
                  Printer.CurrentX = 7800
                  Printer.CurrentY = iLine * 300
                  Printer.Print "客戶案號：" & strCustCaseNo
                  Exit Do
               End If
               RsTemp.MoveNext
            Loop
         End If
         If strCustCaseNo = "" Then
            Printer.CurrentX = 7800
            Printer.CurrentY = iLine * 300
            Printer.Print "客戶案號："
         End If
      End If
      
      iLine = iLine + 1
      'Modify By Sindy 2020/3/23
      iLine_PCC05 = iLine
      '客戶地址
      Call PUB_PrintReceiptHead_Addr(padoacc0k0, strTmp, strPCC05)
      '2020/3/23 END
      Printer.CurrentX = lngX
      Printer.CurrentY = iLine * 300
      'Printer.Print "地　　址：" & strTmp
      strTmp = "地址：" & strTmp
      If LenB(strTmp) <= 44 Then '48
         Printer.Print strTmp
      Else
         Printer.Print MidB(strTmp, 1, 44)
         Printer.CurrentX = lngX
         Printer.CurrentY = (iLine + 1) * 300
         iLine_PCC05 = iLine + 1
         Printer.Print "　　　" & RightB(strTmp, LenB(strTmp) - 44)
      End If
      'Add By Sindy 2017/8/21 接洽人
      If strPCC05 <> "" Then
         Printer.CurrentX = lngX
         Printer.CurrentY = (iLine_PCC05 + 1) * 300
         Printer.Print "　　　" & strPCC05
      End If
      '2017/8/21 END
      
      iLine = iLine + 4
      '請款單
      Printer.FontSize = 24
      Printer.CurrentX = Printer.ScaleWidth / 2 - (Printer.TextWidth("請　　款　　單") / 2)
      Printer.CurrentY = iLine * 300
      Printer.Print "請　　款　　單"
      
      iLine = iLine + 1
      '請款單號
      Printer.FontSize = 12
      Printer.CurrentX = lngX
      Printer.CurrentY = iLine * 300
      Printer.Print "請款單號：" & .Fields("a0k01").Value
      
      '智權人員代號
      If IsNull(.Fields("a0k20").Value) = False Then
         '業務區
         If IsNull(.Fields("a0k22").Value) = False Then
            Printer.CurrentX = 9500 '7800
            Printer.CurrentY = iLine * 300
            Printer.Print .Fields("a0k22").Value
         End If
         Printer.CurrentX = 10000 '8300
         Printer.CurrentY = iLine * 300
         Printer.Print .Fields("a0k20").Value
      End If
   End With
End Sub

'Mark by Amy 2024/05/17 與Sindy 確認已沒在用
''Add By Sindy 2013/12/4
''列印收據合計
''Move by Lydia 2020/03/26 從aacc_fun搬來
'Public Sub PUB_PrintReceiptSum_J(plngAmount1 As Long, plngAmount2 As Long, _
'   m_strCP01 As String, m_strCP10 As String)
'Dim strAmount1 As String
'Dim strAmount2 As String
'Dim lngTotal As Long
'Dim intLength As Integer
'Dim iLine As Integer, lngX As Long
'Dim strAccPerson As String 'Add by Amy 2024/05/14
'
'   'Add by Amy 2024/05/17 財務2個特殊設定拆成3個
'   If Val(strSrvDate(1)) >= Val(財務拆總帳出納國內應收啟用日) Then
'       strAccPerson = Pub_GetSpecMan("財務處應收處理人員")
'   Else
'      strAccPerson = Pub_GetSpecMan("財務處出納人員")
'   End If
'
'   lngX = 700
'
'   '應收金額小計
'   If plngAmount1 = 0 Then
'      strAmount1 = "0"
'   Else
'      strAmount1 = Format(plngAmount1, DDollar)
'   End If
'   intLength = Printer.TextWidth(strAmount1)
'   Printer.CurrentX = 10950 - intLength
'   Printer.CurrentY = 9980
'   Printer.Print strAmount1
'
'   '營業稅小計
'   If plngAmount2 = 0 Then
'      strAmount2 = "0"
'   Else
'      'strAmount2 = Format(plngAmount2, DDollar)
'      strAmount2 = Format((plngAmount2 - Round((plngAmount2 / 1.05))), DDollar)
'   End If
'   intLength = Printer.TextWidth(strAmount2)
'   Printer.CurrentX = 10950 - intLength
'   Printer.CurrentY = 10480
'   Printer.Print strAmount2
'
'   '總計
'   'lngTotal = plngAmount1 + plngAmount2
'   'Added by Sindy 2020/11/11 J公司請款單之收文若為ACS案且案件性質706代收代付時，稅固定為0
'   If m_strCP01 = "ACS" And m_strCP10 = "706" Then
'      lngTotal = plngAmount1 + plngAmount2
'   Else
'   '2020/11/11 END
'      lngTotal = plngAmount2
'   End If
'   Printer.FontSize = 16
'   intLength = Printer.TextWidth("NTD" & Format(lngTotal, DDollar)) 'NT$
'   Printer.CurrentX = 10950 - intLength
'   Printer.CurrentY = 11030
'   Printer.Print "NTD" & Format(lngTotal, DDollar) 'NT$
'   Printer.CurrentX = 2300 '2500 '2100
'   Printer.CurrentY = 9980
'   Printer.Print ChangeNumber(CStr(lngTotal))
'
'   Printer.FontSize = 12
'   '表尾
'   iLine = 40
'   Printer.CurrentX = lngX
'   Printer.CurrentY = 300 * iLine
'   Printer.Print "付款方式："
'   iLine = iLine + 1
'   Printer.CurrentX = lngX
'   Printer.CurrentY = 300 * iLine
'   Printer.Print "1.請將上述款項匯入本公司以下帳戶"
'   iLine = iLine + 1
'   Printer.CurrentX = lngX
'   Printer.CurrentY = 300 * iLine
'   Printer.Print "  銀行名稱：瑞興商銀長安分行"
'   Printer.FontSize = 13
'   Printer.FontBold = True
'   Printer.CurrentX = 4300
'   Printer.CurrentY = 300 * iLine
'   Printer.Print "戶名：台一智權股份有限公司　帳號：0075 21 1607750"
'   Printer.FontSize = 12
'   Printer.FontBold = False
'   iLine = iLine + 1
'   Printer.CurrentX = lngX
'   Printer.CurrentY = 300 * iLine
'   Printer.Print "2.如以支票支付，支票抬頭請開「台一智權股份有限公司」"
'   iLine = iLine + 1
'   Printer.CurrentX = lngX
'   Printer.CurrentY = 300 * iLine
'   Printer.Print "  並請以掛號逕寄 10491 台北市長安東路2段112號9樓 會計室收"
'   'Added by Sindy 2020/11/11 J公司請款單之收文若為ACS案且案件性質706代收代付時，取消備註1
'   If m_strCP01 = "ACS" And m_strCP10 = "706" Then
'      iLine = iLine + 3
'      Printer.CurrentX = lngX
'      Printer.CurrentY = 300 * iLine
'      'Modify by Amy 2024/05/17 財務2個特殊設定拆成3個 原:Pub_GetSpecMan("財務處出納人員")
'      Printer.Print "備註：1.付款時請將相關請款單號以E-mail通知 " & strAccPerson & "@taie.com.tw"
'      iLine = iLine + 1
'      Printer.CurrentX = lngX
'      Printer.CurrentY = 300 * iLine
'      Printer.Print "　　　或請傳真 (02)2506-8147 會計室收，以利沖帳，謝謝您的支持與合作。"
'   Else
'   '2020/11/11 END
'      iLine = iLine + 3
'      Printer.CurrentX = lngX
'      Printer.CurrentY = 300 * iLine
'      Printer.Print "備註：1.發票將於收款後，另行寄發。"
'      iLine = iLine + 1
'      Printer.CurrentX = lngX
'      Printer.CurrentY = 300 * iLine
'      'Modify by Amy 2024/05/17 財務2個特殊設定拆成3個 原:Pub_GetSpecMan("財務處出納人員")
'      Printer.Print "　　　2.付款時請將相關請款單號以E-mail通知 " & strAccPerson & "@taie.com.tw"
'      iLine = iLine + 1
'      Printer.CurrentX = lngX
'      Printer.CurrentY = 300 * iLine
'      Printer.Print "　　　或請傳真 (02)2506-8147 會計室收，以利沖帳，謝謝您的支持與合作。"
'   End If
'End Sub

'Add By Sindy 2014/1/3
'pstrRePrint:是否補開(Y.補開)
'strPrAddr:Y.列印地址條
'Move by Lydia 2020/03/26 從aacc_fun搬來
Public Sub PUB_PrintCaseReceipt_Inv(padoacc0k0 As ADODB.Recordset, strPrAddr As String, Optional pstrRePrint As String = "", _
                                    Optional pbolUpdateTimes As Boolean = True)
Dim intTimes As Integer
Dim StrSQLa As String, intR As Integer
Dim adocaseprogress As ADODB.Recordset
Dim adoquery As ADODB.Recordset
Dim iLine As Integer, strText As String, ii As Integer, jj As Integer
Dim strSys As String
'Dim dblTax As Double
Dim dblAmt As Double
'Dim m_CP01 As String, m_CP02 As String, m_CP03 As String, m_CP04 As String
Dim intHeight As Integer
Dim strTemp As String
Dim strTmp As String
'Add By Sindy 2016/1/18
Dim strItemDesc As String
Dim dblTotAmt As Double
Dim strCaseNo As String
Dim strA0j23 As String
Dim strA0j24 As String
Dim varRef As Variant
Dim strProduct As String
Dim strNation As String
Dim strCustCaseNo As String
Dim strCaseName As String
'2016/1/18 End
Dim lngAmount1 As Long, lngAmount2 As Long 'Add By Sindy 2018/6/8
Dim intRow As Integer 'Add By Sindy 2018/6/8
   
   intHeight = 225
   
   With padoacc0k0
      '列印次數
      If IsNull(.Fields("a4306").Value) Then
         intTimes = 1
      ElseIf pbolUpdateTimes = False Then
         intTimes = Val(.Fields("a4306").Value)
      Else
         intTimes = Val(.Fields("a4306").Value) + 1
      End If
      
      '檢查是否有銷退
      If "" & IsNull(padoacc0k0.Fields("a4309")) = "Y" Then
         GoTo EXITSUB
      End If
      
      For jj = 1 To 2 '列印上下二次
         If jj = 1 Then
            iLine = 3
            If "" & padoacc0k0.Fields("a4303") = "" Then
               Printer.FontSize = 16
               Printer.FontBold = True
               iLine = 15
               Printer.CurrentX = 1200
               Printer.CurrentY = iLine * intHeight
               Printer.Print "此聯作廢"
               Printer.FontSize = 12
               Printer.FontBold = False
               GoTo PrintNext
            End If
         Else
            iLine = 41
         End If
         '發票日期
         Printer.CurrentX = 4500
         Printer.CurrentY = iLine * intHeight
         Printer.Print Left(padoacc0k0.Fields("a4302"), 3) & "　　 " & Mid(padoacc0k0.Fields("a4302"), 4, 2) & "　　 " & Mid(padoacc0k0.Fields("a4302"), 6, 2)
         '補開字樣
         'Modify By Sindy 2018/8/3 發票補開程式,補開字樣要拿掉
'         If pstrRePrint = "Y" Then
'            Printer.FontSize = 18
'            Printer.CurrentX = 8000
'            Printer.CurrentY = iLine * intHeight
'            Printer.Print "** 補開 **"
'            Printer.FontSize = 12
'         End If
         '發票號碼
         iLine = iLine + 3
         Printer.CurrentX = 1700
         Printer.CurrentY = iLine * intHeight
         Printer.Print padoacc0k0.Fields("a4301")
         '買受人
         iLine = iLine + 1
         Printer.CurrentX = 1700
         Printer.CurrentY = iLine * intHeight
         Printer.Print padoacc0k0.Fields("a0k04")
         '統一編號
         iLine = iLine + 1
         Printer.CurrentX = 1700
         Printer.CurrentY = iLine * intHeight
         Printer.Print "" & padoacc0k0.Fields("a4303")
         '檢查號碼
         Printer.CurrentX = 5000
         Printer.CurrentY = iLine * intHeight
         Printer.Print GetInvChkNumber(padoacc0k0.Fields("a4301"))
         '地址
         strTmp = ""
         '收據抬頭為3個字以下(含3個字)以a0k03為主
         If Len(Trim("" & .Fields("a0k04").Value)) <= 3 Then
            strSql = "select cu01,cu02,cu04,cu112,cu23,cu30,cu31 from customer where cu01='" & Left(Trim("" & .Fields("a0k03").Value), 8) & "' and cu02='" & Mid(Trim("" & .Fields("a0k03").Value), 9, 1) & "'"
            intR = 1
            Set RsTemp = ClsLawReadRstMsg(intR, strSql)
            If intR = 1 Then
               'Modify By Sindy 2014/4/1 Mark
'               '聯絡地址優先
'               If Trim("" & RsTemp.Fields("cu31")) <> "" Then
'                  strTmp = Trim("" & RsTemp.Fields("cu30")) & " " & Trim("" & RsTemp.Fields("cu31"))
'               '再來中文地址
'               Else
               If Trim("" & RsTemp.Fields("cu23")) <> "" Then
                  strTmp = Trim("" & RsTemp.Fields("cu112")) & " " & Trim("" & RsTemp.Fields("cu23"))
               End If
            End If
         Else
            '以收據抬頭抓客戶檔之CU04,若為客戶資料則抓中文地址
            '                         若不存在,則再抓收據抬頭資料檔acc420的營業地址
            'Modify By Sindy 2014/8/15 +and (cu80 is null or cu80='其他' or cu80='業務自行處理')
            'Modify By Sindy 2019/6/3 取消 cu80='其他' or cu80='業務自行處理',不列印地址 ex:PU14798050 / E10810732
            'strSql = "select cu01,cu02,cu04,cu112,cu23,cu30,cu31 from customer where cu04='" & Trim("" & .Fields("a0k04").Value) & "' and (cu80 is null or cu80='其他' or cu80='業務自行處理') and cu02=0"
            strSql = "select cu01,cu02,cu04,cu112,cu23,cu30,cu31 from customer where cu04='" & Trim("" & .Fields("a0k04").Value) & "' and cu80 is null and cu02=0"
            intR = 1
            Set RsTemp = ClsLawReadRstMsg(intR, strSql)
            If intR = 1 Then
               'Modify By Sindy 2014/4/1 Mark
'               '聯絡地址優先
'               If Trim("" & RsTemp.Fields("cu31")) <> "" Then
'                  strTmp = Trim("" & RsTemp.Fields("cu30")) & " " & Trim("" & RsTemp.Fields("cu31"))
'               '再來中文地址
'               Else
               If Trim("" & RsTemp.Fields("cu23")) <> "" Then
                  strTmp = Trim("" & RsTemp.Fields("cu112")) & " " & Trim("" & RsTemp.Fields("cu23"))
               End If
            Else
               strSql = "select * from acc420 where a4201='" & Trim("" & .Fields("a0k04").Value) & "'"
               intR = 1
               Set RsTemp = ClsLawReadRstMsg(intR, strSql)
               If intR = 1 Then
                  'Modify By Sindy 2014/4/1 Mark
'                  '郵寄地址優先
'                  If Trim("" & RsTemp.Fields("a4203")) <> "" Then
'                     strTmp = Trim("" & RsTemp.Fields("a4203"))
'                  '再來營業地址
'                  Else
                  If Trim("" & RsTemp.Fields("a4215")) <> "" Then
                     strTmp = Trim("" & RsTemp.Fields("a4215"))
                  End If
               End If
            End If
         End If
         iLine = iLine + 1
         Printer.CurrentX = 1700
         Printer.CurrentY = iLine * intHeight
         Printer.Print strTmp
         
         'Add By Sindy 2016/1/18
         '帳款類別變更
         If IsNull(.Fields("a0k33")) = False Then
            '收文日(最小)
            StrSQLa = "select * " & _
                      " from acc0j0,caseprogress,nation,casepropertymap where a0j13='" & .Fields("axc02").Value & "' and cp09(+)=a0j01 and na01(+)=a0j04 and (cp79 <> 0 or (cp79 = 0 and cp75 <> 0)) and cp01=cpm01(+) and cp10=cpm02(+)" & _
                      " order by a0j25 asc"
            intR = 1
            Set adocaseprogress = ClsLawReadRstMsg(intR, StrSQLa)
            If intR = 1 Then
               iLine = iLine + 2
               adocaseprogress.MoveFirst
               strItemDesc = adocaseprogress.Fields("a0j22") '帳款類別
               dblTotAmt = 0: strCaseNo = ""
               intRow = 0: lngAmount1 = 0: lngAmount2 = 0 'Add By Sindy 2018/6/8
               Do While adocaseprogress.EOF = False
                  intRow = intRow + 1 'Add By Sindy 2018/6/8
                  If strItemDesc <> adocaseprogress.Fields("a0j22") Then '帳款類別
                     'Modify By Sindy 2016/2/1
'                     iLine = iLine + 1
'                     strTemp = ""
'                     '列印申請國家,案件名稱,客戶案件案號
'                     If strA0j23 = "" Or strA0j24 = "" Then
'                        strTemp = IIf(strProduct <> "", " ", "") & Trim(strProduct & IIf(strNation <> "", "/", "") & strNation)
'                        If Len(Trim(strCaseName) & strTemp) > 28 Then
'                           strTemp = Left(Trim(strCaseName), 28 - Len(strTemp)) & "..." & strTemp
'                        Else
'                           strTemp = Trim(strCaseName) & strTemp
'                        End If
'                        Printer.CurrentX = 700
'                        Printer.CurrentY = (iLine * intHeight) + intHeight
'                        Printer.Print strTemp
'                     End If
'                     '帳款類別
'                     Printer.CurrentX = 700
'                     Printer.CurrentY = iLine * intHeight
'                     Printer.Print strItemDesc
                     '申請國家+專利/商標/案件性質
                     iLine = iLine + 1
                     Printer.CurrentX = 700
                     Printer.CurrentY = iLine * intHeight
                     Printer.Print strTemp & "/" & strItemDesc
                     '2016/2/1 END
                     
                     'Modify By Sindy 2018/6/8 ex:QU26012609, CN19738087
'                     If "" & padoacc0k0.Fields("a4303") = "" Then
'                        dblTax = 0 '稅
'                     Else
'                        dblTax = dblTotAmt - Round((dblTotAmt / 1.05), 0) '稅
'                     End If
'                     strText = Format(dblTotAmt - dblTax, DDollar2)
                     lngAmount2 = lngAmount2 + dblTotAmt 'lngAmount2=總金額
                     If "" & padoacc0k0.Fields("a4303") = "" Then
                        strText = dblTotAmt
                     Else
                        strText = Round((dblTotAmt / 1.05))
                        '計算後可能會有差額1,2元;最後一筆要攤平 ex.E10309340
                        If intRow = adocaseprogress.RecordCount Then
                           strText = Round((lngAmount2 / 1.05)) - lngAmount1
                        End If
                     End If
                     lngAmount1 = lngAmount1 + Val(Format(strText)) 'lngAmount1=總淨額(扣掉稅額)
                     strText = Format(strText, DDollar)
                     '2018/6/8 END
                     Printer.CurrentX = 7000 - Printer.TextWidth(strText)
                     Printer.CurrentY = iLine * intHeight
                     Printer.Print strText
                     '本所案號
                     Printer.CurrentX = 7450
                     Printer.CurrentY = iLine * intHeight
                     Printer.Print strCaseNo
                     dblTotAmt = 0: strCaseNo = ""
'                     'If strTemp <> "" Then iLine = 1
'                     If strTemp <> "" Then iLine = iLine + 1 'Modify By Sindy 2016/2/1
                  End If
                  If strCaseNo = "" Then
                     '列印本所案號,申請國家,案件名稱,客戶案件案號
                     strCaseNo = adocaseprogress.Fields("a0j02") '本所案號
                     'Modify By Sindy 2016/2/1
'                     strA0j23 = "" & adocaseprogress.Fields("a0j23")
'                     strA0j24 = "" & adocaseprogress.Fields("a0j24")
'                     If Right(strCaseNo, 3) = "000" Then
'                        strCaseNo = Left(strCaseNo, Len(strCaseNo) - 3)
'                     End If
'                     If strA0j23 = "" Then
'                        '查名案加印商品類別
'                        If adocaseprogress.Fields("cp01").Value = "S" Or adocaseprogress.Fields("cp01").Value = "TS" Then
'                           StrSQLa = "select SP18 as tm09 from SERVICEPRACTICE where SP01 = '" & adocaseprogress.Fields("cp01").Value & "' and SP02 = '" & adocaseprogress.Fields("cp02").Value & "' and SP03 = '" & adocaseprogress.Fields("cp03").Value & "' and SP04 = '" & adocaseprogress.Fields("cp04").Value & "'"
'                        Else
'                           StrSQLa = "select tm09 from trademark where tm01 = '" & adocaseprogress.Fields("cp01").Value & "' and tm02 = '" & adocaseprogress.Fields("cp02").Value & "' and tm03 = '" & adocaseprogress.Fields("cp03").Value & "' and tm04 = '" & adocaseprogress.Fields("cp04").Value & "'"
'                        End If
'                        intR = 1
'                        Set adoquery = ClsLawReadRstMsg(intR, StrSQLa)
'                        If intR = 1 Then
'                           If IsNull(adoquery.Fields("tm09").Value) = False Then
'                              varRef = Split(adoquery.Fields("tm09").Value, ",")
'                              If UBound(varRef) > 4 Then
'                                 strProduct = "第" & varRef(0) & "," & varRef(1) & "," & varRef(2) & "," & varRef(3) & "," & varRef(4) & "...類"
'                              Else
'                                 strProduct = "第" & adoquery.Fields("tm09").Value & " 類"
'                              End If
'                           End If
'                        End If
'                        adoquery.Close
'                     End If
'                     If strA0j23 = "" Then
'                        '國家
'                        If IsNull(adocaseprogress.Fields("na03").Value) = False Then
'                           strNation = adocaseprogress.Fields("na03").Value
'                        End If
'                     End If
'                     If strA0j24 = "" Then
'                        '列印案件名稱(以總收文號查詢)及客戶案件名稱(Optional)
'                        strCaseName = CaseNameQuery(adocaseprogress.Fields("a0j01").Value, 1, strCustCaseNo)
'                        If strCaseName = "" Then
'                           strCaseName = CaseNameQuery(adocaseprogress.Fields("a0j01").Value, 2)
'                        End If
'                     End If
                     '2016/2/1 END
                  End If
                  
                  '金額
                  dblAmt = Val("" & adocaseprogress.Fields("a0j09")) + Val("" & adocaseprogress.Fields("a0j10"))
                  '是否有銷帳金額
                  StrSQLa = "select nvl(sum(nvl(a1u07,0))+sum(nvl(a1u09,0)),0) A1uAmt from acc1u0 where a1u02='" & padoacc0k0.Fields("axc02") & "' and a1u03='" & adocaseprogress.Fields("a0j01") & "'"
                  intR = 1
                  Set adoquery = ClsLawReadRstMsg(intR, StrSQLa)
                  If intR = 1 Then
                     If adoquery.Fields(0) > 0 Then
                        dblAmt = dblAmt - adoquery.Fields(0)
                     End If
                  End If
                  adoquery.Close
                  dblTotAmt = dblTotAmt + dblAmt
                  
                  'Add By Sindy 2016/2/1
                  strSys = CheckSys(Left(adocaseprogress.Fields("a0j02"), Len(adocaseprogress.Fields("a0j02")) - 9))
                  strTemp = GetPrjNationName("" & adocaseprogress.Fields("a0j04")) & IIf(strSys = "1" Or strSys = "5", "專利", IIf(strSys = "2" Or strSys = "6", "商標", "服務費"))
                  '2016/2/1 END
                  strItemDesc = adocaseprogress.Fields("a0j22") '帳款類別
                  adocaseprogress.MoveNext
               Loop
               'Modify By Sindy 2016/2/1
'               iLine = iLine + 1
'               strTemp = ""
'               '列印申請國家,案件名稱,客戶案件案號
'               If strA0j23 = "" Or strA0j24 = "" Then
'                  strTemp = IIf(strProduct <> "", " ", "") & Trim(strProduct & IIf(strNation <> "", "/", "") & strNation)
'                  If Len(Trim(strCaseName) & strTemp) > 28 Then
'                     strTemp = Left(Trim(strCaseName), 28 - Len(strTemp)) & "..." & strTemp
'                  Else
'                     strTemp = Trim(strCaseName) & strTemp
'                  End If
'                  Printer.CurrentX = 700
'                  Printer.CurrentY = (iLine * intHeight) + intHeight
'                  Printer.Print strTemp
'               End If
'               '帳款類別
'               Printer.CurrentX = 700
'               Printer.CurrentY = iLine * intHeight
'               Printer.Print strItemDesc
               '申請國家+專利/商標/案件性質
               iLine = iLine + 1
               Printer.CurrentX = 700
               Printer.CurrentY = iLine * intHeight
               Printer.Print strTemp & "/" & strItemDesc
               '2016/2/1 END
               
               'Modify By Sindy 2018/6/8
'               If "" & padoacc0k0.Fields("a4303") = "" Then
'                  dblTax = 0 '稅
'               Else
'                  dblTax = dblTotAmt - Round((dblTotAmt / 1.05), 0) '稅
'               End If
'               strText = Format(dblTotAmt - dblTax, DDollar2)
               lngAmount2 = lngAmount2 + dblTotAmt 'lngAmount2=總金額
               If "" & padoacc0k0.Fields("a4303") = "" Then
                  strText = dblTotAmt
               Else
                  strText = Round((dblTotAmt / 1.05))
                  '計算後可能會有差額1,2元;最後一筆要攤平 ex.E10309340
                  If intRow = adocaseprogress.RecordCount Then
                     strText = Round((lngAmount2 / 1.05)) - lngAmount1
                  End If
               End If
               lngAmount1 = lngAmount1 + Val(Format(strText)) 'lngAmount1=總淨額(扣掉稅額)
               strText = Format(strText, DDollar)
               '2018/6/8 END
               Printer.CurrentX = 7000 - Printer.TextWidth(strText)
               Printer.CurrentY = iLine * intHeight
               Printer.Print strText
               '本所案號
               Printer.CurrentX = 7450
               Printer.CurrentY = iLine * intHeight
               Printer.Print strCaseNo
'               'If strTemp <> "" Then iLine = 1
'               If strTemp <> "" Then iLine = iLine + 1 'Modify By Sindy 2016/2/1
            End If
         Else
         '2016/1/18 END
            '發票明細資料
            'Modify By Sindy 2022/6/21 + and (cp79 <> 0 or (cp79 = 0 and cp75 <> 0))
            StrSQLa = "select * from acc0j0,caseprogress,casepropertymap where a0j13='" & .Fields("axc02").Value & "' and a0j01=cp09(+) and (cp79 <> 0 or (cp79 = 0 and cp75 <> 0)) and cp01=cpm01(+) and cp10=cpm02(+) ORDER BY a0j01 asc"
            intR = 1
            Set adocaseprogress = ClsLawReadRstMsg(intR, StrSQLa)
            intRow = 0: lngAmount1 = 0: lngAmount2 = 0 'Add By Sindy 2018/6/8
            If intR = 1 Then
               iLine = iLine + 2
               adocaseprogress.MoveFirst
               Do While adocaseprogress.EOF = False
                  intRow = intRow + 1 'Add By Sindy 2018/6/8
   '               If strPrAddr = "Y" Then
   '                  '新增地址條列表資料
   '                  m_CP01 = Left(Trim(adocaseprogress.Fields("a0j02")), Len(Trim(adocaseprogress.Fields("a0j02"))) - 9)
   '                  m_CP02 = Mid(Trim(adocaseprogress.Fields("a0j02")), Len(Trim(adocaseprogress.Fields("a0j02"))) - 8, 6)
   '                  m_CP03 = Mid(Trim(adocaseprogress.Fields("a0j02")), Len(Trim(adocaseprogress.Fields("a0j02"))) - 2, 1)
   '                  m_CP04 = Right(Trim(adocaseprogress.Fields("a0j02")), 2)
   '                  pub_AddressListSN = pub_AddressListSN + 1
   '                  PUB_AddNewAddressList strUserNum, m_CP01, m_CP02, m_CP03, m_CP04, "" & pub_AddressListSN, "0", GetCP10(padoacc0k0.Fields("axc02"))
   '               End If
                  '申請國家+專利/商標/案件性質
                  iLine = iLine + 1
                  Printer.CurrentX = 700
                  Printer.CurrentY = iLine * intHeight
                  strSys = CheckSys(Left(adocaseprogress.Fields("a0j02"), Len(adocaseprogress.Fields("a0j02")) - 9))
                  'Modify By Sindy 2014/2/10
                  'Printer.Print GetPrjNationName("" & adocaseprogress.Fields("a0j04")) & IIf(strSys = "1" Or strSys = "5", "專利", "商標") & "/" & IIf("" & adocaseprogress.Fields("a0j04") = "020", adocaseprogress.Fields("cpm04"), adocaseprogress.Fields("cpm03"))
                  Printer.Print GetPrjNationName("" & adocaseprogress.Fields("a0j04")) & IIf(strSys = "1" Or strSys = "5", "專利", IIf(strSys = "2" Or strSys = "6", "商標", "服務費")) & "/" & IIf("" & adocaseprogress.Fields("a0j04") = "020", adocaseprogress.Fields("cpm04"), adocaseprogress.Fields("cpm03"))
                  '2014/2/10 END
                  '金額
                  dblAmt = Val("" & adocaseprogress.Fields("a0j09")) + Val("" & adocaseprogress.Fields("a0j10"))
                  '是否有銷帳金額
                  StrSQLa = "select nvl(sum(nvl(a1u07,0))+sum(nvl(a1u09,0)),0) A1uAmt from acc1u0 where a1u02='" & padoacc0k0.Fields("axc02") & "' and a1u03='" & adocaseprogress.Fields("a0j01") & "'"
                  intR = 1
                  Set adoquery = ClsLawReadRstMsg(intR, StrSQLa)
                  If intR = 1 Then
                     If adoquery.Fields(0) > 0 Then
                        dblAmt = dblAmt - adoquery.Fields(0)
                     End If
                  End If
                  adoquery.Close
                  'Modify By Sindy 2014/10/21
                  'Modify By Sindy 2018/6/8 ex:QU26012609, CN19738087
                  lngAmount2 = lngAmount2 + dblAmt 'lngAmount2=總金額
                  If "" & padoacc0k0.Fields("a4303") = "" Then
                     'dblTax = 0 '稅
                     strText = dblAmt
                  Else
                  '2014/10/21 END
                     'dblTax = dblAmt - Round((dblAmt / 1.05), 0) '稅
                     strText = Round((dblAmt / 1.05))
                     '計算後可能會有差額1,2元;最後一筆要攤平 ex.E10309340
                     If intRow = adocaseprogress.RecordCount Then
                        strText = Round((lngAmount2 / 1.05)) - lngAmount1
                     End If
                  End If
                  'strText = Format(dblAmt - dblTax, DDollar2)
                  lngAmount1 = lngAmount1 + Val(Format(strText)) 'lngAmount1=總淨額(扣掉稅額)
                  strText = Format(strText, DDollar)
                  '2018/6/8 END
                  Printer.CurrentX = 7000 - Printer.TextWidth(strText)
                  Printer.CurrentY = iLine * intHeight
                  Printer.Print strText
                  '本所案號
                  Printer.CurrentX = 7450
                  Printer.CurrentY = iLine * intHeight
                  Printer.Print "" & adocaseprogress.Fields("a0j02")
                  adocaseprogress.MoveNext
               Loop
            End If
         End If
         adocaseprogress.Close
         
         '銷售額合計
         If jj = 1 Then
            iLine = 21
         Else
            iLine = 59
         End If
         
'2014/12/2 還原 by sonia 個人無稅額,已從存檔控制,故列印不需再控管
'         'Modify By Sindy 2014/10/21
'         If "" & padoacc0k0.Fields("a4303") = "" Then
'            strText = Format(Val("" & padoacc0k0.Fields("a4304")) + Val("" & padoacc0k0.Fields("a4305")), DDollar2)
'         Else
'         '2014/10/21 END
'            strText = Format(Val("" & padoacc0k0.Fields("a4304")), DDollar2)
'         End If
         strText = Format(Val("" & padoacc0k0.Fields("a4304")), DDollar2)
'2014/12/2 end
         Printer.CurrentX = 7000 - Printer.TextWidth(strText)
         Printer.CurrentY = iLine * intHeight + 50
         Printer.Print strText
         'Modify by Amy 2019/05/14 增加零稅率
          iLine = iLine + 3
         If IsNull(padoacc0k0.Fields("a4323")) = False Then
            '零稅率
            Printer.CurrentX = 4000
         Else
             '應稅額
             Printer.CurrentX = 2700
         End If
         Printer.CurrentY = iLine * intHeight
         Printer.Print "V"
         'end 2019/05/14
'2014/12/2 還原 by sonia 個人無稅額,已從存檔控制,故列印不需再控管
'         'Modify By Sindy 2014/10/21
'         If "" & padoacc0k0.Fields("a4303") = "" Then
'            strText = "0"
'         Else
'         '2014/10/21 END
'            strText = Format(Val("" & padoacc0k0.Fields("a4305")), DDollar2)
'         End If
         strText = Format(Val("" & padoacc0k0.Fields("a4305")), DDollar2)
'2014/12/2 end
         Printer.CurrentX = 7000 - Printer.TextWidth(strText)
         Printer.CurrentY = iLine * intHeight
         Printer.Print strText
         '總計
         iLine = iLine + 1
         strText = Format(Val("" & padoacc0k0.Fields("a4304")) + Val("" & padoacc0k0.Fields("a4305")), DDollar2)
         Printer.CurrentX = 7000 - Printer.TextWidth(strText)
         Printer.CurrentY = iLine * intHeight + 50
         Printer.Print strText
         '總計中文大寫
         iLine = iLine + 2
         dblAmt = Val("" & padoacc0k0.Fields("a4304")) + Val("" & padoacc0k0.Fields("a4305"))
         strText = "": strTemp = ""
         For ii = 1 To Len(Trim(CStr(dblAmt)))
            strTemp = strTemp & ShowNumberWord(Mid(CStr(dblAmt), ii, 1))
         Next ii
         '2014/1/20 add by sonia 不足8位數前加'零'
         If Len(Trim(strTemp)) < 8 Then
            For ii = 1 To (8 - Len(Trim(strTemp)))
               strTemp = "零" & strTemp
            Next ii
         End If
         '2014/1/20 end
         '1    2     3    4     5    6     7    8
         '零　 零　　零　 貳　　零　 零　　零　 零
         For ii = Len(strTemp) To 1 Step -1
            If ii = 1 Then
               strText = Mid(strTemp, ii, 1) & strText
            ElseIf ii = 8 Or ii = 6 Or ii = 4 Or ii = 2 Then
               strText = "　 " & Mid(strTemp, ii, 1) & strText
            Else
               strText = "　　" & Mid(strTemp, ii, 1) & strText
            End If
         Next ii
         Printer.CurrentX = 6600 - Printer.TextWidth(strText)
         Printer.CurrentY = iLine * intHeight
         Printer.Print strText
         '請款單號
         If jj = 1 Then
            iLine = 33
         Else
            iLine = 71
         End If
         Printer.CurrentX = 700
         Printer.CurrentY = iLine * intHeight
         If jj = 2 Then Printer.CurrentY = Printer.CurrentY + 50
         Printer.Print "" & padoacc0k0.Fields("axc02")
         '業務區
         Printer.CurrentX = 7500
         Printer.CurrentY = iLine * intHeight
         If jj = 2 Then Printer.CurrentY = Printer.CurrentY + 50
         Printer.Print "" & padoacc0k0.Fields("st15")
         '智權人員編號
         Printer.CurrentX = 8500
         Printer.CurrentY = iLine * intHeight
         If jj = 2 Then Printer.CurrentY = Printer.CurrentY + 50
         Printer.Print "" & padoacc0k0.Fields("a0k20")
PrintNext:
      Next jj
      
      'Modify By Sindy 2014/12/23 補開時要更新
      If pstrRePrint = "Y" Then
         '更新發票的列印次數及列印時間
         'Modify By Sindy 2014/12/25 補開發票只要更新列印次數,列印日期欄不要更新(因為要記錄第一次列印的日期)
         'adoTaie.Execute "update acc430 set a4306=" & intTimes & ",a4307=sysdate where a4301='" & .Fields("a4301").Value & "'"
         adoTaie.Execute "update acc430 set a4306=" & intTimes & " where a4301='" & .Fields("a4301").Value & "'"
         '2014/12/25 END
      Else
         'Modify By Sindy 2014/4/3 移到列印地址條時再一併更新
         '更新發票的列印次數及列印時間
         'Modify By Sindy 2015/1/20 改回到此處更新
         adoTaie.Execute "update acc430 set a4306=" & intTimes & ",a4307=sysdate where a4301='" & .Fields("a4301").Value & "'"
         '2015/1/20 END
      End If
   End With
   
EXITSUB:
   
   Set adocaseprogress = Nothing
   Set adoquery = Nothing
End Sub

'Add By Cheng 2003/10/16
'取得案件性質
'Move by Lydia 2020/03/26 從aacc_fun搬來
Private Function GetCP10(strA1K01 As String) As String
   Dim StrSQLa As String
   Dim rsA As New ADODB.Recordset
   
   GetCP10 = ""
   'Modify by Morgan 2007/4/2 加判斷相關總收文號的案件性質
   StrSQLa = "Select C1.CP01 ,C1.CP10,C2.CP10 CP10x From Caseprogress C1, Caseprogress C2 Where C1.CP60='" & strA1K01 & "' AND C2.CP09(+)=C1.CP43"
   rsA.CursorLocation = adUseClient
   rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
   If rsA.RecordCount > 0 Then
      Do While Not rsA.EOF
         GetCP10 = "" & rsA("CP10").Value
         Select Case "" & rsA("CP01").Value
            Case "FCP", "CFP", "P"
               If "" & rsA("CP10").Value = "605" Then
                  Exit Do
               ElseIf "" & rsA("CP10x").Value = "605" Then
                  GetCP10 = "" & rsA("CP10x").Value
                  Exit Do
               End If
            Case "FCT", "CFT", "T", "TF"
               If "" & rsA("CP10").Value = "102" Then
                  Exit Do
               ElseIf "" & rsA("CP10x").Value = "102" Then
                  GetCP10 = "" & rsA("CP10x").Value
                  Exit Do
               End If
         End Select
         rsA.MoveNext
      Loop
   End If
   'end 2007/4/2
   
   If rsA.State <> adStateClosed Then rsA.Close
   Set rsA = Nothing
End Function

'設定列印字數
'Move by Lydia 2020/03/26 從aacc_fun搬來
Private Function ReOrgPrintTemp(strPrintTemp As String, intCnt As Integer) As String
Dim ii As Integer

ReOrgPrintTemp = ""
For ii = 1 To Len(strPrintTemp)
    ReOrgPrintTemp = ReOrgPrintTemp & Mid(strPrintTemp, ii, 1)
    If Printer.TextWidth(ReOrgPrintTemp) > Printer.TextWidth(String(intCnt, "　")) Then
        ReOrgPrintTemp = Left(ReOrgPrintTemp, Len(ReOrgPrintTemp) - 1)
        Exit For
    End If
Next ii
End Function

'Add by Morgan 2011/9/19
'列印收據抬頭
'Move by Lydia 2020/03/26 從aacc_fun搬來
'Modify By Sindy 2020/4/30 + , Optional bolIsTT9 As Boolean = False
'Modify By Sindy 2020/7/15 + , Optional pbolA4Print As Boolean = False 改用A4列印
'Modify By Sindy 2020/10/28 + , Optional pbolGetData As Boolean = False 非列印,純回傳變數值
'   , Optional ByRef m_A0k01 As String, Optional ByRef m_A0k02 As String, _
'   Optional ByRef m_A0K03 As String, Optional ByRef m_A0K04 As String, Optional ByRef m_Sales As String, _
'   Optional ByRef m_Addr As String
Public Sub PUB_PrintReceiptHead(padoacc0k0 As ADODB.Recordset, pintPrintUniNo As Integer, _
   Optional pstrRePrint As String, Optional pstrPritDate As String, Optional bolIsTT9 As Boolean = False, _
   Optional pbolA4Print As Boolean = False, _
   Optional pbolGetData As Boolean = False, Optional ByRef m_A0k01 As String, Optional ByRef m_A0k02 As String, _
   Optional ByRef m_A0K03 As String, Optional ByRef m_A0K04 As String, Optional ByRef m_Sales As String, _
   Optional ByRef m_Addr As String)
   
   Dim stSQL As String, intR As Integer, strTmp As String
   Dim strDate As String
   
   m_A0k01 = "": m_A0k02 = "": m_A0K03 = ""
   m_A0K04 = "": m_Sales = "": m_Addr = ""
   With padoacc0k0
   
   'Modify By Sindy 2020/10/28
   If pbolGetData = False Then
   '2020/10/28 END
      Select Case .Fields("a0k11").Value
         Case "1", "2"
         Case Else
            stSQL = "select * from acc080 where a0801 = '" & .Fields("a0k11").Value & "'"
            intR = 1
            Set RsTemp = ClsLawReadRstMsg(intR, stSQL)
            If intR = 1 Then
               With RsTemp
               '公司名稱
               If IsNull(.Fields("a0802").Value) = False Then
                  Printer.FontSize = 18
                  Printer.CurrentX = 3500
                  Printer.CurrentY = 300
                  Printer.Print .Fields("a0802").Value
               End If
               
               '發票地址
               Printer.FontSize = 12
               Printer.CurrentX = 3000
               Printer.CurrentY = 700
               If IsNull(.Fields("a0804").Value) Then
                  Printer.Print ReportSum(102)
               Else
                  Printer.Print ReportSum(102) & .Fields("a0804").Value
               End If
               
               '電話
               Printer.CurrentX = 3000
               Printer.CurrentY = 1000
               If IsNull(.Fields("a0813").Value) Then
                  Printer.Print ReportSum(103)
               Else
                  Printer.Print ReportSum(103) & .Fields("a0813").Value
               End If
               End With
            End If
      End Select
   End If
   
   If pstrPritDate <> "" Then
      strDate = pstrPritDate
   Else
      strDate = .Fields("a0k02")
   End If
   
   '收據日期
   'Modify By Sindy 2020/10/28
   If pbolGetData = True Then
      m_A0k02 = strDate
   Else
   '2020/10/28 END
      'Add By Sindy 2020/7/15
      If pbolA4Print = True Then
         '收據日期
         Printer.CurrentX = Px(4)
         Printer.CurrentY = Py_t(0)
         Printer.Print Mid(CFDate(strDate), 1, 3) & " 年 " & Mid(CFDate(strDate), 5, 2) & " 月 " & Mid(CFDate(strDate), 8, 2) & " 日"
      Else
      '2020/7/15 END
         '收據日期-年份
         Printer.CurrentX = 8300 '8200
         Printer.CurrentY = 1950
         Printer.Print Mid(CFDate(strDate), 1, 3)
         
         '收據日期-月份
         Printer.CurrentX = 9300 '9200
         Printer.CurrentY = 1950
         Printer.Print Mid(CFDate(strDate), 5, 2)
         
         '收據日期-日
         Printer.CurrentX = 10200 '10300
         Printer.CurrentY = 1950
         Printer.Print Mid(CFDate(strDate), 8, 2)
      End If
   End If
   
   '客戶編號
   'Modify By Sindy 2020/10/28
   If pbolGetData = True Then
      m_A0K03 = "" & .Fields("A0K03").Value
   Else
   '2020/10/28 END
      If IsNull(.Fields("a0k03").Value) = False Then
         'Add By Sindy 2020/7/15
         If pbolA4Print = True Then
            Printer.CurrentX = Px(0) + 1200
            Printer.CurrentY = Py_t(1)
         Else
         '2020/7/15 END
            Printer.CurrentX = 1350 '1250
            Printer.CurrentY = 2200
         End If
         Printer.Print .Fields("a0k03").Value
      End If
   End If
   
   '收據編號
   'Modify By Sindy 2020/10/28
   If pbolGetData = True Then
      m_A0k01 = .Fields("A0K01").Value
   Else
   '2020/10/28 END
      'Add By Sindy 2020/7/15
      If pbolA4Print = True Then
         Printer.CurrentX = Px(4)
         Printer.CurrentY = Py_t(1)
      Else
      '2020/7/15 END
         Printer.CurrentX = 8300 '8200
         Printer.CurrentY = 2200
      End If
      Printer.Print .Fields("a0k01").Value
   End If
   
   '收據抬頭
   'Modify By Sindy 2020/10/28
   If pbolGetData = False Then
   '2020/10/28 END
      'Add By Sindy 2020/7/15
      If pbolA4Print = True Then
         Printer.CurrentX = Px(0) + 1200
         Printer.CurrentY = Py_t(2)
      Else
      '2020/7/15 END
         Printer.CurrentX = 1350 '1250
         Printer.CurrentY = 2450
      End If
   End If
   If IsNull(.Fields("a0k04").Value) = False Then
      strTmp = Trim(.Fields("a0k04").Value)
      '統一編號(Optional)
      'Modified by Morgan 2025/8/8 改都抓設定就好--瑞婷
      'If pintPrintUniNo = vbChecked Or Trim(.Fields("A0K03")) = "X73395000" Then
      If pintPrintUniNo = vbChecked Then
      'end 2025/8/8
         'Add By Sindy 2015/3/19
'         If Trim(.Fields("A0K03")) = "X73395000" Then '李彩雲固定一定要帶統編  Modify By Sindy 2017/5/4 Mark
            '依收據抬頭抓抬頭檔的統編
            stSQL = "select * from acc420 where a4201='" & Trim(.Fields("a0k04").Value) & "'"
            intR = 1
            Set RsTemp = ClsLawReadRstMsg(intR, stSQL)
            If intR = 1 Then
               If IsNull(RsTemp.Fields("a4202").Value) = False Then
                  strTmp = strTmp & " (" & RsTemp.Fields("a4202").Value & ")"
               End If
            Else
               'Modify By Sindy 2022/9/8
               If IsNull(m_CU11) = False Then
                  strTmp = strTmp & " (" & m_CU11 & ")"
               '2022/9/8 END
               ElseIf IsNull(.Fields("CU11").Value) = False Then
                  strTmp = strTmp & " (" & .Fields("CU11").Value & ")"
               End If
            End If
'         Else
'         '2015/3/19 END
'            If IsNull(.Fields("CU11").Value) = False Then
'               strTmp = strTmp & " (" & .Fields("CU11").Value & ")"
'            End If
'         End If
      End If
      'Modify By Sindy 2020/10/28
      If pbolGetData = True Then
         m_A0K04 = strTmp
      Else
      '2020/10/28 END
         Printer.Print strTmp
      End If
   End If

   '智權人員代號
   If IsNull(.Fields("a0k20").Value) = False Then
      'Modify By Sindy 2020/4/30
      '智慧所收據本所案號是TT-999999時(一定存在於法律所案源檔)， 不印業務區只印智權人員編號
      If bolIsTT9 = False Then
      '2020/4/30 END
         '業務區
         If IsNull(.Fields("a0k22").Value) = False Then
            'Modify By Sindy 2020/10/28
            If pbolGetData = True Then
               m_Sales = .Fields("A0K22").Value
            Else
            '2020/10/28 END
               'Add By Sindy 2020/7/15
               If pbolA4Print = True Then
                  Printer.CurrentX = Px(4)
                  Printer.CurrentY = Py_t(2)
               Else
               '2020/7/15 END
                  Printer.CurrentX = 8300 '8200
                  Printer.CurrentY = 2450
               End If
               Printer.Print .Fields("a0k22").Value
            End If
         End If
      End If
      'Modify By Sindy 2020/10/28
      If pbolGetData = True Then
         m_Sales = m_Sales & IIf(m_Sales <> "", "　", "") & .Fields("a0k20").Value
      Else
      '2020/10/28 END
         'Add By Sindy 2020/7/15
         If pbolA4Print = True Then
            Printer.CurrentX = Px(4) + 600
            Printer.CurrentY = Py_t(2)
         Else
         '2020/7/15 END
            Printer.CurrentX = 8850 '8650
            Printer.CurrentY = 2450
         End If
         Printer.Print .Fields("a0k20").Value
      End If
   End If
      
   If Trim(.Fields("A0K03")) = "X70017000" Then
      'Add by Lydia 2014/10/2 和碩公司之收據印上中文地址
      stSQL = "select cu01,cu02,cu04,cu112,cu23,cu30,cu31 from customer" & _
              " where cu01='" & Left(Trim("" & .Fields("a0k03").Value), 8) & "' and cu02='" & Mid(Trim("" & .Fields("a0k03").Value), 9, 1) & "'"
      intR = 1
      Set RsTemp = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         '中文地址
         'Modify By Sindy 2020/10/28
         If pbolGetData = True Then
            If Trim("" & RsTemp.Fields("cu23")) <> "" Then
               m_Addr = Trim("" & RsTemp.Fields("cu23"))
            End If
         Else
         '2020/10/28 END
            'Add By Sindy 2020/7/15
            If pbolA4Print = True Then
               Printer.CurrentX = Px(0) + 1200
               Printer.CurrentY = Py_t(3)
            Else
            '2020/7/15 END
               Printer.CurrentX = 1350 '1250
               Printer.CurrentY = 2700
            End If
            If Trim("" & RsTemp.Fields("cu23")) <> "" Then
               Printer.Print Trim("" & RsTemp.Fields("cu23"))  'CU23中文地址, CU112 郵遞區號
            End If
         End If
      End If
   End If
   
   If pstrRePrint = "Y" Then
      'Add By Sindy 2020/7/15
      If pbolA4Print = True Then
         Printer.CurrentX = Px(4)
         Printer.CurrentY = Py(1) + 100
      Else
      '2020/7/15 END
         Printer.CurrentX = 8300 '8200
         Printer.CurrentY = 3600
      End If
      Printer.Print "***  補開  ***"
   End If
   
   End With
End Sub

'Add by Morgan 2011/9/19
'列印收據合計
'Move by Lydia 2020/03/26 從aacc_fun搬來
'Modify By Sindy 2020/7/15 + , Optional pbolA4Print As Boolean = False 改用A4列印
Public Sub PUB_PrintReceiptSum(plngAmount1 As Long, plngAmount2 As Long, strA0K11 As String, _
   Optional pbolA4Print As Boolean = False)
   
   Dim strAmount1 As String, strAmount2 As String
   Dim lngTotal As Long
   Dim intLength As Integer

   '服務費小計
   If plngAmount1 = 0 Then
      strAmount1 = "0"
   Else
      strAmount1 = Format(plngAmount1, DDollar)
   End If
   intLength = Printer.TextWidth(strAmount1)
   
   'Add By Sindy 2020/7/15
   If pbolA4Print = True Then
      Printer.CurrentX = Px(2) + 1500 - intLength
      Printer.CurrentY = Py(6) + 100
   Else
   '2020/7/15 END
      Printer.CurrentX = 5900 - intLength
      'Modify By Sindy 2020/4/1
      If strA0K11 = "1" Then '舊專利商標
         Printer.CurrentY = 5000
      Else
      '2020/4/1 END
         Printer.CurrentY = 5300
      End If
   End If
   Printer.Print strAmount1
   
   '規費小計
   If plngAmount2 = 0 Then
      strAmount2 = "0"
   Else
      strAmount2 = Format(plngAmount2, DDollar)
   End If
   intLength = Printer.TextWidth(strAmount2)
   
   'Add By Sindy 2020/7/15
   If pbolA4Print = True Then
      Printer.CurrentX = Px(3) + 1500 - intLength
      Printer.CurrentY = Py(6) + 100
   Else
   '2020/7/15 END
      Printer.CurrentX = 7600 - intLength
      'Modify By Sindy 2020/4/1
      If strA0K11 = "1" Then '舊專利商標
         Printer.CurrentY = 5000
      Else
      '2020/4/1 END
         Printer.CurrentY = 5300
      End If
   End If
   Printer.Print strAmount2
   
   '總計
   lngTotal = plngAmount1 + plngAmount2
   Printer.FontSize = 18
   intLength = Printer.TextWidth("NTD" & Format(lngTotal, DDollar)) 'NT$
   
   'Add By Sindy 2020/7/15
   If pbolA4Print = True Then
      Printer.CurrentX = Px(3) + 200 - intLength
      Printer.CurrentY = Py(7) + 50
   Else
   '2020/7/15 END
      Printer.CurrentX = 7400 - intLength
      'Modify By Sindy 2020/4/1
      If strA0K11 = "1" Then '舊專利商標
         Printer.CurrentY = 5650
      Else
      '2020/4/1 END
         Printer.CurrentY = 5850
      End If
   End If
   Printer.Print "NTD" & Format(lngTotal, DDollar) 'NT$
   Printer.FontSize = 12
End Sub

'Add by Sindy 2020/7/15
'啟動列印收據
'strPrintKind : 0.列表機 1.影印機
'intTableNo : 1.上頁 2.下頁
'bolSingleRow : 是否單筆
Public Sub PUB_PrintCaseReceiptTableMain(TextX As Double, TextY As Double, strPrintKind As Integer, _
   intTableNo As Integer, Optional bolSingleRow As Boolean = False)
Dim Xo As Integer, Yo As Integer, xi As Long, yi As Long
Dim iWidth As Integer
   
   If intTableNo <= 0 Or intTableNo > 2 Then Exit Sub
   If bolSingleRow = True Then
      Printer.EndDoc
      Printer.PaperSize = 9
      Printer.Orientation = 1
      Printer.Font = "新細明體"
   End If
   
   'For ii = 1 To 2
      ReDim Px(15) As Integer
      ReDim Py(15) As Integer
      ReDim Py_t(3) As Integer
      
      TwPerCm = 520
   '   iMargin = 150
      iWidth = 10500
      Printer.FontSize = 12
      iLineHeight = Printer.TextHeight("字") + 47
      
      TextX = Val(TextX)
      TextY = Val(TextY)
      Xo = ((Printer.ScaleWidth - iWidth) / 2) + (Val(TextX) * 567)
      If strPrintKind = 0 Then '列表機
         If intTableNo = 1 Then '上頁
            'Yo = 150
            Yo = (0.2 * 567) + (Val(TextY) * 567)
         Else '下頁
            'Yo = (Printer.ScaleHeight / 2) + 540
            Yo = (14.7 * 567) + (0.5 * 567) + (Val(TextY) * 567)
         End If
      Else '影印機
         If intTableNo = 1 Then '上頁
            'Yo = 350
            Yo = (0.6 * 567) + (Val(TextY) * 567)
         Else '下頁
            'Yo = (Printer.ScaleHeight / 2) + 570
            Yo = (14.7 * 567) + (0.7 * 567) + (Val(TextY) * 567)
         End If
      End If
      
      Printer.FontSize = 20
      strExc(1) = A0802Query("1")
      'xi = Xo + iWidth / 2 - Printer.TextWidth(strExc(1)) / 2
      xi = Printer.ScaleWidth / 2 - (Printer.TextWidth(strExc(1)) / 2)
      yi = Yo
      Printer.CurrentX = xi: Printer.CurrentY = yi
      Printer.Print strExc(1)
      
      Printer.FontSize = 9
      'strExc(1) = "臺北所：臺北市長安東路二段112號9樓　臺中所：臺中市臺灣大道二段300號10樓"
      xi = Printer.ScaleWidth / 2 - (5.7 * 567)
      yi = yi + 1.8 * iLineHeight
      Printer.CurrentX = xi: Printer.CurrentY = yi
      Printer.Print "台北所：台北市長安東路二段112號9樓"
      xi = Printer.ScaleWidth / 2 + (0.2 * 567)
      Printer.CurrentX = xi: Printer.CurrentY = yi
      Printer.Print "台中所：台中市臺灣大道二段300號10樓"
      
      xi = Printer.ScaleWidth / 2 - (5.7 * 567)
      yi = yi + 0.8 * iLineHeight
      Printer.CurrentX = xi: Printer.CurrentY = yi
      Printer.Print "電　話：(02)25061023(總機)"
      xi = Printer.ScaleWidth / 2 + (0.2 * 567)
      Printer.CurrentX = xi: Printer.CurrentY = yi
      Printer.Print "電　話：(04)23270288(總機)"
      
      xi = Printer.ScaleWidth / 2 - (5.7 * 567)
      yi = yi + 0.8 * iLineHeight
      Printer.CurrentX = xi: Printer.CurrentY = yi
      Printer.Print "台南所：(06)2743866  (總機)"
      xi = Printer.ScaleWidth / 2 + (0.2 * 567)
      Printer.CurrentX = xi: Printer.CurrentY = yi
      Printer.Print "高雄所：(07)2363602  (總機)"
      
      Printer.FontSize = 20
      Printer.FontBold = True
      Printer.FontUnderline = True
      strExc(1) = "收　　據"
      xi = Printer.ScaleWidth / 2 - (Printer.TextWidth(strExc(1)) / 2)
      yi = yi + 1 * iLineHeight
      Printer.CurrentX = xi: Printer.CurrentY = yi
      'HPrint strExc(1)
      Printer.Print strExc(1)
      Printer.FontBold = False
      Printer.FontUnderline = False
      
      '畫表格
      Px(0) = Xo: Py(0) = yi
      PUB_PrintCaseReceiptTable
      
'      Printer.CurrentX = Px(0): Printer.CurrentY = 4000
'      Printer.Print "Px(0)"
'      Printer.CurrentX = Px(1): Printer.CurrentY = 4000
'      Printer.Print "Px(1)"
'      Printer.CurrentX = Px(2): Printer.CurrentY = 4000
'      Printer.Print "Px(2)"
'      Printer.CurrentX = Px(3): Printer.CurrentY = 4000
'      Printer.Print "Px(3)"
'      Printer.CurrentX = Px(4): Printer.CurrentY = 4000
'      Printer.Print "Px(4)"
'      Printer.CurrentX = Px(5): Printer.CurrentY = 4000
'      Printer.Print "Px(5)"
   'Next ii
End Sub

'Add by Sindy 2020/7/15
'畫收據表格
Public Sub PUB_PrintCaseReceiptTable()
Dim xi As Long, yi As Long
   
   Px(1) = Px(0) + 4 * TwPerCm
   Px(2) = Px(1) + 4 * TwPerCm
   Px(3) = Px(2) + 4 * TwPerCm
   Px(4) = Px(3) + 4 * TwPerCm
   Px(5) = Px(4) + 4 * TwPerCm + 150
   
   Printer.FontSize = 12
   
   xi = Px(4) - Printer.TextWidth("日　　期：")
   yi = Py(0) + (iLineHeight / 2)
   Py_t(0) = yi
   Printer.CurrentX = xi: Printer.CurrentY = yi
   Printer.Print "日　　期："
   
   xi = Px(0)
   yi = Py(0) + 1.5 * iLineHeight
   Py_t(1) = yi
   Printer.CurrentX = xi: Printer.CurrentY = yi
   Printer.Print "客戶代號："
   xi = Px(4) - Printer.TextWidth("收據號碼：")
   Printer.CurrentX = xi: Printer.CurrentY = yi
   Printer.Print "收據號碼："
   
   xi = Px(0)
   yi = yi + 1 * iLineHeight
   Py_t(2) = yi
   Printer.CurrentX = xi: Printer.CurrentY = yi
   Printer.Print "客戶名稱："
   Py_t(3) = yi + 1 * iLineHeight
   Py(0) = yi + 2 * iLineHeight
   
   For intI = 1 To 12
      Py(intI) = Py(intI - 1) + 1.5 * iLineHeight
   Next
   
   Printer.DrawStyle = 0 'vbSolid=0 : 實線 'Add By Sindy 2021/12/15 南所唐惠琴反應變虛線
   Printer.DrawWidth = 7
   '框
   Printer.Line (Px(0), Py(0))-(Px(5), Py(10)), , B
   
   Printer.DrawWidth = 1
   '縱線
   Printer.Line (Px(2) - 500, Py(0))-(Px(2) - 500, Py(8))
   Printer.Line (Px(3) - 500, Py(0))-(Px(3) - 500, Py(7))
   Printer.Line (Px(4) - 500, Py(0))-(Px(4) - 500, Py(8))
   
   '橫線
   Printer.Line (Px(0), Py(1))-(Px(5), Py(1)) '1
   For intI = 6 To 7
      Printer.Line (Px(0), Py(intI))-(Px(4) - 500, Py(intI))
   Next
   Printer.Line (Px(0), Py(8))-(Px(5), Py(8)) '8
   
   Printer.CurrentX = Px(0) + 400
   Printer.CurrentY = Py(0) + 100
   HPrint "帳　　款　　類　　別"
   Printer.CurrentX = Px(2) - 200
   Printer.CurrentY = Py(0) + 100
   HPrint "本所服務費"
   Printer.CurrentX = Px(3) - 300
   Printer.CurrentY = Py(0) + 100
   HPrint "代收政府規費"
   Printer.CurrentX = Px(4) - 100
   Printer.CurrentY = Py(0) + 100
   HPrint "收 據 專 用 章"
   
   Printer.CurrentX = Px(0) + 400
   Printer.CurrentY = Py(6) + 100
   HPrint "小　　　　　　　　計"
   Printer.CurrentX = Px(0) + 400
   Printer.CurrentY = Py(7) + 100
   HPrint "總　　　　　　　　計"
   Printer.CurrentX = Px(3) + 1000
   Printer.CurrentY = Py(7) + 100
   Printer.Print "元整"
   
   Printer.FontSize = 9
   Printer.CurrentX = Px(3) - 150
   Printer.CurrentY = Py(5) + 200
   Printer.Print "(此項規費請勿扣繳)"
   Printer.CurrentX = Px(0) + 200
   yi = Py(8) + 100
   Printer.CurrentY = yi
   Printer.Print "附註：1.依所得稅法第88條規定，貴公司因報帳之需要，服務費金額在二萬元以上，請扣除執行業務所得稅10%。扣除之稅款"
   Printer.CurrentX = Px(0) + 200
   yi = yi + 1 * iLineHeight - 50
   Printer.CurrentY = yi
   Printer.Print "　　　   請務必於次月十日前向國庫繳清。請依(收據資料)填具扣繳憑單寄本所財務處。"
   Printer.CurrentX = Px(0) + 200
   yi = yi + 1 * iLineHeight - 50
   Printer.CurrentY = yi
   Printer.Print "　　　2.申請人為個人者，請勿扣繳。"
          
   'Printer.Line (Px(0), Py(12))-(Px(12), Py(12))
   Printer.FontSize = 12
'   Printer.CurrentX = Px(0)
'   yi = Py(10) + 50
'   Printer.CurrentY = yi
'   Printer.Print "本所案號：" & "FCT-052232" & "　　案件名稱：淨水器"
'   Printer.CurrentX = Px(0)
'   yi = yi + 1 * iLineHeight
'   Printer.CurrentY = yi
'   Printer.Print "　　　　　台灣"
End Sub

'垂直列印
Private Sub VPrint(sWords As String, Optional iGap As Integer = 50)
   Dim Xo As Integer, Yo As Integer, ii As Integer
   Xo = Printer.CurrentX
   Yo = Printer.CurrentY
   For ii = 1 To Len(sWords)
      Printer.CurrentX = Xo
      Printer.CurrentY = Yo + (ii - 1) * (Printer.TextHeight(Space(1)) + iGap)
      Printer.Print Mid(sWords, ii, 1)
   Next
End Sub

'水平列印
Private Sub HPrint(sWords As String, Optional iGap As Integer = 50)
   Dim Xo As Integer, Yo As Integer, ii As Integer
   Xo = Printer.CurrentX
   Yo = Printer.CurrentY
   For ii = 1 To Len(sWords)
      Printer.CurrentX = Xo
      Printer.CurrentY = Yo
      Printer.Print Mid(sWords, ii, 1)
      Xo = Xo + Printer.TextWidth(Mid(sWords, ii, 1)) + iGap
   Next
End Sub

'Add By Sindy 2022/1/26 frm210141.繳款作業及收據PDF (非正式收據)
'Frmacc1410.收據列印 (多筆收據,會有雙張收據問題 +, Optional strPType As String = "")
'Frmacc1420.補開收據列印
Public Function PUB_PrintCaseReceipt_Doc(pFileFullPath As String, AdoRs As ADODB.Recordset, pintPrintUniNo As Integer, _
   pintPrintCustCaseNo As Integer, Optional pintNoPrintPatentYear As Integer, _
   Optional pstrRePrint As String, Optional pstrNewDesc1 As String, Optional pstrNewDesc2 As String, _
   Optional pstrPritDate As String, Optional pbolUpdateTimes As Boolean = True, _
   Optional pbolA4Print As Boolean = False, Optional strPdfFileNm As String = "", Optional strPType As String = "")
   
Dim bolHadRvdata As Boolean
Dim strA0K01 As String, strA0k02 As String, stra0k03 As String
Dim strA0K04 As String, strSales As String, strAddr As String
Dim strTmpFileName As String
Dim i As Integer, jj As Integer, k As Integer
Dim strName As String
Dim strText As String
Dim TmpDirNm As String, strSaveFileName As String
Dim intFontSize As Integer 'Add By Sindy 2024/8/15
Dim strPath As String 'Add By Sindy 2025/9/18
   
   bolHadRvdata = PUB_PrintCaseReceipt_2(AdoRs, pintPrintUniNo, pintPrintCustCaseNo, pintNoPrintPatentYear, _
      pstrRePrint, pstrNewDesc1, pstrNewDesc2, pstrPritDate, pbolUpdateTimes, pbolA4Print)
      
   If bolHadRvdata = True And m_intRecPos > m_intRecMaxItem Then
      If strPdfFileNm <> "" Then
         MsgBox "收據項目超過4項（收據範本只支援到4項），請通知電腦中心！" & vbCrLf & _
                "收據號碼：" & m_strNo & " 收據項目：" & m_intRecMaxItem
      End If
      bolHadRvdata = False
   End If
   If bolHadRvdata = True Then
      PUB_PrintReceiptHead AdoRs, IIf(m_CU173 = "Y", 1, 0), , pstrPritDate, m_bolIsTT9, True, True, strA0K01, strA0k02, _
                           stra0k03, strA0K04, strSales, strAddr
      
      If strPType <> "雙張收據列印" And pFileFullPath <> "" Then
         'Modify By Sindy 2025/8/20 增加日期時間:暫存著有狀況時當天可以查看狀況,系統啟動時會清$$電子檔
         'strTmpFileName = "$$Temp.doc"
         strTmpFileName = "$$" & strSrvDate(2) & ServerTime & "_2_" & strA0K01 & ".doc" 'Modify By Sindy 2025/9/17
         '2025/8/20 END
         strPath = Mid(pFileFullPath, 1, InStrRev(pFileFullPath, "\")) 'Add By Sindy 2025/9/18
         If Dir(strPath & strTmpFileName) <> "" Then
            Kill strPath & strTmpFileName
         End If
         strTmpFileName = strPath & strTmpFileName
      
         '判斷word是否已開啟
         If g_WordAp Is Nothing Then
RestarWord:
            Set g_WordAp = New Word.Application
            'g_WordAp.Visible = False 'Modify By Sindy 2025/9/17 mark
         End If
         g_WordAp.Visible = False 'Add By Sindy 2025/9/17
         g_WordAp.Documents.Open pFileFullPath
         g_WordAp.ActiveDocument.SaveAs strTmpFileName
         g_WordAp.ActiveDocument.Close
         g_WordAp.Documents.Open strTmpFileName
      End If
      
      With g_WordAp
         '.Selection.WholeStory
         '.Selection.Copy
         .Selection.HomeKey Unit:=wdStory
         For i = 1 To 14 '13
            .Selection.HomeKey Unit:=wdStory
            intFontSize = 0 'Add By Sindy 2024/8/15 不指定字型大小
            strName = ""
            strText = ""
            If i = 1 Then
               strName = "收據日期"
               strA0k02 = DBDATE(strA0k02)
               strText = Left(strA0k02, 4) - 1911 & "年" & Mid(strA0k02, 5, 2) & "月" & Right(strA0k02, 2) & "日"
            ElseIf i = 2 Then
               strName = "收據號碼"
               strText = m_strNo
            ElseIf i = 3 Then
               strName = "請款單抬頭"
               strText = strA0K04
            ElseIf i = 4 Then
               strName = "地址"
               strText = strAddr
            ElseIf i = 5 Then
               strName = "智權人員"
               strText = strSales
            'Add By Sindy 2022/3/15
            ElseIf i = 6 Then
               strName = "補開"
               If pstrRePrint = "Y" Then
                  strText = "***  補開  ***"
               End If
            '2022/3/15 END
            ElseIf i = 7 Then
               strName = "備註1"
               strText = m_strNote1
            ElseIf i = 8 Then
               strName = "客戶代號"
               strText = stra0k03
            ElseIf i = 9 Then
               strName = "小計服務費"
               strText = IIf(m_lngAmount1 = 0, "0", Format(m_lngAmount1, DDollar)) '"NTD " &
            ElseIf i = 10 Then
               strName = "小計規費"
               strText = IIf(m_lngAmount2 = 0, "0", Format(m_lngAmount2, DDollar)) '"NTD " &
            ElseIf i = 11 Then
               strName = "總金額"
               strText = "NTD " & Format(Val(m_lngAmount1) + Val(m_lngAmount2), DDollar)
            ElseIf i = 12 Then
               strName = "客戶案件案號"
               If m_strCustCaseNo <> "" Then
                  'Add By Sindy 2024/8/15
                  '檢查內容是否有中文字
                  For k = 1 To Len(m_strCustCaseNo)
                     If Asc(Mid(m_strCustCaseNo, k, 1)) <= 0 Then
                        intFontSize = 8
                        Exit For
                     End If
                  Next k
                  If intFontSize > 0 And Len(m_strCustCaseNo) > 10 Then
                     strText = m_strCustCaseNo
                  Else
                     intFontSize = 0
                  '2024/8/15 END
                     strText = "客戶案件案號：" & m_strCustCaseNo
                  End If
               Else
                  strText = ""
               End If
            ElseIf i = 13 Then
               strName = "備註2"
               'Modify By Sindy 2024/6/25 案件名稱太長用...表示
               'strText = convForm(CheckStr(m_strNote2), 112) 'm_strNote2 'Modify By Sindy 2022/4/20 E11107660: 截取28個中文字
               If Trim(m_strNote2) <> Trim(convForm(CheckStr(m_strNote2), 100)) Then
                  strText = Trim(convForm(CheckStr(m_strNote2), 100)) & "..."
               Else
                  strText = m_strNote2
               End If
               '2024/6/25 END
            'Add By Sindy 2022/7/13 + 列印次數
            ElseIf i = 14 Then
               strName = "列印次數"
               strText = m_intTimes
            End If
            If Trim(strName) <> "" Then
               '.Selection.WholeStory 'Add By Sindy 2022/1/27
               '.Selection.Copy 'Add By Sindy 2022/1/27
               .Selection.Find.ClearFormatting
               .Selection.Find.Text = "|#" & strName & "#|"
               .Selection.Find.Replacement.Text = ""
               .Selection.Find.Forward = True
               .Selection.Find.Wrap = wdFindContinue
               .Selection.Find.Format = False
               .Selection.Find.MatchCase = False
               .Selection.Find.MatchWholeWord = False
               .Selection.Find.MatchWildcards = False
               .Selection.Find.MatchSoundsLike = False
               .Selection.Find.MatchAllWordForms = False
               .Selection.Find.MatchByte = True
               .Selection.Find.Execute
               .Selection.Delete
               .Selection.Font.ColorIndex = wdBlack
               'Add By Sindy 2024/8/15
               If intFontSize > 0 Then
                  .Selection.TypeText Trim(strName) & "：" '標題
                  .Selection.Font.Size = intFontSize
                  .Selection.TypeText strText '內容
               Else
               '2024/8/15 END
                  .Selection.TypeText strText
               End If
            End If
         Next i
         'Add By Sindy 2022/3/8
         '檢查帳款類別是否需要折行
         Dim intTmp As Integer, int_J As Integer, intLen As Integer
         Dim tmp_strItemDesc(1 To 6) As String, tmp_strAmount1(1 To 6) As String, tmp_strAmount2(1 To 6) As String '請參 m_intRecMaxItem
         Dim chkStrItemDesc As String
         intTmp = 0: int_J = m_intRecMaxItem
         For i = 1 To m_intRecMaxItem
            If m_strItemDesc(i) <> "" Then
               intTmp = intTmp + 1
               tmp_strAmount1(intTmp) = m_strAmount1(i)
               tmp_strAmount2(intTmp) = m_strAmount2(i)
               chkStrItemDesc = "": intLen = 0
               'Modify By Sindy 2023/6/19 30 改抓 29 : ex:維持費 第3次(專利權期間2024年 1月3日-2030年8月7日)
               If PUB_StrToStr(m_strItemDesc(i), 29) <> m_strItemDesc(i) Then
                  For jj = int_J To 1 Step -1
                     If intLen = 0 Then
                        tmp_strItemDesc(intTmp) = PUB_StrToStr(m_strItemDesc(i), 29)
                     Else
                        'Modify By Sindy 2023/6/19
                        'tmp_strItemDesc(intTmp) = PUB_StrToStr(Replace(m_strItemDesc(i), chkStrItemDesc, ""), 30)
                        tmp_strItemDesc(intTmp) = PUB_StrToStr(Mid(m_strItemDesc(i), Len(chkStrItemDesc) + 1), 29)
                        '2023/6/19 END
                     End If
                     intLen = intLen + 1
                     chkStrItemDesc = chkStrItemDesc & tmp_strItemDesc(intTmp)
                     If chkStrItemDesc = m_strItemDesc(i) Then
                        Exit For
                     Else
                        intTmp = intTmp + 1
                        tmp_strAmount1(intTmp) = ""
                        tmp_strAmount2(intTmp) = ""
                     End If
                     int_J = jj - 1
                  Next jj
                  If int_J = 1 Then Exit For
               Else
                  tmp_strItemDesc(intTmp) = m_strItemDesc(i)
               End If
            Else
               Exit For
            End If
         Next i
         If intTmp <> m_intRecPos Then
            For i = 1 To intTmp
               m_strItemDesc(i) = tmp_strItemDesc(i)
               m_strAmount1(i) = tmp_strAmount1(i)
               m_strAmount2(i) = tmp_strAmount2(i)
            Next i
         End If
         '2022/3/8 END
         For i = 1 To m_intRecMaxItem
            .Selection.HomeKey Unit:=wdStory
            For jj = 1 To 3
               strName = ""
               strText = ""
               If jj = 1 Then
                  strName = "帳款類別" & IIf(i > 1, i, "")
                  strText = m_strItemDesc(i) 'ex: E11105847(4項)
               ElseIf jj = 2 Then
                  strName = "服務費" & IIf(i > 1, i, "")
                  strText = m_strAmount1(i)
                  'strText = IIf(GRD1.TextMatrix(i, 2) = 0, 0, Format(GRD1.TextMatrix(i, 2), DDollar))
               ElseIf jj = 3 Then
                  strName = "規費" & IIf(i > 1, i, "")
                  strText = m_strAmount2(i)
                  'strText = IIf(GRD1.TextMatrix(i, 3) = 0, 0, Format(GRD1.TextMatrix(i, 3), DDollar))
               End If
               If Trim(strName) <> "" Then
                  .Selection.Find.ClearFormatting
                  .Selection.Find.Text = "|#" & strName & "#|"
                  .Selection.Find.Replacement.Text = ""
                  .Selection.Find.Forward = True
                  .Selection.Find.Wrap = wdFindContinue
                  .Selection.Find.Format = False
                  .Selection.Find.MatchCase = False
                  .Selection.Find.MatchWholeWord = False
                  .Selection.Find.MatchWildcards = False
                  .Selection.Find.MatchSoundsLike = False
                  .Selection.Find.MatchAllWordForms = False
                  .Selection.Find.MatchByte = True
                  .Selection.Find.Execute
                  .Selection.Delete
                  .Selection.Font.ColorIndex = wdBlack
                  .Selection.TypeText strText
               End If
            Next jj
         Next i
         
         'Add By Sindy 2020/11/20 用Word轉Pdf功能
         If strPdfFileNm <> "" Then
            TmpDirNm = Mid(strPdfFileNm, 1, InStrRev(strPdfFileNm, "\") - 1)
            strSaveFileName = Mid(strPdfFileNm, InStrRev(strPdfFileNm, "\") + 1, Len(strPdfFileNm) - 4 - InStrRev(strPdfFileNm, "\"))
            frmPDF.Show
'            If pub_Word2Pdf Then
               g_WordAp.ActiveDocument.ExportAsFixedFormat OutputFileName:=TmpDirNm & "\" & strSaveFileName & ".pdf", ExportFormat:=17, OpenAfterExport:=False
'            Else
'               '轉PDF
'               frmPDF.StartProcess TmpDirNm, strSaveFileName
'               '切換印表機
'               If PUB_PdfCreatorNameInWord = "" Then PUB_PdfCreatorNameInWord = PUB_GetCreatorNameInWord
'               g_WordAp.ActivePrinter = PUB_PdfCreatorNameInWord
'               g_WordAp.ActiveDocument.PrintOut Background:=False, Copies:=1, Collate:=True
'               frmPDF.EndtProcess
'            End If
            Unload frmPDF
            g_WordAp.Quit wdDoNotSaveChanges
            Set g_WordAp = Nothing 'Added by Morgan 2025/9/10
         Else
            .ActiveDocument.Save
            If strPType <> "雙張收據不印" Then
               .ActiveDocument.PrintOut Background:=False, Copies:=1, Collate:=True
               'Modified by Morgan 2025/9/11 換變數
               'If pub_OsPrinter <> "" Then PUB_WaitUntilNoJob pub_OsPrinter 'Added by Morgan 2025/9/3 有發生漏印，加檢查印表機已清空才繼續
               If pub_OsPrinterA <> "" Then PUB_WaitUntilNoJob pub_OsPrinterA
               g_WordAp.ActiveDocument.Close
               'g_WordAp.Quit 'Removed by Morgan 2025/9/8 改系統結束時執行，因重複啟動Word會慢
            End If
         End If
      End With
      'Removed by Morgan 2025/9/8 改系統結束時執行，因重複啟動Word會慢
      'If strPType <> "雙張收據不印" Then
      '   Set g_WordAp = Nothing
      'End If
      'end 2025/9/8
   End If
   
   Exit Function
   
'EXITSUB:
'   Set adocaseprogress = Nothing
'   Set adoquery = Nothing
'
'   Exit Function
   
ErrHand:
   If strPType <> "雙張收據不印" Then
      Set g_WordAp = Nothing
   End If
   If Err.Number = 462 Then '遠端伺服器不存在或無法使用
      GoTo RestarWord
   ElseIf Err.Number <> 0 Then
      MsgBox (Err.Description)
      If Not g_WordAp Is Nothing Then
         g_WordAp.Quit
         Set g_WordAp = Nothing
      End If
   End If
'
'   Set adocaseprogress = Nothing
'   Set adoquery = Nothing
End Function

'Modify By Sindy 2020/11/2 和 basUpdate (PUB_PrintCaseReceipt) 同取值條件, 有修改時2邊注意是否都要一併調整
'Add by Morgan 2011/9/19
'列印收據(整合 Frmacc1410 & Frmacc1420)
'pintPrintUniNo:列印統一編號,pintPrintCustCaseNo:列印客戶案件案號,pintNoPrintPatentYear:不列印專利年費年度
'pstrRePrint:是否補開(Y/N),pstrNewDesc1:案件性質名稱1,pstrNewDesc2:案件性質名稱2,pstrPritDate:列印日期
'Modified by Morgan 2013/5/1 +pbolUpdateTimes
'Move by Lydia 2020/03/26 從aacc_fun搬來
'Modify By Sindy 2020/7/15 , Optional pbolA4Print As Boolean = False 改用A4列印
Public Function PUB_PrintCaseReceipt_2(padoacc0k0 As ADODB.Recordset, pintPrintUniNo As Integer, _
   pintPrintCustCaseNo As Integer, Optional pintNoPrintPatentYear As Integer, _
   Optional pstrRePrint As String, Optional pstrNewDesc1 As String, Optional pstrNewDesc2 As String, _
   Optional pstrPritDate As String, Optional pbolUpdateTimes As Boolean = True, _
   Optional pbolA4Print As Boolean = False) As Boolean
   
Dim adocaseprogress As ADODB.Recordset
Dim adoquery As ADODB.Recordset
Dim StrSQLa As String, intR As Integer
Dim douService As Double '已銷服務費
Dim douFee As Double '已銷規費

Dim intList As Integer
Dim blnCombPrint As Boolean '收據項目合併列印

'Add By Sindy 2009/07/14
Dim strPA08 As String, strPA09 As String
Dim strFeeType As String, strYF15 As String
Dim strKey(5) As String
Dim strCaseFee(1 To 2) As String
Dim bFind As Boolean
Dim varRef As Variant
'2009/07/14 End
Dim strProduct As String '商品類別
Dim m_FixNo As Integer   '2010/2/12 add by sonia 修法次數

Dim lngItemAmount1 As Long '單項服務費
Dim lngItemAmount2 As Long '單項規費

Dim strCaseNo As String, strCaseNoList As String
Dim strLOSCName As String
Dim strTemp As String
Dim i As Integer
Dim strPA10 As String 'Added by Morgan 2022/6/13

   '清變數值
   m_CU173 = ""
   m_bolIsTT9 = False
   m_intTimes = 0: m_intRecPos = 0: m_strNo = ""
   For i = 1 To m_intRecMaxItem
      m_strItemDesc(i) = ""
      m_strAmount1(i) = ""
      m_strAmount2(i) = ""
   Next i
   m_lngAmount1 = 0: m_lngAmount2 = 0
   m_strNote1 = "": m_strNote2 = "": m_strCustCaseNo = ""
   
   PUB_PrintCaseReceipt_2 = False
   
   With padoacc0k0
   
   m_strNo = .Fields("a0k01").Value
   '列印次數
   If IsNull(.Fields("a0k19").Value) Then
      m_intTimes = 1
   'Added by Morgan 2013/5/1
   ElseIf pbolUpdateTimes = False Then
      m_intTimes = Val(.Fields("a0k19").Value)
   'end 2013/5/1
   Else
      m_intTimes = Val(.Fields("a0k19").Value) + 1
   End If
   
   'Added by Morgan 2012/6/20
   '檢查是否已全銷
   If Not IsNull(padoacc0k0.Fields("a0k10")) Then
      StrSQLa = "select nvl(sum(a1u07),0)+nvl(sum(a1u09),0) from acc1u0 where a1u02='" & padoacc0k0.Fields("a0k01") & "'"
      intR = 1
      Set adoquery = ClsLawReadRstMsg(intR, StrSQLa)
      If intR = 1 Then
         If adoquery.Fields(0) >= Val("" & padoacc0k0.Fields("a0k06")) + Val("" & padoacc0k0.Fields("a0k07")) Then
            adoquery.Close
            GoTo EXITSUB
         End If
      End If
      adoquery.Close
   End If
   'end 2012/6/20
   
   'Add By Sindy 2020/4/30
   '智慧所收據本所案號是TT-999999時(一定存在於法律所案源檔)，不印業務區只印智權人員編號；
   '帳款類別之案件性質後加印'－法律所案號申請人名稱前6個中文'
   '@以收文號抓法律所案源檔之收據總收文號LOS10欄，再以法律所總收文號LOS06抓進度檔之本所案號再去抓法務或顧問案件之申請人1的申請人名稱前6個中文。
   StrSQLa = "SELECT a0j02,cp01,cp02,cp03,cp04,cp12,cp13,LOS02,LC11,NVL(CU04,DECODE(CU05,NULL,CU06,CU05||' '||CU88||' '||CU89||' '||CU90)) as CUname" & _
             " From LawOfficeSource, CaseProgress, acc0j0, lawcase, customer" & _
             " WHERE a0j13='" & .Fields("a0k01").Value & "' AND LOS10(+)=a0j01" & _
             " AND LOS06=cp09(+)" & _
             " AND cp01=LC01(+) AND cp02=LC02(+) AND cp03=LC03(+) AND cp04=LC04(+) AND LC01 is not null" & _
             " AND substr(LC11,1,8)=cu01(+) AND substr(LC11,9,1)=cu02(+)" & _
             " union all " & _
             "SELECT a0j02,cp01,cp02,cp03,cp04,cp12,cp13,LOS02,hc05,NVL(CU04,DECODE(CU05,NULL,CU06,CU05||' '||CU88||' '||CU89||' '||CU90)) as CUname" & _
             " From LawOfficeSource, CaseProgress, acc0j0, hirecase, customer" & _
             " WHERE a0j13='" & .Fields("a0k01").Value & "' AND LOS10(+)=a0j01" & _
             " AND LOS06=cp09(+)" & _
             " AND cp01=hc01(+) AND cp02=hc02(+) AND cp03=hc03(+) AND cp04=hc04(+) AND hc01 is not null" & _
             " AND substr(hc05,1,8)=cu01(+) AND substr(hc05,9,1)=cu02(+)"
   intR = 1
   Set RsTemp = ClsLawReadRstMsg(intR, StrSQLa)
   If RsTemp.RecordCount > 0 Then
      If Left(RsTemp.Fields("a0j02"), 8) = "TT999999" Then
         m_bolIsTT9 = True
         strLOSCName = "" & RsTemp.Fields("CUname").Value
      End If
   End If
   
   m_CU173 = ""
   m_CU11 = "" 'Add By Sindy 2022/9/8
   Call GetTitleCustData(padoacc0k0.Fields("a0k04"), padoacc0k0.Fields("a0k03"), "", , , , , , , , , , , , , , , , , , , , , , , , , m_CU11, , , m_CU173)
   
'******************************************************************************************************************
   '帳款類別變更
   If IsNull(.Fields("a0k33")) = False Then
   
      '收文日(最小)
      StrSQLa = "select * " & _
         " from acc0j0,caseprogress,nation where a0j13='" & .Fields("a0k01").Value & "' and cp09(+)=a0j01 and na01(+)=a0j04 and (cp79 <> 0 or (cp79 = 0 and cp75 <> 0)) " & _
         " order by a0j25 asc"
      intR = 1
      Set adocaseprogress = ClsLawReadRstMsg(intR, StrSQLa)
      If intR = 1 Then
         
         m_intRecPos = 1 'm_intRecPos + 1
         m_strItemDesc(m_intRecPos) = "" & adocaseprogress.Fields("a0j22") '帳款類別
         m_lngAmount1 = 0
         m_lngAmount2 = 0
         strCaseNo = ""
         strCaseNoList = vbTab
         intList = 0
         
         '服務費規費合併
         Do While Not adocaseprogress.EOF
            
            '列印本所案號,申請國家,案件名稱,客戶案件案號
            If strCaseNo <> adocaseprogress.Fields("a0j02") And intList < 2 Then
               strCaseNo = adocaseprogress.Fields("a0j02") '本所案號
               
               If IsNull(adocaseprogress.Fields("a0j20")) Or IsNull(adocaseprogress.Fields("a0j21")) Or IsNull(adocaseprogress.Fields("a0j23")) Or IsNull(adocaseprogress.Fields("a0j24")) Then
                  If InStr(strCaseNoList, vbTab & strCaseNo & vbTab) = 0 Then
                     strCaseNoList = strCaseNoList & strCaseNo & vbTab
                     'Modified by Morgan 2017/11/16 案號、國家與商品類別都拆開設定 Ex.龍巧--瑞婷
                     '案號
                     If IsNull(adocaseprogress.Fields("a0j21")) Then
                        strTemp = strCaseNo
                        If Right(strCaseNo, 3) = "000" Then
                           strTemp = Left(strCaseNo, Len(strCaseNo) - 3)
                        'Add By Sindy 2024/9/20 客戶反應同定稿要有-
                           strTemp = Left(strTemp, Len(strTemp) - 6) & "-" & Right(strTemp, 6)
                        Else
                           strExc(9) = Left(strCaseNo, Len(strCaseNo) - 3)
                           strExc(10) = Right(strCaseNo, 3)
                           strTemp = Left(strExc(9), Len(strExc(9)) - 6) & "-" & Right(strExc(9), 6) & _
                                     "-" & Left(strExc(10), 1) & "-" & Right(strExc(10), 2)
                        '2024/9/20 END
                        End If
                        'Modify By Sindy 2020/7/16
                        If pbolA4Print = True Then
                           m_strNote1 = m_strNote1 & "  本所案號：" & strTemp
'                        Else
'                        '2020/7/16 END
'                           Printer.Print strTemp
                        End If
                     End If
                     
                     '國家
                     If IsNull(adocaseprogress.Fields("a0j23")) Then
                        'Modified by Morgan 2011/12/26 取消 a0j21
                        If IsNull(adocaseprogress.Fields("na03").Value) = False Then
                           strTemp = adocaseprogress.Fields("na03").Value
                           'Modify By Sindy 2020/7/16
                           If pbolA4Print = True Then
                              m_strNote1 = m_strNote1 & "  申請國家：" & strTemp
'                           Else
'                           '2020/7/16 END
'                              Printer.Print strTemp
                           End If
                        End If
                     End If
                     'end 2017/11/16
                     
                     '商品類別
                     strProduct = ""
                     If IsNull(adocaseprogress.Fields("a0j20")) Then
                        '加查名案
                        If adocaseprogress.Fields("cp01").Value = "S" Or adocaseprogress.Fields("cp01").Value = "TS" Then
                           StrSQLa = "select SP18 as tm09 from SERVICEPRACTICE where SP01 = '" & adocaseprogress.Fields("cp01").Value & "' and SP02 = '" & adocaseprogress.Fields("cp02").Value & "' and SP03 = '" & adocaseprogress.Fields("cp03").Value & "' and SP04 = '" & adocaseprogress.Fields("cp04").Value & "'"
                        Else
                           StrSQLa = "select tm09 from trademark where tm01 = '" & adocaseprogress.Fields("cp01").Value & "' and tm02 = '" & adocaseprogress.Fields("cp02").Value & "' and tm03 = '" & adocaseprogress.Fields("cp03").Value & "' and tm04 = '" & adocaseprogress.Fields("cp04").Value & "'"
                        End If
                        intR = 1
                        Set adoquery = ClsLawReadRstMsg(intR, StrSQLa)
                        If intR = 1 Then
                           If IsNull(adoquery.Fields("tm09").Value) = False Then
                              '2010/8/24 modify by sonia 加 '類'
                              strProduct = "第" & adoquery.Fields("tm09").Value & " 類"
                           End If
                        End If
                        adoquery.Close
                     End If
                     
                     If IsNull(adocaseprogress.Fields("a0j24")) Then '要印案件名稱
                        '列印案件名稱(以總收文號查詢)及客戶案件名稱(Optional)
                        strTemp = CaseNameQuery(adocaseprogress.Fields("a0j01").Value, 1, m_strCustCaseNo)
                        If strTemp = "" Then
                           strTemp = CaseNameQuery(adocaseprogress.Fields("a0j01").Value, 2)
                        End If
                        'Modified by Morgan 2012/9/17 若案件名稱太長時縮小
                        strTemp = Trim(strTemp) & " " & strProduct
                        If pbolA4Print = True Then
                           m_strNote2 = m_strNote2 & "  案件名稱：" & strTemp
'                        Else
'                        '2020/7/16 END
'                           strTempA = ReOrgPrintTemp(strTemp, 22)
'                           If strTemp = strTempA Then
'                              Printer.Print strTemp
'                           Else
'                              Printer.Print ReOrgPrintTemp(strTemp, 26)
'                           End If
                        End If
                        'end 2012/9/17
                        
                        'Add By Sindy 2013/10/25 客戶X70017及其關係企業均加申請案號
                        'modify by sonia 2020/3/16 +長春相關企業X74310均加申請案號
                        'modify by sonia 2022/3/28 +溢泰實業相關企業X83843均加申請案號(P大陸案、CFP均仍維持請款單請款故國內收據全加不必判斷申請國家)
                        If Left(adocaseprogress.Fields("a0j11").Value, 6) = "X70017" Or Left(adocaseprogress.Fields("a0j11").Value, 6) = "X74310" Or Left(adocaseprogress.Fields("a0j11").Value, 6) = "X83843" Then
                           strTemp = ApplNoQuery(adocaseprogress.Fields("a0j01").Value)
                           'Modify By Sindy 2020/7/16
                           If pbolA4Print = True Then
                              m_strNote1 = m_strNote1 & "  申請案號：" & strTemp
'                           Else
'                           '2020/7/16 END
'                              Printer.Print "申請案號："
'                              Printer.Print strTemp
                           End If
                        End If
                        '2013/10/25 END
                        
                        'Add by Morgan 2004/8/12
                        If pintPrintCustCaseNo = 1 And m_strCustCaseNo <> "" Then
                           'Call PUB_PrintReceiptCustCaseNo(pintPrintCustCaseNo, m_strCustCaseNo, pbolA4Print)
                           pintPrintCustCaseNo = 0 'Added by Morgan 2011/12/1 只能印一案
'                        Else
'                           m_strCustCaseNo = ""
                        End If
                     End If
                     
                     'Add By Sindy 2020/7/16
                     '備註1
                     If m_strNote1 <> "" Then
                        m_strNote1 = Trim(m_strNote1)
                     End If
                     '備註2
                     If m_strNote2 <> "" Then
                        m_strNote2 = Trim(m_strNote2)
                     End If
                     '2020/7/16 END
                     
'                     m_strNote1 = "": m_strNote2 = "" 'Add By Sindy 2020/7/16
                     intList = intList + 1
                  End If
               End If
            End If
            
            If m_strItemDesc(m_intRecPos) <> adocaseprogress.Fields("a0j22") Then '帳款類別
               
               'Modify By Sindy 2022/7/7 若金額全部銷掉了,不需列印該筆明細
               If lngItemAmount1 = 0 And lngItemAmount2 = 0 Then
                  '先清資料,後減列數
                  m_strItemDesc(m_intRecPos) = ""
                  m_intRecPos = m_intRecPos - 1
               Else
               '2022/7/7 END
'                  '帳款類別
'                  For ii = 0 To 3
'                     strTemp = PUB_StrToStr(strItemDesc, 30)
'                     If strTemp = "" Then
'                        Exit For
'                     Else
'                        Printer.Print strTemp '*****
'                        strItemDesc = Mid(strItemDesc, Len(strTemp) + 1)
'                     End If
'                  Next
'
                  m_lngAmount1 = m_lngAmount1 + lngItemAmount1
                  m_lngAmount2 = m_lngAmount2 + lngItemAmount2

                  If lngItemAmount1 > 0 Then
                     m_strAmount1(m_intRecPos) = Format(lngItemAmount1, DDollar)
                  Else
                     m_strAmount1(m_intRecPos) = 0
                  End If
                  If lngItemAmount2 > 0 Then
                     m_strAmount2(m_intRecPos) = Format(lngItemAmount2, DDollar)
                  Else
                     m_strAmount2(m_intRecPos) = 0
                  End If
               End If

               lngItemAmount1 = 0
               lngItemAmount2 = 0
               
               m_intRecPos = m_intRecPos + 1
               m_strItemDesc(m_intRecPos) = adocaseprogress.Fields("a0j22") '帳款類別
            End If
         
            douService = 0
            douFee = 0
            '有銷帳
            If IsNull(.Fields("a0k10")) = False Then
               StrSQLa = "select sum(a1u07), sum(a1u09) from acc1u0 where a1u02 = '" & .Fields("a0k01").Value & "' and a1u03='" & adocaseprogress.Fields("a0j01") & "'"
               intR = 1
               Set adoquery = ClsLawReadRstMsg(intR, StrSQLa)
               If intR = 1 Then
                  If IsNull(adoquery.Fields(0).Value) = False Then
                     douService = Val(adoquery.Fields(0).Value)
                  End If
                  If IsNull(adoquery.Fields(1).Value) = False Then
                     douFee = Val(adoquery.Fields(1).Value)
                  End If
               End If
               adoquery.Close
            End If
            
            If IsNull(adocaseprogress.Fields("a0j07").Value) = False Then 'Y.合併
               lngItemAmount1 = lngItemAmount1 + Val("" & adocaseprogress.Fields("a0j09")) + Val("" & adocaseprogress.Fields("a0j10")) - douService - douFee
            Else
               If Val("" & adocaseprogress.Fields("a0j09")) - douService > 0 Then
                  lngItemAmount1 = lngItemAmount1 + Val("" & adocaseprogress.Fields("a0j09")) - douService
                  lngItemAmount2 = lngItemAmount2 + Val("" & adocaseprogress.Fields("a0j10")) - douFee
               Else
                  lngItemAmount2 = lngItemAmount2 + Val("" & adocaseprogress.Fields("a0j10")) - douFee + Val("" & adocaseprogress.Fields("a0j09")) - douService
               End If
            End If
                        
            adocaseprogress.MoveNext
         Loop
         adocaseprogress.Close
         
         'Modify By Sindy 2022/7/7 若金額全部銷掉了,不需列印該筆明細
         If lngItemAmount1 = 0 And lngItemAmount2 = 0 Then
            '先清資料,後減列數
            m_strItemDesc(m_intRecPos) = ""
            m_intRecPos = m_intRecPos - 1
         Else
         '2022/7/7 END
            m_lngAmount1 = m_lngAmount1 + lngItemAmount1
            m_lngAmount2 = m_lngAmount2 + lngItemAmount2
'            '帳款類別
'            For ii = 0 To 3
'               strTemp = PUB_StrToStr(strItemDesc, 30)
'               If strTemp = "" Then
'                  Exit For
'               Else
'                  Printer.Print strTemp '*****
'                  strItemDesc = Mid(strItemDesc, Len(strTemp) + 1)
'               End If
'            Next

            If lngItemAmount1 > 0 Then
               m_strAmount1(m_intRecPos) = Format(lngItemAmount1, DDollar)
            Else
               m_strAmount1(m_intRecPos) = 0
            End If
            If lngItemAmount2 > 0 Then
               m_strAmount2(m_intRecPos) = Format(lngItemAmount2, DDollar)
            Else
               m_strAmount2(m_intRecPos) = 0
            End If
         End If
      End If
      
'******************************************************************************************************************
   Else
   
      blnCombPrint = False
      'CFP 美國 領證(601)及公開費(217)--目前已不會再收公開費,程式可不必考慮多案一收據問題 Morgan 2011/9/21
      StrSQLa = "select Count(*) from acc0j0,caseprogress where a0j13 = '" & .Fields("a0k01").Value & "' And A0j04='101' And cp09(+)=a0j01  and CP01='CFP'  And cp10 In ('601','217') and (cp79 <> 0 or (cp79 = 0 and cp75 <> 0)) "
      intR = 1
      Set RsTemp = ClsLawReadRstMsg(intR, StrSQLa)
      If intR = 1 Then
         If Val("" & RsTemp.Fields(0).Value) = 2 Then blnCombPrint = True
      End If
      
      '收據明細資料
      StrSQLa = "select a.*,b.*,getcp10desc(cp01,cp10,a0j04) cp10N,na03 from acc0j0 a,caseprogress b,nation where a0j13 = '" & .Fields("a0k01").Value & "' And cp09(+)=a0j01 and (cp79 <> 0 or (cp79 = 0 and cp75 <> 0)) and na01(+)=a0j04 ORDER BY CP09 "
      intR = 1
      Set adocaseprogress = ClsLawReadRstMsg(intR, StrSQLa)
      If intR = 1 Then
         m_intRecPos = 0
         Do While adocaseprogress.EOF = False
            m_intRecPos = m_intRecPos + 1
            
            douService = 0
            douFee = 0
            '有銷帳
            If adocaseprogress.Fields("cp77") > 0 Then
               '銷帳=費用時不印
               If adocaseprogress.Fields("cp77") = adocaseprogress.Fields("cp16") Then
                  GoTo NextRecord
               Else
                  '抓收款資料
                  'Modified by Morgan 2011/11/24
                  'StrSQLa = "select sum(a1u07), sum(a1u09) from acc1u0 where a1u03 = '" & adocaseprogress.Fields("cp09").Value & "'"
                  StrSQLa = "select sum(a1u07), sum(a1u09) from acc1u0 where a1u03 = '" & adocaseprogress.Fields("cp09").Value & "' and a1u02='" & .Fields("a0k01").Value & "'"
                  intR = 1
                  Set adoquery = ClsLawReadRstMsg(intR, StrSQLa)
                  If intR = 1 Then
                     If IsNull(adoquery.Fields(0).Value) = False Then
                        douService = Val(adoquery.Fields(0).Value)
                     End If
                     If IsNull(adoquery.Fields(1).Value) = False Then
                        douFee = Val(adoquery.Fields(1).Value)
                     End If
                  End If
                  adoquery.Close
               End If
            End If
            
            If blnCombPrint = False Or adocaseprogress.Fields("cp10") = "601" Then
               '案件性質
               'Modify by Morgan 2007/5/8 案件性質名稱直接抓0j0的以免資料不一致卻沒發現(程式有修剪)
               If m_intRecPos = 1 And pstrNewDesc1 <> "" Then
                  m_strItemDesc(m_intRecPos) = pstrNewDesc1
               
               ElseIf m_intRecPos = 2 And pstrNewDesc2 <> "" Then
                  m_strItemDesc(m_intRecPos) = pstrNewDesc2
               
               '不列印專利年費年度
               ElseIf pintNoPrintPatentYear > 0 Then
                  m_strItemDesc(m_intRecPos) = adocaseprogress.Fields("cp10N").Value
                  
               Else
                  'Add By Sindy 2009/07/14
                  '加印繳費年度說明
                  If ((adocaseprogress.Fields("cp01").Value = "P" And adocaseprogress.Fields("cp10").Value = "601") Or _
                        ((adocaseprogress.Fields("cp01").Value = "P" Or adocaseprogress.Fields("cp01").Value = "CFP") And _
                        (adocaseprogress.Fields("cp10").Value = "605" Or adocaseprogress.Fields("cp10").Value = "606" Or adocaseprogress.Fields("cp10").Value = "607"))) And _
                     adocaseprogress.Fields("cp53").Value <> "" And _
                     adocaseprogress.Fields("cp54").Value <> "" Then
                     strSql = "SELECT * FROM patent WHERE pa01='" & adocaseprogress.Fields("cp01").Value & "' and pa02='" & adocaseprogress.Fields("cp02").Value & "' and pa03='" & adocaseprogress.Fields("cp03").Value & "' and pa04='" & adocaseprogress.Fields("cp04").Value & "' "
                     intI = 1
                     Set RsTemp = ClsLawReadRstMsg(intI, strSql)
                     If intI = 1 Then
                        strPA08 = RsTemp("PA08")
                        strPA09 = RsTemp("PA09")
                        strPA10 = "" & RsTemp("PA10") 'Added by Morgan 2022/6/13
                     End If
                     strKey(0) = ""
                     strKey(1) = adocaseprogress.Fields("cp01").Value
                     strKey(2) = adocaseprogress.Fields("cp02").Value
                     strKey(3) = adocaseprogress.Fields("cp03").Value
                     strKey(4) = adocaseprogress.Fields("cp04").Value
                     '2010/2/12 modify by sonia 抓修法次數
                     'bFind = GetMoneyDate(strPA08, strPA09, strKey, strCaseFee(1), strCaseFee(2))
                     bFind = GetMoneyDate(strPA08, strPA09, strKey, strCaseFee(1), strCaseFee(2), , , m_FixNo)
                     If bFind Then
                        If IsEmptyText(strCaseFee(2)) = False Then
                           varRef = Split(strCaseFee(2), ",")
                           'Modified by Morgan 2022/6/13 +strPA10
                           strFeeType = PUB_GetNa20Na22Na24(strPA09, strPA08, strPA10)
                           If adocaseprogress.Fields("cp10").Value = "605" Or _
                              adocaseprogress.Fields("cp10").Value = "601" Then
                              strYF15 = PUB_GetYF15(strPA09, strPA08, "Y000000" & m_FixNo, strFeeType, CDbl(Val(adocaseprogress.Fields("cp53").Value)))
                           Else
                              strYF15 = PUB_GetYF15(strPA09, strPA08, "Y000000" & m_FixNo, strFeeType, Val(varRef(Val(adocaseprogress.Fields("cp53").Value) - 1)))
                           End If
                           If Val(adocaseprogress.Fields("cp53").Value) = Val(adocaseprogress.Fields("cp54").Value) Then
                              m_strItemDesc(m_intRecPos) = m_strItemDesc(m_intRecPos) & adocaseprogress.Fields("cp10N").Value & " " & strYF15
                           Else
                              If adocaseprogress.Fields("cp10").Value = "605" Or _
                                 adocaseprogress.Fields("cp10").Value = "601" Then
                                 m_strItemDesc(m_intRecPos) = m_strItemDesc(m_intRecPos) & adocaseprogress.Fields("cp10N").Value & " (" & strYF15 & "至" & PUB_GetYF15(strPA09, strPA08, "Y000000" & m_FixNo, strFeeType, CDbl(Val(adocaseprogress.Fields("cp54").Value))) & ")"
                              Else
                                 m_strItemDesc(m_intRecPos) = m_strItemDesc(m_intRecPos) & adocaseprogress.Fields("cp10N").Value & " (" & strYF15 & "至" & PUB_GetYF15(strPA09, strPA08, "Y000000" & m_FixNo, strFeeType, Val(varRef(Val(adocaseprogress.Fields("cp54").Value) - 1))) & ")"
                              End If
                           End If
                        End If
                     End If
                  '2009/07/14 End
                  Else
                     'Modify By Sindy 2020/4/30 帳款類別之案件性質後加印'－法律所案號申請人名稱前6個中文'
                     m_strItemDesc(m_intRecPos) = m_strItemDesc(m_intRecPos) & adocaseprogress.Fields("cp10N").Value & IIf(strLOSCName <> "", "-" & Mid(strLOSCName, 1, 6), "")
                  End If
               End If
            End If
         
            If Val("" & adocaseprogress.Fields("a0j09").Value) + Val("" & adocaseprogress.Fields("a0j10").Value) > 0 Then
               
               '有規費不合併
               If Val("" & adocaseprogress.Fields("a0j10").Value) > 0 And IsNull(adocaseprogress.Fields("a0j07").Value) Then
                  '服務費
                  If Val("" & adocaseprogress.Fields("a0j09").Value) - douService > 0 Then
                     m_strAmount1(m_intRecPos) = Format(Val("" & adocaseprogress.Fields("a0j09").Value) - douService, DDollar)
                  Else
                     m_strAmount1(m_intRecPos) = "0"
                  End If
                  
                  '服務費累計
                  m_lngAmount1 = m_lngAmount1 + Val(Format(m_strAmount1(m_intRecPos)))
                  
                  If blnCombPrint = False Then
'                     Printer.Print strAmount1(intRecPos) '*****
                  Else
                     m_strAmount1(m_intRecPos) = ""
                  End If
                  
                  '規費
                  If Val("" & adocaseprogress.Fields("a0j10").Value) - douFee > 0 Then
                     'Modified by Morgan 2011/11/28 若為負點數時規費印費用
                     If Val("" & adocaseprogress.Fields("a0j09").Value) - douService < 0 Then
                        m_strAmount2(m_intRecPos) = Format(Val("" & adocaseprogress.Fields("a0j10").Value) - douFee + Val("" & adocaseprogress.Fields("a0j09").Value) - douService, DDollar)
                     Else
                        m_strAmount2(m_intRecPos) = Format(Val("" & adocaseprogress.Fields("a0j10").Value) - douFee, DDollar)
                     End If
                  Else
                     m_strAmount2(m_intRecPos) = "0"
                  End If
                  
                  '規費累計
                  m_lngAmount2 = m_lngAmount2 + Val(Format(m_strAmount2(m_intRecPos)))
                  
                  If blnCombPrint = False Then
'                      Printer.Print strAmount2(intRecPos) '*****
                  Else
                     m_strAmount1(m_intRecPos) = ""
                  End If
                  
               '合併列印或無規費
               Else
                  m_strAmount1(m_intRecPos) = Format(Val("" & adocaseprogress.Fields("a0j09").Value) + Val("" & adocaseprogress.Fields("a0j10").Value) - douService - douFee, DDollar)
                  m_lngAmount1 = m_lngAmount1 + Val(Format(m_strAmount1(m_intRecPos)))
                  If blnCombPrint = False Then
                     '列印費用
                     If m_strAmount1(m_intRecPos) = "" Then
                        m_strAmount1(m_intRecPos) = 0 'Printer.Print "0" '*****
                     Else
'                        Printer.Print strAmount1(intRecPos) '*****
                     End If
                  End If
                  
                  m_strAmount2(m_intRecPos) = "0"
                  m_lngAmount2 = m_lngAmount2 + 0
                  If blnCombPrint = False Then
'                     Printer.Print strAmount2(intRecPos) '*****
                  Else
                     m_strAmount2(m_intRecPos) = ""
                  End If
               End If
            End If
            'Modify By Sindy 2022/7/7 若金額全部銷掉了,不需列印該筆明細
            If Val(m_strAmount1(m_intRecPos)) = 0 And Val(m_strAmount2(m_intRecPos)) = 0 Then
               '先清資料,後減列數
               m_strItemDesc(m_intRecPos) = ""
               m_intRecPos = m_intRecPos - 1
               GoTo NextRecord '讀下一筆明細資料
            End If
            '2022/7/7 END
            
            '美國領證+公開
            If blnCombPrint = True And m_intRecPos = 2 Then
               '列印費用
               If m_lngAmount1 = 0 Then
                  m_strAmount1(m_intRecPos) = "0"
               Else
                  m_strAmount1(m_intRecPos) = Format(m_lngAmount1, DDollar)
               End If
'               Printer.Print strAmount1(intRecPos) '*****
               '列印規費
               If m_lngAmount2 = 0 Then
                  m_strAmount2(m_intRecPos) = "0"
               Else
                  m_strAmount2(m_intRecPos) = Format(m_lngAmount2, DDollar)
               End If
'               Printer.Print strAmount2(intRecPos) '*****
            End If
            
            'Modify by Morgan 2011/9/20 只要印一次,若設定金額合併則不印
            If m_intRecPos = 1 And IsNull(.Fields("a0k33")) Then
               '列印本所案號
               If (adocaseprogress.Fields("cp03").Value & adocaseprogress.Fields("cp04").Value) = "000" Then
                  'Modify By Sindy 2024/9/20 客戶反應同定稿要有-
                  'strTemp = adocaseprogress.Fields("cp01").Value & adocaseprogress.Fields("cp02").Value
                  strTemp = adocaseprogress.Fields("cp01").Value & "-" & adocaseprogress.Fields("cp02").Value
               Else
                  'Modify By Sindy 2024/9/20 客戶反應同定稿要有-
                  'strTemp = adocaseprogress.Fields("cp01").Value & adocaseprogress.Fields("cp02").Value & adocaseprogress.Fields("cp03").Value & adocaseprogress.Fields("cp04").Value
                  strTemp = adocaseprogress.Fields("cp01").Value & "-" & adocaseprogress.Fields("cp02").Value & "-" & adocaseprogress.Fields("cp03").Value & "-" & adocaseprogress.Fields("cp04").Value
               End If
               'Modify By Sindy 2020/7/16
               If pbolA4Print = True Then
                  m_strNote1 = m_strNote1 & "  本所案號：" & strTemp
'               Else
'               '2020/7/16 END
'                  Printer.Print strTemp
               End If
               
               '列印申請國家名稱
               'Modified by Morgan 2011/12/26 取消 a0j21
               If IsNull(adocaseprogress.Fields("na03").Value) = False Then
                  strTemp = adocaseprogress.Fields("na03").Value
                  'Modify By Sindy 2020/7/16
                  If pbolA4Print = True Then
                     m_strNote1 = m_strNote1 & "  申請國家：" & strTemp
'                  Else
'                  '2020/7/16 END
'                     Printer.Print strTemp
                  End If
               End If
               
               'Add By Sindy 2013/10/25 客戶X70017及其關係企業均加申請案號
               'modify by sonia 2020/3/16 +長春相關企業X74310均加申請案號
               'modify by sonia 2022/3/28 +溢泰實業相關企業X83843均加申請案號(P大陸案、CFP均仍維持請款單請款故國內收據全加不必判斷申請國家)
               If Left(adocaseprogress.Fields("a0j11").Value, 6) = "X70017" Or Left(adocaseprogress.Fields("a0j11").Value, 6) = "X74310" Or Left(adocaseprogress.Fields("a0j11").Value, 6) = "X83843" Then
                  strTemp = ApplNoQuery(adocaseprogress.Fields("a0j01").Value)
                  'Modify By Sindy 2020/7/16
                  If pbolA4Print = True Then
                     m_strNote1 = m_strNote1 & "  申請案號：" & strTemp
'                  Else
'                  '2020/7/16 END
'                     Printer.Print "申請案號："
'                     Printer.Print strTemp
                  End If
               End If
               '2013/10/25 END
               
               '查名案加印商品類別
               strProduct = ""
               If adocaseprogress.Fields("cp01").Value = "S" Or adocaseprogress.Fields("cp01").Value = "TS" Then
                  StrSQLa = "select SP18 as tm09 from SERVICEPRACTICE where SP01 = '" & adocaseprogress.Fields("cp01").Value & "' and SP02 = '" & adocaseprogress.Fields("cp02").Value & "' and SP03 = '" & adocaseprogress.Fields("cp03").Value & "' and SP04 = '" & adocaseprogress.Fields("cp04").Value & "'"
               Else
                  StrSQLa = "select tm09 from trademark where tm01 = '" & adocaseprogress.Fields("cp01").Value & "' and tm02 = '" & adocaseprogress.Fields("cp02").Value & "' and tm03 = '" & adocaseprogress.Fields("cp03").Value & "' and tm04 = '" & adocaseprogress.Fields("cp04").Value & "'"
               End If
               intR = 1
               Set adoquery = ClsLawReadRstMsg(intR, StrSQLa)
               If intR = 1 Then
                  If IsNull(adoquery.Fields("tm09").Value) = False Then
                     '2010/8/24 modify by sonia 加 '類'
                     strProduct = "第" & adoquery.Fields("tm09").Value & " 類"
                  End If
               End If
               adoquery.Close
               
               '列印案件名稱(以總收文號查詢)及客戶案件名稱(Optional)
               strTemp = CaseNameQuery(adocaseprogress.Fields("cp09").Value, 1, m_strCustCaseNo)
               If strTemp = "" Then
                  strTemp = CaseNameQuery(adocaseprogress.Fields("cp09").Value, 2)
               End If
               'Modified by Morgan 2012/9/17 若案件名稱太長時縮小
               strTemp = Trim(strTemp) & " " & strProduct
               'Modify By Sindy 2020/7/16
               If pbolA4Print = True Then
                  m_strNote2 = m_strNote2 & "  案件名稱：" & strTemp
'               Else
'               '2020/7/16 END
'                  strTempA = ReOrgPrintTemp(strTemp, 22)
'                  If strTemp = strTempA Then
'                     Printer.Print strTemp
'                  Else
'                     Printer.Print ReOrgPrintTemp(strTemp, 26)
'                  End If
'                  'end 2012/9/17
               End If
               
               'Add By Sindy 2020/7/16
               '備註1
               If m_strNote1 <> "" Then
                  m_strNote1 = Trim(m_strNote1)
               End If
               '備註2
               If m_strNote2 <> "" Then
                  m_strNote2 = Trim(m_strNote2)
               End If
               '2020/7/16 END
               
               'Add by Morgan 2004/8/12
               If pintPrintCustCaseNo = 1 And m_strCustCaseNo <> "" Then
                  'Call PUB_PrintReceiptCustCaseNo(pintPrintCustCaseNo, m_strCustCaseNo, pbolA4Print)
                  pintPrintCustCaseNo = 0 'Added by Morgan 2011/12/1 只能印一案
'               Else
'                  m_strCustCaseNo = ""
               End If
               
'               m_strNote1 = "": m_strNote2 = "" 'Add By Sindy 2020/7/16
'               intList = intList + 1
            End If
            
            'Add by Morgan 2005/9/15 顧問案的顧問聘任(0)時要印顧問期間
            'Modify By Sindy 2022/5/20 請加入ACS之智財顧問(112)也要印出期間。例：ACS-000106(E11109383)。
            If (adocaseprogress("CP01") = "LA" And adocaseprogress("CP10") = "0") Or _
               (adocaseprogress("CP01") = "ACS" And adocaseprogress("CP10") = "112") Then
               m_strItemDesc(m_intRecPos) = m_strItemDesc(m_intRecPos) & vbCrLf & "顧問期間："
               m_strItemDesc(m_intRecPos) = m_strItemDesc(m_intRecPos) & Format(TransDate("" & adocaseprogress("CP53"), 1), "###/##/##") & " - " & Format(TransDate("" & adocaseprogress("CP54"), 1), "###/##/##")
            End If
NextRecord:
            adocaseprogress.MoveNext
         Loop
         adocaseprogress.Close
      End If
      
   End If
   
   If pbolUpdateTimes = True Then
      adoTaie.Execute "update acc0k0 set a0k19 = " & m_intTimes & " where a0k01 = '" & .Fields("a0k01").Value & "'"
      If pstrPritDate <> "" Then
         'Modify By Sindy 2020/4/20 109/4月開始已無1公司,所以不可以再修改1公司的收據日期
         adoTaie.Execute "update acc0k0 set a0k02=" & pstrPritDate & _
                         " where a0k01 = '" & .Fields("a0k01").Value & "' and a0k11<>'1'"
   '   Else
   '      adoTaie.Execute "update acc0k0 set a0k19 = " & intTimes & " where a0k01 = '" & .Fields("a0k01").Value & "'"
      End If
   End If
   
   End With
   PUB_PrintCaseReceipt_2 = True
   
EXITSUB:

   Set adocaseprogress = Nothing
   Set adoquery = Nothing
End Function

''Add by Morgan 2011/9/19
''列印收據(整合 Frmacc1410 & Frmacc1420)
''pintPrintUniNo:列印統一編號,pintPrintCustCaseNo:列印客戶案件案號,pintNoPrintPatentYear:不列印專利年費年度
''pstrRePrint:是否補開(Y/N),pstrNewDesc1:案件性質名稱1,pstrNewDesc2:案件性質名稱2,pstrPritDate:列印日期
''Modified by Morgan 2013/5/1 +pbolUpdateTimes
''Move by Lydia 2020/03/26 從aacc_fun搬來
''Modify By Sindy 2020/7/15 , Optional pbolA4Print As Boolean = False 改用A4列印
''*****
''Modify By Sindy 2020/11/2 和 frm210141 (GetReceiptData) 同取值條件, 有修改時2邊注意是否都要一併調整
''*****
'Public Sub PUB_PrintCaseReceipt(padoacc0k0 As ADODB.Recordset, pintPrintUniNo As Integer, _
'   pintPrintCustCaseNo As Integer, Optional pintNoPrintPatentYear As Integer, _
'   Optional pstrRePrint As String, Optional pstrNewDesc1 As String, Optional pstrNewDesc2 As String, _
'   Optional pstrPritDate As String, Optional pbolUpdateTimes As Boolean = True, _
'   Optional pbolA4Print As Boolean = False)
'
'   Dim intTimes As Integer
'   Dim strTemp As String
'   Dim intCounter As Integer
'   Dim StrSQLa As String, intR As Integer
'   Dim adocaseprogress As ADODB.Recordset
'   Dim adoquery As ADODB.Recordset
'   Dim douService As Double '已銷服務費
'   Dim douFee As Double '已銷規費
'   Dim intLength As Integer
'   Dim lngAmount1 As Long '服務費
'   Dim lngAmount2 As Long '規費
'   Dim strAmount1 As String
'   Dim strAmount2 As String
'   Dim intList As Integer
'   Dim blnCombPrint As Boolean '收據項目合併列印
'   Dim intRecPos As Integer '目前指向第幾筆資料
'   'Add By Sindy 2009/07/14
'   Dim strPA08 As String, strPA09 As String
'   Dim strFeeType As String, strYF15 As String
'   Dim strKey(5) As String
'   Dim strCaseFee(1 To 2) As String
'   Dim bFind As Boolean
'   Dim varRef As Variant
'   '2009/07/14 End
'   Dim strProduct As String '商品類別
'   Dim strCustCaseNo As String '客戶案件案號
'   Dim m_FixNo As Integer   '2010/2/12 add by sonia 修法次數
'   Dim strDesc As String, ii As Integer
'   Dim strItemDesc As String '帳款類別
'   Dim lngItemAmount1 As Long '單項服務費
'   Dim lngItemAmount2 As Long '單項規費
'   Dim strCaseNo As String, strCaseNoList As String
''   Dim strCDate As String '接洽日期
'   Dim strTempA As String
'   Dim m_CU173 As String
'   Dim iCaseStarY As Integer 'Add By Sindy 2020/4/1
'   Dim bolIsTT9 As Boolean
'   Dim strLOSCName As String
'   'Add By Sindy 2020/7/16
'   Dim XLeftCol1 As Integer, XLeftCol2 As Integer, XLeftCol3 As Integer '列印明細欄位的X座標
'   Dim YLeft As Integer '列印明細欄位的Y座標
'   Dim strNote1 As String, strNote2 As String
'   '2020/7/16 END
'
'   With padoacc0k0
'
'   '列印次數
'   If IsNull(.Fields("a0k19").Value) Then
'      intTimes = 1
'   'Added by Morgan 2013/5/1
'   ElseIf pbolUpdateTimes = False Then
'      intTimes = Val(.Fields("a0k19").Value)
'   'end 2013/5/1
'   Else
'      intTimes = Val(.Fields("a0k19").Value) + 1
'   End If
'
'   'Added by Morgan 2012/6/20
'   '檢查是否已全銷
'   If Not IsNull(padoacc0k0.Fields("a0k10")) Then
'      StrSQLa = "select nvl(sum(a1u07),0)+nvl(sum(a1u09),0) from acc1u0 where a1u02='" & padoacc0k0.Fields("a0k01") & "'"
'      intR = 1
'      Set adoquery = ClsLawReadRstMsg(intR, StrSQLa)
'      If intR = 1 Then
'         If adoquery.Fields(0) >= Val("" & padoacc0k0.Fields("a0k06")) + Val("" & padoacc0k0.Fields("a0k07")) Then
'            adoquery.Close
'            GoTo EXITSUB
'         End If
'      End If
'      adoquery.Close
'   End If
'   'end 2012/6/20
'
'   'Add By Sindy 2020/4/30
'   '智慧所收據本所案號是TT-999999時(一定存在於法律所案源檔)，不印業務區只印智權人員編號；
'   '帳款類別之案件性質後加印'－法律所案號申請人名稱前6個中文'
'   '@以收文號抓法律所案源檔之收據總收文號LOS10欄，再以法律所總收文號LOS06抓進度檔之本所案號再去抓法務或顧問案件之申請人1的申請人名稱前6個中文。
'   StrSQLa = "SELECT a0j02,cp01,cp02,cp03,cp04,cp12,cp13,LOS02,LC11,NVL(CU04,DECODE(CU05,NULL,CU06,CU05||' '||CU88||' '||CU89||' '||CU90)) as CUname" & _
'             " From LawOfficeSource, CaseProgress, acc0j0, lawcase, customer" & _
'             " WHERE a0j13='" & .Fields("a0k01").Value & "' AND LOS10(+)=a0j01" & _
'             " AND LOS06=cp09(+)" & _
'             " AND cp01=LC01(+) AND cp02=LC02(+) AND cp03=LC03(+) AND cp04=LC04(+) AND LC01 is not null" & _
'             " AND substr(LC11,1,8)=cu01(+) AND substr(LC11,9,1)=cu02(+)" & _
'             " union all " & _
'             "SELECT a0j02,cp01,cp02,cp03,cp04,cp12,cp13,LOS02,hc05,NVL(CU04,DECODE(CU05,NULL,CU06,CU05||' '||CU88||' '||CU89||' '||CU90)) as CUname" & _
'             " From LawOfficeSource, CaseProgress, acc0j0, hirecase, customer" & _
'             " WHERE a0j13='" & .Fields("a0k01").Value & "' AND LOS10(+)=a0j01" & _
'             " AND LOS06=cp09(+)" & _
'             " AND cp01=hc01(+) AND cp02=hc02(+) AND cp03=hc03(+) AND cp04=hc04(+) AND hc01 is not null" & _
'             " AND substr(hc05,1,8)=cu01(+) AND substr(hc05,9,1)=cu02(+)"
'   intR = 1
'   Set RsTemp = ClsLawReadRstMsg(intR, StrSQLa)
'   If RsTemp.RecordCount > 0 Then
'      If Left(RsTemp.Fields("a0j02"), 8) = "TT999999" Then
'         bolIsTT9 = True
'         strLOSCName = "" & RsTemp.Fields("CUname").Value
'      End If
'   End If
'   '2020/4/30 END
'
'   'Modify By Sindy 2017/3/17
'   'Modify By Sindy 2017/3/24
'   m_CU173 = ""
'   'Modify By Sindy 2019/5/22 + padoacc0k0.Fields("a0k03")
'   Call GetTitleCustData(padoacc0k0.Fields("a0k04"), padoacc0k0.Fields("a0k03"), "", , , , , , , , , , , , , , , , , , , , , , , , , , , , m_CU173)
'   'PUB_PrintReceiptHead padoacc0k0, intTimes, pintPrintUniNo, pstrRePrint, pstrPritDate
'   'PUB_PrintReceiptHead padoacc0k0, intTimes, IIf("" & padoacc0k0.Fields("a0k40") = "", 0, 1), pstrRePrint, pstrPritDate
'   'Modify By Sindy 2020/7/15 + pbolA4Print
'   PUB_PrintReceiptHead padoacc0k0, IIf(m_CU173 = "Y", 1, 0), pstrRePrint, pstrPritDate, bolIsTT9, pbolA4Print
'   '2017/3/24 END
'
'   'Add By Sindy 2020/4/1 列印案件資料的Y座標起始位置
'   'Modify By Sindy 2020/7/16
'   If pbolA4Print = True Then
'      iCaseStarY = Py(10) + 50
'   Else
'   '2020/7/16 END
'      If .Fields("a0k11").Value = "1" Then '舊專利商標
'         iCaseStarY = 7200
'      Else
'         iCaseStarY = 7300
'      End If
'      '2020/4/1 END
'   End If
'
'   'Add By Sindy 2020/7/16
'   If pbolA4Print = True Then
'      XLeftCol1 = Px(0) + 50
'      XLeftCol2 = Px(2) + 1500
'      XLeftCol3 = Px(3) + 1500
'      YLeft = Py(1) + 100 '列印明細欄位的Y座標
'   Else
'   '2020/7/16 END
'      XLeftCol1 = 350 '帳款類別
'      XLeftCol2 = 5900 '服務費
'      XLeftCol3 = 7600 '規費
'      YLeft = 3600
'   End If
'
'   '帳款類別變更
'   If IsNull(.Fields("a0k33")) = False Then
'
'      '收文日(最小)
'      StrSQLa = "select * " & _
'         " from acc0j0,caseprogress,nation where a0j13='" & .Fields("a0k01").Value & "' and cp09(+)=a0j01 and na01(+)=a0j04 and (cp79 <> 0 or (cp79 = 0 and cp75 <> 0)) " & _
'         " order by a0j25 asc"
'      intR = 1
'      Set adocaseprogress = ClsLawReadRstMsg(intR, StrSQLa)
'      If intR = 1 Then
'
''         strCDate = CFDate(ACDate(adocaseprogress.Fields("cp05")))
'         strItemDesc = "" & adocaseprogress.Fields("a0j22")
'         lngAmount1 = 0
'         lngAmount2 = 0
'         strCaseNoList = vbTab
'         intList = 0
'         '服務費規費合併
'         Do While Not adocaseprogress.EOF
'
'            '列印本所案號,申請國家,案件名稱,客戶案件案號
'            If strCaseNo <> adocaseprogress.Fields("a0j02") And intList < 2 Then
'               strCaseNo = adocaseprogress.Fields("a0j02")
'               If IsNull(adocaseprogress.Fields("a0j20")) Or IsNull(adocaseprogress.Fields("a0j21")) Or IsNull(adocaseprogress.Fields("a0j23")) Or IsNull(adocaseprogress.Fields("a0j24")) Then
'                  If InStr(strCaseNoList, vbTab & strCaseNo & vbTab) = 0 Then
'                     strCaseNoList = strCaseNoList & strCaseNo & vbTab
'                     'Modified by Morgan 2017/11/16 案號、國家與商品類別都拆開設定 Ex.龍巧--瑞婷
'                     '案號
'                     If IsNull(adocaseprogress.Fields("a0j21")) Then
'                        strTemp = strCaseNo
'                        If Right(strCaseNo, 3) = "000" Then
'                           strTemp = Left(strCaseNo, Len(strCaseNo) - 3)
'                        End If
'                        'Modify By Sindy 2020/7/16
'                        If pbolA4Print = True Then
'                           strNote1 = strNote1 & "  本所案號：" & strTemp
'                        Else
'                        '2020/7/16 END
'                           Printer.CurrentX = 1500
'                           Printer.CurrentY = iCaseStarY + intList * 550
'                           Printer.Print strTemp
'                        End If
'                     End If
'                     '國家
'                     If IsNull(adocaseprogress.Fields("a0j23")) Then
'                        'Modified by Morgan 2011/12/26 取消 a0j21
'                        If IsNull(adocaseprogress.Fields("na03").Value) = False Then
'                           strTemp = adocaseprogress.Fields("na03").Value
'                           'Modify By Sindy 2020/7/16
'                           If pbolA4Print = True Then
'                              strNote1 = strNote1 & "  申請國家：" & strTemp
'                           Else
'                           '2020/7/16 END
'                              Printer.CurrentX = 3000
'                              Printer.CurrentY = iCaseStarY + intList * 550
'                              Printer.Print strTemp
'                           End If
'                        End If
'                     End If
'                     'end 2017/11/16
'
'                     '商品類別
'                     strProduct = ""
'                     If IsNull(adocaseprogress.Fields("a0j20")) Then
'                        '加查名案
'                        If adocaseprogress.Fields("cp01").Value = "S" Or adocaseprogress.Fields("cp01").Value = "TS" Then
'                           StrSQLa = "select SP18 as tm09 from SERVICEPRACTICE where SP01 = '" & adocaseprogress.Fields("cp01").Value & "' and SP02 = '" & adocaseprogress.Fields("cp02").Value & "' and SP03 = '" & adocaseprogress.Fields("cp03").Value & "' and SP04 = '" & adocaseprogress.Fields("cp04").Value & "'"
'                        Else
'                           StrSQLa = "select tm09 from trademark where tm01 = '" & adocaseprogress.Fields("cp01").Value & "' and tm02 = '" & adocaseprogress.Fields("cp02").Value & "' and tm03 = '" & adocaseprogress.Fields("cp03").Value & "' and tm04 = '" & adocaseprogress.Fields("cp04").Value & "'"
'                        End If
'                        intR = 1
'                        Set adoquery = ClsLawReadRstMsg(intR, StrSQLa)
'                        If intR = 1 Then
'                           If IsNull(adoquery.Fields("tm09").Value) = False Then
'                              '2010/8/24 modify by sonia 加 '類'
'                              strProduct = "第" & adoquery.Fields("tm09").Value & " 類"
'                           End If
'                        End If
'                        adoquery.Close
'                     End If
'
'                     If IsNull(adocaseprogress.Fields("a0j24")) Then
'                        '列印案件名稱(以總收文號查詢)及客戶案件名稱(Optional)
'                        strTemp = CaseNameQuery(adocaseprogress.Fields("a0j01").Value, 1, strCustCaseNo)
'                        If strTemp = "" Then
'                           strTemp = CaseNameQuery(adocaseprogress.Fields("a0j01").Value, 2)
'                        End If
'                        'Modified by Morgan 2012/9/17 若案件名稱太長時縮小
'                        'Printer.Print ReOrgPrintTemp(Trim(strTemp) & " " & strProduct, 22)
'                        strTemp = Trim(strTemp) & " " & strProduct
'                        'Modify By Sindy 2020/7/16
'                        If pbolA4Print = True Then
'                           strNote2 = strNote2 & "  案件名稱：" & strTemp
'                        Else
'                        '2020/7/16 END
'                           strTempA = ReOrgPrintTemp(strTemp, 22)
'                           Printer.CurrentX = 5500
'                           Printer.CurrentY = iCaseStarY + intList * 550
'                           If strTemp = strTempA Then
'                              Printer.Print strTemp
'                           Else
'                              Printer.FontSize = 10
'                              Printer.Print ReOrgPrintTemp(strTemp, 26)
'                              Printer.FontSize = 12
'                           End If
'                        End If
'                        'end 2012/9/17
'
'                        'Add By Sindy 2013/10/25 客戶X70017及其關係企業均加申請案號
'                        'modify by sonia 2020/3/16 +長春相關企業X74310均加申請案號
'                        'modify by sonia 2022/3/28 +溢泰實業相關企業X83843均加申請案號(P大陸案、CFP均仍維持請款單請款故國內收據全加不必判斷申請國家)
'                        If Left(adocaseprogress.Fields("a0j11").Value, 6) = "X70017" Or Left(adocaseprogress.Fields("a0j11").Value, 6) = "X74310" Or Left(adocaseprogress.Fields("a0j11").Value, 6) = "X83843" Then
'                           strTemp = ApplNoQuery(adocaseprogress.Fields("a0j01").Value)
'                           'Modify By Sindy 2020/7/16
'                           If pbolA4Print = True Then
'                              strNote1 = strNote1 & "  申請案號：" & strTemp
'                           Else
'                           '2020/7/16 END
'                              Printer.FontSize = 13
'                              Printer.CurrentX = 4100
'                              Printer.CurrentY = iCaseStarY + (intList + 1) * 400 '550
'                              Printer.Print "申請案號："
'                              Printer.FontSize = 12
'                              Printer.CurrentX = 5500
'                              Printer.CurrentY = iCaseStarY + (intList + 1) * 400 '550
'                              Printer.Print strTemp
'                           End If
'                        End If
'                        '2013/10/25 END
'
'                        'Add by Morgan 2004/8/12
'                        If pintPrintCustCaseNo = 1 And strCustCaseNo <> "" Then
'                           Call PUB_PrintReceiptCustCaseNo(pintPrintCustCaseNo, strCustCaseNo, pbolA4Print)
'                        End If
'
'                     End If
'
'                     'Add By Sindy 2020/7/16
'                     Printer.FontSize = 10
'                     '備註1
'                     If strNote1 <> "" Then
'                        strNote1 = Trim(strNote1)
'                        Printer.CurrentX = Px(0)
'                        Printer.CurrentY = iCaseStarY + intList * 250
'                        Printer.Print strNote1
'                     End If
'                     '備註2
'                     If strNote2 <> "" Then
'                        strNote2 = Trim(strNote2)
'                        Printer.CurrentX = Px(0)
'                        Printer.CurrentY = iCaseStarY + (intList + 1) * 250
'                        Printer.Print strNote2
'                     End If
'                     Printer.FontSize = 12
'                     '2020/7/16 END
'
'                     strNote1 = "": strNote2 = "" 'Add By Sindy 2020/7/16
'                     intList = intList + 1
'                  End If
'               End If
'            End If
'
'            If strItemDesc <> adocaseprogress.Fields("a0j22") Then
'
'               If lngItemAmount1 > 0 Or lngItemAmount2 > 0 Then
''                  '接洽日期
'                   'Modify By Sindy 2015/3/11 接洽日期不印
''                  If strCDate <> "" Then
''                     Printer.CurrentX = 350
''                     Printer.CurrentY = 3600 + intCounter * 300
''                     Printer.Print CFDate(ACDate(adocaseprogress.Fields("cp05")))
''                  End If
'                  '帳款類別
'                  For ii = 0 To 3
'                     'Modify By Sindy 2017/3/17
'                     'strTemp = PUB_StrToStr(strItemDesc, 20)
'                     strTemp = PUB_StrToStr(strItemDesc, 30)
'                     '2017/3/17 END
'                     If strTemp = "" Then
'                        Exit For
'                     Else
'                        'Modify By Sindy 2015/12/7 收據套印要拿掉接洽日期欄位,往前遞補
'                        'Printer.CurrentX = 1550
'                        Printer.CurrentX = XLeftCol1
'                        '2015/12/7 END
'                        Printer.CurrentY = YLeft + intCounter * 300 + ii * 300
'                        Printer.Print strTemp
'                        strItemDesc = Mid(strItemDesc, Len(strTemp) + 1)
'                     End If
'                  Next
'
'                  lngAmount1 = lngAmount1 + lngItemAmount1
'                  lngAmount2 = lngAmount2 + lngItemAmount2
'
'                  If lngItemAmount1 > 0 Then
'                     strAmount1 = Format(lngItemAmount1, DDollar)
'                  Else
'                     strAmount1 = 0
'                  End If
'                  If lngItemAmount2 > 0 Then
'                     strAmount2 = Format(lngItemAmount2, DDollar)
'                  Else
'                     strAmount2 = 0
'                  End If
'
'                  '服務費
'                  intLength = Printer.TextWidth(strAmount1)
'                  Printer.CurrentX = XLeftCol2 - intLength
'                  Printer.CurrentY = YLeft + intCounter * 300
'                  Printer.Print strAmount1
'                  '規費
'                  intLength = Printer.TextWidth(strAmount2)
'                  Printer.CurrentX = XLeftCol3 - intLength
'                  Printer.CurrentY = YLeft + intCounter * 300
'                  Printer.Print strAmount2
'
'                  intCounter = intCounter + 1
'               End If
'
'               lngItemAmount1 = 0
'               lngItemAmount2 = 0
'
'               '接洽日期
''               strCDate = CFDate(ACDate(adocaseprogress.Fields("cp05")))
'               '帳款類別
'               strItemDesc = adocaseprogress.Fields("a0j22")
'            End If
'
'            douService = 0
'            douFee = 0
'            '有銷帳
'            If IsNull(.Fields("a0k10")) = False Then
'               StrSQLa = "select sum(a1u07), sum(a1u09) from acc1u0 where a1u02 = '" & .Fields("a0k01").Value & "' and a1u03='" & adocaseprogress.Fields("a0j01") & "'"
'               intR = 1
'               Set adoquery = ClsLawReadRstMsg(intR, StrSQLa)
'               If intR = 1 Then
'                  If IsNull(adoquery.Fields(0).Value) = False Then
'                     douService = Val(adoquery.Fields(0).Value)
'                  End If
'                  If IsNull(adoquery.Fields(1).Value) = False Then
'                     douFee = Val(adoquery.Fields(1).Value)
'                  End If
'               End If
'               adoquery.Close
'            End If
'
'            If IsNull(adocaseprogress.Fields("a0j07").Value) = False Then
'               lngItemAmount1 = lngItemAmount1 + Val("" & adocaseprogress.Fields("a0j09")) + Val("" & adocaseprogress.Fields("a0j10")) - douService - douFee
'            Else
'               If Val("" & adocaseprogress.Fields("a0j09")) - douService > 0 Then
'                  lngItemAmount1 = lngItemAmount1 + Val("" & adocaseprogress.Fields("a0j09")) - douService
'                  lngItemAmount2 = lngItemAmount2 + Val("" & adocaseprogress.Fields("a0j10")) - douFee
'               Else
'                  lngItemAmount2 = lngItemAmount2 + Val("" & adocaseprogress.Fields("a0j10")) - douFee + Val("" & adocaseprogress.Fields("a0j09")) - douService
'               End If
'            End If
'            adocaseprogress.MoveNext
'         Loop
'         adocaseprogress.Close
'
'         lngAmount1 = lngAmount1 + lngItemAmount1
'         lngAmount2 = lngAmount2 + lngItemAmount2
'
'         If lngItemAmount1 > 0 Or lngItemAmount2 > 0 Then
'            '接洽日期
'            'Modify By Sindy 2015/3/11 接洽日期不印
''            If strCDate <> "" Then
''               Printer.CurrentX = 350
''               Printer.CurrentY = 3600 + intCounter * 300
''               Printer.Print strCDate
''            End If
'            '帳款類別
'            For ii = 0 To 3
'               'Modify By Sindy 2017/3/17
'               'strTemp = PUB_StrToStr(strItemDesc, 20)
'               strTemp = PUB_StrToStr(strItemDesc, 30)
'               '2017/3/17 END
'               If strTemp = "" Then
'                  Exit For
'               Else
'                  'Modify By Sindy 2015/12/7 收據套印要拿掉接洽日期欄位,往前遞補
'                  'Printer.CurrentX = 1550
'                  Printer.CurrentX = XLeftCol1
'                  '2015/12/7 END
'                  Printer.CurrentY = YLeft + intCounter * 300 + ii * 300
'                  Printer.Print strTemp
'                  strItemDesc = Mid(strItemDesc, Len(strTemp) + 1)
'               End If
'            Next
'
'            If lngItemAmount1 > 0 Then
'               strAmount1 = Format(lngItemAmount1, DDollar)
'            Else
'               strAmount1 = 0
'            End If
'            If lngItemAmount2 > 0 Then
'               strAmount2 = Format(lngItemAmount2, DDollar)
'            Else
'               strAmount2 = 0
'            End If
'
'            '服務費
'            intLength = Printer.TextWidth(strAmount1)
'            Printer.CurrentX = XLeftCol2 - intLength
'            Printer.CurrentY = YLeft + intCounter * 300
'            Printer.Print strAmount1
'            '規費
'            intLength = Printer.TextWidth(strAmount2)
'            Printer.CurrentX = XLeftCol3 - intLength
'            Printer.CurrentY = YLeft + intCounter * 300
'            Printer.Print strAmount2
'         End If
'
'      End If
'   Else
'
'      blnCombPrint = False
'      'CFP 美國 領證(601)及公開費(217)--目前已不會再收公開費,程式可不必考慮多案一收據問題 Morgan 2011/9/21
'      StrSQLa = "select Count(*) from acc0j0,caseprogress where a0j13 = '" & .Fields("a0k01").Value & "' And A0j04='101' And cp09(+)=a0j01  and CP01='CFP'  And cp10 In ('601','217') and (cp79 <> 0 or (cp79 = 0 and cp75 <> 0)) "
'      intR = 1
'      Set RsTemp = ClsLawReadRstMsg(intR, StrSQLa)
'      If intR = 1 Then
'         If Val("" & RsTemp.Fields(0).Value) = 2 Then blnCombPrint = True
'      End If
'
'      '收據明細資料
'      StrSQLa = "select a.*,b.*,getcp10desc(cp01,cp10,a0j04) cp10N,na03 from acc0j0 a,caseprogress b,nation where a0j13 = '" & .Fields("a0k01").Value & "' And cp09(+)=a0j01 and (cp79 <> 0 or (cp79 = 0 and cp75 <> 0)) and na01(+)=a0j04 ORDER BY CP09 "
'      intR = 1
'      Set adocaseprogress = ClsLawReadRstMsg(intR, StrSQLa)
'      If intR = 1 Then
'         intRecPos = 0
'         Do While adocaseprogress.EOF = False
'            intRecPos = intRecPos + 1
'
'            douService = 0
'            douFee = 0
'            '有銷帳
'            If adocaseprogress.Fields("cp77") > 0 Then
'               '銷帳=費用時不印
'               If adocaseprogress.Fields("cp77") = adocaseprogress.Fields("cp16") Then
'                  GoTo NextRecord
'               Else
'                  '抓收款資料
'                  'Modified by Morgan 2011/11/24
'                  'StrSQLa = "select sum(a1u07), sum(a1u09) from acc1u0 where a1u03 = '" & adocaseprogress.Fields("cp09").Value & "'"
'                  StrSQLa = "select sum(a1u07), sum(a1u09) from acc1u0 where a1u03 = '" & adocaseprogress.Fields("cp09").Value & "' and a1u02='" & .Fields("a0k01").Value & "'"
'                  intR = 1
'                  Set adoquery = ClsLawReadRstMsg(intR, StrSQLa)
'                  If intR = 1 Then
'                     If IsNull(adoquery.Fields(0).Value) = False Then
'                        douService = Val(adoquery.Fields(0).Value)
'                     End If
'                     If IsNull(adoquery.Fields(1).Value) = False Then
'                        douFee = Val(adoquery.Fields(1).Value)
'                     End If
'                  End If
'                  adoquery.Close
'               End If
'            End If
'
'            If blnCombPrint = False Or adocaseprogress.Fields("cp10") = "601" Then
'               '收文日
'               'Modify By Sindy 2015/3/11 接洽日期不印
''               If IsNull(adocaseprogress.Fields("cp05").Value) = False Then
''                  Printer.CurrentX = 350
''                  Printer.CurrentY = 3600 + intCounter * 300
''                  Printer.Print CFDate(ACDate(adocaseprogress.Fields("cp05").Value))
''               End If
'
'               '案件性質
'               'Modify By Sindy 2015/12/7 收據套印要拿掉接洽日期欄位,往前遞補
'               'Printer.CurrentX = 1550
'               Printer.CurrentX = XLeftCol1
'               '2015/12/7 END
'               Printer.CurrentY = YLeft + intCounter * 300
'               'Modify by Morgan 2007/5/8 案件性質名稱直接抓0j0的以免資料不一致卻沒發現(程式有修剪)
'               If intRecPos = 1 And pstrNewDesc1 <> "" Then
'                  Printer.Print pstrNewDesc1
'
'               ElseIf intRecPos = 2 And pstrNewDesc2 <> "" Then
'                  Printer.Print pstrNewDesc2
'
'               '不列印專利年費年度
'               ElseIf pintNoPrintPatentYear > 0 Then
'                  'Modified by Morgan 2011/12/27 取消 a0j20
'                  'Printer.Print adocaseprogress.Fields("a0j20").Value
'                  Printer.Print adocaseprogress.Fields("cp10N").Value
'
'               Else
'                  'Add By Sindy 2009/07/14
'                  '加印繳費年度說明
'                  If ((adocaseprogress.Fields("cp01").Value = "P" And adocaseprogress.Fields("cp10").Value = "601") Or _
'                        ((adocaseprogress.Fields("cp01").Value = "P" Or adocaseprogress.Fields("cp01").Value = "CFP") And _
'                        (adocaseprogress.Fields("cp10").Value = "605" Or adocaseprogress.Fields("cp10").Value = "606" Or adocaseprogress.Fields("cp10").Value = "607"))) And _
'                     adocaseprogress.Fields("cp53").Value <> "" And _
'                     adocaseprogress.Fields("cp54").Value <> "" Then
'                     strSql = "SELECT * FROM patent WHERE pa01='" & adocaseprogress.Fields("cp01").Value & "' and pa02='" & adocaseprogress.Fields("cp02").Value & "' and pa03='" & adocaseprogress.Fields("cp03").Value & "' and pa04='" & adocaseprogress.Fields("cp04").Value & "' "
'                     intI = 1
'                     Set RsTemp = ClsLawReadRstMsg(intI, strSql)
'                     If intI = 1 Then
'                        strPA08 = RsTemp("PA08")
'                        strPA09 = RsTemp("PA09")
'                     End If
'                     strKey(0) = ""
'                     strKey(1) = adocaseprogress.Fields("cp01").Value
'                     strKey(2) = adocaseprogress.Fields("cp02").Value
'                     strKey(3) = adocaseprogress.Fields("cp03").Value
'                     strKey(4) = adocaseprogress.Fields("cp04").Value
'                     '2010/2/12 modify by sonia 抓修法次數
'                     'bFind = GetMoneyDate(strPA08, strPA09, strKey, strCaseFee(1), strCaseFee(2))
'                     bFind = GetMoneyDate(strPA08, strPA09, strKey, strCaseFee(1), strCaseFee(2), , , m_FixNo)
'                     If bFind Then
'                        If IsEmptyText(strCaseFee(2)) = False Then
'                           varRef = Split(strCaseFee(2), ",")
'                           strFeeType = PUB_GetNa20Na22Na24(strPA09, strPA08)
'                           If adocaseprogress.Fields("cp10").Value = "605" Or _
'                              adocaseprogress.Fields("cp10").Value = "601" Then
'                              strYF15 = PUB_GetYF15(strPA09, strPA08, "Y000000" & m_FixNo, strFeeType, CDbl(Val(adocaseprogress.Fields("cp53").Value)))
'                           Else
'                              strYF15 = PUB_GetYF15(strPA09, strPA08, "Y000000" & m_FixNo, strFeeType, Val(varRef(Val(adocaseprogress.Fields("cp53").Value) - 1)))
'                           End If
'                           Printer.FontSize = 11
''                           Printer.Font = "標楷體"
'                           If Val(adocaseprogress.Fields("cp53").Value) = Val(adocaseprogress.Fields("cp54").Value) Then
'                              'Modified by Morgan 2011/12/27 取消 a0j20
'                              'Printer.Print adocaseprogress.Fields("a0j20").Value & " " & strYF15
'                              Printer.Print adocaseprogress.Fields("cp10N").Value & " " & strYF15
'                           Else
'                              If adocaseprogress.Fields("cp10").Value = "605" Or _
'                                 adocaseprogress.Fields("cp10").Value = "601" Then
'                                 'Modified by Morgan 2011/12/27 取消 a0j20
'                                 'Printer.Print adocaseprogress.Fields("a0j20").Value & " (" & strYF15 & "至" & PUB_GetYF15(strPA09, strPA08, "Y000000" & m_FixNo, strFeeType, CDbl(Val(adocaseprogress.Fields("cp54").Value))) & ")"
'                                 Printer.Print adocaseprogress.Fields("cp10N").Value & " (" & strYF15 & "至" & PUB_GetYF15(strPA09, strPA08, "Y000000" & m_FixNo, strFeeType, CDbl(Val(adocaseprogress.Fields("cp54").Value))) & ")"
'                              Else
'                                 'Modified by Morgan 2011/12/27 取消 a0j20
'                                 'Printer.Print adocaseprogress.Fields("a0j20").Value & " (" & strYF15 & "至" & PUB_GetYF15(strPA09, strPA08, "Y000000" & m_FixNo, strFeeType, Val(varRef(Val(adocaseprogress.Fields("cp54").Value) - 1))) & ")"
'                                 Printer.Print adocaseprogress.Fields("cp10N").Value & " (" & strYF15 & "至" & PUB_GetYF15(strPA09, strPA08, "Y000000" & m_FixNo, strFeeType, Val(varRef(Val(adocaseprogress.Fields("cp54").Value) - 1))) & ")"
'                              End If
'                           End If
'                        End If
'                     End If
'                  '2009/07/14 End
'                  Else
'                     'Modified by Morgan 2011/12/27 取消 a0j20
'                     'Printer.Print adocaseprogress.Fields("a0j20").Value
'                     'Modify By Sindy 2020/4/30 帳款類別之案件性質後加印'－法律所案號申請人名稱前6個中文'
'                     Printer.Print adocaseprogress.Fields("cp10N").Value & IIf(strLOSCName <> "", "-" & Mid(strLOSCName, 1, 6), "")
'                     '2020/4/30 END
'                  End If
'               End If
'            End If
'
'            Printer.FontSize = 12
''            Printer.Font = "標楷體"
'            'end 2007/5/8
'            'Modified by Morgan 2011/11/24
'            'If IsNull(adocaseprogress.Fields("cp16").Value) = False Then
'            If Val("" & adocaseprogress.Fields("a0j09").Value) + Val("" & adocaseprogress.Fields("a0j10").Value) > 0 Then
'
'               '有規費不合併
'               'Modified by Morgan 2011/11/24
'               'If IsNull(adocaseprogress.Fields("cp17").Value) = False And IsNull(.Fields("a0k30").Value) Then
'               If Val("" & adocaseprogress.Fields("a0j10").Value) > 0 And IsNull(adocaseprogress.Fields("a0j07").Value) Then
'                  '服務費
'                  If Val("" & adocaseprogress.Fields("a0j09").Value) - douService > 0 Then
'                     strAmount1 = Format(Val("" & adocaseprogress.Fields("a0j09").Value) - douService, DDollar)
'                  Else
'                     strAmount1 = "0"
'                  End If
'
'                  If blnCombPrint = False Then
'                     intLength = Printer.TextWidth(strAmount1)
'                     Printer.CurrentX = XLeftCol2 - intLength
'                     Printer.CurrentY = YLeft + intCounter * 300
'                     Printer.Print strAmount1
'                  End If
'
'                  '服務費累計
'                  lngAmount1 = lngAmount1 + Val(Format(strAmount1))
'
'                  '規費
'                  'Modified by Morgan 2011/11/24
'                  If Val("" & adocaseprogress.Fields("a0j10").Value) - douFee > 0 Then
'                     'Modified by Morgan 2011/11/28 若為負點數時規費印費用
'                     If Val("" & adocaseprogress.Fields("a0j09").Value) - douService < 0 Then
'                        strAmount2 = Format(Val("" & adocaseprogress.Fields("a0j10").Value) - douFee + Val("" & adocaseprogress.Fields("a0j09").Value) - douService, DDollar)
'                     Else
'                        strAmount2 = Format(Val("" & adocaseprogress.Fields("a0j10").Value) - douFee, DDollar)
'                     End If
'                  Else
'                     strAmount2 = "0"
'                  End If
'
'                  If blnCombPrint = False Then
'                      intLength = Printer.TextWidth(strAmount2)
'                      Printer.CurrentX = XLeftCol3 - intLength
'                      Printer.CurrentY = YLeft + intCounter * 300
'                      Printer.Print strAmount2
'                  End If
'                  '規費累計
'                  lngAmount2 = lngAmount2 + Val(Format(strAmount2))
'
'               '合併列印或無規費
'               Else
'                  'Modified by Morgan 2011/11/24
'                  'strAmount1 = Format(Val(adocaseprogress.Fields("cp16").Value) - douService - douFee, DDollar)
'                  strAmount1 = Format(Val("" & adocaseprogress.Fields("a0j09").Value) + Val("" & adocaseprogress.Fields("a0j10").Value) - douService - douFee, DDollar)
'                  If blnCombPrint = False Then
'                     intLength = Printer.TextWidth(strAmount1)
'                     Printer.CurrentX = XLeftCol2 - intLength
'                     Printer.CurrentY = YLeft + intCounter * 300
'                     '列印費用
'                     If strAmount1 = "" Then
'                        Printer.Print "0"
'                     Else
'                        Printer.Print strAmount1
'                     End If
'                  End If
'                  lngAmount1 = lngAmount1 + Val(Format(strAmount1))
'
'                  strAmount2 = "0"
'                  If blnCombPrint = False Then
'                       intLength = Printer.TextWidth(strAmount2)
'                       Printer.CurrentX = XLeftCol3 - intLength
'                       Printer.CurrentY = YLeft + intCounter * 300
'                       Printer.Print strAmount2
'                   End If
'                  lngAmount2 = lngAmount2 + 0
'               End If
'            End If
'
'            '美國領證+公開
'            If blnCombPrint = True And intRecPos = 2 Then
'                '列印費用
'                intCounter = intCounter - 1
'                If lngAmount1 = 0 Then
'                    strAmount1 = "0"
'                Else
'                    strAmount1 = Format(lngAmount1, DDollar)
'                End If
'                intLength = Printer.TextWidth(strAmount1)
'                Printer.CurrentX = XLeftCol2 - intLength
'                Printer.CurrentY = YLeft + intCounter * 300
'                Printer.Print strAmount1
'                '列印規費
'                If lngAmount2 = 0 Then
'                    strAmount2 = "0"
'                Else
'                    strAmount2 = Format(lngAmount2, DDollar)
'                End If
'                intLength = Printer.TextWidth(strAmount2)
'                Printer.CurrentX = XLeftCol3 - intLength
'                Printer.CurrentY = YLeft + intCounter * 300
'                Printer.Print strAmount2
'            End If
'
'            'Modify by Morgan 2011/9/20 只要印一次,若設定金額合併則不印
'            If intRecPos = 1 And IsNull(.Fields("a0k33")) Then
'               '列印本所案號
'               If (adocaseprogress.Fields("cp03").Value & adocaseprogress.Fields("cp04").Value) = "000" Then
'                  strTemp = adocaseprogress.Fields("cp01").Value & adocaseprogress.Fields("cp02").Value
'               Else
'                  strTemp = adocaseprogress.Fields("cp01").Value & adocaseprogress.Fields("cp02").Value & adocaseprogress.Fields("cp03").Value & adocaseprogress.Fields("cp04").Value
'               End If
'               'Modify By Sindy 2020/7/16
'               If pbolA4Print = True Then
'                  strNote1 = strNote1 & "  本所案號：" & strTemp
'               Else
'               '2020/7/16 END
'                  Printer.CurrentX = 1500
'                  Printer.CurrentY = iCaseStarY + intList * 550
'                  Printer.Print strTemp
'               End If
'
'               '列印申請國家名稱
'               'Modified by Morgan 2011/12/26 取消 a0j21
'               If IsNull(adocaseprogress.Fields("na03").Value) = False Then
'                  strTemp = adocaseprogress.Fields("na03").Value
'                  'Modify By Sindy 2020/7/16
'                  If pbolA4Print = True Then
'                     strNote1 = strNote1 & "  申請國家：" & strTemp
'                  Else
'                  '2020/7/16 END
'                     Printer.CurrentX = 3000
'                     Printer.CurrentY = iCaseStarY + intList * 550
'                     Printer.Print strTemp
'                  End If
'               End If
'
'               'Add By Sindy 2013/10/25 客戶X70017及其關係企業均加申請案號
'               'modify by sonia 2020/3/16 +長春相關企業X74310均加申請案號
'               'modify by sonia 2022/3/28 +溢泰實業相關企業X83843均加申請案號(P大陸案、CFP均仍維持請款單請款故國內收據全加不必判斷申請國家)
'               If Left(adocaseprogress.Fields("a0j11").Value, 6) = "X70017" Or Left(adocaseprogress.Fields("a0j11").Value, 6) = "X74310" Or Left(adocaseprogress.Fields("a0j11").Value, 6) = "X83843" Then
'                  strTemp = ApplNoQuery(adocaseprogress.Fields("a0j01").Value)
'                  'Modify By Sindy 2020/7/16
'                  If pbolA4Print = True Then
'                     strNote1 = strNote1 & "  申請案號：" & strTemp
'                  Else
'                  '2020/7/16 END
'                     Printer.FontSize = 13
'                     Printer.CurrentX = 4100
'                     Printer.CurrentY = iCaseStarY + (intList + 1) * 400 '550
'                     Printer.Print "申請案號："
'                     Printer.FontSize = 12
'                     Printer.CurrentX = 5500
'                     Printer.CurrentY = iCaseStarY + (intList + 1) * 400 '550
'                     Printer.Print strTemp
'                  End If
'               End If
'               '2013/10/25 END
'
'               '查名案加印商品類別
'               strProduct = ""
'               If adocaseprogress.Fields("cp01").Value = "S" Or adocaseprogress.Fields("cp01").Value = "TS" Then
'                  StrSQLa = "select SP18 as tm09 from SERVICEPRACTICE where SP01 = '" & adocaseprogress.Fields("cp01").Value & "' and SP02 = '" & adocaseprogress.Fields("cp02").Value & "' and SP03 = '" & adocaseprogress.Fields("cp03").Value & "' and SP04 = '" & adocaseprogress.Fields("cp04").Value & "'"
'               Else
'                  StrSQLa = "select tm09 from trademark where tm01 = '" & adocaseprogress.Fields("cp01").Value & "' and tm02 = '" & adocaseprogress.Fields("cp02").Value & "' and tm03 = '" & adocaseprogress.Fields("cp03").Value & "' and tm04 = '" & adocaseprogress.Fields("cp04").Value & "'"
'               End If
'               intR = 1
'               Set adoquery = ClsLawReadRstMsg(intR, StrSQLa)
'               If intR = 1 Then
'                  If IsNull(adoquery.Fields("tm09").Value) = False Then
'                     '2010/8/24 modify by sonia 加 '類'
'                     strProduct = "第" & adoquery.Fields("tm09").Value & " 類"
'                  End If
'               End If
'               adoquery.Close
'
'               '列印案件名稱(以總收文號查詢)及客戶案件名稱(Optional)
'               strTemp = CaseNameQuery(adocaseprogress.Fields("cp09").Value, 1, strCustCaseNo)
'               If strTemp = "" Then
'                  strTemp = CaseNameQuery(adocaseprogress.Fields("cp09").Value, 2)
'               End If
'               'Modified by Morgan 2012/9/17 若案件名稱太長時縮小
'               'Printer.Print ReOrgPrintTemp(Trim(strTemp) & " " & strProduct, 22)
'               strTemp = Trim(strTemp) & " " & strProduct
'               'Modify By Sindy 2020/7/16
'               If pbolA4Print = True Then
'                  strNote2 = strNote2 & "  案件名稱：" & strTemp
'               Else
'               '2020/7/16 END
'                  strTempA = ReOrgPrintTemp(strTemp, 22)
'                  Printer.CurrentX = 5500
'                  Printer.CurrentY = iCaseStarY + intList * 550
'                  If strTemp = strTempA Then
'                     Printer.Print strTemp
'                  Else
'                     Printer.FontSize = 10
'                     Printer.Print ReOrgPrintTemp(strTemp, 26)
'                     Printer.FontSize = 12
'                  End If
'                  'end 2012/9/17
'               End If
'
'               'Add By Sindy 2020/7/16
'               Printer.FontSize = 10
'               '備註1
'               If strNote1 <> "" Then
'                  strNote1 = Trim(strNote1)
'                  Printer.CurrentX = Px(0)
'                  Printer.CurrentY = iCaseStarY + intList * 250
'                  Printer.Print strNote1
'               End If
'               '備註2
'               If strNote2 <> "" Then
'                  strNote2 = Trim(strNote2)
'                  Printer.CurrentX = Px(0)
'                  Printer.CurrentY = iCaseStarY + (intList + 1) * 250
'                  Printer.Print strNote2
'               End If
'               Printer.FontSize = 12
'               '2020/7/16 END
'
'               'Add by Morgan 2004/8/12
'               If pintPrintCustCaseNo = 1 And strCustCaseNo <> "" Then
'                  Call PUB_PrintReceiptCustCaseNo(pintPrintCustCaseNo, strCustCaseNo, pbolA4Print)
'               End If
'
'               strNote1 = "": strNote2 = "" 'Add By Sindy 2020/7/16
'               intList = intList + 1
'            End If
'
'            intCounter = intCounter + 1
'            'Add by Morgan 2005/9/15 顧問案的顧問聘任(0)時要印顧問期間
'            If adocaseprogress("CP01") = "LA" And adocaseprogress("CP10") = "0" Then
'               'Modify By Sindy 2015/12/7 收據套印要拿掉接洽日期欄位,往前遞補
'               'Printer.CurrentX = 1550
'               Printer.CurrentX = XLeftCol1
'               '2015/12/7 END
'               Printer.CurrentY = YLeft + intCounter * 300
'               Printer.Print "顧問期間："
'               intCounter = intCounter + 1
'               'Modify By Sindy 2015/12/7 收據套印要拿掉接洽日期欄位,往前遞補
'               'Printer.CurrentX = 1550
'               Printer.CurrentX = XLeftCol1
'               '2015/12/7 END
'               Printer.CurrentY = YLeft + intCounter * 300
'               Printer.Print Format(TransDate("" & adocaseprogress("CP53"), 1), "###/##/##") & " - " & Format(TransDate("" & adocaseprogress("CP54"), 1), "###/##/##")
'               intCounter = intCounter + 1
'            End If
'NextRecord:
'            adocaseprogress.MoveNext
'         Loop
'         adocaseprogress.Close
'      End If
'
'   End If
'
'   '列印次數
'   'Add By Sindy 2020/7/15
'   If pbolA4Print = True Then
'      Printer.CurrentX = Px(5) - 400
'      Printer.CurrentY = Py(9) + 100
'   Else
'   '2020/7/15 END
'      Printer.CurrentX = 10200 + 350
'      Printer.CurrentY = 6800
'   End If
'   Printer.Print intTimes
'
'   'Add By Sindy 2020/4/1 + .Fields("a0k11").Value
'   'Modify By Sindy 2020/7/15 + pbolA4Print
'   PUB_PrintReceiptSum lngAmount1, lngAmount2, .Fields("a0k11").Value, pbolA4Print
'
'   adoTaie.Execute "update acc0k0 set a0k19 = " & intTimes & " where a0k01 = '" & .Fields("a0k01").Value & "'"
'   If pstrPritDate <> "" Then
'      'Modify By Sindy 2020/4/20 109/4月開始已無1公司,所以不可以再修改1公司的收據日期
'      adoTaie.Execute "update acc0k0 set a0k02=" & pstrPritDate & _
'                      " where a0k01 = '" & .Fields("a0k01").Value & "' and a0k11<>'1'"
''   Else
''      adoTaie.Execute "update acc0k0 set a0k19 = " & intTimes & " where a0k01 = '" & .Fields("a0k01").Value & "'"
'   End If
'   End With
'
'EXITSUB:
'
'   Set adocaseprogress = Nothing
'   Set adoquery = Nothing
'End Sub

'Modify By Sindy 2020/7/16 (從PUB_PrintCaseReceipt抽出來) 收據列印-客戶案件案號
Public Sub PUB_PrintReceiptCustCaseNo(ByRef pintPrintCustCaseNo As Integer, strCustCaseNo As String, _
   Optional pbolA4Print As Boolean = False)
Dim strTempA As String
Dim strTemp As String
'Added by Lydia 2017/06/16
Dim iLeft As Integer '列印客戶代號的X座標
Dim strDoPrt As String '列印客戶案件案號
'end 2017/06/16
Dim YLeft As Integer '列印客戶代號的Y座標 'Add By Sindy 2020/7/16
   
   'Add By Sindy 2020/7/16
   If pbolA4Print = True Then
      iLeft = Px(0) + 1200
      YLeft = Py_t(3)
   Else
   '2020/7/16 END
      iLeft = 1350 '1250 'Added by Lydia 2017/06/16 列印客戶代號的X座標
      YLeft = 2700
   End If
   
   'Add by Morgan 2004/8/12
   'If pintPrintCustCaseNo = 1 And strCustCaseNo <> "" Then
      'Modified by Morgan 2017/3/2 若客戶案件案號太長時縮小並靠右對齊
      'Printer.CurrentX = 8200 - Printer.TextWidth("客戶案件案號：")
      'Printer.CurrentY = 2700
      'Printer.Print "客戶案件案號：" & strCustCaseNo
      strTempA = ReOrgPrintTemp(strCustCaseNo, 12)
      If strCustCaseNo = strTempA Then
         '8200 - Printer.TextWidth("客戶案件案號：")
         'Add By Sindy 2020/7/16
         If pbolA4Print = True Then
            Printer.CurrentX = Px(3)
         Else
         '2020/7/16 END
            Printer.CurrentX = 8300 - Printer.TextWidth("客戶案件案號：")
         End If
         Printer.CurrentY = YLeft
         Printer.Print "客戶案件案號：" & strCustCaseNo
      
      Else
         strTemp = "客戶案件案號：" & strCustCaseNo
         Printer.FontSize = 9
         'Added by Lydia 2017/06/16 判斷長度超過折行(最大2行)
         If Printer.TextWidth(strTemp) > (11080 - iLeft) Then
             Printer.FontSize = 8
             If Printer.TextWidth(strTemp) > (11080 - iLeft) Then
                  strDoPrt = convForm(strTemp, 120)
                  Printer.CurrentX = iLeft
                  Printer.CurrentY = YLeft
                  Printer.Print strDoPrt
                  strDoPrt = Replace(strTemp, strDoPrt, "")
                  Printer.CurrentX = iLeft
                  Printer.CurrentY = YLeft + 160 '2860
                  Printer.Print strDoPrt
             Else
                  Printer.CurrentX = iLeft
                  Printer.CurrentY = YLeft
                  Printer.Print strTemp
             End If
         Else
           'end 2017/06/16
            'Modified by Lydia 2017/06/16
            'Printer.CurrentX = 11080 - Printer.TextWidth(strTemp)
             Printer.CurrentX = iLeft
             Printer.CurrentY = YLeft
             Printer.Print strTemp
         End If 'end 2017/06/16
         Printer.FontSize = 12
      End If
      'end 2017/3/2
      pintPrintCustCaseNo = 0 'Added by Morgan 2011/12/1 只能印一案
   'End If
End Sub

'2012/12/11 整合Frmacc2170及Frmacc21b0並移出來,Frmacc2170改用function的GETA0K11
'Add by Morgan 2006/7/17
'抓公司別
'******此段修改function的GETA0K11也要改
'Move by Lydia 2020/03/26 從aacc_fun搬來
Public Function GetComp(ByRef p_A0k01 As String, ByVal p_CaseNo As String, ByVal p_Company As String) As String
Dim p_Nation As String
   
   ' 若無收據編號時專利且P申請國家非台灣,CFP日本或EPC的公司別設1
   '2008/3/7 ADD BY SONIA CFP之EPC子案改以母案抓申請國家
   If p_CaseNo <> "" Then
      If Mid(p_CaseNo, 1, Len(p_CaseNo) - 12) = "CFP" And Mid(p_CaseNo, Len(p_CaseNo) - 1, 2) <> "00" Then
         Mid(p_CaseNo, Len(p_CaseNo) - 1, 2) = "00"
      End If
   End If
   '2008/3/7 END
   p_Nation = GetPrjNation1(p_CaseNo)    '2006/11/1 ADD BY SONIA 重抓案件基本檔之申請國家
   If p_A0k01 = "" Then
'2006/11/1 MODIFY BY SONIA
'      '專利
'      If Left(p_CaseNo, 2) = "P-" Then
'         '申請國家
'         p_Nation = GetPrjNation1(p_CaseNo)
'         '大陸,日本或EPC
'         If InStr("020,011,221", p_Nation) > 0 Then
'            '1公司
'            GetComp = "1"
'         End If
'      End If
      GetComp = "2"    '先預設 2 公司
      If p_CaseNo <> "" Then 'Add by Morgan 2006/11/24 沒案號的要跳過 -- 婧瑄
      Select Case Mid(p_CaseNo, 1, Len(p_CaseNo) - 12)
         Case "CFP", "CPS"
            Select Case p_Nation
               Case "011"
                  '2011/2/22 modify by sonia
                  'If Mid(p_CaseNo, Len(p_CaseNo) - 10, 6) >= "011051" Then
                  If Mid(p_CaseNo, Len(p_CaseNo) - 10, 6) >= "011051" And Mid(p_CaseNo, Len(p_CaseNo) - 10, 6) <= "023914" Then
                     GetComp = "1"
                  End If
               Case "221"
                  If Mid(p_CaseNo, Len(p_CaseNo) - 10, 6) >= "011051" And Mid(p_CaseNo, Len(p_CaseNo) - 10, 6) < "016183" Then
                     GetComp = "1"
                  End If
            End Select
         Case "P", "PS"
            If p_Nation <> "000" Then
               GetComp = "1"
               '2012/4/24 ADD BY SONIA 此日期起非台灣P案改用專利法律2公司
               If Mid(p_CaseNo, Len(p_CaseNo) - 10, 6) >= 101672 Then
                  GetComp = "2"
               End If
               '2012/4/24 END
            End If
         '2009/4/3 ADD BY SONIA 婧瑄說內外商部門的系統類別都設1公司
         Case "S", "CFC"
            GetComp = "1"
         '2009/4/2 END
         'Add by Morgan 2006/11/24 所有商標案都設 1 公司 -- 婧瑄
         Case Else
            If InStr(Mid(p_CaseNo, 1, Len(p_CaseNo) - 12), "T") > 0 Then
               GetComp = "1"
            End If
      End Select
      End If
'2006/11/1 END
   End If
   If GetComp = "" Then GetComp = p_Company

End Function

'公司名稱查詢
'Modify by Amy 2020/03/17 +IsAbbr縮寫
'Move by Lydia 2020/03/26 從aacc_fun搬來
Public Function A0802Query(InputNo As String, Optional ByVal IsAbbr As Boolean = False) As String
Dim adoacc080 As New ADODB.Recordset
Dim strQ As String, strTmp As String 'Add by Amy 2020/03/17
 
   'Modify by Amy 2020/03/17 1公司顯示2公司名稱
   strQ = "Select a0801,Decode(a0801,'1',AName,a0802) a0802,a0803,a0804,Decode(a0801,'1',BName,a0820) a0820 From acc080 " & _
            ",(Select '1' ANo,a0802 AName,a0820 BName From Acc080 Where a0801='2' ) " & _
             "Where a0801=ANo(+)  And a0801 = '" & InputNo & "' "
   adoacc080.CursorLocation = adUseClient
   adoacc080.Open strQ, adoTaie, adOpenStatic, adLockReadOnly
   If adoacc080.RecordCount <> 0 Then
      strTmp = "" & adoacc080.Fields("a0802").Value
      If IsAbbr = True Then
            strTmp = "" & adoacc080.Fields("a0820").Value
      End If
   Else
      strTmp = MsgText(601)
   End If
   A0802Query = strTmp
   'end 2020/03/17
   adoacc080.Close
End Function

'Added by Lydia 2020/04/15 法務工作點數依規則自動重新分配
Public Function PUB_GetLawPointAuto(ByVal strCP09 As String, ByVal bolChk As Boolean, ByVal bolMsg As Boolean) As Boolean
'bolChk : 是否檢查已有acc1n0
'bolMsg: 是否彈訊息
Dim stSQL As String, intR As Integer
Dim rsAD As ADODB.Recordset
Dim douPtSum As Double '總點數

On Error GoTo ErrHnd
   
'Memo by Lydia 2020/04/15  有法務工作點數的程式
'1.法務發文作業: 內外法發文按工作點數分配按鈕時，若無ACC1N0之工作點數資料則直接依規則先寫入ACC1N0之工作點數資料;
'                           若發文時未按工作點數分配按鈕也直接依規則先寫入ACC1N0之工作點數資料
'2.案件進度檔維護: 第一畫面若instr(cp01,'L')>0則增加工作點數分配按鈕，進入frm071021
'3.財務的銷帳退費作業Frmacc1190
'4.財務的銷帳退費作業Frmacc1190->本所案號退費/銷帳資料輸入Frmacc1192銷退的總收文號若有ACC1N0且A1N02=’3’的資料，在存檔時必須強制進入收據點數分配畫面Frmacc21h5且帶出原分配資料，且必須點數合計正確才能離開。
'end 2020/04/15

    If strCP09 = "" Then Exit Function
    
    If bolChk = True Then
        stSQL = "select * from acc1n0 where a1n01='" & strCP09 & "' and a1n02='3' "
        intR = 1
        Set rsAD = ClsLawReadRstMsg(intR, stSQL)
        If intR = 1 Then
            GoTo EXITSUB '已有分配點數，不須自動分配
        End If
    End If
    
    'Modified by Lydia 2020/04/16
    'stSQL = "select cp09,cp14,cp18,nvl(a1u07,0) damt2 from caseprogress,acc1u0 " & _
                 "where cp09='" & strCP09 & "' and cp18>0 and cp09=a1u03(+) and length(cp14) > 0 "
    stSQL = "select cp09,cp14,cp18,sum(nvl(a1u07,0)) damt2 from caseprogress,acc1u0 " & _
                 "where cp09='" & strCP09 & "' and cp18>0 and cp09=a1u03(+) and cp60=a1u02(+) and length(cp14) > 0 " & _
                 "group by cp09,cp14,cp18 "
    intR = 1
    Set rsAD = ClsLawReadRstMsg(intR, stSQL)
    If intR = 1 Then 'strCP09
         cnnConnection.BeginTrans
            cnnConnection.Execute "delete acc1n0 where a1n01='" & strCP09 & "'"
           '算到小數點
           douPtSum = rsAD.Fields("cp18") - rsAD.Fields("damt2") / 1000 '減收據有財務處銷帳或銷退後的點數
           If douPtSum > 0 Then
              stSQL = "insert into ACC1N0(a1n01,a1n02,a1n03,a1n04,a1n05)" & _
                    " values ('" & strCP09 & "','3','" & rsAD.Fields("cp09") & "','" & "" & rsAD.Fields("cp14") & "'," & douPtSum & ")"
              cnnConnection.Execute stSQL, intR
           End If
        cnnConnection.CommitTrans
        
        If bolMsg = True Then MsgBox "重新分配完畢，若有特殊分配請再人工調整！"
    Else
         MsgBox "收文號無承辦人，無法自動分配工作點數!", vbExclamation
    End If 'strCP09
      
    GoTo EXITSUB

ErrHnd:
    If Err.Number <> 0 Then
         cnnConnection.RollbackTrans
         MsgBox Err.Description
         Exit Function
    End If
    
EXITSUB:
   Set rsAD = Nothing
   PUB_GetLawPointAuto = True
   
End Function

'Modify By Sindy 2020/5/22 從frm100101_15 Move過來,改成共用函數
'Modify By Sindy 2020/5/25 + Optional strTyp As String = "":副檔名 如:P收達==>.ACK.msg
Public Function PUB_UpdateCFData(ByVal stKey1 As String, ByVal stFileName As String, ByVal longSize As Long, _
   Optional strTyp As String = "") As Boolean
Dim stSQL As String
Dim strFile As String, strNewFile As String
Dim stFtpPath As String
   
   PUB_UpdateCFData = False
   
   '新增附件
   If stKey1 <> "" And stFileName <> "" And longSize > 0 Then
      strFile = Mid(stFileName, InStrRev(stFileName, "\") + 1)
      '副檔名
      If strTyp <> "" Then
         strFile = Mid(strFile, 1, InStrRev(strFile, ".") - 1) & "." & strTyp & Mid(strFile, InStrRev(strFile, "."))
      End If
      
      '使用者命名的檔名有可能有中文字, 進FTP的檔名不可放中文, 因此重新命名
      strNewFile = stKey1 & "_" & strSrvDate(1) & "." & Format(ServerTime, "000000") & _
         IIf(strTyp <> "", "." & strTyp, "") & _
         Mid(strFile, InStrRev(strFile, "."))
      
      If PUB_PutFtpFile(stFileName, stKey1, strNewFile, stFtpPath, "CONTACTFILE") = True Then
         stSQL = "INSERT INTO CONTACTFILE(cf01,cf02,cf06,cf07)" & _
                 "VALUES('" & stKey1 & "','" & ChgSQL(strFile) & "','" & ChgSQL(stFtpPath) & "','" & longSize & "')"
         Pub_SeekTbLog stSQL
         cnnConnection.Execute stSQL
         PUB_UpdateCFData = True
      End If
   End If
End Function

'Added by Morgan 2020/7/9
Public Function PUB_ZipFile(pFromPath As String, pZipName As String, Optional pPWD As String, Optional pShowErr As Boolean = True, Optional ByRef pErrMsg As String) As Boolean
   Dim program_name As String, program_path As String
   Dim process_id As Long
   Dim process_handle As Long

   program_name = "C:\Program Files\7-Zip\7z.exe"
   '檢查執行檔
   If Dir(program_name) = "" Then
      MsgBox "未安裝 7-Zip 程式，壓縮檔產生失敗！。"
      Exit Function
   End If
    
On Error GoTo ShellError
        
   '刪除舊檔
   If Dir(pZipName) <> "" Then
      Kill pZipName
   End If
   
   process_id = SHELL("""" & program_name & """ a" & IIf(pPWD <> "", " -p""" & pPWD & """", "") & " """ & pZipName & """ """ & pFromPath & """", vbHide)
    
    On Error GoTo 0

    ' Wait for the program to finish.
    ' Get the process handle.
    process_handle = OpenProcess(SYNCHRONIZE, 0, process_id)
    If process_handle <> 0 Then
        WaitForSingleObject process_handle, INFINITE
        CloseHandle process_handle
    End If
    PUB_ZipFile = True
    Exit Function

ShellError:
   pErrMsg = Err.Description
   If pShowErr Then
      MsgBox " " & _
          program_name & vbCrLf & _
          pErrMsg, vbOKOnly Or vbExclamation, _
          "Error"
   End If
End Function

'Added by Morgan 2020/7/10
'用 7z.exe 檔案解壓
Public Function PUB_UnZipFile2(pZipFile As String, pToPath As String, Optional pPWD As String) As Boolean
   Dim program_name As String, program_path As String
   Dim process_id As Long
   Dim process_handle As Long

   program_name = "C:\Program Files\7-Zip\7z.exe"
   '檢查執行檔
   If Dir(program_name) = "" Then
      MsgBox "未安裝 7-Zip 程式，解壓縮檔產生失敗！。"
      Exit Function
   End If
    
On Error GoTo ShellError
  
   process_id = SHELL("""" & program_name & """ x """ & pZipFile & """ -aoa -o""" & pToPath & """" & IIf(pPWD <> "", " -p" & pPWD, ""), vbHide)
    
    On Error GoTo 0

    ' Wait for the program to finish.
    ' Get the process handle.
    process_handle = OpenProcess(SYNCHRONIZE, 0, process_id)
    If process_handle <> 0 Then
        WaitForSingleObject process_handle, INFINITE
        CloseHandle process_handle
    End If
    PUB_UnZipFile2 = True
    Exit Function

ShellError:
    MsgBox " " & _
        program_name & vbCrLf & _
        Err.Description, vbOKOnly Or vbExclamation, _
        "Error"
End Function

'Added by Morgan 2020/7/30
'檢查重輸入的來函法限是否與2次確認的相同
Public Function PUB_ChkReKeyInOk(pIR01 As String, pIR02 As String, pIR03 As String, pIR04 As String, pCP07 As String, ByRef pIsSameDate As Boolean) As Boolean
   Dim stSQL As String, intQ As Integer, stCP07dc As String
   Dim RsQ As ADODB.Recordset
   
   PUB_ChkReKeyInOk = True
   pIsSameDate = False
   If pIR01 <> "" And pCP07 <> "" Then
      stSQL = "select ir20 from InputRecord where ir01=" & pIR01 & " and ir02=" & pIR02 & " and ir03='" & pIR03 & "' and ir04='" & pIR04 & "' and ir16='8' and ir20 is not null"
      intQ = 1
      Set RsQ = ClsLawReadRstMsg(intQ, stSQL)
      If intQ = 1 Then
         'Modified by Morgan 2020/9/16 重輸不管期限是否相同，都轉79075做2次確認
         'stCP07dc = PUB_GetDataFromText(RsQ(0), "法定期限：")
         'If DBDATE(pCP07) = DBDATE(stCP07dc) Then
         '   pIsSameDate = True
         'Else
         '   If MsgBox("本次輸入法限與2次確認輸入的不同，是否確定要繼續？" & vbCrLf & "若選「是」將會再次轉職代輸入！", vbExclamation + vbYesNo + vbDefaultButton2) = vbNo Then
         '      PUB_ChkReKeyInOk = False
         '   End If
         'End If
         pIsSameDate = True
         'end 2020/9/16
      End If
   End If
   
   Set RsQ = Nothing
End Function

'Added by Morgan 2020/7/29
'讀取字串內特定內容
'pText:待搜尋字串,pFieldName:欄位名,pEndMark:結束符號
Public Function PUB_GetDataFromText(pText As String, pFieldName As String, Optional pEndMark As String = ";") As String
   Dim iLen As Integer, iPos1 As Integer, iPos2 As Integer, strReturn As String
   iLen = Len(pFieldName)
   iPos1 = InStr(pText, pFieldName)
   If iPos1 > 0 Then
      iPos2 = InStr(iPos1 + iLen + 1, pText, pEndMark)
      If iPos2 > 0 Then
         strReturn = Mid(pText, iPos1 + iLen, iPos2 - iPos1 - iLen)
      End If
   End If
   PUB_GetDataFromText = strReturn
End Function

'Added by Morgan 2020/8/18
'取得EPC指定國註冊費相關期限
'pType:1 催審期限=領證期限(發證日)+4個月, 2 最終提申期限=領證期限(發證日)+3個月, 3 一般提申期限=領證期限(發證日)+2個月
'Modified by Morgan 2023/3/9 +pIs249 是否UP註冊(催審期限=領證期限(發證日)+2個月、最終提申期限=領證期限(發證日)+1個月，一般提申則以通用函數設定)
Public Function PUB_Get224CtrlDate(ByVal pType As Integer, ByRef pIssueDate As String, ByRef cp() As String, Optional pIs249 As Boolean = False) As String
   Dim stSQL As String, intQ As Integer, iMonth As Integer, iDays As Integer
   Dim rsQuery As ADODB.Recordset
   
   If pIssueDate = "" Then
      stSQL = "select nvl(pa21,cp07) dd from patent,caseprogress" & _
         " where pa01='" & cp(1) & "' and pa02='" & cp(2) & "' and pa03='" & cp(3) & "' and pa04='00'" & _
         " and cp01(+)=pa01 and cp02(+)=pa02 and cp03(+)=pa03 and cp04(+)=pa04 and cp10(+)='601'"
      intQ = 1
      Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
      If intQ = 1 Then
         pIssueDate = "" & rsQuery(0)
      End If
   End If
   If pIssueDate <> "" Then
      If pType = 1 Then
         If pIs249 Then
            iMonth = 2
         Else
            iMonth = 4
         End If
      ElseIf pType = 2 Then
         If pIs249 Then
            iMonth = 1
         Else
            iMonth = 3
         End If
      Else
         iMonth = 2
      End If
      If iDays > 0 Then
         PUB_Get224CtrlDate = CompDate(2, iDays, pIssueDate)
      Else
         PUB_Get224CtrlDate = CompDate(1, iMonth, pIssueDate)
      End If
   End If
End Function

'Added by Morgan 2021/4/29
Public Function PUB_IsB2NeedCourt(pLOS15 As String) As Boolean
   Dim stB2P As String, stB2T As String
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   
'Modified by Morgan 2022/9/19 改B2案源只有行政訴訟及參加訴訟才要扣5000+5000，其他的都不扣
'   stB2P = Pub_GetSpecMan("B2P")
'   stB2P = Replace(stB2P, "507", "") '行政訴訟上訴
'   stB2P = Replace(stB2P, "508", "") '行政訴訟上訴答辯
'   stB2P = Replace(stB2P, "243", "") '補書狀 Added by Morgan 2021/8/30 --郭雅娟
'
'   stB2T = Pub_GetSpecMan("B2T")
'   stB2T = Replace(stB2T, "408", "") '行政訴訟上訴
'   stB2T = Replace(stB2T, "410", "") '行政訴訟上訴答辯
   'Modified by Morgan 2022/11/9 再加準備程序,言詞辯論--秀玲/杜協理
   'stB2P = "503,506"
   'stB2T = "403,407"
   stB2P = "503,506,211,212"
   stB2T = "403,407,204,205"
   'end 2022/11/9
'end 2022/9/19

   stSQL = "select * from LawOfficeSource,caseprogress where los15='" & pLOS15 & "' and los02='B2'" & _
      " and cp162(+)=los15 and ( (cp01 in ('P','FCP') and instr('" & stB2P & "',cp10)>0) or (cp01 in ('T','FCT') and instr('" & stB2T & "',cp10)>0))"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      PUB_IsB2NeedCourt = True
   End If
   
End Function

'Added by Morgan 2020/9/29
'更新案源TT收文金額(智慧所收據)
Public Sub PUB_UpdateTTFee(pLOS15 As String)
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   Dim stLOS02 As String, stCP16 As String, stCP17 As String, stCP18 As String
   Dim stUpdate As String, bolCourtFee As Boolean
   
   '一般法律訴訟-分潤第1次(A1):15%智權,10%案源(規費)
   '一般法律訴訟-分潤第2次(A2):10%智權,5%案源(規費)
   '智財權/一般法律且非訴訟 (A3):全部回智慧所
   '智財權且訴訟(A4):法律所留15000律師費，其他全回智慧所
   'IP案 配合開庭(B1):法律所留15000律師費及相關規費，餘款全部回智慧所；P案-智慧所扣5000給專利處(規費)
   'IP案 行政訴訟(B2):法律所留5000律師費及規費，其他全部回智慧所；智慧所扣5000給商標部/專利處(規費)
   '                  B2例外:改只有行政訴訟及參加訴訟才要扣5000+5000，其他的都不扣 (2022/9/19 PUB_IsB2NeedCourt 控制)
   
   'Modified by Morgan 2020/10/12 若有其他出庭律師時也要扣律師費
   'Modified by Morgan 2021/4/29 B2專利商標之行政訴訟上訴或答辯都不扣5000律師費及5000出庭費
   'Modified by Morgan 2021/8/30 B2專利補書狀243也不用出庭但可能會跟客戶收費 Ex:P-087216
  'Modified by Morgan 2022/4/14 沒有費用也要更新(Ex:金額改0)
   'Modified by Morgan 2022/11/9 補收款要抓相關號的承辦律師
   'Modified by Morgan 2022/12/12 承辦人有在出庭律師檔時直接抓出庭費CL03
   'Modified by Morgan 2024/11/28 +casepropertymap.cpm12 判斷A類是否扣出庭費
   stSQL = "select * from (select los10,los02,sum(d.cp16-nvl(d.cp17,0)) SFee,max(e.cp01) PT" & _
      " from LAWOFFICESOURCE,caseprogress c,caseprogress d,caseprogress e" & _
      " where los15='" & pLOS15 & "' and c.cp09(+)=los06 and d.cp162(+)=los15 and d.cp01=c.cp01 and e.cp09(+)=los01 group by los10,los02) X" & _
      ",(select count(distinct cl02) OT,sum(CL03) CFee,max(decode(cl02,decode(x.cp01||x.cp10,'L78',y.cp14,'FCL997',y.cp14,x.cp14),'Y')) FNew" & _
      " from caseprogress x,caseprogress y,caselawer z where x.cp162='" & pLOS15 & "' and x.cp01 in ('L','FCL')" & _
      " and y.cp09(+)=x.cp43 and cl01=decode(x.cp01||x.cp10,'L78',y.cp09,'FCL997',y.cp09,x.cp09)) Y,(select max(cpm12) Z1" & _
      " from caseprogress,casepropertymap where cp162='" & pLOS15 & "' and cp01 in ('L','FCL') and cpm01(+)=cp01 and cpm02(+)=cp10 and cpm12(+)='220113') Z" & _
      " where los02<'C'"
      
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      With rsQuery
      stLOS02 = .Fields("LOS02")
      If stLOS02 = "A1" Then
         stCP16 = .Fields("SFee") * 0.25
         stCP17 = .Fields("SFee") * 0.1
      ElseIf stLOS02 = "A2" Then
         stCP16 = .Fields("SFee") * 0.15
         stCP17 = .Fields("SFee") * 0.05
      Else
         'modify by sonia 2022/9/22 L-888888未收費會錯誤
         'stCP16 = .Fields("SFee")
         stCP16 = Val("" & .Fields("SFee"))
         
         '律師費
         'Modfied by Lydia 2022/12/01 改成常數; 15000=> 非B2律師費, 5000=>B2律師費
         If stLOS02 = "A4" Or stLOS02 = "B1" Then
            'Added by Morgan 2022/12/12
            '承辦人有在出庭律師檔時直接抓出庭費CL03
            If .Fields("FNew") = "Y" Then
               stCP16 = stCP16 - .Fields("CFee")
            'Modified by Morgan 2024/11/28 規費科目220113的才要扣
            'Else
            ElseIf "" & .Fields("Z1") = "220113" Then
            'end 2024/11/28
            'end 2022/12/12
               stCP16 = stCP16 - 非B2律師費
            End If
         ElseIf stLOS02 = "B2" Then
            bolCourtFee = PUB_IsB2NeedCourt(pLOS15)
            If bolCourtFee = True Then
               'Added by Morgan 2022/12/12
               '承辦人有在出庭律師檔時直接抓出庭費CL03
               If .Fields("FNew") = "Y" Then
                  stCP16 = stCP16 - .Fields("CFee")
               Else
               'end 2022/12/12
                  stCP16 = stCP16 - B2律師費
               End If
            End If
         End If
         
         'Added by Morgan 2020/10/12 若有其他出庭律師時也要扣律師費
         'Modified by Morgan 2022/12/12 承辦人有在出庭律師檔時直接抓出庭費CL03
         'If .Fields("OT") > 0 Then
         If .Fields("OT") > 0 And IsNull(.Fields("FNew")) Then
         'end 2022/12/12
            'Modfied by Lydia 2022/12/01 改成常數; 15000=> 非B2律師費, 5000=>B2律師費
            If stLOS02 = "A4" Or stLOS02 = "B1" Then
               stCP16 = stCP16 - 非B2律師費 * .Fields("OT")
            ElseIf stLOS02 = "B2" Then
               If bolCourtFee = True Then
                  stCP16 = stCP16 - B2律師費 * .Fields("OT")
               End If
            End If
         End If
         'end 2020/10/12
         
         If stLOS02 = "B1" And .Fields("PT") = "P" Then
            stCP17 = 5000
         ElseIf stLOS02 = "B2" Then
            If bolCourtFee = True Then
               stCP17 = 5000
            Else
               stCP17 = 0
            End If
         Else
            stCP17 = 0
         End If
      End If
      stCP18 = Round((Val(stCP16) - Val(stCP17)) / 1000, 1)
      If stLOS02 = "A1" Or stLOS02 = "A2" Then
         stUpdate = ",cp20='',cp32=''"
      End If
      stSQL = "update caseprogress set cp16=" & stCP16 & ",cp17=" & stCP17 & ",cp18=" & stCP18 & stUpdate & " where cp09='" & .Fields("los10") & "'"
      cnnConnection.Execute stSQL, intQ
      End With
   End If
   
End Sub

'Added by Morgan 2020/9/30
'檢查法律案是否存在A1案源(不同審級視為相同案)
Public Function PUB_ChkExistA1Src(pLC01 As String, pLC02 As String) As Boolean
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   
   stSQL = "select 1 from caseprogress,LAWOFFICESOURCE where cp01='" & pLC01 & "' and cp02='" & pLC02 & "' and los06(+)=cp09 and los02='A1'"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      PUB_ChkExistA1Src = True
   End If
End Function

'Add By Sindy 2020/10/29 新增多案承辦單
'm_SubCP09 : 子案文號
'm_CP09 : 操作歷程的文號
Public Function PUB_InsChkWrkSht(m_SubCP09 As String, Optional stFileTime As String = "", _
   Optional m_CP09 As String = "") As Boolean
Dim rsA As New ADODB.Recordset
Dim strCP01 As String, strCP02 As String, strCP03 As String, strCP04 As String, strCP10 As String
Dim stFileName As String
Dim strCaseNo As String
   
   PUB_InsChkWrkSht = False
   If m_CP09 <> "" Then
      strSql = "select cp01,cp02,cp03,cp04 from caseprogress" & _
               " where cp09='" & m_CP09 & "'"
      If rsA.State = adStateOpen Then rsA.Close
      rsA.CursorLocation = adUseClient
      rsA.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      If rsA.RecordCount = 1 Then
         strCaseNo = rsA.Fields("cp01") & rsA.Fields("cp02") & IIf(rsA.Fields("cp03") & rsA.Fields("cp04") = "000", "", "-" & rsA.Fields("cp03") & "-" & rsA.Fields("cp04"))
      End If
      '程序歸卷時,操作歷程的文號要已發文,代表資料應都無誤是OK的
      strSql = "select cpp01,cpp10,cp10 from casepaperpdf,caseprogress" & _
               " where cpp01='" & m_CP09 & "' and cpp12='S'" & _
               " and instr(upper(cpp02),upper('" & EMP_多案承辦單 & "'))>0" & _
               " and cpp01=cp09(+) and cp27 is not null"
      If rsA.State = adStateOpen Then rsA.Close
      rsA.CursorLocation = adUseClient
      rsA.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      If rsA.RecordCount = 0 Then
         MsgBox "主歷程(" & strCaseNo & ")尚未發文歸卷，不可操作此案發文！", vbExclamation
         Exit Function
      End If
   End If
   
   strSql = "select * from caseprogress where cp09='" & m_SubCP09 & "'"
   If rsA.State = adStateOpen Then rsA.Close
   rsA.CursorLocation = adUseClient
   rsA.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If rsA.RecordCount > 0 Then
      strCP01 = rsA.Fields("cp01")
      strCP02 = rsA.Fields("cp02")
      strCP03 = rsA.Fields("cp03")
      strCP04 = rsA.Fields("cp04")
      strCP10 = rsA.Fields("cp10")
      '承辦單檔案名稱
      Call PUB_ChkEmpFlowFNMRule(strCP01 & "-" & strCP02 & "-" & strCP03 & "-" & strCP04, "", "Y", strCP10, stFileName, , False)
      stFileName = stFileName & "." & strCP10 & "." & EMP_多案承辦單
      stFileName = stFileName & ".menu"
      If Val(stFileTime) = 0 Then stFileTime = Right("000000" & ServerTime, 6)
      '以防重覆歸卷
      strSql = "delete from CasePaperPDF where cpp01='" & m_SubCP09 & "' and cpp02='" & stFileName & "'"
      cnnConnection.Execute strSql
      '新增一筆承辦單.menu至卷宗區
      strSql = "insert into casepaperpdf(cpp01,cpp02,cpp03,CPP05,CPP06,CPP07,cpp08,cpp09,cpp10,cpp12)" & _
               " values('" & m_SubCP09 & "'," & _
                       "'" & stFileName & "',0,'" & strUserNum & "'," & _
                       strSrvDate(1) & "," & stFileTime & "," & _
                       strSrvDate(1) & "," & stFileTime & ",'Y','S')"
      cnnConnection.Execute strSql, intI
   End If
   
   PUB_InsChkWrkSht = True
   Set rsA = Nothing
End Function

'Add By Sindy 2023/4/25 依收受者第1位判斷是否為CF案的Mail
'Modify By Sindy 2024/1/31 + , Optional ByVal bolManager As Boolean = True: 是否含主管
Public Function PUB_IPDept_IsCFMail(ByVal m_Sender As String _
   , Optional ByVal bolManager As Boolean = True) As Boolean

Dim rsTmp As New ADODB.Recordset
Dim varTemp As Variant
Dim jj As Integer
   
   PUB_IPDept_IsCFMail = False
'   'CFT、CFC和S非台灣案
'   If strCP01 <> "" Then
'      If strCP01 = "CFT" Or strCP01 = "CFC" Then
'         PUB_IPDept_IsCFMail = True
'         Exit Function
'      ElseIf strCP01 = "S" Then
'         strExc(0) = "select * from servicepractice where sp01='" & strCP01 & "' and sp02='" & strCP02 & "'" & _
'                     " and sp03='" & strCP03 & "' and sp04='" & strCP04 & "' and sp09<>'000'"
'         intI = 1
'         Set rsTmp = ClsLawReadRstMsg(intI, strExc(0))
'         If intI = 1 Then
'            PUB_IPDept_IsCFMail = True
'            Set rsTmp = Nothing
'            Exit Function
'         End If
'      End If
'   End If
   
   '依收受者判斷是否為CF案的Mail
   If m_Sender <> "" Then
      'm_Sender = Left(Trim(m_Sender), 5) '依收受者第1位判斷是否為CF案的Mail
      m_Sender = Replace(m_Sender, ",", ";")
      varTemp = Split(m_Sender, ";")
      For jj = 0 To UBound(varTemp)
         If varTemp(jj) <> "" Then
            strExc(0) = "Select st03,st01,st02,st05,Sl02,st16 組別代號,decode(st16,'2','英文組','4','日文組','6','CF案',st16) 組別,st70 小組,st04" & _
                        " From Staff, Staff_Level" & _
                        " Where st03 Like 'F1%' and st05=sl01(+)" & _
                        " and st01='" & varTemp(jj) & "'"
            'Modify By Sindy 2024/1/31
            If bolManager = False Then
               strExc(0) = strExc(0) & " and st16 in('6')"
            Else
            '2024/1/31 END
               '含主管
               strExc(0) = strExc(0) & " and (st16 in('6') or st01 in('80030','78011'))"
            End If
            intI = 1
            Set rsTmp = ClsLawReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               PUB_IPDept_IsCFMail = True
               Set rsTmp = Nothing
               Exit Function
            End If
         End If
      Next jj
   End If
   
   Set rsTmp = Nothing
End Function

'Modify By Sindy 2023/7/14
'IPDept 系統收件區 轉信 動作
Public Function PUB_IPDeptTransMail(ByVal strUser As String, ByVal GRD1 As Object, ByVal Check1 As Object, ByVal List1 As Object, _
   ByVal Frame1 As Object, ByVal m_AttachPath As String, ByVal strContext As String, ByRef intRunRow As Integer) As Boolean
   
Dim strUpdTime As String
Dim strFileName As String, strFullFileName As String
Dim bolConn As Boolean
Dim strTo As String, strCC As String
Dim strF2xEmp As String
Dim strF11Emp_CF As String, strF11Emp_FC As String 'Modify By Sindy 2023/7/12
Dim ArrStr As Variant, ArrStrIR04 As Variant
Dim strIR04 As String
Dim strUpd As String 'Add By Sindy 2023/5/12
Dim i As Integer, j As Integer, k As Integer
Dim strArrName As String, strArrType As String
Dim strOtherEmp As String
   
On Error GoTo ErrHand
   
   PUB_IPDeptTransMail = False
   Check1.Value = 0 '預設值 : Check1.Caption=轉寄後不顯示
   For i = 1 To GRD1.Rows - 1
      If GRD1.TextMatrix(i, 0) = "V" Then
         '新增收受者
         For j = 0 To List1.ListCount - 1
            '非外專承辦和外專程序和CFT人員收件人員,須轉寄Outlook先下載信件檔
            If PUB_GetST03(Left(Trim(List1.List(j)), 5)) <> "F22" And _
               PUB_GetST03(Left(Trim(List1.List(j)), 5)) <> "F23" And _
               PUB_IPDept_IsCFMail(Left(Trim(List1.List(j)), 5)) <> True Then
               '讀取檔案
               strFileName = Mid(GRD1.TextMatrix(i, 15), InStrRev(GRD1.TextMatrix(i, 15), "/") + 1)
               
               If PUB_UploadPatentLetterFile(GRD1.TextMatrix(i, 10), GRD1.TextMatrix(i, 16), GRD1.TextMatrix(i, 24), , strFullFileName, True) = False Then
                  MsgBox "下載檔案失敗，無法轉寄！", vbExclamation, "警告！"
                  Exit Function
               Else
                  Exit For
               End If
               
'               If GetAttachFile(grd1.TextMatrix(i, 10), grd1.TextMatrix(i, 11), grd1.TextMatrix(i, 16), strFullFileName, m_AttachPath & "\" & strFileName) = False Then
'                  MsgBox "下載檔案失敗，無法轉寄！", vbExclamation, "警告！"
'                  Exit Sub
'               Else
'                  Exit For
'               End If
            End If
         Next j
         
'         '檢查畫面上的物件是否含有Unicode文字
'         If PUB_ChkUniText(Me, True, True) = False Then
'            Exit Sub
'         End If
         
         Screen.MousePointer = vbHourglass
         cnnConnection.BeginTrans: bolConn = True
         strUpdTime = Right("000000" & ServerTime, 6)
         '清除主檔msg檔可刪除日期-轉寄就要恢復主檔的控管
         strExc(0) = "update IPDeptInput set " & _
                     " ii16=0" & _
                     " where Ii01=" & GRD1.TextMatrix(i, 10) & _
                       " and Ii02=" & GRD1.TextMatrix(i, 11) & _
                       " and Ii03='" & ChgSQL(GRD1.TextMatrix(i, 16)) & "' and nvl(ii16,0)>0"
         cnnConnection.Execute strExc(0), intI
         
         strTo = "": strCC = ""
         '新增收受者
         For j = 0 To List1.ListCount - 1
            ArrStr = Split(List1.List(j) & " ", " ") 'List1.List(j) & " ":加空白是為了收受者,確保陣列讀取有3個區間
''            If UBound(ArrStr) = 0 Then
''               strIR04 = Trim(List1.List(j))
''            Else
'               strIR04 = Trim(ArrStr(0))
'               'Add By Sindy 2023/3/31
'               If strIR04 = "外法群組" Or strIR04 = "代理人通知" Then
'                  strIR04 = Replace(Trim(ArrStr(1)), "國外部轉信", "")
'               End If
'               '2023/3/31 END
''            End If
            
            strArrName = Trim(ArrStr(1))
            strArrType = Trim(ArrStr(2))
            '檢查是否為特殊設定
            If Pub_GetSpecMan(strArrName) <> "" Then
               'Modify By Sindy 2023/11/15 新知、開拓不解析人員,和分信系統一樣直接Outlook送出
               If InStr(strArrName, "國外部轉信新知群組") > 0 Or _
                  InStr(strArrName, "國外部轉信開拓群組") > 0 Then
                  strIR04 = strArrName
               Else
               '2023/11/15 END
                  strIR04 = Pub_GetSpecMan(strArrName) '群組
               End If
            Else
               strIR04 = Trim(ArrStr(0))
            End If
            ArrStrIR04 = Split(strIR04, ";")
            For k = 0 To UBound(ArrStrIR04)
               strIR04 = ArrStrIR04(k)
               
               'Add By Sindy 2023/7/26 若為E-Mail則抓帳號即可
               If InStr(strIR04, "@") > 0 Then
                  strIR04 = Mid(strIR04, 1, InStr(strIR04, "@") - 1)
               End If
               '2023/7/26 END
               
               '檢查此收受者是否已存在
               strExc(0) = "select * from inputrecord" & _
                           " where IR01=" & GRD1.TextMatrix(i, 10) & _
                             " and IR03='" & ChgSQL(GRD1.TextMatrix(i, 16)) & "'" & _
                             " and IR04='" & strIR04 & "'"
               intI = 1
               Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
               If intI = 0 Then '尚無紀錄才新增
                  strExc(0) = "insert into inputrecord(IR01,IR02,IR03,IR04,IR11,IR12,IR13,IR14,IR24)" & _
                              " values(" & GRD1.TextMatrix(i, 10) & _
                                       "," & GRD1.TextMatrix(i, 11) & _
                                       ",'" & ChgSQL(GRD1.TextMatrix(i, 16)) & "'" & _
                                       ",'" & strIR04 & "'," & strSrvDate(1) & "," & _
                                       strUpdTime & ",'" & strUserNum & "'," & _
                                       CNULL(IIf(strUser <> strUserNum, strUser, "")) & _
                                       ",'" & IIf(InStr(strArrType, "(cc)") > 0, "Y", "") & "')"
                  cnnConnection.Execute strExc(0), intI
                  
                  '非外專承辦和外專程序和CFT人員收件人員
                  If PUB_GetST03(strIR04) <> "F22" And _
                     PUB_GetST03(strIR04) <> "F23" And _
                     PUB_IPDept_IsCFMail(IIf(Pub_GetSpecMan(strIR04) <> "", Pub_GetSpecMan(strIR04), strIR04)) <> True Then
                     
                     '再檢查一次信件檔案是否存在
                     If strFileName = "" Then
                        strFileName = Mid(GRD1.TextMatrix(i, 15), InStrRev(GRD1.TextMatrix(i, 15), "/") + 1)
                        If Dir(m_AttachPath & "\" & strFileName) = "" Then
                           If PUB_UploadPatentLetterFile(GRD1.TextMatrix(i, 10), GRD1.TextMatrix(i, 16), GRD1.TextMatrix(i, 24), , strFullFileName, True) = False Then
                              MsgBox "下載檔案失敗，無法轉寄！", vbExclamation, "警告！"
                              Exit Function
                           Else
                              Exit For
                           End If
         '                  If GetAttachFile(grd1.TextMatrix(i, 10), grd1.TextMatrix(i, 11), grd1.TextMatrix(i, 16), strFullFileName, m_AttachPath & "\" & strFileName) = False Then
         '                     MsgBox "下載檔案失敗，無法轉寄！", vbExclamation, "警告！"
         '                     Exit Sub
         '                  Else
         '                     Exit For
         '                  End If
                        End If
                     End If
                     
                     strUpd = strUpd & ";" & strIR04 '記錄特殊群組,後面程式段才能上確認日期 Add By Sindy 2023/5/12
                     '是否為副本
                     If InStr(strArrType, "(cc)") > 0 Then
                        If strCC <> "" Then strCC = strCC & ";"
                        '檢查是否為特殊設定
                        If Pub_GetSpecMan(strIR04) <> "" Then
                           strCC = strCC & Pub_GetSpecMan(strIR04) '群組
                        Else
                           strCC = strCC & strIR04
                        End If
                     Else
                        If strTo <> "" Then strTo = strTo & ";"
                        '檢查是否為特殊設定
                        If Pub_GetSpecMan(strIR04) <> "" Then
                           strTo = strTo & Pub_GetSpecMan(strIR04) '群組
                        Else
                           strTo = strTo & strIR04
                        End If
                        'Add By Sindy 2023/7/12 正本收受者
                        If PUB_GetST03(strIR04) = "F11" Then
                           strF11Emp_FC = strF11Emp_FC & ",'" & UCase(strIR04) & "'"
                        End If
                        '2023/7/12 END
                     End If
                     
                  '進系統收件區人員
                  Else
                     '寫入要發通知信的人員
                     'CaseUseMemo:
                     'cum01 = 0
                     'cum02 = 收受者
                     'cum03 = 0
                     'cum04 = 0
                     'cum05 = 02.信件轉寄通知信
                     'cum06 = 操作人員
                     strExc(0) = "select cum02 from CaseUseMemo" & _
                                 " where cum05='02'" & _
                                   " and cum06=" & CNULL(strUserNum) & _
                                   " and cum02=" & CNULL(strIR04)
                     intI = 1
                     Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
                     If intI = 0 Then
                        strExc(0) = "insert into CaseUseMemo(cum01,cum02,cum03,cum04,cum05)" & _
                                    " values('0','" & strIR04 & "','0','0','02')"
                        cnnConnection.Execute strExc(0), intI
                        Frame1.Visible = True '*****
                     End If
                     'Modify By Sindy 2025/3/14
'                     If PUB_GetST03(strIR04) = "F23" Then
'                        strF23Emp = strF23Emp & ",'" & UCase(strIR04) & "'"
                     If PUB_GetST03(strIR04) = "F23" Or PUB_GetST03(strIR04) = "F22" Then
                        strF2xEmp = strF2xEmp & ",'" & UCase(strIR04) & "'"
                     '2025/3/14 END
                     ElseIf PUB_GetST03(strIR04) = "F11" Then
                        strF11Emp_CF = strF11Emp_CF & ",'" & UCase(strIR04) & "'"
                     Else
                        strOtherEmp = strOtherEmp & ",'" & UCase(strIR04) & "'"
                     End If
                  End If
               End If
            Next k
         Next j
         'Modify By Sindy 2025/3/14
         'If strF23Emp <> "" Then strF23Emp = Mid(strF23Emp, 2)
         If strF2xEmp <> "" Then strF2xEmp = Mid(strF2xEmp, 2)
         '2025/3/14 END
         If strF11Emp_CF <> "" Then strF11Emp_CF = Mid(strF11Emp_CF, 2)
         If strF11Emp_FC <> "" Then strF11Emp_FC = Mid(strF11Emp_FC, 2) 'Add By Sindy 2023/7/12
         If strOtherEmp <> "" Then strOtherEmp = Mid(strOtherEmp, 2)
         
         '轉寄外單位時,Outlook信件只轉寄一封,收受者可為多人
         If strTo = "" And strCC <> "" Then strTo = strCC
         If strTo <> "" Then
            'Add By Sindy 2023/7/14
            strExc(10) = ""
            'Modify By Sindy 2025/3/14
            If strF2xEmp <> "" Or strF11Emp_CF <> "" Or strF11Emp_FC <> "" Or strOtherEmp <> "" Then
               If strF2xEmp <> "" Then strExc(10) = IIf(strExc(10) <> "", strExc(10) & ",", "") & PUB_ReadUserData(Replace(strF2xEmp, "'", ""))
               If strF11Emp_CF <> "" Then strExc(10) = IIf(strExc(10) <> "", strExc(10) & ",", "") & PUB_ReadUserData(Replace(strF11Emp_CF, "'", ""))
               If strOtherEmp <> "" Then strExc(10) = IIf(strExc(10) <> "", strExc(10) & ",", "") & PUB_ReadUserData(Replace(strOtherEmp, "'", ""))
               If strExc(10) <> "" Then
                  strContext = "同時信件已分給下列人員：" & strExc(10) & vbCrLf & vbCrLf & strContext
               End If
            End If
            '2023/7/14 END
            
            '轉寄Outlook並且該收受者上刪除日期時間人員
            PUB_SendMail strUserNum, strTo, "", GRD1.TextMatrix(i, 5), _
                  IIf(Trim(strContext) <> "", strContext, vbCrLf & "信件內容參附件！"), , strFullFileName, , , , strCC, , , , , , , , , , , , , , , , , , "1"
            If bolMailSendOk = False Then GoTo ErrHand
            '該收受者上刪除日期時間人員
            strExc(0) = "update InputRecord set " & _
                        " ir08=" & strSrvDate(1) & ",ir09=" & strUpdTime & ",ir10='" & strUserNum & "'" & _
                        " where ir01=" & GRD1.TextMatrix(i, 10) & _
                          " and ir02=" & GRD1.TextMatrix(i, 11) & _
                          " and ir03='" & ChgSQL(GRD1.TextMatrix(i, 16)) & "'" & _
                          " and ir04 in('" & Replace(strTo, ";", "','") & IIf(strCC <> "", "','" & Replace(strCC, ";", "','"), "") & "')" & _
                          " and ir08=0"
            cnnConnection.Execute strExc(0), intI
            'Add By Sindy 2023/5/12 記錄特殊群組,後面程式段才能上確認日期
            If strUpd <> "" Then
               strUpd = Mid(strUpd, 2)
               strExc(0) = "update InputRecord set " & _
                           " ir08=" & strSrvDate(1) & ",ir09=" & strUpdTime & ",ir10='" & strUserNum & "'" & _
                           " where ir01=" & GRD1.TextMatrix(i, 10) & _
                             " and ir02=" & GRD1.TextMatrix(i, 11) & _
                             " and ir03='" & ChgSQL(GRD1.TextMatrix(i, 16)) & "'" & _
                             " and ir04 in('" & Replace(strUpd, ";", "','") & "')" & _
                             " and ir08=0"
               cnnConnection.Execute strExc(0), intI
            End If
            '2023/5/12 END
         End If
         
         'Modify By Sindy 2025/3/14 轉寄機制外專程序組同外專承辦組規則
'         '程序人員轉寄後該筆結束,由另一位人員接手處理信件
'         If Pub_StrUserSt03 = "F22" Then
'            Check1.Value = 1 '程序轉寄要上刪除日期
'            strExc(0) = "update InputRecord set " & _
'                        " ir08=" & strSrvDate(1) & ",ir09=" & strUpdTime & ",ir10='" & strUserNum & "'" & _
'                        " where ir01=" & GRD1.TextMatrix(i, 10) & _
'                          " and ir02=" & GRD1.TextMatrix(i, 11) & _
'                          " and ir03='" & ChgSQL(GRD1.TextMatrix(i, 16)) & "'" & _
'                          " and upper(ir04)=upper('" & ChgSQL(GRD1.TextMatrix(i, 13)) & "')" & _
'                          " and ir08=0"
'            cnnConnection.Execute strExc(0), intI
'
         '承辦組轉寄承辦組人員時,其他人上確認日期時間人員,只留轉寄收受者處理信件
         If (PUB_GetST03(strUser) = "F23" Or PUB_GetST03(strUser) = "F22") And strF2xEmp <> "" Then
            strExc(0) = "update InputRecord set " & _
                        " ir08=" & strSrvDate(1) & ",ir09=" & strUpdTime & ",ir10='" & strUserNum & "'" & _
                        " where ir01=" & GRD1.TextMatrix(i, 10) & _
                          " and ir02=" & GRD1.TextMatrix(i, 11) & _
                          " and ir03='" & ChgSQL(GRD1.TextMatrix(i, 16)) & "'" & _
                          " and upper(ir04) not in(" & strF2xEmp & ")" & _
                          " and exists(select st01 from staff where st01=ir04 and st03='" & PUB_GetST03(strUser) & "')" & _
                          " and ir08=0"
            cnnConnection.Execute strExc(0), intI
            Check1.Value = 1 '上刪除日期:該筆資料要消失
            
         '外商承辦組
         ElseIf PUB_GetST03(strUser) = "F11" Then
            'CF承辦組轉寄該組人員時,其他人上確認日期時間人員,只留轉寄收受者處理信件
            If strF11Emp_CF <> "" Then
               strExc(0) = "update InputRecord set " & _
                           " ir08=" & strSrvDate(1) & ",ir09=" & strUpdTime & ",ir10='" & strUserNum & "'" & _
                           " where ir01=" & GRD1.TextMatrix(i, 10) & _
                             " and ir02=" & GRD1.TextMatrix(i, 11) & _
                             " and ir03='" & ChgSQL(GRD1.TextMatrix(i, 16)) & "'" & _
                             " and upper(ir04) not in(" & strF11Emp_CF & ")" & _
                             " and exists(select st01 from staff where st01=ir04 and st03='F11')" & _
                             " and ir08=0"
               cnnConnection.Execute strExc(0), intI
               Check1.Value = 1 '上刪除日期:該筆資料要消失
               
            'Add By Sindy 2023/7/12
            '洪經理說FC案經與葉副理討論後,轉寄FC同仁時請直接示為不處理沖銷,處理原因為:交由收件者之承辦人處理
            ElseIf strF11Emp_FC <> "" Then
               '操作人
               'Modify By Sindy 2025/8/28 琬姿反應系統收件區轉寄時,系統上處理結果建議改為 已處理 較符合狀況
               '   ir16='2'==>ir16='5'
               strExc(0) = "update InputRecord set " & _
                           " ir16='5',ir17=" & strSrvDate(1) & ",ir18=" & strUpdTime & ",ir19='" & strUserNum & "'" & _
                           ",ir08=" & strSrvDate(1) & ",ir09=" & strUpdTime & ",ir10='" & strUserNum & "'" & _
                           ",IR20='交由收件者之承辦人處理'" & _
                           " where ir01=" & GRD1.TextMatrix(i, 10) & _
                             " and ir02=" & GRD1.TextMatrix(i, 11) & _
                             " and ir03='" & ChgSQL(GRD1.TextMatrix(i, 16)) & "'" & _
                             " and upper(ir04)=upper('" & ChgSQL(GRD1.TextMatrix(i, 13)) & "')" & _
                             " and ir08=0"
               cnnConnection.Execute strExc(0), intI
               '更新主檔處理結果(尚是空白或歸卷)
               'Modify By Sindy 2025/8/28 琬姿反應系統收件區轉寄時,系統上處理結果建議改為 已處理 較符合狀況
               '   ii29='8'==>ii29='12'
               strExc(0) = "update IPDeptInput set ii29='12'" & _
                           " where ii01=" & GRD1.TextMatrix(i, 10) & _
                             " and ii02=" & GRD1.TextMatrix(i, 11) & _
                             " and ii03='" & ChgSQL(GRD1.TextMatrix(i, 16)) & "'" & _
                             " and (ii29 is null or ii29='11')"
               cnnConnection.Execute strExc(0), intI
               '其他外商人員
               strExc(0) = "update InputRecord set " & _
                           " ir08=" & strSrvDate(1) & ",ir09=" & strUpdTime & ",ir10='" & strUserNum & "'" & _
                           " where ir01=" & GRD1.TextMatrix(i, 10) & _
                             " and ir02=" & GRD1.TextMatrix(i, 11) & _
                             " and ir03='" & ChgSQL(GRD1.TextMatrix(i, 16)) & "'" & _
                             " and exists(select st01 from staff where st01=ir04 and st03='F11')" & _
                             " and ir08=0"
               cnnConnection.Execute strExc(0), intI
               Check1.Value = 1 '上刪除日期:該筆資料要消失
            End If
            '2023/7/12 END
         End If
         
         intRunRow = i '回傳執行的資料列數
         'Call SaveInputRecord(i, False)
         cnnConnection.CommitTrans: bolConn = False
         
'         If Left(grd1.TextMatrix(i, 3), 1) <> "*" Then
'            grd1.TextMatrix(i, 3) = "*" & grd1.TextMatrix(i, 3)
'         End If
         
'         If Check1.Value = 1 Then '上刪除日期
'            LblTotCnt.Caption = "總筆數: " & Val(Replace(LblTotCnt.Caption, "總筆數:", "")) - 1
'            'Call CancelRowColor(i) '清除反白
'            grd1.RowHeight(i) = 0
'         End If
         
         PUB_IPDeptTransMail = True
      End If
   Next i
   Screen.MousePointer = vbDefault
   
   '清除收受者
'   cboII06.Text = ""
'   cboCC.Text = "" '副本
   List1.Clear
   List1.Tag = ""
   
   Exit Function
   
ErrHand:
   If bolConn = True Then cnnConnection.RollbackTrans
   Screen.MousePointer = vbDefault
   MsgBox "轉寄失敗！" & vbCrLf & Err.Description & vbCrLf & vbCrLf & strExc(0)
End Function

'Add By Sindy 2022/6/22 外專信件沖銷機制
'注意: 這個函數外專承辦,程序組都會使用到;要共同考慮
'Modify By Sindy 2023/2/24 Sub改為Function
'Modified by Lydia 2023/05/18 是否開啟Outlook草稿 pOpenFile
Public Function PUB_IPDeptEMailF2UptRec(pIR01 As String, pIR02 As String, pIR03 As String, pIR04 As String, pFrmName As String, _
   pIR16 As String, strUpdTime As String, Optional pCRecNo As String = "", Optional pOpenFile As Boolean = True) As Boolean
Dim rsA As New ADODB.Recordset
Dim strIR22 As String
Dim strII27 As String '信件主檔的處理結果
Dim bolSysDel As Boolean '是否自沖
Dim strFileName As String
Dim strCP01 As String, strCP02 As String, strCP03 As String, strCP04 As String 'Add By Sindy 2022/8/5
Dim strBill As String, strCP10 As String, strPA46 As String 'Add By Sindy 2022/9/14
   
   PUB_IPDeptEMailF2UptRec = False 'Add By Sindy 2023/2/24
   
   'Add By Sindy 2023/2/24 檢查信件是否已被上確認日期,若有,確認人員又不是自己代表有人同時再進行操作
   'If pIR04 = strUserNum Then
      strExc(0) = "select ir01,ir08,ir10,ir19,ir22,st02 from InputRecord,staff" & _
                  " where ir01=" & pIR01 & " and ir02=" & pIR02 & " and ir03='" & pIR03 & "' and ir04='" & pIR04 & "'" & _
                    " and ir10=st01(+)"
      intI = 1
      Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
      If intI = 1 Then
         If Val(RsTemp.Fields("ir08")) > 0 Then
            If "" & RsTemp.Fields("ir10") <> strUserNum Then
               MsgBox "此信件 (" & RsTemp.Fields("st02") & ") 已操作，請確認！"
               Exit Function
            End If
         End If
      End If
   'End If
   '2023/2/24 END
   
   bolSysDel = False
   
   If pCRecNo <> "" Then
      strExc(0) = "select * from caseprogress" & _
                  " where cp09='" & pCRecNo & "'"
      intI = 1
      Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
      If intI = 1 Then
         strCP01 = RsTemp.Fields("cp01")
         strCP02 = RsTemp.Fields("cp02") 'Add By Sindy 2022/9/14
         strCP03 = RsTemp.Fields("cp03") 'Add By Sindy 2022/9/14
         strCP04 = RsTemp.Fields("cp04") 'Add By Sindy 2022/9/14
         strCP10 = RsTemp.Fields("cp10")
         'Add By Sindy 2022/9/14
         '帳單
         If "" & RsTemp.Fields("cp61") <> "" Then
            strBill = "" & RsTemp.Fields("cp61") & IIf("" & RsTemp.Fields("cp62") <> "", "、" & "" & RsTemp.Fields("cp62"), "") & IIf("" & RsTemp.Fields("cp63") <> "", "、" & "" & RsTemp.Fields("cp63"), "") & IIf("" & RsTemp.Fields("cp87") <> "", "、" & "" & RsTemp.Fields("cp87"), "") & IIf("" & RsTemp.Fields("cp88") <> "", "、" & "" & RsTemp.Fields("cp88"), "")
         Else
            strBill = ""
         End If
         '2022/9/14 END
      End If
   End If
   
   'Add By Sindy 2022/9/14 是否PCT案件
   If strCP01 & strCP02 & strCP03 & strCP04 <> "" Then
      strExc(0) = "select pa46 from patent" & _
                  " where pa01='" & strCP01 & "' and pa02='" & strCP02 & "' and pa03='" & strCP03 & "' and pa04='" & strCP04 & "'"
      intI = 1
      Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
      If intI = 1 Then
         strPA46 = "" & RsTemp.Fields("pa46")
      End If
   End If
   '2022/9/14 END
   
   If Pub_StrUserSt03 = "F23" And UCase(pFrmName) = "FRM010001" Then
      bolSysDel = True
      strII27 = "1" '舊案收文
      
   ElseIf UCase(pFrmName) = "多案收文" Then
      bolSysDel = True
      strII27 = "2" '多案收文
      
   ElseIf UCase(pFrmName) = "FRM060504" Then
      bolSysDel = True
      strII27 = "3" '新案命名
      
   ElseIf UCase(pFrmName) = "FRM060120" Then
      bolSysDel = True
      strII27 = "4" '客戶提供文件
      
   ElseIf UCase(pFrmName) = "不續辦或閉卷" Then
      strII27 = "5" '不續辦或閉卷
      'Modify By Sindy 2025/5/6 FC結案單上線後不續辦或閉卷改自沖
      If strSrvDate(1) >= FCP結案單電子化啟用日 Then
         bolSysDel = True
      End If
      '2025/5/6 END
      
   ElseIf UCase(pFrmName) = "FRM140404" Then
      strII27 = "6" '往來記錄
      
   ElseIf pIR16 = "9" Then '回信
      If PUB_GetST03(strUserNum) = "F23" Then
         strII27 = "7" '承辦作業
      Else
         strII27 = "10" '回信
      End If
   ElseIf pIR16 = "2" Then '不處理
      strII27 = "8"
   ElseIf pIR16 = "5" Then '已處理
      strII27 = "12"
   ElseIf pIR16 = "1" Then '輸入
      '申請案號輸入,已收達/已提申,翻譯完稿輸入:自動沖銷; 其他均要待二級主管核准後再沖銷。
      'Modify By Sindy 2022/9/14 將PCT案的(第2次申請案號輸入1101.通知申請案號)、及已提申(不分是否PCT案)無U帳單產生
      '                          的案件皆走二次核對,不自沖
      'If UCase(pFrmName) = "FRM04010401" Or UCase(pFrmName) = "FRM04010507_1" Or UCase(pFrmName) = "FRM060107" Then
      If (UCase(pFrmName) = "FRM04010401" And Not (strPA46 = "Y" And strCP10 = "1101")) Or _
         (UCase(pFrmName) = "FRM04010507_1" And strBill <> "") Or _
         UCase(pFrmName) = "FRM060107" Then
         bolSysDel = True
      End If
      strII27 = "9"
   Else
      strII27 = ""
   End If
   
   '承辦組有人操作動作,其他未處理承辦組的收受者一併沖銷(主核後面程式會判斷)
   If Pub_StrUserSt03 = "F23" Then
      strSql = "update InputRecord set ir08=" & strSrvDate(1) & ",ir09=" & strUpdTime & ",ir10='" & strUserNum & "'" & _
               " where ir01=" & pIR01 & " and ir02=" & pIR02 & " and ir03='" & pIR03 & "' and ir08=0" & _
               " and exists(select st01 from staff where st01=ir04 and st03='F23')"
      cnnConnection.Execute strSql, intI
   End If
   
   '自沖
   If bolSysDel = True Then
      strExc(0) = "select ir01 from InputRecord" & _
                  " where ir01=" & pIR01 & _
                    " and ir02=" & pIR02 & _
                    " and ir03='" & pIR03 & "'" & _
                    " and ir08=0"
      intI = 1
      Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
      If intI = 0 Then
         '上Msg檔可刪除日期
         strSql = "update IPDeptInput set ii16=" & strSrvDate(1) & _
                  " where ii01=" & pIR01 & " and ii02=" & pIR02 & " and ii03='" & pIR03 & "' and ii16=0"
         cnnConnection.Execute strSql, intI
      End If
      
   '外專承辦或不處理或程序組輸入作業,需要主管核准才沖消
   'Add By Sindy 2022/8/12 敏莉:已處理需要主管核准才沖消
   '主核:
   ElseIf Pub_StrUserSt03 = "F23" Or _
      (pIR16 = "2" And InStr(Pub_GetSpecMan("外專程序不處理不需主核名單"), pIR04) = 0) Or _
      (pIR16 = "5" And InStr(Pub_GetSpecMan("外專程序已處理不需主核名單"), pIR04) = 0) Or _
      (pIR16 = "1" And Pub_StrUserSt03 = "F22") Then
      strExc(10) = ""
      '取得二級主管
      strExc(10) = PUB_GetFCPProSup(pIR04)
      If strExc(10) <> "" Then
         strIR22 = strExc(10)
         'Add By Sindy 2023/12/12 淑華提,系統收件區判發流程，
         '當案件的判發主管又是操作人員自己狀況，案件的判發人請跳過操作人員自己判發人應再住上一層主管 (至第3級主管)
         If Pub_StrUserSt03 = "F22" And strIR22 = strUserNum Then
            strSql = "select st53 from staff where st01='" & pIR04 & "' and st53 is not null"
            CheckOC3
            With AdoRecordSet3
               .CursorLocation = adUseClient
               .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
               If .RecordCount > 0 Then
                  strIR22 = .Fields("st53")
               End If
            End With
         End If
         '2023/12/12 END
      'Modify By Sindy 2025/10/14 預設值
      Else
         strIR22 = GetDeptMan(Pub_StrUserSt03)
      '2025/10/14 END
      End If
      '因為要主核,所以該收受者信件加註確認人員,拿掉確認日期時間人員
      strSql = "update InputRecord set ir08=0,ir09=null,ir10=null,ir22='" & strIR22 & "'" & _
               " where ir01=" & pIR01 & " and ir02=" & pIR02 & " and ir03='" & pIR03 & "' and ir04='" & pIR04 & "'"
      cnnConnection.Execute strSql, intI
   End If
   
   '有傳入文號,代表要歸卷
   If pCRecNo <> "" Then
      '檢查卷宗區是否已有此信件,若有,無需重覆歸卷
      strFileName = "." & pIR01 & Format(pIR02, "0#####") & "." & pIR03 & "."
      strExc(0) = "select count(*) from casepaperpdf" & _
                  " where instr(cpp02,'" & strFileName & "')>0" & _
                    " and cpp01='" & pCRecNo & "'"
      intI = 1
      strExc(10) = ""
      Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
      If intI = 1 Then
         If RsTemp.Fields(0) > 0 Then
            strExc(10) = "Y"
         End If
      End If
      If strExc(10) = "" Then
         '下載信件檔,上傳卷宗區
         '敏莉說,程序組且系統別P,PS的歸卷,副檔名為代理人來函
         Call PUB_UploadPatentLetterFile(pIR01, pIR03, pCRecNo, IIf(Pub_StrUserSt03 = "F22" And (strCP01 = "P" Or strCP01 = "PS"), "ALTR", ""))
         'Modify By Sindy 2022/8/18 記錄歸檔文號
         strSql = "update InputRecord set ir21='" & pCRecNo & "'" & _
                  " where ir01=" & pIR01 & " and ir02=" & pIR02 & " and ir03='" & pIR03 & "' and ir04='" & pIR04 & "'"
         cnnConnection.Execute strSql, intI
         '2022/8/18 END
      End If
      
      '外專程序組輸入信件後的Outlook草稿
      'Modified by Lydia 2023/05/18 +是否開啟Outlook草稿 pOpenFile
      If Pub_StrUserSt03 = "F22" And pOpenFile = True Then
         Call PUB_RecvOutLookF22(pIR01, pIR02, pIR03, pIR04, pFrmName, pCRecNo)
      End If
   End If
   
   '更新信件主檔的處理結果
   If strII27 <> "" Then
      'Modify By Sindy 2023/5/31 + and (ii27 is null or ii27='11')
      strSql = "update IPDeptInput set ii27='" & strII27 & "'" & _
               " where ii01=" & pIR01 & " and ii02=" & pIR02 & " and ii03='" & pIR03 & "' and (ii27 is null or ii27='11')"
      cnnConnection.Execute strSql, intI
      'Add By Sindy 2023/7/25 轉寄後再次沖銷
      If intI = 0 Then
         strExc(0) = "select ir01,ii27 from inputrecord,IPDeptInput" & _
                     " where ir01=" & pIR01 & " and ir02=" & pIR02 & " and ir03='" & pIR03 & "' and ir04='" & pIR04 & "' and ir13<>'QPGMR' and ir22 is null" & _
                     " and ir01=ii01 and ir03=ii03"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            strExc(10) = "" & RsTemp.Fields("ii27")
            strSql = "update IPDeptInput set ii27='" & strII27 & "'" & _
                     " where ii01=" & pIR01 & " and ii02=" & pIR02 & " and ii03='" & pIR03 & "'"
            cnnConnection.Execute strSql, intI
            If strExc(10) <> strII27 Then
               PUB_SendMail strUserNum, "97038", "", "轉寄後再次沖銷(尚在檢查狀況用<11=歸卷 7=承辦作業 10=回信>) 舊的處理原因=" & strExc(10) & " 新的處理原因=" & strII27, strSql, , , , , , , , , , True
            End If
         End If
      End If
      '2023/7/25 END
   End If
   
   Set rsA = Nothing
   PUB_IPDeptEMailF2UptRec = True 'Add By Sindy 2023/2/24
End Function

'Add By Sindy 2016/9/21
'EMail來函收文更新郵件轉信讀取記錄
'Modified by Morgan 2020/7/20 +pCRecNo:來函收文號(以輸入人員抓職代設定重複確認人員),pReKeyInOK:來函期限是否與2次確認相同
'Modify By Sindy 2022/5/28 + , Optional pIR20Note As String = ""
'Modified by Lydia 2023/05/18 是否開啟Outlook草稿 pOpenFile
Public Sub PUB_UpdateEMailRec(pIR01 As String, pIR02 As String, pIR03 As String, pIR04 As String, pFrmName As String, _
   Optional pCRecNo As String, Optional pReKeyInOK As Boolean = False, Optional pIR20Note As String = "", Optional pOpenFile As Boolean = True)
   
Dim strUpdTime As String
'Added by Morgan 2020/7/29
Dim strIR22 As String, RsQ As ADODB.Recordset
Dim strIR20 As String
   
   strUpdTime = Right("000000" & ServerTime, 6)
   
   'Modify By Sindy 2022/5/28 增加可以加註內容
   strIR20 = pFrmName
   If pIR20Note <> "" Then
      strSql = "select * From form where FO01='" & pFrmName & "'"
      intI = 1
      Set RsQ = ClsLawReadRstMsg(intI, strSql)
      If intI = 1 Then
         strIR20 = "" & RsQ.Fields("Fo02") '作業名稱
      End If
      strIR20 = strIR20 & "; " & pIR20Note '作業名稱+備註
   End If
   '2022/5/28 END
   
   'IR16=1.輸入
   'Add By Sindy 2022/6/27 + 外專信件
   If Left(Pub_StrUserSt03, 2) = "F2" Then
      'Modified by Morgan 2023/4/12 +ir21
      strSql = "update InputRecord set ir08=" & strSrvDate(1) & ",ir09=" & strUpdTime & ",ir10='" & strUserNum & "'" & _
               ",ir17=" & strSrvDate(1) & ",ir18=" & strUpdTime & ",ir19='" & strUserNum & "'" & _
               ",ir16='1',ir20='" & strIR20 & "'" & IIf(pCRecNo <> "", ",ir21='" & pCRecNo & "'", "") & _
               " where ir01=" & pIR01 & " and ir02=" & pIR02 & " and ir03='" & pIR03 & "' and ir04='" & pIR04 & "' and ir08=0"
      cnnConnection.Execute strSql, intI
      
      '外專信件沖銷機制
      'Modified by Lydia 2023/05/18 +pOpenFile
      Call PUB_IPDeptEMailF2UptRec(pIR01, pIR02, pIR03, pIR04, pFrmName, "1", strUpdTime, pCRecNo, pOpenFile)
      
   'Add By Sindy 2023/4/24 + 外商信件
   ElseIf Left(Pub_StrUserSt03, 2) = "F1" Then
      strSql = "update InputRecord set ir08=" & strSrvDate(1) & ",ir09=" & strUpdTime & ",ir10='" & strUserNum & "'" & _
               ",ir17=" & strSrvDate(1) & ",ir18=" & strUpdTime & ",ir19='" & strUserNum & "'" & _
               ",ir16='1',ir20='" & strIR20 & "'" & IIf(pCRecNo <> "", ",ir21='" & pCRecNo & "'", "") & _
               " where ir01=" & pIR01 & " and ir02=" & pIR02 & " and ir03='" & pIR03 & "' and ir04='" & pIR04 & "' and ir08=0"
      cnnConnection.Execute strSql, intI
      
      '外商信件沖銷機制
      Call PUB_IPDeptEMailF1UptRec(pIR01, pIR02, pIR03, pIR04, pFrmName, "1", strUpdTime, pCRecNo)
      
   'Modify By Sindy 2023/7/17 + 內商人員的信件,未有”有期限來函轉職代作2次確認”直接輸入沖銷 + Or Left(Pub_StrUserSt03, 2) = "P2"
   ElseIf pCRecNo = "" Or Left(Pub_StrUserSt03, 2) = "P2" Then  'Added by Morgan 2020/7/29
   '2022/6/27 END
      strSql = "update InputRecord set ir08=" & strSrvDate(1) & ",ir09=" & strUpdTime & ",ir10='" & strUserNum & "'" & _
               ",ir17=" & strSrvDate(1) & ",ir18=" & strUpdTime & ",ir19='" & strUserNum & "'" & _
               ",ir16='1',ir20='" & strIR20 & "'" & _
               " where ir01=" & pIR01 & " and ir02=" & pIR02 & " and ir03='" & pIR03 & "' and ir04='" & pIR04 & "' and ir08=0"
      cnnConnection.Execute strSql, intI
         
      '上Msg檔可刪除日期
      'Modify By Sindy 2023/4/24 PatentInput應該也要檢查
      strExc(0) = "select ir01 from InputRecord" & _
                  " where ir01=" & pIR01 & _
                    " and ir02=" & pIR02 & _
                    " and ir03='" & pIR03 & "'" & _
                    " and ir08=0"
      intI = 1
      Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
      If intI = 0 Then
      '2023/4/24 END
         'Modify By Sindy 2022/7/28
         If Left(pIR03, 1) = "T" Then
            strExc(0) = "update TMInput set" & _
                        " Ti16=" & strSrvDate(1) & _
                        " where Ti01=" & pIR01 & _
                          " and Ti02=" & pIR02 & _
                          " and Ti03='" & pIR03 & "'" & _
                          " and Ti16=0"
            cnnConnection.Execute strExc(0)
         Else
         '2022/7/28 END
            strSql = "update PatentInput set pi16=" & strSrvDate(1) & _
                     " where pi01=" & pIR01 & " and pi02=" & pIR02 & " and pi03='" & pIR03 & "' and pi16=0"
            cnnConnection.Execute strSql, intI
         End If
      End If
      
   'Added by Morgan 2020/7/29 有期限來函轉職代作2次確認
   Else
      'Add By Sindy 2023/7/13 加部門判斷,僅專利處使用
      If Left(Pub_StrUserSt03, 2) = "P1" Then
      '2023/7/13 END
         If pReKeyInOK Then
            'Modified by Morgan 2020/9/16 2次確認退回重輸的來函一律轉給79075做2次確認
            'strSql = "update InputRecord set ir08=" & strSrvDate(1) & ",ir09=" & strUpdTime & ",ir10='" & strUserNum & "'" & _
            '         " where ir01=" & pIR01 & " and ir02=" & pIR02 & " and ir03='" & pIR03 & "' and ir04='" & pIR04 & "' and ir08=0"
            'cnnConnection.Execute strSql, intI
            'strSql = "update PatentInput set pi16=" & strSrvDate(1) & _
            '         " where pi01=" & pIR01 & " and pi02=" & pIR02 & " and pi03='" & pIR03 & "' and pi16=0"
            'cnnConnection.Execute strSql, intI
            
            strIR22 = "79075"
            strSql = "update InputRecord set ir04='" & strUserNum & "',ir16='1',ir17=" & strSrvDate(1) & ",ir18=" & strUpdTime & ",ir19='" & strUserNum & "'" & _
                     ",ir20='" & strSrvDate(2) & " 轉主管作2次確認('||GETFORMNAME('" & pFrmName & "')||');'||chr(13)||chr(10)||ir20" & _
                     ",ir21='" & pCRecNo & "',ir22='" & strIR22 & "',ir23='!'" & _
                     " where ir01=" & pIR01 & " and ir02=" & pIR02 & " and ir03='" & pIR03 & "' and ir04='" & pIR04 & "' and ir08=0"
            cnnConnection.Execute strSql, intI
            
            'EMail通知
            strSql = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08)" & _
               " select '" & strUserNum & "','" & strIR22 & "',to_char(sysdate,'yyyymmdd')" & _
               ",to_char(sysdate,'hh24miss'),cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04)||'案已重新輸入來函，請進行2次確認作業！','如旨'" & _
               " from caseprogress where cp09='" & pCRecNo & "'"
            cnnConnection.Execute strSql, intI
            'end 202/9/16
            
         Else
            '2次確認人:案件職代1->案件職代2->
            'Modified by Morgan 2021/6/8 職代可能為留職停薪狀態 Ex:A3014
            'Modified by Morgan 2024/6/26 先抓案件職代,79017的人事職代為B1019但目前尚蓉主要是以B1099在操作,故增設案件職代
            strSql = "select cp65,s1.st01 man1,s2.st01 man2,s3.st01 man3,s4.st01 man4,a1.B0108 man5" & _
               " from caseprogress,ABS001 a1,staff s1,staff s2,ABS001 a2,staff s3,staff s4" & _
               " where cp09='" & pCRecNo & "' and a1.B0101(+)=CP65" & _
               " and s1.st01(+)=nvl(a1.b0117,a1.b0102) and s1.st04(+)='1' and s2.st01(+)=nvl(a1.b0121,a1.b0104) and s2.st04(+)='1'" & _
               " and a2.B0101(+)=nvl(a1.b0121,a1.b0104)" & _
               " and s3.st01(+)=nvl(a2.b0117,a2.b0102) and s3.st04(+)='1' and s4.st01(+)=nvl(a2.b0121,a2.b0104) and s4.st04(+)='1'"
               
            intI = 1
            Set RsQ = ClsLawReadRstMsg(intI, strSql)
            If intI = 1 Then
               'Modified by Morgan 2020/8/20 修正時間參數傳入格式不正確問題
               '職代1
               strIR22 = "" & RsQ.Fields("man1")
               If strIR22 <> "" Then
                  If CheckIsPersonRest(strIR22, strSrvDate(1), Format(Left(strUpdTime, 4), "##:##")) = True Then
                     strIR22 = ""
                  End If
               End If
               '職代2
               If strIR22 = "" Then
                  strIR22 = "" & RsQ.Fields("man2")
                  If strIR22 <> "" Then
                     If CheckIsPersonRest(strIR22, strSrvDate(1), Format(Left(strUpdTime, 4), "##:##")) = True Then
                        strIR22 = ""
                     End If
                  End If
               End If
               '職代2的職代1
               If strIR22 = "" Then
                  strIR22 = "" & RsQ.Fields("man3")
                  If strIR22 = RsQ.Fields("cp65") Then strIR22 = ""
                  If strIR22 <> "" Then
                     If CheckIsPersonRest(strIR22, strSrvDate(1), Format(Left(strUpdTime, 4), "##:##")) = True Then
                        strIR22 = ""
                     End If
                  End If
               End If
               '職代2的職代2
               If strIR22 = "" Then
                  strIR22 = "" & RsQ.Fields("man4")
                  If strIR22 = RsQ.Fields("cp65") Then strIR22 = ""
                  If strIR22 <> "" Then
                     If CheckIsPersonRest(strIR22, strSrvDate(1), Format(Left(strUpdTime, 4), "##:##")) = True Then
                     strIR22 = ""
                     End If
                  End If
               End If
               If strIR22 = "" Then
                  strIR22 = "" & RsQ.Fields("man5")
               End If
               'end 2021/6/8
               'end 2020/8/20
            End If
         
            'Modified by Morgan 2020/9/11 因2次確認後信要轉回處理人，故收件人IR04改為處理人--陳玲玲
            strSql = "update InputRecord set ir04='" & strUserNum & "',ir16='1',ir17=" & strSrvDate(1) & ",ir18=" & strUpdTime & ",ir19='" & strUserNum & "'" & _
                     ",ir20='" & strSrvDate(2) & " 轉職代作2次確認('||GETFORMNAME('" & pFrmName & "')||');'||chr(13)||chr(10)||ir20" & _
                     ",ir21='" & pCRecNo & "',ir22='" & strIR22 & "',ir23='!'" & _
                     " where ir01=" & pIR01 & " and ir02=" & pIR02 & " and ir03='" & pIR03 & "' and ir04='" & pIR04 & "' and ir08=0"
            cnnConnection.Execute strSql, intI
            
            'Modify By Sindy 2022/8/19 改寫在系統收件區裡面
   '         'Add By Sindy 2022/8/9 要發通知信
   '         strExc(0) = "select cum02 from CaseUseMemo" & _
   '                     " where cum05='02'" & _
   '                       " and cum06=" & CNULL(strUserNum) & _
   '                       " and cum02='" & strIR22 & "'"
   '         intI = 1
   '         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
   '         If intI = 0 Then
   '            strExc(0) = "insert into CaseUseMemo(cum01,cum02,cum03,cum04,cum05)" & _
   '                        " values('0','" & strIR22 & "','0','0','02')"
   '            cnnConnection.Execute strExc(0)
   '         End If
   '         '2022/8/9 END
         End If
         
         'Added by Morgan 2020/9/16 若來函已發文要取消發文日，等狀態改已處理才可發文
         'Modified by Morgan 2021/8/26 也清除發文人，否則進度查詢的發文室資料會顯示已判發
         strSql = "update caseprogress set cp27=null,cp83=null where cp09='" & pCRecNo & "' and cp27>0"
         cnnConnection.Execute strSql, intI
         'end 2020/9/16
      End If
   End If
   Set RsQ = Nothing
   'end 2020/7/29
End Sub

'Add By Sindy 2022/7/27 外專程序組輸入信件後的Outlook草稿
Public Function PUB_RecvOutLookF22(pIR01 As String, pIR02 As String, pIR03 As String, pIR04 As String, _
   pFrmName As String, pCRecNo As String) As Boolean
   
Dim adoRst As ADODB.Recordset
Dim objOutLook As Object
Dim objMail As Object
Dim cp() As String, pa() As String
Dim strTo As String, strCC As String
Dim strSubject As String, strContent As String
Dim strUserNumST52 As String, strUserNumST52Name As String
Dim strSalesST52 As String, strSalesST52Name As String
Dim strSales As String, strFCPHandler As String, strFCPHandlerST52 As String
Dim strAttach As String
Dim strCP43CP10 As String, strCP43CP47 As String
Dim strCP43CP61 As String, strCP43CP62 As String, strCP43CP63 As String
Dim strCP43CP87 As String, strCP43CP88 As String, strCP43CP14 As String
Dim strBill As String
Dim intRow As Integer 'Add By Sindy 2022/9/30
Dim bolChk As Boolean
Dim str416line As String 'Add By Sindy 2023/3/7
Dim tmpArr As Variant 'Add By Sindy 2024/6/11
'Added by Morgan 2025/8/14
Dim arrTemp() As String, strTempPath As String, strBillFile As String
Dim stSQL As String, intQ As Integer, ii As Integer
'end 2025/8/14
   
   PUB_RecvOutLookF22 = False
   strSubject = "": strContent = "": strTo = "": strCC = ""
   
   If PUB_GetST03(strUserNum) = "F22" Then
      If pIR01 = "" Or pFrmName = "" Then Exit Function
   Else
      Exit Function
   End If
   
   ReDim cp(TF_CP)
   cp(9) = pCRecNo
   Call PUB_ReadCaseProgressDatabase(cp(), 1)
   
   ReDim pa(TF_PA) As String
   pa(1) = cp(1)
   pa(2) = cp(2)
   pa(3) = cp(3)
   pa(4) = cp(4)
   If cp(1) = "FCP" Or cp(1) = "P" Then
      If PUB_ReadPatentDatabase(pa(), 國外_FC) Then
      End If
   ElseIf cp(1) = "FG" Or cp(1) = "PS" Then
      If PUB_ReadServicePracticeDatabase(pa(), 國外_FC) Then
      End If
   End If
   
   strFCPHandler = PUB_GetFCPHandler(cp(1), cp(2), cp(3), cp(4)) 'FCP程序(管制)人員
   strFCPHandlerST52 = PUB_GetFCPProSup(strFCPHandler) '程序人員的二級主管
   
   '操作人員的二級主管
   strUserNumST52 = PUB_GetFCPProSup(strUserNum)
   strUserNumST52Name = GetPrjSalesNM(strUserNumST52)
   '智權人員
   strSales = PUB_GetFCPSalesNo(cp(1), cp(2), cp(3), cp(4))
   strSalesST52 = PUB_GetFCPProSup(strSales)
   strSalesST52Name = GetPrjSalesNM(strSalesST52)
   
   '抓相關總收文號資料
   If cp(43) <> "" Then
      strSql = "select * from caseprogress " & _
               " where cp09='" & cp(43) & "'"
      CheckOC
      With adoRecordset
         .CursorLocation = adUseClient
         .Open strSql, cnnConnection, adOpenForwardOnly, adLockReadOnly
         If .RecordCount > 0 Then
            strCP43CP10 = "" & .Fields("cp10")
            strCP43CP47 = "" & .Fields("cp47") '提申日
            strCP43CP61 = "" & .Fields("cp61")
            strCP43CP62 = "" & .Fields("cp62")
            strCP43CP63 = "" & .Fields("cp63")
            strCP43CP87 = "" & .Fields("cp87")
            strCP43CP88 = "" & .Fields("cp88")
            strCP43CP14 = "" & .Fields("cp14") '承辦人
            '若C類,則抓下一程序的案件性質
            If Left(cp(43), 1) = "C" Then
               strSql = "select * from NextProgress " & _
                        "Where NP02='" & cp(1) & "' And NP03='" & cp(2) & "' And NP04='" & cp(3) & "' And NP05='" & cp(4) & "'" & _
                        " And np01='" & cp(43) & "' And NP06 is null"
               intI = 1
               Set RsTemp = ClsLawReadRstMsg(intI, strSql)
               If intI = 1 Then
                  strCP43CP10 = "" & RsTemp.Fields("np07")
               End If
            End If
         End If
      End With
   End If
   
   '帳單
   If cp(61) <> "" Then
      strBill = cp(61) & IIf(cp(62) <> "", "、" & cp(62), "") & IIf(cp(63) <> "", "、" & cp(63), "") & IIf(cp(87) <> "", "、" & cp(87), "") & IIf(cp(88) <> "", "、" & cp(88), "")
   Else
      strBill = ""
   End If
   
   'Modify By Sindy 2022/8/23
   '之前寰華案key已提申及申請案號輸入及延期，發Outlook的草稿CC自動帶backup@taie.com.tw，請拿掉
   '且若有U帳單，其內容修改如下：
   'To 何淑華:
   '請判發，有寰華帳單（U11106922）請轉寄給財務處及backup，謝謝。 ==> 增加 及backup
   If UCase(pFrmName) = "FRM04010401" Then '申請案號輸入
      '帳單
      If strCP43CP61 <> "" Then
         strBill = strCP43CP61 & IIf(strCP43CP62 <> "", "、" & strCP43CP62, "") & IIf(strCP43CP63 <> "", "、" & strCP43CP63, "") & IIf(strCP43CP87 <> "", "、" & strCP43CP87, "") & IIf(strCP43CP88 <> "", "、" & strCP43CP88, "")
      Else
         strBill = ""
      End If
      'Modify By Sindy 2022/9/29 PCT第二次Key申請案號輸入時，草稿另立
      'Modify By Sindy 2022/10/25 + And cp(10) = "1101"
      If PUB_ChkCPExist(pa, "1102") = True And cp(10) = "1101" Then '通知申請日.1102 通知申請案號.1101
         strTo = strSales '智權人員
         strCC = strSalesST52 & ";backup" '智權人員之主管、backup
         strSubject = "【(寰華案)已收來函: 進入中國國家階段通知書】請承辦報告 Our Ref： " & cp(1) & "-" & cp(2) & IIf(cp(3) & cp(4) = "000", "", "-" & cp(3) & "-" & cp(4)) & " [INCOM." & cp(10) & "]"
         strContent = "To " & GetPrjSalesNM(strSales) & ":" & vbCrLf & _
                      "1.通知函、官方來函、皆已匯入卷宗區，請通知代理人!" & vbCrLf
         intRow = 1
         
         strBill = "" 'Added by Morgan 2025/9/3 此通知不必附帳單電子檔
      Else
      '2022/9/29 END
         'Modify By Sindy 2023/3/7 + 416(實體審查)
         str416line = ""
         strExc(0) = "Select NP08,NP09,np23,NP15 From NextProgress " & _
                     "Where NP02='" & cp(1) & "' And NP03='" & cp(2) & "' And NP04='" & cp(3) & "' And NP05='" & cp(4) & "'" & _
                     " And NP07 in ('416') And NP06 is null " & _
                     "order by NP08 asc"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 1 Then
            str416line = Replace("(" & _
                         IIf(Val("" & RsTemp.Fields("np23")) > 0, " 約定期限：" & ChangeWStringToTDateString("" & RsTemp.Fields("np23")), "") & _
                         IIf(Val("" & RsTemp.Fields("np08")) > 0, " 本所期限：" & ChangeWStringToTDateString("" & RsTemp.Fields("np08")), "") & _
                         IIf(Val("" & RsTemp.Fields("np09")) > 0, " 法定期限：" & ChangeWStringToTDateString("" & RsTemp.Fields("np09")), "") & _
                         ")", "( ", "(")
         End If
         '2023/3/7 END
         
         'Modify By Sindy 2022/12/5
         '敏莉:系統收件區是分割案，在key申請案號輸入，則帶Outlook的內容請改為工程師進行請款
         'Modify By Sindy 2022/12/29 再調整:ex:【(寰華案)已送件完成_分割+(實審 (若進度檔有，且有發文日))】1. 請判發 2. 請工程師進行請款！ Our Ref: P-130694 [INCOM.307 (固定帶此案件性質)]
         If PUB_ChkCPExist(pa, "307") = True Then
            strTo = strUserNumST52 & ";" & strSales & ";" & strCP43CP14 '發文人員之主管、智權人員、工程師
            strCC = strSalesST52 & ";" & PUB_GetFCPEngSup(strCP43CP14) '& ";backup" '智權人員主管、工程師之主管、backup
            
            'Modified by Morgan 2025/8/14 配合寰華案帳單電子化調整--Sharon
            'strContent = "To " & strUserNumST52Name & ":" & vbCrLf & _
                         "請判發，" & IIf(strBill <> "", "有寰華帳單（" & strBill & "）請轉寄給財務處及backup，", "") & "謝謝。" & vbCrLf & vbCrLf
            'Modified by Morgan 2025/8/19 主旨內文再調整--Sharon
            ''strSubject = "【(寰華案)已送件完成_分割" & IIf(PUB_ChkCPExist(pa, "416", 2) = True, "+實審", "") & "】1. 請判發 2. 請承辦簡單報告 3. 請工程師進行請款！ Our Ref: " & cp(1) & "-" & cp(2) & IIf(cp(3) & cp(4) = "000", "", "-" & cp(3) & "-" & cp(4)) & " [INCOM.307]"
            'strContent = "To " & strUserNumST52Name & ":" & vbCrLf & _
                         "請判發，謝謝。" & vbCrLf & vbCrLf
            strSubject = "【(寰華案)已送件完成_分割" & IIf(PUB_ChkCPExist(pa, "416", 2) = True, "+實審", "") & "】1. 請承辦簡單報告 2. 請工程師進行請款！ Our Ref: " & cp(1) & "-" & cp(2) & IIf(cp(3) & cp(4) = "000", "", "-" & cp(3) & "-" & cp(4)) & " [INCOM.307]"
            strContent = "To " & strUserNumST52Name & ":" & vbCrLf & _
                         "請檢查資料。" & vbCrLf & vbCrLf
            'end 2025/8/19
            'end 2025/8/14
            
            'Add By Sindy 2023/1/18
            strContent = strContent & _
                         "To " & GetPrjSalesNM(strSales) & ":" & vbCrLf & _
                         "1.請簡單報告送件日" & vbCrLf
            intRow = 1
            bolChk = ChkPaperKurangnya(cp, intRow, strContent) '本案尚缺
            If bolChk = True Then
               strContent = strContent & vbCrLf
            End If
            '2023/1/18 END
            
            strContent = strContent & _
                         "To " & GetPrjSalesNM(strCP43CP14) & ":" & vbCrLf & _
                         "1.寰華已送件完成【遞交日: " & ChangeWStringToTDateString(strCP43CP47) & "】" & vbCrLf & _
                         "2.請工程師處理請款，送件附檔請參卷宗區" & vbCrLf & _
                         "3.請款信、金額請提供給承辦 (" & GetPrjSalesNM(strSales) & ") 及程序 (" & GetPrjSalesNM(strFCPHandler) & ") " & vbCrLf
            intRow = 3
            'Add By Sindy 2023/1/18 + 416(實體審查)
            If str416line <> "" Then
               intRow = intRow + 1
               strContent = strContent & intRow & ".工程師請款時請一併告知實審期限:" & vbCrLf
               strContent = strContent & "  " & str416line & vbCrLf
            End If
            '2023/1/18 END
         Else
         '2022/12/5 END
            strTo = strUserNumST52 & ";" & strSales '發文人員之主管、智權人員
            
            'Modified by Morgan 2025/8/14 配合寰華案帳單電子化調整--Sharon
            'strCC = strSalesST52 '& ";backup" '智權人員之主管、backup
            'strContent = "To " & strUserNumST52Name & ":" & vbCrLf & _
                         "請判發，" & IIf(strBill <> "", "有寰華帳單（" & strBill & "）請轉寄給財務處及backup，", "") & "謝謝。" & vbCrLf & vbCrLf & _
                         "To " & GetPrjSalesNM(strSales) & ":" & vbCrLf & _
                         "1.寰華已提申(提申日: " & ChangeWStringToTDateString(strCP43CP47) & ")" & vbCrLf & _
                         "2.送件附檔請參卷宗區" & vbCrLf & _
                         "3.請報告代理人+請款！" & vbCrLf
            strCC = strSalesST52 & ";backup" '智權人員之主管、backup
            'Modified by Morgan 2025/8/19 主旨內文再調整--Sharon
            'strSubject = "【(寰華案)新案已提申】1. 請判發 2. 請承辦告申+請款！ Our Ref： " & cp(1) & "-" & cp(2) & IIf(cp(3) & cp(4) = "000", "", "-" & cp(3) & "-" & cp(4)) & " [INCOM." & cp(10) & "]"
            'strContent = "To " & strUserNumST52Name & ":" & vbCrLf & _
                         "請判發，謝謝。" & vbCrLf & vbCrLf
            strSubject = "【(寰華案)新案已提申】請承辦告申+請款！ Our Ref： " & cp(1) & "-" & cp(2) & IIf(cp(3) & cp(4) = "000", "", "-" & cp(3) & "-" & cp(4)) & " [INCOM." & cp(10) & "]"
            strContent = "To " & strUserNumST52Name & ":" & vbCrLf & _
                         "請檢查資料。" & vbCrLf & vbCrLf
            'end 2025/8/19
            'end 2025/8/14
            strContent = strContent & _
                         "To " & GetPrjSalesNM(strSales) & ":" & vbCrLf & _
                         "1.寰華已提申(提申日: " & ChangeWStringToTDateString(strCP43CP47) & ")" & vbCrLf & _
                         "2.送件附檔請參卷宗區" & vbCrLf & _
                         "3.請報告代理人+請款！" & vbCrLf
            intRow = 3
            'Add By Sindy 2023/3/7 + 416(實體審查)
            If str416line <> "" Then
               intRow = intRow + 1
               strContent = strContent & intRow & ".實體審查期限:" & vbCrLf
               strContent = strContent & "  " & str416line & vbCrLf
            End If
            '2023/3/7 END
         End If
      End If
      'Add By Sindy 2023/1/18
      '增加判斷：若進度檔有203主動補正1.已上發文日 2.且是否向客戶請款為空的，增加"附上主動補正金額"項目
      strExc(0) = "Select CP09,CP20 From CaseProgress " & _
                  "Where CP01='" & cp(1) & "' And CP02='" & cp(2) & "' And CP03='" & cp(3) & "' And CP04='" & cp(4) & "'" & _
                  " And CP10='203' And CP158>0 And CP159=0 And CP20 is null"
      intI = 1
      Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
      If intI = 1 Then
         intRow = intRow + 1
         strContent = strContent & intRow & ".附上主動補正金額" & vbCrLf
      End If
      '2023/1/18 END
      'Modify By Sindy 2023/1/18 本案尚缺
      If PUB_ChkCPExist(pa, "307") = False Then
         Call ChkPaperKurangnya(cp, intRow, strContent)
      End If
      
   ElseIf UCase(pFrmName) = "FRM04010507_1" Then '已收達/已提申
      'Modify By Sindy 2022/8/10 已提申才要產生草稿
      If Val(cp(47)) = 0 Then '已提申日空白
         strContent = "不產生草稿"
      Else
      '2022/8/10 END
         If cp(10) = "404" Then '延期
            strTo = strUserNumST52 & ";" & strSales '發文人員之主管、智權人員
            'Modified by Morgan 2025/8/14 配合寰華案帳單電子化調整--Sharon
            'strCC = strSalesST52 '& ";backup" '智權人員之主管、backup
            'strContent = "To " & strUserNumST52Name & ":" & vbCrLf & _
                         "請判發，" & IIf(strBill <> "", "有寰華帳單（" & strBill & "）請轉寄給財務處及backup，", "") & "謝謝。" & vbCrLf & vbCrLf & _
                         "To " & GetPrjSalesNM(strSales) & ":" & vbCrLf & _
                         "1.寰華已延期【遞交日: " & ChangeWStringToTDateString(cp(47)) & "】" & vbCrLf & _
                         "2.請向代理人報告新期限，送件附檔請參卷宗區" & vbCrLf
            strCC = strSalesST52 & ";backup" '智權人員之主管、backup
            'Modified by Morgan 2025/8/19 主旨內文再調整--Sharon
            'strSubject = "【(寰華案)已延期_" & GetPrjState4(cp(1) & "-" & cp(2) & "-" & cp(3) & "-" & cp(4), strCP43CP10) & "】1. 請判發 2. 請承辦報告！ Our Ref: " & cp(1) & "-" & cp(2) & IIf(cp(3) & cp(4) = "000", "", "-" & cp(3) & "-" & cp(4)) & " [INCOM." & cp(10) & "]"
            'strContent = "To " & strUserNumST52Name & ":" & vbCrLf & _
                         "請判發，謝謝。" & vbCrLf & vbCrLf
            strSubject = "【(寰華案)已延期_" & GetPrjState4(cp(1) & "-" & cp(2) & "-" & cp(3) & "-" & cp(4), strCP43CP10) & "】請承辦報告！ Our Ref: " & cp(1) & "-" & cp(2) & IIf(cp(3) & cp(4) = "000", "", "-" & cp(3) & "-" & cp(4)) & " [INCOM." & cp(10) & "]"
            strContent = "To " & strUserNumST52Name & ":" & vbCrLf & _
                         "請檢查資料。" & vbCrLf & vbCrLf
            'end 2025/8/19
            'end 2025/8/14
            strContent = strContent & _
                         "To " & GetPrjSalesNM(strSales) & ":" & vbCrLf & _
                         "1.寰華已延期【遞交日: " & ChangeWStringToTDateString(cp(47)) & "】" & vbCrLf & _
                         "2.請向代理人報告新期限，送件附檔請參卷宗區" & vbCrLf
            '帶下一程序期限
            strExc(0) = "Select NP08,NP09,np23,NP15 From NextProgress " & _
                        "Where NP02='" & cp(1) & "' And NP03='" & cp(2) & "' And NP04='" & cp(3) & "' And NP05='" & cp(4) & "'" & _
                        " And NP07='" & strCP43CP10 & "' And NP06 is null " & _
                        "order by NP08 asc"
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               strContent = strContent & "延期後期限" & vbCrLf & _
                            "(約定期限：" & ChangeWStringToTDateString("" & RsTemp.Fields("np23")) & _
                            " 本所期限：" & ChangeWStringToTDateString("" & RsTemp.Fields("np08")) & _
                            " 法定期限：" & ChangeWStringToTDateString("" & RsTemp.Fields("np09")) & _
                            ")" & vbCrLf
            Else
               strContent = strContent & "延期後期限" & vbCrLf
            End If
            
         ElseIf PUB_GetST03(cp(14)) = "F22" Then '承辦人掛程序人員
            'Modify By Sindy 2022/9/14 增加無帳單的草稿內容
            If strBill <> "" Then
               strTo = strUserNumST52 & ";" & strSales '發文人員之主管、智權人員
               
               'Modified by Morgan 2025/8/14 配合寰華案帳單電子化調整--Sharon
               'strCC = strSalesST52 '& ";backup" '智權人員之主管、backup
               'strContent = "To " & strUserNumST52Name & ":" & vbCrLf & _
                            "請判發，" & IIf(strBill <> "", "有寰華帳單（" & strBill & "）請轉寄給財務處及backup，", "") & "謝謝。" & vbCrLf & vbCrLf & _
                            "To " & GetPrjSalesNM(strSales) & ":" & vbCrLf & _
                            "1.寰華已送件完成【遞交日: " & ChangeWStringToTDateString(cp(47)) & "】" & vbCrLf & _
                            "2.請處理請款，送件附檔請參卷宗區"
               strCC = strSalesST52 & ";backup" '智權人員之主管、backup
               'Modified by Morgan 2025/8/19 主旨內文再調整--Sharon
               'strSubject = "【(寰華案)已送件完成_" & GetPrjState4(cp(1) & "-" & cp(2) & "-" & cp(3) & "-" & cp(4), cp(10)) & "】1. 請判發 2. 請承辦進行請款！ Our Ref: " & cp(1) & "-" & cp(2) & IIf(cp(3) & cp(4) = "000", "", "-" & cp(3) & "-" & cp(4)) & " [INCOM." & cp(10) & "]"
               'strContent = "To " & strUserNumST52Name & ":" & vbCrLf & _
                            "請判發，謝謝。" & vbCrLf & vbCrLf
               strSubject = "【(寰華案)已送件完成_" & GetPrjState4(cp(1) & "-" & cp(2) & "-" & cp(3) & "-" & cp(4), cp(10)) & "】請承辦進行請款！ Our Ref: " & cp(1) & "-" & cp(2) & IIf(cp(3) & cp(4) = "000", "", "-" & cp(3) & "-" & cp(4)) & " [INCOM." & cp(10) & "]"
               strContent = "To " & strUserNumST52Name & ":" & vbCrLf & _
                            "請檢查資料。" & vbCrLf & vbCrLf
               'end 2025/8/19
               'end 2025/8/14
               strContent = strContent & _
                            "To " & GetPrjSalesNM(strSales) & ":" & vbCrLf & _
                            "1.寰華已送件完成【遞交日: " & ChangeWStringToTDateString(cp(47)) & "】" & vbCrLf & _
                            "2.請處理請款，送件附檔請參卷宗區"
            Else
               strTo = strSales '智權人員
               strCC = strSalesST52 & ";backup" '智權人員之主管、backup
               strSubject = "【(寰華案)已送件完成_" & GetPrjState4(cp(1) & "-" & cp(2) & "-" & cp(3) & "-" & cp(4), cp(10)) & "】請進行請款！ Our Ref: " & cp(1) & "-" & cp(2) & IIf(cp(3) & cp(4) = "000", "", "-" & cp(3) & "-" & cp(4)) & " [INCOM." & cp(10) & "]"
               strContent = "To " & GetPrjSalesNM(strSales) & ":" & vbCrLf & _
                            "1.寰華已送件完成【遞交日: " & ChangeWStringToTDateString(cp(47)) & "】" & vbCrLf & _
                            "2.請處理請款，送件附檔請參卷宗區"
            End If
                         
         ElseIf PUB_GetST03(cp(14)) = "F21" Then '承辦人掛工程師
            'Modify By Sindy 2022/9/14 增加無帳單的草稿內容
            If strBill <> "" Then
               strTo = strUserNumST52 & ";" & cp(14) '發文人員之主管、工程師
               'Modified by Morgan 2025/8/14 配合寰華案帳單電子化調整--Sharon
               'strCC = PUB_GetFCPEngSup(cp(14)) '& ";backup" '工程師之主管、backup
               'strContent = "To " & strUserNumST52Name & ":" & vbCrLf & _
                            "請判發，" & IIf(strBill <> "", "有寰華帳單（" & strBill & "）請轉寄給財務處及backup，", "") & "謝謝。" & vbCrLf & vbCrLf & _
                            "To " & GetPrjSalesNM(cp(14)) & ":" & vbCrLf & _
                            "1.寰華已送件完成【遞交日: " & ChangeWStringToTDateString(cp(47)) & "】" & vbCrLf & _
                            "2.請工程師處理請款，送件附檔請參卷宗區" & vbCrLf & _
                            "3.請款信、金額請提供給承辦 (" & GetPrjSalesNM(strSales) & ") 及程序 (" & GetPrjSalesNM(strFCPHandler) & ") "
               strCC = PUB_GetFCPEngSup(cp(14)) & ";backup" '工程師之主管、backup
               'Modified by Morgan 2025/8/19 主旨內文再調整--Sharon
               'strSubject = "【(寰華案)已送件完成_" & GetPrjState4(cp(1) & "-" & cp(2) & "-" & cp(3) & "-" & cp(4), cp(10)) & "】1. 請判發 2. 請工程師進行請款！ Our Ref: " & cp(1) & "-" & cp(2) & IIf(cp(3) & cp(4) = "000", "", "-" & cp(3) & "-" & cp(4)) & " [INCOM." & cp(10) & "]"
               'strContent = "To " & strUserNumST52Name & ":" & vbCrLf & _
                            "請判發，謝謝。" & vbCrLf & vbCrLf
               strSubject = "【(寰華案)已送件完成_" & GetPrjState4(cp(1) & "-" & cp(2) & "-" & cp(3) & "-" & cp(4), cp(10)) & "】請工程師進行請款！ Our Ref: " & cp(1) & "-" & cp(2) & IIf(cp(3) & cp(4) = "000", "", "-" & cp(3) & "-" & cp(4)) & " [INCOM." & cp(10) & "]"
               strContent = "To " & strUserNumST52Name & ":" & vbCrLf & _
                            "請檢查資料。" & vbCrLf & vbCrLf
               'end 2025/8/19
               'end 2025/8/14
               strContent = strContent & _
                            "To " & GetPrjSalesNM(cp(14)) & ":" & vbCrLf & _
                            "1.寰華已送件完成【遞交日: " & ChangeWStringToTDateString(cp(47)) & "】" & vbCrLf & _
                            "2.請工程師處理請款，送件附檔請參卷宗區" & vbCrLf & _
                            "3.請款信、金額請提供給承辦 (" & GetPrjSalesNM(strSales) & ") 及程序 (" & GetPrjSalesNM(strFCPHandler) & ") "
            Else
               strTo = cp(14) '工程師
               strCC = PUB_GetFCPEngSup(cp(14)) & ";backup" '工程師之主管、backup
               strSubject = "【(寰華案)已送件完成_" & GetPrjState4(cp(1) & "-" & cp(2) & "-" & cp(3) & "-" & cp(4), cp(10)) & "】請進行請款！ Our Ref: " & cp(1) & "-" & cp(2) & IIf(cp(3) & cp(4) = "000", "", "-" & cp(3) & "-" & cp(4)) & " [INCOM." & cp(10) & "]"
               strContent = "To " & GetPrjSalesNM(cp(14)) & ":" & vbCrLf & _
                            "1.寰華已送件完成【遞交日: " & ChangeWStringToTDateString(cp(47)) & "】" & vbCrLf & _
                            "2.請工程師處理請款，送件附檔請參卷宗區" & vbCrLf & _
                            "3.請款信、金額請提供給承辦 (" & GetPrjSalesNM(strSales) & ") 及程序 (" & GetPrjSalesNM(strFCPHandler) & ") "
            End If
         End If
      End If
   End If
   
   'Add By Sindy 2024/6/11 寰華案內專工程師中間程序請款的案件，產生Outlook草稿給工程師請款，
   '                       收件者應改發對接外專主管
   tmpArr = Split(strTo, ";")
   strTo = ""
   For intRow = 0 To UBound(tmpArr)
      If Trim(tmpArr(intRow)) <> "" Then
         If Mid(Trim(tmpArr(intRow)), 4, 1) = "9" Then '內專工程師協助承辦外專案件
            strExc(10) = GetST52SelfList(CStr(tmpArr(intRow)))
            If strExc(10) <> "" Then
               strTo = strTo & ";" & strExc(10)
               'Add By Sindy 2024/6/17
               If InStr(strContent, GetPrjSalesNM(Trim(tmpArr(intRow)))) > 0 Then
                  strContent = Replace(strContent, GetPrjSalesNM(Trim(tmpArr(intRow))), GetPrjSalesNM(strExc(10)))
               End If
               '2024/6/17 END
            Else
               strTo = strTo & ";" & Trim(tmpArr(intRow))
            End If
         Else
            strTo = strTo & ";" & Trim(tmpArr(intRow))
         End If
      End If
   Next intRow
   If strTo <> "" Then strTo = Mid(strTo, 2)
   '2024/6/11 END
   
   If strContent = "不產生草稿" Then 'Add By Sindy 2022/8/10
   '有內容及收件者才需要呼叫Outlook草稿
   ElseIf strContent <> "" And strTo <> "" Then
   
      'Added by Morgan 2025/8/14
      If strBill <> "" Then
         arrTemp = Split(strBill, "、")
         For ii = LBound(arrTemp) To UBound(arrTemp)
            If arrTemp(ii) <> "" Then
               stSQL = "select ayf02 from acc152 where ayf01='" & arrTemp(ii) & "'"
               intQ = 1
               Set adoRst = ClsLawReadRstMsg(intQ, stSQL)
               If intQ = 1 Then
                  strBillFile = arrTemp(ii) & "_" & cp(1) & "-" & cp(2) & IIf(cp(3) & cp(4) = "000", "", "-" & cp(3) & "-" & cp(4)) & ".pdf"
                  If PUB_GetAttachFile_Invoice(arrTemp(ii), adoRst(0), App.path & "\" & strUserNum, strBillFile) = True Then
                     strAttach = strAttach & ";" & App.path & "\" & strUserNum & "\" & strBillFile
                  End If
               End If
            End If
         Next
      End If
      'end 2025/8/14
      
      '呼叫新郵件：
      Set objOutLook = CreateObject("Outlook.Application")
      Set objMail = objOutLook.CreateItem(0)
      
      '轉HTML格式
      strContent = Replace(strContent, "新細明體", "Times New Roman")
      '&nbsp; 不換行空格
      '&thinsp; 窄空格
      '單純只是想要輸入空白？ &nbsp; 就對了
      '&emsp; 全形空格
      '&ensp; 半形空格
      'strContent = Replace(strContent, "　", "&emsp;") '&emsp; 全形空格
      strContent = Replace(strContent, " ", "&thinsp;") '&ensp; 半形空格
      strContent = Replace(strContent, vbCrLf, "<BR>")
      
'      If TypeName(objOutLook.Assistant) <> "Nothing" Then
'         objOutLook.ActiveWindow.WindowState = 1 '0.最大化 1.視窗小點
'      End If
      With objMail
         '.BodyFormat = 2 '2=olFormatHTML 1=olFormatPlain 3=olFormatRichText
         .To = strTo
         .cc = strCC
         If strAttach <> "" Then
            'Modified by Morgan 2025/8/14
            '.Attachments.add strAttach '加附件
            arrTemp = Split(strAttach, ";")
            For ii = LBound(arrTemp) To UBound(arrTemp)
               If arrTemp(ii) <> "" Then
                  .Attachments.add arrTemp(ii) '加附件
               End If
            Next
            'end 2025/8/14
         End If
         .Subject = strSubject
         .HTMLBody = strContent
         .Display
      End With
      
      PUB_RecvOutLookF22 = True '草稿產生成功
      Set objMail = Nothing
      Set objOutLook = Nothing
      
   '其他的判斷若承辦人是程序人員，需自動打開原郵件供程序人員通知承辦報告用。
   ElseIf PUB_GetST03(cp(14)) = "F22" Then
      '下載信件檔
      If PUB_UploadPatentLetterFile(pIR01, pIR03, "", , strAttach, True) = False Then
         strAttach = ""
      Else
         ShellExecute 0, "open", strAttach, vbNullString, vbNullString, 1 '開檔
      End If
   End If
   
   Set adoRst = Nothing
End Function

'Add By Sindy 2022/6/30 外專承辦組收文後的Outlook草稿
'Modify By Sindy 2025/8/19 + , Optional ByVal m_LOS15 As String = "": 案源單號
Public Function PUB_RecvOutLookF23(pIR01 As String, pIR02 As String, pIR03 As String, pIR04 As String, _
   m_RecvType As String, pCRecNo As String, Optional ByVal m_LOS15 As String = "") As Boolean
   
Dim adoRst As ADODB.Recordset
Dim objOutLook As Object
Dim objMail As Object
Dim cp() As String, pa() As String
Dim strTo As String, strCC As String
Dim strSubject As String, strContent As String
Dim strUserNumST52 As String, strUserNumST52Name As String
Dim strSalesST52 As String, strSalesST52Name As String
Dim strSales As String, strFCPHandler As String, strFCPHandlerST52 As String
Dim strRestEmp As String
Dim strNP23 As String
Dim strNation As String, strNaName As String, strFC_Y As String, strFC_Name As String
Dim strCaseProperty As String
Dim intMRecvCnt As Integer, strMRecvCode As String, intI As Integer
'Dim ii As Integer, strAppl As String
Dim strAttach As String
Dim strRestKind As String, strCCText As String 'Add By Sindy 2022/8/11
Dim strPA26 As String, strPA27 As String, strPA28 As String, strPA29 As String, strPA30 As String
Dim strApplName As String, bolFMPY53374 As Boolean, bolFMP As Boolean
Dim strPA77 As String, strPA48 As String, StrPA11 As String, strPA22 As String
Dim strConAPPL As String, strA1kDA As String, strA1KSQL As String
Dim strYear As String
   
   PUB_RecvOutLookF23 = False
   strSubject = "": strContent = "": strTo = "": strCC = "": strCCText = ""
   
   If PUB_GetST03(strUserNum) = "F23" Then
      If pIR01 = "" Or m_RecvType = "" Then Exit Function
   Else
      Exit Function
   End If
   
   ReDim cp(TF_CP)
   cp(9) = pCRecNo
   Call PUB_ReadCaseProgressDatabase(cp(), 1)
   
   ReDim pa(TF_PA) As String
   pa(1) = cp(1)
   pa(2) = cp(2)
   pa(3) = cp(3)
   pa(4) = cp(4)
   If cp(1) = "FCP" Or cp(1) = "P" Then
      If PUB_ReadPatentDatabase(pa(), 國外_FC) Then
      End If
   ElseIf cp(1) = "FG" Or cp(1) = "PS" Then
      If PUB_ReadServicePracticeDatabase(pa(), 國外_FC) Then
      End If
   End If
   
   bolFMPY53374 = PUB_FMPtoCheck(1, 2, Pub_strUserST05, pa(1), pa(2), pa(3), pa(4)) 'FMP寰華案件
   bolFMP = PUB_ChkIsFMP(pa(1), pa(2), pa(3), pa(4)) '是否為FMP案件
   strFCPHandler = PUB_GetFCPHandler(cp(1), cp(2), cp(3), cp(4)) 'FCP程序(管制)人員
   strFCPHandlerST52 = PUB_GetFCPProSup(strFCPHandler) '程序人員的二級主管
   
   '操作人員的二級主管
   strUserNumST52 = PUB_GetFCPProSup(strUserNum)
   strUserNumST52Name = GetPrjSalesNM(strUserNumST52)
   '智權人員
   strSales = PUB_GetFCPSalesNo(cp(1), cp(2), cp(3), cp(4))
   strSalesST52 = PUB_GetFCPProSup(strSales)
   strSalesST52Name = GetPrjSalesNM(strSalesST52)
   
   '抓下一程序的約定期限
   strNP23 = ""
   'Modify By Sindy 2024/1/4
   If cp(43) <> "" Then
   '2024/1/4 END
      'Modify By Sindy 2024/1/18 + and np07='" & cp(10) & "' ex:P-132042；案件性質：主動補正 (系統自動帶出113/03/25，但非為主動補正之約定期限，而為香港專1st登錄的約定期限)
      strSql = "select * from nextprogress " & _
               " where np01='" & cp(43) & "' and np07='" & cp(10) & "'"
      CheckOC
      With adoRecordset
         .CursorLocation = adUseClient
         .Open strSql, cnnConnection, adOpenForwardOnly, adLockReadOnly
         If .RecordCount > 0 Then
            strNP23 = "" & .Fields("np23")
         End If
      End With
   End If
   'Y編號國籍
   'Modify By Sindy 2022/8/18
   If cp(1) = "FG" Then '專利服務
      strFC_Y = ChangeCustomerL(pa(26)) 'FC代理人
      '申請人
      strPA26 = ChangeCustomerL(pa(8))
      strPA27 = ChangeCustomerL(pa(58))
      strPA28 = ChangeCustomerL(pa(59))
      strPA29 = ChangeCustomerL(pa(65))
      strPA30 = ChangeCustomerL(pa(66))
      strPA77 = pa(27) '彼所案號
      strPA48 = pa(29) '客戶案件案號
      StrPA11 = pa(11) '申請案號
      strPA22 = pa(14) '專利號數
      strConAPPL = Trim(pa(30)) & IIf(Trim(pa(75)) <> "", IIf(Trim(pa(30)) <> "", "、", "") & Trim(pa(75)), "") '聯絡人
   Else '專利
   '2022/8/18 END
      strFC_Y = ChangeCustomerL(pa(75)) 'FC代理人
      '申請人
      strPA26 = ChangeCustomerL(pa(26))
      strPA27 = ChangeCustomerL(pa(27))
      strPA28 = ChangeCustomerL(pa(28))
      strPA29 = ChangeCustomerL(pa(29))
      strPA30 = ChangeCustomerL(pa(30))
      strPA77 = pa(77) '彼所案號
      strPA48 = pa(48) '客戶案件案號
      StrPA11 = pa(11) '申請案號
      strPA22 = pa(22) '專利號數
      '聯絡人:英-->中-->日
      If Trim(pa(52)) <> "" Then
         strConAPPL = Trim(pa(52))
      ElseIf Trim(pa(51)) <> "" Then
         strConAPPL = Trim(pa(51))
      ElseIf Trim(pa(53)) <> "" Then
         strConAPPL = Trim(pa(53))
      End If
      If Trim(pa(55)) <> "" Then
         If strConAPPL <> "" Then strConAPPL = strConAPPL & "、"
         strConAPPL = strConAPPL & Trim(pa(55))
      ElseIf Trim(pa(54)) <> "" Then
         If strConAPPL <> "" Then strConAPPL = strConAPPL & "、"
         strConAPPL = strConAPPL & Trim(pa(54))
      ElseIf Trim(pa(56)) <> "" Then
         If strConAPPL <> "" Then strConAPPL = strConAPPL & "、"
         strConAPPL = strConAPPL & Trim(pa(56))
      End If
   End If
   strNation = GetPrjNationNumber(strFC_Y)
   strNaName = Trim(GetPrjNationNameHM(strNation))
   strFC_Name = GetPrjName2(strFC_Y)
   strApplName = IIf(strPA26 <> "", Trim(GetPrjPeople1(strPA26, "2")), "") & IIf(strPA27 <> "", "、" & Trim(GetPrjPeople1(strPA27, "2")), "") & _
                 IIf(strPA28 <> "", "、" & Trim(GetPrjPeople1(strPA28, "2")), "") & IIf(strPA29 <> "", "、" & Trim(GetPrjPeople1(strPA29, "2")), "") & _
                 IIf(strPA30 <> "", "、" & Trim(GetPrjPeople1(strPA30, "2")), "")
   '案件性質名稱
   strExc(10) = "": strCaseProperty = ""
   If pa(9) = "000" Then
      If ClsPDGetCasePropertyL(1, cp(1), cp(10), strExc(10)) = True Then
         strCaseProperty = strExc(10)
      End If
   Else
      If ClsPDGetCasePropertyL(2, cp(1), cp(10), strExc(10)) = True Then
         strCaseProperty = strExc(10)
      End If
   End If
      
   '同時把原始信件設為Outlook草稿的附件:
   '下載信件檔
   If PUB_UploadPatentLetterFile(pIR01, pIR03, "", , strAttach, True) = False Then
      strAttach = ""
   End If
   
   Select Case m_RecvType
      Case "1", "2" '1.舊案收文 / 2.多案收文
         If m_RecvType = "2" Then
            strSql = "select * from MultiCaseRecv where mcr01='" & pIR01 & pIR03 & "'" & _
                     " order by decode(mcr02||mcr03||mcr04||mcr05,mcr07||mcr08||mcr09||mcr10,1,2) asc,mcr11 asc,mcr02,mcr03,mcr04,mcr05 asc"
            CheckOC
            With adoRecordset
               .CursorLocation = adUseClient
               .Open strSql, cnnConnection, adOpenForwardOnly, adLockReadOnly
               intMRecvCnt = 0: intI = 0: strMRecvCode = ""
               If .RecordCount > 0 Then
                  intMRecvCnt = .RecordCount
                  .MoveFirst
                  Do While Not .EOF
                     intI = intI + 1
                     If strMRecvCode = "" Then
                        strMRecvCode = strMRecvCode & "　　　　　"
                     Else
                        If intI Mod 6 = 0 Then
                           strMRecvCode = strMRecvCode & vbCrLf & "　　　　　"
                        Else
                           strMRecvCode = strMRecvCode & "、"
                        End If
                     End If
                     strMRecvCode = strMRecvCode & .Fields("mcr02") & "-" & .Fields("mcr03") & IIf(.Fields("mcr04") & .Fields("mcr05") = "000", "", "-" & .Fields("mcr04") & "-" & .Fields("mcr05"))
                     'Add By Sindy 2022/11/28
                     strA1KSQL = strA1KSQL & " or (a1k13='" & .Fields("mcr02") & "' and a1k14='" & .Fields("mcr03") & "' and a1k15='" & .Fields("mcr04") & "' and a1k16='" & .Fields("mcr05") & "')"
                     '2022/11/28 END
                     .MoveNext
                  Loop
                  'Add By Sindy 2022/11/28 未付帳款
                  If strA1KSQL <> "" Then
                     strA1KSQL = Mid(strA1KSQL, 4)
                     strA1kDA = PUB_GetNotPayA1K(" and (" & strA1KSQL & ")")
                  End If
                  '2022/11/28 END
               End If
            End With
         End If
         
         strSubject = IIf(bolFMPY53374 = False And bolFMP = True, "內專", "") & _
                      "【收文" & IIf(m_RecvType = "2", "-共 " & intMRecvCnt & " 件", "") & "】" & strCaseProperty & " Our Ref: " & cp(1) & "-" & cp(2) & IIf(cp(3) & cp(4) = "000", "", "-" & cp(3) & "-" & cp(4)) & " [ORDER." & cp(10) & "]"
         If bolFMPY53374 = False And bolFMP = True Then 'FMP非寰華案件
            strTo = "79075"
         Else
            strTo = Pub_GetSpecMan("C") '程序分案人員
         End If
         '檢查人員是否有休假
         strRestEmp = GetCaseDutyAgent(strTo, "", False, strRestKind)
         If strRestEmp <> "" Then
            strCC = strCC & ";" & strRestEmp
            strCCText = IIf(strCCText <> "", strCCText & "、", "") & strRestKind
         End If
         strCC = strCC & ";" & strUserNumST52 & "; backup" '承辦主管; backup
         '主管休假,CC人事職代
         strRestEmp = GetCaseDutyAgent(strUserNumST52, "", False, , , "1")
         If strRestEmp <> "" Then
            strCC = strCC & ";" & strRestEmp
            strCCText = IIf(strCCText <> "", strCCText & "、", "") & strRestKind
         End If
         
         If strCCText <> "" Then strContent = "因收件人" & strCCText & "，請副本收件人處理此郵件。" & vbCrLf & vbCrLf
         If m_RecvType = "2" Then '2.多案收文
            strContent = strContent & _
                         "本所案號：共 " & intMRecvCnt & " 件" & vbCrLf & strMRecvCode & vbCrLf & _
                         "案件性質名稱：" & strCaseProperty & vbCrLf
            If cp(10) = 變更 Or cp(10) = 讓與 Or cp(10) = 合併 Then
               'Modify By Sindy 2022/10/11
               Call GetFCPF23OrderText(cp, pa, strContent)
               '2022/10/11 END
'               For ii = 1 To 5
'                  If cp(10) = 變更 Then
'                     strAppl = pa(ii + 25)
'                  Else
'                     If ii = 1 Then
'                        strAppl = cp(56)
'                     Else
'                        strAppl = cp(ii + 87)
'                     End If
'                  End If
'                  If strAppl = "" Then
'                     Exit For
'                  Else
'                     strAppl = ChangeCustomerL(strAppl)
'                  End If
'                  strSql = "SELECT NVL(CU04,'') CU04,decode(CU05,null,'',CU05||' '||CU88||' '||CU89||' '||CU90) CU05,NVL(CU06,'') CU06" & _
'                           " FROM CUSTOMER WHERE CU01='" & Mid(strAppl, 1, 8) & "' AND CU02='" & Mid(strAppl, 9, 1) & "' "
'                  CheckOC
'                  With adoRecordset
'                     .CursorLocation = adUseClient
'                     .Open strSql, cnnConnection, adOpenForwardOnly, adLockReadOnly
'                     If .RecordCount > 0 Then
'                        If ii = 1 Then
'                           strContent = strContent & vbCrLf & _
'                               IIf(cp(10) = 變更, "申請人：", IIf(cp(10) = 讓與, "移轉、讓與申請人：", "合併申請人：")) & strAppl & " " & .Fields("CU04") & " " & .Fields("CU05")
'                        Else
'                           strContent = strContent & vbCrLf & _
'                               IIf(cp(10) = 變更, "　　　　", IIf(cp(10) = 讓與, "　　　　　　　　　", "　　　　　　")) & strAppl & " " & .Fields("CU04") & " " & .Fields("CU05")
'                        End If
'                     End If
'                  End With
'               Next ii
            End If
            strContent = strContent & vbCrLf & vbCrLf & _
                         "承辦人員：" & strUserName & strUserNum & vbCrLf & _
                         "程序人員：" & GetPrjSalesNM(strFCPHandler) & strFCPHandler & vbCrLf & vbCrLf
         Else '1.舊案收文
            'Add By Sindy 2022/11/28 未付帳款
            strA1kDA = PUB_GetNotPayA1K(" and a1k13='" & pa(1) & "' and a1k14='" & pa(2) & "' and a1k15='" & pa(3) & "' and a1k16='" & pa(4) & "'")
            
            'Modify By Sindy 2022/9/13 + 顯示年費第幾年 + & IIf(cp(10) = "605", "（第 " & strYear & " 年）", "")
            strYear = ""
            'Modify By Sindy 2024/2/21 +601
            If cp(10) = "605" Or cp(10) = "601" Then
               'Call PUB_Getnexttimes(pa(1), pa(2), pa(3), pa(4), strYear, , cp(10))
               'Modify By Sindy 2024/2/21 改抓收文當下的資料即可
               'Added by Lydia 2024/02/22 FCP案由程序輸入繳費年度;FMP案在收文時會輸入繳費年度
               If cp(1) = "FCP" Then
                  Call PUB_Getnexttimes(pa(1), pa(2), pa(3), pa(4), strYear, , cp(10))
                  strYear = "（繳費年度：第 " & strYear & " 年）"
               Else
               'end 2024/02/22
                  If cp(53) = cp(54) Then
                     strYear = "（繳費年度：第 " & cp(53) & " 年）"
                  Else
                     strYear = "（繳費年度：第 " & cp(53) & " 年至第 " & cp(54) & " 年）"
                  End If
               End If 'Added by Lydia 2024/02/22
            End If
            '2022/9/13 END
            'Add By Sindy 2025/8/19
            If m_LOS15 <> "" Then
               strContent = strContent & "案源單號：" & m_LOS15 & vbCrLf & vbCrLf
            End If
            '2025/8/19 END
            strContent = strContent & _
                         "本所案號：" & cp(1) & "-" & cp(2) & IIf(cp(3) & cp(4) = "000", "", "-" & cp(3) & "-" & cp(4)) & "；案件性質：" & strCaseProperty & strYear & vbCrLf & vbCrLf & _
                         "法定期限：" & ChangeWStringToTDateString(cp(7)) & vbCrLf & _
                         "約定期限：" & IIf(Val(strNP23) > 0, ChangeWStringToTDateString(strNP23) & IIf(bolFMPY53374 = False And bolFMP = True, " (非客戶指定期限)", ""), "") & vbCrLf & _
                         "本所期限：" & ChangeWStringToTDateString(cp(6)) & vbCrLf & _
                         "本所人員：" & strUserName & strUserNum & vbCrLf
         End If
         strContent = strContent & _
                      "國　別：" & strNaName & vbCrLf & _
                      "代理人名稱（英）：" & strFC_Name & vbCrLf & _
                      "客戶名稱（英）：" & strApplName & vbCrLf & _
                      "彼所案號：" & strPA77 & vbCrLf & _
                      "客戶案件案號：" & strPA48 & vbCrLf & _
                      "申請案號：" & StrPA11 & vbCrLf & _
                      "專利號數：" & strPA22 & vbCrLf & _
                      "聯絡人：" & strConAPPL & vbCrLf & _
                      IIf(strA1kDA <> "", "未付帳款：" & strA1kDA & vbCrLf, "") & _
                      vbCrLf
         'Modify By Sindy 2022/10/11
         If cp(10) = 讓與 Or cp(10) = 合併 Then
            If GetFCPF23OrderText(cp, pa, strContent) = True Then
               strContent = strContent & vbCrLf
            End If
         End If
         '2022/10/11 END
         'Modify By Sindy 2025/7/10 + （）非本所案件之年費代繳 [僅代繳年費，未變更代理人，申請書上申請人不出名]
         '                            （）送件當天報告
         strContent = strContent & _
                      "案件事項：" & vbCrLf & _
                      "（）新案提申期限" & vbCrLf & _
                      "（）               前/當天送件" & vbCrLf & _
                      "（）實審+主動修正；（）實審+分割；（）暫不繳實審規費" & vbCrLf & _
                      "（）優先處理/送件（    年    月    日前須回覆/報告/請款）" & vbCrLf & _
                      "（）待接獲指示再送件" & vbCrLf & _
                      "（）期限將屆前再送件" & vbCrLf & _
                      "（）    年    月    日前未獲相反指示再送件" & vbCrLf & _
                      "（）約定期限再送件" & vbCrLf & _
                      "（）期限不得再延" & vbCrLf & _
                      "（）收款後再辦/送件（請管制：    年    月    日）" & vbCrLf & _
                      "（）無指示先行收文" & vbCrLf & _
                      "（）依工程師指示收文" & vbCrLf & _
                      "（）已先會工程師" & vbCrLf & _
                      "（）自動領證/實審/年費收文 [GI]" & vbCrLf & _
                      "（）非本所案件之年費代繳 [僅代繳年費，未變更代理人，申請書上申請人不出名]" & vbCrLf & vbCrLf & _
                      "備註：" & vbCrLf & _
                      "（）送件當天報告" & vbCrLf & vbCrLf
         'Modify By Sindy 2022/8/25 +（）固定價目表
         strContent = strContent & _
                      "注意事項：" & vbCrLf & _
                      "（）已補/改彼號（）已補/改(客戶)案件案號（）已補/改1st、2nd彼所聯絡人（）已增/改matter ID" & vbCrLf & _
                      "（）支票、匯款 (US$___________)：（）已收（）將至" & vbCrLf & _
                      "（）優先請款（）特殊請款（）固定價目表" & vbCrLf & _
                      "（）key不請款：（）依工程師指示（）固定價目表該項合併於別項請款" & vbCrLf & _
                      "（）已報價__________"
                      
      Case "5" '5.不續辦閉卷
         '主旨
         strSubject = "【FCP連絡單】不續辦/閉卷 Our Ref: " & cp(1) & "-" & cp(2) & IIf(cp(3) & cp(4) = "000", "", "-" & cp(3) & "-" & cp(4)) & " [NONCON./CLOFILE.]"
         strTo = strFCPHandler & ";" & strFCPHandlerST52 '程序人員及其主管
         strCC = strUserNumST52 & "; backup" '承辦主管; backup
         '主管休假,CC人事職代
         strRestEmp = GetCaseDutyAgent(strUserNumST52, "", False, , , "1")
         If strRestEmp <> "" Then
            strCC = strCC & ";" & strRestEmp
            strCCText = IIf(strCCText <> "", strCCText & "、", "") & strRestKind
         End If
         
         'Add By Sindy 2022/11/28 未付帳款
         strA1kDA = PUB_GetNotPayA1K(" and a1k13='" & pa(1) & "' and a1k14='" & pa(2) & "' and a1k15='" & pa(3) & "' and a1k16='" & pa(4) & "'")
            
         If strCCText <> "" Then strContent = "因收件人" & strCCText & "，請副本收件人處理此郵件。" & vbCrLf & vbCrLf
         strContent = strContent & _
                      "本所案號：" & cp(1) & "-" & cp(2) & IIf(cp(3) & cp(4) = "000", "", "-" & cp(3) & "-" & cp(4)) & vbCrLf & _
                      "受文者：" & GetPrjSalesNM(strFCPHandler) & strFCPHandler & vbCrLf & _
                      "發文者：" & strUserName & strUserNum & vbCrLf
         strContent = strContent & _
                      "國　別：" & strNaName & vbCrLf & _
                      "代理人名稱（英）：" & strFC_Name & vbCrLf & _
                      "客戶名稱（英）：" & strApplName & vbCrLf & _
                      "彼所案號：" & strPA77 & vbCrLf & _
                      "客戶案件案號：" & strPA48 & vbCrLf & _
                      "申請案號：" & StrPA11 & vbCrLf & _
                      "專利號數：" & strPA22 & vbCrLf & _
                      "聯絡人：" & strConAPPL & vbCrLf & _
                      vbCrLf & _
                      vbCrLf
         strContent = strContent & _
                      "（）D/N run C 類工程師報告" & vbCrLf & _
                      "（）查本案前款均已付清" & vbCrLf & _
                      "（）未付帳款：" & strA1kDA & vbCrLf & _
                      vbCrLf & _
                      "（）907不續辦：（）1.銷年費管制（）2.告代後（）3.審查中" & vbCrLf & _
                      "（）期限屆,未獲指示" & vbCrLf & _
                      "（）代理人指示不繳年費" & vbCrLf & _
                      "（）透過其他管道代繳年費" & vbCrLf & _
                      "（）不續辦請款：（）A.未獲指示（）B.已獲指示" & vbCrLf & _
                      "（）後續准駁簡單報告：（）後續准報告（）駁不報告" & vbCrLf & _
                      "（）需管制年費6個月期限" & vbCrLf & _
                      vbCrLf & _
                      vbCrLf & _
                      "（）913 閉卷：（）1.已獲准（）2.核駁後（）3.審查中（）4.未提審" & vbCrLf & _
                      "（）請銷本所年費期限管制" & vbCrLf & _
                      "（）閉卷請款" & vbCrLf & _
                      "（）不請款" & vbCrLf & _
                      vbCrLf & _
                      "原因：（）2.轉他所(CPA)（）4.另案重提（）6.放棄（）9.撤回（）13.沒指示（）15.指示不繳/辦（）其他："
   End Select
   
   '有內容及收件者才需要呼叫Outlook草稿
   If strContent <> "" And strTo <> "" Then
      '呼叫新郵件：
      Set objOutLook = CreateObject("Outlook.Application")
      Set objMail = objOutLook.CreateItem(0)
      
      '轉HTML格式
      strContent = Replace(strContent, "新細明體", "Times New Roman")
      '&nbsp; 不換行空格
      '&thinsp; 窄空格
      '單純只是想要輸入空白？ &nbsp; 就對了
      '&emsp; 全形空格
      '&ensp; 半形空格
      'strContent = Replace(strContent, "　", "&emsp;") '&emsp; 全形空格
      strContent = Replace(strContent, " ", "&thinsp;") '&ensp; 半形空格
      strContent = Replace(strContent, vbCrLf, "<BR>")
      
'      If TypeName(objOutLook.Assistant) <> "Nothing" Then
'         objOutLook.ActiveWindow.WindowState = 1 '0.最大化 1.視窗小點
'      End If
      With objMail
         '.BodyFormat = 2 '2=olFormatHTML 1=olFormatPlain 3=olFormatRichText
         .To = strTo
         .cc = strCC
         If strAttach <> "" Then
            .Attachments.add strAttach '加附件
         End If
         .Subject = strSubject
         .HTMLBody = strContent
         .Display
      End With
      
      PUB_RecvOutLookF23 = True '草稿產生成功
      Set objMail = Nothing
      Set objOutLook = Nothing
   End If
   
   Set adoRst = Nothing
End Function

'Add By Sindy 2024/4/18 匯出Outlook
Public Sub EmpFlowFCPOutlook(strEEP01 As String, strCP01 As String, strCP02 As String, strCP03 As String, strCP04 As String, _
   strCaseName As String, strCP10Nm As String)
Dim adoRst As ADODB.Recordset
Dim objOutLook As Object
Dim objMail As Object
Dim strEEP02 As String
Dim strContent As String, strSubject As String
   
   strEEP02 = UCase(InputBox("請輸入欲帶出的順序？ (多個時請用逗號,區隔 ex:6,8)" & vbCrLf & _
                             "註：沒有輸入代表歷程全部帶出" & vbCrLf & vbCrLf & _
                             "輸入【 X 】視為取消，不匯出。"))
   If strEEP02 = "X" Then
      Exit Sub
   End If
   
   strContent = "本所案號：" & strCP01 & "-" & strCP02 & "-" & strCP03 & "-" & strCP04 & vbCrLf & _
                "案件名稱：" & strCaseName & vbCrLf & _
                "案件性質：" & strCP10Nm & vbCrLf & vbCrLf
   
   strExc(0) = "select empelectronprocess.*,s1.st02 as eep03Nm,s2.st02 as eep05Nm,ac03" & _
               " from empelectronprocess,staff s1,staff s2,allcode" & _
               " where eep01='" & strEEP01 & "'" & IIf(strEEP02 <> "", " and eep02 in(" & strEEP02 & ")", "") & _
               " and eep03=s1.st01(+) and eep05=s2.st01(+)" & _
               " and ac01='09' And eep04=ac02(+)" & _
               " order by eep02 desc"
   intI = 1
   Set adoRst = ClsLawReadRstMsg(intI, strExc(0))
   If intI = 1 Then
      Do While Not adoRst.EOF
         strContent = strContent & _
                      "發送者：" & adoRst.Fields("eep03Nm") & vbCrLf & _
                      "收受者：" & adoRst.Fields("eep05Nm") & vbCrLf & _
                      IIf("" & adoRst.Fields("eep10") <> "", "副本收受者：" & PUB_ReadUserData("" & adoRst.Fields("eep10")) & vbCrLf, "") & _
                      "時　間：" & ChangeWStringToTDateString(adoRst.Fields("eep06")) & " " & Format(adoRst.Fields("eep07"), "00:00:00") & vbCrLf & _
                      "流程狀態：" & adoRst.Fields("ac03") & vbCrLf & _
                      "內　容：" & vbCrLf & adoRst.Fields("eep08") & vbCrLf & vbCrLf
         adoRst.MoveNext
      Loop
   End If
   
   '呼叫新郵件：
   Set objOutLook = CreateObject("Outlook.Application")
   Set objMail = objOutLook.CreateItem(0)
   
   '轉HTML格式
   strContent = Replace(strContent, "新細明體", "Times New Roman")
   '&nbsp; 不換行空格
   '&thinsp; 窄空格
   '單純只是想要輸入空白？ &nbsp; 就對了
   '&emsp; 全形空格
   '&ensp; 半形空格
   'strContent = Replace(strContent, "　", "&emsp;") '&emsp; 全形空格
   strContent = Replace(strContent, " ", "&thinsp;") '&ensp; 半形空格
   strContent = Replace(strContent, vbCrLf, "<BR>")
   
   strSubject = "【呈報】" & strCP01 & "-" & strCP02 & " " & strCP10Nm & "不請款理由"
                     
'      If TypeName(objOutLook.Assistant) <> "Nothing" Then
'         objOutLook.ActiveWindow.WindowState = 1 '0.最大化 1.視窗小點
'      End If
   With objMail
      '.BodyFormat = 2 '2=olFormatHTML 1=olFormatPlain 3=olFormatRichText
      .To = ""
      .cc = ""
      .Subject = strSubject
      .HTMLBody = strContent
      .Display
   End With
   
   Set objMail = Nothing
   Set objOutLook = Nothing
   Set adoRst = Nothing
End Sub

'Add By Sindy 2022/11/28 未付帳款
'Modify by Amy 2025/04/30 +bolSqlOnly 只回傳語法
'Modify by Amy 2025/08/14 +回傳筆數
Public Function PUB_GetNotPayA1K(strWhSql As String, Optional ByVal bolSqlOnly As Boolean = False, Optional ByRef stCnt As String) As String
Dim strA1kDA As String

   PUB_GetNotPayA1K = "": strA1kDA = ""
   stCnt = "" 'Add by Amy 2025/08/14
   If strWhSql = "" Then Exit Function
   
   strSql = "select A1K01,substrb(' '||sqldatet(A1K02),-9) A1K02,A1K08,A1K18" & _
            " From acc1k0" & _
            " where nvl(a1k12, 0)=0 And a1k25 Is Null And a1k29 Is Null" & strWhSql & _
            " order by a1k13,a1k14,a1k15,a1k16,A1K01"
  'Add by Amy 2025/04/30
   If bolSqlOnly = True Then
      PUB_GetNotPayA1K = strSql
      Exit Function
   End If
   
   CheckOC
   With adoRecordset
      .CursorLocation = adUseClient
      .Open strSql, cnnConnection, adOpenForwardOnly, adLockReadOnly
      stCnt = .RecordCount 'Add by Amy 2025/08/14
      If .RecordCount > 0 Then
         .MoveFirst
         Do While Not .EOF
            If strA1kDA <> "" Then strA1kDA = strA1kDA & "、"
            strA1kDA = strA1kDA & .Fields("A1K01") & "(" & Trim(.Fields("A1K02")) & ")" & .Fields("A1K18") & " " & .Fields("A1K08")
            .MoveNext
         Loop
      End If
   End With
   PUB_GetNotPayA1K = strA1kDA
End Function


'Add By Sindy 2022/10/11
Private Function GetFCPF23OrderText(cp() As String, pa() As String, ByRef strContent As String) As Boolean
Dim ii As Integer
Dim strAppl As String
   
   GetFCPF23OrderText = False
   '變更時，抓首件之(客戶編號 + 客戶名稱(中) + (英)),若有一個以上也一併列出
   '讓與時，抓首件收文時KEY入之移轉、讓與申請人：(客戶編號+客戶名稱(中)+(英)),若有一個以上也一併列出
   '合併時，抓首件收文時KEY入之移轉、讓與申請人：(客戶編號+客戶名稱(中)+(英)),若有一個以上也一併列出
   For ii = 1 To 5
      If cp(10) = 變更 Then
         strAppl = pa(ii + 25)
      Else
         If ii = 1 Then
            strAppl = cp(56)
         Else
            strAppl = cp(ii + 87)
         End If
      End If
      If strAppl = "" Then
         Exit For
      Else
         strAppl = ChangeCustomerL(strAppl)
      End If
      strSql = "SELECT NVL(CU04,'') CU04,decode(CU05,null,'',CU05||' '||CU88||' '||CU89||' '||CU90) CU05,NVL(CU06,'') CU06" & _
               " FROM CUSTOMER WHERE CU01='" & Mid(strAppl, 1, 8) & "' AND CU02='" & Mid(strAppl, 9, 1) & "' "
      CheckOC
      With adoRecordset
         .CursorLocation = adUseClient
         .Open strSql, cnnConnection, adOpenForwardOnly, adLockReadOnly
         If .RecordCount > 0 Then
            GetFCPF23OrderText = True
            If ii = 1 Then
               strContent = strContent & vbCrLf & _
                   IIf(cp(10) = 變更, "申請人：", IIf(cp(10) = 讓與, "移轉、讓與申請人：", "合併申請人：")) & strAppl & " " & .Fields("CU04") & " " & .Fields("CU05")
            Else
               strContent = strContent & vbCrLf & _
                   IIf(cp(10) = 變更, "　　　　", IIf(cp(10) = 讓與, "　　　　　　　　　", "　　　　　　")) & strAppl & " " & .Fields("CU04") & " " & .Fields("CU05")
            End If
         End If
      End With
   Next ii
End Function

'Add By Sindy 2023/1/18 本案尚缺
Private Function ChkPaperKurangnya(cp() As String, ByVal intRow As Integer, ByRef strContent As String) As Boolean
   ChkPaperKurangnya = False
   
   '帶下一程序202(補文件),232(補優先權證明),240(補轉讓證明)
   strExc(0) = "Select NP08,NP09,np23,NP15 From NextProgress " & _
               "Where NP02='" & cp(1) & "' And NP03='" & cp(2) & "' And NP04='" & cp(3) & "' And NP05='" & cp(4) & "'" & _
               " And NP07 in ('202','232','240') And NP06 is null " & _
               "order by NP08 asc"
   intI = 1
   Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
   If intI = 1 Then
      ChkPaperKurangnya = True
      intRow = intRow + 1
      strContent = strContent & intRow & ".本案尚缺:" & vbCrLf
      Do While Not RsTemp.EOF
         strContent = strContent & "  " & Replace(Trim("" & RsTemp.Fields("np15")) & " (" & _
                                    IIf(Val("" & RsTemp.Fields("np23")) > 0, " 約定期限：" & ChangeWStringToTDateString("" & RsTemp.Fields("np23")), "") & _
                                    IIf(Val("" & RsTemp.Fields("np08")) > 0, " 本所期限：" & ChangeWStringToTDateString("" & RsTemp.Fields("np08")), "") & _
                                    IIf(Val("" & RsTemp.Fields("np09")) > 0, " 法定期限：" & ChangeWStringToTDateString("" & RsTemp.Fields("np09")), "") & _
                                   ")", "( ", "(") & vbCrLf
         RsTemp.MoveNext
      Loop
   Else
      intRow = intRow + 1
      strContent = strContent & intRow & ".文件齊備" & vbCrLf
   End If
End Function

'Add By Sindy 2023/4/24 外商信件沖銷機制
Public Function PUB_IPDeptEMailF1UptRec(pIR01 As String, pIR02 As String, pIR03 As String, pIR04 As String, pFrmName As String, _
   pIR16 As String, strUpdTime As String, Optional pCRecNo As String = "") As Boolean
Dim rsA As New ADODB.Recordset
Dim strIR22 As String
Dim strII29 As String '信件主檔的處理結果
Dim bolSysDel As Boolean '是否自沖
Dim strFileName As String
Dim strCP01 As String, strCP02 As String, strCP03 As String, strCP04 As String
Dim strCP07 As String
Dim ii As Integer
Dim m_ABS001_1 As String, m_ABS001_2 As String, m_ABS001_3 As String
Dim strText As String, tmpArr As Variant, intTotRunTime As Integer
   
   PUB_IPDeptEMailF1UptRec = False
   Screen.MousePointer = vbHourglass 'Add By Sindy 2023/6/12
   
   '檢查信件是否已被上確認日期,若有,確認人員又不是自己代表有人同時再進行操作
   'If pIR04 = strUserNum Then
      strExc(0) = "select ir01,ir08,ir10,ir19,ir22,st02 from InputRecord,staff" & _
                  " where ir01=" & pIR01 & " and ir02=" & pIR02 & " and ir03='" & pIR03 & "' and ir04='" & pIR04 & "'" & _
                    " and ir10=st01(+)"
      intI = 1
      Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
      If intI = 1 Then
         If Val(RsTemp.Fields("ir08")) > 0 Then
            If "" & RsTemp.Fields("ir10") <> strUserNum Then
               MsgBox "此信件 (" & RsTemp.Fields("st02") & ") 已操作，請確認！"
               Exit Function
            End If
         End If
      End If
   'End If
   
   bolSysDel = True '自沖
   
   If pCRecNo <> "" Then
      strExc(0) = "select * from caseprogress" & _
                  " where cp09='" & pCRecNo & "'"
      intI = 1
      Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
      If intI = 1 Then
         strCP01 = RsTemp.Fields("cp01")
         strCP02 = RsTemp.Fields("cp02")
         strCP03 = RsTemp.Fields("cp03")
         strCP04 = RsTemp.Fields("cp04")
         strCP07 = "" & RsTemp.Fields("cp07")
      End If
   End If
   If Pub_StrUserSt03 = "F11" And UCase(pFrmName) = "FRM010001" Then
      strII29 = "1" '舊案收文
      
   ElseIf UCase(pFrmName) = "FRM140404" Then
      strII29 = "6" '往來記錄
      
   ElseIf pIR16 = "9" Then '回信
      strII29 = "10" '回信
      bolSysDel = False
      
   ElseIf pIR16 = "2" Then '不處理
      strII29 = "8"
      If InStr(Pub_GetSpecMan("外商信件需經主核名單"), pIR04) > 0 Then
         bolSysDel = False '主核
      End If
      
   ElseIf pIR16 = "5" Then '已處理
      strII29 = "12"
      If InStr(Pub_GetSpecMan("外商信件需經主核名單"), pIR04) > 0 Then
         bolSysDel = False '主核
      End If
      
   ElseIf pIR16 = "1" Then '輸入
      strII29 = "9"
      '來函輸入,C類有法定期限者,不能自沖
      If Left(pCRecNo, 1) = "C" And Val(strCP07) > 0 Then
         bolSysDel = False
      End If
      
   Else
      strII29 = ""
   End If
   
   '承辦組有人操作動作,其他未處理承辦組的收受者一併沖銷(主核後面程式會判斷)
   'If Pub_StrUserSt03 = "F11" And Not (pIR16 = "2" And bolSysDel = True) Then '不含(不處理的自沖)
   'Modify By Sindy 2023/9/21 排除不處理; 取消exists條件中的 and instr('" & Pub_GetSpecMan("外商信件需經主核名單") & "',st01)=0
   If Pub_StrUserSt03 = "F11" And pIR16 <> "2" Then
      strSql = "update InputRecord set ir08=" & strSrvDate(1) & ",ir09=" & strUpdTime & ",ir10='" & strUserNum & "'" & _
               " where ir01=" & pIR01 & " and ir02=" & pIR02 & " and ir03='" & pIR03 & "' and ir08=0" & _
               " and exists(select st01 from staff where st01=ir04 and st03='F11')"
      cnnConnection.Execute strSql, intI
   End If
   
   '自沖
   If bolSysDel = True Then
      strSql = "update InputRecord set ir08=" & strSrvDate(1) & ",ir09=" & strUpdTime & ",ir10='" & strUserNum & "'" & _
               " where ir01=" & pIR01 & " and ir02=" & pIR02 & " and ir03='" & pIR03 & "' and ir04='" & pIR04 & "' and ir08=0"
      cnnConnection.Execute strSql, intI
      
      strExc(0) = "select ir01 from InputRecord" & _
                  " where ir01=" & pIR01 & _
                    " and ir02=" & pIR02 & _
                    " and ir03='" & pIR03 & "'" & _
                    " and ir08=0"
      intI = 1
      Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
      If intI = 0 Then
         '上Msg檔可刪除日期
         strSql = "update IPDeptInput set ii16=" & strSrvDate(1) & _
                  " where ii01=" & pIR01 & " and ii02=" & pIR02 & " and ii03='" & pIR03 & "' and ii16=0"
         cnnConnection.Execute strSql, intI
      End If
      
   '主核:
   Else
      'CFT61:CFT承辦人第１組主管=80030; CFT62:CFT承辦人第２組主管=78011 自行判發不做2次確認
      If Not (strII29 = "9" And (InStr(Pub_GetSpecMan("CFT61"), strUserNum) > 0 Or _
                                 InStr(Pub_GetSpecMan("CFT62"), strUserNum) > 0)) Then
         '2,3,4級主管+部門主管
         strSql = "Select st01,st02,st52||','||st53||','||st54||','||a0908 as STNo,st52,st53,st54,a0908 from staff,acc090" & _
                 " where st01='" & pIR04 & "' and st03=a0901"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strSql)
         If intI = 1 Then
            strIR22 = "" & RsTemp.Fields("a0908") '預設值
            m_ABS001_1 = "" & RsTemp.Fields("STNo")
            intTotRunTime = 1
         End If
   '      If strII29 = "9" Then '輸入
   '         '(1)案件職代
   '         Call GetABS001_3(pIR04, m_ABS001_1, m_ABS001_2, m_ABS001_3, "")
   '         If m_ABS001_1 = "" Then
   '            '(2)一般人事職代
   '            Call GetABS001_1(pIR04, m_ABS001_1, m_ABS001_2, m_ABS001_3)
   '         End If
   '         intTotRunTime = 3
   '      End If
         For ii = 1 To intTotRunTime
            If ii = 1 Then strText = m_ABS001_1
            If ii = 2 Then strText = m_ABS001_2
            If ii = 3 Then strText = m_ABS001_3
            If strText <> "" Then
               tmpArr = Split(strText, ",")
               For intI = 0 To UBound(tmpArr)
                  If Trim(tmpArr(intI)) <> "" Then
                     If ChkStaffST04(CStr(tmpArr(intI)), False) = False Then '在職
                        strIR22 = Trim(tmpArr(intI))
                        Exit For
                     End If
                  End If
               Next intI
               If strIR22 <> "" Then Exit For
            End If
         Next ii
         '因為要主核,所以該收受者信件加註確認人員,拿掉確認日期時間人員
         strSql = "update InputRecord set ir08=0,ir09=null,ir10=null,ir22='" & strIR22 & "'" & _
                  " where ir01=" & pIR01 & " and ir02=" & pIR02 & " and ir03='" & pIR03 & "' and ir04='" & pIR04 & "'"
         cnnConnection.Execute strSql, intI
         'Add By Sindy 2023/9/21 沖掛此主管為收受者的信件
         strSql = "update InputRecord set ir08=" & strSrvDate(1) & ",ir09=" & strUpdTime & ",ir10='" & strUserNum & "'" & _
                  " where ir01=" & pIR01 & " and ir02=" & pIR02 & " and ir03='" & pIR03 & "' and ir04='" & strIR22 & "' and ir08=0"
         cnnConnection.Execute strSql, intI
         '2023/9/21 END
      End If
   End If
   
   '有傳入文號,代表要歸卷
   If pCRecNo <> "" Then
      '檢查卷宗區是否已有此信件,若有,無需重覆歸卷
      strFileName = "." & pIR01 & Format(pIR02, "0#####") & "." & pIR03 & "."
      strExc(0) = "select cpp01 from casepaperpdf" & _
                  " where instr(cpp02,'" & strFileName & "')>0"
      If strII29 = "9" Then '輸入
         strExc(0) = strExc(0) & " and cpp01='" & pCRecNo & "'"
      End If
      intI = 1: strExc(10) = ""
      Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
      If intI = 1 Then
         strExc(10) = "Y"
      End If
      If strExc(10) = "" Then
         '下載信件檔,上傳卷宗區
         '輸入作業的歸卷,副檔名為代理人來函
         Call PUB_UploadPatentLetterFile(pIR01, pIR03, pCRecNo, IIf(strII29 = "9", "ALTR", ""))
         '記錄歸檔文號
         strSql = "update InputRecord set ir21='" & pCRecNo & "'" & _
                  " where ir01=" & pIR01 & " and ir02=" & pIR02 & " and ir03='" & pIR03 & "' and ir04='" & pIR04 & "'"
         cnnConnection.Execute strSql, intI
      Else
         strExc(0) = "select cpp01 from casepaperpdf" & _
                     " where instr(cpp02,'" & strFileName & "')>0" & _
                     " and cpp01='" & pCRecNo & "'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 0 Then
            '沒有做到歸檔,取消文號
            strSql = "update InputRecord set ir21=null" & _
                     " where ir01=" & pIR01 & " and ir02=" & pIR02 & " and ir03='" & pIR03 & "' and ir04='" & pIR04 & "'"
            cnnConnection.Execute strSql, intI
         End If
      End If
   End If
   
   '更新信件主檔的處理結果
   If strII29 <> "" Then
      '(自沖的不處理)最後一筆時,才上主檔的處理結果
      If bolSysDel = True And strII29 = "8" Then
         strExc(0) = "select * from InputRecord,staff" & _
                     " where ir01=" & pIR01 & " and ir02=" & pIR02 & " and ir03='" & pIR03 & "' and ir08=0" & _
                     " and st01=ir04 and substr(st03,1,2)='F1'"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
         If intI = 0 Then
            '處理結果尚是空白或歸卷
            'Modify By Sindy 2023/8/7 and (ii29 is null or ii29='11')
            strSql = "update IPDeptInput set ii29='" & strII29 & "'" & _
                     " where ii01=" & pIR01 & " and ii02=" & pIR02 & " and ii03='" & pIR03 & "' and (ii29 is null or ii29='11')"
            cnnConnection.Execute strSql, intI
         End If
      Else
         '處理結果尚是空白或歸卷
         'Modify By Sindy 2023/8/7 and (ii29 is null or ii29='11')
         strSql = "update IPDeptInput set ii29='" & strII29 & "'" & _
                  " where ii01=" & pIR01 & " and ii02=" & pIR02 & " and ii03='" & pIR03 & "' and (ii29 is null or ii29='11')"
         cnnConnection.Execute strSql, intI
         'Add By Sindy 2023/7/25 轉寄後再次沖銷
         If intI = 0 Then
            strExc(0) = "select ir01,ii29 from inputrecord,IPDeptInput" & _
                        " where ir01=" & pIR01 & " and ir02=" & pIR02 & " and ir03='" & pIR03 & "' and ir04='" & pIR04 & "' and ir13<>'QPGMR' and ir22 is null" & _
                        " and ir01=ii01 and ir03=ii03"
            intI = 1
            Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
            If intI = 1 Then
               strExc(10) = "" & RsTemp.Fields("ii29")
               strSql = "update IPDeptInput set ii29='" & strII29 & "'" & _
                        " where ii01=" & pIR01 & " and ii02=" & pIR02 & " and ii03='" & pIR03 & "'"
               cnnConnection.Execute strSql, intI
               If strExc(10) <> strII29 Then
                  PUB_SendMail strUserNum, "97038", "", "轉寄後再次沖銷(尚在檢查狀況用<11=歸卷 10=回信>) 舊的處理原因=" & strExc(10) & " 新的處理原因=" & strII29, strSql, , , , , , , , , , True
               End If
            End If
         End If
         '2023/7/25 END
      End If
   End If
   
   Screen.MousePointer = vbDefault 'Add By Sindy 2023/6/12
   Set rsA = Nothing
   PUB_IPDeptEMailF1UptRec = True
End Function

'寫記錄
Public Function PUB_WriteLog(oStrLog As String)
   Dim ffa As Integer
   ffa = FreeFile
   Open App.path & "\" & App.EXEName & ".log" For Append As ffa
   Print #ffa, Trim(Now) & "  ==>  " & oStrLog
   Close ffa
End Function

'Added by Morgan 2020/12/21
'脫歐英國案回覆單歸卷
Public Sub PUB_EUtoUK(pUK1 As String, pUK2 As String, pUK3 As String, pUK4 As String, pEU1 As String, pEU2 As String, pEU3 As String, pEU4 As String, pCP09 As String, pCP10 As String)
   Dim stUKCNo As String, stEUCNo As String
   Dim stSQL As String, intR As Integer
   
   stUKCNo = pUK1 & pUK2 & IIf(pUK3 & pUK4 <> "000", "-" & pUK3, "") & IIf(pUK4 <> "00", "-" & pUK4, "")
   stEUCNo = pEU1 & pEU2 & IIf(pEU3 & pEU4 <> "000", "-" & pEU3, "") & IIf(pEU4 <> "00", "-" & pEU4, "")
   stSQL = "update casepaperpdf set cpp01='" & pCP09 & "',cpp02=replace(cpp02,'" & stEUCNo & ".','" & stUKCNo & ".'),cpp10='X' WHERE cpp01='" & pEU1 & pEU2 & pEU3 & pEU4 & "UK' AND instr(upper(cpp02),upper('reply.pdf'))>0 and instr(upper(cpp02),'." & pCP10 & ".')>0 and substr(upper(cpp02),-4)<>'.DEL'"
   cnnConnection.Execute stSQL, intR
   stSQL = "update casepaperpdf set cpp01='" & pCP09 & "',cpp02=replace(cpp02,'" & stEUCNo & ".','" & stUKCNo & "." & pCP10 & ".'),cpp10='X' WHERE cpp01='" & pEU1 & pEU2 & pEU3 & pEU4 & "UK' AND instr(upper(cpp02),upper('reply.pdf'))>0 and instr(upper(cpp02),'." & pCP10 & ".')=0 and substr(upper(cpp02),-4)<>'.DEL'"
   cnnConnection.Execute stSQL, intR
   stSQL = "update casepaperpdf set cpp01='" & pCP09 & "',cpp02=replace(cpp02,'" & stEUCNo & ".','" & stUKCNo & ".'),cpp10='X' WHERE cpp01='" & pEU1 & Val(pEU2) & pEU3 & pEU4 & "UK' AND instr(upper(cpp02),upper('reply.pdf'))>0 and instr(upper(cpp02),'." & pCP10 & ".')>0 and substr(upper(cpp02),-4)<>'.DEL'"
   cnnConnection.Execute stSQL, intR
   stSQL = "update casepaperpdf set cpp01='" & pCP09 & "',cpp02=replace(cpp02,'" & stEUCNo & ".','" & stUKCNo & "." & pCP10 & ".'),cpp10='X' WHERE cpp01='" & pEU1 & Val(pEU2) & pEU3 & pEU4 & "UK' AND instr(upper(cpp02),upper('reply.pdf'))>0 and instr(upper(cpp02),'." & pCP10 & ".')=0 and substr(upper(cpp02),-4)<>'.DEL'"
   cnnConnection.Execute stSQL, intR
End Sub

'Added by Morgan 2020/12/30
Public Function PUB_GetIDSList(ByVal pCaseNo As String, ByRef intQ As Integer) As ADODB.Recordset
   Dim stSQL As String
   '抓已確認的IDS資料
   stSQL = "select cp27,sqldatet(cp27) DDate,i.*" & _
      " from caseprogress,IDSList i" & _
      " where cp01='" & SystemNumber(pCaseNo, 1) & "' and cp02='" & SystemNumber(pCaseNo, 2) & "'" & _
      " and cp03='" & SystemNumber(pCaseNo, 3) & "' and cp04='" & SystemNumber(pCaseNo, 4) & "'" & _
      " and cp10='214' and cp27>0 and cp57 is null and IL01(+)=cp09 and il08 is not null" & _
      " order by il02,DDate,il01,il03"
   intQ = 1
   Set PUB_GetIDSList = ClsLawReadRstMsg(intQ, stSQL)
End Function

'Added by Morgan 2021/2/5
'CFP主案會稿完成更新相同承辦的其他多國案的齊備日
Public Sub PUB_SetEP06ByCR(cr01 As String, cr02 As String, cr03 As String, cr04 As String)
   Dim strCRList As String, strCP14List As String, strCP48 As String
   Dim stSQL As String, intR As Integer
   Dim rsQuery As ADODB.Recordset
   Dim rsQuery2 As ADODB.Recordset
   Dim stCP29F As String 'Added by Morgan 2021/3/17
   
   strCRList = "select '" & cr01 & "' cr01,'" & cr02 & "' cr02,'" & cr03 & "' cr03,'" & cr04 & "' cr04 from dual" & _
      " union select cr05,cr06,cr07,cr08 from caserelation where cr01='" & cr01 & "' and cr02='" & cr02 & "' and cr03='" & cr03 & "' and cr04='" & cr04 & "'"
   
   '**條件有變時，下面抓繪圖人員的語法也要改**
   '檢查是否有多國案主案已發文或會稿完成
   stSQL = "select distinct cp14 from caseprogress,Engineerprogress where (cp01,cp02,cp03,cp04) in (" & strCRList & ") and cp57 is null and  cp10 in (" & CaseMapOut & ") and cp21 is null and ep02(+)=cp09 and nvl(cp27,0)+nvl(ep08,0)>0"
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      strCP14List = Replace("'" & rsQuery.GetString(, , , "','") & "'", ",''", "")
      '未發文未齊備且相同承辦的國外案
      'Modified by Morgan 2021/3/17 +cp29
      stSQL = "select ep02,cp06,cp29,cp14 from caseprogress,Engineerprogress where (cp01,cp02,cp03,cp04) in (" & strCRList & ") and cp27 is null and cp57 is null and  cp10 in (" & CaseMapOut & ") and cp14 is not null and cp14 in (" & strCP14List & ") and ep02(+)=cp09 and ep06 is null"
      intR = 1
      Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         With rsQuery
         .MoveFirst
         Do While Not .EOF
            '更新齊備日
            stSQL = "Update Engineerprogress set ep06=" & strSrvDate(1) & " where ep06 is null and ep02='" & .Fields(0).Value & "'"
            cnnConnection.Execute stSQL, intR
            
            'Added by Morgan 2021/3/17
            '更新繪圖人員
            If IsNull(.Fields("cp29")) Then
               stSQL = "select cp29,st04,st06 from caseprogress,Engineerprogress,staff where (cp01,cp02,cp03,cp04) in (" & strCRList & ") and cp57 is null and  cp10 in (" & CaseMapOut & ") and cp21 is null and ep02(+)=cp09 and nvl(cp27,0)+nvl(ep08,0)>0 and st01(+)=cp29 and cp14='" & .Fields("cp14") & "'"
               intR = 1
               Set rsQuery2 = ClsLawReadRstMsg(intR, stSQL)
               If intR = 1 Then
                  stCP29F = rsQuery2("cp29")
                  If rsQuery2("st04") = "2" Then
                     stSQL = "SELECT ST01 FROM STAFF WHERE ST06='" & rsQuery2("st06") & "' AND ST05='81' and st04='1'"
                     intR = 1
                     Set rsQuery2 = ClsLawReadRstMsg(intR, stSQL)
                     If intR = 1 Then
                        stCP29F = rsQuery2("st01")
                     End If
                  End If
                  stSQL = "Update caseprogress set cp29='" & stCP29F & "'  where cp09='" & .Fields(0).Value & "' and cp29 is null"
                  cnnConnection.Execute stSQL, intR
               End If
            End If
            'end 2021/3/17
            
            '承辦期限
            If PUB_IfSetCP48() Then
               stSQL = "Select cp01,pa09,cp10 From CaseProgress, Patent Where CP09='" & .Fields(0).Value & "' and cp01=pa01(+) and cp02=pa02(+) and cp03=pa03(+) and cp04=pa04(+)"
               intR = 1
               Set rsQuery2 = ClsLawReadRstMsg(intR, stSQL)
               If intR = 1 Then
                  strCP48 = Pub_GetHandleDay(rsQuery2("cp01"), rsQuery2("pa09"), rsQuery2("cp10"), , "" & .Fields(1), .Fields(0))
                  If strCP48 <> "" Then
                     stSQL = "Update caseprogress set cp48=" & strCP48 & " where cp09='" & .Fields(0) & "'"
                     cnnConnection.Execute stSQL, intR
                  End If
               End If
            End If
            .MoveNext
         Loop
         End With
      End If
   End If
End Sub

'Added by Lydia 2021/05/07 傳入本所案號，取得ACS案112智財顧問之簽約期間CP53~CP54
Public Function Pub_GetACS112Range(ByVal pCP01 As String, ByVal pCP02 As String, ByVal pCP03 As String, ByVal pCP04 As String, _
              Optional ByRef pCP09 As String, Optional ByRef pCP15 As String, Optional ByRef pCP53 As String, Optional ByRef pCP54 As String, _
              Optional ByRef pACS01 As String, Optional ByRef pACS02 As String, Optional ByRef pACS03 As String, Optional ByRef pACS04 As String, Optional ByVal pUserNo As String) As Boolean
Dim intQ As Integer, strQ1 As String
Dim rsQD As New ADODB.Recordset
        
    pCP53 = "": pCP54 = ""
    pACS01 = "": pACS02 = "": pACS03 = "": pACS04 = ""
    If pCP03 = "" Then pCP03 = "0"
    If pCP04 = "" Then pCP04 = "00"
    If pUserNo = "" Then pUserNo = strUserNum
    
    Call Proc_R100101_i(pCP01, pCP02, pCP03, pCP04, pUserNo) '將相關卷號存在暫存檔R100101_i
    If pCP01 = "ACS" Then
         '若有傳入總收文號，則讀取該收文號之顧問期間CP53~CP54，若無總收文號則讀取該ACS案未取消收文且收文日最大之智財顧問112之顧問期間CP53~CP54
         strQ1 = "select cp09,cp15,cp53,cp54 from caseprogress where cp09 in (" & _
                    "select substr(max(cp05||cp09),9,9) mno from caseprogress where cp01='" & pCP01 & "' and cp02='" & pCP02 & "' and cp03='" & pCP03 & "' and cp04='" & pCP04 & "' " & _
                     "and cp10='112' and cp159=0 " & IIf(pCP09 <> "", " and cp09='" & pCP09 & "' ", "") & " ) "
    Else
         '非ACS案：相關卷號(CaseRelation1)為ACS且曾有收文智財顧問112
         strQ1 = "select cp01,cp02,cp03,cp04,cp09,cp15,cp53,cp54 from caseprogress where cp09 in (" & _
                    "select substr(max(cp05||cp09),9,9) mno from caseprogress where (cp01,cp02,cp03,cp04) in (select R001001,R001002,R001003,R001004 from R100101_i where id='" & pUserNo & "') " & _
                     "and cp01='ACS' and cp10='112' and cp159=0 " & IIf(pCP09 <> "", " and cp09='" & pCP09 & "' ", "") & " ) "
    End If
    
    intQ = 1
    Set rsQD = ClsLawReadRstMsg(intQ, strQ1)
    If intQ = 1 Then
        pCP09 = "" & rsQD.Fields("cp09")
        pCP15 = Val("" & rsQD.Fields("cp15"))
        pCP53 = "" & rsQD.Fields("cp53")
        pCP54 = "" & rsQD.Fields("cp54")
        If pCP01 <> "ACS" Then
            pACS01 = "" & rsQD.Fields("cp01")
            pACS02 = "" & rsQD.Fields("cp02")
            pACS03 = "" & rsQD.Fields("cp03")
            pACS04 = "" & rsQD.Fields("cp04")
        End If
        
        Pub_GetACS112Range = True
    End If
    
    Set rsQD = Nothing
    
End Function

'Added by Lydia 2021/05/07 ACS智財顧問專業分配比例管制：傳入ACS案號(必傳)用多行文字描述)傳出各專業部門、服務次數、工作時數小計、未發文次數
Public Function ACS112STATISTICS(ByVal iKind As String, ByVal iCP01 As String, ByVal iCP02 As String, ByVal iCP03 As String, ByVal iCP04 As String, _
                      Optional ByRef iCp09 As String, Optional ByRef iCP15 As String, Optional ByRef iCP53 As String, Optional ByRef iCP54 As String, _
                      Optional ByRef pWHours As String, Optional ByRef pWTimes As String, Optional ByRef pNTimes As String, Optional ByRef pUpdSQL As String, Optional ByVal pUserNo As String) As String
'共用模組: ACS112STATISTICS   '計算方法若有異動,請一併修改frm081031_3
'1.  (iKind=1接洽單用)傳入ACS案號(必傳)、總收文號，以陣列方式(可以用多行文字描述)傳出各專業部門、服務次數、工作時數小計、未發文次數，再傳出顧問期間CP53+CP54、簽約時數CP15、已服務時數(工作時數總計)；
'2.  (iKind=2批次用)傳入ACS案號(必傳)、總收文號，若原始分配比例有但是實際並未有任何收文服務的部門也要列出。傳出之陣列組字串(可以用多行文字描述)以下為範例：
'3.  讀取該ACS案和ACS之相關卷號(CaseRelation1)，收文日期在上述之顧問期間且未取消收文進度，以系統類別統計收文次數及工作時數、尚未發文次數，以陣列(可以用多行文字描述)傳出。
Dim intR As Integer, strR1 As String
Dim rsRD As New ADODB.Recordset
Dim strTmpA As String, strTmp2 As String
Dim strRate As String, strTRate As String
Dim strContext As String
Dim strCon1 As String 'Added by Lydia 2023/06/20

    If pUserNo = "" Then pUserNo = strUserNum
    '另外傳出顧問期間CP53+CP54、簽約時數CP15、已服務時數(工作時數總計)、尚未發文次數(總計)
    If Pub_GetACS112Range(iCP01, iCP02, iCP03, iCP04, iCp09, iCP15, iCP53, iCP54, , , , , pUserNo) = False Then '同時將相關卷號存在暫存檔R100101_i
        Exit Function
    End If
   
    'ACS本案非112之收文
    strCon1 = " and cp10 <> '112' " 'Added by Lydia 2023/06/20
    'Modified by Lydia 2023/06/20 改成變數 and cp10 <> '112'=> strCon1
    'Modified by Lydia 2024/05/15 +'ACS' as ord1
    strR1 = "select 'ACS' as ord1, cp01,cp02,cp03,cp04,cp09,cp10,cpm03,nvl(cp113,0) cp113,cp158 from caseprogress,casepropertymap " & _
                "where cp01='" & iCP01 & "' and cp02='" & iCP02 & "' and cp03='" & iCP03 & "' and cp04='" & iCP04 & "' " & _
                "and cp05>=" & iCP53 & " and cp05<=" & iCP54 & " and cp159=0 " & strCon1 & _
                "and cp09<'C' and cp01=cpm01(+) and cp10=cpm02(+) "
    '相關卷號：排除C,D類收文
    'Modified by Lydia 2024/05/15 調整系統別;ex.ACS-000173的相關案為S案
    'strR1 = strR1 & "Union All select cp01,cp02,cp03,cp04,cp09,cp10,cpm03,nvl(cp113,0) cp113,cp158 from caseprogress,casepropertymap " & _
                 "where (cp01,cp02,cp03,cp04) in (select R001001,R001002,R001003,R001004 from R100101_i where id='" & pUserNo & "' and R001001<>'ACS' ) " & _
                 "and cp05>=" & iCP53 & " and cp05<=" & iCP54 & " and cp159=0 and cp09<'C' and cp01=cpm01(+) and cp10=cpm02(+) "
    strR1 = strR1 & "Union All select decode(sk02||sk03,'10','P','50','P','20','T','60','T','11','CFP','51','CFP','21','CFT','61','CFT',DECODE(sk01,'ACS','ACS',CP01)) ord1 " & _
                  ",cp01,cp02,cp03,cp04,cp09,cp10,cpm03,nvl(cp113,0) cp113,cp158 from caseprogress,casepropertymap,systemkind " & _
                 "where (cp01,cp02,cp03,cp04) in (select R001001,R001002,R001003,R001004 from R100101_i where id='" & pUserNo & "' and R001001<>'ACS' ) " & _
                 "and cp05>=" & iCP53 & " and cp05<=" & iCP54 & " and cp159=0 and cp09<'C' and cp01=cpm01(+) and cp10=cpm02(+) and cp01=sk01(+) "
                 
    '先抓已服務次數、已服務時數(工作時數總計)、尚未發文次數(總計)
    strTmpA = "select count(cp09) cnt ,sum(cp113) tot1, sum(decode(cp158,0,1,0)) tot2 from (" & strR1 & " ) "
    intR = 1
    Set rsRD = ClsLawReadRstMsg(intR, strTmpA)
    If intR = 1 Then
        pWHours = Val("" & rsRD.Fields("tot1"))
        pWTimes = Val("" & rsRD.Fields("cnt")) 'Added by Lydia 2023/02/09
        pNTimes = Val("" & rsRD.Fields("tot2"))
        If iKind = "1" Then '接洽單
             'ex.顧問期間：110/4/1~111/3/31，簽約時數：100，已服務次數：7，已服務時數：39　尚未發文次數：
             'Modified by Lydia 2021/07/05 調整格式
             'strContext = strContext & "顧問期間：" & ChangeWStringToTDateString(iCP53) & "~" & ChangeWStringToTDateString(iCP54) & "，簽約時數：" & iCP15 & "，已服務次數：" & Val("" & rsRd.Fields("cnt")) & _
                                                  "，已服務時數：" & pWHours & "，尚未發文次數：" & pNTimes & vbCrLf
             strContext = strContext & "顧問期間：" & ChangeWStringToTDateString(iCP53) & "~" & ChangeWStringToTDateString(iCP54) & "，簽約時數：" & iCP15 & vbCrLf & _
                                                  "已服務次數：" & Val("" & rsRD.Fields("cnt")) & "，已服務時數：" & pWHours & "，尚未發文次數：" & pNTimes & vbCrLf
        ElseIf iKind = "2" Then  '每日批次
            'ex.顧問期間：110/4/1~111/3/31
                '收據號碼：可能多筆
                '簽約時數：100，已服務次數：9，已服務時數：40，服務內容如下：
                'ACS服務次數：2  工作時數小計：12    實際比例：小計/已服務時數   收文分配比例：
                '以系統類別統計收文次數及工作時數、尚未發文次數(多筆)
                '尚未發文明細：(案號+收文號+案件性質)
             'Modified by Lydia 2021/07/05 調整格式
             'strContext = strContext & "顧問期間：" & ChangeWStringToTDateString(iCP53) & "~" & ChangeWStringToTDateString(iCP54) & vbCrLf & _
                                "收據號碼：" & vbCrLf & vbCrLf & _
                                "簽約時數：" & iCP15 & "，已服務次數：" & Val("" & rsRd.Fields("cnt")) & "，已服務時數：" & pWHours & "，尚未發文次數：" & pNTimes & vbCrLf
             strContext = strContext & "顧問期間：" & ChangeWStringToTDateString(iCP53) & "~" & ChangeWStringToTDateString(iCP54) & "，簽約時數：" & iCP15 & vbCrLf & _
                                "收據號碼：" & vbCrLf & vbCrLf & _
                                "已服務次數：" & Val("" & rsRD.Fields("cnt")) & "，已服務時數：" & pWHours & "，尚未發文次數：" & pNTimes & vbCrLf
        End If
    End If
    
    '以系統類別統計收文次數及工作時數、尚未發文次數
    If iKind = "1" Then
        strTmpA = "select cp01, count(cp09) cnt ,sum(cp113) tot1, sum(decode(cp158,0,1,0)) tot2 from (" & strR1 & " ) group by cp01 order by cp01 "
    Else
        '虛建99999999是用來統計資料，避免沒有分配點數記錄會抓不到有實際分配的數據
        'Modified by Lydia 2023/11/29 +人工調整比例取代收文分配比例;+ ar10
        'Modified by Lydia 2024/05/15  ar02=x02(+) and ar02=cp01(+) => ar02=x02(+) and ar02=ord1(+)
        strTmpA = "select ar02,x02,nvl(x03,0) ar03,nvl(x04,0) ar04,nvl(x10,0) ar10,nvl(count(cp09),0) cnt ,nvl(sum(cp113),0) tot1, sum(decode(cp158,0,1,0)) tot2 " & _
                         "from acspfrate ,(select ar01 as x01,ar02 as x02, ar03 as x03, ar04 as x04, ar10 as x10 from acspfrate where ar01='" & iCp09 & "') vtb01 " & _
                         ",(" & strR1 & ") where ar01='99999999' and ar02=x02(+) and ar02=ord1(+) group by ar02,x02,nvl(x03,0),nvl(x04,0),nvl(x10,0) order by 1"
    End If
    intR = 1
    Set rsRD = ClsLawReadRstMsg(intR, strTmpA)
    If intR = 1 Then
        strContext = strContext & vbCrLf '多空一行
        pUpdSQL = ""
        strTmp2 = "0"
        rsRD.MoveFirst
        Do While Not rsRD.EOF
             If iKind = "1" Then  '接洽單
                'ex. ACS服務次數：2  工作時數小計：12　尚未發文次數：
                'Modified by Lydia 2021/07/05 調整格式
                'strContext = strContext & convForm(rsRd.Fields("cp01") & "服務次數：" & rsRd.Fields("cnt"), 16) & _
                                   convForm("工作時數小計：" & rsRd.Fields("tot1"), 18) & _
                                   convForm("尚未發文次數：" & rsRd.Fields("tot2"), 18) & vbCrLf
                strContext = strContext & rsRD.Fields("cp01") & "服務次數：" & rsRD.Fields("cnt") & "，" & _
                                   "工作時數小計：" & rsRD.Fields("tot1") & "，" & _
                                   "尚未發文次數：" & rsRD.Fields("tot2") & vbCrLf
             ElseIf iKind = "2" Then '每日批次：先更新實際分配比例
                'Modified by Lydia 2023/11/29 +Val("" & rsRd.Fields("ar10")) <> 0
                'Modified by Lydia 2024/06/18 + Or Val("" & rsRD.Fields("ar10"))
                If Val("" & rsRD.Fields("ar03")) Or Val("" & rsRD.Fields("ar10")) <> 0 Or Val("" & rsRD.Fields("cnt")) <> 0 Or Val("" & rsRD.Fields("tot1")) <> 0 Or Val("" & rsRD.Fields("tot2")) <> 0 Then
                    '實際分配比例
                    If Val(pWHours) = 0 Or Val("" & rsRD.Fields("tot1")) = 0 Then
                        strRate = "0"
                    Else
                        strRate = Round((Val("" & rsRD.Fields("tot1")) / Val(pWHours)) * 100, 2)
                        '記錄實際分配比例, 於最後一筆修正全部加總=100%
                        strTRate = Val(strTRate) + Val(strRate)
                        strTmp2 = Val(strTmp2) + Val("" & rsRD.Fields("tot1"))
                        If Val(pWHours) = Val(strTmp2) And Val(strTRate) <> 100 Then
                           strRate = strRate + (100 - strTRate)
                        End If
                    End If
                    If "" & rsRD.Fields("x02") <> "" Then  '已有專業分配比例檔=>更新
                        pUpdSQL = pUpdSQL & "update ACSPFrate set ar04=" & CNULL(strRate, True) & ", ar08=" & strSrvDate(1) & ", ar09=" & CNULL(pUserNo) & _
                                        " where ar01='" & iCp09 & "' and ar02='" & rsRD.Fields("x02") & "'  ;"
                    Else  '沒有專業分配比例檔=>補資料
                        'Modified by Lydia 2023/11/29 +ar10
                        pUpdSQL = pUpdSQL & "insert into ACSPFrate (ar01,ar02,ar03,ar04,ar05,ar06,ar07,ar08,ar09,ar10) values (" & _
                                        CNULL(iCp09) & "," & CNULL(rsRD.Fields("ar02")) & ", 0, " & CNULL(strRate, True) & ", '" & pUserNo & "' ," & strSrvDate(1) & "," & Left(Format(ServerTime, "000000"), 4) & "," & strSrvDate(1) & ", '" & pUserNo & "', 0 )  ;"
                    End If
                    'Modified by Lydia 2021/07/05 調整格式
                    'strContext = strContext & convForm(rsRd.Fields("ar02") & "服務次數：" & rsRd.Fields("cnt"), 18) & _
                                       convForm("工作時數小計：" & rsRd.Fields("tot1"), 18) & _
                                       convForm("實際比例：" & strRate & IIf(Val(strRate) <> 0, "%", ""), 18) & _
                                       convForm("收文分配比例：" & rsRd.Fields("ar03") & IIf(Val(rsRd.Fields("ar03")) <> 0, "%", ""), 24) & vbCrLf
                    'Modified by Lydia 2023/11/29 + ar10調整比例, convform
                    'strContext = strContext & rsRd.Fields("ar02") & "服務次數：" & rsRd.Fields("cnt") & "，" & _
                                       "工作時數小計：" & rsRd.Fields("tot1") & "，" & _
                                       "實際比例：" & Val(strRate) & "%，" & _
                                       "收文分配比例：" & Val(rsRd.Fields("ar03")) & "%" & vbCrLf
                    strContext = strContext & convForm(rsRD.Fields("ar02"), 4) & "服務次數：" & rsRD.Fields("cnt") & "，" & _
                                       "工作時數小計：" & rsRD.Fields("tot1") & "，" & _
                                       "實際比例：" & Val(strRate) & "%，" & _
                                       "收文分配比例：" & Val(rsRD.Fields("ar03")) & "%" & _
                                       IIf(Val(rsRD.Fields("ar10")) <> 0, "，調整比例：" & Val(rsRD.Fields("ar10")) & "%", "") & vbCrLf
                End If
             End If
             rsRD.MoveNext
        Loop
    End If

    If iKind = "2" And strContext <> "" Then  '每日批次
        '抓出所有收據號碼
        'Modified by Lydia 2023/06/20 包含112智財顧問; Ex.ACS-000106
        'strTmpA = "select a0j13 from (" & strR1 & ") vtb1, acc0j0 where cp09=a0j01(+) group by a0j13 order by a0j13 "
        'Modified by Lydia 2024/06/20 ACS案的收據只帶出112智財顧問收文的收據，其他相關卷號帶出顧問期間內的所有收據。EX.ACS-000106(AB2019956)
        'strTmpA = "select a0j13 from (" & Replace(strR1, strCon1, "") & ") vtb1, acc0j0 where cp09=a0j01(+) group by a0j13 order by a0j13 "
        strTmpA = "select a0j13 from (" & Replace(strR1, strCon1, "") & ") vtb1, acc0j0 where cp09=a0j01(+) and substr(a0j02,1,3)<> 'ACS' group by a0j13 "
        If iCP01 = "ACS" Then
           strTmpA = strTmpA & " Union select a0j13 from acc0j0 where a0j01='" & iCp09 & "' "
        End If
        strTmpA = strTmpA & " order by a0j13 "
        'end 2024/06/20
        intR = 1
        Set rsRD = ClsLawReadRstMsg(intR, strTmpA)
        If intR = 1 Then
            strTmp2 = Replace(rsRD.GetString(adClipString, , , ","), ",,", ",")
            If Right(strTmp2, 1) = "," Then strTmp2 = Mid(strTmp2, 1, Len(strTmp2) - 1)
            strContext = Replace(strContext, "收據號碼：", "收據號碼：" & strTmp2)
        End If
        '尚未發文明細：(案號+收文號+案件性質)
        If Val(pNTimes) > 0 Then
            strTmpA = "select cp01||'-'||cp02||decode(cp03,'0',null,'-'||cp03)||decode(cp04,'00',null,'-'||cp04) caseno,cp09,cpm03  from (" & strR1 & ") where cp158=0 order by 1 "
            intR = 1
            strTmp2 = ""
            Set rsRD = ClsLawReadRstMsg(intR, strTmpA)
            If intR = 1 Then
                rsRD.MoveFirst
                Do While Not rsRD.EOF
                     strTmp2 = strTmp2 & "、" & rsRD.Fields("caseno") & "." & rsRD.Fields("cp09") & "." & rsRD.Fields("cpm03")
                     rsRD.MoveNext
                Loop
                strContext = strContext & vbCrLf & "尚未發文明細：" & Mid(strTmp2, 2)
            End If
        End If
    End If
    
    If strContext <> "" Then
        If iKind = "2" And pUpdSQL <> "" Then
             pUpdSQL = pUpdSQL & "Update caseprogress set cp27=" & strSrvDate(1) & " where cp09='" & iCp09 & "' and cp27 is null  ;"
        End If
        ACS112STATISTICS = strContext
    End If
    
End Function

'Added by Lydia 2021/05/25 ACS智財顧問專業分配比例管制：發文檢查有相關卷號(CaseRelation1)為ACS且曾有收文智財顧問112，則CFP、CFT、P、T發文都一定要輸入工作時數，輸0也可以。
Public Function Pub_ChkACS112isNull(ByVal pCP01 As String, ByVal pCP02 As String, ByVal pCP03 As String, ByVal pCP04 As String, ByRef tbCP113 As Object) As Boolean
    
    Pub_ChkACS112isNull = False
    'Modified by Lydia 2021/07/16 +L,CFL
    If strSrvDate(1) < ACS_PFrateStart And pCP01 <> "CFP" And pCP01 <> "CFT" And pCP01 <> "T" And pCP01 <> "P" And pCP01 <> "L" And pCP01 <> "CFL" Then
       Exit Function
    End If
    If tbCP113.Enabled = False Or tbCP113.Visible = False Then Exit Function
    
    '一定要輸入工作時數，輸0也可以
    If Trim(tbCP113.Text) = "" Then
         If Pub_GetACS112Range(pCP01, pCP02, pCP03, pCP04) = True Then
              MsgBox "本案為ACS智財顧問相關案，請輸入工作時數！", vbInformation, "ACS智財顧問管制"
              Pub_ChkACS112isNull = True
         End If
    End If
End Function

'Added by Lydia 2021/05/26 傳入本所案號，讀取所有相關卷號(CaseRelation1)
Public Sub Proc_R100101_i(ByVal pCP01 As String, ByVal pCP02 As String, ByVal pCP03 As String, ByVal pCP04 As String, Optional ByVal pUserNo As String)
Dim strTmpEx As String, strTmpQ As String
Dim intQ As Integer, intRec As Integer
Dim intA As Integer
Dim rsQ1 As New ADODB.Recordset
    
    If pUserNo = "" Then pUserNo = strUserNum
    
    strTmpEx = "delete from r100101_i where id='" & pUserNo & "' "
    cnnConnection.Execute strTmpEx
    
    strTmpEx = "insert into r100101_i (R001001,R001002,R001003,R001004,R001005,ID) values ('" & pCP01 & "', '" & pCP02 & "', '" & pCP03 & "', '" & pCP04 & "', 0, '" & pUserNo & "' ) "
    cnnConnection.Execute strTmpEx
    
    strTmpQ = "select count(*) cnt from r100101_i where id='" & pUserNo & "' "
    intQ = 1
    Set rsQ1 = ClsLawReadRstMsg(intQ, strTmpQ)
    If intQ = 1 Then
        '前後筆數相同時跳離
        Do While intRec <> Val("" & rsQ1.Fields("cnt"))
             intRec = Val("" & rsQ1.Fields("cnt"))
             intA = intA + 1
             strTmpEx = "insert into r100101_i (R001001,R001002,R001003,R001004,R001005,ID) " & _
                               "SELECT CR01,CR02,CR03,CR04, " & intA & " , '" & pUserNo & "' FROM (" & _
                               "SELECT CR01,CR02,CR03,CR04,3, '" & pUserNo & "' FROM CASERELATION1 WHERE (CR05,CR06,CR07,CR08) IN (SELECT R001001,R001002,R001003,R001004 FROM R100101_I WHERE ID='" & pUserNo & "' ) " & _
                               "UNION SELECT CR05,CR06,CR07,CR08,3, '" & pUserNo & "' FROM CASERELATION1 WHERE (CR01,CR02,CR03,CR04) IN (SELECT R001001,R001002,R001003,R001004 FROM R100101_I WHERE ID='" & pUserNo & "' ) " & _
                               ") WHERE ( CR01,CR02,CR03,CR04) NOT IN (SELECT R001001,R001002,R001003,R001004 FROM R100101_I WHERE ID='" & pUserNo & "' ) "
             cnnConnection.Execute strTmpEx
              
             intQ = 1
             Set rsQ1 = ClsLawReadRstMsg(intQ, strTmpQ)
        Loop
    End If
    Set rsQ1 = Nothing
    
End Sub

'Added by Lydia 2023/12/14 是否有相關卷號設定
Public Function PUB_IfCaseRelation1Exists(ByVal pCP01 As String, ByVal pCP02 As String, ByVal pCP03 As String, ByVal pCP04 As String) As Boolean
Dim intQ As Integer, strQ1 As String
Dim rsQD As New ADODB.Recordset
   
   PUB_IfCaseRelation1Exists = False
   
   strQ1 = "SELECT CR05,CR06,CR07,CR08 FROM CaseRelation1 WHERE CR01='" & pCP01 & "' AND CR02='" & pCP02 & "' AND CR03='" & pCP03 & "' AND CR04='" & pCP04 & "' "
   strQ1 = strQ1 & "UNION SELECT CR01,CR02,CR03,CR04 FROM CaseRelation1 WHERE CR05='" & pCP01 & "' AND CR06='" & pCP02 & "' AND CR07='" & pCP03 & "' AND CR08='" & pCP04 & "' "
   
   intQ = 1
   Set rsQD = ClsLawReadRstMsg(intQ, strQ1)
   If intQ = 1 Then
      PUB_IfCaseRelation1Exists = True
   End If
   
   Set rsQD = Nothing
End Function

'Added by Lydia 2021/06/02 ACS智財顧問專業分配比例管制：更新專業分配比例檔ACSPFRate檔的實際分配比例, 供每日批次frmAutoBatchDay和智財顧問案重新計算各部門實際比例frm081033
Public Function PUB_RunStrMenu105(ByVal pCP01 As String, ByVal pCP02 As String, ByVal pCP03 As String, ByVal pCP04 As String, ByVal pCP09 As String, Optional pUserNo As String) As Boolean

Dim strTo As String, strSubject As String
Dim strCC As String, strContent As String
Dim strA As String, intA As Integer
Dim rsA As New ADODB.Recordset
Dim strUpdTxt As String '更新語法
Dim tmpArr01 As Variant
Dim strA0j13 As String '收據號碼
Dim strList01 As String '相關案之未發文明細
Dim bolUpdate As Boolean
Dim pCP15 As String, pCP53 As String, pCP54 As String
Dim strQ As String

    If pCP01 = "" Or pCP02 = "" Or pCP03 = "" Or pCP04 = "" Or pCP09 = "" Then Exit Function
    
    '發EMAIL給系統特殊設定「財務處總帳人員」，副本給顧服組
    strTo = Pub_GetSpecMan("財務處總帳人員")
    'Modified by Lydia 2024/05/15 改通知人員
    strCC = Pub_GetSpecMan("ACS分案人員")
    If pUserNo <> "QPGMR" And InStr(strCC, strUserNum) = 0 Then
       strCC = strCC & ";" & strUserNum
    End If
    'end 2024/05/15
    
    '呼叫共用模組: 計算並且更新專業分配比例檔ACSPFRate檔的實際分配比例(ACS案112收文上發文日)，最後回傳分配比例的描述
    strContent = ACS112STATISTICS("2", pCP01, pCP02, pCP03, pCP04, pCP09, pCP15, pCP53, pCP54, , , , strUpdTxt)
    If strUpdTxt = "" Then
        'Added by Lydia 2022/05/31 每日批次:無法計算更新,改成發email通知補作業
        If pUserNo = "QPGMR" Then
             'Modified by Lydia 2023/10/17 加註:收文服務費之20%作為行政流程費用！
             strSubject = pCP01 & "-" & pCP02 & IIf(pCP03 <> "0", "-" & pCP03, "") & IIf(pCP04 <> "00", "-" & pCP04, "") & "，請進入法務系統補上相關資料！收文服務費之20%作為行政流程費用！"
             strContent = pCP01 & "-" & pCP02 & IIf(pCP03 <> "0", "-" & pCP03, "") & IIf(pCP04 <> "00", "-" & pCP04, "") & "顧問期間結束，請進入法務系統補上相關資料：" & vbCrLf & vbCrLf & _
                               "1.進入分案作業：輸入案號查詢後選擇已到期112智財顧問之收文，點選分案畫面之〔專業分配比例〕按鈕，開啟新畫面輸入契約時數和分配比例，再按下確定按鈕進行存檔；" & vbCrLf & _
                               "2.進入資料處理->智財顧問案重新計算各部門實際比例：選擇收文進入〔分配比例明細〕畫面，當執行過重新計算比例才能執行存檔及通知相關人。" & vbCrLf & vbCrLf & String(60, "=") & vbCrLf & strContent
             PUB_SendMail strUserNum, strCC, "", strSubject, strContent
             PUB_RunStrMenu105 = True '避免批次log有問題
        End If
        'end 2022/05/31
        Exit Function
    End If
    
    '更新資料
    If strUpdTxt <> "" Then
       tmpArr01 = Split(strUpdTxt, ";")
       bolUpdate = True
       cnnConnection.BeginTrans
       For intA = 0 To UBound(tmpArr01)
           If Trim(tmpArr01(intA)) <> "" Then
               cnnConnection.Execute Trim(tmpArr01(intA))
           End If
       Next intA
       cnnConnection.CommitTrans
       bolUpdate = False
    End If
    '逐案發EMAIL給系統特殊設定「財務處總帳人員」，副本給顧服組，主旨：ACS-XXXXXX顧問期間結束，請重新結算調整各專業部門分配點數！
    If strContent <> "" And strTo <> "" Then
       'Added by Lydia 2023/06/20
       If pUserNo = "QPGMR" Then
          '每日批次: 顧服組改為正本, Email內文加註
          strTo = strTo & ";" & strCC
          strCC = ""
          strContent = "請專業部門確認最終點數分配後通知財務處!" & vbCrLf & vbCrLf & strContent
       End If
       'end 2023/06/20
       'Modified by Lydia 2023/10/17 加註:收文服務費之20%作為行政流程費用！
       'Modified by Lydia 2024/06/18 加註:，請依顧服組提供的比例
       strSubject = pCP01 & "-" & pCP02 & IIf(pCP03 <> "0", "-" & pCP03, "") & IIf(pCP04 <> "00", "-" & pCP04, "") & "顧問期間結束，請依顧服組提供的比例，請重新結算調整各專業部門分配點數！收文服務費之20%作為行政流程費用！"
       PUB_SendMail strUserNum, strTo, "", strSubject, strContent, , , , , , strCC
    End If
    PUB_RunStrMenu105 = True
    Set rsA = Nothing
    
    Exit Function
    
ErrHandle:
    If Err.Number <> 0 Then
        If pUserNo <> "QPGMR" Then  '人工執行
             MsgBox "更新專業分配比例檔程式錯誤:" & vbCrLf & Err.Description
        End If
        If bolUpdate = True Then
            cnnConnection.RollbackTrans
        End If
    End If
End Function


'Added by Morgan 2021/6/18
'T與FCT共同控管案件通知 RecNo:收件號/收文號, iType:1=來函,2=接洽單
Public Sub PUB_2SysCaseInform(tm01 As String, tm02 As String, tm03 As String, tm04 As String, RecNo As String, Optional iType As Integer = 1)
   Dim strQ As String, intQ As Integer
   Dim RsQ As ADODB.Recordset
   Dim strSal1 As String, strSal2 As String, strCNo2 As String
   Dim strSubj As String, strContent As String
   Dim strNo As String
   
   'Added by Morgan 2023/5/4
   strNo = Pub_GetSpecMan("T與FCT共同管控案件")
   strQ = "select tm15 from trademark t1" & _
      " where tm01='" & tm01 & "' and tm02='" & tm02 & "' and tm03='" & tm03 & "' and tm04='" & tm04 & "' and tm15 is not null and instr(';" & strNo & ";',';'||tm15||';')>0"
   intQ = 1
   Set RsQ = ClsLawReadRstMsg(intQ, strQ)
   If intQ = 0 Then Exit Sub
   'end 2023/5/4
            
   
   strQ = "select tm01,tm02,tm03,tm04,tm15 from trademark t1" & _
      " where (tm10,tm15) in (select tm10,tm15 from trademark t2 where tm01='" & tm01 & "' and tm02='" & tm02 & "' and tm03='" & tm03 & "' and tm04='" & tm04 & "') and tm01<>'" & tm01 & "'"
   intQ = 1
   Set RsQ = ClsLawReadRstMsg(intQ, strQ)
   If intQ = 1 Then
      
      strSal2 = PUB_GetAKindSalesNo(RsQ("tm01"), RsQ("tm02"), RsQ("tm03"), RsQ("tm04"))
      strCNo2 = RsQ("tm01") & "-" & RsQ("tm02") & IIf(RsQ("tm03") & RsQ("tm04") = "000", "", "-" & RsQ("tm03") & "-" & RsQ("tm04"))
      '櫃檯輸入來函
      If iType = 1 Then
         strSubj = "T與FCT共同控管案件通知，請確認案件如何續行"
         strSal1 = PUB_GetAKindSalesNo(tm01, tm02, tm03, tm04)
         strQ = "insert into MailCache(MC01,MC02,MC03,MC04,MC07,MC08)" & _
            " select '" & strUserNum & "','" & strSal1 & ";" & strSal2 & "'" & _
            ",to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss'),'" & strSubj & "'" & _
            ",chr(13)||chr(10)||'收件號：'||MR01" & _
            "||chr(13)||chr(10)||'本所案號：'||TM01||'-'||TM02||decode(TM03||TM04,'000','','-'||TM03||'-'||TM04)" & _
            "||chr(13)||chr(10)||'案件名稱：'||tm05" & _
            "||chr(13)||chr(10)||'備註：'||MR09" & _
            "||chr(13)||chr(10)||'收件日：'||sqldatet(MR02)" & _
            "||chr(13)||chr(10)||'智權人員：" & strSal1 & " '||s1.st02" & _
            "||chr(13)||chr(10)||chr(13)||chr(10)||'另一案號：" & strCNo2 & "'" & _
            "||chr(13)||chr(10)||'智權人員：" & strSal2 & " '||s2.st02" & _
            " from MailRec,trademark,staff s1,staff s2 where mr01='" & RecNo & "'" & _
            " and tm01(+)=MR12 and tm02(+)=MR13 and tm03(+)=MR14 and tm04(+)=MR15" & _
            " and s1.st01(+)='" & strSal1 & "' and s2.st01(+)='" & strSal2 & "'"
            
      '接洽單收文
      Else
         strSubj = "T與FCT共同控管案件已收文，未獲指示者請銷案"
         strQ = "insert into MailCache(MC01,MC02,MC03,MC04,MC07,MC08)" & _
            " select '" & strUserNum & "',cp13||';" & strSal2 & "'" & _
            ",to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss'),'" & strSubj & "'" & _
            ",chr(13)||chr(10)||'收文號：'||CP09" & _
            "||chr(13)||chr(10)||'本所案號：'||cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04)" & _
            "||chr(13)||chr(10)||'案件名稱：'||tm05" & _
            "||chr(13)||chr(10)||'案件性質：'||cpm03" & _
            "||chr(13)||chr(10)||'收文日：'||sqldatet(cp05)" & _
            "||chr(13)||chr(10)||'智權人員：'||cp13||' '||s1.st02" & _
            "||chr(13)||chr(10)||chr(13)||chr(10)||'另一案號：" & strCNo2 & "'" & _
            "||chr(13)||chr(10)||'智權人員：" & strSal2 & " '||s2.st02" & _
            " from caseprogress,trademark,casepropertymap,staff s1,staff s2 where cp09='" & RecNo & "'" & _
            " and tm01(+)=cp01 and tm02(+)=cp02 and tm03(+)=cp03 and tm04(+)=cp04 and cpm01(+)=cp01 and cpm02(+)=cp10" & _
            " and s1.st01(+)=cp13 and s2.st01(+)='" & strSal2 & "'"
            
      End If
      cnnConnection.Execute strQ, intQ
      
   End If
End Sub

'Added by Morgan 2021/6/24
'自卷宗區讀取公告公報PDF檔
'Modified by Morgan 2022/7/11 +pIsPublic
Public Function PUB_GetGazettePDF(ByVal pa01 As String, ByVal pa02 As String, ByVal pa03 As String, ByVal pa04 As String, Optional ByVal pDownload As Boolean = False, Optional ByVal pSavePath As String, Optional ByRef pFileName As String, Optional pIsPublic As Boolean = False) As Boolean
   Dim strQ As String, intQ As Integer
   Dim rstQ As ADODB.Recordset
   Dim stCP10 As String
   
   If pIsPublic Then
      stCP10 = "1229"
   Else
      stCP10 = "1228"
   End If
   
   strQ = "SELECT cpp01,cpp02 FROM CASEPROGRESS,casepaperpdf" & _
      " WHERE cp01='" & pa01 & "' and cp02='" & pa02 & "' and cp03='" & pa03 & "' and cp04='" & pa04 & "'" & _
      " and CP10='" & stCP10 & "' and cpp01(+)=cp09 and substr(upper(cpp02),-9)='.'||cp10||'.PDF'"
   intQ = 0
   Set rstQ = ClsLawReadRstMsg(intQ, strQ)
   If intQ = 1 Then
      With rstQ
      pFileName = .Fields("cpp02")
      If pDownload Then
         PUB_GetGazettePDF = PUB_GetAttachFile_CPP(.Fields("cpp01"), pFileName, pSavePath)
      Else
         PUB_GetGazettePDF = True
      End If
      End With
   End If
End Function

'Added by Morgan 2021/9/22 檢查案件是否為顧服組W2001的4家客戶X69365、X82504、X82708、X83239及其關係企業也掛在顧服組W2001者(只考慮第一申請人即可)
'Modified by Morgan 2022/9/2 +智慧價值(X84215)
'Modified by Morgan 2021/10/5 +pIsX69365Case:是否長庚案件--黃教威
'Modified by Morgan 2022/9/2 +新光金控(X82973000)、力成(X82532) --黃教威
'Modified by Morgan 2023/4/25 +陽電先進(X86684000)及其關聯企業 --黃教威
'Modified by Morgan 2023/6/21 力成(X82532)取消，恢復成一般案件的設定--郭雅娟
Public Function PUB_ChkIsW2001XCase(ByVal pa01 As String, ByVal pa02 As String, ByVal pa03 As String, ByVal pa04 As String, ByRef cp14 As String, Optional ByRef pIsX69365Case As Boolean = False) As Boolean
   Dim strQ As String, intQ As Integer
   Dim rstQ As ADODB.Recordset
   
   cp14 = ""
   '承辦人抓最後收文工程師(不限收文種類)
   'Modified by Morgan 2022/11/4 沒有工程師時要再抓國內案工程師 EX:P-125289--郭
   'Modified by Morgan 2022/11/7 改判斷P10,P11部門否則會抓到繪圖 Ex:P-129698--韻丞
   'Modified by Morgan 2023/5/10 +CU13='P1004'
   'Modified by Morgan 2024/8/5 +CU13='30015'
   strQ = "select st01,st04,cp05,pa26 from patent,customer,caseprogress,staff" & _
      " where pa01='" & pa01 & "' and pa02='" & pa02 & "' and pa03='" & pa03 & "' and pa04='" & pa04 & "'" & _
      " and cu01(+)=substr(pa26,1,8) and cu02(+)=substr(pa26,9,1) and instr('X69365,X82504,X82708,X83239,X84215,X82973,X86684',substr(cu01,1,6))>0 and (cu13='W2001' or cu13='P1004' or cu13='30015')" & _
      " and cp01(+)=pa01 and cp02(+)=pa02 and cp03(+)=pa03 and cp04(+)=pa04 and cp14(+) is not null and cp57 is null" & _
      " and st01(+)=cp14 and st03(+)>='P10' and st03(+)<='P11' order by decode(st01,null,1,0) asc,cp05 desc"
   intQ = 1
   Set rstQ = ClsLawReadRstMsg(intQ, strQ)
   If intQ = 1 Then
      PUB_ChkIsW2001XCase = True
      'Added by Morgan 2021/10/5
      If Left(rstQ("pa26"), 6) = "X69365" Then
         pIsX69365Case = True
      Else
         pIsX69365Case = False
      End If
      'end 2021/10/5
      If rstQ("st04") = "1" Then
         cp14 = rstQ("st01")
      '離職掛王副總
      ElseIf rstQ("st04") = "2" Then
         'Modified by Morgan 2023/5/9
         'cp14 = "71011"
         cp14 = "99050"
      Else
         '抓國內案工程師
         strQ = "select st01,st04,cp05 from casemap,caseprogress,staff" & _
            " where cm01='" & pa01 & "' and cm02='" & pa02 & "' and cm03='" & pa03 & "' and cm04='" & pa04 & "' and cm10='0'" & _
            " and cp01(+)=cm05 and cp02(+)=cm06 and cp03(+)=cm07 and cp04(+)=cm08 and cp14 is not null and cp57 is null" & _
            " and st01(+)=cp14 and st03>='P10' and st03<='P11' order by cp05 desc"
         intQ = 1
         Set rstQ = ClsLawReadRstMsg(intQ, strQ)
         If intQ = 1 Then
            If rstQ("st04") = "1" Then
               cp14 = rstQ("st01")
            Else
               'Modified by Morgan 2023/5/9
               'cp14 = "71011"
               cp14 = "99050"
            End If
         End If
      End If
   End If
   
   If cp14 = "" Then cp14 = "99050" 'Added by Morgan 2024/6/26 轉部門走離職規則 Ex:A7010 --郭
End Function

'Added by Morgan 2021/10/5
'檢查是否為顧服組長庚醫院案件
Public Function PUB_ChkIsX69365Case(ByVal pa01 As String, ByVal pa02 As String, ByVal pa03 As String, ByVal pa04 As String) As Boolean
   Dim strQ As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   'Modified by Morgan 2023/5/10 +cu13='P1004'
   'Modified by Morgan 2024/8/5 +cu13='30015'
   strQ = "select pa26 from patent,customer" & _
      " where pa01='" & pa01 & "' and pa02='" & pa02 & "' and pa03='" & pa03 & "' and pa04='" & pa04 & "'" & _
      " and cu01(+)=substr(pa26,1,8) and cu02(+)=substr(pa26,9,1) and substr(cu01,1,6)='X69365' and (cu13='W2001' or cu13='P1004' or cu13='30015')"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, strQ)
   If intQ = 1 Then
      PUB_ChkIsX69365Case = True
   End If
End Function

'Added by Morgan 2021/10/7
'設定長庚醫院案件OA發文管制日(所限)
Public Sub PUB_SetX69365CaseOACP06(ByVal CP09 As String)
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   Dim stDDate2 As String

   stSQL = "select * from caseprogress where cp09='" & CP09 & "'"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      With rsQuery
      If InStr("" & .Fields("cp64"), "長庚醫院案件發文管制日:") = 0 Then
         stDDate2 = PUB_GetX69365CaseOACP06(.Fields("cp05")) '所限
         stSQL = "update caseprogress set cp64='長庚醫院案件發文管制日:" & ChangeWStringToTDateString(stDDate2) & "(所限);'||cp64"
         '所限較晚時才更新
         If IsNull(.Fields("cp06")) Or .Fields("cp06") > stDDate2 Then
            stSQL = stSQL & ",cp06=" & stDDate2
         End If
         
         stSQL = stSQL & " where cp09='" & .Fields("cp09") & "'"
         cnnConnection.Execute stSQL, intQ
      End If
      End With
   End If
   
End Sub

'Added by Morgan 2021/10/7
'長庚醫院案件OA發文管制日(所限) --OA設定期限及每日批次通知都要用
Public Function PUB_GetX69365CaseOACP06(ByVal pOADate As String) As String
   '管制日(所限):通知日+15天-3工作天
   'Modified by Morgan 2022/3/28 改為通知日+14天-3工作天--黃教威
   'Modified by Morgan 2022/6/30 再改為通知日+10天-3工作天--黃教威
   PUB_GetX69365CaseOACP06 = CompWorkDay(3, CompDate(2, 10, pOADate), 1)
End Function

'Added by Morgan 2021/10/7
'設定長庚醫院案件轉公文管制日(所限)
Public Sub PUB_SetX69365Case1998CP06(ByVal CP09 As String)
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   Dim stDDate2 As String

   stSQL = "select * from caseprogress where cp09='" & CP09 & "'"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      With rsQuery
      If InStr("" & .Fields("cp64"), "長庚醫院案件轉公文管制日:") = 0 Then
         '轉公文所限: 通知日+4天 (除非拿掉發文日，不然應該沒作用)
         stDDate2 = PUB_GetWorkDay1(CompDate(2, 4, .Fields("cp05")), True)
         stSQL = "update caseprogress set cp64='長庚醫院案件轉公文管制日:" & ChangeWStringToTDateString(stDDate2) & "(所限);'||cp64 where cp09='" & .Fields("cp09") & "'"
         cnnConnection.Execute stSQL, intQ
      End If
      End With
   End If
End Sub

'Add By Sindy 2021/12/27
'將文字儲存成 Unicode 編碼檔案
'filePath:完整電子檔名(路徑+電子檔名) ex:C:\97038\Trademark\商標處信件處理結果檢核表-1101227.txt
'Text:整份文件
Function PUB_SaveTextAsUnicode(filePath, Text)
   Const adTypeText = 2
   Const adSaveCreateOverWrite = 2
   Dim TextStream
   
   Set TextStream = CreateObject("ADODB.Stream")
   With TextStream
      .Type = 2
      .Mode = 3
      .Open
      .Charset = "Unicode"
      .WriteText Text
      .SaveToFile filePath
      .Close
   End With
   Set TextStream = Nothing
End Function

'Add By Sindy 2023/2/8
'將文字儲存成 UTF-8 編碼檔案
'Text:整份文件
Function PUB_SaveTextAsUTF8(filePath, Text)
   Const adTypeText = 2
   Const adSaveCreateOverWrite = 2
   Dim TextStream
   
   Set TextStream = CreateObject("ADODB.Stream")
   With TextStream
'      .Open
'      .Charset = "UTF-8"
'      .Position = TextStream.Size
'      .WriteText Text
'      .SaveToFile filePath, adSaveCreateOverWrite
'      .Close
      .Type = 2
      .Mode = 3
      .Open
      '.Charset = "Unicode"
      .Charset = "UTF-8"
      .WriteText Text
      .SaveToFile filePath
      .Close
   End With
   Set TextStream = Nothing
End Function

'Added by Morgan 2015/4/20
'檢查先正達的來函掛特定下一程序時承辦期限為1個工作天(24Hr)
'Move by Lydia 2022/01/21 從ClsPrtForm001.PrintCFormNew搬來,並用從ChkSyngentaNP=>Pub_ChkSyngentaNP
Public Function Pub_ChkSyngentaNP(pCP09 As String) As Boolean
   Dim stSQL As String
   Dim rsQuery As ADODB.Recordset
   Dim intR As Integer
   
   stSQL = "select * from nextprogress where np01='" & pCP09 & "' and (np07=804 or (np07>=501 and np07<=509))"
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      Pub_ChkSyngentaNP = True
   End If
   Set rsQuery = Nothing
End Function

'Added by Lydia 2022/01/21 外專之C類接洽單的備註;
'從ClsPrtForm001.PrintCFormNew改成共用模組,因為輸入C類來函通知會一併發email給承辦工程師
Public Function PUB_FCPCFormMemo(pNo As String, Optional ByVal pDefMemo As String) As String
'pNo: 收文號
'pFAno: 代理人
'pCustList: 申請人1~5
'pDefMemo: 傳入預設備註
Dim pNoPty As String, pCaseNo As String, pCase01 As String
Dim pFaNo As String, pCustList As String
Dim pTempStr As String
Dim strA1 As String, intA As Integer
Dim rsAD As New ADODB.Recordset
Dim bolIsSyngentaOneDayCase As Boolean
Dim pCP24 As String, pCP43 As String
Dim pCP14 As String, pCP14st03 As String
Dim bolIsFCP As Boolean

    PUB_FCPCFormMemo = ""
    strA1 = "select cp01,cp02,cp03,cp04,cp09,cp10,cp12,cp14,st03 as cp14st03,cp24,cp43, pa75, pa26, pa27, pa28, pa29, pa30 " & _
                "From caseprogress, staff, patent " & _
                 "where cp09=" & CNULL(pNo) & " and cp14=st01(+) and cp01=pa01(+) and cp02=pa02(+) and cp03=pa03(+) and cp04=pa04(+) "
    intA = 1
    Set rsAD = ClsLawReadRstMsg(intA, strA1)
    If intA = 0 Then
        Set rsAD = Nothing
        Exit Function
    Else
        pCase01 = "" & rsAD.Fields("cp01")
        pCaseNo = "" & rsAD.Fields("cp01") & "" & rsAD.Fields("cp02") & "" & rsAD.Fields("cp03") & "" & rsAD.Fields("cp04")
        pNoPty = "" & rsAD.Fields("cp10")
        pCP24 = "" & rsAD.Fields("cp24")
        pCP43 = "" & rsAD.Fields("cp43")
        pCP14 = "" & rsAD.Fields("cp14")
        pCP14st03 = "" & rsAD.Fields("cp14st03")
        If "" & rsAD.Fields("cp01") = "FCP" Or ("" & rsAD.Fields("cp01") = "P" And Left("" & rsAD.Fields("cp12"), 1) = "F") Then
            bolIsFCP = True
        End If
        pFaNo = "" & rsAD.Fields("pa75")
        pCustList = "" & rsAD.Fields("pa26") & "," & rsAD.Fields("pa27") & "," & rsAD.Fields("pa28") & "," & rsAD.Fields("pa29") & "," & rsAD.Fields("pa30")
    End If
    
    If pDefMemo <> "" Then
        pTempStr = pDefMemo
    Else
        '改變原處分-核駁也要印
        If (pNoPty = "1002" Or pNoPty = "1007" Or (pNoPty = "1503" And pCP24 = "2")) And pCP43 <> "" Then
           strA1 = "SELECT NP07 FROM NEXTPROGRESS WHERE NP01='" & pNo & "'"
           intA = 1
           Set rsAD = ClsLawReadRstMsg(intA, strA1)
           If intA = 1 Then
              Select Case "" & rsAD.Fields(0)
                 Case "501" '訴願
                    pTempStr = "請客戶提供重新簽署的委任書以俾辦理訴願程序"
                 Case "503" '行政訴訟
                    pTempStr = "請客戶提供重新簽署具公、簽證的委任書以俾辦理行政訴訟程序"
                 Case "504" '行政再審
                    pTempStr = "請客戶提供重新簽署具公、簽證的委任書以俾辦理行政再審程序"
                 Case "507" '行政訴訟上訴
                    pTempStr = "請客戶提供重新簽署具公、簽證的委任書以俾辦理行政訴訟上訴程序"
                 Case "509" '抗告
                    pTempStr = "請客戶提供重新簽署具公、簽證的委任書以俾辦理抗告程序"
              End Select
           End If
        End If
    End If

    If InStr("Y4830900,Y4830901,Y4830902,Y4830903,Y4830904,Y4830905,Y4830908,Y5132600", Left(pFaNo, 8)) > 0 Then
        bolIsSyngentaOneDayCase = Pub_ChkSyngentaNP(pNo)
        If bolIsSyngentaOneDayCase = True Then
           If pTempStr <> "" Then pTempStr = pTempStr & vbCrLf
           pTempStr = pTempStr & "收到舉發案訴願或任何法律行動，請於收到的24小時內告知先正達。"
        End If
    End If
    
    '核駁及審查意見通知函備註:  排除先正達承辦期限為2個工作天(24Hr)的來函
    'Modified by Lydia 2021/08/25 國外部凡是C類工程師的來函(排除核准1001、核發1008，另外非核准和一般來函性質1204,1217,1913,1603,1604)，有設核駁及審查意見通知函備註皆要帶備註到接洽單
    'If bolIsSyngentaOneDayCase = False And (rs1("cp01") = "P" Or rs1("cp01") = "FCP") And (pnopty= "1202" Or pnopty= "1227" Or pnopty= "1002") Then
    'Modified by Lydia 2021/08/31 +判斷來函承辦人為工程師 And PUB_GetST03("" & rs1.Fields("cp14")); ex.發生了FCP065502通知即將公開1207直接收文告代
    'Modified by Lydia 2021/08/31 +排除926,和非C類接洽單And Left("" & rs1.Fields(2), 1) = "C"
    If bolIsSyngentaOneDayCase = False And pCP14st03 = "F21" And Left(pNo, 1) = "C" And _
                  (bolIsFCP = True And InStr("1001,1008,1204,1217,1913,1603,1604,926", pNoPty) = 0) Then
        strA1 = ""
        strA1 = PUB_GetIncomMemoNew(pCaseNo, pCase01, pFaNo, pCustList, "Y", "", pNoPty)
        If Len(strA1) > 0 Then
             pTempStr = pTempStr & IIf(pTempStr <> "", vbCrLf, "") & strA1
        End If
    End If
    PUB_FCPCFormMemo = pTempStr
   
    Set rsAD = Nothing
End Function

'Added by Lydia 2022/02/23 內專: 取得和碩客戶編號
'Modified by Lydia 2022/08/12 +回傳代表客戶編號passCU01
Public Function Pub_Getfrm040303Except(ByVal iCU01 As String, Optional ByRef pCustList As String, Optional ByRef passCU01 As String) As Boolean

passCU01 = ""  'Added by Lydia 2022/08/12

'Added by Lydia 2019/08/30 客戶X70017000和碩聯合科技股份有限公司及其關係企業(編號X70017010、X70017020、X70017030)
pCustList = "X70017000,X70017010,X70017020,X70017030"
'Added by Lydia 2022/02/08 長庚體系逐漸要將其專利案件回歸到產學中心，顯然之後皆須遵循其規則(比照和碩案)進行通知，故除顧服組客戶外，本所其他非顧服組也建議需一併設
'Modified by Morgan 2023/2/21+,X69365060,X69365070,X69365080
pCustList = pCustList & ",X69365020,X75299000,X75299020,X69365060,X69365010,X69365030,X69365000,X69365040,X69365050,X69365060,X69365070,X69365080"

Pub_Getfrm040303Except = False
If iCU01 <> "" And InStr(pCustList, ChangeCustomerL(iCU01)) > 0 Then
    Pub_Getfrm040303Except = True
    'Added by Lydia 2022/08/12
    passCU01 = "X70017000"
    Exit Function
    'end 2022/08/12
End If

'Added by Lydia 2022/08/12 因信邦電子(X39056000)承辦人反應本所專利年費、維持費繳交期限提前通知日期過早(現為三個月)，要求本所在法定期限前一個月通知即可
    '信邦電子(X39056000)、北京信邦(X39056080、X39056081)、江陰信邦(X39056020)及江蘇英邁(X39056090)
pCustList = "X39056000,X39056080,X39056081,X39056020,X39056090"
If iCU01 <> "" And InStr(pCustList, ChangeCustomerL(iCU01)) > 0 Then
    Pub_Getfrm040303Except = True
    passCU01 = "X39056000"
    Exit Function
End If
'end 2022/08/12

'Added by Lydia 2022/08/25 大亞(X60601000)法定期限前4個月通知
pCustList = "X60601000"
If iCU01 <> "" And InStr(pCustList, ChangeCustomerL(iCU01)) > 0 Then
    Pub_Getfrm040303Except = True
    passCU01 = "X60601000"
    Exit Function
End If
'end 2022/08/25

'Added by Lydia 2023/11/09 康舒科技(X00497070)年費期限通知由三個月前改為一個月前
'Modified by Lydia 2023/11/16 康舒科技之關係企業康舒(東莞)電子(X00497100)年費期限亦由三個月改為一個月前
'Mark by Lydia 2024/12/05 (12/4)現因該公司內部問題，希望本所回復為原先三個月期限通知。
'pCustList = "X00497070,X00497100"
'If iCU01 <> "" And InStr(pCustList, ChangeCustomerL(iCU01)) > 0 Then
'    Pub_Getfrm040303Except = True
'    passCU01 = "X00497070"
'    Exit Function
'End If
'end 2023/11/09

'Added by Lydia 2024/04/22 立德電子(X01506000)、江蘇領先(X01506010) 年費期限通知由三個月前改為一個月前  ---李啟佑A3013
'Modified by Lydia 2024/05/02 增加新編號:東莞立德(X01506020)
pCustList = "X01506000,X01506010,X01506020"
If iCU01 <> "" And InStr(pCustList, ChangeCustomerL(iCU01)) > 0 Then
    Pub_Getfrm040303Except = True
    passCU01 = "X01506000"
    Exit Function
End If
'end 2024/04/22

'Added by Lydia 2024/07/23  X38120000/ X38120030碩天科技/寧遠縣碩寧電子，中國專利年費通知程序，提早期限前兩個月前通知。
pCustList = "X38120000,X38120030"
If iCU01 <> "" And InStr(pCustList, ChangeCustomerL(iCU01)) > 0 Then
    Pub_Getfrm040303Except = True
    passCU01 = "X38120000"
    Exit Function
End If
'end 2024/07/23

End Function

'Added by Lydia 2022/03/01 Excel列印：列印財務地址條，參考basQuery.PUB_PrintAccAddress
'Modify By Sindy 2022/3/14
'Optional ByVal m_intLineBreakLen As Integer = 38 : 幾個字折行
'Optional bolAutoAdd As Boolean = True : 是否要系統自動加入字
Public Function PUB_XlsAccAddress(ByVal stAddressList As String, Optional ByVal m_intLineBreakLen As Integer = 38, _
   Optional bolAutoAdd As Boolean = True) As Boolean
'stAddressList：傳入多張地址條的內容；用|區隔不同張地址條，同一張地址條用$區隔地址和收件人
Dim intPG As Integer
'Modified by Lydia 2022/03/04
'Dim xlsAccAddress As New Excel.Application
'Dim wksAddress As New Worksheet
Dim xlsAccAddress
Dim wksAddress
Dim tmpArr
Dim tmpDetail
Dim intA As Integer, intP As Integer, intCounter As Integer, intL As Integer
Dim intLine As Integer
Dim strFileName As String
Dim strTempLine As String

   strFileName = "$$地址條" & MsgText(43)
   If Dir(strExcelPath & strFileName) <> "" Then
       Kill strExcelPath & strFileName
   End If
   
   PUB_XlsAccAddress = False
   
   'Added by Lydia 2022/03/15 因為Godex EZ530的列印範圍是本身Driver設定,所以不用抓地址條設定
   If InStr(UCase(Printer.DeviceName), "GODEX") > 0 Then
       intPG = 2
   Else
   'end 2022/03/15
       intPG = PUB_GetPaperSize(2, , False)
   End If 'Added by Lydia 2022/03/15
   
   If intPG = 0 Then
       MsgBox "地址條紙張格式未設定!!!", vbCritical
   Else
       Set xlsAccAddress = CreateObject("Excel.Application") 'Added by Lydia 2022/03/04
       '傳入多張地址條的內容；用|區隔不同張地址條，同一張地址條用$區隔地址和收件人
       '範例如下：
       'strExc(0) = "１０４臺北市中山區長安東路一段１８號５樓$華南商業銀行股份有限公司|" & _
                        "７１７臺南市仁德區保安里民生路１５-１號$聯豐生物科技股份有限公司|" & _
                        "高雄市鳳山區大仁街２８號$益鑫記帳士事務所~黃小姐|"
       'tmpArr = Split(strExc(0), "|")
       tmpArr = Split(stAddressList, "|")
       For intA = 0 To UBound(tmpArr)
           If Trim(tmpArr(intA)) <> "" Then
               If intCounter = 0 Then
                    xlsAccAddress.SheetsInNewWorkbook = 1
                    xlsAccAddress.Workbooks.add
                    Set wksAddress = xlsAccAddress.Worksheets(1)
                    wksAddress.Activate
                    'xlsAccAddress.Visible = True
                    If Val(xlsAccAddress.Version) < 12 Then
                        xlsAccAddress.Workbooks(1).SaveAs FileName:=strExcelPath & strFileName, FileFormat:=-4143
                    Else
                        xlsAccAddress.Workbooks(1).SaveAs FileName:=strExcelPath & strFileName, FileFormat:=56
                    End If
                    wksAddress.Range("A:A").ColumnWidth = 50
                    wksAddress.Range("A:A").Font.Size = 12
                    If InStr(UCase(Printer.DeviceName), "GODEX") = 0 Then '因為國外部的標籤機Godex EZ530不支援此語法, 另外Godex EZ530的列印範圍是本身Driver設定
                        wksAddress.PageSetup.PaperSize = intPG
                    End If
                    wksAddress.PageSetup.Orientation = xlPortrait '直印
                    wksAddress.PageSetup.Zoom = 100 '縮放比例為100%,列印頁面水平置中
                    wksAddress.PageSetup.HeaderMargin = Excel.Application.InchesToPoints(0) '頁首
                    wksAddress.PageSetup.FooterMargin = Excel.Application.InchesToPoints(0) '頁尾
                    wksAddress.PageSetup.TopMargin = xlsAccAddress.InchesToPoints(0.15) '上
                    wksAddress.PageSetup.BottomMargin = xlsAccAddress.InchesToPoints(0.1) '下
                    wksAddress.PageSetup.LeftMargin = xlsAccAddress.InchesToPoints(0.1) '左邊界
                    wksAddress.PageSetup.RightMargin = xlsAccAddress.InchesToPoints(0.1) '右邊界
               End If
               intCounter = intCounter + 1
               tmpDetail = Empty
               tmpDetail = Split(tmpArr(intA), "$")
               intLine = 1
               For intP = 0 To UBound(tmpDetail)
                   Select Case intP
                        Case 0  '地址
                            strTempLine = GetEnterLineAcc("" & tmpDetail(intP), m_intLineBreakLen, "", intL)
                        Case 1  '收件人：縮排2個字
                            '公司名稱與收件人員用~區隔，兩者需折行
                            strTempLine = GetEnterLineAcc("" & tmpDetail(intP) & IIf(bolAutoAdd = True, MsgText(104), ""), m_intLineBreakLen, "~", intL)
                   End Select
                   '地址條空白列範圍為A1~A7： 其中列印內容超過一行寬度用折行方式，在同一儲存格列印，所以地址固定在A1而收件者在A3
                   wksAddress.Range("A" & IIf(intP = 0, "1", "3")).Value = strTempLine
                   intLine = intLine + intL '記錄列高
                   If intP = 0 Then intLine = intLine + 1
               Next intP
               xlsAccAddress.Workbooks(1).Save
               wksAddress.PrintOut Copies:=1, Collate:=True
               '清除資料
               wksAddress.Range("A1:A7").ClearContents
           End If
       Next intA
       
       xlsAccAddress.Workbooks(1).Save
       xlsAccAddress.Quit
       Set wksAddress = Nothing
       Set xlsAccAddress = Nothing
       PUB_XlsAccAddress = True
   End If
   
End Function

'Added by Lydia 2022/03/01 取得折行後的文字
Private Function GetEnterLineAcc(ByVal pTmp As String, ByVal intM As Single, Optional ByVal pSingle As String, Optional ByRef intRe As Integer) As String
'intM: 每行最大字數,中文算2個
'intRe: 行數
'pSingle : 區隔符號
Dim intB As Integer, strTempB As String, intY As Integer, strTempA As String
Dim tmpArr1
    
    intRe = 0
    strTempA = IIf(pSingle <> "", "　　", "") & pTmp
    If pTmp = "" Or (pSingle = "" And GetTextLength(strTempA) <= intM) Or _
             (pSingle <> "" And InStr(strTempA, pSingle) = 0 And GetTextLength(strTempA) <= intM) Then
       GetEnterLineAcc = strTempA
       intRe = 1
    Else
       tmpArr1 = Split(pTmp, IIf(pSingle <> "", pSingle, "|"))
       For intY = 0 To UBound(tmpArr1)
            '收件人需縮排
            strTempA = IIf(pSingle <> "", "　　", "") & tmpArr1(intY)
            strTempB = PUB_StrToStr(strTempA, intM)
            Do While strTempB <> ""
                GetEnterLineAcc = GetEnterLineAcc & IIf(GetEnterLineAcc <> "", vbCrLf, "") & strTempB
                intB = intB + 1
                'Modified by Lydia 2022/03/09 遇見收件人名稱中間有空白,並且遇到折行
                'strTempA = Replace(strTempA, strTempB, "")
                strTempA = Replace(Trim(strTempA), Trim(strTempB), "")
                If strTempA <> "" Then
                    strTempB = IIf(pSingle <> "", "　　", "") & PUB_StrToStr(strTempA, intM)
                Else
                    strTempB = ""
                End If
            Loop
       Next intY
       intRe = intB
    End If
    
End Function

'Added by Morgan 2022/4/14
'抓顧服組客戶內部郵件CC對象(承辦工程師+外部信密件副本)
Public Function PUB_GetW2001InCC(pCustNo As String, pPA158 As String) As String
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   
   'Modified by Morgan 2023/5/10 +cem06
   stSQL = "select cem03,cem06 from custengmap where cem01='" & Left(pCustNo & "000", 8) & "'" & _
      " and (cem02='*' or cem02='" & pPA158 & "') order by decode(cem02,'*',2,1)"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      PUB_GetW2001InCC = rsQuery("cem03")
      'Added by Morgan 2023/5/10 +外部信密件副本
      If Not IsNull(rsQuery("cem06")) Then
         PUB_GetW2001InCC = PUB_GetW2001InCC & ";" & rsQuery("cem06")
      End If
      'end 2023/5/10
   End If
   Set rsQuery = Nothing
End Function

'Move by Lydia 2022/04/27 從frm090902_2移出來
'Modified by Lydia 2019/09/19 +是否發文iState 和發文日stCP27
'Added by Lydia 2018/04/19 檢查收文狀態
'Modified by Lydia 2023/05/10 承辦工程師stCP14
Public Function PUB_ChkBCPisExist(ByRef stCP() As String, ByVal stCP10 As String, Optional ByRef stCP09 As String, Optional ByRef stCPP As String, Optional ByVal iState As String = "1", Optional ByRef stCP27 As String, Optional ByRef stCP14 As String) As Boolean
'iState:0=不控制,1=未發文, 2=已發文
Dim strA1 As String
Dim intA As Integer
Dim rsAD As New ADODB.Recordset
   
   PUB_ChkBCPisExist = False
   stCP09 = "": stCPP = ""
   '限未發文，建檔人為外專工程師(或電腦中心)
   'Modified by Lydia 2019/08/02 排除F4102 (FCP年費不續辦)
   'Modified by Lydia 2019/09/19 檢查是否發文
   'strA1 = "select cp05,cp09,cp27,cp48,count(cpp02) cnt from caseprogress,staff,casepaperpdf " & _
                "where cp01='" & stCP(1) & "' and cp02='" & stCP(2) & "' and cp03='" & stCP(3) & "' and cp04='" & stCP(4) & "' " & _
                "and cp10='" & stCP10 & "' and substr(cp09,1,1) = 'B' and cp158 = 0 and cp159=0 and cp65=st01(+) " & _
                "and (st03='F21' or st03='M51') and st01<>'F4102' and cp09=cpp01(+) "
   'modify by sonia 2021/1/22 再排除F4104,F4105
   'Modified by Lydia 2022/05/05 加總排除卷宗區已刪除的檔案; ex.FCP-67041
   'Modified by Lydia 2022/05/30 排除卷宗區沒有檔案
   'strA1 = "select cp05,cp09,cp27,cp48,SUM(DECODE(UPPER(SUBSTR(CPP02,-4,4)),'.DEL',0,1)) cnt from caseprogress,staff,casepaperpdf " & _
                "where cp01='" & stCP(1) & "' and cp02='" & stCP(2) & "' and cp03='" & stCP(3) & "' and cp04='" & stCP(4) & "' " & _
                "and cp10='" & stCP10 & "' and substr(cp09,1,1) = 'B'  and cp159=0 and cp65=st01(+) " & _
                "and (st03='F21' or st03='M51') and st01<>'F4102' and st01<>'F4104' and st01<>'F4105' and cp09=cpp01(+) "
   'Modified by Lydia 2023/05/10 +CP14
   strA1 = "select cp05,cp09,cp27,cp48,SUM(DECODE(CPP01,NULL,0,DECODE(UPPER(SUBSTR(CPP02,-4,4)),'.DEL',0,1))) cnt,CP14 " & _
                "from caseprogress,staff,casepaperpdf " & _
                "where cp01='" & stCP(1) & "' and cp02='" & stCP(2) & "' and cp03='" & stCP(3) & "' and cp04='" & stCP(4) & "' " & _
                "and cp10='" & stCP10 & "' and substr(cp09,1,1) = 'B'  and cp159=0 and cp65=st01(+) " & _
                "and (st03='F21' or st03='M51') and st01<>'F4102' and st01<>'F4104' and st01<>'F4105' and cp09=cpp01(+) "
   If iState = "1" Then
       strA1 = strA1 & "and cp158=0 " '未發文
   ElseIf iState = "2" Then
       strA1 = strA1 & "and cp158>0 " '已發文
   End If
   'end 2019/09/19
   
   'Modified by Lydia 2023/05/10 +CP14
   strA1 = strA1 & "group by cp05,cp09,cp27,cp48,CP14 order by cp05 desc"
   intA = 1
   Set rsAD = ClsLawReadRstMsg(intA, strA1)
   If intA = 1 Then
        stCP09 = "" & rsAD.Fields("cp09")
        stCPP = "" & rsAD.Fields("cnt")
        stCP27 = Val("" & rsAD.Fields("cp27"))  'Added by Lydia 2019/09/19
        stCP14 = "" & rsAD.Fields("cp14") 'Added by Lydia 2023/05/10
        PUB_ChkBCPisExist = True
   End If
   
   Set rsAD = Nothing
End Function

'Added by Lydia 2022/04/27 工程師命名作業收文：提申後FMP主修和告代的承辦期限規則
Public Function Pub_GetFMPbCP48(ByVal pKind As String, ByRef pCP() As String, ByVal pCP10 As String, Optional ByRef pCP06 As String) As String
'pKind: 1-命名作業呼叫, 2-其他
Dim strB1 As String, intB As Integer, rsBD As New ADODB.Recordset
Dim strBCP09 As String
Dim strBeginDate As String '新案發文日

    Pub_GetFMPbCP48 = ""
    pCP06 = ""
    
    If PUB_ChkBCPisExist(pCP, pCP10, strBCP09) = False Then
        If pKind = "2" Then Exit Function
    End If
    strB1 = "select cp09, cp10, cp158, tct20, tct117 from caseprogress,transcasetitle where cp01='" & pCP(1) & "' and cp02='" & pCP(2) & "' and cp03='" & pCP(3) & "' and cp04='" & pCP(4) & "' " & _
               "and cp31='Y' and cp158>19221111 and cp159=0 and cp09=tct01(+) "
    intB = 1
    Set rsBD = ClsLawReadRstMsg(intB, strB1)
    If intB = 1 Then
        strBeginDate = "" & rsBD.Fields("cp158")
        If pCP10 = "203" And "" & rsBD.Fields("tct117") <> "1" Then '排除提申前主動修正
            Exit Function
        ElseIf pCP10 = "901" And "" & rsBD.Fields("tct20") <> "1" Then '排除提申前告代
            Exit Function
        End If
    Else
        Exit Function
    End If
    
    If pCP10 = "203" Then '主動修正
       '主動修正:
       '提申前:本所期限=新案本所期限，承辦期限=本所期限往前-5個工作天[同FCP]
       '提申後:
       '1.若無收文實體審查(416)則:
       '本所期限=下一程序之實體審查(416)的本所期限
       '承辦期限=本所期限往前-5個工作天
       '2.若有收文實體審查(416)則:
       '本所期限 =(1)新案發文日+3個月／(2)待收到進入實質審查官方發文日+3個月
       '　　　　收到1204進入實審通知,1214初步審查及進入實審,1215公布及進入實審通知(初審及公佈通知來函輸入的第3-~5項)時，若有主動修正未發文，則update主動修正期限為1204,1214,1215的收文日+3個月
       '承辦期限= 本所期限往前-5個工作天
       '--------------------------------------------------
       If PUB_ChkCPExist(pCP, "416") = False Then
          strB1 = "select np08 from nextprogress where np02='" & pCP(1) & "' and np03='" & pCP(2) & "' and np04='" & pCP(3) & "' and np05='" & pCP(4) & "' " & _
                     " and np07='416' and nvl(np06,'N') <> 'N'  order by np08 desc "
          intB = 1
          Set rsBD = ClsLawReadRstMsg(intB, strB1)
          If intB = 1 Then
              Pub_GetFMPbCP48 = "" & rsBD.Fields("np08")
              pCP06 = CompWorkDay(6, Pub_GetFMPbCP48, 1)
          End If
       Else
          strB1 = "select cp09, cp10, cp158 from caseprogress where cp01='" & pCP(1) & "' and cp02='" & pCP(2) & "' and cp03='" & pCP(3) & "' and cp04='" & pCP(4) & "' " & _
                      "and cp10 in ('1204','1214','1215') and cp158>19221111 and cp159=0 order by cp158 asc"
          intB = 1
          Set rsBD = ClsLawReadRstMsg(intB, strB1)
          If intB = 1 Then
               If pKind = "2" And rsBD.RecordCount > 1 Then
                   '(2)待收到進入實質審查官方發文日+3個月：有期限就不再更新
               Else
                   Pub_GetFMPbCP48 = CompWorkDay(1, CompDate(1, 3, "" & rsBD.Fields("CP158")), 1)
               End If
          Else
               Pub_GetFMPbCP48 = CompWorkDay(1, CompDate(1, 3, strBeginDate), 1)
          End If
          If Pub_GetFMPbCP48 <> "" Then
              pCP06 = CompWorkDay(6, Pub_GetFMPbCP48)
          End If
       End If
    ElseIf pCP10 = "901" Then '告代
      '告代:
      '提申前:承辦期限 =告代收文日起算6個工作天，本所期限 = 承辦期限 + 再加5個工作天[同FCP]
      '提申後: 承辦期限 =(1)通知申請日或通知申請案號／(2)告代收文日起算6個工作天
      '　　　(1)取最早通知申請日1102或通知申請案號1101，且已通知申請日已update期限，後又key通知申請案號時，就不要再updata期限；
      '　　　(2)若已命名完且已經有通知申請日或通知申請案號，之後工程師又去命名勾選提申後告代，則從他勾選的那天起，起算6個工作天；
      '　　　  若只有新案提申無上述情況，告代收文日起算6個工作天；
      '        本所期限 = 承辦期限 + 再加5個工作天
      '-------------------------------------------
       strB1 = "select cp09, cp10, cp158 from caseprogress where cp01='" & pCP(1) & "' and cp02='" & pCP(2) & "' and cp03='" & pCP(3) & "' and cp04='" & pCP(4) & "' " & _
                   "and cp10 in ('1101','1102') and cp158>19221111 and cp159=0 order by cp158 asc"
       intB = 1
       Set rsBD = ClsLawReadRstMsg(intB, strB1)
       If intB = 1 Then
            If pKind = "2" And rsBD.RecordCount > 1 Then
                 '(1)通知申請日或通知申請案號：有期限就不再更新
            Else
                Pub_GetFMPbCP48 = CompWorkDay(7, "" & rsBD.Fields("CP158"))
            End If
       Else
            '無(1)通知申請日或通知申請案號(含只有新案提申)：告代收文日
             Pub_GetFMPbCP48 = CompWorkDay(7, strSrvDate(1))
       End If
       If Pub_GetFMPbCP48 <> "" Then
            pCP06 = CompWorkDay(6, Pub_GetFMPbCP48)
       End If
    End If
    If Pub_GetFMPbCP48 <> "" And Pub_GetFMPbCP48 < strSrvDate(1) Then
        Pub_GetFMPbCP48 = strSrvDate(1)
        pCP06 = strSrvDate(1)
    End If
    '內專預設承辦期限和所限 :  新案發文、進入實質審查、通知申請案號or 通知申請日
    If Pub_GetFMPbCP48 <> "" And pKind = "2" And strBCP09 <> "" Then
        strB1 = "Update CaseProgress set cp48 = " & Pub_GetFMPbCP48 & " , cp06 = " & pCP06 & " where cp09='" & strBCP09 & "' and cp158=0 and cp159=0 "
        cnnConnection.Execute strB1
    End If
    
    Set rsBD = Nothing
End Function


'Added by Lydia 2022/08/04 工程師命名作業:取得承辦期限; 從frm090902_2抽出, 為了與frm060102共用
'iCP05, iCP06, iNa01, iPA10: 新申請案之收文日、所限、申請國家、申請日
'updCP10, updCP06: 計算收文之案件性質、本所期限
't201CP06, t201CP27: 新案翻譯：所限、發文日
Public Function PUB_GetTCTbCP48(ByVal iKind As String, ByVal iCP01 As String, ByVal iCP02 As String, ByVal iCP03 As String, ByVal iCP04 As String, ByVal iNa01 As String, _
                                    ByVal iPA10 As String, ByVal iCP05 As String, ByVal iCP06 As String, ByVal updCP10 As String, _
                                    Optional ByRef updCP06 As String, Optional ByVal t201CP06 As String, Optional ByVal t201CP27 As String) As String
'Memo by Lydia 2023/04/21  提申前：新增判斷指定送件日(2023/04/21 規則)
'主動修正:
'提申前 : 主動修正的本所期限=提申的本所期限(本所期限若超過指定送件日, 則以指定送件日當本所期限)，承辦期限=指定送件日往前-5個工作天
'提申後: 1. 新案翻譯已發文並且與申請日同一天, 承辦期限=新案發文日起算15個工作天, 本所期限=承辦期限+再加5個工作天
'        2. 新案翻譯未發文, 本所期限=新案翻譯的本所期限, 承辦期限=本所期限往前-5個工作天
'告代:
'提申前: 告代收文日起算6個工作天 , 本所期限 = 承辦期限 + 再加5個工作天(本所期限若超過指定送件日, 則以指定送件日當本所期限)
'提申後：承辦期限=新案發文日起算6個工作天, 本所期限=承辦期限+再加5個工作天
'end 2023/04/21
'Memo by Lydia 2022/04/28 工程師命名作業收文FMP主修和告代的承辦期限規則：提申前的承辦期限規則與FCP案一致；
'Memo by Lydia 2021/09/08 提申前的告代的承辦期限以系統日+(依案件國家收費表天數計算,ex.告代的FCP案5天,FG案6天,P案7天)個工作天 ;
                                        '所限和承辦期限不可大於新案的所限,若期限超過系統日改用系統日; ex.FCP65474, FCP65176是8月收文等到說明書才進行命名作業
                                        '提申前的主動修正的本所期限=提申的本所期限(和分案作業相同);承辦期限=本所期限往前-5個工作天

'end 2021/09/08
'Memo by Lydia 2021/08/23 規則
'主動修正:
'提申前:  本所期限 = 新案收文日起算15個工作天(本所期限若超過提申所限, 則以提申所限當本所期限)，承辦期限=本所期限往前-5個工作天
'提申後: 1. 新案翻譯已發文並且與申請日同一天，承辦期限 = 新案發文日起算15個工作天，本所期限 = 承辦期限 + 再加5個工作天
'              2. 新案翻譯未發文，本所期限 = 新案翻譯的本所期限，承辦期限=本所期限往前-5個工作天
'告代:
'提申前: 承辦期限 = 新案收文日起算(依案件國家收費表天數計算,FCP案5天,FG案6天,P案7天)個工作天，本所期限 = 承辦期限 + 再加5個工作天(本所期限若超過提申所限, 則以提申所限當本所期限)
'提申後(等到新案發文一併更新): 承辦期限 = 新案發文日起算6個工作天，本所期限 = 承辦期限 + 再加5個工作天
'增加判斷新案已提申，從命名收文【提申後告代】承辦期限 = 收文日起算6個工作天，本所期限 = 承辦期限 + 再加5個工作天(本所期限若超過新案翻譯的本所期限, 則以新案翻譯的所限當本所期限)
'end 2021/08/23
'Memo by Lydia 2018/04/18 規則
'告代：(提申前)收文日/(提申後)新案發文日起算6個工作天
'主動修正：(提申前)收文日/(提申後+新案翻譯已發文並且與申請日同一天)新案發文日起算15個工作天/
'                        (提申後+新案翻譯未發文)=新案翻譯的本所期限
'提申前的承辦期限若超過提申所限，則以提申所限當承辦期限
'end 2018/04/18
Dim oStdDate As String '起始日
Dim strDate1 As String
Dim strTmp1 As String, strTmp2 As String
Dim pCase(1 To 4) As String
'Added by Lydia 2023/04/21
Dim strCon1 As String, intQ As Integer
Dim rsQD As New ADODB.Recordset
Dim strCP142 As String

  pCase(1) = iCP01: pCase(2) = iCP02: pCase(3) = iCP03: pCase(4) = iCP04
  
  iCP06 = DBDATE(iCP06)
  iCP05 = DBDATE(iCP05)
  
  updCP06 = "" 'Added by Lydia 2021/08/23
  If iKind = "1" Then    '提申後
    'Added by Lydia 2022/04/28 工程師命名作業收文FMP主修和告代的承辦期限規則：提申前的承辦期限規則與FCP案一致；
    If pCase(1) = "P" Then
        strDate1 = Pub_GetFMPbCP48("1", pCase, updCP10, updCP06)
    Else
    'end 2022/04/28
       If Val(iPA10) > 0 Then '有申請日才算期限
            '告代
            If updCP10 = "901" Then
                 'Modified by Lydia 2021/08/23
                 'strDate1 = Pub_GetHandleDay(pCase(1), iNa01, updCP10, n_CP27) '承辦期限 = 新案發文日起算6個工作天
                 '承辦期限 = 收文日起算6個工作天
                 strDate1 = Pub_GetHandleDay(pCase(1), iNa01, updCP10, strSrvDate(1))
                 '本所期限 = 承辦期限 + 再加5個工作天
                 updCP06 = PUB_GetFCPOurDeadline(strDate1, , , , "N")
                 '本所期限若超過新案翻譯的本所期限, 則以新案翻譯的所限當本所期限
                 If updCP06 > t201CP06 Then updCP06 = t201CP06
            '主動修正
            ElseIf updCP10 = "203" Then
                 '(提申後+新案翻譯已發文=新案發文日)新案發文日起算15個工作天
                 If Val(t201CP27) = Val(iPA10) Then
                      strDate1 = Pub_GetHandleDay(pCase(1), iNa01, updCP10, t201CP27)
                      updCP06 = PUB_GetFCPOurDeadline(strDate1, , , , "N")  'Added by Lydia 2021/08/23 本所期限 = 承辦期限 + 再加5個工作天
                 Else
                 '(提申後+新案翻譯未發文)=新案翻譯的本所期限
                      'Modified by Lydia 2021/08/23 新案翻譯未發文，本所期限 = 新案翻譯的本所期限，承辦期限=本所期限往前-5個工作天
                      'strDate1 = t201CP06
                      updCP06 = t201CP06
                      strDate1 = CompWorkDay(6, updCP06, 1)  '承辦期限=本所期限往前-5個工作天
                      'end 2021/08/23
                 End If
            End If
       Else
            strDate = ""
       End If
    End If 'Added by Lydia 2022/04/28
  ElseIf iKind = "2" Then '提申前
       'Added by Lydia 2023/04/21 新案的客戶指定送件日期
       strCon1 = "select cp142 from caseprogress where cp01='" & pCase(1) & "' and cp02='" & pCase(2) & "' and cp03='" & pCase(3) & "' and cp04='" & pCase(4) & "' and cp31='Y' "
       intQ = 1
       Set rsQD = ClsLawReadRstMsg(intQ, strCon1)
       If intQ = 1 Then
           strCP142 = "" & rsQD.Fields("cp142")
       End If
       Set rsQD = Nothing
       'end 2023/04/21
       'Added by Lydia 2021/08/23
       If updCP10 = "203" Then   '主動修正
            'Modified by Lydia 2021/09/08 以系統日+(依案件國家收費表天數計算)個工作天
            'Mark by Lydia 2021/09/08 提申前的主動修正的本所期限=提申的本所期限(和分案作業相同);承辦期限=本所期限往前-5個工作天
            'updCP06 = Pub_GetHandleDay(pCase(1), iNa01, updCP10, iCP05, iCP06)
            'If updCP06 > iCP06 Then
                 updCP06 = iCP06  '提申所限當本所期限
            'End If 'Mark by Lydia 2021/09/08
            'Added by Lydia 2023/04/21 本所期限若超過指定送件日, 則以指定送件日當本所期限
            If Val(strCP142) > 0 And updCP06 > strCP142 Then
                updCP06 = strCP142
            End If
            'end 2023/04/21
            If updCP06 < strSrvDate(1) Then updCP06 = strSrvDate(1) 'Added by Lydia 2021/09/08 若期限超過系統日改用系統日
            
            '承辦期限=本所期限往前-5個工作天
            strDate1 = CompWorkDay(6, updCP06, 1)
            If strDate1 < strSrvDate(1) Then strDate1 = strSrvDate(1) '若期限超過系統日改用系統日
            
       Else
       'end 2021/08/23
            'Memo by Lydia 2021/08/23 承辦期限 = 新案收文日起算6個工作天，本所期限 = 承辦期限 + 再加5個工作天(本所期限若超過提申所限, 則以提申所限當本所期限)
            'Modified by Lydia 2021/09/08 以系統日+(依案件國家收費表天數計算)個工作天
            'strDate1 = Pub_GetHandleDay(pCase(1), iNa01, updCP10, iCP05, iCP06)
            'If strDate1 > iCP06 Then  '所限和承辦期限不可大於新案的所限
            strDate1 = Pub_GetHandleDay(pCase(1), iNa01, updCP10, strSrvDate(1), iCP06)
            If strDate1 > iCP06 And iCP06 <> "" Then  '所限和承辦期限不可大於新案的所限
                strDate1 = iCP06
            End If
            If strDate1 < strSrvDate(1) Then strDate1 = strSrvDate(1) 'Added by Lydia 2021/09/08 若期限超過系統日改用系統日
            'end 2021/09/08
            'Added by Lydia 2021/08/23 本所期限 = 承辦期限 + 再加5個工作天
            updCP06 = CompWorkDay(6, strDate1)  '本所期限 = 承辦期限 + 再加5個工作天
            'Modified by Lydia 2021/09/08
            'If updCP06 > iCP06 Then
            If updCP06 > iCP06 And iCP06 <> "" Then
                 updCP06 = iCP06  '提申所限當本所期限
            End If
            'Added by Lydia 2023/04/21 本所期限若超過指定送件日, 則以指定送件日當本所期限
            If Val(strCP142) > 0 And updCP06 > strCP142 Then
                updCP06 = strCP142
            End If
            'end 2023/04/21
            If updCP06 < strSrvDate(1) Then updCP06 = strSrvDate(1) 'Added by Lydia 2021/09/08 若期限超過系統日改用系統日
            'end 2021/08/23
       End If 'Added by Lydia 2021/08/23
  ElseIf iKind = "3" Then '當日告代
       strDate1 = strSrvDate(1)
  End If
  
  PUB_GetTCTbCP48 = strDate1
End Function

'Add by Sindy 2022/8/12 原則上未發文均可.(非F部門客戶異動智權人員時，客戶未發文進度之智權人員同步修改，整批改客戶亦同)
'傳入客戶編號8碼、原智權人員(A)、新智權人員(B)三個參數
Public Sub Pub_ChangeSaleUpdCP13(ByVal m_CUID As String, ByVal m_OldSales As String, ByVal m_NewSales As String)
Dim strSql As String, intR As Integer, strQuySql As String
Dim rsBD As New ADODB.Recordset

   '當原智權人員離職且非F部門,才異動資料
   'Modify by Amy 2022/08/23 原:PUB_GetST03
   If ChkStaffST04(m_OldSales, False) = True And Left(PUB_GetStaffST15(m_OldSales, 1), 1) <> "F" And Left(PUB_GetStaffST15(m_NewSales, 1), 1) <> "F" Then
      m_CUID = Left(ChangeCustomerL(m_CUID), 8)
      '將該客戶所有未閉卷未銷卷案件之未發文未取消收文進度，若CP13為離職人員時(不必檢查是否與(A)相同)
      'Modify By Sindy 2022/8/29
      '原先控制只要案件的智權人員是離職，不管是不是(A)，一律都改為(B)；
      '但法律所案源資料的智權人員也可能被改掉，
      '所以還是改為只有智權人員為(A)的未發文未取消進度才改為(B)。
      'Modify By Sindy 2022/9/19 修改語法,改善查詢速度
      'Modify By Sindy 2022/9/20 只要抓申請人1比對客戶編號即可
      strQuySql = "SELECT CP09 FROM CASEPROGRESS,STAFF WHERE (CP01,CP02,CP03,CP04) IN (" & _
                              "SELECT TM01,TM02,TM03,TM04 FROM TRADEMARK WHERE substr(TM23,1,8)='" & m_CUID & "' AND TM30||TM57 is null"
      strQuySql = strQuySql + " union all select PA01,PA02,PA03,PA04 FROM PATENT WHERE substr(PA26,1,8)='" & m_CUID & "' AND PA58||PA108 is null"
      strQuySql = strQuySql + " union all select SP01,SP02,SP03,SP04 FROM SERVICEPRACTICE WHERE substr(SP08,1,8)='" & m_CUID & "' AND SP16||SP61 is null"
      strQuySql = strQuySql + " union all select LC01,LC02,LC03,LC04 FROM LAWCASE WHERE substr(LC11,1,8)='" & m_CUID & "' AND LC09||LC34 is null"
      strQuySql = strQuySql + " union all select HC01,HC02,HC03,HC04 FROM HIRECASE WHERE substr(HC05,1,8)='" & m_CUID & "' AND HC10||HC19 is null"
      strQuySql = strQuySql & _
                              ") AND substr(CP12,1,1)<>'F' AND CP158=0 AND CP159=0" & _
                              " AND CP13=ST01(+) AND ST04='2' AND CP13='" & m_OldSales & "'"
      intR = 1
      Set rsBD = ClsLawReadRstMsg(intR, strQuySql)
      If intR = 1 Then
         If rsBD.RecordCount > 0 Then
            '2.再更新該收文號未走完送會歷程的收受者為原智權人員(A)的資料，改收受者為新智權人員(B)
            strSql = "update empelectronprocess set" & _
                     " EEP05='" & m_NewSales & "',EEP11=EEP11||';原收受者為'||EEP05||';'" & _
                     " where eep01 in(" & strQuySql & ")" & _
                     " and eep04 in('" & EMP_送會 & "','" & EMP_會圖 & "')" & _
                     " and EEP09='Y'"
            cnnConnection.Execute strSql, intR
            '1.修改進度檔:智權人員CP13為新智權人員(B)，並於進度備註加註"西元年/月/日因客戶異動智權人員而改未發文案件之收文智權人員，原收文智權人員為XXX；"
            'Modify by Amy 2022/08/23 原:PUB_GetST03
            strSql = "update CASEPROGRESS set" & _
                     " CP13='" & m_NewSales & "',CP12='" & PUB_GetStaffST15(m_NewSales, 1) & "',CP64=CP64||'" & ChangeWStringToWDateString(strSrvDate(1)) & "因客戶異動智權人員而改未發文案件之收文智權人員，原收文智權人員為'||cp13||';'" & _
                     " where CP09 in(" & strQuySql & ")"
            cnnConnection.Execute strSql, intR
         End If
      End If
   End If
End Sub

'Added by Lydia 2023/12/29 客戶改智權人員要同時更新該客戶所有案件下一程序未過期未續辦的期限(從frm140401.ModRecord抽出模組);
Public Sub PUB_ChangeSaleUpdNP10(ByVal pCuNo As String, ByVal pOldSales As String, ByVal pNewSales As String, ByVal bolRelation As Boolean)
'bolRelation是否含關係企業
Dim strTmpA As String, StrSQLa As String, intA As Integer
Dim rsAD As New ADODB.Recordset, rsRead As New ADODB.Recordset
Dim m_CU01 As String, m_CU02 As String
Dim pOldST15 As String, pNewST15 As String
Dim lngExe As Long 'Add by Amy 2025/09/15
   
   pCuNo = ChangeCustomerL(pCuNo)
   m_CU01 = Mid(pCuNo, 1, 8)
   m_CU02 = Mid(pCuNo, 9, 1)
   If m_CU01 = "" Or m_CU02 = "" Or GetStaffName(pNewSales, True) = "" Or pOldSales = pNewSales Then Exit Sub
   pOldST15 = GetST15(pOldSales)
   pNewST15 = GetST15(pNewSales)
     
   If Mid(pNewST15, 1, 1) <> "F" Or Mid(pOldST15, 1, 1) <> "F" Then
      '傳入的客戶代號CU12,CU13已在呼叫前更新為新智權人員
      strTmpA = "Select NP01, NP07, NP22,NP02,NP03,NP04,NP05 From NextProgress, Patent Where NP02<>'FCP' AND NP02=PA01 And NP03=PA02 And NP04=PA03 And NP05=PA04 And NP06 Is Null And NP09>=" & strSrvDate(1) & " And  PA26='" & m_CU01 & IIf(m_CU02 = "", "0", m_CU02) & "' "
      strTmpA = strTmpA & " Union Select NP01, NP07, NP22,NP02,NP03,NP04,NP05 From NextProgress, Trademark Where NP02<>'FCT' AND NP02=TM01 And NP03=TM02 And NP04=TM03 And NP05=TM04 And NP06 Is Null And NP09>=" & strSrvDate(1) & " And  TM23='" & m_CU01 & IIf(m_CU02 = "", "0", m_CU02) & "' "
      strTmpA = strTmpA & " Union Select NP01, NP07, NP22,NP02,NP03,NP04,NP05 From NextProgress, Lawcase Where (NP02<>'FCL' and NP02<>'LIN') AND NP02=LC01 And NP03=LC02 And NP04=LC03 And NP05=LC04 And NP06 Is Null And NP09>=" & strSrvDate(1) & " And  LC11='" & m_CU01 & IIf(m_CU02 = "", "0", m_CU02) & "' "
      strTmpA = strTmpA & " Union Select NP01, NP07, NP22,NP02,NP03,NP04,NP05 From NextProgress, Hirecase Where NP02=HC01 And NP03=HC02 And NP04=HC03 And NP05=HC04 And NP06 Is Null And NP09>=" & strSrvDate(1) & " And  HC05='" & m_CU01 & IIf(m_CU02 = "", "0", m_CU02) & "' "
      strTmpA = strTmpA & " Union Select NP01, NP07, NP22,NP02,NP03,NP04,NP05 From NextProgress, ServicePractice Where NP02<>'FG' AND NP02=SP01 And NP03=SP02 And NP04=SP03 And NP05=SP04 And NP06 Is Null And NP09>=" & strSrvDate(1) & " And  SP08='" & m_CU01 & IIf(m_CU02 = "", "0", m_CU02) & "' "
      
      intA = 1
      Set rsAD = ClsLawReadRstMsg(intA, strTmpA)
      If intA = 1 Then
         rsAD.MoveFirst
         Do While Not rsAD.EOF
            'Modify by Amy 2022/08/31 +if MCT案件的智權人員是依FC代理人的管控智權人員FA120,而不是客戶檔的智權人員
            If Left(pNewST15, 3) = "MCT" Then
                'Memo 原若已是MCT則不會更新,因可能同一案子不同代理人,但原不是MCT改MCT要更新(但要先設定FA120)
                StrSQLa = "Update Nextprogress Set NP10='" & PUB_GetAKindSalesNo("" & rsAD.Fields("NP02"), "" & rsAD.Fields("NP03"), "" & rsAD.Fields("NP04"), "" & rsAD.Fields("NP05")) & "' " & _
                                "Where NP01='" & rsAD.Fields(0).Value & "' And NP07='" & rsAD.Fields(1).Value & "' And NP22=" & rsAD.Fields(2).Value & strNpSqlOfNoSalesDuty
            Else
                '2010/3/22 MODIFY BY SONIA 剔除下一程序非智權人員掌控之案件性質改以strNpSqlOfNoSalesDuty控制
                StrSQLa = "Update Nextprogress Set NP10='" & pNewSales & "' Where NP01='" & rsAD.Fields(0).Value & "' And NP07='" & rsAD.Fields(1).Value & "' And NP22=" & rsAD.Fields(2).Value & strNpSqlOfNoSalesDuty
            End If
            'Modify by Amy 2025/09/15 有執行才寫log,並傳入改前智權人員
            'Pub_SeekTbLog StrSQLa
            cnnConnection.Execute "begin user_data.user_notrigger:=1; end;" 'Add by Morgan 2012/8/22 +控制來函期限通知的 Trigger 不被觸發
            cnnConnection.Execute StrSQLa, lngExe
            cnnConnection.Execute "begin user_data.user_notrigger:=0; end;" 'Add by Morgan 2012/8/22 +控制來函期限通知的 Trigger 不被觸發
            If lngExe > 0 Then Pub_SeekTbLog StrSQLa, , , , , pOldSales
            'end 2025/09/15
            rsAD.MoveNext
         Loop
      End If
   End If
   
   '修改智權人員或業務區時，一併修改舊名稱/關聯企業的資料
   If m_CU02 = "0" Or bolRelation = True Then
      strTmpA = "select cu01,cu02,cu12,cu13 from customer where " & IIf(bolRelation = False, "cu01='" & m_CU01 & "' and cu02<>'0'", "substr(cu01,1,6)='" & Mid(m_CU01, 1, 6) & "' and cu01||cu02<>'" & m_CU01 & m_CU02 & "' ")
      'Added by Lydia 2024/04/22 關聯企業也必須為待活化客戶; X14893010在4/12收文T-248541，但是待活化客戶僅X14893010、X14893030、X14893040，卻同時將X14893000、X14893020也更新
      If bolRelation = True Then 'Added by Lydia 2024/08/15 排除客戶檔維護
         strTmpA = strTmpA & " and cu01 in (select ocu01 from oldcustomer where ocu03 is null)"
      End If
      'end 2024/04/22
      strTmpA = strTmpA & " order by 1,2 "
      intA = 1
      Set rsAD = ClsLawReadRstMsg(intA, strTmpA)
      If intA = 1 Then
         rsAD.MoveFirst
         Do While Not rsAD.EOF
            '修改智權人員或業務區時，一併修改舊名稱/關聯企業的資料
            StrSQLa = "update customer set cu12='" & pNewST15 & "',cu13='" & pNewSales & "' where cu01='" & rsAD.Fields("cu01") & "' and cu02='" & rsAD.Fields("cu02") & "' "
            Pub_SeekTbLog StrSQLa
            cnnConnection.Execute StrSQLa
            
            strTmpA = "Select NP01, NP07, NP22,NP02,NP03,NP04,NP05 From NextProgress, Patent Where NP02<>'FCP' AND NP02=PA01 And NP03=PA02 And NP04=PA03 And NP05=PA04 And NP06 Is Null And NP09>=" & strSrvDate(1) & " And  PA26='" & rsAD.Fields("cu01") & rsAD.Fields("cu02") & "' "
            strTmpA = strTmpA & " Union Select NP01, NP07, NP22,NP02,NP03,NP04,NP05 From NextProgress, Trademark Where NP02<>'FCT' AND NP02=TM01 And NP03=TM02 And NP04=TM03 And NP05=TM04 And NP06 Is Null And NP09>=" & strSrvDate(1) & " And  TM23='" & rsAD.Fields("cu01") & rsAD.Fields("cu02") & "' "
            strTmpA = strTmpA & " Union Select NP01, NP07, NP22,NP02,NP03,NP04,NP05 From NextProgress, Lawcase Where (NP02<>'FCL' and NP02<>'LIN') AND NP02=LC01 And NP03=LC02 And NP04=LC03 And NP05=LC04 And NP06 Is Null And NP09>=" & strSrvDate(1) & " And  LC11='" & rsAD.Fields("cu01") & rsAD.Fields("cu02") & "' "
            strTmpA = strTmpA & " Union Select NP01, NP07, NP22,NP02,NP03,NP04,NP05 From NextProgress, Hirecase Where NP02=HC01 And NP03=HC02 And NP04=HC03 And NP05=HC04 And NP06 Is Null And NP09>=" & strSrvDate(1) & " And  HC05='" & rsAD.Fields("cu01") & rsAD.Fields("cu02") & "' "
            strTmpA = strTmpA & " Union Select NP01, NP07, NP22,NP02,NP03,NP04,NP05 From NextProgress, ServicePractice Where NP02<>'FG' AND NP02=SP01 And NP03=SP02 And NP04=SP03 And NP05=SP04 And NP06 Is Null And NP09>=" & strSrvDate(1) & " And  SP08='" & rsAD.Fields("cu01") & rsAD.Fields("cu02") & "' "
            intA = 1
            Set rsRead = ClsLawReadRstMsg(intA, strTmpA)
            If intA = 1 Then
               rsRead.MoveFirst
               Do While Not rsRead.EOF
                  'Modify by Amy 2022/08/31 +if MCT案件的智權人員是依FC代理人的管控智權人員FA120,而不是客戶檔的智權人員
                  If Left(pNewSales, 3) = "MCT" Then
                      'Memo 原若已是MCT則不會更新,因可能同一案子不同代理人,但原不是MCT改MCT要更新(但要先設定FA120)
                      StrSQLa = "Update Nextprogress Set NP10='" & PUB_GetAKindSalesNo("" & rsRead.Fields("NP02"), "" & rsRead.Fields("NP03"), "" & rsRead.Fields("NP04"), "" & rsRead.Fields("NP05")) & "' " & _
                                      "Where NP01='" & rsRead.Fields(0).Value & "' And NP07='" & rsRead.Fields(1).Value & "' And NP22=" & rsRead.Fields(2).Value & strNpSqlOfNoSalesDuty
                  Else
                      '2010/3/22 MODIFY BY SONIA 剔除下一程序非智權人員掌控之案件性質改以strNpSqlOfNoSalesDuty控制
                      StrSQLa = "Update Nextprogress Set NP10='" & pNewSales & "' Where NP01='" & rsRead.Fields(0).Value & "' And NP07='" & rsRead.Fields(1).Value & "' And NP22=" & rsRead.Fields(2).Value & strNpSqlOfNoSalesDuty
                  End If
                  'Modify by Amy 2025/09/15 有執行才寫log,並傳入改前智權人員
                  'Pub_SeekTbLog StrSQLa
                  cnnConnection.Execute "begin user_data.user_notrigger:=1; end;" 'Add by Morgan 2012/8/22 +控制來函期限通知的 Trigger 不被觸發
                  cnnConnection.Execute StrSQLa
                  cnnConnection.Execute "begin user_data.user_notrigger:=0; end;" 'Add by Morgan 2012/8/22 +控制來函期限通知的 Trigger 不被觸發
                  If lngExe > 0 Then Pub_SeekTbLog StrSQLa, , , , , pOldSales
                  'end 2025/09/15
                  rsRead.MoveNext
               Loop
            End If
            rsAD.MoveNext
         Loop
      End If
   End If  'If m_CU02 = "0" Or bolRelation = True Then
   
   Set rsAD = Nothing
   Set rsRead = Nothing
End Sub

'Add by Morgan 2007/5/24
'抓員工外譯對照資料 p_IO: 0=內->外 1=外->內
'Move by Lydia 2022/09/02 從basQuery搬過來
Public Function PUB_GetMapID(p_ID As String, Optional p_IO As Integer = 1) As String
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   
   If p_IO = 0 Then
      stSQL = "select sim02 from staff_idmap,staff where sim01='" & p_ID & "' and st01=sim02 and st04='1'"
   Else
      stSQL = "select sim01 from staff_idmap,staff where sim02='" & p_ID & "' and st01=sim01 and st04='1'"
   End If
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      PUB_GetMapID = "" & rsQuery.Fields(0)
   End If
   
   If rsQuery.State = adStateOpen Then rsQuery.Close
   Set rsQuery = Nothing
End Function

'Add by Morgan 2007/5/30
'外專工程師組別代碼轉中文
'2010/1/8 p_man 工程師才有第5組,案件沒有第5組
'2012/1/12 modify by sonia 電機組->電子電機組,機械組->機械設計組
'Modify by Amy 2021/04/28 +是否show訊息
'Move by Lydia 2022/09/02 從basQuery搬過來
Public Function PUB_GetFCPGrpName(p_Code As String, Optional p_man As Boolean = False, Optional bolMsg As Boolean = True) As String
   PUB_GetFCPGrpName = ""
   Select Case p_Code
      Case "1"
         PUB_GetFCPGrpName = "電子電機組"
      Case "2"
         PUB_GetFCPGrpName = "化學組"
      Case "3"
         PUB_GetFCPGrpName = "日文組"
      '2008/2/22 add by sonia
      Case "4"
         PUB_GetFCPGrpName = "機械設計組"
      '2008/2/22 end
      '2010/1/8 add by sonia
      Case "5"
         If p_man = True Then
            PUB_GetFCPGrpName = "其他"
         End If
      '2010/1/8 end
   End Select
   '2010/1/8 add by sonia
   'Modify by Amy 2021/04/28 +bolMsg
   If bolMsg = True Then
        If PUB_GetFCPGrpName = "" And p_Code <> "" Then
           MsgBox "工程師組別錯誤！", vbExclamation
        End If
   End If
   '2010/1/8 end
End Function

'Added by Lydia 2019/01/09 取得工程師組別主管
'Move by Lydia 2022/09/02 從basQuery搬過來
Public Function Pub_GetFCPGrpMan(ByVal pNo As String) As String
    
    If Len(pNo) = 1 Then
        Select Case pNo 'FCP工程師組別
            Case "1"    '電子組
                Pub_GetFCPGrpMan = Pub_GetSpecMan("T")
            Case "2"    '化學組
                Pub_GetFCPGrpMan = Pub_GetSpecMan("R")
            Case "3"    '日文組
                Pub_GetFCPGrpMan = Pub_GetSpecMan("S")
            Case "4"    '機械組
                Pub_GetFCPGrpMan = Pub_GetSpecMan("T1")
            Case Else
                Pub_GetFCPGrpMan = ""
        End Select
    End If
End Function

'Add by Sindy 2010/10/27
'專利案件屬性代碼轉中文
'Modify By Sindy 2014/7/8 +stPA08
'Move by Lydia 2022/09/02 從basQuery搬過來
Public Function PUB_GetCaseAttributeName(p_Code As String, Optional stPA08 As String = "1") As String
   PUB_GetCaseAttributeName = ""
   'Modify By Sindy 2014/7/8
   If stPA08 = "3" Then '3.設計案
      Select Case p_Code
         Case "1"
            PUB_GetCaseAttributeName = "整體"
         Case "2"
            PUB_GetCaseAttributeName = "部分"
         Case "3"
            PUB_GetCaseAttributeName = "圖像"
         Case "4"
            PUB_GetCaseAttributeName = "成組"
      End Select
   Else '發明或新型案
   '2014/7/8 END
      Select Case p_Code
         Case "1"
            PUB_GetCaseAttributeName = "機械"
         Case "2"
            PUB_GetCaseAttributeName = "電子電機"
         Case "3"
            PUB_GetCaseAttributeName = "化學生醫"
      End Select
   End If
   If PUB_GetCaseAttributeName = "" And p_Code <> "" Then
      MsgBox "案件屬性錯誤！", vbExclamation
   End If
End Function

'2007/12/24 Add by sonia
'外商承辦組別代碼轉中文(p_Code=st16)
'Modify by Amy 2021/04/12 +p_st70
'Modify by Amy 2021/04/28 +bolMsg
'Move by Lydia 2022/09/02 從basQuery搬過來
Public Function PUB_GetFCTGrpName(p_Code As String, p_st70 As String, Optional bolMsg As Boolean = True) As String
   PUB_GetFCTGrpName = ""
   'Modify by Amy 2021/04/12 原只傳p_code>>1=第１組,加傳p_st70
   Select Case p_Code
        Case "2"
            PUB_GetFCTGrpName = "英文組"
        Case "4"
            PUB_GetFCTGrpName = "日文組"
        'add by sonia 2021/6/25
        Case "6"
            PUB_GetFCTGrpName = "ＣＦＴ"
         'end 2021/6/25
   End Select
   'modify by sonia 2021/6/25 加入p_Code = "6"
   If p_Code = "2" Or p_Code = "6" Then
        Select Case p_st70
           Case "1"
              PUB_GetFCTGrpName = PUB_GetFCTGrpName & "第１組"
           Case "2"
              PUB_GetFCTGrpName = PUB_GetFCTGrpName & "第２組"
           Case "3"
              PUB_GetFCTGrpName = PUB_GetFCTGrpName & "第３組"
           Case "4"
              PUB_GetFCTGrpName = PUB_GetFCTGrpName & "第４組"
        End Select
   End If
   'end 2021/04/12
   '2010/1/8 add by sonia
   'Modify by Amy 2021/04/28 +bolMsg
   If bolMsg = True Then
        If PUB_GetFCTGrpName = "" And p_Code <> "" Then
           MsgBox "組別錯誤！", vbExclamation
        End If
   End If
   '2010/1/8 end
End Function

'2015/12/22 Add by sonia
'外法組別代碼轉中文
'Move by Lydia 2022/09/02 從basQuery搬過來
Public Function PUB_GetFCLGrpName(p_Code As String) As String
   PUB_GetFCLGrpName = ""
   Select Case p_Code
      Case "1"
         PUB_GetFCLGrpName = "英文組"
      Case "2"
         PUB_GetFCLGrpName = "日文組"
   End Select
   If PUB_GetFCLGrpName = "" And p_Code <> "" Then
      MsgBox "組別錯誤！", vbExclamation
   End If
End Function
'2015/12/22 END

'add by sonia 2023/12/18 外籍顧問因新部門代號故加分組
Public Function PUB_GetFEMPGrpName(p_Code As String) As String
   PUB_GetFEMPGrpName = ""
   Select Case p_Code
      Case "1"
         PUB_GetFEMPGrpName = "英文組"
      Case "2"
         PUB_GetFEMPGrpName = "德文組"
      Case "3"
         PUB_GetFEMPGrpName = "日文組"
   End Select
   If PUB_GetFEMPGrpName = "" And p_Code <> "" Then
      MsgBox "組別錯誤！", vbExclamation
   End If
End Function
'end 2023/12/18

'Add by Amy 2022/12/05 客戶代理人來源資料
'Modify by Amy 2024/11/29 +stFormN (顯示訊息用,用於顯示按鈕不用傳)/stMsg:回傳訊息/intType:Table來源/stComeReason:來所原因
'intChoose:1-以XYS01 查XYS02 (介紹者編號)/2-以XYS02 查XYS01/3-以代理人,客戶,潛在客戶編號串XYS01 查XYS02/XYS03
Public Function Pub_GetXYSource(intChoose As Integer, ByVal stNo As String, Optional ByRef stXYSNo As String, Optional ByRef stXYSName As String, Optional ByRef stXYS03 As String _
  , Optional ByVal stFormN As String, Optional ByRef stMsg As String, Optional ByRef intType As Integer, Optional ByRef stComeReason As String) As Boolean
    Dim RsQ As New ADODB.Recordset, intQ As Integer, strQ As String, strWhere As String, stTmp As String
    Dim stMssage As String, stXNo As String 'Add Amy 2024/11/29
    
    Pub_GetXYSource = False
    stXYSNo = "": stXYSName = "": stXYS03 = ""
    'Add by Amy 2024/11/29
    stMsg = "": stMssage = "": intType = 0: stComeReason = ""
    Select Case UCase(stFormN)
      Case "FRM100101_10", "FRM100101_11", "FRM100101_21", "FRM100101_14" '目前不傳FormName,只用於顯示按鈕
      Case "FRM050705" '國外代理人資料維護
         stMssage = "代理人"
      Case "FRM12040125" '客戶/代理人改號作業
         stMssage = "客戶/代理人"
      Case "FRM140401" '客戶基本資料維護
         stMssage = "客戶"
      Case "FRM140402" '國外潛在客戶資料維護
         stMssage = "潛在客戶"
      Case "FRM210128" '潛在客戶資料維護
         stMssage = "潛在客戶"
   End Select
    
   'Modify by Amy 2024/11/29 +intchoose=3 及 2 加排序
   If intChoose = 3 Then
      strQ = "Select XYNo,ComeReason,TB, XYS01,XYS02,XYS03 From XYNoSource" & _
                        ",(Select pcu01 as XYNo,pcu55 as ComeReason,1 as TB From PotCustomer Where pcu01='" & stNo & "' And pcu02='0' " & _
                        "Union Select poc01 as XYNo,'' as ComeReason,2 as TB From PotCustomer1 Where poc01='" & stNo & "' And poc02='0' " & _
                        "Union Select fa01 as XYNo,fa127 as ComeReason,3 as TB From Fagent Where fa01='" & stNo & "' And fa02='0' " & _
                        "Union Select cu01 as XYNo,'' as ComeReason,4 as TB From Customer Where cu01='" & stNo & "' And cu02='0' ) " & _
                  "Where XYNo=XYS01(+) "
   Else
      strQ = "Select XYS01,XYS02,XYS03 From XYNoSource,Fagent " & _
                 "Where XYS0" & intChoose & "='" & stNo & "' And XYS0" & intChoose & "=FA01(+) And FA01 is not null " & _
       "Union Select XYS01,XYS02,XYS03 From XYNoSource,Customer " & _
                "Where XYS0" & intChoose & "='" & stNo & "' And XYS0" & intChoose & "=CU01(+) And CU01 is not null "
       'Add  by Amy 2023/07/12 +國外/國內 潛在客戶
       strQ = strQ & "Union Select XYS01,XYS02,XYS03 From XYNoSource,PotCustomer " & _
                "Where XYS0" & intChoose & "='" & stNo & "' And XYS0" & intChoose & "=PCU01(+) And PCU01 is not null " & _
       "Union Select XYS01,XYS02,XYS03 From XYNoSource,PotCustomer1 " & _
                "Where XYS0" & intChoose & "='" & stNo & "' And XYS0" & intChoose & "=POC01(+) And POC01 is not null "
       'end 2023/07/12
       If intChoose = 2 Then
         strQ = "Select XYS01,XYS02,XYS03,Decode(SubStr(XYS02,1,1),'X',9,1) as mSort From (" & strQ & ") Order by mSort,XYS02 "
       End If
    End If
    'end 2024/11/29
    intQ = 1
    Set RsQ = ClsLawReadRstMsg(intQ, strQ)
    If intQ = 1 Then
        Pub_GetXYSource = True
        RsQ.MoveFirst
        Do While RsQ.EOF = False
            stTmp = ""
            If intChoose = 1 Then
                stXYSNo = stXYSNo & ";" & RsQ.Fields("XYS02") '回傳介紹者資料
                If Not IsNull(RsQ.Fields("XYS02")) Then
                    If Left(RsQ.Fields("XYS02"), 1) = 代理人編號 Then
                        Call ClsPDGetAgent(RsQ.Fields("XYS02"), stTmp)
                    ElseIf Left(RsQ.Fields("XYS02"), 1) = 客戶編號 Then
                        stTmp = GetCustomerName(RsQ.Fields("XYS02"), 1)
                    'Add by Amy 2023/07/12 +潛在客戶編號
                    ElseIf Left(RsQ.Fields("XYS02"), 1) = "R" Then
                        stTmp = GetPotCustomerName(1, RsQ.Fields("XYS02"))
                    End If
                End If
            ElseIf intChoose = 2 Then
                stXYSNo = stXYSNo & ";" & RsQ.Fields("XYS01")
                If Not IsNull(RsQ.Fields("XYS01")) Then
                    If Left(RsQ.Fields("XYS01"), 1) = 代理人編號 Then
                        Call ClsPDGetAgent(RsQ.Fields("XYS01"), stTmp)
                    ElseIf Left(RsQ.Fields("XYS01"), 1) = 客戶編號 Then
                        stTmp = GetCustomerName(RsQ.Fields("XYS01"), 1)
                        stXNo = stXNo & ";" & RsQ.Fields("XYS01") 'Add by Amy 2024/11/29
                    'Add by Amy 2023/07/12 +潛在客戶編號
                    ElseIf Left(RsQ.Fields("XYS01"), 1) = "R" Then
                        stTmp = GetPotCustomerName(1, RsQ.Fields("XYS01"))
                    End If
                End If
            'Modify by Amy 2024/11/29
            ElseIf intChoose = 3 Then
               '以代理人,客戶,潛在客戶編號串XYS01 查XYS02/XYS03
               intType = "" & RsQ.Fields("TB") '來源Table
               stComeReason = "" & RsQ.Fields("ComeReason") '來所原因
               If IsNull(RsQ.Fields("XYS01")) Then
                  stXYSNo = ";NoData" '介紹者資料
                  stXYS03 = "NoData"
               Else
                  stXYSNo = stXYSNo & ";" & RsQ.Fields("XYS02")
                  stXYS03 = "" & RsQ.Fields("XYS03")
               End If
            End If
            If intChoose <> 3 Then
               stXYSName = stXYSName & ";" & stTmp
               stXYS03 = "" & RsQ.Fields("XYS03")
            End If
            'end 2024/11/29
            RsQ.MoveNext
        Loop
    End If
    If stXYSNo <> MsgText(601) Then
        stXYSNo = Mid(stXYSNo, 2)
    End If
    If stXYSName <> MsgText(601) Then
        stXYSName = Mid(stXYSName, 2)
    End If
    
    stMsg = "此" & stMssage & " " & stNo & " 有[被介紹]資料如下:" & vbCrLf & vbCrLf
    '全為X編號
    If stXNo <> MsgText(601) And Replace(";" & stXYSNo, stXNo, "") = MsgText(601) Then
      stMsg = stMsg & Replace(Mid(stXNo, 2), ";", vbCrLf) & vbCrLf & _
                    "以上客戶編號請通知電腦中心,取消介紹者編號(語法)" & vbCrLf
    Else
      stMsg = stMsg & Replace(Replace(stXYSNo, stXNo, ""), ";", vbCrLf) & vbCrLf & _
                    "上述編號請通知其之建立單位,取消介紹者編號" & vbCrLf
      If stXNo <> MsgText(601) Then
         stMsg = stMsg & String(32, "=") & vbCrLf & Replace(Mid(stXNo, 2), ";", vbCrLf) & vbCrLf & _
                    "以上客戶編號請通知電腦中心,取消介紹者編號(語法)" & vbCrLf
      End If
    End If
    If UCase(stFormN) = "FRM12040125" Then
      stMsg = stMsg & "再執行改號作業！"
    Else
      stMsg = stMsg & "才可刪除！"
    End If
      
    Set RsQ = Nothing
End Function

'Add by Amy 2022/12/09 傳入Table,Key,欲回傳之欄位
'Modify by Amy 2023/04/18 +bolShowNoData:True-無資料回傳NoData
Public Function Pub_GetField(ByVal stTB As String, ByVal stKey As String, ByVal stField As String, Optional ByVal bolShowNoData As Boolean = False) As String
    Dim RsQ As New ADODB.Recordset
    Dim intQ As Integer, strQ As String
    
    Pub_GetField = ""
    strQ = "Select " & stField & " From " & stTB & " Where " & stKey
    intQ = 1
    Set RsQ = ClsLawReadRstMsg(intQ, strQ)
    If intQ = 1 Then
        Pub_GetField = "" & RsQ.Fields(0)
    'Add by Amy 2023/04/18 無資料回傳NoData
    Else
        If bolShowNoData = True Then Pub_GetField = "NoData"
    End If
    
    Set RsQ = Nothing
End Function

'Modify By Sindy 2023/1/7 有修改
'Add by Amy 2023/01/04 回傳身份種類說明
'stCF201:系統別/stCF202:國籍/stCF203:案件性質
Public Function Pub_GetCF209(ByVal stCF201 As String, ByVal stCF202 As String, ByVal stCF203 As String, _
   ByRef arrCF209() As String) As Boolean
   
Dim RsQ As New ADODB.Recordset, strQ As String
Dim intQ As Integer, intCnt As Integer
   
   Pub_GetCF209 = False
   Erase arrCF209
   ReDim Preserve arrCF209(3) As String
   
   'Modify By Sindy 2025/3/10
   strExc(10) = ""
   If Trim(stCF203) <> "" Then
      strExc(10) = " and cf203='" & stCF203 & "'"
   End If
   'Modify By Sindy 2023/1/16 P 大陸案 有無台灣專利說明書:控管101、102、103案件性質才需要顯示
   strQ = "select distinct cf205,cf209 from casefee2" & _
          " where cf201='" & stCF201 & "' and cf202='" & stCF202 & "'" & strExc(10) & _
          " and cf210=(select max(cf210) from casefee2 where cf201='" & stCF201 & "' and cf202='" & stCF202 & "'" & strExc(10) & _
          " and cf210<=" & strSrvDate(1) & ")" & _
          IIf(stCF201 = "P" And stCF202 = "020" And (stCF203 = "101" Or stCF203 = "102" Or stCF203 = "103"), "", " and cf209 is not null") & _
          " order by cf205"
   '2025/3/10 END
   intQ = 1
   Set RsQ = ClsLawReadRstMsg(intQ, strQ)
   If intQ = 1 Then
      Pub_GetCF209 = True
      'P 大陸案 回傳 (1)無(2)台灣專利說明書
      If stCF201 = "P" And stCF202 = "020" Then
         arrCF209(LBound(arrCF209)) = "無台灣專利說明書" 'Modify By Sindy 2025/2/3
         arrCF209(LBound(arrCF209) + 1) = "有台灣專利說明書" 'Modify By Sindy 2025/2/3
      Else
         intCnt = 0
         RsQ.MoveFirst
         Do While Not RsQ.EOF
             arrCF209(LBound(arrCF209) + intCnt) = "" & RsQ.Fields("cf209")
             intCnt = intCnt + 1
             RsQ.MoveNext
         Loop
      End If
   End If
   
   Set RsQ = Nothing
End Function

'Added by Morgan 2023/3/21 未發文美國新案IDS檢查(相關案是否已有OA)
Public Sub PUB_NewUsCaseIdsChk(pPA01 As String, pPA02 As String, pPA03 As String, pPA04 As String)
   Dim stSQL As String, intQ As Integer, stVTB As String
   Dim rstQ As ADODB.Recordset
   Dim stCP43 As String, stCP09 As String, stCP06 As String, stCP12 As String, stCP13 As String
   Dim stSubj As String, stText As String
   
   'Modified by Morgan 2023/5/9 排除有同時收文IDS
   stSQL = "select cp09 from caseprogress a where cp01='" & pPA01 & "' and cp02='" & pPA02 & "'" & _
      " and cp03='" & pPA03 & "' and cp04='" & pPA04 & "' and cp10 in ('101','113','114','122','307') and cp158=0 and cp159=0 and cp14 is not null" & _
      " and not exists(select * From caseprogress b where cp01=a.cp01 and cp02=a.cp02 and cp03=a.cp03 and cp04=a.cp04 and cp10='214')" & _
      " and not exists(select * From caseprogress b where cp43=a.cp09 and cp10='956'" & _
      " and instr(cp64,'檢視及評估是否須於美國案提申時一併陳報IDS')>0)"
   intQ = 1
   Set rstQ = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      stCP43 = rstQ("cp09")
      
      stVTB = PUB_GetRelCaseVTB2(pPA01, pPA02, pPA03, pPA04, True)
      stSQL = "select cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) C01,na03 from (" & stVTB & ") X,patent,caseprogress a,nation" & _
         " where x01='P' and pa01(+)=x01 and pa02(+)=x02 and pa03(+)=x03 and pa04(+)=x04 and pa08<>'2'" & _
         " and cp01(+)=pa01 and cp02(+)=pa02 and cp03(+)=pa03 and cp04(+)=pa04 and na01(+)=pa09" & _
         " and (cp10 in('1202','1227','1232','1815','1802') or (cp10 in ('1002','1001')" & _
         " and exists(select * From caseprogress b where cp09=a.cp43 and instr('101,103,301,303,107,307',cp10)>0)))" & _
         " union select cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) C01,na03 from (" & stVTB & ") X,caseprogress a,patent,nation" & _
         " where x01='CFP' and cp01(+)=x01 and cp02(+)=x02 and cp03(+)=x03 and cp04(+)=x04" & _
         " and (cp10 in('1209','1006','1220','1202','1815','1801','1802') or (cp10='1002'" & _
         " and exists(select * From caseprogress b where cp09=a.cp43 and instr('" & UpdateCaseResultCP10List & "',cp10)>0)))" & _
         " and cp01=pa01(+) and cp02=pa02(+) and cp03=pa03(+) and cp04=pa04(+) and na01(+)=pa09"
         
      intQ = 1
      Set rstQ = ClsLawReadRstMsg(intQ, stSQL)
      If intQ = 1 Then
         With rstQ
         stText = ""
         Do While Not .EOF
            stText = stText & .Fields(0) & "(" & .Fields(1) & ")" & vbCrLf
            .MoveNext
         Loop
         End With
         stCP09 = AutoNo("B", 6)
         stCP06 = PUB_GetWorkDay1(CompDate(2, 7, strSrvDate(1)), True)
         stCP13 = PUB_GetAKindSalesNo(pPA01, pPA02, pPA03, pPA04)
         stCP12 = GetSalesArea(stCP13)
         stSQL = "INSERT INTO CASEPROGRESS (CP01,CP02,CP03,CP04,CP05,CP06" & _
            ",CP09,CP10,CP11,CP12,CP13,CP14,CP20,CP26,CP32,CP43,CP64) " & _
            " select cp01,cp02,cp03,cp04,to_char(sysdate,'yyyymmdd')," & stCP06 & _
            ",'" & stCP09 & "','956','90','" & stCP12 & "','" & stCP13 & "',cp14,'N','N','N',cp09,'檢視及評估是否須於美國案提申時一併陳報IDS'" & _
            " from caseprogress where cp09='" & stCP43 & "'"
         cnnConnection.Execute stSQL, intQ
         
         stSubj = "'美國案 '||cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04)||' 已內部收文「報告客戶」，請檢視及評估是否須於提申時一併陳報IDS！'"
         'Modified by Morgan 2023/5/9 --郭
         'stText = "本案已有相對應國家之OA發出，已內部收文「報告客戶」，請檢視及評估是否須於美國案提申時一併陳報IDS，若需要，則請程序人員報價並另函報告客戶；若不需要，則請程序人員將此道「報告客戶」上111111。" & vbCrLf & vbCrLf & _
            "下列為已發OA之相關案號：" & vbCrLf & stText
         stText = "本案已有相對應國家之OA發出，已內部收文「報告客戶」，請檢視及評估是否須於美國案提申時一併陳報IDS，若不需要，則請程序人員將此道「報告客戶」上111111；若需要，則請程序人員報價並以聯絡方式通知智權同仁，由其決定是否要出定稿告知客戶。" & vbCrLf & vbCrLf & _
            "下列為已發OA之相關案號：" & vbCrLf & stText
         stSQL = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08)" & _
            " select '" & strUserNum & "' mc01,cp14 mc02,to_char(sysdate,'yyyymmdd') mc03,to_char(sysdate,'hh24miss') mc04" & _
            "," & stSubj & " mc07,'" & stText & "' mc08 from caseprogress where cp09='" & stCP09 & "'"
         cnnConnection.Execute stSQL, intQ
      End If
   End If
   Set rstQ = Nothing
End Sub

'Added by Morgan 2023/3/23
'設定身分種類
'pObjType:pObj的型態 0=Option陣列, 1=String陣列
Public Sub PUB_SetEntityOpt(pPA01 As String, pPA09 As String, pPA08 As String, pObj, Optional pPA179 As String)
   Dim arrCF209() As String
   Dim ii As Integer
   Dim stCF203 As String
   
   If TypeName(pObj) = "Object" Then
      For ii = 0 To pObj.Count - 1
         pObj(ii).Enabled = False
      Next
   ElseIf TypeName(pObj) = "ComboBox" Then
      pObj.Clear
   End If
   
   '法國設計案除外(不是以身分種類報價)
   If pPA01 = "CFP" And pPA09 = "203" And pPA08 = "3" Then
      Exit Sub
   End If
   
   'Modified by Morgan 2023/3/29 PCT要用109抓
   If pPA09 = "056" Then
      stCF203 = "109"
   Else
      stCF203 = "10" & pPA08
   End If
   If Pub_GetCF209(pPA01, pPA09, stCF203, arrCF209) Then
      Select Case TypeName(pObj)
      Case "Object"
         For ii = 0 To pObj.Count - 1
            If ii > UBound(arrCF209) Then
               pObj(ii).Visible = False
            ElseIf arrCF209(ii) <> "" Then
               pObj(ii).Caption = arrCF209(ii)
               pObj(ii).Visible = True 'Added by Morgan 2023/3/25
               pObj(ii).Enabled = True
            Else
               pObj(ii).Visible = False
            End If
         Next
      Case "ComboBox"
         pObj.AddItem "", 0
         For ii = 0 To UBound(arrCF209)
            If arrCF209(ii) = "" Then
               Exit For
            Else
               pObj.AddItem arrCF209(ii), ii + 1
            End If
         Next
         If pPA179 <> "" Then
            pObj.ListIndex = Val(pPA179)
         End If
      Case "String()"
         pObj = arrCF209
      End Select
   End If
End Sub

'Add by Amy 2023/04/17 取得ACS傳票資料
'stChoose:0-收款語法(420101) /1-抓取「當月」收款資料,並回傳資料(筆數) /2-4191「借方」最小傳票日資料 /3- 4191
                 '5-「當月」分潤(420101 ax207>0,只抓1公司,因收款當月期末時會轉至1公司保留)
                 '8-2492
                 '9-2492 期初/末 餘額 /D-排除之傳票資料
'stBackData:有值需回傳資料
Public Function GetACSData(stChoose As String, ByVal stFormN As String, ByVal stDate As String, ByVal stTB As String, Optional ByVal stCondition As String, Optional ByRef stBackData As String) As String
    Dim RsQ As New ADODB.Recordset, intQ As Integer
    Dim bolBackData As Boolean '是否回傳資料
    Dim stFixAcsWhere As String, stQ As String, stField As String, stWhere As String, stGroup As String
    
    GetACSData = ""
    If stBackData <> Empty Then bolBackData = True
    stBackData = ""
    'Modify by Amy 2023/07/31 +if [分潤]智權不會掛M0101,會掛於個人
    If stChoose <> "5" Then
       stFixAcsWhere = "And ax209='M0101' " '尚[未分潤]會掛於 ax209=M0101,故需固定加此條件
    End If
    
    Select Case UCase(stFormN)
'****** 智權期末實績保留傳票產生 ******
        Case "FRMACC41G0"
            If stChoose = "0" Then
                '依案號抓取420101當月收款資料
                stField = "ax214,Sum(ax207) as ax207"
                stGroup = " Group by ax214 "
            ElseIf stChoose = "1" Then
                '依案號抓取 420101 當月收款之對沖-客戶/摘要/對沖-其他
                stField = "Distinct ax208,ax212,ax213"
            End If
        
'***** ACS待分潤 ******
        Case "FRMACC41L0"
            If stChoose = "2" Then
                stField = "Distinct ax208,ax213,ax212"
                stGroup = " Group by ax208,ax213,ax212 "
            ElseIf stChoose = "3" Then
                stField = "Distinct ax214 as CaseNo,ax208,ax213"
            ElseIf stChoose = "9" Then
                stField = "ax214,Sum(ax207-ax206) as AMT"
                stGroup = " Group by ax214 "
            End If
        
'****** ACS待分潤明細表 ******
        Case "FRMACC41L1"
            stGroup = " Group by ax214 "
            'Add by Amy 2023/07/28 +stChoose="３"、"5"及"8"
            If stChoose = "3" Then
               '當月4191期末保留對沖-其他(記錄收款智權人員)
               stField = "ax213"
               stGroup = ""
            ElseIf stChoose = "5" Then
               '分潤
               stField = "ax201,ax202,a0205,ax207,ax208,ax209,ax212,ax213,ax214,Decode(Ax209||Nvl(ax213,'NULL'),'W2001NULL',2,Decode(Nvl(ax213,'NULL'),'NULL',1,3)) Sort "
               stGroup = ""
            ElseIf stChoose = "8" Then
               '會科2492
               stField = "ax214,Sum(ax207-ax206) as Balance"
            'end 2023/07/28
            ElseIf stChoose = "9" Then
                '2492 餘額
                stField = "ax214,Sum(ax207-ax206) as Balance"
            ElseIf stChoose = "9.1" Then
                '2492 第一筆傳票日
                stField = "ax214 as CaseNo,Min(a0205) as FirstDate"
            End If
            
'****** 函數 ******
        Case UCase("ChkACSIncomeAndEndAmt")
            If stChoose = "0" Then
                stField = "Sum(ax207) as ax207"
            ElseIf stChoose = "8" Then
                stField = "Sum(ax207) as ax207"
            End If
            
        Case UCase("GetPoint")
            stGroup = " Group by ax209 "
            If stChoose = "9" Then
                stField = "ax209 V10, Sum(ax207-ax206) V11"
                'Memo 有串SalesPoint,條件由stCondition傳入
            ElseIf stChoose = "9.1" Then
                stField = "Distinct ST01||ST02 as StName,ax209 as ST01,Decode(SP48,null,ST15,SP48) as SP48"
                stGroup = " Group by ST01||ST02,ax209,Decode(SP48,null,ST15,SP48) "
                'Memo 有串SalesPoint,條件由stCondition傳入
            ElseIf stChoose = "D" Then
                stField = "ax209 V10, Sum(-ax207) V11"
            End If
    End Select
    
    If InStr(UCase(stTB), ",ACC020") > 0 Then
        stFixAcsWhere = stFixAcsWhere & "And ax201=a0201(+) And ax202=a0202(+) "
    End If
    
    If InStr(UCase(stTB), ",STAFF") > 0 Then
         stFixAcsWhere = stFixAcsWhere & "And st01(+)=ax209 "
    End If
    
    If stChoose = "0" Or stChoose = "1" Then
        '去除 ax213空值,因11003月收款時未做收入傳票,但有做 2492傳票,並於11203月才加 420101傳票
        stFixAcsWhere = stFixAcsWhere & "And ax205='420101' And ax207>0 And Nvl(ax213,' ')<>' '  "
    ElseIf stChoose = "2" Or stChoose = "3" Then
        stFixAcsWhere = stFixAcsWhere & "And ax205='4191' "
    'Add by Amy 2023/07/31 「當月」分潤
    ElseIf stChoose = "5" Then
       stFixAcsWhere = stFixAcsWhere & "And ax205='420101'  And ax207>0 And ax201='1' "
    ElseIf stChoose = "8" Or stChoose = "9" Then
        stFixAcsWhere = stFixAcsWhere & "And ax205||''='2492' "
    End If
    
    '日期
    If stDate <> MsgText(601) Then
        stWhere = stWhere & "And SubStr(a0205,1,5)='" & stDate & "' "
    End If
    '其他條件
    If stCondition <> MsgText(601) Then
        stWhere = stWhere & stCondition
    End If
    
    Select Case Left(stChoose, 1)
        Case "0" '420101 貸方 收款
            stQ = "Select " & stField & " From Acc021" & stTB & _
                    " Where SubStr(ax214,1,3)='ACS' " & stFixAcsWhere & " " & stWhere & " " & stGroup
            
        Case "1" '抓取「當月」收款(420101 貸方)資料,並回傳資料
            '最小傳票日(若抓最小傳票號,怕1與J公司都有),同傳票也可能多筆 ex:J公司D112020058
            'Modify by Amy 2024/11/05 +最小項次 ex: 財務產生ACS期末實績保留傳票時,摘要無法帶出,因 J公司D113100015 有兩個項次
            stQ = "Select " & stField & " From Acc021" & stTB & _
                    " Where SubStr(ax214,1,3)='ACS' " & stFixAcsWhere & " " & stWhere & _
                    " And a0205||ax202||ax203=(Select Min(a0205||ax202||ax203) From Acc021" & stTB & " Where 1=1 " & stFixAcsWhere & " " & stWhere & ") "
                    
        Case "2" '抓取最小傳票日 4191 「借方」資料,並回傳資料
            stQ = "Select " & stField & " From Acc021 " & stTB & _
                    " Where SubStr(ax214,1,3)='ACS' " & stFixAcsWhere & " " & stWhere & _
                    " And A0205||ax202=(Select Min(a0205||ax202) From Acc021" & stTB & " Where 1=1 " & stFixAcsWhere & " " & stWhere & ") " & _
                    stGroup
                    
        Case "3" '抓會科 4191
            stQ = "Select " & stField & " From Acc021 " & stTB & _
                    " Where SubStr(ax214,1,3)='ACS' " & stFixAcsWhere & " " & stWhere & " " & stGroup
        
        'Add by Amy 2023/07/31
        Case "5" '分潤 420101
            '避免抓到收款資料,只抓1公司貸方大於0,因收款當月期末時會轉至1公司保留,分潤智權不會掛M0101,會掛於個人 ex:客戶檔智權人員
            stQ = "Select " & stField & " From Acc021 " & stTB & _
                        " Where SubStr(ax214,1,3)='ACS' " & stFixAcsWhere & " " & stWhere & _
                        " Order by a0205,ax201,ax202,Decode(ax213,'顧服獎',9,Decode(ax209,'W2001',8,1)) "
                        
        Case "8" '抓會科 2492(因2492期初/末餘額 11203月調整,故限制只抓1公司-秀玲)
            stQ = "Select " & stField & " From Acc021 " & stTB & _
                    " Where SubStr(ax214,1,3)='ACS' And ax201='1' " & stFixAcsWhere & " " & stWhere & " " & stGroup
                                    
        Case "9" '2492 期初/末餘額
            'ACS000085/91 110年直接做 J公司2492,11203年調整做至 1公司收入(當月收入增加),故避免期初增加,故限制只抓1公司
            '調整J公司 D112030094/95 傳票 至 1公司 D112032077/78
            stQ = "Select " & stField & " From Acc021 " & stTB & _
                    " Where SubStr(ax214,1,3)='ACS' And ax201='1' " & stFixAcsWhere & " " & stWhere & " " & stGroup
            'Modify by Amy 2023/07/11 ACS待分潤明細表抓2492 第一筆傳票日,避免抓不到,不可加Having Sum(ax207-ax206)<>0
            If UCase(stFormN) = "FRMACC41L1" And stChoose = "9.1" Then
               'ex:ACS000113000 1120711 傳票只有1公司D112052523傳票->2492 第一筆傳票日顯示空
            Else
               stQ = stQ & " Having Sum(ax207-ax206)<>0 "
            End If
                                    
        Case "D" '排除之傳票資料
            'Memo 420101調整傳票 ax213不輸可排除
            stQ = "Select " & stField & " From Acc021 " & stTB & _
                    " Where ax201='J' And ax202 In('D112030094','D112030095') And ax207>0 " & stWhere & " " & stGroup
                                    
    End Select
    If bolBackData = False Then GetACSData = stQ: Exit Function
    
    intQ = 1
    Set RsQ = ClsLawReadRstMsg(intQ, stQ)
    If intQ = 1 Then
        Select Case UCase(stFormN)
            Case "FRMACC41G0"
                '抓取「當月」收款資料,並回傳資料(筆數)
                If stChoose = "1" Then
                    '對沖-客戶;摘要;對沖-其他(智權)
                    stBackData = stBackData & "" & RsQ.Fields("ax208") & ";" & RsQ.Fields("ax212") & _
                                         ";" & RsQ.Fields("ax213")
                End If
            Case "FRMACC41L0"
                '4191「借方」最小傳票日資料
                If stChoose = "2" Then
                    '對沖-其他;摘要
                    stBackData = stBackData & "" & RsQ.Fields("ax208") & ";" & RsQ.Fields("ax213") & ";" & RsQ.Fields("ax212")
                End If
            'Add by Amy 2023/08/01
            Case "FRMACC41L1"
               '4191科目資料
               If stChoose = "3" Then
                  '對沖-其他(收款智權人員)
                  stBackData = stBackData & "" & RsQ.Fields("ax213")
               End If
            Case UCase("ChkACSIncomeAndEndAmt")
                '420101 收款
                If stChoose = "0" Then
                    stBackData = stBackData & "" & RsQ.Fields("ax207")
                '2492 保留
                ElseIf stChoose = "8" Then
                    stBackData = stBackData & "" & RsQ.Fields("ax207")
                End If
        End Select
        GetACSData = RsQ.RecordCount
    End If
    
    Set RsQ = Nothing
End Function

'Add by Amy 2023/04/24 判斷智權人員與客戶可收文所別(一個符合即相同),從客戶檔及接洽單整理修改成共用
'intChoose:0:抓個別資料/1-比較
'stCU112:中文地址郵區號 / stCU30:聯絡地址郵區號 / stCU112_Old:中文地址郵區號(舊) / stCU30_Old:聯絡地址郵區號(舊)
'stCU10:客戶國籍 /stCU87:地址國籍 / stCU10_Old:客戶國籍(舊) /stCU87_Old:地址國籍 (舊)
Public Function ChkAcrossArea(ByVal intChoose As Integer, ByVal stFormN As String, ByVal stSalesNo As String, _
  Optional ByVal stCU112 As String = "", Optional ByVal stCU30 As String = "", Optional ByVal stCU112_Old As String = "", Optional ByVal stCU30_Old As String = "", _
  Optional ByVal stCU10 As String = "", Optional ByVal stCU87 As String = "", Optional ByVal stCU10_Old As String = "", Optional ByVal stCU87_Old As String = "") As Boolean
    
    Dim ii As Integer, intQ As Integer
    Dim RsQ As New ADODB.Recordset, strQ As String, strFixSql As String, strGroup As String, stWhere As String
    Dim bolApplyAcrossArea_Old As Boolean, bolApplyAcrossArea_New As Boolean, bolContactAcrossArea_Old As Boolean, bolContactAcrossArea_New As Boolean '申請地 舊/申請地 新/聯絡地 舊/聯絡地 新 與智權不同所
     
    ChkAcrossArea = False
    strFixSql = "Select PZD07 From PostZipData " & _
                    "Where (InStr(PZD07,'" & PUB_GetST06(stSalesNo) & "')>0 or PZD07 is null) "
    strGroup = "Group by PZD07"
    
    '0.抓個別資料
    If intChoose = 0 Then
        '中文地址郵區號
        If stCU112 <> MsgText(601) Then
            stWhere = stWhere & "Substr(PZD01,1,3)='" & Left(PUB_ChgNumeralStyle(stCU112), 3) & "' "
        End If
        '聯絡地址郵區號
        If stCU30 <> MsgText(601) Then
            If stWhere <> MsgText(601) Then stWhere = stWhere & " Or "
            stWhere = stWhere & "Substr(PZD01,1,3)='" & Left(PUB_ChgNumeralStyle(stCU30), 3) & "' "
        End If
        
        If stWhere = MsgText(601) Then Exit Function ''Add by Amy 2020/09/09 若非台灣會Error(客戶資料維護)
        
        strQ = strFixSql & "And (" & stWhere & ") " & strGroup
        
        intQ = 1
        Set RsQ = ClsLawReadRstMsg(intQ, strQ)
        If intQ = 0 Then
            ChkAcrossArea = True
        End If
    '1.比較
    Else
        'Modify by Amy 2024/06/28 加入客戶檔維護 修改時條件判斷,避免有未改到的
        '中文地址郵區號
        If stCU10 <> MsgText(601) And stCU10 < "010" And stCU112 <> MsgText(601) Then
            strQ = strFixSql & "And Substr(PZD01,1,3)='" & Left(PUB_ChgNumeralStyle(stCU112), 3) & "' " & strGroup
            intQ = 1
            Set RsQ = ClsLawReadRstMsg(intQ, strQ)
            If intQ = 0 Then
                bolApplyAcrossArea_New = True
            End If
        End If
        If stCU10_Old <> MsgText(601) And stCU10_Old < "010" And stCU112_Old <> MsgText(601) Then
            strQ = strFixSql & "And Substr(PZD01,1,3)='" & Left(PUB_ChgNumeralStyle(stCU112_Old), 3) & "' " & strGroup
            intQ = 1
            Set RsQ = ClsLawReadRstMsg(intQ, strQ)
            If intQ = 0 Then
                bolApplyAcrossArea_Old = True
            End If
        End If
        
        '聯絡地址郵區號
        If stCU87 <> MsgText(601) And stCU87 < "010" And stCU30 <> MsgText(601) Then
            strQ = strFixSql & "And Substr(PZD01,1,3)='" & Left(PUB_ChgNumeralStyle(stCU30), 3) & "' " & strGroup
            intQ = 1
            Set RsQ = ClsLawReadRstMsg(intQ, strQ)
            If intQ = 0 Then
                bolContactAcrossArea_New = True
            End If
        End If
        If stCU87_Old <> MsgText(601) And stCU87_Old < "010" And stCU30_Old <> MsgText(601) Then
            strQ = strFixSql & "And Substr(PZD01,1,3)='" & Left(PUB_ChgNumeralStyle(stCU30_Old), 3) & "' " & strGroup
            intQ = 1
            Set RsQ = ClsLawReadRstMsg(intQ, strQ)
            If intQ = 0 Then
                bolContactAcrossArea_Old = True
            End If
        End If
    End If
    
    Select Case UCase(stFormN)
        Case "FRM090801_NEW" '接洽單
            If intChoose = 0 Then
                If bolApplyAcrossArea_New = True And bolContactAcrossArea_New = True Then
                    ChkAcrossArea = True
                End If
            End If
        Case "FRM140401" '客戶基本檔維護
            If intChoose = 0 Then
                If bolApplyAcrossArea_New = True And bolContactAcrossArea_New = True Then
                    ChkAcrossArea = True
                End If
            Else
               'Add by Amy 2024/06/28 +Else 從客戶檔維護 修改時搬過來並加項目2.條件,避免有未改到的
               'Modify by Amy 2024/07/05 項目2國籍條件加另一個國籍>=010 ex:X15222020 國籍都是台灣 中文地址[非]跨所,聯絡地址由[非]跨所->跨所 不算跨所
               '1.原 中文地址Zip 跨所,聯絡地址Zip 由 非跨所->跨所 Or 原 聯絡地址Zip 跨所, 中文地址Zip 由 非跨所->跨所 Or 兩者都 非跨所 都改成 跨所
               '2.客戶國籍及地址國籍有一個不是台灣,若其中地址由 非跨所->跨所 ex:X08225050 客戶國籍大陸 聯絡地址 由 新北市->臺南市
               '且 跨所同意主管 為空,彈訊息
               '註:客戶國籍[非]台灣,中文地址[非]台灣 ->台灣地址,因國籍不會改,不會判斷地址是否正確,也不會判斷上述條件-秀玲說每天會用語法檢查
               '     客戶國籍 為 台灣,中文地址 為 台灣 ->台灣地址,但國籍不同,國籍會更正；中文地址 為 台灣 ->[非]台灣地址,會於備註顯示[臺灣地址格式不檢查]
               If (bolApplyAcrossArea_Old = True And bolContactAcrossArea_Old = False And bolContactAcrossArea_New = True) _
                 Or (bolContactAcrossArea_Old = True And bolApplyAcrossArea_Old = False And bolApplyAcrossArea_New = True) _
                 Or (bolApplyAcrossArea_Old = False And bolContactAcrossArea_Old = False And bolApplyAcrossArea_New = True And bolContactAcrossArea_New = True) _
                 Or (((stCU10 < "010" And stCU87 >= "010") Or (stCU87 < "010" And stCU10 >= "010")) And ((bolApplyAcrossArea_Old = False And bolApplyAcrossArea_New = True) Or (bolContactAcrossArea_Old = False And bolContactAcrossArea_New = True))) _
               Then
                  ChkAcrossArea = True
               End If
               'end 2024/06/28
            End If
        Case "FRM210101_1" '客戶基本檔維護/智權人員客戶資料修改
            If intChoose = 1 Then
               '需mail 通知電腦中心條件
               'Modify by Amy 2024/06/28 項目2.條件
               'Modify by Amy 2024/07/05 項目2國籍條件加另一個國籍>=010 ex:X15222020 國籍都是台灣 中文地址[非]跨所,聯絡地址由[非]跨所->跨所 不算跨所
               '1.申請[是]地跨所且聯絡地由[不是]跨所改跨所
               '2.客戶國籍及地址國籍有一個不是台灣,若其中地址由 非跨所->跨所 ex:X08225050 客戶國籍大陸 聯絡地址 由 新北市->臺南市
               If (bolApplyAcrossArea_Old = True And (bolContactAcrossArea_Old = False And bolContactAcrossArea_New = True)) _
                 Or (((stCU10 < "010" And stCU87 >= "010") Or (stCU87 < "010" And stCU10 >= "010")) And ((bolApplyAcrossArea_Old = False And bolApplyAcrossArea_New = True) Or (bolContactAcrossArea_Old = False And bolContactAcrossArea_New = True))) _
               Then
                  ChkAcrossArea = True
               End If
            End If
    End Select
    
    Set RsQ = Nothing
End Function

'Add by Amy 2023/05/08 從frm050705 搬過來
'Modify by Amy 2024/11/29 原傳入intChoose 改傳intEditMode;原回傳Boolean改回傳 String,加stSource/stSource_Old/stNo_Old
'回傳:0-無資料需更新/1-存檔成功/文字-ErrHand訊息
'intEditMode:1-新增/2-修改/3-刪除 模式-傳入的表單狀態 /4-查詢XYS02=stNo_Old,則更新XYS02=stNo /5-只更新XYS01及XYS02(不需先查詢)
Public Function SaveXYNoSource(ByVal intEditMode As Integer, stFormN As String, ByVal stNo As String, Optional ByVal stXYS02 As String, Optional ByVal stXYS03 As String _
  , Optional ByVal stSource As String, Optional ByVal stSource_Old As String, Optional ByVal stNo_Old As String) As String
    Dim RsQ As New ADODB.Recordset, intQ As Integer, strQ As String, strCmd As String
    'Add by Amy 2024/11/29
    Dim arrTmp
    Dim intChoose As Integer, stXYS02_Old As String, stXYS03_Old As String, ii As Integer  'intChoose:1-新增/2-修改/3-刪除 (SaveXYNoSource)
On Error GoTo ErrHand
    
    'Modify by Amy 2024/11/29 SaveXYNoSource改回傳文字;原傳入intChoose 改傳intEditMode;判斷 stXYS02 長度小於8,補0
    'SaveXYNoSource = False 'Add by Amy 2022/12/28
    SaveXYNoSource = "0"
    intChoose = 0
    If stXYS02 <> MsgText(601) And Len(stXYS02) < 8 Then
      stXYS02 = Left(GetNewFagent(stXYS02), 8)
    End If
    'end 2024/11/29
    
    Select Case UCase(stFormN)
        Case "FRM050705" '國外代理人維護
        'Add by Amy 2024/11/29
        Case "FRM140402" '國外潛在客戶
        Case "FRM12040125" '客戶/代理人改號作業
            'intEditMode=5
            strCmd = "Update XYNoSource Set XYS01='" & stNo & "' Where XYS01='" & stNo_Old & "';" & _
                              "Update XYNoSource Set XYS02='" & stNo & "' Where XYS02='" & stNo_Old & "'"
        'end 2024/11/29
        Case "FRM140402_2" '潛在客戶轉客戶或代理人作業
            If stNo_Old <> MsgText(601) Then
               If intEditMode = 4 Then
                  strQ = "Select Distinct 'XYS02'  From XYNoSource Where XYS02='" & stNo_Old & "' "
               Else
                  strQ = "Select * From XYNoSource Where XYS01='" & stNo_Old & "' "
               End If
            End If
    End Select

'*** intEditMode 不是5 ***
    
    If intEditMode <> 5 Then
      If strQ = MsgText(601) Then
        strQ = "Select * From XYNoSource Where XYS01='" & stNo & "' "
      End If
      intQ = 1
      Set RsQ = ClsLawReadRstMsg(intQ, strQ)
      '已有資料
      If intQ = 1 Then
          'Modify by Amy 2024/11/29 從代理人維護搬過來修改,讓 國外潛在客戶(加 來所原因)及 潛在客戶轉客戶或代理人作業 也可用
          '傳入表單狀態為[修改] Or 潛在客戶轉客戶或代理人作業,[不是]查XYS02
          If intEditMode = 2 Or (UCase(stFormN) = "FRM140402_2" And intEditMode <> "4") Then
              stXYS02_Old = "" & RsQ.Fields("XYS02")
              stXYS03_Old = "" & RsQ.Fields("XYS03")
              '來所原因 由04.其他申請人介紹 或05.其他事務所介紹 或11.其他-->改成不會寫入「客戶代理人來源資料檔」的態樣,需刪除客戶代理人來源資料檔資料
              If (stSource_Old = "04" Or stSource_Old = "05" Or stSource_Old = "11") And stSource <> "04" And stSource <> "05" And stSource <> "11" Then
                 intChoose = 3
              '來所原因 相關欄有修改
              ElseIf stSource_Old <> MsgText(601) And (stXYS02_Old <> stXYS02 Or stXYS03_Old <> stXYS03) Then
                 intChoose = 2
              ElseIf UCase(stFormN) = "FRM140402_2" Then
                 intChoose = 2 '上述檢查都沒
              End If
              If intChoose = 0 Then Exit Function
          Else
              intChoose = intEditMode
          End If
          If intChoose = 4 And stNo_Old <> MsgText(601) Then
              '查詢XYS02=stNo_Old,則更新XYS02=stNo
              strCmd = "Update XYNoSource Set " & RsQ.Fields(0) & "='" & stNo & "' Where " & RsQ.Fields(0) & "='" & stNo_Old & "' "
          ElseIf intChoose = 3 Then
              If stNo_Old <> MsgText(601) Then
                  strCmd = "Delete From XYNoSource Where XYS01='" & stNo_Old & "' "
              Else
                  strCmd = "Delete From XYNoSource Where XYS01='" & stNo & "' "
              End If
          Else
              If "" & RsQ.Fields("XYS02") <> stXYS02 Then strCmd = strCmd & ",XYS02=" & CNULL(stXYS02)
              If "" & RsQ.Fields("XYS03") <> stXYS03 Then strCmd = strCmd & ",XYS03=" & CNULL(stXYS03)
              strCmd = "XYS07='" & strUserNum & "',XYS08=" & strSrvDate(1) & ",XYS09=" & ServerTime & strCmd
              'Memo by Amy 2024/11/29 國外潛在客戶轉客戶或代理人作業,有傳入新編號需更新
              If UCase(stFormN) = "FRM140402_2" And stNo_Old <> MsgText(601) Then
                 strCmd = "Update XYNoSource Set XYS01=" & CNULL(stNo) & "," & strCmd & " Where XYS01='" & stNo_Old & "' "
              Else
                 strCmd = "Update XYNoSource Set " & strCmd & " Where XYS01='" & stNo & "' "
              End If
          End If
          'end 2024/11/29
      '無資料-新增時,來所原因 [是] 04/05/11 Or 修改時,來所原因 [不是] 04/05/11-> 04/05/11
      'Memo XYNoSource資料檔只會存 [來所原因] 為04/05/11
      ElseIf (intEditMode = 1 And (stSource = "04" Or stSource = "05" Or stSource = "11")) _
        Or (intEditMode = 2 And stSource_Old <> "04" And stSource_Old <> "05" And stSource_Old <> "11" And (stSource = "04" Or stSource = "05" Or stSource = "11")) Then
          strCmd = "Insert Into XYNoSource (XYS01,XYS02,XYS03,XYS04,XYS05,XYS06) Values " & _
                          "('" & stNo & "'," & CNULL(stXYS02) & "," & CNULL(stXYS03) & "," & _
                          "'" & strUserNum & "'," & strSrvDate(1) & "," & ServerTime & ")"
      End If
    End If
'*** End intEditMode 不是5 ***

    If strCmd <> MsgText(601) Then
        'Modify by Amy 2024/11/29 [非]客戶/代理人改號作業及潛在客戶維護,才需寫Log-秀玲,SaveXYNoSource改回傳文字
        arrTmp = Split(strCmd, ";")
        For ii = LBound(arrTmp) To UBound(arrTmp)
            If UCase(stFormN) <> "FRM12040125" And UCase(stFormN) <> "FRM140402" Then
                Pub_SeekTbLog arrTmp(ii) '避免資料誤刪,無法補回(只寫 代理人/客戶 資料-較重要)
            End If
            cnnConnection.Execute arrTmp(ii)
        Next ii
        'SaveXYNoSource = True 'Add by Amy 2022/12/28
        SaveXYNoSource = "1"
        'end 2024/11/29
    End If
    
ErrHand:
   If Err.Description <> MsgText(601) Then
      SaveXYNoSource = "SaveXYNoSource存檔失敗，請洽系統管理員 !" & vbCrLf & _
                                          Err.Description
   End If
   Set RsQ = Nothing
End Function

'Add by Amy 2023/05/29 銀存科目設定(從Frmacc42b0/3130搬來修改)
Public Sub Pub_AccBankTit(ByRef p_Combo1 As Object, stForm As String)
    Dim ii As Integer, stFieldSeq(1 To 3) As String, stFieldLast As String, stAccSeq As String, stAllAccNo As String, arrTmp
    Dim RsQ As New ADODB.Recordset, intQ As Integer, strQ As String, strQ2 As String
    Dim bolAddNullRec As Boolean '有空白選項
    Dim bolNew As Boolean 'Added by Morgan 2025/5/29
    
    'Added by Morgan 2025/5/29
    strQ = "select * from acc010 where a0101='191101'"
    intQ = 1
    Set RsQ = ClsLawReadRstMsg(intQ, strQ)
    If intQ = 1 Then
      bolNew = True
    End If
    'end 2025/5/29
    
    bolAddNullRec = False
    stFieldLast = "'1911','1912','1913'" 'Added by Morgan 2025/5/29
    Select Case UCase(stForm)
        Case "FRMACC41E0" '簽收作業
        
            'Added by Morgan 2025/5/29
            If bolNew Then
               stFieldLast = "'191102','191202','191302'"
            End If
            'end 2025/5/29
            
        Case "FRMACC42B0" ''未繳款簽收資料查詢
        
            'Added by Morgan 2025/5/29
            If bolNew Then
               stFieldLast = "'191101','191102','191201','191202','191301','191302'"
            End If
            'end 2025/5/29
        
            strQ2 = "Select '1101 北所現金',91 From Dual"
            bolAddNullRec = True
    End Select
    
    '*** 銀存科目 順序設定 ***
    'Modified by Morgan 2025/5/29 調整科目及順序
    ''1-5
    'stFieldSeq(1) = stFieldSeq(1) & "110207,110303,110208,110204,110205"
    ''6-10
    'stFieldSeq(2) = stFieldSeq(2) & "110301,110302,110602,110502"
    ''11-15
    'stFieldSeq(3) = stFieldSeq(3) & ""
    ''放最後
    'stFieldLast = stFieldLast & "'1911','1912','1913'"
    stFieldSeq(1) = "110602,110207,110303,110502"
    'end 2025/5/29
    
    arrTmp = Split(stFieldSeq(1) & IIf(stFieldSeq(2) = "", "", "," & stFieldSeq(2)) & IIf(stFieldSeq(3) = "", "", "," & stFieldSeq(3)), ",")
   
    For ii = LBound(arrTmp) To UBound(arrTmp)
        stAccSeq = stAccSeq & ",'" & arrTmp(ii) & "'," & ii + 1
        stAllAccNo = stAllAccNo & "','" & arrTmp(ii)
    Next ii
    If stAccSeq <> MsgText(601) Then
        stAccSeq = ",Decode(a0101,'" & Mid(stAccSeq, 3) & ",90) Srt"
    End If
    If stAllAccNo <> MsgText(601) Then
        stAllAccNo = Mid(stAllAccNo, 3) & "'" & IIf(stFieldLast = "", "", "," & stFieldLast)
    End If
    '*** End 銀存科目 順序設定 ***
    p_Combo1.Clear
    If bolAddNullRec = True Then
        p_Combo1.AddItem MsgText(601)
    End If
    
    If pub_strUserOffice = "2" Then
        strQ = "Select a0101||' '||a0102 From acc010 Where  a0101='1911'"
         'Added by Morgan 2025/5/29
         If bolNew Then
            strQ = "Select a0101||' '||a0102 From acc010 Where  a0101 like '1911%' and a0101 in (" & stFieldLast & ") order by 1"
         End If
         'end 2025/5/29
    ElseIf pub_strUserOffice = "3" Then
        strQ = "Select a0101||' '||a0102 From acc010 Where  a0101='1912'"
        'Added by Morgan 2025/5/29
         If bolNew Then
            strQ = "Select a0101||' '||a0102 From acc010 Where  a0101 like '1912%' and a0101 in (" & stFieldLast & ") order by 1"
         End If
         'end 2025/5/29
    ElseIf pub_strUserOffice = "4" Then
        strQ = "Select a0101||' '||a0102 From acc010 Where  a0101='1913'"
        'Added by Morgan 2025/5/29
         If bolNew Then
            strQ = "Select a0101||' '||a0102 From acc010 Where  a0101 like '1913%' and a0101 in (" & stFieldLast & ") order by 1"
         End If
         'end 2025/5/29
    Else
        strQ = "Select a0101||' '||a0102" & stAccSeq & " From acc010 Where  a0101 in (" & stAllAccNo & ") "
        If strQ2 <> MsgText(601) Then
            strQ = strQ & " Union " & strQ2
        End If
        'Modified by Morgan 2025/6/10 +,1
        strQ = strQ & " Order by Srt,1"
    End If
    intQ = 1
    Set RsQ = ClsLawReadRstMsg(intQ, strQ)
    If intQ = 1 Then
        Do While Not RsQ.EOF
            p_Combo1.AddItem RsQ.Fields(0)
            RsQ.MoveNext
        Loop
    End If
    
End Sub

'Added by Lydia 2023/07/07 智權系統之商標委查單：不論是否請假，採用全部人員都分發查名單，並回傳增加的期限天數
Public Function Pub_GetTmqAllDate(ByVal pChkDate As String, Optional ByRef pAddDays As Integer = 2) As Boolean
'設定:20220707-20220711因為查名中心人員請假過半，為了公平採用全部人員都分發查名單，但是期限+2天
'     20230707-20230710因7月7日(Fri.)及10日(Mon.)有多數查名同仁請假半，為了公平採用全部人員都分發查名單，但是期限+2天

Dim intD As Integer, strD1 As String
Dim rsD1 As New ADODB.Recordset
   
   'AddressA4List特殊設定(TSres):AAL03=1(起始日期)、AAL03=2(終止日期)、AAL03=3(增加期限天數)
   Pub_GetTmqAllDate = False
   strD1 = "select a1.aal02 as bdate, a2.aal02 as edate,a3.aal02 as cdays from addressa4list a1, addressa4list a2, addressa4list a3 " & _
           "where a1.aal01='TSres' and a1.aal03='1' and a1.aal01=a2.aal01 and a2.aal03='2' and a1.aal01=a3.aal01 and a3.aal03='3'"
   intD = 1
   Set rsD1 = ClsLawReadRstMsg(intD, strD1)
   If intD = 1 Then
      If pChkDate >= "" & rsD1.Fields("bdate") And pChkDate <= "" & rsD1.Fields("edate") Then
         Pub_GetTmqAllDate = True
         pAddDays = Val("" & rsD1.Fields("cdays"))
      End If
   End If
   
   Set rsD1 = Nothing
End Function

'Add by Amy 2023/07/12 潛在客戶名稱
'nLanguage:0-中->英->日 /1-英->中->日
Public Function GetPotCustomerName(ByVal nLanguage As Integer, ByVal m_NO As String) As String
   Dim RsQ As New ADODB.Recordset
   Dim strNo1 As String, strNo2 As String, strQ As String, intQ As Integer
   
   GetPotCustomerName = ""
   strQ = GetNewFagent2(m_NO)
   strNo1 = Left(strQ, 8)
   strNo2 = Mid(strQ, 9, 1)
   strQ = "Select pcu08 CN,pcu03 EN1,pcu04 EN2,pcu05 EN3,pcu06 EN4,pcu07 JN From PotCustomer " & _
                "Where pcu01='" & strNo1 & "' And pcu02='" & strNo2 & "' " & _
   "Union Select poc03 CN,poc23 EN1,poc24 EN2,poc25 EN3,poc26 EN4,poc27 JN From PotCustomer1 " & _
                "Where poc01='" & strNo1 & "' And poc02='" & strNo2 & "' "
   intQ = 1
   Set RsQ = ClsLawReadRstMsg(intQ, strQ)
   If intQ = 1 Then
      Select Case nLanguage
         Case 0 '中->英->日
            If IsNull(RsQ.Fields("CN")) = False Then
               GetPotCustomerName = RsQ.Fields("CN")
            ElseIf IsNull(RsQ.Fields("EN1")) = False Then
               GetPotCustomerName = RsQ.Fields("EN1")
               If IsNull(RsQ.Fields("EN2")) = False Then
                  GetPotCustomerName = GetPotCustomerName & " " & RsQ.Fields("EN2")
               End If
               If IsNull(RsQ.Fields("EN3")) = False Then
                  GetPotCustomerName = GetPotCustomerName & " " & RsQ.Fields("EN3")
               End If
               If IsNull(RsQ.Fields("EN4")) = False Then
                  GetPotCustomerName = GetPotCustomerName & " " & RsQ.Fields("EN4")
               End If
            ElseIf IsNull(RsQ.Fields("JN")) = False Then
               GetPotCustomerName = RsQ.Fields("JN")
            End If
         Case 1 '英->中->日
            If IsNull(RsQ.Fields("EN1")) = False Then
               GetPotCustomerName = RsQ.Fields("EN1")
               If IsNull(RsQ.Fields("EN2")) = False Then
                  GetPotCustomerName = GetPotCustomerName & " " & RsQ.Fields("EN2")
               End If
               If IsNull(RsQ.Fields("EN3")) = False Then
                  GetPotCustomerName = GetPotCustomerName & " " & RsQ.Fields("EN3")
               End If
               If IsNull(RsQ.Fields("EN4")) = False Then
                  GetPotCustomerName = GetPotCustomerName & " " & RsQ.Fields("EN4")
               End If
            ElseIf IsNull(RsQ.Fields("CN")) = False Then
               GetPotCustomerName = RsQ.Fields("CN")
            ElseIf IsNull(RsQ.Fields("JN")) = False Then
               GetPotCustomerName = RsQ.Fields("JN")
            End If
      End Select
   End If
   Set RsQ = Nothing
End Function

'Add by Amy 2023/07/27 Excel 放置代表圖(從frm040336搬過來,避免Excel版本不同需改多支)
Public Sub PutXlsImg(ByVal stFormN As String, ByRef Wks As Worksheet, ByRef stF As String, ByRef intRow As Integer, stNo1 As String, stNo2 As String, stNo3 As String, stNo4 As String)
    Const msoTrue = -1
    Dim oShape
    Dim intCellH As Integer, intCellW As Integer, intPhotoH As Integer, intPhotoW As Integer
    Dim strPhotoN As String
    
    Select Case UCase(stFormN)
         Case "FRM040336" '資策會專利案件季報表
         Case "FRM0503171" '客戶案件總簿
         Case "FRM210138" '客戶案件預算預估表
    End Select
    
    If GetImgByteFile_Case(stNo1, stNo2, stNo3, stNo4, strPhotoN, 0) = True Then
        Wks.Rows(intRow).RowHeight = 110
        intCellH = Val(Wks.Rows(intRow).RowHeight) - 10
        intCellW = Val(Wks.Range(stF & intRow).Width) - 10
                    
        Set oShape = Wks.Shapes.AddPicture(strPhotoN, False, True, 100, 100, -1, -1)
        oShape.LockAspectRatio = msoTrue
        intPhotoH = Val(oShape.Height) - 10
        intPhotoW = Val(oShape.Width) - 10
                        
        If intPhotoH / intCellH >= intPhotoW / intCellW Then
            oShape.Height = intCellH
        Else
            oShape.Width = intCellW
        End If
        oShape.Top = Wks.Range(stF & intRow).Top + 5
        oShape.Left = Wks.Range(stF & intRow).Left + 5
    End If
End Sub
'Added by Morgan 2023/8/1
Public Function PUB_CNP701708Check(ByVal pFromCuNo As String, ByVal pToCuNo As String, Optional ByVal pAsk As Boolean = False) As Boolean
   Dim stSQL As String, intQ As Integer, stMsg As String, bolAlert As Boolean
   Dim rsQuery As ADODB.Recordset
   Dim stCuNo() As String
   Dim ii As Integer, stCon As String
   
   stMsg = "依大陸官方規定，讓與人國籍為:中國大陸，受讓人國籍為:非中國大陸，需提供：技術出口合同登記證書、技術出口合同資料表，此文件需由讓與人向註冊地的商務局辦理或委託具有進出口資質的代辦公司註冊地之辦理。"
   
   PUB_CNP701708Check = True
   If pFromCuNo <> "" And pToCuNo <> "" Then
      '讓與人
      stSQL = ""
      stCuNo() = Split(pFromCuNo, ",")
      For ii = LBound(stCuNo) To UBound(stCuNo)
         If stCuNo(ii) <> "" Then
            stCuNo(ii) = ChangeCustomerL(stCuNo(ii))
            If stSQL <> "" Then stSQL = stSQL & " union "
            stSQL = "select cu01,cu02,cu10 from customer where  cu01='" & Left(stCuNo(ii), 8) & "' and cu02='" & Mid(stCuNo(ii), 9) & "' and cu10='020'"
         Else
            Exit For
         End If
      Next ii
      If stSQL <> "" Then
         intQ = 1
         Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
         If intQ = 1 Then
            '受讓人
            '讓與人
            stSQL = ""
            stCuNo() = Split(pToCuNo, ",")
            For ii = LBound(stCuNo) To UBound(stCuNo)
               If stCuNo(ii) <> "" Then
                  stCuNo(ii) = ChangeCustomerL(stCuNo(ii))
                  If stSQL <> "" Then stSQL = stSQL & " union "
                  stSQL = "select cu01,cu02,cu10 from customer where  cu01='" & Left(stCuNo(ii), 8) & "' and cu02='" & Mid(stCuNo(ii), 9) & "' and cu10<>'020'"
               Else
                  Exit For
               End If
            Next ii
            If stSQL <> "" Then
               intQ = 1
               Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
               If intQ = 1 Then
                  If pAsk Then
                     If MsgBox(stMsg & vbCrLf & vbCrLf & "是否要繼續？", vbYesNo + vbQuestion + vbDefaultButton2) = vbNo Then
                        PUB_CNP701708Check = False
                     End If
                  Else
                     MsgBox stMsg, vbInformation
                  End If
               End If
            End If
         End If
      End If
   End If
   Set rsQuery = Nothing
End Function

'Added by Morgan 2023/8/2
'Modified by Morgan 2023/8/7 改已會稿完成才發
'承辦人是外翻人員,分案時,若P案已會稿完成,則請系統自動發MAIL通知承辦人(系統會透過ST14轉發給品薇)
Public Sub CFPMail2F5xx(pCP01 As String, pCP02 As String, pCP03 As String, pCP04 As String, pCP14 As String)
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   Dim stSubj As String
   
   stSQL = "SELECT cm05||'-'||cm06||decode(cm07||cm08,'000','','-'||cm07||'-'||cm08) InNo,cp27,ep08,ep09" & _
      " FROM casemap,caseprogress,engineerprogress" & _
      " WHERE cm01='" & pCP01 & "' and cm02='" & pCP02 & "' and cm03='" & pCP03 & "' and cm04='" & pCP04 & "' and cm10='0'" & _
      " and cp01(+)=cm05 and cp02(+)=cm06 and cp03(+)=cm07 and cp04(+)=cm08 and cp10 in (" & CaseMapIn & ") and ep02(+)=cp09 and (ep08>0 or cp27>0)"
            
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      stSubj = rsQuery(0) & "案已" & IIf(rsQuery("cp27") > 0, "發文", "會稿完成") & "！"
      stSubj = stSubj & "(相關國外案：" & pCP01 & "-" & pCP02 & IIf(pCP03 & pCP04 = "000", "", "-" & pCP03 & "-" & pCP04) & ")"
      
      'Added by Morgan 2023/9/21 建多國關聯可能會觸發多次,檢查有紀錄就不再發 Ex:P-131678
      stSQL = "update mailcache set mc03=mc03 where mc01='" & strUserNum & "' and mc02='" & pCP14 & "' and mc07='" & stSubj & "'"
      cnnConnection.Execute stSQL, intQ
      If intQ = 0 Then
      'end 2023/9/21
      
         stSQL = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08)" & _
            " VALUES ( '" & strUserNum & "','" & pCP14 & "',to_char(sysdate,'yyyymmdd')" & _
            ",to_char(sysdate,'hh24miss'),'" & stSubj & "','如旨')"
         cnnConnection.Execute stSQL, intQ
         
      End If 'Added by Morgan 2023/9/21
   End If
   
   Set rsQuery = Nothing
End Sub

'Added by Morgan 2023/8/14
Public Sub PUB_SetEngInform(pCP09 As String, pOldEng As String, pMail As Boolean, Optional ByRef pPS As String)
   Dim stSQL As String, stSQL2 As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   Dim stSubj As String, stConT As String
   Dim stCP13 As String, stCP14 As String
   
   pPS = ""
   
   '檢查該收文號是否為工程師承辦
   stSQL = "select cp01,cp02,cp03,cp04,cp05,cp13,cp14,pa01||'-'||pa02||decode(pa03||pa04,'000','','-'||pa03||'-'||pa04) ORef,pa05,pa09,na03" & _
      " from caseprogress,staff,patent,nation" & _
      " where cp09='" & pCP09 & "' and st01(+)=cp14 and st03 in ('P10','P11')" & _
      " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04 and na01(+)=pa09"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      With rsQuery
      stCP13 = .Fields("CP13")
      stCP14 = .Fields("CP14")
      stSubj = .Fields("ORef") & "（" & .Fields("pa05") & "）承辦工程師資訊通知"
      stConT = "本所案號：" & .Fields("ORef") & vbCrLf & _
               "國別：" & .Fields("na03") & vbCrLf & _
               "案件名稱：" & .Fields("pa05")
                  
      stSQL = "select decode('" & .Fields("pa09") & "','020',cpm04,cpm03) Pty,cp14||st02 Eng,cp09,cp13,cp14" & _
            " from caseprogress,casepropertymap,staff where cp01='" & .Fields("CP01") & "' and cp02='" & .Fields("CP02") & "'" & _
            " and cp03='" & .Fields("CP03") & "' and cp04='" & .Fields("CP04") & "' and cpm01(+)=cp01 and cpm02(+)=cp10" & _
            " and st01(+)=cp14 and st03 in ('P10','P11') order by cp66,cp67,cp09"
      End With
      
      If pOldEng <> "" And pOldEng = stCP14 Then GoTo eXitFlg '承辦人沒改
      
      intQ = 1
      Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
      If intQ = 1 Then
         '分案
         If pOldEng = "" Then
            rsQuery.Find "CP09='" & pCP09 & "'"
            If rsQuery.EOF Then
               GoTo eXitFlg
            Else
               rsQuery.MovePrevious
               If rsQuery.BOF Then
                  GoTo eXitFlg
                  
               '與前次工程師相同
               ElseIf stCP14 = rsQuery("CP14") Then
                  GoTo eXitFlg
                  
               End If
            End If
         End If
         
         '承辦工程師資訊
         pPS = "承辦工程師資訊如下："
         With rsQuery
         .MoveFirst
         Do While Not .EOF
            pPS = pPS & vbCrLf & .Fields("pty") & "－" & .Fields("eng")
            If pOldEng <> "" And .Fields("cp09") = pCP09 And .Fields("cp14") <> pOldEng Then
               pPS = pPS & "(原分案予" & pOldEng & GetPrjSales(pOldEng) & ")"
            End If
            .MoveNext
         Loop
         End With
         
         If pMail Then
            stConT = stConT & vbCrLf & vbCrLf & pPS
            stSQL = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08)" & _
                 " values ('" & strUserNum & "','" & stCP13 & "',to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss')" & _
                 ",'" & ChgSQL(stSubj) & "','" & ChgSQL(stConT) & "')"
            cnnConnection.Execute stSQL, intQ
         End If
      End If
   End If
   
eXitFlg:
   Set rsQuery = Nothing
End Sub

'Added by Morgan 2023/11/15
'檢查檔案是否big5編碼
Public Function PUB_IsBig5File(pFile As String, Optional pErrMsg As Boolean = True) As Boolean
   Dim FF2 As Integer, LFil As Long, LFi2 As Long
   Dim strText As String
   Dim b1() As Byte
   
On Error GoTo ErrHnd

   FF2 = FreeFile()
   Open pFile For Binary As #FF2
   LFil = LOF(FF2)
   Close #FF2
   strText = PUB_ReadTextFile(pFile)
   b1() = StrConv(strText, vbFromUnicode)
   LFi2 = UBound(b1) + 1
   If LFil = LFi2 Then
      PUB_IsBig5File = True
   End If
   Exit Function
   
ErrHnd:
   If pErrMsg Then
      MsgBox Err.Description, vbCritical
   End If
End Function

'Added by Morgan 2023/11/15
'文字存檔(不含BOM的UTF-8格式)
Public Sub PUB_SaveUTF8NoBOM(filePath, Text)
   Const adSaveCreateNotExist = 1
   Const adSaveCreateOverWrite = 2
   Const adModeReadWrite = 3
   Const adTypeBinary = 1
   Const adTypeText = 2
   
   Dim StreamUTF8 As New ADODB.Stream
   Dim StreamUTF8NoBOM  As New ADODB.Stream
   
   With StreamUTF8
     .Charset = "UTF-8"
     .Type = adTypeText
     .Mode = adModeReadWrite
     .Open
     .WriteText Text
     .Position = 3
   End With
   
   With StreamUTF8NoBOM
     .Type = adTypeBinary
     .Mode = adModeReadWrite
     .Open
     StreamUTF8.CopyTo StreamUTF8NoBOM
     .SaveToFile filePath, adSaveCreateOverWrite
   End With
   
   StreamUTF8.Close
   StreamUTF8NoBOM.Close
   
   Set StreamUTF8 = Nothing
   Set StreamUTF8NoBOM = Nothing
End Sub

'Added by Morgan 2023/12/28
'收文號檢查是否有補文件未收文或未發文
Public Sub PUB_ChkUnAddDoc(pCP09 As String)
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   
   stSQL = "select np01 from nextprogress where np01='" & pCP09 & "' and np07='202' and np06 is null" & _
      " union select cp09 from caseprogress where cp43='" & pCP09 & "' and cp10='202' and cp158=0 and cp159=0"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      MsgBox "本案尚有文件未補齊，麻煩請確認！", vbInformation, "補文件未收文或未發文檢查"
   End If
   Set rsQuery = Nothing
End Sub

'Added by Morgan 2024/1/19
'送件方式選項1的中文
Public Function PUB_GetCP114Opt1Desc(pCP01 As String, pCP10 As String) As String
   'Modify By Sindy 2024/1/22
   '  比對案件性質原為=, 改為instr比對; 因接洽單是多個案件性質1,2,3
   If pCP01 = "T" And InStr(pCP10, "102") > 0 Then 'T案且案件性質有延展102時
      PUB_GetCP114Opt1Desc = "可辦期送件"
   ElseIf pCP01 = "P" And (InStr(pCP10, "601") > 0 Or InStr(pCP10, "605") > 0) Then
      PUB_GetCP114Opt1Desc = "立即"
   Else
      PUB_GetCP114Opt1Desc = "不限制"
   End If
End Function

'Added by Lydia 2024/05/07 查名單-網中：刪除圖檔或附件
Public Function PUB_TMQAppFileDel(ByVal pK01 As String, ByVal pK02 As String, ByVal pK03 As String) As Boolean
Dim intR As Integer
Dim rsRD As New ADODB.Recordset
Dim strR1 As String
    
On Error GoTo Err01
    
    strR1 = "select TMF01,TMF02,TMF03,TMF04,TMF05,TMF09 from TMQAPPFILE where TMF01='" & pK01 & "' and TMF02='" & pK02 & "' and TMF03='" & pK03 & "' "
    intR = 1
    Set rsRD = ClsLawReadRstMsg(intR, strR1)
    If intR = 1 Then
       rsRD.MoveFirst
       Do While Not rsRD.EOF
          '刪除FTP檔案
          If "" & rsRD.Fields("TMF09") <> "" Then  'AND TMF04='" & rsRd.Fields("TMF04") & "'
             If PUB_DelFtpFile2(rsRD.Fields("TMF02"), "TMF01='" & rsRD.Fields("TMF01") & "' AND TMF02='" & rsRD.Fields("TMF02") & "' AND TMF03='" & rsRD.Fields("TMF03") & "' ", "TMQAPPFILE") = False Then
                Exit Function
             End If
          End If
          strR1 = "delete from TMQAPPFILE where TMF01='" & rsRD.Fields("TMF01") & "' and TMF02='" & rsRD.Fields("TMF02") & "' and TMF03='" & rsRD.Fields("TMF03") & "' "
          cnnConnection.Execute strR1, intR
          rsRD.MoveNext
       Loop
       PUB_TMQAppFileDel = True
    Else
       PUB_TMQAppFileDel = True
    End If
    
    Exit Function
    
Err01:
    If Err.Number <> 0 Then
       MsgBox Err.Description
       cnnConnection.RollbackTrans
    End If
End Function

'Added by Lydia 2024/05/07 查名單-網中：儲存查名作業的附件內容
Public Function PUB_TMQAppFileSave(ByVal pbolAuto As Boolean, ByVal pMK01 As String, ByVal pMK02 As String, ByRef pMK03 As String, ByVal pFileName As String, Optional ByVal bolConn As Boolean = True) As Boolean
'pBolAuto:是否自動新增流水號
'pMK01:查名單號
'pMK02:類別1=人工輸入查詢, 2=網站查詢匯入, 3=查名結果附件
'pMK03:流水號>>00=圖形查詢附件，01~99=所有查名結果附件共用
'pFileName:完整檔案來源路徑
Dim bytes() As Byte
Dim rsAD As New ADODB.Recordset
Dim intA As Integer, strA1 As String, strFType As String
Dim iFileNo As Integer, lngSize As Long '檔案大小
Dim strFtpPath As String

On Error GoTo ErrHand
     
     If iFileNo > 0 Then Close #iFileNo
     iFileNo = FreeFile
     Open pFileName For Binary Access Read As #iFileNo
     lngSize = LOF(iFileNo)
     If lngSize = 0 Then Exit Function
     
If bolConn = True Then cnnConnection.BeginTrans
    
    If pbolAuto = False Then
       '刪除在FTP的附件
       If PUB_TMQAppFileDel(pMK01, pMK02, pMK03) = False Then
          Exit Function
       End If
    Else
       '自動新增流水號
       strA1 = "SELECT NVL(MAX(TMF03),0)+1 AS MNO FROM TMQAPPFILE WHERE TMF01='" & pMK01 & "' "
       intA = 1
       Set rsAD = ClsLawReadRstMsg(intA, strA1)
       If intA = 1 Then
          pMK03 = "" & rsAD.Fields("MNO")
       End If
    End If
    pMK03 = Format(Val(pMK03), "00")
    
    Set rsAD = Nothing
    
    strFType = UCase(Mid(pFileName, InStrRev(pFileName, "."))) '副檔名
    Close #iFileNo

    If PUB_PutFtpFile(pFileName, pMK01, pMK01 & pMK02 & pMK03 & strFType, strFtpPath, "TMQAPPFILE") = True Then
       'Modified by Lydia 2024/05/31 +TMF10檔名
       strA1 = "insert into TMQAPPFILE (TMF01,TMF02,TMF03,TMF04,TMF05,TMF06,TMF07,TMF08,TMF09,TMF10) values " & _
               "('" & pMK01 & "','" & pMK02 & "','" & Format(pMK03, "00") & "'," & lngSize & ", '" & strUserNum & "' " & _
               ",to_char(sysdate,'yyyymmdd'), lpad(to_char(sysdate,'HH24MISS'),4,'0'),null,'" & ChgSQL(strFtpPath) & "','" & ChgSQL(Mid(strFtpPath, InStrRev(strFtpPath, "/") + 1)) & "')"
       cnnConnection.Execute strA1
    End If
If bolConn = True Then cnnConnection.CommitTrans
     
     PUB_TMQAppFileSave = True
     Exit Function
 
ErrHand:
   If iFileNo > 0 Then Close #iFileNo
   
   If Err.Number <> 32755 Then
      MsgBox Err.Description
      If bolConn = True Then cnnConnection.RollbackTrans
   End If

End Function

'Added by Lydia 2024/05/07 查名單-網中：讀取DB附件檔
Public Function PUB_TMQAppFileGet(ByRef pSavePath As String, ByRef pFileName As String, ByVal pD01 As String, ByVal pD02 As String, ByVal pD03 As String, Optional ByRef pCData As String) As Boolean
Dim stAttPath As String
Dim Rs2 As New ADODB.Recordset
Dim intQ As Integer, strQuery As String
Dim strTT As String
   
On Error GoTo ErrHnd
    
   pCData = ""
   '預設路徑
   If pSavePath <> "" Then
      If Dir(pSavePath, vbDirectory) = "" Then
         MkDir pSavePath
      End If
      strTT = Mid(pFileName, InStrRev(UCase(pFileName), ".")) '副檔名
      stAttPath = pSavePath & "\" & pD01 & pD02 & pD03 & strTT
   Else
      '傳入完整檔案路徑
      stAttPath = pFileName
   End If
   '檔案已存在時
   If Dir(stAttPath) <> "" Then
      '檢查檔案是否正在使用中
      If PUB_ChkFileOpening(stAttPath) = True Then
         MsgBox stAttPath & vbCrLf & "檔案正在使用中（請關閉），方可繼續操作。", vbExclamation
         Exit Function
      End If
      SetAttr stAttPath, vbNormal '預設檔案為正常
      Kill stAttPath
   End If

   strQuery = "select * from TMQAPPFILE where TMF01='" & pD01 & "' and TMF02='" & pD02 & "' and TMF03='" & pD03 & "' "
   intQ = 1
   Set Rs2 = ClsLawReadRstMsg(intQ, strQuery)
   If intQ = 1 Then
      strTT = "" & Rs2.Fields("TMF09")
      If strTT <> "" Then
         pFileName = stAttPath
         pCData = Trim("" & Rs2.Fields("TMF05")) & "|" & Trim("" & Rs2.Fields("TMF06")) & "|" & Trim("" & Rs2.Fields("TMF07")) 'Create ID|Date|Time
         PUB_TMQAppFileGet = PUB_GetFtpFile(strTT, stAttPath, "TMQAPPFILE")
      End If
   End If
   Exit Function

ErrHnd:
   MsgBox Err.Description, vbCritical
End Function

'Added by Lydia 2024/06/12 查名單-網中：附件檔是否存在
Public Function PUB_TMQAppFileChk(ByVal pMK01 As String, ByVal pMK02 As String, ByRef pMK03 As String) As Boolean
Dim strQ1 As String
Dim intQ As Integer
Dim rsChk As New ADODB.Recordset

   PUB_TMQAppFileChk = False
   If pMK01 <> "" And pMK02 <> "" And pMK03 <> "" Then
      intQ = 1
      strQ1 = "select tmf09,tmf10 from tmqappfile where tmf01='" & pMK01 & "' and tmf02='" & pMK02 & "' and tmf03='" & pMK03 & "' "
      Set rsChk = ClsLawReadRstMsg(intQ, strQ1)
      If intQ = 1 Then
         PUB_TMQAppFileChk = True
      End If
   End If
   Set rsChk = Nothing
   
End Function

'Added by Lydia 2024/09/26 查名單-網中：傳收文號判斷查名單是否查覆完畢
Public Function PUB_TMACheckOver(ByVal iNoList As String, Optional bMsg As Boolean = True) As Boolean
Dim inC As Integer, StrStr As String
Dim rsCK As New ADODB.Recordset

    PUB_TMACheckOver = True

    StrStr = "select tqc01,tqc02,tqc03,tqc07,tma01,st02 from tmqcasemap ,tmqappform,staff " & _
             "where tqc02 in (" & GetAddStr(iNoList) & ") and tqc03<>'" & cntTQC自動記錄 & "' and tqc02=tma34 and tqc03=tma01 and tma10=st01(+) and tma14 is null "
    inC = 1
    Set rsCK = ClsLawReadRstMsg(inC, StrStr)
    If inC = 1 Then
       StrStr = ""
       If bMsg = True Then
          rsCK.MoveFirst
          Do While Not rsCK.EOF
             StrStr = StrStr & "委查單號:" & rsCK.Fields("tma01") & "，查名人:" & rsCK.Fields("st02") & vbCrLf
             rsCK.MoveNext
          Loop
          MsgBox "下列單據尚未查覆完畢，不可通知送件!" & vbCrLf & vbCrLf & StrStr
       End If
       PUB_TMACheckOver = False
    End If
    
    Set rsCK = Nothing
    
End Function


'Add by Morgan 2011/8/1
'Modified by Morgan 2024/6/5 改共用
Public Sub PUB_SettHour(ByVal pCP09 As String, Optional ByRef pSuportHr As String, Optional ByRef pModifyHr As String)
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   
   pSuportHr = 0
   pModifyHr = 0
   stSQL = "select nvl(sum(p1),0),nvl(sum(p2),0) from (select sh05 p1,0 p2 from supporthour where sh12='" & pCP09 & "' and sh11 is not null" & _
            " union all select 0,mh05 from modifyhour where mh12='" & pCP09 & "' and mh11 is not null" & _
            " union all select 0,eh05 from extendhour where eh12='" & pCP09 & "' and eh11 is not null)"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      pSuportHr = "" & rsQuery(0)
      pModifyHr = "" & rsQuery(1)
   End If
   
   Set rsQuery = Nothing
End Sub

'Added by Lydia 2024/07/02 檢查案源是否可以輸入出庭律師
'Modified by Lydia 2024/09/09 +pBolMsg是否彈訊息
Public Function Pub_ChkLosToCL(ByVal pCP09 As String, ByRef pBolMsg As Boolean, ByRef pMsgTxt As String) As Boolean
Dim rsQD As ADODB.Recordset
Dim intQ As Integer, strQ1 As String
Dim strMsg As String
   
   pMsgTxt = "" 'Added by Lydia 2024/09/09
   strQ1 = "select c1.cp01 as lcp01, c1.cp02 as lcp02, c1.cp03 as lcp03,c1.cp04 as lcp04, los02,los15,c2.cp01 as ocp01, c2.cp02 as ocp02, c2.cp03 as ocp03,c2.cp04 as ocp04, " & _
           "c2.cp10 as ocp10,decode(pa01,null,decode(tm01,null,nvl(m2.cpm03,m2.cpm04),decode(tm10,'000',cpm03,cpm04)),decode(pa09,'000',cpm03,cpm04)) as ocp10name " & _
           "from caseprogress c1,lawofficesource, caseprogress c2,casepropertymap m2,patent,trademark " & _
           "where c1.cp09='" & pCP09 & "' and c1.cp162 is not null and c1.cp162=los15(+) and los01=c2.cp09(+) " & _
           "and c2.cp01=m2.cpm01(+) and c2.cp10=m2.cpm02(+) " & _
           "and c2.cp01=pa01(+) and c2.cp02=pa02(+) and c2.cp03=pa03(+) and c2.cp04=pa04(+) " & _
           "and c2.cp01=tm01(+) and c2.cp02=tm02(+) and c2.cp03=tm03(+) and c2.cp04=tm04(+) "
   intQ = 1
   Set rsQD = ClsLawReadRstMsg(intQ, strQ1)
   If intQ = 1 Then
      If "" & rsQD.Fields("los02") = "B2" Then
         strMsg = "案源為" & rsQD.Fields("ocp01") & "-" & rsQD.Fields("ocp02") & IIf(rsQD.Fields("ocp03") & rsQD.Fields("ocp04") = "000", "", "-" & rsQD.Fields("ocp03") & "-" & rsQD.Fields("ocp04")) & _
                         "之" & rsQD.Fields("ocp10name") & "，不可以輸出庭費！" 'Added by Lydia 2024/09/09
         'B2案源只有行政訴訟及參加訴訟才要扣5000+5000，其他的都不扣
         If PUB_IsB2NeedCourt("" & rsQD.Fields("los15")) = False Then
            'Added by Lydia 2024/09/09
            If pBolMsg = False Then
               pMsgTxt = strMsg
               GoTo EXITSUB
            Else
            'end 2024/09/09
               MsgBox "案源為" & rsQD.Fields("ocp01") & "-" & rsQD.Fields("ocp02") & IIf(rsQD.Fields("ocp03") & rsQD.Fields("ocp04") = "000", "", "-" & rsQD.Fields("ocp03") & "-" & rsQD.Fields("ocp04")) & _
                      "之" & rsQD.Fields("ocp10name") & "，不可以輸出庭費！", vbExclamation + vbOKOnly, "資料稽核"
               GoTo EXITSUB
            End If 'Added by Lydia 2024/09/09
         End If
      End If
   End If
   Pub_ChkLosToCL = True
   
EXITSUB:
   Set rsQD = Nothing
   
End Function
'end 2024/07/02

'Added by Lydia 2024/09/06 查名單-網中：計算期限日期
Public Function PUB_GetNewTMADate(ByVal pType As String, ByVal ppDate As String, ByVal ppTime As String, ByVal pAllStatus As String) As String
'pType檢索方式:1-文字,2-圖形,3-文字+圖形,4-團體標章,5-證明標章
'pAllStatus 內商查名單分單狀態
Dim tmpWorkday As Integer
Dim tmpQC02  As String
Dim bWorkday As Boolean
   
   If InStr("1,2,3,", pType) > 0 Then '網中：目前預設「送出期限」、「查覆期限」各為1個工作天
      '送出給網中期限=1天，查覆期限要等到網中回寫後才能計算(Trigger)
      tmpWorkday = 1
   Else
      '團體標章及證明標章：仍由查名人員查名
      If pType = "4" Then
         tmpWorkday = 2 '文字
      Else
         tmpWorkday = 3
         Call PUB_GetTMQClass(2, 0, 0, 1, IIf(pType = "4", "8888", "9999"), , tmpQC02)
         If Val(tmpQC02) >= 14 Then tmpWorkday = 4
      End If
   End If
   '判斷是否為工作天
   If ChkWorkDay(ppDate) = True Then
      bWorkday = True
   Else
      bWorkday = False
   End If

    
   '大於13:30,期限+1天; 在非上班日的下午申請查名單,期限不用+1天(=次日早上)
   If (UCase(pAllStatus) = "N" Or Val(ppTime) > 1330) And bWorkday = True Then
      PUB_GetNewTMADate = CompWorkDay(tmpWorkday + 1, ppDate, 0)
   Else
      PUB_GetNewTMADate = CompWorkDay(tmpWorkday, ppDate, 0)
   End If
End Function

'Added by Lydia 2024/09/06 查名單-網中：依檢索方式取得欄位和排序語法
Public Function PUB_GetTMAClass(ByVal pType As String, Optional ByRef pOrd As String) As String
'pType檢索方式: 第1碼 1-文字, 2-圖形, 3-文字+圖形
                '最後一碼: 2=前2日統計, 其他>>當日
   PUB_GetTMAClass = ""
   pOrd = ""
   Select Case Left(pType, 1)
      Case "1"   '文字
         pOrd = " order by TMASR08,TMASR02,TMASR05"
         If Right(pType, 1) = "2" Then
            PUB_GetTMAClass = "TMASR02"  '前2日統計
         Else
            PUB_GetTMAClass = "TMASR08"  '當日
         End If
      Case "2"   '圖形
         pOrd = " order by TMASR09,TMASR03,TMASR06"
         PUB_GetTMAClass = "TMASR09"
         If Right(pType, 1) = "2" Then
            PUB_GetTMAClass = "TMASR03"  '前2日統計
         Else
            PUB_GetTMAClass = "TMASR09"  '當日
         End If
      Case "3"   '文字+圖形
         pOrd = " order by TMASR10,TMASR04,TMASR07"
         PUB_GetTMAClass = "TMASR10"
         If Right(pType, 1) = "2" Then
            PUB_GetTMAClass = "TMASR04"  '前2日統計
         Else
            PUB_GetTMAClass = "TMASR10"  '當日
         End If
   End Select
   
End Function

'Added by Lydia 2024/09/06 查名單-網中：排班規則(委查單分3類,依當日拿單量、前2日統計單量和亂數排序三種排序組成排班規則)
Public Function PUB_GetTMAUserPos(ByVal pType As String) As String
'pType檢索方式:1-文字,2-圖形,3-文字+圖形
Dim intR As Integer
Dim rsQR As New ADODB.Recordset
Dim strP1 As String, strP2 As String
Dim rsB As New ADODB.Recordset
Dim bolRest As Boolean '查名人員是否請假
Dim strTime As String, bolAllRest As Boolean
   
On Error GoTo OutPos

   '取得排序
   strP1 = PUB_GetTMAClass(pType, strP2)
   '判斷出缺勤時間
   strTime = Format(ServerTime, "000000")
   If Val(strTime) < 80000 Then '每日批次於凌晨執行
       strTime = "08:00"
   Else
       strTime = Mid(strTime, 1, 2) & ":" & Mid(strTime, 3, 2)
   End If
   '(模組)有多數查名同仁請假半，為了公平採用全部人員都分發查名單，但是期限+2天(天數依設定)
   If Pub_GetTmqAllDate(strSrvDate(1)) = True Then
      bolAllRest = True
   End If
   '排班等級(tmasr12) ='1'-> 直接分派查名單; '2'->統計人員群組，再分派一次
   strP1 = "select tmqm02,tmqm03, a1.* from tmqappsumr a1, tmqmember a2 where tmasr01=tmqm01(+) and tmasr11 is null and tmasr12='1' "
  
   'Added by Lydia 2021/01/08 因A4021鄭天雲和A7027金筱凌工作內容調整緣故，經呈 林經理同意，更改為此二人只查詢文字，圖形不查，煩請協助修改分發條件。
   'Memo by Lydia 2022/07/08 P2003人員雖然有變動,但是設定不變----與嘉雯確認過
   If pType = "2" Or pType = "3" Then
      'A4021鄭天雲和A7027金筱凌=>P2003
      strP1 = strP1 & " and tmasr01 <> 'P2003' "
   End If
   'Added by Lydia 2024/03/14 排除指定查名人員不分派查名單(從某一天開始)
   strP1 = strP1 & " and tmasr01 not in (select nvl(aal04,'AAAA') ul01 from addressa4list where aal01 ='TSdel' and aal02 <=to_char(sysdate,'yyyymmdd')) "
  
   strP2 = strP1 & strP2
   intR = 1
   Set rsQR = ClsLawReadRstMsg(intR, strP2)
   If intR = 1 Then
      rsQR.MoveFirst
      '逐筆判斷是否請假中
      Do While Not rsQR.EOF And PUB_GetTMAUserPos = ""
          '屬於統計人員代號
         If IsNull(rsQR.Fields("TMQM02")) Then
            strP1 = Replace(strP2, " and tmasr12='1'", " and tmasr12='2' and tmqm02='" & rsQR.Fields("TMASR01") & "'")
            intR = 1
            Set rsB = ClsLawReadRstMsg(intR, strP1)
            If intR = 1 Then
               rsB.MoveFirst
               Do While Not rsB.EOF
                  If bolAllRest = True Then
                     bolRest = False
                  Else
                     bolRest = CheckIsPersonRest(rsB.Fields("TMASR01"), strSrvDate(1), strTime)
                  End If
                  If "" & rsB.Fields("tmqm03") = "Y" Then '組別有人請假,就不拿單(一起放假)
                     If bolRest = True Then
                        PUB_GetTMAUserPos = ""
                        Exit Do 'rsB
                     End If
                  Else
                     If bolRest = True Then
                        PUB_GetTMAUserPos = ""
                     Else
                        PUB_GetTMAUserPos = "" & rsB.Fields("TMASR01") '組別有人上班,就拿單
                        Exit Do 'rsB
                     End If
                  End If
                  rsB.MoveNext
               Loop
            End If
         Else
            If bolAllRest = True Then
                bolRest = False
            Else
                bolRest = CheckIsPersonRest(rsQR.Fields("TMASR01"), strSrvDate(1), strTime)
            End If
            If bolRest = False Then
                PUB_GetTMAUserPos = rsQR.Fields("TMASR01")
            End If
         End If
         rsQR.MoveNext
      Loop
   End If
   
   Set rsQR = Nothing
   Set rsB = Nothing
OutPos:
   If Err.Number <> 0 Then MsgBox Err.Number & vbCrLf & Err.Description & " !", vbCritical, "查名單-網中：查名排班"
End Function

'Added by Lydia 2024/09/06 查名單-網中：排班規則(當日拿單量計算)
Public Function PUB_TMAtoTake(ByVal iKind As String, ByVal Quser As String, ByVal pType As String, ByVal wrStatus As String, bolTrans As Boolean) As String
'iKind = 寫入模式(1-新增, 2-修改)
'pType檢索方式:1-文字,2-圖形,3-文字+圖形
'修改: 傳入Quser有值=>個人重新計算,不傳入Quser值=>所有人重新計算
'wrStatus = 指定欄位(0-前2日統計量,1-當日累計量)

   Dim intR As Integer, strR As String
   Dim rsQR As New ADODB.Recordset
   Dim strP1 As String, strP2 As String, strP3 As String
   
On Error GoTo OutTake

 If bolTrans = True Then cnnConnection.BeginTrans
   
   Select Case iKind
      Case "1" '新增
         If Len(Quser) > 0 Then
            strP3 = PUB_GetTMAClass(pType) '取得當日統計欄位/前2日統計欄位
            strP1 = " update tmqappsumr set " & Trim(strP3) & "=" & Trim(strP3) & "+1 where tmasr01=" & CNULL(Quser)
            cnnConnection.Execute strP1
            strR = "select tmqm02 from tmqmember where tmqm01='" & Quser & "' and tmqm02<>tmqm01 "
            intR = 1
            Set rsQR = ClsLawReadRstMsg(intR, strR)
            If intR = 1 Then
               strP1 = " update tmqappsumr set " & Trim(strP3) & "=" & Trim(strP3) & "+1 where tmasr01=" & CNULL(rsQR(0))
               cnnConnection.Execute strP1
            End If
         End If
      Case "2" '修改,刪除->重算 (因為查名單修改不會觸發PUB_GetTMQUserPos,所以查名人不會變)

         '先清空記錄欄位
         If wrStatus = "0" Then   '0-前2日統計量
            strP1 = " update TMQAppSumR set TMASR02=0,TMASR03=0,TMASR04=0"
            strP2 = "TMA09>=" & CNULL(CompWorkDay(3, strSrvDate(1), 1), True) & " and TMA09<" & CNULL(strSrvDate(1), True) & " "
         Else '1-當日累計量
            strP1 = " update TMQAppSumR set TMASR08=0,TMASR09=0,TMASR10=0"
            strP2 = "TMA09=" & CNULL(strSrvDate(1), True)
         End If
         '指定查名人員
         If Len(Quser) > 0 Then strP1 = strP1 & " Where TMASR01 = " & CNULL(Quser)

         cnnConnection.Execute strP1

         strP1 = "select TMA10,TMA25,count(*) as cnt from TMQAppForm,tmqmember where " & strP2 & " and TMA10=tmqm01(+) and nvl(TMA10,'N') <> 'N' and nvl(TMA13,'N')='N' "
         '指定查名人員
         If Len(Quser) > 0 Then strP1 = strP1 & " and TMA10 = " & CNULL(Quser)
         strP1 = strP1 & " group by TMA10,TMA25 "
          
         intR = 1
         Set rsQR = ClsLawReadRstMsg(intR, strP1)
         If intR = 1 Then
            rsQR.MoveFirst
            Do While Not rsQR.EOF
               strP3 = PUB_GetTMAClass("" & rsQR.Fields("TMA25") & IIf(wrStatus = "0", "-2", "")) '取得當日統計欄位/前2日統計欄位
               strP1 = "Update TMQAppSumR SET " & strP3 & "=" & rsQR.Fields("cnt") & " where tmasr01='" & rsQR.Fields("tma10") & "' "
               cnnConnection.Execute strP1
               rsQR.MoveNext
            Loop
         End If
          
         '統計人員合計
         strP1 = "select TMQM02,sum(" & IIf(wrStatus = "0", "TMASR02", "TMASR08") & ") s2,sum(" & IIf(wrStatus = "0", "TMASR03", "TMASR09") & ") s3,sum(" & IIf(wrStatus = "0", "TMASR04", "TMASR10") & ") s4 " & _
                 "from TMQAppSumR,tmqmember where TMASR01=tmqm01(+) "
         If Len(Quser) = 0 Then
            strP1 = strP1 & " and tmqm01<>tmqm02 group by TMQM02 "
         Else
            strP1 = strP1 & " and tmqm01 in (select tmqm01 from tmqmember where tmqm02 in (select tmqm02 from tmqmember where tmqm01<>tmqm02 and tmqm01='" & Quser & "')) group by TMQM02"
         End If
         intR = 1
         Set rsQR = ClsLawReadRstMsg(intR, strP1)
         If intR = 1 Then
            rsQR.MoveFirst
            Do While Not rsQR.EOF
               strP2 = "update TMQAppSumR set " & IIf(wrStatus = "0", "TMASR02", "TMASR08") & "=" & rsQR.Fields("s2") & ", " & IIf(wrStatus = "0", "TMASR03", "TMASR09") & "=" & rsQR.Fields("s3") & _
                       ", " & IIf(wrStatus = "0", "TMASR04", "TMASR10") & "=" & rsQR.Fields("s4") & " where TMASR01=" & CNULL(rsQR.Fields(0))
               cnnConnection.Execute strP2
               rsQR.MoveNext
            Loop
         End If
   End Select
   
   Set rsQR = Nothing

 If bolTrans = True Then cnnConnection.CommitTrans
 
OutTake:
   If Err.Number <> 0 Then
      If bolTrans = True Then
         cnnConnection.RollbackTrans
         MsgBox Err.Number & vbCrLf & Err.Description & " !", vbCritical, "查名單-網中：查名排班"
      End If
   End If
End Function

'Added by Lydia 2024/12/02 查名單(網中)：類別組群的SQL
Public Function PUB_GetTMAforClass() As String
   '用RTRIM函數去掉尾端空白
   PUB_GetTMAforClass = " DECODE(TMA20,'1','團體標章','2','證明標章',REPLACE(RTRIM(DECODE(TMA22,NULL,DECODE(TMA23,NULL,NULL,TMA23||' ')||DECODE(TMA24,NULL,NULL,TMA24||' '),TMA22||' ')),' ',',')) "
End Function

'Add by Morgan 2008/10/8
'抓專利下次繳費日
Public Function PUB_GetNextFeeDate(pa() As String) As String
   Dim DATE1 As String, ii As Integer
   Dim varTmp
   Dim strDate As String
   
   If pa(72) <> "" Then
      If GetMoneyDate(Val(pa(8)), pa(9), pa(), DATE1, "") = True Then
         varTmp = Split(pa(72), ",")
         ii = UBound(varTmp)
         strDate = CompDate(0, Val(varTmp(ii)), DATE1)
         '台灣減一天,其他不必
         If pa(9) = "000" Then
            strDate = CompDate(2, -1, strDate)
            'Added by Morgan 2025/3/3 台灣法限遇假日順延 Ex:FCP-063645 Winfrey/郭
            'Removed by Morgan 2025/3/11 取消，系統法限不動，另寫程式控制或人工改
            'strDate = PUB_GetWorkDay1(strDate, False)
            'end 2025/3/11
            'end 2025/3/3
         End If
         PUB_GetNextFeeDate = strDate
      End If
   End If
End Function

'Move by Lydia 2025/01/13 從basPublic搬過來
'Added by Lydia 2024/09/30 (113/11/01上線) 傳入收文號，判斷是否已請款、已付款
Public Function PUB_ChkIsPaid(ByVal pCP09 As String, Optional ByRef pCP60 As String) As Boolean
'pCP09: 法律所收文號
'pCP60: 有>>已請款
'PUB_ChkIsPaid=True(已付款)
Dim strQ1 As String, intQ As Integer
Dim rsQuery As New ADODB.Recordset
    
   PUB_ChkIsPaid = False
   pCP60 = ""
   strQ1 = "select los15,c1.cp01 as lcp01,c1.cp02 as lcp02,c1.cp03 as lcp03,c1.cp04 as lcp04,c1.cp60 as lcp60,nvl(c1.cp75,0) as lcp75,nvl(k1.a1k30,0) as lt01 " & _
           ",c2.cp01 as ocp01,c2.cp02 as ocp02,c2.cp03 as ocp03,c2.cp04 as ocp04,c2.cp60 as ocp60,nvl(c2.cp75,0) as ocp75,nvl(k2.a1k30,0) as ot01 " & _
           "from caseprogress c1, lawofficesource, caseprogress c2,acc1k0 k1, acc1k0 k2 " & _
           "where c1.cp09='" & pCP09 & "' and c1.cp162=los15(+) and los01=c2.cp09(+) and c1.cp60=k1.a1k01(+) and c2.cp60=k2.a1k01(+) "
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, strQ1)
   If intQ = 1 Then
      If "" & rsQuery.Fields("los15") = "" Or "" & rsQuery.Fields("ocp01") = "TT" Or ("" & rsQuery.Fields("ocp01") <> "TT" And "" & rsQuery.Fields("lcp60") <> "") Then
         '※無案源：以CP60判斷:
         '1. 無值：未請款
         '2. 有值：
         '甲、  E開頭：CP75>0已收款；CP75=0未收款，例：L-006571(AB1039856)E1120495已收；
         '乙、  X開頭：A1K30>0已收款；A1K30=0未收款，例：FCL-010987(AB2035961)X11216186已收。
         '
         '※有案源且案源為TT-999999(LOS01)：判斷同無案源。
         '甲、  E開頭：L-006673(AB2026903)E11215033已收；L-006675(AB2027344)E11215271未收；
         '乙、  X開頭：FCL-010988(AB2016512)X11206772已收。
         '
         '※有案源且案源非TT-999999(LOS01)專利商標案源：
         '1. 法務案有CP60：判斷同無案源。
         '甲、  E開頭：CP75>0已收款；CP75=0未收款，例：L-006629(AB2011815)E11207560已收、L-006761-1(AB3038368)E11319977未收；
         '乙、  不會有X開頭。
         '2. 法務案無CP60，改判斷專利商標案源之CP60：
         pCP60 = "" & rsQuery.Fields("lcp60")
         If (Left(pCP60, 1) = "E" And Val("" & rsQuery.Fields("lcp75")) > 0) Or (Left(pCP60, 1) = "X" And Val("" & rsQuery.Fields("lt01")) > 0) Then
            PUB_ChkIsPaid = True
         End If
      Else
         '※有案源且案源非TT-999999(LOS01)專利商標案源：
         '2. 法務案無CP60，改判斷專利商標案源之CP60：
         '甲、  專利商標案源之CP60無值：未請款；
         '乙、  專利商標案源之CP60有值：A1K30>0已收款；A1K30=0未收款，
         '例：FCL-011017(AB3018774)X11308577已收，案源FCP-064861；FCL-010984(AB2012130)X11205501已收，案源FCT-040040。
         pCP60 = "" & rsQuery.Fields("ocp60")
         If (Left(pCP60, 1) = "E" And Val("" & rsQuery.Fields("ocp75")) > 0) Or (Left(pCP60, 1) = "X" And Val("" & rsQuery.Fields("ot01")) > 0) Then
            PUB_ChkIsPaid = True
         End If
      End If
   End If
   Set rsQuery = Nothing
End Function

'Move by Lydia 2025/01/13 從basPublic搬過來
'Added by Lydia 2022/05/23 法律所案源：(B2類發文規費)
Public Sub PUB_UpdateLosCP27(ByVal pLOS15 As String)
Dim strQ1 As String, intQ As Integer
Dim strB1 As String, strB2 As String, strTo As String
Dim rsQD As New ADODB.Recordset
Dim strCP60 As String, bolPaid As Boolean 'Added by Lydia 2024/09/30

    '法務案無發文日則更新發文日為系統日，但法務案不更新CP84。另加發EMAIL給法務案承辦人，提供案號及案件性質、總收文號，提醒他去案件進度檔補輸工作時數及工作點數分配。
    'Modified by Lydia 2024/09/30 參考法務發文通知出庭律師Email
    'strQ1 = "select y.cp01||'-'||y.cp02||'-'||y.cp03||'-'||y.cp04 as caseno,y.cp09,y.cp14,y.cp10,cpm03,z.cp13 as cp13pt, z.cp01||'-'||z.cp02||'-'||z.cp03||'-'||z.cp04 as ptcaseno " & _
                "from LAWOFFICESOURCE, caseprogress x, caseprogress y, caseprogress z, casepropertymap " & _
                "where los15='" & pLOS15 & "' and los06=x.cp09(+) and x.cp01=y.cp01(+) and x.cp02=y.cp02(+) and x.cp03=y.cp03(+) and x.cp04=y.cp04(+) " & _
                "and y.cp162=los15 and y.cp01=cpm01(+) and y.cp10=cpm02(+) and y.cp159=0 and y.cp158=0 and los01=z.cp09 "
    'Modified by Lydia 2025/01/13 +LOS02
    strQ1 = "select LOS02, y.cp01||'-'||y.cp02||'-'||y.cp03||'-'||y.cp04 as caseno,y.cp09,y.cp14,y.cp10," & _
            "decode(lc15,'000',nvl(cpm03,cpm04),nvl(cpm04,cpm03)) as cpm03 ,nvl(lc05,nvl(lc06,lc07)) as lcasename,z.cp13 as cp13pt, z.cp01||'-'||z.cp02||'-'||z.cp03||'-'||z.cp04 as ptcaseno " & _
            "from LAWOFFICESOURCE, caseprogress x, caseprogress y, caseprogress z, casepropertymap,lawcase " & _
            "where los15='" & pLOS15 & "' and los06=x.cp09(+) and x.cp01=y.cp01(+) and x.cp02=y.cp02(+) and x.cp03=y.cp03(+) and x.cp04=y.cp04(+) " & _
            "and y.cp162=los15 and y.cp01=cpm01(+) and y.cp10=cpm02(+) and y.cp159=0 and y.cp158=0 and los01=z.cp09 and y.cp01=lc01(+) and y.cp02=lc02(+) and y.cp03=lc03(+) and y.cp04=lc04(+) "
    intQ = 1
    Set rsQD = ClsLawReadRstMsg(intQ, strQ1)
    If intQ = 1 Then
        If "" & rsQD.Fields("cp14") <> "" Then
            strB1 = "Update Caseprogress set cp27=" & strSrvDate(1) & " where cp09 = '" & rsQD.Fields("cp09") & "' "
            cnnConnection.Execute strB1
            'Mark by Lydia 2022/05/27 '因為現行法務案不輸入工時(LA才有)和點數,所以只上發文日; ex.P-093322-0-00
            'strB1 = rsQD.Fields("caseno") & "之" & rsQD.Fields("cpm03") & "(" & rsQD.Fields("cp09") & ")已發文，請儘速到案件進度維護作業補輸工作時數及工作點數分配！"
            'strB1 = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08)" & _
            '     " values( '" & strUserNum & "','" & rsQD.Fields("CP14") & "',to_char(sysdate,'yyyymmdd')" & _
            '     ",to_char(sysdate,'hh24miss'),'" & strB1 & "','本案和專業部" & rsQD.Fields("ptcaseno") & "已發文，請儘速到案件進度維護作業補輸工作時數及工作點數分配。')"
            'cnnConnection.Execute strB1, intI
            'end 2022/05/27
            'Added by Lydia 2025/01/13 B2案源的案件性質不扣出庭費; ex.案源案號：P-087216-0-00(AB3051197), 法務案號：L-006220-5-00(AB3051296)
            If "" & rsQD.Fields("los02") = "B2" Then
               bolPaid = PUB_IsB2NeedCourt(pLOS15)
            Else
               bolPaid = True
            End If
            If bolPaid = True Then
            'end 2025/01/13
              'Added by Lydia 2024/09/30 (113/11/01上線)同時做律師領取出庭費：參考法務發文通知出庭律師Email(frm071006)
               bolPaid = PUB_ChkIsPaid("" & rsQD.Fields("cp09"), strCP60)
               strTo = "" & rsQD.Fields("cp14")
               strB1 = "" & rsQD.Fields("caseno") & "通知領取出庭費事"
               strB2 = "法務案號：" & rsQD.Fields("caseno") & vbCrLf & _
                       "案源案號：" & rsQD.Fields("ptcaseno") & vbCrLf & _
                       "案件名稱：" & rsQD.Fields("lcasename") & vbCrLf & _
                       "案件性質：" & rsQD.Fields("cpm03") & vbCrLf & _
                       IIf(strCP60 <> "", "收據號碼：" & strCP60, "") & vbCrLf & _
                       "收款狀態：" & IIf(strCP60 = "", "未請款", IIf(bolPaid = True, "已收款", "未收款")) & vbCrLf & vbCrLf & _
                       "已完成委任狀發文程序，請至【法務系統->內法->資料處理->出庭費確認維護】確認開庭費領取事宜。"
               strQ1 = "select cl01 as v101,listagg(cl02,';') within group (order by cl01) as v102 from caselawer where cl01='" & rsQD.Fields("cp09") & "' group by cl01 "
               intQ = 1
               Set rsQD = ClsLawReadRstMsg(intQ, strQ1)
               If intQ = 1 Then
                  strTo = "" & rsQD.Fields("v102")
               End If
               If strTo <> "" Then
                  strQ1 = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08,mc09) " & _
                         "values('" & strUserNum & "','" & strTo & "',to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss') " & _
                         ",'" & ChgSQL(strB1) & "','" & ChgSQL(strB2) & "',null) "
                  cnnConnection.Execute strQ1
               End If
               'end 2024/09/30
            End If 'Added by Lydia 2025/01/13
        Else '法律所尚未分案
            '依員工所別取得法務預設窗口
            strQ1 = PUB_GetLawCaseWindow(rsQD.Fields("cp13pt"), Mid(rsQD.Fields("ptcaseno"), 1, InStr(rsQD.Fields("ptcaseno"), "-") - 1))
            strB1 = rsQD.Fields("caseno") & "之" & rsQD.Fields("cpm03") & "(" & rsQD.Fields("cp09") & ")，請儘速分案並且發文！"
            strB1 = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08)" & _
                 " values( '" & strUserNum & "','" & strQ1 & "',to_char(sysdate,'yyyymmdd')" & _
                 ",to_char(sysdate,'hh24miss'),'" & strB1 & "','專業部" & rsQD.Fields("ptcaseno") & "已發文，請儘速分案並且發文！')"
            cnnConnection.Execute strB1, intQ
        End If
    End If
    Set rsQD = Nothing
End Sub

'Added by Morgan 2025/2/26
'檢查e化客戶特殊設定
Public Function PUB_ChkECustSetting(ByVal pCustNo As String, ByVal pCode As String) As Boolean
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   
   intQ = 1
   pCustNo = Left(pCustNo & "000", 9)
   stSQL = "SELECT CU186 FROM CUSTOMER WHERE cu01='" & Left(pCustNo, 8) & "' and cu02='" & Mid(pCustNo, 9) & "' and CU186 is not null"
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      If InStr("," & rsQuery("cu186") & ",", "," & pCode & ",") > 0 Then
         PUB_ChkECustSetting = True
      End If
   End If
   
   Set rsQuery = Nothing
End Function

'Add by Amy 2025/05/15 建立回覆單檔案資料夾
'intChoose: 1-判斷無資料夾者建立 / 2-刪除暫存資料*.* / 3-傳入多檔路徑+檔案確認檔案未開再刪除
Public Function Pub_SetFilePathDelTmp(stType As String, intChoose As Integer, ByRef stMsg As String, Optional ByRef stAttachPath As String) As Boolean
   Dim stTP As String, stMidFolder As String, bolAddFolder As Boolean
   Dim ii As Integer, stErr As String, arrTmp
   
On Error GoTo ErrHnd
   Pub_SetFilePathDelTmp = False
   stAttachPath = "": stMsg = ""
   
   'Memo 目前使用表單
   '結案單相關: FRM210133(國內)/FRM210133_F(國外承辦用)/FRM210147_1/FRM210148_1/FRM210149/FRM210149_1
   
   Select Case UCase(stType)
      Case "CLOSE"
         stMidFolder = Pub_GetSpecMan("EmpFlowAttPath")
   End Select
   
   stTP = App.path & stMidFolder
   If intChoose = 1 Then
      If Dir(stTP, vbDirectory) = "" Then
         MkDir stTP
         bolAddFolder = True
      End If
   End If
   stTP = stTP & "\" & strUserNum
   If intChoose = 1 Then
      If Dir(stTP, vbDirectory) = "" Then
         MkDir stTP
         bolAddFolder = True
      End If
   End If
   
   If intChoose = 2 Then
      stAttachPath = stTP
      If intChoose = 2 Then
         If Dir(stAttachPath & "\.") <> "" Then
            Kill stAttachPath & "\*.*"
         End If
      End If
   End If
   
   '傳入多檔路徑+檔案確認檔案未開再刪除
   If intChoose = 3 Then
      Call PUB_DelPCOrgFile(stAttachPath, True, False, stErr)
      If stErr <> "" Then GoTo ErrHnd
   End If
   If intChoose = 1 Then stAttachPath = stTP
   Pub_SetFilePathDelTmp = True
   
ErrHnd:
   If stErr <> "" Then stMsg = "檔案已開啟,請關閉才可刪除" & Mid(stErr, 2)
   If Err.Number <> 0 Then stMsg = IIf(stMsg <> "", vbCrLf, "") & Err.Description
End Function

'Add by Amy 2025/06/19 確認檔案是否開啟
Public Function Pub_FileIsOpen(stFormN As String, ByVal stFilePath As String, ByRef stMsg As String) As Boolean
   Dim i As Integer, stSign As String, stFileN As String, arrFile
   
   stSign = "&" '多案區隔符號
   Select Case UCase(stFormN)
      Case "FRM210133" '國內結案單
      Case "FRM210133_F" 'FC結案單-承辦用
      Case "FRM210147_1" '案件簽核-個人用
      Case "FRM210148_1" '案件簽核-主管用
   End Select
   
   Pub_FileIsOpen = False
   stMsg = ""
   
   If stFilePath = "" Then Exit Function
   
   arrFile = Split(stFilePath, stSign)
   For i = LBound(arrFile) To UBound(arrFile)
      stFileN = arrFile(i)
      If InStrRev(stFileN, " (") > 0 Then
         If UCase(Mid(stFileN, InStrRev(stFileN, " (") + 1, Len("(X86)"))) <> "(X86)" Then
            stFileN = Left(stFileN, InStrRev(stFileN, " (") - 1)
         End If
      End If
      If PUB_ChkFileOpening(stFileN, , False) = True Then
         Pub_FileIsOpen = True
         stMsg = stMsg & ";" & stFileN
      End If
   Next i
   If stMsg <> "" Then stMsg = Mid(stMsg, 2)
End Function

'Added by Lydia 2025/06/20 內專通知函之繳年費/實體審查通知函：例外通知 'Memo by Lydia 2025/07/25 上線日期114/7/28
Public Function Pub_Getfrm040303ExceptNew(ByVal pSysNo As String, ByVal pBDate As String, ByVal pOpt3 As String, ByVal iAppNo As String, Optional ByRef pCustList As String, Optional ByRef pHandleData As Variant, Optional ByRef PCU01 As String) As Boolean
'pSysNo : 系統別
'pBDate : 畫面的期限範圍起
'pOpt3 : P案區分10號,20號執行
'iAppNo : ALL取得全部資料; X編號檢查是否為例外客戶
'pCustList : 設定的關係企業
'pHandleData : 相關控制變數
'pCU01  : 代表的客戶編號
Dim intR As Integer, strR1 As String
Dim rsRD As New ADODB.Recordset
Dim m_Date1 As String, m_Date2 As String 'P案所限區間(大陸案)
Dim m_FMPDate1 As String, m_FMPDate2 As String 'FMP案所限區間(大陸案)
Dim m_DateTW1 As String, m_DateTW2 As String 'P案所限區間(台灣案)
   
   If (pSysNo <> "P" And pSysNo <> "CFP") Or iAppNo = "" Then Exit Function
     
   pCustList = ""
   PCU01 = ""

   iAppNo = UCase(iAppNo)
   strR1 = "SELECT fd02,fd03,fd07,fd08 FROM formdate WHERE fd01='frm040303' AND nvl(fd08,0)<>0 "
   If iAppNo <> "ALL" Then
      iAppNo = ChangeCustomerL(iAppNo)
      strR1 = strR1 & " and instr(upper(fd03),'" & iAppNo & "') > 0 "
   End If
   strR1 = strR1 & "ORDER BY fd07 "
   intR = 1
   Set rsRD = ClsLawReadRstMsg(intR, strR1)
   If intR = 1 Then
      ReDim pHandleData(0 To rsRD.RecordCount - 1) As Variant
      rsRD.MoveFirst
      Do While Not rsRD.EOF
         pCustList = pCustList & rsRD.Fields("fd03") & ","
         PCU01 = PCU01 & rsRD.Fields("fd02") & ","
         If pSysNo = "P" And pBDate <> "" Then
            Call PUB_SetDateConFrm040303(pBDate, IIf(pOpt3 = "", "1", pOpt3), m_Date1, m_Date2, m_FMPDate1, m_FMPDate2, m_DateTW1, m_DateTW2, Val("" & rsRD.Fields("fd08")), "" & rsRD.Fields("fd02"))
            If m_Date1 <> "" Then
               '(0)代表X編號|(1)客戶編號(含關係企業)|(2)P案所限區間(大陸案)m_Date1|(3)m_Date2|(4)FMP案所限區間(大陸案)m_FMPDate1|(5)m_FMPDate2|(6)P案所限區間(台灣案)m_DateTW1|(7)m_DateTW2
               pHandleData(rsRD.AbsolutePosition - 1) = rsRD.Fields("fd02") & "|" & rsRD.Fields("fd03") & "|" & m_Date1 & "|" & m_Date2 & "|" & m_FMPDate1 & "|" & m_FMPDate2 & "|" & m_DateTW1 & "|" & m_DateTW2
            End If
         End If
         If pSysNo = "CFP" Then
            '(0)代表X編號|(1)客戶編號(含關係企業)|(2)提前X個月
            pHandleData(rsRD.AbsolutePosition - 1) = rsRD.Fields("fd02") & "|" & rsRD.Fields("fd03") & "|" & rsRD.Fields("fd08")
         End If
         rsRD.MoveNext
      Loop
      pCustList = Mid(pCustList, 1, Len(pCustList) - 1)
      PCU01 = Mid(PCU01, 1, Len(PCU01) - 1)

      Pub_Getfrm040303ExceptNew = True
   End If
   Set rsRD = Nothing
   Exit Function

End Function

'Added by Lydia 2025/06/20 P內專通知函之繳年費/實體審查通知函：計算催期限的日期範圍 'Memo by Lydia 2025/07/25 上線日期114/7/28
Public Sub PUB_SetDateConFrm040303(ByVal pYYMM As String, ByVal pOpt3 As String, ByRef p020Date1 As String, ByRef p020Date2 As String, _
           ByRef pFMPDate1 As String, ByRef pFMPDate2 As String, ByRef pDateTW1 As String, ByRef pDateTW2 As String, Optional ByVal pMon As Integer = 3, Optional ByVal bCU01 As String)
'p020Date1,p020Date2  'P案所限區間(大陸案)
'pFMPDate1,pFMPDate2 'FMP案所限區間(大陸案)
'pDateTW1,pDateTW2    'P案所限區間(台灣案)
'pMon 催期限月數(預設3個月)
Dim pDate1 As String, pDate2 As String, pDate3 As String

   If pYYMM <> "" Then
      p020Date1 = "": p020Date2 = ""
      pFMPDate1 = "": pFMPDate2 = ""
      pDateTW1 = "": pDateTW2 = ""
      '10號
      If pOpt3 = "1" Then
         pDate1 = pYYMM & "10"
         'P:+3個月的1~20號 (台灣案及非台灣案)
         pDate3 = CompDate(1, pMon, pDate1)
         pDate2 = Left(pDate3, 6) & "01"
         pDate3 = Left(pDate3, 6) & "20"
         pDateTW1 = TransDate(pDate2, 1)
         pDateTW2 = TransDate(pDate3, 1)

         'P:下月16號-該月底
         '領證發文也要用寫共用
         If Get605InformPeriod4NonTwCase(pDate1, False, pDate2, pDate3, bCU01) = False Then Exit Sub
         p020Date1 = TransDate(pDate2, 1)
         p020Date2 = TransDate(pDate3, 1)
         'FMP:+3月
         '第一次要包含過渡的資料
         If pDate1 = "990110" Then
            pFMPDate1 = "990319"
         Else
            pFMPDate1 = TransDate(pDate2, 1)
         End If

         If Get605InformPeriod4NonTwCase(pDate1, True, pDate2, pDate3, bCU01) = False Then Exit Sub
         pFMPDate1 = TransDate(pDate2, 1)
         pFMPDate2 = TransDate(pDate3, 1)

      '20號
      Else
         pDate1 = pYYMM & "20"
         'P:+3個月的21號~月底 (台灣案及非台灣案)
         pDate3 = CompDate(2, -1, Left(CompDate(1, pMon + 1, pDate1), 6) & "01")
         pDate2 = Left(pDate3, 6) & "21"
         pDateTW1 = TransDate(pDate2, 1)
         pDateTW2 = TransDate(pDate3, 1)
         
         'P:下下月1號-15號
         '領證發文也要用寫共用
         If Get605InformPeriod4NonTwCase(pDate1, False, pDate2, pDate3, bCU01) = False Then Exit Sub
         p020Date1 = TransDate(pDate2, 1)
         p020Date2 = TransDate(pDate3, 1)
         'FMP:+3月
         If Get605InformPeriod4NonTwCase(pDate1, True, pDate2, pDate3, bCU01) = False Then Exit Sub
         pFMPDate1 = TransDate(pDate2, 1)
         pFMPDate2 = TransDate(pDate3, 1)
      End If
   End If
End Sub

'Add By Sindy 2025/06/25 為Frmacc44x0 和AutoBatch: StrMenu39 抓資料的SQL
'strFrmNm: 作業名稱
'strType: 1.扣繳收據抬頭檢查清單 2.當年度全部收據資料+扣繳
'strYear: 扣繳年度
'strDate: 收據日期,為抓年度
Public Sub PUB_Frmacc44x0(strFrmNm As String, strType As String, strYear As String, strDate As String)
Dim strY As String '統計年度
Dim intR As Integer
Dim rsRD As New ADODB.Recordset
Dim m_CU01 As String, m_CU02 As String, m_CU13 As String
   
   Screen.MousePointer = vbHourglass
   strY = Left(DBDATE(strDate), 4) - 1911 '當年度
   
   '先清空
   cnnConnection.Execute "delete from ACCTMP44q0 where T05='" & strFrmNm & "' and T14='" & strUserNum & "'", intI
   '********************************
   '寫入暫存檔
   'T01.收據號碼
   'T02.客戶編號
   'T03.扣繳年度
   'T04.已扣繳金額
   'T05.Form Name
   'T07.公司別
   'T14.UserID
   'T15.收據抬頭
   'T24.可扣繳別
   'T30.來源acc1v0 =V
   '********************************
   If strType = 1 Then '扣繳收據抬頭檢查清單
      '1.收據抬頭字數大於3個字的不可扣繳收據
      strExc(0) = "SELECT a0k01,a0k03,A0k16,0,'" & strFrmNm & "',A0K11,'" & strUserNum & "',A0k04,A0k05,''" & _
                  " From acc0k0" & _
                  " where A0k16=" & strYear & _
                  " and length(A0k04)>=4 AND A0K11<>'J' AND A0K05='1' AND (A0K09 IS NULL OR A0K09=0)" & _
                  " group by a0k01,a0k03,A0k16,A0K11,A0k04,A0k05"
      '2.收據抬頭為境外公司為可扣繳收據
      strExc(0) = strExc(0) & " Union " & _
                  "SELECT a0k01,a0k03,A1v09,sum(A1v06),'" & strFrmNm & "',A1v03,'" & strUserNum & "',A0k04,A0k05,'V'" & _
                  " From acc0k0, acc1v0" & _
                  " where A0k16=" & strYear & " AND a0k05='2'" & _
                  " and a0k01=a1v02 AND A0K11<>'J' AND (A0K09 IS NULL OR A0K09=0)" & _
                  " group by a0k01,a0k03,A1v09,A1v03,A0k04,A0k05"
      strExc(0) = strExc(0) & " Union " & _
                  "SELECT a1k01,a1k28,A1v09,sum(A1v06),'" & strFrmNm & "',A1v03,'" & strUserNum & "',A1k35,'2','V'" & _
                  " From acc1k0, acc1v0" & _
                  " where a1v09=" & strYear & _
                  " and a1k01=a1v02 and A1k35 is not null AND (A1K12 IS NULL OR A1K12=0)" & _
                  " group by a1k01,a1k28,A1v09,A1v03,A1k35"
      cnnConnection.Execute "insert into ACCTMP44q0(T01,T02,T03,T04,T05,T07,T14,T15,T24,T30) " & strExc(0), intI
      '3.未收款或某扣繳年度
      '(注意:此函數下面會再依條件刪除資料)
      strExc(0) = "select a0k01,a0k03,A0k16,0,'" & strFrmNm & "',A0K11,'" & strUserNum & "',A0k04,A0k05" & _
                  " from acc0k0,acc0j0," & _
                  "(select a1u02,a1u03,nvl(sum(a1u04),0) a1u04,nvl(sum(a1u05),0) a1u05,nvl(sum(a1u07),0) a1u07,nvl(sum(a1u09),0) a1u09,nvl(sum(a1u08),0) a1u08,nvl(sum(a1u10),0) a1u10" & _
                  " from acc1u0 group by a1u02,a1u03) x" & _
                  " Where a0k02>=910101" & _
                  " AND LENGTH(A0K04)>=4 AND A0K11<>'J' AND A0K05='1' AND (A0K09 IS NULL OR A0K09=0)" & _
                  " and a0k06+a0k07>a0k17+a0k18" & _
                  " and a0k01=a0j13(+) and a0j13=a1u02(+) and a0j01=a1u03(+)" & _
                  " and (a1u04+a1u05+a1u07+a1u09-a1u08-a1u10<a0j09+a0j10 or a1u02 is null)" & _
                  " and not exists(select T01 from ACCTMP44q0 where T05='" & strFrmNm & "' and T14='" & strUserNum & "' and T01=a0k01)"
      strExc(0) = strExc(0) & " Union " & _
                  "select a0k01,a0k03,A0k16,0,'" & strFrmNm & "',A0K11,'" & strUserNum & "',A0k04,A0k05" & _
                  " from acc0k0,acc0j0," & _
                  "(select a1u02,a1u03,nvl(sum(a1u04),0) a1u04,nvl(sum(a1u05),0) a1u05,nvl(sum(a1u07),0) a1u07,nvl(sum(a1u09),0) a1u09,nvl(sum(a1u08),0) a1u08,nvl(sum(a1u10),0) a1u10" & _
                  " from acc1u0 group by a1u02,a1u03) x" & _
                  " where a0k02>=910101 AND A0K11<>'J' AND A0K05='2' AND (A0K09 IS NULL OR A0K09=0)" & _
                  " and a0k06+a0k07>a0k17+a0k18" & _
                  " and a0k01=a0j13(+) and a0j13=a1u02(+) and a0j01=a1u03(+)" & _
                  " AND (A1U04+A1U05+A1U07+A1U09-A1U08-A1U10<A0J09+A0J10 OR A1U02 IS NULL)" & _
                  " and not exists(select T01 from ACCTMP44q0 where T05='" & strFrmNm & "' and T14='" & strUserNum & "' and T01=a0k01)"
      cnnConnection.Execute "insert into ACCTMP44q0(T01,T02,T03,T04,T05,T07,T14,T15,T24) " & strExc(0), intI
   '當年度全部收據資料+扣繳
   ElseIf strType = 2 Then
      '抓扣繳年度有已扣繳額資料(acc1v0)
      strExc(0) = "SELECT a0k01,a0k03,A1v09,sum(A1v06),'" & strFrmNm & "',A1v03,'" & strUserNum & "',A0k04,A0k05,'V'" & _
                  " From acc0k0, acc1v0" & _
                  " where a1v09=" & strYear & " AND a0k05='2'" & _
                  " and a0k01=a1v02 AND A0K11<>'J' AND (A0K09 IS NULL OR A0K09=0)" & _
                  " group by a0k01,a0k03,A1v09,A1v03,A0k04,A0k05" & _
                  " Union" & _
                  " SELECT a1k01,a1k28,A1v09,sum(A1v06),'" & strFrmNm & "',A1v03,'" & strUserNum & "',A1k35,'2','V'" & _
                  " From acc1k0, acc1v0" & _
                  " where a1v09=" & strYear & _
                  " and a1k01=a1v02 and A1k35 is not null AND (A1K12 IS NULL OR A1K12=0)" & _
                  " group by a1k01,a1k28,A1v09,A1v03,A1k35"
      cnnConnection.Execute "insert into ACCTMP44q0(T01,T02,T03,T04,T05,T07,T14,T15,T24,T30) " & strExc(0), intI
      '當年度全部收據資料(acc0k0,acc1k0)
      strExc(0) = "select a0k01,a0k03,A0k16,0,'" & strFrmNm & "',A0k11,'" & strUserNum & "',A0k04,A0k05" & _
                  " From acc0k0 Where a0k02>=" & strY & "0101 AND a0k02<=" & strY & "1231 AND a0k05='2'" & _
                  " AND A0K11<>'J' AND (A0K09 IS NULL OR A0K09=0)" & _
                  " and not exists(select T01 from ACCTMP44q0 where T05='" & strFrmNm & "' and T14='" & strUserNum & "' and T01=a0k01)"
      cnnConnection.Execute "insert into ACCTMP44q0(T01,T02,T03,T04,T05,T07,T14,T15,T24) " & strExc(0), intI
      strExc(0) = "select a1k01,a1k28,'',0,'" & strFrmNm & "',A1k37,'" & strUserNum & "',A1k35,'2'" & _
                  " From acc1k0 Where a1k02>=" & strY & "0101 AND a1k02<=" & strY & "1231" & _
                  " and A1k35 is not null AND (A1K12 IS NULL OR A1K12=0)" & _
                  " and not exists(select T01 from ACCTMP44q0 where T05='" & strFrmNm & "' and T14='" & strUserNum & "' and T01=a1k01)"
      cnnConnection.Execute "insert into ACCTMP44q0(T01,T02,T03,T04,T05,T07,T14,T15,T24) " & strExc(0), intI
   End If
   
   '********************************
   'T29.依收據抬頭讀到的客戶編號
   '********************************
   '讀取對應到的客戶編號資料:
   strExc(0) = "update ACCTMP44q0 set T29=(" & _
               "select min(CU01||CU02) from customer,staff where CU04=T15 and cu02='0'" & _
               " and (cu80 is null or instr('" & 客戶及代理人可讀取的狀態 & "',cu80)>0)" & _
               " and cu13=st01(+) and st04='1'" & _
               ")" & _
               " where T05='" & strFrmNm & "' and T14='" & strUserNum & "' and T29 is null"
   cnnConnection.Execute strExc(0), intI
   '讀取對應到的特殊收據抬頭資料
   strExc(0) = "update ACCTMP44q0 set T29=(" & _
               "select 'T' from acc420 where a4201=T15" & _
               ")" & _
               " where T05='" & strFrmNm & "' and T14='" & strUserNum & "' and T29 is null"
   cnnConnection.Execute strExc(0), intI
   '逐筆抓資料取得客戶/代理人編號或特殊收據抬頭檔
   strSql = "select T15 from ACCTMP44q0 where T05='" & strFrmNm & "' and T14='" & strUserNum & "' and T29 is null group by T15"
   intR = 1
   Set rsRD = ClsLawReadRstMsg(intR, strSql)
   If intR = 1 Then
      rsRD.MoveFirst
      Do While Not rsRD.EOF
         If GetTitleCustData(rsRD.Fields("T15"), "", "", m_CU01, m_CU02, _
                            , , , , , , , _
                            , , , , , , , _
                            , , m_CU13) = True Then
            If m_CU01 <> "" Then 'And Left(m_CU01, 1) = "X" Then
               strExc(0) = "update ACCTMP44q0 set T29='" & m_CU01 & m_CU02 & "'" & _
                           "where T05='" & strFrmNm & "' and T14='" & strUserNum & "' and T15='" & ChgSQL(rsRD.Fields("T15")) & "' and T29 is null"
               cnnConnection.Execute strExc(0), intI
'            ElseIf m_CU01 <> "" And Left(m_CU01, 1) = "Y" Then
'               strExc(0) = "update ACCTMP44q0 set T29='" & m_CU01 & m_CU02 & "'" & _
'                           "where T05='" & strFrmNm & "' and T14='" & strUserNum & "' and T15='" & ChgSQL(rsRd.Fields("T15")) & "' and T29 is null"
'               cnnConnection.Execute strExc(0), intI
            ElseIf m_CU01 = "" And m_CU13 <> "" Then
               strExc(0) = "update ACCTMP44q0 set T29='T'" & _
                           "where T05='" & strFrmNm & "' and T14='" & strUserNum & "' and T15='" & ChgSQL(rsRD.Fields("T15")) & "' and T29 is null"
               cnnConnection.Execute strExc(0), intI
            End If
         End If
         rsRD.MoveNext
      Loop
   End If
   
   '********************************
   'T06.代表號
   'T16.財務E-Mail
   'T17.Tel
   'T18.Fax
   'T22.業務區
   'T23.智權人員
   'T25.是否為境外公司
   'T26.客戶狀態/代理人狀態
   '********************************
   '更新客戶資料
   strExc(0) = "update ACCTMP44q0 set T06=(select nvl(cu20,'X') from customer where CU01=substr(T29,1,8) and cu02='0')" & _
               ",T16=(select cu115 from customer where CU01=substr(T29,1,8) and cu02='0')" & _
               ",T17=(select CU16||decode(cu17,NULL,'',';'||CU17) from customer where CU01=substr(T29,1,8) and cu02='0')" & _
               ",T18=(select CU18||decode(cu19,NULL,'',';'||CU19) from customer where CU01=substr(T29,1,8) and cu02='0')" & _
               ",T22=(select cu12 from customer where CU01=substr(T29,1,8) and cu02='0')" & _
               ",T23=(select cu13 from customer where CU01=substr(T29,1,8) and cu02='0')" & _
               ",T25=(select cu158 from customer where CU01=substr(T29,1,8) and cu02='0')" & _
               ",T26=(select cu80 from customer where CU01=substr(T29,1,8) and cu02='0')" & _
               " where T05='" & strFrmNm & "' and T14='" & strUserNum & "' and T29 is not null and substr(T29,1,1)='X'"
   cnnConnection.Execute strExc(0), intI
   '更新特殊收據抬頭檔資料
   strExc(0) = "update ACCTMP44q0 set T16=(select a4218 from acc420 where a4201=T15)" & _
               ",T17=(select A4204 from acc420 where a4201=T15)" & _
               ",T18=(select A4205 from acc420 where a4201=T15)" & _
               ",T22=(select st15 from acc420,staff where a4201=T15 and A4206=st01(+) and st15 is not null)" & _
               ",T23=(select A4206 from acc420 where a4201=T15)" & _
               ",T25=(select A4216 from acc420 where a4201=T15)" & _
               "where T05='" & strFrmNm & "' and T14='" & strUserNum & "' and T29='T'"
   cnnConnection.Execute strExc(0), intI
   '更新代理人資料
   strExc(0) = "update ACCTMP44q0 set T06=(select nvl(fa16,'X') from FAGENT where fa01=substr(T29,1,8) and fa02='0')" & _
               ",T16=(select fa79 from FAGENT where fa01=substr(T29,1,8) and fa02='0')" & _
               ",T17=(select fa12||decode(fa13,NULL,'',';'||fa13) from FAGENT where fa01=substr(T29,1,8) and fa02='0')" & _
               ",T18=(select fa14||decode(fa15,NULL,'',';'||fa15) from FAGENT where fa01=substr(T29,1,8) and fa02='0')" & _
               ",T26=(select fa69 from FAGENT where fa01=substr(T29,1,8) and fa02='0')" & _
               " where T05='" & strFrmNm & "' and T14='" & strUserNum & "' and T29 is not null and substr(T29,1,1)='Y'"
   cnnConnection.Execute strExc(0), intI
   
   '********************************
   'T19.會計師姓名   A4902 (30)
   'T20.會計師信箱   A4905 (100)
   'T21.會計備註     A4914 (200)
   'T27.會計師事務所 A4912 (30)
   'T28.會計師電話   A4903 (20)
   '********************************
   '更新會計師資料
   strExc(0) = "update ACCTMP44q0 set T19=(select A4902 from ACC490 where A4901=decode(T29,'T',T15,T29))" & _
               ",T20=(select A4905 from ACC490 where A4901=decode(T29,'T',T15,T29))" & _
               ",T21=(select A4914 from ACC490 where A4901=decode(T29,'T',T15,T29))" & _
               ",T27=(select A4912 from ACC490 where A4901=decode(T29,'T',T15,T29))" & _
               ",T28=(select A4903 from ACC490 where A4901=decode(T29,'T',T15,T29))" & _
               " where T05='" & strFrmNm & "' and T14='" & strUserNum & "' and T29 is not null"
   cnnConnection.Execute strExc(0), intI
   
   If strType = 1 Then '扣繳收據抬頭檢查清單
      '刪除 不可扣繳 是境外公司
      strExc(0) = "delete from ACCTMP44q0 where T05='" & strFrmNm & "' and T14='" & strUserNum & "' and T24='1' and T25='Y'"
      cnnConnection.Execute strExc(0), intI
      '刪除 可扣繳 不是境外公司
      strExc(0) = "delete from ACCTMP44q0 where T05='" & strFrmNm & "' and T14='" & strUserNum & "' and T24='2' and T25 is null"
      cnnConnection.Execute strExc(0), intI
   End If
   
   Screen.MousePointer = vbDefault
   Set rsRD = Nothing
End Sub

'Add by Amy 2025/06/27 顯示相關案
'intCType:0-抓全部 /1-以申請案號 判斷 聯合案 或 衍生案 /2-國內外案件關聯 (CaseMap) /3-分割案 (DivisionCase) /4-相關卷號 (CaseRelation1)
'                 9-相關案件(呼叫DB 程序DB_R100101_H)
Public Function ChkCaseRelation(intCType As Integer, stFormN As String, stCaseNo1 As String, stCaseNo2 As String, stCaseNo3 As String, stCaseNo4 As String _
, ByRef stMsg As String) As Boolean
    Dim RsQ As New ADODB.Recordset, stQ As String, intQ As Integer, intGetWord As Integer, bolRunDB_R100101_H As Boolean
    Dim stFixMsg As String, stQCM10 As String, stPA11 As String, stTmp As String
      
   Select Case UCase(stFormN)
      Case "FRM210133_F" 'FC結案單-承辦用
         '抓 關聯案、衍生案、分割案、一案兩請、香港案、澳門案
         stQCM10 = "'0','3','4','5','6'"
         stFixMsg = "此案號(" & stCaseNo1 & "-" & stCaseNo2 & IIf(stCaseNo3 & stCaseNo4 <> "000", stCaseNo3 & "-" & stCaseNo4, "") & ") 有相關案件如下：" & vbCrLf
   End Select
   
   ChkCaseRelation = False
   stMsg = ""
   If stCaseNo1 & stCaseNo2 = "" Then Exit Function
   
   'ex:查 CFP-020655 會抓不到P-085790 (因都由FCP-034693案產生的關聯),故參考frm100101_2 「相關卷號」鈕顯示方式,來判斷如何抓相關案
   If ChkDataByCR(stCaseNo1 & "-" & stCaseNo2 & "-" & stCaseNo3 & "-" & stCaseNo4) = False Then
      bolRunDB_R100101_H = True
   End If
   
   If bolRunDB_R100101_H = False Then
'*** 以 申請案號 抓 聯合案 或 衍生案 ***
      If intCType = 0 Or intCType = 1 Then
         stQ = "Select PA11 From Patent Where pa01='" & stCaseNo1 & "' And pa02='" & stCaseNo2 & "' And pa03='" & stCaseNo3 & "' And pa04='" & stCaseNo4 & "' "
         intQ = 1
         Set RsQ = ClsLawReadRstMsg(intQ, stQ)
         If intQ = 1 Then
            stPA11 = "" & RsQ.Fields("PA11")
         End If
         If intCType = 1 And stPA11 = "" Then Exit Function
         
         intGetWord = InStr(stPA11, "U")
         
         If intGetWord > 1 Then
            '只取官方給的申請案號 ex:申請案號 093308155 (FCP-031489) / 093308155U01 (FCP-031490)
            '                                                               100305828D01 (FCP-047144) / 100305828D02 (FCP-047145)
            '                                                               101305188D01 (FCP-046229)
            stPA11 = Mid(stPA11, 1, intGetWord - 1)
         Else
            'ex:申請案號 U/000262 (P-122796)
            intGetWord = InStr(stPA11, "D")
            If intGetWord > 1 Then stPA11 = Mid(stPA11, 1, intGetWord - 1)
         End If
         
         stQ = ""
         '聯合案 U (ex:FCP-031489 及 FCP 031490)
         '衍生案 D (ex:FCP-061446 及 FCP-061447)
         If stPA11 <> "" Then
            stQ = "Select pa01,pa02,pa03,pa04,pa11 From Patent Where Instr(pa11,'" & stPA11 & "')>0  Order by Length(pa11) Desc"
            intQ = 1
            Set RsQ = ClsLawReadRstMsg(intQ, stQ)
            If intQ = 1 Then
               RsQ.MoveFirst
               If RsQ.RecordCount > 1 Then
                  ChkCaseRelation = True
                  Do While RsQ.EOF = False
                     If InStr("" & RsQ.Fields("pa11"), "U") > 0 And InStr(stTmp, "聯合案") = 0 Then
                        stTmp = "聯合案：" & vbCrLf
                     ElseIf InStr("" & RsQ.Fields("pa11"), "D") > 0 And InStr(stTmp, "衍生案") = 0 Then
                        stTmp = "衍生案：" & vbCrLf
                     End If
                     If RsQ.Fields("pa01") & RsQ.Fields("pa02") & RsQ.Fields("pa03") & RsQ.Fields("pa04") <> stCaseNo1 & stCaseNo2 & stCaseNo3 & stCaseNo4 Then
                        stTmp = stTmp & "　" & RsQ.Fields("pa01") & "-" & RsQ.Fields("pa02") & IIf(RsQ.Fields("pa03") & RsQ.Fields("pa04") <> "000", RsQ.Fields("pa03") & "-" & RsQ.Fields("pa04"), "")
                     End If
                     RsQ.MoveNext
                  Loop
               End If
            End If
         End If
      End If
     
'*** 2.國內外案件關聯 (CaseMap) ***
      If intCType = 0 Or intCType = 2 Then
      'CM10: 0 國內外案件 / 1: 美國IDS / 2: 大陸發明 / 3.一案二申請 / 4.香港大陸 / 5.澳門大陸 / 6.擬制喪失新穎性
        '一案兩請, 香港案, 澳門案 (ex:FCP-069755)
        stQ = "Select cm05 as pa01,cm06 as pa02,cm07 as pa03,cm08 as pa04,'2'||cm10 as Sort From CaseMap Where cm10 in (" & stQCM10 & ") And cm01='" & stCaseNo1 & "' And cm02='" & stCaseNo2 & "' And cm03='" & stCaseNo3 & "' And cm04='" & stCaseNo4 & "' " & _
      " Union Select cm01 as pa01,cm02 as pa02,cm03 as pa03,cm04 as pa04,'2'||cm10 as Sort From CaseMap Where cm10 in (" & stQCM10 & ") And cm05='" & stCaseNo1 & "' And cm06='" & stCaseNo2 & "' And cm07='" & stCaseNo3 & "' And cm08='" & stCaseNo4 & "' "
      End If
   
'*** 3.分割案 (DivisionCase) ex:FCP-061444 母案 及FCP-071759 子案 ***
      If intCType = 0 Or intCType = 3 Then
         If stQ <> "" Then stQ = stQ & " Union "
         stQ = stQ & "Select dc05 as pa01,dc06 as pa02,dc07 as pa03,dc08 as pa04,'3' as Sort From DivisionCase Where dc01='" & stCaseNo1 & "' And dc02='" & stCaseNo2 & "' And dc03='" & stCaseNo3 & "' And dc04='" & stCaseNo4 & "' " & _
                   " Union Select dc01 as pa01,dc02 as pa02,dc03 as pa03,dc04 as pa04,'3' as Sort From DivisionCase Where dc05='" & stCaseNo1 & "' And dc06='" & stCaseNo2 & "' And dc07='" & stCaseNo3 & "' And dc08='" & stCaseNo4 & "' "
      End If
      
'*** 4.相關卷號 (CaseRelation1) ex:FCP-061446 ***
      If intCType = 0 Or intCType = 4 Then
         If stQ <> "" Then stQ = stQ & " Union "
         stQ = stQ & "Select cr05 as pa01,cr06 as pa02,cr07 as pa03,cr08 as pa04,'4' as Sort From CaseRelation1 Where cr01='" & stCaseNo1 & "' And cr02='" & stCaseNo2 & "' And cr03='" & stCaseNo3 & "' And cr04='" & stCaseNo4 & "' " & _
                   " Union Select cr01 as pa01,cr02 as pa02,cr03 as pa03,cr04 as pa04,'4' as Sort From CaseRelation1 Where cr05='" & stCaseNo1 & "' And cr06='" & stCaseNo2 & "' And cr07='" & stCaseNo3 & "' And cr08='" & stCaseNo4 & "' "
      End If
   
   Else
'*** 9.相關案件 ex:CFP-020655 ***
      If intCType = 0 Or intCType = 9 Then
         cnnConnection.Execute "delete from r100101_h where id='" & strUserNum & "' "
         cnnConnection.Execute "insert into r100101_h select '" & stCaseNo1 & "','" & stCaseNo2 & "','" & stCaseNo3 & "','" & stCaseNo4 & "',0,'1','" & strUserNum & "' from dual "
         cnnConnection.Execute "insert into r100101_h select '" & stCaseNo1 & "','" & stCaseNo2 & "','" & stCaseNo3 & "','" & stCaseNo4 & "',0,'2','" & strUserNum & "' from dual "
         cnnConnection.Execute "begin   db_r100101_h('" & strUserNum & "'); end;"
         stQ = "Select R001001 as pa01,R001002 as pa02,R001003 as pa03,R001004 as pa04,'9' as Sort From R100101_H Where ID='" & strUserNum & "' And R001001 is not null "
      End If
   End If
   
   stQ = "Select Distinct pa01,pa02,pa03,pa04,Sort From (" & stQ & ") Where pa01||pa02||pa03||pa04<>'" & stCaseNo1 & stCaseNo2 & stCaseNo3 & stCaseNo4 & "' "
   stQ = stQ & " Order by Sort,pa01,pa02,pa03,pa04 "
               
   intQ = 1
   Set RsQ = ClsLawReadRstMsg(intQ, stQ)
   If intQ = 1 Then
      ChkCaseRelation = True
      RsQ.MoveFirst
      Do While RsQ.EOF = False
         Select Case "" & RsQ.Fields("Sort")
            Case "20"
               If InStr(stTmp, "國內外案件") = 0 Then
                  stTmp = stTmp & "國內外案件：" & vbCrLf
               End If
            Case "21"
               If InStr(stTmp, "美國IDS") = 0 Then
                  stTmp = stTmp & "美國IDS：" & vbCrLf
               End If
            Case "22"
               If InStr(stTmp, "大陸發明") = 0 Then
                  stTmp = stTmp & "大陸發明：" & vbCrLf
               End If
            Case "23"
               If InStr(stTmp, "一案二請") = 0 Then
                  stTmp = stTmp & "一案二請：" & vbCrLf
               End If
            Case "24"
               If InStr(stTmp, "香港案") = 0 Then
                  stTmp = stTmp & "香港案：" & vbCrLf
               End If
            Case "25"
               If InStr(stTmp, "澳門案") = 0 Then
                  stTmp = stTmp & "澳門案：" & vbCrLf
               End If
            Case "26"
               If InStr(stTmp, "喪失新穎性") = 0 Then
                  stTmp = stTmp & "喪失新穎性：" & vbCrLf
               End If
            Case "3"
               If InStr(stTmp, "分割案") = 0 Then
                  stTmp = stTmp & "分割案：" & vbCrLf
               End If
            Case "4"
               If InStr(stTmp, "相關卷號") = 0 Then
                  stTmp = "相關卷號：" & vbCrLf
               End If
            Case "9"
               '相關案件
         End Select
         stTmp = stTmp & "　" & RsQ.Fields("pa01") & "-" & RsQ.Fields("pa02") & IIf(RsQ.Fields("pa03") & RsQ.Fields("pa04") <> "000", RsQ.Fields("pa03") & "-" & RsQ.Fields("pa04"), "") & vbCrLf
         RsQ.MoveNext
      Loop
   End If
   If stTmp <> "" Then stMsg = stFixMsg & stTmp
   Set RsQ = Nothing
End Function

'Added by Morgan 2025/7/18
'設定檔案修改時間
Public Function PUB_SetFileTime(pFile As String, pDateTime As String, Optional pShowErr As Boolean = False) As Boolean
   Dim oFilObj As FileSystemObject
   Dim tZone As TIME_ZONE_INFORMATION
   Dim writedate As Date
   Dim bias As Long
   Dim ft As SYSTEMTIME
   Dim hFile As Long
   Dim ofs As OFSTRUCT
   Dim lplwr As FILETIME
   Const OF_READWRITE = &H2

On Error GoTo ErrHnd

   Set oFilObj = New FileSystemObject
   Call GetTimeZoneInformation(tZone)
   bias = tZone.bias
   writedate = CDate(Format(pDateTime, "@@@@/@@/@@ @@:@@:@@")) + TimeSerial(0, bias, 0)
   ft.wYear = Year(writedate)
   ft.wMonth = Month(writedate)
   ft.wDay = Day(writedate)
   ft.wHour = Hour(writedate)
   ft.wMinute = Minute(writedate)
   ft.wSecond = Second(writedate)

   hFile = OpenFile(pFile, ofs, OF_READWRITE)
   Call SystemTimeToFileTime(ft, lplwr)
   Call SetFileTime(hFile, ByVal 0, ByVal 0, lplwr)  '只更改第三個(最後寫入)時間
   Call CloseHandle(hFile) '關閉檔案
   PUB_SetFileTime = True
   
ErrHnd:
   If Err.Number <> 0 Then
      If pShowErr Then MsgBox Err.Description, vbCritical
   End If
   
   Set oFilObj = Nothing
End Function


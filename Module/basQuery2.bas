Attribute VB_Name = "basQuery2"
'Create By Amy 2023/10/13
Option Explicit

Private Declare Function GetModuleFileName Lib "kernel32" Alias "GetModuleFileNameA" (ByVal hModule As Long, ByVal lpFileName As String, ByVal nSize As Long) As Long
Private Declare Function gethostname Lib "WSOCK32.DLL" (ByVal Name As String, ByVal namelen As Integer) As Integer
'Added by Lydia 2025/09/17 代理人案件統計和來訪資料Word排除統計的案件性質
Public Const cntFAnotCP10tot As String = "'P411','P902','P907','P913','P925','P937','P954','CFP411','CFP902','CFP907','CFP913','CFP925','CFP937','CFP952','CFP953','CFP954','CFP997','CFP998','CFP999','FCP411','FCP902','FCP907','FCP913','FCP925','FCP937','T305','T703','T704','T718','T720','T726','TF305','TF703','TF704','TF718','TF726','TF997','TF998','CFT305','CFT703','CFT704','CFT718','CFT720','CFT726','CFT901','CFT997','CFT998','FCT305','FCT703','FCT704','FCT718','FCT720','FCT726','FCT901'"

'取得本案期限
Public Sub GetCaseDeadLineData(ByRef grdTemp As MSHFlexGrid, ByRef intLastRow As Integer, ByRef strCode1 As String, ByRef strCode2 As String, ByRef strCode3 As String, ByRef strCode4 As String, Optional strCode5 As String, Optional bolContinueBlank As Boolean = False)
Dim varSaveCursor, varGridWidth() As Variant

varSaveCursor = Screen.MousePointer
Screen.MousePointer = vbHourglass
varGridWidth = Array(300, 1350, 900, 900, 1200, 1200, 1200, 1000)
SetGridDataListWidth grdTemp, varGridWidth()
If strCode1 = 馬德里案 Then
   'edit by nickc 2007/02/02 不用 dll 了
   'Set grdTemp.Recordset = objPublicData.ReadCaseDeadLineRst(strCode1, strCode2 + IIf(strCode3 = "", "0", strCode3), _
           IIf(strCode4 = "", "0", strCode4), IIf(strCode5 = "", "00", strCode5), bolContinueBlank)
   Set grdTemp.Recordset = ClsPDReadCaseDeadLineRst(strCode1, strCode2 + IIf(strCode3 = "", "0", strCode3), _
           IIf(strCode4 = "", "0", strCode4), IIf(strCode5 = "", "00", strCode5), bolContinueBlank)

Else
   'edit by nickc 2007/02/02 不用 dll 了
   'Set grdTemp.Recordset = objPublicData.ReadCaseDeadLineRst(strCode1, strCode2, _
        IIf(strCode3 = "", "0", strCode3), IIf(strCode4 = "", "00", strCode4), bolContinueBlank)
   Set grdTemp.Recordset = ClsPDReadCaseDeadLineRst(strCode1, strCode2, _
        IIf(strCode3 = "", "0", strCode3), IIf(strCode4 = "", "00", strCode4), bolContinueBlank)

End If
SetDataListVision grdTemp, True
intLastRow = 0
If grdTemp.Rows > 1 Then
   'Modify By Cheng 2002/03/06
'   ShowBar grdTemp, intLastRow, 7
   ShowBar grdTemp, intLastRow, grdTemp.Cols - 1
End If
Screen.MousePointer = varSaveCursor
End Sub

'Update:True 更新 False:新增
Public Function GetSPSQL(sp() As String, Optional UPDATE As Boolean = True) As String
 Dim i As Integer, strTmp As String, strTmp1 As String
   sp(10) = TransDate(sp(10), 2)
   sp(12) = TransDate(sp(12), 2)
   sp(16) = TransDate(sp(16), 2)
   sp(20) = TransDate(sp(20), 2)
   sp(21) = TransDate(sp(21), 2)
   sp(39) = TransDate(sp(39), 2)
   sp(40) = TransDate(sp(40), 2)
   
   sp(8) = ChangeCustomerL(sp(8))
   sp(26) = ChangeCustomerL(sp(26))
   sp(35) = ChangeCustomerL(sp(35))
   sp(37) = ChangeCustomerL(sp(37))
   sp(65) = ChangeCustomerL(sp(65))
   sp(66) = ChangeCustomerL(sp(66))
   
   GetSPSQL = ""
   For i = 1 To tf_SP 'edit by nickc 2006/07/12 T_SP
      Select Case i
         Case 52, 53, 54, 55, 56, 57
         Case Else
            GetSPSQL = GetSPSQL + "sp" + Format(i, "00") + "=" + CNULL(ChgSQL(sp(i))) + ","
            If Not UPDATE Then
               strTmp = strTmp & "SP" & Format(i, "00") & ","
               strTmp1 = strTmp1 & CNULL(ChgSQL(sp(i))) & ","
            End If
      End Select
   Next
   
   If UPDATE Then
      GetSPSQL = Left(GetSPSQL, Len(GetSPSQL) - 1)
      GetSPSQL = "update servicepractice set " & GetSPSQL & " where sp01=" + CNULL(sp(1)) + " and sp02=" + CNULL(sp(2)) + _
         " and sp03=" + CNULL(sp(3)) + " and sp04=" + CNULL(sp(4))
   Else
      strTmp = Left(strTmp, Len(strTmp) - 1)
      strTmp1 = Left(strTmp1, Len(strTmp1) - 1)
      GetSPSQL = "insert into servicepractice (" & strTmp & ") values (" & strTmp1 & ")"
   End If
End Function

'將前一畫面之Combo（中英文名稱）設給現在之畫面
'Modify By Sindy 2021/7/16 改為用 Object 型態
'Public Sub SetComboToCombo(ByRef cboTemp1 As ComboBox, ByRef cboTemp2 As ComboBox)
Public Sub SetComboToCombo(ByRef cboTemp1 As Object, ByRef cboTemp2 As Object)
Dim i As Integer

cboTemp1.Clear
For i = 0 To cboTemp2.ListCount - 1
       cboTemp1.AddItem cboTemp2.List(i)
Next
If cboTemp1.ListCount > 0 Then cboTemp1.ListIndex = 0
End Sub

Public Function PUB_GetPatentKindName(strPTM02, strNANO As String) As String
'strPTM02 : 專利種類代號
'strNANO : 國家代號
Dim rsA As New ADODB.Recordset
Dim StrSQLa As String

PUB_GetPatentKindName = ""
If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing
StrSQLa = "Select PTM03,PTM04 From PatentTrademarkMap Where PTm01='1' And PTM02='" & strPTM02 & "'"
rsA.CursorLocation = adUseClient
rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
If rsA.RecordCount > 0 Then
   Select Case strNANO
   Case 台灣國家代號
      PUB_GetPatentKindName = "" & rsA.Fields(0).Value
   Case Else
      PUB_GetPatentKindName = "" & rsA.Fields(1).Value
   End Select
End If
If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing
End Function

'讀取國外案件關聯表之資料
'iSitu 0 國內外案件資料維護資料 1 讀取美國IDS資料 2 大陸發明
'Modify by Morgan 2004/10/29 加國家,點數
'Modify by Morgan 2004/12/27 加發文日
'Modify by Morgan 2005/3/15 加收文號，案件性質，申請國代碼
Public Function GetCaseRelationDataOut(ByRef strCode1 As String, ByRef strCode2 As String, _
   ByRef strCode3 As String, ByRef strCode4 As String, ByRef strPromoter As String, _
   Optional ByVal iSitu As Integer = 0, Optional strSales As String, Optional ByRef strCountry As String, Optional ByRef strPoint As String, Optional ByRef strCP27 As String, Optional ByRef strCP09 As String, Optional ByRef strCP10 As String, Optional ByRef strPA09 As String) As Boolean
   
On Error GoTo ErrHand

    Dim strSql As String, rsRecordset As New ADODB.Recordset, strWhich As String
    
    Select Case iSitu
      Case 0
         strWhich = "國外"
      Case 1
         strWhich = "美國"
      Case 2
         strWhich = "大陸"
      'add by nickc 2005/06/28
      Case 4
         strWhich = "香港"
      'Added by Lydia 2015/07/27 +澳門
      Case 5
         strWhich = "澳門"
    End Select
    
    strPromoter = ""
    strSales = ""
    
    strCode3 = IIf(strCode3 = "", "0", strCode3)
    strCode4 = IIf(strCode4 = "", "00", strCode4)
    'Modify by Morgan 2004/10/29 加國家,點數
    'Modify by Morgan 2005/3/15 加收文號,案件性質
    'edit by nickc 2005/06/28
    If iSitu <> 4 Then
      'Modify by Morgan 2006/1/19 加 109 PCT申請
         '2006/3/7 MODIFY BY SONIA 加案件性質 110,112
         'Modify by Morgan 2006/4/14 案件性質改用常數控制
         strSql = "select s1.st02,s2.st02, na03,cp18,cp27,cp09,cp10,pa09 from caseprogress,staff s1,staff s2, patent, nation where " & _
            "cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and " & _
            "cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + _
            " and cp10 in (" & CaseMapOut & ") AND cp14=s1.st01(+) and cp13=s2.st01(+)" & _
            " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04 and na01(+)=pa09 order by cp09"
    Else
         strSql = "select s1.st02,s2.st02, na03,cp18,cp27,cp09,cp10,pa09 from caseprogress,staff s1,staff s2, patent, nation where " & _
            "cp01=" + CNULL(strCode1) + " and cp02=" + CNULL(strCode2) + " and " & _
            "cp03=" + CNULL(strCode3) + " and cp04=" + CNULL(strCode4) + _
            " and cp10 in ( '110','112' ) AND cp14=s1.st01(+) and cp13=s2.st01(+)" & _
            " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04 and na01(+)=pa09 order by cp09"
   End If
       
       
    rsRecordset.CursorLocation = adUseClient
    rsRecordset.Open strSql, cnnConnection, adOpenDynamic
    
    If Not rsRecordset.EOF And Not rsRecordset.BOF Then
       If Not IsNull(rsRecordset.Fields(0)) Then strPromoter = rsRecordset.Fields(0)
       If Not IsNull(rsRecordset.Fields(1)) Then strSales = rsRecordset.Fields(1)
       strCountry = "" & rsRecordset.Fields("na03"): strPoint = "" & rsRecordset.Fields("cp18") 'Add by Morgan 2004/10/29
       strCP27 = "" & rsRecordset.Fields("cp27") 'Add by Morgan 2004/12/27
       strCP09 = "" & rsRecordset.Fields("cp09") 'Add by Morgan 2005/3/15
       strCP10 = "" & rsRecordset.Fields("cp10") 'Add by Morgan 2005/3/15
       strPA09 = "" & rsRecordset.Fields("pa09") 'Add by Morgan 2005/3/15
       GetCaseRelationDataOut = True
    Else
       ShowMsg strWhich + MsgText(1010)
    End If
    Exit Function
ErrHand:
    ShowMsg MsgText(1008)
End Function

'add by nick 2004/07/12 從 GetCustomer 改增加狀態
'取得客戶名稱(中英日任一),郵遞區號,地址(中英日任一),狀態
'Modify By Sindy 2014/12/2 +Optional ByLoginUserReadName As Boolean
'Modify By Sindy 2015/8/27 +Optional strCP01 As String
'Modify By Sindy 2021/2/1 + , Optional ByRef strRefState As String : 回傳狀態； 前畫面需要寄信時才能判斷。
'                         + , Optional bolOldCase As Boolean = False : 是否舊案收文； 為新案才要彈訊息，不可收文。
'Modify by Amy 2022/03/10 +Optional stFormN as string=""
'Modified by Lydia 2022/09/02 修改ByRef strCustomer=> ByVal strCustomer
'Public Function GetCustomerAndState(ByRef strCustomer As String, ByRef strCustomerName As String, _
                                    Optional ByRef strZipCode As String, Optional ByRef strAddress As String, _
                                    Optional ByLoginUserReadName As Boolean = False, _
                                    Optional strCP01 As String = "", Optional ByRef strRefState As String, _
                                    Optional bolOldCase As Boolean = False, Optional stFormN As String = "") As Boolean
'Modified by Lydia 2023/03/06 + strCP02, strCP03, strCP04
'Modify By Sindy 2025/3/26 +Optional ByVal strCP10 As String: 欲收文的案件性質
Public Function GetCustomerAndState(ByVal strCustomer As String, ByRef strCustomerName As String, _
                                    Optional ByRef strZipCode As String, Optional ByRef strAddress As String, _
                                    Optional ByVal ByLoginUserReadName As Boolean = False, _
                                    Optional ByVal strCP01 As String = "", Optional ByRef strRefState As String, _
                                    Optional ByVal bolOldCase As Boolean = False, Optional ByVal stFormN As String = "", _
                                    Optional ByVal strCP02 As String = "", Optional ByVal strCP03 As String = "", _
                                    Optional ByVal strCP04 As String = "", Optional ByVal strCP10 As String) As Boolean
Dim mStrSql As String, rsRecordset As New ADODB.Recordset
'add by nick 2004/07/21
Dim strState As String
Dim bolFUser As Boolean 'Add By Sindy 2014/12/2
Dim strSysCode As String 'Add By Sindy 2015/8/27
Dim strMsgFix As String, strMsg As String 'Add by Amy 2022/03/10
Dim strB1 As String 'Added by Lydia 2023/03/06
'Dim intCaseKind As Integer 'Add By Sindy 2025/3/26
'Dim strApplTitName 'Add By Sindy 2025/3/31

On Error GoTo ErrHand
   
   GetCustomerAndState = False
   
   'Add By Sindy 2014/12/2
   If ByLoginUserReadName = True Then '依操作者的部門判斷
      'FXX者帶英->中->日
      If Left(Pub_StrUserSt03, 1) = "F" Then
         bolFUser = True
      '非FXX者帶中->英->日
      Else
         bolFUser = False
      End If
   End If
   '2014/12/2 END
   
   strCustomer = ChangeCustomerL(strCustomer)
   If Left(strCustomer, 1) = 客戶編號 Then
      'Add By Sindy 2014/12/2
      If ByLoginUserReadName = True And bolFUser = True Then
         '英->中->日
         mStrSql = "select cu01||cu02,nvl(cu05||' '||cu88||' '||cu89||' '||cu90,nvl(cu04,cu06)),cu30," & _
                  "NVL(CU23,DECODE(CU24,NULL,CU29,CU24||' '||CU25||' '||CU26||' '||CU27||' '||CU28||' '||cu102)),'',cu80 " & _
                  "from customer where " & ChgCustomer(strCustomer) & " order by cu01,cu02"
      Else
      '2014/12/2 END
         '中->英->日
         mStrSql = "select cu01||cu02,nvl(cu04,nvl(cu05||' '||cu88||' '||cu89||' '||cu90,cu06)),cu30," & _
                  "NVL(CU23,DECODE(CU24,NULL,CU29,CU24||' '||CU25||' '||CU26||' '||CU27||' '||CU28||' '||cu102)),'',cu80 " & _
                  "from customer where " & ChgCustomer(strCustomer) & " order by cu01,cu02"
      End If
   ElseIf Left(strCustomer, 1) = 代理人編號 Then
      'Add By Sindy 2014/12/2
      If ByLoginUserReadName = True And bolFUser = True Then
         '英->中->日
         mStrSql = "select fa01||fa02,nvl(cu05||' '||cu88||' '||cu89||' '||cu90,nvl(cu04,cu06)),cu30," & _
                  "NVL(CU23,DECODE(CU24,NULL,CU29,CU24||' '||CU25||' '||CU26||' '||CU27||' '||CU28||' '||cu102))," & _
                  "cu01||cu02,cu80 from customer,fagent where cu01=fa03 and " & ChgFagent(strCustomer) & _
                  " order by cu01,cu02"
      Else
      '2014/12/2 END
         '中->英->日
         mStrSql = "select fa01||fa02,nvl(cu04,nvl(cu05||' '||cu88||' '||cu89||' '||cu90,cu06)),cu30," & _
                  "NVL(CU23,DECODE(CU24,NULL,CU29,CU24||' '||CU25||' '||CU26||' '||CU27||' '||CU28||' '||cu102))," & _
                  "cu01||cu02,cu80 from customer,fagent where cu01=fa03 and " & ChgFagent(strCustomer) & _
                  " order by cu01,cu02"
      End If
   Else
      MsgBox MsgText(9151), , MsgText(5)
      Exit Function
   End If
   strCustomerName = ""
   strZipCode = ""
   strAddress = ""
   strState = "": strRefState = ""
   strMsgFix = "": strMsg = "" 'Add by Amy 2022/03/10
   rsRecordset.CursorLocation = adUseClient
   rsRecordset.Open mStrSql, cnnConnection
   If rsRecordset.RecordCount > 0 Then
      If rsRecordset.Fields(0) = strCustomer Then
         If Left(strCustomer, 1) = 代理人編號 Then strCustomer = rsRecordset.Fields(4)
         strCustomer = ChangeCustomerS(strCustomer)
         If Not IsNull(rsRecordset.Fields(1)) Then strCustomerName = rsRecordset.Fields(1)
         If Not IsNull(rsRecordset.Fields(2)) Then strZipCode = rsRecordset.Fields(2)
         If Not IsNull(rsRecordset.Fields(3)) Then strAddress = rsRecordset.Fields(3)
         strSysCode = CheckSys(strCP01) 'Add By Sindy 2015/8/27
'         'Add By Sindy 2025/3/31
'         If (strCP10 = 移轉 And strSysCode Mod 4 = 商標) Or _
'            ((strCP10 = 讓與 Or strCP10 = 專利權讓與 Or strCP10 = 合併 Or strCP10 = 繼承) And strSysCode Mod 4 = 專利) Then
'            strApplTitName = GetPrjState6(strCP01, strCP10) & "申請人"
'         Else
'            strApplTitName = "申請人"
'         End If
'         '2025/3/31 END
         
         'Added by Lydia 2024/06/13 以操作者判斷可使用的系統;
         If strSysCode = "" Then
            strB1 = PUB_GetST93(strUserNum)
            If Left(strB1, 1) = "F" Or Left(strB1, 1) = "J" Or Left(strB1, 1) = "P" Then
               strSysCode = "1"
            ElseIf Left(strB1, 1) = "T" Then
               strSysCode = "2"
            End If
         End If
         'end 2024/06/13
         'add by nick 2004/07/21
         If Not IsNull(rsRecordset.Fields(5)) Then strState = rsRecordset.Fields(5)
         'Modify by Amy 2022/03/10 +strMsg,針對接洽單顯示不同訊息
         'Modify By Sindy 2022/9/16 + frm090801_New
         If UCase(stFormN) = UCase("frm090801") Or UCase(stFormN) = UCase("frm090801_New") Then
            strMsgFix = "申請人 " & rsRecordset.Fields(0) & " (" & rsRecordset.Fields(1) & ")" & vbCrLf
         End If
         If Trim(strState) = "不再使用" Then
            strRefState = strState
            strMsg = "此申請人資料已不再使用，請確認！！"
            'Modify By Sindy 2022/9/16 + frm090801_New
            If UCase(stFormN) = UCase("frm090801") Or UCase(stFormN) = UCase("frm090801_New") Then
                strMsg = Replace(strMsg, "此申請人", strMsgFix)
            End If
            MsgBox strMsg, , MsgText(5)
            Exit Function
         'Add by Amy 2022/03/10
         ElseIf Trim(strState) = "設為對造" Then
            'Added by Lydia 2023/03/06 OpenCase僅存本所案號的四個欄位，存在於此Table的案號，不受客戶狀態為「設為對造」的限制。
            If strCP02 <> "" Then
               If ClsPDCheckCaseCodeIsExist(strCP01, strCP02, strCP03, strCP04, , , , , strB1) = True Then
                  If strCP01 = "CFP" And strB1 = "221" Then
                     '系統類別為CFP且申請國家為EPC(221)者檢查本所案號的前三欄
                     mStrSql = "OC01='" & strCP01 & "' AND OC02='" & strCP02 & "' AND OC03='" & strCP03 & "' "
                  ElseIf strCP01 = "TF" Then
                     'TF者檢查本所案號之前二欄，但第二欄只檢查前5碼
                     mStrSql = "OC01='" & strCP01 & "' AND SUBSTR(OC02,1,5)='" & Left(strCP02, 5) & "' "
                  Else
                     '其他情形檢查本所案號四個欄位必須相同才能開放
                     mStrSql = "OC01='" & strCP01 & "' AND OC02='" & strCP02 & "' AND OC03='" & strCP03 & "' AND OC04='" & strCP04 & "'"
                  End If
                  mStrSql = "Select * from OpenCase Where " & mStrSql
                  If rsRecordset.State <> adStateClosed Then rsRecordset.Close
                  rsRecordset.CursorLocation = adUseClient
                  rsRecordset.Open mStrSql, cnnConnection
                  If rsRecordset.RecordCount > 0 Then
                     strState = ""
                  End If
               End If
            End If
            If Trim(strState) <> "" Then
            'end 2023/03/06
               strRefState = strState
               strMsg = "此申請人資料已被設為對造，請確認！！"
               'Modify By Sindy 2022/9/16 + frm090801_New
               If UCase(stFormN) = UCase("frm090801") Or UCase(stFormN) = UCase("frm090801_New") Then
                   strMsg = Replace(strMsg, "此申請人", strMsgFix)
               End If
               MsgBox strMsg, , MsgText(5)
               Exit Function
            End If 'Added by Lydia 2023/03/06
'         'Modify By Sindy 2015/8/27
'         ElseIf Trim(strState) = "不得代理" Then
'              MsgBox "此申請人資料不得代理，請確認！！", , MsgText(5)
'              Exit Function
'         ElseIf (strSysCode = "2" Or strSysCode = "6") And Trim(strState) = "不得代理商標" Then
'              MsgBox "此申請人資料不得代理商標，請確認！！", , MsgText(5)
'              Exit Function
'         ElseIf (strSysCode = "1" Or strSysCode = "5") And Trim(strState) = "不得代理專利" Then
'              MsgBox "此申請人資料不得代理專利，請確認！！", , MsgText(5)
'              Exit Function
'         '2015/8/27 END
         'Modify By Sindy 2021/2/1 是否舊案收文； 為新案才要彈訊息，不可收文。
         Else
            'Add By Sindy 2025/3/26 雖然是舊案但是若為專利的701讓與(708專利權讓與)或商標的501移轉時，
            '    若受讓人的5個編號為不得代理的客戶編號，而該編號又不存在於原申請人中，
            '    此時這種情形對不得代理的客戶來說是新案號，所以應控制不可收文。
            If bolOldCase = True Then
               'If ClsPDGetSystemKind(strCP01, intCaseKind) = True Then
                  If (strCP10 = 移轉 And strSysCode Mod 4 = 商標) Or _
                     ((strCP10 = 讓與 Or strCP10 = 專利權讓與 Or strCP10 = 合併 Or strCP10 = 繼承) And strSysCode Mod 4 = 專利) Then
                     strSql = "select pa05,pa06,pa07 from patent" & _
                              " where pa01=" & CNULL(strCP01) & " and pa02=" & CNULL(strCP02) & _
                              " and pa03=" & CNULL(strCP03) & " and pa04=" & CNULL(strCP04) & _
                              " and instr(pa26||pa27||pa28||pa29||pa30,'" & strCustomer & "')=0"
                     strSql = strSql & " union select tm05,tm06,tm07 from trademark" & _
                              " where tm01=" & CNULL(strCP01) & " and tm02=" & CNULL(strCP02) & _
                              " and tm03=" & CNULL(strCP03) & " and tm04=" & CNULL(strCP04) & _
                              " and instr(tm23||tm78||tm79||tm80||tm81,'" & strCustomer & "')=0"
                     strSql = strSql & " union select sp05,sp06,sp07 from servicepractice" & _
                              " where sp01=" & CNULL(strCP01) & " and sp02=" & CNULL(strCP02) & _
                              " and sp03=" & CNULL(strCP03) & " and sp04=" & CNULL(strCP04) & _
                              " and instr(sp08||sp58||sp59||sp65||sp66,'" & strCustomer & "')=0"
                     intI = 1
                     Set RsTemp = ClsLawReadRstMsg(intI, strSql)
                     If intI = 1 Then
                        bolOldCase = False
                     End If
                  End If
               'End If
            End If
            '2025/3/26 END
            If Trim(strState) = "不得代理" Then
               strRefState = strState
               If bolOldCase = False Then
                  strMsg = "此申請人資料不得代理，請確認！！"
                  'Modify By Sindy 2022/9/16 + frm090801_New
                  If UCase(stFormN) = UCase("frm090801") Or UCase(stFormN) = UCase("frm090801_New") Then
                      strMsg = Replace(strMsg, "此申請人", strMsgFix)
                  End If
                  MsgBox strMsg, , MsgText(5)
                  Exit Function
               End If
            ElseIf (strSysCode = "2" Or strSysCode = "6") And Trim(strState) = "不得代理商標" Then
               strRefState = strState
               If bolOldCase = False Then
                  strMsg = "此申請人資料不得代理商標，請確認！！"
                  'Modify By Sindy 2022/9/16 + frm090801_New
                  If UCase(stFormN) = UCase("frm090801") Or UCase(stFormN) = UCase("frm090801_New") Then
                      strMsg = Replace(strMsg, "此申請人", strMsgFix)
                  End If
                  MsgBox strMsg, , MsgText(5)
                  Exit Function
               End If
            ElseIf (strSysCode = "1" Or strSysCode = "5") And Trim(strState) = "不得代理專利" Then
               strRefState = strState
               If bolOldCase = False Then
                  strMsg = "此申請人資料不得代理專利，請確認！！"
                  'Modify By Sindy 2022/9/16 + frm090801_New
                  If UCase(stFormN) = UCase("frm090801") Or UCase(stFormN) = UCase("frm090801_New") Then
                      strMsg = Replace(strMsg, "此申請人", strMsgFix)
                  End If
                  MsgBox strMsg, , MsgText(5)
                  Exit Function
               End If
            End If
         End If
         '2021/2/1 END
      End If
      GetCustomerAndState = True
   Else
      MsgBox MsgText(9151), , MsgText(5)
   End If
   rsRecordset.Close
   Exit Function
ErrHand:
   If Err.Number = 0 Then
      Exit Function
   End If
   MsgBox Err.Description, , MsgText(5)
End Function

Public Sub FixGrid(ByRef grdTemp As MSHFlexGrid)
 Dim intLastHeight As Integer
   If grdTemp.Rows > 1 Then
      intLastHeight = grdTemp.Height
      grdTemp.FixedRows = 0
      grdTemp.Height = 200
      grdTemp.TopRow = grdTemp.Rows - 1
      grdTemp.FixedRows = 1
      grdTemp.TopRow = 1
      grdTemp.Height = intLastHeight
   End If
End Sub

'Modified by Lydia 2017/11/15 + iCols 設定變色欄位數, iSingal 設定選取的標誌,iBcolor 選取列原本的顏色
'Modified by Lydia 2022/11/09 +iJumpCols 指定排除變色欄位數
Public Sub GridClick(GRDtmp As MSHFlexGrid, intRow As Integer, intCheck As Integer, Optional ByVal iSitu As Integer = 0, _
           Optional ByVal iCols As Integer = 0, Optional ByVal iSignal As String = "v", Optional ByVal iBcolor As Long = Empty, Optional ByVal iJumpCols As String)
'iSitu=0 單選(預設)，1 多選，2 多選並且變色(Added by Lydia 2024/05/22)
 Dim intK As Integer, intJ As Integer 'Memo by Lydia 2024/05/22 變數名稱i,j=>改為intK, intJ
 Dim mDefColor As Long 'Added by Lydia 2023/03/01
 
   With GRDtmp
      'Modify By Sindy 2016/1/28
      'If .row = 0 Then Exit Sub
      If .row = 0 Then intRow = 0: Exit Sub
      '2016/1/28 END
      
      'Added by Lydia 2017/11/15 設定變色欄位數
      If iCols = 0 Then
         iCols = .Cols
      End If
      'end 2017/11/15
      
      If iSitu = 0 Then
         If intRow = .row Then
            .col = 0
            If .CellBackColor = &HFFC0C0 Then
               For intK = 0 To iCols - 1
                  If InStr("," & iJumpCols & ",", "," & intK & ",") = 0 Then 'Added by Lydia 2022/11/09 指定排除變色欄位數
                     .col = intK
                     'Modified by Lydia 2017/11/15
                     '.CellBackColor = .BackColor
                     .CellBackColor = IIf(iBcolor = Empty, .BackColor, iBcolor)
                  End If   'Added by Lydia 2022/11/09
               Next
               'Modified by Lydia 2017/11/15
               'If .Cols >= intCheck Then .col = intCheck: .Text = ""
               If iCols >= intCheck Then .col = intCheck: .Text = ""
            Else
               For intK = 0 To iCols - 1
                  If InStr("," & iJumpCols & ",", "," & intK & ",") = 0 Then 'Added by Lydia 2022/11/09 指定排除變色欄位數
                      .col = intK
                      .CellBackColor = &HFFC0C0
                  End If 'Added by Lydia 2022/11/09
               Next
               'Modified by Lydia 2017/11/15
               'If .Cols >= intCheck Then .col = intCheck: .Text = "v"
               If iCols >= intCheck Then .col = intCheck: .Text = iSignal
            End If
         Else
            intRow = .row
            .Visible = False
            For intK = 1 To .Rows - 1
               .row = intK
               .col = 0
               'Modified by Lydia 2017/11/15
               'If .CellBackColor <> .BackColor Then
                  'For j = 0 To .Cols - 1
               'Modified by Lydia 2023/03/01 全部先回復原來的顏色
               'If .CellBackColor <> IIf(iBcolor = Empty, .BackColor, iBcolor) Then
               mDefColor = .CellBackColor
               If iCols > 0 Then
                  If iCols + 1 > GRDtmp.Cols Then
                      .col = 0
                      mDefColor = IIf(iBcolor = Empty, .BackColor, iBcolor) 'Added by Lydia 2023/04/26 因為frm090908還原顏色有問題
                  Else
                      .col = iCols + 1
                      mDefColor = .CellBackColor 'Added by Lydia 2023/04/26 因為frm090908還原顏色有問題
                  End If
                  'Modified by Lydia 2023/03/16
                  'mDefColor = .CellBackColor
                  'Mark by Lydia 2023/04/26 因為frm090908還原顏色有問題
                  'mDefColor = IIf(iBcolor = Empty, .BackColor, iBcolor)
                  .col = 0
               End If
               If .CellBackColor <> mDefColor Then
               'end 2023/03/01
                  For intJ = 0 To iCols - 1
               'end 2017/11/15
                     .col = intJ
                     If intJ = intCheck Then .Text = ""
                     'Modified by Lydia 2017/11/15
                     '.CellBackColor = .BackColor
                     'Modified by Lydia 2024/02/17 debug ;  & intK & =>  & intJ &
                     If InStr("," & iJumpCols & ",", "," & intJ & ",") = 0 Then 'Added by Lydia 2022/11/09 指定排除變色欄位數
                         'Modified by Lydia 2023/03/01 全部先回復原來的顏色
                         '.CellBackColor = IIf(iBcolor = Empty, .BackColor, iBcolor)
                         .CellBackColor = mDefColor
                     End If  'Added by Lydia 2022/11/09
                  Next
               End If
            Next
            .col = 0
            .row = intRow
            For intK = 0 To iCols - 1
               If InStr("," & iJumpCols & ",", "," & intK & ",") = 0 Then 'Added by Lydia 2022/11/09 指定排除變色欄位數
                  .col = intK
                  .CellBackColor = &HFFC0C0
               End If 'Added by Lydia 2022/11/09
            Next
            'Modified by Lydia 2017/11/15
            'If .Cols >= intCheck Then .col = intCheck: .Text = "v"
            If iCols >= intCheck Then .col = intCheck: .Text = iSignal
            .Visible = True
         End If
      Else
         If iCols >= intCheck Then
            .col = intCheck
            'Modified by Lydia 2020/05/27 +一個空白 .Text = " "
            If .Text = "" Or .Text = " " Then
               'Modified by Lydia 2017/11/15
               '.Text = "v"
               .Text = iSignal
            Else
               .Text = ""
            End If
         End If
         'Added by Lydia 2024/05/22 增加2 多選並且變色
         If iSitu = 2 Then
            .col = 0
            If .CellBackColor = &HFFC0C0 Then
               For intK = 0 To iCols - 1
                  If InStr("," & iJumpCols & ",", "," & intK & ",") = 0 Then '指定排除變色欄位數
                     .col = intK
                     .CellBackColor = IIf(iBcolor = Empty, .BackColor, iBcolor)
                  End If
               Next
            Else
               For intK = 0 To iCols - 1
                  If InStr("," & iJumpCols & ",", "," & intK & ",") = 0 Then '指定排除變色欄位數
                      .col = intK
                      .CellBackColor = &HFFC0C0
                  End If
               Next
            End If
         End If
         'end --- 增加2 多選並且變色
      End If
      .Refresh
   End With
End Sub

Public Function DelMsg() As Boolean
   If MsgBox("是否要刪除此筆資料 ?", vbYesNo + vbCritical + vbDefaultButton2, "詢問") = vbYes Then
      DelMsg = True
   Else
      DelMsg = False
   End If
End Function

Public Function ChkCaseCode(ByVal strType As String, ByVal S01 As String, ByVal S02 As String, ByVal S03 As String, ByVal S04 As String) As Boolean
Dim strTmp As String, intA As Integer, rsAD As New ADODB.Recordset  'Added by Lydia 2024/05/14

   If S03 = "" Then S03 = "0"
   If S04 = "" Then S04 = "00"
   Select Case UCase(strType)
      Case "CP"
         strTmp = "SELECT COUNT(*) FROM CASEPROGRESS WHERE CP01='" & S01 & "' AND CP02='" & S02 & "' AND CP03='" & S03 & "' AND CP04='" & S04 & "'"
         intA = 1
         Set rsAD = ClsLawReadRstMsg(intA, strTmp) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(inta, strTmp)
         If rsAD.Fields(0) > 0 Then
            MsgBox "案件進度檔中尚有此案號之資料，無法刪除 !", vbCritical
            ChkCaseCode = False
            Exit Function
         Else
            ChkCaseCode = True
            Exit Function
         End If
      Case "PA"
         strTmp = "SELECT COUNT(*) FROM PATENT WHERE PA01='" & S01 & "' AND PA02='" & S02 & "' AND PA03='" & S03 & "' AND PA04='" & S04 & "'"
         intA = 1
         Set rsAD = ClsLawReadRstMsg(intA, strTmp) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(inta, strTmp)
         If rsAD.Fields(0) > 0 Then
            MsgBox "基本檔中已有此案號之資料 !", vbCritical
            ChkCaseCode = False
            Exit Function
         Else
            ChkCaseCode = True
         End If
      Case "SP"
         strTmp = "SELECT COUNT(*) FROM SERVICEPRACTICE WHERE SP01='" & S01 & "' AND SP02='" & S02 & "' AND SP03='" & S03 & "' AND SP04='" & S04 & "'"
         intA = 1
         Set rsAD = ClsLawReadRstMsg(intA, strTmp) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(inta, strTmp)
         If rsAD.Fields(0) > 0 Then
            MsgBox "基本檔中已有此案號之資料 !", vbCritical
            ChkCaseCode = False
            Exit Function
         Else
            ChkCaseCode = True
         End If
      'Add By Sindy 2010/7/1
      Case "NP"
         strTmp = "SELECT COUNT(*) FROM NEXTPROGRESS WHERE NP02='" & S01 & "' AND NP03='" & S02 & "' AND NP04='" & S03 & "' AND NP05='" & S04 & "'"
         intA = 1
         Set rsAD = ClsLawReadRstMsg(intA, strTmp) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(inta, strTmp)
         If rsAD.Fields(0) > 0 Then
            MsgBox "下一程序資料檔中尚有此案號之資料，無法刪除 !", vbCritical
            ChkCaseCode = False
            Exit Function
         Else
            ChkCaseCode = True
            Exit Function
         End If
      '2010/7/1 End
   End Select
   If ChkCaseCode Then
      intA = 1
      strTmp = "SELECT AU03 FROM AUTONUMBER WHERE AU01='" & S01 & "'"
      Set rsAD = ClsLawReadRstMsg(intA, strTmp) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(inta, strTmp)
      If intA = 1 Then
         If Val(S02) > Val(rsAD.Fields(0)) Then
            MsgBox "輸入之編號大於自動編號，請重新輸入 !", vbInformation
            ChkCaseCode = False
         End If
      End If
   End If
   
   Set rsAD = Nothing 'Added by Lydia 2024/05/14
End Function

'顯示錯誤訊息
Public Sub DataErrorMessage(i As Integer, Optional strName As String)
Select Case i
Case 1
    MsgBox "" + strName + " 輸入資料錯誤", vbCritical
Case 2
    MsgBox "" + strName + " 日期格式錯誤", vbCritical
Case 3
    MsgBox "存檔失敗,請洽系統管理者", vbCritical
Case 4
    MsgBox "無此權限", vbCritical
Case 5
    MsgBox "" + strName + " 資料不可為空", vbCritical
Case 6
    MsgBox "已到第一筆", vbCritical
Case 7
    MsgBox "已到最末筆", vbCritical
Case 8
    MsgBox "查無此資料....", vbCritical
Case 9
    MsgBox "此筆資料不存在", vbCritical
Case 10
    MsgBox "'" + strName + "'不可小於系統日!", vbCritical
Case 11
    MsgBox "'" + strName + "'不可大於系統日!", vbCritical
Case 12
     MsgBox "法定期限小於本所期限!", vbCritical
Case 13
    MsgBox "本所期限大於法定期限!", vbCritical
Case 14
    MsgBox "'" + strName + "'刪除成功!", vbCritical
Case 15
   MsgBox "'" + strName + "'刪除失敗!", vbCritical
End Select
End Sub

'Siegfried 檢查兩個值的範圍
'Modify By Sindy 2021/7/16 改為用 Object 型態
'Public Function ChkRange(txt1 As TextBox, txt2 As TextBox, ByVal St As String) As Boolean
Public Function ChkRange(txt1 As Object, txt2 As Object, ByVal St As String) As Boolean
 On Error Resume Next
   ChkRange = False
   If txt1 <> "" Then
      If Val(txt1.Text) > Val(txt2.Text) Then
         MsgBox St & "範圍不正確 !", vbCritical
         txt1.SetFocus
      Else
         ChkRange = True
      End If
   End If
End Function

'*************************************************
'  取得下一程序之序號
'
'*************************************************
Public Function GetNextProgressNo() As String
Dim adoRecord As New ADODB.Recordset
   adoRecord.CursorLocation = adUseClient
   adoRecord.Open "select max(np22) from nextprogress", cnnConnection, adOpenStatic, adLockReadOnly   'edit by nickc 2005/08/04 原先是  動態開啟
   If adoRecord.RecordCount <> 0 Then
      If IsNull(adoRecord.Fields(0).Value) Then
         GetNextProgressNo = 1
      Else
         GetNextProgressNo = Val(adoRecord.Fields(0).Value) + 1
      End If
   Else
      GetNextProgressNo = 1
   End If
   adoRecord.Close
End Function

''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
'add by nick 2004/07/21 GetCustomerName 改增加檢查狀態
' 由客戶代碼取得客戶名稱
' Input : strCustomer ==> 客戶代碼
'         nLanguage ==> 0 : 表取得的是中文名稱(無中文取英文, 無英文取日文)
'                       1 : 表取得的是英文名稱(無英文取中文, 無中文取日文)
'                       (預設值為0)
' Output : 傳回客戶的名稱
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Public Function GetCustomerNameAndState(ByVal strCustomer As String, Optional ByVal nLanguage As String = "0", Optional oState As Boolean) As String
   Dim rsTmp As New ADODB.Recordset
   Dim strKey As String
   Dim strSql As String
   
   If nLanguage < 0 Or nLanguage > 1 Then: nLanguage = 0
   
   GetCustomerNameAndState = Empty
   
   If Len(strCustomer) < 9 Then: strCustomer = strCustomer & String(9 - Len(strCustomer), "0")
   
   If Len(strCustomer) > 8 Then
      strSql = "SELECT * FROM Customer " & _
               "WHERE CU01 = '" & Mid(strCustomer, 1, 8) & "' AND " & _
                     "CU02 = '" & Mid(strCustomer, 9, 1) & "'"
   Else
      strSql = "SELECT * FROM Customer " & _
               "WHERE CU01 = '" & Mid(strCustomer, 1, 8) & "' AND " & _
                     "CU02 = '0' "
   End If
   rsTmp.CursorLocation = adUseClient
   rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If rsTmp.RecordCount > 0 Then
      rsTmp.MoveFirst
      Select Case nLanguage
         Case 0:
            If IsNull(rsTmp.Fields("CU04")) = False Then
               GetCustomerNameAndState = rsTmp.Fields("CU04")
            ElseIf IsNull(rsTmp.Fields("CU05")) = False Then
               GetCustomerNameAndState = rsTmp.Fields("CU05")
               If IsNull(rsTmp.Fields("CU88")) = False Then
                  GetCustomerNameAndState = GetCustomerNameAndState & " " & rsTmp.Fields("CU88")
               End If
               If IsNull(rsTmp.Fields("CU89")) = False Then
                  GetCustomerNameAndState = GetCustomerNameAndState & " " & rsTmp.Fields("CU89")
               End If
               If IsNull(rsTmp.Fields("CU90")) = False Then
                  GetCustomerNameAndState = GetCustomerNameAndState & " " & rsTmp.Fields("CU90")
               End If
            ElseIf IsNull(rsTmp.Fields("CU06")) = False Then
               GetCustomerNameAndState = rsTmp.Fields("CU06")
            End If
         Case 1:
            If IsNull(rsTmp.Fields("CU05")) = False Then
               GetCustomerNameAndState = rsTmp.Fields("CU05")
               If IsNull(rsTmp.Fields("CU88")) = False Then
                  GetCustomerNameAndState = GetCustomerNameAndState & " " & rsTmp.Fields("CU88")
               End If
               If IsNull(rsTmp.Fields("CU89")) = False Then
                  GetCustomerNameAndState = GetCustomerNameAndState & " " & rsTmp.Fields("CU89")
               End If
               If IsNull(rsTmp.Fields("CU90")) = False Then
                  GetCustomerNameAndState = GetCustomerNameAndState & " " & rsTmp.Fields("CU90")
               End If
            ElseIf IsNull(rsTmp.Fields("CU04")) = False Then
               GetCustomerNameAndState = rsTmp.Fields("CU04")
            ElseIf IsNull(rsTmp.Fields("CU06")) = False Then
               GetCustomerNameAndState = rsTmp.Fields("CU06")
            End If
      End Select
      If CheckStr(rsTmp.Fields("cu80").Value) = "不再使用" Then
             MsgBox "此申請人資料已不再使用，請確認！！", , MsgText(5)
             oState = False
      Else
             oState = True
      End If
   End If
   rsTmp.Close
   Set rsTmp = Nothing
End Function

'分別取得申請人中英日地址
Public Function PUB_GetCustEachAdd(strCU01 As String, strKind) As String
'strKind : "1"中文, "2"英文, "3"日文
Dim rsA As New ADODB.Recordset
Dim StrSQLa As String

PUB_GetCustEachAdd = ""
If strCU01 = "" Then Exit Function
StrSQLa = "Select * From CUSTOMER WHERE CU01='" & Mid(strCU01 & "000000000", 1, 8) & "' AND CU02='" & Mid(strCU01 & "000000000", 9, 1) & "'"
rsA.CursorLocation = adUseClient
rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
If rsA.RecordCount > 0 Then
   '中文地址
   If strKind = "1" Then
      PUB_GetCustEachAdd = "" & rsA.Fields("CU23").Value
   '英文地址
   ElseIf strKind = "2" Then
        'Modify By Cheng 2003/05/19
        '去除前後空白
'      PUB_GetCustEachAdd = "" & rsA.Fields("CU24").Value & " " & _
'                              rsA.Fields("CU25").Value & " " & _
'                              rsA.Fields("CU26").Value & " " & _
'                              rsA.Fields("CU27").Value & " " & _
'                              rsA.Fields("CU28").Value & " " & rsA.Fields("CU102").Value
      PUB_GetCustEachAdd = Trim("" & rsA.Fields("CU24").Value & " " & _
                              rsA.Fields("CU25").Value & " " & _
                              rsA.Fields("CU26").Value & " " & _
                              rsA.Fields("CU27").Value & " " & _
                              rsA.Fields("CU28").Value & " " & rsA.Fields("CU102").Value)
  '日文地址
   Else
      PUB_GetCustEachAdd = "" & rsA.Fields("CU29").Value
   End If
   If Len(Replace(PUB_GetCustEachAdd, " ", "")) <= 0 Then PUB_GetCustEachAdd = ""
End If
If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing
End Function

'add by nick 2004/07/21 PUB_GetAgentName 改增加檢查狀態
'以系統類別的SK03判斷顯示代理人名稱順序
'若SK03=0, 則中-->英-->日, 否則英-->中-->日
Public Function PUB_GetAgentNameAndState(strSK01 As String, strFA0102 As String, strTempName As String) As Boolean
Dim rsA As New ADODB.Recordset
Dim StrSQLa As String
Dim strSK03 As String

PUB_GetAgentNameAndState = True
'2010/11/24 add by sonia
If Mid(strFA0102 & "000000000", 9, 1) <> "0" And Mid(strFA0102 & "000000000", 9, 1) <> "9" Then
   MsgBox "此代理人編號為更名前舊名稱，已不可再使用請確認！！", , MsgText(5)
   PUB_GetAgentNameAndState = False
   Exit Function
End If
'2010/11/24 end
strSK03 = ""
If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing
StrSQLa = "Select SK03 From SystemKind Where SK01='" & strSK01 & "'"
rsA.CursorLocation = adUseClient
rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
If rsA.RecordCount > 0 Then
   strSK03 = "" & rsA.Fields(0).Value
End If
If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing
'2010/11/24 modify by sonia 加fa02以判斷是否為
If strSK03 = "0" Then
   StrSQLa = "Select DECODE(FA04,NULL,DECODE(FA05,NULL,FA06,FA05||' '||FA63||' '||FA64||' '||FA65),FA04),fa69 FROM FAGENT WHERE FA01='" & Mid(strFA0102 & "000000000", 1, 8) & "' AND FA02='" & Mid(strFA0102 & "000000000", 9, 1) & "'"
Else
   StrSQLa = "Select DECODE(FA05,NULL,NVL(FA04,FA06),FA05||' '||FA63||' '||FA64||' '||FA65),fa69 FROM FAGENT WHERE FA01='" & Mid(strFA0102 & "000000000", 1, 8) & "' AND FA02='" & Mid(strFA0102 & "000000000", 9, 1) & "'"
End If
rsA.CursorLocation = adUseClient
rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
If rsA.RecordCount > 0 Then
   strTempName = "" & CheckStr(rsA.Fields(0).Value)
   If CheckStr(rsA.Fields(1).Value) = "不再使用" Then
      MsgBox "此代理人資料已不再使用，請確認！！", , MsgText(5)
      PUB_GetAgentNameAndState = False
   End If
Else
   strTempName = ""
   PUB_GetAgentNameAndState = False
End If

If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing
End Function

'add by nick 2004/07/12 從 GetAgent 改增加狀態
'取得代理人名稱
'Modify By Sindy 2014/12/2 +Optional ByLoginUserReadName As Boolean
'Modify By Sindy 2015/8/27 +Optional strCP01 As String
'Modify By Sindy 2021/2/1 + , Optional ByRef strRefState As String : 回傳狀態； 前畫面需要寄信時才能判斷。
'                         + , Optional bolOldCase As Boolean = False : 是否舊案收文； 為新案才要彈訊息，不可收文。
'Modified by Lydia 2022/09/02 修改ByRef strAgent=> ByVal strAgent
'Public Function GetAgentAndState(ByRef strAgent As String, ByRef strAgentName As String, _
                                 Optional strAdress As String, Optional bolShowMsg As Boolean = True, _
                                 Optional ByLoginUserReadName As Boolean = False, Optional strCP01 As String, _
                                 Optional ByRef strRefState As String, Optional bolOldCase As Boolean = False) As Boolean
Public Function GetAgentAndState(ByVal strAgent As String, ByRef strAgentName As String, _
                                 Optional ByRef strAdress As String, Optional ByRef bolShowMsg As Boolean = True, _
                                 Optional ByVal ByLoginUserReadName As Boolean = False, Optional ByVal strCP01 As String, _
                                 Optional ByRef strRefState As String, Optional ByVal bolOldCase As Boolean = False) As Boolean
Dim strSql As String, rsRecordset As New ADODB.Recordset, i As Integer
'add by nick 2004/07/21
Dim strState As String
Dim bolFUser As Boolean 'Add By Sindy 2014/12/2
Dim strSysCode As String 'Add By Sindy 2015/8/27
Dim strTemp1 As String 'Added by Lydia 2024/06/13

On Error GoTo ErrHand
   
   GetAgentAndState = False
   
   'Add By Sindy 2014/12/2
   If ByLoginUserReadName = True Then '依操作者的部門判斷
      'FXX者帶英->中->日
      If Left(Pub_StrUserSt03, 1) = "F" Then
         bolFUser = True
      '非FXX者帶中->英->日
      Else
         bolFUser = False
      End If
   End If
   '2014/12/2 END
   
   strAgent = ChangeCustomerL(strAgent)
   If Left(strAgent, 1) = 代理人編號 Then
      'Add By Sindy 2014/12/2
      If ByLoginUserReadName = True And bolFUser = False Then
         '中->英->日
         'Modify by Amy 2017/01/11 修改nvl(fa05||' '||fa63||' '||fa64||' '||fa65,fa06)不會是空值
         strSql = "select fa01||fa02,nvl(fa04,Decode(fa05,null,fa06,fa05||' '||fa63||' '||fa64||' '||fa65))," & _
                  "nvl(fa15,nvl(fa16||' '||fa17||' '||fa18||' '||fa19||' '||fa20,fa21)),'',fa69 from " & _
                  "fagent where " & ChgFagent(strAgent) & " order by fa01,fa02"
      Else
      '2014/12/2 END
         '英->中->日
         'Modify by Amy 2017/01/11 修改nvl(fa05||' '||fa63||' '||fa64||' '||fa65,nvl(fa04,fa06))不會是空值
         strSql = "select fa01||fa02,Decode(fa05,null,nvl(fa04,fa06),fa05||' '||fa63||' '||fa64||' '||fa65)," & _
                  "nvl(fa15,nvl(fa16||' '||fa17||' '||fa18||' '||fa19||' '||fa20,fa21)),'',fa69 from " & _
                  "fagent where " & ChgFagent(strAgent) & " order by fa01,fa02"
      End If
   ElseIf Left(strAgent, 1) = 客戶編號 Then
      'Add By Sindy 2014/12/2
      If ByLoginUserReadName = True And bolFUser = False Then
         '中->英->日
         'Modify by Amy 2017/01/11 修改nvl(fa05||' '||fa63||' '||fa64||' '||fa65,fa06)
         strSql = "select cu01||cu02,nvl(fa04,Decode(fa05,null,fa06,fa05||' '||fa63||' '||fa64||' '||fa65))," & _
                  "nvl(fa15,nvl(fa16||' '||fa17||' '||fa18||' '||fa19||' '||fa20,fa21))," & _
                  "fa01||fa02,fa69 from customer,fagent where fa01=cu03 and " & ChgCustomer(strAgent) & " order by fa01,fa02"
      Else
      '2014/12/2 END
         '英->中->日
         'Modify by Amy 2017/01/11 修改nvl(fa05||' '||fa63||' '||fa64||' '||fa65,nvl(fa04,fa06))
         strSql = "select cu01||cu02,Decode(fa05,null,nvl(fa04,fa06),fa05||' '||fa63||' '||fa64||' '||fa65)," & _
                  "nvl(fa15,nvl(fa16||' '||fa17||' '||fa18||' '||fa19||' '||fa20,fa21))," & _
                  "fa01||fa02,fa69 from customer,fagent where fa01=cu03 and " & ChgCustomer(strAgent) & " order by fa01,fa02"
      End If
   Else
      MsgBox MsgText(9152), , MsgText(5)
      Exit Function
   End If
   strAgentName = ""
   strAdress = ""
   strState = "": strRefState = ""
   rsRecordset.CursorLocation = adUseClient
   rsRecordset.Open strSql, cnnConnection
   If rsRecordset.RecordCount > 0 Then
      If rsRecordset.Fields(0) = strAgent Then
         If Left(strAgent, 1) = 客戶編號 Then strAgent = rsRecordset.Fields(3)
         strAgent = ChangeCustomerS(strAgent)
         If Not IsNull(rsRecordset.Fields(1)) Then strAgentName = rsRecordset.Fields(1)
         If Not IsNull(rsRecordset.Fields(2)) Then strAdress = rsRecordset.Fields(2)
         'add by nick 2004/07/21
         'Modify By Sindy 2014/9/22
         'If Not IsNull(rsRecordset.Fields(2)) Then strState = rsRecordset.Fields(2)
         If Not IsNull(rsRecordset.Fields(4)) Then strState = rsRecordset.Fields(4)
         '2014/9/22 END
         strSysCode = CheckSys(strCP01) 'Add By Sindy 2015/8/27
         'Added by Lydia 2024/06/13 以操作者判斷可使用的系統;
         If strSysCode = "" Then
            strTemp1 = PUB_GetST93(strUserNum)
            If Left(strTemp1, 1) = "F" Or Left(strTemp1, 1) = "J" Or Left(strTemp1, 1) = "P" Then
               strSysCode = "1"
            ElseIf Left(strTemp1, 1) = "T" Then
               strSysCode = "2"
            End If
         End If
         'end 2024/06/13
         
         'Add By Sindy 2014/10/27
         If bolShowMsg = True Then
         '2014/10/27 END
            If Trim(strState) = "不再使用" Then
               strRefState = strState
               MsgBox "此代理人資料已不再使用，請確認！！", , MsgText(5)
               Exit Function
'            'Modify By Sindy 2015/8/27
'            ElseIf Trim(strState) = "不得代理" Then
'                 MsgBox "此申請人資料不得代理，請確認！！", , MsgText(5)
'                 Exit Function
'            ElseIf (strSysCode = "2" Or strSysCode = "6") And Trim(strState) = "不得代理商標" Then
'                 MsgBox "此申請人資料不得代理商標，請確認！！", , MsgText(5)
'                 Exit Function
'            ElseIf (strSysCode = "1" Or strSysCode = "5") And Trim(strState) = "不得代理專利" Then
'                 MsgBox "此申請人資料不得代理專利，請確認！！", , MsgText(5)
'                 Exit Function
'            '2015/8/27 END
            'Modify By Sindy 2021/2/1 是否舊案收文； 為新案才要彈訊息，不可收文。
            Else
               If Trim(strState) = "不得代理" Then
                  strRefState = strState
                  If bolOldCase = False Then
                     MsgBox "此申請人資料不得代理，請確認！！", , MsgText(5)
                     Exit Function
                  End If
               ElseIf (strSysCode = "2" Or strSysCode = "6") And Trim(strState) = "不得代理商標" Then
                  strRefState = strState
                  If bolOldCase = False Then
                     MsgBox "此申請人資料不得代理商標，請確認！！", , MsgText(5)
                     Exit Function
                  End If
               ElseIf (strSysCode = "1" Or strSysCode = "5") And Trim(strState) = "不得代理專利" Then
                  strRefState = strState
                  If bolOldCase = False Then
                     MsgBox "此申請人資料不得代理專利，請確認！！", , MsgText(5)
                     Exit Function
                  End If
               End If
            End If
            '2021/2/1 END
         End If
      End If
      GetAgentAndState = True
   Else
      'Add By Sindy 2017/12/15
      If bolShowMsg = True Then
      '2017/12/15 END
         MsgBox MsgText(9152), , MsgText(5)
      End If
   End If
   rsRecordset.Close
   Exit Function
   
ErrHand:
   If Err.Number = 0 Then
      Exit Function
   End If
   MsgBox Err.Description, , MsgText(5)
End Function

'取得時間
Public Function GetTime() As String
Dim strTime As String, strmin As String
strTime = time
If Mid(strTime, 1, 2) = "PM" And Mid(strTime, 4, 2) <> "00" Then
   strmin = str(Val(Mid(strTime, 4, 2)) + 12)
   GetTime = strmin + Mid(strTime, 7, 2)
Else
   GetTime = Mid(strTime, 4, 2) + Mid(strTime, 7, 2)
End If
End Function

Public Function ChkSysName(ByVal SysName As String) As Boolean
 Dim TmpCls As ClsSysName
   For Each TmpCls In ColSysName
      If TmpCls.SysId = SysName Then
         ChkSysName = True
         Exit For
      End If
   Next
   If ChkSysName = False Then MsgBox "登入之使用者無法使用此系統類別、或系統類別錯誤，請重新輸入 !", vbCritical
End Function

'Add by Morgan 2007/3/14
'多國案若有其他相同案已核准、發證、公開、公告時不可分案、發文、提申
'該案若有主張優先權則排除
'相同案要排除國內案(因為已有作控制)，日本、德國也可能要排除現暫保留
'Modify by Morgan 2008/2/21 +p_lngDate
Public Function PUB_SameCaseCheck(ByRef cp() As String, Optional ByVal p_lngDate As Long) As Boolean
Dim strTmp(0 To 3) As String, intA As Integer, rsAD As New ADODB.Recordset  'Added by Lydia 2024/05/14
   
   'Modify by Morgan 2008/2/21
   'p_lngDate = Val(strSrvDate(1))
   If p_lngDate = 0 Then
      p_lngDate = Val(strSrvDate(1))
   End If
   
   strTmp(0) = "select pa01,pa02,pa03,pa04,pa12,pa16,pa21 from patent" & _
      " where not exists(select * from caseprogress where cp01='" & cp(1) & "' and cp02='" & cp(2) & "' and cp03='" & cp(3) & "' and cp04='" & cp(4) & "' and cp10 in ('106','121'))" & _
      " and (pa01,pa02,pa03,pa04) in (select cr05,cr06,cr07,cr08 from caserelation" & _
      " where cr01='" & cp(1) & "' and cr02='" & cp(2) & "' and cr03='" & cp(3) & "' and cr04='" & cp(4) & "')" & _
      " and (pa12<" & p_lngDate & " or pa16='1' or (pa21<" & p_lngDate & " and pa09<>'239')) and rownum<2"
   intA = 1
   Set rsAD = ClsLawReadRstMsg(intA, strTmp(0))
   If intA = 1 Then
      With rsAD
         strTmp(1) = .Fields(0) & "-" & .Fields(1) & IIf(.Fields(2) & .Fields(3) = "000", "", "-" & .Fields(2) & "-" & .Fields(3))
         strTmp(2) = ""
         If Val("" & .Fields("pa12")) > 0 And Val("" & .Fields("pa12")) < p_lngDate Then
            strTmp(2) = "公開"
         ElseIf "" & .Fields("PA16") = "1" Then
            strTmp(2) = "核准"
         ElseIf Val(.Fields("PA21")) > 0 And Val("" & .Fields("pa21")) < p_lngDate Then
            strTmp(2) = "發證"
         End If
         'Modified by Morgan 2022/9/27 修正通知對象職稱
         strTmp(3) = "王副總"
         If strSrvDate(1) >= "20230511" Then
            strTmp(3) = "郭經理"
         End If
         If MsgBox("相同案【" & strTmp(1) & "】已【" & strTmp(2) & "】應通知" & strTmp(3) & "處理，是否要繼續？", vbYesNo + vbDefaultButton2 + vbExclamation) = vbYes Then
            PUB_SameCaseCheck = True
         End If
      End With
   Else
      PUB_SameCaseCheck = True
   End If
   
   Set rsAD = Nothing 'Added by Lydia 2024/05/14
End Function

'Add by Morgan 2007/3/19
'當多國案之核准、發證、公開時若有其他相同案未發文或無申請日或申請日晚於核准日/發證日/公開日則發Mail給王協理、郭雅娟&林慧汶並印連絡單
'該案若有主張優先權則排除
'p_iState:1=核准,2=發證,3=公開,4=公告
Public Sub PUB_SameCaseCheck1(ByRef cp() As String, ByVal p_iState As Integer, ByVal p_Date As String)
Dim strTmp(0 To 5) As String, intA As Integer, rsAD As New ADODB.Recordset  'Added by Lydia 2024/05/14

   'Modified by Morgan 2021/9/27 +判斷申請案才要--玫音
   strTmp(0) = "select rpad(pa01||'-'||pa02||decode(pa03||pa04,'000',null,'-'||pa03||'-'||pa04),16) c1,decode(pa08,'1','發明　','2','新型　','3','設計') c2,na03,pa10" & _
      " from caserelation, patent, nation" & _
      " where cr01='" & cp(1) & "' and cr02='" & cp(2) & "' and cr03='" & cp(3) & "' and cr04='" & cp(4) & "'" & _
      " and not exists(select * from caseprogress where cp01=cr05 and cp02=cr06 and cp03=cr07 and cp04=cr04" & _
      " and cp10 in ('106','121'))" & _
      " and pa01(+)=cr05 and pa02(+)=cr06 and pa03(+)=cr07 and pa04(+)=cr08 and pa57 is null" & _
      " and (pa10 is null or pa10>" & p_Date & ") and na01(+)=pa09" & _
      " and exists(select * From caseprogress where cp01=pa01 and cp02=pa02 and cp03=pa03 and cp04=pa04 and cp10 in(" & NewCasePtyList & ") and cp57 is null)"
      
   intA = 1
   Set rsAD = ClsLawReadRstMsg(intA, strTmp(0))
   If intA = 1 Then
      strTmp(1) = cp(1) & "-" & cp(2) & IIf(cp(3) & cp(4) = "000", "", "-" & cp(3) & "-" & cp(4))
      strTmp(2) = ""
      Select Case p_iState
         Case 1
            strTmp(2) = "核准"
         Case 2
            strTmp(2) = "發證"
         Case 3
            strTmp(2) = "公開"
         Case 4
            strTmp(2) = "公告"
      End Select
      strTmp(3) = "多國案【" & strTmp(1) & "】已【" & strTmp(2) & "】但尚有其他相同案未提出申請或申請日較晚！"
      strTmp(4) = "多國案 " & strTmp(1) & " 已於" & TranslateKeyWord(incCNV_CHINESE_MINKO1, p_Date, "") & strTmp(2) & "但有其他相同案尚未提出申請或申請日較晚，案號如下：" & vbCrLf
      With rsAD
         .MoveFirst
         Do While Not .EOF
            strTmp(4) = strTmp(4) & vbCrLf & String(2, "　") & .Fields("c1") & "　" & IIf(IsNull(.Fields("pa10")), "(無申請日)", "(申請日晚)") & "　" & .Fields("c2") & "　" & .Fields("na03")
            .MoveNext
         Loop
      End With
      'Modified by Morgan 2021/9/27 改發文者也是收到email
      'PUB_SendMail strUserNum, "71011;79075;79017", "", strtmp(3), strtmp(4)
      'MsgBox strtmp(3) & vbCrLf & "準備列印連絡單...", vbOKOnly, "連絡單列印"
      'PUB_PrintContactSheet strUserName, "王錦寬 郭雅娟 林慧汶", strtmp(3), strtmp(4)
      'Modified by Morgan 2023/4/27 取消79017,5/11以後取消71011
      'strtmp(5) = "71011;79075;79017"
      strTmp(5) = "71011;79075"
      If strSrvDate(1) >= "20230511" Then
         strTmp(5) = "79075"
      End If
      'end 2023/4/27
      PUB_SendMail strUserNum, strTmp(5), "", strTmp(3), strTmp(4), , , , , , strUserNum
      'end 2021/9/27
   End If
   
   Set rsAD = Nothing 'Added by Lydia 2024/05/14
End Sub

Public Sub PUB_PrintContactSheet(ByVal p_Sender As String, ByVal p_Receiver As String, ByVal p_Subject As String, ByVal p_Content As String)
   Dim dx As Double, dY As Double, iCnt As Integer, strOut As String
   Dim iSaleMode As Integer
   iSaleMode = Printer.ScaleMode
   Printer.Font.Name = "標楷體"
   Printer.FontSize = 36
   Printer.ScaleMode = vbCentimeters
   dx = 2: dY = 3
   Printer.CurrentX = dx
   Printer.CurrentY = dY
   Printer.Print "連絡單"
   dx = dx + 1: dY = dY + 2
   
   Printer.FontSize = 14
   Printer.FontBold = True
   Printer.CurrentX = dx
   Printer.CurrentY = dY
   Printer.Print "受文者：" & p_Receiver
   dx = dx: dY = dY + 1
   Printer.CurrentX = dx
   Printer.CurrentY = dY
   Printer.Print "發文者：" & p_Sender
   dx = dx: dY = dY + 1
   Printer.CurrentX = dx
   Printer.CurrentY = dY
   Printer.Print "日　期：" & TranslateKeyWord(incCNV_CHINESE_MINKO1, strSrvDate(1), "")
   
   dx = dx: dY = dY + 1
   strOut = "主　題："
   For iCnt = 1 To Len(p_Subject)
      If Printer.TextWidth(strOut & Mid(p_Subject, iCnt, 1)) > 13 Then
         Printer.CurrentX = dx
         Printer.CurrentY = dY
         Printer.Print strOut
         dx = dx: dY = dY + 0.5
         strOut = String(4, "　") & Mid(p_Subject, iCnt, 1)
      Else
         strOut = strOut & Mid(p_Subject, iCnt, 1)
      End If
   Next
   If strOut <> "" Then
      Printer.CurrentX = dx
      Printer.CurrentY = dY
      Printer.Print strOut
      dx = dx: dY = dY + 0.5
   End If
   
   dx = dx: dY = dY + 0.5
   Printer.DrawWidth = 10
   Printer.Line (dx, dY)-(dx + 13, dY)
   Printer.CurrentX = dx
   Printer.CurrentY = dY
   Printer.FontBold = False
   
   dx = dx: dY = dY + 0.5
   strOut = ""
   For iCnt = 1 To Len(p_Content)
      If Mid(p_Content, iCnt, 2) = vbCrLf Then
         Printer.CurrentX = dx
         Printer.CurrentY = dY
         Printer.Print strOut
         dx = dx: dY = dY + 0.5
         strOut = ""
         iCnt = iCnt + 1
      ElseIf Printer.TextWidth(strOut & Mid(p_Content, iCnt, 1)) > 13 Then
         Printer.CurrentX = dx
         Printer.CurrentY = dY
         Printer.Print strOut
         dx = dx: dY = dY + 0.5
         strOut = Mid(p_Content, iCnt, 1)
      Else
         strOut = strOut & Mid(p_Content, iCnt, 1)
      End If
   Next
   If strOut <> "" Then
      Printer.CurrentX = dx
      Printer.CurrentY = dY
      Printer.Print strOut
   End If
   Printer.EndDoc
   Printer.ScaleMode = iSaleMode
   Printer.DrawWidth = 1     '2010/12/1 ADD BY SONIA
End Sub

'Modified by Morgan 2012/4/18 +HTML 格式
'Modify By Sindy 2016/12/14 + Optional bolAutoBatch As Boolean = False
'Modify By Sindy 2019/7/12 + Optional bolAbsenceSys As Boolean = False
'Modify By Sindy 2020/1/3 + Optional bolCaseDutyAgentMsg As Boolean = True
'Modified by Morgan 2021/1/21 bolCaseDutyAgentMsg 改預設為 False (這函數基本上都是背景發信，不需要回訊息)
'Modify By Sindy 2024/6/6 +, Optional ByVal bolDefCont As Boolean = False：
'                          True=有傳入收文號時會先抓出收文性質Email內文,再附加 mailcache 傳入的Email內文
Public Sub PUB_SendMailCache(Optional bolAutoBatch As Boolean = False, Optional bolAbsenceSys As Boolean = False, _
   Optional bolCaseDutyAgentMsg As Boolean = False, Optional ByVal bolDefCont As Boolean = False)
   
   'Modified by Morgan 2019/7/8 全域變數都改為區域變數,否則可能會衝突
   Dim bolHTML As Boolean
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   Dim stSaveMailCP09 As String 'Added by Morgan 2025/6/27
   
   'Modified by Morgan 2019/11/15 + and to_char(sysdate,'yyyymmdd')>=mc12
   stSQL = "select * from mailcache where mc01='" & strUserNum & "' and mc05 is null and to_char(sysdate,'yyyymmdd')>=mc12"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      With rsQuery
         Do While Not .EOF
            If .Fields("MC10") = "Y" Then
               bolHTML = True
            Else
               'Modified by Morgan 2019/10/14
               '配合事務所簽名檔的使用，都改用HTML格式寄送
               'bolHTML = False
               bolHTML = True
               'end 2019/10/14
            End If
                        
            'Modify by Morgan 2010/6/23
            '不繪圖不發
            If .Fields("MC02") = "99999" Then
               bolMailSendOk = True
            Else
               bolMailSendOk = False
               stSaveMailCP09 = IIf("" & .Fields("MC14") = "Y", "" & .Fields("MC13"), "") 'Added by Morgan 2025/6/27
               'Modify By Sindy 2016/12/14
               If bolAutoBatch = True Then
                  'Modify By Sindy 2019/7/12 + bolAbsenceSys
                  'Modified by Morgan 2021/11/2 +MC13
                  'Modify By Sindy 2024/6/6 + bolDefCont
                  PUB_SendMail .Fields("MC01"), .Fields("MC02"), "" & .Fields("MC13"), "" & .Fields("MC07"), "" & .Fields("MC08") & .Fields("MC11"), vbCrLf & vbCrLf & "***此信件為系統自動寄出，請勿直接回覆。***", , bolHTML, , , "" & .Fields("MC09"), "QPGMR", "系統管理員", , bolAbsenceSys, False, , , , , , , , , , , , , , , bolDefCont, stSaveMailCP09
               Else
               '2016/12/14 END
                  'Modify By Sindy 2019/7/12 +
                  'Modified by Morgan 2021/11/2 +MC13
                  'Modify By Sindy 2024/6/6 + bolDefCont
                  PUB_SendMail .Fields("MC01"), .Fields("MC02"), "" & .Fields("MC13"), "" & .Fields("MC07"), "" & .Fields("MC08") & .Fields("MC11"), , , bolHTML, , , "" & .Fields("MC09"), , , , bolAbsenceSys, bolCaseDutyAgentMsg, , , , , , , , , , , , , , , bolDefCont, stSaveMailCP09
               End If
            End If
            If bolMailSendOk = True Then
               strSql = "Update mailcache set MC05=to_char(sysdate,'YYYYMMDD'),MC06=to_char(sysdate,'HH24MISS')" & _
                  " where MC01='" & .Fields("MC01") & "' and MC02='" & .Fields("MC02") & "' and MC03=" & .Fields("MC03") & " and MC04=" & .Fields("MC04")
               cnnConnection.Execute strSql, intI
            End If
            .MoveNext
         Loop
      End With
   End If
   Set rsQuery = Nothing
End Sub

'Move from other module by Morgan 2007/5/23
'反白
'Modified by Lydia 2018/11/06 Form2.0改型態(參考InverseTextBox)
'Public Sub TextInverse(ByRef txtTemp As TextBox)
Public Sub TextInverse(ByRef txtTemp As Control)
   txtTemp.SelStart = 0
   txtTemp.SelLength = Len(txtTemp.Text)
End Sub

'轉成大寫字型
Public Function UpperCase(ByVal Ascii As Integer) As Integer
UpperCase = Asc(UCase(Chr(Ascii)))
End Function
'end 2007/5/23

'Add by Morgan 2007/6/5
'還原預設印表機
Public Sub PUB_RestorePrinter(p_defaultPrinter As String, Optional p_Orientation As Integer = 0)
   'Added by Morgan 2018/7/18 沒改印表機不必設定
   If Printer.DeviceName = p_defaultPrinter Then
      If p_Orientation > 0 Then
         If Printer.Orientation <> p_Orientation Then
            Printer.Orientation = p_Orientation
         End If
      End If
      Exit Sub
   End If
   'end 2018/7/18
   
   Dim oPrn As Printer
   For Each oPrn In Printers
      If oPrn.DeviceName = p_defaultPrinter Then
         Set Printer = oPrn
         'Add by Morgan 2011/3/15
         If p_Orientation > 0 Then
            Printer.Orientation = p_Orientation
         End If
         'end 2011/3/15
         Exit For
      End If
   Next
End Sub

'Add by Morgan 2007/6/5
'設定印表機選單
'Modified by Morgan 2020/10/29 +pListValidOnly:是否只顯示有效的印表機
'Modify By Sindy 2021/7/16 改為用 Object 型態
'Public Sub PUB_SetPrinter(p_FormName As String, p_cboPrinter As ComboBox, Optional p_DefaulPrinter As String, Optional p_bolAll As Boolean = True, Optional p_DefaulPrinterIdx As Integer, Optional ByRef XBox As TextBox, Optional ByRef YBox As TextBox, Optional pListValidOnly As Boolean = False)
'Modified by Lydia 2022/09/05 排除特定印表機 pJumpList
Public Sub PUB_SetPrinter(p_FormName As String, p_cboPrinter As Object, Optional p_DefaulPrinter As String, Optional p_bolAll As Boolean = True, Optional p_DefaulPrinterIdx As Integer, Optional ByRef XBox As Object, Optional ByRef YBox As Object, _
                 Optional pListValidOnly As Boolean = False, Optional pJumpList As String = "...")
                 
   Dim oPrn As Printer, ii As Integer
   Dim colInstalledPrinters, objPrinter 'Added by Morgan 2020/10/28
   Static oPrinters() As String, bDone As Boolean 'Added by Morgan 2021/7/23
   Dim strTmp As String, intA As Integer, rsAD As New ADODB.Recordset  'Added by Lydia 2024/05/14
   
   p_DefaulPrinter = Printer.DeviceName
   
   pListValidOnly = False 'Added by Morgan 2021/12/15 110/6/26起 AutoUpdate 已增加同步印表機功能，應可不用再從 OS 讀取印表機
   'Added by Morgan 2020/10/28 只列出有效的印表機
   If Val(pub_OS_Ver) > 6 And pListValidOnly = True Then
      p_cboPrinter.Clear
      
      'Modified by Morgan 2021/7/23 因每次讀取都會頓一下，改讀一次後存陣列
      If bDone = False Then
         Set colInstalledPrinters = Interaction.GetObject("winmgmts:{impersonationLevel=impersonate}!\\.\root\cimv2").ExecQuery("Select * from Win32_Printer")
         ii = 0
         For Each objPrinter In colInstalledPrinters
            ReDim Preserve oPrinters(ii) As String
            oPrinters(ii) = objPrinter.Name
            ii = ii + 1
            If p_bolAll = True Or objPrinter.Name <> p_DefaulPrinter Then
               'Debug.Print objPrinter.Name
               p_cboPrinter.AddItem objPrinter.Name, 0
            End If
         Next
         bDone = True
      Else
         For ii = LBound(oPrinters) To UBound(oPrinters)
            If p_bolAll = True Or oPrinters(ii) <> p_DefaulPrinter Then
               p_cboPrinter.AddItem oPrinters(ii), 0
            End If
         Next
      End If
      'end 2021/7/23
      
      For ii = 0 To p_cboPrinter.ListCount - 1
         If p_cboPrinter.List(ii) = p_DefaulPrinter Then
            p_DefaulPrinterIdx = ii
            Exit For
         End If
      Next
   Else
   'end 2020/10/28
   
      For ii = 0 To Printers.Count - 1
         'Removed by Morgan 2017/11/10 取消,會影響 ListIndex
         ''Added by Morgan 2017/11/8 剔除Microsoft印表機因為無.Copies屬性值,在列印時會出錯(自24g0程式移來,原Lydia 2015/08/19加的控制)
         'If UCase(Printers(ii).DeviceName) = UCase("Microsoft Office Document Image Writer") Then
         'ElseIf p_bolAll = True Then
         'end 2017/11/10
         If p_bolAll = True Then
            p_cboPrinter.AddItem Printers(ii).DeviceName
         ElseIf Printers(ii).DeviceName <> p_DefaulPrinter Then
            p_cboPrinter.AddItem Printers(ii).DeviceName
         End If
         
         'Add by Morgan 2008/5/21
         If Printers(ii).DeviceName = p_DefaulPrinter Then
            p_DefaulPrinterIdx = ii
         End If
         'end 2008/5/21
      Next
      
   End If 'Added by Morgan 2020/10/28
   
   'Modify by Morgan 2010/2/4 改預設系統印表機
   'p_cboPrinter.ListIndex = 0
   If p_bolAll = True Then
      p_cboPrinter.ListIndex = p_DefaulPrinterIdx
   End If
   
   'Add by Morgan 2008/5/21
   If TypeName(XBox) = "TextBox" Then
      XBox.Text = "0": XBox.Tag = ""
   End If
   If TypeName(YBox) = "TextBox" Then
      YBox.Text = "0": YBox.Tag = ""
   End If
   'end 2008/5/21
   
   'Added by Lydia 2022/09/05 排除特定印表機 pJumpList; 111/9/2整批寄發FC催款單遇到Y54047為紙本並且預設印表機為PDFCreator，因為在印紙本要輸入檔名未輸入，但是同時持續轉PDF作業，所以造成Y54047的列印轉成Y54067的附件。
   If pJumpList <> "..." Then
      For ii = 0 To p_cboPrinter.ListCount - 1
         If InStr(UCase(pJumpList), UCase(p_cboPrinter.List(ii))) > 0 And UCase(p_cboPrinter.List(ii)) <> "" Then
            p_cboPrinter.RemoveItem ii
         End If
      Next
   End If
   'end 202/09/05
   
   '設定列印印表機
   'Modified by Morgan 2017/10/24 先判斷 User+@+電腦名稱
   'Modified by Lydia 2022/09/05 排除特定印表機 pJumpList
   'strtmp = "Select PSP04,PSP05,PSP06,'1' Srt From PrintStartPoint Where PSP01='" & strUserNum & "@" & pub_HostName & "' And PSP02='" & p_FormName & "' And PSP03='" & p_cboPrinter.Name & "'"
   'strtmp = strtmp & " union Select PSP04,PSP05,PSP06,'2' Srt From PrintStartPoint Where PSP01='" & strUserNum & "' And PSP02='" & p_FormName & "' And PSP03='" & p_cboPrinter.Name & "' order by Srt Asc"
   'end 2017/10/24
   strTmp = "Select PSP04,PSP05,PSP06,'1' Srt From PrintStartPoint Where PSP01='" & strUserNum & "@" & pub_HostName & "' And PSP02='" & p_FormName & "' And PSP03='" & p_cboPrinter.Name & "' and instr(" & CNULL(UCase(pJumpList)) & " , upper(psp06)) = 0 "
   strTmp = strTmp & " union Select PSP04,PSP05,PSP06,'2' Srt From PrintStartPoint Where PSP01='" & strUserNum & "' And PSP02='" & p_FormName & "' And PSP03='" & p_cboPrinter.Name & "' and instr(" & CNULL(UCase(pJumpList)) & " , upper(psp06)) = 0  order by Srt Asc"
   'end 2022/09/05
   intA = 1
   Set rsAD = ClsLawReadRstMsg(intA, strTmp)
   '若有資料
   If rsAD.RecordCount > 0 Then
       If p_cboPrinter.ListCount > 0 Then
           For ii = 0 To p_cboPrinter.ListCount - 1
               If p_cboPrinter.List(ii) = "" & rsAD("PSP06").Value Then
                  p_cboPrinter.ListIndex = ii
                  'Add by Morgan 2008/5/21
                  If TypeName(XBox) = "TextBox" Then
                     XBox.Text = "" & CDbl("" & rsAD("PSP04").Value)
                     XBox.Tag = XBox.Text
                  End If
                  If TypeName(YBox) = "TextBox" Then
                     YBox.Text = "" & CDbl("" & rsAD("PSP05").Value)
                     YBox.Tag = YBox.Text
                  End If
                  'end 2008/5/21
                  Exit For
               End If
           Next ii
       End If
       '記錄原設定值
       p_cboPrinter.Tag = p_cboPrinter.Text
   '若無資料
   Else
       '記錄原設定值
       p_cboPrinter.Tag = ""
   End If
   Set rsAD = Nothing 'Added by Lydia 2024/05/14
End Sub

'add by nickc 2007/06/06
'依部分名稱取得中文輸入法的代號
Public Function GetIMEKeyBoardHandle(ByVal ImeName As String) As Long
    Dim hkb5(24) As Long
    Dim i As Integer
    Dim BuffLen As Integer
    Dim Buff As String * 255
    Dim RetStr As String
    Dim RetCount As Integer
    Dim LayOutNo As Integer

    BuffLen = 255
    LayOutNo = GetKeyboardLayoutList(25, hkb5(0))
    GetIMEKeyBoardHandle = 0
    For i = 0 To LayOutNo - 1
        RetCount = ImmGetDescription(hkb5(i), Buff, BuffLen)
        RetStr = Left(Buff, RetCount)
        If InStr(1, RetStr, ImeName) <> 0 Then
            GetIMEKeyBoardHandle = hkb5(i)
            Exit Function
        ElseIf ImeName = "EN" And RetStr = "" Then
            '取消輸入法
            GetIMEKeyBoardHandle = hkb5(i)
            Exit Function
        End If
    Next i
End Function

'add by nickc 2007/06/06
 '設定某個中文輸入法
Public Function ActiveIMEKeyBoard(ByVal ImeName As String) As Boolean
    Dim hkbd As Long
    Dim i As Long
    ActiveIMEKeyBoard = False
    hkbd = GetIMEKeyBoardHandle(ImeName)
    If hkbd <> 0 Then
        i = ActivateKeyboardLayout(hkbd, 0)
        If i <> 0 Then
            ActiveIMEKeyBoard = True
        End If
    End If
End Function

'add by nickc 2007/06/06 開啟輸入法
Public Sub OpenIme()
   Exit Sub 'Added by Morgan 2018/12/13 取消--經理
   
   Dim oTime As Integer
   
   'Added  by Morgan 2016/10/21 Win7 有載入 EN 輸入法才切換否則不動作
   If Val(pub_OS_Ver) > 6 Then
      If bolWin7ENloaded Then
         If GetKeyboardLayout(0) = &H4090409 Then
            ActivateKeyboardLayout 0, 0 '切換前一個輸入法
         End If
      End If
   Else
   'end 2016/10/21
   
      'If Not ActiveIMEKeyBoard("倉頡") Then ActiveIMEKeyBoard ("注音")
         For oTime = 0 To 7000
             DoEvents
         Next oTime
      If IsChtIme = False Then
          'Debug.Print "chg"
          'DoEvents
          For oTime = 0 To 5000
          Next oTime
          keybd_event &H11, 0, 0, 0
          'DoEvents
          For oTime = 0 To 5000
          Next oTime
          keybd_event &H20, 0, 0, 0
          'DoEvents
          For oTime = 0 To 5000
          Next oTime
          keybd_event &H20, 0, &H2, 0
          'DoEvents
          For oTime = 0 To 5000
          Next oTime
          keybd_event &H11, 0, &H2, 0
          'DoEvents
          For oTime = 0 To 5000
          Next oTime
      End If
      
   End If 'Added by Morgan 2016/10/21
End Sub

'add by nickc 2007/06/06 關閉輸入法
Public Sub CloseIme()
   Exit Sub 'Added by Morgan 2018/12/13 取消--經理
   
   'Added  by Morgan 2016/10/21 Win7 有載入 EN 輸入法才切換否則不動作
   If Val(pub_OS_Ver) > 6 Then
      If bolWin7ENloaded Then
         If GetKeyboardLayout(0) <> &H4090409 Then
            ActivateKeyboardLayout &H4090409, 0
         End If
      End If
   Else
   'end 2016/10/21
   
      ActiveIMEKeyBoard "EN"
      
   End If 'Added by Morgan 2016/10/21
End Sub

'Add by Morgan 2007/6/12
Public Function PUB_IsLatestAgent(p_Cp01 As String, p_Cp02 As String, p_Cp03 As String, p_Cp04 As String, Optional p_CP09 As String, Optional p_CP110 As String = "65002") As Boolean
   Dim stCon As String
   Dim strTmp As String, intA As Integer, rsAD As New ADODB.Recordset  'Added by Lydia 2024/05/14
   
   If p_CP09 <> "" Then
      stCon = " and CP09<>'" & p_CP09 & "'"
   End If
   strTmp = "select cp110 from caseprogress" & _
      " where cp01='" & p_Cp01 & "' and cp02='" & p_Cp02 & "' and cp03='" & IIf(p_Cp03 = "", "0", p_Cp03) & "'" & _
      " and cp04='" & IIf(p_Cp04 = "", "00", p_Cp04) & "' and cp09<'C' and cp27>0 and cp110 is not null" & stCon & _
      " order by cp27 desc,cp09 desc"
   intA = 1
   Set rsAD = ClsLawReadRstMsg(intA, strTmp)
   If intA = 1 Then
      If rsAD(0) = p_CP110 Then
         PUB_IsLatestAgent = True
      End If
   End If
   Set rsAD = Nothing 'Added by Lydia 2024/05/14
End Function

'add by nickc 2007/06/13偵測目前是否為中文輸入法
Public Function IsChtIme() As Boolean
Dim hCurKBDLayout As Long
IsChtIme = False
hCurKBDLayout = GetKeyboardLayout(0)
If ImmIsIME(hCurKBDLayout) = 1 Then
    IsChtIme = True
End If
End Function

'Add by Morgan 2007/6/14
'檢查是否有客戶未發通知重新委任函
Public Sub PUB_ReAsignInform(p_Cp01 As String, p_Cp02 As String, p_Cp03 As String, p_Cp04 As String, p_CP09 As String, Optional p_bolCheckOk As Boolean = False)
   Dim stCustNo As String, stSQL() As String, iUB As Integer
   Dim strTmp As String, strExSql As String, intA As Integer, rsAD As New ADODB.Recordset  'Added by Lydia 2024/05/14
   
   If p_bolCheckOk = False Then
      p_bolCheckOk = PUB_IsLatestAgent(p_Cp01, p_Cp02, p_Cp03, p_Cp04, p_CP09)
   End If
   If p_bolCheckOk = True Then
      strTmp = "select pa26 from patent,LinReAsignRec" & _
         " where pa01='" & p_Cp01 & "' and pa02='" & p_Cp02 & "' and pa03='" & p_Cp03 & "' and pa04='" & p_Cp04 & "' and pa26 is not null" & _
         " and lr01(+)=pa26 and lr01 is null" & _
         " union select pa27 from patent,LinReAsignRec" & _
         " where pa01='" & p_Cp01 & "' and pa02='" & p_Cp02 & "' and pa03='" & p_Cp03 & "' and pa04='" & p_Cp04 & "' and pa27 is not null" & _
         " and lr01(+)=pa27 and lr01 is null" & _
         " union select pa28 from patent,LinReAsignRec" & _
         " where pa01='" & p_Cp01 & "' and pa02='" & p_Cp02 & "' and pa03='" & p_Cp03 & "' and pa04='" & p_Cp04 & "' and pa28 is not null" & _
         " and lr01(+)=pa28 and lr01 is null" & _
         " union select pa29 from patent,LinReAsignRec" & _
         " where pa01='" & p_Cp01 & "' and pa02='" & p_Cp02 & "' and pa03='" & p_Cp03 & "' and pa04='" & p_Cp04 & "' and pa29 is not null" & _
         " and lr01(+)=pa29 and lr01 is null" & _
         " union select pa30 from patent,LinReAsignRec" & _
         " where pa01='" & p_Cp01 & "' and pa02='" & p_Cp02 & "' and pa03='" & p_Cp03 & "' and pa04='" & p_Cp04 & "' and pa30 is not null" & _
         " and lr01(+)=pa30 and lr01 is null"
      intA = 1
      Set rsAD = ClsLawReadRstMsg(intA, strTmp)
      If intA = 1 Then
         iUB = 0
         Do While Not rsAD.EOF
            stCustNo = stCustNo & "," & rsAD.Fields(0)
            iUB = iUB + 1
            ReDim Preserve stSQL(iUB)
            stSQL(iUB) = "insert into LinReAsignRec(LR01,LR02,LR03,LR04,LR05,LR06,LR07) values('" & rsAD.Fields(0) & "','" & p_Cp01 & "','" & p_Cp02 & "','" & p_Cp03 & "','" & p_Cp04 & "'," & strSrvDate(1) & ",'" & strUserNum & "')"
            rsAD.MoveNext
         Loop
         
         EndLetter "02", p_CP09, "99", strUserNum
         strExSql = "INSERT INTO EXCEPTCONDITION (ET01,ET02,ET03,ET04,ET05,ET06) " & _
               "VALUES ('02','" & p_CP09 & "','99','" & strUserNum & _
               "','客戶編號','(" & Mid(stCustNo, 2) & ")')"
         cnnConnection.Execute strExSql, intA
         
         NowPrint p_CP09, "02", "99", False, strUserNum, 0
         
         cnnConnection.BeginTrans
On Error GoTo ErrHnd
         For iUB = 1 To UBound(stSQL)
            If stSQL(iUB) <> "" Then
               cnnConnection.Execute stSQL(iUB), intA
            End If
         Next
         cnnConnection.CommitTrans
         
      End If
   End If
   Set rsAD = Nothing 'Added by Lydia 2024/05/14
   
   Exit Sub
   
ErrHnd:
   If Err.Number <> 0 Then
      cnnConnection.RollbackTrans
      MsgBox Err.Description
      Set rsAD = Nothing 'Added by Lydia 2024/05/14
   End If
End Sub

'Add by Morgan 2007/7/17 檢查是否需核准928
'Modify by Morgan 2008/3/19 +判斷是否有重新委任補文件未收文
Public Function PUB_928Check(cp() As String, CP09 As String) As Boolean
Dim strTmp As String, intA As Integer, rsAD As New ADODB.Recordset  'Added by Lydia 2024/05/14
   strTmp = "select cp09,np07,np06 from caseprogress,nextprogress" & _
      " where cp01='" & cp(1) & "' and cp02='" & cp(2) & "' and cp03='" & cp(3) & "' and cp04='" & cp(4) & "'" & _
      " and cp10='928' and cp27<" & strSrvDate(1) & " and cp24 is null and cp27<>19221111" & _
      " and np01(+)=cp09 and np07(+)='202'"
   intA = 1
   Set rsAD = ClsLawReadRstMsg(intA, strTmp)
   If intA = 1 Then
      CP09 = rsAD(0)
      If Not IsNull(rsAD("np07")) And (IsNull(rsAD("np06")) Or "" & rsAD("np06") = "N") Then
         MsgBox "本案有發文【重新委任】至今仍無結果，但因尚有補文件未收文故將不會同時上核准！"
      Else
         If MsgBox("本案有發文【重新委任】但尚無結果，是否要一併核准？", vbYesNo + vbDefaultButton1) = vbYes Then
            PUB_928Check = True
         End If
      End If
   End If
   Set rsAD = Nothing 'Added by Lydia 2024/05/14
End Function

'Add by Morgan 2007/7/17 檢查是否需核准928
Public Sub PUB_928Update(cp() As String, CP09 As String, Optional CP25 As String, Optional cp13 As String, Optional cp12 As String)
Dim strExSql As String, intA As Integer 'Added by Lydia 2024/05/14

   If CP25 = "" Then
      CP25 = strSrvDate(1)
   End If
   If cp13 = "" Then
      cp13 = PUB_GetFCPSalesNo(cp(1), cp(2), cp(3), cp(4))
   End If
   If cp12 = "" Then
      cp12 = PUB_GetStaffST15(cp13, 1)
   End If

   strExSql = "INSERT INTO CASEPROGRESS (CP01,CP02,CP03,CP04,CP05,CP09,CP10," & _
         "CP12,CP13,CP14,CP20,CP26,CP32,CP27,CP43) VALUES ('" & cp(1) & "','" & cp(2) & "','" & _
         cp(3) & "','" & cp(4) & "'," & strSrvDate(1) & ",'" & _
         AutoNo("C", 6) & "','1001','" & cp12 & "','" & _
         cp13 & "','" & strUserNum & "','N','N','N'," & strSrvDate(1) & ",'" & _
         CP09 & "')"
         
   cnnConnection.Execute strExSql, intA
      
   strExSql = "update caseprogress set cp24='1',cp25=" & CP25 & " where cp09='" & CP09 & "' and cp24 is null"
   cnnConnection.Execute strExSql, intA
      
End Sub

'Add by Morgan 2007/7/19 檢查工作時數
'Modify By Sindy 2023/12/18 +, Optional ByVal bolShowMsg As Boolean = True: 不顯示訊息
'                            , Optional ByRef intMaxValue As Integer = 0: 回傳上限值
'Modify By Sindy 2024/5/2 +, Optional ByRef strRefVal As String = "": 回傳是否繼續作業
Public Function PUB_CheckCP113(CP113 As String, cp01 As String, CP10 As String, Optional cp14 As String, _
   Optional ByVal bolShowMsg As Boolean = True, Optional ByRef intMaxValue As Integer = 0, _
   Optional ByRef strRefVal As String = "") As Boolean
   
Const maxvalue As Integer = 25
Dim bolCheck As Boolean
Dim strCP01 As String 'Add By Sindy 2024/1/22
Dim strTmp As String, intA As Integer, rsAD As New ADODB.Recordset  'Added by Lydia 2024/05/14

   intMaxValue = maxvalue 'Modify By Sindy 2023/12/18
   '加控制工程師才檢查工作時數設定
   bolCheck = False
   If cp14 <> "" Then
      '2008/4/8 MODIFY BY SONIA
      'If PUB_GetStaffST15(cp14, 1) = "F21" Then
      'Modify By Sindy 98/03/11 增加FCT和S
      If cp01 = "FCT" Or cp01 = "S" Then
         If PUB_GetStaffST15(cp14, 1) = "F10" Or PUB_GetStaffST15(cp14, 1) = "F11" Or _
            PUB_GetStaffST15(cp14, 1) = "F12" Or cp14 = "F4103" Then
            bolCheck = True
         End If
      Else 'FCP,FG
         If PUB_GetStaffST15(cp14, 1) = "F21" Or PUB_GetStaffST15(cp14, 1) = "F81" Then
            bolCheck = True
         End If
      End If
   End If
   If bolCheck = True Then
      'Modify By Sindy 2024/1/22 若系統別是P時,優先用FCP做檢查,無資料才用P
      If cp01 = "P" Then
         strCP01 = "'FCP','P'"
      ElseIf cp01 = "PS" Then
         strCP01 = "'FG','PS'"
      Else
         strCP01 = "'" & cp01 & "'"
      End If
      'strtmp = "select cpm03 from casepropertymap where cpm01='" & cp01 & "' and cpm02='" & CP10 & "' and cpm16='Y'"
      strTmp = "select cpm03,decode(cpm01,'FCP',1,'FG',1,'P',2,'PS',2,1) as sort,cpm01,cpm02 from casepropertymap where cpm01 in(" & strCP01 & ") and cpm02='" & CP10 & "' and cpm16='Y'" & _
                  " order by sort asc"
      '2024/1/22 END
      intA = 1
      Set rsAD = ClsLawReadRstMsg(intA, strTmp)
      If intA = 1 Then
         '2011/9/26 modify by sonia
         'If CP113 = "" Then
         '   MsgBox rsad(0) & "的工作時數不可空白！", vbExclamation
         '   Exit Function
         'End If
         Select Case cp01
            Case "FCT", "S"    '外商輸0可以過(陳金蓮要求,日文組都沒寫)
               If CP113 = "" Then
                  'Modify By Sindy 2023/12/18 +if
                  If bolShowMsg = True Then
                  '2023/12/18 END
                     MsgBox rsAD(0) & "的工作時數不可空白！", vbExclamation
                  End If
                  Exit Function
               End If
            Case Else
               If Val(CP113) = 0 Then
                  'Modify By Sindy 2023/12/18 +if
                  If bolShowMsg = True Then
                  '2023/12/18 END
                     MsgBox rsAD(0) & "的工作時數不可空白！", vbExclamation
                  End If
                  Exit Function
               End If
         End Select
         '2011/9/26 end
      End If
      Set rsAD = Nothing 'Added by Lydia 2024/05/14
   End If
   If Val(CP113) > maxvalue Then
      If MsgBox("工作時數已超過上限值" & maxvalue & "，是否繼續作業？", vbYesNo + vbDefaultButton1) = vbNo Then
         strRefVal = "N" 'Modify By Sindy 2024/5/2 回傳按"否"不要繼續作業
         Exit Function
      Else
         strRefVal = "Y" 'Modify By Sindy 2024/5/2 回傳按"是"繼續...
      End If
   End If
   PUB_CheckCP113 = True
   Set rsAD = Nothing 'Added by Lydia 2024/05/14
End Function

'Add by Morgan 2007/7/23 讀取是否向客戶請款預設值
'Modify by Morgan 2007/10/24 加 p_AppNo:客戶編號(多人時直接串起來)
'Modify by Morgan 2008/3/27 加 p_AgentNo:代理人編號
'Modify by Morgan 2008/4/10 加 p_CaseNo:案號
Public Function PUB_GetCP20(cp01 As String, CP10 As String, Optional cp16 As String, Optional p_AppNo As String, Optional p_AgentNo As String, Optional p_CaseNo As String) As String
   Dim stCP20 As String
   Dim RsQ As ADODB.Recordset, intQ As Integer, stSQL As String
   
   '申請人 X56411 C類來函預設不請款
   If Len(CP10) = 4 Then
      If InStr(p_AppNo, "X56411") > 0 Then
         stCP20 = "N"
      'Add by Morgan 2008/8/21
      ElseIf InStr(p_AppNo, "X61740") > 0 Then
         stCP20 = "N"
      'Add by Morgan 2008/3/27
      ElseIf InStr(p_AppNo, "X55725") > 0 And InStr(p_AgentNo, "Y45736") > 0 Then
         stCP20 = "N"
      'Add by Morgan 2017/12/6 Y52283+X70681 OA預設不請款 --洪郁嵐,吳若芬
      'modify by sonia 2025/4/22 +部分准駁1009
      ElseIf InStr("1002,1009,1202,1227,1232", CP10) > 0 And InStr(p_AppNo, "X70681") > 0 And InStr(p_AgentNo, "Y52283") > 0 Then
         stCP20 = "N"
      'Added by Morgan 2025/3/4
      'Y2099001Murgitroyd+Meta集團(X80668000、 X80669000、X80670000)案件，1002核駁、1202審查意見通知函、1227最後通知預設不請款並備註"簡單報告"
      'modify by sonia 2025/4/22 +部分准駁1009
      ElseIf InStr("1002,1009,1202,1227", CP10) > 0 And InStr("X80668000,X80669000,X80670000", p_AppNo) > 0 And InStr(p_AgentNo, "Y2099001") > 0 Then
         stCP20 = "N"
      'Add by Morgan 2008/4/10 抓個案設定
      ElseIf p_CaseNo <> "" Then
         stSQL = "select pa146 from patent where " & ChgPatent(p_CaseNo)
         intQ = 1
         Set RsQ = ClsLawReadRstMsg(intQ, stSQL)
         If intQ = 1 Then
            stCP20 = "" & RsQ(0)
         End If
      End If
   End If
   
   If stCP20 = "" Then
      stSQL = "select cpm17,cpm18 from casepropertymap where cpm01='" & cp01 & "' and cpm02='" & CP10 & "'"
      intQ = 1
      Set RsQ = ClsLawReadRstMsg(intQ, stSQL)
      If intQ = 1 Then
         stCP20 = "" & RsQ.Fields(0)
         cp16 = Val("" & RsQ.Fields(1))
      End If
   End If
   PUB_GetCP20 = stCP20
   Set RsQ = Nothing
End Function

'Added by Lydia 2024/05/28 特定案件是否不請款：將各程式寫的Code，改成模組
Public Function PUB_GetCP20forSpec(ByVal pCP01 As String, ByVal pCP02 As String, ByVal pCP03 As String, ByVal pCP04 As String, ByVal pPA16 As String) As String
'pPA16: 目前准駁
Dim strType As String

   'Added by Lydia 2022/05/03  FCP-062174審定前不收費控制:補上是否向客戶收款=N  ---(源自於109/3/24Email)
   If pPA16 = "" And InStr("FCP062174000", pCP01 & pCP02 & pCP03 & pCP04) > 0 Then
       strType = "N"
   End If
   'end 2022/05/03
   'Added by Lydia 2022/05/03 FCP-067004核准前不收費控制：申請至核准(暫不包含領證)不收任何收費 (包含規費及服務費、若客戶提AEP也不收費)  --公告1110506-02
   If pPA16 <> "1" And InStr("FCP067004000", pCP01 & pCP02 & pCP03 & pCP04) > 0 Then
       strType = "N"
   End If
   'end 2022/05/03
   'Added by Lydia 2024/05/28 林總同意 FCP-070951 所有程序不請款 from 任政宏Red ---公告1130529-05
   If InStr("FCP070951000", pCP01 & pCP02 & pCP03 & pCP04) > 0 Then
      strType = "N"
   End If
   'end 2024/05/28
   
   PUB_GetCP20forSpec = strType
End Function

'Add by Morgan 2007/8/27 '檢查是否年費為申請日起算且非准後繳
Public Function PUB_CheckAnnuity(ByVal p_PA08 As String, ByVal p_PA09 As String, ByVal p_PA10 As String, Optional ByRef p_NP07 As String, Optional ByRef p_NP09 As String) As Boolean
   Dim varYear
   Dim strTmp As String, intA As Integer, rsAD As New ADODB.Recordset  'Added by Lydia 2024/05/14
   
   strTmp = "select decode('" & p_PA08 & "','1',na20,'2',na22,na24) C1" & _
      ",decode('" & p_PA08 & "','1',na21,'2',na23,na25) C2" & _
      " from nation where na01='" & p_PA09 & "' and decode('" & p_PA08 & "','1',na06,'2',na08,na10)='2'" & _
      " and decode('" & p_PA08 & "','1',na42,'2',na45,na48)='2'" & _
      " and decode('" & p_PA08 & "','1',na56,'2',na57,na58) is null"
   intA = 1
   Set rsAD = ClsLawReadRstMsg(intA, strTmp)
   If intA = 1 Then
      p_NP07 = "" & rsAD.Fields(0)
      If Not IsNull(rsAD.Fields(1)) Then
         varYear = Split("" & rsAD.Fields(1), ",")
         If p_NP07 = "605" Then
            p_NP09 = CompDate(0, varYear(0) - 1, p_PA10)
         'Add by Morgan 2008/7/16 非年費不必減1年
         Else
            p_NP09 = CompDate(0, varYear(0), p_PA10)
         End If
      End If
      If p_NP09 <> "" Then
         PUB_CheckAnnuity = True
      End If
   End If
   Set rsAD = Nothing 'Added by Lydia 2024/05/14
End Function

'add by nickc 2007/09/21 紀錄操作
'oOp 操作者  因為不一定是登入者
'oMemo 紀錄事項或是條件內容
'oCP01、oCP02、oCP03、oCP04、oCP09   條件，指單一筆
'OPName  操作功能，可不輸，不輸入系統將會自動抓
Sub Pub_SaveLog(ByVal oOp As String, ByVal oMemo As String, Optional ByVal oCP01 As String = "", Optional ByVal oCP02 As String = "", Optional ByVal oCP03 As String = "", Optional ByVal oCP04 As String = "", Optional ByVal oCp09 As String = "", Optional ByVal OPName As String = "", Optional ByVal oState As String = "2")
Dim MySQLString As String
Dim MyTmpOPName As String
MyTmpOPName = OPName
If OPName = "" Then
    If Screen.ActiveForm Is Nothing Then
        MyTmpOPName = ""
    Else
        MyTmpOPName = Screen.ActiveForm.Caption & "(" & Screen.ActiveForm.Name & ")"
    End If
End If
MySQLString = "insert into dml_log (dl01,dl02,dl03,dl04,dl05,dl06,dl07,dl08,dl09,dl10,dl11,dl12) " & _
                         " select " & IIf(oCP01 = "", " null", "'" & oCP01 & "'") & "," & IIf(oCP02 = "", "null", "'" & oCP02 & "'") & "," & IIf(oCP03 = "", "null", "'" & oCP03 & "'") & "," & IIf(oCP04 = "", "null", "'" & oCP04 & "'") & "," & IIf(oCp09 = "", "null", "'" & oCp09 & "'") & ",'" & oOp & "',to_number(to_char(sysdate,'YYYYMMDD')),to_number(to_char(sysdate,'HH24MIss')),'" & ChgSQL(oMemo) & "','非 DML 語法','" & oState & "'," & IIf(MyTmpOPName = "", "null", "'" & ChgSQL(MyTmpOPName) & "'") & " from dual"
cnnConnection.Execute MySQLString
End Sub

'add by nickc 2007/10/01 取得有時效性的承辦天數
'oSys              系統別
'oNation          國家代碼
'oCp10            案件性質
'oStartDayW    起始日(收文日、發文日、文件齊備日、系統日、...)
'oMaxDayW    最大期限(本所期限、法定期限、系統日、...)
'oCFPCp09     收文號判斷專利國內外案皆為同一工程師使用，沒傳入將不檢查國內外
'oDelayDay      傳入P案延遲天數    只會扣 CFP
'若是 oStartDayW  沒有傳入，則將以系統日作判斷
'※※※※注意：有修改此段程式，須一併修改BatchDay 程式
'Modify By Sindy 2021/6/24 + , Optional ByRef CaseNo As String : 本所案號加-
Public Function Pub_GetHandleDay(ByVal oSys As String, ByVal oNation As String, ByVal oCp10 As String, _
   Optional ByVal oStartDayW As String = "", Optional ByVal oMaxDayW As String = "", Optional ByVal oCFPCp09 As String = "", _
   Optional ByVal oDelayDay As Integer = 0, Optional ByRef CaseNo As String) As String
 
Dim rsgnd As New ADODB.Recordset
Dim rsgnd2 As New ADODB.Recordset
Dim oMyStdDate As String
Dim oMyMaxDate As String
Dim Strgnd As String
Dim Strgnd2 As String
Dim MyCp48 As String
Dim MyBaseDate As String
Dim strTmp As String, intA As Integer, rsAD As New ADODB.Recordset  'Added by Lydia 2024/05/14

'Add By Sindy 2021/6/24 【968回復說明書校閱】承辦期限：新案翻譯本所期限前10個工作天
'Add By Sindy 2021/7/8  【968回復說明書校閱】承辦期限：新案翻譯法定期限前15個工作天
'Modify By Sindy 2021/7/23 + 核對中說格式209、檢視中說210、製作中說235
If oSys = "FCP" Or oSys = "FG" Then
   If oCp10 = "968" Then
      strTmp = "select cp06,cp07 from caseprogress" & _
         " where cp01='" & SystemNumber(CaseNo, 1) & "' and cp02='" & SystemNumber(CaseNo, 2) & "'" & _
         " and cp03='" & SystemNumber(CaseNo, 3) & "' and cp04='" & SystemNumber(CaseNo, 4) & "'" & _
         " AND cp10 in ('201','209','210','235') AND CP27 IS NULL AND CP57 IS NULL"
      intA = 1
      Set rsAD = ClsLawReadRstMsg(intA, strTmp)
      If intA = 1 Then
         If Val("" & rsAD.Fields("cp07")) > 0 Then
            Pub_GetHandleDay = CompWorkDay(15, CompDate(2, -1, rsAD.Fields("cp07")), 1)
            Exit Function
         End If
      End If
   End If
End If
'2021/6/24 END
Set rsAD = Nothing 'Added by Lydia 2024/05/14

oMyStdDate = IIf(oStartDayW = "", strSrvDate(1), oStartDayW)
'oMyMaxDate = IIf(oMaxDayW = "", strSrvDate(1), oMaxDayW)
oMyMaxDate = oMaxDayW
Set rsgnd = New ADODB.Recordset
If rsgnd.State = 1 Then rsgnd.Close
Strgnd = "select cf105 as CFDate,1 as oSort from casefee1 where cf101='" & oSys & "' and cf102='" & oNation & "' and cf103='" & oCp10 & "' and cf104=(select max(cf104) from casefee1 where cf101='" & oSys & "' and cf102='" & oNation & "' and cf103='" & oCp10 & "' and cf104<=" & oMyStdDate & ") "
Strgnd = Strgnd & " union select cf04,2 from casefee where cf01='" & oSys & "' and cf02='" & oNation & "' and cf03='" & oCp10 & "' order by oSort "
rsgnd.CursorLocation = adUseClient
rsgnd.Open Strgnd, cnnConnection, adOpenStatic, adLockReadOnly
If rsgnd.RecordCount <> 0 Then
    If CheckStr(rsgnd.Fields("CFDate")) <> "" Then
        MyBaseDate = CheckStr(rsgnd.Fields("CFDate"))
        If oCFPCp09 <> "" Then   '有國內外案才會傳入
            Strgnd2 = "select * from (select C1.cp14 as A,C2.Cp14 as B from casemap,caseprogress c1,caseprogress c2 where cm10='0' and c1.cp01='CFP' and c1.cp09='" & oCFPCp09 & "' and c1.cp10 in (" & GetAddStr(CaseMapIn) & ") "
            Strgnd2 = Strgnd2 & " and c1.cp01=cm01(+) and c1.cp02=cm02(+) and c1.cp03=cm03(+) and c1.cp04=cm04(+) and cm05=c2.cp01(+) and cm06=c2.cp02(+) and cm07=c2.cp03(+) and cm08=c2.cp04(+) and c2.cp10 in (" & GetAddStr(CaseMapOut) & ") ) AA where AA.A=AA.B "
            Set rsgnd2 = New ADODB.Recordset
            If rsgnd2.State = 1 Then rsgnd2.Close
            rsgnd2.CursorLocation = adUseClient
            rsgnd2.Open Strgnd2, cnnConnection, adOpenStatic, adLockReadOnly
            If rsgnd2.RecordCount <> 0 Then
                MyBaseDate = Trim(Val("10") - oDelayDay)
            End If
        End If
        MyCp48 = CompWorkDay(Val(MyBaseDate), oMyStdDate, 0)
        If oMyMaxDate <> "" Then
            If MyCp48 > oMyMaxDate Then
                MyCp48 = oMyMaxDate
            End If
        End If
    'edit by nickc 2007/10/31 秀玲說取消
    'add by nickc 2007/10/24 秀玲說，若是沒有的話，傳回起始日
    'Else
    '    MyCp48 = oMyStdDate
    End If
End If
'Add by Morgan 2007/12/11 若有承辦期限且最大期限小於系統日時，承辦期限設定為系統日
If MyCp48 <> "" And oMaxDayW <> "" And Val(oMaxDayW) < Val(strSrvDate(1)) Then
   MyCp48 = strSrvDate(1)
End If
'end 2007/12/11
Pub_GetHandleDay = MyCp48
End Function

'add by nickc 2007/10/16 取得系統特殊設定之人員
'Added by Lydia 2016/08/03 加模糊查詢 bRLike
'Modify by Sindy 2023/5/4 + 增加排除的字樣 : Optional ByVal strNotInStr As String = ""
Public Function Pub_GetSpecMan(oCode As String, Optional ByVal bRlike As Boolean = False, _
   Optional ByVal strNotInStr As String = "") As String
Dim midSql As String 'Added by Lydia 2016/08/03
CheckOC3
Pub_GetSpecMan = ""
With AdoRecordSet3
    .CursorLocation = adUseClient
    'Added by Lydia 2016/08/03 加模糊查詢 (合併多筆)
    If bRlike = True Then
        'Modify By Sindy 2023/5/4 ex:Pub_GetSpecMan("MCTF", True,"收信人員")
        If strNotInStr <> "" Then
           .Open "select distinct oMan from setSpecMan where ocode like '" & oCode & "%' and InStr(ocode,'" & strNotInStr & "')=0 ", cnnConnection, adOpenStatic, adLockReadOnly
        Else
        '2023/5/4 END
           .Open "select distinct oMan from setSpecMan where ocode like '" & oCode & "%' ", cnnConnection, adOpenStatic, adLockReadOnly
        End If
        If .RecordCount <> 0 Then
           .MoveFirst
           Do While Not .EOF
              Pub_GetSpecMan = Pub_GetSpecMan & IIf(Pub_GetSpecMan <> "", ";", "") & Replace(CheckStr(.Fields("oMan")), ",", ";")
              .MoveNext
           Loop
        End If
    Else  '原本只抓單筆
        .Open "select distinct oMan from setSpecMan where ocode='" & oCode & "' ", cnnConnection, adOpenStatic, adLockReadOnly
        If .RecordCount <> 0 Then
            Pub_GetSpecMan = Replace(CheckStr(.Fields("oMan")), ",", ";")
        End If
    End If
    'end 2016/08/03
    If Right(Pub_GetSpecMan, 1) = ";" Then
        Pub_GetSpecMan = Mid(Pub_GetSpecMan, 1, Len(Pub_GetSpecMan) - 1)
    End If
End With
CheckOC3
End Function

Public Function PUB_CopyImgFile(p_fPA() As String, p_tPA() As String) As Boolean
Dim stSQL As String, iTmp As Integer, iFields As Integer
Dim ibf() As String
Dim bytes() As Byte
Dim strIBF05 As String, p_FileName As String, strFtpPath As String
Dim adoRst As New ADODB.Recordset 'Add By Sindy 2017/8/15
Dim RsQ As New ADODB.Recordset 'Add by Amy 2018/07/23
   
   'Modify by Amy 2018/07/23 +彩色代表圖 拿掉 and ibf05='1'
   'Modify By Sindy 2018/10/31 TF馬德里商標圖檔-子案的圖同母案
   '固定都以IBF01=tm01 AND IBF02=substr(tm02,1,5)||'0' AND IBF03='0' AND IBF04='00' 去抓代表圖
   If p_fPA(1) = "TF" Then
      stSQL = "select * from imgbytefile where ibf01='" & p_fPA(1) & "' and ibf02='" & Mid(p_fPA(2), 1, 5) & "0" & "' And ibf03='0' And ibf04='00' " & _
                   "Order by ibf05 Asc"
   Else
   '2018/10/31 END
      stSQL = "select * from imgbytefile where ibf01='" & p_fPA(1) & "' and ibf02='" & p_fPA(2) & "' and ibf03='" & p_fPA(3) & "' and ibf04='" & p_fPA(4) & "' " & _
                   "Order by ibf05 Asc"
   End If
   iTmp = 1
   With RsQ
      .CursorLocation = adUseClient
      .Open stSQL, cnnConnection, adOpenStatic, adLockOptimistic
      If .RecordCount > 0 Then
        adoRst.CursorLocation = adUseClient
        adoRst.Open stSQL, cnnConnection, adOpenStatic, adLockOptimistic
         .MoveFirst
          Do While Not .EOF
             'Add By Sindy 2017/8/10 下載檔案
             strIBF05 = .Fields("IBF05")
             p_FileName = App.path & "\TempFile"
             RidFile p_FileName
             If "" & .Fields("IBF15") <> "" Then
                If PUB_GetFtpFile(.Fields("IBF15"), p_FileName, UCase("ImgByteFile")) = False Then
                   GoTo CancleUpdate
                End If
             End If
             '2017/8/10 END
             
             iFields = .Fields.Count
             ReDim ibf(iFields - 1)
             For iTmp = 0 To iFields - 1
    '            If LCase(.Fields(iTmp).Name) = "ibf14" Then
    '               ReDim bytes(Val(.Fields("ibf13").Value))
    '               bytes() = .Fields(iTmp).GetChunk(Val(.Fields("ibf13")))
    '            Else
                If LCase(.Fields(iTmp).Name) = "ibf07" Or _
                   LCase(.Fields(iTmp).Name) = "ibf10" Or _
                   LCase(.Fields(iTmp).Name) = "ibf11" Or _
                   LCase(.Fields(iTmp).Name) = "ibf12" Then
                   ibf(iTmp) = ""
                ElseIf LCase(.Fields(iTmp).Name) = "ibf08" Then
                   ibf(iTmp) = Val(Format(Date, "yyyymmdd"))
                ElseIf LCase(.Fields(iTmp).Name) = "ibf09" Then
                   ibf(iTmp) = Val(Format(time, "HHMM"))
                Else
                   ibf(iTmp) = "" & .Fields(iTmp)
                End If
             Next
             adoRst.AddNew
         
On Error GoTo CancleUpdate

             For iTmp = 0 To iFields - 1
    '            If LCase(.Fields(iTmp).Name) = "ibf14" Then
    '               .Fields(iTmp).AppendChunk bytes()
    '            Else
                If LCase(.Fields(iTmp).Name) = "ibf01" Then
                   adoRst.Fields(iTmp) = p_tPA(1)
                ElseIf LCase(.Fields(iTmp).Name) = "ibf02" Then
                   adoRst.Fields(iTmp) = p_tPA(2)
                ElseIf LCase(.Fields(iTmp).Name) = "ibf03" Then
                   adoRst.Fields(iTmp) = p_tPA(3)
                ElseIf LCase(.Fields(iTmp).Name) = "ibf04" Then
                   adoRst.Fields(iTmp) = p_tPA(4)
                ElseIf ibf(iTmp) <> "" Then
                   adoRst.Fields(iTmp) = ibf(iTmp)
                End If
             Next
             
             'Modify By Sindy 2017/8/10
             '檔案改放FTP
             'If Dir(p_FileName) <> "" Then
             If FileExists(p_FileName) Then
                PUB_PutFtpFile p_FileName, p_tPA(1) & "-" & p_tPA(2) & "-" & p_tPA(3) & "-" & p_tPA(4) & "-" & strIBF05, p_tPA(1) & "-" & p_tPA(2) & "-" & p_tPA(3) & "-" & p_tPA(4) & "-" & strIBF05, strFtpPath, UCase("imgbytefile")
                If strFtpPath <> "" Then
                   adoRst.Fields("ibf15") = strFtpPath
                End If
             End If
             '2017/8/10 END
             
             adoRst.UPDATE
             PUB_CopyImgFile = True
             .MoveNext
         Loop
      End If
   End With
   
   Set RsQ = Nothing
   'end 2018/07/23
   Set adoRst = Nothing 'Add By Sindy 2017/8/15
   Exit Function
   
CancleUpdate:
   adoRst.CancelUpdate
End Function

'Add by Morgan 2007/10/26
'專利權讓與年費期限檢查
Public Function PUB_708FeeCheck(pa() As String, Optional p_NP07 As String, Optional p_NP08 As String, Optional p_NP09 As String) As Boolean
   Dim iBasType As Integer '起算日種類
   Dim strBasDate As String '起算日
   Dim strFeeYears As String '繳費年度
   Dim strLstPayYr As String '最後繳費年
   Dim strNxtPayYr As String '下次繳費年
   Dim arrFeeYr, arrPayYr
   Dim strTmp As String, intA As Integer, rsAD As New ADODB.Recordset 'Added by Lydia 2024/05/15

   'Added by Lydia 2025/10/29
   Dim m_bolFMP As Boolean
   m_bolFMP = PUB_ChkIsFMP(pa(1), pa(2), pa(3), pa(4), pa(9))
   'end 2025/10/29
   
   strTmp = "SELECT * FROM NATION WHERE NA01='" & pa(9) & "'"
   intA = 1
   Set rsAD = ClsLawReadRstMsg(intA, strTmp)
   If intA = 1 Then
      '年費案件性質
      Select Case pa(8)
         Case "1"
            p_NP07 = "" & rsAD("na20")
            strFeeYears = "" & rsAD("na21")
            iBasType = Val("" & rsAD("na06"))
         Case "2"
            p_NP07 = "" & rsAD("na22")
            '舊法新型專用期12年
            If pa(9) = "000" And pa(8) = "2" And Val(pa(14)) > 0 And Val(DBDATE(pa(14))) < 20040701 Then
               strFeeYears = "1,2,3,4,5,6,7,8,9,10,11,12"
            Else
               strFeeYears = "" & rsAD("na23")
            End If
            
            iBasType = Val("" & rsAD("na08"))
         Case "3"
            p_NP07 = "" & rsAD("na24")
            strFeeYears = "" & rsAD("na25")
            iBasType = Val("" & rsAD("na10"))
      End Select
      Select Case iBasType
         Case 2
            strBasDate = DBDATE(pa(10))
         Case 4
            strBasDate = DBDATE(pa(20))
         Case 5
            strBasDate = DBDATE(pa(14))
         Case 6
            strBasDate = DBDATE(pa(21))
         Case 7
            strBasDate = DBDATE(pa(12))
      End Select
      If p_NP07 <> "" And strFeeYears <> "" Then
         '檢查是否有掛期限或收文
         strTmp = "select np01 from nextprogress where np02='" & pa(1) & "' and np03='" & pa(2) & "' and np04='" & pa(3) & "' and np05='" & pa(4) & "' and np06 is null and np07='" & p_NP07 & "'"
         strTmp = strTmp & " union select cp09 from caseprogress where cp01='" & pa(1) & "' and cp02='" & pa(2) & "' and cp03='" & pa(3) & "' and cp04='" & pa(4) & "' and cp57 is null and cp27 is null and cp10='" & p_NP07 & "'"
         intA = 1
         Set rsAD = ClsLawReadRstMsg(intA, strTmp)
         '已有年費期限
         If intA = 1 Then
            PUB_708FeeCheck = True
         Else
            arrFeeYr = Split(strFeeYears, ",")
            strNxtPayYr = arrFeeYr(0)
            If pa(72) <> "" Then
               arrPayYr = Split(pa(72), ",")
               strLstPayYr = arrPayYr(UBound(arrPayYr))
               For intA = LBound(arrFeeYr) To UBound(arrFeeYr)
                  If arrFeeYr(intA) = strLstPayYr Then
                     If intA + 1 <= UBound(arrFeeYr) Then
                        strNxtPayYr = arrFeeYr(intA + 1)
                     Else
                        strNxtPayYr = ""
                     End If
                     Exit For
                  End If
               Next
            End If
            '沒有下次繳費年
            If strNxtPayYr = "" Then
               PUB_708FeeCheck = True
            Else
               If p_NP07 = "605" And Val(strLstPayYr) > 0 Then
                  p_NP09 = CompDate(0, Val(strLstPayYr), strBasDate)
               Else
                  p_NP09 = CompDate(0, Val(strNxtPayYr), strBasDate)
               End If
               If pa(9) = "000" Then
                  p_NP09 = CompDate(2, -1, p_NP09)
                  'Added by Morgan 2014/10/28
                  'Modified by Morgan 2014/11/20 外專改回舊規則
                  If pa(9) = 台灣國家代號 And strSrvDate(1) >= 台灣案所限新規則啟用日 And pa(1) <> "FCP" Then
                     p_NP08 = PUB_GetOurDeadline(p_NP09)
                     
                  'Added by Morgan 2019/7/11 外專台灣案所限以改工作天計算
                  ElseIf strSrvDate(1) >= 外專台灣案所限新規則啟用日 And pa(1) = "FCP" Then
                     p_NP08 = PUB_GetFCPOurDeadline(p_NP09, 2)
                  
                  'end 2019/7/11
                  Else
                  'end 2014/10/28
                     p_NP08 = CompDate(2, -2, p_NP09)
                  End If
               Else
                  'Added by Lydia 2025/10/29
                  If m_bolFMP = False And strSrvDate(1) >= 內專本所約定期限啟用日 Then
                      p_NP08 = PUB_GetPOurDeadline(p_NP09, pa(9))
                  Else
                  'end 2025/10/29
                      p_NP08 = CompDate(1, -1, p_NP09)
                      p_NP08 = CompDate(2, -5, p_NP08)
                  End If 'Added by Lydia 2025/10/29
                  
               End If
               p_NP08 = PUB_GetWorkDay1(p_NP08, True)
            End If
         End If
      End If
   End If
   Set rsAD = Nothing 'Added by Lydia 2024/05/15
End Function

'Add by Morgan 2007/10/29
'FCP核對已准專利檢查 pa141->fa85->cu122(任一申請人設不核對該案就不核對)
Public Function PUB_CheckAuto926(pa() As String) As Boolean
   Dim stSQL As String, intR As Integer
   stSQL = "select nvl(pa141,nvl(fa85,nvl(c1.cu122,nvl(c2.cu122,nvl(c3.cu122,nvl(c4.cu122,c5.cu122))))))" & _
      " from patent,fagent,customer c1,customer c2,customer c3, customer c4,customer c5" & _
      " where pa01='" & pa(1) & "' and pa02='" & pa(2) & "' and pa03='" & pa(3) & "' and pa04='" & pa(4) & "'" & _
      " and fa01(+)=substr(pa75,1,8) and fa02(+)=substr(pa75,9,1)" & _
      " and c1.cu01(+)=substr(pa26,1,8) and c1.cu02(+)=substr(pa26,9,1)" & _
      " and c2.cu01(+)=substr(pa27,1,8) and c2.cu02(+)=substr(pa27,9,1)" & _
      " and c3.cu01(+)=substr(pa28,1,8) and c3.cu02(+)=substr(pa28,9,1)" & _
      " and c4.cu01(+)=substr(pa29,1,8) and c4.cu02(+)=substr(pa29,9,1)" & _
      " and c5.cu01(+)=substr(pa30,1,8) and c5.cu02(+)=substr(pa30,9,1)"
   intR = 1
   Set AdoRecordSet3 = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      If IsNull(AdoRecordSet3(0)) Then
         PUB_CheckAuto926 = True
      End If
   End If
End Function

'add by nickc 2007/11/08 數字輸入才有效
'Modified by Lydia 2018/11/06 Form2.0改型態
'Function Pub_NumAscii(oKeyAscii As Integer, Optional CanDecimal As Boolean = False) As Integer
Function Pub_NumAscii(oKeyAscii, Optional CanDecimal As Boolean = False) As Integer
   If (oKeyAscii >= 48 And oKeyAscii <= 57) Or oKeyAscii = 13 Or oKeyAscii = 8 Or oKeyAscii = 9 Or oKeyAscii = 27 Or oKeyAscii = 113 Or oKeyAscii = 114 Or oKeyAscii = 120 Or oKeyAscii = 121 Then
       Pub_NumAscii = oKeyAscii
   Else
       If CanDecimal = True And oKeyAscii = 46 Then
           Pub_NumAscii = oKeyAscii
       Else
           oKeyAscii = 0
       End If
   End If
End Function

'add by nickc  2007/11/16 取得MSHFlexGrid 正確的 row & col
Public Sub getGrdColRow(ByRef oObj As MSHFlexGrid, ByVal x As Single, ByVal y As Single, ByRef col As Long, ByRef row As Long)
Dim nIndex As Long
col = 0: row = 0
For nIndex = 0 To oObj.Rows - 1
    If y > oObj.RowHeight(nIndex) Then
        row = row + 1
        y = y - oObj.RowHeight(nIndex)
    ElseIf y > 0 Then
        row = row + 1
        Exit For
    End If
Next nIndex
For nIndex = 0 To oObj.Cols - 1
    If x > oObj.ColWidth(nIndex) Then
        col = col + 1
        x = x - oObj.ColWidth(nIndex)
    ElseIf x > 0 Then
        col = col + 1
        Exit For
    End If
Next nIndex
'col = col - 1 + IIf(oObj.LeftCol <> oObj.FixedCols, oObj.LeftCol - oObj.FixedCols, 0)
'row = row - 1 + IIf(oObj.TopRow <> oObj.FixedRows, oObj.TopRow - oObj.FixedRows, 0)
col = col - 1 + IIf(oObj.LeftCol <> oObj.FixedCols And oObj.LeftCol <> 0, oObj.LeftCol - oObj.FixedCols, 0)
row = row - 1 + IIf(oObj.TopRow <> oObj.FixedRows And oObj.TopRow <> 0, oObj.TopRow - oObj.FixedRows, 0)

If col > oObj.Cols - 1 Then col = oObj.Cols - 1
If row > oObj.Rows - 1 Then row = oObj.Rows - 1
End Sub

'Added by Lydia 2016/08/11 取得MSFlexGrid正確的 row & col
Public Sub Pub_MSFGrdColRow(ByRef oObj As MSFlexGrid, ByVal x As Single, ByVal y As Single, ByRef col As Long, ByRef row As Long)
Dim nIndex As Long
col = 0: row = 0
For nIndex = 0 To oObj.Rows - 1
    If y > oObj.RowHeight(nIndex) Then
        row = row + 1
        y = y - oObj.RowHeight(nIndex)
    ElseIf y > 0 Then
        row = row + 1
        Exit For
    End If
Next nIndex
For nIndex = 0 To oObj.Cols - 1
    If x > oObj.ColWidth(nIndex) Then
        col = col + 1
        x = x - oObj.ColWidth(nIndex)
    ElseIf x > 0 Then
        col = col + 1
        Exit For
    End If
Next nIndex

col = col - 1 + IIf(oObj.LeftCol <> oObj.FixedCols And oObj.LeftCol <> 0, oObj.LeftCol - oObj.FixedCols, 0)
row = row - 1 + IIf(oObj.TopRow <> oObj.FixedRows And oObj.TopRow <> 0, oObj.TopRow - oObj.FixedRows, 0)

If col > oObj.Cols - 1 Then col = oObj.Cols - 1
If row > oObj.Rows - 1 Then row = oObj.Rows - 1
End Sub

'Add by Morgan 2007/11/28 部門選單
'Modify By Sindy 2021/7/16 改為用 Object 型態
'Public Sub PUB_AddDeptCombo(ByRef p_cbo As ComboBox)
Public Sub PUB_AddDeptCombo(ByRef p_cbo As Object)
   With p_cbo
      .Clear
      .AddItem "Accounting"
      .AddItem "IP Dept."
      .AddItem "Legal Dept."
      .AddItem "Patent Dept."
      .AddItem "Trademark Dept."
   End With
End Sub

'Add by Morgan 2007/11/28 職稱選單
'Modify By Sindy 2021/7/16 改為用 Object 型態
'Public Sub PUB_AddTitleCombo(ByRef p_cbo As ComboBox)
Public Sub PUB_AddTitleCombo(ByRef p_cbo As Object)
   With p_cbo
      .Clear
      .AddItem "Accounting"
      .AddItem "Advocate"
      .AddItem "Assistant"
      .AddItem "Associate"
      .AddItem "Associate Director"
      .AddItem "Attorney-at-Law"
      .AddItem "Barrister-at-Law"
      .AddItem "Deputy Director"
      .AddItem "Director"
      .AddItem "Engineer"
      .AddItem "Head of General Department"
      .AddItem "IP Agent"
      .AddItem "Lawyer"
      .AddItem "Legal Assistant"
      .AddItem "Manager"
      .AddItem "Managing Director"
      .AddItem "Managing Partner"
      .AddItem "Notary Public"
      .AddItem "Paralegal"
      .AddItem "Partner"
      .AddItem "Patent Agent"
      .AddItem "Patent Attorney"
      .AddItem "Patent consultant"
      .AddItem "President"
      .AddItem "Solicitor"
      .AddItem "Trademark Agent"
      .AddItem "Trademark Manager"
      .AddItem "Vice Chairman of the board"
      .AddItem "VP"
   End With
End Sub

'Add by Sindy 2020/3/10 專利案件屬性選單
'Modify By Sindy 2021/7/16 改為用 Object 型態
Public Sub PUB_AddCaseAttributeCombo(ByRef p_cbo As Object, ByVal strPA08 As String)
   With p_cbo
      .Clear
      If strPA08 = "3" Then '設計案
         .AddItem "1.整體"
         .AddItem "2.部分"
         .AddItem "3.圖像"
         .AddItem "4.成組"
      Else
         .AddItem "1.機械"
         .AddItem "2.電子電機"
         .AddItem "3.化學生醫"
      End If
   End With
End Sub

'Add by Morgan 2007/11/29
'檢查是否有相關案(包含本案)已扣支援點數
Public Function PUB_ChkP4SH(p_CP09 As String) As Boolean
   Dim stSQL As String, stVTB As String, intR As Integer
   Dim adoRst As ADODB.Recordset
   
   'Modify by Morgan 2010/7/20 一案兩請也只扣一次
   'Modified by Morgan 2013/8/14
   'stVTB = "select cp01||cp02||cp03||cp04 from caseprogress where cp09='" & p_CP09 & "'" & _
       " union all select cm01||cm02||cm03||cm04 from caseprogress, casemap" & _
       " where cp09='" & p_CP09 & "' and cm05(+)=cp01 and cm06(+)=cp02 and cm07(+)=cp03 and cm08(+)=cp04 and cm10 in ('0','3')" & _
       " union all select cm05||cm06||cm07||cm08 from caseprogress, casemap" & _
       " where cp09='" & p_CP09 & "' and cm01(+)=cp01 and cm02(+)=cp02 and cm03(+)=cp03 and cm04(+)=cp04 and cm10 in ('0','3')" & _
       " union all select cr01||cr02||cr03||cr04 from caseprogress, caserelation" & _
       " where cp09='" & p_CP09 & "' and cr05(+)=cp01 and cr06(+)=cp02 and cr07(+)=cp03 and cr08(+)=cp04 and cr01 is not null" & _
       " union all select cr01||cr02||cr03||cr04 from caseprogress,casemap, caserelation" & _
       " where cp09='" & p_CP09 & "' and cm01(+)=cp01 and cm02(+)=cp02 and cm03(+)=cp03 and cm04(+)=cp04 and cm10 in ('0','3')" & _
       " and cr05(+)=cm05 and cr06(+)=cm06 and cr07(+)=cm07 and cr08(+)=cm08 and cr01 is not null" & _
       " union all select cr01||cr02||cr03||cr04 from caseprogress,casemap, caserelation" & _
       " where cp09='" & p_CP09 & "' and cm05(+)=cp01 and cm06(+)=cp02 and cm07(+)=cp03 and cm08(+)=cp04 and cm10 in ('0','3')" & _
       " and cr05(+)=cm01 and cr06(+)=cm02 and cr07(+)=cm03 and cr08(+)=cm04 and cr01 is not null"
   stVTB = PUB_GetSameCaseSQL(p_CP09)
   'end 2013/8/14
   
   'Modify by Morgan 2011/3/16 +抓acc021,因為有可能收款後才人工輸入傳票作支援點數
   stSQL = "select a1p17 from acc1p0 where rownum<2 and  substr(a1p05,1,1)='4' and a1p08=5000 and a1p16='P1001'" & _
      " and a1p17 in(" & stVTB & ")" & _
      " union select ax214 from acc021 where rownum<2 and  substr(ax205,1,1)='4' and ax207=5000 and ax209='P1001'" & _
      " and ax214 in(" & stVTB & ")"
      
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      PUB_ChkP4SH = True
   End If
   Set adoRst = Nothing
End Function

'Added by Morgan 2013/8/14
'相同案語法(收文號)
Public Function PUB_GetSameCaseSQL(p_CP09 As String) As String
   Dim stVTB As String
   '本案
   stVTB = "select cp01||cp02||cp03||cp04 CNo from caseprogress where cp09='" & p_CP09 & "'"
   '國內案
   stVTB = stVTB & " union select cm05||cm06||cm07||cm08 from caseprogress, casemap where cp09='" & p_CP09 & "'" & _
      " and cm01(+)=cp01 and cm02(+)=cp02 and cm03(+)=cp03 and cm04(+)=cp04 and cm10 in ('0','3')"
   '國內案的國外案
   stVTB = stVTB & " union select b.cm01||b.cm02||b.cm03||b.cm04 from caseprogress,casemap a,casemap b where cp09='" & p_CP09 & "'" & _
      " and a.cm01(+)=cp01 and a.cm02(+)=cp02 and a.cm03(+)=cp03 and a.cm04(+)=cp04 and a.cm10 in ('0','3')" & _
      " and b.cm05(+)=a.cm05 and b.cm06(+)=a.cm06 and b.cm07(+)=a.cm07 and b.cm08(+)=a.cm08 and b.cm10 in ('0','3')"
   '國內案的國外案的國外案
   stVTB = stVTB & " union select c.cm01||c.cm02||c.cm03||c.cm04 from caseprogress,casemap a,casemap b,casemap c where cp09='" & p_CP09 & "'" & _
      " and a.cm01(+)=cp01 and a.cm02(+)=cp02 and a.cm03(+)=cp03 and a.cm04(+)=cp04 and a.cm10 in ('0','3')" & _
      " and b.cm05(+)=a.cm05 and b.cm06(+)=a.cm06 and b.cm07(+)=a.cm07 and b.cm08(+)=a.cm08 and b.cm10 in ('0','3')" & _
      " and c.cm05(+)=b.cm01 and c.cm06(+)=b.cm02 and c.cm07(+)=b.cm03 and c.cm08(+)=b.cm04 and c.cm10 in ('0','3')"
   '國內案的國內案
   stVTB = stVTB & " union select b.cm05||b.cm06||b.cm07||b.cm08 from caseprogress,casemap a,casemap b where cp09='" & p_CP09 & "'" & _
      " and a.cm01(+)=cp01 and a.cm02(+)=cp02 and a.cm03(+)=cp03 and a.cm04(+)=cp04 and a.cm10 in ('0','3')" & _
      " and b.cm01(+)=a.cm05 and b.cm02(+)=a.cm06 and b.cm03(+)=a.cm07 and b.cm04(+)=a.cm08 and b.cm10 in ('0','3')"
   '國內案的國內案的國外案
   stVTB = stVTB & " union select c.cm01||c.cm02||c.cm03||c.cm04 from caseprogress,casemap a,casemap b,casemap c where cp09='" & p_CP09 & "'" & _
      " and a.cm01(+)=cp01 and a.cm02(+)=cp02 and a.cm03(+)=cp03 and a.cm04(+)=cp04 and a.cm10 in ('0','3')" & _
      " and b.cm01(+)=a.cm05 and b.cm02(+)=a.cm06 and b.cm03(+)=a.cm07 and b.cm04(+)=a.cm08 and b.cm10 in ('0','3')" & _
      " and c.cm05(+)=b.cm05 and c.cm06(+)=b.cm06 and c.cm07(+)=b.cm07 and c.cm08(+)=b.cm08 and c.cm10 in ('0','3')"
   '國外案
   stVTB = stVTB & " union select cm01||cm02||cm03||cm04 from caseprogress, casemap where cp09='" & p_CP09 & "'" & _
      " and cm05(+)=cp01 and cm06(+)=cp02 and cm07(+)=cp03 and cm08(+)=cp04 and cm10 in ('0','3')"
   '國外案的國外案
   stVTB = stVTB & " union select b.cm01||b.cm02||b.cm03||b.cm04 from caseprogress,casemap a,casemap b where cp09='" & p_CP09 & "'" & _
      " and a.cm05(+)=cp01 and a.cm06(+)=cp02 and a.cm07(+)=cp03 and a.cm08(+)=cp04 and a.cm10 in ('0','3')" & _
      " and b.cm05(+)=a.cm01 and b.cm06(+)=a.cm02 and b.cm07(+)=a.cm03 and b.cm08(+)=a.cm04 and b.cm10 in ('0','3')"
   '國外案的國外案的國外案
   stVTB = stVTB & " union select c.cm01||c.cm02||c.cm03||c.cm04 from caseprogress,casemap a,casemap b,casemap c where cp09='" & p_CP09 & "'" & _
      " and a.cm05(+)=cp01 and a.cm06(+)=cp02 and a.cm07(+)=cp03 and a.cm08(+)=cp04 and a.cm10 in ('0','3')" & _
      " and b.cm05(+)=a.cm01 and b.cm06(+)=a.cm02 and b.cm07(+)=a.cm03 and b.cm08(+)=a.cm04 and b.cm10 in ('0','3')" & _
      " and c.cm05(+)=b.cm01 and c.cm06(+)=b.cm02 and c.cm07(+)=b.cm03 and c.cm08(+)=b.cm04 and c.cm10 in ('0','3')"
   '國外案的國內案
   stVTB = stVTB & " union select b.cm05||b.cm06||b.cm07||b.cm08 from caseprogress,casemap a,casemap b where cp09='" & p_CP09 & "'" & _
      " and a.cm05(+)=cp01 and a.cm06(+)=cp02 and a.cm07(+)=cp03 and a.cm08(+)=cp04 and a.cm10 in ('0','3')" & _
      " and b.cm01(+)=a.cm01 and b.cm02(+)=a.cm02 and b.cm03(+)=a.cm03 and b.cm04(+)=a.cm04 and b.cm10 in ('0','3')"
   '國外案的國內案的國外案
   stVTB = stVTB & " union select c.cm01||c.cm02||c.cm03||c.cm04 from caseprogress,casemap a,casemap b,casemap c where cp09='" & p_CP09 & "'" & _
      " and a.cm05(+)=cp01 and a.cm06(+)=cp02 and a.cm07(+)=cp03 and a.cm08(+)=cp04 and a.cm10 in ('0','3')" & _
      " and b.cm01(+)=a.cm01 and b.cm02(+)=a.cm02 and b.cm03(+)=a.cm03 and b.cm04(+)=a.cm04 and b.cm10 in ('0','3')" & _
      " and c.cm05(+)=b.cm05 and c.cm06(+)=b.cm06 and c.cm07(+)=b.cm07 and c.cm08(+)=b.cm08 and c.cm10 in ('0','3')"
   '多國案
   stVTB = stVTB & " union select cr01||cr02||cr03||cr04 from caseprogress, caserelation where cp09='" & p_CP09 & "'" & _
      " and cr05(+)=cp01 and cr06(+)=cp02 and cr07(+)=cp03 and cr08(+)=cp04 and cr01 is not null"
   PUB_GetSameCaseSQL = stVTB
End Function

'相同案語法(本所案號)
Public Function PUB_GetSameCaseSQL2(p_Cp01 As String, p_Cp02 As String, p_Cp03 As String, p_Cp04 As String) As String
   Dim stVTB As String
   '本案
   stVTB = "select '" & p_Cp01 & p_Cp02 & p_Cp03 & p_Cp04 & "' CNo from Dual"
   '國內案
   stVTB = stVTB & " union select cm05||cm06||cm07||cm08 from casemap" & _
      " where cm01='" & p_Cp01 & "' and cm02='" & p_Cp02 & "' and cm03='" & p_Cp03 & "' and cm04='" & p_Cp04 & "' and cm10 in ('0','3')"
   '國內案的國外案
   stVTB = stVTB & " union select b.cm01||b.cm02||b.cm03||b.cm04 from casemap a,casemap b" & _
      " where a.cm01='" & p_Cp01 & "' and a.cm02='" & p_Cp02 & "' and a.cm03='" & p_Cp03 & "' and a.cm04='" & p_Cp04 & "' and a.cm10 in ('0','3')" & _
      " and b.cm05(+)=a.cm05 and b.cm06(+)=a.cm06 and b.cm07(+)=a.cm07 and b.cm08(+)=a.cm08 and b.cm10 in ('0','3')"
   '國內案的國外案的國外案
   stVTB = stVTB & " union select c.cm01||c.cm02||c.cm03||c.cm04 from casemap a,casemap b,casemap c" & _
      " where a.cm01='" & p_Cp01 & "' and a.cm02='" & p_Cp02 & "' and a.cm03='" & p_Cp03 & "' and a.cm04='" & p_Cp04 & "' and a.cm10 in ('0','3')" & _
      " and b.cm05(+)=a.cm05 and b.cm06(+)=a.cm06 and b.cm07(+)=a.cm07 and b.cm08(+)=a.cm08 and b.cm10 in ('0','3')" & _
      " and c.cm05(+)=b.cm01 and c.cm06(+)=b.cm02 and c.cm07(+)=b.cm03 and c.cm08(+)=b.cm04 and c.cm10 in ('0','3')"
   '國內案的國內案
   stVTB = stVTB & " union select b.cm05||b.cm06||b.cm07||b.cm08 from casemap a,casemap b" & _
      " where a.cm01='" & p_Cp01 & "' and a.cm02='" & p_Cp02 & "' and a.cm03='" & p_Cp03 & "' and a.cm04='" & p_Cp04 & "' and a.cm10 in ('0','3')" & _
      " and b.cm01(+)=a.cm05 and b.cm02(+)=a.cm06 and b.cm03(+)=a.cm07 and b.cm04(+)=a.cm08 and b.cm10 in ('0','3')"
   '國內案的國內案的國外案
   stVTB = stVTB & " union select c.cm01||c.cm02||c.cm03||c.cm04 from casemap a,casemap b,casemap c" & _
      " where a.cm01='" & p_Cp01 & "' and a.cm02='" & p_Cp02 & "' and a.cm03='" & p_Cp03 & "' and a.cm04='" & p_Cp04 & "' and a.cm10 in ('0','3')" & _
      " and b.cm01(+)=a.cm05 and b.cm02(+)=a.cm06 and b.cm03(+)=a.cm07 and b.cm04(+)=a.cm08 and b.cm10 in ('0','3')" & _
      " and c.cm05(+)=b.cm05 and c.cm06(+)=b.cm06 and c.cm07(+)=b.cm07 and c.cm08(+)=b.cm08 and c.cm10 in ('0','3')"
   '國外案
   stVTB = stVTB & " union select cm01||cm02||cm03||cm04 from casemap" & _
      " where cm05='" & p_Cp01 & "' and cm06='" & p_Cp02 & "' and cm07='" & p_Cp03 & "' and cm08='" & p_Cp04 & "' and cm10 in ('0','3')"
   '國外案的國外案
   stVTB = stVTB & " union select b.cm01||b.cm02||b.cm03||b.cm04 from casemap a,casemap b" & _
      " where a.cm05='" & p_Cp01 & "' and a.cm06='" & p_Cp02 & "' and a.cm07='" & p_Cp03 & "' and a.cm08='" & p_Cp04 & "' and a.cm10 in ('0','3')" & _
      " and b.cm05(+)=a.cm01 and b.cm06(+)=a.cm02 and b.cm07(+)=a.cm03 and b.cm08(+)=a.cm04 and b.cm10 in ('0','3')"
   '國外案的國外案的國外案
   stVTB = stVTB & " union select c.cm01||c.cm02||c.cm03||c.cm04 from casemap a,casemap b,casemap c" & _
      " where a.cm05='" & p_Cp01 & "' and a.cm06='" & p_Cp02 & "' and a.cm07='" & p_Cp03 & "' and a.cm08='" & p_Cp04 & "' and a.cm10 in ('0','3')" & _
      " and b.cm05(+)=a.cm01 and b.cm06(+)=a.cm02 and b.cm07(+)=a.cm03 and b.cm08(+)=a.cm04 and b.cm10 in ('0','3')" & _
      " and c.cm05(+)=b.cm01 and c.cm06(+)=b.cm02 and c.cm07(+)=b.cm03 and c.cm08(+)=b.cm04 and c.cm10 in ('0','3')"
   '國外案的國內案
   stVTB = stVTB & " union select b.cm05||b.cm06||b.cm07||b.cm08 from casemap a,casemap b" & _
      " where a.cm05='" & p_Cp01 & "' and a.cm06='" & p_Cp02 & "' and a.cm07='" & p_Cp03 & "' and a.cm08='" & p_Cp04 & "' and a.cm10 in ('0','3')" & _
      " and b.cm01(+)=a.cm01 and b.cm02(+)=a.cm02 and b.cm03(+)=a.cm03 and b.cm04(+)=a.cm04 and b.cm10 in ('0','3')"
   '國外案的國內案的國外案
   stVTB = stVTB & " union select c.cm01||c.cm02||c.cm03||c.cm04 from casemap a,casemap b,casemap c" & _
      " where a.cm05='" & p_Cp01 & "' and a.cm06='" & p_Cp02 & "' and a.cm07='" & p_Cp03 & "' and a.cm08='" & p_Cp04 & "' and a.cm10 in ('0','3')" & _
      " and b.cm01(+)=a.cm05 and b.cm02(+)=a.cm06 and b.cm03(+)=a.cm07 and b.cm04(+)=a.cm08 and b.cm10 in ('0','3')" & _
      " and c.cm05(+)=b.cm05 and c.cm06(+)=b.cm06 and c.cm07(+)=b.cm07 and c.cm08(+)=b.cm08 and c.cm10 in ('0','3')"
   '多國案
   stVTB = stVTB & " union select cr01||cr02||cr03||cr04 from caserelation" & _
      " where cr05='" & p_Cp01 & "' and cr06='" & p_Cp02 & "' and cr07='" & p_Cp03 & "' and cr08='" & p_Cp04 & "'"
   PUB_GetSameCaseSQL2 = stVTB
End Function

'Add by Morgan 2007/11/29
'檢查是否有相關案已有核可的支援紀錄
Public Function PUB_ChkSH(p_CP09 As String, p_SH01 As String, p_SH02 As String, p_SH03 As String, p_SH04 As String) As Boolean
   Dim stSQL As String, stVTB As String, intR As Integer
   Dim adoRst As ADODB.Recordset
   'Modify by Morgan 2010/7/20 一案兩請也只扣一次
   'Modified by Morgan 2013/8/14
   'stVTB = "select cp01,cp02,cp03,cp04 from caseprogress where cp09='" & p_CP09 & "'" & _
       " union all select cm01,cm02,cm03,cm04 from caseprogress, casemap" & _
       " where cp09='" & p_CP09 & "' and cm05(+)=cp01 and cm06(+)=cp02 and cm07(+)=cp03 and cm08(+)=cp04 and cm10 in ('0','3')" & _
       " union all select cm05,cm06,cm07,cm08 from caseprogress, casemap" & _
       " where cp09='" & p_CP09 & "' and cm01(+)=cp01 and cm02(+)=cp02 and cm03(+)=cp03 and cm04(+)=cp04 and cm10 in ('0','3')" & _
       " union all select cr01,cr02,cr03,cr04 from caseprogress, caserelation" & _
       " where cp09='" & p_CP09 & "' and cr05(+)=cp01 and cr06(+)=cp02 and cr07(+)=cp03 and cr08(+)=cp04 and cr01 is not null"
   'stSQL = "select sh12 from supporthour where rownum<2 and sh12 is not null and upper(sh11)='V'" & _
      " and not (sh01='" & DBDATE(p_SH01) & "' and sh02='" & p_SH02 & "' and sh03='" & p_SH03 & "' and sh04='" & p_SH04 & "' )" & _
      " and (sh06,sh07,sh08,sh09) in(" & stVTB & ")"
      
   stVTB = PUB_GetSameCaseSQL(p_CP09)
   stSQL = "select sh12 from supporthour where rownum<2 and sh12 is not null and upper(sh11)='V'" & _
      " and not (sh01='" & DBDATE(p_SH01) & "' and sh02='" & p_SH02 & "' and sh03='" & p_SH03 & "' and sh04='" & p_SH04 & "' )" & _
      " and (sh06||sh07||sh08||sh09) in(" & stVTB & ")"
   'end 2013/8/14
   
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      PUB_ChkSH = True
   End If
   Set adoRst = Nothing
End Function

'日期時間比大小
Function CompDateTime(oDT1 As String, oDT2 As String) As Boolean
CompDateTime = False
Dim otd1, ott1, otd2, ott2
Dim tmpvar As Variant
'取出1
If InStr(1, oDT1, "/") <> 0 Then
    tmpvar = Split(oDT1, "/")
    otd1 = tmpvar(0) & "/" & tmpvar(1) & "/" & Mid(tmpvar(2), 1, 2)
    If InStr(1, oDT1, ":") <> 0 Then
        ott1 = Replace(Right(oDT1, 5), ":", "")
    Else
        ott1 = Right(oDT1, 4)
    End If
ElseIf InStr(1, oDT1, ":") <> 0 Then
    otd1 = Mid(oDT1, 1, Len(oDT1) - 5)
    ott1 = Replace(Right(oDT1, 5), ":", "")
Else
    otd1 = Mid(oDT1, 1, Len(oDT1) - 4)
    ott1 = Right(oDT1, 4)
End If
otd1 = DBDATE(otd1)
'取出2
If InStr(1, oDT2, "/") <> 0 Then
    tmpvar = Split(oDT2, "/")
    otd2 = tmpvar(0) & "/" & tmpvar(1) & "/" & Mid(tmpvar(2), 1, 2)
    If InStr(1, oDT2, ":") <> 0 Then
        ott2 = Replace(Right(oDT2, 5), ":", "")
    Else
        ott2 = Right(oDT2, 4)
    End If
ElseIf InStr(1, oDT2, ":") <> 0 Then
    otd2 = Mid(oDT2, 1, Len(oDT2) - 5)
    ott2 = Replace(Right(oDT2, 5), ":", "")
Else
    otd2 = Mid(oDT2, 1, Len(oDT2) - 4)
    ott2 = Right(oDT2, 4)
End If
otd2 = DBDATE(otd2)
'檢查資料
If otd2 < otd1 Then '迄比起還小
    Exit Function
ElseIf otd1 = otd2 And ott2 < ott1 Then  '同一天，但是時間迄比時間起還小
    Exit Function
End If
CompDateTime = True
End Function

'Add by Morgan 2007/12/11 檢查聯絡人名稱是否重複
Public Function PUB_DupeContactCheck(pCC() As String, adoRst As ADODB.Recordset) As Boolean

   Dim stSQL As String, intR As Integer, stCon As String
   stCon = ""
   If pCC(1) <> "" Then
      stCon = stCon & " and pcc01<>'" & pCC(1) & "'"
   End If
   stCon = stCon & " and ( 1=0"
   If pCC(3) <> "" Then
      'Modified by Lydia 2018/02/22 名稱有造字不可以下Trim函數
      'stCon = stCon & " or upper(RTrim(pcc03))='" & ChgSQL(UCase(RTrim(pcc(3)))) & "'"
      stCon = stCon & " or upper(RTrim(pcc03))=upper(Rtrim('" & ChgSQL(pCC(3)) & "'))"
   End If
   If pCC(4) <> "" Then
      'Modified by Lydia 2018/02/22 名稱有造字不可以下Trim函數
      'stCon = stCon & " or RTrim(pcc04)='" & ChgSQL(RTrim(pcc(4))) & "'"
      stCon = stCon & " or RTrim(pcc04)=Rtrim('" & ChgSQL(pCC(4)) & "')"
   End If
   If pCC(5) <> "" Then
      'Modified by Lydia 2018/02/22 名稱有造字不可以下Trim函數
      'stCon = stCon & " or RTrim(pcc05)='" & ChgSQL(RTrim(pcc(5))) & "'"
      stCon = stCon & " or RTrim(pcc05)=Rtrim('" & ChgSQL(pCC(5)) & "')"
   End If
   stCon = stCon & " )"
   
   stSQL = "select '' C01,pcc01||'-'||pcc02 C02" & _
      ",rtrim(pcc03||' '||pcc04||' '||pcc05) C03" & _
      ",rtrim(cu05||' '||cu88||' '||cu89||' '||cu90||' '||cu06||' '||cu04) C04" & _
      ",pcc01||pcc02 C05 from potcustcont,customer" & _
      " where cu01(+)=pcc01 and cu02='0' and pcc20 is null" & stCon
   stSQL = stSQL & " union select '' C01,pcc01||'-'||pcc02 C02" & _
      ",rtrim(pcc03||' '||pcc04||' '||pcc05) C03" & _
      ",rtrim(fa05||' '||fa63||' '||fa64||' '||fa65||' '||fa06||' '||fa04) C04" & _
      ",pcc01||pcc02 C05 from potcustcont,fagent" & _
      " where fa01(+)=pcc01 and fa02='0' and pcc20 is null" & stCon
   stSQL = stSQL & " union select '' C01,pcc01||'-'||pcc02 C02" & _
      ",rtrim(pcc03||' '||pcc04||' '||pcc05) C03" & _
      ",rtrim(pcu03||' '||pcu04||' '||pcu05||' '||pcu06||' '||pcu07||' '||pcu08) C04" & _
      ",pcc01||pcc02 C05 from potcustcont,potcustomer" & _
      " where pcu01(+)=pcc01 and pcu02='0' and pcc20 is null" & stCon
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      PUB_DupeContactCheck = True
   End If
End Function

'add by nickc 2007/12/28  抓年度的第一個工作天
Public Function GetYearStdDay(oYear As String) As String
Dim m_StrSQL As String
Dim m_rs As New ADODB.Recordset
m_StrSQL = "select min(wd01) as wd01 from workday where wd01>=" & Trim(oYear) & "0101 and wd01<=" & Trim(oYear) & "1231 "
Set m_rs = New ADODB.Recordset
If m_rs.State = 1 Then m_rs.Close
m_rs.CursorLocation = adUseClient
m_rs.Open m_StrSQL, cnnConnection, adOpenStatic, adLockReadOnly
If m_rs.RecordCount <> 0 Then
    GetYearStdDay = CheckStr(m_rs.Fields("wd01"))
Else
    GetYearStdDay = ""
    Exit Function
End If
End Function

'add by nickc 2008/01/30  抓該月份的第一個工作天
'Modify by Amy 2016/04/18 +intChoose=1 抓該月份的最後一個工作天
'Add By Sindy 2016/11/9 + 取得該月的最後一天日曆天(+ Optional bolGetMonLastDay As Boolean = False)
Public Function GetMonthStdDay(oMonth As String, Optional intChoose As Integer = 0 _
            , Optional bolGetMonLastDay As Boolean = False) As String
Dim m_StrSQL As String
Dim m_rs As New ADODB.Recordset
Dim ii As Integer
   
   If intChoose = 0 Then
       m_StrSQL = "Min"
   Else
       m_StrSQL = "Max"
   End If
   m_StrSQL = "select " & m_StrSQL & "(wd01) as wd01 from workday where wd01>=" & Trim(oMonth) & "01 and wd01<=" & Trim(oMonth) & "31 "
   Set m_rs = New ADODB.Recordset
   If m_rs.State = 1 Then m_rs.Close
   m_rs.CursorLocation = adUseClient
   m_rs.Open m_StrSQL, cnnConnection, adOpenStatic, adLockReadOnly
   'edit by nickc 2008/01/30
   'If m_rs.RecordCount <> 0 Then
   If Not m_rs.EOF And Not m_rs.BOF Then
       GetMonthStdDay = CheckStr(m_rs.Fields("wd01"))
   Else
       GetMonthStdDay = ""
   End If
   'Add By Sindy 2016/11/9
   If intChoose = 1 Then '取該月最後一天
      If bolGetMonLastDay = True Then '要日曆天
         For ii = 1 To 30
            If IsDate(ChangeWStringToWDateString(CStr(Val(GetMonthStdDay) + 1))) = False Then
               Exit For
            End If
            GetMonthStdDay = CStr(Val(GetMonthStdDay) + 1)
         Next ii
      End If
   End If
   '2016/11/9 END
   Exit Function
End Function

'Add by Morgan 2008/1/3
'分案之指定國家－修改
Public Function PUB_UpdateCountry(ByRef intCaseKind As Integer, ByRef strCode() As String _
   , ByRef strCountry As String, ByRef strCountryOld As String) As Boolean
    
   Dim varCountryTemp As Variant, i As Integer, j As Integer, k As Integer, strSql As String, strTmp As String
   Dim strRule As String
   
   strRule = strCode(1) & strCode(2) & strCode(3) & strCode(4)
   '新增
   varCountryTemp = Split(strCountry, ",")
   strTmp = ""
   Select Case intCaseKind
      Case 專利
         '讀取最大多國碼
         strSql = "select max(pa04) from patent where pa01='" & strCode(1) & "' and pa02='" & strCode(2) & "' and pa03='" & strCode(3) & "'"
         i = 1
         Set AdoRecordSet3 = ClsLawReadRstMsg(i, strSql)
         If i = 1 Then
            j = Val("" & AdoRecordSet3.Fields(0))
         End If
         For i = 10 To TF_PA
            Select Case i
               Case 92, 93, 94, 95, 96, 97, 108, 136, 137, 138
               Case Else
                  strTmp = strTmp & "PA" & Format(i) & ","
            End Select
         Next
         strTmp = Left(strTmp, Len(strTmp) - 1)
         For i = 0 To UBound(varCountryTemp)
            If InStr(strCountryOld, varCountryTemp(i)) = 0 Then
               j = j + 1
               strSql = "INSERT INTO PATENT (PA01,PA02,PA03,PA04,PA05,PA06,PA07,PA08,PA09," & _
                  strTmp & ") SELECT PA01,PA02,PA03,'" & Format(j, "00") & "',PA05,PA06," & _
                  "PA07,PA08,'" & CStr(varCountryTemp(i)) & "'," & strTmp & " FROM PATENT WHERE " & ChgPatent(strRule)
               cnnConnection.Execute strSql, k
            End If
         Next
      
      Case 商標
         '讀取最大多國碼
         strSql = "select max(tm04) from TRADEMARK where tm01='" & strCode(1) & "' and tm02='" & strCode(2) & "' and tm03='" & strCode(3) & "'"
         i = 1
         Set AdoRecordSet3 = ClsLawReadRstMsg(i, strSql)
         If i = 1 Then
            j = Val("" & AdoRecordSet3.Fields(0))
         End If
         For i = 11 To TF_TM
            Select Case i
               Case 59, 60, 61, 62, 63, 64, 57, 73, 74, 75
               Case Else
                  strTmp = strTmp & "TM" & Format(i) & ","
            End Select
         Next
         strTmp = Left(strTmp, Len(strTmp) - 1)
         For i = 0 To UBound(varCountryTemp)
            If InStr(strCountryOld, varCountryTemp(i)) = 0 Then
               j = j + 1
               strSql = "INSERT INTO TRADEMARK (TM01,TM02,TM03,TM04,TM05,TM06,TM07,TM08,TM09," & _
                  "TM10," & strTmp & ") SELECT TM01,TM02,TM03,'" & Format(j, "00") & "'," & _
                  "TM05,TM06,TM07,TM08,TM09,'" & CStr(varCountryTemp(i)) & "'," & strTmp & _
                  " FROM TRADEMARK WHERE " & ChgTradeMark(strRule)
               cnnConnection.Execute strSql, k
            End If
         Next
   End Select
   '閉卷
   '少了的國家也不用閉卷
   PUB_UpdateCountry = True
End Function

'Add by Morgan 2008/1/11
'判斷案件是否有外國的申請人
Public Function PUB_ExistForeigner(ByVal p_CaseNo As String) As Boolean
   Dim intR As Integer, stSQL As String
   Dim adoTmp As ADODB.Recordset
   stSQL = "select 1 from patent where " & ChgPatent(p_CaseNo) & " and exists(select * from customer where cu01||cu02 in (pa26,pa27,pa28,pa29,pa30) and cu10>='010')"
   intR = 1
   Set adoTmp = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      PUB_ExistForeigner = True
   End If
   Set adoTmp = Nothing
End Function

'Add by Morgan 2008/1/11
'電腦中心分案發Mail
Public Sub PUB_M51Mail(ByVal p_CaseNo As String, ByVal p_Eng As String)
Dim strTmp As String 'Added by Lydia 2024/05/14

   If MsgBox("是否為改請？要發Mail通知工程師嗎？", vbYesNo + vbDefaultButton1) = vbYes Then
      strTmp = ""
      Do While strTmp = ""
         strTmp = InputBox("請輸入Mail內容！")
         If strTmp = "" Then
            If MsgBox("尚未輸入Mail內容是否要放棄發Mail？", vbYesNo + vbDefaultButton2) = vbYes Then
               Exit Do
            End If
         End If
      Loop
      If strTmp <> "" Then
         Call PUB_SendMail(strUserNum, p_Eng, " ", p_CaseNo & " 案改請通知", strTmp)
      End If
   End If
End Sub

'Add by Morgan 2008/1/16
'MailBox 格式檢查
'Modify by Sindy 2018/9/4 + ByRef
'Modify by Sindy 2021/6/30 + , Optional pShowMsg As Boolean = True, _
   Optional ByRef pMsgText As String
Public Function PUB_CheckMail(ByRef p_stBox As String, Optional pShowMsg As Boolean = True, _
   Optional ByRef pMsgText As String) As Boolean
   
Dim tmpArr As Variant
Dim m_i As Integer
Dim ii As Integer
   
   'Add by Morgan 2008/2/18 沒有EMail時統一輸No
   If UCase(p_stBox) = "NO" Then
      PUB_CheckMail = True
      Exit Function
   End If
   'end 2008/2/18
   
   'Modify by Sindy 2018/9/4
   p_stBox = Trim(p_stBox) '去掉空白
   
   'Modified by Morgan 2021/11/8
   'p_stBox = Replace(p_stBox, "；", ";") 'Removed by Morgan 2021/11/8
   '增加檢查不能有全形字,分號也一樣
   For ii = 1 To Len(p_stBox)
      If Asc(Mid(p_stBox, ii, 1)) < 0 Then
         pMsgText = "Mail ( " & p_stBox & " ) 含有全形字，請修正！" & vbCrLf & vbCrLf & "( 注意:多個E-Mail請以半形的 ; 符號區隔 )"
         PUB_CheckMail = False
         If pShowMsg = True Then
            MsgBox pMsgText, vbExclamation
         End If
         Exit Function
      End If
   Next
   'end 2021/11/8
   
   tmpArr = Split(p_stBox, ";")
   For m_i = 0 To UBound(tmpArr)
      If InStr(1, tmpArr(m_i), "@") = 0 Then
         pMsgText = "Mail (" & tmpArr(m_i) & ") 必需要有 @ 符號！"
         If pShowMsg = True Then
            'MsgBox "Mail (" & tmpArr(m_i) & ") 必需要有 @ 符號！", vbExclamation
            MsgBox pMsgText, vbExclamation
         End If
         PUB_CheckMail = False
         Exit Function
      ElseIf InStr(1, tmpArr(m_i), "@") = 1 Or InStr(1, tmpArr(m_i), "@") = Len(tmpArr(m_i)) Then
         pMsgText = "Mail (" & tmpArr(m_i) & ") @ 符號不可為字首或字尾！"
         If pShowMsg = True Then
            'MsgBox "Mail (" & tmpArr(m_i) & ") @ 符號不可為字首或字尾！", vbExclamation
            MsgBox pMsgText, vbExclamation
         End If
         PUB_CheckMail = False
         Exit Function
      'Modify by Sindy 2018/9/4
      ElseIf InStr(1, tmpArr(m_i), "@") <> InStrRev(tmpArr(m_i), "@") Then
         pMsgText = "Mail (" & tmpArr(m_i) & ")  一組EMail只能有一個 @ 符號！"
         If pShowMsg = True Then
            'MsgBox "Mail (" & tmpArr(m_i) & ")  一組EMail只能有一個 @ 符號！", vbExclamation
            MsgBox pMsgText, vbExclamation
         End If
         PUB_CheckMail = False
         Exit Function
      'Modify by Morgan 2011/2/8 "&"符號要能用
      '2011/10/3 modify by sonia "~"可使用Y52503040
      'Modify by Amy 2016/12/22 不可用?-陳金蓮
      'Modify by Sindy 2018/9/4 不可用'和:符號
      'Modified by Morgan 2019/7/22 '符合規範要可以用
      ElseIf InStr(1, tmpArr(m_i), ",") > 0 Or InStr(1, tmpArr(m_i), "[") > 0 Or _
             InStr(1, tmpArr(m_i), "]") > 0 Or InStr(1, tmpArr(m_i), "!") > 0 Or _
             InStr(1, tmpArr(m_i), "(") > 1 Or InStr(1, tmpArr(m_i), ")") > 0 Or _
             InStr(1, tmpArr(m_i), "=") > 0 Or InStr(1, tmpArr(m_i), "\") > 0 Or _
             InStr(1, tmpArr(m_i), "/") > 0 Or InStr(1, tmpArr(m_i), "<") > 0 Or _
             InStr(1, tmpArr(m_i), ">") > 0 Or InStr(1, tmpArr(m_i), "$") > 0 Or _
             InStr(1, tmpArr(m_i), "%") > 0 Or InStr(1, tmpArr(m_i), "^") > 0 Or _
             InStr(1, tmpArr(m_i), "*") > 0 Or InStr(1, tmpArr(m_i), "?") > 0 Or _
             InStr(1, tmpArr(m_i), ":") > 0 Then
         'Modify by Sindy 2018/9/4 + (注意:多個E-Mail必須使用 ; 符號區隔)
         pMsgText = "Mail (" & tmpArr(m_i) & ") 不允許有下列符號！" & vbCrLf & _
                ",、[、]、!、(、)、=、\、/、<、>、$、%、^、* 、?、'、:" & vbCrLf & vbCrLf & _
                "(注意:多個E-Mail必須使用 ; 符號區隔)"
         If pShowMsg = True Then
            'MsgBox "Mail (" & tmpArr(m_i) & ") 不允許有下列符號！" & vbCrLf & _
                ",、[、]、!、(、)、=、\、/、<、>、$、%、^、* 、?、'、:" & vbCrLf & vbCrLf & _
                "(注意:多個E-Mail必須使用 ; 符號區隔)", vbExclamation
            MsgBox pMsgText, vbExclamation
         End If
         PUB_CheckMail = False
         Exit Function
      'Added by Morgan 2013/8/6
      ElseIf InStr(1, tmpArr(m_i), vbCrLf) > 0 Then
         'Modify by Sindy 2018/9/4 + (注意:多個E-Mail必須使用 ; 符號區隔)
         pMsgText = "Mail (" & tmpArr(m_i) & ") 不允許有跳行符號，請清除！" & vbCrLf & vbCrLf & _
                "(注意:多個E-Mail必須使用 ; 符號區隔)"
         If pShowMsg = True Then
            'MsgBox "Mail (" & tmpArr(m_i) & ") 不允許有跳行符號，請清除！" & vbCrLf & vbCrLf & _
                "(注意:多個E-Mail必須使用 ; 符號區隔)", vbExclamation
            MsgBox pMsgText, vbExclamation
         End If
         PUB_CheckMail = False
         Exit Function
      'end 2013/8/6
      End If
   Next m_i
   '2018/9/4 END
   
   PUB_CheckMail = True
End Function

'add by nickc 2008/01/18
'取得員工所屬組別商標用
Public Function PUB_GetStaffST16(StrST01 As String) As String
'strKind : 1.部門編號2.部門名稱
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset

PUB_GetStaffST16 = ""
StrSQLa = "Select ST16 From Staff Where  ST01='" & StrST01 & "' "
rsA.CursorLocation = adUseClient
rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
If rsA.RecordCount > 0 Then
    PUB_GetStaffST16 = CheckStr(rsA.Fields("st16"))
End If
If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing

End Function

'Add by Morgan 2006/12/13
'將PictureBox內圖片存檔
Public Sub PUB_SavePic(p_PicBox As PictureBox, p_strFileName As String)
   Dim m_Image    As New cImage
   Dim m_Jpeg     As New cJpeg
   
   With p_PicBox
      Set .Picture = .Image
      m_Image.CopyStdPicture .Picture
      m_Jpeg.SetSamplingFrequencies 2, 2, 1, 1, 1, 1 '彩色
      m_Jpeg.Quality = 80
      m_Jpeg.SampleHDC m_Image.hDC, m_Image.Width, m_Image.Height
      RidFile p_strFileName
      m_Jpeg.SaveFile p_strFileName
   End With
   Set m_Image = Nothing
   Set m_Jpeg = Nothing
End Sub

'Add by Morgan 2008/1/25
Public Function PUB_PCCDelCheck(p_PCU01 As String, Optional p_PCU02 As String, Optional p_PCC02 As String) As Boolean
   Dim stSQL As String, intR As Integer
   If p_PCU01 = "" Then
      PUB_PCCDelCheck = True
      Exit Function
   End If
   
   stSQL = "select count(*) from contactrecord"
   If p_PCU02 <> "" Then
      stSQL = stSQL & " where cr03='" & p_PCU01 & p_PCU02 & "'"
   Else
      stSQL = stSQL & " where substr(cr03,1,8)='" & p_PCU01 & "'"
   End If
   If p_PCC02 <> "" Then
      stSQL = stSQL & " and instr(cr04,'" & p_PCC02 & "')>0"
   End If
   intR = 1
   Set AdoRecordSet3 = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      If AdoRecordSet3.Fields(0) = 0 Then
         PUB_PCCDelCheck = True
      Else
         MsgBox "尚有往來記錄，不可刪除！"
      End If
   End If
End Function

'Add by Sindy 98/03/04
Public Function PUB_POCDelCheck(p_POC01 As String, Optional p_POC02 As String) As Boolean
Dim stSQL As String, intR As Integer
   
   If p_POC01 = "" Then
      PUB_POCDelCheck = True
      Exit Function
   End If
   
   stSQL = "select count(*) from contactrecord1"
   If p_POC02 <> "" Then
      stSQL = stSQL & " where cor03='" & p_POC01 & p_POC02 & "'"
   Else
      stSQL = stSQL & " where substr(cor03,1,8)='" & p_POC01 & "'"
   End If
   intR = 1
   Set AdoRecordSet3 = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      If AdoRecordSet3.Fields(0) = 0 Then
         PUB_POCDelCheck = True
      Else
         MsgBox "尚有國內往來記錄，不可刪除！"
      End If
   End If
End Function

'Add by nickc 2008/01/30
'取得員工代收郵件人員
Public Function PUB_GetST14(ByVal p_User As String) As String
   strSql = "select st14 from staff where st01='" & p_User & "'"

On Error GoTo ErrHnd

   CheckOC3
   With AdoRecordSet3
      .CursorLocation = adUseClient
      .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      If .RecordCount > 0 Then
         PUB_GetST14 = "" & .Fields(0)
      End If
   End With
   
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
End Function

'add by nickc 2008/02/13
'Modified by Morgan 2019/10/3 +bolUpdWoFunc Update語法是否有使用db function
Public Function ChgSQLfldToStr(oStr As String, Optional bolUpdWoFunc As Boolean) As String
Dim m_tmpstr As String
Dim m_tmpstr2 As String
Dim m_i As Integer
Dim isStr As Boolean
Dim isNextfld As Boolean
Dim isNextfldB As Boolean
Dim isNextfldE As Boolean
Dim tmpArrF As Variant 'Added by Lydia 2016/12/30

'Modify By Sindy 2025/9/12
'If InStr(1, UCase(oStr), "VALUES") <> 0 Then
If InStr(1, UCase(oStr), " VALUES") <> 0 Then
'2025/9/12 END
    m_tmpstr = Trim(Mid(oStr, InStr(1, UCase(oStr), "VALUES") + 6, Len(oStr) - 1))
    If Left(m_tmpstr, 1) = "(" Then
        m_tmpstr = Mid(m_tmpstr, 2)
    End If
    If Right(m_tmpstr, 1) = ")" Then
        m_tmpstr = Mid(m_tmpstr, 1, Len(m_tmpstr) - 1)
    End If
    isStr = False
    m_tmpstr2 = ""
    isNextfld = False
    isNextfldB = False
    isNextfldE = False
    For m_i = 1 To Len(m_tmpstr)
        If Mid(m_tmpstr, m_i, 1) = "," Then
            If isStr = False And isNextfldB = False And isNextfldE = False Then
                isNextfld = True
            End If
            If isStr = False And isNextfldB And isNextfldE = False Then
                m_tmpstr2 = m_tmpstr2 & "'"
                isNextfldB = False
                isNextfldE = False
                isNextfld = True
            End If
        ElseIf Mid(m_tmpstr, m_i, 1) = "'" Then
            isStr = Not isStr
            isNextfld = False
            If isStr Then
                isNextfldB = False
                isNextfldE = False
            End If
        Else
            If isNextfld Then
                isNextfldB = True
            ElseIf isStr = False Then
                If m_i <> Len(m_tmpstr) Then
                    If Mid(m_tmpstr, m_i + 1, 1) = "," Then
                        isNextfldE = True
                    Else
                        isNextfldB = False
                    End If
                Else
                    isNextfldE = True
                End If
            End If
        End If

        If isNextfldB And Not isNextfldE Then
            m_tmpstr2 = m_tmpstr2 & "'" & Mid(m_tmpstr, m_i, 1)
            isNextfld = False
        ElseIf isNextfldE Then
            m_tmpstr2 = m_tmpstr2 & Mid(m_tmpstr, m_i, 1) & "'"
            isNextfldE = False
            isNextfldB = False
       Else
            m_tmpstr2 = m_tmpstr2 & Mid(m_tmpstr, m_i, 1)
        End If
    Next m_i
    ChgSQLfldToStr = Replace(oStr, m_tmpstr, m_tmpstr2)

'Modify By Sindy 2025/9/12
'ElseIf InStr(1, UCase(oStr), "SET") <> 0 Then
ElseIf InStr(1, UCase(oStr), " SET ") <> 0 Then
'2025/9/12 END
    m_tmpstr = Trim(Mid(oStr, InStr(1, UCase(oStr), "SET") + 3))
    m_tmpstr = Trim(Mid(m_tmpstr, 1, InStr(1, UCase(m_tmpstr), "WHERE") - 1))
    'Modified by Lydia 2016/12/30 改成模組
'    isStr = False
'    m_tmpstr2 = ""
'    isNextfld = False
'    isNextfldB = False
'    isNextfldE = False
'    For m_i = 1 To Len(m_tmpstr)
'        If Mid(m_tmpstr, m_i, 1) = "=" Then
'            If isStr = False And isNextfldB = False And isNextfldE = False Then
'                isNextfld = True
'            End If
'        ElseIf Mid(m_tmpstr, m_i, 1) = "," Then
'            If isStr = False And isNextfldB And isNextfldE = False Then
'                m_tmpstr2 = m_tmpstr2 & "'"
'                isNextfldB = False
'                isNextfldE = False
'                isNextfld = False
'            End If
'        ElseIf Mid(m_tmpstr, m_i, 1) = "'" Then
'            isStr = Not isStr
'            isNextfld = False
'            If isStr Then
'                isNextfldB = False
'                isNextfldE = False
'            End If
'        Else
'            If isNextfld Then
'                isNextfldB = True
'            ElseIf isStr = False Then
'                If m_i <> Len(m_tmpstr) Then
'                    If Mid(m_tmpstr, m_i + 1, 1) = "," Then
'                        isNextfldE = True
'                    Else
'                        isNextfldB = False
'                    End If
'                Else
'                    isNextfldE = True
'                End If
'            End If
'        End If
'
'        If Mid(m_tmpstr, m_i, 1) = " " Then
'            m_tmpstr2 = m_tmpstr2 & Mid(m_tmpstr, m_i, 1)
'        ElseIf isNextfldB And Not isNextfldE Then
'            If LCase(Mid(Mid(m_tmpstr, m_i), 1, 4)) <> "null" Then
'                m_tmpstr2 = m_tmpstr2 & "'" & Mid(m_tmpstr, m_i, 1)
'            Else
'                m_tmpstr2 = m_tmpstr2 & Mid(m_tmpstr, m_i, 1)
'                isNextfldB = False
'            End If
'            isNextfld = False
'        ElseIf isNextfldE Then
'            If isNextfldB = True Then
'                m_tmpstr2 = m_tmpstr2 & Mid(m_tmpstr, m_i, 1) & "'"
'            Else
'                m_tmpstr2 = m_tmpstr2 & Mid(m_tmpstr, m_i, 1)
'            End If
'            isNextfldE = False
'            isNextfldB = False
'       Else
'            m_tmpstr2 = m_tmpstr2 & Mid(m_tmpstr, m_i, 1)
'        End If
        
'    Next m_i
    m_tmpstr2 = PUB_ChgUpFd(m_tmpstr, bolUpdWoFunc)
    tmpArrF = Split(m_tmpstr2, vbCrLf & Chr(8))
    m_tmpstr2 = ""
    For m_i = 0 To UBound(tmpArrF)
        If Trim(tmpArrF(m_i)) <> "" Then
           If InStr(tmpArrF(m_i), "=") > 0 And InStr(tmpArrF(m_i), "'") = 0 Then
              'Modified by Morgan 2021/10/26 右邊若有多空白要去除否則比對會錯誤 Ex:'NULL '
              'm_tmpstr2 = m_tmpstr2 & IIf(m_tmpstr2 <> "", ",", "") & IIf(InStr(tmpArrF(m_i), "= ") > 0, Replace(tmpArrF(m_i), "= ", "= '"), Replace(tmpArrF(m_i), "=", "='")) & "'"
              m_tmpstr2 = m_tmpstr2 & IIf(m_tmpstr2 <> "", ",", "") & RTrim(IIf(InStr(tmpArrF(m_i), "= ") > 0, Replace(tmpArrF(m_i), "= ", "= '"), Replace(tmpArrF(m_i), "=", "='"))) & "'"
              'end 2021/10/26
           Else
              m_tmpstr2 = m_tmpstr2 & IIf(m_tmpstr2 <> "", ",", "") & tmpArrF(m_i)
           End If
        End If
    Next m_i
    'end 2016/12/30
    ChgSQLfldToStr = Replace(oStr, m_tmpstr, m_tmpstr2)
Else
    ChgSQLfldToStr = oStr
End If
End Function

'Add by Morgan 2008/2/20
'檢查若沒有EMail時提醒補輸並更新
Public Sub PUB_CheckEMail(ByVal stAgentNo As String, Optional ByVal stContactNo As String)
Dim stSQL As String, intR As Integer, stMsg As String, stEMail As String
Dim iTbNo As Integer
   
   
'2015/1/5 modify by sonia 僅投資法務仍要補,因專利商標要改的部分太多故此處取消,將PUB_CheckEMail改移到此投資法務frm071006內的CheckEMail
'   If stAgentNo = "" Then Exit Sub
'
'On Error GoTo ErrHnd
'
'   stAgentNo = Left(stAgentNo & "000", 9)
'   If stContactNo <> "" Then
'      iTbNo = 1
'      stMsg = "聯絡人【 " & stAgentNo & "-" & stContactNo
'      stSQL = "select NVL(PCC05,NVL(PCC03,PCC04)) FNAME from potcustcont where pcc01='" & Left(stAgentNo, 8) & "' and pcc02='" & stContactNo & "' and pcc08 is null"
'   Else
'      If Left(stAgentNo, 1) = "Y" Then
'         iTbNo = 2
'         stMsg = "代理人【 " & stAgentNo
'         stSQL = "select NVL(FA04,NVL(RTRIM(FA05||' '||FA63||' '||FA64||' '||FA65),FA06)) FNAME from fagent where fa01='" & Left(stAgentNo, 8) & "' and fa02='" & Mid(stAgentNo, 9) & "' and fa16 is null"
'      Else
'         iTbNo = 3
'         stMsg = "客戶【 " & stAgentNo
'         stSQL = "select NVL(CU04,NVL(RTRIM(CU05||' '||CU88||' '||CU89||' '||CU90),CU06)) FNAME from customer where cu01='" & Left(stAgentNo, 8) & "' and cu02='" & Mid(stAgentNo, 9) & "' and cu20 is null"
'      End If
'   End If
'   intR = 1
'   Set AdoRecordSet3 = ClsLawReadRstMsg(intR, stSQL)
'   If intR = 1 Then
'      stMsg = stMsg & " " & AdoRecordSet3(0) & " 】" & "尚無 EMail 資料，請輸入！"
'      Do
'         stEMail = InputBox(stMsg, "Email 輸入", stEMail)
'         If stEMail = "" Then
'            If MsgBox("是否確定這次不補 EMail 資料？", vbYesNo + vbDefaultButton2, "Email 輸入") = vbYes Then
'               Exit Do
'            End If
'         Else
'            If PUB_CheckMail(stEMail) = True Then
'               If iTbNo = 1 Then
'                  stSQL = "update potcustcont set pcc08='" & ChgSQL(stEMail) & "' where pcc01='" & Left(stAgentNo, 8) & "' and pcc02='" & stContactNo & "'"
'               ElseIf iTbNo = 2 Then
'                  stSQL = "update fagent set fa16='" & ChgSQL(stEMail) & "' where fa01='" & Left(stAgentNo, 8) & "' and fa02='" & Mid(stAgentNo, 9) & "'"
'               Else
'                  stSQL = "update customer set cu20='" & ChgSQL(stEMail) & "' where cu01='" & Left(stAgentNo, 8) & "' and cu02='" & Mid(stAgentNo, 9) & "'"
'               End If
'               cnnConnection.BeginTrans
'On Error GoTo ErrHnd2
'               Pub_SeekTbLog stSQL
'               cnnConnection.Execute stSQL, intR
'               cnnConnection.CommitTrans
'               Exit Do
'            End If
'         End If
'      Loop
'   End If
'   Exit Sub
'
'ErrHnd2:
'   cnnConnection.RollbackTrans
'ErrHnd:
'   MsgBox Err.Description
'
End Sub

'add by nickc 2008/02/27 轉全行數字
Public Function ToWide(m_str As String) As String
'Modify by Amy 2022/03/31 改至同一個fucnion
'Dim m_i As Integer
'ToWide = StrConv(m_str, vbWide)   '相對的是   vbNarrow
ToWide = PUB_ChangeZIPToSir(m_str)
End Function

'Add by Morgan 2008/3/18
'檢查是否重新委任未辦理
Public Function PUB_Check928NotOk(cp() As String) As Boolean
   Dim stSQL As String, intR As Integer
   stSQL = "select NP06 from caseprogress,nextprogress" & _
      " where cp01='" & cp(1) & "' and cp02='" & cp(2) & "' and cp03='" & cp(3) & "' and cp04='" & cp(4) & "' and cp10='928'" & _
      " and np01(+)=cp09 and np07='202' and (np06 is null or np06='N')"
   intR = 1
   Set AdoRecordSet3 = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      PUB_Check928NotOk = True
   End If
End Function
'Add by Morgan 2008/3/21
'p_bolXtra:是否案件性質為年費或延展
'Modified by Morgan 2009/10/19 +bolPaper  => 是否 EMail 同時寄紙本
'Modified by Morgan 2014/5.30 +bolChkDN   => DN 是否 E 化
Public Function PUB_GetEMailFlag(ByRef p_CaseNo As String, Optional ByVal p_bolXtra As Boolean, Optional ByVal p_CP60 As String, Optional ByRef bolPaper As Boolean, Optional ByVal strCuFaNo As String, Optional ByVal bolChkDN As Boolean) As Boolean
   Dim stSQL As String, intR As Integer, strCaseNo(1 To 4) As String
   bolPaper = False
   ChgCaseNo p_CaseNo, strCaseNo
   'Add by Morgan 2009/12/30 +只傳代理人或客戶編號及系統別(整批列印用)
   If strCuFaNo <> "" Then
      Select Case strCaseNo(1)
         Case "P", "CFP", "FCP"
            If Left(strCuFaNo, 1) = "Y" Then
               stSQL = "SELECT FA86 C1,fa98 C2 FROM FAGENT WHERE FA01='" & Left(strCuFaNo, 8) & "' and FA02='" & Mid(strCuFaNo, 9) & "'"
            Else
               stSQL = "SELECT CU124 C1,cu137 C2 FROM CUSTOMER WHERE CU01='" & Left(strCuFaNo, 8) & "' and CU02='" & Mid(strCuFaNo, 9) & "'"
            End If
         Case Else
            If Left(strCuFaNo, 1) = "Y" Then
               stSQL = "SELECT FA91 C1,FA99 C2 FROM FAGENT WHERE FA01='" & Left(strCuFaNo, 8) & "' and FA02='" & Mid(strCuFaNo, 9) & "'"
            Else
               stSQL = "SELECT CU126 C1,CU138 C2 FROM CUSTOMER WHERE CU01='" & Left(strCuFaNo, 8) & "' and CU02='" & Mid(strCuFaNo, 9) & "'"
            End If
      End Select
      
   Else
   
      Select Case strCaseNo(1)
         Case "P", "CFP", "FCP"
               'Add by Morgan 2008/4/3
               '若請款單號時需判斷該單是否為年費請款
               'Modify by Morgan 2010/1/22
               '請款單要抓請款對象
               'If p_bolXtra = False And p_CP60 <> "" Then
               '   stSQL = "select 1 from caseprogress where cp60='" & p_CP60 & "' and cp10='605'"
               '   intR = 1
               '   Set AdoRecordSet3 = ClsLawReadRstMsg(intR, stSQL)
               '   If intR = 1 Then
               '      p_bolXtra = True
               '   End If
               'End If
               If p_CP60 <> "" Then
                  'Modified by Morgan 2017/10/24 請款對象可能是X編號
                  stSQL = "select pa142||X1.cu124||X2.cu124||fa86 C1,pa155||X1.cu137||X2.cu137||fa98 C2" & _
                     " from Patent,ACC1K0,FAGENT,CUSTOMER X1,CUSTOMER X2 where " & ChgPatent(p_CaseNo) & _
                     " AND a1k13(+)=PA01 AND a1k14(+)=PA02 AND a1k15(+)=PA03 AND a1k16(+)=PA04 AND A1K01(+)='" & p_CP60 & "'" & _
                     " AND FA01(+)=SUBSTR(A1K28,1,8) AND FA02(+)=SUBSTR(A1K28,9,1)" & _
                     " AND X1.CU01(+)=SUBSTR(A1K28,1,8) AND X1.CU02(+)=SUBSTR(A1K28,9,1)" & _
                     " AND X2.CU01(+)=SUBSTR(PA26,1,8) AND X2.CU02(+)=SUBSTR(PA26,9,1)"
                     
               Else
               'end 2010/1/22
                  If p_bolXtra = True Then
                  'end 2008/4/3
                     stSQL = "select pa142||cu124||DECODE(PA76,NULL,DECODE(CU96,NULL,F3.FA86,F2.FA86),F1.FA86) C1" & _
                        ",pa155||cu137||DECODE(PA76,NULL,DECODE(CU96,NULL,F3.FA98,F2.FA98),F1.FA98) C2" & _
                        " from Patent,FAGENT F1,CUSTOMER,FAGENT F2,FAGENT F3" & _
                        " where " & ChgPatent(p_CaseNo) & _
                        " AND F1.FA01(+)=SUBSTR(PA76,1,8) AND F1.FA02(+)=SUBSTR(PA76,9,1)" & _
                        " AND CU01(+)=SUBSTR(PA26,1,8) AND CU02(+)=SUBSTR(PA26,9,1)" & _
                        " AND F2.FA01(+)=SUBSTR(CU96,1,8) AND F2.FA02(+)=SUBSTR(CU96,9,1)" & _
                        " AND F3.FA01(+)=SUBSTR(PA75,1,8) AND F3.FA02(+)=SUBSTR(PA75,9,1)"
                  Else
                     stSQL = "select pa142||cu124||fa86 C1,pa155||cu137||fa98 C2" & _
                        " from Patent,FAGENT,CUSTOMER where " & ChgPatent(p_CaseNo) & " AND FA01(+)=SUBSTR(PA75,1,8) AND FA02(+)=SUBSTR(PA75,9,1) AND CU01(+)=SUBSTR(PA26,1,8) AND CU02(+)=SUBSTR(PA26,9,1)"
                  End If
               End If
            
       '專利服務
       Case "PS", "CPS", "FG"
            stSQL = "select SP80||CU124||FA86 C1,SP83||CU137||FA98 C2" & _
               " from servicepractice,FAGENT,CUSTOMER where " & ChgService(p_CaseNo) & " AND FA01(+)=SUBSTR(sp26,1,8) AND FA02(+)=SUBSTR(sp26,9,1) AND CU01(+)=SUBSTR(sp08,1,8) AND CU02(+)=SUBSTR(sp08,9,1)"
       'Add by Morgan 2008/5/23
       'Add By Sindy 2012/1/11 +TF
       Case "T", "CFT", "FCT", "TF"
            '若請款單號時需判斷該單是否為延展請款
            'Modify by Morgan 2010/1/22
            '請款單要抓請款對象
            'If p_bolXtra = False And p_CP60 <> "" Then
            '   stSQL = "select 1 from caseprogress where cp60='" & p_CP60 & "' and cp10='102'"
            '   intR = 1
            '   Set AdoRecordSet3 = ClsLawReadRstMsg(intR, stSQL)
            '   If intR = 1 Then
            '      p_bolXtra = True
            '   End If
            'End If
            ''end 2008/5/23
            If p_CP60 <> "" Then
               'Modified by Morgan 2017/10/24 請款對象可能是X編號
               stSQL = "select TM121||X1.CU126||X2.CU126||FA91 C1,TM126||X1.CU138||X2.CU138||FA99 C2" & _
                  " from trademark,acc1k0,FAGENT,CUSTOMER X1,CUSTOMER X2 where " & ChgTradeMark(p_CaseNo) & _
                  " AND a1k13(+)=tm01 AND a1k14(+)=tm02 AND a1k15(+)=tm03 AND a1k16(+)=tm04 AND A1K01(+)='" & p_CP60 & "'" & _
                  " AND FA01(+)=SUBSTR(A1K28,1,8) AND FA02(+)=SUBSTR(A1K28,9,1)" & _
                  " AND X1.CU01(+)=SUBSTR(A1K28,1,8) AND X1.CU02(+)=SUBSTR(A1K28,9,1)" & _
                  " AND X2.CU01(+)=SUBSTR(tm23,1,8) AND X2.CU02(+)=SUBSTR(tm23,9,1)"
               
            Else
            'end 2010/1/22
            
               If p_bolXtra = True Then
                  stSQL = "select TM121||CU126||DECODE(tm33,NULL,DECODE(CU98,NULL,F3.FA91,F2.FA91),F1.FA91) C1" & _
                     ",TM126||CU138||DECODE(tm33,NULL,DECODE(CU98,NULL,F3.FA99,F2.FA99),F1.FA99) C2" & _
                     " from trademark,FAGENT F1,CUSTOMER,FAGENT F2,FAGENT F3" & _
                     " where " & ChgTradeMark(p_CaseNo) & _
                     " AND F1.FA01(+)=SUBSTR(tm33,1,8) AND F1.FA02(+)=SUBSTR(tm33,9,1)" & _
                     " AND CU01(+)=SUBSTR(tm23,1,8) AND CU02(+)=SUBSTR(tm23,9,1)" & _
                     " AND F2.FA01(+)=SUBSTR(CU98,1,8) AND F2.FA02(+)=SUBSTR(CU98,9,1)" & _
                     " AND F3.FA01(+)=SUBSTR(tm44,1,8) AND F3.FA02(+)=SUBSTR(tm44,9,1)"
               Else
                  stSQL = "select TM121||CU126||FA91 C1,TM126||CU138||FA99 C2" & _
                     " from trademark,FAGENT,CUSTOMER where " & ChgTradeMark(p_CaseNo) & " AND FA01(+)=SUBSTR(tm44,1,8) AND FA02(+)=SUBSTR(tm44,9,1) AND CU01(+)=SUBSTR(tm23,1,8) AND CU02(+)=SUBSTR(tm23,9,1)"
               End If
            End If
            
         '其他服務業務
         Case Else
            stSQL = "select SP80||CU126||FA91 C1,SP83||CU138||FA99 C2" & _
               " from servicepractice,FAGENT,CUSTOMER where " & ChgService(p_CaseNo) & " AND FA01(+)=SUBSTR(sp26,1,8) AND FA02(+)=SUBSTR(sp26,9,1) AND CU01(+)=SUBSTR(sp08,1,8) AND CU02(+)=SUBSTR(sp08,9,1)"
      End Select
      
   End If
   
   If stSQL <> "" Then
      intR = 1
      Set AdoRecordSet3 = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         'Modified by Morgan 2014/5/30
         '是否E化欄位改可放 Y 以外的值
         'If Not IsNull(AdoRecordSet3(0)) Then
         '   PUB_GetEMailFlag = True
         If InStr("" & AdoRecordSet3(0), "Y") > 0 Then
            PUB_GetEMailFlag = True
         ElseIf bolChkDN = True Then
            If InStr("" & AdoRecordSet3(0), "D") > 0 Then
               PUB_GetEMailFlag = True
            End If
         'end 2014/5/30
         End If
         
         'Add by Morgan 2009/10/19
         If PUB_GetEMailFlag = True Then
            If Not IsNull(AdoRecordSet3(1)) Then
               bolPaper = True
            End If
         End If
         'end 2009/10/19
      End If
   End If
End Function
'Add by Morgan 2008/3/27
'讀取電腦名稱
Public Function PUB_ReadHostName() As String
   Dim stHostName As String
   Dim dwLength As Integer
   dwLength = 256
   stHostName = String(dwLength, Chr(0))
   gethostname stHostName, Len(stHostName)
   PUB_ReadHostName = Replace(stHostName, Chr(0), "")
End Function

'Add by Morgan 2008/3/27
'Modified by Morgan 2015/6/3 +iDirection 進紙方向: 0=不控制 , 1=窄邊, 2=寬邊
'Modified by Lydia 2022/02/25 bolPrinter=False '取得自訂紙張編號
Public Function PUB_GetPaperSize(iRptNo As Integer, Optional iDirection As Integer, Optional bolPrinter As Boolean = True) As Integer
   Dim stSQL As String, intR As Integer
   
On Error GoTo ErrHnd
   
   'Modify by Morgan 2009/1/16 9x系統直接以定義值自訂
   'Modifed by Lydia 2022/02/25 +And bolPrinter = True
   If pub_OS = 1 And bolPrinter = True Then
      stSQL = "select pd03,pd04 from Papersizedefine where pd01='" & Format(iRptNo, "00") & "'"
      intR = 1
      Set AdoRecordSet3 = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         Printer.Width = Val(AdoRecordSet3("pd03")) * 567
         Printer.Height = Val(AdoRecordSet3("pd04")) * 567
         PUB_GetPaperSize = Printer.PaperSize
      End If
   Else
      stSQL = "select PM03,PM06 from PapersizeMap where pm01='" & pub_HostName & "' and pm02='" & Format(iRptNo, "00") & "'"
      intR = 1
      Set AdoRecordSet3 = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         PUB_GetPaperSize = AdoRecordSet3(0)
         'Modified by Lydia 2022/02/25
         'Printer.PaperSize = PUB_GetPaperSize 'Added by Morgan 2015/6/3 印表機不一定支援自訂紙張,要先套用
         If bolPrinter = True Then
            'Added by Morgan 2022/5/30 '婉莘列印傳票發現還是用A4跳頁，重印又正常，先加看看
            Printer.Orientation = 1
            Printer.EndDoc
            'end 2022/5/30
            Printer.PaperSize = PUB_GetPaperSize
         End If
      Else
         'Added by Lydia 2022/02/25
         If bolPrinter = False Then
             PUB_GetPaperSize = -1
         Else
         'end 2022/02/25
             Printer.Orientation = 1
             Printer.EndDoc
             PUB_GetPaperSize = Printer.PaperSize
         End If 'Added by Lydia 2022/02/25
      End If
   End If
   
'Added by Morgan 2015/6/3
If bolPrinter = True Then 'Added by Lydia 2022/02/25
   If iDirection = 1 Then
      If Printer.Width > Printer.Height Then
         If Printer.Orientation = 1 Then
            Printer.Orientation = 2
         Else
            Printer.Orientation = 1
         End If
      End If
   ElseIf iDirection = 2 Then
      If Printer.Width < Printer.Height Then
         If Printer.Orientation = 1 Then
            Printer.Orientation = 2
         Else
            Printer.Orientation = 1
         End If
      End If
   End If
End If 'Added by Lydia 2022/02/25

   Exit Function
   
ErrHnd:
   If Err.Number = 380 Then
      Printer.Orientation = 1
      Printer.EndDoc
      PUB_GetPaperSize = Printer.PaperSize
      Resume Next
   Else
      MsgBox Err.Description, vbCritical
   End If
'end 2015/6/3
End Function

''add by nickc 2008/04/07 取得代理人或客戶之D/N幣別
''Add By Sindy 2011/3/3 + strSysType
'Public Function pub_GetCurrency(oFaKey As String, Optional strSysType As String = "") As String
'Dim stSQL As String, intR As Integer
'
'   'Modify By Sindy 2013/1/28
''   If strSrvDate(1) >= AccFMPImputCurrStarDate Then
'      '2009/6/24 modify by sonia
'      'stSQL = "select fa43 from fagent where fa01='" & Mid(oFaKey & "000000", 1, 8) & "' and fa02='" & Mid(oFaKey & "000000", 9, 1) & "'"
'      If Mid(oFaKey, 1, 1) = "Y" Then
'         'Modify By Sindy 2011/3/3
'         If CheckSys(strSysType) = "2" Or CheckSys(strSysType) = "6" Then
'            '商標D/N幣別
'            stSQL = "select fa108 from fagent where fa01='" & Mid(oFaKey & "000000", 1, 8) & "' and fa02='" & Mid(oFaKey & "000000", 9, 1) & "'"
'         '2011/3/3 End
'         Else
'            '專利D/N幣別
'            stSQL = "select fa43 from fagent where fa01='" & Mid(oFaKey & "000000", 1, 8) & "' and fa02='" & Mid(oFaKey & "000000", 9, 1) & "'"
'         End If
'      Else
'         'Modify By Sindy 2011/3/3
'         If CheckSys(strSysType) = "2" Or CheckSys(strSysType) = "6" Then
'            '商標D/N幣別
'            stSQL = "select cu148 from customer where cu01='" & Mid(oFaKey & "000000", 1, 8) & "' and cu02='" & Mid(oFaKey & "000000", 9, 1) & "'"
'         '2011/3/3 End
'         Else
'            '專利D/N幣別
'            stSQL = "select cu76 from customer where cu01='" & Mid(oFaKey & "000000", 1, 8) & "' and cu02='" & Mid(oFaKey & "000000", 9, 1) & "'"
'         End If
'      End If
'      '2009/6/24 end
'      intR = 1
'      Set AdoRecordSet3 = ClsLawReadRstMsg(intR, stSQL)
'      If intR = 1 Then
'         pub_GetCurrency = "" & AdoRecordSet3(0)
'      Else
'         'Modify by Sindy 2013/1/17
'         'pub_GetCurrency = "U"
'         pub_GetCurrency = "USD"
'         '2013/1/17 End
'      End If
''   Else
''   '2013/1/28 End
''
''      '2009/6/24 modify by sonia
''      'stSQL = "select fa43 from fagent where fa01='" & Mid(oFaKey & "000000", 1, 8) & "' and fa02='" & Mid(oFaKey & "000000", 9, 1) & "'"
''      If Mid(oFaKey, 1, 1) = "Y" Then
''         'Modify By Sindy 2011/3/3
''         If CheckSys(strSysType) = "2" Or CheckSys(strSysType) = "6" Then
''            '商標D/N幣別
''            stSQL = "select fa108 from fagent where fa01='" & Mid(oFaKey & "000000", 1, 8) & "' and fa02='" & Mid(oFaKey & "000000", 9, 1) & "'"
''         '2011/3/3 End
''         Else
''            '專利D/N幣別
''            stSQL = "select fa43 from fagent where fa01='" & Mid(oFaKey & "000000", 1, 8) & "' and fa02='" & Mid(oFaKey & "000000", 9, 1) & "'"
''         End If
''      Else
''         'Modify By Sindy 2011/3/3
''         If CheckSys(strSysType) = "2" Or CheckSys(strSysType) = "6" Then
''            '商標D/N幣別
''            stSQL = "select cu148 from customer where cu01='" & Mid(oFaKey & "000000", 1, 8) & "' and cu02='" & Mid(oFaKey & "000000", 9, 1) & "'"
''         '2011/3/3 End
''         Else
''            '專利D/N幣別
''            stSQL = "select cu76 from customer where cu01='" & Mid(oFaKey & "000000", 1, 8) & "' and cu02='" & Mid(oFaKey & "000000", 9, 1) & "'"
''         End If
''      End If
''      '2009/6/24 end
''      intR = 1
''      Set AdoRecordSet3 = ClsLawReadRstMsg(intR, stSQL)
''      If intR = 1 Then
''         pub_GetCurrency = "" & AdoRecordSet3(0)
''      Else
''         pub_GetCurrency = "U"
''      End If
''   End If
'End Function

'Add by Morgan 2008/4/17 取得FCP案件的減免狀態
Public Function PUB_GetFCPCaseDiscState(PA0104 As String, Optional stDiscType As String) As Boolean
'Modify by Morgan 2010/6/28
'   Dim stSQL As String, intR As Integer
'   stSQL = "SELECT CU01,CU02,CU15 FROM CUSTOMER WHERE (CU01,CU02) IN (" & _
'      " SELECT SUBSTR(PA26,1,8),SUBSTR(PA26,9,1) FROM PATENT WHERE " & ChgPatent(PA0104) & _
'      " UNION SELECT SUBSTR(PA27,1,8),SUBSTR(PA27,9,1) FROM PATENT WHERE " & ChgPatent(PA0104) & _
'      " UNION SELECT SUBSTR(PA28,1,8),SUBSTR(PA28,9,1) FROM PATENT WHERE " & ChgPatent(PA0104) & _
'      " UNION SELECT SUBSTR(PA29,1,8),SUBSTR(PA29,9,1) FROM PATENT WHERE " & ChgPatent(PA0104) & _
'      " UNION SELECT SUBSTR(PA30,1,8),SUBSTR(PA30,9,1) FROM PATENT WHERE " & ChgPatent(PA0104) & _
'      " ) AND NVL(CU15,'1')='1'"
'   intR = 1
'   Set AdoRecordSet3 = ClsLawReadRstMsg(intR, stSQL)
'   If intR = 0 Then
'      PUB_GetFCPCaseDiscState = True
'   End If
   If PUB_GetCaseDiscStat(PA0104, stDiscType) = "Y" Then
      PUB_GetFCPCaseDiscState = True
   End If
'end 2010/6/28
End Function

'add by sonia 2015/12/24
'讀取薪資查詢系統初始時相關變數值
Public Function PUB_GetSalaryData()
Dim stSQL As String, intR As Integer

   Pub_MaxSMYM = 0                '可查詢薪資資料最大年月
   Pub_MaxYBYear = 0              '可查詢年終資料最大年度
   Pub_MaxOB1Year = 0             '可查詢端午資料最大年度
   Pub_MaxOB2Year = 0             '可查詢中秋資料最大年度

   stSQL = "select '1' type,max(br01) br01 from BookRecord where br01>=" & Pub_StartYM & " and br02<=" & strSrvDate(1) & " and substr(br01,5,2)<='12' union " & _
           "select '2' type,max(br01) br01 from BookRecord where br01>=" & Pub_StartYM & " and br02<=" & strSrvDate(1) & " and substr(br01,5,2)='13' union " & _
           "select '3' type,max(br01) br01 from BookRecord where br01>=" & Pub_StartYM & " and br02<=" & strSrvDate(1) & " and substr(br01,5,2)='14' union " & _
           "select '4' type,max(br01) br01 from BookRecord where br01>=" & Pub_StartYM & " and br02<=" & strSrvDate(1) & " and substr(br01,5,2)='15' order by type"

   intR = 1
   Set AdoRecordSet3 = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      With AdoRecordSet3
      Do While Not .EOF
         Select Case .Fields("type")
            Case "1"
               If "" & .Fields("br01") <> "" Then Pub_MaxSMYM = Val(.Fields("br01"))
            Case "2"
               If "" & .Fields("br01") <> "" Then Pub_MaxYBYear = Val(Left(.Fields("br01"), 4))
            Case "3"
               If "" & .Fields("br01") <> "" Then Pub_MaxOB1Year = Val(Left(.Fields("br01"), 4))
            Case "4"
               If "" & .Fields("br01") <> "" Then Pub_MaxOB2Year = Val(Left(.Fields("br01"), 4))
         End Select
         .MoveNext
      Loop
      End With
   End If
   
   '讀取可查詢薪資資料名單,不含國外部外翻及'F4100','F4101','F4102','F4103','96029','96030'
   '1.有權限主管讀取員工名單(剔除本人及總經理Pub_GetSpecMan("總經理員工編號"))
   '2.讀取個人及外翻編號
   Pub_StaffList = ""
   
   '若屬於Pub_GetSpecMan("可查詢全所薪資資料名單")人員則抓全部
   If InStr(Pub_GetSpecMan("可查詢全所薪資資料名單"), strUserNum) > 0 Then
      'modify by sonia 2021/1/21 +F4104~F4107
      stSQL = "      SELECT ST02||' '||ST01||DECODE(ST51,NULL,NULL,' (離)'),'2' SORT,ST03,ST01 FROM STAFF WHERE ST01<>'" & strUserNum & "' AND ST03<>'F51' AND (ST04='1' OR ST51>=" & Val(Pub_StartYM & "00") & ") AND SUBSTR(ST01,4,1)<>'9' AND ST01>'60000' AND ST01<'FZ' " & _
              "         AND ST01 NOT IN ('F4100','F4101','F4102','F4103','F4104','F4105','F4106','F4107','96029','96030') " & _
              "UNION SELECT S2.ST02||' '||S2.ST01||DECODE(S2.ST51,NULL,NULL,' (離)'),'1' SORT,S2.ST03 ST03,S2.ST01 ST01 FROM STAFF S1,STAFF S2 WHERE S1.ST01='" & strUserNum & "' AND S1.ST26=S2.ST26(+) "
   Else
      'modify by sonia 2021/1/21 +F4104~F4107
      'Modified by Morgan 2024/1/31 +ACC090NEW.A0927
      'modify by sonia 2024/12/20 非上述特殊人員僅可查在職人員薪資,故ST04='1' OR ST51>=" & Val(Pub_StartYM & "00") & "改為ST04='1'
      stSQL = "      SELECT ST02||' '||ST01||DECODE(ST51,NULL,NULL,' (離)'),'3' SORT,ST03,ST01 FROM STAFF,ACC090,ACC090NEW WHERE A0901<>'F51' AND INSTR(A0913||';'||A0927,'" & strUserNum & "')>0 AND A0901=ST03(+) AND A0921=ST93(+) AND (ST04='1' ) AND SUBSTR(ST01,4,1)<>'9' AND ST01>'60000' AND ST01<'FZ' " & _
              "         AND ST01 NOT IN ('F4100','F4101','F4102','F4103','F4104','F4105','F4106','F4107','96029','96030') " & _
              "         AND ST01<>'" & strUserNum & "' AND ST01 NOT IN ('" & Pub_GetSpecMan("總經理員工編號") & "') " & _
              "UNION SELECT ST02||' '||ST01,'1' SORT,ST03,ST01 FROM STAFF WHERE ST01='" & strUserNum & "' " & _
              "UNION SELECT S2.ST02||' '||S2.ST01||DECODE(S2.ST51,NULL,NULL,' (離)'),'2' SORT,S2.ST03 ST03,S2.ST01 ST01 FROM STAFF S1,STAFF S2 WHERE S1.ST01='" & strUserNum & "' AND S1.ST26=S2.ST26(+) AND S2.ST01<>S1.ST01 AND (S2.ST04='1' OR S2.ST51>=" & Val(Pub_StartYM & "00") & ") "
   End If
   'modify by sonia 2016/1/25 王副總建議排序改部門+員工編號,婧瑄也同意,原依姓名排序
   stSQL = stSQL & "ORDER BY SORT,ST03,ST01"

   intR = 1
   Set AdoRecordSet3 = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      With AdoRecordSet3
      Do While Not .EOF
         If Pub_StaffList = "" Then
            Pub_StaffList = .Fields(0)
         Else
            Pub_StaffList = Pub_StaffList & ";" & .Fields(0)
         End If
         .MoveNext
      Loop
      End With
   End If

   'add by sonia 2025/2/5 '可查詢年終獎金資料人員名單,與Pub_StaffList區分權限
   '讀取可查詢年終獎金資料名單,不含國外部外翻及'F4100','F4101','F4102','F4103','96029','96030'
   '1.有權限主管讀取員工名單(剔除本人及總經理Pub_GetSpecMan("總經理員工編號"))
   '2.讀取個人及外翻編號
   Pub_StaffBonusList = ""
   '若屬於Pub_GetSpecMan("年終獎金作業可操作人員")人員則抓全部
   If InStr(Pub_GetSpecMan("年終獎金作業可操作人員"), strUserNum) > 0 Then
      stSQL = "      SELECT ST02||' '||ST01||DECODE(ST51,NULL,NULL,' (離)'),'2' SORT,ST03,ST01 FROM STAFF WHERE ST01<>'" & strUserNum & "' AND ST03<>'F51' AND (ST04='1' OR ST51>=" & Val(Pub_StartYM & "00") & ") AND SUBSTR(ST01,4,1)<>'9' AND ST01>'60000' AND ST01<'FZ' " & _
              "         AND ST01 NOT IN ('F4100','F4101','F4102','F4103','F4104','F4105','F4106','F4107','96029','96030') " & _
              "UNION SELECT S2.ST02||' '||S2.ST01||DECODE(S2.ST51,NULL,NULL,' (離)'),'1' SORT,S2.ST03 ST03,S2.ST01 ST01 FROM STAFF S1,STAFF S2 WHERE S1.ST01='" & strUserNum & "' AND S1.ST26=S2.ST26(+) "
   Else
      stSQL = "      SELECT ST02||' '||ST01||DECODE(ST51,NULL,NULL,' (離)'),'3' SORT,ST03,ST01 FROM STAFF,ACC090,ACC090NEW WHERE A0901<>'F51' AND INSTR(A0913||';'||A0927,'" & strUserNum & "')>0 AND A0901=ST03(+) AND A0921=ST93(+) AND (ST04='1' ) AND SUBSTR(ST01,4,1)<>'9' AND ST01>'60000' AND ST01<'FZ' " & _
              "         AND ST01 NOT IN ('F4100','F4101','F4102','F4103','F4104','F4105','F4106','F4107','96029','96030') " & _
              "         AND ST01<>'" & strUserNum & "' AND ST01 NOT IN ('" & Pub_GetSpecMan("總經理員工編號") & "') " & _
              "UNION SELECT ST02||' '||ST01,'1' SORT,ST03,ST01 FROM STAFF WHERE ST01='" & strUserNum & "' " & _
              "UNION SELECT S2.ST02||' '||S2.ST01||DECODE(S2.ST51,NULL,NULL,' (離)'),'2' SORT,S2.ST03 ST03,S2.ST01 ST01 FROM STAFF S1,STAFF S2 WHERE S1.ST01='" & strUserNum & "' AND S1.ST26=S2.ST26(+) AND S2.ST01<>S1.ST01 AND (S2.ST04='1' OR S2.ST51>=" & Val(Pub_StartYM & "00") & ") "
   End If
   stSQL = stSQL & "ORDER BY SORT,ST03,ST01"

   intR = 1
   Set AdoRecordSet3 = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      With AdoRecordSet3
      Do While Not .EOF
         If Pub_StaffBonusList = "" Then
            Pub_StaffBonusList = .Fields(0)
         Else
            Pub_StaffBonusList = Pub_StaffBonusList & ";" & .Fields(0)
         End If
         .MoveNext
      Loop
      End With
   End If
   'end 2025/2/5
   
End Function
'end 2015/12/24

'Add by Morgan 2008/4/24
'特殊權限智權人員清單
'Modified by Lydia 2017/07/25 +可使用業務區(tST15_1,tST15_2)
Public Function PUB_GetSalesList(p_SalesNo As String, Optional p_SalesAreaFrom As String, Optional p_SalesAreaTo As String, Optional p_SalesZone As String, Optional p_ST05 As String, Optional ByRef tST15_1 As String, Optional ByRef tST15_2 As String) As String
Dim stSQL As String, bXID As Boolean, intR As Integer, stCon As String
Dim stRtn As String
Dim rsQ1 As New ADODB.Recordset 'Added by Lydia 2017/07/25

'From: 邱秀玲 (資訊.副理.sonia)
'Sent: Friday, June 10, 2022 3:00 PM
'To: 盧秀雲(資訊.Sindy) <97038@taie.com.tw>
'Subject: RE: 智權部的暫收款查詢
'
'只要有權限查詢資料 , 無論任何人查任何人的資料, 結果要一致:
'1. 被查詢的人若為帶人主管，下屬離職時則一併帶出離職下屬資料，若下屬未離職則不必帶出；
'2. 被查詢的人若為區主管SM時，則同時帶出該區離職人員及虛建編號的資料；
'3. 查詢條件未下智權人員編號時，則依業務區條件帶出該區所有人資料。

   Pub_StrST52 = False   '2010/5/10 add by sonia
   
   '智權人員下自己時可看見 自己的 + 離職智權人員 + 該業務區虛建智權人員的資料
   '2009/12/16 modify by sonia 加電腦中心查詢主管時也可看該主管 + 離職智權人員 + 該業務區虛建智權人員的資料
   'Modify By Sindy 2022/6/10 只要有輸入員編,就需要用員編檢查權限
   'If (strUserNum = p_SalesNo) Or Pub_StrUserSt03 = "M51" Then
   If p_SalesNo <> "" Then
   '2022/6/10 END
      '1.使用者為74018,71011,67002,87027
      'modify by sonia 2016/2/24 +69008
      'Modify By Sindy 2022/6/10
      'If InStr("74018,71011,67002,69008,87027", p_SalesNo) > 0 Then
      'Modifed by Lydia 2023/04/24 修改王副總退休之相關控制; 5/1加入李柏翰99050
      'If InStr("71011,87027", p_SalesNo) > 0 Then
      '2022/6/10 END
      If InStr("71011,87027" & IIf(strSrvDate(1) >= "20230501", ",99050", ""), p_SalesNo) > 0 Then
         bXID = True
      Else
         'Modify By Sindy 2022/6/10
         'If p_ST05 = "" Then p_ST05 = PUB_GetST05(strUserNum)
         If p_ST05 = "" Then p_ST05 = PUB_GetST05(p_SalesNo)
         '2022/6/10 END
         If p_ST05 = "SM" Then bXID = True
         '2010/5/10 ADD BY SONIA 若離職時帶人主管也要看到離職人員資料 98008姚志揚離職,77043郭少鈞可以看到
         'Modify By Sindy 2014/8/28 +ST53,ST54,ST55
         'stSQL = "select st01 from staff where st52='" & p_SalesNo & "' and st04<>'1'"
         stSQL = "select st01 from staff where (st52='" & p_SalesNo & "' or st53='" & p_SalesNo & "' or st54='" & p_SalesNo & "' or st55='" & p_SalesNo & "')"
         '2014/8/28 END
         intR = 1
         'Moified by Lydia 2017/07/25 AdoRecordSet3 ->rsQ1
         Set rsQ1 = ClsLawReadRstMsg(intR, stSQL)
         If intR = 1 Then
            bXID = True: Pub_StrST52 = True
         End If
         '2010/5/10 END
         'modify by sonia 2016/6/7 72014代看虛建編號S29,20012的資料,即看72014編號時同時查出S29及20012資料
         If InStr("72014", p_SalesNo) > 0 Then
            stSQL = "select st01 from staff where (st52='" & p_SalesNo & "' or st53='" & p_SalesNo & "' or st54='" & p_SalesNo & "' or st55='" & p_SalesNo & "') "
            intR = 1
            'Moified by Lydia 2017/07/25 AdoRecordSet3 ->rsQ1
            Set rsQ1 = ClsLawReadRstMsg(intR, stSQL)
            If intR = 1 Then
               bXID = True: Pub_StrST52 = True
            End If
         End If
         'end 2016/6/7
      End If
   'Modify By Sindy 2022/6/10 Mark,同上檢查即可
'   'add by sonia 2017/1/26 開放吳碧梧70005可操作林文雄A4023
'   ElseIf strUserNum = "70005" And p_SalesNo = "A4023" Then
'      bXID = True: Pub_StrST52 = True
'   'end 2017/1/26
   '2022/6/10 END
   Else
      bXID = False
   End If
   
'   '2010/9/24 add by sonia 若上級主管查業務區主管(杜副總看林協理)也要可以看到該區離職智權人員及虛建智權人員的資料
'   'Modify By Sindy 2020/7/29 79053.蘇嫄媛要查杜經理資料時,也要查到杜經理可以看到的其他人員資料 =>  Or InStr("74018", p_SalesNo) > 0)
'   If (strUserNum <> p_SalesNo) And _
'      (PUB_GetST05(p_SalesNo) = "SM" Or InStr("74018", p_SalesNo) > 0) Then
'      bXID = True
'   End If
'   '2010/9/24 end
'
'   'Add By Sindy 2020/7/28 簡協理可看所有智權人員
'   'Modify By Sindy 2022/5/4 簡協理改為抓系統特殊設定「全所智權部主管」
'   If InStr(Pub_GetSpecMan("全所智權部主管"), strUserNum) > 0 And Left(PUB_GetStaffST15(p_SalesNo, "1"), 1) = "S" Then
'      bXID = True
'   End If
'   '2020/7/28 END
   
   'Add By Sindy 2022/6/6 增加開放部門主管可以查詢離職同仁資料
   stSQL = "select st01 from staff a,acc090 where st15=a0901(+) and '" & p_SalesNo & "'=a0908"
   intR = 1
   Set rsQ1 = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      bXID = True
   End If
   '2022/6/6 END
   
   If p_SalesZone <> "" Then
      'edit by nickc 2008/05/09 若是電腦中心就不管所別
      '2010/5/17 modify by sonia 加財務處
      If Pub_StrUserSt03 = "M31" Or Pub_StrUserSt03 = "M51" Then
      Else
         stCon = stCon & " and st06='" & p_SalesZone & "'"
      End If
   End If
   
   '業務區條件
   'Modified by Lydia 2017/07/21 下面語法已有抓業務區,所以下列主管跳過這個條件
   'Modifed by Lydia 2023/04/24 修改王副總退休之相關控制; 5/1加入李柏翰99050
   'If ((strUserNum = p_SalesNo) Or Pub_StrUserSt03 = "M51") And InStr("71011,87027", p_SalesNo) = 0 Then
   If ((strUserNum = p_SalesNo) Or Pub_StrUserSt03 = "M51") And InStr("71011,87027" & IIf(strSrvDate(1) >= "20230501", ",99050", ""), p_SalesNo) = 0 Then
        If p_SalesAreaFrom <> "" Then
           stCon = stCon & " and st15>='" & p_SalesAreaFrom & "'"
        End If
        If p_SalesAreaTo <> "" Then
           stCon = stCon & " and st15<='" & p_SalesAreaTo & "'"
        End If
   End If 'end 2017/07/21
   
   '該業務區離職或虛建智權人員
   If bXID = True Then
      'Add By Sindy 2021/11/10
      '江協理可看內外商,同時看 96029,96030 巨京商標
      If p_SalesNo = "98020" Then
         stSQL = "select st01 from staff a where (substr(st15,1,2)='F1' or substr(st15,1,2)='P2') and (st01<'6' or st01='96029' or st01='96030' or st04='2' or st01='" & p_SalesNo & "')" & stCon
      '2021/11/10 END
      '葉經理 67002 同時看 96029,96030 巨京商標
      'modify by sonia 2016/2/24 +69008
      ElseIf p_SalesNo = "67002" Or p_SalesNo = "69008" Then
         stSQL = "select st01 from staff a where substr(st15,1,2)=(select substr(b.st15,1,2) from staff b where b.st01='" & p_SalesNo & "') and (st01<'6' or st01='96029' or st01='96030' or st04='2' or st01='" & p_SalesNo & "')" & stCon
      '王協理 71011 同時看 96031,96032 巨京專利
      'Modifed by Lydia 2023/04/24 修改王副總退休之相關控制; 5/1加入李柏翰99050
      'ElseIf p_SalesNo = "71011" Then
      ElseIf p_SalesNo = "71011" Or (strSrvDate(1) >= "20230501" And p_SalesNo = "99050") Then
         stSQL = "select st01 from staff a where substr(st15,1,2)=(select substr(b.st15,1,2) from staff b where b.st01='" & p_SalesNo & "') and (st01<'6' or st04='2' or st01='" & p_SalesNo & "')" & stCon
      '陳淑芳 87027 只能同時看 20001台中所
      ElseIf p_SalesNo = "87027" Then
         stSQL = "select st01 from staff a where substr(st15,1,2)=(select substr(b.st15,1,2) from staff b where b.st01='" & p_SalesNo & "') and (st01='20001' or st01='" & p_SalesNo & "')" & stCon
      'add by sonia 2016/6/6 林姿如 72014 能同時看 20012吳中一及S29中區其他
'      ElseIf p_SalesNo = "72014" Then
'         stSQL = "select st01 from staff a where st01='20012' or st01='S29' or (substr(st15,1,2)=(select substr(b.st15,1,2) from staff b where b.st01='" & p_SalesNo & "') and st01='" & p_SalesNo & "'" & stCon & ")"
'         Pub_StrST52 = True
      '2010/5/10 add by sonia 若離職時帶人主管也要看到離職人員資料,因中所有跨區帶人故不考慮業務區條件
'modify by sonia 2018/4/26 發現有身份重覆的情形,85026葉招進以前是帶人主管ST52,後來變成區主管
'      ElseIf Pub_StrST52 = True Then
'         'modify by sonia 2013/7/4 中二張祐昇97011離職,客戶轉中一虛建20011,同時要給林青祺87011看期限故修改
'         'stSQL = "select st01 from staff a where st01='" & p_SalesNo & "' or (st52='" & p_SalesNo & "' and st04<>'1') "
'         'Modify By Sindy 2014/8/28 +ST53,ST54,ST55
'         'stSQL = "select st01 from staff a where st01='" & p_SalesNo & "' or (st52='" & p_SalesNo & "' and st04<>'1') OR (ST52='" & p_SalesNo & "' AND ST04='1' AND ST01<'6') "
'         stSQL = "select st01 from staff a where st01='" & p_SalesNo & "' " & _
'                 "OR ((st52='" & p_SalesNo & "' or st53='" & p_SalesNo & "' or st54='" & p_SalesNo & "' or st55='" & p_SalesNo & "') AND st04<>'1') " & _
'                 "OR ((ST52='" & p_SalesNo & "' or ST53='" & p_SalesNo & "' or ST54='" & p_SalesNo & "' or ST55='" & p_SalesNo & "') AND ST04='1' AND (ST01<'6' OR ST01>'S')) "
'         '2014/8/28 END
'      '2010/5/10 end
'      '其他看該區
'      Else
'         stSQL = "select st01 from staff a where st15=(select b.st15 from staff b where b.st01='" & p_SalesNo & "') and (st01<'6' or st04='2' or st01='" & p_SalesNo & "')" & stCon
'      End If
      Else
         'Modify By Sindy 2022/6/10
         stSQL = "select st01 from staff a where st01='" & p_SalesNo & "'"
         '若離職時帶人主管也要看到離職人員資料,因中所有跨區帶人故不考慮業務區條件
         If Pub_StrST52 = True Then
            'Modify By Sindy 2022/6/14 AND (ST01<'6' OR ST01>'S') => AND ST01<'6'
            'modify by sonia 2024/6/14 上述可能因為W1001不顯示才改,但會擋住P1004故再修改為 AND ST01<>'W1001' AND (ST01<'6' OR ST01>'P')
            'stSQL = stSQL & " union select st01 from staff a where" & _
            '           " ((st52='" & p_SalesNo & "' or st53='" & p_SalesNo & "' or st54='" & p_SalesNo & "' or st55='" & p_SalesNo & "') AND st04='2') " & _
            '         "OR ((ST52='" & p_SalesNo & "' or ST53='" & p_SalesNo & "' or ST54='" & p_SalesNo & "' or ST55='" & p_SalesNo & "') AND ST04='1' AND ST01<'6') " 'W1001
            stSQL = stSQL & " union select st01 from staff a where" & _
                       " ((st52='" & p_SalesNo & "' or st53='" & p_SalesNo & "' or st54='" & p_SalesNo & "' or st55='" & p_SalesNo & "') AND st04='2') " & _
                     "OR ((ST52='" & p_SalesNo & "' or ST53='" & p_SalesNo & "' or ST54='" & p_SalesNo & "' or ST55='" & p_SalesNo & "') AND ST04='1' AND ST01<>'W1001' AND (ST01<'6' OR ST01>'P')) "
         End If
         '其他看該區但僅限部門主管
         'add by sonia 2019/5/21 S41之A0908已改為簡國靜,但楊家復仍可看全區才對
         'Modify By Sindy 2021/1/13 69005簡協理調單位,改為S00智權部主管 + Or p_SalesNo = "69005" Or strUserNum = "69005"
         'Modify By Sindy 2022/5/4 簡協理改為抓系統特殊設定「全所智權部主管」
         'Modify By Sindy 2022/6/10 Mark:下列if不符合使用
'         If p_SalesNo = "71009" Or InStr(Pub_GetSpecMan("全所智權部主管"), p_SalesNo) > 0 Or InStr(Pub_GetSpecMan("全所智權部主管"), strUserNum) > 0 Then
'            stSQL = stSQL & "select st01 from staff a,acc090 where st15=(select b.st15 from staff b where b.st01='" & p_SalesNo & "') and (st01<'6' or st04='2' or st01='" & p_SalesNo & "')" & stCon & " and st15=a0901(+) "
'         Else
'         'end 2019/5/21
         'Add By Sindy 2022/6/10
         If p_ST05 = "SM" Then
         '2022/6/10 END
            'Modify By Sindy 2022/6/14 AND (ST01<'6' OR ST01>'S') => AND ST01<'6'
            stSQL = stSQL & " union select st01 from staff a,acc090 where st15=(select b.st15 from staff b where b.st01='" & p_SalesNo & "') and ((ST04='1' AND ST01<'6') or st04='2')" & stCon & " and st15=a0901(+) and '" & p_SalesNo & "'=a0908"
         End If
'         End If   'add by sonia 2019/5/21
      End If
'2018/4/26 end
      intR = 1
      'Moified by Lydia 2017/07/25 AdoRecordSet3 ->rsQ1
      Set rsQ1 = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         'Moified by Lydia 2017/07/25 AdoRecordSet3 ->rsQ1
         stRtn = "'" & rsQ1.GetString(adClipString, , , "','") & "'"
         stRtn = Replace(stRtn, ",''", "")
      Else
         stRtn = "''"
      End If
      
   '若有下業務區條件時
   ElseIf stCon <> "" Then
      stSQL = "select st01 from staff a where st01='" & p_SalesNo & "'" & stCon
      intR = 1
      'Moified by Lydia 2017/07/25 AdoRecordSet3 ->rsQ1
      Set rsQ1 = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         'Moified by Lydia 2017/07/25 AdoRecordSet3 ->rsQ1
         stRtn = "'" & rsQ1(0) & "'"
      'add by nickc 2008/05/09 沒資料回傳空白
      Else
        stRtn = "''"
      End If
   
   Else
      stRtn = "'" & p_SalesNo & "'"
   End If
   
   '2009/12/16 add by sonia 加巨京專利給郭雅娟79075看
   If p_SalesNo = "79075" Then
      stRtn = "'" & p_SalesNo & "','96031','96032'"
   End If
   '2009/12/16 end
   
   'Added by Lydia 2017/07/24 系統特殊設定"J"為"巨京商標96029,96030期限及信件管理人"
   stSQL = Pub_GetSpecMan("J")
   If InStr(stSQL, p_SalesNo) > 0 And (InStr(stRtn, "96029") = 0 Or InStr(stRtn, "96030") = 0) Then
      stRtn = "'" & p_SalesNo & "','96029','96030'"
   End If
   'modify by sonia 2019/3/15
   'stSQL = GetMCTF0XCode(p_SalesNo) '取得MCTF群組
   stSQL = GetMCTF0XAllCode(p_SalesNo)  '取得該員工所屬之所有MCTF群組
   'end 2019/3/15
   If stSQL <> "" Then stRtn = stRtn & ",'" & stSQL & "'"
   'end 2017/07/24
   
   'add by sonia 2019/7/2 創新業務部各組人員可以看該組所有人資料,創新業務部主管W10則自行輸入W1001或W2001看
   'Memo by Lydia 2019/08/08 已經測試過智權部的各程式
   If Left(Pub_StrUserSt03, 1) = "W" And Pub_StrUserSt03 <> "W00" Then
      stSQL = "select st01 from staff where st03='" & Pub_StrUserSt03 & "' and st01<>'" & p_SalesNo & "'"
      intR = 1
      Set rsQ1 = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         With rsQ1
         Do While .EOF = False
            If stRtn = "''" Then stRtn = "'" & p_SalesNo & "'"
            stRtn = stRtn & ",'" & .Fields("st01").Value & "'"
            .MoveNext
         Loop
         End With
      End If
   End If
   'end 2019/7/2
   
   'Added by Lydia 2017/07/25 可使用業務區
   tST15_1 = "": tST15_2 = ""
   stSQL = "select min(st15) m1,max(st15) m2 from staff where st01 in (" & stRtn & ")"
   intR = 1
   Set rsQ1 = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      tST15_1 = "" & rsQ1.Fields("m1")
      tST15_2 = "" & rsQ1.Fields("m2")
   End If
   
   Set rsQ1 = Nothing
   'end 2017/07/25
   
'cancel by sonia 2015/7/1 已無客戶掛68096且進度檔資料都已發文或取消收文
'   '2011/8/3 add by sonia 查68006時同時看68096
'   If p_SalesNo = "68006" Then
'      stRtn = "'" & p_SalesNo & "','68096'"
'   End If
'   '2011/8/3 end
   'Add by Amy 2023/11/16 被查詢的智權人員若在「全所智權部主管」名單內,同時看10009(管理部無效)的資料
   If InStr(Pub_GetSpecMan("全所智權部主管"), p_SalesNo) > 0 Then
      stRtn = "'" & p_SalesNo & "','10009'"
   End If
   PUB_GetSalesList = stRtn
End Function

''Add by Morgan 2008/4/25
''檢查是否有該智權人員的管理權限
'Public Function PUB_CheckSalesRight(p_SalesNo As String, Optional p_bMsg As Boolean) As Boolean
'   Dim stSQL As String, intR As Integer, bRtn As Boolean
'   bRtn = False
'
'   '自己
'   If strUserNum = p_SalesNo Then
'      bRtn = True
'   '電腦中心
'   ElseIf Pub_StrUserSt03 = "M51" Then
'      bRtn = True
'   '2015/7/29 ADD BY SONIA 總經理(等級01)及主任秘書(等級08)可看全部
'   ElseIf PUB_GetST05(strUserNum) = "01" Or PUB_GetST05(strUserNum) = "08" Then
'      bRtn = True
'   '2015/7/29 END
'   'Modify By Sindy 2020/7/1 + 帶人主管
'   ElseIf p_SalesNo <> strUserNum And PUB_GetST52(p_SalesNo, strUserNum) = True Then
'      bRtn = True
'   '2020/7/1 END
'   Else
'      '2011/8/10 add by sonia杜副總或中三區人員可查68096
'      If (strUserNum = "68006" Or PUB_GetStaffST15(strUserNum, "1") = "S23") And p_SalesNo = "68096" Then
'         bRtn = True
'      '2011/8/10 end
'      'Modify By Sindy 2009/05/12
'      '若為帶人主管權限時,檢查其輸入的智權人員之第二級期限管制人是否為操作人員
'      ElseIf PUB_GetST05(strUserNum) = "SA" Then
'         'Modify By Sindy 2014/8/28
'         'If p_SalesNo <> strUserNum And PUB_GetST52(p_SalesNo) <> strUserNum Then
'         If p_SalesNo <> strUserNum And PUB_GetST52(p_SalesNo, strUserNum) = False Then
'         '2014/8/28 END
'            'MsgBox "您無權限查詢此人資料！", vbExclamation, "操作錯誤！"
'         Else
'            bRtn = True
'         End If
'      Else
'         '專利、商標主管
'         'modify by sonia 2016/2/24 +69008
'         If InStr("68005,71011,67002,69008", strUserNum) > 0 Then
'            stSQL = "select * from staff a where st01='" & p_SalesNo & "'" & _
'               " and exists(select * from staff b where b.st01='" & strUserNum & "' and substr(b.st15,1,2)=substr(a.st15,1,2))"
'         '杜燕文可看所屬業務區
'         'Modify By Sindy 2022/5/9 杜經理此權限只使用到 20220513
'         ElseIf strUserNum = "74018" And strSrvDate(1) < 20220514 Then
'            stSQL = "select * from staff a where st01='" & p_SalesNo & "'" & _
'               " and exists(select * from staff b where b.st01='" & strUserNum & "' and b.st15=a.st15)"
'         'add by sonia 2016/6/30 林柄佑82026可看中所業務
'         ElseIf strUserNum = "82026" Then
'            stSQL = "select * from staff a where st01='" & p_SalesNo & "' and st15>='S2' and st15<='S29'"
'         'end 2016/6/30
'         Else
'            stSQL = "select * from staff a where st01='" & p_SalesNo & "'" & _
'               " and exists(select * from staff b where b.st01='" & strUserNum & "' and b.st05='SM' and b.st15=a.st15)"
'         End If
'         intR = 1
'         Set AdoRecordSet3 = ClsLawReadRstMsg(intR, stSQL)
'         If intR = 1 Then
'            bRtn = True
'         End If
'      End If
'   End If
'   PUB_CheckSalesRight = bRtn
'   If p_bMsg = True And bRtn = False Then
'      MsgBox "無該智權人員權限！"
'   End If
'End Function

'add by nickc 2008/04/29 檢查是否欠款，有欠款不可以發文
Public Function IsDebt(oNation As String, oCp09 As String) As Boolean
Dim m_rs As New ADODB.Recordset
Dim m_rs2 As New ADODB.Recordset
IsDebt = False
'edit by nickc 2008/05/02 先都取消
Exit Function
If oNation <> "000" Then
    Set m_rs = New ADODB.Recordset
    If m_rs.State = 1 Then m_rs.Close
    m_rs.CursorLocation = adUseClient
    m_rs.Open "select * from caseprogress where cp09='" & oCp09 & "' and substr(cp12,1,1)='S' ", cnnConnection, adOpenStatic, adLockReadOnly
    If Not m_rs.EOF And Not m_rs.BOF Then
        '沒收據但有費用
        If CheckStr(m_rs.Fields("CP60")) = "" Then
            If Val(CheckStr(m_rs.Fields("CP16"))) <> 0 Then
                IsDebt = True
            End If
        Else
            '有收據但有未收金額
            If Val(CheckStr(m_rs.Fields("CP79"))) <> 0 Then
                IsDebt = True
            End If
        End If
        If IsDebt Then
            'Remove by Lydia 2018/08/22 取消預定收款日,改成付款週期
'            Set m_rs2 = New ADODB.Recordset
'            m_rs2.CursorLocation = adUseClient
'            m_rs2.Open "select * from ReceivablesDay where rd01='" & oCp09 & "' ", cnnConnection, adOpenStatic, adLockReadOnly
'            If Not m_rs2.EOF And Not m_rs2.BOF Then
'                IsDebt = False
'            End If
            'end 2018/08/22
        End If
    End If
    m_rs.Close
    Set m_rs = Nothing
End If
End Function
'Add by Morgan 2008/5/7
'新增定稿暫存檔(報價)
'Modified by Morgan 2018/7/17 +p_LC18
Public Sub PUB_AddLetterCache(p_LC01 As String, p_LC02 As String, p_LC03 As String, p_LC04 As String, p_LC05 As String, Optional p_LC15 As Double, Optional p_LC18 As String)
   Dim stSQL As String, intR As Integer
   
   cnnConnection.BeginTrans
On Error GoTo ErrHnd
   'Add by Lydia 2014/10/29 　LC02="0"＝＞為自動發證國家之證書號輸入(frm05010403_2)時產生，因為無下一程序所以預設LC02=NP22=0
   '刪除暫存定稿
   stSQL = "delete from LetterCache where LC01='" & p_LC01 & "' and LC02='" & p_LC02 & "'"
   cnnConnection.Execute stSQL, intR
   '刪除暫存定稿變數
   stSQL = "delete from LetterCacheVar where LCV01='" & p_LC01 & "' and LCV02='" & p_LC02 & "'"
   cnnConnection.Execute stSQL, intR
   '新增暫存定稿
   If p_LC15 > 0 Then
      stSQL = "insert into LetterCache(LC01,LC02,LC03,LC04,LC05,LC15,LC18)" & _
         " values('" & p_LC01 & "'," & p_LC02 & ",'" & p_LC03 & "','" & p_LC04 & "','" & p_LC05 & "'," & p_LC15 & ",'" & p_LC18 & "')"
   Else
      stSQL = "insert into LetterCache(LC01,LC02,LC03,LC04,LC05,LC18)" & _
         " values('" & p_LC01 & "'," & p_LC02 & ",'" & p_LC03 & "','" & p_LC04 & "','" & p_LC05 & "','" & p_LC18 & "')"
   End If
   cnnConnection.Execute stSQL, intR
   
   'Added by Morgan 2020/9/16 若信件未處理時上假列印日，先不讓業務看報價，等信件已處理時再清除並更新報價日
   If p_LC18 <> "" Then
      stSQL = "update lettercache set lc13=19221111 where lc18='" & p_LC18 & "' and lc13 is null and exists(select * from InputRecord where ir21=lc18 and ir08=0)"
      cnnConnection.Execute stSQL, intR
   End If
   'end 2020/9/16
   
   'Add By Sindy 2021/1/6 內商電子化後,新增報價定稿時,不上專業部發文日
   '  等到智權部確認後印出定稿時，才上專業部發文日
   stSQL = "Update caseprogress Set cp27=null WHERE cp09='" & p_LC01 & "'" & _
         " and substr(cp01,1,1)='T' AND cp27 is not null"
   cnnConnection.Execute stSQL, intR
   '2021/1/6 END
   
   cnnConnection.CommitTrans
   Exit Sub
   
ErrHnd:
   cnnConnection.RollbackTrans
   MsgBox Err.Description
End Sub

'add by nickc 2008/05/08 判斷名稱指定細分國籍(美國及日本才有效)
Public Function pub_NationByName(oName As String, oOldNation As String, Optional IsChk As Boolean = False, Optional m_msg As String) As String
Dim m_tmpN As String
Dim m_msg1 As String
   'Added by Lydia 2016/08/09 改成直接以字首來細分國籍
   'If strSrvDate(1) >= "20160811" Then 'Remove by Lydia 2016/08/11
        '目前設定:美國,日本,德國
        If InStr(Pub_GetSpecMan("NA01_4"), Mid(oOldNation, 1, 3)) > 0 And Mid(oOldNation, 1, 3) <> "" Then
            m_tmpN = UCase(Replace(oName, " ", ""))
            If Mid(m_tmpN, 1, 29) = UCase("PatentProfessionalCorporation") Then
                m_tmpN = Mid(m_tmpN, 30)
            ElseIf Mid(m_tmpN, 1, 19) = UCase("PatentCorporateBody") Then
                m_tmpN = Mid(m_tmpN, 20)
            ElseIf Mid(m_tmpN, 1, 12) = UCase("LAWOFFICESOF") Then
                m_tmpN = Mid(m_tmpN, 13)
            ElseIf Mid(m_tmpN, 1, 10) = UCase("LAWOFFICES") Then
                m_tmpN = Mid(m_tmpN, 11)
            ElseIf Mid(m_tmpN, 1, 11) = UCase("LAWOFFICEOF") Then
                m_tmpN = Mid(m_tmpN, 12)
            ElseIf Mid(m_tmpN, 1, 9) = UCase("LAWOFFICE") Then
                m_tmpN = Mid(m_tmpN, 10)
            ElseIf Mid(m_tmpN, 1, 29) = UCase("IntellectualPropertyLawFirmof") Then
                m_tmpN = Mid(m_tmpN, 30)
            ElseIf Mid(m_tmpN, 1, 14) = UCase("THELAWOFFICEOF") Then
                m_tmpN = Mid(m_tmpN, 15)
            ElseIf Mid(m_tmpN, 1, 3) = UCase("Ms.") Then
                m_tmpN = Mid(m_tmpN, 4)
            ElseIf Mid(m_tmpN, 1, 3) = UCase("Mr.") Then
                m_tmpN = Mid(m_tmpN, 4)
            '********加特殊名稱時,資料庫自訂函數 GetHeadChar 也要修改
            End If
            '字首A=原國家代碼
             If Mid(m_tmpN, 1, 1) = "A" Then
                 pub_NationByName = Mid(oOldNation, 1, 3)
                 m_msg1 = m_msg & "英文名稱第一碼為 A，" & m_msg & "國籍應該為 " & Mid(oOldNation, 1, 3) & " !"
             '其他以字首為區分代號
             ElseIf Mid(m_tmpN, 1, 1) >= "B" And Mid(m_tmpN, 1, 1) <= "Z" Then
                 pub_NationByName = Mid(oOldNation, 1, 3) & Mid(m_tmpN, 1, 1)
                 m_msg1 = m_msg & "英文名稱第一碼為 " & Mid(m_tmpN, 1, 1) & "，" & m_msg & "國籍應該為 " & Mid(oOldNation, 1, 3) & Mid(m_tmpN, 1, 1) & " !"
             Else
                 pub_NationByName = Mid(oOldNation, 1, 3) & "Z"
                 m_msg1 = m_msg & "英文名稱第一碼非英文字母或無英文名稱，" & m_msg & "國籍應該為 " & Mid(oOldNation, 1, 3) & "Z !"
             End If
             If IsChk = True And oOldNation <> pub_NationByName Then
                 ShowMsg m_msg1
             End If
        Else
            pub_NationByName = oOldNation
        End If
'Remove by Lydia 2016/08/11
'   Else
'   'end 2016/08/09
'
'        'Modified by Lydia 2016/03/14 +德國231
'        If Mid(oOldNation, 1, 3) = "101" Or Mid(oOldNation, 1, 3) = "011" Or Mid(oOldNation, 1, 3) = "231" Then
'            m_tmpN = UCase(Replace(oName, " ", ""))
'            'may 的需求
'            If Mid(m_tmpN, 1, 29) = UCase("PatentProfessionalCorporation") Then
'                m_tmpN = Mid(m_tmpN, 30)
'            ElseIf Mid(m_tmpN, 1, 19) = UCase("PatentCorporateBody") Then
'                m_tmpN = Mid(m_tmpN, 20)
'            '2008/9/23 ADD BY SONIA
'            ElseIf Mid(m_tmpN, 1, 12) = UCase("LAWOFFICESOF") Then
'                m_tmpN = Mid(m_tmpN, 13)
'            ElseIf Mid(m_tmpN, 1, 10) = UCase("LAWOFFICES") Then
'                m_tmpN = Mid(m_tmpN, 11)
'            ElseIf Mid(m_tmpN, 1, 11) = UCase("LAWOFFICEOF") Then
'                m_tmpN = Mid(m_tmpN, 12)
'            ElseIf Mid(m_tmpN, 1, 9) = UCase("LAWOFFICE") Then
'                m_tmpN = Mid(m_tmpN, 10)
'            '2008/9/23 END
'            'Add By Sindy 2009/07/03
'            ElseIf Mid(m_tmpN, 1, 29) = UCase("IntellectualPropertyLawFirmof") Then
'                m_tmpN = Mid(m_tmpN, 30)
'            '2009/07/03 End
'            '2010/4/15 ADD BY SONIA Y52109
'            ElseIf Mid(m_tmpN, 1, 14) = UCase("THELAWOFFICEOF") Then
'                m_tmpN = Mid(m_tmpN, 15)
'            '2010/4/15 END
'           'Add By Sindy 2010/7/2
'            ElseIf Mid(m_tmpN, 1, 3) = UCase("Ms.") Then
'                m_tmpN = Mid(m_tmpN, 4)
'            ElseIf Mid(m_tmpN, 1, 3) = UCase("Mr.") Then
'                m_tmpN = Mid(m_tmpN, 4)
'            '2010/7/2 End
'            '********加特殊名稱時,資料庫自訂函數 GetHeadChar 也要修改
'            End If
'            Select Case Mid(oOldNation, 1, 3)
'            Case "101" '美國
'                '原為A~I為101,J~Z為1011,2008年改為分四段
'                'Modified by Morgan 2012/7/2 O~Z(1013) 拆成 O~S(1013),T~Z(1014)
'                '2012/10/31 modify by sonia 原O~S(1013),T~Z(1014) 改為O~R(1013),S~Z(1014)
'                '2013/3/21  modiby by sonia 再改回 O~S(1013),T~Z(1014)
'                '2013/8/2   modify by sonia 配合外專承辦再改
'                'Modified by Lydia 2016/04/13 原本T~W為1014，改為T為1014及U~W為1015；原本X~Z為1015，改為1016，其他改為1016
'                'Modified by Lydia 2016/07/13 原A~I(101)，拆成A~E(101)和F~I(1011)
'                If Mid(m_tmpN, 1, 1) >= "A" And Mid(m_tmpN, 1, 1) <= "E" Then
'                     pub_NationByName = "101"
'                     m_msg1 = m_msg & "英文名稱第一碼介於 A~E 之間，" & m_msg & "國籍應該為 101 !"
'
'                ElseIf Mid(m_tmpN, 1, 1) >= "F" And Mid(m_tmpN, 1, 1) <= "I" Then
'                     pub_NationByName = "1011"
'                     m_msg1 = m_msg & "英文名稱第一碼介於 F~I 之間，" & m_msg & "國籍應該為 1011 !"
'
'                ElseIf Mid(m_tmpN, 1, 1) >= "J" And Mid(m_tmpN, 1, 1) <= "N" Then
'                     pub_NationByName = "1012"
'                     m_msg1 = m_msg & "英文名稱第一碼介於 J~N 之間，" & m_msg & "國籍應該為 1012 !"
'
'                ElseIf Mid(m_tmpN, 1, 1) >= "O" And Mid(m_tmpN, 1, 1) <= "R" Then
'                     pub_NationByName = "1013"
'                     m_msg1 = m_msg & "英文名稱第一碼介於 O~R 之間，" & m_msg & "國籍應該為 1013 !"
'
'                ElseIf Mid(m_tmpN, 1, 1) >= "S" And Mid(m_tmpN, 1, 1) <= "S" Then
'                     pub_NationByName = "1014"
'                     m_msg1 = m_msg & "英文名稱第一碼為 S，" & m_msg & "國籍應該為 1014 !"
'
'                ElseIf Mid(m_tmpN, 1, 1) >= "T" And Mid(m_tmpN, 1, 1) <= "T" Then
'                     pub_NationByName = "1015"
'                     m_msg1 = m_msg & "英文名稱第一碼為 T，" & m_msg & "國籍應該為 1015 !"
'
'                ElseIf Mid(m_tmpN, 1, 1) >= "U" And Mid(m_tmpN, 1, 1) <= "W" Then
'                     pub_NationByName = "1016"
'                     m_msg1 = m_msg & "英文名稱第一碼介於 U~W 之間，" & m_msg & "國籍應該為 1016 !"
'
'                ElseIf Mid(m_tmpN, 1, 1) >= "X" And Mid(m_tmpN, 1, 1) <= "Z" Then
'                     pub_NationByName = "1017"
'                     m_msg1 = m_msg & "英文名稱第一碼介於 X~Z 之間，" & m_msg & "國籍應該為 1017 !"
'
'                Else
'                     pub_NationByName = "1017"
'                     m_msg1 = m_msg & "英文名稱第一碼非英文字母或無英文名稱，" & m_msg & "國籍應該為 1017 !"
'                End If
'                If IsChk = True And oOldNation <> pub_NationByName Then
'                    ShowMsg m_msg1
'                End If
'
'            Case "011" '日本
'                '原為A~L為011,M~Z為0111,2008/4/22改為分三段(將M~Z再細分成二段)
'                '2008/11/19改為五段(將A~L細分二段,P~Z細分二段)
'                '2009/2/12改為六段(S~Z分為S,T~Z)
'                '2012/2/29 modify by sonia 張靜芳要求E~L再E~J及K~L
'                '2012/10/31 modify by sonia 原M~O再細分為二段M~N及O
'                '2013/3/21 modify by sonia M~N再細分M,N
'                '2013/8/2  modify by sonia 配合外專承辦再改
'                '2014/2/26 modify by sonia 配合外專程序再改
'                '2015/3/23 modify by sonia 配合外專承辦將0117P~Z再細分0117P~R,0118S,0119T~Z
'                If Mid(m_tmpN, 1, 1) >= "A" And Mid(m_tmpN, 1, 1) <= "C" Then
'                     pub_NationByName = "011"
'                     m_msg1 = m_msg & "英文名稱第一碼介於 A~C 之間，" & m_msg & "國籍應該為 011 !"
'
'                ElseIf Mid(m_tmpN, 1, 1) >= "D" And Mid(m_tmpN, 1, 1) <= "G" Then
'                     pub_NationByName = "0111"
'                     m_msg1 = m_msg & "英文名稱第一碼介於 D~G 之間，" & m_msg & "國籍應該為 0111 !"
'
'                ElseIf Mid(m_tmpN, 1, 1) >= "H" And Mid(m_tmpN, 1, 1) <= "H" Then
'                     pub_NationByName = "0112"
'                     m_msg1 = m_msg & "英文名稱第一碼為 H，" & m_msg & "國籍應該為 0112 !"
'
'                ElseIf Mid(m_tmpN, 1, 1) >= "I" And Mid(m_tmpN, 1, 1) <= "L" Then
'                     pub_NationByName = "0113"
'                     m_msg1 = m_msg & "英文名稱第一碼介於 I~L 之間，" & m_msg & "國籍應該為 0113 !"
'
'                ElseIf Mid(m_tmpN, 1, 1) >= "M" And Mid(m_tmpN, 1, 1) <= "M" Then
'                     pub_NationByName = "0114"
'                     m_msg1 = m_msg & "英文名稱第一碼為 M，" & m_msg & "國籍應該為 0114 !"
'
'                ElseIf Mid(m_tmpN, 1, 1) >= "N" And Mid(m_tmpN, 1, 1) <= "N" Then
'                     pub_NationByName = "0115"
'                     m_msg1 = m_msg & "英文名稱第一碼為 N，" & m_msg & "國籍應該為 0115 !"
'
'                ElseIf Mid(m_tmpN, 1, 1) >= "O" And Mid(m_tmpN, 1, 1) <= "O" Then
'                     pub_NationByName = "0116"
'                     m_msg1 = m_msg & "英文名稱第一碼為 O ，" & m_msg & "國籍應該為 0116 !"
'
'                ElseIf Mid(m_tmpN, 1, 1) >= "P" And Mid(m_tmpN, 1, 1) <= "R" Then
'                     pub_NationByName = "0117"
'                     m_msg1 = m_msg & "英文名稱第一碼介於 P~R 之間，" & m_msg & "國籍應該為 0117 !"
'
'                ElseIf Mid(m_tmpN, 1, 1) >= "S" And Mid(m_tmpN, 1, 1) <= "S" Then
'                     pub_NationByName = "0118"
'                     m_msg1 = m_msg & "英文名稱第一碼為 S，" & m_msg & "國籍應該為 0118 !"
'
'                ElseIf Mid(m_tmpN, 1, 1) >= "T" And Mid(m_tmpN, 1, 1) <= "Z" Then
'                     pub_NationByName = "0119"
'                     m_msg1 = m_msg & "英文名稱第一碼介於 T~Z 之間，" & m_msg & "國籍應該為 0119 !"
'
'                Else
'                     pub_NationByName = "0119"
'                     m_msg1 = m_msg & "英文名稱第一碼非英文字母或無英文名稱，" & m_msg & "國籍應該為 0119 !"
'                End If
'                If IsChk = True And oOldNation <> pub_NationByName Then
'                    ShowMsg m_msg1
'                End If
'            'Added by Lydia 2016/03/14 +德國
'            Case "231"
'                If strSrvDate(1) < "20160315" Then '105.03.15變更
'                    pub_NationByName = oOldNation
'                    Exit Function
'                End If
'                If Mid(m_tmpN, 1, 1) >= "A" And Mid(m_tmpN, 1, 1) <= "E" Then
'                     pub_NationByName = "231"
'                     m_msg1 = m_msg & "英文名稱第一碼介於 A~E 之間，" & m_msg & "國籍應該為 231 !"
'
'                ElseIf Mid(m_tmpN, 1, 1) >= "F" And Mid(m_tmpN, 1, 1) <= "I" Then
'                     pub_NationByName = "2311"
'                     m_msg1 = m_msg & "英文名稱第一碼介於 F~I 之間，" & m_msg & "國籍應該為 2311 !"
'
'                ElseIf Mid(m_tmpN, 1, 1) >= "J" And Mid(m_tmpN, 1, 1) <= "N" Then
'                     pub_NationByName = "2312"
'                     m_msg1 = m_msg & "英文名稱第一碼介於 J~N 之間，" & m_msg & "國籍應該為 2312 !"
'
'                ElseIf Mid(m_tmpN, 1, 1) >= "O" And Mid(m_tmpN, 1, 1) <= "R" Then
'                     pub_NationByName = "2313"
'                     m_msg1 = m_msg & "英文名稱第一碼介於 O~R 之間，" & m_msg & "國籍應該為 2313 !"
'
'                ElseIf Mid(m_tmpN, 1, 1) >= "S" And Mid(m_tmpN, 1, 1) <= "S" Then
'                     pub_NationByName = "2314"
'                     m_msg1 = m_msg & "英文名稱第一碼為 S，" & m_msg & "國籍應該為 2314 !"
'
'                ElseIf Mid(m_tmpN, 1, 1) >= "T" And Mid(m_tmpN, 1, 1) <= "W" Then
'                     pub_NationByName = "2315"
'                     m_msg1 = m_msg & "英文名稱第一碼介於 T~W 之間，" & m_msg & "國籍應該為 2315 !"
'
'                ElseIf Mid(m_tmpN, 1, 1) >= "X" And Mid(m_tmpN, 1, 1) <= "Z" Then
'                     pub_NationByName = "2316"
'                     m_msg1 = m_msg & "英文名稱第一碼介於 X~Z 之間，" & m_msg & "國籍應該為 2316 !"
'
'                Else
'                     pub_NationByName = "2316"
'                     m_msg1 = m_msg & "英文名稱第一碼非英文字母或無英文名稱，" & m_msg & "國籍應該為 2316 !"
'                End If
'                If IsChk = True And oOldNation <> pub_NationByName Then
'                    ShowMsg m_msg1
'                End If
'            Case Else
'            End Select
'        Else
'            pub_NationByName = oOldNation
'        End If
'   End If
End Function

'Add by Morgan 2008/5/13
'設定幣別選單(可以代理人預設)
'Modify By Sindy 2021/7/16 改為用 Object 型態
'Public Sub PUB_Add2Combo(oCombo As ComboBox, Optional ByVal stFAgentNo As String)
Public Sub PUB_Add2Combo(oCombo As Object, Optional ByVal stFAgentNo As String)
Dim stSQL As String, intR As Integer
      
   stSQL = "select a1y01 from acc1y0 order by 1 asc"
   intR = 1
   Set AdoRecordSet3 = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      oCombo.Clear
      With AdoRecordSet3
      Do While .EOF = False
         oCombo.AddItem .Fields("a1y01").Value
         .MoveNext
      Loop
      End With
   End If
   
   If stFAgentNo <> "" Then
      stFAgentNo = ChangeCustomerL(stFAgentNo)
      
      'Add By Sindy 2012/6/5 改為先抓該代理人是否有設定帳單幣別,若有,則抓代理人的帳單幣別,若沒有才抓NA52
      stSQL = "select fa113 from fagent where fa01 = '" & Mid(stFAgentNo, 1, 8) & "' and fa02 = '" & Mid(stFAgentNo, 9, 1) & "'"
      intR = 1
      Set AdoRecordSet3 = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         If IsNull(AdoRecordSet3("fa113")) = False Then
            oCombo = AdoRecordSet3("fa113")
            Exit Sub
         End If
      End If
      '2012/6/5 End
      
      stSQL = "select na52 from fagent, nation where fa10 = na01 (+) and fa01 = '" & Mid(stFAgentNo, 1, 8) & "' and fa02 = '" & Mid(stFAgentNo, 9, 1) & "'"
      intR = 1
      Set AdoRecordSet3 = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         If IsNull(AdoRecordSet3("na52")) = False Then
            oCombo = AdoRecordSet3("na52")
         End If
      End If
   End If
End Sub

'Add by Morgan 2008/5/16
'查詢參考報價資料
'p_Sys:1=專利, 2=商標, 3=專利自動發證, 4=商標自動發證
'p_Year:繳費年度
'Modified by Lydia 2017/07/03 +系統別p_No01
Public Function PUB_GetOldPrice(Optional ByVal p_AppNo As String, Optional ByVal p_AppCountry As String, Optional ByVal p_AppKind As String, Optional ByVal p_Property As String, Optional ByRef p_adoRst As ADODB.Recordset, Optional ByVal p_ToDate As String, Optional ByVal p_Exception As String, Optional ByVal p_Sys As String = "1", Optional ByVal p_dblYear As Double, Optional ByVal p_No01 As String = "") As Boolean
   Dim stFromDate As String, stCon As String, stSQL As String, intR As Integer
   If p_ToDate = "" Then
      p_ToDate = strSrvDate(1)
   End If
   'Modify by Morgan 2008/6/4 改抓6個月內資料--杜副總
   'stFromDate = CompDate(1, -3, p_ToDate)
   stFromDate = CompDate(1, -6, p_ToDate)
   stCon = " and lc11>" & stFromDate & " and lc11<=" & p_ToDate
   '申請人
   If p_AppNo <> "" Then
     'Add by Lydia 2014/10/29
     ' If p_Sys = "1" Then
      If p_Sys = "1" Or p_Sys = "3" Then
         'Modified by Lydia 2017/07/03 CFP核駁報價只抓同一申請人的報價
         'Modified by Morgan 2019/3/29 條件改和下面一致否則CFP核准領證報價會有問題Ex:CFP-29129
         'If p_No01 = "CFP" Then
         If p_Sys = "1" And p_Property = "107" And p_No01 = "CFP" Then
            stCon = stCon & " and instr(pa26||pa27||pa28||pa29||pa30,'" & ChangeCustomerL(p_AppNo) & "')>0"
         Else
         'end 2017/07/03
            stCon = stCon & " and instr(pa26||pa27||pa28||pa29||pa30,'" & Left(p_AppNo, 6) & "')>0"
         End If 'end 2017/07/03
      'Modified by Morgan 2015/7/2
      'ElseIf p_Sys = "2" Then
      ElseIf p_Sys = "2" Or p_Sys = "4" Then
         stCon = stCon & " and instr(tm23||tm78||tm79||tm80||tm81,'" & Left(p_AppNo, 6) & "')>0"
      'Add By Sindy 2014/12/2
      Else
         stCon = stCon & " and instr(sp08||sp58||sp59||sp65||sp66,'" & Left(p_AppNo, 6) & "')>0"
      '2014/12/2 END
      End If
   End If
   '申請國
   If p_AppCountry <> "" Then
'      If p_Sys = "1" Then
      If p_Sys = "1" Or p_Sys = "3" Then
         stCon = stCon & " and pa09='" & p_AppCountry & "'"
      'Modified by Morgan 2015/7/2
      'ElseIf p_Sys = "2" Then
      ElseIf p_Sys = "2" Or p_Sys = "4" Then
         stCon = stCon & " and tm10='" & p_AppCountry & "'"
      'Add By Sindy 2014/12/2
      Else
         stCon = stCon & " and sp09='" & p_AppCountry & "'"
      '2014/12/2 END
      End If
   End If
   '專利種類
   If p_AppKind <> "" Then
      'If p_Sys = "1" Then
      If p_Sys = "1" Or p_Sys = "3" Then
         stCon = stCon & " and pa08='" & p_AppKind & "'"
      'Modified by Morgan 2015/7/2
      'ElseIf p_Sys = "2" Then
      ElseIf p_Sys = "2" Or p_Sys = "4" Then
         stCon = stCon & " and tm08='" & p_AppKind & "'"
      End If
   End If
   '案件性質
   'Modified by Lydia 2017/07/03 排除CFP核駁報價
   'If p_Property <> "" Then
   'Modified by Morgan 2019/3/29 條件改和下面一致否則CFP核准領證報價會有問題Ex:CFP-29129
   'If p_Property <> "" And p_No01 <> "CFP" Then
   If p_Property <> "" And Not (p_Sys = "1" And p_Property = "107" And p_No01 = "CFP") Then
       'Add by Lydia 2014/10/29 　LC02="0"＝＞為自動發證國家之證書號輸入(frm05010403_2)時產生，因為無下一程序所以預設LC02=NP22=0
      'If p_Sys <> "3" Then
      'Modified by Morgan 2015/7/2
      'If p_Sys = "3" Then
      '   stCon = stCon & " and CP10='1603'"
      If p_Sys = "3" Or p_Sys = "4" Then
         stCon = stCon & " and CP10='" & p_Property & "'"
      'end 2015/7/2
      ElseIf p_Sys = "1" Or p_Sys = "2" Then
         stCon = stCon & " and np07='" & p_Property & "'" '原
      'Add By Sindy 2014/12/2
      Else
         stCon = stCon & " and CP10='" & p_Property & "'"
      '2014/12/2 END
      End If
   End If
   
   '例外
   'Modified by Lydia 2017/07/03 CFP核駁報價的前半年報價歷史記錄
   If p_Sys = "1" And p_Property = "107" And p_No01 = "CFP" Then
      stCon = Replace(stCon, "lc11", "c1.cp05")
      '程序報價：抓半年內同一申請人、申請國家和專利種類的案件進度1002,1006的報價備註
      stSQL = "select sqldatet(c1.cp05) 報價日,c1.cp01||'-'||c1.cp02||decode(c1.cp03||c1.cp04,'000','','-'||c1.cp03||'-'||c1.cp04) 本所案號 " & _
              ",NVL(pa05,NVL(pa07,pa06)) 案件名稱,decode(pa09,'000',cpm03,cpm04) 案件性質,'程序報價:'||c1.cp144 as 報價 " & _
              "from caseprogress c1,patent,casepropertymap where c1.cp01='CFP' and c1.cp159=0 " & stCon & _
              " and c1.cp01=pa01(+) and c1.cp02=pa02(+) and c1.cp03=pa03(+) and c1.cp04=pa04(+) " & _
              "and c1.cp01=cpm01 and c1.cp10=cpm02 and c1.cp10 in ('1002','1006') and nvl(c1.cp144,'N') <> 'N' "
      '抓半年內同一申請人、申請國家和專利種類的答辯(107)-核駁、最終核駁(CP43=1002,1006)的費用和點數，用答辯107的cp16,cp17,cp18和Acc1u0(用收文號SUM加總)計算費用和點數；
        'CP17->CP17-SUM(A1U09)
        'CP18->CP18*1000-SUM(A1U07)
        'cp16 = cp17 + cp18
        '收文費用: cp16 (cp18) => 費用和點數
      stSQL = stSQL & "Union All " & _
              "select sqldatet(c1.cp05) 報價日,c1.cp01||'-'||c1.cp02||decode(c1.cp03||c1.cp04,'000','','-'||c1.cp03||'-'||c1.cp04) 本所案號 " & _
              ",NVL(pa05,NVL(pa07,pa06)) 案件名稱,decode(pa09,'000',cpm03,cpm04) 案件性質 " & _
              ",'收文費用:'||to_char(c1.cp17-nvl(a1u09,0)+(c1.cp18*1000)-nvl(a1u07,0),'FM999,999,999')||'('||(((c1.cp18*1000)-nvl(a1u07,0))/1000)||')' as 報價 " & _
              "from caseprogress c1,patent,casepropertymap,caseprogress c2,(select a1u03,sum(a1u07) a1u07,sum(a1u09) a1u09 from acc1u0 group by a1u03) X1 " & _
              "where c1.cp01='CFP' and c1.cp159=0 " & stCon & _
              " and c1.cp10='107' and c1.cp16 > 0 and c1.cp01=pa01(+) and c1.cp02=pa02(+) and c1.cp03=pa03(+) and c1.cp04=pa04(+) " & _
              "and c1.cp01=cpm01 and c1.cp10=cpm02 and c1.cp43=c2.cp09(+) and c2.cp10 in ('1002','1006') and c1.cp09=a1u03(+) " & _
              "order by 1"
   Else
   'end 2017/07/03
       If p_Exception <> "" Then
          stCon = stCon & " and lc01||lc02<>'" & p_Exception & "'"
       End If
       
       If p_dblYear > 0 Then
          stCon = stCon & " and lc15=" & p_dblYear
       End If
       
       'Add by Lydia 2014/10/29 　LC02="0"＝＞為自動發證國家之證書號輸入(frm05010403_2)時產生，因為無下一程序所以預設LC02=NP22=0
       If p_Sys = "3" Then
          stSQL = " select sqldatet(lc11) 報價日,cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) 本所案號," & _
                  " NVL(pa05,NVL(pa07,pa06)) 案件名稱,nvl(a.lcv07,a.lcv03) 項目,lc15 年度," & _
                  " nvl(a.lcv06,a.lcv04)||decode(b.lcv01,null,'','('||nvl(b.lcv06,b.lcv04)||')') 報價 " & _
                  " from lettercache,caseprogress,patent,lettercachevar a,lettercachevar b " & _
                  " Where cp09(+)=lc01 and lc02='0' and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04 " & _
                  " and a.lcv01(+)=lc01 and a.lcv02(+)=lc02 and a.lcv05='Y' and instr(a.lcv03,'註冊費')=0 and b.lcv01(+)=a.lcv01 " & _
                  " and b.lcv02(+)=a.lcv02 and b.lcv03(+)=a.LCV03||'點數' " & stCon & _
                  " order by 1 desc,2,3,4 "
    
       'Added by Morgan 2015/7/2
       '商標動發證
       ElseIf p_Sys = "4" Then
          stSQL = " select sqldatet(lc11) 報價日,cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) 本所案號" & _
                  ",nvl(tm05,nvl(tm07,tm06)) 案件名稱,nvl(a.lcv07,a.lcv03) 項目,lc15 年度" & _
                  ",nvl(a.lcv06,a.lcv04)||decode(b.lcv01,null,'','('||nvl(b.lcv06,b.lcv04)||')') 報價 " & _
                  " from lettercache,caseprogress,trademark,lettercachevar a,lettercachevar b " & _
                  " Where cp09(+)=lc01 and lc02='0' and tm01(+)=cp01 and tm02(+)=cp02 and tm03(+)=cp03 and tm04(+)=cp04 " & _
                  " and a.lcv01(+)=lc01 and a.lcv02(+)=lc02 and a.lcv05='Y' and instr(a.lcv03,'註冊費')=0 and b.lcv01(+)=a.lcv01 " & _
                  " and b.lcv02(+)=a.lcv02 and b.lcv03(+)=a.LCV03||'點數' " & stCon & _
                  " order by 1 desc,2,3,4 "
       'end 2015/7/2
       '專利
       ElseIf p_Sys = "1" Then
          'EPC的指定國註冊費除外
          'Modified by Morgan 2021//7/30
          stSQL = "select sqldatet(lc11) 報價日,np02||'-'||np03||decode(np04||np05,'000','','-'||np04||'-'||np05) 本所案號" & _
             ",NVL(pa05,NVL(pa07,pa06)) 案件名稱,nvl(a.lcv07,a.lcv03) 項目,lc15 年度" & _
             ",nvl(a.lcv06,a.lcv04)||decode(b.lcv01,null,'','('||nvl(b.lcv06,b.lcv04)||')') 報價,cp64 備註" & _
             " from lettercache,nextprogress,patent,lettercachevar a,lettercachevar b,caseprogress" & _
             " Where np01(+)=lc01 and np22(+)=lc02 and cp09(+)=lc01" & _
             " and pa01(+)=np02 and pa02(+)=np03 and pa03(+)=np04 and pa04(+)=np05" & _
             " and a.lcv01(+)=lc01 and a.lcv02(+)=lc02 and a.lcv05='Y' and instr(a.lcv03,'註冊費')=0" & _
             " and b.lcv01(+)=a.lcv01 and b.lcv02(+)=a.lcv02 and b.lcv03(+)=a.LCV03||'點數'" & stCon & _
             " order by 1 desc,2,3,4"
       '商標
       ElseIf p_Sys = "2" Then
          stSQL = "select sqldatet(lc11) 報價日,np02||'-'||np03||decode(np04||np05,'000','','-'||np04||'-'||np05) 本所案號" & _
             ",nvl(tm05,nvl(tm07,tm06)) 案件名稱,nvl(a.lcv07,a.lcv03) 項目,lc15 年度" & _
             ",nvl(a.lcv06,a.lcv04) ||decode(b.lcv01,null,'','('||nvl(b.lcv06,b.lcv04)||')') 報價" & _
             " from lettercache,nextprogress,trademark,lettercachevar a,lettercachevar b" & _
             " Where np01(+)=lc01 and np22(+)=lc02" & _
             " and tm01(+)=np02 and tm02(+)=np03 and tm03(+)=np04 and tm04(+)=np05" & _
             " and a.lcv01(+)=lc01 and a.lcv02(+)=lc02 and a.lcv05='Y' and instr(a.lcv03,'註冊費')=0" & _
             " and b.lcv01(+)=a.lcv01 and b.lcv02(+)=a.lcv02 and b.lcv03(+)=a.LCV03||'點數'" & stCon & _
             " order by 1 desc,2,3,4"
       'Add By Sindy 2014/12/2
       Else
          stSQL = "select sqldatet(lc11) 報價日,cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) 本所案號" & _
             ",nvl(sp05,nvl(sp07,sp06)) 案件名稱,nvl(a.lcv07,a.lcv03) 項目,lc15 年度" & _
             ",nvl(a.lcv06,a.lcv04) ||decode(b.lcv01,null,'','('||nvl(b.lcv06,b.lcv04)||')') 報價" & _
             " from lettercache,caseprogress,servicepractice,lettercachevar a,lettercachevar b" & _
             " Where cp09(+)=lc01 and lc02='0'" & _
             " and sp01(+)=cp01 and sp02(+)=cp02 and sp03(+)=cp03 and sp04(+)=cp04" & _
             " and a.lcv01(+)=lc01 and a.lcv02(+)=lc02 and a.lcv05='Y' and instr(a.lcv03,'註冊費')=0" & _
             " and b.lcv01(+)=a.lcv01 and b.lcv02(+)=a.lcv02 and b.lcv03(+)=a.LCV03||'點數'" & stCon & _
             " order by 1 desc,2,3,4"
       '2014/12/2 END
       End If
   End If 'end 2017/07/03
   
   intR = 1
   Set p_adoRst = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      PUB_GetOldPrice = True
   End If
End Function

'Add by Morgan 2008/5/20
'設定Label為可點選
Public Sub PUB_LabelActive(ByRef olblFront As LABEL, ByRef olblBack As LABEL, Optional bolOn As Boolean = True)
   If bolOn = True Then
      olblFront.Tag = "Y"
      olblFront.BackColor = &HC0FFC0
      olblBack.Height = olblFront.Height
      olblBack.Width = olblFront.Width
      olblBack.Left = olblFront.Left + 50
      olblBack.Top = olblFront.Top + 60
      olblBack.BackColor = &H80000010
      olblBack.Visible = True
   Else
      olblFront.Tag = ""
      olblFront.BackColor = &H8000000F
      olblBack.Visible = False
   End If
End Sub
'Add by Morgan 2008/5/20
Public Sub PUB_LabelMouseDown(ByRef olblFront As LABEL, ByRef olblBack As LABEL)
   If olblFront.Tag = "Y" Then
      olblFront.Left = olblBack.Left
      olblFront.Top = olblBack.Top
   End If
End Sub
'Add by Morgan 2008/5/20
Public Sub PUB_LabelMouseUp(ByRef olblFront As LABEL, ByRef olblBack As LABEL)
   If olblFront.Tag = "Y" Then
      olblFront.Left = olblBack.Left - 50
      olblFront.Top = olblBack.Top - 60
   End If
End Sub
'Add by Morgan 2008/5/21 從ClsPrtForm001抽出來共用
'讀取相關案件虛擬表格語法
Public Function PUB_GetRelCaseVTB(ByRef p_CaseNo() As String) As String
   Dim stVTable As String
'Modify by Morgan 2009/5/14 改與共同查詢的專利相關他國案一致(Call Store Procedure)
'   '多國案
'   stVTable = " select CR05 X01,CR06 X02,CR07 X03,CR08 X04 from caserelation" & _
'      " where CR01='" & p_CaseNo(1) & "' AND CR02='" & p_CaseNo(2) & "' AND CR03='" & p_CaseNo(3) & "' AND CR04='" & p_CaseNo(4) & "'" & _
'      " Union select CR01,CR02,CR03,CR04 from caserelation" & _
'      " where CR05='" & p_CaseNo(1) & "' AND CR06='" & p_CaseNo(2) & "' AND CR07='" & p_CaseNo(3) & "' AND CR08='" & p_CaseNo(4) & "'"
'   'Add by Morgan 2007/9/20 加國內外案
'   '國內案
'   stVTable = stVTable & " UNION SELECT CM05,CM06,CM07,CM08 FROM CASEMAP" & _
'      " WHERE CM01='" & p_CaseNo(1) & "' AND CM02='" & p_CaseNo(2) & "' AND CM03='" & p_CaseNo(3) & "' AND CM04='" & p_CaseNo(4) & "'"
'   '國內案的其他國外案
'   stVTable = stVTable & " UNION SELECT CM01,CM02,CM03,CM04 FROM CASEMAP WHERE (CM05,CM06,CM07,CM08) IN" & _
'      "(SELECT CM05,CM06,CM07,CM08 FROM CASEMAP" & _
'      " WHERE CM01='" & p_CaseNo(1) & "' AND CM02='" & p_CaseNo(2) & "' AND CM03='" & p_CaseNo(3) & "' AND CM04='" & p_CaseNo(4) & "')"
'
'   'Add by Morgan 2009/4/23
'   '國內案的其他國外案的國外案 P-86780
'   stVTable = stVTable & " UNION SELECT CM01,CM02,CM03,CM04 FROM CASEMAP WHERE (CM05,CM06,CM07,CM08) IN" & _
'      "(SELECT CM01,CM02,CM03,CM04 FROM CASEMAP WHERE (CM05,CM06,CM07,CM08) IN" & _
'      "(SELECT CM05,CM06,CM07,CM08 FROM CASEMAP" & _
'      " WHERE CM01='" & p_CaseNo(1) & "' AND CM02='" & p_CaseNo(2) & "' AND CM03='" & p_CaseNo(3) & "' AND CM04='" & p_CaseNo(4) & "'))"
'
'   '國外案
'   stVTable = stVTable & " UNION SELECT CM01,CM02,CM03,CM04 FROM CASEMAP" & _
'      " WHERE CM05='" & p_CaseNo(1) & "' AND CM06='" & p_CaseNo(2) & "' AND CM07='" & p_CaseNo(3) & "' AND CM08='" & p_CaseNo(4) & "'"
'   '國外案的其他國外案
'   stVTable = stVTable & " UNION SELECT CM01,CM02,CM03,CM04 FROM CASEMAP WHERE (CM05,CM06,CM07,CM08) IN" & _
'      "(SELECT CM01,CM02,CM03,CM04 FROM CASEMAP" & _
'      " WHERE CM05='" & p_CaseNo(1) & "' AND CM06='" & p_CaseNo(2) & "' AND CM07='" & p_CaseNo(3) & "' AND CM08='" & p_CaseNo(4) & "')"
   cnnConnection.Execute "delete from r100101_h where id='" & strUserNum & "' "
   cnnConnection.Execute "insert into r100101_h select '" & p_CaseNo(1) & "','" & p_CaseNo(2) & "','" & p_CaseNo(3) & "','" & p_CaseNo(4) & "',0,'1','" & strUserNum & "' from dual "
   cnnConnection.Execute "begin   db_r100101_h('" & strUserNum & "'); end;"
   stVTable = "select distinct r001001 X01,r001002 X02,r001003 X03,r001004 X04 from r100101_h" & _
      " where id='" & strUserNum & "' and not (r001001='" & p_CaseNo(1) & "' and r001002='" & p_CaseNo(2) & "' and r001003='" & p_CaseNo(3) & "' and r001004='" & p_CaseNo(4) & "')"
'end 2009/5/14
   PUB_GetRelCaseVTB = stVTable
End Function

'Add by Morgan 2008/6/9
'帳單備註提醒
Public Sub PUB_CheckCaseBillMemo(PA1234 As String)
   Dim stSQL As String, adoRst As ADODB.Recordset, intR As Integer
On Error GoTo ErrHnd

   stSQL = "select pa148 from patent where " & ChgPatent(PA1234) & " and pa147 is null and pa148 is not null"
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      If MsgBox("" & adoRst(0) & vbCrLf & vbCrLf & "下次是否要再提醒？", vbYesNo, "帳單備註提醒(" & PA1234 & ")") = vbNo Then
         stSQL = "update patent set pa147='N' where " & ChgPatent(PA1234)
         Pub_SeekTbLog stSQL
         adoTaie.Execute stSQL, intR
      End If
   End If
   Exit Sub
   
ErrHnd:
   MsgBox Err.Description, vbCritical
End Sub

'Add by Morgan 2008/6/11
'代理人D/N備註提醒
'Add By Sindy 2011/3/3 + strSysType
Public Function PUB_CheckDNMemo(p_FagentNo As String, Optional bolAsk As Boolean, Optional strSysType As String = "") As Boolean
   Dim stSQL As String, adoRst As ADODB.Recordset, intR As Integer
On Error GoTo ErrHnd
   
   'Modify By Sindy 2011/3/3
   If CheckSys(strSysType) = "2" Or CheckSys(strSysType) = "6" Then
      stSQL = "select fa110 from fagent where " & ChgFagent(p_FagentNo) & " and fa110 is not null"
      stSQL = stSQL & " union all select cu150 from customer where " & ChgCustomer(p_FagentNo) & " and cu150 is not null" 'Added by Morgan 2015/4/17
      
   '2011/3/3 End
   Else
      stSQL = "select fa45 from fagent where " & ChgFagent(p_FagentNo) & " and fa45 is not null"
      'Added by Morgan 2015/4/17
      'Modified by Morgan 2019/7/16 欄位更正
      stSQL = stSQL & " union all select cu78 from customer where " & ChgCustomer(p_FagentNo) & " and cu78 is not null"
   End If
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      'Modified by Morgan 2015/4/17
      'Modified by Morgan 2020/12/8 adoRst(0).Name-->LCase(adoRst(0).Name), O12欄位名稱都為大寫
      If bolAsk Then
         If MsgBox(adoRst(0) & vbCrLf & vbCrLf & "是否仍要列印？", vbYesNo + vbDefaultButton2, IIf(LCase(adoRst(0).Name) = "fa110", "商標", "專利") & "D/N備註提醒(" & p_FagentNo & ")") = vbYes Then
            PUB_CheckDNMemo = True
         End If
      Else
         MsgBox adoRst(0), , IIf(LCase(adoRst(0).Name) = "fa110", "商標", "專利") & "D/N備註提醒(" & p_FagentNo & ")"
         PUB_CheckDNMemo = True
      End If
      'end 2015/4/17
   Else
      PUB_CheckDNMemo = True
   End If
   Exit Function
   
ErrHnd:
   MsgBox Err.Description, vbCritical
End Function

'Add by Morgan 2008/6/20
'去掉字串裡的跳行符號
Public Function PUB_StringFilter(ByVal p_Str As String) As String
   'Add by Amy 2014/09/11 +Word 會出現的換行(向下箭頭符號)
   p_Str = Replace(p_Str, Chr(11), "")
   p_Str = Replace(p_Str, Chr(10), "")
   p_Str = Replace(p_Str, Chr(13), "")
   PUB_StringFilter = p_Str
End Function
'Add by Morgan 2008/6/20
'修正畫面所有含跳行符號的文字框.name
'Modify By Sindy 2014/12/27 +strNotFilterText:不過濾的文字框
Public Sub PUB_FilterFormText(ByRef oForm As Form, Optional strNotFilterText As String = "")
   Dim oObj As Object
   Dim varTemp As Variant, bolNotFilter As Boolean, ii As Integer 'Add By Sindy 2014/12/27
   Dim strFieldN As String, intIdx As Integer 'Add by Amy 2015/01/15 文字框陣列名稱/Index
   
On Error GoTo HndErr 'Add By Sindy 2015/3/19
   
   varTemp = Split(strNotFilterText, ",") 'Add By Sindy 2014/12/27
   For Each oObj In oForm.Controls
      If TypeName(oObj) = "TextBox" Then
         If oObj.Text <> "" And oObj.Locked = False And oObj.Enabled = True Then
            'Modify By Sindy 2014/12/27
            'oObj.Text = PUB_StringFilter(oObj.Text)
            '比對是否為不過濾的文字框
            bolNotFilter = False
            If strNotFilterText <> "" Then
               For ii = 0 To UBound(varTemp)
                  'Modify by Amy 2015/01/15 文字框為陣列
                  'Modify by Amy 2016/04/07 傳入的TextBox 沒index會錯
                  If UCase(oObj.Name) = UCase(varTemp(ii)) Then
                        bolNotFilter = True
                        Exit For
                  'Modify by Amy 2024/11/15 bug-寫法有問題調整,傳入為陣列的元件不會有()
'                  ElseIf InStr(oObj.Name, "(") > 0 And InStr(oObj.Name, ")") > 0 Then
'                     If InStr(varTemp(ii), "(") > 0 And InStr(varTemp(ii), ")") > 0 Then
'                        strFieldN = Mid(varTemp(ii), 1, InStr(varTemp(ii), "(") - 1)
'                        intIdx = Val(Mid(varTemp(ii), InStr(varTemp(ii), "(") + 1, InStr(varTemp(ii), ")") - 1))
'                        If UCase(oObj.Name) = UCase(strFieldN) And oObj.Index = intIdx Then
'                            bolNotFilter = True
'                            Exit For
'                        End If
'                     End If
                  ElseIf InStr(varTemp(ii), "(") > 0 And InStr(varTemp(ii), ")") > 0 Then
                     strFieldN = Mid(varTemp(ii), 1, InStr(varTemp(ii), "(") - 1)
                     intIdx = Val(Mid(varTemp(ii), InStr(varTemp(ii), "(") + 1, InStr(varTemp(ii), ")") - 1))
                     If UCase(oObj.Name) = UCase(strFieldN) Then
                        If oObj.Index = intIdx Then
                            bolNotFilter = True
                            Exit For
                        End If
                     End If
                  'end 2024/11/15
                  End If
                  'end 2016/04/07
                  'end 2015/01/15
ReadNext: 'Add By Sindy 2015/3/19
               Next ii
            End If
            If bolNotFilter = False Then
               oObj.Text = PUB_StringFilter(oObj.Text)
            End If
            '2014/12/27 END
         End If
      End If
   Next
   
'Add By Sindy 2015/3/19
   Exit Sub
HndErr:
   If Err.Number = 343 Then
      GoTo ReadNext
   End If
'2015/3/19 END
End Sub

'Add by Morgan 2008/7/30
'設定聯絡人選單
'Modified by Lydia 2021/04/28 改成Form 2.0可用
'Public Sub PUB_AddContact(ByVal p_stNo As String, p_Combo As ComboBox, Optional p_Default As String, Optional p_Auto As Boolean = False)
Public Sub PUB_AddContact(ByVal p_stNo As String, p_Combo As Object, Optional p_Default As String, Optional p_Auto As Boolean = False, _
                                        Optional ByVal bForm2 As Boolean = False, Optional ByRef p_ItemDataList As String)
   Dim stSQL As String, adoRst As ADODB.Recordset, intR As Integer
   Dim stCU01 As String, stCU02 As String
   Dim tmpArr As Variant 'Added by Lydia 2021/04/28
   
   p_stNo = Left(p_stNo & "000", 9)
   stCU01 = Left(p_stNo, 8)
   stCU02 = Mid(p_stNo, 9)
   p_Combo.Clear
   p_ItemDataList = "" 'Added by Lydia 2021/04/28
   stSQL = "select pcc02,pcc05,cu127 from customer,potcustcont where cu01='" & stCU01 & "' and cu02 ='" & stCU02 & "' and pcc01=cu01 order by pcc02 desc"
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      With adoRst
      .MoveFirst
      If p_Default = "" And p_Auto = True Then p_Default = "" & .Fields("cu127")
      Do While Not .EOF
         If Not IsNull(.Fields("pcc05")) Then
            p_Combo.AddItem .Fields("pcc05"), 0
            'Added by Lydia 2021/04/28 Form 2.0 沒有ItemData
            If bForm2 = True Then
               p_ItemDataList = Val(.Fields("pcc02")) & IIf(p_ItemDataList <> "", ",", "") & p_ItemDataList
            Else
            'end 2021/04/28
                p_Combo.ItemData(0) = Val(.Fields("pcc02"))
            End If 'Added by Lydia 2021/04/28
         End If
         .MoveNext
      Loop
      End With
   End If
   p_Combo.AddItem "", 0
   'Added by Lydia 2021/04/28 Form 2.0 沒有ItemData
   If bForm2 = True Then
       p_ItemDataList = "0," & p_ItemDataList  '增加空白項
       tmpArr = Split(p_ItemDataList, ",")
   End If
   'end 2021/04/28
   If Val(p_Default) > 0 Then
      For intR = 0 To p_Combo.ListCount - 1
         'Added by Lydia 2021/04/28 Form 2.0 沒有ItemData
         If bForm2 = True Then
            If Trim(tmpArr(intR)) <> "0" And Val(tmpArr(intR)) = Val(p_Default) Then
               'Modified by Lydia 2021/12/17 debug:應該放List的Index ; ex.X1583316預設聯絡人17在Index=9
               'p_Combo.ListIndex = Val(tmpArr(intR))
               p_Combo.ListIndex = intR
               Exit For
            End If
         Else
         'end 2021/04/28
            If p_Combo.ItemData(intR) = Val(p_Default) Then
               p_Combo.ListIndex = intR
               Exit For
            End If
         End If 'Added by Lydia 2021/04/28
      Next
   End If
   If p_Combo.ListIndex = -1 Then
      p_Combo.ListIndex = 0
   End If
End Sub

'Add by Morgan 2008/8/4
'讀取接洽人名稱
Public Function PUB_GetContact(ByVal strCustomerNo As String, Optional ByRef strContactNo As String, Optional p_Auto As Boolean = False) As String
   Dim adoRst As ADODB.Recordset, stSQL As String, intR As Integer
   If strCustomerNo <> "" Then
      
      If strContactNo = "" And p_Auto = False Then Exit Function
      
      strCustomerNo = Left(strCustomerNo & "000", 9)
      stSQL = "select pcc05,cu127 from customer,potcustcont" & _
         " where cu01='" & Left(strCustomerNo, 8) & "' and cu02='" & Mid(strCustomerNo, 9) & "' and pcc01(+)=cu01"
      If strContactNo = "" Then
         stSQL = stSQL & " and pcc02(+)=cu127"
      Else
         strContactNo = Format(strContactNo, "00")
         stSQL = stSQL & " and pcc02='" & strContactNo & "'"
      End If
      intR = 1
      Set adoRst = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         PUB_GetContact = "" & adoRst.Fields(0)
         If strContactNo = "" Then
            strContactNo = "" & adoRst.Fields(1)
         End If
      End If
   End If
End Function
'Add by Morgan 2008/8/7
'讀取地址相關欄位
'Modified by Morgan 2008/9/16 +p_Enforced:強制讀取聯絡地址及接洽人資料
'Modified by Morgan 2020/10/16 +p_CustOldName:客戶舊名稱
'Modified by Morgan 2021/10/12 ByVal p_CustNo -> ByRef p_CustNo
'Modified by Morgan 2023/7/5 +p_Lang:指定定稿語文
Public Function PUB_GetAddrRef(Optional ByRef p_CustNo As String, Optional p_CaseNo1 As String, Optional p_CaseNo2 As String, Optional p_CaseNo3 As String, Optional p_CaseNo4 As String, Optional p_CustName As String, Optional p_Contact As String, Optional p_ZipCode As String, Optional p_Address As String, Optional p_MagazineOnly As Boolean, Optional p_ContactNo As String, Optional p_Enforced As Boolean, Optional ByRef p_CustOldName As String, Optional ByVal p_Lang As String) As Boolean
   Dim stSQL As String, intR As Integer, iSys As Integer, adoRst As ADODB.Recordset
   Dim CU80 As String, CU87 As String, CU64 As String
   Dim stCustNo As String 'Added by Morgan 2021/10/12
   
   p_CustName = ""
   p_ZipCode = ""
   p_Address = ""
   p_Contact = ""
      
   If p_CustNo = "" And p_CaseNo1 = "" Then Exit Function
   
   stCustNo = p_CustNo 'Added by Morgan 2021/10/12 以下程式 p_CustNo 改為stCustNo
   
   '有本所案號
   If p_CaseNo1 <> "" Then
      iSys = CheckSys(p_CaseNo1)
      p_CaseNo3 = Right("0" & p_CaseNo3, 1)
      p_CaseNo4 = Right("00" & p_CaseNo4, 2)
      Select Case iSys
         Case 1 '專利
            stSQL = "select pa26,pa149 from patent where pa01='" & p_CaseNo1 & "' and pa02='" & p_CaseNo2 & "' and pa03='" & p_CaseNo3 & "' and pa04='" & p_CaseNo4 & "'"
         Case 2 '商標
            stSQL = "select tm23,tm123 from trademark where tm01='" & p_CaseNo1 & "' and tm02='" & p_CaseNo2 & "' and tm03='" & p_CaseNo3 & "' and tm04='" & p_CaseNo4 & "'"
         Case 3 '法務
            stSQL = "select lc11,lc42 from lawcase where lc01='" & p_CaseNo1 & "' and lc02='" & p_CaseNo2 & "' and lc03='" & p_CaseNo3 & "' and lc04='" & p_CaseNo4 & "'"
         Case 4 '顧問
            stSQL = "select hc05,hc23 from hirecase where hc01='" & p_CaseNo1 & "' and hc02='" & p_CaseNo2 & "' and hc03='" & p_CaseNo3 & "' and hc04='" & p_CaseNo4 & "'"
         Case Else '服務
            stSQL = "select sp08,sp78 from servicepractice where sp01='" & p_CaseNo1 & "' and sp02='" & p_CaseNo2 & "' and sp03='" & p_CaseNo3 & "' and sp04='" & p_CaseNo4 & "'"
      End Select
      intR = 1
      Set adoRst = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         stCustNo = "" & adoRst.Fields(0)
         p_ContactNo = "" & adoRst.Fields(1)
      End If
   End If
   stCustNo = Left(stCustNo & "000", 9)
   
   'Modified by Morgan 2020/10/16 改固定抓更名後的資料,並可回傳舊名稱
   If Right(stCustNo, 1) <> "0" Then
      stSQL = "select * from customer where cu01='" & Left(stCustNo, 8) & "' and cu02='" & Mid(stCustNo, 9) & "'"
      intR = 1
      Set adoRst = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         With adoRst
         '客戶舊名稱
         If Not IsNull(.Fields("CU104")) Then
            p_CustOldName = .Fields("CU104")
         ElseIf Not IsNull(.Fields("CU04")) Then
            p_CustOldName = .Fields("CU04")
         Else
            p_CustOldName = Trim("" & .Fields("CU05") & " " & .Fields("CU88") & " " & .Fields("CU89") & " " & .Fields("CU90"))
         End If
         End With
      End If
      stCustNo = Left(stCustNo & "000", 8) & "0"
   End If
   'end 2020/10/16
   
   If p_ContactNo <> "" Then
      stSQL = "select * from customer,potcustcont where cu01='" & Left(stCustNo, 8) & "' and cu02='" & Mid(stCustNo, 9) & "' and pcc01(+)=cu01 and pcc02(+)='" & p_ContactNo & "'"
   Else
      stSQL = "select * from customer,potcustcont where cu01='" & Left(stCustNo, 8) & "' and cu02='" & Mid(stCustNo, 9) & "' and pcc01(+)=cu01 and pcc02(+)=cu127"
   End If
   If p_MagazineOnly = True Then
      stSQL = stSQL & " AND CU32 IS NULL"
   End If
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      With adoRst
      CU80 = "" & .Fields("cu80")
      CU87 = Left("" & .Fields("cu87"), 3)
      CU64 = "" & .Fields("cu64")
      If p_Lang <> "" Then CU64 = p_Lang 'Added by Morgan 2023/7/5
      
      '客戶名稱
      If Not IsNull(.Fields("CU104")) Then
         p_CustName = .Fields("CU104")
      ElseIf Not IsNull(.Fields("CU04")) Then
         p_CustName = .Fields("CU04")
      Else
         p_CustName = Trim("" & .Fields("CU05") & " " & .Fields("CU88") & " " & .Fields("CU89") & " " & .Fields("CU90"))
      End If
            
      '有客戶狀態或定稿語文為中文且非台灣、香港、大陸、澳門時不印地址
      'Modified by Morgan 2022/1/10 +客戶狀態為「解除對造」者視為無狀態，也要印出地址(Ex:X85419000)--秀玲
      'Modified by Morgan 2022/4/6 +客戶狀態為「國內同業」者視為無狀態，也要印出地址(Ex:X85663000)--秀玲
      If p_Enforced = False And ((CU80 <> "解除對造" And CU80 <> "國內同業" And CU80 <> "") Or (CU64 = "1" And CU87 > "009" And CU87 <> "013" And CU87 <> "020" And CU87 <> "044")) Then
         p_ZipCode = ""
         p_Address = ""
         'Modified by Morgan 2012/2/7 改回傳全形空白個人或公司的判斷才會正確
         'p_Contact = ""
         'Modified by Morgan 2022/9/23 接洽人都要顯示
         'p_Contact = " 　　　　"
         p_Contact = "" & .Fields("PCC05")
         'end 2022/9/23
      '接洽人有聯絡地址
      ElseIf Not IsNull(.Fields("PCC22")) Then
         p_Address = Trim(.Fields("PCC22"))
         p_ZipCode = "" & .Fields("PCC21")
         p_Contact = "" & .Fields("PCC05")
      Else
         '郵遞區號
         p_ZipCode = "" & .Fields("CU30")
         '客戶聯絡地址
         p_Address = Trim("" & .Fields("CU31"))
         If p_Address = "" Then
            '客戶中文地址
            p_Address = Trim("" & .Fields("CU23"))
         End If
         '接洽人
         p_Contact = "" & .Fields("PCC05")
      End If
      
      End With
      
      If p_CustNo = "" Then p_CustNo = stCustNo 'Added by Morgan 2021/10/12
      PUB_GetAddrRef = True
   End If
   Set adoRst = Nothing
End Function
'Add by Morgan 2008/8/27
'申請人的稱謂
Public Function PUB_GetAppTitle(Optional ByVal p_CustNo As String, Optional p_CaseNo1 As String, Optional p_CaseNo2 As String, Optional p_CaseNo3 As String, Optional p_CaseNo4 As String) As String
   Dim stSQL As String, intR As Integer, iSys As Integer, adoRst As ADODB.Recordset
   If p_CaseNo1 <> "" Then
      iSys = CheckSys(p_CaseNo1)
      Select Case iSys
         Case 1 '專利
            stSQL = "select cu11 from patent,customer where pa01='" & p_CaseNo1 & "' and pa02='" & p_CaseNo2 & "' and pa03='" & p_CaseNo3 & "' and pa04='" & p_CaseNo4 & "' and cu01(+)=substr(pa26,1,8) and cu02(+)=substr(pa26,9) and cu15='0'"
         Case 2 '商標
            stSQL = "select cu11 from trademark,customer where tm01='" & p_CaseNo1 & "' and tm02='" & p_CaseNo2 & "' and tm03='" & p_CaseNo3 & "' and tm04='" & p_CaseNo4 & "' and cu01(+)=substr(tm23,1,8) and cu02(+)=substr(tm23,9) and cu15='0'"
         Case 3 '法務
            stSQL = "select cu11 from lawcase,customer where lc01='" & p_CaseNo1 & "' and lc02='" & p_CaseNo2 & "' and lc03='" & p_CaseNo3 & "' and lc04='" & p_CaseNo4 & "' and cu01(+)=substr(lc11,1,8) and cu02(+)=substr(lc11,9) and cu15='0'"
         Case 4 '顧問
            stSQL = "select cu11 from hirecase,customer where hc01='" & p_CaseNo1 & "' and hc02='" & p_CaseNo2 & "' and hc03='" & p_CaseNo3 & "' and hc04='" & p_CaseNo4 & "' and cu01(+)=substr(hc05,1,8) and cu02(+)=substr(hc05,9) and cu15='0'"
         Case Else '服務
            stSQL = "select cu11 from servicepractice,customer where sp01='" & p_CaseNo1 & "' and sp02='" & p_CaseNo2 & "' and sp03='" & p_CaseNo3 & "' and sp04='" & p_CaseNo4 & "' and cu01(+)=substr(sp08,1,8) and cu02(+)=substr(sp08,9) and cu15='0'"
      End Select
   ElseIf p_CustNo <> "" Then
      p_CustNo = Left(p_CustNo & "000", 9)
      stSQL = "select cu11 from customer where cu01='" & Left(p_CustNo, 8) & "' and cu02='" & Mid(p_CustNo, 9) & "' and cu15='0'"
   Else
      Exit Function
   End If
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      If Not IsNull(adoRst(0)) Then
         If Mid(adoRst(0), 2, 1) = "1" Then
            PUB_GetAppTitle = "先生"
         ElseIf Mid(adoRst(0), 2, 1) = "2" Then
            PUB_GetAppTitle = "女士"
         End If
      End If
   End If
   Set adoRst = Nothing
End Function
'20081008 Modify by Toni加判斷79075FC代理人<>Null
'20080904 add by Toni
'P案客戶智權人員為79075郭雅娟者,改用大-->台定稿
Public Function PUB_CheckCuNation(cu As String, strPA01 As String, strPA02 As String, strPA03 As String, strPA04 As String, Optional ByRef salesNo As String) As String
Dim salesArea As String
Dim adoRecordset As New ADODB.Recordset
Dim strSql As String

   PUB_CheckCuNation = "": salesArea = "": salesNo = ""
   
   strSql = "SELECT PA75 FROM  PATENT" & _
      " WHERE PA01='" & strPA01 & "' and  PA02='" & strPA02 & "'  and PA03='" & strPA03 & "'  and PA04='" & strPA04 & "'"

   If adoRecordset.State = adStateOpen Then adoRecordset.Close
   adoRecordset.CursorLocation = adUseClient
   adoRecordset.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If adoRecordset.RecordCount > 0 Then
      If cu <> "" Then
         salesArea = GetCuSales(cu, salesNo)
         If (salesNo = "79075" And Not IsNull(adoRecordset.Fields("PA75"))) Or salesNo = "96031" Or salesNo = "96032" Then
            PUB_CheckCuNation = "1"
         End If
      End If
   End If

   CheckOC
   
End Function
'20080904 END


'*************************************************
'  檢核欄位長度
'
'*************************************************
Public Function CheckLen(strLabel, strField As String, intLength As Integer) As String
   'Modified by Sindy 2024/12/9 現在資料庫字元是char所以檢查函數可以改為Len()字元數會更正確
   'If LenB(strField) > intLength Then
   If Len(strField) > intLength Then
   '2024/12/9 END
      CheckLen = MsgText(603)
      MsgBox strLabel & MsgText(64), , MsgText(5)
   Else
      CheckLen = MsgText(602)
   End If
End Function
'*************************************************
'  員工姓名查詢
'
'*************************************************
Public Function StaffQuery(InputNo As String) As String
Dim adostaff As New ADODB.Recordset
Dim strQ As String, intQ As Integer 'Add by Amy 2021/10/22
    
   'Modify by Amy 2021/10/22 可顯示多筆
   StaffQuery = ""
   If InStr(InputNo, ",") > 0 Then
        strQ = " st01 in ('" & Replace(InputNo, ",", "','") & "') "
   Else
        strQ = " st01 = '" & InputNo & "' "
   End If
   strQ = "Select * From Staff Where " & strQ & "Order by st01"
   intQ = 1
   Set adostaff = ClsLawReadRstMsg(intQ, strQ)
   If intQ = 1 Then
      'Modify by Amy 2021/10/22 可顯示多筆
      Do While adostaff.EOF = False
        If IsNull(adostaff.Fields("st02").Value) Then
           StaffQuery = StaffQuery & "," & MsgText(601)
        Else
           StaffQuery = StaffQuery & "," & adostaff.Fields("st02").Value
        End If
        adostaff.MoveNext
      Loop
      StaffQuery = Mid(StaffQuery, 2)
      'end 2021/10/22
   Else
      StaffQuery = MsgText(601)
   End If
   adostaff.Close
End Function
'*************************************************
'  部門名稱查詢
'
'*************************************************
Public Function A0902Query(InputNo As String) As String
Dim adoacc090 As New ADODB.Recordset
   adoacc090.CursorLocation = adUseClient
   adoacc090.Open "select * from acc090 where a0901 = '" & InputNo & "'", adoTaie, adOpenStatic, adLockReadOnly
   If adoacc090.RecordCount <> 0 Then
      If IsNull(adoacc090.Fields("a0902").Value) Then
         A0902Query = MsgText(601)
      Else
         A0902Query = adoacc090.Fields("a0902").Value
      End If
   Else
      A0902Query = MsgText(601)
   End If
   adoacc090.Close
End Function


'*************************************************
'  銀行名稱查詢
'
'*************************************************
Public Function A0g02Query(InputNo As String) As String
Dim adoacc0g0 As New ADODB.Recordset
   adoacc0g0.CursorLocation = adUseClient
   adoacc0g0.Open "select * from acc0g0 where a0g01 = '" & InputNo & "'", adoTaie, adOpenStatic, adLockReadOnly
   If adoacc0g0.RecordCount <> 0 Then
      If IsNull(adoacc0g0.Fields("a0g02").Value) Then
         A0g02Query = MsgText(601)
      Else
         A0g02Query = adoacc0g0.Fields("a0g02").Value
      End If
   Else
      A0g02Query = MsgText(601)
   End If
   adoacc0g0.Close
End Function
'*************************************************
'  銀行帳號名稱查詢
'
'*************************************************
Public Function A0h03Query(InputBankNo, InputBankId As String) As String
Dim adoacc0h0 As New ADODB.Recordset
   adoacc0h0.CursorLocation = adUseClient
   adoacc0h0.Open "select * from acc0h0 where a0h01 = '" & InputBankNo & "' and a0h02 = '" & InputBankId & "'", adoTaie, adOpenStatic, adLockReadOnly
   If adoacc0h0.RecordCount <> 0 Then
      If IsNull(adoacc0h0.Fields("a0h03").Value) Then
         A0h03Query = ""
      Else
         A0h03Query = adoacc0h0.Fields("a0h03").Value
      End If
   Else
      A0h03Query = ""
   End If
   adoacc0h0.Close
End Function
'*************************************************
'  廠商名稱查詢
'
'*************************************************
Public Function A0i02Query(InputNo As String) As String
Dim adoacc0i0 As New ADODB.Recordset
   adoacc0i0.CursorLocation = adUseClient
   adoacc0i0.Open "select * from acc0i0 where a0i01 = '" & InputNo & "'", adoTaie, adOpenStatic, adLockReadOnly
   If adoacc0i0.RecordCount <> 0 Then
      If IsNull(adoacc0i0.Fields("a0i02").Value) Then
         A0i02Query = MsgText(601)
      Else
         A0i02Query = adoacc0i0.Fields("a0i02").Value
      End If
   Else
      A0i02Query = MsgText(601)
   End If
   adoacc0i0.Close
End Function
'*************************************************
'  顯示名稱查詢
'
'*************************************************
Public Function A1j03Query(InputNo1 As String, InputNo2 As String) As String
Dim adoacc1j0 As New ADODB.Recordset
   adoacc1j0.CursorLocation = adUseClient
   adoacc1j0.Open "select a1j03 from acc1j0 where a1j01 = '" & InputNo1 & "' and a1j02 = '" & InputNo2 & "'", adoTaie, adOpenStatic, adLockReadOnly
   If adoacc1j0.RecordCount <> 0 Then
      If IsNull(adoacc1j0.Fields("a1j03").Value) Then
         A1j03Query = MsgText(601)
      Else
         A1j03Query = adoacc1j0.Fields("a1j03").Value
      End If
   Else
      A1j03Query = MsgText(601)
   End If
   adoacc1j0.Close
End Function
'*************************************************
'  編號後三碼補零
'
'*************************************************
Public Function AfterZero(strValue As String) As String
   AfterZero = strValue & "000"
End Function
'*************************************************
'  客戶名稱查詢
'
'*************************************************
Public Function CustomerQuery(InputNo As String, InputSelect As Integer) As String
Dim adocustomer As New ADODB.Recordset
   adocustomer.CursorLocation = adUseClient
   adocustomer.Open "select * from customer where cu01 = '" & Mid(InputNo, 1, 8) & "' and cu02 = '" & IIf(Mid(InputNo, 9, 1) = "", "0", Mid(InputNo, 9, 1)) & "'", adoTaie, adOpenStatic, adLockReadOnly
   If adocustomer.RecordCount <> 0 Then
      adocustomer.MoveFirst
      Select Case InputSelect
         Case 1
            If IsNull(adocustomer.Fields("cu04").Value) Then
               '2009/3/31 MODIFY BY SONIA 無中文時抓英文
               'CustomerQuery = MsgText(601)
               If IsNull(adocustomer.Fields("cu05").Value) Then
                  '無英文時抓日文
                  If IsNull(adocustomer.Fields("cu06").Value) Then
                     CustomerQuery = MsgText(601)
                  Else
                     CustomerQuery = adocustomer.Fields("cu06").Value
                  End If
               Else
                  CustomerQuery = adocustomer.Fields("cu05").Value
               End If
               '2009/3/31 END
            Else
               CustomerQuery = adocustomer.Fields("cu04").Value
            End If
         Case 2
            If IsNull(adocustomer.Fields("cu05").Value) Then
               '2009/3/31 MODIFY BY SONIA 無英文時抓中文
               'CustomerQuery = MsgText(601)
               If IsNull(adocustomer.Fields("cu04").Value) Then
                  '無中文時抓日文
                  If IsNull(adocustomer.Fields("cu06").Value) Then
                     CustomerQuery = MsgText(601)
                  Else
                     CustomerQuery = adocustomer.Fields("cu06").Value
                  End If
               Else
                  CustomerQuery = adocustomer.Fields("cu04").Value
               End If
               '2009/3/31 END
            Else
               CustomerQuery = adocustomer.Fields("cu05").Value
            End If
         Case 3
            If IsNull(adocustomer.Fields("cu06").Value) Then
               '2009/3/31 MODIFY BY SONIA 無日文時抓中文
               'CustomerQuery = MsgText(601)
               If IsNull(adocustomer.Fields("cu04").Value) Then
                  '無中文時抓英文
                  If IsNull(adocustomer.Fields("cu05").Value) Then
                     CustomerQuery = MsgText(601)
                  Else
                     CustomerQuery = adocustomer.Fields("cu05").Value
                  End If
               Else
                  CustomerQuery = adocustomer.Fields("cu04").Value
               End If
               '2009/3/31 END
            Else
               CustomerQuery = adocustomer.Fields("cu06").Value
            End If
      End Select
   Else
      CustomerQuery = MsgText(601)
   End If
   adocustomer.Close
End Function

'Add By Sindy 2013/10/25
'*************************************************
'  以總收文號查詢申請案號
'*************************************************
Public Function ApplNoQuery(InputNo As String) As String
Dim adocaseprogress As New ADODB.Recordset
   
   adocaseprogress.CursorLocation = adUseClient
   adocaseprogress.Open "select pa11 from caseprogress, patent where cp01 = pa01 and cp02 = pa02 and cp03 = pa03 and cp04 = pa04 and cp09 = '" & InputNo & "' " & _
                        "union select tm12 from caseprogress, trademark where cp01 = tm01 and cp02 = tm02 and cp03 = tm03 and cp04 = tm04 and cp09 = '" & InputNo & "' " & _
                        "union select '' from caseprogress, lawcase where cp01 = lc01 and cp02 = lc02 and cp03 = lc03 and cp04 = lc04 and cp09 = '" & InputNo & "' " & _
                        "union select '' from caseprogress, hirecase where cp01 = hc01 and cp02 = hc02 and cp03 = hc03 and cp04 = hc04 and cp09 = '" & InputNo & "' " & _
                        "union select sp11 from caseprogress, servicepractice where cp01 = sp01 and cp02 = sp02 and cp03 = sp03 and cp04 = sp04 and cp09 = '" & InputNo & "'", adoTaie, adOpenStatic, adLockReadOnly
   If adocaseprogress.RecordCount <> 0 Then
      If IsNull(adocaseprogress.Fields(0).Value) Then
         ApplNoQuery = MsgText(601)
      Else
         ApplNoQuery = adocaseprogress.Fields(0).Value
      End If
   Else
      ApplNoQuery = MsgText(601)
   End If
   adocaseprogress.Close
End Function

'*************************************************
'  以總收文號查詢案件名稱
'
'Modify By Cheng 2002/01/17
'多加客戶案件案號欄位
'Modify by Amy 2020/05/28 加strData欲查詢欄位並回傳
'*************************************************
Public Function CaseNameQuery(InputNo As String, InputSelect As Integer, Optional strCustCaseNo As String, Optional ByRef strData As String = "") As String
Dim adoQ As New ADODB.Recordset
'Add by Amy 2020/05/28
Dim stField(1 To 5) As String
Dim bolOtherField As Boolean

   'Add By Cheng 2002/01/17
   strCustCaseNo = ""
   'Add by Amy 2020/05/28
   bolOtherField = False
   If strData <> MsgText(601) Then
        bolOtherField = True
        Select Case strData
            Case "申請案號"
                stField(1) = ",pa11 as " & strData
                stField(2) = ",tm12 as " & strData
                stField(3) = ",'' as " & strData
                stField(4) = ",'' as " & strData
                stField(5) = ",sp11 as " & strData
        Case Else
        End Select
   End If
   strData = ""
   'end 2020/05/28
   
   adoQ.CursorLocation = adUseClient
   '商標名稱已合併為一欄(TM05)
   adoQ.Open "select pa05, pa06, pa07, pa48" & stField(1) & " from caseprogress, patent where cp01 = pa01 and cp02 = pa02 and cp03 = pa03 and cp04 = pa04 and cp09 = '" & InputNo & "' " & _
                        "union select tm05, tm05, tm05, tm35" & stField(2) & " from caseprogress, trademark where cp01 = tm01 and cp02 = tm02 and cp03 = tm03 and cp04 = tm04 and cp09 = '" & InputNo & "' " & _
                        "union select lc05, lc06, lc07, lc17" & stField(3) & " from caseprogress, lawcase where cp01 = lc01 and cp02 = lc02 and cp03 = lc03 and cp04 = lc04 and cp09 = '" & InputNo & "' " & _
                        "union select hc06, '', '', ''" & stField(4) & " from caseprogress, hirecase where cp01 = hc01 and cp02 = hc02 and cp03 = hc03 and cp04 = hc04 and cp09 = '" & InputNo & "' " & _
                        "union select sp05, sp06, sp07, sp29" & stField(5) & " from caseprogress, servicepractice where cp01 = sp01 and cp02 = sp02 and cp03 = sp03 and cp04 = sp04 and cp09 = '" & InputNo & "'", adoTaie, adOpenStatic, adLockReadOnly
   If adoQ.RecordCount <> 0 Then
      Select Case InputSelect
         Case 1
            If IsNull(adoQ.Fields(0).Value) Then
               CaseNameQuery = MsgText(601)
            Else
               CaseNameQuery = adoQ.Fields(0).Value
            End If
         Case 2
            If IsNull(adoQ.Fields(1).Value) Then
               CaseNameQuery = MsgText(601)
            Else
               CaseNameQuery = adoQ.Fields(1).Value
            End If
         Case 3
            If IsNull(adoQ.Fields(2).Value) Then
               CaseNameQuery = MsgText(601)
            Else
               CaseNameQuery = adoQ.Fields(2).Value
            End If
      End Select
      'Add By Cheng 2002/01/17
      strCustCaseNo = "" & adoQ.Fields(3).Value
   Else
      CaseNameQuery = MsgText(601)
      'Add By Cheng 2002/01/17
      strCustCaseNo = ""
   End If
   'Add by Amy 2020/05/28
   If bolOtherField = True Then strData = "" & adoQ.Fields("申請案號")
   adoQ.Close
End Function


'*************************************************
'  以本所案號查詢案件名稱
'
'*************************************************
Public Function CaseNameShow(InputNo1 As String, InputNo2 As String, InputNo3 As String, InputNo4 As String, InputSelect As Integer) As String
Dim adocase As New ADODB.Recordset

   adocase.CursorLocation = adUseClient
    'Modify By Cheng 2003/11/11
    '商標名稱已合併為一個欄位(TM05)
'   adocase.Open "select pa05, pa06, pa07 from patent where pa01 = '" & InputNo1 & "' and pa02 = '" & InputNo2 & "' and pa03 = '" & InputNo3 & "' and pa04 = '" & InputNo4 & "' " & _
'                "union all select tm05, tm06, tm07 from trademark where tm01 = '" & InputNo1 & "' and tm02 = '" & InputNo2 & "' and tm03 = '" & InputNo3 & "' and tm04 = '" & InputNo4 & "' " & _
'                "union all select lc05, lc06, lc07 from lawcase where lc01 = '" & InputNo1 & "' and lc02 = '" & InputNo2 & "' and lc03 = '" & InputNo3 & "' and lc04 = '" & InputNo4 & "' " & _
'                "union all select hc06, '', '' from hirecase where hc01 = '" & InputNo1 & "' and hc02 = '" & InputNo2 & "' and hc03 = '" & InputNo3 & "' and hc04 = '" & InputNo4 & "' " & _
'                "union all select sp05, sp06, sp07 from servicepractice where sp01 = '" & InputNo1 & "' and sp02 = '" & InputNo2 & "' and sp03 = '" & InputNo3 & "' and sp04 = '" & InputNo4 & "'", adoTaie, adOpenStatic, adLockReadOnly
   adocase.Open "select pa05, pa06, pa07 from patent where pa01 = '" & InputNo1 & "' and pa02 = '" & InputNo2 & "' and pa03 = '" & InputNo3 & "' and pa04 = '" & InputNo4 & "' " & _
                "union all select tm05, '', '' from trademark where tm01 = '" & InputNo1 & "' and tm02 = '" & InputNo2 & "' and tm03 = '" & InputNo3 & "' and tm04 = '" & InputNo4 & "' " & _
                "union all select lc05, lc06, lc07 from lawcase where lc01 = '" & InputNo1 & "' and lc02 = '" & InputNo2 & "' and lc03 = '" & InputNo3 & "' and lc04 = '" & InputNo4 & "' " & _
                "union all select hc06, '', '' from hirecase where hc01 = '" & InputNo1 & "' and hc02 = '" & InputNo2 & "' and hc03 = '" & InputNo3 & "' and hc04 = '" & InputNo4 & "' " & _
                "union all select sp05, sp06, sp07 from servicepractice where sp01 = '" & InputNo1 & "' and sp02 = '" & InputNo2 & "' and sp03 = '" & InputNo3 & "' and sp04 = '" & InputNo4 & "'", adoTaie, adOpenStatic, adLockReadOnly
   If adocase.RecordCount <> 0 Then
      Select Case InputSelect
         Case 1
            If IsNull(adocase.Fields(0).Value) Then
               CaseNameShow = MsgText(601)
            Else
               CaseNameShow = adocase.Fields(0).Value
            End If
         Case 2
            If IsNull(adocase.Fields(1).Value) Then
               CaseNameShow = MsgText(601)
            Else
               CaseNameShow = adocase.Fields(1).Value
            End If
         Case 3
            If IsNull(adocase.Fields(2).Value) Then
               CaseNameShow = MsgText(601)
            Else
               CaseNameShow = adocase.Fields(2).Value
            End If
      End Select
   Else
      CaseNameShow = MsgText(601)
   End If
   adocase.Close
End Function

'*************************************************
'  以總收文號查詢申請人
'
'*************************************************
Public Function CaseCustQuery(InputNo As String) As String
Dim adocaseprogress As New ADODB.Recordset
Dim adocase As New ADODB.Recordset
   adocaseprogress.CursorLocation = adUseClient
   'edit by nick 2004/07/06 專利申請人順序錯誤
   'adocaseprogress.Open "select nvl(pa30, nvl(pa29, nvl(pa28, nvl(pa27, pa26)))) from caseprogress, patent where cp01 = pa01 and cp02 = pa02 and cp03 = pa03 and cp04 = pa04 and cp09 = '" & InputNo & "' " & _
                        "union select tm23 from caseprogress, trademark where cp01 = tm01 and cp02 = tm02 and cp03 = tm03 and cp04 = tm04 and cp09 = '" & InputNo & "' " & _
                        "union select lc11 from caseprogress, lawcase where cp01 = lc01 and cp02 = lc02 and cp03 = lc03 and cp04 = lc04 and cp09 = '" & InputNo & "' " & _
                        "union select hc05 from caseprogress, hirecase where cp01 = hc01 and cp02 = hc02 and cp03 = hc03 and cp04 = hc04 and cp09 = '" & InputNo & "' " & _
                        "union select nvl(sp08, nvl(sp58, sp59)) from caseprogress, servicepractice where cp01 = sp01 and cp02 = sp02 and cp03 = sp03 and cp04 = sp04 and cp09 = '" & InputNo & "'", adoTaie, adOpenStatic, adLockReadOnly
   'Modify By Sindy 2011/2/22 增加TM78,TM79,TM80,TM81,LC43,LC44,LC45,LC46,HC24,HC25,HC26,HC27,SP65,SP66
'   adocaseprogress.Open "select nvl(pa26, nvl(pa27, nvl(pa28, nvl(pa29, pa30)))) from caseprogress, patent where cp01 = pa01 and cp02 = pa02 and cp03 = pa03 and cp04 = pa04 and cp09 = '" & InputNo & "' " & _
'                        "union select tm23 from caseprogress, trademark where cp01 = tm01 and cp02 = tm02 and cp03 = tm03 and cp04 = tm04 and cp09 = '" & InputNo & "' " & _
'                        "union select lc11 from caseprogress, lawcase where cp01 = lc01 and cp02 = lc02 and cp03 = lc03 and cp04 = lc04 and cp09 = '" & InputNo & "' " & _
'                        "union select hc05 from caseprogress, hirecase where cp01 = hc01 and cp02 = hc02 and cp03 = hc03 and cp04 = hc04 and cp09 = '" & InputNo & "' " & _
'                        "union select nvl(sp08, nvl(sp58, sp59)) from caseprogress, servicepractice where cp01 = sp01 and cp02 = sp02 and cp03 = sp03 and cp04 = sp04 and cp09 = '" & InputNo & "'", adoTaie, adOpenStatic, adLockReadOnly
   adocaseprogress.Open "select nvl(pa26, nvl(pa27, nvl(pa28, nvl(pa29, pa30)))) from caseprogress, patent where cp01 = pa01 and cp02 = pa02 and cp03 = pa03 and cp04 = pa04 and cp09 = '" & InputNo & "' " & _
                        "union select nvl(tm23, nvl(tm78, nvl(tm79, nvl(tm80, tm81)))) from caseprogress, trademark where cp01 = tm01 and cp02 = tm02 and cp03 = tm03 and cp04 = tm04 and cp09 = '" & InputNo & "' " & _
                        "union select nvl(lc11, nvl(lc43, nvl(lc44, nvl(lc45, lc46)))) from caseprogress, lawcase where cp01 = lc01 and cp02 = lc02 and cp03 = lc03 and cp04 = lc04 and cp09 = '" & InputNo & "' " & _
                        "union select nvl(hc05, nvl(hc24, nvl(hc25, nvl(hc26, hc27)))) from caseprogress, hirecase where cp01 = hc01 and cp02 = hc02 and cp03 = hc03 and cp04 = hc04 and cp09 = '" & InputNo & "' " & _
                        "union select nvl(sp08, nvl(sp58, nvl(sp59, nvl(sp65, sp66)))) from caseprogress, servicepractice where cp01 = sp01 and cp02 = sp02 and cp03 = sp03 and cp04 = sp04 and cp09 = '" & InputNo & "'", adoTaie, adOpenStatic, adLockReadOnly
   If adocaseprogress.RecordCount <> 0 Then
      If IsNull(adocaseprogress.Fields(0).Value) Then
         CaseCustQuery = MsgText(601)
      Else
         CaseCustQuery = adocaseprogress.Fields(0).Value
      End If
   Else
      CaseCustQuery = MsgText(601)
   End If
   adocaseprogress.Close
End Function
'*************************************************
'  以本所案號查詢申請人
'
'*************************************************
Public Function CaseCustShow(InputNo1 As String, InputNo2 As String, InputNo3 As String, InputNo4 As String, InputSelect As Integer) As String
Dim adocase As New ADODB.Recordset
   adocase.CursorLocation = adUseClient
   '2009/7/24 MODIFY BY SONIA 只改專利語法,應抓第一申請人(結餘單R096030082,CFP-016175)
   'adocase.Open "select nvl(pa30, nvl(pa29, nvl(pa28, nvl(pa27, pa26)))) from patent where pa01 = '" & InputNo1 & "' and pa02 = '" & InputNo2 & "' and pa03 = '" & InputNo3 & "' and pa04 = '" & InputNo4 & "' " &
   adocase.Open "select pa26 from patent where pa01 = '" & InputNo1 & "' and pa02 = '" & InputNo2 & "' and pa03 = '" & InputNo3 & "' and pa04 = '" & InputNo4 & "' " & _
                "union all select tm23 from trademark where tm01 = '" & InputNo1 & "' and tm02 = '" & InputNo2 & "' and tm03 = '" & InputNo3 & "' and tm04 = '" & InputNo4 & "' " & _
                "union all select lc11 from lawcase where lc01 = '" & InputNo1 & "' and lc02 = '" & InputNo2 & "' and lc03 = '" & InputNo3 & "' and lc04 = '" & InputNo4 & "' " & _
                "union all select hc05 from hirecase where hc01 = '" & InputNo1 & "' and hc02 = '" & InputNo2 & "' and hc03 = '" & InputNo3 & "' and hc04 = '" & InputNo4 & "' " & _
                "union all select nvl(sp59, nvl(sp58, sp08)) from servicepractice where sp01 = '" & InputNo1 & "' and sp02 = '" & InputNo2 & "' and sp03 = '" & InputNo3 & "' and sp04 = '" & InputNo4 & "'", adoTaie, adOpenStatic, adLockReadOnly
   If adocase.RecordCount <> 0 Then
      Select Case InputSelect
         Case 1
            If IsNull(adocase.Fields(0).Value) Then
               CaseCustShow = MsgText(601)
            Else
               CaseCustShow = adocase.Fields(0).Value
            End If
         Case 2
            If IsNull(adocase.Fields(0).Value) Then
               CaseCustShow = MsgText(601)
            Else
               CaseCustShow = adocase.Fields(0).Value
            End If
         Case 3
            If IsNull(adocase.Fields(0).Value) Then
               CaseCustShow = MsgText(601)
            Else
               CaseCustShow = adocase.Fields(0).Value
            End If
         Case 4
            If IsNull(adocase.Fields(0).Value) Then
               CaseCustShow = MsgText(601)
            Else
               CaseCustShow = adocase.Fields(0).Value
            End If
      End Select
   Else
      CaseCustShow = MsgText(601)
   End If
   adocase.Close
End Function

'Add By Cheng 2002/01/17
'*************************************************
'  以總收文號查詢申請人姓名 (中-->英-->日)
'
'*************************************************
Public Function CaseCustNameQuery(strCustNo As String) As String
Dim adocaseprogress As New ADODB.Recordset
   adocaseprogress.CursorLocation = adUseClient
   adocaseprogress.Open "select decode(cu04,Null,decode(cu05,Null,cu06,cu05||' '||cu88||' '||cu89||' '||cu90),cu04) from Customer where cu01 = '" & Mid(strCustNo, 1, 8) & "' And cu02 = '" & Mid(strCustNo, 9, 1) & "' ", _
                          adoTaie, adOpenStatic, adLockReadOnly
   If adocaseprogress.RecordCount <> 0 Then
      If IsNull(adocaseprogress.Fields(0).Value) Then
         CaseCustNameQuery = MsgText(601)
      Else
         CaseCustNameQuery = Left(adocaseprogress.Fields(0).Value, 6)
      End If
   Else
      CaseCustNameQuery = MsgText(601)
   End If
   adocaseprogress.Close
End Function

Public Function Pub_GetModuleFileName() As String
'宣告變數
Dim str As String

Pub_GetModuleFileName = ""
str = String(MAX_PATH, "#")
GetModuleFileName App.hInstance, str, MAX_PATH
Pub_GetModuleFileName = Replace(str, "#", "")

End Function

'檢查身份證字號或統一編號
'Modify by Morgan 2009/1/14 +3外僑及規則說明
Public Function CheckID(ByVal Sty As Integer, ByVal sID As String) As Boolean
 Dim x1 As Integer, i As Integer, nCheckSum As Integer
 'Memo by Amy 2024/06/24 請確認是否可使用 Pub_CheckIDAll, 統一修改避免有未改到的
 
   Select Case Sty
      '台灣身份證字號檢查
      Case 0
         sID = UCase(sID)
         '10碼
         If Len(sID) <> 10 Then CheckID = False: Exit Function
         '第2碼以後為數字
         If Not IsNumeric(Mid$(sID, 2)) Then CheckID = False: Exit Function
         'edit by nickc 2007/11/16 修正字母順序寫錯
         'x1 = InStr("ABCDEFGHJKLMNPQRSTUVWXYZIO", Left$(sID, 1)) + 9
         x1 = InStr("ABCDEFGHJKLMNPQRSTUVXYWZIO", Left$(sID, 1)) + 9
         '第1碼為英文字母
         If x1 < 10 Then CheckID = False: Exit Function
         
         sID = Format$(x1, "00") + Mid$(sID, 2)
         nCheckSum = Val(Mid$(sID, 1, 1))
         For i = 2 To Len(sID) - 1
            nCheckSum = nCheckSum + Val(Mid$(sID, i, 1)) * (11 - i)
         Next
         nCheckSum = nCheckSum + Val(Mid$(sID, 11, 1))
         CheckID = (nCheckSum Mod 10 = 0)
      '統一編號
      Case 1
         i = Val(Mid(Trim(str(Val(Mid(sID, 2, 1)) * 2)), 1, 1)) + _
            Val(Mid(Trim(str(Val(Mid(sID, 2, 1)) * 2)), 2, 1)) + _
            Val(Mid(sID, 1, 1)) + _
            Val(Mid(Trim(str(Val(Mid(sID, 4, 1)) * 2)), 1, 1)) + _
            Val(Mid(Trim(str(Val(Mid(sID, 4, 1)) * 2)), 2, 1)) + _
            Val(Mid(sID, 3, 1)) + _
            Val(Mid(Trim(str(Val(Mid(sID, 6, 1)) * 2)), 1, 1)) + _
            Val(Mid(Trim(str(Val(Mid(sID, 6, 1)) * 2)), 2, 1)) + _
            Val(Mid(sID, 5, 1)) + _
            Val(Mid(Trim(str(Val(Mid(sID, 7, 1)) * 4)), 1, 1)) + _
            Val(Mid(Trim(str(Val(Mid(sID, 7, 1)) * 4)), 2, 1)) + _
            Val(Mid(sID, 8, 1))
         'Modified by Morgan 2024/10/16 改為可被5整除,112/4月以後財政部將會釋出多出的統編
         'If (i / 10) = Int(i / 10) Then
         If (i / 5) = Int(i / 5) Then
         'end 2024/10/16
            CheckID = True
         Else
            If Mid(sID, 7, 1) = "7" Then
               i = Val(Mid(Trim(str(Val(Mid(sID, 2, 1)) * 2)), 1, 1)) + _
               Val(Mid(Trim(str(Val(Mid(sID, 2, 1)) * 2)), 2, 1)) + _
               Val(Mid(sID, 1, 1)) + _
               Val(Mid(Trim(str(Val(Mid(sID, 4, 1)) * 2)), 1, 1)) + _
               Val(Mid(Trim(str(Val(Mid(sID, 4, 1)) * 2)), 2, 1)) + _
               Val(Mid(sID, 3, 1)) + _
               Val(Mid(Trim(str(Val(Mid(sID, 6, 1)) * 2)), 1, 1)) + _
               Val(Mid(Trim(str(Val(Mid(sID, 6, 1)) * 2)), 2, 1)) + _
               Val(Mid(sID, 5, 1)) + _
               Val(Mid(Trim(Val(Mid(Trim(str(Val(Mid(sID, 7, 1)) * 4)), 1, 1)) + _
               Val(Mid(Trim(str(Val(Mid(sID, 7, 1)) * 4)), 2, 1))), 1, 1)) + _
               Val(Mid(sID, 8, 1))
               If (i / 10) = Int(i / 10) Then
                  CheckID = True
               Else
                  CheckID = False
               End If
            Else
               CheckID = False
            End If
         End If
      'Add by Morgan 2009/1/14
      '第2碼為英文以第1碼的方法轉數字後取個位數替換後規則同身分證號
      Case 2 '外僑
         sID = UCase(sID)
         '10碼
         If Len(sID) <> 10 Then CheckID = False: Exit Function
         '第3碼以後為數字
         If Not IsNumeric(Mid$(sID, 3)) Then CheckID = False: Exit Function
         '第2碼為英文字母
         x1 = InStr("ABCDEFGHJKLMNPQRSTUVXYWZIO", Mid(sID, 2, 1)) + 9
         If x1 < 10 Then CheckID = False: Exit Function
         '轉數字取個位數替換
         sID = Left(sID, 1) & Right(x1, 1) & Mid$(sID, 3)
         x1 = InStr("ABCDEFGHJKLMNPQRSTUVXYWZIO", Left$(sID, 1)) + 9
         '第1碼為英文字母
         If x1 < 10 Then CheckID = False: Exit Function
         sID = Format$(x1, "00") + Mid$(sID, 2)
         nCheckSum = Val(Mid$(sID, 1, 1))
         For i = 2 To Len(sID) - 1
            nCheckSum = nCheckSum + Val(Mid$(sID, i, 1)) * (11 - i)
         Next
         nCheckSum = nCheckSum + Val(Mid$(sID, 11, 1))
         CheckID = (nCheckSum Mod 10 = 0)
      'Add by Amy 2020/08/28 大陸 身份證字號 檢查
      Case 3
         '18碼
         If Len(sID) <> 18 Then CheckID = False: Exit Function
         CheckID = CheckPRCID(sID)
      'Add by Amy 2024/08/14 大陸 社會信用代碼 檢查
      Case 4
         If Len(sID) <> 18 Then CheckID = False: Exit Function
         CheckID = CheckGB32100(sID)
      'Add by Amy 2024/08/14 大陸 社會信用代碼 及 身份證字號 檢查(無法判斷個人or公司)
      Case 5
         If Len(sID) <> 18 Then CheckID = False: Exit Function
         CheckID = CheckGB32100(sID) '先檢查 社會信用代碼
         If CheckID = False Then
            CheckID = CheckPRCID(sID) '再檢查 身份證字號
         End If
   End Select
End Function
'*************************************************
'  分攤方式查詢
'
'*************************************************
Public Function A0702Query(InputNo As String) As String
Dim adoacc070 As New ADODB.Recordset
   adoacc070.CursorLocation = adUseClient
   adoacc070.Open "select * from acc070 where a0701 = '" & InputNo & "'", adoTaie, adOpenStatic, adLockReadOnly
   If adoacc070.RecordCount <> 0 Then
      If IsNull(adoacc070.Fields("a0702").Value) Then
         A0702Query = MsgText(601)
      Else
         A0702Query = adoacc070.Fields("a0702").Value
      End If
   Else
      A0702Query = MsgText(601)
   End If
   adoacc070.Close
End Function

'Add by Morgan 2008/10/15
'檢查Form是否存在
Public Function PUB_IsFormExist(p_FormName As String) As Boolean
   Dim ii As Integer
   For ii = 0 To Forms.Count - 1
      If Forms(ii).Name = p_FormName Then
         PUB_IsFormExist = True
         Exit For
      End If
   Next
End Function
'Add by Morgan 2008/11/10
'專利發文時說明書是否要電子檔的預設值
Public Function PUB_GetDefautCP120(p_CP10 As String, p_PA09 As String) As String
   Dim stSQL As String, intR As Integer, rsTmp As ADODB.Recordset
   'Modify By Sindy 2013/11/13 改抓CasePropertyMap檔
   'stSQL = "select em03 from extmap where em01='" & p_CP10 & "' and em02='" & p_PA09 & "'"
   stSQL = "select cpm26 from CasePropertyMap where cpm01='P' and cpm02='" & p_CP10 & "' and cpm26 is not null"
   '2013/11/13 END
   intR = 1
   Set rsTmp = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      PUB_GetDefautCP120 = "Y"
   'Add By Sindy 2014/1/16
   Else
      If p_CP10 = "307" Then '分割
         PUB_GetDefautCP120 = "Y"
      End If
   '2014/1/16 END
   End If
End Function

'''''''''''''''''''''''''''''''''''''''''''''''''''''
' 檢查系統類別是否正確
' Input : strSys ==> 檢查的系統類別
' Output : True = 該系統類別存在
'          False = 該系統類別不存在
'''''''''''''''''''''''''''''''''''''''''''''''''''''
Public Function IsCorrectSysKind(ByVal strSys As String) As Boolean
   Dim strSql As String
   Dim rsTmp As New ADODB.Recordset
   IsCorrectSysKind = False
   strSql = "SELECT * FROM SYSTEMKIND " & _
            "WHERE SK01 = '" & strSys & "' "
   rsTmp.CursorLocation = adUseClient
   rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly   'edit by nickc 2005/08/04 原先是  動態開啟
   If rsTmp.RecordCount > 0 Then
      IsCorrectSysKind = True
   End If
   rsTmp.Close
   Set rsTmp = Nothing
End Function

'Morgan 2003/11/21
'2008/11/25自各程式抽出共用
Public Function CaseCheck(m_TM01 As String, m_TM02 As String, m_TM03 As String, m_TM04, m_TM10 As String) As Boolean

   Dim strSql As String
   Dim rsTmp As New ADODB.Recordset
   
   CaseCheck = False
   If (m_TM10 = "000") Then
      '2008/11/25 modify by sonia 桂英說改檢查該案號, 不要只檢查點選的那一道
      'strSQL = " select CU10 from caseprogress A, TRADEMARK B, CUSTOMER C, ACC1K0 D" & _
         " where CP09='" & m_CP09 & "'" & _
         " AND TM01=CP01 AND TM02=CP02 AND TM03=CP03 AND TM04=CP04" & _
         " AND CU01=SUBSTR(TM23,1,8) AND CU02=SUBSTR(TM23,9,1)" & _
         " AND A1K01=CP60 AND (A1K29<>'Y' OR A1K29 IS NULL)"
      strSql = " select CU10 from caseprogress A, TRADEMARK B, CUSTOMER C, ACC1K0 D" & _
         " where CP01='" & m_TM01 & "' AND CP02='" & m_TM02 & "' AND CP03='" & m_TM03 & "' AND CP04='" & m_TM04 & "'" & _
         " AND TM01=CP01 AND TM02=CP02 AND TM03=CP03 AND TM04=CP04" & _
         " AND CU01=SUBSTR(TM23,1,8) AND CU02=SUBSTR(TM23,9,1)" & _
         " AND A1K01=CP60 AND (A1K29<>'Y' OR A1K29 IS NULL)"
      
      rsTmp.CursorLocation = adUseClient
      rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly   'edit by nickc 2005/08/04 原先是  動態開啟
      If Not (rsTmp.EOF And rsTmp.BOF) Then
         rsTmp.MoveFirst
         If rsTmp.Fields(0).Value <> "000" Then
            MsgBox "請注意此案為外對內案件，但帳款未結清！", vbExclamation
            CaseCheck = True
         End If
      End If
      rsTmp.Close
      Set rsTmp = Nothing
   End If
   
End Function

'Add by Morgan 2008/12/17
'計算下次繳費期限(從發證移來以便共用)
'strBaseDate:年費起算日期
Public Function PUB_GetNextYearFeeDate(cp() As String, pa() As String, Optional strCaseType As String, Optional strPayType As String, Optional strBaseDate As String) As String

   Dim strTemp As String, strTemp1 As String, strTemp2 As String, dobDateAdd As Double
   Dim varTemp As Variant, strStartDate As String, strDate As String, strDate1 As String
   Dim i As Integer, yearTemp As String
   Dim StrSQLa As String
   Dim rsA As New ADODB.Recordset
   Dim stDateType As String, stYear As String
   Dim strRtnDate As String
   Dim strReduceOneDay As String 'Added by Morgan 2019/12/3
   Dim strTmp As String, intA As Integer, rsAD As New ADODB.Recordset  'Added by Lydia 2024/05/14
   
On Error GoTo HndErr

   'modify by sonia 91.1.29(先抓已繳年度, 若無再抓第一年, 未繳時不要放,,,,,)
   ' 91.01.28 modify by louis (證書固定是第一年)
   'strTemp = GetMoneyYears(pa(72))
   'strTemp = 1
   yearTemp = GetMoneyYears(pa(72))

   'Modify by Morgan 2005/3/21 改GetMoneyYears
   ''93.10.29 modify by sonia 應抓下次繳費年度,以發證日計算者仍為第一年
   ''If yearTemp <> 1 Then yearTemp = yearTemp + 1
   'If pa(72) = "" Then
   '   yearTemp = 1
   'Else
   '   yearTemp = yearTemp + 1
   'End If
   ''93.10.29 end
   '2003/3/21 end

   strCaseType = Empty: strPayType = Empty
   
   'Modified by Morgan 2019/12/3
   'If GetNationTaxEx(Val(pa(8)), pa(9), strTemp, strTemp1, 年費, strTemp2, strCaseType) Then
   If ClsPDGetNationTax(Val(pa(8)), pa(9), strTemp, strTemp1, 年費, strTemp2, strCaseType, strReduceOneDay) Then
   'end 2019/12/3
      strPayType = strTemp
     '2006/1/27 ADD BY SONIA菲律賓修法
      If pa(9) = "030" And pa(10) <> "" And Val(pa(10)) < 19980101 Then
         strPayType = "6"
         strTemp = strPayType
         Select Case pa(8)
            Case "1"
               strTemp1 = "5,6,7,8,9,10,11,12,13,14,15,16,17"
               strTemp2 = 17
            Case "2"
               strTemp1 = "5,10,15"
               strTemp2 = 15
            Case "3"
               strTemp1 = "5,10,15"
               strTemp2 = 15
         End Select
   
      'Add by Morgan 2006/8/3 馬來西亞修法,舊法發明為發證日起15年,新型為發證日起15年
      ElseIf pa(9) = "018" Then
         Select Case pa(8)
            Case "1"
               '發明申請日2001/8/1以後適用新法
               If Val(pa(10)) > 0 And Val(TransDate(pa(10), 2)) < 20010801 Then
                  strPayType = "6"
               End If
            
            Case "2"
               '新型發證日2001/8/1以後適用新法
               'Remove by Morgan 2007/7/26 新型不管何時提申均適用新法(2003年8月14日實施)
               'If Val(pa(21)) > 0 And Val(TransDate(pa(21), 2)) < 20010801 Then
               '   strPayType = "6"
               '   strTemp = "6"
               '   strTemp1 = "5,10"
               '   strTemp2 = 10
               'End If
         End Select
   
      'Add by Morgan 2007/4/20 日本設計自申請日2007/4/1起改用新法,舊法為發證日起15年,第4年起逐年繳交。
      ElseIf pa(9) = "011" Then
         If pa(8) = "3" Then
            If Val(pa(10)) > 0 And Val(TransDate(pa(10), 2)) < 20070401 Then
               strTemp1 = "4,5,6,7,8,9,10,11,12,13,14,15"
               strTemp2 = 15
            End If
         End If
      '2008/9/25 韓國新型自申請日2006/10/1起改用新法,舊法為發證日起第2,4,5,6,7,8,9,10年起逐年繳交。
      ElseIf pa(9) = "012" Then
         If pa(8) = "2" Then
            If Val(pa(10)) > 0 And Val(TransDate(pa(10), 2)) < 20061001 Then
               strTemp1 = "2,4,5,6,7,8,9,10"
            End If
         End If
      '2008/9/25 END
      '2012/5/18 ADD BY SONIA 澳洲發明自申請日2008/7/1起改用新法,舊法為申請日起第6~20年起逐年繳交。
      ElseIf pa(9) = "015" Then
         If pa(8) = "1" Then
            'Added by Morgan 2025/8/7
            '澳洲植物新品種保護的專利權期間為自發證日起算25年，自發證日起第2年須逐年繳年費--禧佩
            strTmp = "select cp09 from caseprogress where cp01='" & pa(1) & "' and cp02='" & pa(2) & "' and cp03='" & pa(3) & "' and cp04='" & pa(4) & "' and cp10='120' and cp27>0"
            intA = 1
            Set rsAD = ClsLawReadRstMsg(intA, strTmp)
            If intA = 1 Then
               strPayType = "6"
               strTemp = strPayType
               stDateType = strPayType
               strTemp1 = "2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25"
            'end 2025/8/7
            ElseIf Val(pa(10)) > 0 And Val(TransDate(pa(10), 2)) < 20080701 Then
               strTemp1 = "6,7,8,9,10,11,12,13,14,15,16,17,18,19,20"
            End If
         End If
      '2012/5/18 END
      'add by sonia 2019/5/28 '土耳其發明及新型在2018/5/9日以前沒繳過的都適用新法自第3年開始(已繳過的仍自第2年開始) CFP-027731
      ElseIf pa(9) = "235" And pa(8) = "1" And Left(pa(72), 1) = "2" Then
         strTemp1 = "2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20"
      ElseIf pa(9) = "235" And pa(8) = "2" And Left(pa(72), 1) = "2" Then
         strTemp1 = "2,3,4,5,6,7,8,9,10"
      'end 2019/5/28
      End If
      '2006/1/27 END
   
      varTemp = Split(strTemp1, ",")
      'modify by sonia 91.1.29(先抓已繳年度, 若無再抓第一年)
      'dobDateAdd = varTemp(0)
      dobDateAdd = varTemp(yearTemp - 1)
   
      'Modify by Morgan 2011/3/21 英國分割要從母案的申請日起算年費期限
      'strStartDate = GetStartDate(strTemp, cp(), pa())
      'Modify by Morgan 2011/9/15 +EPC的分割也要
      'If pa(9) = "201" And strTemp = 申請日 Then
      If (pa(9) = "201" Or pa(9) = "221") And strTemp = 申請日 Then
         strTmp = "select pa10 from caseprogress,divisioncase,patent" & _
            " where cp01='" & pa(1) & "' and cp02='" & pa(2) & "'" & _
            " and cp03='" & pa(3) & "' and cp04='" & pa(4) & "'" & _
            " and cp10='307' and cp27>0 and cp57 is null" & _
            " and dc01(+)='" & cp(1) & "' and dc02(+)='" & cp(2) & "'" & _
            " and dc03(+)='" & cp(3) & "' and dc04(+)='" & cp(4) & "'" & _
            " and pa01(+)=dc05 and pa02(+)=dc06 and pa03(+)=dc07 and pa04(+)=dc08"
            
         intA = 1
         Set rsAD = ClsLawReadRstMsg(intA, strTmp)
         If intA = 1 Then
            strStartDate = rsAD("pa10")
         Else
            strStartDate = GetStartDate(strTemp, cp(), pa())
         End If
      Else
         strStartDate = GetStartDate(strTemp, cp(), pa())
      End If
      'end 2011/3/21
      
      'Added by Morgan 2013/7/3
      'Modified by Morgan 2013/10/2 +馬來西亞設計
      'Modified by Morgan 2013/12/31 +印尼設計--禧佩
      'Removed by Morgan 2014/1/13 取消印尼設計--禧佩
      'Modified by Morgan 2016/10/19 巴基斯坦發明及設計之專利期間及年費均從優先權日起算--禧佩
      If (((pa(9) = "040" Or pa(9) = "018") And pa(8) = "3") Or (pa(9) = "038" And (pa(8) = "1" Or pa(8) = "3"))) And strTemp = 申請日 Then
         strDate1 = PUB_GetFirstPriDate(pa())
         If strDate1 <> "" Then
            strStartDate = strDate1
         End If
      End If
      'end 2013/7/3
      
      'Add by Morgan 2007/8/7 加考慮年費起算日與繳年費起算日不同時 CFP-14786
      If strStartDate <> "" Then
         If stDateType = "" Then 'Added by Morgan 2025/8/7 有例外會在上面先設定
            strTmp = "select * from nation where na01='" & pa(9) & "'"
            intA = 1
            Set rsAD = ClsLawReadRstMsg(intA, strTmp)
            If intA = 1 Then
               Select Case pa(8)
                  Case "1"
                     stDateType = rsAD.Fields("na42")
                  Case "2"
                     stDateType = rsAD.Fields("na45")
                  Case "3"
                     stDateType = rsAD.Fields("na48")
               End Select
            End If
         End If
         
         If stDateType <> strTemp Then
            '考慮民國年或空白
            Select Case stDateType
               Case 收文日
                  If Len(cp(5)) > 4 Then
                     stYear = Left(cp(5), Len(cp(5)) - 4)
                  End If
               Case 申請日
                  If Len(pa(10)) > 4 Then
                     stYear = Left(pa(10), Len(pa(10)) - 4)
                  End If
               Case 公開日
                  If Len(pa(12)) > 4 Then
                     stYear = Left(pa(12), Len(pa(12)) - 4)
                  End If
               Case 准駁日
                  If Len(pa(20)) > 4 Then
                     stYear = Left(pa(20), Len(pa(20)) - 4)
                  End If
               Case 公告日
                  If Len(pa(14)) > 4 Then
                     stYear = Left(pa(14), Len(pa(14)) - 4)
                  End If
               Case 發證日
                  If Len(pa(21)) > 4 Then
                     stYear = Left(pa(21), Len(pa(21)) - 4)
                  End If
               Case 發文日
                  If Len(cp(27)) > 4 Then
                     stYear = Left(cp(27), Len(cp(27)) - 4)
                  End If
            End Select
            If stYear <> "" Then
               strStartDate = stYear & Right(strStartDate, 4)
            End If
         End If
      End If
   
      strBaseDate = strStartDate
      
      If strStartDate <> "" Then
         '91.12.22 ADD BY SONIA
         If pa(9) = "012" And pa(8) = "2" And pa(10) <> "" And Val(pa(10)) < 19990701 Then dobDateAdd = 3
         '91.12.22 END
         If strCaseType = "605" Then
            'Modify by Morgan 2005/9/4
            'strStartDate = CompDate(0, (dobDateAdd - 1), strStartDate)
            'Modified by Morgan 2019/12/3
            'strDate = CompDate(0, (dobDateAdd - 1), strStartDate)
            strDate = PUB_GetEndDate(strStartDate, (dobDateAdd - 1), strReduceOneDay, pa(9))
            'end 2019/12/3
         Else
            'Modify by Morgan 2005/9/4
            'strStartDate = CompDate(0, dobDateAdd, strStartDate)
            'Modified by Morgan 2019/12/3
            'strDate = CompDate(0, dobDateAdd, strStartDate)
            strDate = PUB_GetEndDate(strStartDate, dobDateAdd, strReduceOneDay, pa(9))
            'end 2019/12/3
         End If
         'Modify by Morgan 2005/9/4
         'strDate = strStartDate
      End If
      
      'strDate1 = ChangeWDateStringToWString(DateAdd("M", -1, ChangeWStringToWDateString(strDate)))
      strRtnDate = strDate
      
      'Added by Morgan 2016/10/28
      '印尼發明及新型的年費期限第1次為發證日+6個月,第2次以後為屆滿前1個月
      'Modified by Morgan 2022/3/22
      '核准日6個月內須繳交自申請日起算累計至核准日次年之年費，之後則逐年提前於屆滿前1個月(申請日)繳交
      If pa(9) = "017" And (pa(8) = "1" Or pa(8) = "2") Then
         'Added by Morgan 2022/3/22
         If pa(72) = "" And pa(20) <> "" Then
            strRtnDate = CompDate(1, 6, pa(20))
         Else
         'end 2022/3/22
            strRtnDate = CompDate(1, -1, strRtnDate)
         End If
         GoTo EscPoint
      End If
      'end 2016/10/28
   
      'Modify by Morgan 2005/9/4
      'If strRtnDate > strSrvDate(2) Then
      If strRtnDate > strSrvDate(1) Then
         GoTo EscPoint
      End If
      
      '2008/9/25 ADD BY SONIA 英國,印度發明第一年若過期改為發證日+三個月故不抓下一年
      If (pa(9) = "201" Or pa(9) = "040") And pa(8) = "1" Then
         GoTo EscPoint
      End If
      '2008/9/25 END
   
      '93.12.22 add 准後繳年費者
      If rsA.State <> adStateClosed Then rsA.Close
      Set rsA = Nothing
      StrSQLa = "Select * From Nation Where NA01='" & pa(9) & "' "
      rsA.CursorLocation = adUseClient
      rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
      If rsA.RecordCount > 0 Then
          Select Case pa(8)
          Case "1" '發明
              '若非准後繳費者
              If "" & rsA("NA56").Value <> "Y" Then
                  If rsA.State <> adStateClosed Then rsA.Close
                  Set rsA = Nothing
                  GoTo EscPoint
              End If
          Case "2" '新型
              '若非准後繳費者
              If "" & rsA("NA57").Value <> "Y" Then
                  If rsA.State <> adStateClosed Then rsA.Close
                  Set rsA = Nothing
                  GoTo EscPoint
              End If
          Case "3" '設計
              '若非准後繳費者
              If "" & rsA("NA58").Value <> "Y" Then
                  If rsA.State <> adStateClosed Then rsA.Close
                  Set rsA = Nothing
                  GoTo EscPoint
              End If
          End Select
      End If

      If rsA.State <> adStateClosed Then rsA.Close
      Set rsA = Nothing
   
CompNextDate:
   
      yearTemp = yearTemp + 1
      If yearTemp > UBound(varTemp) Then GoTo EscPoint
            
      dobDateAdd = varTemp(yearTemp - 1)
      '法定期限
      If strCaseType = "605" Then
         'Modified by Morgan 2019/12/3
         'strRtnDate = CompDate(0, (dobDateAdd - 1), strStartDate)
         strRtnDate = PUB_GetEndDate(strStartDate, (dobDateAdd - 1), strReduceOneDay, pa(9))
         'end 2019/12/3
      Else
         'Modified by Morgan 2019/12/3
         'strRtnDate = CompDate(0, dobDateAdd, strStartDate)
         strRtnDate = PUB_GetEndDate(strStartDate, dobDateAdd, strReduceOneDay, pa(9))
         'end 2019/12/3
      End If
       
      'Added by Morgan 2018/7/31 --禧佩
      '歐亞專利聯盟年費為准後始須繳交,若遇到之第1次年費期限距發證日少於2個月,原年費期限可延長2個月
      If (pa(9) = "074" And pa(8) = "1") And pa(21) <> "" Then
         If strRtnDate > DBDATE(pa(21)) Then
            strDate = CompDate(1, 2, pa(21))
            If strRtnDate < strDate Then
               strRtnDate = CompDate(1, 2, strRtnDate)
            End If
            GoTo EscPoint
         End If
      End If
      'end 2018/7/31
      
      '若法定期限小於系統日期
      If strRtnDate < strSrvDate(1) Then
         '重算
         GoTo CompNextDate
      '若法定期限大於等於系統日期
      Else
         GoTo EscPoint
      End If
      '93.12.22 end
   End If
   
EscPoint:

   'Add by Morgan 2008/12/17 從領證發文移來
   '2008/3/21 ADD BY SONIA沙烏地阿拉伯,年費期限為每年3/31
   If pa(9) = "021" And strRtnDate <> "" Then
      strRtnDate = Left(strRtnDate, 4) & "0331"
      strBaseDate = Left(strBaseDate, 4) & "0331"
   End If
   '2008/3/21 END
   'end 2008/12/17
   
   '2011/5/10 ADD BY SONIA 阿根延設計須於期滿前6個月辦理CFP-019099
   If pa(9) = "118" And pa(8) = "3" And strRtnDate <> "" Then
      strRtnDate = CompDate(1, -6, strRtnDate)
   End If
   '2011/5/10 END
   
   PUB_GetNextYearFeeDate = strRtnDate
   Set rsAD = Nothing 'Added by Lydia 2024/05/14
   
HndErr:

End Function

'Add by Morgan 2008/12/17 (從發證移來以便共用)
' 1 : 發明年費
' 2 : 新型年費
' 3 : 設計年費
' 4 : 發明實體審查
' 5 : 新型實體審查
' 6 : 設計實體審查
' 7 : 發明公開
' 8 : 新型公開
' 9 : 設計公開
'10 : 商標
'取得年費等期限
'Removed by Morgan 2019/12/3 改用 ClsPDGetNationTaxEx
'Private Function GetNationTaxEx(ByRef intChoose As Integer, ByRef strNation As String, ByRef strStartUpDay As String, ByRef strYears As String, Optional strProperty As String, Optional strPayYears As String, Optional strCaseType As String, Optional strPayType As String) As Boolean
'Dim strSql As String, rsRecordset As New ADODB.Recordset, strTemp As String
'
'On Error GoTo HndErr
'   Select Case intChoose
'      Case 1
'         strSql = "select na06,na21,na07,na20"
'      Case 2
'         strSql = "select na08,na23,na09,na22"
'      Case 3
'         strSql = "select na10,na25,na11,na24"
'      Case 4
'         strSql = "select na26,na27"
'      Case 5
'         strSql = "select na28,na29"
'      Case 6
'         strSql = "select na30,na31"
'      Case 7
'         strSql = "select na32,na33"
'      Case 8
'         strSql = "select na34,na35"
'      Case 9
'         strSql = "select na36,na37"
'      Case 10
'         strSql = "select na12,na13"
'   End Select
'   strSql = strSql + " from nation where na01=" + CNULL(strNation)
'   rsRecordset.CursorLocation = adUseClient
'   rsRecordset.Open strSql, cnnConnection
'   If rsRecordset.RecordCount > 0 Then
'      strStartUpDay = IIf(IsNull(rsRecordset.Fields(0)), "", rsRecordset.Fields(0))
'      strYears = IIf(IsNull(rsRecordset.Fields(1)), "", rsRecordset.Fields(1))
'      If rsRecordset.Fields.Count = 4 Then
'         strPayYears = IIf(IsNull(rsRecordset.Fields(2)), "", rsRecordset.Fields(2))
'         strTemp = IIf(IsNull(rsRecordset.Fields(3)), "", rsRecordset.Fields(3))
'         strCaseType = strTemp
'         strPayType = IIf(IsNull(rsRecordset.Fields(0)), "", rsRecordset.Fields(0))
'      End If
'   End If
'   '91.12.22 MODIFY BY SONIA
'   'If (rsRecordset.Fields.Count = 2 And strYears = "") Or (rsRecordset.Fields.Count = 4 And strYears = "" And strTemp <> strProperty) Then
'   If (rsRecordset.Fields.Count = 2 And strPayYears = "") Or (rsRecordset.Fields.Count = 4 And strPayYears = "") Then
'   '91.12.22 END
'      ShowMsg MsgText(9104)
'   Else
'      GetNationTaxEx = True
'   End If
'   rsRecordset.Close
'   Exit Function
'HndErr:
'End Function

'Add by Morgan 2008/12/25
'表單顯示狀態切換
Public Sub PUB_ChangeCaption(oForm As Form, iMode As Integer)
Dim strCaption As String
   
   strCaption = oForm.Caption
   strCaption = Replace(strCaption, "(新增)", "")
   strCaption = Replace(strCaption, "(修改)", "")
   strCaption = Replace(strCaption, "(查詢)", "")
   Select Case iMode
      Case 1
         strCaption = strCaption & "(新增)"
      Case 2
         strCaption = strCaption & "(修改)"
      Case 4
         strCaption = strCaption & "(查詢)"
   End Select
   oForm.Caption = strCaption
End Sub
'Add by Morgan 2009/2/19 設定系統變數
Public Function PUB_SetSystemVar() As Boolean
   Dim stVarName As String, ii As Integer
   Dim stDefVar As String 'Added by Lydia 2024/07/22
   Dim strTmpB As String 'Added by Lydia 2025/08/01
   
On Error GoTo ErrHnd
   
   'Added by Morgan 2017/9/6
   stVarName = "正式資料庫電腦名稱"
   正式資料庫電腦名稱 = ""
   CheckOC3
   AdoRecordSet3.CursorLocation = adUseClient
   AdoRecordSet3.Open "select oMan from SetSpecMan  where oCode='正式資料庫電腦名稱'", cnnConnection, adOpenStatic, adLockReadOnly
   正式資料庫電腦名稱 = AdoRecordSet3.Fields(0)
   
   stVarName = "目前連線資料庫名稱"
   pub_DbTerminalName = ""
   CheckOC3
   AdoRecordSet3.CursorLocation = adUseClient
   AdoRecordSet3.Open "select TERMINAL FROM V$SESSION where SID=1", cnnConnection, adOpenStatic, adLockReadOnly
   pub_DbTerminalName = AdoRecordSet3.Fields(0)
   'end 2017/9/6

   stVarName = "FCP電子檔存放路徑"
   EFilePath = ""
   CheckOC3
   AdoRecordSet3.CursorLocation = adUseClient
   AdoRecordSet3.Open "select oMan from SetSpecMan  where oCode='EFilePath'", cnnConnection, adOpenStatic, adLockReadOnly
   EFilePath = AdoRecordSet3.Fields(0)
   
   'Added by Morgan 2013/7/29
   stVarName = "FCP電子送件檔案存放路徑"
   FCP電子送件檔案存放路徑 = ""
   CheckOC3
   AdoRecordSet3.CursorLocation = adUseClient
   AdoRecordSet3.Open "select oMan from SetSpecMan  where oCode='FCP電子送件檔案存放路徑'", cnnConnection, adOpenStatic, adLockReadOnly
   FCP電子送件檔案存放路徑 = AdoRecordSet3.Fields(0)
   'end 2013/7/29
   
   stVarName = "FCT電子檔存放路徑"
   FCTeFilePath = ""
   CheckOC3
   AdoRecordSet3.CursorLocation = adUseClient
   AdoRecordSet3.Open "select oMan from SetSpecMan  where oCode='FCTeFilePath'", cnnConnection, adOpenStatic, adLockReadOnly
   FCTeFilePath = AdoRecordSet3.Fields(0)
   
   'Add By Sindy 2012/1/11
   stVarName = "T電子檔存放路徑"
   TeFilePath = ""
   CheckOC3
   AdoRecordSet3.CursorLocation = adUseClient
   AdoRecordSet3.Open "select oMan from SetSpecMan  where oCode='TeFilePath'", cnnConnection, adOpenStatic, adLockReadOnly
   TeFilePath = AdoRecordSet3.Fields(0)
   '2012/1/11 End
   
   stVarName = "FCL電子檔存放路徑"
   FCLeFilePath = ""
   CheckOC3
   AdoRecordSet3.CursorLocation = adUseClient
   AdoRecordSet3.Open "select oMan from SetSpecMan  where oCode='FCLeFilePath'", cnnConnection, adOpenStatic, adLockReadOnly
   FCLeFilePath = AdoRecordSet3.Fields(0)
   
   stVarName = "往來記錄附件存放路徑"
   往來記錄附件存放路徑 = ""
   CheckOC3
   AdoRecordSet3.CursorLocation = adUseClient
   AdoRecordSet3.Open "select oMan from SetSpecMan  where oCode='往來記錄附件存放路徑'", cnnConnection, adOpenStatic, adLockReadOnly
   往來記錄附件存放路徑 = AdoRecordSet3.Fields(0)
   
   'Add By Sindy 2011/6/10
   stVarName = "法務案開庭紀要存放路徑"
   法務案開庭紀要存放路徑 = ""
   CheckOC3
   AdoRecordSet3.CursorLocation = adUseClient
   AdoRecordSet3.Open "select oMan from SetSpecMan  where oCode='法務案開庭紀要存放路徑'", cnnConnection, adOpenStatic, adLockReadOnly
   法務案開庭紀要存放路徑 = AdoRecordSet3.Fields(0)
   
   'Add By Sindy 2012/3/19
   stVarName = "不得代理案件存放路徑"
   不得代理案件存放路徑 = ""
   CheckOC3
   AdoRecordSet3.CursorLocation = adUseClient
   AdoRecordSet3.Open "select oMan from SetSpecMan  where oCode='不得代理案件存放路徑'", cnnConnection, adOpenStatic, adLockReadOnly
   不得代理案件存放路徑 = AdoRecordSet3.Fields(0)
   
   'Added by Morgan 2012/4/13
   stVarName = "案件進度附件存放路徑"
   案件進度附件存放路徑 = ""
   CheckOC3
   AdoRecordSet3.CursorLocation = adUseClient
   AdoRecordSet3.Open "select oMan from SetSpecMan  where oCode='案件進度附件存放路徑'", cnnConnection, adOpenStatic, adLockReadOnly
   案件進度附件存放路徑 = AdoRecordSet3.Fields(0)
   
   'Add By Sindy 2012/12/22 CF代理人報價附件存放路徑
   stVarName = "CF代理人報價附件存放路徑"
   CF代理人報價附件存放路徑 = ""
   CheckOC3
   AdoRecordSet3.CursorLocation = adUseClient
   AdoRecordSet3.Open "select oMan from SetSpecMan  where oCode='CF代理人報價附件存放路徑'", cnnConnection, adOpenStatic, adLockReadOnly
   CF代理人報價附件存放路徑 = AdoRecordSet3.Fields(0)
   '2012/12/22 End
  
   'Added by Lydia 2017/12/04
   'Mark by Lydia 2023/10/12 改用原始檔區存放
   'stVarName = "FCP命名追蹤暫存"
   'FCP命名追蹤暫存 = ""
   'CheckOC3
   'AdoRecordSet3.CursorLocation = adUseClient
   'AdoRecordSet3.Open "select oMan from SetSpecMan  where oCode='FCP命名追蹤暫存'", cnnConnection, adOpenStatic, adLockReadOnly
   'FCP命名追蹤暫存 = AdoRecordSet3.Fields(0)
   'end 2023/10/12
   'Remove by Lydia 2021/12/06 (109/4/6)已將\\Typing2的"English_Vers"和"專利案件"的案件資料夾，全部搬到原始檔區
   'stVarName = "FCP命名追蹤收文區"
   'FCP命名追蹤收文區 = ""
   'CheckOC3
   'AdoRecordSet3.CursorLocation = adUseClient
   'AdoRecordSet3.Open "select oMan from SetSpecMan  where oCode='FCP命名追蹤收文區'", cnnConnection, adOpenStatic, adLockReadOnly
   'FCP命名追蹤收文區 = AdoRecordSet3.Fields(0)
   'end 2021/12/06
   'end 2017/12/04

   'Add by Morgan 2009/4/16
   stVarName = "非英語系國家"
   NoneEngCountry = ""
   CheckOC3
   AdoRecordSet3.CursorLocation = adUseClient
   AdoRecordSet3.Open "select na01 from nation  where na59='N' order by 1", cnnConnection, adOpenStatic, adLockReadOnly
   NoneEngCountry = AdoRecordSet3.GetString(, , , ",")
   If Right(NoneEngCountry, 1) = "," Then NoneEngCountry = Left(NoneEngCountry, Len(NoneEngCountry) - 1)
   
   'FTP_IP
   stVarName = "FTP Server IP"
   FTP_IP = ""
   CheckOC3
   AdoRecordSet3.CursorLocation = adUseClient
   AdoRecordSet3.Open "select oMan from SetSpecMan  where oCode='FTP_IP'", cnnConnection, adOpenStatic, adLockReadOnly
   FTP_IP = AdoRecordSet3.Fields(0)
   
   'Add by Morgan 2019/3/15
   'Removed by Morgan 2021/7/19 改為常數，刪除系統特殊設定
   'stVarName = "專利處108考核啟用日"
   'PUB_108RuleDate = ""
   'CheckOC3
   'AdoRecordSet3.CursorLocation = adUseClient
   'AdoRecordSet3.Open "select NVL(Max(oMan),'20990101') from SetSpecMan  where oCode='" & stVarName & "'", cnnConnection, adOpenStatic, adLockReadOnly
   'PUB_108RuleDate = AdoRecordSet3.Fields(0)
   'end 2021/7/19
   
   'Added by Lydia 2019/04/10
   stVarName = "T案收文齊備排除"
   T案收文齊備排除 = ""
   CheckOC3
   AdoRecordSet3.CursorLocation = adUseClient
   AdoRecordSet3.Open "select oMan from SetSpecMan  where oCode='T案收文齊備排除'", cnnConnection, adOpenStatic, adLockReadOnly
   T案收文齊備排除 = AdoRecordSet3.Fields(0)
   
   'Added by Lydia 2019/10/05 利益衝突案件
   stVarName = "XY特殊權限範圍"
   XY特殊權限範圍 = ""
   CheckOC3
   AdoRecordSet3.CursorLocation = adUseClient
   'Modified by Lydia 2025/08/01 增加關聯企業(CFR01=前6碼)的判斷
   'AdoRecordSet3.Open "SELECT distinct(CFR01) as CFR01 FROM CUFA_RIGHT ", cnnConnection, adOpenStatic, adLockReadOnly
   strTmpB = "SELECT DISTINCT(CFR01) AS CFR01 FROM CUFA_RIGHT WHERE cfr03='M51' and LENGTH(cfr01)=8 " & _
             "UNION SELECT DISTINCT(cu01) AS cfr01 FROM customer WHERE substr(cu01,1,6) IN (SELECT cfr01 FROM cufa_right WHERE LENGTH(cfr01)=6 GROUP BY cfr01) " & _
             "UNION SELECT DISTINCT(fa01) AS cfr01 FROM fagent WHERE substr(fa01,1,6) IN (SELECT cfr01 FROM cufa_right WHERE LENGTH(cfr01)=6 GROUP BY cfr01)"
   AdoRecordSet3.Open strTmpB, cnnConnection, adOpenStatic, adLockReadOnly
   'end 2025/08/01
   If AdoRecordSet3.RecordCount > 0 Then XY特殊權限範圍 = AdoRecordSet3.GetString(adClipString, , , ",")
   
   'Added by 2024/07/22 更換FTP路徑
   stVarName = "FTP_VOL_IP_SALE1"
   stDefVar = ""
   CheckOC3
   AdoRecordSet3.CursorLocation = adUseClient
   AdoRecordSet3.Open "select oMan from SetSpecMan  where oCode=" & CNULL(stVarName), cnnConnection, adOpenStatic, adLockReadOnly
   stDefVar = AdoRecordSet3.Fields(0)
   strTFeeForm = "\\" & stDefVar & "\XFER\FEE_FORM"  'T案繳費單存放路徑 Added by Morgan 2018/11/30
   strTApp1CasePath = "\\" & stDefVar & "\商標客戶專區"  'T案商標客戶專區路徑 Add By Sindy 2023/3/28
   str_T_OrderPath = "\\" & stDefVar & "\tm_order_scan" 'Modify By Sindy 2022/10/25
   str_FCT_OrderPath = "\\" & stDefVar & "\FCT_Order_SCAN" 'Modify By Sindy 2022/10/25
   str_ACS_OrderPath = "\\" & stDefVar & "\ACS01_Order_SCAN" 'Modify By Sindy 2022/10/25
   strSale1Path = stDefVar 'SALE1的DNS名稱
   '--------------------------------------
   stVarName = "FTP_VOL_IP_PAT1"
   stDefVar = ""
   CheckOC3
   AdoRecordSet3.CursorLocation = adUseClient
   AdoRecordSet3.Open "select oMan from SetSpecMan  where oCode=" & CNULL(stVarName), cnnConnection, adOpenStatic, adLockReadOnly
   stDefVar = AdoRecordSet3.Fields(0)
   strDocImportPath = "\\" & stDefVar & "\OA_SCAN" '公文來函電子檔匯入預設路徑 Added by Morgan 2014/5/20
   str_P_OrderPath = "\\" & stDefVar & "\Order_SCAN" 'Modify By Sindy 2022/10/25
   str_CFP_OrderPath = "\\" & stDefVar & "\CFP_Order_SCAN" 'Modify By Sindy 2022/10/25
   str_P_台灣電子送件檔案路徑 = "\\" & stDefVar & "\Te資料暫存區\(勿刪)台灣電子送件檔案" 'Modify By Sindy 2022/10/25
   strPat1Path = stDefVar 'PAT1的DNS名稱
   '--------------------------------------
   stVarName = "FTP_TYPING2"
   stDefVar = ""
   CheckOC3
   AdoRecordSet3.CursorLocation = adUseClient
   AdoRecordSet3.Open "select oMan from SetSpecMan  where oCode=" & CNULL(stVarName), cnnConnection, adOpenStatic, adLockReadOnly
   stDefVar = AdoRecordSet3.Fields(0)
   strTyping2Path = stDefVar 'Typing2的DNS名稱
   'end 2024/07/22
   
   'Added by Lydia 2022/11/15 自訂色彩0~5: 0=淡綠色,1=淡橙色,2=淡青色,3=淡黃色,4=青綠色,5=紫紅色
   stVarName = "自訂色彩"
   PGColor = Array(&H80FF80, &H80C0FF, &HFFFF80, &H80FFFF, &HFFD0&, &HFF80FF)
 
   'Add by Morgan 2009/11/12
   stVarName = "系統別對照資料"
   CheckOC3
   With AdoRecordSet3
   .CursorLocation = adUseClient
   .Open "select sk01,sk02 from systemkind order by 2,1", cnnConnection, adOpenStatic, adLockReadOnly
   Erase pub_SysKind
   Do While Not .EOF
      ii = Val("" & .Fields("sk02"))
      If ii > 0 And ii < 6 Then
         pub_SysKind(ii) = pub_SysKind(ii) & .Fields("sk01") & ","
      End If
      .MoveNext
   Loop
   End With
   
   'Added by Morgan 2014/5/9
   '設定合併程式完整路徑,名稱
   pub_PdftkName = "pdftk.exe"
   If Dir(App.path & "\" & pub_PdftkName) <> "" Then
      pub_PdftkEXE = """" & App.path & "\" & pub_PdftkName & """"
   Else
      pub_PdftkEXE = pub_PdftkName
   End If
   
   pub_OS_Ver = PUB_GetVersionNo 'Added by Morgan 2016/10/19
   'Added by Morgan 2016/10/21
   bolWin7ENloaded = False
   If Val(pub_OS_Ver) > 6 Then
      bolWin7ENloaded = IsImeLoaded(&H4090409)
'Removed by Morgan 2016/10/28 先取消,還要再討論
'      'Memo by Morgan 2016/10/27 載入EN輸入法會造成無法複製中文內容(貼出會變亂碼), 目前已針對共同查詢的中日文案件名稱及備註切換為中文輸入法,若有其他中文欄位需要複製內容時再逐一修改。
'      If bolWin7ENloaded = False Then
'         '載入 EN 輸入法
'         If LoadKeyboardLayout("00000409", 0) <> 0 Then
'            '重新檢查
'            bolWin7ENloaded = IsImeLoaded(&H4090409)
'         End If
'      End If
'      'end 2016/10/24
   End If
   'end 2016/10/21
   
   'Add by Amy 2021/06/21 避免居家刪到別人的檔案,故改路徑
   strExcelPath = PUB_Getdesktop & "\xls\"
   strExcelPathN = "「桌面的 xls資料夾」"
   'end 2021/06/21
   'Memo by Lydia 2021/07/01 檢查xls資料夾的模組 Pub_ChkExcelPath
   
   PUB_SetSystemVar = True
   
   'Modified by Morgan 2019/1/9 取消,Word都已改新版(且檢查有時會有巨集錯誤)--經理
   'SetWordRefVer
   pub_Word2Pdf = True
   'end 2019/1/9
    
ErrHnd:
   If Err.Number <> 0 Then
      'MsgBox Err.Description
      MsgBox "系統變數【" & stVarName & "】設定失敗將會影響部分作業，請通知電腦中心!"
      Resume Next
   End If
   
End Function

'Added by Lydia 2021/07/01 檢查xls資料夾 或傳入路徑的資料夾是否存在
Public Sub Pub_ChkExcelPath(Optional ByRef pFilePath As String)
Dim tmpArr1 As Variant, intR1 As Integer, strMidPath As String 'Added by Lydia 2023/09/21

     If pFilePath = "" Then pFilePath = strExcelPath
     'Added by Lydia 2025/04/16
     Dim strOldPath As String
     strOldPath = pFilePath
     'end 2025/04/16
    
     pFilePath = IIf(Right(pFilePath, 1) = "\", Mid(pFilePath, 1, Len(pFilePath) - 1), pFilePath)
     If Dir(pFilePath, vbDirectory) = "" Then
        'Modified by Lydia 2023/09/21
        'MkDir pFilePath
        tmpArr1 = Split(pFilePath, "\")
        For intR1 = 0 To UBound(tmpArr1)
           If Trim(tmpArr1(intR1)) <> "" Then
              strMidPath = strMidPath & IIf(strMidPath <> "", "\", "") & tmpArr1(intR1)
              If Dir(strMidPath, vbDirectory) = "" Then
                 MkDir strMidPath
              End If
           End If
        Next intR1
        'end 2023/09/21
     End If
     'Added by Lydia 2025/04/16
     If Right(strOldPath, 1) = "\" Then
        pFilePath = pFilePath & "\"
     End If
     
End Sub


'Added by Morgan 2017/9/15
'Modified by Morgan 2017/9/27 Word97調整(不關 Word App 避免彈出訊息)
'Modified by Morgan 2017/9/29 紀錄PDFCreator在Word的印表機名稱(在此一併處理以免單獨跑 Word97 會在關閉時彈出訊息)
'Modified by Morgan 2017/10/6 有些電腦切換控制台印表機有問題取消 PDFCreator在Word的印表機名稱 的設定,另 pub_Word2Pdf 也改只有特定部門要設
Private Sub SetWordRefVer()
   Static bolDone As Boolean
   Dim oWordApp As Word.Application
   Dim strOsDefaultPrinter As String
   Dim strCreatorName As String, intCreatorId As Integer
   
On Error GoTo ErrHnd
   
   If Not bolDone And Val(pub_OS_Ver) >= 6 And InStr("M51,M31,F12,F22,P12,P22", Pub_StrUserSt03) > 0 Then
      Set oWordApp = New Word.Application
      If Val(oWordApp.Version) >= 12 Then
         pub_Word2Pdf = True
      End If
      
      If Val(oWordApp.Version) >= 9 Then
         oWordApp.Quit wdDoNotSaveChanges
      Else
         Set g_WordAp = oWordApp
      End If
      bolDone = True
   End If
   
ErrHnd:
   Set oWordApp = Nothing
   
End Sub

'Add By Cheng 2003/12/11
'取得商品類別數
'2009/3/4 MOVE BY SONIA 自Frmacc21h1移出
'Modify by Morgan 2011/3/4 + bolExists35 :是否包含第 35 類
Public Function GetTMKindCnt(strTM01 As String, strTM02 As String, strTM03 As String, strTM04 As String, Optional ByRef bolExists35 As Boolean) As Integer
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset

bolExists35 = False
GetTMKindCnt = 0
StrSQLa = "Select TM09 From Trademark Where " & ChgTradeMark(strTM01 & strTM02 & strTM03 & strTM04)
rsA.CursorLocation = adUseClient
rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
If rsA.RecordCount > 0 Then
    If "" & rsA.Fields(0).Value = "" Then
        GetTMKindCnt = 1
    Else
        GetTMKindCnt = UBound(Split("" & rsA.Fields(0).Value, ",")) + 1
        If InStr("," & rsA.Fields(0) & ",", ",35,") > 0 Then
            bolExists35 = True
        End If
    End If
End If
If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing
End Function

'Add By Sindy 98/03/25
'是否經發文室 (內商提說沒有合併案件發文,不需顯示同案件同時段多筆發文設定的小視窗)
' index=1 主管機關
' index=2 非主管機關
Public Function GetCPMSendYn(ByRef Strindex As String, ByRef StrIndex2 As String, ByRef Index As Integer) As String
CheckOC3
GetCPMSendYn = ""
strSql = "SELECT CPM21,CPM22 FROM CASEPROPERTYMAP WHERE CPM01='" & Strindex & "' AND CPM02='" & StrIndex2 & "' "
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
   If Index = 1 Then
      If Not IsNull(AdoRecordSet3.Fields(0)) Then
         GetCPMSendYn = AdoRecordSet3.Fields(0)
      End If
   ElseIf Index = 2 Then
      If Not IsNull(AdoRecordSet3.Fields(1)) Then
         GetCPMSendYn = AdoRecordSet3.Fields(1)
      End If
   End If
End If
CheckOC3
End Function

'Add By Sindy 98/04/09
'僅一項商品類別時, 才顯示商品名稱(超過1個用•••), 反之不顯示
'Modify By Sindy 106/10/30 Optional strCP10 As String = ""
Public Function GetTMGoods(tm01 As String, tm02 As String, tm03 As String, tm04 As String, _
      Optional strCP10 As String = "") As String
Dim lngPos As Long, ii As Integer
Dim lngItem1 As Long, lngItem2 As Long, lngItem3 As Long
Dim strData As String
Dim strTmp As String, intA As Integer, rsAD As New ADODB.Recordset  'Added by Lydia 2024/05/14

   'Modify By Sindy 2017/10/30 + 增加排除未延展商品(and tg18 is null)
   If strCP10 = "102" Then
      strData = " and tg18 is null"
   Else
      strData = ""
   End If
   '2017/10/30 END
   strTmp = "select tg05,tg06,tg07,tg08,tg15,tg16,tg17" & _
               " from tmgoods" & _
               " where tg01='" & tm01 & "' and tg02='" & tm02 & "'" & _
               " and tg03='" & tm03 & "' and tg04='" & tm04 & "'" & strData & _
               " order by tg05"
   intA = 1
   Set rsAD = ClsLawReadRstMsg(intA, strTmp)
   GetTMGoods = ""
   If rsAD.RecordCount = 1 Then
      'rsad.MoveFirst
      'GetTMGoods = vbCrLf
      'GetTMGoods = "商品名稱："
      'Do While Not rsad.EOF
         lngPos = 1
         strData = Trim(CheckStr(rsAD.Fields("TG06").Value) & CheckStr(rsAD.Fields("TG15").Value) & CheckStr(rsAD.Fields("TG07").Value) & CheckStr(rsAD.Fields("TG16").Value) & CheckStr(rsAD.Fields("TG08").Value) & CheckStr(rsAD.Fields("TG17").Value))
         For ii = 1 To 1
            lngItem1 = InStr(lngPos, strData, "、")
            lngItem2 = InStr(lngPos, strData, "，")
            lngItem3 = InStr(lngPos, strData, "；")
            If lngItem1 <> 0 And lngItem2 <> 0 Then
               If lngItem1 > lngItem2 Then
                  lngItem1 = lngItem2
               End If
            Else
               If lngItem1 = 0 Then lngItem1 = lngItem2
            End If
            If lngItem1 <> 0 And lngItem3 <> 0 Then
               If lngItem1 > lngItem3 Then
                  lngItem1 = lngItem3
               End If
            Else
               If lngItem1 = 0 Then lngItem1 = lngItem3
            End If
            '取商品名稱
            If lngItem1 = 0 Then
               GetTMGoods = strData
               Exit For
            Else
               If ii = 1 Then
                  If Mid(strData, lngItem1, 1) = "。" And lngItem1 = Len(strData) Then
                     GetTMGoods = strData
                     Exit For
                  End If
                  GetTMGoods = GetTMGoods & Mid(strData, lngPos, lngItem1 - lngPos) & "•••"
               Else
                  GetTMGoods = GetTMGoods & Mid(strData, lngPos, lngItem1 - lngPos + 1)
               End If
               lngPos = lngItem1 + 1
            End If
         Next ii
         'rsad.MoveNext
      'Loop
   End If
   
   Set rsAD = Nothing 'Added by Lydia 2024/05/14
End Function

'Add By Sindy 98/04/09
Public Function GetPicColor(tm01 As String, tm02 As String, tm03 As String, tm04 As String) As String
Dim strTmp As String, intA As Integer, rsAD As New ADODB.Recordset  'Added by Lydia 2024/05/14

   'Modify by Amy 2018/08/03 加彩色代表圖格式 ibf05=2
   'Modify By Sindy 2018/10/31 TF馬德里商標圖檔-子案的圖同母案
   '固定都以IBF01=tm01 AND IBF02=substr(tm02,1,5)||'0' AND IBF03='0' AND IBF04='00' 去抓代表圖
   If tm01 = "TF" Then
      strTmp = "SELECT ibf06 FROM imgbytefile WHERE ibf01='" & tm01 & "' and ibf02='" & Mid(tm02, 1, 5) & "0" & "' And ibf03='0' And ibf04='00' " & _
                        "and( ( ibf05='1' and ibf06 in('2','4')) or (ibf05='2') )"
   Else
   '2018/10/31 END
      strTmp = "SELECT ibf06 FROM imgbytefile WHERE ibf01='" & tm01 & "' and ibf02='" & tm02 & "' and ibf03='" & tm03 & "' and ibf04='" & tm04 & "' " & _
                        "and( ( ibf05='1' and ibf06 in('2','4')) or (ibf05='2') )"
   End If
   intA = 1
   Set rsAD = ClsLawReadRstMsg(intA, strTmp)
   GetPicColor = ""
   If intA = 1 Then
'      If Not IsNull(rsad.Fields(0).Value) Then
'         If rsad.Fields(0).Value = "2" Or rsad.Fields(0).Value = "4" Then
            GetPicColor = "(彩色圖)"
'         End If
'      End If
   End If
   'end 2018/08/03
   Set rsAD = Nothing 'Added by Lydia 2024/05/14
End Function

'Add by Morgan 2009/5/12
'檢查是否已有提申期限
Public Function PUB_ChkFileNP(ByVal p_CP09 As String, Optional ByVal p_CP10 As String = "'995','996','997','998'") As Boolean
   Dim stSQL As String, ii As Integer, adoRst As ADODB.Recordset
   
   stSQL = "select * from nextprogress where np01='" & p_CP09 & "' and np06 is null and np07 in (" & p_CP10 & ")"
   ii = 1
   Set adoRst = ClsLawReadRstMsg(ii, stSQL)
   If ii = 1 Then
      PUB_ChkFileNP = True
   End If
End Function

'Modify By Sindy 2025/9/18
', Optional ByVal pStrPath As String = "": 檔案的路徑
Public Sub PUB_KillTempFile(pFileName As String, Optional ByVal pStrPath As String = "")
Dim TmpFileName As String  'Added by Lydia 2020/02/19

   On Error Resume Next
   
   'Modified by Lydia 2020/02/19 改用迴圈
   'If Dir(App.path & "\" & pFileName) <> "" Then
   '   Kill App.path & "\" & pFileName
   'End If
   
   'Modify By Sindy 2025/9/18
   If Trim(pStrPath) <> "" Then
      pStrPath = Trim(pStrPath)
      If Right(pStrPath, 1) <> "\" Then
         pStrPath = pStrPath & "\"
      End If
      TmpFileName = Dir(pStrPath & pFileName)
   Else
      pStrPath = App.path & "\"
   '2025/9/18 END
      TmpFileName = Dir(pStrPath & pFileName)
   End If
   Do While TmpFileName <> ""
      '改檔案性質為一般(因為原始檔區開啟檔案,都設唯讀)
      If InStr(pFileName, "\") > 0 Then
          SetAttr pStrPath & Mid(pFileName, 1, InStrRev(pFileName, "\")) & TmpFileName, vbNormal
          Kill pStrPath & Mid(pFileName, 1, InStrRev(pFileName, "\")) & TmpFileName
      Else
          SetAttr pStrPath & TmpFileName, vbNormal
          Kill pStrPath & TmpFileName
      End If
      TmpFileName = Dir()
   Loop
   'end 2020/02/19
End Sub


'Added by Morgan 2017/3/20
'Modified by Morgan 2020/2/20 +pPath
Public Sub PUB_KillTempFolder(pFolderName As String, Optional pPath As String)
   Dim fso
   On Error Resume Next
   If pPath = "" Then pPath = App.path
   Set fso = CreateObject("Scripting.FileSystemObject") '建立FileSystemObject
   'Modified by Morgan 2020/2/20
   'fso.DeleteFolder App.path & "\" & pFolderName, True
   fso.DeleteFolder pPath & "\" & pFolderName, True
   Set fso = Nothing
End Sub

'Modify By Sindy 2011/6/10 +開庭紀要
Public Sub PUB_OpenFtpFile(ByVal stDocNo As String, ByVal stFileName As String, Optional oWinSock As Winsock, Optional strFileKind As String = "1", Optional bolOpenFile As Boolean = True, Optional ByRef strFilePath As String)
   Dim hOpen As Long
   Dim hConnection As Long
   Dim hLocalFile As Long
   Dim bReturn As Boolean
   Dim dwInternetFlags As Integer
   Dim stDir As String
   Dim stRemoteFile As String
   Dim stLocalFile As String
   Dim IsTimeOut As Boolean
   Dim SeekTimer
   Dim ACT_FTP_IP As String
   Dim arrIP
   Dim ii As Integer
   Dim strFileKindName As String 'Add By Sindy 2011/6/10
   
On Error GoTo OutPort

   'Added by Morgan 2012/4/13
   If oWinSock Is Nothing Then
      Set oWinSock = Forms(0).Winsock1
   End If
   'end 2012/4/13
   
   'Modify By Sindy 2011/6/10
   'stDir = 往來記錄附件存放路徑
   'Modify By Sindy 2012/3/19 +不得代理案件
   If strFileKind = "1" Then '往來記錄
      stDir = 往來記錄附件存放路徑
      strFileKindName = "往來記錄"
   ElseIf strFileKind = "2" Then '開庭紀要
      stDir = 法務案開庭紀要存放路徑
      strFileKindName = "開庭紀要"
   ElseIf strFileKind = "3" Then '不得代理案件
      stDir = 不得代理案件存放路徑
      strFileKindName = "不得代理案件"
   'Add By Sindy 2012/12/22
   ElseIf strFileKind = "4" Then 'CF代理人報價附件
      stDir = CF代理人報價附件存放路徑
      strFileKindName = "CF代理人報價"
   'Added by Morgan 2012/4/13
   Else
      stDir = strFileKind
      strFileKindName = strFileKind
   'end 2012/4/13
   End If
   
   If stFileName <> "" Then
      If InStrRev(stFileName, " (") > 0 Then
         'Add By Sindy 2021/8/6 排除 C:\Program Files (x86) 狀況
         If UCase(Mid(stFileName, InStrRev(stFileName, " (") + 1, Len("(X86)"))) <> "(X86)" Then
         '2021/8/6 END
            stFileName = Left(stFileName, InStrRev(stFileName, " (") - 1)
         End If
      End If
      stRemoteFile = stFileName
      'Modify by Morgan 2009/11/19 改用亂數
      stLocalFile = App.path & "\$$" & stFileName
      ii = 0
      Do While Dir(stLocalFile) <> ""
         stLocalFile = App.path & "\$$" & Int(99 * Rnd) & stFileName
         ii = ii + 1
         If ii > 99 Then
            MsgBox "暫存檔建立失敗！"
            GoTo OutPort
         End If
      Loop
      
      If hOpen = 0 Then
         hOpen = InternetOpen("Taie FTP", INTERNET_OPEN_TYPE_DIRECT, vbNullString, vbNullString, 0)
         If hOpen = 0 Then
            MsgBox "網路錯誤！"
            GoTo OutPort
         Else
            IsTimeOut = True
            If GOOD_FTP_IP <> "" Then
               arrIP = Split(GOOD_FTP_IP & ";" & FTP_IP, ";")
            Else
               arrIP = Split(FTP_IP, ";")
            End If
            For ii = LBound(arrIP) To UBound(arrIP)
               ACT_FTP_IP = arrIP(ii)
               If ACT_FTP_IP <> "" Then
                  '偵測 FTPServer 是否存在
                  If oWinSock.State Then oWinSock.Close
                  oWinSock.Connect ACT_FTP_IP, 21
                  IsTimeOut = False
                  SeekTimer = Timer
                  Do While oWinSock.State = 6 And IsTimeOut = False
                     DoEvents
                     If Timer - SeekTimer > 1 Then
                        IsTimeOut = True
                     End If
                  Loop
                  If oWinSock.State Then oWinSock.Close
                  If IsTimeOut = False Then
                     Exit For
                  End If
               End If
            Next
            
            '若是超過時間
            If IsTimeOut = True Then
               'Modify By Sindy 2023/2/18 +(IsTimeOut) 方便知道是那裡回傳的錯誤
               MsgBox "無法與FTP Server建立連線！(PUB_OpenFtpFile: IsTimeOut = True)"
               GoTo OutPort
            Else
               GOOD_FTP_IP = ACT_FTP_IP
            End If
        
            hConnection = InternetConnect(hOpen, ACT_FTP_IP, FTP_Port, _
               "pgmid", "pgmpwd", INTERNET_SERVICE_FTP, INTERNET_FLAG_PASSIVE, 0)
            If hConnection = 0 Then
               'Modify By Sindy 2023/2/18 +(InternetConnect) 方便知道是那裡回傳的錯誤
               MsgBox "無法與FTP Server建立連線！(PUB_OpenFtpFile: hConnection = 0)"
               GoTo OutPort
            ElseIf FtpSetCurrentDirectory(hConnection, stDir) = False Then
               'Modify By Sindy 2011/6/10
               'MsgBox "往來記錄目錄不存在！"
               MsgBox strFileKindName & "目錄不存在！"
               GoTo OutPort
            '切換至往來記錄單號目錄
            ElseIf FtpSetCurrentDirectory(hConnection, stDocNo) = False Then
               'Modify By Sindy 2011/6/10
               'MsgBox "往來記錄單號目錄不存在！"
               MsgBox strFileKindName & "單號目錄不存在！"
               GoTo OutPort
            End If
         End If
      End If
      
      'Modified by Morgan 2018/8/3 +強制重新下載參數(INTERNET_FLAG_RELOAD)
      'Modify By Sindy 2018/8/3
      'dwInternetFlags = FTP_TRANSFER_TYPE_BINARY
      dwInternetFlags = &H2 'INTERNET_FLAG_TRANSFER_BINARY
      dwInternetFlags = dwInternetFlags + &H80000000 'INTERNET_FLAG_RELOAD
      bReturn = FtpGetFile(hConnection, stRemoteFile, stLocalFile, False, FILE_ATTRIBUTE_ARCHIVE, dwInternetFlags, 0)
      ' Download successfully
      If bReturn = False Then
         MsgBox "檔案讀取失敗！"
         GoTo OutPort
      End If
      If bolOpenFile = True Then 'Modify By Sindy 2011/6/13 +if
         ShellExecute hLocalFile, "open", stLocalFile, vbNullString, vbNullString, 3
      Else
         strFilePath = stLocalFile 'Add By Sindy 2011/6/13 回傳完整路徑檔名
      End If
   End If
   
OutPort:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
   If hOpen <> 0 Then InternetCloseHandle (hOpen)
   If hConnection <> 0 Then InternetCloseHandle (hConnection)
   If oWinSock.State Then oWinSock.Close
   
End Sub

'Add by Morgan 2009/6/2
'修正VB的ROUND為四捨六入五留雙改為一般的四捨五入
Public Function Round(ByVal dblNumber As Double, Optional ByVal intFactor As Integer = 0) As Double
    Round = Fix(CDbl(dblNumber * 10 ^ intFactor + 0.5 * Sgn(dblNumber))) / 10 ^ intFactor
End Function
'Added by Morgan 2013/1/3
'可指定第幾位數後捨去(Fix函數改良版)
Public Function Trunc(ByVal dblNumber As Double, Optional ByVal intFactor As Integer = 0) As Double
    'Modified by Morgan 2024/6/25 修正4.467會變4.466999問題 (應該是Fix的引數型態轉換造成)
    'Trunc = Fix(CDbl(dblNumber * 10 ^ intFactor)) / 10 ^ intFactor
    Trunc = Fix(CStr(dblNumber * 10 ^ intFactor)) / 10 ^ intFactor
    'end 2024/6/25
End Function

'Add By Sindy 2009/06/29
'取得專利年費案件性質
'Modified by Morgan 2022/6/13 +strPA10
Public Function PUB_GetNa20Na22Na24(ByVal strPA09 As String, ByVal strPA08 As String, Optional ByVal strPA10 As String) As String
   Dim stSQL As String, ii As Integer, adoRst As ADODB.Recordset
   
   PUB_GetNa20Na22Na24 = ""
   
   'Added by Morgan 2022/6/13
   '俄羅斯設計案2015/1/1以前提申案件除了延展費外仍要繳年費(繳費紀錄為年費)
   If strPA09 = "023" And strPA08 = "3" And Val(strPA10) > 0 And Val(strPA10) < 20150101 Then
      PUB_GetNa20Na22Na24 = "605"
      Exit Function
   End If
   'end 2022/6/13
   
   Select Case strPA08
   Case "1" '發明
      stSQL = "select na20 from Nation where na01='" & strPA09 & "' "
   Case "2" '新型
      stSQL = "select na22 from Nation where na01='" & strPA09 & "' "
   Case "3" '設計
      stSQL = "select na24 from Nation where na01='" & strPA09 & "' "
   End Select
   ii = 1
   Set adoRst = ClsLawReadRstMsg(ii, stSQL)
   If ii = 1 Then
      PUB_GetNa20Na22Na24 = "" & adoRst.Fields(0)
   End If
End Function

'Add By Sindy 2009/06/29
'取得年費年度說明
Public Function PUB_GetYF15(strYF01 As String, strYF02 As String, strYF03 As String, strYF04 As String, dbYF05 As Double) As String
'strYF01 : 申請國家
'strYF02 : 專利種類
'strYF03 : 代理人
'strYF04 : 案件性質
'dbYF05 : 年度

Dim StrSQLa As String
Dim rsA As New ADODB.Recordset

PUB_GetYF15 = ""

'StrSQLa = "Select YF15 From PatentYearFee Where YF01='" & strYF01 & "' AND YF02='" & strYF02 & "' AND YF03='" & strYF03 & "' AND YF04='" & strYF04 & "' AND YF05 = " & dbYF05
StrSQLa = "Select YF15 From PatentYearFee Where YF01='" & strYF01 & "' AND YF02='" & strYF02 & "' AND instr(YF03,'" & strYF03 & "')>0 AND YF04='" & strYF04 & "' AND YF05 = " & dbYF05
If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing
rsA.CursorLocation = adUseClient
rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
If rsA.RecordCount > 0 Then
   PUB_GetYF15 = "" & rsA.Fields(0).Value
End If
If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing
End Function

'Add By Sindy 2009/06/29
'從frm050312的Getnexttimes移過來
'抓下次繳費次數
'Modified by Morgan 2022/6/9 +m_CP10
Public Function PUB_Getnexttimes(m_NP02 As String, m_NP03 As String, m_NP04 As String, m_NP05 As String, ByRef strYear As String, Optional ByRef m_PA91 As String = "", Optional ByVal m_CP10 As String) As String
   Dim strPA08 As String
   Dim strPA09 As String
   Dim strPA10 As String, strCP10 As String 'Added by Morgan 2022/6/15
   Dim strPA72 As String
   Dim varPA72 As Variant
   Dim varRef As Variant
   Dim strKey(5) As String
   Dim strCaseFee(1 To 2) As String
   Dim bFind As Boolean
   Dim ii As Integer
   Dim strTmp As String, intA As Integer, rsAD As New ADODB.Recordset  'Added by Lydia 2024/05/14
   
   PUB_Getnexttimes = ""
   'Modified by Morgan 2022/6/15 +PA10
   strTmp = "SELECT PA08,PA09,PA72,PA91,PA10 FROM PATENT WHERE PA01='" & m_NP02 & "' And PA02='" & m_NP03 & "' AND PA03='" & m_NP04 & "' AND PA04='" & m_NP05 & "'"
   intA = 1
   Set rsAD = ClsLawReadRstMsg(intA, strTmp) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(inta, strtmp)
   If intA = 1 Then
      If IsNull(rsAD.Fields("PA08")) = False Then strPA08 = rsAD.Fields("PA08")
      If IsNull(rsAD.Fields("PA09")) = False Then strPA09 = rsAD.Fields("PA09")
      If IsNull(rsAD.Fields("PA72")) = False Then strPA72 = rsAD.Fields("PA72")
      strPA10 = "" & rsAD.Fields("PA10") 'Added by Morgan 2022/6/15
      m_PA91 = "" & rsAD.Fields("PA91") 'Add by Morgan 2008/4/30
      strKey(0) = ""
      strKey(1) = m_NP02
      strKey(2) = m_NP03
      strKey(3) = m_NP04
      strKey(4) = m_NP05
      'Modified by Morgan 2022/6/9 +m_CP10
      bFind = GetMoneyDate(strPA08, strPA09, strKey, strCaseFee(1), strCaseFee(2), , m_CP10)
      If bFind Then
      
         'Added by Morgan 2022/6/15 若繳費性質與設定性質不同時表示繳費紀錄並非本次要繳費性質的紀錄,紀錄清空白讓程式回傳第1次
         strCP10 = PUB_GetNa20Na22Na24(strPA09, strPA08, strPA10)
         If m_CP10 <> "" And strCP10 <> m_CP10 Then
            strPA72 = ""
         End If
         'end 2022/6/15
         
         '尋找下次繳費的位置
         '若已有繳費記錄
         If IsEmptyText(strPA72) = False Then
              varPA72 = Split(strPA72, ",")
              If IsEmptyText(strCaseFee(2)) = False Then
                 varRef = Split(strCaseFee(2), ",")
                 For ii = LBound(varRef) To UBound(varRef)
                       If Val(varPA72(UBound(varPA72))) < Val(varRef(ii)) Then
                            strYear = Val(varRef(ii))
                            PUB_Getnexttimes = ii + 1
                            Exit For
                       End If
                 Next ii
              End If
          '若無繳費記錄
          Else
              If IsEmptyText(strCaseFee(2)) = False Then
                  'Add By Sindy 2009/07/16
                  varRef = Split(strCaseFee(2), ",")
                  strYear = Val(varRef(0))
                  '2009/07/16 End
                  PUB_Getnexttimes = 1
              End If
         End If
      End If
   End If
   
   Set rsAD = Nothing 'Added by Lydia 2024/05/14
   
End Function

'Add By Sindy 2009/07/03
'取得商品名稱
Public Function GetGoodsName(tm01 As String, tm02 As String, tm03 As String, tm04 As String) As String
Dim strTmp As String, intA As Integer, rsAD As New ADODB.Recordset  'Added by Lydia 2024/05/14

   strTmp = "select tg05,nvl(tg06,'') as tg06,nvl(tg07,'') as tg07,nvl(tg08,'') as tg08,nvl(tg15,'') as tg15,nvl(tg16,'') as tg16,nvl(tg17,'') as tg17 from tmgoods where tg01='" & tm01 & "' and tg02='" & tm02 & "' and tg03='" & tm03 & "' and tg04='" & tm04 & "' order by tg05 "
   intA = 1
   Set rsAD = ClsLawReadRstMsg(intA, strTmp)
   GetGoodsName = ""
   If rsAD.RecordCount = 1 Then
      rsAD.MoveFirst
      Do While Not rsAD.EOF
         GetGoodsName = GetGoodsName & Trim(rsAD.Fields("TG06").Value) & _
                                      Trim(rsAD.Fields("TG15").Value) & _
                                      Trim(rsAD.Fields("TG07").Value) & _
                                      Trim(rsAD.Fields("TG16").Value) & _
                                      Trim(rsAD.Fields("TG08").Value) & _
                                      Trim(rsAD.Fields("TG17").Value)
         rsAD.MoveNext
      Loop
   End If
   Set rsAD = Nothing 'Added by Lydia 2024/05/14
End Function

'Move from frm88005 by Morgan 2009/8/19
'add by nickc 2006/08/18 檢查收件者，若是已經離職，則改發該部門最小編號者，若是沒有，改發秀玲---秀玲 mail 提的
'Rem by Morgan 2009/2/23 若規則有改時 AutoBatchDay 也要同步
'Modify By Sindy 2019/4/25 因董事長無收到作業系統發的E-Mail，請協助處理。
'                          發現,因董事長在系統裡是設定不寄信 + Optional ByVal bol63001CanSend As Boolean = False
Public Function ChkMailId(oOldMailID, Optional ByVal bol63001CanSend As Boolean = False) As String
Dim strST93 As String, strST15 As String 'Added by Lydia 2024/06/18

   ChkMailId = ""
   Dim oStrSQL As String
   Dim MailRS As New ADODB.Recordset
   '先檢查是否為員工
   oStrSQL = "select * from staff where st01='" & Replace(UCase(oOldMailID), "@TAIE.COM.TW", "") & "' "
   Set MailRS = New ADODB.Recordset
   MailRS.CursorLocation = adUseClient
   MailRS.Open oStrSQL, cnnConnection, adOpenStatic, adLockReadOnly
   If MailRS.RecordCount <> 0 Then
       '檢查在不在職
       'edit by nickc 2007/09/20 虛建智權人員也發給主管
       'oStrSQL = "select * from staff where st01='" & Replace(UCase(oOldMailID), "@TAIE.COM.TW", "") & "' and st04='1' "
       oStrSQL = "select * from staff where st01='" & Replace(UCase(oOldMailID), "@TAIE.COM.TW", "") & "' and st04='1' and st01>'63' "
       Set MailRS = New ADODB.Recordset
       MailRS.CursorLocation = adUseClient
       MailRS.Open oStrSQL, cnnConnection, adOpenStatic, adLockReadOnly
       If MailRS.RecordCount <> 0 Then
         'Modify by Morgan 2010/6/3
         'ChkMailId = oOldMailID
         If Not IsNull(MailRS("st14")) Then  'st14內部郵件收件員工編號
            'Modify By Sindy 2019/4/25
            If oOldMailID = "63001" Then
               If bol63001CanSend = True And MailRS("st14") = "99997" Then
                  ChkMailId = oOldMailID
               Else
                  ChkMailId = MailRS("st14")
               End If
            Else
            '2019/4/25 END
               ChkMailId = MailRS("st14")
            End If
         Else
            ChkMailId = oOldMailID
         End If
       Else
       '已離職
           '2011/4/13 add by sonia 離職智權人員先發給在職的帶人主管 吳邑君收文CFP-023894已會稿完成
           'Modified by Lydia 2024/06/18
           oStrSQL = "select s2.st01,s3.st01,s4.st01,s5.st01,s1.st93 ,s1.st15 from staff s1,staff s2,staff s3,staff s4,staff s5 where s1.st01='" & Replace(UCase(oOldMailID), "@TAIE.COM.TW", "") & "' " & _
                     "and s1.st52=s2.st01(+) and s2.st04(+)='1' and s1.st53=s3.st01(+) and s3.st04(+)='1' " & _
                     "and s1.st54=s4.st01(+) and s4.st04(+)='1' and s1.st55=s5.st01(+) and s5.st04(+)='1' "
           Set MailRS = New ADODB.Recordset
           MailRS.CursorLocation = adUseClient
           MailRS.Open oStrSQL, cnnConnection, adOpenStatic, adLockReadOnly
           If MailRS.RecordCount <> 0 Then
              If Not IsNull(MailRS(0)) Then
                 ChkMailId = MailRS(0)
              ElseIf Not IsNull(MailRS(1)) Then
                 ChkMailId = MailRS(1)
              ElseIf Not IsNull(MailRS(2)) Then
                 ChkMailId = MailRS(2)
              ElseIf Not IsNull(MailRS(3)) Then
                 ChkMailId = MailRS(3)
              End If
              'Added by Lydia 2024/06/18
              strST93 = "" & MailRS.Fields("st93")
              strST15 = "" & MailRS.Fields("st15")
              'end 2024/06/18
           End If
           If ChkMailId = "" Then
           '2011/4/13 end
           
               'edit by nickc 2007/03/27 改成 st03
               'oStrSQL = "select min(st01) from staff where st15=(select st15 from staff where st01='" & Replace(UCase(oOldMailID), "@TAIE.COM.TW", "") & "' ) and st04='1' and st01>'63001' "
               'edit by nickc 2007/08/16 改抓部門檔的主管
               'oStrSQL = "select min(st01) from staff where st03=(select st03 from staff where st01='" & Replace(UCase(oOldMailID), "@TAIE.COM.TW", "") & "' ) and st04='1' and st01>'63001' "
               'edit by nickc 2007/09/20 虛建智權人員也發給主管
               'oStrSQL = "select a0908 from acc090 where a0901=(select st15 from staff where st01='" & Replace(UCase(oOldMailID), "@TAIE.COM.TW", "") & "' ) and st04='1' and st01>'63001' "
               'Modify by Morgan 2009/2/10 語法錯誤
               'oStrSQL = "select a0908 from acc090 where a0901=(select st15 from staff where st01='" & Replace(UCase(oOldMailID), "@TAIE.COM.TW", "") & "' ) and st04='1'  "
               'Modified by Lydia 2024/06/18 抓部門主管A0908時，改為若有ST93則抓ACC090NEW的A0924，沒有ST93才以ST15抓A0908
               'oStrSQL = "select a0908 from acc090 where a0901=(select st15 from staff where st01='" & Replace(UCase(oOldMailID), "@TAIE.COM.TW", "") & "' )"
               oStrSQL = "select a0908,1 as ord1 from acc090 where a0901='" & strST15 & "' "
               If strST93 <> "" Then
                  oStrSQL = oStrSQL & " union select a0924,0 as ord1 from acc090new where a0921='" & strST93 & "' "
               End If
               oStrSQL = oStrSQL & " order by ord1 "
               'end 2024/06/18
               Set MailRS = New ADODB.Recordset
               MailRS.CursorLocation = adUseClient
               MailRS.Open oStrSQL, cnnConnection, adOpenStatic, adLockReadOnly
               If MailRS.EOF And MailRS.BOF Then
                   '完全沒有
                   ChkMailId = Pub_GetSpecMan("程式管理人員")
               Else
                   MailRS.MoveFirst 'Added by Lydia 2024/06/18
                   ChkMailId = CheckStr(MailRS.Fields(0))
               End If
           End If  '2011/4/13 ADD BY SONIA
       End If
   Else
       ChkMailId = oOldMailID
   End If
   Set MailRS = Nothing
End Function

'2009/10/23 ADD BY SONIA 帳單輸入檢查
'1.此案號第一筆收文號是否已輸過帳單(若舊系統有帳單表示第一筆收文號已輸過)
'2.此收文號是否已輸滿5張帳單,不可再輸入帳單
'3.此收文號已輸過帳單
'4.此收文號有虧損
'5.此案號有虧損
'6.FMP案件單獨提醒操作人員影印帳單交國外部,不列入主管審核原因
Public Function ChkACC150(strCP01 As String, strCP02 As String, strCP03 As String, strCP04 As String, strCP09 As String, strYes As Boolean, strAXF04 As Variant, strTWAmount As Double, strCurr As String) As Boolean
Dim adoacc150 As New ADODB.Recordset
Dim adoquery As New ADODB.Recordset
Dim adoaccsum As New ADODB.Recordset
Dim strYesMSG As String         '需主管審核原因
Dim m_CP09 As String            '第一筆收文之總收文號
Dim m_OldPay As String          '舊系統台幣帳單金額
Dim m_strProfit As String       '案件目前盈虧
Dim m_ProcessProfit As String   '此收文號盈虧

   ChkACC150 = False
   m_CP09 = ""
   strYes = False

On Error GoTo Checking
   If adoacc150.State = adStateOpen Then
      adoacc150.Close
   End If
   adoacc150.CursorLocation = adUseClient
   If strCon1 <> "" Then
       adoacc150.Open "select cp09,cp05 from caseprogress, casepropertymap, fagent " & _
                    " where cp01 = cpm01 and cp10 = cpm02 and substr(cp44, 1, 8) = fa01 (+) and substr(cp44, 9, 1) = fa02 (+) and ((cp61 <> '" & strCon8 & "' or cp61 is null) and (cp62 <> '" & strCon8 & "' or cp62 is null) and (cp63 <> '" & strCon8 & "' or cp63 is null) and (cp87 <> '" & strCon8 & "' or cp87 is null) and (cp88 <> '" & strCon8 & "' or cp88 is null)) and (substr(cp60, 1, 1) = 'E' or cp60 is null) and cp01 = '" & strCP01 & "' and cp02 = '" & strCP02 & "' and cp03 = '" & strCP03 & "' and cp04 = '" & strCP04 & "' and UPPER(NVL(fa05||fa63||fa64||fa65,FA04)) like UPPER('" & Replace(strCon1, "'", "''") & _
                    "%') union " & _
                    "select cp09,cp05 from caseprogress, casepropertymap, fagent, acc1k0 " & _
                    " where cp01 = cpm01 and cp10 = cpm02 and substr(cp44, 1, 8) = fa01 (+) and substr(cp44, 9, 1) = fa02 (+) and cp60 = a1k01 (+) and ((cp61 <> '" & strCon8 & "' or cp61 is null) and (cp62 <> '" & strCon8 & "' or cp62 is null) and (cp63 <> '" & strCon8 & "' or cp63 is null) and (cp87 <> '" & strCon8 & "' or cp87 is null) and (cp88 <> '" & strCon8 & "' or cp88 is null)) and (substr(cp60, 1, 1) = 'X') and cp01 = '" & strCP01 & "' and cp02 = '" & strCP02 & "' and cp03 = '" & strCP03 & "' and cp04 = '" & strCP04 & "' and UPPER(NVL(fa05||fa63||fa64||fa65,FA04)) like UPPER('" & Replace(strCon1, "'", "''") & _
                    "%') order by CP05 DESC,cp09 DEsc", adoTaie, adOpenStatic, adLockReadOnly
   Else
      If strCustNo <> "" Then
          adoacc150.Open "select cp09,cp05 from caseprogress, casepropertymap, fagent " & _
                      " where cp01 = cpm01 and cp10 = cpm02 and substr(cp44, 1, 8) = fa01 (+) and substr(cp44, 9, 1) = fa02 (+) and ((cp61 <> '" & strCon8 & "' or cp61 is null) and (cp62 <> '" & strCon8 & "' or cp62 is null) and (cp63 <> '" & strCon8 & "' or cp63 is null) and (cp87 <> '" & strCon8 & "' or cp87 is null) and (cp88 <> '" & strCon8 & "' or cp88 is null)) and (substr(cp60, 1, 1) = 'E' or cp60 is null) and cp01 = '" & strCP01 & "' and cp02 = '" & strCP02 & "' and cp03 = '" & strCP03 & "' and cp04 = '" & strCP04 & "' and fa01 = '" & Mid(strCustNo, 1, 8) & "' and fa02 = '" & Mid(strCustNo, 9, 1) & "' union " & _
                       "select cp09,cp05 from caseprogress, casepropertymap, fagent, acc1k0 " & _
                       " where cp01 = cpm01 and cp10 = cpm02 and substr(cp44, 1, 8) = fa01 (+) and substr(cp44, 9, 1) = fa02 (+) and cp60 = a1k01 (+) and ((cp61 <> '" & strCon8 & "' or cp61 is null) and (cp62 <> '" & strCon8 & "' or cp62 is null) and (cp63 <> '" & strCon8 & "' or cp63 is null) and (cp87 <> '" & strCon8 & "' or cp87 is null) and (cp88 <> '" & strCon8 & "' or cp88 is null)) and (substr(cp60, 1, 1) = 'X') and cp01 = '" & strCP01 & "' and cp02 = '" & strCP02 & "' and cp03 = '" & strCP03 & "' and cp04 = '" & strCP04 & "' and fa01 = '" & Mid(strCustNo, 1, 8) & "' and fa02 = '" & Mid(strCustNo, 9, 1) & _
                       "' order by CP05 DESC,cp09 DEsc", adoTaie, adOpenStatic, adLockReadOnly
      Else
          adoacc150.Open "select cp09,cp05 from caseprogress, casepropertymap, fagent " & _
                       " where cp01 = cpm01 and cp10 = cpm02 and substr(cp44, 1, 8) = fa01 (+) and substr(cp44, 9, 1) = fa02 (+) and ((cp61 <> '" & strCon8 & "' or cp61 is null) and (cp62 <> '" & strCon8 & "' or cp62 is null) and (cp63 <> '" & strCon8 & "' or cp63 is null) and (cp87 <> '" & strCon8 & "' or cp87 is null) and (cp88 <> '" & strCon8 & "' or cp88 is null)) and (substr(cp60, 1, 1) = 'E' or cp60 is null) and cp01 = '" & strCP01 & "' and cp02 = '" & strCP02 & "' and cp03 = '" & strCP03 & "' and cp04 = '" & strCP04 & "' union " & _
                       "select cp09,cp05 from caseprogress, casepropertymap, fagent, acc1k0 " & _
                       " where cp01 = cpm01 and cp10 = cpm02 and substr(cp44, 1, 8) = fa01 (+) and substr(cp44, 9, 1) = fa02 (+) and cp60 = a1k01 (+) and ((cp61 <> '" & strCon8 & "' or cp61 is null) and (cp62 <> '" & strCon8 & "' or cp62 is null) and (cp63 <> '" & strCon8 & "' or cp63 is null) and (cp87 <> '" & strCon8 & "' or cp87 is null) and (cp88 <> '" & strCon8 & "' or cp88 is null)) and (substr(cp60, 1, 1) = 'X') and cp01 = '" & strCP01 & "' and cp02 = '" & strCP02 & "' and cp03 = '" & strCP03 & "' and cp04 = '" & strCP04 & "' order by CP05 DESC,cp09 DEsc", adoTaie, adOpenStatic, adLockReadOnly
      End If
   End If

   If adoacc150.RecordCount > 0 Then
      adoacc150.MoveLast
      adoquery.CursorLocation = adUseClient
      adoquery.Open "select cp61 from caseprogress where cp09 = '" & adoacc150.Fields("cp09").Value & "' and cp61 is not null", adoTaie, adOpenStatic, adLockReadOnly
      If adoquery.RecordCount = 0 Then
         strYes = True
         m_CP09 = adoacc150.Fields("cp09").Value
         strYesMSG = "最小收文號尚未輸過帳單"
      End If
      adoquery.Close
   Else
      GoTo OtherCheck
   End If

   If adoacc150.State = adStateOpen Then
      adoacc150.Close
   End If
   adoacc150.CursorLocation = adUseClient
   adoacc150.Open "select cp09, nvl(cp16,0) - nvl(cp77,0) as RecAmount, decode(cp88, null, decode(cp87, null, decode(cp63, null, decode(cp62, null, decode(cp61, null, 0, 1), 2), 3), 4), 5) as PayCount, decode(cp77, 0, nvl(cp18, 0), null, nvl(cp18, 0), DECODE((CP16-CP77),0,0, (CP16-CP77) / 1000)) as cp18,CP31,cp12,cp05 from caseprogress " & _
                " where cp09='" & strCP09 & "' and (substr(cp60, 1, 1) = 'E' or cp60 is null) and cp01 = '" & strCP01 & "' and cp02 = '" & strCP02 & "' and cp03 = '" & strCP03 & "' and cp04 = '" & strCP04 & "' union " & _
                "select cp09, sum(nvl(a1l05,0)) as RecAmount, decode(cp88, null, decode(cp87, null, decode(cp63, null, decode(cp62, null, decode(cp61, null, 0, 1), 2), 3), 4), 5) as PayCount, sum(DECODE(A1L04,CP10,nvl(a1l05,0),0))/1000 as cp18,CP31,cp12,cp05 from caseprogress,acc1l0,acc1k0 " & _
                " where cp09='" & strCP09 & "' and substr(cp60, 1, 1) = 'X' and cp60=a1k01(+) and cp60=a1l01(+) and cp10=substr(a1l04,1,length(cp10)) and cp01 = '" & strCP01 & "' and cp02 = '" & strCP02 & "' and cp03 = '" & strCP03 & "' and cp04 = '" & strCP04 & "' " & _
                "group by cp60,cp09, decode(cp88, null, decode(cp87, null, decode(cp63, null, decode(cp62, null, decode(cp61, null, 0, 1), 2), 3), 4), 5),CP31,cp12,cp05 ", adoTaie, adOpenStatic, adLockReadOnly

'1.此案號第一筆收文號是否已輸過帳單()
   If adoacc150.Fields("cp09").Value = m_CP09 Then
      strYes = False
      strYesMSG = ""
   End If

   '案件損益    'strAXF04本次帳單金額
   If CalculateProfit(strCP01, strCP02, strCP03, strCP04, m_OldPay, m_strProfit, strAXF04, strCurr) = False Then Exit Function
   
   '若舊系統有帳單表示第一筆收文號已輸過
   If Val(m_OldPay) > 0 Then
      strYes = False
      strYesMSG = ""
   End If

'2.此收文號是否已輸滿5張帳單,不可再輸入帳單
   If IsNull(adoacc150.Fields("PayCount").Value) = False Then
      If Val(adoacc150.Fields("PayCount").Value) > 4 Then
         ChkACC150 = True
         MsgBox MsgText(205), , MsgText(5)
         Exit Function
      End If
   End If

'3.此收文號已輸過帳單
   If adoacc150.Fields("PayCount").Value > 0 Then
      strYes = True
      If strYesMSG = "" Then
         strYesMSG = "此收文號已輸過帳單"
      Else
         strYesMSG = strYesMSG & ",此收文號已輸過帳單"
      End If
   End If

'4.此收文號有虧損
   If CalculateProcessProfit(strCP09, m_ProcessProfit, strAXF04, strTWAmount, strCurr) = False Then Exit Function
   If Val(m_ProcessProfit) < 0 Then                    '此收文號有虧損
      strYes = True
      If strYesMSG = "" Then
         strYesMSG = "此收文號有虧損"
      Else
         strYesMSG = strYesMSG & ",此收文號有虧損"
      End If
   End If

'5.此案號有虧損
   If Val(m_strProfit) < 0 Then
      strYes = True
      If strYesMSG = "" Then
         strYesMSG = "此案號目前有虧損"
      Else
         strYesMSG = strYesMSG & ",此案號目前有虧損"
      End If
   End If

   If strYes Then
      MsgBox strYesMSG & "！" & MsgText(187), , MsgText(5)
   End If

OtherCheck:
'6.FMP案件單獨提醒操作人員影印帳單交國外部,不列入主管審核原因
   If Mid(adoacc150.Fields("cp12").Value, 1, 1) = "F" And InStr(1, strCP01, "P") > 0 Then
      MsgBox "請影印帳單交國外部請款！"
   End If

Checking:
   If Err.Number = 0 Then
      Exit Function
   End If
   MsgBox Err.Description, , MsgText(5)

End Function
'2009/10/23 END

'2009/10/26 add by sonia 計算案件盈虧
'strOldPay 舊系統台幣帳單金額
'strProfit 目前盈虧
Public Function CalculateProfit(strCP01 As String, strCP02 As String, strCP03 As String, strCP04 As String, ByRef strOldPay As String, ByRef strProfit As String, strAXF04 As Variant, strCurr As String) As Boolean
Dim adoquery As New ADODB.Recordset
Dim adoaccsum As New ADODB.Recordset
Dim adocal As New ADODB.Recordset
Dim adoloop As New ADODB.Recordset
Dim m_CurrRate As Long    '目前預估匯率

On Error GoTo Checking

   CalculateProfit = True

   '????測試外對外案件CFT-009367及行事曆
   
   '舊系統帳單金額
   adoquery.CursorLocation = adUseClient
   Select Case strCP01
      Case "TF"   '母子案一起算,但領土延伸分開算
         adoquery.Open "select sum(nvl(a1520, 0)) from acc151, acc150 where axf01 = a1501 and axf02 = '000000000' and INSTR(axf03,'" & strCP01 & strCP02 & "')=1 ", adoTaie, adOpenStatic, adLockReadOnly
      Case "CFP"  '僅EPC母子案一起算,接續案及集體設計個別計算
         adoquery.Open "select sum(nvl(a1520, 0)) from acc151, acc150 where axf01 = a1501 and axf02 = '000000000' and INSTR(axf03,'" & strCP01 & strCP02 & strCP03 & "')=1 ", adoTaie, adOpenStatic, adLockReadOnly
      Case Else
         adoquery.Open "select sum(nvl(a1520, 0)) from acc151, acc150 where axf01 = a1501 and axf02 = '000000000' and axf03 = '" & strCP01 & strCP02 & strCP03 & strCP04 & "' ", adoTaie, adOpenStatic, adLockReadOnly
   End Select
   If adoquery.RecordCount <> 0 Then
      If IsNull(adoquery.Fields(0).Value) Then
         strOldPay = "0"
      Else
         strOldPay = adoquery.Fields(0).Value
      End If
   Else
      strOldPay = "0"
   End If
   adoquery.Close

   strProfit = MsgText(601)
   m_CurrRate = 1
   
   If adoaccsum.State = adStateOpen Then
      adoaccsum.Close
   End If
   adoaccsum.CursorLocation = adUseClient
   '2009/11/24 加註by sonia 本次帳單以最新的預估結匯匯率計算
   adoaccsum.Open "select a2103 from acc210 where a2102 = '" & strCurr & "' and a2101 = (select max(a2101) from acc210 where a2102 = '" & strCurr & "' and a2101 <= " & strSrvDate(2) & ")", adoTaie, adOpenStatic, adLockReadOnly
   If adoaccsum.RecordCount <> 0 Then
      m_CurrRate = Val(adoaccsum.Fields("a2103").Value)
   End If
   adoaccsum.Close
   
   'strAXF04本次帳單金額
   strProfit = Val(strProfit) - (Val(strAXF04) * m_CurrRate)

'2009/11/25 MODIFY BY SONIA 改寫法,否則一請款單對多收文號且有雜費時無法正確計算
'   If adocal.State = adStateOpen Then
'      adocal.Close
'   End If
'   adocal.CursorLocation = adUseClient
'   adocal.Open "select cp09, decode(cpm01, 'FCP', cpm03, 'FCT', cpm03, 'FCL', cpm03, 'LIN', cpm03, cpm04) as PropertyName, nvl(cp05 - 19110000, 0) as cp05, nvl(cp27 - 19110000, 0) as cp27, cp44, nvl(fa05||fa63||fa64||fa65, nvl(fa04, fa06)) as FagentName, nvl(cp16,0) - nvl(cp77,0) as RecAmount, decode(cp88, null, decode(cp87, null, decode(cp63, null, decode(cp62, null, decode(cp61, null, 0, 1), 2), 3), 4), 5) as PayCount, decode(cp77, 0, nvl(cp18, 0), null, nvl(cp18, 0), DECODE((CP16-CP77),0,0, (CP18-(nvl(cp77,0) / 1000)))) as cp18,CP31,CP64 from caseprogress, casepropertymap, fagent " & _
'               " where cp01 = cpm01 and cp10 = cpm02 and substr(cp44, 1, 8) = fa01 (+) and substr(cp44, 9, 1) = fa02 (+) and ((cp61 <> '" & strCon8 & "' or cp61 is null) and (cp62 <> '" & strCon8 & "' or cp62 is null) and (cp63 <> '" & strCon8 & "' or cp63 is null) and (cp87 <> '" & strCon8 & "' or cp87 is null) and (cp88 <> '" & strCon8 & "' or cp88 is null)) and (substr(cp60, 1, 1) = 'E' or cp60 is null) and cp01 = '" & strCP01 & "' and cp02 = '" & strCP02 & "' and cp03 = '" & strCP03 & "' and cp04 = '" & strCP04 & "' union " & _
'               "select cp09, decode(cpm01, 'FCP', cpm03, 'FCT', cpm03, 'FCL', cpm03, 'LIN', cpm03, cpm04) as PropertyName, nvl(cp05 - 19110000, 0) as cp05, nvl(cp27 - 19110000, 0) as cp27, cp44, nvl(fa05||fa63||fa64||fa65, nvl(fa04, fa06)) as FagentName, NVL(nvl(a1k30, A1K11),0) as RecAmount, decode(cp88, null, decode(cp87, null, decode(cp63, null, decode(cp62, null, decode(cp61, null, 0, 1), 2), 3), 4), 5) as PayCount, decode(cp77, 0, nvl(cp18, 0), null, nvl(cp18, 0), DECODE((CP16-CP77),0,0, (CP18-(nvl(cp77,0) / 1000)))) as cp18,CP31,CP64 from caseprogress, casepropertymap, fagent, acc1k0 " & _
'               " where cp01 = cpm01 and cp10 = cpm02 and substr(cp44, 1, 8) = fa01 (+) and substr(cp44, 9, 1) = fa02 (+) and cp60 = a1k01 (+) and ((cp61 <> '" & strCon8 & "' or cp61 is null) and (cp62 <> '" & strCon8 & "' or cp62 is null) and (cp63 <> '" & strCon8 & "' or cp63 is null) and (cp87 <> '" & strCon8 & "' or cp87 is null) and (cp88 <> '" & strCon8 & "' or cp88 is null)) and (substr(cp60, 1, 1) = 'X') and cp01 = '" & strCP01 & "' and cp02 = '" & strCP02 & "' and cp03 = '" & strCP03 & "' and cp04 = '" & strCP04 & "' order by CP05 DESC,cp09 asc", adoTaie, adOpenStatic, adLockReadOnly
'   Set adoloop = adocal.Clone
'   adoloop.MoveFirst
'   Do While adoloop.EOF = False
'         If Val(adoloop.Fields("RecAmount").Value) = 0 Then
'            strProfit = Val(strProfit)
'         Else
'            strProfit = Val(strProfit) + adoloop.Fields("RecAmount").Value
'            If IsNull(adoloop.Fields("cp18").Value) = False Then
'               strProfit = Val(strProfit) - (Val(adoloop.Fields("cp18").Value) * 1000)
'            End If
'         End If
'         If adoquery.State = adStateOpen Then
'            adoquery.Close
'         End If
'         adoquery.CursorLocation = adUseClient
'         adoquery.Open "select a1505, a1502, sum(decode(a1507, null, nvl(NVL(AXF04*decode(A1906,0,null,A1906),axf15), 0), 0)) as PayAmount from acc151, acc150, ACC190 where axf01 = a1501 AND AXF01=A1902(+) and axf02 = '" & adoloop.Fields("cp09").Value & "' group by a1505, a1502", adoTaie, adOpenStatic, adLockReadOnly
'         Do While adoquery.EOF = False
'            If IsNull(adoquery.Fields("PayAmount").Value) = False Then
'                  strProfit = Val(strProfit) - Val(adoquery.Fields("PayAmount").Value)
'            End If
'            adoquery.MoveNext
'         Loop
'         adoquery.Close
'      adoloop.MoveNext
'   Loop
   
   '國內收據及國外請款單之收入-(點數*1000)
   If adocal.State = adStateOpen Then
      adocal.Close
   End If
   adocal.CursorLocation = adUseClient
   'adocal.Open "select cp09, decode(cpm01, 'FCP', cpm03, 'FCT', cpm03, 'FCL', cpm03, 'LIN', cpm03, cpm04) as PropertyName, nvl(cp05 - 19110000, 0) as cp05, nvl(cp27 - 19110000, 0) as cp27, cp44, nvl(fa05||fa63||fa64||fa65, nvl(fa04, fa06)) as FagentName, nvl(cp16,0) - nvl(cp77,0) as RecAmount, decode(cp88, null, decode(cp87, null, decode(cp63, null, decode(cp62, null, decode(cp61, null, 0, 1), 2), 3), 4), 5) as PayCount, decode(cp77, 0, nvl(cp18, 0), null, nvl(cp18, 0), DECODE((CP16-CP77),0,0, (CP16-CP77) / 1000)) as cp18,CP31,CP64 from caseprogress, casepropertymap, fagent " & _
               " where cp01 = cpm01 and cp10 = cpm02 and substr(cp44, 1, 8) = fa01 (+) and substr(cp44, 9, 1) = fa02 (+) and ((cp61 <> '" & strCon8 & "' or cp61 is null) and (cp62 <> '" & strCon8 & "' or cp62 is null) and (cp63 <> '" & strCon8 & "' or cp63 is null) and (cp87 <> '" & strCon8 & "' or cp87 is null) and (cp88 <> '" & strCon8 & "' or cp88 is null)) and (substr(cp60, 1, 1) = 'E' or cp60 is null) and cp01 = '" & strCP01 & "' and cp02 = '" & strCP02 & "' and cp03 = '" & strCP03 & "' and cp04 = '" & strCP04 & "' union " & _
               "select cp09, decode(cpm01, 'FCP', cpm03, 'FCT', cpm03, 'FCL', cpm03, 'LIN', cpm03, cpm04) as PropertyName, nvl(cp05 - 19110000, 0) as cp05, nvl(cp27 - 19110000, 0) as cp27, cp44, nvl(fa05||fa63||fa64||fa65, nvl(fa04, fa06)) as FagentName, NVL(nvl(a1k30, A1K11),0) as RecAmount, decode(cp88, null, decode(cp87, null, decode(cp63, null, decode(cp62, null, decode(cp61, null, 0, 1), 2), 3), 4), 5) as PayCount, decode(cp77, 0, nvl(cp18, 0), null, nvl(cp18, 0), DECODE((CP16-CP77),0,0, (CP16-CP77) / 1000)) as cp18,CP31,CP64 from caseprogress, casepropertymap, fagent, acc1k0 " & _
               " where cp01 = cpm01 and cp10 = cpm02 and substr(cp44, 1, 8) = fa01 (+) and substr(cp44, 9, 1) = fa02 (+) and cp60 = a1k01 (+) and ((cp61 <> '" & strCon8 & "' or cp61 is null) and (cp62 <> '" & strCon8 & "' or cp62 is null) and (cp63 <> '" & strCon8 & "' or cp63 is null) and (cp87 <> '" & strCon8 & "' or cp87 is null) and (cp88 <> '" & strCon8 & "' or cp88 is null)) and (substr(cp60, 1, 1) = 'X') and cp01 = '" & strCP01 & "' and cp02 = '" & strCP02 & "' and cp03 = '" & strCP03 & "' and cp04 = '" & strCP04 & "' order by CP05 DESC,cp09 asc", adoTaie, adOpenStatic, adLockReadOnly
   Select Case strCP01
      Case "TF"   '母子案一起算,但領土延伸分開算
         adocal.Open "select cp09, nvl(cp16,0) - nvl(cp77,0) as RecAmount, decode(cp77, 0, nvl(cp18, 0), null, nvl(cp18, 0), DECODE((CP16-CP77),0,0, (CP16-X.A1U07-CP17) / 1000)) as cp18 from caseprogress, " & _
                     "(SELECT A1U03,SUM(A1U07) A1U07 FROM ACC1U0,CASEPROGRESS WHERE CP09=A1U03 and cp01 = '" & strCP01 & "' and cp02 = '" & strCP02 & "' GROUP BY A1U03) X " & _
                     " where ((cp61 <> '" & strCon8 & "' or cp61 is null) and (cp62 <> '" & strCon8 & "' or cp62 is null) and (cp63 <> '" & strCon8 & "' or cp63 is null) and (cp87 <> '" & strCon8 & "' or cp87 is null) and (cp88 <> '" & strCon8 & "' or cp88 is null)) and (substr(cp60, 1, 1) = 'E' or cp60 is null) AND CP09=X.A1U03(+) and cp01 = '" & strCP01 & "' and cp02 = '" & strCP02 & "' union " & _
                     "select cp09, NVL(nvl(a1k30, A1K11),0) as RecAmount, nvl(cp18, 0) as cp18 from caseprogress, acc1k0 " & _
                     " where cp60 = a1k01 (+) and ((cp61 <> '" & strCon8 & "' or cp61 is null) and (cp62 <> '" & strCon8 & "' or cp62 is null) and (cp63 <> '" & strCon8 & "' or cp63 is null) and (cp87 <> '" & strCon8 & "' or cp87 is null) and (cp88 <> '" & strCon8 & "' or cp88 is null)) and (substr(cp60, 1, 1) = 'X') and cp01 = '" & strCP01 & "' and cp02 = '" & strCP02 & "' " & _
                     " order by cp09 asc", adoTaie, adOpenStatic, adLockReadOnly
      Case "CFP"  '僅EPC母子案一起算,接續案及集體設計個別計算
         adocal.Open "select cp09, nvl(cp16,0) - nvl(cp77,0) as RecAmount, decode(cp77, 0, nvl(cp18, 0), null, nvl(cp18, 0), DECODE((CP16-CP77),0,0, (CP16-X.A1U07-CP17) / 1000)) as cp18 from caseprogress, " & _
                     "(SELECT A1U03,SUM(A1U07) A1U07 FROM ACC1U0,CASEPROGRESS WHERE CP09=A1U03 and cp01 = '" & strCP01 & "' and cp02 = '" & strCP02 & "' and cp03 = '" & strCP03 & "' GROUP BY A1U03) X " & _
                     " where ((cp61 <> '" & strCon8 & "' or cp61 is null) and (cp62 <> '" & strCon8 & "' or cp62 is null) and (cp63 <> '" & strCon8 & "' or cp63 is null) and (cp87 <> '" & strCon8 & "' or cp87 is null) and (cp88 <> '" & strCon8 & "' or cp88 is null)) and (substr(cp60, 1, 1) = 'E' or cp60 is null) AND CP09=X.A1U03(+) and cp01 = '" & strCP01 & "' and cp02 = '" & strCP02 & "' and cp03 = '" & strCP03 & "' union " & _
                     "select cp09, NVL(nvl(a1k30, A1K11),0) as RecAmount, nvl(cp18, 0) as cp18 from caseprogress, acc1k0 " & _
                     " where cp60 = a1k01 (+) and ((cp61 <> '" & strCon8 & "' or cp61 is null) and (cp62 <> '" & strCon8 & "' or cp62 is null) and (cp63 <> '" & strCon8 & "' or cp63 is null) and (cp87 <> '" & strCon8 & "' or cp87 is null) and (cp88 <> '" & strCon8 & "' or cp88 is null)) and (substr(cp60, 1, 1) = 'X') and cp01 = '" & strCP01 & "' and cp02 = '" & strCP02 & "' and cp03 = '" & strCP03 & "' " & _
                     " order by cp09 asc", adoTaie, adOpenStatic, adLockReadOnly
      Case Else
         adocal.Open "select cp09, nvl(cp16,0) - nvl(cp77,0) as RecAmount, decode(cp77, 0, nvl(cp18, 0), null, nvl(cp18, 0), DECODE((CP16-CP77),0,0, (CP16-X.A1U07-CP17) / 1000)) as cp18 from caseprogress, " & _
                     "(SELECT A1U03,SUM(A1U07) A1U07 FROM ACC1U0,CASEPROGRESS WHERE CP09=A1U03 and cp01 = '" & strCP01 & "' and cp02 = '" & strCP02 & "' and cp03 = '" & strCP03 & "' and cp04 = '" & strCP04 & "' GROUP BY A1U03) X " & _
                     " where ((cp61 <> '" & strCon8 & "' or cp61 is null) and (cp62 <> '" & strCon8 & "' or cp62 is null) and (cp63 <> '" & strCon8 & "' or cp63 is null) and (cp87 <> '" & strCon8 & "' or cp87 is null) and (cp88 <> '" & strCon8 & "' or cp88 is null)) and (substr(cp60, 1, 1) = 'E' or cp60 is null) AND CP09=X.A1U03(+) and cp01 = '" & strCP01 & "' and cp02 = '" & strCP02 & "' and cp03 = '" & strCP03 & "' and cp04 = '" & strCP04 & "' union " & _
                     "select cp09, NVL(nvl(a1k30, A1K11),0) as RecAmount, nvl(cp18, 0) as cp18 from caseprogress, acc1k0 " & _
                     " where cp60 = a1k01 (+) and ((cp61 <> '" & strCon8 & "' or cp61 is null) and (cp62 <> '" & strCon8 & "' or cp62 is null) and (cp63 <> '" & strCon8 & "' or cp63 is null) and (cp87 <> '" & strCon8 & "' or cp87 is null) and (cp88 <> '" & strCon8 & "' or cp88 is null)) and (substr(cp60, 1, 1) = 'X') and cp01 = '" & strCP01 & "' and cp02 = '" & strCP02 & "' and cp03 = '" & strCP03 & "' and cp04 = '" & strCP04 & "' " & _
                     " order by cp09 asc", adoTaie, adOpenStatic, adLockReadOnly
   End Select
   Do While adocal.EOF = False
      If Val(adocal.Fields("RecAmount").Value) = 0 Then
         strProfit = Val(strProfit)
      Else
         strProfit = Val(strProfit) + adocal.Fields("RecAmount").Value
         If IsNull(adocal.Fields("cp18").Value) = False Then
            strProfit = Val(strProfit) - (Val(adocal.Fields("cp18").Value) * 1000)
         End If
      End If
      adocal.MoveNext
   Loop
   
   '新系統國外帳單,己付者以a1906匯率計算,抵帳者以A1G03抵帳匯率計算,未付者以最新的預估結匯匯率計算
   If adocal.State = adStateOpen Then
      adocal.Close
   End If
   adocal.CursorLocation = adUseClient
   'adocal.Open "select sum(decode(a1507, null, nvl(NVL(AXF04*decode(A1906,0,null,A1906), nvl(AXF04*decode(A1513,0,null,A1513),AXF04*decode(" & m_CurrRate & ",0,null," & m_CurrRate & "))), 0), 0)) as PayAmount from acc151, acc150, ACC190 where axf01 = a1501 AND AXF01=A1902(+) and axf02 <> '000000000' and axf03 = '" & strCP01 & strCP02 & strCP03 & strCP04 & "' group by a1505, a1502", adoTaie, adOpenStatic, adLockReadOnly
   Select Case strCP01
      Case "TF"   '母子案一起算,但領土延伸分開算
         adocal.Open "select AXF02,A1507,AXF04,A1906,A1G03,A1505,NVL(AXF04*decode(A1906,0,null,A1906),NVL(AXF04*decode(A1G03,0,null,A1G03),0)) AS PayAmount from acc151, acc150, ACC190, ACC1G0 where axf01 = a1501 AND AXF01=A1902(+) AND A1512=A1G01(+) and axf02 <> '000000000' and INSTR(axf03,'" & strCP01 & strCP02 & "')=1 ", adoTaie, adOpenStatic, adLockReadOnly
      Case "CFP"  '僅EPC母子案一起算,接續案及集體設計個別計算
         adocal.Open "select AXF02,A1507,AXF04,A1906,A1G03,A1505,NVL(AXF04*decode(A1906,0,null,A1906),NVL(AXF04*decode(A1G03,0,null,A1G03),0)) AS PayAmount from acc151, acc150, ACC190, ACC1G0 where axf01 = a1501 AND AXF01=A1902(+) AND A1512=A1G01(+) and axf02 <> '000000000' and INSTR(axf03,'" & strCP01 & strCP02 & strCP03 & "')=1 ", adoTaie, adOpenStatic, adLockReadOnly
      Case Else
         adocal.Open "select AXF02,A1507,AXF04,A1906,A1G03,A1505,NVL(AXF04*decode(A1906,0,null,A1906),NVL(AXF04*decode(A1G03,0,null,A1G03),0)) AS PayAmount from acc151, acc150, ACC190, ACC1G0 where axf01 = a1501 AND AXF01=A1902(+) AND A1512=A1G01(+) and axf02 <> '000000000' and axf03 = '" & strCP01 & strCP02 & strCP03 & strCP04 & "' ", adoTaie, adOpenStatic, adLockReadOnly
   End Select
   Do While adocal.EOF = False
      If IsNull(adocal.Fields("PayAmount").Value) = False And adocal.Fields("PayAmount").Value <> 0 Then
         strProfit = Val(strProfit) - Format(Val(adocal.Fields("PayAmount").Value), FAmount)
      Else
         If adoquery.State = adStateOpen Then
            adoquery.Close
         End If
         adoquery.CursorLocation = adUseClient
         adoquery.Open "select a2103 from acc210 where a2102 = '" & adocal.Fields("A1505") & "' and a2101 = (select max(a2101) from acc210 where a2102 = '" & adocal.Fields("A1505") & "' and a2101 <= " & strSrvDate(2) & ")", adoTaie, adOpenStatic, adLockReadOnly
         If adoquery.RecordCount <> 0 Then
            strProfit = Val(strProfit) - Format(Val(adocal.Fields("AXF04").Value) * Val(adoquery.Fields("A2103").Value), FAmount)
         Else
            strProfit = Val(strProfit) - Format(Val(adocal.Fields("AXF04").Value), FAmount)
         End If
         adoquery.Close
      End If
      adocal.MoveNext
   Loop
   adocal.Close
'2009/11/25 END
   
   '扣除安全基金
   strProfit = Val(strProfit) - GetFloatPrepareCase(strCP01, strCP02, strCP03, strCP04)
   '扣除舊系統帳單
   strProfit = Val(strProfit) - Val(strOldPay)
   strProfit = Format(strProfit, FAmount)

Checking:
   If Err.Number = 0 Then
      Exit Function
   End If
   MsgBox Err.Description, , MsgText(5)

End Function
'2009/10/26 end

'2009/11/26 add by sonia 計算收文號盈虧
Public Function CalculateProcessProfit(strCP09 As String, ByRef strProcessProfit As String, strAXF04 As Variant, strTWAmount As Double, strCurr As String) As Boolean
Dim adoquery As New ADODB.Recordset
Dim adoaccsum As New ADODB.Recordset
Dim adocal As New ADODB.Recordset
Dim adoloop As New ADODB.Recordset
Dim m_PayAmount As Double
Dim m_Amount As Double

On Error GoTo Checking

   CalculateProcessProfit = True
   strProcessProfit = MsgText(601)
   m_PayAmount = 0
   m_Amount = 0
   
   '此收文號收入-(點數*1000)
   If adoaccsum.State = adStateOpen Then
      adoaccsum.Close
   End If
   adoaccsum.CursorLocation = adUseClient
   '2013/1/15 modify by sonia T124832之續展AA1011314有銷帳,點數算錯
   'adoaccsum.Open "select nvl(cp16,0) - nvl(cp77,0) as RecAmount, decode(cp77, 0, nvl(cp18, 0), null, nvl(cp18, 0), DECODE((CP16-CP77),0,0, (CP16-CP77) / 1000-cp18)) as cp18,CP31,CP01,CP02,CP03,CP04 from caseprogress " & _
                " where cp09='" & strCP09 & "' and (substr(cp60, 1, 1) = 'E' or cp60 is null) union " & _
                "select sum(nvl(a1l05,0)) as RecAmount, sum(DECODE(A1L04,CP10,nvl(a1l05,0),0))/1000 as cp18,CP31,CP01,CP02,CP03,CP04 from caseprogress,acc1l0,acc1k0 " & _
                " where cp09='" & strCP09 & "' and substr(cp60, 1, 1) = 'X' and cp60=a1k01(+) and cp60=a1l01(+) and cp10=substr(a1l04,1,length(cp10)) " & _
                "group by CP31,CP01,CP02,CP03,CP04 ", adoTaie, adOpenStatic, adLockReadOnly
   adoaccsum.Open "select nvl(cp16,0) - nvl(cp77,0) as RecAmount, decode(cp77, 0, nvl(cp18, 0), null, nvl(cp18, 0), DECODE((CP16-CP77),0,0, (CP16-a1u07-cp17) / 1000)) as cp18,CP31,CP01,CP02,CP03,CP04 from caseprogress, " & _
                "(select a1u03,sum(a1u07) a1u07 from acc1u0 where a1u03='" & strCP09 & "' group by a1u03) where cp09='" & strCP09 & "' and (substr(cp60, 1, 1) = 'E' or cp60 is null) and cp09=a1u03(+) union " & _
                "select sum(nvl(a1l05,0)) as RecAmount, sum(DECODE(A1L04,CP10,nvl(a1l05,0),0))/1000 as cp18,CP31,CP01,CP02,CP03,CP04 from caseprogress,acc1l0,acc1k0 " & _
                " where cp09='" & strCP09 & "' and substr(cp60, 1, 1) = 'X' and cp60=a1k01(+) and cp60=a1l01(+) and cp10=substr(a1l04,1,length(cp10)) " & _
                "group by CP31,CP01,CP02,CP03,CP04 ", adoTaie, adOpenStatic, adLockReadOnly
   If adoaccsum.RecordCount <> 0 Then
      If Val(adoaccsum.Fields("RecAmount")) > 0 Then  'RecAmount=0者不可再減點數,否則負負為正CFP-022018答辯
         m_Amount = Val(adoaccsum.Fields("RecAmount")) - (Val(adoaccsum.Fields("cp18").Value) * 1000)
      End If
      '新案件才扣除安全基金
      If adoaccsum.Fields("cp31") = "Y" Then
         m_Amount = m_Amount - GetFloatPrepareCase(adoaccsum.Fields("cp01"), adoaccsum.Fields("cp02"), adoaccsum.Fields("cp03"), adoaccsum.Fields("cp04"))
      End If
   End If
   
   '扣除此收文號其他帳單金額
   If adoaccsum.State = adStateOpen Then
      adoaccsum.Close
   End If
   adoaccsum.CursorLocation = adUseClient
   adoaccsum.Open "select AXF02,A1507,AXF04,A1906,A1G03,A1505,NVL(AXF04*decode(A1906,0,null,A1906),NVL(AXF04*decode(A1G03,0,null,A1G03),0)) AS PayAmount from acc151, acc150, ACC190, ACC1G0 where axf01 = a1501 AND AXF01=A1902(+) AND A1512=A1G01(+) and axf02 = '" & strCP09 & "' ", adoTaie, adOpenStatic, adLockReadOnly
   Do While adoaccsum.EOF = False
      '已付
      If IsNull(adoaccsum.Fields("PayAmount").Value) = False And adoaccsum.Fields("PayAmount").Value <> 0 Then
         m_Amount = m_Amount - Format(Val(adoaccsum.Fields("PayAmount").Value), FAmount)
      '未付帳單以最新的預估結匯匯率計算
      'Modified by Morgan 2024/7/30 排除已作廢帳單
      'Else
      ElseIf IsNull(adoaccsum.Fields("A1507")) Then
      'end 2024/7/30
         If adoquery.State = adStateOpen Then
            adoquery.Close
         End If
         adoquery.CursorLocation = adUseClient
         adoquery.Open "select a2103 from acc210 where a2102 = '" & adoaccsum.Fields("A1505") & "' and a2101 = (select max(a2101) from acc210 where a2102 = '" & adoaccsum.Fields("A1505") & "' and a2101 <= " & strSrvDate(2) & ")", adoTaie, adOpenStatic, adLockReadOnly
         If adoquery.RecordCount <> 0 Then
            m_Amount = m_Amount - Format(Val(adoaccsum.Fields("AXF04").Value) * Val(adoquery.Fields("A2103").Value), FAmount)
         Else
            m_Amount = m_Amount - Format(Val(adoaccsum.Fields("AXF04").Value), FAmount)
         End If
         adoquery.Close
      End If
      adoaccsum.MoveNext
   Loop
   
   '扣除本次帳單金額
   If adoaccsum.State = adStateOpen Then
      adoaccsum.Close
   End If
   adoaccsum.CursorLocation = adUseClient
   '所有未付帳單之損益都以最新的預估結匯匯率計算
   adoaccsum.Open "select a2103 from acc210 where a2102 = '" & strCurr & "' and a2101 = (select max(a2101) from acc210 where a2102 = '" & strCurr & "' and a2101 <= " & strSrvDate(2) & ")", adoTaie, adOpenStatic, adLockReadOnly
   If adoaccsum.RecordCount <> 0 Then
      strTWAmount = (Val(strAXF04) * Val(adoaccsum.Fields("a2103").Value))
   Else
      strTWAmount = Val(strAXF04)
   End If
   If adoaccsum.State = adStateOpen Then
      adoaccsum.Close
   End If
   strProcessProfit = Val(m_Amount) - Format(Val(strTWAmount), FAmount)
   
   strProcessProfit = Format(strProcessProfit, FAmount)

Checking:
   If Err.Number = 0 Then
      Exit Function
   End If
   MsgBox Err.Description, , MsgText(5)

End Function
'2009/11/26 end

'2009/12/17 add by sonia
'清除查詢印表記錄檔欄位
Public Function ClearQueryLog(str_QL04 As String)
   pub_QL05 = "": pub_QL07 = "": pub_QL06 = 0
   pub_QL04 = str_QL04
End Function

'寫入查詢印表記錄檔欄位
'Modify By Sindy 2025/8/7 + Optional strAddText As String = "":存檔前要加的文字
Public Function InsertQueryLog(str_QL06 As String, _
   Optional strAddText As String = "")
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset
   
   If Len(pub_QL05) > 4000 Then
      pub_QL07 = Mid(pub_QL05, 4001)
      pub_QL05 = Mid(pub_QL05, 1, 4000)
   End If
   
   If rsA.State <> adStateClosed Then rsA.Close
   Set rsA = Nothing
   
   If str_QL06 = "" Then
      'Modified by Lydia 2025/07/31 +QL08,QL09
      'StrSQLa = "INSERT INTO QueryLog (QL01,QL02,QL03,QL04,QL05,QL06,QL07) " & _
                "values ('" & strUserNum & "'," & strSrvDate(1) & "," & ServerTime & ",'" & pub_QL04 & "','" & ChgSQL(pub_QL05) & "',null,'" & ChgSQL(pub_QL07) & "')"
      'Modify By Sindy 2025/8/7 + & strAddText
      StrSQLa = "INSERT INTO QueryLog (QL01,QL02,QL03,QL04,QL05,QL06,QL07,QL08,QL09) " & _
                "values ('" & strUserNum & "'," & strSrvDate(1) & "," & ServerTime & ",'" & pub_QL04 & "','" & ChgSQL(pub_QL05 & strAddText) & "',null,'" & ChgSQL(pub_QL07) & "',SYS_CONTEXT('USERENV','IP_ADDRESS'),SYS_CONTEXT('USERENV','TERMINAL'))"
                
   Else
      pub_QL06 = Val(str_QL06)
      'Modified by Lydia 2025/07/31 +QL08,QL09
      'StrSQLa = "INSERT INTO QueryLog (QL01,QL02,QL03,QL04,QL05,QL06,QL07) " & _
                "values ('" & strUserNum & "'," & strSrvDate(1) & "," & ServerTime & ",'" & pub_QL04 & "','" & ChgSQL(pub_QL05) & "'," & pub_QL06 & ",'" & ChgSQL(pub_QL07) & "')"
      'Modify By Sindy 2025/8/7 + & strAddText
      StrSQLa = "INSERT INTO QueryLog (QL01,QL02,QL03,QL04,QL05,QL06,QL07,QL08,QL09) " & _
                "values ('" & strUserNum & "'," & strSrvDate(1) & "," & ServerTime & ",'" & pub_QL04 & "','" & ChgSQL(pub_QL05 & strAddText) & "'," & pub_QL06 & ",'" & ChgSQL(pub_QL07) & "',SYS_CONTEXT('USERENV','IP_ADDRESS'),SYS_CONTEXT('USERENV','TERMINAL'))"
   End If
   cnnConnection.Execute StrSQLa
End Function
'2009/12/17 end

'Add By Sindy 2025/7/29
Public Function PUB_CheckQL05(strText As String) As String
   If Trim(pub_QL05) = "" Then
      PUB_CheckQL05 = strText
      Exit Function
   ElseIf InStr(pub_QL05, strText) = 0 Then
      PUB_CheckQL05 = strText
      Exit Function
   End If
End Function

'2009/12/31 ADD BY SONIA 檢查是否為台灣99年新規費發明案件
Public Function Chk99NewCase(strCP01 As String, strCP02 As String, strCP03 As String, strCP04 As String) As Boolean
'0.分割母案已提再審且母案申請日<20100101則分割實審為舊規費8000(2010/10/15 add by sonia)
'1.先檢查有無申請案號,無申請案號者視為新規費案件
'2.再判斷該案號是否有收文改請發明301或分割307
'2.5有改請發明301或分割307:
'    收文日或發文日>=20100101則為新規費案件
'    收文日<=20100101未發文則為新規費案件
'  但收文日<=20100101且發文日<=20100101則為舊規費案件
'3.無改請發明301或分割308判斷申請日是否>=20100101
Dim strPA10 As String
Dim StrPA11 As String 'Add By Sindy 2020/10/16
   
   '2010/10/15 add by sonia 分割母案已提再審且母案申請日<20100101則分割實審為舊規費8000
   '2010/10/19 FCP-042277母案FCP-032220再審已收但未發
   strSql = "select PA10,CP27 FROM DivisionCase,patent,CASEPROGRESS WHERE DC01='" & strCP01 & "' AND DC02='" & strCP02 & "' AND DC03='" & strCP03 & "' AND DC04='" & strCP04 & "' " & _
            "AND DC05=PA01(+) AND DC06=PA02(+) AND DC07=PA03(+) AND DC08=PA04(+) AND PA01=CP01(+) AND PA02=CP02(+) AND PA03=CP03(+) AND PA04=CP04(+) " & _
            "AND CP10='107' AND CP57 IS NULL"
   CheckOC3
   AdoRecordSet3.CursorLocation = adUseClient
   AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
      'Modified by Morgan 2013/4/22
      '若母案已提再審分割案的實審視為再審,又再審於102/1/1起改同實審收費故此處改一率適用新法
      'If Val("" & AdoRecordSet3.Fields("PA10")) < 20100101 Then
      '   Exit Function
      'End If
      Chk99NewCase = True
      Exit Function
      'end 2013/4/22
   End If
   '2010/10/15 END
   
   strPA10 = "": StrPA11 = ""
   
   strSql = " select PA10,PA11 FROM PATENT WHERE PA01='" & strCP01 & "'  AND PA02='" & strCP02 & "' AND PA03='" & strCP03 & "' AND PA04='" & strCP04 & "' AND PA09='000' AND PA08='1' "
   CheckOC3
   AdoRecordSet3.CursorLocation = adUseClient
   AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
      strPA10 = "" & AdoRecordSet3.Fields("PA10")
      '1.先檢查有無申請案號,無申請案號者視為新規費案件
      If "" & AdoRecordSet3.Fields("PA11") = "" Then
         Chk99NewCase = True
      Else
         StrPA11 = "" & AdoRecordSet3.Fields("PA11") 'Add By Sindy 2020/10/16
         '2.再判斷該案號是否有收文改請發明301或分割307
         strSql = "select CP05,CP27,CP66 FROM CASEPROGRESS WHERE CP01='" & strCP01 & "' AND CP02='" & strCP02 & "' AND CP03='" & strCP03 & "' AND CP04='" & strCP04 & "' " & _
                  " AND CP10 IN ('301','307') AND CP57 IS NULL ORDER BY CP05 DESC "
         CheckOC3
         AdoRecordSet3.CursorLocation = adUseClient
         AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
         '2.5有改請發明301或分割307:
         If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
            '收文日或發文日>=20100101則為新規費案件
            'Modify By Sindy 2020/10/16 ex:FCP-62747
            '   請修改假收文"分割案"在產生後續中間程序電子申請書時的規費判斷如下:
            '   若"分割"的收文日是11/11/11在產生後續中間程序電子申請書(例: 申復的修正申請書)時，請去抓分割案申請案號的前3碼(年度)，來判斷規費的算法是依據新法or舊法
            '   (有詢問敏莉不用限制是301或307都適用)
            If Val("" & AdoRecordSet3.Fields("CP05")) >= 20100101 Or _
               Val("" & AdoRecordSet3.Fields("CP27")) >= 20100101 Or _
               (Val("" & AdoRecordSet3.Fields("CP05")) = 19221111 And Val(DBDATE(Left(StrPA11, 3) & "0101")) >= 20100101) Then
               Chk99NewCase = True
            '收文日<=20100101未發文則為新規費案件
            ElseIf Val("" & AdoRecordSet3.Fields("CP05")) < 20100101 And "" & AdoRecordSet3.Fields("CP27") = "" Then
               Chk99NewCase = True
            '但收文日<=20100101且發文日<=20100101則為舊規費案件
            Else
            End If
         '3.無改請發明301或分割307判斷申請日是否>=20100101
         Else
            If Val(strPA10) >= 20100101 Then
               Chk99NewCase = True
            End If
         End If
      End If
   '無基本檔者視為新規費案件
   Else
      Chk99NewCase = True
   End If
   CheckOC3

End Function
'2009/12/31 END

'Add by Morgan 2010/4/8
'檢查分配點數總合是否符合
Public Function PUB_ChkPointOk(strA1K01 As String) As Boolean
   Dim stSQL As String, iR As Integer
   Dim adoRst As ADODB.Recordset
   
   'Modify By Sindy 2013/1/28
'   If strSrvDate(1) >= AccFMPImputCurrStarDate Then
   '   stSQL = "select 1 from acc1k0 Where a1k01='" & strA1k01 & "'" & _
   '      " and exists(select 1 from acc1n0 where a1n01=a1k01 and a1n02='1'" & _
   '      " having(nvl(sum(a1n05),0)=trunc(a1k11-nvl(a1k09,0)-nvl(a1k06,0)*nvl(a1k10,0))/1000))" & _
   '      " and exists(select 1 from acc1n0 where a1n01=a1k01 and a1n02='2'" & _
   '      " having(nvl(sum(a1n05),0)=trunc(a1k11-nvl(a1k09,0)-nvl(a1k06,0)*nvl(a1k10,0))/1000))"
      'Modify By Sindy 2013/1/15
      'Modified by Morgan 2018/3/20 +a1k36
      stSQL = "select 1 from acc1k0 Where a1k01='" & strA1K01 & "'" & _
         " and exists(select 1 from acc1n0 where a1n01=a1k01 and a1n02='1'" & _
         " having(nvl(sum(a1n05),0)=trunc(a1k11-nvl(a1k09,0)-nvl(a1k06,0)+nvl(a1k36,0))/1000))" & _
         " and exists(select 1 from acc1n0 where a1n01=a1k01 and a1n02='2'" & _
         " having(nvl(sum(a1n05),0)=trunc(a1k11-nvl(a1k09,0)-nvl(a1k06,0)+nvl(a1k36,0))/1000))"
      '2013/1/15 End
      iR = 1
      Set adoRst = ClsLawReadRstMsg(iR, stSQL)
      If iR = 1 Then
         PUB_ChkPointOk = True
      End If
'   Else
'   '2013/1/28 End
'
'      stSQL = "select 1 from acc1k0 Where a1k01='" & strA1k01 & "'" & _
'         " and exists(select 1 from acc1n0 where a1n01=a1k01 and a1n02='1'" & _
'         " having(nvl(sum(a1n05),0)=trunc(a1k11-nvl(a1k09,0)-nvl(a1k06,0)*nvl(a1k10,0))/1000))" & _
'         " and exists(select 1 from acc1n0 where a1n01=a1k01 and a1n02='2'" & _
'         " having(nvl(sum(a1n05),0)=trunc(a1k11-nvl(a1k09,0)-nvl(a1k06,0)*nvl(a1k10,0))/1000))"
'
'      iR = 1
'      Set adoRst = ClsLawReadRstMsg(iR, stSQL)
'      If iR = 1 Then
'         PUB_ChkPointOk = True
'      End If
'   End If
End Function

'Add by Morgan 2010/3/31
'依照預設規則分配點數
Public Function PUB_PointAutoassign(strA1K01 As String, Optional bolExistsTrans As Boolean = False) As Boolean
   Dim stSQL As String, intR As Integer, ii As Integer
   Dim adoRst As ADODB.Recordset, adoRst2 As ADODB.Recordset
   Dim douPtSum As Double '總點數
   Dim douPt As Double, douPt1 As Double
   Dim douPtP1001 As Double
   Dim douPtP2001 As Double
   Dim douPtF4101 As Double
   Dim douPtF4102 As Double
   Dim douPtF4103 As Double
   Dim strLastA1l04 As String '前筆請款項目
   Dim strA1N03 As String '收文號
   Dim strA1n04 As String '被分配人
   Dim strA1N04s As String '相同案件性質的承辦人清單
   Dim bolNeedModify As Boolean '是否需要調整點數
   Dim arrXData() As String, arrSize As Integer '額外分配的點數
   Dim bolFMP As Boolean '是否FMP案
   Dim bolFMPnewcase As Boolean '是否FMP新案請款(要扣安全基金) Added by Morgan 2013/2/20
   Dim bolOurFMP As Boolean '新案是否寰華案件 Added by Morgan 2014/11/7
   Dim douTail As Double '剩餘小數值
   Dim bolTcase As Boolean '是否內商人員承辦案件
   Dim douSafeFund As Double '未扣安全基金
   Dim strCP01 As String, strCP12 As String '系統別,收文業務區 Added by Morgan 2015/5/26
   Dim douPt2Sum As Double '專業總點數  add by sonia 2017/10/18
   Dim bolCredit As Boolean '是否有折讓 added by Morgan 2018/4/3
   Dim strTmp As String, intA As Integer, rsAD As New ADODB.Recordset  'Added by Lydia 2024/05/14
   
   arrSize = 0
   bolFMP = False
   bolOurFMP = False 'Added by Morgan 2014/11/6
   douPt2Sum = 0     'add by sonia 2017/10/23
      
On Error GoTo ErrHnd
   
   If Not bolExistsTrans Then
      cnnConnection.BeginTrans
   End If
   cnnConnection.Execute "delete acc1n0 where a1n01='" & strA1K01 & "'"
   
   'Modify By Sindy 2013/1/28
'   If strSrvDate(1) >= AccFMPImputCurrStarDate Then
      'Modify By Sindy 2013/1/28
      'stSQL = "select nvl(sum(a1l05-nvl(a1l07,0)),0) from acc1l0 where a1L01='" & strA1k01 & "' and substr(a1l04,-2)<>'99' and substr(a1l03,1,1)||a1l04<>'T03'"
      'Modified by Morgan 2013/2/20 考慮案全基金改直接抓acc1k0
      'stSQL = "select sum(amt) from( " & _
              "select nvl(sum(a1l05),0) amt from acc1l0 where a1L01='" & strA1k01 & "' and substr(a1l04,-2)<>'99' and substr(a1l04,-2)<>'98' and substr(a1l03,1,1)||a1l04<>'T03' " & _
              "Union " & _
              "select (nvl(sum(nvl(a1l07,0)),0) * -1) amt from acc1l0 where a1L01='" & strA1k01 & "' " & _
              ")"
      stSQL = "select a1k11-nvl(a1k09,0),a1k13,nvl(a1k06,0)-nvl(a1k36,0) Crd from acc1k0 where a1k01='" & strA1K01 & "'"
      '2013/1/28 End
      intR = 1
      Set adoRst = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         If adoRst("Crd") > 0 Then bolCredit = True 'Added by Morgan 2018/4/3
         '小數一律捨去
         douPtSum = Fix(adoRst(0)) / 1000
         If douPtSum > 0 Then
            '智權人員點數放在最後收文的智權人員
            'Modified by Morgan 2012/3/15 +pa09
            'Modified by Morgan 2020/12/23 +lawofficesource.los04
            stSQL = "select cp01,cp02,cp03,cp04,cp12,cp13,cp09,st15,pa09,los04" & _
               " from caseprogress,staff,patent,lawofficesource" & _
               " where cp60='" & strA1K01 & "' and st01(+)=cp14" & _
               " and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04" & _
               " and los06(+)=cp09 order by cp05,cp09"
            intR = 1
            Set adoRst = ClsLawReadRstMsg(intR, stSQL)
            If intR = 1 Then
               With adoRst
               .MoveLast
               strCP01 = "" & adoRst("cp01") 'Added by Morgan 2015/5/25
               strCP12 = "" & adoRst("cp12") 'Added by Morgan 2015/5/25
               
               'Added by Morgan 2015/5/26
               '法務部收文則專業點數及業務點數都依550:150比例分配給'F4102'及'F4103'
               'Modify By Sindy 2020/3/31 Or strCP12 = "L02" => Or Left(strCP12, 1) = "L"
               'Modified by Morgan 2020/12/23 改判斷案源歸介紹人否則照一般規則
               'If (strCP01 = "FCL" Or strCP01 = "CFL" Or strCP01 = "LIN") And _
               '   (strCP12 = "F31" Or strCP12 = "F41" Or Left(strCP12, 1) = "L") Then
               '   stSQL = "insert into ACC1N0(a1n01,a1n02,a1n03,a1n04,a1n05)" & _
               '         " values ('" & strA1k01 & "','1',' ','F4102'," & Round(douPtSum * (550 / 700), 3) & ")"
               '   cnnConnection.Execute stSQL, intR
               '
               '   stSQL = "insert into ACC1N0(a1n01,a1n02,a1n03,a1n04,a1n05)" & _
               '         " values ('" & strA1k01 & "','1',' ','F4103'," & douPtSum - Round(douPtSum * (550 / 700), 3) & ")"
               '   cnnConnection.Execute stSQL, intR
               If InStr(strCP01, "L") > 0 And Not IsNull(.Fields("los04")) Then
                  stSQL = "insert into ACC1N0(a1n01,a1n02,a1n03,a1n04,a1n05)" & _
                        " values ('" & strA1K01 & "','1',' ','" & Left(.Fields("los04"), 5) & "'," & douPtSum & ")"
                  cnnConnection.Execute stSQL, intR
               'end 2020/12/23
               Else
               'end 2015/5/26
                  'Modified by Morgan 2012/3/15 +判斷非台灣案
                  If .Fields("cp01") = "P" And Left(.Fields("cp12"), 1) = "F" And "" & .Fields("pa09") <> "000" Then
                     bolFMP = True
                     bolOurFMP = PUB_FMPtoCheck(1, 2, Pub_strUserST05, .Fields("cp01"), .Fields("cp02"), .Fields("cp03"), .Fields("cp04"))  'Added by Morgan 2014/11/6
                  End If
               
                  stSQL = "insert into ACC1N0(a1n01,a1n02,a1n03,a1n04,a1n05)" & _
                        " values ('" & strA1K01 & "','1','" & .Fields("cp09") & "','" & .Fields("cp13") & "'," & douPtSum & ")"
                  cnnConnection.Execute stSQL, intR
                  
                  'Add by Morgan 2010/11/17
                  If .Fields("cp01") = "FCT" Or .Fields("cp01") = "T" Then
                     Do While Not .EOF
                        If Left("" & .Fields("st15"), 2) = "P2" Then
                           bolTcase = True
                           Exit Do
                        End If
                        .MoveNext
                     Loop
                  End If
                  
               End If 'Added by Morgan 2015/5/26
               
               End With
            End If
            
            
            'Add by Morgan 2010/11/17
            'FCT,FMT的請款單只要有一個承辦人是內商人員則整張請款單專業點數都歸內商--陳鳳英
            If bolTcase Then
               stSQL = "insert into ACC1N0(a1n01,a1n02,a1n03,a1n04,a1n05)" & _
                     " values ('" & strA1K01 & "','2',' ','P2001'," & douPtSum & ")"
               cnnConnection.Execute stSQL, intR
               douPt2Sum = douPt2Sum + douPtSum 'add by sonia 2017/10/23
            
'Removed by Morgan 2020/12/23 法律所獨立，專業點數改照一般規則
'            'Added by Morgan 2015/5/26
'            'FCL案件
'            '外專收文則專業點數全數歸'F4102'，業務點數歸收文人員
'            'modify by sonia 2019/7/31 +ACS系統類別
'            ElseIf (strCP01 = "FCL" Or strCP01 = "CFL" Or strCP01 = "LIN" Or strCP01 = "ACS") And Left(strCP12, 2) = "F2" Then
'               stSQL = "insert into ACC1N0(a1n01,a1n02,a1n03,a1n04,a1n05)" & _
'                     " values ('" & strA1k01 & "','2',' ','F4102'," & douPtSum & ")"
'               cnnConnection.Execute stSQL, intR
'               douPt2Sum = douPt2Sum + douPtSum 'add by sonia 2017/10/23
'
'            '外商收文則專業點數全數歸'F4103'，業務點數歸收文人員
'            'modify by sonia 2019/7/31 +ACS系統類別
'            ElseIf (strCP01 = "FCL" Or strCP01 = "CFL" Or strCP01 = "LIN" Or strCP01 = "ACS") And Left(strCP12, 2) = "F1" Then
'               stSQL = "insert into ACC1N0(a1n01,a1n02,a1n03,a1n04,a1n05)" & _
'                     " values ('" & strA1k01 & "','2',' ','F4103'," & douPtSum & ")"
'               cnnConnection.Execute stSQL, intR
'               douPt2Sum = douPt2Sum + douPtSum 'add by sonia 2017/10/23
'
'            '法務部收文則專業點數及業務點數都依550:150比例分配給'F4102'及'F4103'
'            'Modify By Sindy 2020/3/31 Or strCP12 = "L02" => Or Left(strCP12, 1) = "L"
'            ElseIf (strCP01 = "FCL" Or strCP01 = "CFL" Or strCP01 = "LIN") And _
'               (strCP12 = "F31" Or strCP12 = "F41" Or Left(strCP12, 1) = "L") Then
'               stSQL = "insert into ACC1N0(a1n01,a1n02,a1n03,a1n04,a1n05)" & _
'                     " values ('" & strA1k01 & "','2',' ','F4102'," & Round(douPtSum * (550 / 700), 3) & ")"
'               cnnConnection.Execute stSQL, intR
'               douPt2Sum = douPt2Sum + Round(douPtSum * (550 / 700), 3) 'add by sonia 2017/10/23
'
'               stSQL = "insert into ACC1N0(a1n01,a1n02,a1n03,a1n04,a1n05)" & _
'                     " values ('" & strA1k01 & "','2',' ','F4103'," & douPtSum - Round(douPtSum * (550 / 700), 3) & ")"
'               cnnConnection.Execute stSQL, intR
'               douPt2Sum = douPt2Sum + douPtSum - Round(douPtSum * (550 / 700), 3) 'add by sonia 2017/10/23
'            'end 2015/5/26
'end 2020/12/23
            
            Else
               '承辦點數
               'Modify by Morgan 2010/6/30 FCT請款項目為4011,6011,6021,6041,6061時,以前三碼抓案件性質
               'Modified by Morgan 2013/5/1 尾碼98也要排除
               'Memo by Morgan 2013/8/15 注意:若資料順序調整需確認是否會影響FMP新案請款扣安全基金的順序(1.打字費(03) 2.申請費(101,102,103) 3.本所服務費)
               stSQL = "select a1l01,a1L03,a1l04,pt,cp09,cp12,cp14,s1.st15,ep04,s2.st15 dep2,nvl(tf06,100) tf06" & _
                  " from (SELECT a1l01,a1L03,a1l04,sum(a1L05-nvl(a1L07,0)) as pt" & _
                  " from (select a1l01,a1l03,a1l04,a1l05,a1l07 FROM acc1L0  WHERE a1l01='" & strA1K01 & "'" & _
                  " and substr(a1l04,-2)<>'99' and substr(a1l04,-2)<>'98' and substr(a1l03,1,1)||a1l04<>'T03'" & _
                  " and not (a1l03='FCT' and a1l04 in ('4011','6011','6021','6041','6061'))" & _
                  " union all select a1l01,a1l03,substr(a1l04,1,3),a1l05,a1l07" & _
                  " FROM acc1L0  WHERE a1l01='" & strA1K01 & "'" & _
                  " and substr(a1l04,-2)<>'99' and substr(a1l04,-2)<>'98' and substr(a1l03,1,1)||a1l04<>'T03'" & _
                  " and a1l03='FCT' and a1l04 in ('4011','6011','6021','6041','6061'))" & _
                  " group by a1l01,a1L03,a1l04 )X,CaseProgress,Engineerprogress,Transfee,staff s1,staff s2" & _
                  " where cp60(+)=a1L01 and cp10(+)=a1L04 and ep02(+)=cp09 and tf01(+)=cp09  and s1.st01(+)=cp14" & _
                  " and s2.st01(+)=ep04 order by a1l01,a1l03,a1l04,cp05 desc,cp09 desc"
               intR = 1
               Set adoRst = ClsLawReadRstMsg(intR, stSQL)
               If intR = 1 Then
                  With adoRst
                  .MoveFirst
                  
                  'Add by Morgan 2010/5/17 FMP案總點數的20%要分配給專利處,扣除個人點數後,剩餘為FCP部門點數
                  If bolFMP Then
                     'Added by Morgan 2013/2/20
                     '檢查是否為FMP新案
                     'Modified by Morgan 2013/8/15
                     bolFMPnewcase = PUB_FMPNewCaseInvoice(strA1K01)
                     If bolFMPnewcase = True Then douSafeFund = 2
                     'end 2013/8/15
                     'end 2013/2/20
                     'Modified by Morgan 2014/11/6 寰華案件除外
                     If bolOurFMP = False Then
                        douPtP1001 = Round(douPtSum * 0.2, 3)
                     End If
                     'end 2014/11/6
                     
                     douPtF4102 = douPtSum - douPtP1001
                  End If
                  
                  douTail = 0
                  Do While Not .EOF
                     
                     douPt = .Fields("pt") + douTail
                     douTail = douPt - Fix(douPt)
                  
                     If IsNull(.Fields("CP09")) Then
                        'modify by sonia 2019/7/31 +ACS系統類別
                        If (.Fields("a1l03") = "FCL" Or .Fields("a1l03") = "LIN" Or .Fields("a1l03") = "CFL" Or .Fields("a1l03") = "L" Or .Fields("a1l03") = "ACS") Then
                           bolNeedModify = True
                        End If
                     End If
                     strA1N03 = ""
                     strA1n04 = ""
                     '相同案件性質點數放在最後收文日的最大收文號
                     If strLastA1l04 <> .Fields("a1l04") Then
                        douPt = Fix(douPt) / 1000
                        strA1N04s = ""
                     Else
                        douPt = 0
                     End If
                     
                     'Modify by Morgan 2010/5/17 FMP案改總點數的20%給專利處(上面)
                     ''國外部收文的P案若承辦人不為專利處人員時點數扣20%給專利處
                     'If .Fields("a1l03") = "P" And Left(.Fields("cp12"), 1) = "F" And Left(.Fields("st15"), 1) <> "P" Then
                     '   douPtP1001 = douPtP1001 + Round(douPt * 0.2, 3)
                     '   douPt = douPt - Round(douPt * 0.2, 3)
                     'End If
                           
                     'Added by Morgan 2013/2/20
                     'FMP新案打字費或103要扣安全基金2000
                     If bolFMPnewcase Then
                        'Modified by Morgan 2013/8/15 扣安全基金:1.打字費 2.申請費 3.本所服務費 (依照資料順序 打字費03會先扣)
                        'If .Fields("a1l04") = "03" Or .Fields("a1l04") = "103" Then
                        '   douPt = douPt - 2
                        If .Fields("a1l04") = "03" Or .Fields("a1l04") = "101" Or .Fields("a1l04") = "102" Or .Fields("a1l04") = "103" Then
                           If douSafeFund > 0 Then
                              If douPt > douSafeFund Then
                                 douPt = douPt - douSafeFund
                                 douSafeFund = 0
                              Else
                                 douPt = 0
                                 douSafeFund = douSafeFund - douPt
                              End If
                           End If
                           'end 2013/8/15
                        End If
                     End If
                        
                     '沒有收文號或承辦人算部門點數
                     If IsNull(.Fields("st15")) Then
                        Select Case .Fields("a1l03")
                           Case "P", "PS", "CFP", "CPS"
                              If Not bolFMP Then
                                 douPtP1001 = douPtP1001 + douPt
                              End If
                           
                           'modify by sonia 2019/7/31 +ACS系統類別
                           Case "CFL", "FCL", "LIN", "ACS"
                              douPtF4101 = douPtF4101 + douPt
                              
                           Case "FCP", "FG"
                              douPtF4102 = douPtF4102 + douPt
                              
                           Case "FCT", "CFT", "CFC", "S"
                              '最後收文外商部門的承辦人，若無則分配給部門
                              stSQL = "select cp14,cp09 from caseprogress,staff where cp60='" & strA1K01 & "' and st01(+)=cp14 and substr(st15,1,2)='F1' order by cp05 desc,cp09 desc"
                              intR = 1
                              Set adoRst2 = ClsLawReadRstMsg(intR, stSQL)
                              If intR = 1 Then
                                 arrSize = arrSize + 1
                                 ReDim Preserve arrXData(3, arrSize)
                                 arrXData(1, arrSize) = adoRst2("cp14")
                                 arrXData(2, arrSize) = adoRst2("cp09")
                                 arrXData(3, arrSize) = douPt
                              Else
                                 douPtF4103 = douPtF4103 + douPt
                              End If
                              
                           Case Else
                              If Left(.Fields("a1l03"), 1) = "T" Then
                                 douPtP2001 = douPtP2001 + douPt
                              End If
                        End Select
                        
                     '有承辦人
                     '特殊人員
                     ElseIf (.Fields("a1l03") = "FCL" Or .Fields("a1l03") = "LIN" Or .Fields("a1l03") = "CFL") And .Fields("cp14") = "97009" Then
                        strA1N03 = .Fields("CP09")
                        strA1n04 = "97099" '魏汎娟
                      
                     Else
                        strA1N03 = .Fields("CP09")
                        
                        '外專翻譯核稿點數(承辦人<>核稿人)
                        'Modified by Morgan 2013/6/19 +927其他翻譯
                        If (.Fields("a1l04") = "201" Or .Fields("a1l04") = "927") And Not IsNull(.Fields("ep04")) Then
                           '核稿點數=翻譯請款點數(扣除折扣)x(30%+因翻譯瑕疵扣減支付外譯人員翻譯費之百分比x70%)
                           If .Fields("cp14") <> .Fields("ep04") And .Fields("dep2") = "F21" Then
                              douPt1 = Round(douPt * (0.3 + 0.7 * (1 - .Fields("TF06") / 100)), 3)
                              douPt = douPt - douPt1
                              stSQL = "insert into ACC1N0(a1n01,a1n02,a1n03,a1n04,a1n05,a1n06)" & _
                                 " values ('" & strA1K01 & "','2','" & strA1N03 & "','" & .Fields("ep04") & "'," & douPt1 & ",'Y')"
                              cnnConnection.Execute stSQL, intR
                              douPt2Sum = douPt2Sum + douPt1 'add by sonia 2017/10/23
                              'Add by Morgan 2010/5/17 +FMP案控制
                              If bolFMP Then douPtF4102 = douPtF4102 - douPt1
                           End If
                           
                        '外專設計或聯合設計同時請製作中說但無該請款項目時點數分67%給製作中說的工程師
                        'Modified by Morgan 2017/3/22 +衍生設計125--吳若芬
                        ElseIf .Fields("a1l03") = "FCP" And (.Fields("a1l04") = "103" Or .Fields("a1l04") = "105" Or .Fields("a1l04") = "125" Or .Fields("a1l04") = "940") Then
                           Set rsAD = adoRst.Clone
                           rsAD.MoveFirst
                           rsAD.Find "a1l04='210'"
                           If rsAD.EOF Then
                              'Modified by Morgan 2019/5/10 判斷承辦人不同才要分,否則會Dupe Ex:X10807306
                              'strtmp = "select cp14,cp09 from caseprogress,staff where cp60='" & strA1k01 & "' and cp10='210' and st01(+)=cp14 and st15='F21'"
                              'Modified by Morgan 2019/9/27 修正承辦人判斷錯誤問題(已重新分配108/5/10以後製作中說請款單的點數)
                              strTmp = "select cp14,cp09 from caseprogress,staff where cp60='" & strA1K01 & "' and cp10='210' and st01(+)=cp14 and st15='F21' and cp14<>'" & .Fields("cp14") & "'"
                              'end 2019/5/10
                              intA = 1
                              Set rsAD = ClsLawReadRstMsg(intA, strTmp)
                              If intA = 1 Then
                                 douPt1 = Round(douPt * 0.67, 3)
                                 douPt = douPt - douPt1
                                 'Modified by Morgan 2013/2/21
                                 'stSQL = "insert into ACC1N0(a1n01,a1n02,a1n03,a1n04,a1n05)" & _
                                    " values ('" & strA1k01 & "','2','" & rsad.Fields("cp09") & "','" & rsad.Fields("cp14") & "'," & douPt1 & ")"
                                 stSQL = "insert into ACC1N0(a1n01,a1n02,a1n03,a1n04,a1n05)" & _
                                    " values ('" & strA1K01 & "','2','" & strA1N03 & "','" & rsAD.Fields("cp14") & "'," & douPt1 & ")"
                                 cnnConnection.Execute stSQL, intR
                                 douPt2Sum = douPt2Sum + douPt1 'add by sonia 2017/10/23
                              End If
                           End If
                        
                        'Added by Morgan 2013/2/21
                        'FMP新案101&102 點數依照FCP103比例(67%)分配給新案翻譯(201)的核稿人或檢視中說(209)或檢視PCT公開本與FCP相異處(942)的工程師。
                        'FMP新案103 點數(扣除安全基金剩餘的)依照FCP103比例(67%)分配給檢視中說(209)或撰稿(210)的工程師。
                        'Modified by Morgan 2024/2/20 +105集體設計也要--敏莉 Ex:P-133037-1-00
                        ElseIf bolFMPnewcase And (.Fields("a1l04") = "101" Or .Fields("a1l04") = "102" Or .Fields("a1l04") = "103" Or .Fields("a1l04") = "105") Then
                           
                           strTmp = "select cp14,cp09 from acc1k0,caseprogress,staff where a1k01='" & strA1K01 & "' and cp01(+)=a1k13 and cp02(+)=a1k14 and cp03(+)=a1k15 and cp04(+)=a1k16 and cp10 in ('209','210','942') and st01(+)=cp14 and st15='F21'"
                           strTmp = strTmp & " union select ep04,cp09 from acc1k0,caseprogress,engineerprogress,staff where a1k01='" & strA1K01 & "' and cp01(+)=a1k13 and cp02(+)=a1k14 and cp03(+)=a1k15 and cp04(+)=a1k16 and cp10='201' and ep02(+)=cp09 and st01(+)=ep04 and st15='F21'"
                           intA = 1
                           Set rsAD = ClsLawReadRstMsg(intA, strTmp)
                           If intA = 1 Then
                              douPt1 = Round(douPt * 0.67, 3) '參照核稿(專利處分配的比例從部門扣)--David
                              douPt = douPt - douPt1
                              douPtF4102 = douPtF4102 - douPt1
                              stSQL = "insert into ACC1N0(a1n01,a1n02,a1n03,a1n04,a1n05)" & " values ('" & strA1K01 & "','2','" & strA1N03 & "','" & rsAD.Fields("cp14") & "'," & douPt1 & ")"
                              cnnConnection.Execute stSQL, intR
                              douPt2Sum = douPt2Sum + douPt1 'add by sonia 2017/10/23
                           End If
                       'Added by Morgan 2025/8/11
                        'FCP領證同時請核對已准專利926但無該請款項目時依收文點數分配給工程師
                        ElseIf .Fields("a1l03") = "FCP" And .Fields("a1l04") = "601" Then
                           Set rsAD = adoRst.Clone
                           rsAD.MoveFirst
                           rsAD.Find "a1l04='926'"
                           If rsAD.EOF Then
                              strTmp = "select cp14,cp09,cp16 from caseprogress,staff where cp60='" & strA1K01 & "' and cp10='926' and st01(+)=cp14 and st15='F21' and cp14<>'" & .Fields("cp14") & "' and cp16>0"
                              intA = 1
                              Set rsAD = ClsLawReadRstMsg(intA, strTmp)
                              If intA = 1 Then
                                 douPt1 = Round(rsAD("cp16") / 1000, 3)
                                 douPt = douPt - douPt1
                                 stSQL = "insert into ACC1N0(a1n01,a1n02,a1n03,a1n04,a1n05)" & _
                                    " values ('" & strA1K01 & "','2','" & rsAD("cp09") & "','" & rsAD("cp14") & "'," & douPt1 & ")"
                                 cnnConnection.Execute stSQL, intR
                                 douPt2Sum = douPt2Sum + douPt1
                              End If
                           End If
                        'end 2025/8/11
                           
                        End If
                        
                        Select Case .Fields("st15")
                           '外商程序也分配點數
                           'Case "F12"
                           '   douPtF4103 = douPtF4103 + douPt
                              
                           'modify by sonia 2018/3/15 +"F23"承辦組(X10519384,X10309015)
                           Case "F22", "F23", "F51", "F52"
                              If bolFMP = False Then
                                 'Modified by Morgan 2015/5/26
                                 'douPtF4102 = douPtF4102 + douPt
                                 Select Case .Fields("a1l03")
                                    Case "P", "PS", "CFP", "CPS"
                                       douPtP1001 = douPtP1001 + douPt
                                    Case Else
                                       douPtF4102 = douPtF4102 + douPt
                                 End Select
                                 'end 2015/5/26
                              End If
                              
                           Case Else
                              Select Case Left(.Fields("st15"), 2)
                                 Case "P1"
                                    'Modify by Morgan 2010/5/17 +FMP案控制
                                    If bolFMP = False Then
                                       douPtP1001 = douPtP1001 + douPt
                                    End If
                                 Case "P2"
                                    douPtP2001 = douPtP2001 + douPt
                                    
                                 Case Else
                                    '外專承辦的檢視中說=*50%,其餘歸部門所有
                                    'cancal by sonia 2018/8/17 改為全數歸承辦人
                                    'If .Fields("a1l04") = "209" And .Fields("st15") = "F21" Then
                                    '   douPt1 = douPt - Round(douPt * 0.5, 3)
                                    '   'Modify by Morgan 2010/5/17 +FMP案控制
                                    '   If Not bolFMP Then
                                    '      douPtF4102 = douPtF4102 + douPt1
                                    '   End If
                                    '   douPt = douPt - douPt1
                                    'End If
                                    'end 2018/8/17
                                    strA1n04 = .Fields("cp14")
                                    
                              End Select
                        End Select
                     End If
                     
                     If strA1n04 <> "" Then
                        '有點數或承辦人不同時新增
                        If douPt <> 0 Or InStr(strA1N04s, strA1n04 & ",") = 0 Then
                           stSQL = "insert into ACC1N0(a1n01,a1n02,a1n03,a1n04,a1n05,a1n06)" & _
                              " values ('" & strA1K01 & "','2','" & strA1N03 & "','" & strA1n04 & "'," & douPt & ",'')"
                           cnnConnection.Execute stSQL, intR
                           douPt2Sum = douPt2Sum + douPt 'add by sonia 2017/10/23
                           If douPt = 0 Then bolNeedModify = True
                           'Add by Morgan 2010/5/17 +FMP案控制
                           If bolFMP Then douPtF4102 = douPtF4102 - douPt
                           
                        End If
                        strA1N04s = strA1N04s & strA1n04 & ","
                     End If
                     strLastA1l04 = .Fields("a1l04")
                     .MoveNext
                  Loop
                  End With
                  
                  If douPtP1001 <> 0 Then
                     stSQL = "insert into ACC1N0(a1n01,a1n02,a1n03,a1n04,a1n05,a1n06)" & _
                           " values ('" & strA1K01 & "','2',' ','P1001'," & douPtP1001 & ",'')"
                     cnnConnection.Execute stSQL, intR
                     douPt2Sum = douPt2Sum + douPtP1001 'add by sonia 2017/10/23
                  End If
                  If douPtP2001 <> 0 Then
                     stSQL = "insert into ACC1N0(a1n01,a1n02,a1n03,a1n04,a1n05,a1n06)" & _
                           " values ('" & strA1K01 & "','2',' ','P2001'," & douPtP2001 & ",'')"
                     cnnConnection.Execute stSQL, intR
                     douPt2Sum = douPt2Sum + douPtP2001 'add by sonia 2017/10/23
                  End If
                  If douPtF4101 <> 0 Then
                     stSQL = "insert into ACC1N0(a1n01,a1n02,a1n03,a1n04,a1n05,a1n06)" & _
                           " values ('" & strA1K01 & "','2',' ','F4101'," & douPtF4101 & ",'')"
                     cnnConnection.Execute stSQL, intR
                     douPt2Sum = douPt2Sum + douPtF4101 'add by sonia 2017/10/23
                  End If
                  
                  If douPtF4102 <> 0 Then
                     stSQL = "insert into ACC1N0(a1n01,a1n02,a1n03,a1n04,a1n05,a1n06)" & _
                           " values ('" & strA1K01 & "','2',' ','F4102'," & douPtF4102 & ",'')"
                     cnnConnection.Execute stSQL, intR
                     douPt2Sum = douPt2Sum + douPtF4102 'add by sonia 2017/10/23
                  End If
                  If douPtF4103 <> 0 Then
                     stSQL = "insert into ACC1N0(a1n01,a1n02,a1n03,a1n04,a1n05,a1n06)" & _
                           " values ('" & strA1K01 & "','2',' ','F4103'," & douPtF4103 & ",'')"
                     cnnConnection.Execute stSQL, intR
                     douPt2Sum = douPt2Sum + douPtF4103 'add by sonia 2017/10/23
                  End If
                  
                  For ii = 1 To arrSize
                     stSQL = "update acc1n0 set a1n05=a1n05+" & arrXData(3, ii) & " where a1n01='" & strA1K01 & "'" & _
                        " and a1n02='2' and a1n03='" & arrXData(2, ii) & "' and a1n04='" & arrXData(1, ii) & "'"
                     cnnConnection.Execute stSQL, intR
                     If intR = 0 Then
                        stSQL = "insert into ACC1N0(a1n01,a1n02,a1n03,a1n04,a1n05,a1n06)" & _
                           " values ('" & strA1K01 & "','2','" & arrXData(2, ii) & "','" & arrXData(1, ii) & "'" & _
                           " ," & arrXData(3, ii) & ",'')"
                        cnnConnection.Execute stSQL, intR
                     End If
                     douPt2Sum = douPt2Sum + arrXData(3, ii) 'add by sonia 2017/10/23
                  Next
               End If
            End If
         End If
      End If
   

   
   'add by sonia 2017/10/18 FCP及FMP案B類收文927其他翻譯且承辦人為外翻編號且相關總收文號為C類之結匯金額,要扣除專業之工程師點數
   strTmp = "select a1p07,a1w01,a1w02,cp60,cp61 from acc1w0,caseprogress,acc1p0 where a1w01='" & strA1K01 & "' and substr(a1w02,1,1)='B' and a1w02=cp09(+) " & _
               "and cp01 in ('P','FCP') and cp10='927' and substr(cp14,1,1)='F' and substr(cp43,1,1)='C' and cp61||a1w02=a1p23 and a1p07>0"
   intA = 1
   Set rsAD = ClsLawReadRstMsg(intA, strTmp)
   If intA = 1 Then
      '計算總點數與專業點數差額
      douPt2Sum = douPt2Sum - douPtSum '點數差額
      If douPtF4102 < 0 Then douPt2Sum = douPt2Sum - douPtF4102 'add by sonia 2024/11/6
      If douPt2Sum > 0 Then
         '專業點數之工程師只有一個且點數夠扣時才直接扣掉
         strTmp = "select a1n04,sum(a1n05) a1n05,max(a1n05) max from acc1n0,staff where a1n01='" & strA1K01 & "' and a1n02='2' and a1n04=st01(+) and st03='F21' and a1n04<>'F4102' group by a1n04"
         intA = 1
         Set rsAD = ClsLawReadRstMsg(intA, strTmp)
         If intA = 1 Then
            If rsAD.RecordCount = 1 And rsAD.Fields("max") > douPt2Sum Then
               stSQL = "update acc1n0 set a1n05=a1n05-" & douPt2Sum & " where (a1n01,a1n02,a1n03,a1n04) in " & _
                       "(select a1n01,a1n02,a1n03,a1n04 from acc1n0,staff where a1n01='" & strA1K01 & "' and a1n02='2' and a1n04=st01(+) and st03='F21' and a1n04<>'F4102') and a1n05=" & rsAD.Fields("max")
               cnnConnection.Execute stSQL, intR
               'add by sonia 2024/11/6
               If douPtF4102 < 0 Then
                  stSQL = "delete acc1n0 where a1n01='" & strA1K01 & "' and a1n02='2' and a1n04='F4102'"
                  cnnConnection.Execute stSQL, intR
               End If
               'end 2024/11/6
            'add by sonia 2024/11/6 工程師若不只一筆則扣C類來函那筆，若不夠扣則扣A類
            Else
               strTmp = "select * from acc1n0,Staff where a1n01='" & strA1K01 & "' and a1n02='2' And A1n04=St01(+) And St03='F21' And A1n04<>'F4102' and a1n05>=" & douPt2Sum & " order by a1n03 desc"
               intA = 1
               Set rsAD = ClsLawReadRstMsg(intA, strTmp)
               If intA = 1 Then
                  stSQL = "update acc1n0 set a1n05=a1n05-" & douPt2Sum & " where a1n01='" & strA1K01 & "' and a1n02='2' and a1n03='" & rsAD.Fields("a1n03") & "' and a1n04='" & rsAD.Fields("a1n04") & "'"
                  cnnConnection.Execute stSQL, intR
                  If douPtF4102 < 0 Then
                     stSQL = "delete acc1n0 where a1n01='" & strA1K01 & "' and a1n02='2' and a1n04='F4102'"
                     cnnConnection.Execute stSQL, intR
                  End If
               End If
            'end 2024/11/6
            End If
         End If
      End If
   End If
   'end 2017/10/18
   
   If bolCredit Then PUB_ReAssignPoint strA1K01, True  'Added by Morgan 2018/3/21
   
   If Not bolExistsTrans Then
      cnnConnection.CommitTrans
   End If
   If Not bolNeedModify Then
      PUB_PointAutoassign = True
   End If
   
   GoTo ExitPort

ErrHnd:
   If Not bolExistsTrans Then
      cnnConnection.RollbackTrans
      MsgBox Err.Description
   Else
      Err.Raise Err.Number
   End If
   
ExitPort:
   Set adoRst = Nothing
   Set adoRst2 = Nothing
   Set rsAD = Nothing 'Added by Lydia 2024/05/14
   
End Function

'Add by Morgan 2010/5/21
Public Function PUB_ReAssignPoint(strA1K01 As String, Optional bolExistsTrans As Boolean = False) As Boolean
   Dim stSQL As String, intR As Integer, ii As Integer
   Dim adoRst As ADODB.Recordset, adoRst2 As New ADODB.Recordset
   Dim lngPtSumK As Long '請款單總點數
   Dim lngPtSumN As Long '目前分配總點數
   Dim lngPtRest As Long '未分配點數
   Dim lngPt As Long
   
On Error GoTo ErrHnd

   If Not bolExistsTrans Then
      cnnConnection.BeginTrans
   End If
   'Modify By Sindy 2013/1/10
'   stSQL = "select trunc(a1k11-nvl(a1k09,0)-nvl(a1k06,0)*nvl(a1k10,0))" & _
'      " from acc1k0 where a1k01='" & strA1k01 & "'"
   'Modified by Morgan 2018/3/20 +a1k36
   stSQL = "select trunc(a1k11-nvl(a1k09,0)-nvl(a1k06,0)+nvl(a1k36,0))" & _
      " from acc1k0 where a1k01='" & strA1K01 & "'"
   '2013/1/10 End
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   'Modify by Morgan 2011/8/29 bug
   'If intI = 1 Then
   If intR = 1 Then
      lngPtSumK = adoRst(0)
      For ii = 1 To 2
         stSQL = "select nvl(sum(a1n05),0),count(*) from acc1n0 where a1n01='" & strA1K01 & "' and a1n02='" & ii & "'"
         intR = 1
         Set adoRst = ClsLawReadRstMsg(intR, stSQL)
         If intR = 1 Then
            lngPtSumN = adoRst(0) * 1000
            lngPtRest = lngPtSumK
            '點數不同時照比例重新分配
            If lngPtSumK <> lngPtSumN Then
               stSQL = "select * from acc1n0 where a1n01='" & strA1K01 & "' and a1n02='" & ii & "' order by a1n05,a1n04"
               With adoRst2
               .CursorLocation = adUseClient
               .Open stSQL, adoTaie, adOpenDynamic, adLockBatchOptimistic
                  If .RecordCount > 0 Then
                  .MoveFirst
                  'Added by Morgan 2015/4/16 修正除 0 的錯誤
                  '若原來點數為 0 時
                  If lngPtSumN = 0 Then
                     '只有一筆
                     If .RecordCount = 1 Then
                        .Fields("a1n05").Value = lngPtSumK / 1000
                     End If
                  Else
                  'end 2015/4/16
                  
                     Do While Not .EOF
                        lngPt = Fix(lngPtSumK * .Fields("a1n05") * 1000 / lngPtSumN)
                        .Fields("a1n05").Value = lngPt / 1000
                        lngPtRest = lngPtRest - lngPt
                        .MoveNext
                     Loop
                  
                     If lngPtRest > 0 Then
                        .MovePrevious
                        .Fields("a1n05").Value = .Fields("a1n05").Value + lngPtRest / 1000
                     End If
                     
                  End If 'Added by Morgan 2015/4/16
                  
                  .UpdateBatch
               End If
               .Close
               End With
            End If
         End If
      Next
   End If
   
   If Not bolExistsTrans Then
      cnnConnection.CommitTrans
   End If
   
   PUB_ReAssignPoint = True
   
   GoTo ExitPort

ErrHnd:
   If Not bolExistsTrans Then
      cnnConnection.RollbackTrans
      MsgBox Err.Description
   Else
      Err.Raise Err.Number
   End If
   
ExitPort:
   Set adoRst = Nothing
   Set adoRst2 = Nothing
End Function

'Add by Morgan 2010/2/8
'檢查客戶名稱是否存在
Public Function PUB_ChkCustNameExist(Optional strChinese As String, Optional strEnglish As String, Optional strJapanese As String, Optional bolMsg As Boolean = True, Optional strCustNo As String) As Boolean
   Dim stSQL As String, intR As Integer
   Dim adoRst As ADODB.Recordset
   Dim stSql_C As String, stSql_E As String, stSql_J As String 'Add by Amy 2022/09/07
   
   'Add by Amy 2022/09/07 去掉逗點、句點、空白-秀玲
   strChinese = Replace(Replace(Replace(Replace(Replace(Replace(Replace(UCase(strChinese), ",", ""), "，", ""), ".", ""), "．", ""), "。", ""), " ", ""), "　", "")
   strEnglish = Replace(Replace(Replace(Replace(Replace(Replace(Replace(UCase(strEnglish), ",", ""), "，", ""), ".", ""), "．", ""), "。", ""), " ", ""), "　", "")
   strJapanese = Replace(Replace(Replace(Replace(Replace(Replace(Replace(UCase(strJapanese), ",", ""), "，", ""), ".", ""), "．", ""), "。", ""), " ", ""), "　", "")
   
   stSql_C = "Replace(Replace(Replace(Replace(Replace(Replace(Replace(Upper(cu04),',',''),'，',''),'.',''),'．',''),'。',''),' ',''),'　','')"
   stSql_E = "Replace(Replace(Replace(Replace(Replace(Replace(Replace(Upper(cu05||' '||cu88||' '||cu89||' '||cu90),',',''),'，',''),'.',''),'．',''),'。',''),' ',''),'　','')"
   stSql_J = "Replace(Replace(Replace(Replace(Replace(Replace(Replace(Upper(cu06),',',''),'，',''),'.',''),'．',''),'。',''),' ',''),'　','')"
   'end 2022/09/07
    
   If strChinese & strEnglish & strJapanese <> "" Then
      '2011/5/12 modify by sonia 加顯示業務區+智權人員
      'stSQL = "select cu01||cu02 from customer where upper(ltrim(rtrim(cu04)))=upper(ltrim(rtrim('" & ChgSQL(strChinese) & "')))" & _
         " Or upper(ltrim(rtrim(cu05||' '||cu88||' '||cu89||' '||cu90)))=upper(ltrim(rtrim('" & ChgSQL(strEnglish) & "')))" & _
         " Or upper(ltrim(rtrim(cu06)))=upper(ltrim(rtrim('" & ChgSQL(strJapanese) & "')))"
      'Modify by Amy 2022/09/07 去掉逗點、句點、空白-秀玲
      stSQL = "select cu01||cu02,decode(cu13,null,'無智權人員管制',a0902||st02||decode(st51,null,null,'(已離職)')) from customer,staff,acc090 " & _
         "where (upper(ltrim(rtrim(" & stSql_C & ")))=upper(ltrim(rtrim('" & ChgSQL(strChinese) & "')))" & _
         " Or upper(ltrim(rtrim(" & stSql_E & ")))=upper(ltrim(rtrim('" & ChgSQL(strEnglish) & "')))" & _
         " Or upper(ltrim(rtrim(" & stSql_J & ")))=upper(ltrim(rtrim('" & ChgSQL(strJapanese) & "')))) and cu13=st01(+) and st15=a0901(+)"
      intR = 1
      Set adoRst = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         PUB_ChkCustNameExist = True
         With adoRst
            '2011/5/12 modify by sonia
            'strCustNo = adoRst(0)
            strCustNo = adoRst(0) & " (" & adoRst(1) & ") "
            .MoveNext
            Do While Not .EOF
               '2011/5/12 modify by sonia
               'strCustNo = strCustNo & "," & adoRst(0)
               strCustNo = strCustNo & "," & adoRst(0) & " (" & adoRst(1) & ") "
               .MoveNext
            Loop
         End With
         If bolMsg Then MsgBox "對造名稱與本所客戶【" & Trim(strCustNo) & "】相同，請通知承辦人員特別留意！"
      End If
   End If
   Set adoRst = Nothing
End Function

'Added by Morgan 2022/3/22
'計算印尼發明/新型第1次繳年費期限=第1次為核准日6個月內須繳交自申請日起算累計至核准日次年之年費
Public Function GetIDN1st605FeeDate(pStartDate As String)
   GetIDN1st605FeeDate = CompDate(1, 6, pStartDate)
End Function
' 依給定的年度取得計算後的日期
Public Function GetFeeNextDate(ByVal strStartDate As String, ByVal strFeeYear As String, ByVal strNation As String, ByVal strPatent As String) As String
   Dim strDate As String
   Dim nYear As Integer
   Dim nMonth As Integer
   Dim strReduceOne As String 'Added by Morgan 2019/12/4
   
   nYear = Int(strFeeYear)
   nMonth = (CDbl(strFeeYear) - CDbl(nYear)) * 12
   '93.3.2 modify by sonia
   'strStartDate = DBDATE(DateSerial(Val(DBYEAR(strStartDate)) + nYear, Val(DBMONTH(strStartDate)) + nMonth, Val(DBDAY(strStartDate))))
   'Modified by Morgan 2019/12/4 計算專用期止日要減1天者年費/延展費期限也要減1天,Ex:新加坡設計案
   'strStartDate = DateAdd("m", nMonth, DateAdd("yyyy", nYear, ChangeWStringToWDateString(strStartDate)))
   Call ClsPDGetNationTax(Val(strPatent), strNation, , , , , , strReduceOne)
   strStartDate = PUB_GetEndDate(strStartDate, Val(strFeeYear), strReduceOne, strNation)
   strStartDate = ChangeWStringToWDateString(strStartDate) 'Added by Morgan 2019/12/11
   'end 2019/12/4
   '93.3.2 end
   '2005/8/24 ADD BY SONIA 阿根延設計須於期滿前6個月辦理 CFP-017348
   If strNation = "118" And strPatent = "3" Then
     strStartDate = CompDate(1, -6, ChangeWDateStringToWString(strStartDate))
      strStartDate = ChangeWStringToWDateString(CompDate(2, -1, strStartDate))
   End If
   '2005/8/24 END
   '2008/3/21 ADD BY SONIA沙烏地阿拉伯,年費期限為每年3/31
   If strNation = "021" Then
      strStartDate = ChangeWStringToTString(Mid(strStartDate, 1, 4) + "0331")
   End If
   '2008/3/21 END
   
   'Added by Morgan 2016/10/28
   '印尼發明及新型的年費期限第1次為發證日+6個月,第2次以後為屆滿前1個月
   'Memo by Morgan 2022/3/22
   '印尼發明及新型的年費期限第1次改為核准日6個月內須繳交自申請日起算累計至核准日次年之年費，之後則逐年提前於屆滿前1個月(申請日)繳交
   If strNation = "017" And (strPatent = "1" Or strPatent = "2") Then
     strStartDate = CompDate(1, -1, ChangeWDateStringToWString(strStartDate))
   End If
   'end 2016/10/28
   
   GetFeeNextDate = strStartDate
End Function

'Add By Sindy 2010/5/26 檢查是否為系統特殊設定之人員
Public Function CheckLevel(p_UID As String, p_Code As String) As Boolean
   Dim stSQL As String
   Dim intQ As Integer, rsQuery As ADODB.Recordset 'Added by Morgan 2020/8/31
   
   stSQL = "select OMAN from SetSpecMan where OCODE='" & p_Code & "'"
   'Modified by Morgan 2020/8/31
   'intI = 1
   'Set RsTemp = ClsLawReadRstMsg(intI, stSQL)
   'If intI = 1 Then
   '   If InStr("" & RsTemp(0), p_UID) > 0 Then
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      If InStr("" & rsQuery(0), p_UID) > 0 Then
   'end 2020/8/31
         CheckLevel = True
      End If
   End If
   Set rsQuery = Nothing 'Added by Lydia 2024/05/15
End Function
'Add by Morgan 2010/6/17
'Modify by Morgan 2011/6/30 申請人同發明人實審費調整,超項費調整
'韓國發明新型實審費提醒
'ItemCnt:項數
Public Sub Alert416Fee(ItemCnt As String, PA09 As String, PA157 As String, PA08 As String, Optional CP44 As String)
   Dim stFee(4) As String
   Dim stSQL As String, intR As Integer
   Dim adoRst As ADODB.Recordset
   Dim stMsg As String
   
   If PA09 <> "012" Then Exit Sub
   
   stFee(1) = Val(ItemCnt)
   stFee(2) = ""
   stFee(3) = ""
   If Val(stFee(1)) > 0 Then
      If PA157 = "Y" Then
         If PA08 = "1" Then
            stFee(2) = "14000"
            stFee(3) = "1100"
         ElseIf PA08 = "2" Then
            stFee(2) = "14000"
            stFee(3) = "900"
         End If
      Else
         stSQL = "SELECT NVL(YF06,0)+NVL(YF07,0) FROM PATENTYEARFEE WHERE YF01='" & PA09 & "' AND YF02='" & PA08 & "' AND (YF03='" & GetNewFagent(CP44) & "' or YF03='Y00000000') AND YF04='416' AND YF05='1' order by YF03 desc"
         intR = 1
         Set adoRst = ClsLawReadRstMsg(intR, stSQL)
         If intR = 1 Then
            stFee(2) = Val("" & adoRst(0))
            If PA08 = "1" Then
               stFee(3) = "2000"
            ElseIf PA08 = "2" Then
               stFee(3) = "1300"
            End If
         End If
      End If
      If stFee(2) <> "" And stFee(3) <> "" Then
         If Val(stFee(1)) > 3 Then
            stFee(4) = Val(stFee(2)) + Val(stFee(3)) * (Val(stFee(1)) - 3)
         Else
            stFee(4) = stFee(2)
         End If
         If PA157 = "Y" Then
            stMsg = "本案申請人同發明人，"
         End If
         MsgBox stMsg & "實審費用預估為 " & Format(stFee(4), DDollar) & " 元。"
      End If
   End If
   Set adoRst = Nothing
End Sub
'Add by Morgan 2009/12/1
'設定FMP案的承辦期限
Public Function PUB_GetFmpCP48(ByVal pCP05 As String, ByVal pCP06 As String, ByVal pCP07 As String, ByVal pCP133 As String, ByVal pCP134 As String, Optional ByRef pNP23 As String, Optional ByRef pCP48Desc As String) As String
   Dim stDate1 As String, stDate2 As String, iDays3 As Integer, iDaysRest As Integer, stCP48 As String
   pNP23 = "" '約定期限=法限-14天(例外:1個月的法限時為所限-3天)
   '1個月
   If Val(pCP134) = 1 Then
      pNP23 = PUB_GetWorkDay1(CompDate(2, -3, pCP06), True)
      '承辦期限1=官方發文日起7天
      stDate1 = CompDate(2, 7, pCP133)
      '承辦期限2=收文日起3天
      stDate2 = CompDate(2, 3, pCP05)
      '承辦期限3天數
      iDays3 = 3
   Else
      pNP23 = PUB_GetWorkDay1(CompDate(2, -14, pCP07), True)
      '2個月
      If Val(pCP134) = 2 Then
         '承辦期限1=官方發文日起14天
         stDate1 = CompDate(2, 14, pCP133)
         '承辦期限2=收文日起7天
         stDate2 = CompDate(2, 7, pCP05)
         '承辦期限3天數
         iDays3 = 3
      '3個月以上
      ElseIf Val(pCP134) >= 3 Then
         '承辦期限1=官方發文日起21天
         stDate1 = CompDate(2, 21, pCP133)
         '承辦期限2=收文日起14天
         stDate2 = CompDate(2, 14, pCP05)
         '承辦期限3天數
         iDays3 = 7
      End If
   End If
   '剩餘天數=法限-收文日
   iDaysRest = CDate(Format(pCP07, "####/##/##")) - CDate(Format(pCP05, "####/##/##"))
   '距法限已少於一半期限
   If iDaysRest < 15 * Val(pCP134) Then
      pCP48Desc = "距法限已少於一半期限"
      stCP48 = CompDate(2, iDays3, pCP05)
   ElseIf Val(stDate1) > Val(stDate2) Then
      pCP48Desc = "自官方發文日起算"
      stCP48 = stDate1
   Else
      pCP48Desc = "自本所收文日起算"
      stCP48 = stDate2
   End If
   
   '不可晚於約定期限
   If Val(stCP48) > Val(pNP23) Then
      stCP48 = pNP23
   End If
   
   stCP48 = PUB_GetWorkDay1(stCP48, True)
   
   '不可小於系統日
   If Val(stCP48) < Val(strSrvDate(1)) Then
      stCP48 = strSrvDate(1)
   End If
   
   PUB_GetFmpCP48 = stCP48
End Function

'Add By Sindy 2010/7/8
Public Function CheckTMGoodsErr(ByVal strTM01 As String, ByVal strTM02 As String, ByVal strTM03 As String, ByVal strTM04 As String, Optional ByRef bMsgBox As Boolean, Optional ByRef bSendMail As Boolean, Optional ByRef strCP14 As String) As Boolean
Dim strTM09 As String, dblGoods As Double, strTG05 As String
Dim j  As Integer
Dim varTemp As Variant
'Added by Lydia 2016/03/11
Dim strTM10 As String '國別
Dim strTtmp As String
Dim strTmp As String, intA As Integer, rsAD As New ADODB.Recordset  'Added by Lydia 2024/05/14

   CheckTMGoodsErr = False
   '先檢查是否有商品資料
   'Modify By Sindy 2014/5/26 加過濾未延展商品
   strTmp = "select count(tg05) from tmgoods where tg01='" & strTM01 & "' and tg02='" & strTM02 & "' and tg03='" & strTM03 & "' and tg04='" & strTM04 & "' and tg18 is null"
   intA = 1
   Set rsAD = ClsLawReadRstMsg(intA, strTmp)
   If intA = 1 Then
      If rsAD.Fields(0) > 0 Then
         dblGoods = rsAD.Fields(0)
         '讀取基本檔
         strTmp = "select * from trademark where tm01='" & strTM01 & "' and tm02='" & strTM02 & "' and tm03='" & strTM03 & "' and tm04='" & strTM04 & "' "
         intA = 1
         Set rsAD = ClsLawReadRstMsg(intA, strTmp)
         strTM09 = ""
         If intA = 1 Then
            strTM09 = "" & rsAD.Fields("TM09")
            'Added by Lydia 2016/03/11 收信人(strCP14)改為模組判斷
            strTM10 = "" & rsAD.Fields("TM10")
            If strTM01 = "CFT" Then
                'Modified by Lydia 2016/11/21 +美國和歐盟
                'If strTM10 = "011" Then '日本
                If InStr("011,101,239", strTM10) > 0 Then  '日本、美國、歐盟
                    strTtmp = PUB_GetAKindSalesNo(strTM01, strTM02, strTM03, strTM04)  '抓最近收文A類接洽記錄單的智權人員
                End If
                'Modified by Lydia 2017/05/12 GetNP69更名為GetNA69
                Call GetNA69("", strTM10, "" & strTtmp, strCP14, strTM01, strTM02, strTM03, strTM04)
            End If
            'end 2016/03/11
         End If
         '比對商品類別數量是否一致
         If strTM09 = "" Then
            CheckTMGoodsErr = True
         Else
            varTemp = Split(strTM09, ",")
            If (UBound(varTemp) + 1) <> dblGoods Then CheckTMGoodsErr = True
            '比對商標類別是否相同
            For j = 0 To UBound(varTemp)
               strTmp = "select count(*) from tmgoods where tg01='" & strTM01 & "' and tg02='" & strTM02 & "' and tg03='" & strTM03 & "' and tg04='" & strTM04 & "' and tg05='" & Trim(varTemp(j)) & "' "
               intA = 1
               Set rsAD = ClsLawReadRstMsg(intA, strTmp)
               If intA = 1 Then
                  If rsAD.Fields(0) = 0 Then CheckTMGoodsErr = True
               End If
            Next j
         End If
         '取得TG商品類別
         strTG05 = ""
         If CheckTMGoodsErr = True And bSendMail = True Then
            'Modify By Sindy 2014/5/26 加過濾未延展商品
            strTmp = "select tg05 from tmgoods where tg01='" & strTM01 & "' and tg02='" & strTM02 & "' and tg03='" & strTM03 & "' and tg04='" & strTM04 & "' and tg18 is null order by tg05 asc"
            intA = 1
            Set rsAD = ClsLawReadRstMsg(intA, strTmp)
            If intA = 1 Then
               With rsAD
                  rsAD.MoveFirst
                  Do While Not .EOF
                     If strTG05 <> "" Then
                        strTG05 = strTG05 & ","
                     End If
                     strTG05 = strTG05 & rsAD.Fields(0)
                     rsAD.MoveNext
                  Loop
               End With
            End If
         End If
      End If
   End If
   
   Set rsAD = Nothing 'Added by Lydia 2024/05/14
    
   If CheckTMGoodsErr = True And bMsgBox = True Then
      '顯示訊息
      MsgBox "商品及服務的商品類別與基本檔不符，請進行修改！"
   End If
   If CheckTMGoodsErr = True And bSendMail = True Then
      '發Mail
      PUB_SendMail strUserNum, strCP14, "", "此案號的商品及服務檔的商品類別與基本檔不符，請儘速修改，謝謝！", "本所案號：" + strTM01 & "-" & strTM02 & "-" & strTM03 & "-" & strTM04 & vbCrLf & _
      "基本檔商商品類別：" + strTM09 & vbCrLf & _
      "商品及服務檔商品類別：" + strTG05
   End If
End Function

'Move by Lydia 2016/03/18 從basPublic搬來
'Add By Sindy 2014/9/11 CFT承辦人(管制人)
'Modified by Lydia 2016/03/11 +案號strCP01~strCP04
'Modified by Lydia 2017/05/12 GetNP69更名為GetNA69
'Memo by Lydia 2022/09/21 增加CFC案承辦人
Public Function GetNA69(ByVal strChkUser As String, ByVal strNA01 As String, Optional ByVal strCP13 As String, _
                        Optional ByRef strNA69 As String, Optional ByVal strCP01 As String, Optional ByVal strCP02 As String, Optional ByVal strCP03 As String, Optional ByVal strCP04 As String) As Boolean
Dim RsAdo As New ADODB.Recordset
Dim strTmp(0 To 1)  As String, intA As Integer  'Added by Lydia 2024/05/14

   strNA69 = ""
   'Modified by Lydia 2017/05/12 GetNP69更名為GetNA69
   GetNA69 = False
   'Added by Lydia 2022/09/21 CFC之美國案改抓Pub_GetSpecMan("CFC案承辦人")、非美國案則依各國設定
   If strCP01 = "CFC" And Left(Trim(strNA01), 3) = "101" Then
        strNA69 = Pub_GetSpecMan("CFC案承辦人")
   'end 2022/09/21
   
   '取得CFT承辦人
   'Modified by Lydia 2022/09/21
   'If Left(Trim(strNA01), 3) = "011" Then '日本
   ElseIf Left(Trim(strNA01), 3) = "011" Then '日本
      If PUB_GetST06(strCP13) = "1" Then '北所
         strTmp(0) = "select OMAN from SetSpecMan where OCODE='CFT_011B'"
         intA = 1
         Set RsAdo = ClsLawReadRstMsg(intA, strTmp(0))
         If intA = 1 Then
            If Not IsNull(RsAdo.Fields(0)) Then
               strNA69 = RsAdo.Fields(0)
            End If
         End If
      Else '中南高
         strTmp(0) = "select OMAN from SetSpecMan where OCODE='CFT_011A'"
         intA = 1
         Set RsAdo = ClsLawReadRstMsg(intA, strTmp(0))
         If intA = 1 Then
            If Not IsNull(RsAdo.Fields(0)) Then
               strNA69 = RsAdo.Fields(0)
            End If
         End If
      End If
   'Added by Lydia 2016/11/16 美國及歐盟案件分區
   ElseIf Left(Trim(strNA01), 3) = "101" Or Trim(strNA01) = "239" Then
         strTmp(1) = PUB_GetST06(strCP13)
         If strTmp(1) = "1" Or strTmp(1) = "2" Then '北中所
            'Modified by Lydia 2025/04/30 將原本的美國+歐盟案設定分開
            If strTmp(1) = "1" Then 'Added by Lydia 2018/10/03 拆開北所和中所
                'Modified by Lydia 2025/04/30 將原本的美國+歐盟案設定分開
                'strTmp(0) = "select OMAN from SetSpecMan where OCODE='CFT_101239B'" '北所
                strTmp(0) = "select OMAN from SetSpecMan where OCODE='CFT_" & Left(Trim(strNA01), 3) & "B'" '北所
            Else
                'Modified by Lydia 2025/04/30 將原本的美國+歐盟案設定分開
                'strTmp(0) = "select OMAN from SetSpecMan where OCODE='CFT_101239C'" '中所
                 strTmp(0) = "select OMAN from SetSpecMan where OCODE='CFT_" & Left(Trim(strNA01), 3) & "C'" '中所
            End If
            ''end 2018/10/03
            intA = 1
            Set RsAdo = ClsLawReadRstMsg(intA, strTmp(0))
            If intA = 1 Then
               If Not IsNull(RsAdo.Fields(0)) Then
                  strNA69 = RsAdo.Fields(0)
               End If
            End If
         Else                                       '南高所
            'Modified by Lydia 2025/04/30 將原本的美國+歐盟案設定分開
            'strTmp(0) = "select OMAN from SetSpecMan where OCODE='CFT_101239A'"
            strTmp(0) = "select OMAN from SetSpecMan where OCODE='CFT_" & Left(Trim(strNA01), 3) & "A'"
            intA = 1
            Set RsAdo = ClsLawReadRstMsg(intA, strTmp(0))
            If intA = 1 Then
               If Not IsNull(RsAdo.Fields(0)) Then
                  strNA69 = RsAdo.Fields(0)
               End If
            End If
         End If
   'end 2016/11/16
   Else
      '取得國家檔設定的CFT承辦人
      'Added by Lydia 2016/03/11 改成模組(DB.Functions)
      'Remove by Lydia 2016/03/24 外商反應未考慮好,先移除
      'If strCP01 = "CFT" Then
      '   strtmp(0) = "SELECT GETNA69('" & strCP01 & "','" & strCP02 & "','" & strCP03 & "','" & strCP04 & "','','') NA69 FROM dual"
      'Else
      'end 2016/03/11
         strTmp(0) = "SELECT NA69 FROM NATION WHERE NA01='" & strNA01 & "'"
      'End If
      'end 2016/03/24
      
      intA = 1
      Set RsAdo = ClsLawReadRstMsg(intA, strTmp(0))
      If intA = 1 Then
         If Not IsNull(RsAdo.Fields(0)) Then
            strNA69 = RsAdo.Fields(0)
         End If
      End If
   End If
   '檢查人員是否已離職
   If strNA69 <> "" Then
      '若已離職則掛該人員之ST52
      If ChkStaffST04(strNA69, False) = True Then
         strTmp(0) = "SELECT ST52 FROM staff WHERE ST01='" & strNA69 & "'"
         intA = 1
         Set RsAdo = ClsLawReadRstMsg(intA, strTmp(0))
         If intA = 1 Then
            If Not IsNull(RsAdo.Fields(0)) Then
               strNA69 = RsAdo.Fields(0)
            End If
         End If
      End If
   End If
   '檢查傳入的值是否為CFT承辦人
   If strChkUser = strNA69 Then
      'Modified by Lydia 2017/05/12 GetNP69更名為GetNA69
      GetNA69 = True
   End If
   
   Set RsAdo = Nothing
End Function
'Add By Sindy 2010/8/13 比對自動編號年度
Public Function CompAutoNumberYear(strYear As String) As String
   CompAutoNumberYear = ""
   If Val(strYear) <= 99 Then
      CompAutoNumberYear = strYear
   Else
      If Val(strYear) > 199 Then
         MsgBox "此年度編碼已不符使用，請洽資訊人員，謝謝！"
      Else
         CompAutoNumberYear = Chr(Val(Mid(strYear, 2, 1)) + 65) & Right(strYear, 1)
      End If
   End If
End Function

'Add by Morgan 2010/9/28
'是否設定承辦期限(新規則改次日凌晨計算設定)
Public Function PUB_IfSetCP48(Optional p_CP09 As String) As Boolean
   '舊規則
   If Not bolNewPromoterRule Then
      PUB_IfSetCP48 = True
   '新規則非FMP案
   ElseIf p_CP09 <> "" Then
      PUB_IfSetCP48 = PUB_IsFMP(p_CP09)
   End If
End Function
'是否為FMP案
Public Function PUB_IsFMP(p_CP09 As String) As Boolean
   Dim stSQL As String, intR As Integer
   Dim rsTmp As ADODB.Recordset
   stSQL = "select cp12 from caseprogress where cp09='" & p_CP09 & "' and cp01='P'"
   intR = 1
   Set rsTmp = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      If Left(rsTmp.Fields(0), 1) = "F" Then
         PUB_IsFMP = True
      End If
   End If
   Set rsTmp = Nothing
End Function
'2010/11/19 ADD BY SONIA COPY FROM frm04010502_3的GetFee,但只抓規費
'取得大陸領證費規費,傳入本所案號,cp44及核准年度
'Memo by Morgan 2018/2/27 ！！！注意:若有用到　pa(1),pa(8),pa(9),pa(26)　以外的值時,frm210138 也要改！！！
Public Function PUB_Get020601Fee(ByRef pa() As String, strCP44 As String, strFromYear As String, Optional strToYear As String, Optional ByRef lTmp As Double) As Double
   Dim lBase As Long, lPlus As Long
   Dim lSFee As Long 'Modified by Lydia 2015/03/27
'Public Function PUB_Get020601Fee(ByRef pa() As String, strCP44 As String, strFromYear As String, Optional strToYear As String) As Double
  ' Dim lTmp As Long, lBase As Long, lPlus As Long
   'Modifield by Lydia 2014/12/25 服務費
   '客戶只抓服務費,規費改抓代理人設定,否則調價後會不同步
   
   'Added by Lydia 2015/03/27 +PA01
   lTmp = PUB_GetYF06(pa(9), pa(8), ChangeCustomerL(pa(26)), "601", "1", "1", pa(1))
   If lTmp = 0 Then
      lTmp = PUB_GetYF06(pa(9), pa(8), "Y00000001", "601", "1", "1", pa(1))
   End If
   
   If strToYear = "" Then strToYear = strFromYear 'Add by Morgan 2010/12/23
   
   'Modified by Lydia 2015/03/27 大陸年費服務費第1年=領證費,其他年皆各別要算服務費
   'Modified by Lydia 2015/03/30 修正->第1年為本所服務的第1年,不一定為專利核准第1年
    'If Val(strToYear) > 1 Then
    '   lSFee = PUB_GetYF06(pa(9), pa(8), ChangeCustomerL(pa(26)), "605", "2", strToYear, pa(1))
    If Val(strFromYear) + 1 <= Val(strToYear) Then
       lSFee = PUB_GetYF06(pa(9), pa(8), ChangeCustomerL(pa(26)), "605", str(Val(strFromYear) + 1), strToYear, pa(1))
       lTmp = lTmp + lSFee
    End If
    
   'Modify by Morgan 2010/12/8 因只抓規費不必先抓客戶設定
   '領證費
   If strCP44 <> "" Then
      PUB_Get020601Fee = PUB_GetYF07(pa(9), pa(8), ChangeCustomerL(strCP44), "601", "1", "1", pa(1))
   End If
   If PUB_Get020601Fee = 0 Then
      PUB_Get020601Fee = PUB_GetYF07(pa(9), pa(8), "Y00000001", "601", "1", "1", pa(1))
   End If
   
   If Val(strFromYear) > 0 And (Val(strFromYear) > 3 Or Val(strFromYear) <> Val(strToYear)) Then
      '年費(先抓1-3年的Base金額,再抓輸入大陸年度的金額, 計算出差額, 再加上上面之領證則為大陸領證費)
      If strCP44 <> "" Then
         lBase = PUB_GetYF07(pa(9), pa(8), ChangeCustomerL(strCP44), "605", "3", "3", pa(1))
      End If
      If lBase = 0 Then
         lBase = PUB_GetYF07(pa(9), pa(8), "Y00000001", "605", "3", "3", pa(1))
      End If
   
      If strCP44 <> "" Then
         lPlus = PUB_GetYF07(pa(9), pa(8), ChangeCustomerL(strCP44), "605", strFromYear, strToYear, pa(1))
      End If
      If lPlus = 0 Then
         lPlus = PUB_GetYF07(pa(9), pa(8), "Y00000001", "605", strFromYear, strToYear, pa(1))
      End If
   End If
   PUB_Get020601Fee = PUB_Get020601Fee + lPlus - lBase
End Function
'2010/11/19 END

'add by Toni 20080926 控制共同查詢是否有跨部門查詢案件明細權限
'Modify By Sindy 2020/9/9 + Optional strUseForm As String="" : 指定某作業開放的權限
Public Function CheckSR09(ByVal strUser As String, ByVal strSys As String, ByVal strCrossDept As String, _
   Optional bolMsg As Boolean = True, Optional strCP01 As String, Optional strCP02 As String, _
   Optional strCP03 As String, Optional strCP04 As String, Optional strUseForm As String = "") As Boolean
Dim rsTmp As New ADODB.Recordset
Dim strA1 As String
Dim strTit As String
Dim strMsg As String
Dim nResponse
Dim strCU13 As String
Dim stUsers As String  'add by sonia 2018/5/23
Dim Support_CP14 As String   'add by sonia 2024/3/8
Dim StrSQLa As String, intA As Integer, rsAD As New ADODB.Recordset 'Added by Lydia 2024/05/15

   'Add By Sindy 2020/5/12 TT-999999 不檢查權限
   'modify by sonia 2022/9/22 加L-888888 不檢查權限
   If (strCP01 = "TT" And strCP02 = "999999") Or (strCP01 = "L" And strCP02 = "888888") Then
      CheckSR09 = True
      GoTo EXITSUB
   'Add By Sindy 2020/6/11 LA-999999 基本檔及進度檔只開放 st05 in ('00','01')及法律所人員可查詢。
   ElseIf strCP01 = "LA" And strCP02 = "999999" Then
      If PUB_GetST05(strUser) <> "00" And PUB_GetST05(strUser) <> "01" And PUB_ChkLCompStaff(strUser) = False Then
         CheckSR09 = False
         If bolMsg = True Then
            strTit = "檢核資料"
            strMsg = "您沒有查詢案件明細的權限"
            nResponse = MsgBox(strMsg, vbOKOnly, strTit)
         End If
         GoTo EXITSUB
      End If
   End If
   
   CheckSR09 = True: strCU13 = ""
   If IsUserHasRightOfSystem(strUser, strSys) = False Then
      '2011/5/17 modify by sonia 加傳本所案號
      'If IsUserHasRightOfFunction("frm100101_1", strCrossDept, False) = False Then
      If IsUserHasRightOfFunction("frm100101_1", strCrossDept, False, strCP01, strCP02, strCP03, strCP04) = False Then
'         If bolMsg = True Then
'            strTit = "檢核資料"
'            strMsg = "您沒有跨部門查詢案件明細的權限"
'            nResponse = MsgBox(strMsg, vbOKOnly, strTit)
'         End If
         CheckSR09 = False
         'goto exitsub
      '2008/10/7 ADD BY SONIA 再檢查跨部門查詢權限檔 S1.SDR03(個人權限),S2.SDR03(等級權限)
      Else
         strA1 = "SELECT S1.SDR03,S2.SDR03 FROM STAFF,STAFF_DEPT_RIGHT S1,STAFF_DEPT_RIGHT S2 " & _
                  "WHERE ST01 = '" & strUser & "' AND ST01=S1.SDR01(+) AND '" & strSys & "'=S1.SDR02(+) AND ST05=S2.SDR01(+) AND '" & strSys & "'=S2.SDR02(+) "
         rsTmp.CursorLocation = adUseClient
         rsTmp.Open strA1, cnnConnection, adOpenStatic, adLockReadOnly
         If rsTmp.RecordCount > 0 Then
            If IsNull(rsTmp.Fields(0)) = True And IsNull(rsTmp.Fields(1)) = True Then
'               If bolMsg = True Then
'                  strTit = "檢核資料"
'                  strMsg = "您沒有跨部門查詢案件明細的權限"
'                  nResponse = MsgBox(strMsg, vbOKOnly, strTit)
'               End If
               CheckSR09 = False
               'goto exitsub
            End If
         End If
         rsTmp.Close
      '2008/10/7 END
      End If
      
      'Modify By Sindy 2011/1/20
      '若該操作人員無跨部門權限時, 再檢查該案號的客戶檔智權人員,
      '若客戶檔智權人員為此操作人員則開放可以查詢該案號資料
      If CheckSR09 = False Then
         '2011/5/12 modify by sonia 加部門主管
         'modify by sonia 2022/8/17 加ST14及各級主管
         strA1 = "select cu13,st04,a0908,st14,st52,st53,st54,st55 from trademark,customer,staff,acc090 where tm01='" & strCP01 & "' and tm02='" & strCP02 & "' and tm03='" & strCP03 & "' and tm04='" & strCP04 & "' and cu01=substr(tm23,1,8) and cu02=substr(tm23,9,1) and cu13=st01(+) and st15=a0901(+) " & _
                      "union all " & _
                      "select cu13,st04,a0908,st14,st52,st53,st54,st55 from patent,customer,staff,acc090 where pa01='" & strCP01 & "' and pa02='" & strCP02 & "' and pa03='" & strCP03 & "' and pa04='" & strCP04 & "' and cu01=substr(pa26,1,8) and cu02=substr(pa26,9,1) and cu13=st01(+) and st15=a0901(+) " & _
                      "union all " & _
                      "select cu13,st04,a0908,st14,st52,st53,st54,st55 from servicepractice,staff,customer,acc090 where sp01='" & strCP01 & "' and sp02='" & strCP02 & "' and sp03='" & strCP03 & "' and sp04='" & strCP04 & "' and cu01=substr(sp08,1,8) and cu02=substr(sp08,9,1) and cu13=st01(+) and st15=a0901(+) " & _
                      "union all " & _
                      "select cu13,st04,a0908,st14,st52,st53,st54,st55 from lawcase,customer,staff,acc090 where lc01='" & strCP01 & "' and lc02='" & strCP02 & "' and lc03='" & strCP03 & "' and lc04='" & strCP04 & "' and cu01=substr(lc11,1,8) and cu02=substr(lc11,9,1) and cu13=st01(+) and st15=a0901(+) " & _
                      "union all " & _
                      "select cu13,st04,a0908,st14,st52,st53,st54,st55 from hirecase,customer,staff,acc090 where hc01='" & strCP01 & "' and hc02='" & strCP02 & "' and hc03='" & strCP03 & "' and hc04='" & strCP04 & "' and cu01=substr(hc05,1,8) and cu02=substr(hc05,9,1) and cu13=st01(+) and st15=a0901(+) "
         intA = 1
         Set rsAD = ClsLawReadRstMsg(intA, strA1)
         'modify by sonia 2022/8/17 國外部人員不開放A4011查X69974
         'CheckSR09 = True
         If Left(Pub_StrUserSt03, 1) <> "F" Then CheckSR09 = True
         'end 2022/8/17
         If intA = 1 Then
            strCU13 = "" & rsAD.Fields("cu13")
            '2011/5/12 add by sonia
            If strCU13 < "6" Or "" & rsAD.Fields("st04") <> "1" Then
               strCU13 = "" & rsAD.Fields("a0908")
            End If
            '2011/5/12 end
            'add by sonia 2020/2/15 顧服組W20人員A8006因Group為H1(ACS)並非SA,但又收文非ACS案件,例X76050020收文CFT案,故修改控制
            If strCU13 = "W2001" Then
               If Pub_StrUserSt03 = "W00" Or Pub_StrUserSt03 = "W20" Then strCU13 = strUserNum
            End If
            'end 2020/2/15
            'add by sonia 2022/8/17
            If Left(strCU13, 3) = "MCT" Then
               If InStr("" & rsAD.Fields("st14"), strUserNum) > 0 Or InStr("" & rsAD.Fields("st52"), strUserNum) > 0 Or InStr("" & rsAD.Fields("st53"), strUserNum) > 0 Or InStr("" & rsAD.Fields("st54"), strUserNum) > 0 Or InStr("" & rsAD.Fields("st55"), strUserNum) > 0 Then
                  strCU13 = strUserNum
                  CheckSR09 = True
               End If
            End If
            'end 2022/8/17
         End If
         'modify by sonia 2022/8/17
         'If strCU13 <> strUserNum Then
         If strCU13 <> strUserNum Or CheckSR09 = False Then
         'end 2022/8/17
            'modify by sonia 2016/4/6 開放法務部人員之跨部門相關案件權限
            'If bolMsg = True Then
            '   strTit = "檢核資料"
            '   strMsg = "您沒有跨部門查詢案件明細的權限"
            '   nResponse = MsgBox(strMsg, vbOKOnly, strTit)
            'End If
            'CheckSR09 = False
            'goto exitsub
            CheckSR09 = False
            If Mid(Pub_StrUserSt03, 1, 1) = "L" Or Pub_StrUserSt03 = "F31" Or Pub_StrUserSt03 = "P31" Then
               '1.欲查詢案件與法務案有收文金額分配者
               strA1 = "select c1.cp01,c1.cp02,a0n01,c2.cp01,c2.cp02,a0n02 from acc0n0,caseprogress c1,caseprogress c2 " & _
                        "where c2.cp01='" & strCP01 & "' and c2.cp02='" & strCP02 & "' and c2.cp03='" & strCP03 & "' and c2.cp04='" & strCP04 & "' and c2.cp09=a0n02(+) and a0n01=c1.cp09(+) and c1.cp01 in ('L','LA','FCL','CFL','LIN') "
               rsTmp.CursorLocation = adUseClient
               rsTmp.Open strA1, cnnConnection, adOpenStatic, adLockReadOnly
               If rsTmp.RecordCount > 0 Then
                  CheckSR09 = True
               End If
               rsTmp.Close
               '2.欲查詢案件之承辦人或出庭律師曾有法務部人員者
               strA1 = "select cp01,cp02,cp03,cp04,cp09,s1.st03,s2.st03,s3.st03 from caseprogress,caselawer,staff s1,staff s2,staff s3 " & _
                        "where cp01='" & strCP01 & "' and cp02='" & strCP02 & "' and cp03='" & strCP03 & "' and cp04='" & strCP04 & "' and cp09=cl01(+) and cp14=s1.st01(+) and cp29=s2.st01(+) and cl02=s3.st01(+) " & _
                        "and (substr(s1.st03,1,1)='L' or s1.st03 in ('P31','F31') or substr(s2.st03,1,1)='L' or s2.st03 in ('P31','F31') or substr(s3.st03,1,1)='L' or s3.st03 in ('P31','F31'))"
               rsTmp.CursorLocation = adUseClient
               rsTmp.Open strA1, cnnConnection, adOpenStatic, adLockReadOnly
               If rsTmp.RecordCount > 0 Then
                  CheckSR09 = True
               End If
               rsTmp.Close
            End If
            
            'add by sonia 2024/3/7  內專工程師協助支援外專機械組案件,要開放特殊人員'協助機械組內專主管'查詢支援案件的權限
            If CheckSR09 = False And strCP01 = "FCP" Then
               '抓案件任一道進度的承辦人或核稿人是'協助機械組工程師'名單者，員工編號第4碼一定是9的虛帳號
               strA1 = "select distinct cp14 from caseprogress where cp01='" & strCP01 & "' and cp02='" & strCP02 & "' and cp03='" & strCP03 & "' and cp04='" & strCP04 & "' and substr(cp14,4,1)='9' union " & _
                        "select distinct ep04 from caseprogress,engineerprogress where cp01='" & strCP01 & "' and cp02='" & strCP02 & "' and cp03='" & strCP03 & "' and cp04='" & strCP04 & "' and cp09=ep02 and substr(ep04,4,1)='9'"
               rsTmp.CursorLocation = adUseClient
               rsTmp.Open strA1, cnnConnection, adOpenStatic, adLockReadOnly
               If rsTmp.RecordCount > 0 Then
                  Support_CP14 = False
                  stUsers = Pub_GetSpecMan("協助機械組工程師")
                  With rsTmp
                     Do While Not .EOF
                        If InStr(stUsers, .Fields("CP14")) > 0 Then
                           Support_CP14 = True
                        End If
                        .MoveNext
                     Loop
                  End With
                  '特殊人員'協助機械組內專主管'協助外專,要開放所有FCP機械組案查詢權限
                  If Support_CP14 = True Then
                     stUsers = Pub_GetSpecMan("協助機械組內專主管")
                     If InStr(stUsers, strUserNum) > 0 Then
                        CheckSR09 = True
                     End If
                  End If
               End If
            End If
            'end 2024/3/7
   
            If CheckSR09 = False Then
               If bolMsg = True Then
                  strTit = "檢核資料"
                  strMsg = "您沒有跨部門查詢案件明細的權限"
                  nResponse = MsgBox(strMsg, vbOKOnly, strTit)
               End If
            End If
            GoTo EXITSUB
            'end 2016/4/6
         End If
      End If
      'Modify By Sindy 2020/9/9 原始檔查詢:跨部門人員也不能查看原始檔區
      'Modify By Sindy 2021/8/3 薛德璟:雅娟:煩請開放P案的原始檔給CFP程序人員可以進入使用 +  Or GetStaffDepartment(strUserNum) = "P12"
      If CheckSR09 = True Then
         If UCase(strUseForm) = UCase("frm100101_M") Then
'         If UCase(strUseForm) = UCase("frm100101_M") And _
'            Not ((strCP01 = "P" Or strCP01 = "CFP") And _
'                 (Mid(GetStaffDepartment(strUserNum), 1, 2) = "F2" Or Mid(GetStaffDepartment(strUserNum), 1, 2) = "F8" Or _
'                  Mid(GetStaffDepartment(strUserNum), 1, 2) = "F6" Or GetStaffDepartment(strUserNum) = "P12")) Then
            strA1 = "SELECT S1.SDR04,S2.SDR04 FROM STAFF,STAFF_DEPT_RIGHT S1,STAFF_DEPT_RIGHT S2 " & _
                     "WHERE ST01 = '" & strUser & "' AND ST01=S1.SDR01(+) AND '" & strSys & "'=S1.SDR02(+) AND ST05=S2.SDR01(+) AND '" & strSys & "'=S2.SDR02(+) "
            rsTmp.CursorLocation = adUseClient
            rsTmp.Open strA1, cnnConnection, adOpenStatic, adLockReadOnly
            If rsTmp.RecordCount > 0 Then
               If IsNull(rsTmp.Fields(0)) = True And IsNull(rsTmp.Fields(1)) = True Then
                  If bolMsg = True Then
                     strTit = "檢核資料"
                     strMsg = "您沒有跨部門查詢原始檔區的權限"
                     nResponse = MsgBox(strMsg, vbOKOnly, strTit)
                  End If
                  CheckSR09 = False
                  GoTo EXITSUB
               End If
            End If
            rsTmp.Close
         End If
      End If
      '2020/9/9 END
   End If
   
   '2011/5/17 add by sonia 專利非外專收文之案件,外專人員不可查詢
   '2012/5/29 MODIFY BY SONIA P-063774 改編 FCP-045831 會看不到,故改控制P及CFP
   'If InStr(1, strCP01, "P") > 0 And (Mid(GetStaffDepartment(strUserNum), 1, 2) = "F2" Or Mid(GetStaffDepartment(strUserNum), 1, 2) = "F8") Then
   '2012/10/31 MODIFY BY SONIA 因開放國外部秘書之FMP權限故改為控制國外部不可看非外專收文之案件
   'If (strCP01 = "P" Or strCP01 = "CFP") And (Mid(GetStaffDepartment(strUserNum), 1, 2) = "F2" Or Mid(GetStaffDepartment(strUserNum), 1, 2) = "F8") Then
   'modify by sonia 2017/3/16 暫時開放80030可查專利案會因此句錯誤,故改回F2,F8再加入F6
   'If (strCP01 = "P" Or strCP01 = "CFP") And Left(GetStaffDepartment(strUserNum), 1) = "F" Then
   If (strCP01 = "P" Or strCP01 = "CFP") And _
      (Mid(GetStaffDepartment(strUserNum), 1, 2) = "F2" Or Mid(GetStaffDepartment(strUserNum), 1, 2) = "F8" Or _
       Mid(GetStaffDepartment(strUserNum), 1, 2) = "F6") Then
     'add by sonia 2018/5/23 新增特殊人員'外專工程師專利處核稿人'協助專利處核稿,要開放所有P,CFP案查詢權限
     stUsers = Pub_GetSpecMan("外專工程師專利處核稿人")
     If InStr(stUsers, strUserNum) > 0 Then
     Else
     'end 2018/5/22
        strA1 = "Select * From CASEPROGRESS Where CP01='" & strCP01 & "' AND CP02='" & strCP02 & "' AND CP03='" & strCP03 & "' AND CP04='" & strCP04 & "' AND SUBSTR(CP12,1,2)='F2' "
        intA = 1
        Set rsAD = ClsLawReadRstMsg(intA, strA1)
        If intA = 0 Then
           If bolMsg = True Then
              strTit = "檢核資料"
              strMsg = "您沒有跨部門查詢案件明細的權限"
              nResponse = MsgBox(strMsg, vbOKOnly, strTit)
           End If
           CheckSR09 = False
           GoTo EXITSUB
        End If
     End If   'add by sonia 2018/5/22
   End If
   '2011/5/17 END
   
   'Add By Sindy 2010/12/30 檢核跨所別權限
   If IsUserHasRightOfFunction("frm100101_1", strBranch, False, strCP01, strCP02, strCP03, strCP04) = False Then
      If bolMsg = True Then
         strTit = "檢核資料"
         strMsg = "您沒有跨所別查詢案件明細的權限"
         nResponse = MsgBox(strMsg, vbOKOnly, strTit)
      End If
      CheckSR09 = False
      GoTo EXITSUB
   End If
   
'Added by Lydia 2024/05/15
EXITSUB:
   Set rsAD = Nothing
'end 2024/05/15
End Function
'20080926 END

'add by Sindy 2011/01/03 控制共同查詢是否有查詢國內外客戶權限
'Modified by Lydia 2023/08/09 增加bolShowSys=>沒有查詢國外客戶的權限,是否顯示客戶曾收的案件系統別
Public Function CheckSR12(ByVal strIdNo As String, Optional ByVal bolMsg As Boolean = True, Optional ByVal bolShowSys As Boolean = False) As Boolean
Dim rsTmp As New ADODB.Recordset
Dim strSql As String
Dim strTit As String
Dim strMsg As String
Dim nResponse
Dim m_SR12
Dim varTmp1 As Variant   '2011/12/5 ADD BY SONIA
Dim strShowSys As String 'Added by Lydia 2023/08/09

   CheckSR12 = True
   m_SR12 = IsUserHasRightOfSR12
                  
   If Trim(m_SR12) <> "" And Trim(strIdNo) <> "" Then
      'Added by Lydia 2023/08/09 SQL:查客戶案件無權限時，請帶出該客戶曾收文案件之系統類別
      If bolShowSys = True Then
         If Left(strIdNo, 1) = "X" Then
            strShowSys = "select pa01 from patent where (pa26 like " & CNULL(Left("" & Left(strIdNo, 8), 8) & "%") & " or pa27 like " & CNULL(Left("" & Left(strIdNo, 8), 8) & "%") & " or pa28 like " & CNULL(Left("" & Left(strIdNo, 8), 8) & "%") & " or pa29 like " & CNULL(Left("" & Left(strIdNo, 8), 8) & "%") & " or pa30 like " & CNULL(Left("" & Left(strIdNo, 8), 8) & "%") & ") group by pa01 " & _
                     "union select tm01 from trademark where (tm23 like " & CNULL(Left("" & Left(strIdNo, 8), 8) & "%") & " or tm78 like " & CNULL(Left("" & Left(strIdNo, 8), 8) & "%") & " or tm79 like " & CNULL(Left("" & Left(strIdNo, 8), 8) & "%") & " or tm80 like " & CNULL(Left("" & Left(strIdNo, 8), 8) & "%") & " or tm81 like " & CNULL(Left("" & Left(strIdNo, 8), 8) & "%") & ") group by tm01 " & _
                     "union select sp01 from servicepractice where (sp08 like " & CNULL(Left("" & Left(strIdNo, 8), 8) & "%") & " or sp58 like " & CNULL(Left("" & Left(strIdNo, 8), 8) & "%") & " or sp59 like " & CNULL(Left("" & Left(strIdNo, 8), 8) & "%") & " or sp65 like " & CNULL(Left("" & Left(strIdNo, 8), 8) & "%") & " or sp66 like " & CNULL(Left("" & Left(strIdNo, 8), 8) & "%") & ") group by sp01 " & _
                     "union select lc01 from lawcase where (lc11 like " & CNULL(Left("" & Left(strIdNo, 8), 8) & "%") & " or lc43 like " & CNULL(Left("" & Left(strIdNo, 8), 8) & "%") & " or lc44 like " & CNULL(Left("" & Left(strIdNo, 8), 8) & "%") & " or lc45 like " & CNULL(Left("" & Left(strIdNo, 8), 8) & "%") & " or lc46 like " & CNULL(Left("" & Left(strIdNo, 8), 8) & "%") & ") group by lc01 order by 1 "
         Else
            strShowSys = "select pa01 from patent where pa75 like '" & Left(strIdNo, 8) & "%' group by pa01 " & _
                     "union select cp01 from caseprogress where cp01 like 'CF%' and cp44 like '" & Left(strIdNo, 8) & "%' group by cp01 " & _
                     "union select tm01 from trademark where tm44 like '" & Left(strIdNo, 8) & "%' group by tm01 " & _
                     "union select sp01 from servicepractice where sp26 like '" & Left(strIdNo, 8) & "%' group by sp01 " & _
                     "union select lc01 from lawcase where lc27 like '" & Left(strIdNo, 8) & "%' group by lc01 order by 1 "
         End If
      End If
      'end 2023/08/09
      Select Case Left(strIdNo, 1)
         Case "X" '客戶
            strSql = "SELECT cu12 FROM Customer " & _
                         "WHERE cu01='" & Left(strIdNo, 8) & "' and cu02='" & Right(strIdNo, 1) & "' "
            rsTmp.CursorLocation = adUseClient
            rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
            If rsTmp.RecordCount > 0 Then
               If Not IsNull(rsTmp.Fields("cu12")) Then
                  '業務區    F字頭為國外客戶
                  If Left(Trim(rsTmp.Fields("cu12")), 1) = "F" And m_SR12 <> "F" Then
                     If bolMsg = True Then
                        'Added by Lydia 2023/08/09 查客戶案件無權限時，請帶出該客戶曾收文案件之系統類別
                        If strShowSys <> "" Then
                           rsTmp.Close
                           rsTmp.CursorLocation = adUseClient
                           rsTmp.Open strShowSys, cnnConnection, adOpenStatic, adLockReadOnly
                           If rsTmp.RecordCount > 0 Then
                              strShowSys = rsTmp.GetString(adClipString, , , ",")
                              strShowSys = "此申請人曾收文案件之系統類別：" & Mid(strShowSys, 1, Len(strShowSys) - 1)
                           Else
                              strShowSys = ""
                           End If
                        End If
                        'end 2023/08/09
                        strTit = "檢核資料"
                        'Modified by Lydia 2023/08/09 +IIF()
                        strMsg = "您沒有查詢國外客戶的權限！" & IIf(strShowSys <> "", vbCrLf & strShowSys, "")
                        nResponse = MsgBox(strMsg, vbOKOnly, strTit)
                     End If
                     CheckSR12 = False
                  '業務區非F字頭為國內客戶
                  ElseIf Left(Trim(rsTmp.Fields("cu12")), 1) <> "F" And m_SR12 <> "C" Then
                     '2011/5/16 ADD BY SONIA 若該客戶曾收為國外部案件則國外部人員可查詢 X60431,X60431010
                     strSql = "SELECT COUNT(*) FROM PATENT WHERE PA01='FCP' AND (PA26='" & strIdNo & "' OR PA27='" & strIdNo & "' OR PA28='" & strIdNo & "' OR PA29='" & strIdNo & "' OR PA30='" & strIdNo & "') "
                     rsTmp.Close
                     rsTmp.CursorLocation = adUseClient
                     rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
                     If rsTmp.RecordCount > 0 Then
                        If Val(rsTmp.Fields(0)) > 0 And Left(GetStaffDepartment(strUserNum), 2) = "F2" Then Exit Function
                     End If
                     strSql = "SELECT COUNT(*) FROM TRADEMARK WHERE TM01='FCT' AND (TM23='" & strIdNo & "' OR TM78='" & strIdNo & "' OR TM79='" & strIdNo & "' OR TM80='" & strIdNo & "' OR TM81='" & strIdNo & "') "
                     rsTmp.Close
                     rsTmp.CursorLocation = adUseClient
                     rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
                     If rsTmp.RecordCount > 0 Then
                        If Val(rsTmp.Fields(0)) > 1 And Left(GetStaffDepartment(strUserNum), 2) = "F1" Then Exit Function
                     End If
                     '2011/5/16 END
                     If bolMsg = True Then
                        'Added by Lydia 2023/08/09 查客戶案件無權限時，請帶出該客戶曾收文案件之系統類別
                        If strShowSys <> "" Then
                           rsTmp.Close
                           rsTmp.CursorLocation = adUseClient
                           rsTmp.Open strShowSys, cnnConnection, adOpenStatic, adLockReadOnly
                           If rsTmp.RecordCount > 0 Then
                              strShowSys = rsTmp.GetString(adClipString, , , ",")
                              strShowSys = "此申請人曾收文案件之系統類別：" & Mid(strShowSys, 1, Len(strShowSys) - 1)
                           Else
                              strShowSys = ""
                           End If
                        End If
                        'end 2023/08/09
                        strTit = "檢核資料"
                        'Modified by Lydia 2023/08/09 +IIF()
                        strMsg = "您沒有查詢國內客戶的權限！" & IIf(strShowSys <> "", vbCrLf & strShowSys, "")
                        nResponse = MsgBox(strMsg, vbOKOnly, strTit)
                     End If
                     CheckSR12 = False
                  End If
               End If
            End If
         
         Case "Y" '代理人
            '皆為國外客戶
            strSql = "SELECT fa10 FROM Fagent " & _
                         "WHERE fa01='" & Left(strIdNo, 8) & "' and fa02='" & Right(strIdNo, 1) & "' "
            rsTmp.CursorLocation = adUseClient
            rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
            If rsTmp.RecordCount > 0 Then
               If m_SR12 <> "F" Then
                  If bolMsg = True Then
                     'Added by Lydia 2023/08/09 查客戶案件無權限時，請帶出該客戶曾收文案件之系統類別
                     If strShowSys <> "" Then
                        rsTmp.Close
                        rsTmp.CursorLocation = adUseClient
                        rsTmp.Open strShowSys, cnnConnection, adOpenStatic, adLockReadOnly
                        If rsTmp.RecordCount > 0 Then
                           strShowSys = rsTmp.GetString(adClipString, , , ",")
                           strShowSys = "此代理人曾收文案件之系統類別：" & Mid(strShowSys, 1, Len(strShowSys) - 1)
                        Else
                           strShowSys = ""
                        End If
                     End If
                     'end 2023/08/09
                     strTit = "檢核資料"
                     'Modified by Lydia 2023/08/09 +IIF()
                     strMsg = "您沒有查詢國外客戶的權限！" & IIf(strShowSys <> "", vbCrLf & strShowSys, "")
                     nResponse = MsgBox(strMsg, vbOKOnly, strTit)
                  End If
                  CheckSR12 = False
               End If
            End If
            
         Case "R" '潛在客戶
            '國外潛在客戶
            'Modify By Sindy 2020/5/25 + pcu51=國內外權限
            strSql = "SELECT pcu38,pcu51 FROM potcustomer " & _
                         "WHERE pcu01='" & Left(strIdNo, 8) & "' and pcu02='" & Right(strIdNo, 1) & "' "
            rsTmp.CursorLocation = adUseClient
            rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
            If rsTmp.RecordCount > 0 Then
               'Modify By Sindy 2020/5/25 + pcu51=國內外權限
               If Not IsNull(rsTmp.Fields("pcu51")) Then
                  '部門別    F字頭為國外客戶
                  If Left(Trim(rsTmp.Fields("pcu51")), 1) = "F" And m_SR12 <> "F" Then
                     If bolMsg = True Then
                        strTit = "檢核資料"
                        strMsg = "您沒有查詢國外客戶的權限！"
                        nResponse = MsgBox(strMsg, vbOKOnly, strTit)
                     End If
                     CheckSR12 = False
                  '部門別非F字頭為國內客戶
                  ElseIf Left(Trim(rsTmp.Fields("pcu51")), 1) <> "F" And m_SR12 <> "C" Then
                     If bolMsg = True Then
                        strTit = "檢核資料"
                        strMsg = "您沒有查詢國內客戶的權限！"
                        nResponse = MsgBox(strMsg, vbOKOnly, strTit)
                     End If
                     CheckSR12 = False
                  End If
               '2020/5/25 END
               ElseIf Not IsNull(rsTmp.Fields("pcu38")) Then
                  '2011/12/5 MODIFY BY SONIA 只抓開發人員第一個,否則此句會抓不到R01293
                  'strSql = "SELECT st03 FROM staff WHERE st01='" & rsTmp.Fields("pcu38") & "' "
                  varTmp1 = Split(rsTmp.Fields("pcu38"), ",")
                  strSql = "SELECT st03 FROM staff WHERE st01='" & varTmp1(0) & "' "
                  '2011/12/5 END
                  rsTmp.Close
                  rsTmp.CursorLocation = adUseClient
                  rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
                  If rsTmp.RecordCount > 0 Then
                     '部門別    F字頭為國外客戶
                     If Left(Trim(rsTmp.Fields("st03")), 1) = "F" And m_SR12 <> "F" Then
                        If bolMsg = True Then
                           strTit = "檢核資料"
                           strMsg = "您沒有查詢國外客戶的權限！"
                           nResponse = MsgBox(strMsg, vbOKOnly, strTit)
                        End If
                        CheckSR12 = False
                     '部門別非F字頭為國內客戶
                     ElseIf Left(Trim(rsTmp.Fields("st03")), 1) <> "F" And m_SR12 <> "C" Then
                        If bolMsg = True Then
                           strTit = "檢核資料"
                           strMsg = "您沒有查詢國內客戶的權限！"
                           nResponse = MsgBox(strMsg, vbOKOnly, strTit)
                        End If
                        CheckSR12 = False
                     End If
                  End If
               End If
            Else
               '國內潛在客戶, 皆為國內客戶
               strSql = "SELECT * FROM potcustomer1 " & _
                            "WHERE poc01='" & Left(strIdNo, 8) & "' and poc02='" & Right(strIdNo, 1) & "' "
               rsTmp.Close
               rsTmp.CursorLocation = adUseClient
               rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
               If rsTmp.RecordCount > 0 Then
                  If m_SR12 <> "C" Then
                     If bolMsg = True Then
                        strTit = "檢核資料"
                        strMsg = "您沒有查詢國內客戶的權限！"
                        nResponse = MsgBox(strMsg, vbOKOnly, strTit)
                     End If
                     CheckSR12 = False
                  End If
               End If
            End If
            
         Case Else '其他-投資法務開拓客戶
            '皆為國外客戶
            strSql = "SELECT * FROM ExpandCusDetail " & _
                         "WHERE ecd02||'-'||LPAD(ecd01,6,'0')='" & strIdNo & "' "
            rsTmp.CursorLocation = adUseClient
            rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
            If rsTmp.RecordCount > 0 Then
               If m_SR12 <> "F" Then
                  If bolMsg = True Then
                     strTit = "檢核資料"
                     strMsg = "您沒有查詢國外客戶的權限！"
                     nResponse = MsgBox(strMsg, vbOKOnly, strTit)
                  End If
                  CheckSR12 = False
               End If
            End If
      End Select
   End If
End Function
'2011/01/03 END

'Add by Morgan 2010/4/9
'批次建立acc1n0
Public Function PUB_AddBatch(Optional strFromNo As String, Optional strToNo As String, Optional strDateFrom As String = "920101", Optional strDateTo As String = "") As Boolean
   Dim stSQL As String, intR As Integer, stCon As String, bolReturn As Boolean
   Dim adoRst As ADODB.Recordset, bolFunReturn As Boolean
   
   bolFunReturn = True
   
   stCon = ""
   'stCon = " and (a1k13='FCL' or a1k13='CFL' or a1k13='LIN') and a1k29 is null" 'Added by Morgan 2015/5/26 FCL未收款重新分配條件
   
   stCon = stCon & " and a1k02>=" & strDateFrom
   If strDateTo <> "" Then stCon = stCon & " and a1k02<=" & strDateTo
   If strFromNo <> "" Then stCon = stCon & " and a1k01>='" & strFromNo & "'"
   If strToNo <> "" Then stCon = stCon & " and a1k01<='" & strToNo & "'"
   
   stSQL = "select a1k01 FROM acc1k0 WHERE nvl(A1K12,0)=0 AND LENGTH(A1K01)=9" & stCon
   stSQL = stSQL & " AND nvl(a1k11,0)-nvl(a1k09,0)>0"
   stSQL = stSQL & " AND exists(select * from acc1l0 where a1l01=a1k01)"
   If strFromNo <> "" Then
      stSQL = stSQL & " AND not exists(select * from acc1n0 where a1n01=a1k01)"
   End If
   'stSQL = stSQL & " AND EXISTS(SELECT 1 FROM ACC1n0 WHERE A1n01=A1K01 and a1n02='2' HAVING SUM(a1n05*1000)<> trunc(A1K11-nvl(a1k09,0)))"
   'stSQL = stSQL & " and exists(select * from caseprogress where cp60=a1k01 and cp01='P' and substr(cp12,1,1)='F')"
   stSQL = stSQL & " order by a1k01 asc"
   
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      With adoRst
      Do While Not .EOF
         bolReturn = PUB_PointAutoassign(.Fields(0))
         bolFunReturn = (bolFunReturn And bolReturn)
         .MoveNext
      Loop
      End With
   End If
   Set adoRst = Nothing
   If bolFunReturn = False Then
      MsgBox "自動點數分配失敗，請進入請款單維護作業手動進行點數分配！"
   End If
   PUB_AddBatch = bolFunReturn
End Function

'2013/4/29 Modify by Amy 增加變數判斷可不顯示Msgbox
'2011/10/17 add by sonia 檢查四縣市改制地址欄
Public Function CheckTaiwanAddr(ByVal strAddr As String, Optional strNation As String, Optional strLabel As String, Optional MsgYN As Boolean = True) As Boolean
Dim strMsg As String
Dim m_Addr As String     '2011/10/18 add by sonia
Dim stROC As String 'Add by Amy 2015/11/30

   CheckTaiwanAddr = True
   If strNation > "010" Then
      Exit Function               '國籍非台灣不必檢查
   'Add by Amy 2015/08/18 +郵政信箱只檢查是否有號
   ElseIf InStr(strAddr, "信箱") Then
      If InStr(strAddr, "號") = 0 Then
            strMsg = "郵政信箱一定要有「號」, 若確認無誤請按 是！ 若要修改地址, 請按 否！"
            If MsgYN = True Then '可不顯示Msgbox
                If MsgBox(strMsg, vbYesNo + vbCritical + vbDefaultButton2) = vbNo Then
                    CheckTaiwanAddr = False
                    Exit Function
                End If
            Else
                CheckTaiwanAddr = False
                strLabel = "郵政信箱一定要有「號」！"
                Exit Function
            End If
      End If
   Else
      '2011/10/18除去前面的郵遞區號
      'Modify by Amy 2016/12/21 去除前面中華民國、臺灣省、臺灣字樣檢查
      If Left(strAddr, 4) = "中華民國" Then stROC = Left(strAddr, 4)
      If Left(strAddr, 3) = "臺灣省" Or Left(strAddr, 3) = "台灣省" Then stROC = Left(strAddr, 3)
      If Left(strAddr, 2) = "臺灣" Or Left(strAddr, 2) = "台灣" Then stROC = Left(strAddr, 2)
      m_Addr = IIf(stROC = MsgText(601), strAddr, Mid(strAddr, Len(stROC) + 1))
        
      'Modify by Amy 2015/08/12 +數字半型
      Do While (Left(m_Addr, 1) >= "１" And Left(m_Addr, 1) <= "９") Or (Left(m_Addr, 1) >= "1" And Left(m_Addr, 1) <= "9")
         m_Addr = Mid(m_Addr, 2)
      Loop
      Select Case Left(m_Addr, 2)
         'Modify by Amy 2015/08/12 +臺中
         Case "台中", "台南", "高雄", "臺中"
            If Mid(m_Addr, 3, 1) <> "縣" And Mid(m_Addr, 3, 1) <> "市" Then
               m_Addr = Left(m_Addr, 2) & "市" & Mid(m_Addr, 3)
            End If
      End Select
      '2011/10/18 end
      'Add by Amy 2015/08/12 第2碼不可為縣或市
      If Mid(m_Addr, 2, 1) = "縣" Or Mid(m_Addr, 2, 1) = "市" Then
            strMsg = strLabel & "欄地址格式錯誤！注意：台灣案一定要用新地址格式！若確認地址無誤請按 是！ 若要修改地址, 請按 否！"
            If MsgYN = True Then  '可不顯示Msgbox
                If MsgBox(strMsg, vbYesNo + vbCritical + vbDefaultButton2) = vbNo Then
                    CheckTaiwanAddr = False
                    Exit Function
                End If
             Else
                CheckTaiwanAddr = False
                strLabel = "第二個字不可為「縣」或「市」！"
                Exit Function
             End If
      End If
      'end 2015/08/11
      Select Case Left(m_Addr, 3)
         Case "台北縣", "臺北縣", "台中縣", "臺中縣", "台南縣", "臺南縣", "高雄縣"
            '2012/3/27 MODIFY BY SONIA 改為可選擇是否要用舊地址
            'ShowMsg strLabel & "欄錯誤！現在已沒有 " & Left(m_Addr, 3) & "了！"
            'CheckTaiwanAddr = False
            strMsg = strLabel & "欄錯誤！現在已沒有 " & Left(m_Addr, 3) & "了！注意：台灣案一定要用新地址！若確認地址無誤請按 是！ 若要修改地址, 請按 否！"
            If MsgYN = True Then 'Modify by Amy 增加變數判斷可不顯示Msgbox
                If MsgBox(strMsg, vbYesNo + vbCritical + vbDefaultButton2) = vbNo Then
                    CheckTaiwanAddr = False
                    Exit Function
                End If
             Else
                CheckTaiwanAddr = False
                strLabel = "現在已沒有 " & Left(m_Addr, 3) & "了！"
                Exit Function
             End If
            '2012/3/27 END
         '鄉, 鎮, 村 的檢查, 但只提醒仍可輸入
         'Modify by Amy 2015/08/12 +臺中市
         Case "新北市", "台中市", "台南市", "高雄市", "臺中市"
            '2011/10/18 add by sonia 台南永安街已改為永成路
            If InStr(m_Addr, "台南") > 0 And InStr(m_Addr, "永安街") > 0 Then
               '2012/3/27 MODIFY BY SONIA 改為可選擇是否要用舊地址
               'ShowMsg strLabel & "欄錯誤！台南市的永安街 已改為 永成路XX段 了, 請再確認地址！"
               'CheckTaiwanAddr = False
               'Exit Function
               strMsg = strLabel & "欄錯誤！台南市的永安街 已改為 永成路XX段 了！注意：台灣案一定要用新地址！若確認地址無誤請按 是！ 若要修改地址, 請按 否！"
               If MsgYN = True Then 'Modify by Amy 增加變數判斷可不顯示Msgbox
                If MsgBox(strMsg, vbYesNo + vbCritical + vbDefaultButton2) = vbNo Then
                  CheckTaiwanAddr = False
                  Exit Function
                End If
               Else
                 CheckTaiwanAddr = False
                 strLabel = "台南市的永安街 已改為 永成路XX段 了！"
                 Exit Function
               End If
            End If
            '2011/10/18 end
            If InStr(m_Addr, "村") > 0 Then
               If InStr(m_Addr, "村里") = 0 And InStr(m_Addr, "村路") = 0 And InStr(m_Addr, "村街") = 0 And InStr(m_Addr, "新村") = 0 And _
                  InStr(m_Addr, "一村") = 0 And InStr(m_Addr, "二村") = 0 And InStr(m_Addr, "三村") = 0 And InStr(m_Addr, "四村") = 0 And _
                  InStr(m_Addr, "五村") = 0 And InStr(m_Addr, "六村") = 0 And InStr(m_Addr, "七村") = 0 And InStr(m_Addr, "八村") = 0 And _
                  InStr(m_Addr, "九村") = 0 And InStr(m_Addr, "十村") = 0 And InStr(m_Addr, "鳳村") = 0 And InStr(m_Addr, "鎌村") = 0 And _
                  InStr(m_Addr, "前村東路") = 0 And InStr(m_Addr, "錦村車路") = 0 And InStr(m_Addr, "西村巷") = 0 And InStr(m_Addr, "美村南路") = 0 And _
                  InStr(m_Addr, "前鎮區進村") = 0 Then
                     strMsg = "四縣市改制後已經沒有 XX 村 了, 但您輸入的" & strLabel & "欄有 村 這個字, 若確認地址無誤請按 是！ 若要修改地址, 請按 否！"
                    If MsgYN = True Then 'Modify by Amy 增加變數判斷可不顯示Msgbox
                        If MsgBox(strMsg, vbYesNo + vbCritical + vbDefaultButton2) = vbNo Then
                            CheckTaiwanAddr = False
                            Exit Function
                       End If
                    Else
                        CheckTaiwanAddr = False
                        strLabel = "四縣市改制後已經沒有 XX 村 了！"
                        Exit Function
                    End If
               End If
            End If
            If InStr(m_Addr, "鄉") > 0 Then
               If InStr(m_Addr, "後鄉里") = 0 And InStr(m_Addr, "雲鄉山莊") = 0 And InStr(m_Addr, "本鄉里") = 0 Then
                  strMsg = "四縣市改制後已經沒有 XX 鄉 了, 但您輸入的" & strLabel & "欄有 鄉 這個字, 若確認地址無誤請按 是！ 若要修改地址, 請按 否！"
                  If MsgYN = True Then 'Modify by Amy 增加變數判斷可不顯示Msgbox
                    If MsgBox(strMsg, vbYesNo + vbCritical + vbDefaultButton2) = vbNo Then
                       CheckTaiwanAddr = False
                       Exit Function
                    End If
                  Else
                    CheckTaiwanAddr = False
                    strLabel = "四縣市改制後已經沒有 XX 鄉 了！"
                    Exit Function
                  End If
               End If
            End If
            If InStr(m_Addr, "鎮") > 0 Then
               If InStr(m_Addr, "前鎮區") = 0 And InStr(m_Addr, "左鎮區") = 0 And InStr(m_Addr, "店鎮里") = 0 And InStr(m_Addr, "鎮北北巷") = 0 And _
                  InStr(m_Addr, "鎮北里") = 0 And InStr(m_Addr, "鎮西里") = 0 And InStr(m_Addr, "鎮東里") = 0 And InStr(m_Addr, "鎮南里") = 0 And _
                  InStr(m_Addr, "鎮政路") = 0 And InStr(m_Addr, "鎮瀾街") = 0 And InStr(m_Addr, "鎮平里") = 0 And InStr(m_Addr, "鎮前街") = 0 And _
                  InStr(m_Addr, "鎮南路") = 0 And InStr(m_Addr, "二鎮里") = 0 And InStr(m_Addr, "前鎮加工") = 0 And InStr(m_Addr, "鎮山里") = 0 And _
                  InStr(m_Addr, "鎮新") = 0 And InStr(m_Addr, "鎮南街") = 0 And InStr(m_Addr, "鎮山街") = 0 And InStr(m_Addr, "鎮東路") = 0 And _
                  InStr(m_Addr, "鎮海路") = 0 Then
                     strMsg = "四縣市改制後已經沒有 XX 鎮 了, 但您輸入的" & strLabel & "欄有 鎮 這個字, 若確認地址無誤請按 是！ 若要修改地址, 請按 否！"
                     If MsgYN = True Then 'Modify by Amy 增加變數判斷可不顯示Msgbox
                        If MsgBox(strMsg, vbYesNo + vbCritical + vbDefaultButton2) = vbNo Then
                            CheckTaiwanAddr = False
                            Exit Function
                        End If
                     Else
                        CheckTaiwanAddr = False
                        strLabel = "四縣市改制後已經沒有 XX 鎮 了！"
                       Exit Function
                     End If
               End If
            End If
         Case Else
      End Select
      'Add by Amy 2015/08/12 +一定要有「號」
      If InStr(m_Addr, "號") = 0 Then
            strMsg = strLabel & "欄一定要有「號」, 若確認地址無誤請按 是！ 若要修改地址, 請按 否！"
            If MsgYN = True Then '可不顯示Msgbox
                If MsgBox(strMsg, vbYesNo + vbCritical + vbDefaultButton2) = vbNo Then
                    CheckTaiwanAddr = False
                    Exit Function
                End If
            Else
                CheckTaiwanAddr = False
                strLabel = strLabel & "欄一定要有「號」！"
                Exit Function
            End If
      End If
   End If
End Function
'2011/10/17 end

'add by Sindy 2011/01/21 檢查資料與客戶檔申請地址不同時, 顯示訊息提醒操作人員注意地址欄
'strChkType : 1.中文 2.英文 3.日文
Public Function CheckCustomerAddr(ByVal strChkType As String, ByVal strIdName As String, ByVal strIdAddr As String, Optional strText As String, Optional bolMsg As Boolean = True) As Boolean
Dim rsTmp As New ADODB.Recordset
Dim strSql As String
Dim strTit As String
Dim strMsg As String
Dim nResponse
   
   CheckCustomerAddr = True
   If strText = "" Then strText = strIdName
   
   Select Case strChkType
      Case 1: '1.中文
         strSql = "SELECT rtrim(cu23) as cu23 FROM Customer WHERE rtrim(cu04)='" & strIdName & "' "
         rsTmp.CursorLocation = adUseClient
         rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
         If rsTmp.RecordCount > 0 Then
            If Not IsNull(rsTmp.Fields("cu23")) Then
               If Trim(rsTmp.Fields("cu23")) <> strIdAddr Then
                  If bolMsg = True Then
                     strTit = "檢核資料"
                     strMsg = strText & "地址與客戶中文地址不同，請注意！"
                     nResponse = MsgBox(strMsg, vbOKOnly, strTit)
                  End If
                  CheckCustomerAddr = False
               End If
            End If
         End If
         
      Case 2: '2.英文
         'strSql = "SELECT rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) as cu24 FROM Customer WHERE rtrim(rtrim(cu05)||' '||rtrim(cu88)||' '||rtrim(cu89)||' '||rtrim(cu90))='" & strIdName & "' "
         strIdName = UCase(Replace(strIdName, " ", ""))
         strIdAddr = UCase(Replace(strIdAddr, " ", ""))
         strSql = "SELECT upper(replace(rtrim(rtrim(cu24)||rtrim(cu25)||rtrim(cu26)||rtrim(cu27)||rtrim(cu28)||rtrim(cu102)),' ',null)) as cu24 FROM Customer WHERE upper(replace(rtrim(rtrim(cu05)||rtrim(cu88)||rtrim(cu89)||rtrim(cu90)),' ',null))='" & strIdName & "' "
         rsTmp.CursorLocation = adUseClient
         rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
         If rsTmp.RecordCount > 0 Then
            If Not IsNull(rsTmp.Fields("cu24")) Then
               If Trim(rsTmp.Fields("cu24")) <> strIdAddr Then
                  If bolMsg = True Then
                     strTit = "檢核資料"
                     strMsg = strText & "地址與客戶英文地址不同，請注意！"
                     nResponse = MsgBox(strMsg, vbOKOnly, strTit)
                  End If
                  CheckCustomerAddr = False
               End If
            End If
         End If
         
      Case 3: '3.日文
         strSql = "SELECT rtrim(cu29) as cu29 FROM Customer WHERE rtrim(cu06)='" & strIdName & "' "
         rsTmp.CursorLocation = adUseClient
         rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
         If rsTmp.RecordCount > 0 Then
            If Not IsNull(rsTmp.Fields("cu29")) Then
               If Trim(rsTmp.Fields("cu29")) <> strIdAddr Then
                  If bolMsg = True Then
                     strTit = "檢核資料"
                     strMsg = strText & "地址與客戶日文地址不同，請注意！"
                     nResponse = MsgBox(strMsg, vbOKOnly, strTit)
                  End If
                  CheckCustomerAddr = False
               End If
            End If
         End If
   End Select
End Function

'add by Sindy 2011/01/21
'檢查相同國家若有舊案申請地址與客戶目前申請地址不同時，提醒操作人員
'1.並於接洽單的備註欄註明'有舊案件與客戶目前申請地址不同，舊地址為……..'。
'2.發文作業亦須檢查此項目，並顯示畫面。
Public Function ChkOCaseAndCAddrNotAlike(ByVal strCustID As String, ByVal strNation As String, ByVal strCP01 As String, ByVal strCaseType As String, ByRef rsTmp As ADODB.Recordset, Optional bolMsg As Boolean = True) As Boolean
Dim strSql As String
Dim strTit As String
Dim strMsg As String
Dim nResponse
   
   ChkOCaseAndCAddrNotAlike = False
   
   Select Case strCP01
      '若為CFP新申請案(NewCasePtyList)且申請國家為011日本或012韓國時，須檢查
      Case "CFP"
         If InStr(NewCasePtyList, strCaseType) > 0 And (strNation = "011" Or strNation = "012") Then
            If rsTmp.State <> 0 Then
               rsTmp.Close
            End If
            'and (pa16 is null or pa16<>'2')
            'Modify By Sindy 2016/8/12 有申請日一定要檢查地址,無申請人則才要考慮閉卷銷卷問題
            strSql = "SELECT pa01,pa02,pa03,pa04,pa26 as id,cu04 as cname,rtrim(rtrim(cu05)||' '||rtrim(cu88)||' '||rtrim(cu89)||' '||rtrim(cu90)) as ename,cu06 as jname,pa31 as caseAddr,cu23 as caddr,rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) as eaddr,cu29 as jaddr,1 as sort FROM Patent,Customer WHERE pa01='" & strCP01 & "' and pa09='" & strNation & "' and pa26 in (" & strCustID & ") and cu01=substr(pa26,1,8) and cu02=substr(pa26,9,1) and pa31 is not null and cu23 is not null and replace(replace(replace(rtrim(pa31),'　',null),chr(10),null),chr(13),null) <> replace(rtrim(cu23),'　',null) and replace(replace(replace(rtrim(pa31),'　',null),chr(10),null),chr(13),null) <> rtrim(CU112)||replace(rtrim(cu23),'　',null) and (pa10 is not null or (pa10 is null and pa57 is null and pa108 is null and pa136 is null)) and (pa25 is null or (pa25 is not null and pa25>" & strSrvDate(1) & " and pa17='Y')) " & _
              " Union SELECT pa01,pa02,pa03,pa04,pa27 as id,cu04 as cname,rtrim(rtrim(cu05)||' '||rtrim(cu88)||' '||rtrim(cu89)||' '||rtrim(cu90)) as ename,cu06 as jname,pa32 as caseAddr,cu23 as caddr,rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) as eaddr,cu29 as jaddr,1 as sort FROM Patent,Customer WHERE pa01='" & strCP01 & "' and pa09='" & strNation & "' and pa27 in (" & strCustID & ") and cu01=substr(pa27,1,8) and cu02=substr(pa27,9,1) and pa32 is not null and cu23 is not null and replace(replace(replace(rtrim(pa32),'　',null),chr(10),null),chr(13),null) <> replace(rtrim(cu23),'　',null) and replace(replace(replace(rtrim(pa32),'　',null),chr(10),null),chr(13),null) <> rtrim(CU112)||replace(rtrim(cu23),'　',null) and (pa10 is not null or (pa10 is null and pa57 is null and pa108 is null and pa136 is null)) and (pa25 is null or (pa25 is not null and pa25>" & strSrvDate(1) & " and pa17='Y')) " & _
              " Union SELECT pa01,pa02,pa03,pa04,pa28 as id,cu04 as cname,rtrim(rtrim(cu05)||' '||rtrim(cu88)||' '||rtrim(cu89)||' '||rtrim(cu90)) as ename,cu06 as jname,pa33 as caseAddr,cu23 as caddr,rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) as eaddr,cu29 as jaddr,1 as sort FROM Patent,Customer WHERE pa01='" & strCP01 & "' and pa09='" & strNation & "' and pa28 in (" & strCustID & ") and cu01=substr(pa28,1,8) and cu02=substr(pa28,9,1) and pa33 is not null and cu23 is not null and replace(replace(replace(rtrim(pa33),'　',null),chr(10),null),chr(13),null) <> replace(rtrim(cu23),'　',null) and replace(replace(replace(rtrim(pa33),'　',null),chr(10),null),chr(13),null) <> rtrim(CU112)||replace(rtrim(cu23),'　',null) and (pa10 is not null or (pa10 is null and pa57 is null and pa108 is null and pa136 is null)) and (pa25 is null or (pa25 is not null and pa25>" & strSrvDate(1) & " and pa17='Y')) " & _
              " Union SELECT pa01,pa02,pa03,pa04,pa29 as id,cu04 as cname,rtrim(rtrim(cu05)||' '||rtrim(cu88)||' '||rtrim(cu89)||' '||rtrim(cu90)) as ename,cu06 as jname,pa34 as caseAddr,cu23 as caddr,rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) as eaddr,cu29 as jaddr,1 as sort FROM Patent,Customer WHERE pa01='" & strCP01 & "' and pa09='" & strNation & "' and pa29 in (" & strCustID & ") and cu01=substr(pa29,1,8) and cu02=substr(pa29,9,1) and pa34 is not null and cu23 is not null and replace(replace(replace(rtrim(pa34),'　',null),chr(10),null),chr(13),null) <> replace(rtrim(cu23),'　',null) and replace(replace(replace(rtrim(pa34),'　',null),chr(10),null),chr(13),null) <> rtrim(CU112)||replace(rtrim(cu23),'　',null) and (pa10 is not null or (pa10 is null and pa57 is null and pa108 is null and pa136 is null)) and (pa25 is null or (pa25 is not null and pa25>" & strSrvDate(1) & " and pa17='Y')) " & _
              " Union SELECT pa01,pa02,pa03,pa04,pa30 as id,cu04 as cname,rtrim(rtrim(cu05)||' '||rtrim(cu88)||' '||rtrim(cu89)||' '||rtrim(cu90)) as ename,cu06 as jname,pa35 as caseAddr,cu23 as caddr,rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) as eaddr,cu29 as jaddr,1 as sort FROM Patent,Customer WHERE pa01='" & strCP01 & "' and pa09='" & strNation & "' and pa30 in (" & strCustID & ") and cu01=substr(pa30,1,8) and cu02=substr(pa30,9,1) and pa35 is not null and cu23 is not null and replace(replace(replace(rtrim(pa35),'　',null),chr(10),null),chr(13),null) <> replace(rtrim(cu23),'　',null) and replace(replace(replace(rtrim(pa35),'　',null),chr(10),null),chr(13),null) <> rtrim(CU112)||replace(rtrim(cu23),'　',null) and (pa10 is not null or (pa10 is null and pa57 is null and pa108 is null and pa136 is null)) and (pa25 is null or (pa25 is not null and pa25>" & strSrvDate(1) & " and pa17='Y')) " & _
              " Union SELECT pa01,pa02,pa03,pa04,pa26 as id,cu04 as cname,rtrim(rtrim(cu05)||' '||rtrim(cu88)||' '||rtrim(cu89)||' '||rtrim(cu90)) as ename,cu06 as jname,pa36 as caseAddr,cu23 as caddr,rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) as eaddr,cu29 as jaddr,2 as sort FROM Patent,Customer WHERE pa01='" & strCP01 & "' and pa09='" & strNation & "' and pa26 in (" & strCustID & ") and cu01=substr(pa26,1,8) and cu02=substr(pa26,9,1) and pa36 is not null and rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) is not null and replace(replace(replace(upper(rtrim(pa36)),' ',null),chr(10),null),chr(13),null) <> replace(upper(rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102))),' ',null) " & _
              " and (pa10 is not null or (pa10 is null and pa57 is null and pa108 is null and pa136 is null)) and (pa25 is null or (pa25 is not null and pa25>" & strSrvDate(1) & " and pa17='Y')) " & _
              " Union SELECT pa01,pa02,pa03,pa04,pa27 as id,cu04 as cname,rtrim(rtrim(cu05)||' '||rtrim(cu88)||' '||rtrim(cu89)||' '||rtrim(cu90)) as ename,cu06 as jname,pa37 as caseAddr,cu23 as caddr,rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) as eaddr,cu29 as jaddr,2 as sort FROM Patent,Customer WHERE pa01='" & strCP01 & "' and pa09='" & strNation & "' and pa27 in (" & strCustID & ") and cu01=substr(pa27,1,8) and cu02=substr(pa27,9,1) and pa37 is not null and rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) is not null and replace(replace(replace(upper(rtrim(pa37)),' ',null),chr(10),null),chr(13),null) <> replace(upper(rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102))),' ',null) " & _
              " and (pa10 is not null or (pa10 is null and pa57 is null and pa108 is null and pa136 is null)) and (pa25 is null or (pa25 is not null and pa25>" & strSrvDate(1) & " and pa17='Y')) " & _
              " Union SELECT pa01,pa02,pa03,pa04,pa28 as id,cu04 as cname,rtrim(rtrim(cu05)||' '||rtrim(cu88)||' '||rtrim(cu89)||' '||rtrim(cu90)) as ename,cu06 as jname,pa38 as caseAddr,cu23 as caddr,rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) as eaddr,cu29 as jaddr,2 as sort FROM Patent,Customer WHERE pa01='" & strCP01 & "' and pa09='" & strNation & "' and pa28 in (" & strCustID & ") and cu01=substr(pa28,1,8) and cu02=substr(pa28,9,1) and pa38 is not null and rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) is not null and replace(replace(replace(upper(rtrim(pa38)),' ',null),chr(10),null),chr(13),null) <> replace(upper(rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102))),' ',null) " & _
              " and (pa10 is not null or (pa10 is null and pa57 is null and pa108 is null and pa136 is null)) and (pa25 is null or (pa25 is not null and pa25>" & strSrvDate(1) & " and pa17='Y')) " & _
              " Union SELECT pa01,pa02,pa03,pa04,pa29 as id,cu04 as cname,rtrim(rtrim(cu05)||' '||rtrim(cu88)||' '||rtrim(cu89)||' '||rtrim(cu90)) as ename,cu06 as jname,pa39 as caseAddr,cu23 as caddr,rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) as eaddr,cu29 as jaddr,2 as sort FROM Patent,Customer WHERE pa01='" & strCP01 & "' and pa09='" & strNation & "' and pa29 in (" & strCustID & ") and cu01=substr(pa29,1,8) and cu02=substr(pa29,9,1) and pa39 is not null and rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) is not null and replace(replace(replace(upper(rtrim(pa39)),' ',null),chr(10),null),chr(13),null) <> replace(upper(rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102))),' ',null) " & _
              " and (pa10 is not null or (pa10 is null and pa57 is null and pa108 is null and pa136 is null)) and (pa25 is null or (pa25 is not null and pa25>" & strSrvDate(1) & " and pa17='Y')) " & _
              " Union SELECT pa01,pa02,pa03,pa04,pa30 as id,cu04 as cname,rtrim(rtrim(cu05)||' '||rtrim(cu88)||' '||rtrim(cu89)||' '||rtrim(cu90)) as ename,cu06 as jname,pa40 as caseAddr,cu23 as caddr,rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) as eaddr,cu29 as jaddr,2 as sort FROM Patent,Customer WHERE pa01='" & strCP01 & "' and pa09='" & strNation & "' and pa30 in (" & strCustID & ") and cu01=substr(pa30,1,8) and cu02=substr(pa30,9,1) and pa40 is not null and rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) is not null and replace(replace(replace(upper(rtrim(pa40)),' ',null),chr(10),null),chr(13),null) <> replace(upper(rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102))),' ',null) " & _
              " and (pa10 is not null or (pa10 is null and pa57 is null and pa108 is null and pa136 is null)) and (pa25 is null or (pa25 is not null and pa25>" & strSrvDate(1) & " and pa17='Y')) " & _
              " Union SELECT pa01,pa02,pa03,pa04,pa26 as id,cu04 as cname,rtrim(rtrim(cu05)||' '||rtrim(cu88)||' '||rtrim(cu89)||' '||rtrim(cu90)) as ename,cu06 as jname,pa41 as caseAddr,cu23 as caddr,rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) as eaddr,cu29 as jaddr,3 as sort FROM Patent,Customer WHERE pa01='" & strCP01 & "' and pa09='" & strNation & "' and pa26 in (" & strCustID & ") and cu01=substr(pa26,1,8) and cu02=substr(pa26,9,1) and pa41 is not null and cu29 is not null and replace(replace(replace(rtrim(pa41),'　',null),chr(10),null),chr(13),null) <> replace(rtrim(cu29),'　',null) and (pa10 is not null or (pa10 is null and pa57 is null and pa108 is null and pa136 is null)) and (pa25 is null or (pa25 is not null and pa25>" & strSrvDate(1) & " and pa17='Y')) " & _
              " Union SELECT pa01,pa02,pa03,pa04,pa27 as id,cu04 as cname,rtrim(rtrim(cu05)||' '||rtrim(cu88)||' '||rtrim(cu89)||' '||rtrim(cu90)) as ename,cu06 as jname,pa42 as caseAddr,cu23 as caddr,rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) as eaddr,cu29 as jaddr,3 as sort FROM Patent,Customer WHERE pa01='" & strCP01 & "' and pa09='" & strNation & "' and pa27 in (" & strCustID & ") and cu01=substr(pa27,1,8) and cu02=substr(pa27,9,1) and pa42 is not null and cu29 is not null and replace(replace(replace(rtrim(pa42),'　',null),chr(10),null),chr(13),null) <> replace(rtrim(cu29),'　',null) and (pa10 is not null or (pa10 is null and pa57 is null and pa108 is null and pa136 is null)) and (pa25 is null or (pa25 is not null and pa25>" & strSrvDate(1) & " and pa17='Y')) " & _
              " Union SELECT pa01,pa02,pa03,pa04,pa28 as id,cu04 as cname,rtrim(rtrim(cu05)||' '||rtrim(cu88)||' '||rtrim(cu89)||' '||rtrim(cu90)) as ename,cu06 as jname,pa43 as caseAddr,cu23 as caddr,rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) as eaddr,cu29 as jaddr,3 as sort FROM Patent,Customer WHERE pa01='" & strCP01 & "' and pa09='" & strNation & "' and pa28 in (" & strCustID & ") and cu01=substr(pa28,1,8) and cu02=substr(pa28,9,1) and pa43 is not null and cu29 is not null and replace(replace(replace(rtrim(pa43),'　',null),chr(10),null),chr(13),null) <> replace(rtrim(cu29),'　',null) and (pa10 is not null or (pa10 is null and pa57 is null and pa108 is null and pa136 is null)) and (pa25 is null or (pa25 is not null and pa25>" & strSrvDate(1) & " and pa17='Y')) " & _
              " Union SELECT pa01,pa02,pa03,pa04,pa29 as id,cu04 as cname,rtrim(rtrim(cu05)||' '||rtrim(cu88)||' '||rtrim(cu89)||' '||rtrim(cu90)) as ename,cu06 as jname,pa44 as caseAddr,cu23 as caddr,rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) as eaddr,cu29 as jaddr,3 as sort FROM Patent,Customer WHERE pa01='" & strCP01 & "' and pa09='" & strNation & "' and pa29 in (" & strCustID & ") and cu01=substr(pa29,1,8) and cu02=substr(pa29,9,1) and pa44 is not null and cu29 is not null and replace(replace(replace(rtrim(pa44),'　',null),chr(10),null),chr(13),null) <> replace(rtrim(cu29),'　',null) and (pa10 is not null or (pa10 is null and pa57 is null and pa108 is null and pa136 is null)) and (pa25 is null or (pa25 is not null and pa25>" & strSrvDate(1) & " and pa17='Y')) " & _
              " Union SELECT pa01,pa02,pa03,pa04,pa30 as id,cu04 as cname,rtrim(rtrim(cu05)||' '||rtrim(cu88)||' '||rtrim(cu89)||' '||rtrim(cu90)) as ename,cu06 as jname,pa45 as caseAddr,cu23 as caddr,rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) as eaddr,cu29 as jaddr,3 as sort FROM Patent,Customer WHERE pa01='" & strCP01 & "' and pa09='" & strNation & "' and pa30 in (" & strCustID & ") and cu01=substr(pa30,1,8) and cu02=substr(pa30,9,1) and pa45 is not null and cu29 is not null and replace(replace(replace(rtrim(pa45),'　',null),chr(10),null),chr(13),null) <> replace(rtrim(cu29),'　',null) and (pa10 is not null or (pa10 is null and pa57 is null and pa108 is null and pa136 is null)) and (pa25 is null or (pa25 is not null and pa25>" & strSrvDate(1) & " and pa17='Y')) " & _
              " order by id,pa01,pa02,pa03,pa04,sort "
            rsTmp.CursorLocation = adUseClient
            rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
            If rsTmp.RecordCount > 0 Then
'               With rsTmp
'                  .MoveFirst
'                  Do While .EOF = False
'                     If Trim(.Fields("caseAddr")) <> Trim(.Fields("addr")) Then
                        ChkOCaseAndCAddrNotAlike = True
'                        Exit Do
'                     End If
'                     .MoveNext
'                  Loop
'                  If ChkOCaseAndCAddrNotAlike = True Then
                     If bolMsg = True Then
                        strTit = "檢核資料"
                        strMsg = "有相同國家的舊案申請地址與客戶目前地址不同，請注意！"
                        nResponse = MsgBox(strMsg, vbOKOnly, strTit)
                     End If
'                  End If
'               End With
            End If
         End If
         
      '若為T新申請案(101)且申請國家為020大陸時，
      '若為CFT新申請案(101)且申請國家為011日本、012韓國、014新加坡、239歐洲聯盟時，
      '2011/5/12 MODIFY BY SONIA 陳經理說加013香港
      '須檢查
      Case "T", "CFT"
         If strCaseType = "101" Then
            'Modify by Amy 2016/04/12 CFT改不限制國家
'            If (strCP01 = "T" And strNation = "020") Or _
'               (strCP01 = "CFT" And (strNation = "011" Or strNation = "012" Or strNation = "013" Or strNation = "014" Or strNation = "239")) Then
            If (strCP01 = "T" And strNation = "020") Or strCP01 = "CFT" Then
               If rsTmp.State <> 0 Then
                  rsTmp.Close
               End If
               'and (tm16 is null or tm16<>'2')
               'Modify By Sindy 2015/12/17 T,020不檢查英,日文地址 X25325110 T-174981 T-174982
               'Modify By Sindy 2016/8/12 有申請日一定要檢查地址,無申請人則才要考慮閉卷銷卷問題
               If (strCP01 = "T" And strNation = "020") Then
                  strSql = "SELECT tm01,tm02,tm03,tm04,tm23 as id,cu04 as cname,rtrim(rtrim(cu05)||' '||rtrim(cu88)||' '||rtrim(cu89)||' '||rtrim(cu90)) as ename,cu06 as jname,tm24 as caseAddr,cu23 as caddr,rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) as eaddr,cu29 as jaddr,1 as sort FROM Trademark,Customer WHERE tm01='" & strCP01 & "' and tm10='" & strNation & "' and tm23 in (" & strCustID & ") and cu01=substr(tm23,1,8) and cu02=substr(tm23,9,1) and tm24 is not null and cu23 is not null and replace(replace(replace(rtrim(tm24),'　',null),chr(10),null),chr(13),null) <> replace(rtrim(cu23),'　',null) and replace(replace(replace(rtrim(tm24),'　',null),chr(10),null),chr(13),null) <> rtrim(CU112)||replace(rtrim(cu23),'　',null) and (tm11 is not null or (tm11 is null and tm29 is null and tm57 is null and tm73 is null)) and (tm22 is null or (tm22 is not null and tm22>" & strSrvDate(1) & " and tm17='Y')) " & _
                    " Union SELECT tm01,tm02,tm03,tm04,tm78 as id,cu04 as cname,rtrim(rtrim(cu05)||' '||rtrim(cu88)||' '||rtrim(cu89)||' '||rtrim(cu90)) as ename,cu06 as jname,tm82 as caseAddr,cu23 as caddr,rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) as eaddr,cu29 as jaddr,1 as sort FROM Trademark,Customer WHERE tm01='" & strCP01 & "' and tm10='" & strNation & "' and tm78 in (" & strCustID & ") and cu01=substr(tm78,1,8) and cu02=substr(tm78,9,1) and tm82 is not null and cu23 is not null and replace(replace(replace(rtrim(tm82),'　',null),chr(10),null),chr(13),null) <> replace(rtrim(cu23),'　',null) and replace(replace(replace(rtrim(tm82),'　',null),chr(10),null),chr(13),null) <> rtrim(CU112)||replace(rtrim(cu23),'　',null) and (tm11 is not null or (tm11 is null and tm29 is null and tm57 is null and tm73 is null)) and (tm22 is null or (tm22 is not null and tm22>" & strSrvDate(1) & " and tm17='Y')) " & _
                    " Union SELECT tm01,tm02,tm03,tm04,tm79 as id,cu04 as cname,rtrim(rtrim(cu05)||' '||rtrim(cu88)||' '||rtrim(cu89)||' '||rtrim(cu90)) as ename,cu06 as jname,tm83 as caseAddr,cu23 as caddr,rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) as eaddr,cu29 as jaddr,1 as sort FROM Trademark,Customer WHERE tm01='" & strCP01 & "' and tm10='" & strNation & "' and tm79 in (" & strCustID & ") and cu01=substr(tm79,1,8) and cu02=substr(tm79,9,1) and tm83 is not null and cu23 is not null and replace(replace(replace(rtrim(tm83),'　',null),chr(10),null),chr(13),null) <> replace(rtrim(cu23),'　',null) and replace(replace(replace(rtrim(tm83),'　',null),chr(10),null),chr(13),null) <> rtrim(CU112)||replace(rtrim(cu23),'　',null) and (tm11 is not null or (tm11 is null and tm29 is null and tm57 is null and tm73 is null)) and (tm22 is null or (tm22 is not null and tm22>" & strSrvDate(1) & " and tm17='Y')) " & _
                    " Union SELECT tm01,tm02,tm03,tm04,tm80 as id,cu04 as cname,rtrim(rtrim(cu05)||' '||rtrim(cu88)||' '||rtrim(cu89)||' '||rtrim(cu90)) as ename,cu06 as jname,tm84 as caseAddr,cu23 as caddr,rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) as eaddr,cu29 as jaddr,1 as sort FROM Trademark,Customer WHERE tm01='" & strCP01 & "' and tm10='" & strNation & "' and tm80 in (" & strCustID & ") and cu01=substr(tm80,1,8) and cu02=substr(tm80,9,1) and tm84 is not null and cu23 is not null and replace(replace(replace(rtrim(tm84),'　',null),chr(10),null),chr(13),null) <> replace(rtrim(cu23),'　',null) and replace(replace(replace(rtrim(tm84),'　',null),chr(10),null),chr(13),null) <> rtrim(CU112)||replace(rtrim(cu23),'　',null) and (tm11 is not null or (tm11 is null and tm29 is null and tm57 is null and tm73 is null)) and (tm22 is null or (tm22 is not null and tm22>" & strSrvDate(1) & " and tm17='Y')) " & _
                    " Union SELECT tm01,tm02,tm03,tm04,tm81 as id,cu04 as cname,rtrim(rtrim(cu05)||' '||rtrim(cu88)||' '||rtrim(cu89)||' '||rtrim(cu90)) as ename,cu06 as jname,tm85 as caseAddr,cu23 as caddr,rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) as eaddr,cu29 as jaddr,1 as sort FROM Trademark,Customer WHERE tm01='" & strCP01 & "' and tm10='" & strNation & "' and tm81 in (" & strCustID & ") and cu01=substr(tm81,1,8) and cu02=substr(tm81,9,1) and tm85 is not null and cu23 is not null and replace(replace(replace(rtrim(tm85),'　',null),chr(10),null),chr(13),null) <> replace(rtrim(cu23),'　',null) and replace(replace(replace(rtrim(tm85),'　',null),chr(10),null),chr(13),null) <> rtrim(CU112)||replace(rtrim(cu23),'　',null) and (tm11 is not null or (tm11 is null and tm29 is null and tm57 is null and tm73 is null)) and (tm22 is null or (tm22 is not null and tm22>" & strSrvDate(1) & " and tm17='Y')) " & _
                    " order by id,tm01,tm02,tm03,tm04,sort "
               Else
               '2015/12/17 END
                  strSql = "SELECT tm01,tm02,tm03,tm04,tm23 as id,cu04 as cname,rtrim(rtrim(cu05)||' '||rtrim(cu88)||' '||rtrim(cu89)||' '||rtrim(cu90)) as ename,cu06 as jname,tm24 as caseAddr,cu23 as caddr,rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) as eaddr,cu29 as jaddr,1 as sort FROM Trademark,Customer WHERE tm01='" & strCP01 & "' and tm10='" & strNation & "' and tm23 in (" & strCustID & ") and cu01=substr(tm23,1,8) and cu02=substr(tm23,9,1) and tm24 is not null and cu23 is not null and replace(replace(replace(rtrim(tm24),'　',null),chr(10),null),chr(13),null) <> replace(rtrim(cu23),'　',null) and replace(replace(replace(rtrim(tm24),'　',null),chr(10),null),chr(13),null) <> rtrim(CU112)||replace(rtrim(cu23),'　',null) and (tm11 is not null or (tm11 is null and tm29 is null and tm57 is null and tm73 is null)) and (tm22 is null or (tm22 is not null and tm22>" & strSrvDate(1) & " and tm17='Y')) " & _
                    " Union SELECT tm01,tm02,tm03,tm04,tm78 as id,cu04 as cname,rtrim(rtrim(cu05)||' '||rtrim(cu88)||' '||rtrim(cu89)||' '||rtrim(cu90)) as ename,cu06 as jname,tm82 as caseAddr,cu23 as caddr,rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) as eaddr,cu29 as jaddr,1 as sort FROM Trademark,Customer WHERE tm01='" & strCP01 & "' and tm10='" & strNation & "' and tm78 in (" & strCustID & ") and cu01=substr(tm78,1,8) and cu02=substr(tm78,9,1) and tm82 is not null and cu23 is not null and replace(replace(replace(rtrim(tm82),'　',null),chr(10),null),chr(13),null) <> replace(rtrim(cu23),'　',null) and replace(replace(replace(rtrim(tm82),'　',null),chr(10),null),chr(13),null) <> rtrim(CU112)||replace(rtrim(cu23),'　',null) and (tm11 is not null or (tm11 is null and tm29 is null and tm57 is null and tm73 is null)) and (tm22 is null or (tm22 is not null and tm22>" & strSrvDate(1) & " and tm17='Y')) " & _
                    " Union SELECT tm01,tm02,tm03,tm04,tm79 as id,cu04 as cname,rtrim(rtrim(cu05)||' '||rtrim(cu88)||' '||rtrim(cu89)||' '||rtrim(cu90)) as ename,cu06 as jname,tm83 as caseAddr,cu23 as caddr,rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) as eaddr,cu29 as jaddr,1 as sort FROM Trademark,Customer WHERE tm01='" & strCP01 & "' and tm10='" & strNation & "' and tm79 in (" & strCustID & ") and cu01=substr(tm79,1,8) and cu02=substr(tm79,9,1) and tm83 is not null and cu23 is not null and replace(replace(replace(rtrim(tm83),'　',null),chr(10),null),chr(13),null) <> replace(rtrim(cu23),'　',null) and replace(replace(replace(rtrim(tm83),'　',null),chr(10),null),chr(13),null) <> rtrim(CU112)||replace(rtrim(cu23),'　',null) and (tm11 is not null or (tm11 is null and tm29 is null and tm57 is null and tm73 is null)) and (tm22 is null or (tm22 is not null and tm22>" & strSrvDate(1) & " and tm17='Y')) " & _
                    " Union SELECT tm01,tm02,tm03,tm04,tm80 as id,cu04 as cname,rtrim(rtrim(cu05)||' '||rtrim(cu88)||' '||rtrim(cu89)||' '||rtrim(cu90)) as ename,cu06 as jname,tm84 as caseAddr,cu23 as caddr,rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) as eaddr,cu29 as jaddr,1 as sort FROM Trademark,Customer WHERE tm01='" & strCP01 & "' and tm10='" & strNation & "' and tm80 in (" & strCustID & ") and cu01=substr(tm80,1,8) and cu02=substr(tm80,9,1) and tm84 is not null and cu23 is not null and replace(replace(replace(rtrim(tm84),'　',null),chr(10),null),chr(13),null) <> replace(rtrim(cu23),'　',null) and replace(replace(replace(rtrim(tm84),'　',null),chr(10),null),chr(13),null) <> rtrim(CU112)||replace(rtrim(cu23),'　',null) and (tm11 is not null or (tm11 is null and tm29 is null and tm57 is null and tm73 is null)) and (tm22 is null or (tm22 is not null and tm22>" & strSrvDate(1) & " and tm17='Y')) " & _
                    " Union SELECT tm01,tm02,tm03,tm04,tm81 as id,cu04 as cname,rtrim(rtrim(cu05)||' '||rtrim(cu88)||' '||rtrim(cu89)||' '||rtrim(cu90)) as ename,cu06 as jname,tm85 as caseAddr,cu23 as caddr,rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) as eaddr,cu29 as jaddr,1 as sort FROM Trademark,Customer WHERE tm01='" & strCP01 & "' and tm10='" & strNation & "' and tm81 in (" & strCustID & ") and cu01=substr(tm81,1,8) and cu02=substr(tm81,9,1) and tm85 is not null and cu23 is not null and replace(replace(replace(rtrim(tm85),'　',null),chr(10),null),chr(13),null) <> replace(rtrim(cu23),'　',null) and replace(replace(replace(rtrim(tm85),'　',null),chr(10),null),chr(13),null) <> rtrim(CU112)||replace(rtrim(cu23),'　',null) and (tm11 is not null or (tm11 is null and tm29 is null and tm57 is null and tm73 is null)) and (tm22 is null or (tm22 is not null and tm22>" & strSrvDate(1) & " and tm17='Y')) " & _
                    " Union SELECT tm01,tm02,tm03,tm04,tm23 as id,cu04 as cname,rtrim(rtrim(cu05)||' '||rtrim(cu88)||' '||rtrim(cu89)||' '||rtrim(cu90)) as ename,cu06 as jname,tm25 as caseAddr,cu23 as caddr,rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) as eaddr,cu29 as jaddr,2 as sort FROM Trademark,Customer WHERE tm01='" & strCP01 & "' and tm10='" & strNation & "' and tm23 in (" & strCustID & ") and cu01=substr(tm23,1,8) and cu02=substr(tm23,9,1) and tm25 is not null and rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) is not null and replace(replace(replace(upper(rtrim(tm25)),' ',null),chr(10),null),chr(13),null) <> replace(upper(rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102))),' ',null) " & _
                    " and (tm11 is not null or (tm11 is null and tm29 is null and tm57 is null and tm73 is null)) and (tm22 is null or (tm22 is not null and tm22>" & strSrvDate(1) & " and tm17='Y')) " & _
                    " Union SELECT tm01,tm02,tm03,tm04,tm78 as id,cu04 as cname,rtrim(rtrim(cu05)||' '||rtrim(cu88)||' '||rtrim(cu89)||' '||rtrim(cu90)) as ename,cu06 as jname,tm86 as caseAddr,cu23 as caddr,rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) as eaddr,cu29 as jaddr,2 as sort FROM Trademark,Customer WHERE tm01='" & strCP01 & "' and tm10='" & strNation & "' and tm78 in (" & strCustID & ") and cu01=substr(tm78,1,8) and cu02=substr(tm78,9,1) and tm86 is not null and rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) is not null and replace(replace(replace(upper(rtrim(tm86)),' ',null),chr(10),null),chr(13),null) <> replace(upper(rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102))),' ',null) " & _
                    " and (tm11 is not null or (tm11 is null and tm29 is null and tm57 is null and tm73 is null)) and (tm22 is null or (tm22 is not null and tm22>" & strSrvDate(1) & " and tm17='Y')) " & _
                    " Union SELECT tm01,tm02,tm03,tm04,tm79 as id,cu04 as cname,rtrim(rtrim(cu05)||' '||rtrim(cu88)||' '||rtrim(cu89)||' '||rtrim(cu90)) as ename,cu06 as jname,tm87 as caseAddr,cu23 as caddr,rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) as eaddr,cu29 as jaddr,2 as sort FROM Trademark,Customer WHERE tm01='" & strCP01 & "' and tm10='" & strNation & "' and tm79 in (" & strCustID & ") and cu01=substr(tm79,1,8) and cu02=substr(tm79,9,1) and tm87 is not null and rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) is not null and replace(replace(replace(upper(rtrim(tm87)),' ',null),chr(10),null),chr(13),null) <> replace(upper(rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102))),' ',null) " & _
                    " and (tm11 is not null or (tm11 is null and tm29 is null and tm57 is null and tm73 is null)) and (tm22 is null or (tm22 is not null and tm22>" & strSrvDate(1) & " and tm17='Y')) " & _
                    " Union SELECT tm01,tm02,tm03,tm04,tm80 as id,cu04 as cname,rtrim(rtrim(cu05)||' '||rtrim(cu88)||' '||rtrim(cu89)||' '||rtrim(cu90)) as ename,cu06 as jname,tm88 as caseAddr,cu23 as caddr,rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) as eaddr,cu29 as jaddr,2 as sort FROM Trademark,Customer WHERE tm01='" & strCP01 & "' and tm10='" & strNation & "' and tm80 in (" & strCustID & ") and cu01=substr(tm80,1,8) and cu02=substr(tm80,9,1) and tm88 is not null and rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) is not null and replace(replace(replace(upper(rtrim(tm88)),' ',null),chr(10),null),chr(13),null) <> replace(upper(rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102))),' ',null) " & _
                    " and (tm11 is not null or (tm11 is null and tm29 is null and tm57 is null and tm73 is null)) and (tm22 is null or (tm22 is not null and tm22>" & strSrvDate(1) & " and tm17='Y')) " & _
                    " Union SELECT tm01,tm02,tm03,tm04,tm81 as id,cu04 as cname,rtrim(rtrim(cu05)||' '||rtrim(cu88)||' '||rtrim(cu89)||' '||rtrim(cu90)) as ename,cu06 as jname,tm89 as caseAddr,cu23 as caddr,rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) as eaddr,cu29 as jaddr,2 as sort FROM Trademark,Customer WHERE tm01='" & strCP01 & "' and tm10='" & strNation & "' and tm81 in (" & strCustID & ") and cu01=substr(tm81,1,8) and cu02=substr(tm81,9,1) and tm89 is not null and rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) is not null and replace(replace(replace(upper(rtrim(tm89)),' ',null),chr(10),null),chr(13),null) <> replace(upper(rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102))),' ',null) " & _
                    " and (tm11 is not null or (tm11 is null and tm29 is null and tm57 is null and tm73 is null)) and (tm22 is null or (tm22 is not null and tm22>" & strSrvDate(1) & " and tm17='Y')) " & _
                    " Union SELECT tm01,tm02,tm03,tm04,tm23 as id,cu04 as cname,rtrim(rtrim(cu05)||' '||rtrim(cu88)||' '||rtrim(cu89)||' '||rtrim(cu90)) as ename,cu06 as jname,tm26 as caseAddr,cu23 as caddr,rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) as eaddr,cu29 as jaddr,3 as sort FROM Trademark,Customer WHERE tm01='" & strCP01 & "' and tm10='" & strNation & "' and tm23 in (" & strCustID & ") and cu01=substr(tm23,1,8) and cu02=substr(tm23,9,1) and tm26 is not null and cu29 is not null and replace(replace(replace(rtrim(tm26),'　',null),chr(10),null),chr(13),null) <> replace(rtrim(cu29),'　',null) and (tm11 is not null or (tm11 is null and tm29 is null and tm57 is null and tm73 is null)) and (tm22 is null or (tm22 is not null and tm22>" & strSrvDate(1) & " and tm17='Y')) " & _
                    " Union SELECT tm01,tm02,tm03,tm04,tm78 as id,cu04 as cname,rtrim(rtrim(cu05)||' '||rtrim(cu88)||' '||rtrim(cu89)||' '||rtrim(cu90)) as ename,cu06 as jname,tm90 as caseAddr,cu23 as caddr,rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) as eaddr,cu29 as jaddr,3 as sort FROM Trademark,Customer WHERE tm01='" & strCP01 & "' and tm10='" & strNation & "' and tm78 in (" & strCustID & ") and cu01=substr(tm78,1,8) and cu02=substr(tm78,9,1) and tm90 is not null and cu29 is not null and replace(replace(replace(rtrim(tm90),'　',null),chr(10),null),chr(13),null) <> replace(rtrim(cu29),'　',null) and (tm11 is not null or (tm11 is null and tm29 is null and tm57 is null and tm73 is null)) and (tm22 is null or (tm22 is not null and tm22>" & strSrvDate(1) & " and tm17='Y')) " & _
                    " Union SELECT tm01,tm02,tm03,tm04,tm79 as id,cu04 as cname,rtrim(rtrim(cu05)||' '||rtrim(cu88)||' '||rtrim(cu89)||' '||rtrim(cu90)) as ename,cu06 as jname,tm91 as caseAddr,cu23 as caddr,rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) as eaddr,cu29 as jaddr,3 as sort FROM Trademark,Customer WHERE tm01='" & strCP01 & "' and tm10='" & strNation & "' and tm79 in (" & strCustID & ") and cu01=substr(tm79,1,8) and cu02=substr(tm79,9,1) and tm91 is not null and cu29 is not null and replace(replace(replace(rtrim(tm91),'　',null),chr(10),null),chr(13),null) <> replace(rtrim(cu29),'　',null) and (tm11 is not null or (tm11 is null and tm29 is null and tm57 is null and tm73 is null)) and (tm22 is null or (tm22 is not null and tm22>" & strSrvDate(1) & " and tm17='Y')) " & _
                    " Union SELECT tm01,tm02,tm03,tm04,tm80 as id,cu04 as cname,rtrim(rtrim(cu05)||' '||rtrim(cu88)||' '||rtrim(cu89)||' '||rtrim(cu90)) as ename,cu06 as jname,tm92 as caseAddr,cu23 as caddr,rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) as eaddr,cu29 as jaddr,3 as sort FROM Trademark,Customer WHERE tm01='" & strCP01 & "' and tm10='" & strNation & "' and tm80 in (" & strCustID & ") and cu01=substr(tm80,1,8) and cu02=substr(tm80,9,1) and tm92 is not null and cu29 is not null and replace(replace(replace(rtrim(tm92),'　',null),chr(10),null),chr(13),null) <> replace(rtrim(cu29),'　',null) and (tm11 is not null or (tm11 is null and tm29 is null and tm57 is null and tm73 is null)) and (tm22 is null or (tm22 is not null and tm22>" & strSrvDate(1) & " and tm17='Y')) " & _
                    " Union SELECT tm01,tm02,tm03,tm04,tm81 as id,cu04 as cname,rtrim(rtrim(cu05)||' '||rtrim(cu88)||' '||rtrim(cu89)||' '||rtrim(cu90)) as ename,cu06 as jname,tm93 as caseAddr,cu23 as caddr,rtrim(rtrim(cu24)||' '||rtrim(cu25)||' '||rtrim(cu26)||' '||rtrim(cu27)||' '||rtrim(cu28)||' '||rtrim(cu102)) as eaddr,cu29 as jaddr,3 as sort FROM Trademark,Customer WHERE tm01='" & strCP01 & "' and tm10='" & strNation & "' and tm81 in (" & strCustID & ") and cu01=substr(tm81,1,8) and cu02=substr(tm81,9,1) and tm93 is not null and cu29 is not null and replace(replace(replace(rtrim(tm93),'　',null),chr(10),null),chr(13),null) <> replace(rtrim(cu29),'　',null) and (tm11 is not null or (tm11 is null and tm29 is null and tm57 is null and tm73 is null)) and (tm22 is null or (tm22 is not null and tm22>" & strSrvDate(1) & " and tm17='Y')) " & _
                    " order by id,tm01,tm02,tm03,tm04,sort "
               End If
               rsTmp.CursorLocation = adUseClient
               rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
               If rsTmp.RecordCount > 0 Then
'                  With rsTmp
'                     .MoveFirst
'                     Do While .EOF = False
'                        If Trim(.Fields("caseAddr")) <> Trim(.Fields("addr")) Then
                           ChkOCaseAndCAddrNotAlike = True
'                           Exit Do
'                        End If
'                        .MoveNext
'                     Loop
'                     If ChkOCaseAndCAddrNotAlike = True Then
                        If bolMsg = True Then
                           strTit = "檢核資料"
                           strMsg = "有相同國家的舊案申請地址與客戶目前地址不同，請注意！"
                           nResponse = MsgBox(strMsg, vbOKOnly, strTit)
                        End If
'                     End If
'                  End With
               End If
            End If
         End If
   End Select
End Function

'add by Sindy 2011/7/1
'檢查舊案申請地址與接洽紀錄單上新址提申不同者,請擇一
Public Function ChkOCaseAndCAddrNotAlikeChoose(ByVal strCustID As String, ByVal strNation As String, ByVal strCP01 As String, ByVal strCaseType As String, ByRef rsTmp As ADODB.Recordset, Optional bolMsg As Boolean = True) As Boolean
Dim strSql As String
Dim strTit As String
Dim strMsg As String
Dim nResponse
   
   ChkOCaseAndCAddrNotAlikeChoose = False
   
   Select Case strCP01
      '若為T,TF且非台灣案
      Case "T", "TF"
         If strNation <> "000" Then
            If rsTmp.State <> 0 Then
               rsTmp.Close
            End If
            'Modify By Sindy 2016/8/12 有申請日一定要檢查地址,無申請人則才要考慮閉卷銷卷問題
            strSql = "SELECT '' as V,tm24 as 案件申請地址,'' as 備註 FROM Trademark,Customer WHERE tm01='" & strCP01 & "' and tm10='" & strNation & "' and tm23 in ('" & strCustID & "') and cu01=substr(tm23,1,8) and cu02=substr(tm23,9,1) and tm24 is not null and cu23 is not null and replace(replace(replace(rtrim(tm24),'　',null),chr(10),null),chr(13),null) <> replace(rtrim(cu23),'　',null) and replace(replace(replace(rtrim(tm24),'　',null),chr(10),null),chr(13),null) <> rtrim(CU112)||replace(rtrim(cu23),'　',null) and (tm11 is not null or (tm11 is null and tm29 is null and tm57 is null and tm73 is null)) and (tm22 is null or (tm22 is not null and tm22>" & strSrvDate(1) & " and tm17='Y')) " & _
              " Union SELECT '' as V,tm82 as 案件申請地址,'' as 備註 FROM Trademark,Customer WHERE tm01='" & strCP01 & "' and tm10='" & strNation & "' and tm78 in ('" & strCustID & "') and cu01=substr(tm78,1,8) and cu02=substr(tm78,9,1) and tm82 is not null and cu23 is not null and replace(replace(replace(rtrim(tm82),'　',null),chr(10),null),chr(13),null) <> replace(rtrim(cu23),'　',null) and replace(replace(replace(rtrim(tm82),'　',null),chr(10),null),chr(13),null) <> rtrim(CU112)||replace(rtrim(cu23),'　',null) and (tm11 is not null or (tm11 is null and tm29 is null and tm57 is null and tm73 is null)) and (tm22 is null or (tm22 is not null and tm22>" & strSrvDate(1) & " and tm17='Y')) " & _
              " Union SELECT '' as V,tm83 as 案件申請地址,'' as 備註 FROM Trademark,Customer WHERE tm01='" & strCP01 & "' and tm10='" & strNation & "' and tm79 in ('" & strCustID & "') and cu01=substr(tm79,1,8) and cu02=substr(tm79,9,1) and tm83 is not null and cu23 is not null and replace(replace(replace(rtrim(tm83),'　',null),chr(10),null),chr(13),null) <> replace(rtrim(cu23),'　',null) and replace(replace(replace(rtrim(tm83),'　',null),chr(10),null),chr(13),null) <> rtrim(CU112)||replace(rtrim(cu23),'　',null) and (tm11 is not null or (tm11 is null and tm29 is null and tm57 is null and tm73 is null)) and (tm22 is null or (tm22 is not null and tm22>" & strSrvDate(1) & " and tm17='Y')) " & _
              " Union SELECT '' as V,tm84 as 案件申請地址,'' as 備註 FROM Trademark,Customer WHERE tm01='" & strCP01 & "' and tm10='" & strNation & "' and tm80 in ('" & strCustID & "') and cu01=substr(tm80,1,8) and cu02=substr(tm80,9,1) and tm84 is not null and cu23 is not null and replace(replace(replace(rtrim(tm84),'　',null),chr(10),null),chr(13),null) <> replace(rtrim(cu23),'　',null) and replace(replace(replace(rtrim(tm84),'　',null),chr(10),null),chr(13),null) <> rtrim(CU112)||replace(rtrim(cu23),'　',null) and (tm11 is not null or (tm11 is null and tm29 is null and tm57 is null and tm73 is null)) and (tm22 is null or (tm22 is not null and tm22>" & strSrvDate(1) & " and tm17='Y')) " & _
              " Union SELECT '' as V,tm85 as 案件申請地址,'' as 備註 FROM Trademark,Customer WHERE tm01='" & strCP01 & "' and tm10='" & strNation & "' and tm81 in ('" & strCustID & "') and cu01=substr(tm81,1,8) and cu02=substr(tm81,9,1) and tm85 is not null and cu23 is not null and replace(replace(replace(rtrim(tm85),'　',null),chr(10),null),chr(13),null) <> replace(rtrim(cu23),'　',null) and replace(replace(replace(rtrim(tm85),'　',null),chr(10),null),chr(13),null) <> rtrim(CU112)||replace(rtrim(cu23),'　',null) and (tm11 is not null or (tm11 is null and tm29 is null and tm57 is null and tm73 is null)) and (tm22 is null or (tm22 is not null and tm22>" & strSrvDate(1) & " and tm17='Y')) "
            rsTmp.CursorLocation = adUseClient
            rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
            If rsTmp.RecordCount > 0 Then
               ChkOCaseAndCAddrNotAlikeChoose = True
            Else
               If bolMsg = True Then
                  strTit = "檢核資料"
                  strMsg = "查無資料！"
                  nResponse = MsgBox(strMsg, vbOKOnly, strTit)
               End If
            End If
         End If
   End Select
End Function

'Add by Morgan 2011/3/25
'從發明人維護移出以便共用
Public Function PUB_GetNewIN02(ByVal pIN01 As String) As String
   Dim stSQL As String, intR As Integer
   Dim adoRst As ADODB.Recordset
   Dim lstIN02 As String, newIN02 As String
   Dim Chr1 As String, Chr2 As String
   'Added by Lydia 2022/09/20
   Dim IntNow As Integer, intJ As Integer
   Dim rsQuery As New ADODB.Recordset
   
   stSQL = "SELECT NVL(MAX(IN02),'00') FROM INVENTOR WHERE IN01='" & pIN01 & "'"
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      lstIN02 = Right("00" & adoRst.Fields(0), 2)
      'Modify by Morgan 2011/3/1 以文字判斷,超過99後第一碼改A~Z,第二碼從0~9後為A~Z,Ex 99,A0,A1...A9,AA,AB...AZ,B0
      If lstIN02 < "99" Then
         newIN02 = Format(Val(lstIN02) + 1, "00")
      ElseIf lstIN02 < "ZZ" Then
         Chr1 = Mid(lstIN02, 1, 1)
         Chr2 = Mid(lstIN02, 2, 1)
         If Chr2 < "9" Then
            Chr2 = Val(Chr2) + 1
         ElseIf Chr2 = "9" Then
            If Chr1 = "9" Then
               Chr1 = "A"
               Chr2 = "0"
            Else
               Chr2 = "A"
            End If
         ElseIf Chr2 < "Z" Then
            Chr2 = Chr(Asc(Chr2) + 1)
         Else
            Chr2 = 0
            If Chr1 = "9" Then '如果有輸入 9A~Z 時
               Chr1 = "A"
            Else
               Chr1 = Chr(Asc(Chr1) + 1)
            End If
         End If
         newIN02 = Chr1 & Chr2
      'Added by Lydia 2022/09/20 若最大的in02='ZZ'時，請往前面抓空號使用，但是不可為00; ex.X3479000
      ElseIf lstIN02 = "ZZ" Then
         'Added by Morgan 2024/6/7 因有客戶的發明人超過上限1036(00-99,A0-ZZ),改用語法抓尚未使用的編號,增加260個(0A~9Z) --Ex:X34790 中國鋼鐵
         stSQL = "select ss from ( select decode( sign(x1-9),1,chr(55+x1),x1)||decode( sign(y1-9),1,chr(55+y1),y1) ss" & _
            " from (select rownum-1 x1 from workday where rownum<37 ) x,(select rownum-1 y1 from workday where rownum<37 ) y" & _
            ") where not exists(select * from inventor where in01='" & pIN01 & "' and in02=ss) order by 1"
         
         intR = 1
         Set adoRst = ClsLawReadRstMsg(intR, stSQL)
         If intR = 1 Then
            newIN02 = adoRst(0)
         Else
            MsgBox "發明人已超過目前系統上限!", vbCritical, "發明人編號"
         End If
         'end 2024/6/7

'Removed by Morgan 2024/6/7 改上面寫法
'          stSQL = "select '1' as ord1, substr(in02,1,1) as grp ,COUNT(*) as cnt " & _
'                       "from inventor where in01='" & pIN01 & "' and substr(in02,1,1)<'A' group by substr(in02,1,1) " & _
'                       "union select '2' as ord1, substr(in02,1,1) as grp ,COUNT(*) as cnt " & _
'                       "from inventor where in01='" & pIN01 & "' and substr(in02,1,1)>='A' group by substr(in02,1,1) " & _
'                       "order by 1, 2 "
'          Chr1 = ""
'          Chr2 = ""
'          '第一碼的範圍: 0,1,2,3,4,5,6,7,8,9,A,B,C...Z
'          For intJ = 0 To 35
'              If intJ < 10 Then
'                 Chr2 = Chr2 & intJ & ","
'              Else
'                 Chr2 = Chr2 & Chr(65 + (intJ - 10)) & ","
'              End If
'          Next intJ
'          intR = 1
'          Set adoRst = ClsLawReadRstMsg(intR, stSQL)
'          If intR = 1 Then
'              adoRst.MoveFirst
'              For intR = 1 To adoRst.RecordCount
'                  IntNow = 0
'                  If ("" & adoRst.Fields("grp") = "0" And "" & adoRst.Fields("cnt") = "9") Or (Val("" & adoRst.Fields("grp")) > 0 And "" & adoRst.Fields("cnt") = "10") _
'                         Or ("" & adoRst.Fields("grp") >= "A" And "" & adoRst.Fields("cnt") = "36") Then
'                      '跳過00、第一碼滿號
'                  ElseIf InStr(Chr2, adoRst.Fields("grp") & ",") > 1 Then
'                      '遇到未使用的第一碼
'                      newIN02 = Left(Chr2, 1) & "0"
'                      Exit For
'                  Else
'                      stSQL = "select substr(in02,2,1) chr1 from inventor where in01='" & pIN01 & "' and substr(in02,1,1)=" & CNULL("" & adoRst.Fields("grp")) & " order by 1"
'                      intJ = 1
'                      Set rsQuery = ClsLawReadRstMsg(intJ, stSQL)
'                      If intJ = 1 Then
'                          rsQuery.MoveFirst
'                          Do While Not rsQuery.EOF
'                              '第一碼為0~9=>第二碼限制為0~9
'                              If "" & adoRst.Fields("grp") < "A" Then
'                                 If adoRst.Fields("grp") & IntNow = "00" Then
'                                     IntNow = 1
'                                 End If
'                                 If IntNow < "" & rsQuery.Fields("chr1") Then
'                                    newIN02 = adoRst.Fields("grp") & IntNow
'                                    Exit For
'                                 End If
'                                 IntNow = IntNow + 1
'
'                                 If rsQuery.AbsolutePosition = rsQuery.RecordCount Then
'                                     newIN02 = adoRst.Fields("grp") & IntNow
'                                     Exit For
'                                 ElseIf IntNow > 10 Then
'                                     Exit Do '滿號
'                                 End If
'                              '第一碼為A~Z=>第二碼0~9, A~Z
'                              Else
'                                 If IntNow < 9 And IntNow < "" & rsQuery.Fields("chr1") Then
'                                    newIN02 = adoRst.Fields("grp") & IntNow
'                                    Exit For
'                                 ElseIf IntNow > 10 And Chr(IntNow) < "" & rsQuery.Fields("chr1") Then
'                                    newIN02 = adoRst.Fields("grp") & Chr(IntNow)
'                                    Exit For
'                                 End If
'
'                                 IntNow = IntNow + 1
'                                 If IntNow = 10 Then IntNow = Asc("A")
'
'                                 If rsQuery.AbsolutePosition = rsQuery.RecordCount Then
'                                     newIN02 = adoRst.Fields("grp") & IIf(IntNow < 9, IntNow, Chr(IntNow))
'                                     Exit For
'                                 ElseIf IntNow > 90 Then '大於Z
'                                     Exit Do '滿號
'                                 End If
'                              End If
'                              rsQuery.MoveNext
'                          Loop
'                      End If
'                  End If
'                  Chr2 = Replace(Chr2, adoRst.Fields("grp") & ",", "") '去掉已經滿號的第一碼
'                  If newIN02 <> "" Then Exit For
'                  adoRst.MoveNext
'              Next intR
'          End If
'          If newIN02 = "" Then
'              '檢查有無未使用的編號
'              If Len(Trim(Chr2)) >= 2 Then
'                 newIN02 = Left(Chr2, 1) & "0"
'              Else
'                 MsgBox "查無空號!", vbCritical, "發明人編號"
'                 newIN02 = "00"
'              End If
'          End If
'end 2024/6/6
      'end 2022/09/20
      End If
   Else
      newIN02 = "01"
   End If
   PUB_GetNewIN02 = newIN02
   If adoRst.State <> adStateClosed Then adoRst.Close
   Set adoRst = Nothing
   Set rsQuery = Nothing 'Added by Lydia 2022/09/20
End Function

'Add by Morgan 2011/4/18
'預設請款單備註
'pAgentNo:代理人(客戶)代碼, pSys:系統代碼
Public Function PUB_GetDNRemark(pAgentNo As String, Optional pSys As String, Optional pCaseNo2 As String, Optional pCaseNo3 As String, Optional pCaseNo4 As String) As String
'Memo by Lydia 2019/06/11 若增加備註,請記得詢問承辦目前未結清的請款單是否要加上列印備註(a1k05)

   Select Case pAgentNo
      'Added by Morgan 2019/6/6 --Lisa
      Case "Y48183000", "Y48183010"
         PUB_GetDNRemark = """All services provided were performed outside of the U.S."""
         
      Case "Y33268020"
         PUB_GetDNRemark = """Services were not performed in the US"""
         
      'Add by Morgan 2011/4/29
      Case "Y51988000"
         PUB_GetDNRemark = """No work performed in the United States"""
      
      'Add by Morgan 2011/5/4
      Case "Y52223000"
         PUB_GetDNRemark = """No work was performed in the U.S."""
      
      'Added by Morgan 2014/12/3
      Case "Y48315010"
         PUB_GetDNRemark = PUB_GetDNRemark2(pSys, pCaseNo2, pCaseNo3, pCaseNo4)
      
      'Added by Morgan 2017/3/22 --陳怡蓉
      Case "Y21199010"
         PUB_GetDNRemark = """All services reflected on this invoice were performed outside of the United States"""
      
      'Added by Morgan 2017/3/24
      Case "Y54745000"
         PUB_GetDNRemark = "Sachkonto: 67200210" & vbCrLf
         PUB_GetDNRemark = PUB_GetDNRemark & "Cost Center: 50% of the sum refer to S.101-0401.01-1-03 and the other 50% of the sum refer to F.276-0321.01-1-02" & vbCrLf
         PUB_GetDNRemark = PUB_GetDNRemark & "Contact person in CH: Mr. Frederic Ravussin."
         
   End Select
End Function
'Added by Morgan 2014/12/3
Private Function PUB_GetDNRemark2(pPA01 As String, pPA02 As String, pPA03 As String, pPA04 As String) As String
   Dim stSQL As String, intR As Integer
   Dim rsQuery As ADODB.Recordset
   
   stSQL = "select pa52 from patent where pa01='" & pPA01 & "' and pa02='" & pPA02 & "' and pa03='" & pPA03 & "' and pa04='" & pPA04 & "' and pa52 is not null"
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      PUB_GetDNRemark2 = "The Primary Attorney for this case is " & Replace(rsQuery(0), vbCrLf, "") & "."
   End If
   Set rsQuery = Nothing
End Function

'Add by Morgan 2011/5/11
'取新的公報代理人編號
Public Function PUB_GetFreeAgentCode(pSys As String) As String
   Dim stSQL As String, intR As Integer
   Dim adoRst As ADODB.Recordset
   Dim lstTA02 As String, newTA02 As String
   Dim stChr(4) As String, ii As Integer
   
   '最大號,不足4碼前面補空白再比較1000才會比9大
   stSQL = "SELECT max(substrb('    '||TA02,-4)) FROM TAgent WHERE TA01 = '" & pSys & "'"
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      lstTA02 = adoRst.Fields(0)
      '以文字判斷,超過9999後第一碼改A~Z,第二碼從0~9後為A~Z,Ex 99,A0,A1...A9,AA,AB...AZ,B0
      If lstTA02 < "9999" Then
         newTA02 = Val(lstTA02) + 1
      
      '先考慮第一碼改英文就好 27萬個代理人應該也夠用了
      ElseIf lstTA02 < "Z999" Then
         For ii = 1 To 4
            stChr(ii) = Mid(lstTA02, ii, 1)
         Next
         '0~8,A~Y
         If stChr(4) < "9" Or (stChr(4) > "9" And stChr(4) < "Z") Then
            stChr(4) = Chr(Asc(stChr(4)) + 1)
         
         ElseIf stChr(4) = "Z" Or stChr(4) = "9" Then
            stChr(4) = "0"
            If stChr(3) < "9" Or (stChr(3) > "9" And stChr(3) < "Z") Then
               stChr(3) = Chr(Asc(stChr(3)) + 1)
               
            ElseIf stChr(3) = "Z" Or stChr(3) = "9" Then
               stChr(3) = "0"
               If stChr(2) < "9" Or (stChr(3) > "2" And stChr(2) < "Z") Then
                  stChr(2) = Chr(Asc(stChr(2)) + 1)
                  
               ElseIf stChr(2) = "Z" Or stChr(2) = "9" Then
                  stChr(2) = "0"
                  stChr(1) = Chr(Asc(stChr(1)) + 1)
               End If
            End If
         End If
         
         newTA02 = stChr(1) & stChr(2) & stChr(3) & stChr(4)
      End If
   Else
      newTA02 = "1"
   End If
   PUB_GetFreeAgentCode = newTA02
   If adoRst.State <> adStateClosed Then adoRst.Close
   Set adoRst = Nothing
End Function
'從 basPerson 移來 Morgan 2011/5/25 +bolSilent
'*************************************************
' 檢查員工代號是否正確
' Input : strTemp ==> 員工代號
' Output : False.正確 / True.有誤
'*************************************************
Public Function ChkStaffID(ByVal strTemp As String, Optional bolSilent As Boolean) As Boolean
Dim i As Integer

On Error GoTo ErrHand
   
   ChkStaffID = False
   'Modify By Sindy 2010/11/25 調整員工編號第1碼規則
   If Val(strSrvDate(1)) < 20110101 Then
      ' 判斷員工代號須為 6~9 或 F 開頭
      If (Left(Trim(strTemp), 1) < "6" Or Left(Trim(strTemp), 1) > "9") And Left(Trim(strTemp), 1) <> "F" Then
         If bolSilent = False Then
            MsgBox "員工代號須為 6~9 或 F 開頭，請確認！", vbCritical
         End If
         ChkStaffID = True
      End If
   Else
      ' 判斷員工代號須為 6~9 或 A~F 開頭
      If (Left(Trim(strTemp), 1) < "6" Or Left(Trim(strTemp), 1) > "9") And _
         (Left(Trim(strTemp), 1) < "A" Or Left(Trim(strTemp), 1) > "G") Then
         If bolSilent = False Then
            MsgBox "員工代號須為 6~9 或 A~F 開頭，請確認！", vbCritical
         End If
         ChkStaffID = True
      End If
   End If
   
   Exit Function
ErrHand:
   MsgBox "員工代號錯誤，請重新輸入 !", vbCritical
End Function

'Removed by Morgan 2013/9/11 改用PUB_GetNpMemo
''Add by Morgan 2011/6/13
''代理人/申請人年費期限備註
''pReceiver:收件人,pApplicant:申請人,pCaseNo:本所案號
'Public Function PUB_Get605Memo(pReceiver As String, pApplicant As String, pCaseNo As String) As String
'   Dim stRtn As String
'
'   Select Case pCaseNo
'      'Added by Morgan 2012/7/17
'      Case "FCP026742000", "FCP035466000", "FCP038757000", "FCP037803000", "FCP043374000", "FCP041445000", "FCP041446000", "FCP043893000"
'         stRtn = "年費事宜需另cc:X59555;"
'      'end 2012/7/17
'      'add by sonia 2013/5/27
'      Case "FCP041305000"
'         stRtn = "催年費函與FCP-041306併成同一張函;"
'      Case "FCP041306000"
'         stRtn = "催年費函與FCP-041305併成同一張函;"
'      '2013/5/27 end
'      Case Else
'         Select Case Left(pReceiver, 6)
'            Case "Y33944", "Y48840", "Y48196", "Y20624", "Y21099"
'               stRtn = "信函要傳真;"
'
'            Case "Y49083"
'               stRtn = "只需銀龍加蓋年費回傳章;"
'
'            Case "Y30011"
'               stRtn = "年費函需以EMail傳送,不寄紙本;"
'
'            'Add by Morgan 2011/10/19--譚文蓉
'            Case "Y47735"
'               '關係企業不用 --林芳如
'               If pReceiver = "Y47735000" Then
'                  stRtn = "催年費函需另cc:Y47740;"
'               End If
'
'            Case Else
'               'Added by Morgan 2012/6/4
'               If pReceiver = "Y46513010" And pApplicant = "X46513000" Then
'                  stRtn = "不寄年費催繳函,只留備份;"
'               'Added by Morgan 2012/8/20
'               Else
'                  Select Case Left(pApplicant, 6)
'                     Case "X47047" '原在Trigger自動加註Y52216000代理的案件的年費期限,更代後改判斷申請人且併入本函數
'                        stRtn = "年費函不需報價;"
'                  End Select
'               'end 2012/8/20
'               End If
'               'end 2012/6/4
'         End Select
'   End Select
'   PUB_Get605Memo = stRtn
'End Function
''Add by Morgan 2011/6/13
''代理人/申請人實體審查期限備註
''pApplicant:申請人,pFCAgent:FC代理人
'Public Function PUB_Get416Memo(pApplicant As String, pFCAgent As String) As String
'   Dim stRtn As String
'   Select Case pFCAgent
'      '2011/10/12 modify by sonia 加入Y51304020(自發明申請發文,申請案號輸入移過來)
'      'Modified by Morgan 2012/2/1 改 X21775000 為 Y21775000 --美珍
'      Case "Y21775000", "Y51304020"
'         stRtn = "不寄函逕收文;"
'      Case Else
'         Select Case pApplicant
'            Case "X55560000", "X55560010", "X20438000"
'               stRtn = "不寄函逕收文;"
'            '2011/10/12 add by sonia
'            Case "X45814000"
'               If pFCAgent = "Y45814000" Then stRtn = "不寄函逕收文;"
'            '2011/10/12 end
'
'            'Added by Morgan 2012/2/2
'            Case "X21775000"
'               If pFCAgent = "Y49361000" Then stRtn = "不寄函逕收文;"
'            'end 2012/2/2
'            'Added by Morgan 2012/5/9
'            Case "X46370000"
'               If pFCAgent = "Y20136000" Then stRtn = "請管制期限前一個月交承辦收文實審;"
'            'end 2012/5/9
'         End Select
'   End Select
'   PUB_Get416Memo = stRtn
'End Function
'end 2013/9/11

'Add by Morgan 2011/6/15
Public Sub MaskEdBoxInverse(pBox As MaskEdBox)
   pBox.SelStart = 0
   pBox.SelLength = Len(pBox.Text)
End Sub

'Modified by Lydia 2021/05/24 改成Form 2.0可用
'Public Sub AddCboName(cbo As ComboBox, pa05 As String, pa06 As String, pa07 As String)
Public Sub AddCboName(cbo As Object, pa05 As String, pa06 As String, pa07 As String)
   cbo.Clear
   cbo.AddItem "中 : " & pa05
   cbo.AddItem "英 : " & pa06
   'Modified by Lydia 2022/04/25 「日文名稱」改為「外文名稱」
   cbo.AddItem "外 : " & pa07
   cbo.ListIndex = 0
End Sub


'Add by Morgan 2011/8/9
'檢查程式是否正在執行中,本程式則檢查是否有2個以上相同程式
'Modify by Amy 2020/01/21 +ProCount '回傳有幾個執行檔在執行
'Modified by Morgan 2020/9/30 +pOwners:執行者ID 'Removed by Morgan 2020/10/21 取消
Public Function PUB_CheckIsRunning(pProcessName As String, Optional ByRef ProCount As Integer = 0) As Boolean

   Dim Processes, Process
   'Dim stOwner As String 'Added by Morgan 2020/9/30 'Removed by Morgan 2020/10/21 取消
   
   If pub_OS = 2 Then
      Set Processes = Interaction.GetObject("winmgmts:").ExecQuery("select * from Win32_Process where name='" & pProcessName & "'")
      If UCase(pProcessName) = UCase(App.EXEName & ".exe") Then
         If Processes.Count > 1 Then PUB_CheckIsRunning = True
      Else
         If Processes.Count > 0 Then PUB_CheckIsRunning = True
      End If
      
      'Added by Morgan 2020/9/30
      'Removed by Morgan 2020/10/21 取得執行者會有權限問題，也可能因時間差造成程式已關閉而引發 Not found 錯誤，故取消
      'If Processes.Count > 0 Then
      '   For Each Process In Processes
      '      If Process.getowner(stOwner) = 0 Then
      '         pOwners = pOwners & "," & stOwner
      '      End If
      '   Next
      '   If pOwners <> "" Then pOwners = Mid(pOwners, 2)
      'End If
      'end 2020/9/30
      
      ProCount = Processes.Count
   End If
End Function

'Add by Morgan 2011/8/9
'轉PDF格式
Public Function PUB_Trans2Pdf(pFromFilePath As String, pToFileName As String, pJoin As Boolean, pToPath As String) As Boolean
   Dim strCmd As String, iTimes As Integer
   Dim strTempPdfPath As String
   Dim oFilObj As FileSystemObject
   
   '多張先產生暫存
   If pJoin = True Then
      strTempPdfPath = ".\$*.pdf"
      
   '單張直接寫到目的地
   Else
      strTempPdfPath = """" & pToPath & "\" & pToFileName & """"
   End If
   
   strCmd = "ablebatchconverter.exe /inputfile=" & pFromFilePath & " /outputfile=" & strTempPdfPath & " /overwrite"
   Shell strCmd
   For iTimes = 1 To 10
      If PUB_CheckIsRunning("ablebatchconverter.exe") = True Then
         Sleep 1000
      Else
         Exit For
      End If
   Next
   If iTimes > 10 Then Exit Function
   
   If pJoin = True Then
      If Dir(".\" & pToFileName) <> "" Then
         Kill ".\" & pToFileName
      End If
      '特殊路徑無法存檔故先就地合併
      'Modified by Morgan 2014/5/9 合併程式改放執行檔路徑
      'strCmd = "pdftk.exe " & strTempPdfPath & " cat output .\" & pToFileName & ""
      strCmd = pub_PdftkEXE & " " & strTempPdfPath & " cat output .\" & pToFileName & ""
      Shell strCmd
      For iTimes = 1 To 10
         If PUB_CheckIsRunning(pub_PdftkName) = True Then
            Sleep 1000
         Else
            Exit For
         End If
      Next
      If iTimes > 10 Then Exit Function
      
      '搬到目的地
      Set oFilObj = New FileSystemObject
      If oFilObj.FileExists(pToPath & "\" & pToFileName) = True Then oFilObj.DeleteFile pToPath & "\" & pToFileName
      oFilObj.MoveFile ".\" & pToFileName, pToPath & "\" & pToFileName
      Set oFilObj = Nothing
      
      '刪除暫存檔
      If Dir(strTempPdfPath) <> "" Then
         Kill strTempPdfPath
      End If
   End If
      
   PUB_Trans2Pdf = True
   
   '刪除暫存檔
   If Dir(pFromFilePath) <> "" Then
      Kill pFromFilePath
   End If

End Function

'取得Windows System的目錄
Public Function PUB_GetWinSysPath()
   Dim len5 As Long
   Dim SysPath As String
   SysPath = String(255, 0)
   len5 = GetSystemDirectory(SysPath, 256)
   SysPath = Left(SysPath, InStr(1, SysPath, Chr(0)) - 1) & "\"
   PUB_GetWinSysPath = SysPath
End Function

Public Function PUB_GetMyComputerSysPath() As Long
'宣告變數
Dim str As String

On Error GoTo ErrorHandler
PUB_GetMyComputerSysPath = -1
str = String(MAX_PATH, "#")

'讀取本機Win系統目錄失敗
If GetSystemDirectory(str, MAX_PATH) = 0 Then
   '寫入Log檔
   Pub_WriteSysLog "讀取本機Win系統目錄失敗"
   Exit Function
'成功
Else
   SaveSetting "UpdSys", "Update", "WinSysPath", Replace(str, "#", "")
End If

'讀取與設定成功
PUB_GetMyComputerSysPath = 0
Exit Function

ErrorHandler:
'寫入Log檔
Pub_WriteSysLog "<" & Err.Number & ">" & Err.Description
End Function

'g_strWriteSysLogFilePath As String '欲記錄Log的完整路徑及檔名
Public Sub Pub_WriteSysLog(strMsg As String)
Dim ffa As Integer
Dim strFilePath As String 'Add By Sindy 2018/5/28

'Added by Morgan 2019/10/25 每日/每月批次log另外寫
If InStr(LCase(App.EXEName), "autobatch") > 0 Then
   If InStr(LCase(App.EXEName), "autobatchday") > 0 Then
      WLog strMsg
   Else
      WLog strMsg, 1
   End If
   Exit Sub
End If
'end 2019/10/25
   
strFilePath = App.path & "\Log_" & App.EXEName & ".txt"
'Add By Sindy 2018/5/28
If g_strWriteSysLogFilePath <> "" Then
   strFilePath = g_strWriteSysLogFilePath
End If
'2018/5/28 END

ffa = FreeFile
'Open App.path & "\Log_" & App.EXEName & ".txt" For Append As ffa
Open strFilePath For Append As ffa
Print #ffa, Trim(Now) & "  ==>  " & strMsg
Close ffa
End Sub

'員工或客戶編號轉數字
Public Function PUB_Id2Num(ByRef pID As String, Optional strType As String = "0") As Long
   pID = Trim(pID)
   Select Case strType
      Case 0 '員工編號
         If pID <> "001-1" Then '業務助理 Add By Sindy 2013/8/1 +if
            'Modified by Morgan 2019/10/8 員工號有W開頭,第1碼改轉ASCII CODE 即(0~Z-> 48~90)
            'PUB_Id2Num = "&H" & pID
            'Modified by Morgan 2019/10/30 原程式有問題(Ex:80030),改第1碼改轉ASCII CODE 後面保留原數字
            'If Len(pID) < 5 Or pID < "60000" Then '非員工號
            '   PUB_Id2Num = "&H" & pID
            'Else
            '   PUB_Id2Num = Val(Asc(Left(pID, 1)) & CLng("&H" & Mid(pID, 2)))
            'End If
            PUB_Id2Num = Val(Asc(Left(pID, 1)) & Mid(pID, 2))
            'end 2019/10/30
            'end 2019/10/8
         End If
      Case 1 '客戶編號
         'Modified by Morgan 2016/9/8 末三碼會有B,C改轉16進位,前9碼維持10進位,用+-表示XY,第1碼改固定放1(因長整數不可大於2147483647)
         If Left(pID, 1) = "X" Then
            'PUB_Id2Num = "1" & Mid(Trim(pID), 2, Len(Trim(pID)) - 1)
            PUB_Id2Num = "1" & Mid(pID, 2, Len(pID) - 4) & Format("&H" & Right(pID, 3), "0000")
         ElseIf Left(pID, 1) = "Y" Then
            'PUB_Id2Num = "2" & Mid(Trim(pID), 2, Len(Trim(pID)) - 1)
            PUB_Id2Num = "-1" & Mid(pID, 2, Len(pID) - 4) & Format("&H" & Right(pID, 3), "0000")
         End If
         'end 2016/9/8
   End Select
End Function

'數字轉員工或客戶編號
Public Function PUB_Num2Id(pNum As Long, Optional strType As String = "0") As String
   Dim strNum As String
   
   Select Case strType
      Case 0 '員工編號
         'Modified by Morgan 2019/10/8 員工號有W開頭,第1碼改轉ASCII CODE
         'PUB_Num2Id = Hex(pNum)
         'Modified by Morgan 2019/10/30 原程式有問題(Ex:80030),改第1碼改轉ASCII CODE 後面保留原數字
         'If pNum < 65536 Then '非員工號
         '   PUB_Num2Id = Hex(pNum)
         'Else
         '   PUB_Num2Id = Chr(Left(pNum, 2)) & Hex(Mid(pNum, 3))
         'End If
         PUB_Num2Id = Chr(Left(pNum, 2)) & Mid(pNum, 3)
         'end 2019/10/30
         'end 2019/10/8
      Case 1 '客戶編號
         'Modified by Morgan 2016/9/8 末三碼會有B,C改轉16進位,前9碼維持10進位,用+-表示XY,第1碼改固定放1(因長整數不可大於2147483647)
         'If Left(Trim(pNum), 1) = "1" Then
            'PUB_Num2Id = "X" & Mid(Trim(pNum), 2, Len(Trim(pNum)) - 1)
         'ElseIf Left(Trim(pNum), 1) = "2" Then
            'PUB_Num2Id = "Y" & Mid(Trim(pNum), 2, Len(Trim(pNum)) - 1)
         'End If
         strNum = Trim(Abs(pNum))
         If pNum > 0 Then
            PUB_Num2Id = "X" & Mid(strNum, 2, Len(strNum) - 5) & Format(Hex(Right(strNum, 4)), "000")
         Else
            PUB_Num2Id = "Y" & Mid(strNum, 2, Len(strNum) - 5) & Format(Hex(Right(strNum, 4)), "000")
         End If
         'end 2016/9/8
         PUB_Num2Id = Left(PUB_Num2Id & "000000000", 9)
   End Select
End Function


'iFile:0=每日,1=每月
Function WLog(oStrLog As String, Optional iFile As Integer = 0)
Dim ffa As Integer
ffa = FreeFile
'Add By Sindy 2017/12/19 有錯誤訊息加？增加辨識度
If Left(oStrLog, 2) <> "開始" And Left(oStrLog, 2) <> "完畢" And _
   InStr(oStrLog, "完成") = 0 And InStr(oStrLog, "結束") = 0 And _
   Left(oStrLog, 2) <> "更新" And InStr(oStrLog, "成功") = 0 And _
   Left(oStrLog, 2) <> "語法" Then
   'Modify By Sindy 2024/8/7 增加更明顯的辨識度
   oStrLog = oStrLog & "？？？？？？？？？？" & vbCrLf & vbCrLf & _
                       "？？？？？？？？？？" & vbCrLf & _
                       "   <********** 注意程式是否有出錯!!!  **********>" & vbCrLf & _
                       "？？？？？？？？？？" & vbCrLf & vbCrLf
   '2024/8/7 END
End If
'2017/12/19 END
'Add by Morgan 2008/6/2
If iFile = 1 Then
   Open App.path & "\autobatchlog.log" For Append As ffa
Else
'end 2008/6/2
   Open App.path & "\autobatchdaylog.log" For Append As ffa
End If
Print #ffa, Trim(Now) & "  ==>  " & oStrLog
Close ffa
End Function

'Modify By Sindy 2011/9/14 mdiMain->forms(0)
'將From移至畫面之中心
'加 pbMdiCenter:指定移到Mid畫面的中央 Added by Morgan 2011/12/14
Public Sub MoveFormToCenter(ByRef frmTemp As Form, Optional pbMdiCenter As Boolean)
Dim intX  As Integer, intY As Integer

If frmTemp.MDIChild Or pbMdiCenter Then
   intX = (Forms(0).ScaleWidth - frmTemp.Width) / 2
   intY = (Forms(0).ScaleHeight - frmTemp.Height) / 2
   
   'Added by Morgan 2019/4/12
   '若不是子表單時還要加上主表單的座標
   If Not frmTemp.MDIChild Then
      intX = intX + Forms(0).Left
      intY = intY + Forms(0).Top
   End If
   'end 2019/4/12
   
   'If frmTemp.Height > 6110 Then
   '   intX = 0
   '   intY = 0
   'Else
   '   intX = (forms(0).ScaleWidth - frmTemp.Width) / 2
   '   intY = (forms(0).ScaleHeight - frmTemp.Height) / 2
   'End If
   If Forms(0).Width < 10000 And Forms(0).Height < 7000 Then
      ' 有垂直捲軸
      If frmTemp.Height > 6110 Then
         intY = 0
         If frmTemp.Width > 9200 Then
            intX = 0
         Else
            intX = (Forms(0).ScaleWidth - frmTemp.Width) / 2
         End If
      Else
         intX = (Forms(0).ScaleWidth - frmTemp.Width) / 2
         intY = (Forms(0).ScaleHeight - frmTemp.Height) / 2
      End If
   End If
Else
   intX = (Screen.Width - frmTemp.Width) / 2
   intY = (Screen.Height - frmTemp.Height) / 2
End If

'Add by Morgan 2011/9/26 座標加控制不為負數，因為有發生超出主畫面且垂直捲軸沒作用情形。
If intX < 0 Then intX = 0
If intY < 0 Then intY = 0
'end 2011/9/26

frmTemp.Move intX, intY
End Sub

'2011/10/5 ADD BY SONIA 抓下一程序的相關案件性質
Public Function PUB_GetNextCasePropertyName(strNP01 As String, strNP22 As String, strLang As String) As String
'strLang : 1中文 2英文 3日文
Dim StrSQLa As String, StrSqlB As String
Dim rsA As New ADODB.Recordset
Dim rsB As New ADODB.Recordset
Dim intR As Integer
Dim strCP30 As String

PUB_GetNextCasePropertyName = ""

   'Modified by Lydia 2024/01/17 防止語法出錯; strNP22=> Val(strNP22)
   StrSQLa = "select np02,np07 from nextprogress where np01='" & strNP01 & "' and np22='" & Val(strNP22) & "' "

   intR = 1
   Set rsA = ClsLawReadRstMsg(intR, StrSQLa)
   If intR = 1 Then
      StrSQLa = "": StrSqlB = ""
      With rsA
         '依系統別分類
         Select Case .Fields("np02")
            Case "CFP", "FCP", "P"
               Select Case .Fields("np07")
                  Case "411", "995", "996", "997", "998"
                     StrSQLa = "Select Decode(PA09,'000',CPM03,CPM04), CPM10, CPM13 From CaseProgress, Patent, CasePropertyMap Where CP01=PA01 And CP02=PA02 And CP03=PA03 And CP04=PA04 And CP01=CPM01 And CP10=CPM02 And CP09='" & strNP01 & "'"
               End Select
               
            Case "PS", "FG", "CPS"
               Select Case .Fields("np07")
                  Case "411", "995", "996", "997", "998"
                     StrSQLa = "Select Decode(sp09,'000',CPM03,CPM04), CPM10, CPM13 From CaseProgress, servicepractice, CasePropertyMap Where CP01=sp01 And CP02=sp02 And CP03=sp03 And CP04=sp04 And CP01=CPM01 And CP10=CPM02 And CP09='" & strNP01 & "'"
               End Select

            Case "CFT", "FCT", "T", "TF"
               Select Case .Fields("np07")
                  Case "305", "997", "998"
                     StrSQLa = "Select Decode(TM10,'000',CPM03,CPM04), CPM10, CPM13 From CaseProgress, Trademark, CasePropertyMap Where CP01=TM01 And CP02=TM02 And CP03=TM03 And CP04=TM04 And CP01=CPM01 And CP10=CPM02 And CP09='" & strNP01 & "'"
               End Select
            
            Case "CFC", "S", "TB", "TC", "TD", "TF", "TM", "TR", "TS", "TT"
               Select Case .Fields("np07")
                  Case "305", "997", "998"
                     StrSQLa = "Select Decode(sp09,'000',CPM03,CPM04), CPM10, CPM13 From CaseProgress, servicepractice, CasePropertyMap Where CP01=sp01 And CP02=sp02 And CP03=sp03 And CP04=sp04 And CP01=CPM01 And CP10=CPM02 And CP09='" & strNP01 & "'"
               End Select
               
            'modify by sonia 2019/7/31 +ACS系統類別
            Case "L", "FCL", "CFL", "LIN", "ACS"
               Select Case .Fields("np07")
                  Case "6001"
                     StrSQLa = "Select Decode(lc15,'000',CPM03,CPM04), CPM10, CPM13 From CaseProgress, lawcase, CasePropertyMap Where CP01=lc01 And CP02=lc02 And CP03=lc03 And CP04=lc04 And CP01=CPM01 And CP10=CPM02 And CP09='" & strNP01 & "'"
               End Select
               
            Case "LA"
               Select Case .Fields("np07")
                  Case "6001"
                     StrSQLa = "Select CPM03, CPM10, CPM13 From CaseProgress, hirecase, CasePropertyMap Where CP01=hc01 And CP02=hc02 And CP03=hc03 And CP04=hc04 And CP01=CPM01 And CP10=CPM02 And CP09='" & strNP01 & "'"
               End Select
               
         End Select
      End With
      
      If StrSQLa <> "" Then
         intR = 1
         Set rsB = ClsLawReadRstMsg(intR, StrSQLa)
         If intR <> 1 Then
            If StrSqlB <> "" Then
               intR = 1
               Set rsB = ClsLawReadRstMsg(intR, StrSqlB)
            End If
         End If
         If intR = 1 Then
            Select Case strLang
                Case "1" '中文
                    PUB_GetNextCasePropertyName = "-" & rsB.Fields(0).Value
                Case "2" '英文
                    PUB_GetNextCasePropertyName = "-" & rsB.Fields(1).Value
                Case "3" '日文
                    PUB_GetNextCasePropertyName = "-" & rsB.Fields(2).Value
            End Select
         End If
      End If
   End If
End Function
'2011/10/5 end

'2011/10/28 ADD BY SONIA 自frm040330結餘單抽出來共用
'判斷新案還是舊案 2011/3/10 自PrintByOne及PrintByOneOld抽出共用
Public Function Judgecase(oCP01 As String, oCP02 As String) As Boolean
   
   Judgecase = True
   Select Case UCase(oCP01)
      Case "CFP"
         If Val(oCP02) >= 12986 Then
            Judgecase = False
         End If
      Case "CPS"
         If Val(oCP02) >= 1 Then
            Judgecase = False
         End If
      Case "P"
         If Val(oCP02) >= 63583 Then
            Judgecase = False
         End If
      Case "PS"
         If Val(oCP02) >= 14 Then
            Judgecase = False
         End If
      Case "CFT"
         If Val(oCP02) >= 8295 Then
            Judgecase = False
         End If
      Case "S"
         If Val(oCP02) >= 1 Then
            Judgecase = False
         End If
      Case "CFC"
         If Val(oCP02) >= 683 Then
            Judgecase = False
         End If
      Case "CFL"
         If Val(oCP02) >= 10408 Then
            Judgecase = False
         End If
      Case "T"
         If Val(oCP02) >= 126722 Then
            Judgecase = False
         End If
      Case "TF"
         If Val(oCP02) >= 450 Then
            Judgecase = False
         End If
      Case "TC"
         If Val(oCP02) >= 10025 Then
            Judgecase = False
         End If
     Case "TB"
         If Val(oCP02) >= 115 Then
            Judgecase = False
         End If
      Case "TD"
         If Val(oCP02) >= 130 Then
            Judgecase = False
         End If
      Case "TM"
         If Val(oCP02) >= 25 Then
            Judgecase = False
         End If
      Case "TR"
         If Val(oCP02) >= 64 Then
            Judgecase = False
         End If
      Case "TT"
         If Val(oCP02) >= 7 Then
            Judgecase = False
         End If
      Case "TS"
         If Val(oCP02) >= 26 Then
            Judgecase = False
         End If
      Case Else
         Judgecase = False
   End Select
End Function
'2011/10/28 END

'Added by Morgan 2011/11/25 視窗原為最大化,改指定大小及位置以方便其他應用程式操作
Public Sub PUB_InitFormPos(ByRef oForm As Form)
   Dim iWidth As Long, iHeight As Long
   
   If oForm.Visible = False Then Exit Sub
   
On Error GoTo NormalControl
   
   '若最大化大於 800*600 才指定,否則原來就是 800*600 解析度的電腦的工作列會遮到程式下緣而導致若有水平拉把的畫面會無法操作
   If oForm.WindowState <> 2 Then oForm.WindowState = 2
'Modified by Morgan 2023/5/31 統一指定 1280(W),1024(H)--經理
'   If oForm.Width > 800 * Screen.TwipsPerPixelX And oForm.Height > 600 * Screen.TwipsPerPixelY Then
'      'Modified by Morgan 2015/4/23
'      '繪圖進度維護畫面較大
'      'Modified by Morgan 2015/11/17 再放大到1280x1024
'      'If Pub_StrUserSt03 = "P13" And oForm.Width >= 1024 * Screen.TwipsPerPixelX And oForm.Height >= 768 * Screen.TwipsPerPixelY Then
'      If Pub_StrUserSt03 = "P13" And oForm.Width >= 1280 * Screen.TwipsPerPixelX And oForm.Height >= 1024 * Screen.TwipsPerPixelY Then
'         iWidth = 1280
'         iHeight = 1024
'
'      'Added by Morgan 2016/2/18
'      '專利處工程師放大到 1024*600
'      ElseIf Pub_StrUserSt03 = "P11" And oForm.Width >= 1024 * Screen.TwipsPerPixelX Then
'         iWidth = 1024
'         iHeight = 600
'      'end 2016/2/18
'
'      Else
'         iWidth = 800
'         iHeight = 600
'      End If
'      'end 2015/4/23
   If oForm.Width >= 1280 * Screen.TwipsPerPixelX And oForm.Height >= 1024 * Screen.TwipsPerPixelY Then
      iWidth = 1280
      iHeight = 1024
'end 2023/5/31
      oForm.WindowState = 0
   End If
   
NormalControl:
   If oForm.WindowState = 0 Then '以防沒有設定成功會發生錯誤
      oForm.Width = iWidth * Screen.TwipsPerPixelX
      oForm.Height = iHeight * Screen.TwipsPerPixelY
      oForm.Top = 0
      oForm.Left = 0
   End If
End Sub

'Add By Sindy 2012/2/20 檢查案件性質是否有728轉案至他所,若有本所期限前面加※符號
Public Function PUB_GetCP10ValueAttachText(strKey As String, strCP10 As String, strSymbol As String, strText As String) As String
Dim stSQL As String
Dim iR As Integer
Dim RsAdo As ADODB.Recordset
   
   PUB_GetCP10ValueAttachText = strText
   
   If UCase(Left(strKey, 1)) = "N" Then
      strKey = Right(strKey, Len(strKey) - 1)
   End If
   
   stSQL = "select count(*) from caseprogress " & _
           "where cp01='" & SystemNumber(strKey, 1) & "' and cp02='" & SystemNumber(strKey, 2) & "' and cp03='" & SystemNumber(strKey, 3) & "' and cp04='" & SystemNumber(strKey, 4) & "' " & _
           "and cp10='" & strCP10 & "' "
   iR = 1
   Set RsAdo = ClsLawReadRstMsg(iR, stSQL)
   If iR = 1 Then
      If RsAdo.Fields(0) > 0 Then
         PUB_GetCP10ValueAttachText = strSymbol & Trim(strText)
      End If
   End If
   Set RsAdo = Nothing
End Function

'Add By Sindy 2012/3/1
Public Sub CallFormData(frmName As Form, strFrmNm As String, strCP01 As String, strCP02 As String, strCP03 As String, strCP04 As String)
Dim frm As Form
   
   '檢查維護畫面若已經開啟，將警告
   For Each frm In Forms
      If frm.Name = strFrmNm Then
         '一律關閉原視窗,否則若為修改狀態又選擇取消時會存錯資料
         If frmName.m_EditMode = 1 Or frmName.m_EditMode = 2 Then
             frmName.SetFocus
             MsgBox "基本資料維護畫面即將更新，未完成之作業將要取消，請另行操作！"
         End If
         Unload frmName
         Exit For
      End If
   Next
   '設定滑鼠游標為等待狀態
   Screen.MousePointer = vbHourglass
   '顯示基本資料維護的畫面
   frmName.SetCurrKey strCP01, strCP02, strCP03, strCP04
   frmName.Show
   '設定滑鼠游標為預設
   Screen.MousePointer = vbDefault
End Sub

'Add By Sindy 2012/4/5 CFT,FCT所有案件性質發文時, 檢查代表圖是否存在
'Modify by Amy 2018/08/03 改成ChkImgByteFile 此不使用
'Public Function ChkIsExistImg(strKey1 As String, strKey2 As String, strKey3 As String, strKey4 As String, Optional bolShowMsg As Boolean = True) As Boolean
'   ChkIsExistImg = False
'   strSql = "select ibf01||ibf02||ibf03||ibf04 from imgbytefile where ibf01='" & strKey1 & "' and ibf02='" & strKey2 & "' and ibf03='" & strKey3 & "' and ibf04='" & strKey4 & "' and ibf05='1'"
'   intI = 1
'   Set RsTemp = ClsLawReadRstMsg(intI, strSql)
'   If intI = 1 Then
'      ChkIsExistImg = True
'   End If
'   If ChkIsExistImg = False And bolShowMsg = True Then
'      If strKey1 = "CFT" Then
'         MsgBox "本案尚未放代表圖至系統！"
'      End If
'   End If
'End Function

'Added by Morgan 2012/4/13
'開啟選檔視窗
'Modify By Sindy 2021/7/16 改為用 Object 型態
'Public Sub PUB_OpenDialog4List(pListBox As ListBox)
Public Sub PUB_OpenDialog4List(pListBox As Object)
   Dim stFileName As String
   Dim sFile
   Dim ii As Integer
   Dim fs, f, s

On Error GoTo ErrHnd
   
   stFileName = "*.*"
   With Forms(0).CommonDialog1
      .CancelError = True
      .FileName = stFileName
      .Filter = "All Files (*.*)|*.*"
      .InitDir = PUB_Getdesktop
      .MaxFileSize = 3000
      .Flags = cdlOFNHideReadOnly Or cdlOFNPathMustExist Or cdlOFNAllowMultiselect Or cdlOFNExplorer Or cdlOFNNoDereferenceLinks
      .ShowOpen
      If .FileName <> "" Then
         If InStr(.FileName, ChrW$(0)) > 0 Then
            sFile = Split(.FileName, ChrW$(0))
            For ii = 1 To UBound(sFile)
               If InStr(sFile(ii), "\") > 0 Then
                  stFileName = sFile(ii)
               Else
                  stFileName = sFile(0) & "\" & sFile(ii)
               End If
               Set fs = CreateObject("Scripting.FileSystemObject")
               Set f = fs.GetFile(stFileName)
               PUB_AddListX pListBox, stFileName & " (" & -1 * Int(-1 * f.Size / 1024) & " KB)"
            Next
         Else
            stFileName = .FileName
            Set fs = CreateObject("Scripting.FileSystemObject")
            Set f = fs.GetFile(stFileName)
            PUB_AddListX pListBox, stFileName & " (" & -1 * Int(-1 * f.Size / 1024) & " KB)"
         End If
      End If
   End With
   Exit Sub
ErrHnd:
   If Err.Number <> 32755 Then
      MsgBox Err.Description
   End If
End Sub

'Added by Morgan 2012/4/13
'上傳附件檔
'Modify By Sindy 2021/7/16 改為用 Object 型態
'Public Function PUB_UploadAtt(ByVal pFolder As String, ByVal pKey As String, pListBox As ListBox, Optional pErrNo As Integer, Optional pErrMsg As String, Optional oWinSock As Winsock) As Boolean
Public Function PUB_UploadAtt(ByVal pFolder As String, ByVal pKey As String, pListBox As Object, Optional pErrNo As Integer, Optional pErrMsg As String, Optional oWinSock As Winsock) As Boolean
   Dim hOpen As Long
   Dim hConnection As Long
   Dim hDir As Long
   Dim bReturn As Boolean
   Dim dwInternetFlags As Integer
   Dim stRemoteFile As String
   Dim stLocalFile As String
   Dim stItem As String
   Dim idx As Integer
   Dim iPos As Integer
   Dim IsTimeOut As Boolean
   Dim SeekTimer
   Dim ACT_FTP_IP As String
   Dim arrIP
   Dim ii As Integer
   
   If oWinSock Is Nothing Then
      Set oWinSock = Forms(0).Winsock1
   End If
   
   pErrNo = 0
   pErrMsg = ""
   
   If pListBox.ListCount > 0 Then
      For idx = 0 To pListBox.ListCount - 1
         stItem = pListBox.List(idx)
         iPos = InStr(stItem, "\")
         If iPos > 0 Then
            If InStrRev(stItem, " (") > 0 Then
               'Add By Sindy 2021/8/6 排除 C:\Program Files (x86) 狀況
               If UCase(Mid(stItem, InStrRev(stItem, " (") + 1, Len("(X86)"))) <> "(X86)" Then
               '2021/8/6 END
                  stItem = Left(stItem, InStrRev(stItem, " (") - 1)
               End If
'            Else
'               stLocalFile = stItem
            End If
            stLocalFile = stItem
            stRemoteFile = Mid(stLocalFile, InStrRev(stLocalFile, "\") + 1)
            
            If hOpen = 0 Then
               hOpen = InternetOpen("Taie FTP", INTERNET_OPEN_TYPE_DIRECT, vbNullString, vbNullString, 0)
               If hOpen = 0 Then
                  pErrNo = 1
                  pErrMsg = "網路錯誤！"
                  GoTo OutPort
               Else
                  IsTimeOut = True
                  If GOOD_FTP_IP <> "" Then
                     arrIP = Split(GOOD_FTP_IP & ";" & FTP_IP, ";")
                  Else
                     arrIP = Split(FTP_IP, ";")
                  End If
                  For ii = LBound(arrIP) To UBound(arrIP)
                     ACT_FTP_IP = arrIP(ii)
                     If ACT_FTP_IP <> "" Then
                        '偵測 FTPServer 是否存在
                        If oWinSock.State Then oWinSock.Close
                        oWinSock.Connect ACT_FTP_IP, 21
                        IsTimeOut = False
                        SeekTimer = Timer
                        Do While oWinSock.State = 6 And IsTimeOut = False
                           DoEvents
                           If Timer - SeekTimer > 1 Then
                              IsTimeOut = True
                           End If
                        Loop
                        If oWinSock.State Then oWinSock.Close
                        If IsTimeOut = False Then
                           Exit For
                        End If
                     End If
                  Next
                  
                  '若是超過時間
                  If IsTimeOut = True Then
                     pErrNo = 2
                     pErrMsg = "無法與FTP Server建立連線！(PUB_UploadAtt: IsTimeOut = True)"
                     GoTo OutPort
                  Else
                     GOOD_FTP_IP = ACT_FTP_IP
                  End If
               
                  hConnection = InternetConnect(hOpen, ACT_FTP_IP, FTP_Port, _
                     "pgmid", "pgmpwd", INTERNET_SERVICE_FTP, INTERNET_FLAG_PASSIVE, 0)
                  If hConnection = 0 Then
                     pErrNo = 3
                     pErrMsg = "無法與FTP Server建立連線！(PUB_UploadAtt: hConnection = 0)"
                     GoTo OutPort
                  ElseIf FtpSetCurrentDirectory(hConnection, pFolder) = False Then
                     pErrNo = 4
                     pErrMsg = "切換至" & pFolder & "目錄失敗！"
                     GoTo OutPort
                  ElseIf FtpSetCurrentDirectory(hConnection, pKey) = False Then
                     hDir = FtpCreateDirectory(hConnection, pKey)
                     If hDir = 0 Then
                        pErrNo = 5
                        pErrMsg = "建立" & pKey & "目錄失敗！"
                        GoTo OutPort
                     ElseIf FtpSetCurrentDirectory(hConnection, pKey) = False Then
                        pErrNo = 6
                        pErrMsg = "切換至" & pKey & "目錄失敗！"
                        GoTo OutPort
                     End If
                  End If
               End If
            End If

            dwInternetFlags = FTP_TRANSFER_TYPE_BINARY
            bReturn = FtpPutFile(hConnection, stLocalFile, stRemoteFile, dwInternetFlags, 0)
            ' Upload successfully
            If bReturn = False Then
               pErrNo = 7
               pErrMsg = "檔案上傳失敗！"
               GoTo OutPort
            End If
         End If
      Next
   End If
   PUB_UploadAtt = True
   
OutPort:
   If hOpen <> 0 Then InternetCloseHandle (hOpen)
   If hConnection <> 0 Then InternetCloseHandle (hConnection)
   If oWinSock.State Then oWinSock.Close
End Function
'Added by Morgan 2012/4/13
'刪除 FTP 檔案
Public Function PUB_RemoveAtt(ByVal pFolder As String, ByVal pKey As String, pFiles As String, Optional iErrNo As Integer, Optional stErrMsg As String, Optional oWinSock As Winsock) As Boolean
   Dim hOpen As Long
   Dim hConnection As Long
   Dim bReturn As Boolean
   Dim IsTimeOut As Boolean
   Dim SeekTimer
   Dim ACT_FTP_IP As String
   Dim arrIP
   Dim ii As Integer, jj As Integer
   Dim arrFile
   Dim stRemoteFile As String
   
   If oWinSock Is Nothing Then
      Set oWinSock = Forms(0).Winsock1
   End If
   
   iErrNo = 0
   stErrMsg = ""
   
   arrFile = Split(pFiles, ",")
   For jj = LBound(arrFile) To UBound(arrFile)
      If arrFile(jj) <> "" Then
         If hOpen = 0 Then
            hOpen = InternetOpen("Taie FTP", INTERNET_OPEN_TYPE_DIRECT, vbNullString, vbNullString, 0)
            If hOpen = 0 Then
               iErrNo = 1
               stErrMsg = "網路錯誤！"
               GoTo OutPort
            Else
               IsTimeOut = True
               If GOOD_FTP_IP <> "" Then
                  arrIP = Split(GOOD_FTP_IP & ";" & FTP_IP, ";")
               Else
                  arrIP = Split(FTP_IP, ";")
               End If
               For ii = LBound(arrIP) To UBound(arrIP)
                  ACT_FTP_IP = arrIP(ii)
                  If ACT_FTP_IP <> "" Then
                     '偵測 FTPServer 是否存在
                     If oWinSock.State Then oWinSock.Close
                     oWinSock.Connect ACT_FTP_IP, 21
                     IsTimeOut = False
                     SeekTimer = Timer
                     Do While oWinSock.State = 6 And IsTimeOut = False
                        DoEvents
                        If Timer - SeekTimer > 1 Then
                           IsTimeOut = True
                        End If
                     Loop
                     If oWinSock.State Then oWinSock.Close
                     If IsTimeOut = False Then
                        Exit For
                     End If
                  End If
               Next
               
               '若是超過時間
               If IsTimeOut = True Then
                  iErrNo = 2
                  stErrMsg = "無法與FTP Server建立連線！(PUB_RemoveAtt: IsTimeOut = True)"
                  GoTo OutPort
               Else
                  GOOD_FTP_IP = ACT_FTP_IP
               End If
               
               hConnection = InternetConnect(hOpen, ACT_FTP_IP, FTP_Port, _
                  "pgmid", "pgmpwd", INTERNET_SERVICE_FTP, INTERNET_FLAG_PASSIVE, 0)
               If hConnection = 0 Then
                  iErrNo = 3
                  stErrMsg = "無法與FTP Server建立連線！(PUB_RemoveAtt: hConnection = 0)"
                  GoTo OutPort
               ElseIf FtpSetCurrentDirectory(hConnection, pFolder) = False Then
                  iErrNo = 4
                  stErrMsg = "切換至 " & pFolder & " 失敗！"
                  GoTo OutPort
               ElseIf FtpSetCurrentDirectory(hConnection, pKey) = False Then
                  '無法切換時當作已刪除
                  Exit For
               End If
            End If
         End If
         If InStrRev(arrFile(jj), " (") > 0 Then
            'Add By Sindy 2021/8/6 排除 C:\Program Files (x86) 狀況
            If UCase(Mid(arrFile(jj), InStrRev(arrFile(jj), " (") + 1, Len("(X86)"))) <> "(X86)" Then
            '2021/8/6 END
               arrFile(jj) = Left(arrFile(jj), InStrRev(arrFile(jj), " (") - 1)
            End If
'         Else
'            stRemoteFile = arrFile(jj)
         End If
         stRemoteFile = arrFile(jj)
         '刪除檔案不控制成功與否
         bReturn = FtpDeleteFile(hConnection, stRemoteFile)
      End If
   Next

   PUB_RemoveAtt = True
   
OutPort:
   If hOpen <> 0 Then InternetCloseHandle (hOpen)
   If hConnection <> 0 Then InternetCloseHandle (hConnection)
   If oWinSock.State Then oWinSock.Close
End Function
'Added by Morgan 2012/4/13
'新增檔案至清單
'Modify By Sindy 2021/7/16 改為用 Object 型態
'Public Function PUB_AddListX(oList As ListBox, stNewItem As String) As Boolean
Public Function PUB_AddListX(oList As Object, stNewItem As String) As Boolean
   Dim idx As Integer, bFound As Boolean, stFileName As String, stNewFileName As String
   If InStr(stNewItem, ",") > 0 Then
      MsgBox "逗號[,]為系統保留字，請重新命名！", vbExclamation
      Exit Function
   End If
   If stNewItem <> "" Then
      For idx = 0 To oList.ListCount - 1
         stFileName = Mid(oList.List(idx), InStrRev(oList.List(idx), "\") + 1)
         stNewFileName = Mid(stNewItem, InStrRev(stNewItem, "\") + 1)
         If stNewFileName = stFileName Then
            MsgBox "附件[ " & stFileName & " ]已存在！"
            PUB_AddListX = False
            bFound = True
            Exit For
         End If
      Next
      If bFound = False Then
         oList.AddItem stNewItem, oList.ListCount
         oList.ListIndex = oList.ListCount - 1
         PUB_AddListX = True
      End If
   End If
End Function
'Added by Morgan 2012/4/13
'移除清單項目
'Modify By Sindy 2021/7/16 改為用 Object 型態
'Public Function PUB_RemoveList(oList As ListBox) As Boolean
Public Function PUB_RemoveList(oList As Object) As Boolean
   Dim ii As Integer
   If oList.ListCount > 0 Then
      ii = 0
      Do While ii < oList.ListCount
         If oList.Selected(ii) = True Then
            PUB_RemoveList = True
            oList.RemoveItem ii
            ii = ii - 1
         End If
         ii = ii + 1
      Loop
   End If
End Function
'Added by Morgan 2012/4/13
'組附件字串(以逗號分隔)
'Modify By Sindy 2021/7/16 改為用 Object 型態
'Public Function PUB_ComposeAttList(oList As ListBox) As String
Public Function PUB_ComposeAttList(oList As Object) As String
   Dim stRtn As String, idx As Integer
   If oList.ListCount > 0 Then
      stRtn = Mid(oList.List(0), InStrRev(oList.List(0), "\") + 1)
      For idx = 1 To oList.ListCount - 1
         stRtn = stRtn & "," & Mid(oList.List(idx), InStrRev(oList.List(idx), "\") + 1)
      Next
   End If
   PUB_ComposeAttList = stRtn
End Function

'Add By Sindy 2012/4/16 列印帳款未結清案件資料
Public Function GetPrintCaseCheck(strCP09 As String)
Dim A1kData As String
Dim iLine As Integer
Dim strTemp As Variant
Dim oII As Integer
Dim Rs As ADODB.Recordset
Dim strTmp As String, intA As Integer 'Added by Lydia 2024/05/15

   strTmp = "select * from caseprogress,trademark,CUSTOMER " & _
            "where cp09='" & strCP09 & "' " & _
            "and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+) " & _
            "and CU01=SUBSTR(TM23,1,8) AND CU02=SUBSTR(TM23,9,1) "
   intA = 1
   Set Rs = ClsLawReadRstMsg(intA, strTmp)
   If intA = 1 Then
      'If Left(Trim(rs.Fields("cp12")), 1) <> "F" And rs.Fields("tm10") = "000" And rs.Fields("CU10") <> "000" Then
         '欠款資料
         A1kData = GetT_020_a1k_data(Rs.Fields("tm01"), Rs.Fields("tm02"), Rs.Fields("tm03"), Rs.Fields("tm04"))
         If A1kData <> "" Then
            A1kData = "本案欠款資料" & A1kData
            Printer.PaperSize = 9 'Add By Sindy 2020/6/20
            Printer.Orientation = 1 '1.直印 2.橫印
            Printer.FontName = "細明體"
            Printer.Font.Size = 14
            iLine = 2 '1
            Printer.CurrentX = 500
            Printer.CurrentY = 300 * iLine
            Printer.Print "本所案號：" & Rs.Fields("tm01") & "-" & Rs.Fields("tm02") & "-" & Rs.Fields("tm03") & "-" & Rs.Fields("tm04") & "　　　智權人員：" & GetPrjSalesNM(Rs.Fields("cp13")) & "　　　列印日期：" & ChangeTStringToTDateString(strSrvDate(2))
            iLine = iLine + 2
            Printer.CurrentX = 500
            Printer.CurrentY = 300 * iLine
            Printer.Print "案件名稱：" & "" & Rs.Fields("tm05")
            iLine = iLine + 2
            Printer.CurrentX = 500
            Printer.CurrentY = 300 * iLine
            Printer.Print "代 理 人：" & GetPrjName1("" & Rs.Fields("tm44"))
            iLine = iLine + 2
            Printer.CurrentX = 500
            Printer.CurrentY = 300 * iLine
            Printer.Print "申 請 人：" & GetPrjPeople1("" & Rs.Fields("tm23"), "1")
            iLine = iLine + 2
            strTemp = Split(A1kData, "、")
            For oII = 0 To UBound(strTemp)
               Printer.CurrentX = 500
               Printer.CurrentY = 300 * iLine
               If oII = 0 Then
                  Printer.Print strTemp(oII)
               Else
                  Printer.Print "　　　　　　" & strTemp(oII)
               End If
               iLine = iLine + 1
            Next oII
            iLine = iLine + 1
            Printer.EndDoc
         End If
      'End If
   End If
   
   Set Rs = Nothing 'Added by Lydia 2024/05/15
   
End Function

'Add By Sindy 2012/4/19 商標卷宗性質/事件
Public Function GetCaseType3(strTM01 As String, strTM02 As String, strTM03 As String, strTM04 As String, strCP09 As String) As String
Dim strTM10 As String
Dim strTmp As String, intA As Integer, rsAD As New ADODB.Recordset  'Added by Lydia 2024/05/14

   strTM10 = ""
   GetCaseType3 = ""
   Select Case strTM01
      Case "T", "TF", "CFT", "FCT"
         strTmp = "SELECT * FROM trademark WHERE TM01='" & strTM01 & "' and TM02='" & strTM02 & "' and TM03='" & strTM03 & "' and TM04='" & strTM04 & "'"
         intA = 1
         Set rsAD = ClsLawReadRstMsg(intA, strTmp)
         If intA = 1 Then
            strTM10 = rsAD.Fields("TM10")
            Select Case rsAD.Fields("TM28")
               Case "1"
                  If "" & rsAD.Fields("TM21") = "" Then
                     If strTM01 = "CFT" Then
                        GetCaseType3 = "申請"
                     Else
                        GetCaseType3 = "註冊申請"
                     End If
                  Else
                     GetCaseType3 = "註冊"
                  End If
               Case "2"
                  GetCaseType3 = "異議"
               Case "3"
                  If strTM10 = "000" Then
                     GetCaseType3 = "評定"
                  Else
                     GetCaseType3 = "裁定"
                  End If
               Case "4"
                  If strTM10 = "000" Then
                     GetCaseType3 = "廢止"
                  Else
                     GetCaseType3 = "撤銷"
                  End If
            End Select
         End If
         strTmp = "SELECT * FROM caseprogress WHERE CP09='" & strCP09 & "'"
         intA = 1
         Set rsAD = ClsLawReadRstMsg(intA, strTmp)
         If intA = 1 Then
            Select Case rsAD.Fields("CP10")
               Case "1601"
                  GetCaseType3 = "異議"
               Case "1602"
                  GetCaseType3 = "異議"
               Case "1603"
                  If strTM10 = "000" Then
                     GetCaseType3 = "評定"
                  Else
                     GetCaseType3 = "裁定"
                  End If
               Case "1604"
                  If strTM10 = "000" Then
                     GetCaseType3 = "評定"
                  Else
                     GetCaseType3 = "裁定"
                  End If
               'modify by sonia 2017/9/6 +1619
               Case "1605", "1619"
                  If strTM10 = "000" Then
                     GetCaseType3 = "廢止"
                  Else
                     GetCaseType3 = "撤銷"
                  End If
               'modify by sonia 2017/9/6 +1620
               Case "1606", "1620"
                  If strTM10 = "000" Then
                     GetCaseType3 = "廢止"
                  Else
                     GetCaseType3 = "撤銷"
                  End If
               Case "602"
                  GetCaseType3 = "異議"
               Case "604"
                  If strTM10 = "000" Then
                     GetCaseType3 = "評定"
                  Else
                     GetCaseType3 = "裁定"
                  End If
               'modify by sonia 2017/9/6 +624
               Case "606", "624"
                  If strTM10 = "000" Then
                     GetCaseType3 = "廢止"
                  Else
                     GetCaseType3 = "撤銷"
                  End If
            End Select
         End If
   End Select
   
   Set rsAD = Nothing 'Added by Lydia 2024/05/14
End Function

'Add By Sindy 2012/5/4
'讀取延期月數
Public Function GetDelayMonth(m_CP43 As String) As String
Dim strTmp As String, intA As Integer, rsAD As New ADODB.Recordset  'Added by Lydia 2024/05/14

   GetDelayMonth = ""
   strTmp = ""
   If Trim(m_CP43) <> "" Then
      If Left(Trim(m_CP43), 1) = "C" Then
          strTmp = "SELECT CP134 FROM CaseProgress WHERE CP09='" & Trim(m_CP43) & "'"
      Else
          strTmp = "SELECT CP134 FROM CaseProgress WHERE CP09=(SELECT CP43 FROM CaseProgress WHERE CP09='" & Trim(m_CP43) & "')"
      End If
      If strTmp <> "" Then
         intA = 1
         Set rsAD = ClsLawReadRstMsg(intA, strTmp)
         If intA = 1 Then
            If IsNull(rsAD.Fields(0)) = False Then
               GetDelayMonth = rsAD.Fields(0)
            End If
         End If
      End If
   End If
   Set rsAD = Nothing 'Added by Lydia 2024/05/14
End Function

'Add By Sindy 2012/5/16
'計算台灣商標爭議案件承辦期限
Public Function PUB_TMdebateCountCP48(strCP06 As String, strCP122 As String, strEP06 As String, strCP09 As String, strCP13 As String) As String
Dim bolDelay As Boolean
Dim Rs As ADODB.Recordset
Dim strST06 As String
Dim strTmp As String, intA As Integer  'Added by Lydia 2024/05/14

   bolDelay = False
   PUB_TMdebateCountCP48 = ""
   strCP06 = DBDATE(strCP06)
   strEP06 = DBDATE(strEP06)
   
   strTmp = "SELECT count(*) FROM tmctldate WHERE TCD01='" & Trim(strCP09) & "' and TCD02='3' and TCD07='延期發文'"
   intA = 1
   Set Rs = ClsLawReadRstMsg(intA, strTmp)
   If intA = 1 Then
      If Rs.Fields(0) > 0 Then
         bolDelay = True '已延期
      End If
   End If
   '智權人員所別
   strTmp = "SELECT st06 FROM staff WHERE st01='" & strCP13 & "'"
   intA = 1
   Set Rs = ClsLawReadRstMsg(intA, strTmp)
   If intA = 1 Then
      If Not IsNull(Rs.Fields("st06")) Then
         strST06 = Rs.Fields("st06")
      End If
   End If
   
   'Add By Sindy 2025/7/28 T案的727分析屬於爭議案(承辦期限的算法不同時其他爭議案件)
   '                       ,但FCT案727分析不屬於爭議案!
   strTmp = "SELECT cp01,cp10,cp06,cp09,tm10 FROM caseprogress,trademark" & _
            " WHERE cp09='" & Trim(strCP09) & "'" & _
            " AND cp01=tm01 AND cp02=tm02 AND cp03=tm03 AND cp04=tm04"
   intA = 1
   Set Rs = ClsLawReadRstMsg(intA, strTmp)
   If intA = 1 Then
      If Rs.Fields("cp01") = "T" And Rs.Fields("cp10") = "727" And Rs.Fields("tm10") = "000" Then
         '依工作天數計算承辦期限
         PUB_TMdebateCountCP48 = Pub_GetHandleDay(Rs.Fields("cp01"), "" & Rs.Fields("tm10"), Rs.Fields("cp10"), strSrvDate(1), "" & Rs.Fields("CP06"), "" & Rs.Fields("CP09"))
         GoTo RunExit
      End If
   End If
   '2025/7/28
   
   '本所期限在7個日曆天內到期 或 急件者，5個工作天計算；但若已延期則不考慮急件，其餘則7個工作天計算
   '承辦期限北所自齊備日之次日起算，分所自齊備日之次2日起算(遇假日順延)
   If ((Val(strCP06) > 0 And Val(strCP06) <= Val(CompDate(2, 7, strSrvDate(1)))) Or _
      strCP122 = "Y") And _
      bolDelay = False Then
      '急件為5個工作天
      'Modify By Sindy 2012/6/1 杜副總說取消
'      If strST06 = "1" Then
         PUB_TMdebateCountCP48 = CompWorkDay(6, strEP06, 0)
'      Else
'         PUB_TMdebateCountCP48 = CompWorkDay(7, strEP06, 0)
'      End If
   Else
      '承辦天數為7個工作天
      'Modify By Sindy 2012/6/1 杜副總說取消
'      If strST06 = "1" Then
         PUB_TMdebateCountCP48 = CompWorkDay(8, strEP06, 0)
'      Else
'         PUB_TMdebateCountCP48 = CompWorkDay(9, strEP06, 0)
'      End If
   End If
   
RunExit: 'Add By Sindy 2025/7/28 +
   
   '承辦期限若大於本所期限，則同於本所期限
   If Val(strCP06) > 0 Then
      If Val(PUB_TMdebateCountCP48) > Val(strCP06) Then
         PUB_TMdebateCountCP48 = strCP06
      End If
   End If
   
   Set Rs = Nothing 'Added by Lydia 2024/05/14
End Function

'Add By Sindy 2012/5/22 讀取案件進度資料
Public Function GetCaseProData(strCP09 As String, strColName As String) As String
Dim Rs As ADODB.Recordset
Dim strTmp As String, intA As Integer  'Added by Lydia 2024/05/14

   GetCaseProData = ""
   strTmp = "SELECT " & strColName & " FROM CaseProgress WHERE CP09='" & Trim(strCP09) & "'"
   intA = 1
   Set Rs = ClsLawReadRstMsg(intA, strTmp)
   If intA = 1 Then
      If IsNull(Rs.Fields(0)) = False Then
         GetCaseProData = Rs.Fields(0)
      End If
   End If
   Set Rs = Nothing 'Added by Lydia 2024/05/14
End Function

'2012/7/23 add by sonia 內商台灣案發文規費與收文規費不符時,發mail給智權人員
'modify by sonia 2013/7/2 加電子送件自動扣款參數
'Modified by Lydia 2022/05/23 +pStrMemo 內文加註: PT案(傳入收文號)取得法律案源之發文規費
'Modified by Morgan 2023/8/24 +pChk939 檢查同日發文的超頁費超項(實審)
Public Sub PUB_ChkOfficialFee(ByVal strCP09 As String, ByVal strCP84 As String, Optional strCP118 As String, Optional pStrMemo As String, Optional pChk939 As Boolean = False)
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset
Dim rsA2 As New ADODB.Recordset 'Add By Sindy 2021/6/16
Dim strCP60 As String 'add by sonia 2013/7/2
Dim strCP17 As String, m_Fee As String, m_Official As String 'Add by Sindy 2021/6/16
Dim m_StrTo As String, m_StrSub As String, m_StrCont As String 'Added by Lydia 2022/05/30 整理frm880005改用寄信模組
Dim str939CP16 As String, str939CP17 As String 'Added by Morgan 2023/8/24
Dim strToCC As String 'Add By Sindy 2025/5/23

   'add by sonia 2013/7/2 抓出該收文號之所有收據編號
   strCP60 = ""
   StrSQLa = "Select a0j13 From acc0j0 Where a0j01='" & strCP09 & "' "
   rsA.CursorLocation = adUseClient
   rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
   If rsA.RecordCount > 0 Then
      rsA.MoveFirst
      Do While Not rsA.EOF
         If strCP60 = "" Then
            strCP60 = rsA.Fields("a0j13")
         Else
            strCP60 = strCP60 & "," & rsA.Fields("a0j13")
         End If
         rsA.MoveNext
      Loop
   Else
      strCP60 = "尚未開立收據"
   End If
   If rsA.State <> adStateClosed Then rsA.Close
   '2013/7/2 end
   
   'Added by Morgan 2023/8/24
   If pChk939 Then
      '規費(不會有服務費可直接減銷帳金額)
      StrSQLa = "select sum(b.cp16) cp16, sum(b.cp17-nvl(b.cp77,0)) cp17 from caseprogress a,caseprogress b" & _
         " where a.cp09='" & strCP09 & "' and b.cp01(+)=a.cp01 and b.cp02(+)=a.cp02 and b.cp03(+)=a.cp03 and b.cp04(+)=a.cp04" & _
         " and b.cp27=a.cp27 and b.cp10 in ('938','939')"
      rsA.CursorLocation = adUseClient
      rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
      If rsA.RecordCount > 0 Then
         str939CP16 = Val("" & rsA("cp16"))
         str939CP17 = Val("" & rsA("cp17"))
      End If
      If rsA.State <> adStateClosed Then rsA.Close
      
      '收據
      StrSQLa = "select distinct a0j13,cpm03 from caseprogress a,caseprogress b,acc0j0,casepropertymap" & _
         " where a.cp09='" & strCP09 & "' and b.cp01(+)=a.cp01 and b.cp02(+)=a.cp02 and b.cp03(+)=a.cp03 and b.cp04(+)=a.cp04" & _
         " and b.cp27=a.cp27 and b.cp10 in ('938','939') and a0j01(+)=b.cp09 and cpm01(+)=b.cp01 and cpm02(+)=b.cp10"
      rsA.CursorLocation = adUseClient
      rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
      If rsA.RecordCount > 0 Then
         rsA.MoveFirst
         Do While Not rsA.EOF
            If IsNull(rsA.Fields(0)) Then
               strCP60 = strCP60 & IIf(strCP60 <> "", ",", "") & rsA("cpm03") & "尚未開立收據"
            ElseIf InStr(strCP60, rsA.Fields("a0j13")) = 0 Then
               strCP60 = strCP60 & IIf(strCP60 <> "", ",", "") & rsA.Fields("a0j13")
            End If
            rsA.MoveNext
         Loop
      End If
      If rsA.State <> adStateClosed Then rsA.Close
   End If
   'end 2023/8/24
   
   '2012/8/1 modify by sonia 扣除銷帳規費
   'Modify By Sindy 2021/6/16 + ,cp10,CP43
   'Modified by Morgan 2023/11/20 +Patent
   'StrSQLa = "Select cp01,cp02,cp03,cp04,cp13,cp16,cp17-sum(nvl(a1u09,0)) cp17,cp18,cp60,nvl(nvl(cu04,cu05),cu06) custname,tm05,cp10,CP43" & _
             " From CaseProgress,trademark,customer,acc1u0" & _
             " Where CP09='" & strCP09 & "'" & _
             " and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+)" & _
             " and substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+)" & _
             " and cp09=a1u03(+)" & _
             " group by cp84,cp09,cp01,cp02,cp03,cp04,cp13,cp16,cp17,cp18,cp60,nvl(nvl(cu04,cu05),cu06),tm05,cp10,CP43"
   'Modify By Sindy 2025/5/23 +,cp14
   'Modify By Sindy 2025/5/29 group by +,cp14
   StrSQLa = "Select cp01,cp02,cp03,cp04,cp13,cp14,cp16,cp17-sum(nvl(a1u09,0)) cp17,cp18,cp60,nvl(nvl(cu04,cu05),cu06) custname,nvl(tm05,pa05) tm05,cp10,CP43" & _
             " From (select * from CaseProgress,trademark,patent" & _
             " Where CP09='" & strCP09 & "'" & _
             " and cp01=tm01(+) and cp02=tm02(+) and cp03=tm03(+) and cp04=tm04(+)" & _
             " and cp01=pa01(+) and cp02=pa02(+) and cp03=pa03(+) and cp04=pa04(+)" & _
             ") X,customer,acc1u0 where substr(nvl(tm23,pa26),1,8)=cu01(+) and substr(nvl(tm23,pa26),9,1)=cu02(+)" & _
             " and cp09=a1u03(+)" & _
             " group by cp84,cp09,cp01,cp02,cp03,cp04,cp13,cp14,cp16,cp17,cp18,cp60,nvl(nvl(cu04,cu05),cu06),nvl(tm05,pa05),cp10,CP43"
   'end 2023/11/20
   rsA.CursorLocation = adUseClient
   rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
   If rsA.RecordCount > 0 Then
      'Add By Sindy 2021/6/16 修改延期發文程式，收文規費與發文規費的檢查，除了原來的檢查外，請再加上與延期相關總收文號的收文規費比較，若金額符合則不必再發MAIL。
      If "" & rsA.Fields("CP43") <> "" Then
         If GetPrjState4(rsA.Fields("CP01") & "-" & rsA.Fields("CP02") & "-" & rsA.Fields("CP03") & "-" & rsA.Fields("CP04"), _
            rsA.Fields("CP10")) = "延期" Then
            StrSQLa = "Select cp01,cp02,cp03,cp04,cp09,cp17,cp77" & _
                      " From CaseProgress" & _
                      " Where CP09='" & rsA.Fields("CP43") & "'"
            rsA2.CursorLocation = adUseClient
            rsA2.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
            If rsA2.RecordCount > 0 Then
               '若有銷帳則要扣除銷帳規費
               strCP17 = CheckStr(rsA2.Fields("CP17"))
               If Val("" & rsA2.Fields("CP77")) <> 0 Then
                  If GetCP77Detail(rsA2.Fields("CP09"), m_Fee, m_Official) = True Then
                     strCP17 = Val(strCP17) - Val(m_Official)
                  End If
               End If
               If Val(strCP17) = Val(strCP84) Then
                  Exit Sub
               End If
            End If
         End If
      End If
      '2021/6/16 END
      
      'Modifed by Lydia 2022/05/30 整理frm880005改用寄信模組
      'frm880005.txtEmail(0).Text = rsA.Fields("cp13")
      ''2013/7/2 add by sonia 自動扣款之電子送件時才要寄副本給財務處
      ''Modify Sindy 2020/12/23 mark
'      'If strCP118 = "A" Then
      ''2020/12/23 END
      '   frm880005.txtEmail(0).Text = frm880005.txtEmail(0).Text & ";" & Pub_GetSpecMan("財務處總帳人員")
'      'End If
      ''2013/7/2 end
      
      m_StrTo = rsA.Fields("cp13") & ";" & Pub_GetSpecMan("財務處總帳人員")
      'Add by Amy 2024/05/15 財務2個特殊設定拆成3個
      If Val(strSrvDate(1)) >= Val(財務拆總帳出納國內應收啟用日) Then
          m_StrTo = rsA.Fields("cp13") & ";" & Pub_GetSpecMan("財務處應收處理人員")
      End If
      'Add By Sindy 2025/5/23 將操作之承辦同仁列入系統信之副本收受者
      strToCC = strUserNum
      If "" & rsA.Fields("cp14") <> strUserNum Then
         strToCC = strToCC & ";" & rsA.Fields("cp14")
      End If
      '2025/5/23 END
      
      '2013/7/2 modify by sonia 收據編號改抓該收文號之所有收據編號
      'frm880005.txtEmail(1).Text = "通知 " & rsA.Fields("cp01") & "-" & rsA.Fields("cp02") & "-" & rsA.Fields("cp03") & "-" & rsA.Fields("cp04") & " 收文規費與發文規費不符，請將收據 ( " & rsA.Fields("cp60") & " ) 退回財務處修改！"
      'Modify By Sindy 2020/12/23 調整主旨
      'frm880005.txtEmail(1).Text = "通知 " & rsA.Fields("cp01") & "-" & rsA.Fields("cp02") & "-" & rsA.Fields("cp03") & "-" & rsA.Fields("cp04") & " 收文規費與發文規費不符，請將收據 ( " & strCP60 & " ) 退回財務處修改！"
      If strCP60 = "尚未開立收據" Then
         'Modifed by Lydia 2022/05/30 整理frm880005改用寄信模組
         'frm880005.txtEmail(1).Text = "通知 " & rsA.Fields("cp01") & "-" & rsA.Fields("cp02") & "-" & rsA.Fields("cp03") & "-" & rsA.Fields("cp04") & " 收文規費與發文規費不符，" & _
            "請通知財務金額如何修正( 尚未開立收據 )！"
         m_StrSub = "通知 " & rsA.Fields("cp01") & "-" & rsA.Fields("cp02") & "-" & rsA.Fields("cp03") & "-" & rsA.Fields("cp04") & " 收文規費與發文規費不符，" & _
            "請通知財務金額如何修正( 尚未開立收據 )！"
      Else
         'Modifed by Lydia 2022/05/30 整理frm880005改用寄信模組
         'frm880005.txtEmail(1).Text = "通知 " & rsA.Fields("cp01") & "-" & rsA.Fields("cp02") & "-" & rsA.Fields("cp03") & "-" & rsA.Fields("cp04") & " 收文規費與發文規費不符，" & _
            "請將收據 ( " & strCP60 & " ) 退回財務處並通知金額如何修正！"
         m_StrSub = "通知 " & rsA.Fields("cp01") & "-" & rsA.Fields("cp02") & "-" & rsA.Fields("cp03") & "-" & rsA.Fields("cp04") & " 收文規費與發文規費不符，" & _
            "請將收據 ( " & strCP60 & " ) 退回財務處並通知金額如何修正！"
      End If
      '2020/12/23 END
      '2013/7/2 end
      'Modified by Lydia 2022/05/23 +pStrMemo 內文加註: PT案(傳入收文號)取得法律案源之發文規費
      'Modifed by Lydia 2022/05/30 整理frm880005改用寄信模組
      'frm880005.txtEmail(2).Text = "　申請人１：" & rsA.Fields("custname") & vbCrLf & _
                                   "　案件名稱：" & rsA.Fields("tm05") & vbCrLf & vbCrLf & _
                                   "　本程序收文費用如下：" & vbCrLf & _
                                   "　　　收文費用：" & Format(rsA.Fields("cp16"), DDollar) & "     規費：" & Format(rsA.Fields("cp17"), DDollar) & "     點數：" & Format(rsA.Fields("cp18"), "###,###.0") & vbCrLf & _
                                   "　    發文規費：" & Format(strCP84, DDollar) & vbCrLf & IIf(pStrMemo <> "", pStrMemo & vbCrLf, "") & vbCrLf & _
                                   "　請將收據 ( " & strCP60 & " ) 退回財務處修改！。" & vbCrLf
      'frm880005.Form_Activate: DoEvents
      'frm880005.cmdOK_Click 0: DoEvents
      'Modified by Morgan 2023/8/24 +str939CP16,str939CP17
      m_StrCont = "　申請人１：" & rsA.Fields("custname") & vbCrLf & _
                                   "　案件名稱：" & rsA.Fields("tm05") & vbCrLf & vbCrLf & _
                                   "　本程序收文費用如下：" & vbCrLf & _
                                   "　　　收文費用：" & Format(rsA.Fields("cp16") + Val(str939CP16), DDollar) & "     規費：" & Format(rsA.Fields("cp17") + Val(str939CP17), DDollar) & "     點數：" & Format(rsA.Fields("cp18"), "###,###.0") & vbCrLf & _
                                   "　    發文規費：" & Format(strCP84, DDollar) & vbCrLf & IIf(pStrMemo <> "", pStrMemo & vbCrLf, "") & vbCrLf & _
                                   "　請將收據 ( " & strCP60 & " ) 退回財務處修改！。" & vbCrLf
      'Modify By Sindy 2025/5/23 + strToCC
      PUB_SendMail strUserNum, m_StrTo, strCP09, m_StrSub, m_StrCont, , , , , , strToCC
      'end 2022/05/30
   End If
   Set rsA = Nothing
   Set rsA2 = Nothing 'Add By Sindy 2021/6/16
End Sub
'2012/7/23 end

'Modify By Sindy 2012/7/30 frm040303 移出來共用
'依不同專利種類取得下次繳費年度
Public Function PUB_getPA72NextYear(strPA01 As String, strPA02 As String, strPA03 As String, strPA04 As String, Optional p_stMaxFeeYear As String, Optional p_bFirstYear As Boolean) As String
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset
Dim strPayYear As String '記錄各專利種類的繳費年度
Dim arrPayYear '記錄各專利種類的繳費年度陣列
Dim strMaxPayYear As String '記錄各專利種類的最大繳費年度
Dim ii As Integer
Dim arrPA72 '記錄已繳費年度陣列
Dim strMaxPA72 As String '下一次繳費年度
Dim strPA14 As String, strPA25 As String
Dim strEffDate As String '有效專用日期

   PUB_getPA72NextYear = ""
   strPayYear = ""
   StrSQLa = "Select * From Patent,Nation Where " & ChgPatent(strPA01 & strPA02 & strPA03 & strPA04) & " And PA09=NA01(+) "
   If rsA.State <> adStateClosed Then rsA.Close
   Set rsA = Nothing
   rsA.CursorLocation = adUseClient
   rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
   If rsA.RecordCount > 0 Then
       strPA14 = "" & rsA("PA14")
       Select Case "" & rsA("PA08").Value
       Case "1" '發明
           If "" & (rsA("NA21").Value) <> "" Then
               strPayYear = "" & (rsA("NA21").Value)
           End If
       Case "2" '新型
           If "" & (rsA("NA23").Value) <> "" Then
               strPayYear = "" & (rsA("NA23").Value)
           End If
       Case "3" '設計
           If "" & (rsA("NA25").Value) <> "" Then
               strPayYear = "" & (rsA("NA25").Value)
           End If
       End Select
       
      'Add by Morgan 2007/11/6 舊法新型專用期12年
      If rsA("pa09") = "000" And rsA("pa08") = "2" And Val("" & rsA("pa14")) > 0 And Val("" & rsA("pa14")) < 20040701 Then
         strPayYear = "1,2,3,4,5,6,7,8,9,10,11,12"
      End If
      'end 2007/11/6
                              
       'm_strPA08 = "" & rsA("PA08").Value
       
       If strPayYear <> "" Then
           arrPayYear = Split(strPayYear, ",")
           strMaxPayYear = "0"
           For ii = LBound(arrPayYear) To UBound(arrPayYear)
                   If Val(strMaxPayYear) < Val(arrPayYear(ii)) Then
                       '取得設定的最大繳費年度
                       strMaxPayYear = arrPayYear(ii)
                   End If
           Next ii
           
           If "" & rsA("PA72").Value = "" Then
               p_bFirstYear = True 'Add by Morgan 2008/5/7
               '下一次繳費年度
               'Modify by Morgan 2008/5/7
               'strMaxPA72 = "1"
               strMaxPA72 = arrPayYear(LBound(arrPayYear))
               'end 2008/5/7
               If Val(strMaxPA72) <= Val(strMaxPayYear) Then
                   PUB_getPA72NextYear = strMaxPA72
               End If
           Else
               arrPA72 = Split("" & rsA("PA72").Value, ",")
               strMaxPA72 = "0"
               For ii = LBound(arrPA72) To UBound(arrPA72)
                   If Val(strMaxPA72) < Val(arrPA72(ii)) Then
                       '取得目前最大已繳費年度
                       strMaxPA72 = arrPA72(ii)
                   End If
               Next ii
               '下一次繳費年度
               strMaxPA72 = Val(strMaxPA72) + 1
               If Val(strMaxPA72) <= Val(strMaxPayYear) Then
                   PUB_getPA72NextYear = strMaxPA72
               End If
           End If
           'Add by Morgan 2007/11/20 新版年費要抓下兩年費用
           If rsA("pa09") = "000" Then
               strPA14 = "" & rsA("pa14")
               strPA25 = "" & rsA("pa25")
               p_stMaxFeeYear = strMaxPA72
               If strPA14 <> "" And strPA25 <> "" Then
                   For ii = Val(strMaxPA72) To Val(strMaxPayYear) - 1
                      strEffDate = CompDate(0, ii, strPA14)
                      If strEffDate > strPA25 Then
                         Exit For
                      Else
                         p_stMaxFeeYear = ii + 1
                      End If
                   Next
               End If
           End If
           'end 2007/11/20
       End If
   End If
   
   If rsA.State <> adStateClosed Then rsA.Close
   Set rsA = Nothing
End Function

'Modify By Sindy 2012/7/30 frm040303 移出來共用
'Add by Morgan 2004/5/18
'取得下一繳費年度
'依不同專利種類取得下次繳費年度
Public Function PUB_getNextPayYear(strPA01 As String, strPA02 As String, strPA03 As String, strPA04 As String, ByRef strNextPayDate As String) As String
   Dim StrSQLa As String
   Dim rsA As New ADODB.Recordset
   Dim strPayYear As String '記錄各專利種類的繳費年度
   Dim arrPayYear '記錄各專利種類的繳費年度陣列
   Dim ii As Integer
   Dim arrPA72 '記錄已繳費年度陣列
   Dim strMaxPA72 As String   '已繳費年度
   Dim strPayDATE As String '記錄各專利種類的年費起算日
   Dim strNP07 As String '案件性質
   Dim strPA09 As String '國家
   Dim m_strPA08 As String '記錄專利種類'Add By Sindy 2012/7/30
   
   PUB_getNextPayYear = ""
   strPayYear = ""
   strMaxPA72 = "0"
   
   StrSQLa = "Select * From Patent,Nation Where " & ChgPatent(strPA01 & strPA02 & strPA03 & strPA04) & " And PA09=NA01(+) "
   If rsA.State <> adStateClosed Then rsA.Close
   Set rsA = Nothing
   rsA.CursorLocation = adUseClient
   rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
   
   If rsA.RecordCount > 0 Then
      strPA09 = "" & rsA("pa09")
      If "" & rsA("PA72").Value <> "" Then
         arrPA72 = Split("" & rsA("PA72").Value, ",")
         For ii = UBound(arrPA72) To LBound(arrPA72) Step -1
             If Val(arrPA72(ii)) > 0 Then
                 '取得目前最大已繳費年度
                 strMaxPA72 = arrPA72(ii)
                 Exit For
             End If
         Next ii
      'Remove by Morgan 2009/2/12 P-75730 的下次繳費年無法取得,改再下面抓下次繳費日時判斷是否為延展費控制
      ''2008/9/10 add by sonia P-074053催第一次時因為pa72空的,strMaxPA72會變為0
      'Else
      '   If "" & (rsA("NA23").Value) <> "" Then
      '      arrPA72 = Split("" & rsA("NA23").Value, ",")
      '      strMaxPA72 = "" & arrPA72(0)
      '   End If
      ''2008/9/10 end
      'end 2009/2/12
      End If
   
      m_strPA08 = "" & rsA("PA08").Value
       
      Select Case m_strPA08
         Case "1" '發明
             If "" & (rsA("NA21").Value) <> "" Then
                 strPayYear = "" & (rsA("NA21").Value)
                 strPayDATE = "" & (rsA("NA06").Value)
             End If
             strNP07 = "" & rsA("NA20").Value
         Case "2" '新型
             If "" & (rsA("NA23").Value) <> "" Then
                 strPayYear = "" & (rsA("NA23").Value)
                 strPayDATE = "" & (rsA("NA08").Value)
             End If
             strNP07 = "" & rsA("NA22").Value
         Case "3" '設計
             If "" & (rsA("NA25").Value) <> "" Then
                 strPayYear = "" & (rsA("NA25").Value)
                 strPayDATE = "" & (rsA("NA10").Value)
             End If
             strNP07 = "" & rsA("NA24").Value
      End Select
      
      If strPayYear <> "" Then
         arrPayYear = Split(strPayYear, ",")
         For ii = LBound(arrPayYear) To UBound(arrPayYear)
            If Val(arrPayYear(ii)) > Val(strMaxPA72) Then
               '取得設定的下次繳費年度
               PUB_getNextPayYear = arrPayYear(ii)
               Exit For
            End If
         Next ii
      End If
      
      'Modify by Morgan 2009/2/12 香港新型,設計為延展算法不同,非台灣案法限不必減1天
      Select Case strPayDATE
         Case 申請日
            If strNP07 = "605" Then
               strNextPayDate = CompDate(0, strMaxPA72, rsA("PA10").Value)
            Else
               strNextPayDate = CompDate(0, PUB_getNextPayYear, rsA("PA10").Value)
            End If
         Case 公開日
                    strNextPayDate = CompDate(0, strMaxPA72, rsA("PA12").Value)
         Case 准駁日
                    strNextPayDate = CompDate(0, strMaxPA72, rsA("PA20").Value)
         Case 公告日
                    strNextPayDate = CompDate(0, strMaxPA72, rsA("PA14").Value)
         Case 發證日
                    strNextPayDate = CompDate(0, strMaxPA72, rsA("PA21").Value)
      End Select
      
      If strPA09 = "000" Then
         strNextPayDate = CompDate(2, -1, strNextPayDate)
      End If
   End If
   
   If rsA.State <> adStateClosed Then rsA.Close
   Set rsA = Nothing
End Function

'2012/8/1 ADD BY SONIA
' 取得該收文號之銷帳服務費及銷帳規費
Public Function GetCP77Detail(p_CP09 As String, p_Fee As String, p_Official As String) As Boolean
Dim strTmp As String, intA As Integer, rsAD As New ADODB.Recordset 'Added by Lydia 2024/05/15

   GetCP77Detail = False
   strTmp = "select SUM(NVL(A1U07,0)) A1U07,SUM(NVL(A1U09,0)) A1U09 FROM ACC1U0 WHERE A1U03='" & p_CP09 & "'"
   intA = 1
   Set rsAD = ClsLawReadRstMsg(intA, strTmp)
   If intA = 1 Then
      GetCP77Detail = True
      p_Fee = Val("" & rsAD.Fields(0))
      p_Official = Val("" & rsAD.Fields(1))
   End If
   Set rsAD = Nothing 'Added by Lydia 2024/05/15
   
End Function

'Added by Morgan 2012/8/9
'FCP案管制人
Public Function PUB_GetFCPHandler(cp01 As String, cp02 As String, cp03 As String, cp04 As String, Optional CP10 As String, Optional ByRef FaNo As String) As String
   Dim stSQL As String, intR As Integer, adoRst As ADODB.Recordset
   
   'Modified by Lydia 2017/02/13 +FMP管制人
   'Modified by Lydia 2017/03/09 判斷服務業務檔
'   If strSrvDate(1) < FMP管制人啟用日 Then
'        stSQL = "select na16,PA75,9 Srt from patent,fagent,nation where pa01(+)='" & cp01 & "' and pa02(+)='" & cp02 & "' and pa03(+)='" & cp03 & "' and pa04(+)='" & cp04 & "' and fa01(+)=substr(pa75,1,8) and fa02(+)=substr(pa75,9) and na01(+)=fa10"
'        If CP10 = "605" Then
'           stSQL = stSQL & " union select na16,PA76,1 Srt from patent,fagent,nation where pa01(+)='" & cp01 & "' and pa02(+)='" & cp02 & "' and pa03(+)='" & cp03 & "' and pa04(+)='" & cp04 & "' and substr(pa76,1,1)='Y' and fa01(+)=substr(pa76,1,8) and fa02(+)=substr(pa76,9) and na01(+)=fa10"
'           stSQL = stSQL & " union select na16,PA76,1 Srt from patent,customer,nation where pa01(+)='" & cp01 & "' and pa02(+)='" & cp02 & "' and pa03(+)='" & cp03 & "' and pa04(+)='" & cp04 & "' and substr(pa76,1,1)='X' and cu01(+)=substr(pa76,1,8) and cu02(+)=substr(pa76,9) and na01(+)=cu10"
'           stSQL = stSQL & " union select na16,CU96,2 Srt from patent,customer,fagent,nation where pa01(+)='" & cp01 & "' and pa02(+)='" & cp02 & "' and pa03(+)='" & cp03 & "' and pa04(+)='" & cp04 & "' and cu01(+)=substr(pa26,1,8) and cu02(+)=substr(pa26,9) and substr(CU96,1,1)='Y' and fa01(+)=substr(CU96,1,8) and fa02(+)=substr(CU96,9) and na01(+)=fa10"
'           stSQL = stSQL & " union select na16,c1.CU96,2 Srt from patent,customer c1,customer c2,nation where pa01(+)='" & cp01 & "' and pa02(+)='" & cp02 & "' and pa03(+)='" & cp03 & "' and pa04(+)='" & cp04 & "' and c1.cu01(+)=substr(pa26,1,8) and c1.cu02(+)=substr(pa26,9) and substr(c1.CU96,1,1)='X' and c2.cu01(+)=substr(c1.CU96,1,8) and c2.cu02(+)=substr(c1.CU96,9) and na01(+)=c2.cu10"
'        End If
'   Else
'        stSQL = "select DECODE(PA01,'P',NVL(NA79,NA16),'PS',NVL(NA79,NA16),NA16) NA16,PA75,9 Srt from patent,fagent,nation where pa01(+)='" & cp01 & "' and pa02(+)='" & cp02 & "' and pa03(+)='" & cp03 & "' and pa04(+)='" & cp04 & "' and fa01(+)=substr(pa75,1,8) and fa02(+)=substr(pa75,9) and na01(+)=fa10"
'        If CP10 = "605" Then
'           stSQL = stSQL & " union select DECODE(PA01,'P',NVL(NA79,NA16),'PS',NVL(NA79,NA16),NA16) NA16,PA76,1 Srt from patent,fagent,nation where pa01(+)='" & cp01 & "' and pa02(+)='" & cp02 & "' and pa03(+)='" & cp03 & "' and pa04(+)='" & cp04 & "' and substr(pa76,1,1)='Y' and fa01(+)=substr(pa76,1,8) and fa02(+)=substr(pa76,9) and na01(+)=fa10"
'           stSQL = stSQL & " union select DECODE(PA01,'P',NVL(NA79,NA16),'PS',NVL(NA79,NA16),NA16) NA16,PA76,1 Srt from patent,customer,nation where pa01(+)='" & cp01 & "' and pa02(+)='" & cp02 & "' and pa03(+)='" & cp03 & "' and pa04(+)='" & cp04 & "' and substr(pa76,1,1)='X' and cu01(+)=substr(pa76,1,8) and cu02(+)=substr(pa76,9) and na01(+)=cu10"
'           stSQL = stSQL & " union select DECODE(PA01,'P',NVL(NA79,NA16),'PS',NVL(NA79,NA16),NA16) NA16,CU96,2 Srt from patent,customer,fagent,nation where pa01(+)='" & cp01 & "' and pa02(+)='" & cp02 & "' and pa03(+)='" & cp03 & "' and pa04(+)='" & cp04 & "' and cu01(+)=substr(pa26,1,8) and cu02(+)=substr(pa26,9) and substr(CU96,1,1)='Y' and fa01(+)=substr(CU96,1,8) and fa02(+)=substr(CU96,9) and na01(+)=fa10"
'           stSQL = stSQL & " union select DECODE(PA01,'P',NVL(NA79,NA16),'PS',NVL(NA79,NA16),NA16) NA16,c1.CU96,2 Srt from patent,customer c1,customer c2,nation where pa01(+)='" & cp01 & "' and pa02(+)='" & cp02 & "' and pa03(+)='" & cp03 & "' and pa04(+)='" & cp04 & "' and c1.cu01(+)=substr(pa26,1,8) and c1.cu02(+)=substr(pa26,9) and substr(c1.CU96,1,1)='X' and c2.cu01(+)=substr(c1.CU96,1,8) and c2.cu02(+)=substr(c1.CU96,9) and na01(+)=c2.cu10"
'        End If
'   End If
   'end 2017/02/13
    stSQL = "SELECT PA01,NVL(PA75,PA26) ANO, 91 SRT FROM PATENT WHERE PA01='" & cp01 & "' AND PA02='" & cp02 & "' AND PA03='" & cp03 & "' AND PA04='" & cp04 & "' "
    stSQL = stSQL & "UNION ALL SELECT SP01,NVL(SP26,SP08) ANO, 92 SRT FROM SERVICEPRACTICE WHERE SP01='" & cp01 & "' AND SP02='" & cp02 & "' AND SP03='" & cp03 & "' AND SP04='" & cp04 & "' "
    If CP10 = "605" Then
        stSQL = stSQL & "UNION ALL SELECT PA01,NVL(PA76, NVL(CU96, NVL(PA75, PA26))) ANO, 11 SRT FROM PATENT,CUSTOMER WHERE PA01='" & cp01 & "' AND PA02='" & cp02 & "' AND PA03='" & cp03 & "' AND PA04='" & cp04 & "' AND SUBSTR(PA26,1,8)=CU01(+) AND SUBSTR(PA26,9,1)=CU02(+) "
    End If
    stSQL = "SELECT DECODE(PA01,'P',DECODE(SUBSTR(ANO,1,1),'Y',NVL(N1.NA79,N1.NA16),NVL(N2.NA79,N2.NA16)),'PS',DECODE(SUBSTR(ANO,1,1),'Y',NVL(N1.NA79,N1.NA16),NVL(N2.NA79,N2.NA16)),NVL(N1.NA16,N2.NA16)) NA16," & _
            "ANO,SRT From (" & stSQL & ") X1,FAGENT,CUSTOMER,NATION N1,NATION N2 " & _
            "WHERE SUBSTR(ANO,1,8)=FA01(+) AND SUBSTR(ANO,9,1)=FA02(+) AND SUBSTR(ANO,1,8)=CU01(+) AND SUBSTR(ANO,9,1)=CU02(+) AND FA10=N1.NA01(+) AND CU10=N2.NA01(+) "
   'end 2017/03/09
   stSQL = stSQL & " order by Srt"
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      PUB_GetFCPHandler = "" & adoRst(0)
      FaNo = "" & adoRst(1)
   End If
   Set adoRst = Nothing
End Function

'Add By Sindy 2012/8/22 從frm04010502_3Copy出來共用
'是否通知年費期限
Public Function PUB_CheckYear(strPA08 As String, strPA10 As String, strPA20 As String) As String
'檢查是否通知下一年年費期限
'1.第二年  : (申請日+1年)之月份 - (核准日+5個月)之月份 <= 4
'2.第三年起: (申請日+N年)之月份 - (核准日+5個月)之月份 <= 2
Dim m_PA10 As String, m_Text5 As String, iYear As Integer
Dim m_PA10MM As String, m_Text5MM As String
Dim m_PA10DD As String, m_Text5DD As String
Dim m_DiffMM As String
   
   PUB_CheckYear = "": iYear = 1
   m_PA10 = CompDate(0, iYear, strPA10)
   m_PA10MM = Val(Mid(m_PA10, 5, 2))
   m_PA10DD = Val(Mid(m_PA10, 7, 2))
   m_Text5 = CompDate(1, 5, strPA20)
   m_Text5MM = Val(Mid(m_Text5, 5, 2))
   m_Text5DD = Val(Mid(m_Text5, 7, 2))
   
   If Val(m_PA10MM) < Val(m_Text5MM) Then m_PA10MM = m_PA10MM + 12
   m_DiffMM = m_PA10MM - m_Text5MM
   If m_DiffMM = 0 Then
      If Val(m_Text5DD) >= Val(m_PA10DD) Then m_DiffMM = 5
   End If
   
   '1
   If m_PA10 >= m_Text5 Then
      If strPA08 <> "1" And Val(m_DiffMM) <= 4 Then
         PUB_CheckYear = "Y"
      End If
      Exit Function
   Else
   '2
      If strPA08 <> "1" Then
         If Val(m_DiffMM) < 2 Then
            PUB_CheckYear = "Y"
         ElseIf m_DiffMM = 2 Then
            If Val(m_Text5DD) < Val(m_PA10DD) Then
               PUB_CheckYear = "Y"
            End If
         End If
      End If
      Exit Function
   End If
End Function

'Add By Sindy 2012/10/2
'檢查是否有平台帳號的使用權限
Public Function PUB_ChkCustWebIDUserRights(strCustID As String, strUser As String) As Boolean
Dim stSQL As String, intR As Integer, adoRst As ADODB.Recordset
Dim strCon As String
   
   PUB_ChkCustWebIDUserRights = False
   
   'If InStr(Pub_GetSpecMan("客戶平台系統設定之管理人員"), strUserNum) = 0 And Pub_StrUserSt03 <> "M51" Then Exit Function
   
   If Pub_StrUserSt03 <> "M51" Then
      strCon = "and (instr(cd06,'" & strUser & "')>0 or cd06 is null) "
   End If
   stSQL = "SELECT cd03 FROM custweb,custwebid " & _
           "WHERE cw01=cd01(+) " & _
           "and instr(cw04,'" & strCustID & "')>0 " & strCon & _
           "order by cd05 asc,cd03 asc"
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      PUB_ChkCustWebIDUserRights = True
   End If
   Set adoRst = Nothing
End Function

'2012/11/26 add by sonia 順德X07166及其關係企業專利案件(P之1202,1002及CFP之1002,1006,1206,1209)提醒操作人員
Public Function PUB_CheckX07166Remind(s_cp01 As String, s_CP09 As String, s_CP10 As String, Optional ByRef s_941CP14 As String) As Boolean
Dim stSQL As String, adoRst As ADODB.Recordset, intR As Integer
Dim stCP14NM As String
Dim strTmp As String, intA As Integer, rsAD As New ADODB.Recordset  'Added by Lydia 2024/05/14

On Error GoTo ErrHnd

   PUB_CheckX07166Remind = False
   
   '2013/1/22 modify by sonia CFP案加入1220建議性處份書
   'Modified by Morgan 2017/8/8 +1802,1807 (P,CFP) -- 郭雅娟
   'Modified by Morgan 2021/10/6 來函性質改用常數判斷
   'If s_cp01 = "CFP" And InStr("1002,1006,1206,1209,1220,1802,1807", s_CP10) > 0 Then
   'ElseIf Left(s_cp01, 1) = "P" And InStr("1002,1202,1802,1807", s_CP10) > 0 Then
   If s_cp01 = "CFP" And InStr(PatentOAPtyList, s_CP10) > 0 Then
   ElseIf Left(s_cp01, 1) = "P" And InStr(PatentOAPtyList, s_CP10) > 0 Then
   'end 2021/10/6
   Else
      Exit Function
   End If
   
   stSQL = "select pa26,cp14,pa09,pa01,pa02,pa03,pa04 from patent,caseprogress where cp09='" & s_CP09 & "' " & _
           "and cp01=pa01(+) and cp02=pa02(+) and cp03=pa03(+) and cp04=pa04(+) "
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      If Left(adoRst("pa26"), 6) = "X07166" Then
         If s_cp01 = "CFP" Then
            PUB_CheckX07166Remind = True
            MsgBox "此為順德(關係企業)案件, 須先出定稿通知客戶 !!!", vbExclamation + vbOKOnly
         ElseIf Left(s_cp01, 1) = "P" Then
            PUB_CheckX07166Remind = True
            '2012/12/5 MODIFY BY SONIA P非台灣案若原承辦人非工程師則改抓國內案承辦人,再判斷是否離職 P-093775
            s_941CP14 = "" & adoRst("cp14")
            If adoRst("pa09") <> 台灣國家代號 Then
               strTmp = "SELECT ST03 FROM STAFF WHERE ST01='" & s_941CP14 & "' AND ST03>='P1' AND ST03<='P11'"
               intA = 1
               Set rsAD = ClsLawReadRstMsg(intA, strTmp)
               If intA = 0 Then
                  s_941CP14 = PUB_GetInCaseCP14(adoRst("pa01"), adoRst("pa02"), adoRst("pa03"), adoRst("pa04"))
               End If
            End If
            '2013/2/8 add by sonia 若工程師非粘竺儒84012、胡書慈93003及徐偉甄97034則改為粘竺儒84012,並顯示訊息
            'cancel by sonia 2015/4/7
            'If s_941CP14 <> "84012" And s_941CP14 <> "93003" And s_941CP14 <> "97034" Then
            '   s_941CP14 = "84012"
            'End If
            'end 2015/4/7
            'add by sonia 2015/4/20 專利處再改需求,若工程師非粘竺儒84012、楊佳蓉A0039則改為楊佳蓉A0039,並顯示訊息
            'modify by sonia 2016/4/27 再取消84012
            'If s_941CP14 <> "84012" And s_941CP14 <> "A0039" Then
            'modify by sonia 2017/3/7 楊佳蓉產假改蔡順興94019
            'If s_941CP14 <> "A0039" Then
            '   s_941CP14 = "A0039"
            'End If
            'Removed by Morgan 2025/7/17 取消--郭
            'If s_941CP14 <> "94019" Then
            '   s_941CP14 = "94019"
            'End If
            'end 2025/7/17
            'end 2017/3/7
            'end 2015/4/20
            strTmp = "SELECT ST04 FROM STAFF WHERE ST01='" & s_941CP14 & "' "
            intA = 1
            Set rsAD = ClsLawReadRstMsg(intA, strTmp)
            If intA = 1 Then
               If "" & rsAD(0).Value <> "1" Then
                   'Added by Lydia 2023/04/24 修改王副總退休之相關控制
                   If strSrvDate(1) >= "20230501" Then
                      s_941CP14 = "99050" '5/1原工程師離職掛李柏翰
                   Else
                   'end 2023/04/24
                      s_941CP14 = "71011" '原工程師離職掛王副總
                   End If 'Added by Lydia 2023/04/24
               End If
            End If
            '2013/2/8 end
            If ClsPDGetStaff(s_941CP14, stCP14NM) Then
            End If
            MsgBox "此為順德(關係企業)案件, 發文後卷退 " & stCP14NM & " 辦理分析 !!!", vbExclamation + vbOKOnly
            '2012/12/5 END
         End If
      End If
   End If
   
   Set rsAD = Nothing 'Added by Lydia 2024/05/14
   Exit Function
ErrHnd:
   MsgBox Err.Description, vbCritical
End Function
'2012/11/26 end

'2015/8/21 add by sonia 專利案件要先簡單報告之客戶(P之1202,1002及CFP之1002,1006,1206,1209),同時要提醒操作人員,順德(及關係企業)以外
Public Function PUB_SimpleReportCust(s_cp01 As String, s_CP10 As String, s_PA26 As String, s_PA27 As String, s_PA28 As String, s_PA29 As String, s_PA30 As String) As Boolean

On Error GoTo ErrHnd

   PUB_SimpleReportCust = False
   
   'Modified by Morgan 2021/10/6 來函性質改用常數判斷
   'If s_cp01 = "CFP" And InStr("1002,1006,1206,1209,1220", s_CP10) > 0 Then
   'ElseIf Left(s_cp01, 1) = "P" And InStr("1002,1202", s_CP10) > 0 Then
   If s_cp01 = "CFP" And InStr(PatentOAPtyList, s_CP10) > 0 Then
   ElseIf Left(s_cp01, 1) = "P" And InStr(PatentOAPtyList, s_CP10) > 0 Then
   'end 2021/10/6
   Else
      Exit Function
   End If
   
   '2015/8/13 add by sonia 加入簡國靜名下之台虹科技X4193900(關係企業也不要),但只做CFP案,郭說P案直接通知不分析;
   If Left(s_PA26, 8) = "X4193900" Or Left(s_PA27, 8) = "X4193900" Or Left(s_PA28, 8) = "X4193900" Or Left(s_PA29, 8) = "X4193900" Or Left(s_PA30, 8) = "X4193900" Then
      If s_cp01 = "CFP" Then
         PUB_SimpleReportCust = True
         MsgBox "此為簡國靜名下之台虹科技案件, 須先出定稿通知客戶 !!!", vbExclamation + vbOKOnly
      End If
   End If
   '2015/8/13 end
   
   'Added by Morgan 2023/4/18 瑞儀光電 X43190 及其關係企業的CFP案--簡國靜(玫音請作單)
   '比照順德(只判斷申請人1)
   'Modified by Morgan 2023/10/20 + X15833160 欣興電子--陳雅群/郭雅娟
   If InStr(s_PA26, "X43190") > 0 Or Left(s_PA26, 8) = "X1583316" Then
      If s_cp01 = "CFP" Then
         PUB_SimpleReportCust = True
      End If
   End If
   'end 2023/4/18
   
   Exit Function

ErrHnd:
   MsgBox Err.Description, vbCritical
End Function
'2015/8/21 end

'Add By Sindy 2012/12/6
'檢查是否可上收據自動列印時間點
Public Function PUB_ChkAccIsUpdCP151(strCP09 As String, strCP151 As String) As Boolean
Dim Rs As ADODB.Recordset
Dim strTmp As String, intA As Integer  'Added by Lydia 2024/05/14

   PUB_ChkAccIsUpdCP151 = True
   
   If strCP151 <> "" Then
      Select Case strCP151
      Case "1", "2"
         strTmp = "SELECT cp27,cp61 FROM caseprogress WHERE CP09='" & Trim(strCP09) & "'"
         intA = 1
         Set Rs = ClsLawReadRstMsg(intA, strTmp)
         If intA = 1 Then
            If strCP151 = "1" And Val("" & Rs.Fields("cp27")) > 0 Then
               PUB_ChkAccIsUpdCP151 = False
            ElseIf strCP151 = "2" And "" & Rs.Fields("cp61") <> "" Then
               PUB_ChkAccIsUpdCP151 = False
            End If
         End If
      Case "3"
         strTmp = "SELECT a1520 FROM acc151,acc150 WHERE axf01=a1501 and axf02='" & Trim(strCP09) & "'"
         intA = 1
         Set Rs = ClsLawReadRstMsg(intA, strTmp)
         If intA = 1 Then
            If Val("" & Rs.Fields("a1520")) > 0 Then
               PUB_ChkAccIsUpdCP151 = False
            End If
         End If
      End Select
      Rs.Close
      Set Rs = Nothing
   End If
   If PUB_ChkAccIsUpdCP151 = False Then
      MsgBox "已過時效,不可上收據自動列印時間點!!!", vbExclamation + vbOKOnly
   End If
End Function

'Add By Sindy 2012/12/10
'取得客戶應收帳款收文檢查上限
'Modified by Lydia 2020/02/03 應收帳款上限分開管制為個人"應收帳款上限CU183"和"集團應收帳款上限CRA02"
'Public Function PUB_GetCustRecAmtLmt(strKey1 As String) As Double
Public Function PUB_GetCustRecAmtLmt(ByVal strKey1 As String, ByRef dblCRA02 As Double) As Double
Dim Rs As ADODB.Recordset
Dim strA As String, intR As Integer

   PUB_GetCustRecAmtLmt = 300000 '預設為30萬 'Memo by Lydia 2020/02/03 預設個人"應收帳款上限CU183"
   dblCRA02 = 0 'Added by Lydia 2020/02/03
   
   If Trim(strKey1) <> "" Then
      'Modified by Lydia 2020/02/03
      'strA = "SELECT * FROM CustRecAmtLmt WHERE CRA01='" & Left(Trim(strKey1), 6) & "'"
      strA = "SELECT CU01||CU02 AS CNO,CU183,CRA01,CRA02 FROM Customer, CustRecAmtLmt " & _
                "WHERE CU01||CU02='" & ChangeCustomerL(strKey1) & "' AND SUBSTR(CU01,1,6)=CRA01(+) "
      intR = 1
      Set Rs = ClsLawReadRstMsg(intR, strA)
      If intR = 1 Then
         'Modified by Lydia 2020/02/03
         'PUB_GetCustRecAmtLmt = rs.Fields("CRA02")
         If Val("" & Rs.Fields("cu183")) > 0 Then PUB_GetCustRecAmtLmt = Rs.Fields("cu183")
         If Val("" & Rs.Fields("cra02")) > 0 Then dblCRA02 = Rs.Fields("cra02")
         'end 2020/02/03
      End If
      Rs.Close
      Set Rs = Nothing
   End If
End Function

'Add By Sindy 2013/1/28
'取得1.報價匯率和2.預估結匯匯率
Public Function PUB_GetAcc210(intType As Integer, strCurr As String, strDate As String)
Dim Rs As ADODB.Recordset
Dim strTmp As String, intA As Integer  'Added by Lydia 2024/05/14

   PUB_GetAcc210 = 0
   strTmp = "select a2101,a2102,a2103,a2110,nvl(a2110,1.03)*a2103 a2111 from acc210 where a2102='" & strCurr & "' and a2101<=" & strDate & " order by a2101 DESC"
   intA = 1
   Set Rs = ClsLawReadRstMsg(intA, strTmp)
   If intA = 1 Then
      Rs.MoveFirst
      If intType = 1 Then '報價匯率
         PUB_GetAcc210 = Trunc(Rs.Fields("a2111"), 3)
      Else '2.預估結匯匯率
         PUB_GetAcc210 = Trunc(Rs.Fields("a2103"), 3)
      End If
   End If
   Rs.Close
   Set Rs = Nothing
End Function

'Add By Sindy 2013/3/4
'依地址資料取得郵遞區號
Public Function GetZipCode(strAddr As String) As String
Dim Rs As ADODB.Recordset
Dim strTmp As String, intA As Integer  'Added by Lydia 2024/05/14

   GetZipCode = ""
   '比對縣巿欄位
   'Modify By Sindy 2015/2/5 將MailZip改抓postzipdata
   'strtmp = "select distinct mz04 from mailzip where mz04 is not null order by mz04 asc"
   strTmp = "select substr(PZD01,1,3),PZD02,PZD03 from postzipdata group by substr(PZD01,1,3),PZD02,PZD03"
   intA = 1
   Set Rs = ClsLawReadRstMsg(intA, strTmp)
   If intA = 1 Then
      Rs.MoveFirst
      Do While Not Rs.EOF
         'If InStr(1, strAddr, Trim(rs.Fields("mz04"))) > 0 Then
         If InStr(1, strAddr, Trim(Rs.Fields("PZD02"))) > 0 Then
            '比對鄉鎮欄位
            'strtmp = "select mz01,nvl(mz05,'') mz05 from mailzip where mz04='" & rs.Fields("mz04") & "' order by mz01 asc"
            strTmp = "select substr(PZD01,1,3),PZD02,PZD03 from postzipdata where PZD02='" & Rs.Fields("PZD02") & "' group by substr(PZD01,1,3),PZD02,PZD03"
            intA = 1
            Set Rs = ClsLawReadRstMsg(intA, strTmp)
            If intA = 1 Then
               Rs.MoveFirst
               Do While Not Rs.EOF
'                  '若鄉鎮欄位為空白時,則代表為此郵遞區號
'                  If Trim(rs.Fields("mz05")) = "" Then
'                     GetZipCode = Trim(rs.Fields("mz01"))
'                     Exit Do
'                  Else
'                     If InStr(1, strAddr, Trim(rs.Fields("mz05"))) > 0 Then
'                        GetZipCode = Trim(rs.Fields("mz01"))
'                        Exit Do
'                     End If
'                  End If
                  If InStr(1, strAddr, Trim(Rs.Fields("PZD03"))) > 0 Then
                     GetZipCode = Trim(Rs.Fields(0))
                     Exit Do
                  End If
                  Rs.MoveNext
               Loop
               GoTo RunEnd
            End If
         End If
         Rs.MoveNext
      Loop
   End If
RunEnd:
   Set Rs = Nothing
End Function

'Add By Sindy 2013/3/29 計算請款單外幣金額(單筆)
Public Function GetDebitNoteFAmt(strA1K01 As String, strA1K18 As String, strA1K02 As String, stra1l04 As String, strA1L05 As String, _
                                 strA1L07 As String, strA1L16 As String, strA1L17 As String, strA1K33 As String, strA1K10 As String, _
                                 Optional ByRef dblA1L05FAmt As Double) As Double
Dim m_stra1l04 As String, m_strA1L05 As String
Dim m_strA1L07 As String, m_strA1L16 As String
Dim m_strA1L17 As String
Dim m_dblA1L05FAmt As Double
Dim m_dblA1L0507FAmt As Double
Dim dblDisc As Double, dblAmt As Double
Dim strTmp As String, intA As Integer, rsAD As New ADODB.Recordset  'Added by Lydia 2024/05/14

   '若為代收代付並且有折扣時,計算方式較特殊
   If Right(Trim(stra1l04), 2) = "98" Then
      '計算代收代付
      'Modify By Sindy 2025/3/21 + strA1K01
      GetDebitNoteFAmt = GetDebitNoteFAmt_Base(strA1K01, strA1K18, strA1K02, stra1l04, strA1L05, strA1L07, _
                                               strA1L16, strA1L17, strA1K33, strA1K10, dblA1L05FAmt)
      If GetDebitNoteFAmt <> dblA1L05FAmt Then
         '取得本所服務費的外幣金額
         strTmp = "select * from acc1L0 where a1L01='" & strA1K01 & "' and a1L04='" & Left(Trim(stra1l04), Len(Trim(stra1l04)) - 2) & "'"
         intA = 1
         Set rsAD = ClsLawReadRstMsg(intA, strTmp)
         If intA = 1 Then
            If rsAD.RecordCount > 0 Then
               m_stra1l04 = rsAD.Fields("a1L04")
               m_strA1L05 = rsAD.Fields("a1L05")
               m_strA1L07 = rsAD.Fields("a1L07")
               m_strA1L16 = rsAD.Fields("a1L16")
               m_strA1L17 = rsAD.Fields("a1L17")
               m_dblA1L05FAmt = 0
               'Modify By Sindy 2025/3/21 + strA1K01
               m_dblA1L0507FAmt = GetDebitNoteFAmt_Base(strA1K01, strA1K18, strA1K02, m_stra1l04, m_strA1L05, m_strA1L07, _
                                                  m_strA1L16, m_strA1L17, strA1K33, strA1K10, m_dblA1L05FAmt)
               dblDisc = Round(100 - (Val(m_strA1L07) / Val(m_strA1L05) * 100))
               '(代收代付的外幣金額 + 本所服務費的外幣金額) = 原外幣總額
               '以原外幣總額計算折扣後的外幣總額 = 折扣後外幣總額
               '折扣後外幣總額 - 折扣後的本所服務費外幣金額 = 折扣後的代收代付外幣金額
               GetDebitNoteFAmt = ((dblA1L05FAmt + m_dblA1L05FAmt) * (dblDisc / 100)) - m_dblA1L0507FAmt
               '3.純外幣,4.外幣+美金合計 : 逐筆加總並且去小數
               If strA1K33 = "3" Or strA1K33 = "4" Then
                  GetDebitNoteFAmt = Trunc(GetDebitNoteFAmt, 0)
               End If
            End If
         Else
            Exit Function
         End If
      End If
   Else
      'Modify By Sindy 2025/3/21 + strA1K01
      GetDebitNoteFAmt = GetDebitNoteFAmt_Base(strA1K01, strA1K18, strA1K02, stra1l04, strA1L05, strA1L07, _
                                               strA1L16, strA1L17, strA1K33, strA1K10, dblA1L05FAmt)
   End If
   
   Set rsAD = Nothing 'Added by Lydia 2024/05/14
End Function

'Add By Sindy 2013/4/18 計算請款單外幣金額(單筆)
'Modify By Sindy 2025/3/21 +strA1K01 As String: 請款編號
Public Function GetDebitNoteFAmt_Base(strA1K01 As String, strA1K18 As String, strA1K02 As String, stra1l04 As String, strA1L05 As String, strA1L07 As String, _
                                 strA1L16 As String, strA1L17 As String, strA1K33 As String, strA1K10 As String, _
                                 Optional ByRef dblA1L05FAmt As Double) As Double
Dim dblInputRate As Double
Dim bolIsFMP As Boolean 'Add By Sindy 2025/3/21
   
   GetDebitNoteFAmt_Base = 0
   dblA1L05FAmt = 0
   
   'Add By Sindy 2025/3/21
   bolIsFMP = False
   strExc(0) = "select cp01,cp12,a1k22,a1k19 from caseprogress,acc1k0 where cp60='" & strA1K01 & "' and cp60=a1k01(+) and cp01='P' and substr(cp12,1,1)='F'"
   intI = 1
   Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
   If intI = 1 Then
      bolIsFMP = True
   End If
   '2025/3/21 END
   
   '備註 : 只有FMP案才有開放可以輸入A1L16幣別
   '以請款幣別輸入者以A1L17計算
   'Modify By Sindy 2025/3/25 開放全所都可以輸入幣別
   If Trim(strA1L16) = strA1K18 Then
      If Val(strA1L05) > 0 Then 'Modify By Sindy 2013/5/1 +if判斷 請款金額不可為0會出現溢位錯誤訊息
         'Modify By Sindy 2025/4/2 幣別相同又沒有折扣問題,不用再換算直接使用A1L17
         If Val(strA1L07) = 0 Then
            GetDebitNoteFAmt_Base = Val(strA1L17)
            dblA1L05FAmt = Val(strA1L17)
         Else
         '2025/4/2 END
            '3.純外幣,4.外幣+美金合計 : 逐筆加總並且去小數
            If strA1K33 = "3" Or strA1K33 = "4" Then
               GetDebitNoteFAmt_Base = Trunc(Val(strA1L17) / 100 * Round(100 - (Val(strA1L07) / Val(strA1L05) * 100)), 0)
               dblA1L05FAmt = Trunc(Val(strA1L17), 0)
            '1.純台幣,2.台幣+外幣合計 : 逐筆加總不去小數,最後才一次去小數
            Else
               GetDebitNoteFAmt_Base = Val(strA1L17) / 100 * Round(100 - (Val(strA1L07) / Val(strA1L05) * 100))
               dblA1L05FAmt = Val(strA1L17)
            End If
         End If
      End If
   'FMP案以RMB(規費或代理人服務費) 或 USD(規費) 輸入者以A1L05/請款幣別預估結匯匯率計算
'   ElseIf Trim(strA1L16) <> "" And ( _
'      ((Right(Trim(strA1L04), 2) = "99" Or Right(Trim(strA1L04), 2) = "98") And Trim(strA1L16) = "RMB") Or _
'      (Right(Trim(strA1L04), 2) = "99" And Trim(strA1L16) = "USD") _
'      ) Then
   'Modify By Sindy 2025/3/21 + ) And bolIsFMP = True
   ElseIf (Trim(strA1L16) = "RMB" Or Trim(strA1L16) = "USD") And bolIsFMP = True Then
      '取得請款幣別的預估結匯匯率(FMP是用預估結匯匯率換算台幣)
      dblInputRate = PUB_GetAcc210(2, strA1K18, strA1K02)
   
      '3.純外幣,4.外幣+美金合計 : 逐筆加總並且去小數
      If strA1K33 = "3" Or strA1K33 = "4" Then
         GetDebitNoteFAmt_Base = Trunc(((Val(strA1L05) - Val(strA1L07)) / dblInputRate), 0)
         dblA1L05FAmt = Trunc((Val(strA1L05) / dblInputRate), 0)
      '1.純台幣,2.台幣+外幣合計 : 逐筆加總不去小數,最後才一次去小數
      Else
         GetDebitNoteFAmt_Base = (Val(strA1L05) - Val(strA1L07)) / dblInputRate
         dblA1L05FAmt = Val(strA1L05) / dblInputRate
      End If
      
   '其他,以請款幣別請款匯率計算
   Else
      '3.純外幣,4.外幣+美金合計 : 逐筆加總並且去小數
      If strA1K33 = "3" Or strA1K33 = "4" Then
         GetDebitNoteFAmt_Base = Trunc(((Val(strA1L05) - Val(strA1L07)) / strA1K10), 0)
         dblA1L05FAmt = Trunc((Val(strA1L05) / strA1K10), 0)
      '1.純台幣,2.台幣+外幣合計 : 逐筆加總不去小數,最後才一次去小數
      Else
         GetDebitNoteFAmt_Base = (Val(strA1L05) - Val(strA1L07)) / strA1K10
         dblA1L05FAmt = Val(strA1L05) / strA1K10
      End If
   End If
End Function

'Added by Morgan 2013/5/1
'Modified by Morgan 2015/8/5 +pAppNo:申請人
Public Function PUB_GetDiscX(pNo As String, pCP01 As String, pCP10 As String, pOldDisc As String, pAppNo As String) As String
   Dim strNewDisc As String
   strNewDisc = pOldDisc
   '代理人Y20656 實審服務費5折
   If Left(pNo & "000", 9) = "Y20656000" And pCP01 = "FCP" And pCP10 = "416" Then
      If Val(strNewDisc) > 0.5 Then strNewDisc = 0.5
   End If
   
   'add by sonia 2017/7/20
   '代理人 Y22327 Electro Scientific Industries, Inc. 201翻譯優惠: 80%
   'Modified by Morgan 2017/9/29 +X22327 --潘子微
   'Modified by Morgan 2018/7/19 +X79319 --羅暐曄
   'Modified by Morgan 2019/7/3 +X79319010 --陳俐卉
   'Modified by Morgan 2025/6/9 因代理人Y2232700 MKS Inc.已設定TW+CN案全面75折優惠 (申請至年費階段)，取消Y22327及X22327(不會再有非自家代理的案件)--Lisa
   'If (Left(pNo & "000", 9) = "Y22327000" Or Left(pAppNo & "000", 9) = "X22327000" Or Left(pAppNo & "000", 9) = "X79319000" Or Left(pAppNo & "000", 9) = "X79319010") And pCP10 = "201" And (pCP01 = "FCP" Or pCP01 = "FG" Or pCP01 = "P") Then
   If (Left(pAppNo & "000", 9) = "X79319000" Or Left(pAppNo & "000", 9) = "X79319010") And pCP10 = "201" And (pCP01 = "FCP" Or pCP01 = "FG" Or pCP01 = "P") Then
   'end 2025/6/9
      If Val(strNewDisc) > 0.8 Then strNewDisc = 0.8
   End If
   'end 2017/7/20
   
   'Added by Morgan 2015/8/5
   '申請人 X26046 SK hynix Inc. 201翻譯優惠: 80%
   If pCP10 = "201" And pCP01 = "FCP" Then
      If Left(pAppNo & "000", 9) = "X26046000" Then
         If Val(strNewDisc) > 0.8 Then strNewDisc = 0.8
         
      'Added by Morgan 2018/1/31 Murgitroyd 201 翻譯中說 折扣65折--陳佩貞
      'Modified by Lydia 2022/09/23 改用系統特殊設定
      'ElseIf InStr("Y20990000,Y20990010,Y20990020,Y20990030,Y20990040,Y20990050,Y20990060,Y20990B70,Y20990B80,Y52412000,Y52527000,Y52527010,Y52626000,Y53383000,Y53912000,Y32539000", Left(pNo & "000", 9)) > 0 Then
      ElseIf InStr(Pub_GetSpecMan("外專MURGITROYD設定"), Left(pNo & "000", 9)) > 0 Then
         If Val(strNewDisc) > 0.65 Then strNewDisc = 0.65
      End If
   End If
   
   PUB_GetDiscX = strNewDisc
End Function


'Added by Sindy 2013/5/8
'電子承辦簽核檔案命名規則
'Modify By Sindy 2013/8/22 +strFlowID
'Modify By Sindy 2013/9/26 +index = 1.存卷資料
'Modify by Sindy 2013/10/9 +bolShowMsg
'Modify by Sindy 2021/10/14 + Optional bolNotChkFileCaseNo As Boolean = False：不檢查檔名前頭為本所案號
'Modify by Sindy 2023/12/15 + Optional bolNotChkChinWord As Boolean = False：外專不檢查電子檔名是否有中文,因附件區不進卷宗區
Public Function PUB_ChkEmpFlowFNMRule(strCaseNo As String, strFileName As String, _
                                      strFlowID As String, strCP10 As String, _
                                      Optional ByRef strCompFileName As String, _
                                      Optional ByVal Index As Integer = 0, _
                                      Optional bolChkInfo As Boolean = True, _
                                      Optional bolShowMsg As Boolean = True, _
                                      Optional ByRef strErr As String, _
                                      Optional strSecName As String = "", _
                                      Optional bolNotChkFileCaseNo As Boolean = False, _
                                      Optional bolNotChkChinWord As Boolean = False) As Boolean
Dim Str01 As String, Str02 As String, Str03 As String, Str04 As String
Dim i As Integer
Dim strCompFileName2 As String
Dim strCompFileName3 As String
Dim strCompFileName4 As String
Dim Rs As ADODB.Recordset
Dim strTempFile As String
Dim strTmp As String, intA As Integer  'Added by Lydia 2024/05/14

   PUB_ChkEmpFlowFNMRule = False
   Str01 = CStr(SystemNumber(strCaseNo, 1))
   Str02 = CStr(SystemNumber(strCaseNo, 2))
   Str03 = CStr(SystemNumber(strCaseNo, 3))
   Str04 = CStr(SystemNumber(strCaseNo, 4))
   strCompFileName = Trim(Str01) & Trim(Str02) & IIf(Str03 <> "0" Or Str04 <> "00", "-" & Str03, "") & IIf(Str04 <> "00", "-" & Str04, "")
   strCompFileName2 = Trim(Str01) & CStr(Val(Str02)) & IIf(Str03 <> "0" Or Str04 <> "00", "-" & Str03, "") & IIf(Str04 <> "00", "-" & Str04, "")
   strCompFileName3 = Trim(Str01) & "-" & Trim(Str02) & IIf(Str03 <> "0" Or Str04 <> "00", "-" & Str03, "") & IIf(Str04 <> "00", "-" & Str04, "")
   strCompFileName4 = Trim(Str01) & "-" & CStr(Val(Str02)) & IIf(Str03 <> "0" Or Str04 <> "00", "-" & Str03, "") & IIf(Str04 <> "00", "-" & Str04, "")
   If strFileName <> "" Then
      If Len(Mid(strFileName, InStr(strFileName, ".") + 1)) = 0 Then
         strErr = strFileName & vbCrLf & vbCrLf & "檔案命名不符規定，必須要有副檔名!!!"
         If bolShowMsg = True Then
            MsgBox strErr
         End If
         Exit Function
      End If
      
      'Add By Sindy 2013/10/9
      If InStr(strFileName, "#") > 0 Then
         strErr = strFileName & vbCrLf & vbCrLf & "【#】符號為系統保留字，不可使用於檔案命名"
         If bolShowMsg = True Then
            MsgBox strErr
         End If
         Exit Function
      End If
      '2013/10/9 END
      
      'Add By Sindy 2022/5/3
      If Len(strFileName) > 70 Then
         strErr = strFileName & vbCrLf & vbCrLf & "檔名太長，勿超過70（目前長度為" & Len(strFileName) & "）!!!"
         If bolShowMsg = True Then
            MsgBox strErr
         End If
         Exit Function
      End If
      '2022/5/3 END
      
      'Add By Sindy 2013/11/7
      If Not (strSecName = EMP_客戶資料 And strFlowID = "Y") Then '卷宗區客戶資料開放可以存放3D圖檔
         If Right(Trim(UCase(strFileName)), 4) = ".X_T" Or _
            Right(Trim(UCase(strFileName)), 4) = ".X-T" Or _
            Right(Trim(UCase(strFileName)), 4) = ".STP" Or _
            Right(Trim(UCase(strFileName)), 5) = ".STEP" Or _
            Right(Trim(UCase(strFileName)), 4) = ".SAT" Or _
            Right(Trim(UCase(strFileName)), 4) = ".IGS" Then
            strErr = strFileName & vbCrLf & vbCrLf & "為3D圖檔，請改透過FTP或其他方式傳送!!!"
            If bolShowMsg = True Then
               MsgBox strErr
            End If
            Exit Function
         End If
      End If
      '2013/11/7 END
      
'      'Add By Sindy 2015/11/12 檢查檔名是否有”多”命名其他的案件副檔名
'      If strSecName <> "" Then
'         strtmp = "select efc02 from efilecaption" & _
'                     " Where '" & Str01 & "'=efc01(+) and instr(upper('" & strFileName & "'),upper('.'||efc02(+)||'.'))>0" & _
'                     " and upper(efc02)<>upper('" & strSecName & "')"
'         inta = 1
'         Set rs = ClsLawReadRstMsg(inta, strtmp)
'         If inta = 1 Then
'            strErr = strFileName & vbCrLf & vbCrLf & "檔案命名不符規定，不可使用此系統保留字(案件副檔名: ." & rs.Fields("efc02") & ".)!!!"
'            If bolShowMsg = True Then
'               MsgBox strErr
'            End If
'            Set rs = Nothing
'            Exit Function
'         End If
'      Else
'         '檢查是否有重覆命名案件副檔名的狀況
'         'Step.1 讀取案件副檔名
'         strtmp = "select efc02 from efilecaption" & _
'                     " Where '" & Str01 & "'=efc01(+) and instr(upper('" & strFileName & "'),upper('.'||efc02(+)||'.'))>0"
'         inta = 1
'         Set rs = ClsLawReadRstMsg(inta, strtmp)
'         If inta = 1 Then
'            strErr = "." & rs.Fields("efc02") & "."
'            strTempfile = Replace(UCase(strFileName), UCase("." & rs.Fields("efc02")), "")
'            'Step.2 再讀取是否還有案件副檔名
'            strtmp = "select efc02 from efilecaption" & _
'                        " Where '" & Str01 & "'=efc01(+) and instr(upper('" & strTempfile & "'),upper('.'||efc02(+)||'.'))>0"
'            inta = 1
'            Set rs = ClsLawReadRstMsg(inta, strtmp)
'            If inta = 1 Then
'               strTempfile = "." & rs.Fields("efc02") & "."
'
'               strErr = strFileName & vbCrLf & vbCrLf & "檔案命名不符規定，不可同時命名多個案件副檔名(如: " & strErr & " 和 " & strTempfile & ")!!!"
'               If bolShowMsg = True Then
'                  MsgBox strErr
'               End If
'               Set rs = Nothing
'               Exit Function
'            End If
'         End If
'      End If
'      '2015/11/12 END
      
      'Add By Sindy 2013/9/16
      'Modify By Sindy 2015/5/27 不管什麼身份或流程狀態，檔名中的本所案號輸入形式均控管一致
'      If strFlowID = EMP_會修 Or _
'         strFlowID = EMP_會完 Or _
'         (Left(Trim(Pub_StrUserSt15), 1) = "S" And strFlowID = EMP_聯絡) Then
      'Modify By Sindy 2021/10/14 不檢查檔名前頭為本所案號
      If bolNotChkFileCaseNo = False Then
      '2021/10/14 END
         If UCase(Left(strFileName, Len(strCompFileName))) <> strCompFileName And _
            UCase(Left(strFileName, Len(strCompFileName2))) <> strCompFileName2 And _
            UCase(Left(strFileName, Len(strCompFileName3))) <> strCompFileName3 And _
            UCase(Left(strFileName, Len(strCompFileName4))) <> strCompFileName4 Then
            strErr = strFileName & vbCrLf & vbCrLf & "檔案命名不符規定，字首必須為" & strCompFileName
            If bolShowMsg = True Then
               MsgBox strErr
            End If
            Exit Function
         End If
      End If
'      Else
'      '2013/9/16 END
'         If Left(strFileName, Len(strCompFileName)) <> strCompFileName Then
'            strErr = strFileName & vbCrLf & vbCrLf & "檔案命名不符規定，字首必須為" & strCompFileName
'            If bolShowMsg = True Then
'               MsgBox strErr
'            End If
'            Exit Function
'         End If
'      End If
      
      'strFlowID = "Y":代表控管檔名不可為中文
      'Modify By Sindy 2013/10/3 +EMP_附加流程
      'Modify By Sindy 2013/12/2 +EMP_退件重送
      'Modify By Sindy 2015/5/27 strFlowID = "Y" 另外控管
      'Modify By Sindy 2018/5/4 + strFlowID = EMP_送件
      'Modify By Sindy 2018/8/8 + strFlowID = EMP_發文歸檔
      If strFlowID <> "Y" And Str01 = "ACS" Then
         'Modify By Sindy ACS操作歷程時,不鎖中文字;
         '                因ACS發文時，歷程中的所有附件都不放入卷宗區或原始檔區。
         '                所以沒有中文檔名的問題。
      Else
         If strFlowID = EMP_墨完 Or _
            strFlowID = EMP_繪圖判發 Or _
            strFlowID = EMP_送判 Or _
            strFlowID = EMP_判發 Or _
            strFlowID = EMP_送件 Or _
            strFlowID = EMP_發文歸檔 Or _
            strFlowID = EMP_附加流程 Or _
            strFlowID = EMP_退件重送 Or _
            Index = 1 Then '1=存卷
            'Modify By Sindy 2023/12/15
            If bolNotChkChinWord = True And Index = 0 Then
               '外專不鎖中文,因附件區不進卷宗區
               'Modify By Sindy 2024/8/14 註:外商同外專不鎖中文,因附件區不進卷宗區
            Else
            '2023/12/15 END
'               'Add By Sindy 2024/8/28 MSG不鎖中文
'               If UCase(Right(strFileName, Len(strFileName) - InStrRev(strFileName, ".") + 1)) = UCase(".MSG") Then
'               '2024/8/28 END
                  '檔名中不可有中文字
                  For i = 1 To Len(strFileName)
                     If Asc(Mid(strFileName, i, 1)) <= 0 Then
                        strErr = strFileName & vbCrLf & vbCrLf & "檔案命名不符規定，不可有中文字!!!"
                        If bolShowMsg = True Then
                           MsgBox strErr
                        End If
                        Exit Function
                     End If
                  Next i
'               End If
            End If
         'Add By Sindy 2015/5/27
         ElseIf strFlowID = "Y" Then
            'Modify By Sindy 2024/12/12
            If bolNotChkChinWord = True And Index = 0 Then
               '外專不鎖中文,因附件區不進卷宗區
               '外商同外專不鎖中文,因附件區不進卷宗區
            Else
            '2024/12/12 END
               If UCase(Right(strFileName, Len(strFileName) - InStrRev(strFileName, ".") + 1)) = UCase(".PDF") Then
                  '檔名中不可有中文字
                  For i = 1 To Len(strFileName)
                     If Asc(Mid(strFileName, i, 1)) <= 0 Then
                        strErr = strFileName & vbCrLf & vbCrLf & "檔案命名不符規定，不可有中文字!!!"
                        If bolShowMsg = True Then
                           MsgBox strErr
                        End If
                        Exit Function
                     End If
                  Next i
               End If
            End If
         '2015/5/27 END
         End If
      End If
      
      'Add By Sindy 2013/9/26 index = 1.存卷資料
      If bolChkInfo = True Then
         'strCompFileName = strCompFileName & ".info"
         If Index = 1 Then
            'Modify By Sindy 2019/6/27
            strTmp = "select EFC01,EFC02 from efilecaption where EFC06='Y'" & _
                        " and instr(upper('" & ChgSQL(strFileName) & "'),upper('.'||EFC02||'.'))>0"
            intA = 1
            Set Rs = ClsLawReadRstMsg(intA, strTmp)
            If intA = 0 Then
            '2019/6/27 END
               'If UCase(Left(strFileName, Len(strCompFileName))) <> UCase(strCompFileName) Then
               If UCase(Mid(strFileName, InStr(strFileName, "."), 5)) <> UCase(".info") Then
                  'Modify By Sindy 2021/10/14 不檢查檔名前頭為本所案號
                  strErr = ""
                  If bolNotChkFileCaseNo = True Then
                     If Left(UCase(strFileName), 4) <> UCase("info") Then
                        strErr = strFileName & vbCrLf & vbCrLf & "檔案命名不符規定，字首至少必須為 " & UCase("info")
                     End If
                  Else
                     'strErr = strFileName & vbCrLf & vbCrLf & "檔案命名不符規定，字首必須為" & strCompFileName & ".info"
                     strErr = strFileName & vbCrLf & vbCrLf & "檔案命名不符規定，字首至少必須為" & strCompFileName & ".info"
                  End If
                  If strErr <> "" Then
                  '2021/10/14 END
                     If bolShowMsg = True Then
                        MsgBox strErr
                     End If
                     Exit Function
                  End If
               End If
            End If
            
            '一定要是PDF檔
            If UCase(Right(strFileName, 4)) <> UCase(".pdf") Then
               strErr = strFileName & vbCrLf & vbCrLf & "存卷資料要是PDF檔！"
               If bolShowMsg = True Then
                  MsgBox strErr
               End If
               Exit Function
            End If
         Else
            'If UCase(Left(strFileName, Len(strCompFileName))) = UCase(strCompFileName) Then
            If UCase(Mid(strFileName, InStr(strFileName, "."), 5)) = UCase(".info") Then
               'Modify By Sindy 2021/10/14 不檢查檔名前頭為本所案號
               strErr = ""
               If bolNotChkFileCaseNo = True Then
                  If Left(UCase(strFileName), 4) = UCase("info") Then
                     strErr = strFileName & vbCrLf & vbCrLf & "非存卷資料，檔名字首不可為 " & UCase("info")
                  End If
               Else
                  strErr = strFileName & vbCrLf & vbCrLf & "非存卷資料，檔名字首不可為" & strCompFileName & ".info"
               End If
               If strErr <> "" Then
               '2021/10/14 END
                  If bolShowMsg = True Then
                     MsgBox strErr
                  End If
                  Exit Function
               End If
            End If
         End If
      End If
      
'      'Add By Sindy 2013/9/16 檢查與專業部電子檔副檔名是否正確
'      If strFlowID = EMP_送判 Or _
'         strFlowID = EMP_判發 Or _
'         strFlowID = "Y" Then
'         strtmp = "select cpm26 from casepropertymap where cpm01='" & Str01 & "' and cpm02='" & strCP10 & "'"
'         inta = 1
'         Set rs = ClsLawReadRstMsg(inta, strtmp)
'         If inta = 1 Then
'            If Trim("" & rs.Fields("cpm26")) <> "" Then
'               If InStr(UCase(strFileName), "DWG") = 0 Then '繪圖電子檔除外
'                  If InStr(UCase(strFileName), UCase(rs.Fields("cpm26"))) = 0 Then
'                     MsgBox strFileName & vbCrLf & "檔案命名不符規定，副檔名應有" & rs.Fields("cpm26")
'                     Set rs = Nothing
'                     Exit Function
'                  End If
'               End If
'            End If
'         End If
'         Set rs = Nothing
'      End If
'      '2013/9/16 END
   End If
   Set Rs = Nothing
   PUB_ChkEmpFlowFNMRule = True
End Function

'Added by Sindy 2013/7/2
'電子承辦簽核檔案更名規則
Public Function PUB_GetEmpFlowReNameFile(strCP01 As String, strCP02 As String, strCP03 As String, strCP04 As String, _
                                         strCP10 As String, stFileName As String, ByRef stReNameFile As String, _
                                         Optional chkQueryKind As Boolean = False, Optional intQueryKind As Integer, _
                                         Optional bolShowMsg As Boolean = True, Optional ByRef strErr As String, _
                                         Optional strCP09 As String = "", Optional strSecName As String = "") As Boolean
Dim stFileName2 As String, stFileName1 As String
Dim strFileCase As String, strFileCase2 As String
Dim bolGetFileName As Boolean
Dim intRow As Integer
Dim strArea1 As String, strArea2 As String 'Add By Sindy 2018/11/1
Dim strTmp As String, intA As Integer, rsAD As New ADODB.Recordset 'Added by Lydia 2024/05/15

   PUB_GetEmpFlowReNameFile = True
   'Modify By Sindy 2023/12/7 +LCase 轉小寫
   stFileName2 = LCase(Right(stFileName, Len(stFileName) - InStrRev(stFileName, ".") + 1)) '副檔名
   'Modify By Sindy 2023/12/7 不要轉大寫,因目前官方不接受大寫副檔名
   'stReNameFile = UCase(stFileName) '檔名+.副檔名
   If InStr(Left(stFileName, InStrRev(stFileName, ".") - 1), ".") > 0 Then '副檔名前的檔名有存在.時的處理
      stFileName1 = UCase(Left(stFileName, InStr(stFileName, "."))) '第一個點的前段
      stReNameFile = stFileName1 & _
                     Mid(stFileName, Len(stFileName1) + 1, Len(stFileName) - Len(stFileName1) - Len(stFileName2)) & _
                     stFileName2 '檔名+.副檔名
   Else
      stReNameFile = Left(stFileName, InStrRev(stFileName, ".") - 1) & stFileName2 '檔名+.副檔名
   End If
   '2023/12/7 END
   'Add By Sindy 2023/12/14 重覆案號 ex:P-132355 (P132355.P132355.utl.docx)
   stReNameFile = Replace(stReNameFile, stFileName1 & stFileName1, stFileName1)
   '2023/12/14 END
   
'   If InStrRev(stFileName, " (") > 0 Then
'      stFileName = Left(stFileName, InStrRev(stFileName, " (") - 1) '檔名必須+.副檔名
'   End If
'   'Modify By Sindy 2013/10/8 此程式段有點問題
'   If InStrRev(stFileName, ".") > 0 Then
'      stFileName = Left(stFileName, InStrRev(stFileName, ".") - 1)
'   End If
'   stFileName2 = Right(stReNameFile, Len(stReNameFile) - (InStrRev(stReNameFile, ".")) + 1) '副檔名
'   '2013/10/8 END
   'Added by Lydia 2020/01/17 排除FCP的English_vers
   'Modified by Lydia 2020/02/17 +P案(FMP案)
   'Modified by Lydia 2020/03/03 + 專利案件
   'If (strCP01 = "FCP" Or strCP01 = "P") And strCP10 = cntEnglish_Vers Then
   If (strCP01 = "FCP" Or strCP01 = "P") And (strCP10 = cntEnglish_Vers Or strCP10 = cnt專利案件) Then
      '可上傳PDF
   Else
       If chkQueryKind = True Then
          If intQueryKind = 0 Then '原始檔
             If UCase(stFileName2) = ".PDF" Then
                strErr = stReNameFile & vbCrLf & vbCrLf & "原始檔不可存放.PDF檔"
                If bolShowMsg = True Then
                   MsgBox strErr
                End If
                PUB_GetEmpFlowReNameFile = False
                Exit Function
             End If
          'Modify By Sindy 2015/5/26 開放可以放其他檔案類型
    '      Else '卷宗區
    '         If UCase(stFileName2) <> ".PDF" Then
    '            strErr = stReNameFile & vbCrLf & vbCrLf & "卷宗區只可存放.PDF檔"
    '            If bolShowMsg = True Then
    '               MsgBox strErr
    '            End If
    '            PUB_GetEmpFlowReNameFile = False
    '            Exit Function
    '         End If
          End If
       End If
   End If 'end 2020/01/17
   
   'Modify By Sindy 2014/7/24
'   strFileCase = Trim(strCP01) & Val(Trim(strCP02)) & _
'                 IIf(Val(Trim(strCP03)) = 0, "", "-" & strCP03) & _
'                 IIf(Val(Trim(strCP04)) = 0, "", "-" & Format(strCP04, "00"))
   'Modified by Lydia 2019/06/04 參考FCT-6586-T的發文無法匯入卷宗區的問題
   'strFileCase = Trim(strCP01) & Val(Trim(strCP02)) & _
                 IIf(Val(Trim(strCP03)) = 0 And Val(Trim(strCP04)) = 0, "", "-" & strCP03) & _
                 IIf(Val(Trim(strCP04)) = 0, "", "-" & Format(strCP04, "00"))
  'Memo by Lydia 2019/12/04 本所案號: 系統別+簡化流水號
  strFileCase = Trim(strCP01) & Val(Trim(strCP02)) & _
                 IIf(Trim(strCP03) & Trim(strCP04) <> "" And Trim(strCP03) & Trim(strCP04) <> "000", "-" & strCP03, "") & _
                 IIf(Trim(strCP04) <> "" And Trim(strCP04) <> "00", "-" & Format(strCP04, "00"), "")
   '2014/7/24 END
   'Add By Sindy 2015/9/10
   'Modified by Lydia 2019/06/04 參考FCT-6586-T的發文無法匯入卷宗區的問題
   'strFileCase2 = Trim(strCP01) & Trim(strCP02) & _
                 IIf(Val(Trim(strCP03)) = 0 And Val(Trim(strCP04)) = 0, "", "-" & strCP03) & _
                 IIf(Val(Trim(strCP04)) = 0, "", "-" & Format(strCP04, "00"))
   'Modified by Lydia 2019/12/04 統一卷宗區的檔名之本所案號 => 本所案號: 系統別+完整流水號
   'strFileCase2 = Trim(strCP01) & Trim(strCP02) & _
                 IIf(Trim(strCP03) & Trim(strCP04) <> "" And Trim(strCP03) & Trim(strCP04) <> "000", "-" & strCP03, "") & _
                 IIf(Trim(strCP04) <> "" And Trim(strCP04) <> "00", "-" & Format(strCP04, "00"), "")
   strFileCase2 = Trim(strCP01) & Format(Val(strCP02), "000000") & _
                 IIf(Trim(strCP03) & Trim(strCP04) <> "" And Trim(strCP03) & Trim(strCP04) <> "000", "-" & strCP03, "") & _
                 IIf(Trim(strCP04) <> "" And Trim(strCP04) <> "00", "-" & Format(strCP04, "00"), "")
   '2015/9/10 END
   
   'Modify By Sindy 2018/11/1 ex:P-120707.1213.CN207518380U.PDF 會錯誤變成 P1207077.1213.CN207518380U.PDF
   strArea1 = Mid(stReNameFile, 1, InStr(stReNameFile, ".") - 1)
   If InStr(strArea1, strCP01) = 0 Or InStr(strArea1, Val(strCP02)) = 0 Then '第一區不是案號,全歸第2區
      strArea1 = strFileCase2
      strArea2 = stReNameFile
      stReNameFile = strArea1 & "." & strArea2
   Else
      strArea2 = Mid(stReNameFile, InStr(stReNameFile, "."))
      stReNameFile = Replace(strArea1, Trim(strCP01) & "-", Trim(strCP01), , 1) & strArea2
   End If
   '2018/11/1 END
   
   '更名
   'If InStr(UCase(stFileName), UCase(strFileCase & "." & strCP10)) = 0 Then 'Remove by Lydia 2019/12/04
'      If UCase(Right(stFileName, Len("DWG.PDF"))) = "DWG.PDF" Then
'         stReNameFile = Left(stFileName, Len(stFileName) - Len("DWG.PDF")) & "." & strCP10 & ".DWG.PDF"
'      Else
'         stReNameFile = Left(stFileName, InStrRev(stFileName, ".") - 1) & "." & strCP10 & stFileName2
'      End If
      'Modify By Sindy 2015/9/4 ex.P098891.rjn.doc (140 KB) #20150904152626#
      'stReNameFile = strFileCase & "." & strCP10 & "." & Mid(stReNameFile, Len(strFileCase) + 1)
      'stReNameFile = strFileCase & "." & strCP10 & Mid(stReNameFile, InStr(stReNameFile, ".")) '案號後沒加.會有問題
      'Modify By Sindy 2015/9/10 ex.P111864dwg.pdf
      If InStr(UCase(stReNameFile), UCase(strFileCase2)) > 0 Then '電子檔名本所案號第2字區有輸足6碼
         'Modify By Sindy 2015/10/30
         If InStr(UCase(stReNameFile), UCase("." & strCP10 & ".")) > 0 Then
            'Modified by Lydia 2019/12/04 統一卷宗區的檔名之本所案號 => 本所案號: 系統別+完整流水號
            'stReNameFile = strFileCase & Mid(stReNameFile, Len(strFileCase2) + 1)
            stReNameFile = strFileCase2 & Mid(stReNameFile, Len(strFileCase2) + 1)
         Else
         '2015/10/30 END
            'Modified by Lydia 2019/12/04 統一卷宗區的檔名之本所案號 => 本所案號: 系統別+完整流水號
            'stReNameFile = strFileCase & "." & strCP10 & "." & Mid(stReNameFile, Len(strFileCase2) + 1)
            'Add By Sindy 2020/5/15 沒有傳入案件性質
            If strCP10 = "" Then
               '玲玲提維持原檔名,不要加點 ex:P131916.dwg.pdf; 因申請書裡是 P131916dwg.pdf 要一致
               'stReNameFile = strFileCase2 & "." & Mid(stReNameFile, Len(strFileCase2) + 1)
               stReNameFile = strFileCase2 & Mid(stReNameFile, Len(strFileCase2) + 1)
            Else
            '2020/5/15 END
               stReNameFile = strFileCase2 & "." & strCP10 & "." & Mid(stReNameFile, Len(strFileCase2) + 1)
            End If
         End If
      Else
         'Modify By Sindy 2015/10/30
         If InStr(UCase(stReNameFile), UCase("." & strCP10 & ".")) > 0 Then
            'Modified by Lydia 2019/12/04 統一卷宗區的檔名之本所案號 => 本所案號: 系統別+完整流水號
            'stReNameFile = strFileCase & Mid(stReNameFile, Len(strFileCase) + 1)
            stReNameFile = strFileCase2 & Mid(stReNameFile, Len(strFileCase) + 1)
         Else
         '2015/10/30 END
            'Modified by Lydia 2019/12/04 統一卷宗區的檔名之本所案號 => 本所案號: 系統別+完整流水號
            'stReNameFile = strFileCase & "." & strCP10 & "." & Mid(stReNameFile, Len(strFileCase) + 1)
            'Add By Sindy 2020/5/15 沒有傳入案件性質
            If strCP10 = "" Then
               '玲玲提維持原檔名,不要加點 ex:P131916.dwg.pdf; 因申請書裡是 P131916dwg.pdf 要一致
               'stReNameFile = strFileCase2 & "." & Mid(stReNameFile, Len(strFileCase) + 1)
               stReNameFile = strFileCase2 & Mid(stReNameFile, Len(strFileCase) + 1)
            Else
            '2020/5/15 END
               stReNameFile = strFileCase2 & "." & strCP10 & "." & Mid(stReNameFile, Len(strFileCase) + 1)
            End If
         End If
      End If
      '2015/9/4 END
   'End If 'Remove by Lydia 2019/12/04
   
   'Modified by Lydia 2020/01/20 抽出，更換檔名的符號
'   stReNameFile = Replace(stReNameFile, "..", ".")
'   'Modify By Sindy 2014/1/17 Mark, 因P-107213判發時有_data.pdf和.data.pdf這二個是不同的檔案
'   '                          若下列程式replace掉,就反而會變誤歸檔或少歸檔的問題
'   '先不Mark,雅娟說會請程序留下正確的檔案即可
'   stReNameFile = Replace(stReNameFile, ". ", ".") 'Add By Sindy 2014/11/27
'   stReNameFile = Replace(stReNameFile, " .", ".") 'Add By Sindy 2014/11/27
'   stReNameFile = Replace(stReNameFile, "._", ".") 'Add By Sindy 2013/11/18
'   stReNameFile = Replace(stReNameFile, "_.", ".") 'Add By Sindy 2014/11/27
'   stReNameFile = Replace(stReNameFile, ".-", ".") 'Add By  /18
'   stReNameFile = Replace(stReNameFile, "-.", ".") 'Add By Sindy 2014/11/27
'   stReNameFile = Replace(stReNameFile, " ", ".") 'Add By Sindy 2017/1/26
'   stReNameFile = Replace(stReNameFile, "　", ".") 'Add By Sindy 2017/1/26
'   stReNameFile = Replace(stReNameFile, "'", "") 'Add By Sindy 2018/2/1 去掉'因為後面程式再讀寫資料時SQL判斷較麻煩
   stReNameFile = PUB_GetReNameFileSignal(stReNameFile)
   'end 2020/01/20
   
   'Add Sindy 2015/5/26 案件性質的副檔名
   If strSecName <> "" Then
      If InStr(UCase(stReNameFile), UCase("." & strSecName)) = 0 Then
         '取得檔名
         bolGetFileName = False: intRow = 0
         strFileCase = Left(stReNameFile, InStrRev(stReNameFile, ".") - 1)
         Do While bolGetFileName = False
            If strSecName = EMP_客戶資料 Then
               stReNameFile = strFileCase & "." & strSecName & IIf(intRow > 0, intRow, "") & stFileName2
            Else
               stReNameFile = strFileCase & IIf(intRow > 0, "." & intRow, "") & "." & strSecName & stFileName2
            End If
            '檢查檔案是否已存在
            If strCP09 <> "" Then
               strTmp = "select cpp02" & _
                        " From casepaperpdf" & _
                        " where cpp01='" & strCP09 & "'" & _
                        " and upper(cpp02)='" & UCase(stReNameFile) & "'"
               intA = 1
               Set rsAD = ClsLawReadRstMsg(intA, strTmp)
               If intA = 0 Then
                  bolGetFileName = True
                  If strSecName = EMP_客戶資料 Then
                     Call PUB_InsEfileCaption(strCP01, EMP_客戶資料, intRow) '檢查是否有需要新增電子檔次要副檔名說明
                  End If
                  Exit Do
               End If
            Else
               bolGetFileName = True
               Exit Do
            End If
            intRow = intRow + 1
         Loop
      End If
   End If
   '2015/5/26 END
   
   Set rsAD = Nothing 'Added by Lydia 2024/05/15
End Function

'Added by Lydia 2020/01/20 更換檔名的符號(從電子承辦簽核檔案更名規則PUB_GetEmpFlowReNameFile抽出)
Public Function PUB_GetReNameFileSignal(ByVal pFileName As String) As String
Dim stMidName As String
   
   stMidName = pFileName
   stMidName = Replace(stMidName, "...", ".") 'Add By Sindy 2025/10/21
   stMidName = Replace(stMidName, "..", ".")
   'Modify By Sindy 2014/1/17 Mark, 因P-107213判發時有_data.pdf和.data.pdf這二個是不同的檔案
   '                          若下列程式replace掉,就反而會變誤歸檔或少歸檔的問題
   '先不Mark,雅娟說會請程序留下正確的檔案即可
   stMidName = Replace(stMidName, ". ", ".") 'Add By Sindy 2014/11/27
   stMidName = Replace(stMidName, " .", ".") 'Add By Sindy 2014/11/27
   stMidName = Replace(stMidName, "._", ".") 'Add By Sindy 2013/11/18
   stMidName = Replace(stMidName, "_.", ".") 'Add By Sindy 2014/11/27
   stMidName = Replace(stMidName, ".-", ".") 'Add By Sindy 2013/11/18
   stMidName = Replace(stMidName, "-.", ".") 'Add By Sindy 2014/11/27
   stMidName = Replace(stMidName, " ", ".") 'Add By Sindy 2017/1/26
   stMidName = Replace(stMidName, "　", ".") 'Add By Sindy 2017/1/26
   stMidName = Replace(stMidName, "'", "") 'Add By Sindy 2018/2/1 去掉'因為後面程式再讀寫資料時SQL判斷較麻煩
   PUB_GetReNameFileSignal = stMidName
End Function

'Removed by Morgan 2015/5/27 不再使用
''Added by Sindy 2013/5/10 電子承辦案件文件原始檔要Copy一份電子檔至Server
'Public Function PUB_CopyCasePaperFileToServer(ByVal m_StrSQL As String, ByVal strErrFilePath As String, _
'                                              ByRef strErrFile As String, ByRef iFiles As Integer, ByRef strErrCode As String) As Boolean
'Dim stAttPath As String
'Dim lngSize As Long, iFileNo As Integer, bytes() As Byte
'Dim strCaseNo As String, strCP10 As String
'Dim fso As New Scripting.FileSystemObject
'Dim strServerPath As String
'Dim m_PrintRpt As Boolean
'Dim ff1 As Integer
'Dim strAttachPath As String
'
'On Error GoTo ErrHnd
'
'   PUB_CopyCasePaperFileToServer = False
'   strServerPath = "\\pat1\c\sindy"
'   m_PrintRpt = False
'
'   strAttachPath = App.path & "\SeminarAttach"
'   If Dir(strAttachPath, vbDirectory) = "" Then
'      MkDir strAttachPath
'   End If
'   '清除路徑下電子檔
'   If Dir(strAttachPath & "\.") <> "" Then
'      Kill strAttachPath & "\*.*"
'   End If
'
'   'm_strSql可以依發文日或總收文號
'   If Trim(m_StrSQL) = "" Then
'      'MsgBox "沒有查詢條件，不可執行此作業"
'      strErrCode = strErrCode & "沒有查詢條件，不可執行此作業"
'      Exit Function
'   End If
'
'   If Not fso.FolderExists(strServerPath) Then
'      fso.CreateFolder strServerPath
'   End If
'   If Not fso.FolderExists(strServerPath & "\0CFP") Then
'      fso.CreateFolder strServerPath & "\0CFP"
'   End If
'   If Not fso.FolderExists(strServerPath & "\0CFP\CFP檔案備份") Then
'      fso.CreateFolder strServerPath & "\0CFP\CFP檔案備份"
'   End If
'
'   '查詢案件文件原始檔
'   strExc(0) = "select cp01,cp02,cp03,cp04,cp10,cpf02,cpf03,cpf04 from CaseProgress,CasePaperFile where cp01 in('P','CFP') " & m_StrSQL & " and cp27 is not null and cp57 is null and cp09=cpf01 and (cpf10 is null or cpf10='X')" & _
'               " order by cp01,cp02,cp03,cp04 asc"
'   intI = 1
'   Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
'   If intI = 1 Then
'      With RsTemp
'         .MoveFirst
'         strCaseNo = "": strCP10 = ""
'         Do While Not .EOF
'            If strCaseNo <> .Fields("cp01") & .Fields("cp02") & .Fields("cp03") & .Fields("cp04") Then
'               If strCaseNo <> "" Then
'                  '上傳電子檔至Server
'                  If PUB_EMPFileCopyToServer(strServerPath, strAttachPath, strCaseNo, strCP10, strErrFilePath, strErrFile, iFiles, m_PrintRpt, ff1, strErrCode) = True Then
'                     PUB_CopyCasePaperFileToServer = True
'                  Else
'                     strErrCode = strErrCode & "，檔案備份失敗!!!"
'                     If m_PrintRpt = True Then Close ff1
'                     Exit Function
'                  End If
'               End If
'               '清除路徑下電子檔
'               If Dir(strAttachPath & "\.") <> "" Then
'                  Kill strAttachPath & "\*.*"
'               End If
'               strCaseNo = .Fields("cp01") & .Fields("cp02") & .Fields("cp03") & .Fields("cp04")
'               strCP10 = .Fields("cp10")
'            End If
'
'On Error GoTo ErrHnd1
'            '下載附件
'            stAttPath = strAttachPath & "\" & .Fields("cpf02")
'            With RsTemp
'               lngSize = Val(.Fields("cpf03").Value)
'               ReDim bytes(lngSize)
'               If lngSize > 0 Then bytes() = .Fields("cpf04").GetChunk(lngSize)
'            End With
'            iFileNo = FreeFile
'            Open stAttPath For Binary Access Write As #iFileNo
'            If lngSize > 0 Then Put #iFileNo, , bytes()
'            Close #iFileNo
'
'            .MoveNext
'         Loop
'         If strCaseNo <> "" Then
'            '上傳電子檔至Server
'            If PUB_EMPFileCopyToServer(strServerPath, strAttachPath, strCaseNo, strCP10, strErrFilePath, strErrFile, iFiles, m_PrintRpt, ff1, strErrCode) = True Then
'               PUB_CopyCasePaperFileToServer = True
'            Else
'               strErrCode = strErrCode & "，檔案備份失敗!!!"
'               If m_PrintRpt = True Then Close ff1
'               Exit Function
'            End If
'         End If
'      End With
'      If m_PrintRpt = True Then Close ff1
'   End If
'
'   Exit Function
'
'ErrHnd:
'   'MsgBox Err.Description, vbCritical
'   strErrCode = strErrCode & Err.Description
'   Exit Function
'
'ErrHnd1:
'   'MsgBox Err.Description, vbCritical
'   strErrCode = strErrCode & Err.Description
'   If iFileNo > 0 Then Close #iFileNo
'   Exit Function
'End Function

Public Function PUB_EMPFileCopyToServer(strServerPath As String, strAttachPath As String, strCaseNo As String, strCP10 As String, _
                                        strErrFilePath As String, ByRef strErrFile As String, ByRef iFiles As Integer, _
                                        ByRef m_PrintRpt As Boolean, ByRef ff1 As Integer, ByRef strErrCode As String) As Boolean
Dim fso As New Scripting.FileSystemObject
Dim fdr As Scripting.Folder
Dim fl As Scripting.File
Dim sFdName As String
Dim sFdName2 As String
Dim sDestination As String
Dim strTmpFolder As String, jj As Integer
Dim strNewName As String, strFileType As String, strTemp As String
   
On Error GoTo ErrHnd2
   
   PUB_EMPFileCopyToServer = False
   sDestination = ""
   Select Case UCase(Left(strCaseNo, 3))
      Case "CFP"
         sFdName = CStr(Val(Mid(strCaseNo, 4, 3)))
         sDestination = "\0CFP\CFP檔案備份\" & sFdName & "000"
      Case Else
         If UCase(Left(strCaseNo, 1)) = "P" And IsNumeric(Mid(strCaseNo, 2, 1)) = True Then
            sFdName = CStr(Val(Mid(strCaseNo, 2, 3)))
            sFdName2 = Mid(strCaseNo, 5, 3)
            If IsNumeric(sFdName) And IsNumeric(sFdName2) Then
               'Remove by Morgan 2011/3/30 改用Mirror方式備份
               If Not fso.FolderExists(strServerPath & "\" & sFdName) Then
                  'Morgan 2011/8/15 考慮權限問題先在 C:\99 內建子資料夾再搬到 C: 這樣權限才會繼承
                  If fso.FolderExists("\\pat1\C\99") Then
                     For jj = 1 To 10000
                        strTmpFolder = "\\pat1\C\99\" & sFdName & jj
                        If Not fso.FolderExists(strTmpFolder) Then
                           fso.CreateFolder strTmpFolder
                           fso.MoveFolder strTmpFolder, strServerPath & "\" & sFdName
                           Exit For
                        End If
                     Next
                  Else
                     fso.CreateFolder strServerPath & "\" & sFdName
                  End If
               End If
               
               '18000以後才要分子目錄
               If Val(sFdName) >= 18 Then
                  Select Case Left(sFdName2, 1)
                     Case 0, 1, 2
                        sFdName2 = "000"
                     Case 3, 4, 5
                        sFdName2 = "300"
                     Case 6, 7, 8
                        sFdName2 = "600"
                     Case Else
                        sFdName2 = "900"
                  End Select
               End If
               sDestination = sFdName & "\" & sFdName2
            End If
         End If
   End Select
   Set fdr = fso.GetFolder(strAttachPath)
   For Each fl In fdr.files
      If sDestination <> "" Then
         If Not fso.FolderExists(strServerPath & "\" & sDestination) Then
            fso.CreateFolder strServerPath & "\" & sDestination
         End If
         '檢查Server上是否已有此檔案,若無,則直接Move
         If Not fso.FileExists(strServerPath & "\" & sDestination & "\" & fl.Name) Then
            PUB_EMPFileCopyToServer = True
            fl.Move strServerPath & "\" & sDestination & "\"
         Else
            '檔案重覆時,更名(原檔名後面加序號)再Move
            iFiles = iFiles + 1
            strTemp = Left(fl.Name, InStrRev(fl.Name, ".") - 1)
            strFileType = Right(fl.Name, Len(fl.Name) - Len(strTemp))
            For jj = 1 To 10000
               strNewName = strTemp & "." & CStr(jj) & strFileType
               If Not fso.FileExists(strServerPath & "\" & sDestination & "\" & strNewName) Then
                  PUB_EMPFileCopyToServer = True
                  fl.Move strServerPath & "\" & sDestination & "\" & strNewName
                  '記錄文字檔
                  If m_PrintRpt = False Then
                     m_PrintRpt = True
                     If ff1 > 0 Then Close #ff1
                     ff1 = FreeFile
                     strErrFile = strErrFilePath & Left(strSrvDate(2), 3) & "年" & Mid(strSrvDate(2), 4, 2) & "月" & Right(strSrvDate(2), 2) & "日PAT1自動備份檔案重覆更名通知.txt"
                     Open strErrFile For Output As ff1
                  End If
                  Print #ff1, strCaseNo & vbTab & strTemp & strFileType & vbTab & fl.DateLastModified & vbTab & (fl.Size / 1024) & "KB ==> " & strNewName
                  Exit For
               End If
            Next jj
         End If
      End If
   Next
   
   Exit Function
   
ErrHnd2:
   'AlertMsg "轉檔錯誤：" & fl.Name & vbCrLf & "-->" & Err.Description
   'MsgBox Err.Description, vbCritical
   strErrCode = strErrCode & Err.Description
   Exit Function
End Function

'Modify By Sindy 2013/5/15 改成共用函數
'加註by sonia 2017/8/3 爭議案來函應剔除之來函性質:
'  1005延期受理、1202 核駁前先行通知、1203通知準備程序、1204通知言詞辯論、1401延長審查時間、1607 爭議受理、1611 對方延期、1614 被禁止處分、1615 取消被禁止處分
'Add By Sindy 2012/5/7 爭議案件性質[AutoBatchDay也有此段程式]
Public Sub PUB_GetTMdebate()
   CheckOC3
   AdoRecordSet3.CursorLocation = adUseClient
   'Modify By Sindy 2012/7/5 增加剔除'204','205','207','306','307','310','614','615'
   AdoRecordSet3.Open "select sg03 from staff_group where sg02='FCT' and sg01='C1' and substr(sg03,4) is null" & _
                      " and sg03 not in('204','205','207','303','305','306','307','310','614','615','706','722')", _
                      cnnConnection, adOpenStatic, adLockReadOnly
   TMdebate = ""
   If AdoRecordSet3.RecordCount > 0 Then
     AdoRecordSet3.MoveFirst
     Do While Not AdoRecordSet3.EOF
        TMdebate = TMdebate & AdoRecordSet3.Fields(0) & ","
        AdoRecordSet3.MoveNext
     Loop
     TMdebate = Left(TMdebate, Len(TMdebate) - 1)
   End If
End Sub

Public Function PUB_ChangeZIPToSir(strText As String) As String
Dim i As Integer
   
   PUB_ChangeZIPToSir = "": strText = Trim(strText)
   If strText = "" Then Exit Function
   
   For i = 1 To Len(strText)
      'Modify By Sindy 2021/12/13 取消 Chr(ChangeZIP(Asc(Mid(strText, i, 1))))
      '                           改為 StrConv(Mid(strText, i, 1), vbWide)
      'Modify by Amy 2022/03/31 判斷是Ascii32~126才轉,避免變?號 ex:X85725 「金本」
      If AscW(Mid(strText, i, 1)) >= 32 And AscW(Mid(strText, i, 1)) <= 126 Then
        PUB_ChangeZIPToSir = PUB_ChangeZIPToSir & StrConv(Mid(strText, i, 1), vbWide)
      Else
        PUB_ChangeZIPToSir = PUB_ChangeZIPToSir & Mid(strText, i, 1)
      End If
   Next i
   If PUB_ChangeZIPToSir = "" Then
      PUB_ChangeZIPToSir = strText
   End If
End Function

'Add By Sindy 2013/5/16 傳入地址轉換郵遞區號
Public Function PUB_AddrChangeZIPCode(ByRef strAddrText As String, Optional ByRef bolRunResult As Boolean, Optional bolSaveTempYn As Boolean = True) As String
Dim Rs As ADODB.Recordset
Dim intCount As Integer, strSqlText As String
Dim ii As Integer
Dim strText As String, strCode3 As String, strCode5 As String
Dim intFind1 As Integer, intFind2 As Integer
Dim strUpdAddrText As String
Dim strCompAddrText As String 'Add By Sindy 2018/8/31 用來比對的地址
Dim strTmp As String, intA As Integer  'Added by Lydia 2024/05/14

On Error GoTo ErrHnd
   
   bolRunResult = False
   PUB_AddrChangeZIPCode = "": strAddrText = Trim(strAddrText)
   If strAddrText = "" Then Exit Function
   strUpdAddrText = strAddrText
   strCompAddrText = strAddrText 'Add By Sindy 2018/8/31 用來比對的地址; strAddrText:是要回傳正確的地址給User使用之
   
   '地址有東沙群島、南沙群島、釣魚台字樣者，直接以東沙群島、南沙群島、釣魚台抓zipcode
   strText = ""
   If InStr(strCompAddrText, "東沙群島") > 0 Then
      strText = "東沙群島"
   ElseIf InStr(strCompAddrText, "南沙群島") > 0 Then
      strText = "南沙群島"
   ElseIf InStr(strCompAddrText, "釣魚台") > 0 Then
      strText = "釣魚台"
   End If
   If strText <> "" Then
      strTmp = "select pzd01 from postzipdata where pzd03='" & strText & "'"
      intA = 1
      Set Rs = ClsLawReadRstMsg(intA, strTmp)
      If intA = 1 Then
         PUB_AddrChangeZIPCode = Rs.Fields(0)
         GoTo RunEnd
      End If
   End If
   
   '比對縣市鄉鎮新舊名稱
   strAddrText = ReplaceAddr(strAddrText): strCompAddrText = strAddrText
   
   intCount = Empty
   strSqlText = ""
FindZipAgain:
   '*************************************
   '截取段、路、街等字，前面的字元比對
   '*************************************
   For ii = 1 To 3
      If ii = 1 Then strText = "段"
      If ii = 2 Then strText = "路"
      If ii = 3 Then strText = "街"
      If InStr(strCompAddrText, strText) > 0 Then
         '縣巿+鄉鎮+街道
         'Modify By Sindy 2014/3/17 因造字{select pzd01 from postzipdata where pzd02||pzd03||pzd04='彰化縣溪湖鎮大庭里３鄰崙子鷒'}會出現錯誤。ORA-01756: 引號字串未以恰當方式終止
         'strtmp = "select pzd01 from postzipdata where pzd02||pzd03||pzd04='" & PUB_ChangeZIPToSir(Left(strCompAddrText, InStr(strCompAddrText, strText))) & "'"
         strTmp = "select pzd01 from postzipdata where pzd02||pzd03||pzd04=rtrim('" & PUB_ChangeZIPToSir(Left(strCompAddrText, InStr(strCompAddrText, strText))) & " ')"
         intA = 1
         Set Rs = ClsLawReadRstMsg(intA, strTmp)
         If intA = 1 Then
            If Rs.RecordCount = 1 Then
               PUB_AddrChangeZIPCode = Rs.Fields(0)
            Else
               If ChkLeft3IsSame(Rs, strText) = True Then PUB_AddrChangeZIPCode = strText '檢查前3碼是否一樣
            End If
            intCount = Rs.RecordCount
            strSqlText = strTmp
            GoTo RunEnd
         End If
         '縣巿+街道
         'Modify By Sindy 2014/3/17 因造字
         'strtmp = "select pzd01 from postzipdata where pzd02||pzd04='" & PUB_ChangeZIPToSir(Left(strCompAddrText, InStr(strCompAddrText, strText))) & "'"
         strTmp = "select pzd01 from postzipdata where pzd02||pzd04=rtrim('" & PUB_ChangeZIPToSir(Left(strCompAddrText, InStr(strCompAddrText, strText))) & " ')"
         intA = 1
         Set Rs = ClsLawReadRstMsg(intA, strTmp)
         If intA = 1 Then
            If Rs.RecordCount = 1 Then
               PUB_AddrChangeZIPCode = Rs.Fields(0)
            Else
               If ChkLeft3IsSame(Rs, strText) = True Then PUB_AddrChangeZIPCode = strText '檢查前3碼是否一樣
            End If
            intCount = Rs.RecordCount
            strSqlText = strTmp
            GoTo RunEnd
         End If
         '鄉鎮+街道
         'Modify By Sindy 2014/3/17 因造字
         'strtmp = "select pzd01 from postzipdata where pzd03||pzd04='" & PUB_ChangeZIPToSir(Left(strCompAddrText, InStr(strCompAddrText, strText))) & "'"
         strTmp = "select pzd01 from postzipdata where pzd03||pzd04=rtrim('" & PUB_ChangeZIPToSir(Left(strCompAddrText, InStr(strCompAddrText, strText))) & " ')"
         intA = 1
         Set Rs = ClsLawReadRstMsg(intA, strTmp)
         If intA = 1 Then
            If Rs.RecordCount = 1 Then
               PUB_AddrChangeZIPCode = Rs.Fields(0)
            Else
               If ChkLeft3IsSame(Rs, strText) = True Then PUB_AddrChangeZIPCode = strText '檢查前3碼是否一樣
            End If
            intCount = Rs.RecordCount
            strSqlText = strTmp
            GoTo RunEnd
         End If
         '縣巿(前2個字)+鄉鎮+街道
         'Modify By Sindy 2014/3/17 因造字
         'strtmp = "select pzd01 from postzipdata where substr(pzd02,1,2)||pzd03||pzd04='" & PUB_ChangeZIPToSir(Left(strCompAddrText, InStr(strCompAddrText, strText))) & "'"
         strTmp = "select pzd01 from postzipdata where substr(pzd02,1,2)||pzd03||pzd04=rtrim('" & PUB_ChangeZIPToSir(Left(strCompAddrText, InStr(strCompAddrText, strText))) & " ')"
         intA = 1
         Set Rs = ClsLawReadRstMsg(intA, strTmp)
         If intA = 1 Then
            If Rs.RecordCount = 1 Then
               PUB_AddrChangeZIPCode = Rs.Fields(0)
            Else
               If ChkLeft3IsSame(Rs, strText) = True Then PUB_AddrChangeZIPCode = strText '檢查前3碼是否一樣
            End If
            intCount = Rs.RecordCount
            strSqlText = strTmp
            GoTo RunEnd
         End If
         '縣巿(前2個字)+街道
         'Modify By Sindy 2014/3/17 因造字
         'strtmp = "select pzd01 from postzipdata where substr(pzd02,1,2)||pzd04='" & PUB_ChangeZIPToSir(Left(strCompAddrText, InStr(strCompAddrText, strText))) & "'"
         strTmp = "select pzd01 from postzipdata where substr(pzd02,1,2)||pzd04=rtrim('" & PUB_ChangeZIPToSir(Left(strCompAddrText, InStr(strCompAddrText, strText))) & " ')"
         intA = 1
         Set Rs = ClsLawReadRstMsg(intA, strTmp)
         If intA = 1 Then
            If Rs.RecordCount = 1 Then
               PUB_AddrChangeZIPCode = Rs.Fields(0)
            Else
               If ChkLeft3IsSame(Rs, strText) = True Then PUB_AddrChangeZIPCode = strText '檢查前3碼是否一樣
            End If
            intCount = Rs.RecordCount
            strSqlText = strTmp
            GoTo RunEnd
         End If
         '鄉鎮(前2個字)+街道
         'Modify By Sindy 2014/3/17 因造字
         'strtmp = "select pzd01 from postzipdata where substr(pzd03,1,length(pzd03)-1)||pzd04='" & PUB_ChangeZIPToSir(Left(strCompAddrText, InStr(strCompAddrText, strText))) & "'"
         strTmp = "select pzd01 from postzipdata where substr(pzd03,1,length(pzd03)-1)||pzd04=rtrim('" & PUB_ChangeZIPToSir(Left(strCompAddrText, InStr(strCompAddrText, strText))) & " ')"
         intA = 1
         Set Rs = ClsLawReadRstMsg(intA, strTmp)
         If intA = 1 Then
            If Rs.RecordCount = 1 Then
               PUB_AddrChangeZIPCode = Rs.Fields(0)
            Else
               If ChkLeft3IsSame(Rs, strText) = True Then PUB_AddrChangeZIPCode = strText '檢查前3碼是否一樣
            End If
            intCount = Rs.RecordCount
            strSqlText = strTmp
            GoTo RunEnd
         End If
      End If
   Next ii
'市,縣...3碼
'市,區,鄉,鎮...2至4碼
'PZD02 PZD03
'------ --------
'台中市 大里區
'台中市 后里區
'台東縣 太麻里鄉
'台南市 佳里區
'花蓮縣 玉里鎮
'花蓮縣 富里鄉
'南投縣 水里鄉
'南投縣 埔里鎮
'屏東縣 里港鄉
'新北市 八里區
'新北市 萬里區
'嘉義縣 阿里山鄉
'選取了 12 筆資料列.
   '檢查是否有里字,若有去掉再重新找一次
   If InStrRev(strCompAddrText, "里") > 0 Then
      intFind1 = InStrRev(strCompAddrText, "里")
      intFind2 = 0
      If InStrRev(Left(strCompAddrText, 7), "鄉") > 0 Then
         intFind2 = InStrRev(Left(strCompAddrText, 7), "鄉")
      ElseIf InStrRev(Left(strCompAddrText, 7), "鎮") > 0 Then
         intFind2 = InStrRev(Left(strCompAddrText, 7), "鎮")
      ElseIf InStrRev(Left(strCompAddrText, 7), "區") > 0 Then
         intFind2 = InStrRev(Left(strCompAddrText, 7), "區")
      ElseIf InStrRev(Left(strCompAddrText, 7), "市") > 0 Then
         intFind2 = InStrRev(Left(strCompAddrText, 7), "市")
      ElseIf InStrRev(Left(strCompAddrText, 3), "縣") > 0 Then
         intFind2 = InStrRev(Left(strCompAddrText, 3), "縣")
      ElseIf InStrRev(Left(strCompAddrText, 3), "市") > 0 Then
         intFind2 = InStrRev(Left(strCompAddrText, 3), "市")
      End If
      If intFind1 > intFind2 Then
         strCompAddrText = Left(strCompAddrText, intFind2) & Mid(strCompAddrText, intFind1 + 1)
         GoTo FindZipAgain
      End If
   End If
'   '地址有宜蘭縣壯圍鄉、新北市新莊區、新竹縣寶山鄉、台南市新市區改以縣市+街道去抓(不考慮鄉鎮)
'   If InStr(strAddrText, "宜蘭縣") > 0 And InStr(strAddrText, "壯圍鄉") > 0 Then
'      strAddrText = Replace(strAddrText, "壯圍鄉", ""): strCompAddrText = strAddrText
'   End If
'   If InStr(strAddrText, "新北市") > 0 And InStr(strAddrText, "新莊區") > 0 Then
'      strAddrText = Replace(strAddrText, "新莊區", ""): strCompAddrText = strAddrText
'   End If
'   If InStr(strAddrText, "新竹縣") > 0 And InStr(strAddrText, "寶山鄉") > 0 Then
'      strAddrText = Replace(strAddrText, "寶山鄉", ""): strCompAddrText = strAddrText
'   End If
'   If InStr(strAddrText, "台南市") > 0 And InStr(strAddrText, "新市區") > 0 Then
'      strAddrText = Replace(strAddrText, "新市區", ""): strCompAddrText = strAddrText
'   End If
   '******************************
   '依前6個字比對縣巿+鄉鎮
   '******************************
   strTmp = "select pzd01 from postzipdata where pzd02||pzd03='" & Left(strCompAddrText, 6) & "'"
   intA = 1
   Set Rs = ClsLawReadRstMsg(intA, strTmp)
   If intA = 1 Then
      If Rs.RecordCount = 1 Then
         PUB_AddrChangeZIPCode = Rs.Fields(0)
      Else
         If ChkLeft3IsSame(Rs, strText) = True Then PUB_AddrChangeZIPCode = strText '檢查前3碼是否一樣
      End If
      intCount = Rs.RecordCount
      strSqlText = strTmp
      GoTo RunEnd
   End If
   '******************************
   '依前7個字比對縣巿+鄉鎮
   '******************************
   strTmp = "select pzd01 from postzipdata where pzd02||pzd03='" & Left(strCompAddrText, 7) & "'" '如:阿里山鄉有4個字
   intA = 1
   Set Rs = ClsLawReadRstMsg(intA, strTmp)
   If intA = 1 Then
      If Rs.RecordCount = 1 Then
         PUB_AddrChangeZIPCode = Rs.Fields(0)
      Else
         If ChkLeft3IsSame(Rs, strText) = True Then PUB_AddrChangeZIPCode = strText '檢查前3碼是否一樣
      End If
      intCount = Rs.RecordCount
      strSqlText = strTmp
      GoTo RunEnd
   End If
   '******************************
   '依前5個字比對縣巿+鄉鎮
   '******************************
   strTmp = "select pzd01 from postzipdata where pzd02||pzd03='" & Left(strCompAddrText, 5) & "'" '如:臺南市北區才5個字
   intA = 1
   Set Rs = ClsLawReadRstMsg(intA, strTmp)
   If intA = 1 Then
      If Rs.RecordCount = 1 Then
         PUB_AddrChangeZIPCode = Rs.Fields(0)
      Else
         If ChkLeft3IsSame(Rs, strText) = True Then PUB_AddrChangeZIPCode = strText '檢查前3碼是否一樣
      End If
      intCount = Rs.RecordCount
      strSqlText = strTmp
      GoTo RunEnd
   End If
   
   If bolSaveTempYn = True And strUpdAddrText <> "中國大陸" Then
      '更新暫存檔
      strTmp = "select * From TempAddrZipTest Where TAZAddr='" & Trim(strUpdAddrText) & "'"
      intA = 1
      Set Rs = ClsLawReadRstMsg(intA, strTmp)
      If intA = 1 Then
         strSql = "Update TempAddrZipTest set TAZID='" & strUserNum & "',TAZcode3=null,TAZcode5=null,TAZCount=null,TAZSQL=null Where TAZAddr='" & Trim(strUpdAddrText) & "'"
      Else
         strSql = "insert into TempAddrZipTest(TAZID,TAZADDR) values(" & _
                  "'" & strUserNum & "','" & Trim(strUpdAddrText) & "')"
      End If
      cnnConnection.Execute strSql
   End If
   
   Rs.Close
   Set Rs = Nothing
   Exit Function
   
RunEnd:
   bolRunResult = True
   
   If bolSaveTempYn = True And strUpdAddrText <> "中國大陸" Then
      strSqlText = Replace(strSqlText, "'", "")
      strSqlText = Mid(UCase(strSqlText), InStrRev(UCase(strSqlText), "WHERE") + 5)
      If PUB_AddrChangeZIPCode = "" Then
         strCode3 = ""
         strCode5 = ""
         If PUB_AddrChangeZIPCode <> "" Then
            If Len(PUB_AddrChangeZIPCode) = 5 Then
               strCode3 = Left(PUB_AddrChangeZIPCode, 3)
               strCode5 = PUB_AddrChangeZIPCode
            Else
               strCode3 = PUB_AddrChangeZIPCode
            End If
         End If
         '更新暫存檔
         strTmp = "select * From TempAddrZipTest Where TAZAddr='" & Trim(strUpdAddrText) & "'"
         intA = 1
         Set Rs = ClsLawReadRstMsg(intA, strTmp)
         If intA = 1 Then
            strSql = "Update TempAddrZipTest set TAZID='" & strUserNum & "',TAZcode3=" & CNULL(strCode3) & ",TAZcode5=" & CNULL(strCode5) & ",TAZCount=" & intCount & ",TAZSQL='" & strSqlText & "' Where TAZAddr='" & Trim(strUpdAddrText) & "'"
         Else
            strSql = "insert into TempAddrZipTest(TAZID,TAZcode3,TAZcode5,TAZADDR,TAZCount,TAZSQL) values(" & _
                     "'" & strUserNum & "'," & CNULL(strCode3) & "," & CNULL(strCode5) & ",'" & Trim(strUpdAddrText) & "'," & intCount & ",'" & strSqlText & "')"
         End If
      Else
         '刪除暫存檔
         strSql = "Delete From TempAddrZipTest Where TAZAddr='" & Trim(strUpdAddrText) & "'"
      End If
      cnnConnection.Execute strSql
   End If
   
   Rs.Close
   Set Rs = Nothing
   Exit Function
   
ErrHnd:
   Set Rs = Nothing
   If Err.Number <> 0 Then
      MsgBox Err.Description & strSql, vbCritical
   End If
End Function

'Add By Sindy 2013/5/31 檢查前3碼是否一樣
Public Function ChkLeft3IsSame(rs1 As ADODB.Recordset, ByRef strText As String) As Boolean
   ChkLeft3IsSame = False
   
   rs1.MoveFirst
   strText = Left(Trim(rs1.Fields(0)), 3)
   Do While Not rs1.EOF
      If strText <> Left(Trim(rs1.Fields(0)), 3) Then
         strText = ""
         Exit Function
      End If
      rs1.MoveNext
   Loop
   ChkLeft3IsSame = True
End Function

'Modify by Amy 2015/10/20 +intChoose 0:全部 / 1:只取代段 / 2:只取代工業區 / 3:只取代鄉鎮新舊名稱
'Add By Sindy 2013/5/17 比對縣市
Public Function ReplaceAddr(strAddr As String, Optional intChoose As Integer = 0, Optional ByVal stNation As String) As String
Dim Rs As ADODB.Recordset
Dim strTmp As String, intA As Integer  'Added by Lydia 2024/05/14

   If stNation > "010" Then ReplaceAddr = strAddr: Exit Function 'Add by Amy 2025/07/01

   ReplaceAddr = strAddr
   '統一取代的字元
   ReplaceAddr = Replace(ReplaceAddr, "巿", "市")
   
   'Modify By Sindy 2015/2/5 改將資料建立到newoldaddr檔案裡
'   '四都升格
'   ReplaceAddr = Replace(ReplaceAddr, "臺中縣", "台中市")
'   ReplaceAddr = Replace(ReplaceAddr, "台中縣", "台中市")
'   ReplaceAddr = Replace(ReplaceAddr, "臺北縣", "新北市")
'   ReplaceAddr = Replace(ReplaceAddr, "台北縣", "新北市")
'   ReplaceAddr = Replace(ReplaceAddr, "臺南縣", "台南市")
'   ReplaceAddr = Replace(ReplaceAddr, "台南縣", "台南市")
'   ReplaceAddr = Replace(ReplaceAddr, "高雄縣", "高雄市")
'   '取代臺字
'   ReplaceAddr = Replace(ReplaceAddr, "臺中市", "台中市")
'   ReplaceAddr = Replace(ReplaceAddr, "臺北市", "台北市")
'   ReplaceAddr = Replace(ReplaceAddr, "臺東縣", "台東縣")
'   ReplaceAddr = Replace(ReplaceAddr, "臺南市", "台南市")
'   ReplaceAddr = Replace(ReplaceAddr, "釣魚臺", "釣魚台")
'   ReplaceAddr = Replace(ReplaceAddr, "臺西鄉", "台西鄉")
'   ReplaceAddr = Replace(ReplaceAddr, "臺東市", "台東市")
'   ReplaceAddr = Replace(ReplaceAddr, "霧臺鄉", "霧台鄉")
   
   'Modify by Amy 2015/10/20 +intChoose判斷
   If intChoose = 0 Or intChoose = 1 Then
        '段
        ReplaceAddr = Replace(ReplaceAddr, "1段", "１段")
        ReplaceAddr = Replace(ReplaceAddr, "一段", "１段")
        ReplaceAddr = Replace(ReplaceAddr, "2段", "２段")
        ReplaceAddr = Replace(ReplaceAddr, "二段", "２段")
        ReplaceAddr = Replace(ReplaceAddr, "3段", "３段")
        ReplaceAddr = Replace(ReplaceAddr, "三段", "３段")
        ReplaceAddr = Replace(ReplaceAddr, "4段", "４段")
        ReplaceAddr = Replace(ReplaceAddr, "四段", "４段")
        ReplaceAddr = Replace(ReplaceAddr, "5段", "５段")
        ReplaceAddr = Replace(ReplaceAddr, "五段", "５段")
        ReplaceAddr = Replace(ReplaceAddr, "6段", "６段")
        ReplaceAddr = Replace(ReplaceAddr, "六段", "６段")
        ReplaceAddr = Replace(ReplaceAddr, "7段", "７段")
        ReplaceAddr = Replace(ReplaceAddr, "七段", "７段")
        ReplaceAddr = Replace(ReplaceAddr, "8段", "８段")
        ReplaceAddr = Replace(ReplaceAddr, "八段", "８段")
        ReplaceAddr = Replace(ReplaceAddr, "9段", "９段")
        ReplaceAddr = Replace(ReplaceAddr, "九段", "９段")
        If intChoose = 1 Then Exit Function
    End If
    If intChoose = 0 Or intChoose = 2 Then
        'xx工業區
        'Modify by Amy 2015/11/11 原程式修改至ReplaceIndAre
        ReplaceAddr = ReplaceIndArea(ReplaceAddr)
        If intChoose = 2 Then Exit Function
   End If
   
   If intChoose = 0 Or intChoose = 3 Then
        '比對對照表
        strTmp = "select * from newoldaddr"
        intA = 1
        Set Rs = ClsLawReadRstMsg(intA, strTmp)
        If intA = 1 Then
           Rs.MoveFirst
           Do While Not Rs.EOF
              ReplaceAddr = Replace(ReplaceAddr, Rs.Fields("noa01"), Rs.Fields("noa02"))
              Rs.MoveNext
           Loop
        End If
        Rs.Close
        Set Rs = Nothing
   End If
   'end 2015/10/20
End Function

Public Sub TestAddrZip()
Dim Rs As ADODB.Recordset
Dim strZip As String
Dim strErrFile As String
Dim strCompNotDataFile As String
Dim ff1 As Integer, FF2 As Integer
Dim bolRunResult As Boolean
Dim strTmp As String, intA As Integer  'Added by Lydia 2024/05/14

On Error GoTo ErrHnd
   
   strErrFile = "": strCompNotDataFile = ""
   '貝爾商標延展開拓資料
   strTmp = "select bt04,bt08 from bairetrademark"
   intA = 1
   Set Rs = ClsLawReadRstMsg(intA, strTmp)
   If intA = 1 Then
      Rs.MoveFirst
      Do While Not Rs.EOF
         If Trim("" & Rs.Fields(0)) <> "" Then
            strZip = Left(PUB_AddrChangeZIPCode(Trim("" & Rs.Fields(0)), bolRunResult), 3)
            If strZip <> "" Then
               '檢查比對是否正確
               If Trim("" & Rs.Fields(1)) <> "" Then
                  If PUB_ChangeZIPToSir(strZip) <> Left(PUB_ChangeZIPToSir(Trim("" & Rs.Fields(1))), 3) Then
                     If strErrFile = "" Then
                        strErrFile = "比對到的ZipCode錯誤_貝爾商標.txt"
                        If FF2 > 0 Then Close #FF2
                        FF2 = FreeFile
                        Open PUB_Getdesktop & "\" & strErrFile For Output As FF2
                     End If
                     Print #FF2, PUB_ChangeZIPToSir(strZip) & "　" & _
                                 PUB_ChangeZIPToSir(Trim("" & Rs.Fields(1))) & "　" & Trim("" & Rs.Fields(0))
                  End If
               End If
            ElseIf bolRunResult = False Then
               '比對不到資料
               If strCompNotDataFile = "" Then
                  strCompNotDataFile = "依地址比對不到ZipCode_貝爾商標.txt"
                  If ff1 > 0 Then Close #ff1
                  ff1 = FreeFile
                  Open PUB_Getdesktop & "\" & strCompNotDataFile For Output As ff1
               End If
               Print #ff1, Trim("" & Rs.Fields(0))
            End If
         End If
         Rs.MoveNext
      Loop
   End If
   Rs.Close
   If strCompNotDataFile <> "" Then
      Close ff1
   End If
   If strErrFile <> "" Then
      Close FF2
   End If

   strErrFile = "": strCompNotDataFile = ""
   '大陸專利公告資料
   strTmp = "select cpn08,cpn09 from chinapatentnotice"
   intA = 1
   Set Rs = ClsLawReadRstMsg(intA, strTmp)
   If intA = 1 Then
      Rs.MoveFirst
      Do While Not Rs.EOF
         If Trim("" & Rs.Fields(0)) <> "" Then
            strZip = Left(PUB_AddrChangeZIPCode(Trim("" & Rs.Fields(0)), bolRunResult), 3)
            If strZip <> "" Then
               '檢查比對是否正確
               If Trim("" & Rs.Fields(1)) <> "" Then
                  If PUB_ChangeZIPToSir(strZip) <> Left(PUB_ChangeZIPToSir(Trim("" & Rs.Fields(1))), 3) Then
                     If strErrFile = "" Then
                        strErrFile = "比對到的ZipCode錯誤_大陸專利.txt"
                        If FF2 > 0 Then Close #FF2
                        FF2 = FreeFile
                        Open PUB_Getdesktop & "\" & strErrFile For Output As FF2
                     End If
                     Print #FF2, PUB_ChangeZIPToSir(strZip) & "　" & _
                                 PUB_ChangeZIPToSir(Trim("" & Rs.Fields(1))) & "　" & Trim("" & Rs.Fields(0))
                  End If
               End If
            ElseIf bolRunResult = False Then
               '比對不到資料
               If strCompNotDataFile = "" Then
                  strCompNotDataFile = "依地址比對不到ZipCode_大陸專利.txt"
                  If ff1 > 0 Then Close #ff1
                  ff1 = FreeFile
                  Open PUB_Getdesktop & "\" & strCompNotDataFile For Output As ff1
               End If
               Print #ff1, Trim("" & Rs.Fields(0))
            End If
         End If
         Rs.MoveNext
      Loop
   End If
   Rs.Close
   If strCompNotDataFile <> "" Then
      Close ff1
   End If
   If strErrFile <> "" Then
      Close FF2
   End If

   strErrFile = "": strCompNotDataFile = ""
   '國內商標公報非本所商標權人資料
   strTmp = "select tbor05,' ' from tmbulletinowner"
   intA = 1
   Set Rs = ClsLawReadRstMsg(intA, strTmp)
   If intA = 1 Then
      Rs.MoveFirst
      Do While Not Rs.EOF
         If Trim("" & Rs.Fields(0)) <> "" Then
            strZip = Left(PUB_AddrChangeZIPCode(Trim("" & Rs.Fields(0)), bolRunResult), 3)
            If strZip <> "" Then
               '檢查比對是否正確
               If Trim("" & Rs.Fields(1)) <> "" Then
                  If PUB_ChangeZIPToSir(strZip) <> Left(PUB_ChangeZIPToSir(Trim("" & Rs.Fields(1))), 3) Then
                     If strErrFile = "" Then
                        strErrFile = "比對到的ZipCode錯誤_國內商標公報.txt"
                        If FF2 > 0 Then Close #FF2
                        FF2 = FreeFile
                        Open PUB_Getdesktop & "\" & strErrFile For Output As FF2
                     End If
                     Print #FF2, PUB_ChangeZIPToSir(strZip) & "　" & _
                                 PUB_ChangeZIPToSir(Trim("" & Rs.Fields(1))) & "　" & Trim("" & Rs.Fields(0))
                  End If
               End If
            ElseIf bolRunResult = False Then
               '比對不到資料
               If strCompNotDataFile = "" Then
                  strCompNotDataFile = "依地址比對不到ZipCode_國內商標公報.txt"
                  If ff1 > 0 Then Close #ff1
                  ff1 = FreeFile
                  Open PUB_Getdesktop & "\" & strCompNotDataFile For Output As ff1
               End If
               Print #ff1, Trim("" & Rs.Fields(0))
            End If
         End If
         Rs.MoveNext
      Loop
   End If
   Rs.Close
   If strCompNotDataFile <> "" Then
      Close ff1
   End If
   If strErrFile <> "" Then
      Close FF2
   End If
   
'   strErrFile = "": strCompNotDataFile = ""
'   '客戶檔
'   strtmp = "select cu31,cu30,cu01||cu02 from customer where cu31 is not null and cu10>='000' and cu10<='008' and cu82>=20090101 order by cu01,cu02 asc"
'   inta = 1
'   Set rs = ClsLawReadRstMsg(inta, strtmp)
'   If inta = 1 Then
'      rs.MoveFirst
'      Do While Not rs.EOF
'         If Trim("" & rs.Fields(0)) <> "" Then
'            strZip = Left(PUB_AddrChangeZIPCode(Trim("" & rs.Fields(0)), bolRunResult),3)
'            If strZip <> "" Then
'               '檢查比對是否正確
'               If Trim("" & rs.Fields(1)) <> "" Then
'                  If PUB_ChangeZIPToSir(strZip) <> Left(PUB_ChangeZIPToSir(Trim("" & rs.Fields(1))), 3) Then
'                     If strErrFile = "" Then
'                        strErrFile = "比對到的ZipCode錯誤_客戶檔.txt"
'                        If FF2 > 0 Then Close #FF2
'                        FF2 = FreeFile
'                        Open PUB_Getdesktop & "\" & strErrFile For Output As FF2
'                     End If
'                     Print #FF2, Trim("" & rs.Fields(2)) & "　" & PUB_ChangeZIPToSir(strZip) & "　" & _
'                                 PUB_ChangeZIPToSir(Trim("" & rs.Fields(1))) & "　" & Trim("" & rs.Fields(0))
'                  End If
'               End If
'            ElseIf bolRunResult = False Then
'               '比對不到資料
'               If strCompNotDataFile = "" Then
'                  strCompNotDataFile = "依地址比對不到ZipCode_客戶檔.txt"
'                  If ff1 > 0 Then Close #ff1
'                  ff1 = FreeFile
'                  Open PUB_Getdesktop & "\" & strCompNotDataFile For Output As ff1
'               End If
'               Print #ff1, Trim("" & rs.Fields(2)) & "　" & Trim("" & rs.Fields(0))
'            End If
'         End If
'         rs.MoveNext
'      Loop
'   End If
'   rs.Close
'   If strCompNotDataFile <> "" Then
'      Close ff1
'   End If
'   If strErrFile <> "" Then
'      Close FF2
'   End If
   
   MsgBox "測試完畢!!!"
   
ErrHnd:
   Set Rs = Nothing
   If Err.Number <> 0 Then
      MsgBox Err.Description, vbCritical
   End If
End Sub

'Add By Sindy 2013/8/13
'Modify By Sindy 2018/7/16 + , Optional ByRef strfPath As String
'Modify By Sindy 2024/2/2 + , Optional ByVal strReplaText As String: 客戶案件案號有時會加在檔名前面,要去掉再做檢查
Public Function GetFileName(ByVal FullPathFile As String, Optional ByRef strfPath As String, _
   Optional ByVal strReplaText As String) As String
Dim stItem As String, iPos As Integer
   
   stItem = FullPathFile
   iPos = InStr(stItem, "\")
   Do While iPos > 0
      stItem = Mid(stItem, iPos + 1)
      iPos = InStr(stItem, "\")
   Loop
   
   If InStr(stItem, "#") > 0 Then
      stItem = Trim(Left(stItem, InStr(stItem, "#") - 1))
      'Add By Sindy 2018/7/16
      'ex:FullPathFile="C:\97038\Promoter\SeminarAttach\A1033\2023-W65＊9-001-F.P131866-0913A.pdf (168.86 KB) #20240202095818#"
      If InStr(FullPathFile, stItem) > 0 And InStr(FullPathFile, "\") > 0 Then
         'ex:strfPath="C:\97038\Promoter\SeminarAttach\A1033"
         strfPath = Mid(FullPathFile, 1, InStr(FullPathFile, stItem) - 2) '取得檔名前的路徑
      End If
   End If
   
   'Modify By Sindy 2015/1/21
   'If InStrRev(stItem, " (") > 0 And Right(stItem, 1) = ")" Then
   If InStrRev(stItem, " (") > 0 And Right(stItem, 4) = " KB)" Then 'And InStrRev(stItem, "KB)") > 0 Then
   '2015/1/21 END
      stItem = Left(stItem, InStrRev(stItem, " (") - 1)
   End If
   
   'Add By Sindy 2024/2/2
   If strReplaText <> "" Then
      If Mid(stItem, 1, Len(strReplaText)) = strReplaText Then
         stItem = Mid(stItem, Len(strReplaText) + 2)
      End If
   End If
   '2024/2/2 END
   
   GetFileName = stItem
End Function

'Added by Morgan 2013/8/15
'是否FMP新案請款單
Public Function PUB_FMPNewCaseInvoice(p_InvNo As String) As Boolean
   Dim stSQL As String, iR As Integer
   Dim adoquery As ADODB.Recordset
   
   'Modified by Morgan 2013/8/19 只要 101,102,103 --David Ex.P105450 不用
   'stSQL = "select * from caseprogress where cp60='" & p_InvNo & "' and cp01='P' and cp12 like 'F%' and cp09<'B' and cp10 in (" & GetAddStr(NewCasePtyList) & ")"
   stSQL = "select * from caseprogress where cp60='" & p_InvNo & "' and cp01='P' and cp12 like 'F%' and cp09<'B' and cp10 in ('101','102','103')"
   iR = 1
   Set adoquery = ClsLawReadRstMsg(iR, stSQL)
   If iR = 1 Then
      PUB_FMPNewCaseInvoice = True
   End If
   Set adoquery = Nothing
End Function

'Add By Sindy 2013/8/15
'檢查案件是否要催延展
Public Function PUB_ChkCaseIsNoticeScale(strCP01 As String, strCP02 As String, strCP03 As String, strCP04 As String) As Boolean
Dim Rs As ADODB.Recordset
Dim strTM44 As String
Dim strTM23 As String, strTM78 As String, strTM79 As String, strTM80 As String, strTM81 As String
Dim strTmp As String, intA As Integer  'Added by Lydia 2024/05/14

   PUB_ChkCaseIsNoticeScale = True
   
   '設個案不催者,則一律不催
   '有FC代理人不催者,則不催
   '共同申請者,要全部申請人都不要才不催
   strTmp = "select tm01,tm02,tm03,tm04,tm23,tm78,tm79,tm80,tm81,tm44,tm129" & _
                " From Trademark" & _
               " where tm01='" & strCP01 & "' and tm02='" & strCP02 & "' and tm03='" & strCP03 & "' and tm04='" & strCP04 & "'"
   intA = 1
   Set Rs = ClsLawReadRstMsg(intA, strTmp)
   If intA = 1 Then
      If "" & Rs.Fields("tm129") = "Y" Then
         PUB_ChkCaseIsNoticeScale = False
         GoTo ExitFunc
      Else
         strTM44 = "" & Rs.Fields("tm44")
         strTM23 = "" & Rs.Fields("tm23")
         strTM78 = "" & Rs.Fields("tm78")
         strTM79 = "" & Rs.Fields("tm79")
         strTM80 = "" & Rs.Fields("tm80")
         strTM81 = "" & Rs.Fields("tm81")
      End If
      '檢查FC代理人
      If strTM44 <> "" Then
         strTmp = "select fa01,fa02,fa117" & _
                      " From Fagent" & _
                     " where fa01='" & Mid(strTM44, 1, 8) & "' and fa02='" & Mid(strTM44, 9, 1) & "'" & _
                       " and fa117='Y'"
         intA = 1
         Set Rs = ClsLawReadRstMsg(intA, strTmp)
         If intA = 1 Then
            PUB_ChkCaseIsNoticeScale = False
            GoTo ExitFunc
         End If
      End If
      '檢查申請人1
      If strTM23 <> "" Then
         strTmp = "select cu01,cu02,cu139" & _
                      " From customer" & _
                     " where cu01='" & Mid(strTM23, 1, 8) & "' and cu02='" & Mid(strTM23, 9, 1) & "'" & _
                       " and cu139='Y'"
         intA = 1
         Set Rs = ClsLawReadRstMsg(intA, strTmp)
         If intA = 1 Then
            If strTM78 = "" And strTM79 = "" And strTM80 = "" And strTM81 = "" Then
               PUB_ChkCaseIsNoticeScale = False
               GoTo ExitFunc
            End If
         Else
            GoTo ExitFunc
         End If
      End If
      '檢查申請人2
      If strTM78 <> "" Then
         strTmp = "select cu01,cu02,cu139" & _
                      " From customer" & _
                     " where cu01='" & Mid(strTM78, 1, 8) & "' and cu02='" & Mid(strTM78, 9, 1) & "'" & _
                       " and cu139='Y'"
         intA = 1
         Set Rs = ClsLawReadRstMsg(intA, strTmp)
         If intA = 1 Then
            If strTM79 = "" And strTM80 = "" And strTM81 = "" Then
               PUB_ChkCaseIsNoticeScale = False
               GoTo ExitFunc
            End If
         Else
            GoTo ExitFunc
         End If
      End If
      '檢查申請人3
      If strTM79 <> "" Then
         strTmp = "select cu01,cu02,cu139" & _
                      " From customer" & _
                     " where cu01='" & Mid(strTM79, 1, 8) & "' and cu02='" & Mid(strTM79, 9, 1) & "'" & _
                       " and cu139='Y'"
         intA = 1
         Set Rs = ClsLawReadRstMsg(intA, strTmp)
         If intA = 1 Then
            If strTM80 = "" And strTM81 = "" Then
               PUB_ChkCaseIsNoticeScale = False
               GoTo ExitFunc
            End If
         Else
            GoTo ExitFunc
         End If
      End If
      '檢查申請人4
      If strTM80 <> "" Then
         strTmp = "select cu01,cu02,cu139" & _
                      " From customer" & _
                     " where cu01='" & Mid(strTM80, 1, 8) & "' and cu02='" & Mid(strTM80, 9, 1) & "'" & _
                       " and cu139='Y'"
         intA = 1
         Set Rs = ClsLawReadRstMsg(intA, strTmp)
         If intA = 1 Then
            If strTM81 = "" Then
               PUB_ChkCaseIsNoticeScale = False
               GoTo ExitFunc
            End If
         Else
            GoTo ExitFunc
         End If
      End If
      '檢查申請人5
      If strTM81 <> "" Then
         strTmp = "select cu01,cu02,cu139" & _
                      " From customer" & _
                     " where cu01='" & Mid(strTM81, 1, 8) & "' and cu02='" & Mid(strTM81, 9, 1) & "'" & _
                       " and cu139='Y'"
         intA = 1
         Set Rs = ClsLawReadRstMsg(intA, strTmp)
         If intA = 1 Then
            PUB_ChkCaseIsNoticeScale = False
            GoTo ExitFunc
         Else
            GoTo ExitFunc
         End If
      End If
   End If
   
ExitFunc:
   Rs.Close
   Set Rs = Nothing
End Function

'Modify By Sindy 2013/8/19
'strKind : 1.IPC分類 2.產業別分類 3.案件屬性
Public Function GetPatentIPC(strKind As String, strTPB10 As String, strTPB02 As String) As String
Dim strCompareV As String
Dim bolExclude As Boolean, ii As Integer
Dim strTxt As Variant, strTxt2 As Variant
Dim strTxt2_1 As String, strTxt2_2 As String
Dim strCon As String
Dim intChkRun As Integer '至少檢查2次
Dim strTmp As String, intA As Integer, rsAD As New ADODB.Recordset 'Added by Lydia 2024/05/15

   intChkRun = 0
   GetPatentIPC = ""
   If strKind = "1" Then 'IPC分類
      strCon = " and PI01 is not null"
   ElseIf strKind = "2" Then '產業別分類
      strCon = " and PI06 is not null"
   'Modify By Sindy 2016/3/2
   Else '案件屬性
      strCon = " and PI07 is not null"
   End If
   '2016/3/2 END
   
   '先取國際分類號前3碼檢查是否有值, 若無,再取國際分類號前4碼比對
   strTmp = "SELECT * FROM PatentIPC WHERE PI02 = '" & Left(strTPB10, 3) & "'" & strCon
   intA = 1
   If rsAD.State <> adStateClosed Then rsAD.Close
   Set rsAD = ClsLawReadRstMsg(intA, strTmp)
   If intA = 0 Then
ChkRun2:
      strTmp = "SELECT * FROM PatentIPC WHERE PI02 = '" & Left(strTPB10, 4) & "'" & strCon
      intA = 1
      If rsAD.State <> adStateClosed Then rsAD.Close
      Set rsAD = ClsLawReadRstMsg(intA, strTmp)
      If intA = 0 Then
         rsAD.Close
      Else
         intChkRun = 2
      End If
   Else
      intChkRun = 1
   End If
   If rsAD.State <> adStateClosed Then
      '國際分類號樣式範本:
      'G11C11/4074
      'C07D401/12
      'A23L1/221
      '次類索引
      'Add By Sindy 2019/8/14
      If InStr(strTPB10, "/") > 0 Then
      '2019/8/14 END
         strCompareV = Trim(Mid(strTPB10, InStr(strTPB10, "/") - 2, 5))
         If IsNumeric(Left(strCompareV, 1)) = False Then
            strCompareV = Right(strCompareV, Len(strCompareV) - 1)
         End If
      End If
      rsAD.MoveFirst
      Do While Not rsAD.EOF
         '檢查PI03,PI04,PI05是否有值
         If "" & rsAD.Fields("PI03") = "" And "" & rsAD.Fields("PI04") = "" And "" & rsAD.Fields("PI05") = "" Then
            If strKind = "1" Then 'IPC分類
               GetPatentIPC = rsAD.Fields("PI01")
            ElseIf strKind = "2" Then '產業別分類
               GetPatentIPC = rsAD.Fields("PI06")
            'Add By Sindy 2016/3/2
            Else '案件屬性
               GetPatentIPC = rsAD.Fields("PI07")
            End If
            '2016/3/2 END
            Exit Do
         Else
            '專利種類
            If "" & rsAD.Fields("PI05") <> "" And GetPatentIPC = "" Then
               If (Left(strTPB02, 1) = "I" And rsAD.Fields("PI05") = "1") Or _
                  (Left(strTPB02, 1) = "M" And rsAD.Fields("PI05") = "2") Then
                  If strKind = "1" Then 'IPC分類
                     GetPatentIPC = rsAD.Fields("PI01")
                  ElseIf strKind = "2" Then '產業別分類
                     GetPatentIPC = rsAD.Fields("PI06")
                  'Add By Sindy 2016/3/2
                  Else '案件屬性
                     GetPatentIPC = rsAD.Fields("PI07")
                  End If
                  '2016/3/2 END
                  Exit Do
               End If
            End If
            'If InStr(strTPB10, "/") > 0 Then
               '除外(次類索引)
               If "" & rsAD.Fields("PI03") <> "" And GetPatentIPC = "" Then
                  bolExclude = False
                  '有幾組
                  strTxt = Split(rsAD.Fields("PI03"), ",")
                  For ii = 0 To UBound(strTxt)
                     If InStr(strTxt(ii), "-") = 0 Then
                        If IsNumeric(CStr(Replace(strTxt(ii), "/", ""))) = True Then 'ex.38,39,47/42
                           strTxt(ii) = Replace(strTxt(ii), "/", "")
                           If Left(Replace(strCompareV, "/", ""), Len(Trim(strTxt(ii)))) = Trim(strTxt(ii)) Then
                              bolExclude = True
                              Exit For
                           End If
                        Else 'ex.A01H,A01K67
                           If Left(strTPB10, Len(Trim(strTxt(ii)))) = Trim(strTxt(ii)) Then
                              bolExclude = True
                              Exit For
                           End If
                        End If
                     Else
                        '每一組的起迄區間
                        strTxt2 = Split(strTxt(ii), "-")
                        '次類索引(起)
                        strTxt2_1 = Trim(strTxt2(0))
                        '次類索引(迄)
                        strTxt2_2 = Trim(strTxt2(1))
                        If Val(Replace(strCompareV, "/", "")) >= Val(Replace(strTxt2_1, "/", "")) And _
                           Val(Replace(strCompareV, "/", "")) <= Val(Replace(strTxt2_2, "/", "")) Then
                           bolExclude = True
                           Exit For
                        End If
                     End If
                  Next ii
                  If bolExclude = False Then
                     If strKind = "1" Then 'IPC分類
                        GetPatentIPC = rsAD.Fields("PI01")
                     ElseIf strKind = "2" Then '產業別分類
                        GetPatentIPC = rsAD.Fields("PI06")
                     'Add By Sindy 2016/3/2
                     Else '案件屬性
                        GetPatentIPC = rsAD.Fields("PI07")
                     End If
                     '2016/3/2 END
                     Exit Do
                  End If
               '只含(次類索引)
               ElseIf "" & rsAD.Fields("PI04") <> "" And GetPatentIPC = "" Then
                  '有幾組
                  strTxt = Split(rsAD.Fields("PI04"), ",")
                  For ii = 0 To UBound(strTxt)
                     If InStr(strTxt(ii), "-") = 0 Then
                        If IsNumeric(CStr(Replace(strTxt(ii), "/", ""))) = True Then 'ex.38,39,47/42
                           strTxt(ii) = Replace(strTxt(ii), "/", "")
                           If Left(Replace(strCompareV, "/", ""), Len(Trim(strTxt(ii)))) = Trim(strTxt(ii)) Then
                              If strKind = "1" Then 'IPC分類
                                 GetPatentIPC = rsAD.Fields("PI01")
                              ElseIf strKind = "2" Then '產業別分類
                                 GetPatentIPC = rsAD.Fields("PI06")
                              'Add By Sindy 2016/3/2
                              Else '案件屬性
                                 GetPatentIPC = rsAD.Fields("PI07")
                              End If
                              '2016/3/2 END
                              Exit Do
                           End If
                        Else 'ex.A01H,A01K67
                           If Left(strTPB10, Len(Trim(strTxt(ii)))) = Trim(strTxt(ii)) Then
                              If strKind = "1" Then 'IPC分類
                                 GetPatentIPC = rsAD.Fields("PI01")
                              ElseIf strKind = "2" Then '產業別分類
                                 GetPatentIPC = rsAD.Fields("PI06")
                              'Add By Sindy 2016/3/2
                              Else '案件屬性
                                 GetPatentIPC = rsAD.Fields("PI07")
                              End If
                              '2016/3/2 END
                              Exit Do
                           End If
                        End If
                     Else
                        '每一組的起迄區間
                        strTxt2 = Split(strTxt(ii), "-")
                        '次類索引(起)
                        strTxt2_1 = Trim(strTxt2(0))
                        '次類索引(迄)
                        strTxt2_2 = Trim(strTxt2(1))
                        If Val(Replace(strCompareV, "/", "")) >= Val(Replace(strTxt2_1, "/", "")) And _
                           Val(Replace(strCompareV, "/", "")) <= Val(Replace(strTxt2_2, "/", "")) Then
                           If strKind = "1" Then 'IPC分類
                              GetPatentIPC = rsAD.Fields("PI01")
                           ElseIf strKind = "2" Then '產業別分類
                              GetPatentIPC = rsAD.Fields("PI06")
                           'Add By Sindy 2016/3/2
                           Else '案件屬性
                              GetPatentIPC = rsAD.Fields("PI07")
                           End If
                           '2016/3/2 END
                           Exit Do
                        End If
                     End If
                  Next ii
               End If
            'End If
         End If
         rsAD.MoveNext
      Loop
      rsAD.Close
   End If
   If intChkRun = 1 And GetPatentIPC = "" Then
      GoTo ChkRun2
   End If
   If strKind = "2" And GetPatentIPC = "" Then '產業別
      GetPatentIPC = "99" '其他
   End If
   'Add By Sindy 2016/3/2
   If strKind = "3" And GetPatentIPC = "" Then '案件屬性
      GetPatentIPC = "9" '其他
   End If
   '2016/3/2 END
   Set rsAD = Nothing 'Added by Lydia 2024/05/15
End Function

'Modify By Sindy 2013/9/4 從basPublic搬過來
'Modify by Morgan 2007/1/8 加p_CP45:彼所案號
'Modify by Morgan 2008/10/16 +p_CP44,p_CP116 若有值時為預設代理人
'Modified by Lydia 2016/10/27 +p_CP09,p_NA01,p_CU01 新案件CP31='Y'且CP44 IS NULL時，以申請人1之8碼+'1'(sk02)+申請國家抓申請人指定國外代理人檔
'Modify By Sindy 2021/7/16 改為用 Object 型態
'Public Sub AddAgent(cbo As ComboBox, ByRef strNo() As String, Optional ByRef p_CP45 As String, Optional ByVal p_CP44 As String, Optional ByVal p_CP116 As String, Optional ByVal p_CP09 As String, Optional ByVal p_NA01 As String, Optional ByVal p_CU01 As String)
Public Sub AddAgent(cbo As Object, ByRef strNo() As String, Optional ByRef p_CP45 As String, Optional ByVal p_CP44 As String, Optional ByVal p_CP116 As String, Optional ByVal p_CP09 As String, Optional ByVal p_NA01 As String, Optional ByVal p_CU01 As String)
Dim strTmp As String, intA As Integer, rsAD As New ADODB.Recordset  'Added by Lydia 2024/05/14

   cbo.Clear
   
   'Added by Lydia 2016/10/27 p_CP31 新案件CP31='Y'且CP44 IS NULL時，以申請人1之8碼+'1'(sk02)+申請國家抓申請人指定國外代理人檔
   If p_CP09 <> "" Then
      strTmp = "select caa04||'0' caa04 From caseprogress, systemkind, custassignagent " & _
                  "where cp09='" & p_CP09 & "' and cp31='Y' and cp44 is null and cp01=sk01 and sk02=caa01(+) and caa02='" & Mid(p_CU01 & "00000000", 1, 8) & "' and caa03='" & p_NA01 & "' order by 1"
                  
      intA = 1
      Set rsAD = ClsLawReadRstMsg(intA, strTmp)
      If intA = 1 Then
         rsAD.MoveFirst
         Do While Not rsAD.EOF
            cbo.AddItem rsAD(0)
            rsAD.MoveNext
         Loop
         cbo.ListIndex = 0
      End If
   End If
   'end 2016/10/27
   
   If p_CP44 <> "" Then
      cbo.AddItem ChangeCustomerS(p_CP44) & IIf(p_CP116 <> "", "-" & p_CP116, "")
      p_CP44 = ChangeCustomerL(p_CP44)
   End If
   
   'Modify by Morgan 2004/3/11
   '抓AB類收文號的代理人，預設最後發文日最大收文號的代理人
   'strtmp = "SELECT DISTINCT(CP44) FROM CASEPROGRESS WHERE CP01='" & strNo(1) & _
      "' AND CP02='" & strNo(2) & "' AND CP03='" & strNo(3) & "' AND " & _
      "CP04='" & strNo(4) & "' AND CP44 IS NOT NULL"
      
    'Modify by Morgan 2008/2/21 加聯絡人
    'Modify by Morgan 2010/2/23 香港案要排除421
    'modify by sonia 2017/5/10 排除CFT之文件簽證711及申請英文證明304
    'Modified by Morgan 2024/3/27 排除 各國專利局Y編號
    'Modified by Morgan 2024/4/11 排除P大陸案年費--郭
    'Modified by Morgan 2025/4/25 P案相關收文號是年費的也要排除--玲玲
    strTmp = "SELECT  CP44,cp116,CP45,Max(nvl(CP27,0)||CP09) Srt FROM CASEPROGRESS c1,PATENT" & _
        " WHERE CP01='" & strNo(1) & "' AND CP02='" & strNo(2) & "'" & _
        " AND CP03='" & strNo(3) & "' AND CP04='" & strNo(4) & "'" & _
        " AND CP01||CP10 NOT IN ('CFT711','CFT304') AND CP44 IS NOT NULL AND CP09<'C'" & _
        " AND PA01(+)=CP01 AND PA02(+)=CP02 AND PA03(+)=CP03 AND PA04(+)=CP04" & _
        " AND NOT (CP10='421' AND PA09='013') AND NOT (CP01='P' AND CP10='605' AND PA09='020')" & _
        " and not exists(select * from SetSpecMan where ocode='各國專利局Y編號' and instr(oman,cp44)>0)" & _
        " and not exists(select * from caseprogress c2 where cp09=c1.cp43 and cp10='605' and cp01='P')" & _
        " Group By CP44,cp116,CP45 Order By Srt desc "
        
   intA = 1
   Set rsAD = ClsLawReadRstMsg(intA, strTmp) 'edit by nickc 2007/02/05 不用 dll 了 objLawDll.ReadRstMsg(inta, strtmp)
   If intA = 1 Then
      p_CP45 = "" & rsAD.Fields("cp45")
      Do While Not rsAD.EOF
         If p_CP44 = rsAD.Fields("cp44") And p_CP116 = "" & rsAD.Fields("cp116") Then
            p_CP45 = "" & rsAD.Fields("cp45")
         Else
            cbo.AddItem ChangeCustomerS(rsAD.Fields("cp44"))
         End If
         rsAD.MoveNext
      Loop
      'Modify by Morgan 2004/3/11
      '預設最後發文日最大發文號的代理人
      'If cbo.ListCount = 1 Then cbo.ListIndex = 0
      cbo.ListIndex = 0
   End If
   Set rsAD = Nothing 'Added by Lydia 2024/05/14
   
End Sub

'Add By Sindy 2013/9/5
'檢查是否有存在此流程
Public Function PUB_ChkEmpFlowExists(strCP09 As String, strFlowStatus As String, _
         Optional ByVal strQuyEEP02 As String, Optional ByRef strRefEEP02 As String) As Boolean
Dim Rs As ADODB.Recordset
Dim strTmp As String, intA As Integer  'Added by Lydia 2024/05/14

   PUB_ChkEmpFlowExists = False
   strTmp = "select * from EmpElectronProcess where eep01='" & strCP09 & "'" & _
                 " and eep04='" & strFlowStatus & "'" & _
                 IIf(strQuyEEP02 <> "", " and eep02>=" & strQuyEEP02, "") & _
                 " order by eep02 desc"
   intA = 1
   Set Rs = ClsLawReadRstMsg(intA, strTmp)
   If intA = 1 Then
      Rs.MoveFirst
      PUB_ChkEmpFlowExists = True
      strRefEEP02 = "" & Rs.Fields("EEP02")
   End If
   
   'Add By Sindy 2015/3/6 檢查是否有聯絡送英核流程
   'Modify By Sindy 2015/3/16 +or instr(eep08,'[送日核]')>0
   If strFlowStatus = EMP_送英核 Then
      strTmp = "select eep01,eep02" & _
                  " From empelectronprocess" & _
                  " where eep01='" & strCP09 & "' and eep04='" & EMP_聯絡 & "' and (instr(eep08,'[送英核]')>0 or instr(eep08,'[送日核]')>0)" & _
                  " order by eep02 desc"
      intA = 1
      Set Rs = ClsLawReadRstMsg(intA, strTmp)
      If intA = 1 Then
         If PUB_ChkEmpFlowExists = False Then
            PUB_ChkEmpFlowExists = True
            strRefEEP02 = "" & Rs.Fields("EEP02")
         Else
            If Val(strRefEEP02) > Val("" & Rs.Fields("EEP02")) Then
               strRefEEP02 = "" & Rs.Fields("EEP02")
            End If
         End If
      End If
   End If
   
   Rs.Close
   Set Rs = Nothing
End Function

'Add By Sindy 2013/9/13 檢查檔案是否正在使用中
'Modify By Sindy 2018/9/26 + Optional ByRef HadShowMsg As Boolean = False : 是否已有顯示訊息
'Modified by Lydia 2020/03/26 +是否彈訊息Optional ByVal bolShowMsg As Boolean = True
Public Function PUB_ChkFileOpening(strPathFile As String, Optional ByRef HadShowMsg As Boolean = False, Optional ByVal bolShowMsg As Boolean = True) As Boolean
Dim intFn As Integer
   
On Error GoTo ErrHnd
   
   PUB_ChkFileOpening = False
   intFn = FreeFile
   Open strPathFile For Input Lock Read As #intFn
   Close #intFn
   Exit Function
    
ErrHnd:
   If Err.Number = 70 Then
      PUB_ChkFileOpening = True
      'MsgBox "檔案開啟中...", vbExclamation
      
      'Added by Lydia 2020/03/26
      'Modified by Lydia 2024/02/07 DEBUG
      'ElseIf bolShowMsg = False Then
      If bolShowMsg = False Then
         PUB_ChkFileOpening = True
         HadShowMsg = True '已有顯示訊息
      'end 2020/03/26
      Else
         PUB_ChkFileOpening = True
         HadShowMsg = True '已有顯示訊息
         MsgBox "檢查檔案是否正在使用中：" & Err.Description & vbCrLf & vbCrLf & strPathFile, vbExclamation
      End If
   End If 'Added by Lydia 2024/02/07 DEBUG
   Close #intFn
   Screen.MousePointer = vbDefault 'Add By Sindy 2020/3/5
End Function

'Add By Sindy 2022/7/1 檢查檔案是否正在使用中
Public Function PUB_ChkFileOpening2(strPathFile As String, Optional strMsgTxt As String = "")
   PUB_ChkFileOpening2 = False
   If PUB_ChkDir(strPathFile) = True Then
      'Modify By Sindy 2024/4/18 +, False
      If PUB_ChkFileOpening(strPathFile, False, False) = True Then
         PUB_ChkFileOpening2 = True
         MsgBox strPathFile & vbCrLf & vbCrLf & "檔案正在使用中，請關閉！" & strMsgTxt, vbExclamation
         Screen.MousePointer = vbDefault
         Exit Function
      End If
   End If
End Function

'Add By Sindy 2013/9/24 檢查此系統別及國家案件性質
Public Function PUB_ChkCPMIsExists(ByRef Strindex As String, ByRef StrIndex2 As String, ByRef strNation As String) As Boolean
PUB_ChkCPMIsExists = False
CheckOC3
strSql = "SELECT CPM03,CPM04 FROM CASEPROPERTYMAP WHERE CPM01='" & Strindex & "' AND CPM02='" & StrIndex2 & "' "
AdoRecordSet3.CursorLocation = adUseClient
AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
If AdoRecordSet3.RecordCount <> 0 And AdoRecordSet3.RecordCount > 0 Then
   If strNation = "000" Then '台灣案
      If AdoRecordSet3.Fields(0) <> "（無）" Then
         PUB_ChkCPMIsExists = True
      End If
   Else
      If AdoRecordSet3.Fields(1) <> "（無）" Then
         PUB_ChkCPMIsExists = True
      End If
   End If
End If
CheckOC3
End Function

''Add By Sindy 2013/9/27 檢查查詢智權人員案件資料權限
'Public Function PUB_ChkSalesCaDateQLim(strQuser As String, strCP13 As String, strCP01 As String) As Boolean
'Dim strSaleST15 As String
'Dim strQuserST05 As String
'Dim strQuserST15 As String
'
'   PUB_ChkSalesCaDateQLim = False
'
'   strSaleST15 = PUB_GetStaffST15(strCP13, 1)
'
'   strQuserST05 = PUB_GetST05(strQuser)
'   strQuserST15 = PUB_GetStaffST15(strQuser, 1)
'
'   '自己的案件可以查
'   If strQuser = strCP13 Then
'      PUB_ChkSalesCaDateQLim = True
'      Exit Function
'   End If
'
'   Select Case strQuser
'      '外商陳經理可看全所CFT,FCT,S,CFC
'      Case "68005"
'         If strCP01 = "CFT" Or strCP01 = "FCT" Or strCP01 = "S" Or strCP01 = "CFC" Then
'            PUB_ChkSalesCaDateQLim = True
'            Exit Function
'         End If
'
'      '小真,杜副總可看全部
'      'modify by sonia 2014/6/9 +美珍77027
'      Case "65001", "68006", "77027"
'         PUB_ChkSalesCaDateQLim = True
'         Exit Function
'
'      '杜燕文,劉大愛可看S31
'      'modify by sonia 2016/8/22劉大愛78007改為蘇嫄媛79053
'      Case "74018", "79053"
'         If strSaleST15 = "S31" Then
'            PUB_ChkSalesCaDateQLim = True
'            Exit Function
'         End If
'
'      '王協理可看專利處
'      Case "71011"
'         If strSaleST15 >= "P10" And strSaleST15 <= "P19" Then
'            PUB_ChkSalesCaDateQLim = True
'            Exit Function
'         End If
'
'      '葉經理可看商標處
'      'modify by sonia 2016/2/24 +69008
'      Case "67002", "69008"
'         If strSaleST15 >= "P20" And strSaleST15 <= "P29" Then
'            PUB_ChkSalesCaDateQLim = True
'            Exit Function
'         End If
'
'      Case Else
'         Select Case strQuserST05
'            '電腦中心,財務,總經理看全部
'            Case "00", "01"
'               PUB_ChkSalesCaDateQLim = True
'               Exit Function
'
'            '各區主管
'            Case "SM"
'               '林永生71003可看中所全部
'               If strQuser = "71003" Then
'                  If strSaleST15 = "S23" Then
'                     PUB_ChkSalesCaDateQLim = True
'                     Exit Function
'                  End If
'               End If
'
'               '簡協理可看北所全部但預設S15
'               'Modify By Sindy 2020/1/9
'               '　　原簡協理69005可看北所全部智權部資料,
'               '　　現欲開放可看全所智權部資料
'               If strQuser = "69005" Then
'                  'If strSaleST15 = "S15" Then
'                  If Left(strSaleST15, 1) = "S" Then
'                  '2020/1/9 END
'                     PUB_ChkSalesCaDateQLim = True
'                     Exit Function
'                  End If
'               End If
'
'               '同部門可以看
'               If strQuserST15 = strSaleST15 Then
'                  PUB_ChkSalesCaDateQLim = True
'                  Exit Function
'               End If
'
'            '加入外商主管  王宗珮、洪琬姿、葉易雲
'            Case "21", "26", "28"
'               If strQuserST15 = strSaleST15 Then
'                  PUB_ChkSalesCaDateQLim = True
'                  Exit Function
'               End If
'         End Select
'   End Select
'
'   '若操作人員的ST05=SA且在職員工的ST52有該編號存在,此類人員稱之為帶人主管
'   'Modify By Sindy 2014/8/28
'   'If PUB_GetST05Limits(strQUser) = True And PUB_GetST52(strCP13) = strQUser Then
'   If PUB_GetST05Limits(strQuser) = True And PUB_GetST52(strCP13, strQuser) = True Then
'   '2014/8/28 END
'      PUB_ChkSalesCaDateQLim = True
'      Exit Function
'   End If
'
'   '中三區人員可單獨下68096看期限
'   If strQuserST15 = "S23" And strCP13 = "68096" Then
'      PUB_ChkSalesCaDateQLim = True
'      Exit Function
'   End If
'
'   '北五區人員可單獨下10051看期限
'   If strQuserST15 = "S15" And strCP13 = "10051" Then
'      PUB_ChkSalesCaDateQLim = True
'      Exit Function
'   End If
'End Function


'Add by Amy 2013/10/17
'Modify by Amy 2013/10/30 改訊息
'Modify by Amy 2014/04/07 +bolExcept
'****** 修改時請確認DB Function GetDizhang 是否也需修改 ******
'回傳客戶或代理人基本檔有設「帳款理情形」(可下All、單筆或區間)
'StrNo1=All 抓所有帳款理情形資料 /只輸入 StrNo1 單筆 /輸入 StrNo1及StrNo2 區間
'ShowMsg :是否秀訊息
'intChoose :預設回傳「客戶編號 & (帳款處理內容)」/1.回傳「客戶編號」/2.回傳 「帳款處理內容」(適用於單筆)
'bolExcept:帳款處理情形是否有例外設定,預設True (D.不同意抵帳)
Public Function GetDizhang(ByVal strNo1 As String, Optional ByVal strNo2 As String, Optional ShowMsg As Boolean = False, Optional ByVal intChoose As Integer = 0, Optional ByVal bolExcept As Boolean = True) As String
     Dim strSql As String, strField1 As String, strField2 As String
     Dim intR As Integer, CountRow As Integer
     Dim Rs As ADODB.Recordset
     'Add by Amy 2017/11/21
     Dim RsQ As ADODB.Recordset
     Dim strQ As String, strAccMemo As String, intQ As Integer
     
     GetDizhang = ""
     'Modify by Amy 2014/04/07
     If bolExcept = True Then
'        strField1 = " CU01 inf1,Decode(CU142,'A','同意抵帳中',Decode(CU142,'B','宣告破產','帳款處理中')) inf2"
'        strField2 = " FA01 inf1,Decode(FA103,'A','同意抵帳中',Decode(FA103,'B','宣告破產','帳款處理中')) inf2"
        strField1 = " CU01 inf1,GetDizhang(CU142,'Y') inf2"
        strField2 = " FA01 inf1,GetDizhang(FA103,'Y') inf2"
     Else
        strField1 = " CU01 inf1,GetDizhang(CU142) inf2"
        strField2 = " FA01 inf1,GetDizhang(FA103) inf2"
     End If
     'end 2014/04/07
     
     If UCase(strNo1) = "ALL" Then
        strSql = "Select Distinct " & strField1 & " From Customer Where CU142 is not null " & _
           "Union Select Distinct " & strField2 & " From Fagent Where FA103 is not null "
     Else
        strNo1 = Left(strNo1 & String(9 - Len(strNo1), "0"), 8) '只取前8碼(客戶或代理人更名會更新編號前8碼一樣的同意抵帳欄位)
        If UCase(Left(Trim(strNo1), 1)) = "X" Then
            If Trim(strNo2) = "" Then
                strSql = "Select Distinct " & strField1 & " From Customer Where CU142 is not null And CU01 ='" & strNo1 & "' "
            Else
                strNo2 = Left(strNo2 & String(9 - Len(strNo2), "0"), 8)
                strSql = "Select Distinct " & strField1 & " From Customer Where CU142 is not null And CU01 >='" & strNo1 & "' And CU01<='" & strNo2 & "'"
            End If
        ElseIf UCase(Left(Trim(strNo1), 1)) = "Y" Then
             If Trim(strNo2) = "" Then
                strSql = "Select Distinct " & strField2 & " From Fagent Where FA103 is not null And FA01 ='" & strNo1 & "' "
             Else
                strNo2 = Left(strNo2 & String(9 - Len(strNo2), "0"), 8)
                strSql = "Select Distinct " & strField2 & " From Fagent Where FA103 is not null And FA01>='" & strNo1 & "' And FA01 <='" & strNo2 & "'"
             End If
        Else
            Exit Function
        End If
     End If
    
        
   intR = 1: CountRow = 0
   Set Rs = ClsLawReadRstMsg(intR, strSql)
   If intR = 1 Then
        Do While Not Rs.EOF
            'Add by Amy 2017/11/21 +顯示會計備註
            strAccMemo = ""
            If ShowMsg = True Then
                intQ = 1
                If UCase(Left(Rs.Fields("inf1"), 1)) = "X" Then
                    strQ = "Select cu159 as AMemo From Customer Where CU01='" & Rs.Fields("inf1") & "' And CU02='0' And cu159 is not null "
                Else
                    strQ = "Select fa118 as AMemo From FAgent Where FA01='" & Rs.Fields("inf1") & "' And FA02='0' And fa118 is not null "
                End If
                Set RsQ = ClsLawReadRstMsg(intQ, strQ)
                If intQ = 1 Then
                    strAccMemo = "" & RsQ.Fields("AMemo")
                End If
            End If
            'end 2017/11/21
            Select Case intChoose
                Case 1
                    GetDizhang = GetDizhang & Rs.Fields("inf1") & ","
                'Modify by Amy 2017/11/21 +會計備註
                Case 2
                    GetDizhang = "" & Rs.Fields("inf2") & IIf(strAccMemo = "", "", vbCrLf & "會計備註：" & strAccMemo) & ","
                Case Else
                    If Not IsNull(Rs.Fields("inf2")) Then 'Modify by Amy 2014/04/07 +if
                        GetDizhang = GetDizhang & Rs.Fields("inf1") & " 帳款處理設為「" & Rs.Fields("inf2") & "」" & vbCrLf & _
                        IIf(strAccMemo = "", "", "會計備註：" & strAccMemo & vbCrLf)
                    End If
                'end 2017/11/21
            End Select
            CountRow = CountRow + 1
            Rs.MoveNext
        Loop
        If intChoose = 1 Or intChoose = 2 Then
            GetDizhang = Left(GetDizhang, Len(GetDizhang) - 1)
        End If
   End If
   If ShowMsg = True And CountRow > 0 And GetDizhang <> "" Then 'Modify by Amy 2014/04/07 +GetDizhang<>""
        Select Case intChoose
            Case 1 '回傳 客戶編號
                MsgBox "編號 " & GetDizhang & vbCrLf & " 已設定帳款處理情形，詳細情形請與財務處聯繫!!", vbInformation
            Case 2 '回傳  帳款處理內容
                MsgBox "帳款處理情形設為 「" & GetDizhang & " 」，詳細情形請與財務處聯繫!!", vbInformation
            Case Else
                If CountRow = 1 Then
                    MsgBox "編號 " & GetDizhang & vbCrLf & "詳細情形請與財務處聯繫!!", vbInformation
                Else
                    MsgBox "下列編號設定帳款處理情形：" & vbCrLf & GetDizhang & vbCrLf & "詳細情形請與財務處聯繫!!", vbInformation
                End If
         End Select
   End If
   Rs.Close
   Set Rs = Nothing
End Function
'end 2013/10/17

'Added by Morgan 2013/10/23 自 GetMoneyDate 抽出來
'讀取各國修法年費設定
'Output:pFeeYears=繳費年度, pFixNo=修法第次, pStartDate=年費起算日
Public Sub PUB_GetSpecAnnuityRef(ByVal pPA09 As String, ByVal pPA08 As Integer, ByVal pPA10 As String, ByVal pCP10 As String, ByVal pPA21 As String, ByVal pPA72 As String, ByRef pFeeYears As String, Optional ByRef pFixNo As Integer, Optional ByRef pStartDate As String, Optional ByRef pStartDateType As String)
   
   pPA10 = DBDATE(pPA10)
   pPA21 = DBDATE(pPA21)
   
   'Modify by Morgan 2009/11/5 將CFP年費發文之規則並入
   '2005/9/23 ADD BY SONIA 各國修法
   Select Case pPA09
      Case "000" '台灣
         'Add by Morgan 2005/3/2 台灣新型舊法為12年
         'Modify by Moragn 2005/7/19 判斷有公告日
         'If pPA08 = 2 And pPA09 = "000" And Val(pStartDate) <= 20040701 Then
         If pPA08 = 2 And pPA09 = "000" And Val(pStartDate) > 0 And Val(pStartDate) <= 20040701 Then
            pFeeYears = "1,2,3,4,5,6,7,8,9,10,11,12"
            pFixNo = 1
         End If
      
      'Added by Morgan 2021/5/28 大陸 2021/6/1 修改
      Case "020" '大陸
         '大陸外觀設計 2021/6/1 以前申請者，其專利期間為自申請日起算10年
         If pPA08 = 3 And Val(pPA10) > 0 And Val(pPA10) < 20210601 Then
            pFeeYears = "1,2,3,4,5,6,7,8,9,10"
            pFixNo = 1
         End If
         
      Case "011" '日本
         '日本新型申請日在2005/3/31以前者，其專利期間為自申請日起算6年
         If pPA08 = 2 And Val(pPA10) > 0 Then
            If Val(pPA10) < 20050331 Then
               pFeeYears = "4,5,6"
               pFixNo = 1
            End If
         'Add by Morgan 2007/4/20
         '日本設計自申請日2007/4/1起改用新法,舊法為發證日起15年,第4年起逐年繳交。
         ElseIf pPA08 = 3 And Val(pPA10) > 0 Then
            If Val(pPA10) < 20070401 Then
               pFeeYears = "4,5,6,7,8,9,10,11,12,13,14,15"
               pFixNo = 1
            End If
         End If
      
      Case "012" '韓國
         'Add by Morgan 2008/2/27 申請日20061001以後者自申請日起10年，自發證日起第4年須逐年繳交年費
         If pPA08 = 2 And Val(pPA10) > 0 Then
            '申請日在1999/7/1以前者，自申請日起15年
            If Val(pPA10) < 19990701 Then
               '2008/11/27 MODIFY BY SONIA
               'pFeeYears = ",2,3,4,5,6,7,8,9,10,11,12,13,14,15"
               pFeeYears = "2,3,4,5,6,7,8,9,10,11,12,13,14,15"
               pFixNo = 1
            '2008/11/27 MODIFY BY SONIA 申請日在1999/7/1~20061001者，自申請日起10年，繳費年度自發證日起算第2，4，5，6，7，8，9，10年
            ElseIf Val(pPA10) < 20061001 Then
               pFeeYears = "2,4,5,6,7,8,9,10"
               pFixNo = 2
            End If
         End If
         '設計申請日在1998/3/1以前者，自發證日起10年,無案件
         '    申請日在1998/3/1以後者，自發證日起15年
      
      Case "015" '澳洲
         '2012/5/18 ADD BY SONIA 20080701以後申請者，專用期限自申請日起20年，惟自申請日第5年須逐年繳年費
         If pPA08 = 1 And Val(pPA10) > 0 Then
            '申請日在20080701以前者,自申請日第6年須逐年繳年費
            If Val(pPA10) < 20080701 Then
               pFeeYears = "6,7,8,9,10,11,12,13,14,15,16,17,18,19,20"
               pFixNo = 1
            End If
         End If
         '2012/5/18 END
         '20040617以後申請者，專用期限自申請日起10年，繳費年度：5、延展費
         If pPA08 = 3 And Val(pPA10) > 0 Then
            'Modify by Morgan 2009/11/5 第一次以發證日起算,其餘為申請日(目前尚有4個案件但都只剩第3次故起算日與目前設定相同不必再特別控制)
            '專用期限自註冊日起1年，期滿可延自申請日起6年，期滿可再延2次，1次5年，總計16年。即自發證日起至申請日起16年，繳費年度：1，6，11、延展費
            If Val(pPA10) < 20040617 Then
               pFeeYears = "1,6,11"
               pFixNo = 1
            End If
         End If
         
      'Add by Morgan 2006/8/21
      Case "018" '馬來西亞
         '2010/4/21 add by sonia
         '2001/8/1以後提申者，自申請日起20年，自發證日起第2年逐年繳交年費
         If pPA08 = "1" And Val(pPA10) > 0 Then
            '舊法：2001/8/1以前提申者，自發證日起15年，自發證日起第2年逐年繳交年費
            If Val(pPA10) < 20010801 Then
               pFeeYears = "2,3,4,5,6,7,8,9,10,11,12,13,14,15"
               pFixNo = 1
            End If
         End If
         '2010/4/21 end
         If pPA08 = 2 And pCP10 = "607" And Val(pPA10) > 0 Then
            'Modify by Morgan 2007/7/18 新型不管何時提申均適用上述新法(2003年8月14日實施)
            ''舊法(發證日<2001/8/1)自發證日起5年，期滿可延展2次，每次5年；
            'If Val(DBDATE(field(21))) < 20010801 Then
            '   strFeeYears = "5,10"
            '   strStartDate = DBDATE(field(21))
            'Else
            '新法自申請日起10年，期滿可延展2次，每次5年；
            '   strFeeYears = "10,15"
            '   strStartDate = DBDATE(field(10))
            'End If
            pFeeYears = "10,15"
            pStartDate = pPA10
            'end 2007/7/18
         End If
         
      '2010/4/21 ADD BY SONIA
      Case "030" '菲律賓
         '申請日在1998/1/1以後者，申請日起20年，公開日起第5年逐年繳交年費
         If pPA08 = "1" And Val(pPA10) > 0 Then
            '申請日在1998/1/1以前者，發證日起17年，發證日起第5年逐年繳交年費
            If Val(pPA10) < 19980101 Then
               pStartDateType = "6" 'Added by Morgan 2013/10/23
               pStartDate = pPA21
               pFeeYears = "5,6,7,8,9,10,11,12,13,14,15,16,17"
               pFixNo = 1
            End If
         End If
         '申請日在1998/1/1以後者，申請日起7年，期滿不得延展，無須繳交年費
         If pPA08 = "2" And Val(pPA10) > 0 Then
            '申請日在1998/1/1以前者，發證日起5年，期滿可延2次，每次5年
            If Val(pPA10) < 19980101 Then
               pStartDateType = "6" 'Added by Morgan 2013/10/23
               pStartDate = pPA21
               pFeeYears = "5,10"
               pFixNo = 1
            End If
         End If
         '設計申請日在1998/1/1以前者，發證日起5年，期滿可延2次，每次5年, 共15年, 無案件
         '    申請日在1998/1/1以後者，申請日起5年，期滿可延2次，每次5年, 共15年
      '2010/4/21 end
      
      'Add by Morgan 2010/9/30 補漏(自年費發文)
      Case "042"   '越南
         If Val(pPA21) > 0 Then
            If Val(pPA21) < 20031127 Then
               If pPA08 = "1" Or pPA08 = "2" Then
                  pStartDate = pPA10
               End If
            End If
         End If
         
      '2010/2/22 add by sonia
      Case "204" '義大利
         '申請日在2006/1/1以後者，自申請日起第5年逐年繳交年費
         If pPA08 = 1 And Val(pPA10) > 0 Then
            '2010/7/8 與慧汶確認
            '申請日在2006/1/1以前者，自申請日起第4年逐年繳交年費,但第1次繳費日晚於20070101者仍自第5年開始繳交
            'Modified by Morgan 2018/9/18
            'If Val(pPA10) < 20060101 And (DBDATE(GetFeeNextDate(pStartDate, 3, pPA09, pPA08)) < 20070101) Then
            If Val(pPA10) < 20060101 And (DBDATE(GetFeeNextDate(pPA10, 3, pPA09, pPA08)) < 20070101) Then
            'end 2018/9/18
               pFeeYears = "4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20"
               pFixNo = 1
            End If
         End If
      '2010/2/22 end
      
      'add by sonia 2014/5/29
      Case "205" '瑞士
         '2014/1/1起改為自申請日起第4年逐年繳年費，適用於所有尚未繳納年費之案件。原為自申請日起第5年逐年繳年費。
         If pPA08 = 1 And Val(pPA10) > 0 Then
            '申請日在2014/1/1以前者，自申請日起第5年逐年繳交年費,但第1次繳費日晚於20140101者仍自第4年開始繳交
            'Modified by Morgan 2018/5/9
            'If Val(pPA10) < 20140101 And (DBDATE(GetFeeNextDate(pStartDate, 4, pPA09, pPA08)) < 20140101) Then
            If Val(pPA10) < 20140101 And (DBDATE(GetFeeNextDate(pPA10, 4, pPA09, pPA08)) < 20140101) Then
            'end 2018/5/9
               pFeeYears = "5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20"
               pFixNo = 1
            End If
         End If
      '2014/5/29 end
      
      '2010/4/21 ADD BY SONIA
      Case "206" '奧地利 (無案件)
      
'Removed by Morgan 2016/1/21 繳費年度只需記錄新法後的,否則會有錯
'         '發明案2010年1月1日起，自申請日第6年起每年須繳交年費(准後始須繳交)
'         '原自申請日第3年起每年繳年費,但下次繳費日未至第6年則該年不必繳(無案件)
'         If pPA08 = 1 And pPA72 <> "" Then
'            pFeeYears = "3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20"
'            pFixNo = 1
'         End If
'
'         '新型案2010年1月1日起，自申請日第4年起每年須繳交年費(准後始須繳交)
'         '原自申請日第2年起每年繳年費,但下次繳費日未至第4年則該年不必繳(無案件)
'         If pPA08 = 2 And pPA72 <> "" Then
'            pFeeYears = "2,3,4,5,6,7,8,9,10"
'            pFixNo = 1
'         End If
         
      Case "207" '荷蘭發明新型
         '在2008/6/5以前有繳過年費者，自申請日起第5年逐年繳交年費
         '否則自申請日起第4年逐年繳交年費
         '2010/4/22 ADD BY SONIA 修法雖自第4年起繳交,但若第4年已過期則仍自第5年起繳 CFP-016429
         If pPA08 = 1 And Val(pStartDate) > 0 Then
            If pPA72 = "" And DBDATE(GetFeeNextDate(pStartDate, 3, pPA09, pPA08)) < strSrvDate(1) Then
               pFeeYears = "5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20"
               pFixNo = 1
            ElseIf pPA72 <> "" Then
               If Mid(pPA72, 1, 1) <> "4" Then
                  pFeeYears = "5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20"
                  pFixNo = 1
               End If
            End If
         End If
         '2010/4/22 END
         If pPA08 = 2 And Val(pStartDate) > 0 Then
            pFixNo = 1     '2010/7/12 ADD BY SONIA 荷蘭2008/6/5取消新型,故修法次數都為1
            If pPA72 = "" And DBDATE(GetFeeNextDate(pStartDate, 3, pPA09, pPA08)) < strSrvDate(1) Then
               pFeeYears = "5,6"
               pFixNo = 1
            ElseIf pPA72 <> "" Then
               If Mid(pPA72, 1, 1) <> "4" Then
                  'Modify by Morgan 2010/6/8
                  'pFeeYears = "5,6"
                  pFeeYears = Replace(pFeeYears, "4,", "")
                  pFixNo = 1
               End If
            End If
         End If
      '2010/4/21 END
      
      Case "211" '西班牙
         '申請日在2003/7/9以後者，其專利期間為自發證日起25年，繳費年度：5，10，15，20、延展費
         If pPA08 = 3 And Val(pPA10) > 0 Then
            '申請日在2003/7/9以前者，其專利期間為自核准日起20年，繳費年度：5，10，15、延展費
            If Val(pPA10) < 20030709 Then
               pFeeYears = "5,10,15"
               pFixNo = 1
            End If
         End If
         
      'Add by Morgan 2007/7/31
      'Modified by Morgan 2017/7/3 俄羅斯5/2改國家代碼 "233"->"023"
      Case "023" '俄羅斯
         '新型延展費:自申請日起5年,可延展3年
         If pPA08 = "2" And pCP10 = "607" And Val(pPA10) > 0 Then
            '2008/10/6 MODIFY BY SONIA 2008/1/1修法改申請日起10年,2008/1/1日以後還有效的案件都適用
            'strFeeYears = "5"
            pFeeYears = "10"
            pStartDate = pPA10
            
         'Added by Morgan 2015/6/9
         '新型年費:2014/10/01之前提出申請者專用期間為 13 年,自申請日起須逐年繳年費(准後始須繳交)
         ElseIf pPA08 = "2" And pCP10 = "605" And Val(pPA10) > 0 And Val(pPA10) < 20141001 Then
            pFeeYears = "1,2,3,4,5,6,7,8,9,10,11,12,13"
            pStartDate = pPA10
            pStartDateType = "2"
            
         '設計延展費:2014/10/01之前提出申請者,自申請日起15年,可延展1次(10年)
         ElseIf pPA08 = "3" And pCP10 = "607" And Val(pPA10) > 0 And Val(pPA10) < 20141001 Then
            pFeeYears = "15"
            pStartDate = pPA10
            pStartDateType = "2"
                  
         '設計延展費:2014/10/01之後提出申請者,自申請日起5年,可延展4次(每次5年)
         'Modified by Morgan 2022/6/9
         '設計延展費:2015/1/1以前提申案件除了延展費外仍要繳年費,2015/1/1以後提申案件僅須繳延展費(國家檔設定)--禧佩
         'ElseIf pPA08 = "3" And pCP10 = "607" And Val(pPA10) >= 20141001 Then
         '   pFeeYears = "5,10,15,20"
         '   pStartDate = pPA10
         '   pStartDateType = "2"
         ElseIf pPA08 = "3" And pCP10 = "605" And Val(pPA10) > 0 And Val(pPA10) < 20150101 Then
            pFeeYears = "3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25"
            pStartDate = pPA10
            pStartDateType = "2"
         'end 2022/6/9
         'end 2015/6/9
         
         End If
      'add by sonia 2019/3/12
      Case "027"   '以色列
         '設計案申請日在2018/8/7以前者，申請日起18年,申請日起第5、10、15年繳延展費。
         If pPA08 = 3 And Val(pPA10) > 0 Then
            If Val(pPA10) < 20180807 Then
               pFeeYears = "5,10,15"
               pFixNo = 1
            End If
         End If
         
      Case "235"   '土耳其發明及新型在2018/5/9日以前沒繳過的都適用新法自第3年開始(原自第2年開始)
         If pPA08 = 1 Then   '發明
            If pPA72 <> "" Then
               If Mid(pPA72, 1, 1) = "2" Then
                  pFeeYears = "2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20"
               End If
            End If
         ElseIf pPA08 = 2 Then   '新型
            If pPA72 <> "" Then
               If Mid(pPA72, 1, 1) = "2" Then
                  pFeeYears = "2,3,4,5,6,7,8,9,10"
               End If
            End If
         End If
         '2010/4/22 END
      'end 2019/3/12
   End Select
End Sub
'Added by Morgan 2013/10/31 檢查請款單格式
Public Function PUB_GetBillFormat(ByVal pA1K28 As String, Optional pCP01 As String, Optional pCP02 As String, Optional pCP03 As String, Optional pCP04 As String) As Integer
   Dim iRtn As Integer
   Dim stSQL As String, intR As Integer
   Dim rsQuery As ADODB.Recordset
   
   iRtn = 0
   Select Case Left(pA1K28, 8)
   'Modified by Morgan 2017/3/7 +Y48048 --Kimi
   'Modified by Morgan 2017/3/16 +下列編號--Tim
   'Modified by Morgan 2018/11/12 +X37704--Tim
   'X67402,X6740201,X6740202,X60507,X60507001,X6050701,X70749,X70406,X71137,X49346,X70197,X69605,X71927,X72756,X48049,X27727,X6050702,X48049C1,Y52322B1,Y48048,Y48842,Y2245702,Y52322,Y49562
   'Modified by Morgan 2019/2/26 +Y55199
   'Modified by Morgan 2019/4/24 +Y55240 (DuPont)--洪培堯
   'Modified by Morgan 2022/3/4 +Y55423 --Kimi
   Case "Y2245700", "Y5519900", "Y4804800", "X6740200", "X6740201", "X6740202", "X6050700", "X6050701", "X7074900", "X7040600", "X7113700", "X4934600", "X7019700", "X6960500", "X7192700", "X7275600", "X4804900", "X2772700", "X6050702", "X48049C1", "Y52322B1", "Y4884200", "Y2245702", "Y5232200", "Y4956200", "X3770400", "Y5524000", "Y5542300"
      iRtn = 1
   Case "Y5349500", "X3224200", "Y4725001"
      iRtn = 2
   Case "X5208400", "X4831001", "X4831000", "Y4830906", "Y4830907"
      iRtn = 3
   Case Else
      'Added by Morgan 2014/2/25
      'ARKRAY X55094 格式特別
      If pCP01 <> "" Then
         'Modified by Lydia 2016/03/03 增加申請人
         'stSQL = "select pa01 from patent where pa01='" & pCP01 & "' and pa02='" & pCP02 & "' and pa03='" & pCP03 & "' and pa04='" & pCP04 & "' and instr(pa26||pa27||pa28||pa29||pa30,'X5509400')>0" & _
            " union select sp01 from servicepractice where sp01='" & pCP01 & "' and sp02='" & pCP02 & "' and sp03='" & pCP03 & "' and sp04='" & pCP04 & "' and instr(sp08||sp58||sp59||sp65||sp66,'X5509400')>0"
         stSQL = "select pa26 from patent where pa01='" & pCP01 & "' and pa02='" & pCP02 & "' and pa03='" & pCP03 & "' and pa04='" & pCP04 & "'" & _
            " union select sp08 from servicepractice where sp01='" & pCP01 & "' and sp02='" & pCP02 & "' and sp03='" & pCP03 & "' and sp04='" & pCP04 & "'"
         intR = 1
         Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
         If intR = 1 Then
            'Modified by Lydia 2016/03/03
            'iRtn = 4
            Select Case Left(rsQuery(0), 8)
                Case "X5509400"
                     iRtn = 4
                Case "X7286900"
                     iRtn = 5
            End Select
            'end 2016/03/03
         End If
      End If
      'end 2014/2/25
   End Select
   PUB_GetBillFormat = iRtn
   Set rsQuery = Nothing
End Function

'Add By Sindy 2015/3/4 檢查是否有設定英文核判表
Public Function PUB_ChkIsSetProofEngReader(strEmp As String, strCP01 As String, strCP02 As String, strCP03 As String, strCP04 As String, _
                                           strCP10 As String, Optional ByRef strPER04 As String, _
                                           Optional ByRef bolMultinationalEngOk As Boolean = False) As Boolean
Dim rsQuery As ADODB.Recordset
Dim QryEEP02 As String
   
Dim strTmp As String, intA As Integer, rsAD As New ADODB.Recordset  'Added by Lydia 2024/05/14

   PUB_ChkIsSetProofEngReader = False
   bolMultinationalEngOk = False
   strPER04 = ""
   strTmp = "select * from ProofEngReader where per01='" & strCP01 & "' and per03='" & strCP10 & "'"
   intA = 1
   Set rsQuery = ClsLawReadRstMsg(intA, strTmp)
   If intA = 0 Then
      '此案件性質不在設定表裡代表無需設定權限
   Else
      'CFP多國案,如主案已完成英核,其他國對應案可不必英核
      'Modify By Sindy 2015/4/10 + And InStr(NewCasePtyList, strCP10) > 0:新申請案時才要管多國案是否已送英核的問題
      If strCP01 = "CFP" And InStr(NewCasePtyList, strCP10) > 0 Then
         '是否多國案
         strTmp = "select cr01 from CaseRelation" & _
                  " where cr01='" & strCP01 & "' and cr02='" & strCP02 & "' and cr03='" & strCP03 & "' and cr04='" & strCP04 & "'"
         intA = 1
         Set rsQuery = ClsLawReadRstMsg(intA, strTmp)
         If intA = 1 Then
            '取得主案本所案號（多筆）
            strTmp = "select cp01,cp02,cp03,cp04,cp21,cp09 from CaseRelation,caseprogress" & _
                     " where cr01='" & strCP01 & "' and cr02='" & strCP02 & "' and cr03='" & strCP03 & "' and cr04='" & strCP04 & "'" & _
                     " and cr05=cp01(+) and cr06=cp02(+) and cr07=cp03(+) and cr08=cp04(+)" & _
                     " and cp10 in(" & NewCasePtyList & ")" & _
                     " and cp21 is null"
            intA = 1
            Set rsQuery = ClsLawReadRstMsg(intA, strTmp)
            If intA = 1 Then
               rsQuery.MoveFirst
               Do While Not rsQuery.EOF
                  '逐筆檢查主案是否已完成英核,若有其他國對應案可不必英核
                  QryEEP02 = ""
                  If PUB_ChkEmpFlowExists(rsQuery.Fields("cp09"), EMP_送英核, , QryEEP02) = True Then
                     If PUB_ChkEmpFlowExists(rsQuery.Fields("cp09"), EMP_核完, QryEEP02) = True Then
                        '已送英核且已核完
                        bolMultinationalEngOk = True '多國案,主案已送英核且已核完
                        PUB_ChkIsSetProofEngReader = False
                        Set rsQuery = Nothing
                        Exit Function
                     End If
                  End If
                  rsQuery.MoveNext
               Loop
            End If
         End If
      End If
      
      'Add By Sindy 2015/4/24 若未設定英核表,則表示為必須英核
      strTmp = "select st64 from staff where st01='" & strEmp & "'"
      intA = 1
      Set rsQuery = ClsLawReadRstMsg(intA, strTmp)
      If intA = 1 Then
         If "" & rsQuery.Fields(0) = "N" Then
            PUB_ChkIsSetProofEngReader = True
            '英核人員
            strTmp = "select st01 from staff where st04='1' and st03='P14'"
            intA = 1
            Set rsQuery = ClsLawReadRstMsg(intA, strTmp)
            If intA = 1 Then
               strPER04 = "" & rsQuery.Fields(0)
            End If
            Set rsQuery = Nothing
            Exit Function
         End If
      End If
      '2015/4/24 END
      
      '檢查英核權限
      'PUB_ChkIsSetProofEngReader = True
      'Modify By Sindy 2017/1/11 + and per02<>per04 排除自行核稿
      strTmp = "select * from ProofEngReader where per01='" & strCP01 & "'" & _
               " and per02='" & strEmp & "' and per02<>per04 and per03='" & strCP10 & "'"
      intA = 1
      Set rsQuery = ClsLawReadRstMsg(intA, strTmp)
      If intA = 1 Then
         PUB_ChkIsSetProofEngReader = True 'Modify By Sindy 2016/12/22 移至此處
         strPER04 = "" & rsQuery.Fields("per04")
      End If
   End If
   
   Set rsQuery = Nothing
End Function

'Add By Sindy 2014/9/17 檢查是否有設定核判表
'Modify By Sindy 2015/1/20 + Optional ByRef strPP04 As String, Optional ByRef strPP05 As String
'Modify By Sindy 2018/5/2 + Optional ByVal strCP09 As String = "", Optional ByVal strNA01 As String = ""
'Modify By Sindy 2018/8/13 + Optional ByRef strPP01 As String, Optional ByRef strPP03 As String
Public Function PUB_ChkIsSetPromoterReader(ByVal strEmp As String, ByVal strCP01 As String, ByVal strCP10 As String, _
                                           Optional ByRef strPP04 As String, _
                                           Optional ByRef strPP05 As String, _
                                           Optional ByVal strCP09 As String = "", _
                                           Optional ByVal strNA01 As String = "", _
                                           Optional ByRef strPP01 As String = "", _
                                           Optional ByRef strPP03 As String = "") As Boolean
Dim rsQuery As ADODB.Recordset
Dim strCPM23 As String
'Add By Sindy 2018/5/2
Dim strSys As String
Dim bolPAFlow As Boolean, bolTMFlow As Boolean
Dim strCP43 As String, strCP13 As String
'2018/5/2 END
Dim strCF10 As String
Dim strCP43CP10 As String 'Add By Sindy 2022/7/12
Dim strTmp As String, intA As Integer, rsAD As New ADODB.Recordset  'Added by Lydia 2024/05/14

   PUB_ChkIsSetPromoterReader = False
   strPP04 = "" '核稿人 Add By Sindy 2015/1/20
   strPP05 = "" '判發人 Add By Sindy 2015/1/20
   strPP03 = "" 'Add By Sindy 2018/10/1
   strPP01 = strCP01 '預設值
   
   'Add By Sindy 2018/5/2
   strSys = CheckSys(strCP01)
   If InStr("1", strSys) > 0 Then '專利
      bolPAFlow = True
   ElseIf InStr("2", strSys) > 0 Then '商標
      bolTMFlow = True
   ElseIf InStr("5,6", strSys) > 0 Then
      If strSys = "6" Then '商標:服務
         bolTMFlow = True
      Else
         bolPAFlow = True
      End If
   Else
      bolPAFlow = True
   End If
   '2018/5/2 END
   
   'Add By Sindy 2024/6/25
   If bolPAFlow = True And Left(PUB_GetST03(strEmp), 1) <> "F" Then '專利處,適用此段程式
   '2024/6/25 EMD
      '先檢查是否有設定核判表
      '1.系統別+案件性質+申請國家
      If strNA01 <> "" Then
         strTmp = "select * from PROMOTERPROOFREADER where pp01='" & strCP01 & "' and pp02='" & strEmp & "'" & _
                  " and pp03='" & strCP10 & "' and pp06='" & strNA01 & "'"
         intA = 1
         Set rsAD = ClsLawReadRstMsg(intA, strTmp)
         If intA = 1 Then
            PUB_ChkIsSetPromoterReader = True
            strPP04 = "" & rsAD.Fields("PP04")
            strPP05 = "" & rsAD.Fields("PP05")
            Exit Function
         End If
      End If
      '2.系統別+案件性質
      strTmp = "select * from PROMOTERPROOFREADER where pp01='" & strCP01 & "' and pp02='" & strEmp & "'" & _
               " and pp03='" & strCP10 & "'" & _
               " order by pp06 desc"
      intA = 1
      Set rsAD = ClsLawReadRstMsg(intA, strTmp)
      If intA = 1 Then
         If "" & rsAD.Fields("PP06") = "*" Then '* 代表沒指定申請國家
            PUB_ChkIsSetPromoterReader = True
            strPP04 = "" & rsAD.Fields("PP04")
            strPP05 = "" & rsAD.Fields("PP05")
            Exit Function
         End If
      End If
   End If
   '2024/6/25 END
   
   'Add By Sindy 2023/9/25
   'If Left(PUB_GetST03(strEmp), 2) = "F2" Then
   If Left(PUB_GetST03(strEmp), 1) = "F" Then 'Modify By Sindy 2024/8/13 暫先改判斷一碼
'      '1.先檢查是否有設定核判表
'      strTmp = "select * from PROMOTERPROOFREADER where pp01='" & strCP01 & "' and pp02='" & strEmp & "' and pp03='" & strCP10 & "'"
'      intA = 1
'      Set rsAD = ClsLawReadRstMsg(intA, strTmp)
'      If intA = 1 Then
'         PUB_ChkIsSetPromoterReader = True
'         strPP04 = "" & rsAD.Fields("PP04")
'         strPP05 = "" & rsAD.Fields("PP05")
'      Else
         '2.案件性質表
         strTmp = "select cpm23 from casepropertymap where cpm01='" & strCP01 & "' and cpm02='" & strCP10 & "'"
         intA = 1
         Set rsAD = ClsLawReadRstMsg(intA, strTmp)
         If intA = 1 Then
            strCPM23 = "" & rsAD.Fields("cpm23")
         End If
         
         'Add By Sindy 2024/9/18 外商判斷
         If Left(PUB_GetST03(strEmp), 2) = "F1" Then
            If strCPM23 = "" And Len(strCP10) = 3 Then
               strCPM23 = "B" '非申請
            End If
            strSql = "select * from PROMOTERPROOFREADER where pp01='" & strPP01 & "' and pp02='" & strEmp & "' and pp03 in('" & strCPM23 & "','" & strCP10 & "') and PP06 in('" & strNA01 & "','*') order by pp06 desc"
            intA = 1
            Set rsQuery = ClsLawReadRstMsg(intA, strSql)
            If intA = 1 Then
               PUB_ChkIsSetPromoterReader = True
               strPP03 = "" & rsQuery.Fields("pp03") 'Add By Sindy 2018/8/13
               strPP04 = "" & rsQuery.Fields("pp04") 'Add By Sindy 2015/1/20
               strPP05 = "" & rsQuery.Fields("pp05")
               Exit Function
            End If
         End If
         '2024/9/18 END
         
         'Modify By Sindy 2024/1/5 因會有P案,此if先取消 ex:P-126940
'         If strCPM23 = "9" Then '9=為不列入核判表之案件性質
'            PUB_ChkIsSetPromoterReader = True
'         Else
            '外專人員:ST52=核稿人;像OA、申復核完就判發了
            '僅日本組工程師有核稿人、判發人
            '3.抓ST52,抓ST53
            strTmp = "SELECT * FROM STAFF WHERE ST01='" & strEmp & "'"
            intA = 1
            Set rsAD = ClsLawReadRstMsg(intA, strTmp)
            If intA = 1 Then
               PUB_ChkIsSetPromoterReader = True
               If strCP10 = "201" And bolPAFlow = True Then 'Modify By Sindy 2024/8/13 + And bolPAFlow = True
                  strPP04 = "" '201.新案翻譯的核稿人是指核稿工程師
                  strPP05 = "" & rsAD.Fields("st52")
               Else
                  'ST61=歷程判發人為三級主管
                  If "" & rsAD.Fields("st61") = "Y" Then
                  'If PUB_GetST03(strEmp) = "F21" And "" & rsad.Fields("st16") = "3" Then '日文組工程師
                     strPP04 = "" & rsAD.Fields("st52")
                     strPP05 = "" & rsAD.Fields("st53")
                  Else
                     'Modify By Sindy 2024/1/9
                     '工程師主管一致覺得二級主管預設在判發人,因實務上大部分都只要送判
                     '若需要送核,工程師再自行填入核稿人主管
                     'Add By Sindy 2024/1/2
'                     If PUB_GetST03(strEmp) = "F22" Then '外專程序人員僅操作送判
                        strPP04 = ""
                        strPP05 = "" & rsAD.Fields("st52")
'                     Else
'                     '2024/1/2 END
'                        strPP04 = "" & rsad.Fields("st52")
'                        strPP05 = ""
'                     End If
                  End If
               End If
            End If
'         End If
'      End If
      Exit Function
   End If
   '2023/9/25 END
   
   'Add By Sindy 2018/8/2
   '****************************************
   '商標案 : 由相關總收文號性質來決定:
   '****************************************
   If bolTMFlow = True And strCP09 <> "" Then
      'Add By Sindy2018/12/14 69008.林純貞經理提
      '請將承辦人為69008(我)的C類案件,全部設為不須核稿人(自行核判)
      'A類且申請國家為020(大陸地區)的案件,也是自行核判。
      'A類且申請國家為台灣時,設為何律師核判,因林律師留職停薪。
      If strEmp = "69008" Then
         'C類及申請國家非台灣者,均自行核判
         If Left(strCP09, 1) = "C" Or strNA01 <> "000" Then
            PUB_ChkIsSetPromoterReader = True
            Exit Function
         End If
      End If
      
      '1705.取消催審期限
      '1706.其他來函
      '1724.通知已轉他所
      If (strCP10 = "1705" Or strCP10 = "1706" Or strCP10 = "1724") Then
         '讀一層相關總收文號
         strSql = "select cp01,cp02,cp03,cp04,cp09,cp10,cp13 from caseprogress where cp09=(select cp43 from caseprogress where cp09='" & strCP09 & "' and cp43 is not null)"
         intA = 1
         Set rsQuery = ClsLawReadRstMsg(intA, strSql)
         If intA = 1 Then
            'strCP10 = rsQuery.Fields("cp10") 'Modify By Sindy 2025/5/7 mark
            strCP43 = rsQuery.Fields("cp09") '相關總收文號
            'strCP13 = rsQuery.Fields("cp13") '智權人員
            '目前智權人員
            strCP13 = PUB_GetAKindSalesNo(rsQuery.Fields("cp01"), rsQuery.Fields("cp02"), rsQuery.Fields("cp03"), rsQuery.Fields("cp04"))
            'Add By Sindy 2025/5/7
            '爭議案件
            If InStr(TMdebate, "" & rsQuery.Fields("cp10")) > 0 Then
               strCPM23 = "G" 'G.商爭分析
            Else
               strCPM23 = "F" 'F.商申分析
            End If
            '2025/5/7 END
         End If
      '1005.延期受理
      ElseIf (strCP10 = "1005") Then
         '讀二層相關總收文號
         strSql = "select cp01,cp02,cp03,cp04,cp09,cp10,cp13 from caseprogress where cp09=(select cp43 from caseprogress where cp09=(select cp43 from caseprogress where cp09='" & strCP09 & "' and cp43 is not null) and cp43 is not null)"
         intA = 1
        Set rsQuery = ClsLawReadRstMsg(intA, strSql)
         If intA = 1 Then
            'strCP10 = rsQuery.Fields("cp10") 'Modify By Sindy 2025/5/7 mark
            strCP43 = rsQuery.Fields("cp09") '相關總收文號
            'strCP13 = rsQuery.Fields("cp13") '智權人員
            '目前智權人員
            strCP13 = PUB_GetAKindSalesNo(rsQuery.Fields("cp01"), rsQuery.Fields("cp02"), rsQuery.Fields("cp03"), rsQuery.Fields("cp04"))
            'Add By Sindy 2025/5/7
            '爭議案件
            If InStr(TMdebate, "" & rsQuery.Fields("cp10")) > 0 Then
               strCPM23 = "G" 'G.商爭分析
            Else
               strCPM23 = "F" 'F.商申分析
            End If
            '2025/5/7 END
         End If
      End If
   End If
   '****************************************
   
   'Add By Sindy 2018/8/1
   If bolTMFlow = True Then
      '先檢查有沒有個別設定:
      strSql = "select cpm23 from casepropertymap where cpm01='" & strCP01 & "' and cpm02='" & strCP10 & "' and cpm23 is not null"
      intA = 1
      Set rsQuery = ClsLawReadRstMsg(intA, strSql)
      If intA = 0 Then
         strPP01 = "T" '無個別設定,商標則統一用T系統別抓核判資料
      End If
   End If
   '2018/8/1 END
   'Add By Sindy 2025/5/7
   If strCPM23 = "" Then
   '2025/5/7 END
      'strSql = "select cpm23 from casepropertymap where cpm01='" & strCP01 & "' and cpm02='" & strCP10 & "'"
      strSql = "select cpm23 from casepropertymap where cpm01='" & strPP01 & "' and cpm02='" & strCP10 & "'"
      intA = 1
      Set rsQuery = ClsLawReadRstMsg(intA, strSql)
      If intA = 1 Then
         strCPM23 = "" & rsQuery.Fields("cpm23")
      End If
   End If
   strPP03 = strCPM23 'Add By Sindy 2018/8/13
   
   If strCPM23 = "9" Then '9=為不列入核判表之案件性質
      PUB_ChkIsSetPromoterReader = True
   'Add By Sindy 2021/10/14 智財報告書
   ElseIf strCP01 = "ACS" Then
      PUB_ChkIsSetPromoterReader = True
      '核判表:
      '智財報告書103, 核稿是A9005教威, 核判是A5024秀娟;教威的智財報告書是秀娟直接核判。
      '其他案件性質不用核稿只有送判。
      'Modify By Sindy 2023/11/7 秀娟取消,換教威
'      If strCP10 = "103" Then
'         strPP04 = "A9005"
         strPP04 = ""
         strPP05 = "A9005"
'      Else
'         strPP04 = ""
'         strPP05 = "A5024"
'      End If
      '2023/11/7 END
   '2021/10/14 END
   Else
      'Add By Sindy 2018/5/2
      '商標大陸案(案件性質3碼的),TF
      If bolTMFlow = True And (strNA01 = "020" Or strCP01 = "TF") And Len(strCP10) = 3 Then
         '申請,續展
         'Modify By Sindy 2021/11/8 + 變更(301)移轉(501)許可合同(502)
         'Modify By Sindy 2022/2/24 + 103補換發證書
         If strCP10 = "101" Or strCP10 = "102" Or strCP10 = "301" Or strCP10 = "501" Or strCP10 = "502" Or strCP10 = "103" Then
            strSql = "select * from PROMOTERPROOFREADER where pp01='" & strPP01 & "' and pp02='" & strEmp & "' and pp03='H' and PP06 in('" & strNA01 & "','*') order by pp06 desc"
         Else
            strSql = "select * from PROMOTERPROOFREADER where pp01='" & strPP01 & "' and pp02='" & strEmp & "' and pp03='E' and PP06 in('" & strNA01 & "','*') order by pp06 desc"
         End If
      '商標大陸案(案件性質4碼的),TF
      ElseIf bolTMFlow = True And (strNA01 = "020" Or strCP01 = "TF") And Len(strCP10) = 4 Then
         'Modify By Sindy 2019/7/19
         'strSql = "select * from PROMOTERPROOFREADER where pp01='" & strPP01 & "' and pp02='" & strEmp & "' and pp03='G'"
         'modify by sonia 2024/7/3 應為order by 而非group by
         'strSql = "select PP01,PP02,'G' as pp03,PP04,PP05,PP06 from PROMOTERPROOFREADER where pp01='" & strPP01 & "' and pp02='" & strEmp & "' and PP06 in('" & strNA01 & "','*') and (pp03='G' or pp03 in(SELECT CPM02 FROM CASEPROPERTYMAP WHERE CPM23='G' AND CPM01 IN('" & strPP01 & "'))) group by PP01 asc,PP02 asc,PP04 asc,PP05 asc,pp06 desc"
         'Modify By Sindy 2024/7/8 上列程式我沒控管好,再做調整
         'strSql = "select PP01,PP02,'G' as pp03,PP04,PP05,PP06 from PROMOTERPROOFREADER where pp01='" & strPP01 & "' and pp02='" & strEmp & "' and PP06 in('" & strNA01 & "','*') and (pp03='G' or pp03 in(SELECT CPM02 FROM CASEPROPERTYMAP WHERE CPM23='G' AND CPM01 IN('" & strPP01 & "'))) order by PP01 asc,PP02 asc,PP04 asc,PP05 asc,pp06 desc"
         strSql = "select PP01,PP02,'G' as pp03,PP04,PP05,PP06 from PROMOTERPROOFREADER where pp01='" & strPP01 & "' and pp02='" & strEmp & "' and PP06 in('" & strNA01 & "','*') and (pp03='G' or pp03 in(SELECT CPM02 FROM CASEPROPERTYMAP WHERE CPM23='G' AND CPM01 IN('" & strPP01 & "'))) group by PP01,PP02,PP04,PP05,pp06 order by PP01 asc,PP02 asc,pp06 desc,PP04 asc,PP05 asc"
         '2019/7/19 END
         'G=商爭分析
         strCPM23 = "G" 'add by sonia 2018/9/28 T-213659 大陸核駁,否則後面 strCPM23 = "F" 商申面向客戶(分析),非MCTFXX人員不需要核稿會清掉核判人員
      Else
      '2018/5/2 END
         'strSql = "select * from PROMOTERPROOFREADER where pp01='" & strCP01 & "' and pp02='" & strEmp & "' and pp03 in('" & strCPM23 & "','" & strCP10 & "')"
         strSql = "select * from PROMOTERPROOFREADER where pp01='" & strPP01 & "' and pp02='" & strEmp & "' and pp03 in('" & strCPM23 & "','" & strCP10 & "') and PP06 in('" & strNA01 & "','*') order by pp06 desc"
      End If
      intA = 1
      Set rsQuery = ClsLawReadRstMsg(intA, strSql)
      If intA = 1 Then
         PUB_ChkIsSetPromoterReader = True
         strPP03 = "" & rsQuery.Fields("pp03") 'Add By Sindy 2018/8/13
         strPP04 = "" & rsQuery.Fields("pp04") 'Add By Sindy 2015/1/20
         strPP05 = "" & rsQuery.Fields("pp05") 'Add By Sindy 2015/1/20
         
         '***** 商標案 *****
         'Add By Sindy 2018/7/19
         If bolTMFlow = True And strCP09 <> "" Then
            If strCP43 = "" Then '前面有可能已抓取資料
               strSql = "select cp01,cp02,cp03,cp04,cp13,cp43 from caseprogress where cp09='" & strCP09 & "'"
               intA = 1
               Set rsQuery = ClsLawReadRstMsg(intA, strSql)
               If intA = 1 Then
                  'strCP13 = "" & rsQuery.Fields("cp13") '智權人員
                  '目前智權人員
                  strCP13 = PUB_GetAKindSalesNo(rsQuery.Fields("cp01"), rsQuery.Fields("cp02"), rsQuery.Fields("cp03"), rsQuery.Fields("cp04"))
                  strCP43 = "" & rsQuery.Fields("cp43") '相關總收文號
               End If
            End If
            'F=商申分析
            If strCPM23 = "F" And _
               Left(strCP13, 4) <> "MCTF" Then '商申面向客戶(分析)
               '非MCTF01,02,03人員,不需要核稿
               strPP04 = ""
            End If
            'Add By Sindy 2018/7/25
            '讀取相關文號的案件性質主管機關不是經濟部智慧財產局,為經理判發
            'Modify By Sindy 2020/2/21 嘉雯說要排除TC案件 And strCP01 <> "TC"
            'Modify By Sindy 2021/11/2 主管機關不是經濟部智慧財產局,並且為台灣案改由 98003.林律師判發
            If (strCPM23 = "F" Or strCPM23 = "G") And strCP43 <> "" And strCP01 <> "TC" Then '商申,商爭面向客戶(分析)
               strSql = "select cf10 from caseprogress,casefee where cp09='" & strCP43 & "'" & _
                        " and cf01(+)=cp01 and cf02='" & strNA01 & "' and cf03(+)=cp10"
               intA = 1
               Set rsQuery = ClsLawReadRstMsg(intA, strSql)
               If intA = 1 Then
                  If "" & rsQuery.Fields("cf10") <> "" And _
                     "" & rsQuery.Fields("cf10") <> "經濟部智慧財產局" And strNA01 = "000" Then
'                     strSql = "select st01,st02 from staff where st03='P20' and ST20='41' and st04='1'"
'                     inta = 1
'                     Set rsQuery = ClsLawReadRstMsg(inta, strSql)
'                     If inta = 1 Then
'                        strPP05 = "" & rsQuery.Fields("st01") '為經理判發
'                     End If
                     strPP05 = "98003" 'Modify By Sindy 2021/11/2 改由 98003.林律師判發(並且為台灣案)
                  End If
               End If
            End If
            '2018/7/25 END
         End If
         '2018/7/19 END
      End If
      
      '********** 商標案 **********
      'Add By Sindy 2018/5/2
      '特殊的案性性質必須另外判斷
      If bolTMFlow = True Then
         '303.延期 201.補正 --- 為商爭案用代碼(C)
         If (strCP10 = "303" Or strCP10 = "201") And strCP09 <> "" Then
            '讀取相關文號的案件性質主管機關不是經濟部智慧財產局,為商爭案用代碼(C)再抓一次核判設定
            strSql = "select cp43 from caseprogress where cp09='" & strCP09 & "'"
            intA = 1
            Set rsQuery = ClsLawReadRstMsg(intA, strSql)
            If intA = 1 Then
               strCP43 = "" & rsQuery.Fields("cp43")
               If strCP43 <> "" Then
                  'modify by sonia 2018/9/28 +cp10
                  'Modify By Sindy 2018/10/2
                  '承慧說商爭案延期,補正的判發人:
                  '相關文號的案件性質是"經濟部智慧財產局"為承慧（非承慧承辦）判發，
                  '　　　　　　　　不是"經濟部智慧財產局"為經理判發。
                  '但相關文號的案件性質屬於核判表D類者則為所長判發。
                  strSql = "select cf10,cp10,cpm23 from caseprogress,casefee,casepropertymap" & _
                           " where cp09='" & strCP43 & "'" & _
                           " and cf01(+)=cp01 and cf02='" & strNA01 & "' and cf03(+)=cp10" & _
                           " and cpm01(+)=cp01 and cpm02(+)=cp10"
                  intA = 1
                  Set rsQuery = ClsLawReadRstMsg(intA, strSql)
                  If intA = 1 Then
                     strCF10 = "" & rsQuery.Fields("cf10")
                     strCP43CP10 = "" & rsQuery.Fields("cp10")
                     '爭議案件
                     If InStr(TMdebate, "" & rsQuery.Fields("cp10")) > 0 Then
                        If "" & rsQuery.Fields("cpm23") = "D" Then
                           'Modify By Sindy 2019/7/19
                           'strSql = "select * from PROMOTERPROOFREADER where pp01='" & strPP01 & "' and pp02='" & strEmp & "' and pp03='D'"
                           'modify by sonia 2024/7/3 應為order by 而非group by
                           'strSql = "select PP01,PP02,'D' as pp03,PP04,PP05,PP06 from PROMOTERPROOFREADER where pp01='" & strPP01 & "' and pp02='" & strEmp & "' and PP06 in('" & strNA01 & "','*') and (pp03='D' or pp03 in(SELECT CPM02 FROM CASEPROPERTYMAP WHERE CPM23='D' AND CPM01 IN('" & strPP01 & "'))) group by PP01 asc,PP02 asc,PP04 asc,PP05 asc,pp06 desc"
                           'Modify By Sindy 2024/7/8 上列程式我沒控管好,再做調整
                           'strSql = "select PP01,PP02,'D' as pp03,PP04,PP05,PP06 from PROMOTERPROOFREADER where pp01='" & strPP01 & "' and pp02='" & strEmp & "' and PP06 in('" & strNA01 & "','*') and (pp03='D' or pp03 in(SELECT CPM02 FROM CASEPROPERTYMAP WHERE CPM23='D' AND CPM01 IN('" & strPP01 & "'))) order by PP01 asc,PP02 asc,PP04 asc,PP05 asc,pp06 desc"
                           strSql = "select PP01,PP02,'D' as pp03,PP04,PP05,PP06 from PROMOTERPROOFREADER where pp01='" & strPP01 & "' and pp02='" & strEmp & "' and PP06 in('" & strNA01 & "','*') and (pp03='D' or pp03 in(SELECT CPM02 FROM CASEPROPERTYMAP WHERE CPM23='D' AND CPM01 IN('" & strPP01 & "'))) group by PP01,PP02,PP04,PP05,pp06 order by PP01 asc,PP02 asc,pp06 desc,PP04 asc,PP05 asc"
                           '2019/7/19 END
                        Else
                           'Modify By Sindy 2019/7/19
                           'strSql = "select * from PROMOTERPROOFREADER where pp01='" & strPP01 & "' and pp02='" & strEmp & "' and pp03='C'"
                           'modify by sonia 2024/7/3 應為order by 而非group by
                           'strSql = "select PP01,PP02,'C' as pp03,PP04,PP05,PP06 from PROMOTERPROOFREADER where pp01='" & strPP01 & "' and pp02='" & strEmp & "' and PP06 in('" & strNA01 & "','*') and (pp03='C' or pp03 in(SELECT CPM02 FROM CASEPROPERTYMAP WHERE CPM23='C' AND CPM01 IN('" & strPP01 & "'))) group by PP01 asc,PP02 asc,PP04 asc,PP05 asc,pp06 desc"
                           'Modify By Sindy 2024/7/8 上列程式我沒控管好,再做調整
                           'strSql = "select PP01,PP02,'C' as pp03,PP04,PP05,PP06 from PROMOTERPROOFREADER where pp01='" & strPP01 & "' and pp02='" & strEmp & "' and PP06 in('" & strNA01 & "','*') and (pp03='C' or pp03 in(SELECT CPM02 FROM CASEPROPERTYMAP WHERE CPM23='C' AND CPM01 IN('" & strPP01 & "'))) order by PP01 asc,PP02 asc,PP04 asc,PP05 asc,pp06 desc"
                           strSql = "select PP01,PP02,'C' as pp03,PP04,PP05,PP06 from PROMOTERPROOFREADER where pp01='" & strPP01 & "' and pp02='" & strEmp & "' and PP06 in('" & strNA01 & "','*') and (pp03='C' or pp03 in(SELECT CPM02 FROM CASEPROPERTYMAP WHERE CPM23='C' AND CPM01 IN('" & strPP01 & "'))) group by PP01,PP02,PP04,PP05,pp06 order by PP01 asc,PP02 asc,pp06 desc,PP04 asc,PP05 asc"
                           '2019/7/19 END
                        End If
                        intA = 1
                        Set rsQuery = ClsLawReadRstMsg(intA, strSql)
                        If intA = 1 Then
                           PUB_ChkIsSetPromoterReader = True
                           strPP03 = "" & rsQuery.Fields("pp03") 'Add By Sindy 2018/8/13
                           strPP04 = "" & rsQuery.Fields("pp04")
                           strPP05 = "" & rsQuery.Fields("pp05")
                        End If
                        'modify by sonia 2018/9/28 +屬於商爭案件性質 T-213881 申請意見書之延期, 原只以主管機關判斷
'                        If strCF10 <> "" And "" & strCF10 <> "經濟部智慧財產局" Then
'                           strPP05 = "69008" '林經理
'                        Else
'                           strPP05 = "86048" '承慧
'                        End If
                        'Modify By Sindy 2021/11/2 都由 副理 核稿並判發
                        strPP05 = "86048" '承慧
                     Else
                        'Modify By Sindy 2022/7/12 就視為商爭申請案
                        '商標大陸案(案件性質4碼的),TF
                        If bolTMFlow = True And (strNA01 = "020" Or strCP01 = "TF") And Len(strCP43CP10) = 4 Then
                           'modify by sonia 2024/7/3 應為order by 而非group by
                           'strSql = "select PP01,PP02,'G' as pp03,PP04,PP05,PP06 from PROMOTERPROOFREADER where pp01='" & strPP01 & "' and pp02='" & strEmp & "' and PP06 in('" & strNA01 & "','*') and (pp03='G' or pp03 in(SELECT CPM02 FROM CASEPROPERTYMAP WHERE CPM23='G' AND CPM01 IN('" & strPP01 & "'))) group by PP01 asc,PP02 asc,PP04 asc,PP05 asc,pp06 desc"
                           'Modify By Sindy 2024/7/8 上列程式我沒控管好,再做調整
                           'strSql = "select PP01,PP02,'G' as pp03,PP04,PP05,PP06 from PROMOTERPROOFREADER where pp01='" & strPP01 & "' and pp02='" & strEmp & "' and PP06 in('" & strNA01 & "','*') and (pp03='G' or pp03 in(SELECT CPM02 FROM CASEPROPERTYMAP WHERE CPM23='G' AND CPM01 IN('" & strPP01 & "'))) order by PP01 asc,PP02 asc,PP04 asc,PP05 asc,pp06 desc"
                           strSql = "select PP01,PP02,'G' as pp03,PP04,PP05,PP06 from PROMOTERPROOFREADER where pp01='" & strPP01 & "' and pp02='" & strEmp & "' and PP06 in('" & strNA01 & "','*') and (pp03='G' or pp03 in(SELECT CPM02 FROM CASEPROPERTYMAP WHERE CPM23='G' AND CPM01 IN('" & strPP01 & "'))) group by PP01,PP02,PP04,PP05,pp06 order by PP01 asc,PP02 asc,pp06 desc,PP04 asc,PP05 asc"
                           strCPM23 = "G"
                           intA = 1
                           Set rsQuery = ClsLawReadRstMsg(intA, strSql)
                           If intA = 1 Then
                              PUB_ChkIsSetPromoterReader = True
                              strPP03 = "" & rsQuery.Fields("pp03")
                              strPP04 = "" & rsQuery.Fields("pp04")
                              strPP05 = "" & rsQuery.Fields("pp05")
                           End If
                        End If
                        '2022/7/12 END
                     End If
                  End If
               End If
            End If
         End If
         
         'Add By Sindy 2018/8/2
         '****************************************
         '依系統類別區分:
         '****************************************
         '1801.服務業務結果:TB程序,TD商申(F),TM商爭(E),TS商申(F),其他都列商申(F),個人由人員自行修改
         If (strCP10 = "1801") Then
            If strCP01 <> "TB" Then
               If strCP01 = "TM" Then 'TM商爭(E)
                  strCPM23 = "E" 'E=商爭其他
               Else '商申(F)
                  strCPM23 = "F" 'F=商申分析
               End If
               If strCPM23 <> "" Then
                  'Modify By Sindy 2019/7/19
                  'strSql = "select * from PROMOTERPROOFREADER where pp01='" & strPP01 & "' and pp02='" & strEmp & "' and pp03='" & strCPM23 & "'"
                  'modify by sonia 2024/7/3 應為order by 而非group by
                  'strSql = "select PP01,PP02,'" & strCPM23 & "' as pp03,PP04,PP05,PP06 from PROMOTERPROOFREADER where pp01='" & strPP01 & "' and pp02='" & strEmp & "' and PP06 in('" & strNA01 & "','*') and (pp03='" & strCPM23 & "' or pp03 in(SELECT CPM02 FROM CASEPROPERTYMAP WHERE CPM23='" & strCPM23 & "' AND CPM01 IN('" & strPP01 & "'))) group by PP01 asc,PP02 asc,PP04 asc,PP05 asc,pp06 desc"
                  'Modify By Sindy 2024/7/8 上列程式我沒控管好,再做調整
                  'strSql = "select PP01,PP02,'" & strCPM23 & "' as pp03,PP04,PP05,PP06 from PROMOTERPROOFREADER where pp01='" & strPP01 & "' and pp02='" & strEmp & "' and PP06 in('" & strNA01 & "','*') and (pp03='" & strCPM23 & "' or pp03 in(SELECT CPM02 FROM CASEPROPERTYMAP WHERE CPM23='" & strCPM23 & "' AND CPM01 IN('" & strPP01 & "'))) order by PP01 asc,PP02 asc,PP04 asc,PP05 asc,pp06 desc"
                  strSql = "select PP01,PP02,'" & strCPM23 & "' as pp03,PP04,PP05,PP06 from PROMOTERPROOFREADER where pp01='" & strPP01 & "' and pp02='" & strEmp & "' and PP06 in('" & strNA01 & "','*') and (pp03='" & strCPM23 & "' or pp03 in(SELECT CPM02 FROM CASEPROPERTYMAP WHERE CPM23='" & strCPM23 & "' AND CPM01 IN('" & strPP01 & "'))) group by PP01,PP02,PP04,PP05,pp06 order by PP01 asc,PP02 asc,pp06 desc,PP04 asc,PP05 asc"
                  '2019/7/19 END
                  intA = 1
                  Set rsQuery = ClsLawReadRstMsg(intA, strSql)
                  If intA = 1 Then
                     PUB_ChkIsSetPromoterReader = True
                     strPP03 = "" & rsQuery.Fields("pp03") 'Add By Sindy 2018/8/13
                     strPP04 = "" & rsQuery.Fields("pp04")
                     strPP05 = "" & rsQuery.Fields("pp05")
                  End If
               End If
            End If
         End If
      End If
      '2018/5/2 END
   End If
   
   Set rsQuery = Nothing
End Function


'Add By Sindy 2013/11/26 檢查是否有專利處的核判權限
'strType : 1.核稿人 2.判發人
'Modify By Sindy 2024/6/26 +, Optional ByVal strNA01 As String = ""
Public Function PUB_ChkPromoterReader(ByVal strCP01 As String, ByVal strCP10 As String, _
                                      ByVal strType As String, ByVal strChkPerson As String, _
                                      Optional ByVal strPP02 As String = "", Optional ByVal strNA01 As String = "") As Boolean
Dim strCPM23 As String
   
   PUB_ChkPromoterReader = False
   
   'Modify By Sindy 2020/5/4 Mark:竺儒退休
'   'Add By Sindy 2014/7/3 竺儒的職代(先抓案件,無,再抓人事),當竺儒休假時其權限同等於竺儒
'   strSql = "select b0101 from abs001,staff where b0101='84012' and b0101=st01(+) and st04='1'" & _
'            " and ((b0102='" & strChkPerson & "' and b0117 is null) or (b0103='" & strChkPerson & "' and b0117 is null) or (b0104='" & strChkPerson & "' and b0117 is null) or (b0105='" & strChkPerson & "' and b0117 is null) or (b0106='" & strChkPerson & "' and b0117 is null) or (b0107='" & strChkPerson & "' and b0117 is null)" & _
'            " or b0117='" & strChkPerson & "' or b0119='" & strChkPerson & "' or b0121='" & strChkPerson & "' or b0123='" & strChkPerson & "')"
'   intI = 1
'   Set RsTemp = ClsLawReadRstMsg(intI, strSql)
'   If intI = 1 Then
'      '是竺儒的職代
'      If RsTemp.RecordCount > 0 Then
'         '竺儒休假
'         If CheckIsPersonRest("84012", strSrvDate(1), Left(Right("000000" & ServerTime, 6), 2) & ":" & Mid(Right("000000" & ServerTime, 6), 3, 2)) = True Then
'            strChkPerson = "84012" '用竺儒的身分檢查其核判權限
'         End If
'      End If
'   End If
'   '2014/7/3 END
   
   'Add By Sindy 2014/4/11 增加檢查是否有自行核或判的權限
   CheckOC3
   strCPM23 = ""
   strSql = "select cpm23 from casepropertymap where cpm01='" & strCP01 & "' and cpm02='" & strCP10 & "'"
   AdoRecordSet3.CursorLocation = adUseClient
   AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If AdoRecordSet3.RecordCount > 0 Then
      strCPM23 = "" & AdoRecordSet3.Fields(0)
   End If
   '2014/4/11 END
   
   CheckOC3
   If strType = "1" Then
      'Modify By Sindy 2014/4/11
      'strSql = "SELECT count(*) FROM promoterproofreader WHERE PP01='" & strCP01 & "' AND PP03='" & strCP10 & "' and PP04='" & strChkPerson & "'"
      'Modify By Sindy 2024/6/26 +pp06
      strSql = "SELECT count(*) FROM promoterproofreader WHERE PP01='" & strCP01 & "' AND PP03 in('" & strCP10 & "'" & IIf(strCPM23 = "", "", ",'" & strCPM23 & "'") & ") and PP04='" & strChkPerson & "' and PP06 in('" & strNA01 & "','*')"
   Else
      'Modify By Sindy 2014/4/11
      'strSql = "SELECT count(*) FROM promoterproofreader WHERE PP01='" & strCP01 & "' AND PP03='" & strCP10 & "' and PP05='" & strChkPerson & "'"
      'Modify By Sindy 2024/6/26 +pp06
      strSql = "SELECT count(*) FROM promoterproofreader WHERE PP01='" & strCP01 & "' AND PP03 in('" & strCP10 & "'" & IIf(strCPM23 = "", "", ",'" & strCPM23 & "'") & ") and PP05='" & strChkPerson & "' and PP06 in('" & strNA01 & "','*')"
   End If
   If strPP02 <> "" Then
      strSql = strSql & " and PP02='" & strPP02 & "'"
   End If
   strSql = strSql & " order by pp06 desc" 'Add By Sindy 2024/6/26
   AdoRecordSet3.CursorLocation = adUseClient
   AdoRecordSet3.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If AdoRecordSet3.RecordCount > 0 Then
      If AdoRecordSet3.Fields(0) > 0 Then
         PUB_ChkPromoterReader = True
      End If
   End If
   CheckOC3
   
   'Add By Sindy 2016/3/8 P案C類(P案件性質4碼為C類)不檢查核判權限
   'Modify By Sindy 2018/5/2 + strCPM23 = "9"
   If (strCP01 = "P" And Len(strCP10) = 4) Or _
      strCPM23 = "9" Then
   '2018/5/2 END
      PUB_ChkPromoterReader = True
   End If
   '2016/3/8 END
End Function

'Add By Sindy 2013/11/27 以收據抬頭讀取最近扣繳確認年度
Public Function PUB_GetA2802LastYear(strA2801 As String) As String
   Dim stSQL As String, intR As Integer
   Dim adoTmp As ADODB.Recordset
   
   PUB_GetA2802LastYear = ""
   'Modify By Sindy 2024/9/30 + ChgSQL
   stSQL = "Select * From ACC280 Where A2801='" & ChgSQL(Trim(strA2801)) & "' order by A2802 desc"
   intR = 1
   Set adoTmp = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      With adoTmp
         .MoveFirst
         PUB_GetA2802LastYear = .Fields("A2802")
      End With
   End If
   Set adoTmp = Nothing
End Function

'Add By Sindy 2013/12/15 檢查是否為不開發票之客戶
'Modify By Sindy 2023/9/4 + Optional chkCU144AorB As String = ""
'Modify By Sindy 2024/9/25 +, strA0k11 As String: 公司別
'chkCU144AorB 傳入C: 檢查是否已呈報
Public Function PUB_ChkCU144isN(strCU01 As String, strCU02 As String, strCU04 As String, strA0K11 As String, _
                                Optional bolShowMsg As Boolean = True, Optional MsgText As String = "", _
                                Optional chkCU144AorB As String = "") As Boolean
   Dim stSQL As String, intR As Integer, strCon As String
   Dim adoTmp As ADODB.Recordset
   
   PUB_ChkCU144isN = False
   If strCU01 <> "" Then
      strCon = " CU01||CU02='" & strCU01 & strCU02 & "'"
   Else
      strCon = " CU04='" & strCU04 & "'"
   End If
   stSQL = "Select cu144 From customer Where" & strCon
   intR = 1
   Set adoTmp = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      With adoTmp
         .MoveFirst
         'Modify By Sindy 2024/9/25 + And strA0k11 = "J"
         If "" & .Fields("cu144") = "N" And strA0K11 = "J" Then
            PUB_ChkCU144isN = True
            If bolShowMsg = True Then
               MsgBox "不開發票之客戶，" & MsgText & "不可選擇智權公司!!!", vbInformation
            End If
            
         'Modify By Sindy 2023/9/4 顯示提示訊息
         ElseIf strA0K11 = "J" Then 'Add By Sindy 2024/9/25 + if J公司才需要檢查
            If chkCU144AorB = "A" And "" & .Fields("cu144") = "A" Then
               MsgBox "注意！此客戶為 A:開立發票請款！", vbInformation, "注意!!!"
            ElseIf chkCU144AorB = "C" Then
               If "" & .Fields("cu144") <> "A" And "" & .Fields("cu144") <> "B" Then
                  PUB_ChkCU144isN = True 'Add By Sindy 2023/10/6
                  MsgBox "注意！此客戶 未呈報 不可先開發票！", vbInformation, "注意!!!"
               End If
            End If
         '2023/9/4 END
         End If
      End With
   End If
   Set adoTmp = Nothing
End Function

'Add By Cheng 2002/07/29
'Modify by Amy 2015/09/09 +參數bolLMsgOnly 只彈訊息,但仍可往下做
Public Function PUB_GetStaffNameDept(ByVal StrST01 As String, ByRef strST02 As String, ByRef strA0902 As String, blnChkQuit As Boolean, Optional ByVal bolLMsgOnly As Boolean = False) As Boolean
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset

PUB_GetStaffNameDept = False
strST02 = ""
strA0902 = ""

StrSQLa = "Select * From STAFF,ACC090 WHERE ST03=A0901(+) AND ST01='" & StrST01 & "'"
rsA.CursorLocation = adUseClient
rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
If rsA.RecordCount > 0 Then
   If blnChkQuit = True Then
      '若非在職
      If rsA.Fields("ST04") <> "1" Then
         'Modify By Sindy 2022/12/2 增加判斷是否留職停薪中
         'MsgBox "此代號員工已離職!!!", vbExclamation + vbOKOnly
         MsgBox "此代號員工" & IIf(PUB_StaffChange04(StrST01) = True, "留職停薪中", "已離職") & "!!!", vbExclamation + vbOKOnly
         If bolLMsgOnly = True Then
            strST02 = "" & rsA.Fields("ST02").Value
            strA0902 = "" & rsA.Fields("A0902").Value
            PUB_GetStaffNameDept = True
         End If
      Else
         strST02 = "" & rsA.Fields("ST02").Value
         strA0902 = "" & rsA.Fields("A0902").Value
         PUB_GetStaffNameDept = True
      End If
   Else
      strST02 = "" & rsA.Fields("ST02").Value
      strA0902 = "" & rsA.Fields("A0902").Value
      PUB_GetStaffNameDept = True
   End If
Else
   MsgBox "此代號不存在於員工檔!!!", vbExclamation + vbOKOnly
End If
If rsA.State <> adStateClosed Then rsA.Close
Set rsA = Nothing
End Function

'Added by Morgan 2013/12/24
'抓目前使用發票日期
Public Function GetInvDate() As String
   Dim stSQL As String, intR As Integer
   Dim rsQuery As ADODB.Recordset
   
   stSQL = "select A4112 from ACC410 where A4101=(select max(A4101) from Acc410 where A4112>0)"
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      GetInvDate = rsQuery(0)
   End If
   Set rsQuery = Nothing
End Function

'抓發票號碼
'pInvDate=發票日期(民國),省略將抓目前使用發票日期並回寫
'intTrans=是否在Transaction中,0:否,1:是
Public Function GetInvNewNo(Optional ByRef pInvDate As String, Optional pInTrans As Boolean = True) As String
   Dim stYYYMM As String
   Dim stSQL As String, intR As Integer
   Dim rsQuery As ADODB.Recordset
   Dim stNowInvDate As String
   
   If pInTrans = False Then
      adoTaie.BeginTrans
   End If
   
   '先鎖定
   stSQL = "Update Acc410 set A4110=A4110 where rownum<2"
   adoTaie.Execute stSQL, intR
   
   stNowInvDate = GetInvDate
   
   '發票日期
   If pInvDate = "" Then
      pInvDate = stNowInvDate
      If pInvDate = "" Then
         pInvDate = strSrvDate(2)
      End If
   ElseIf Val(pInvDate) < Val(stNowInvDate) Then
      Err.Raise 999, , "發票日期不可早於目前使用發票日期!!"
      Exit Function
   End If
      
   
   
   '發票區間
   stYYYMM = Val(pInvDate) \ 100
   
   If intR = 1 Then
      stSQL = "select * from Acc410 where A4101<=" & stYYYMM & " and A4102>=" & stYYYMM
      intR = 1
      Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         With rsQuery
         '尚未使用=>字軌1+起1
         If IsNull(.Fields("A4110")) Or .Fields("A4110") = 0 Then
            GetInvNewNo = .Fields("A4103") & Format(.Fields("A4104"), String(8, "0"))
            stSQL = "Update Acc410 set A4109=1,A4110=A4104,A4112=" & pInvDate & " where A4101<=" & stYYYMM & " and A4102>=" & stYYYMM
            adoTaie.Execute stSQL, intR
               
         '使用範圍1
         ElseIf .Fields("A4109") = 1 Then
            '尚未超出範圍=>最大號+1
            If .Fields("A4110") < .Fields("A4105") Then
               GetInvNewNo = .Fields("A4103") & Format(.Fields("A4110") + 1, String(8, "0"))
               stSQL = "Update Acc410 set A4110=A4110+1,A4112=" & pInvDate & " where A4101<=" & stYYYMM & " and A4102>=" & stYYYMM
               adoTaie.Execute stSQL, intR
            '超出範圍=>字軌2+起2
            Else
               GetInvNewNo = .Fields("A4106") & Format(.Fields("A4107"), String(8, "0"))
               stSQL = "Update Acc410 set A4109=2,A4110=A4107,A4112=" & pInvDate & " where A4101<=" & stYYYMM & " and A4102>=" & stYYYMM
               adoTaie.Execute stSQL, intR
            End If
         '使用範圍2
         ElseIf .Fields("A4109") = 2 Then
            '尚未超出範圍=>最大號+1
            If .Fields("A4110") < .Fields("A4108") Then
               GetInvNewNo = .Fields("A4106") & Format(.Fields("A4110") + 1, String(8, "0"))
               stSQL = "Update Acc410 set A4110=A4110+1,A4112=" & pInvDate & " where A4101<=" & stYYYMM & " and A4102>=" & stYYYMM
               adoTaie.Execute stSQL, intR
            Else
               Err.Raise 999, , "發票號碼超出範圍!!"
               Exit Function
            End If
         End If
         End With
      End If
   End If
   
   If pInTrans = False Then
      adoTaie.CommitTrans
   End If
End Function
'end 2013/12/24

'Add by Morgan 2011/9/22
'以收文號讀取相關收據號碼
Public Function PUB_GetRelateNo2(pNo As String) As String
   Dim strNoList As String
   Dim stSQL As String, intR As Integer
   Dim adoTmp As ADODB.Recordset
   
   stSQL = "select a0j13 from acc0j0 where a0j01='" & pNo & "'"
   intR = 1
   Set adoTmp = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      With adoTmp
      strNoList = .Fields("a0j13")
      .MoveNext
      Do While Not .EOF
         strNoList = strNoList & "," & .Fields("a0j13")
         .MoveNext
      Loop
      End With
   End If
   PUB_GetRelateNo2 = strNoList
   Set adoTmp = Nothing
End Function

'Added by Sindy 2013/12/26
'抓申報日期
Public Function GetInvDataA4111(strInvDate As String) As String
   Dim stSQL As String, intR As Integer
   Dim rsQuery As ADODB.Recordset
   Dim strKey As String
   
   GetInvDataA4111 = ""
   
   If Len(strInvDate) = 7 Then
      strKey = Left(strInvDate, 5)
   ElseIf Len(strInvDate) = 8 Then
      strKey = Val(Left(strInvDate, 6)) - 191100
   Else
      strKey = strInvDate
   End If
   
   stSQL = "select A4111 from ACC410 where " & strKey & " between A4101 and A4102"
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      GetInvDataA4111 = "" & rsQuery(0)
   End If
   Set rsQuery = Nothing
End Function

'Added by Sindy 2014/1/3
'電子發票檢查碼計算公式
Public Function GetInvChkNumber(strInvNo As String) As Integer
Dim strChkNo As String
Dim strData1 As String, strData2 As String, strTemp As String, strVal As String
Dim i As Integer
   
   GetInvChkNumber = 0
   If Len(strInvNo) = 10 Then
      strInvNo = Right(strInvNo, 8)
   ElseIf Len(strInvNo) < 8 Then
      MsgBox "發票號碼有誤,不可小於8碼!!"
      Exit Function
   End If
   
   strChkNo = "70608186"
   '先相乘,得...十位數一排,個位數一排
   strData1 = ""
   strData2 = ""
   strVal = ""
   For i = 1 To 8
      strTemp = CStr(Val(Mid(strChkNo, i, 1)) * Val(Mid(strInvNo, i, 1)))
      If Len(strTemp) = 1 Then
         strData1 = strData1 & "0"
         strData2 = strData2 & strTemp
      Else
         strData1 = strData1 & Left(strTemp, 1)
         strData2 = strData2 & Right(strTemp, 1)
      End If
   Next i
   '再相加,捨去十位數留下個位數
   For i = 1 To 8
      strTemp = CStr(Val(Mid(strData1, i, 1)) + Val(Mid(strData2, i, 1)))
      strVal = strVal & Right(strTemp, 1)
   Next i
   '再將全部個位數相加即得檢查碼
   For i = 1 To 8
      GetInvChkNumber = GetInvChkNumber + Val(Mid(strVal, i, 1))
   Next i
End Function

''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' 取得字串以逗點分隔的Sub字串總數
' Input : strTemp ==> 所要計算子字串個數的母字串
' Output : 傳回以逗號分隔的子字串總數
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Public Function GetSubStringCount(ByVal strTemp As String) As Integer
   Dim nLength As Integer
   Dim nPos As Integer
   Dim nSection As Integer
   nSection = 0
   nLength = Len(strTemp)
   For nPos = 1 To nLength
      If Mid(strTemp, nPos, 1) = "," Then
         If nPos <> nLength Then
            nSection = nSection + 1
         End If
      End If
   Next nPos
   If nSection > 0 Then
      nSection = nSection + 1
   Else
      If IsEmptyText(strTemp) = False Then
         nSection = 1
      End If
   End If
   GetSubStringCount = nSection
End Function

''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' 取得字串中的子字串
' Input : strTemp ==> 原始字串
'         nSec ==> 子字串的索引值 (以1為基底)
' Output : 傳回第nSec個子字串
' 說明 : 若傳入的nSec值超過子字串的總數時, 回傳回空字串
'        此功能需配合函式(GetSubStringCount)來使用
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Public Function GetSubString(ByVal strTemp As String, ByVal nSec As Integer)
   Dim strSub As String
   Dim nLength As Integer
   Dim nPos As Integer
   Dim nX As Integer
   Dim nSection As Integer
   nSection = 1
   nLength = Len(strTemp)
   For nPos = 1 To nLength
      If nSection = nSec Then
         strSub = Empty
         For nX = nPos To nLength
            If Mid(strTemp, nX, 1) = "," Then
               Exit For
            Else
               strSub = strSub & Mid(strTemp, nX, 1)
            End If
         Next nX
         Exit For
      End If
      If Mid(strTemp, nPos, 1) = "," Then
         nSection = nSection + 1
      End If
   Next nPos
   strSub = Trim(strSub)
   GetSubString = strSub
End Function

'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' 取得國家的代碼
' Input : strKEY01 ==> 本所案號的第一個欄位
'         strKEY02 ==> 本所案號的第二個欄位
'         strKEY03 ==> 本所案號的第三個欄位
'         strKEY04 ==> 本所案號的第四個欄位
' Output : 傳回基本檔中國家的代碼
' 說明 : 該函式不會去檢查基本檔是否存在, 即使基本檔不存在改本所案號
'        也會傳回預設國家代碼000, 故若要檢查基本檔是否存在, 請自行以
'        其它函式檢查
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Public Function GetNationNo(ByVal strKEY01 As String, ByVal strKEY02 As String, ByVal strKEY03 As String, ByVal strKEY04 As String) As String
   Dim strSql As String
   Dim rsTmp As ADODB.Recordset
   
   GetNationNo = "000"
   ' 依本所案號讀取基本檔案
   Select Case strKEY01
      ' 讀取商標基本檔
      Case "T", "TF", "CFT", "FCT":
         strSql = "SELECT TM10 FROM TradeMark " & _
                  "WHERE TM01 = '" & strKEY01 & "' AND " & _
                        "TM02 = '" & strKEY02 & "' AND " & _
                        "TM03 = '" & strKEY03 & "' AND " & _
                        "TM04 = '" & strKEY04 & "' "
         Set rsTmp = New ADODB.Recordset
         rsTmp.CursorLocation = adUseClient
         rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
         If rsTmp.RecordCount > 0 Then
            If IsNull(rsTmp.Fields("TM10")) = False Then
               GetNationNo = rsTmp.Fields("TM10")
            End If
         End If
         rsTmp.Close
         Set rsTmp = Nothing
      ' 讀取專利基本檔
      Case "P", "CFP", "FCP":
         strSql = "SELECT PA09 FROM PATENT " & _
                  "WHERE PA01 = '" & strKEY01 & "' AND " & _
                        "PA02 = '" & strKEY02 & "' AND " & _
                        "PA03 = '" & strKEY03 & "' AND " & _
                        "PA04 = '" & strKEY04 & "' "
         Set rsTmp = New ADODB.Recordset
         rsTmp.CursorLocation = adUseClient
         rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
         If rsTmp.RecordCount > 0 Then
            If IsNull(rsTmp.Fields("PA09")) = False Then
               GetNationNo = rsTmp.Fields("PA09")
            End If
         End If
         rsTmp.Close
         Set rsTmp = Nothing
      ' 讀取法務基本檔
      'Modify By Sindy 2009/07/24 增加LIN系統類別
      'modify by sonia 2019/7/31 +ACS系統類別
      Case "L", "CFL", "FCL", "LIN", "ACS":
         strSql = "SELECT LC15 FROM LAWCASE " & _
                  "WHERE LC01 = '" & strKEY01 & "' AND " & _
                        "LC02 = '" & strKEY02 & "' AND " & _
                        "LC03 = '" & strKEY03 & "' AND " & _
                        "LC04 = '" & strKEY04 & "' "
         Set rsTmp = New ADODB.Recordset
         rsTmp.CursorLocation = adUseClient
         rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
         If rsTmp.RecordCount > 0 Then
            If IsNull(rsTmp.Fields("LC15")) = False Then
               GetNationNo = rsTmp.Fields("LC15")
            End If
         End If
         rsTmp.Close
         Set rsTmp = Nothing
      ' 讀取顧問案件基本檔
      Case "LA":
         GetNationNo = "000"
      ' 讀取服務業務基本檔
      Case Else:
         strSql = "SELECT SP09 FROM SERVICEPRACTICE " & _
                  "WHERE SP01 = '" & strKEY01 & "' AND " & _
                        "SP02 = '" & strKEY02 & "' AND " & _
                        "SP03 = '" & strKEY03 & "' AND " & _
                        "SP04 = '" & strKEY04 & "' "
         Set rsTmp = New ADODB.Recordset
         rsTmp.CursorLocation = adUseClient
         rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
         If rsTmp.RecordCount > 0 Then
            If IsNull(rsTmp.Fields("SP09")) = False Then
               GetNationNo = rsTmp.Fields("SP09")
            End If
         End If
         rsTmp.Close
         Set rsTmp = Nothing
   End Select
   
   Set rsTmp = Nothing
End Function

'Added By Sindy 2014/1/29
'取得本所案號新案件的收文日
'Add By Sindy 2018/4/25 + Optional ByVal strColNm As String = "", Optional ByRef strcp118 As String = ""
'                       傳入欲查詢的欄位, 傳出查詢的欄位值
Public Function GetCP31isY_CP05(strCP01 As String, strCP02 As String, strCP03 As String, strCP04 As String, _
   Optional ByVal strColNm As String = "", Optional ByRef strColVal As String = "") As String
   Dim stSQL As String, intR As Integer
   Dim rsQuery As ADODB.Recordset
   
   GetCP31isY_CP05 = strSrvDate(1)
   'Add By Sindy 2018/4/25 + " & IIf(strColNm <> "", "," & strColNm, "") & "
   stSQL = "select cp05" & IIf(strColNm <> "", "," & strColNm, "") & " from caseprogress" & _
           " where cp01='" & strCP01 & "' and cp02='" & strCP02 & "' and cp03='" & strCP03 & "' and cp04='" & strCP04 & "'" & _
           " and cp31='Y'" & _
           " order by cp05 asc"
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      GetCP31isY_CP05 = rsQuery(0)
      'Add By Sindy 2018/4/25
      If strColNm <> "" Then
         strColVal = "" & rsQuery.Fields(strColNm)
      End If
      '2018/4/25 END
   End If
   Set rsQuery = Nothing
End Function

'Added By Sindy 2014/1/29
'若收據開J公司,但案件的特殊出名公司未輸入時,同時發E-MAIL
Public Sub PUB_ChkJCompanyRecv_Mail(strA0K01 As String, strJcomp As String)
Dim stSQL As String, intR As Integer
Dim rsQuery As ADODB.Recordset
Dim RsAdo As ADODB.Recordset
Dim strCP01 As String, strCP02 As String, strCP03 As String, strCP04 As String
Dim strCP13 As String, strCP14 As String, strNation As String, strApp As String
Dim strCaseNo As String
Dim strTo As String, strContext As String
   
   If strJcomp = "J" Then
      stSQL = "select distinct a0j02,a0j01 from acc0j0,acc0k0" & _
              " where a0k01=a0j13(+) and a0k01='" & strA0K01 & "'"
      intR = 1
      Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         rsQuery.MoveFirst
         Do While Not rsQuery.EOF
            If InStr(strCaseNo, rsQuery.Fields(0)) = 0 Then
               strCaseNo = strCaseNo & "," & rsQuery.Fields(0)
               strCP01 = Left(rsQuery.Fields(0), Len(rsQuery.Fields(0)) - 9)
               strCP02 = Left(Right(rsQuery.Fields(0), 9), 6)
               strCP03 = Left(Right(rsQuery.Fields(0), 3), 1)
               strCP04 = Right(rsQuery.Fields(0), 2)
               If strCP01 <> "CFP" And strCP01 <> "CFT" Then 'Add By Sindy 2014/2/12 +if:發E-MAIL給陳金蓮和甄妮的部分則取消
                  If Trim(PUB_GetReceiptComp(strCP01, strCP02, strCP03, strCP04)) = "" Then
                     If strCP01 = "P" Or strCP01 = "PS" Then 'Modify By Sindy 2014/2/12
                        '2016/10/14 modify by sonia 改用A的特殊人員(玲玲)
                        'strTo = Pub_GetSpecMan("A1")
                        strTo = Pub_GetSpecMan("A")
   '                  ElseIf strCP01 = "CFP" Then
   '                     strTo = "85037" '甄妮
                     ElseIf Left(strCP01, 1) = "T" Then 'Modify By Sindy 2014/2/12
                        strTo = Pub_GetSpecMan("內商分案人員") '"73014" '宋若蘭
   '                  ElseIf strCP01 = "CFT" Then
   '                     strTo = "72012" '陳金蓮
                     'Add by Amy 2023/08/23 ACS案發給ACS01
                     ElseIf strCP01 = "ACS" Then
                        'Modified by Lydia 2024/05/14
                        'strTo = "ACS01"
                        strTo = Pub_GetSpecMan("ACS郵件通知主管")
                     Else
                        strTo = Pub_GetSpecMan("程式管理人員") '秀玲
                     End If
                     strCP13 = "": strCP14 = "": strNation = "": strApp = ""
                     stSQL = "select cp13,cp14,s1.st02,s2.st02" & _
                             " From caseprogress,staff s1,staff s2" & _
                             " where cp09='" & rsQuery.Fields(1) & "' and cp13=s1.st01(+) and cp14=s2.st01(+)"
                     intR = 1
                     Set RsAdo = ClsLawReadRstMsg(intR, stSQL)
                     If intR = 1 Then
                        strCP13 = "" & RsAdo.Fields(2)
                        strCP14 = "" & RsAdo.Fields(3)
                     End If
                     stSQL = "select pa09,pa26,na03,NVL(CU04,DECODE(CU05,NULL,CU06,CU05||' '||CU88||' '||CU89||' '||CU90)) cu04" & _
                             " From patent, Nation, customer" & _
                             " where pa01='" & strCP01 & "' and pa02='" & strCP02 & "' and pa03='" & strCP03 & "' and pa04='" & strCP04 & "' and pa09=na01(+)" & _
                             " and substr(pa26,1,8)=cu01(+) and substr(pa26,9,1)=cu02(+)" & _
                             " Union" & _
                             " select tm10,tm23,na03,NVL(CU04,DECODE(CU05,NULL,CU06,CU05||' '||CU88||' '||CU89||' '||CU90)) cu04" & _
                             " From trademark, Nation, customer" & _
                             " where tm01='" & strCP01 & "' and tm02='" & strCP02 & "' and tm03='" & strCP03 & "' and tm04='" & strCP04 & "' and tm10=na01(+)" & _
                             " and substr(tm23,1,8)=cu01(+) and substr(tm23,9,1)=cu02(+)" & _
                             " Union" & _
                             " select lc15,lc11,na03,NVL(CU04,DECODE(CU05,NULL,CU06,CU05||' '||CU88||' '||CU89||' '||CU90)) cu04" & _
                             " From lawcase, Nation, customer" & _
                             " where lc01='" & strCP01 & "' and lc02='" & strCP02 & "' and lc03='" & strCP03 & "' and lc04='" & strCP04 & "' and lc15=na01(+)" & _
                             " and substr(lc11,1,8)=cu01(+) and substr(lc11,9,1)=cu02(+)" & _
                             " Union" & _
                             " select sp09,sp08,na03,NVL(CU04,DECODE(CU05,NULL,CU06,CU05||' '||CU88||' '||CU89||' '||CU90)) cu04" & _
                             " From servicepractice, Nation, customer" & _
                             " where sp01='" & strCP01 & "' and sp02='" & strCP02 & "' and sp03='" & strCP03 & "' and sp04='" & strCP04 & "' and sp09=na01(+)" & _
                             " and substr(sp08,1,8)=cu01(+) and substr(sp08,9,1)=cu02(+)"
                     intR = 1
                     Set RsAdo = ClsLawReadRstMsg(intR, stSQL)
                     If intR = 1 Then
                        strNation = "" & RsAdo.Fields(2)
                        strApp = "" & RsAdo.Fields(3)
                     End If
                     strContext = strContext & "本所案號：" & strCP01 & "-" & strCP02 & "-" & strCP03 & "-" & strCP04 & vbCrLf & _
                                               "申請國家：" & strNation & vbCrLf & _
                                               "　申請人：" & strApp & vbCrLf & _
                                               "　承辦人：" & strCP14 & vbCrLf & _
                                               "智權人員：" & strCP13 & vbCrLf & vbCrLf
                  End If
               End If
            End If
            rsQuery.MoveNext
         Loop
      End If
      If strContext <> "" And strTo <> "" Then
         PUB_SendMail strUserNum, strTo, "", _
                      strCP01 & "-" & strCP02 & IIf(strCP03 & strCP04 = "000", "", "-" & strCP03 & IIf(strCP04 = "000", "", "-" & strCP04)) & "的收據為智權公司, 請確認接洽記錄單再輸入案件的特殊出名公司!", _
                      strContext
      End If
      Set rsQuery = Nothing
      Set RsAdo = Nothing
   End If
End Sub

''Add By Sindy 2014/2/7
''檢查暫不列印是否有更新DB成功
'Public Sub PUB_TempChkA0K32isN(ByVal strA0K01 As String)
'   strExc(0) = "select cp01,cp02,cp03,cp04,cp09,cp27,cp151,cp61,acc0k0.* from acc0k0,caseprogress" & _
'               " where a0k01='" & strA0K01 & "' and a0k01=cp60(+)"
'   intI = 1
'   Set rsAdo = ClsLawReadRstMsg(intI, strExc(0))
'   If intI = 1 Then
'      PUB_SendMail strUserNum, "97038", "", "檢查暫不列印是否有更新DB成功,收據號碼=" & strA0K01, _
'              "A0K01：" & rsAdo.Fields("A0K01") & vbCrLf & _
'              "A0K32：" & rsAdo.Fields("A0K32") & vbCrLf & _
'              "CP151：" & rsAdo.Fields("CP151") & vbCrLf & _
'              "CP27：" & rsAdo.Fields("CP27") & vbCrLf & _
'              "CP61：" & rsAdo.Fields("CP61") & vbCrLf & _
'              "CP09：" & rsAdo.Fields("CP09") & vbCrLf & _
'              "本所案號：" & rsAdo.Fields("CP01") & "-" & rsAdo.Fields("CP02") & "-" & rsAdo.Fields("CP03") & "-" & rsAdo.Fields("CP04") & vbCrLf
'   End If
'End Sub

'Add By Sindy 2014/2/11 C類該案號最新收據抬頭
Public Function GetReceiptTitle_C(strReceNo As String, strCaseNo As String) As String
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset
   
   GetReceiptTitle_C = ""
   If Left(strReceNo, 1) = "C" Then
      'Added by Morgan 2015/6/15
      '先抓報價有設抬頭者
      StrSQLa = "select lc16 from lettercache where lc01='" & strReceNo & "' and lc02=0 and lc16 is not null"
      rsA.CursorLocation = adUseClient
      rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
      If rsA.RecordCount > 0 Then
         GetReceiptTitle_C = "" & rsA.Fields("lc16")
      Else
      'end 2015/6/15
         rsA.Close 'Add By Sindy 2015/6/17
         StrSQLa = "Select A0K04,A0K02 From ACC0K0,ACC0J0 Where A0J02='" & strCaseNo & "'" & _
                   " and A0J13=A0K01(+) and (a0k09 is null or a0k09=0) and A0K04 is not null" & _
                   " Order By A0K02 desc"
         rsA.CursorLocation = adUseClient
         rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
         If rsA.RecordCount > 0 Then
            rsA.MoveFirst
            GetReceiptTitle_C = "" & rsA.Fields("A0K04")
         End If
         
      End If 'Added by Morgan 2015/6/15
      
      If rsA.State <> adStateClosed Then rsA.Close
      Set rsA = Nothing
   End If
End Function
'Added by Morgan 2014/2/17
'讀取彼所案號異動資料
Public Function PUB_GetFCCaseNo(pCP60 As String, ByRef opRefNo As String, Optional pIs605or102 As Boolean = False) As Boolean
   Dim stSQL As String, intR As Integer
   Dim rsQuery As ADODB.Recordset
   
   opRefNo = ""
   'Modified by Morgan 2016/8/8 +因有可能要跟新代理人請款,加判斷代理人編號 Ex.X10510391(FCP-49798)
   stSQL = "select FL06 from acc1k0,FCCaseNoLog where a1k01='" & pCP60 & "' and FL01(+)=a1k13 and FL02(+)=a1k14 and FL03(+)=a1k15 and FL04(+)=a1k16 and FL05(+)=a1k03 and FL07='" & IIf(pIs605or102 = True, "1", "2") & "' and FL09*1000000+FL10>(a1k19+19110000)*1000000+a1k20 order by FL09 asc,FL10 asc"
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      opRefNo = "" & rsQuery(0)
      PUB_GetFCCaseNo = True
   End If
   Set rsQuery = Nothing
End Function

'Add By Sindy 2014/2/19
'檢查台灣商標延展跨類的規費
Public Function PUB_ChkTawT102MClassFee(strTM01 As String, strTM02 As String, strTM03 As String, strTM04 As String, _
                                        dblFee As Double, strCP07 As String) As String
   Dim stSQL As String, intR As Integer
   Dim rsQuery As ADODB.Recordset
   Dim intMoney As Long  '倍數
   Dim strClass As String, strNation As String
   Dim tmpArr As Variant
   Dim dblCountFee As Double
   
   PUB_ChkTawT102MClassFee = ""
   strTM02 = Right("000000" & strTM02, 6)
   strTM03 = Right("0" & strTM03, 1)
   strTM04 = Right("00" & strTM04, 2)
   
   stSQL = "select TM09,TM10 from trademark where tm01='" & strTM01 & "' and tm02='" & strTM02 & "' and tm03='" & strTM03 & "' and tm04='" & strTM04 & "'"
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      strClass = Trim("" & rsQuery.Fields("TM09"))
      strNation = Trim("" & rsQuery.Fields("TM10"))
   End If
   rsQuery.Close
   
   If strNation = "000" And strClass <> "" Then
      tmpArr = Split(IIf(Right(strClass, 1) = ",", Mid(strClass, 1, Len(strClass) - 1), strClass), ",")
      '有跨類才需要檢查
      If (Val(UBound(tmpArr)) + 1) > 1 Then
         intMoney = 1
         If strCP07 <> "" Then
            strCP07 = Val(DBDATE(strCP07)) - 19110000
            '若系統日的昨天為非工作天, 則以系統日的前一個工作天做比較
            If ChkWorkDay(DBDATE(DateAdd("d", -1, ChangeWStringToWDateString(strSrvDate(1))))) = False Then
               If Val(strCP07) < (Val(CompWorkDay(1, DBDATE(DateAdd("d", -1, ChangeWStringToWDateString(strSrvDate(1)))), 1)) - 19110000) And Val(strCP07) <> 0 Then
                  intMoney = 2
               End If
            Else
               If Val(strCP07) < Val(GetTaiwanTodayDate) And Val(strCP07) <> 0 Then
                  intMoney = 2
               End If
            End If
         End If
         dblCountFee = 4000 * (Val(UBound(tmpArr)) + 1) * intMoney
         If Val(dblFee) <> dblCountFee Then
            If MsgBox("規費不符，本案類別數共" & (Val(UBound(tmpArr)) + 1) & "類，每類4,000元，應為" & Format(dblCountFee, "#,##0") & "元" & IIf(intMoney = 2, "（含逾期加倍）", "") & "。" & vbCrLf & _
                      "是否所有類別都要延展？", vbYesNo + vbQuestion) = vbYes Then
               PUB_ChkTawT102MClassFee = "N"
            Else
               PUB_ChkTawT102MClassFee = "Y"
            End If
         End If
      End If
   End If
   Set rsQuery = Nothing
End Function

'Added by Morgan 2014/3/10
'特殊請款金額(目前寫在程式內,將來改Table設定)
'Removed by Morgan 2015/6/8 取消,因目前只有兩家且條件不同改在請款通知函內控制
'Public Function PUB_GetSpecInvoiceFee(pAgenetNo As String, pSysCode As String, pItemCode As String, pInvoiceDate As String, pRate As Double, pNTFee As String) As Boolean
'   'BASF 請款金額固定
'   If pAgenetNo = "Y45814010" And Val(DBDATE(pInvoiceDate)) >= 20130902 And pSysCode = "FCP" Then
'      If pItemCode = "601" Then
'         pNTFee = 180 * Val(pRate)
'         PUB_GetSpecInvoiceFee = True
'      'Removed by Morgan 2015/6/5 沒有用(此為實審+主動修正的費用,非系統自動產生)
'      'ElseIf pItemCode = "416" Then
'      '   pNTFee = 160 * Val(pRate)
'      '   PUB_GetSpecInvoiceFee = True
'      End If
'   End If
'End Function


'*************************************************

'*************************************************
'  電腦自動給號
'
'*************************************************
'Modified by Morgan 2014/3/10 同名函數整合
'Modified by Morgan 2020/4/29 +bolNumOnly: True=只要回傳數字
Public Function AutoNo(InputItem As String, InputLength As Integer, Optional intTrans As Integer = 0, Optional bolNumOnly As Boolean = False) As String
Dim adoaccnum As New ADODB.Recordset
Dim strItem As String, strYes As String


'911106 NICK '911106 nick 避免相同連線作做2次 transation
Dim BolTransOk As Boolean

   If intTrans = 0 Then
      BolTransOk = True
   Else
      BolTransOk = False
   End If

On Error GoTo TransErr
   
   If adoTaie.ConnectionString = "" Then Set adoTaie = cnnConnection 'Added by Morgan 2017/11/13
   
   If BolTransOk = True Then
      adoTaie.BeginTrans
   End If
   
   adoTaie.Execute "update autonumber set au03 = au03 where au01 = '" & InputItem & "'"
   If Len(InputItem) > 1 Then
      strItem = Mid(InputItem, 2, 1)
   Else
      strItem = InputItem
   End If
   
   If bolNumOnly = True Then strItem = "" 'Added by Morgan 2020/4/29 只回傳流水號控制
   
   adoaccnum.CursorLocation = adUseClient
   adoaccnum.Open "select * from autonumber where au01 = '" & InputItem & "'", adoTaie, adOpenStatic, adLockReadOnly
   If adoaccnum.RecordCount = 0 Then
      If InputItem = "E" Then
         AutoNo = strItem & Mid(ACDate(strSrvDate(1)), 1, 3) & ZeroBeforeNo("2000", InputLength)
      Else
         'Modified by Morgan 2012/1/9 收款單號有可能跨年預先使用
         'AutoNo = strItem & Mid(strSrvDate(2), 1, 3) & ZeroBeforeNo("0", InputLength)
         If InputItem = "F" Then
            AutoNo = UpdateNo("acc0l0", "a0l01", 5, strSrvDate(2), InputItem)
            If AutoNo = "" Then
               AutoNo = strItem & Mid(strSrvDate(2), 1, 3) & ZeroBeforeNo("0", InputLength)
            End If
         'end 2012/1/9
         
         ElseIf InputItem = "U" Or InputItem = "V" Then
            AutoNo = strItem & Mid(ACDate(strSrvDate(1)), 1, 3) & ZeroBeforeNo("0", InputLength)
            
         Else
            'Modify By Sindy 2010/8/17 比對自動編號年度
            'Modify by Morgan 2011/1/5 +K
            If InputItem = "A" Or InputItem = "B" Or InputItem = "C" Or _
               InputItem = "D" Or InputItem = "DP" Or InputItem = "K" Then
               AutoNo = strItem & CompAutoNumberYear(Val(Mid(ACDate(strSrvDate(1)), 1, 3))) & ZeroBeforeNo("0", InputLength)
            '2010/8/17 End
            Else
               AutoNo = strItem & Val(Mid(ACDate(strSrvDate(1)), 1, 3)) & ZeroBeforeNo("0", InputLength)
            End If
         End If
      End If
   Else
      If adoaccnum.Fields("au02").Value <> Val(Mid(strSrvDate(1), 1, 4)) Then
         If InputItem = "E" Then
            AutoNo = strItem & Mid(ACDate(strSrvDate(1)), 1, 3) & ZeroBeforeNo("2000", InputLength)
         Else
            If InputItem = "U" Or InputItem = "V" Then
               AutoNo = strItem & Mid(ACDate(strSrvDate(1)), 1, 3) & ZeroBeforeNo("0", InputLength)
            Else
               'Modify By Sindy 2010/8/17 比對自動編號年度
               'Modify by Morgan 2011/1/5 +K
               If InputItem = "A" Or InputItem = "B" Or InputItem = "C" Or _
                  InputItem = "D" Or InputItem = "DP" Or InputItem = "K" Then
                  AutoNo = strItem & CompAutoNumberYear(Val(Mid(ACDate(strSrvDate(1)), 1, 3))) & ZeroBeforeNo("0", InputLength)
               '2010/8/17 End
               Else
                  AutoNo = strItem & Val(Mid(ACDate(strSrvDate(1)), 1, 3)) & ZeroBeforeNo("0", InputLength)
               End If
            End If
         End If
      Else
         If InputItem = "U" Or InputItem = "V" Then
            AutoNo = strItem & Mid(ACDate(strSrvDate(1)), 1, 3) & ZeroBeforeNo(str(adoaccnum.Fields("au03").Value), InputLength)
         Else
            'Modify By Sindy 2010/8/17 比對自動編號年度
            'Modify by Morgan 2011/1/5 +K
            If InputItem = "A" Or InputItem = "B" Or InputItem = "C" Or _
               InputItem = "D" Or InputItem = "DP" Or InputItem = "K" Then
               AutoNo = strItem & CompAutoNumberYear(Val(Mid(ACDate(strSrvDate(1)), 1, 3))) & ZeroBeforeNo(str(adoaccnum.Fields("au03").Value), InputLength)
            '2010/8/17 End
            Else
               AutoNo = strItem & Val(Mid(ACDate(strSrvDate(1)), 1, 3)) & ZeroBeforeNo(str(adoaccnum.Fields("au03").Value), InputLength)
            End If
         End If
      End If
   End If
   
   'Modified by Lydia 2024/05/03 查名單-網中：增加HH=TMQAppForm
   If Len(InputItem) = 1 Or InputItem = "HH" Then
      If InputItem = "U" Or InputItem = "V" Then
         strYes = SaveAutoNo(InputItem, Mid(AutoNo, 5, InputLength))
      Else
         'Modify By Sindy 2010/8/17
         'Modify by Morgan 2011/1/5 +K
         If InputItem = "A" Or InputItem = "B" Or InputItem = "C" Or _
            InputItem = "D" Or InputItem = "DP" Or InputItem = "K" Or _
            Val(Mid(ACDate(strSrvDate(1)), 1, 3)) <= 99 Then
            strYes = SaveAutoNo(InputItem, Mid(AutoNo, 4, InputLength))
         '2010/8/17 End
         Else
            strYes = SaveAutoNo(InputItem, Mid(AutoNo, 5, InputLength))
         End If
      End If
      
   'Added by Morgan 2020/4/29
   ElseIf bolNumOnly = True Then
      strYes = SaveAutoNo(InputItem, Mid(AutoNo, 4))
   'end 2020/4/29
   
   End If
   adoaccnum.Close
   
   If BolTransOk Then
      adoTaie.CommitTrans
   End If
   
'911106 nick 避免相同連線作做2次 transation
   Exit Function
   
TransErr:
   If Err.Number = -2147168237 Then
      BolTransOk = False
      Resume Next
   End If
End Function

'*************************************************
'  電腦給號存檔
'
'*************************************************
Public Function SaveAutoNo(InputItem, InputNo As String) As String
Dim adoaccnum As New ADODB.Recordset
   adoaccnum.CursorLocation = adUseClient
   adoaccnum.Open "select * from autonumber where au01 = '" & InputItem & "'", cnnConnection, adOpenDynamic, adLockBatchOptimistic
   If adoaccnum.RecordCount = 0 Then
      adoaccnum.AddNew
      adoaccnum.Fields("au01").Value = InputItem
   End If
   adoaccnum.Fields("au02").Value = Mid(strSrvDate(1), 1, 4)
   adoaccnum.Fields("au03").Value = InputNo
   adoaccnum.UpdateBatch
   adoaccnum.Close
   SaveAutoNo = "Y"
End Function

'Added by Morgan 2019/5/15
'*************************************************
'  電腦自動給號(流水號)
'
'*************************************************
Public Function GetAutoNo(InputItem, Optional pInTrans As Boolean = True) As String
   Dim rsQuery As ADODB.Recordset
   Dim intQ As Integer, stSQL As String
   
   If pInTrans = False Then cnnConnection.BeginTrans
   
   stSQL = "update autonumber set au03 = au03+1 where au01 = '" & InputItem & "'"
   cnnConnection.Execute stSQL, intQ
   
   stSQL = "select au03 from autonumber where au01 = '" & InputItem & "'"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      GetAutoNo = rsQuery(0)
   End If
   
   If pInTrans = False Then cnnConnection.CommitTrans
   Set rsQuery = Nothing
End Function

'*************************************************
'  自動給過去年度之流水號
'
'*************************************************
Public Function UpdateNo(strTable As String, strField As String, intLength As Integer, strDate As String, Optional strDocNo As String = "") As String
Dim adoaccnum As New ADODB.Recordset

On Error GoTo Checking
   adoaccnum.CursorLocation = adUseClient
   adoaccnum.Open "select nvl(max(" & strField & "), 0) from " & strTable & " where substr(" & strField & ", 2, 3) = '" & Mid(strDate, 1, 3) & "'", adoTaie, adOpenStatic, adLockReadOnly
   If adoaccnum.RecordCount <> 0 Then
      If IsNull(adoaccnum.Fields(0).Value) = False Then
         If adoaccnum.Fields(0).Value = "0" Then
            UpdateNo = strDocNo & Mid(strDate, 1, 3) & ZeroBeforeNo(Mid(adoaccnum.Fields(0).Value, 5, intLength), intLength)
         Else
            UpdateNo = Mid(adoaccnum.Fields(0).Value, 1, 4) & ZeroBeforeNo(Mid(adoaccnum.Fields(0).Value, 5, intLength), intLength)
         End If
'         strYes = SaveAutoNo(Mid(adoaccnum.Fields(0).Value, 1, 1), Mid(UpdateNo, 5, intLength))
      End If
   End If
   adoaccnum.Close
Checking:
   If Err.Number = 0 Then
      Exit Function
   End If
   MsgBox Err.Description, , MsgText(5)
End Function
'Added by Morgan 2014/3/7
'抓印表機名稱對應的陣列值
Public Function Pub_GetPrinterIndex(ByVal Printername As String) As Long
   Dim ii As Long
   Pub_GetPrinterIndex = -1
   For ii = 0 To Printers.Count - 1
    If UCase(Printers(ii).DeviceName) = UCase$(Printername) Then
     Pub_GetPrinterIndex = ii
     Exit For
    End If
   Next ii
End Function

'Add by Amy 2014/03/20 因應台日優先權證明文件控管
'以本所案號抓取優先權資料對照檔且優先權國家為日本，專利種類為發明或新型，判斷其優先權存取碼是否為空值
Public Function ChkPD09Null(ByVal strNo1 As String, ByVal strNo2 As String, ByVal strNo3 As String, ByVal strNo4 As String) As Boolean
Dim rsTmp As ADODB.Recordset
Dim strTmp As String, intA As Integer  'Added by Lydia 2024/05/14

   strTmp = "Select pd09 From PriDate Where pd01='" & strNo1 & "' And pd02='" & strNo2 & "' " & _
                     "And pd03='" & strNo3 & "' And pd04='" & strNo4 & "' And pd07='011' And InStr('1,2',pd08)>0 "
   intA = 1
   Set rsTmp = ClsLawReadRstMsg(intA, strTmp)
   If intA = 1 Then
      If IsNull(rsTmp.Fields("pd09")) Then
         ChkPD09Null = True
         Exit Function
      End If
   End If
   ChkPD09Null = False
   
   Set rsTmp = Nothing
End Function
'end 2014/03/20

'Add By Sindy 2014/11/13 取得目前最大的發明人序號
Public Function PUB_GetMaxPi05(strCaseNo1 As String, strCaseNo2 As String, StrCaseNo3 As String, strCaseNo4 As String) As Integer
Dim rsTmp As ADODB.Recordset
Dim strTmp As String, intA As Integer 'Added by Lydia 2024/05/15

   PUB_GetMaxPi05 = 0
   strTmp = "Select nvl(max(pi05),0) From PatentInventor Where pi01='" & strCaseNo1 & "' And pi02='" & strCaseNo2 & "'" & _
                     " And pi03='" & StrCaseNo3 & "' And pi04='" & strCaseNo4 & "'"
   intA = 1
   Set rsTmp = ClsLawReadRstMsg(intA, strTmp)
   If intA = 1 Then
      PUB_GetMaxPi05 = "" & rsTmp.Fields(0)
   End If
   
   Set rsTmp = Nothing
End Function

'Modify by Amy 2014/04/23  從frm040104_3 搬過來並修改
'bolInvCopyOnly: 只複製關聯案發明人至發明人基本檔 / strDefInv:傳回預設關聯案發明人
'複製發明人資料 Add by Morgan 2011/3/25
Public Sub CopyInventor(ByVal PaNoSrc As String, ByVal PaNoTrg As String, Optional bolInvCopyOnly As Boolean = False, Optional strDefInv As String = "")
   Dim stSQL As String, ii As Integer, jj As Integer
   Dim adoSrc As ADODB.Recordset
   Dim adoChk As ADODB.Recordset
   Dim strIN01 As String, strIN02 As String
   Dim bDone As Boolean
   'Add By Sindy 2014/11/12
   Dim strSrcCase(1 To 4) As String
   Dim strOrgCase(1 To 4) As String
   Dim intGetMaxPi05 As Integer
   '2014/11/12 END
   Dim intA As Integer 'Added by Lydia 2024/05/15
   
   strDefInv = "" 'Added by Morgan 2023/8/8 發明人編號會有Y,修正回傳內容異常問題 Ex:CFP-033924
   
   ChgCaseNo PaNoSrc, strSrcCase
   ChgCaseNo PaNoTrg, strOrgCase
   '抓來源案件的發明人資料並依發明人欄位次排序
   'Modify By Sindy 2014/11/12
   'Modify by Amy 2019/05/07 +in05,in06 也要比對英日名稱,else程式Mark
   If strSrvDate(1) >= 專利發明人檔啟用日 Then
      stSQL = "select in01,in02,in03,in04,pi05,in05,in06" & _
              " from PatentInventor,inventor where pi01='" & strSrcCase(1) & "' and pi02='" & strSrcCase(2) & "' and pi03='" & strSrcCase(3) & "' and pi04='" & strSrcCase(4) & "'" & _
              " and substr(pi06,1,8)=in01(+) and substr(pi06,9,2)=in02(+)" & _
              " order by pi05 asc"
'   Else
'   '2014/11/12 END
'Memo by Lydia 2021/08/17 刪除舊程式碼：專利發明人在專利基本檔60~69

   End If
   'end 2019/05/07
   intA = 1
   Set adoSrc = ClsLawReadRstMsg(intA, stSQL)
   If intA <> 1 Then GoTo ExitPoint
   
   '抓目的案件的所有發明人資料並依申請人欄位次排序
   'Modify by Amy 2019/05/07 +比對英日名稱,因CFP031042發文帶關連案P122551 發明人,「無相符資料時新增為第一申請人的發明人」會一直新增
   stSQL = "select decode(in01,substr(pa26,1,8),1,substr(pa27,1,8),2,substr(pa28,1,8),3" & _
          ",substr(pa29,1,8),4,substr(pa30,1,8),5) Srt,in01,in02,in03,in04,in05,in06" & _
          " from patent,inventor inv where " & ChgPatent(PaNoTrg) & _
          " and instr(pa26||pa27||pa28||pa29||pa30,in01)>0" & _
          " union all select 0,substr(pa26,1,8),'','','','','' from patent where " & ChgPatent(PaNoTrg) & _
          " order by Srt,in02"
   intA = 1
   Set adoChk = ClsLawReadRstMsg(intA, stSQL)
   '第一筆固定是申請人1的空白發明人資料以便新增時用
   If intA = 1 Then
      strIN01 = adoChk("in01")
      
      'Add by Amy 2014/04/22 +if
      If bolInvCopyOnly = False Then
         '清除目的案件原發明人欄位
         'Modify By Sindy 2014/11/12
         If strSrvDate(1) >= 專利發明人檔啟用日 Then
            '全部刪除
            stSQL = "delete from patentInventor where pi01=" + CNULL(strOrgCase(1)) + " and pi02=" + CNULL(strOrgCase(2)) + " and pi03=" + CNULL(strOrgCase(3)) + " and pi04=" + CNULL(strOrgCase(4))
            Pub_SeekTbLog stSQL 'Add By Sindy 2017/8/23
         Else
         '2014/11/12 END
            'Memo by Lydia 2021/08/17 刪除舊程式碼：專利發明人在專利基本檔60~69
         End If
         cnnConnection.Execute stSQL, intA
      End If
      'end 2014/04/22
      
      adoSrc.MoveFirst
      Do While Not adoSrc.EOF
         bDone = False
         'ID比對
         If Not IsNull(adoSrc("in03")) Then
            adoChk.MoveFirst
            adoChk.Find "in03='" & adoSrc("in03") & "'"
            
            'ID相符
            If Not adoChk.EOF Then
               If bolInvCopyOnly = False Then
                  'Modify By Sindy 2014/11/12
                  If strSrvDate(1) >= 專利發明人檔啟用日 Then
                     intGetMaxPi05 = PUB_GetMaxPi05(strOrgCase(1), strOrgCase(2), strOrgCase(3), strOrgCase(4))
                     intGetMaxPi05 = intGetMaxPi05 + 1
                     stSQL = "INSERT into patentInventor(pi01,pi02,pi03,pi04,pi05,pi06) VALUES(" & _
                             CNULL(strOrgCase(1)) & "," & CNULL(strOrgCase(2)) & "," & CNULL(strOrgCase(3)) & "," & CNULL(strOrgCase(4)) & "," & intGetMaxPi05 & ",'" & adoChk("in01") & adoChk("in02") & "')"
                     Pub_SeekTbLog stSQL 'Add By Sindy 2017/8/23
                  Else
                  '2014/11/12 END
                     stSQL = "update patent set " & adoSrc("ColName") & "='" & adoChk("in01") & adoChk("in02") & "'" & _
                             " where " & ChgPatent(PaNoTrg)
                  End If
                  cnnConnection.Execute stSQL, intA
               End If
               'Modified by Morgan 2023/8/8
               'If strDefInv <> "" Then strDefInv = strDefInv & "," & adoChk("in01") & adoChk("in02")
               strDefInv = strDefInv & "," & adoChk("in01") & adoChk("in02")
               'end 2023/8/8
               bDone = True
            End If
         End If
         
         '名稱比對
         'Modify by Amy 2019/05/07 +比對英日名稱
         If Not bDone Then
            adoChk.MoveFirst
            adoChk.Find "in04='" & adoSrc("in04") & "'" '中文名稱
            If adoChk.EOF Then
                adoChk.MoveFirst
                adoChk.Find "in05='" & adoSrc("in05") & "'" '英文名稱
                If adoChk.EOF Then
                    adoChk.MoveFirst
                    adoChk.Find "in05='" & adoSrc("in05") & "'" '日文名稱
                    '日文名稱符合
                    If Not adoChk.EOF Then
                        bDone = True
                    End If
                '英文名稱符合
                Else
                    bDone = True
                End If
            '中文名稱符合
            Else
                bDone = True
            End If
            '名稱相符
            If bDone Then
               If bolInvCopyOnly = False Then
                  'Modify By Sindy 2014/11/12
                  If strSrvDate(1) >= 專利發明人檔啟用日 Then
                     intGetMaxPi05 = PUB_GetMaxPi05(strOrgCase(1), strOrgCase(2), strOrgCase(3), strOrgCase(4))
                     intGetMaxPi05 = intGetMaxPi05 + 1
                     stSQL = "INSERT into patentInventor(pi01,pi02,pi03,pi04,pi05,pi06) VALUES(" & _
                             CNULL(strOrgCase(1)) & "," & CNULL(strOrgCase(2)) & "," & CNULL(strOrgCase(3)) & "," & CNULL(strOrgCase(4)) & "," & intGetMaxPi05 & ",'" & adoChk("in01") & adoChk("in02") & "')"
                     Pub_SeekTbLog stSQL 'Add By Sindy 2017/8/23
                  Else
                  '2014/11/12 END
                     stSQL = "update patent set " & adoSrc("ColName") & "='" & adoChk("in01") & adoChk("in02") & "'" & _
                             " where " & ChgPatent(PaNoTrg)
                  End If
                  cnnConnection.Execute stSQL, intA
               End If
               'Modified by Morgan 2023/8/8
               'If strDefInv <> "" Then strDefInv = strDefInv & "," & adoChk("in01") & adoChk("in02")
               strDefInv = strDefInv & "," & adoChk("in01") & adoChk("in02")
               'end 2023/8/8
            End If
         End If
         'end 2019/05/07
         '無相符資料時新增為第一申請人的發明人
         If Not bDone Then
            strIN02 = PUB_GetNewIN02(strIN01)
            stSQL = "insert into inventor(in01,in02,in03,in04,in05,in06,in07,in08,in09,in10,in11,in12)" & _
                    " select '" & strIN01 & "','" & strIN02 & "',in03,in04,in05,in06,in07,in08,in09,in10,in11,in12" & _
                    " from inventor where in01='" & adoSrc("in01") & "' and in02='" & adoSrc("in02") & "'"
            cnnConnection.Execute stSQL, intA
           
            'Modified by Morgan 2023/8/8
            'If strDefInv <> "" And inta > 0 Then
            If intA > 0 Then
            'end 2023/8/8
                strDefInv = strDefInv & "," & strIN01 & strIN02
            End If
            
            If bolInvCopyOnly = False Then
               'Modify By Sindy 2014/11/12
               If strSrvDate(1) >= 專利發明人檔啟用日 Then
                  intGetMaxPi05 = PUB_GetMaxPi05(strOrgCase(1), strOrgCase(2), strOrgCase(3), strOrgCase(4))
                  intGetMaxPi05 = intGetMaxPi05 + 1
                  stSQL = "INSERT into patentInventor(pi01,pi02,pi03,pi04,pi05,pi06) VALUES(" & _
                          CNULL(strOrgCase(1)) & "," & CNULL(strOrgCase(2)) & "," & CNULL(strOrgCase(3)) & "," & CNULL(strOrgCase(4)) & "," & intGetMaxPi05 & ",'" & strIN01 & strIN02 & "')"
                  Pub_SeekTbLog stSQL 'Add By Sindy 2017/8/23
               Else
               '2014/11/12 END
                  stSQL = "update patent set " & adoSrc("ColName") & "='" & strIN01 & strIN02 & "'" & _
                          " where " & ChgPatent(PaNoTrg)
               End If
               cnnConnection.Execute stSQL, intA
            End If
         End If
         adoSrc.MoveNext
      Loop
      'Modified by Morgan 2023/8/8
      'strDefInv = Replace(Replace(strDefInv, "Y,", ""), "Y", "")
      If Left(strDefInv, 1) = "," Then
         strDefInv = Mid(strDefInv, 2)
      End If
      'end 2023/8/8
   End If
   
ExitPoint:
   Set adoSrc = Nothing
   Set adoChk = Nothing
End Sub

'Add by Amy 更新專利基本檔發明人欄位
Public Sub UpdPatentInventor(ByVal PaNoTrg As String, ByVal strInventor As String)
Dim ii  As Integer
Dim strUpd As String
Dim strInvTp() As String
Dim strCase(1 To 4) As String 'Add By Sindy 2014/11/13
Dim intA As Integer 'Added by Lydia 2024/05/15

   strInvTp = Split(strInventor, ",")
   '清除案件原發明人欄位
   'Modify By Sindy 2014/11/13
   ChgCaseNo PaNoTrg, strCase
   If strSrvDate(1) >= 專利發明人檔啟用日 Then
      '全部刪除
      strUpd = "delete from patentInventor where pi01=" + CNULL(strCase(1)) + " and pi02=" + CNULL(strCase(2)) + " and pi03=" + CNULL(strCase(3)) + " and pi04=" + CNULL(strCase(4))
      Pub_SeekTbLog strUpd 'Add By Sindy 2017/8/23
   Else
   '2014/11/13 END
      'Memo by Lydia 2021/08/17 刪除舊程式碼：專利發明人在專利基本檔60~69
   End If
   cnnConnection.Execute strUpd, intA
   
   For ii = 0 To UBound(strInvTp)
      'Modify By Sindy 2014/11/12
      If strSrvDate(1) >= 專利發明人檔啟用日 Then
         strUpd = "INSERT into patentInventor(pi01,pi02,pi03,pi04,pi05,pi06) VALUES(" & _
                  CNULL(strCase(1)) & "," & CNULL(strCase(2)) & "," & CNULL(strCase(3)) & "," & CNULL(strCase(4)) & "," & ii + 1 & ",'" & strInvTp(ii) & "')"
         Pub_SeekTbLog strUpd 'Add By Sindy 2017/8/23
      Else
      '2014/11/12 END
         strUpd = "Update Patent Set pa6" & ii & "='" & strInvTp(ii) & "' Where " & ChgPatent(PaNoTrg)
      End If
      cnnConnection.Execute strUpd, intA
   Next ii
End Sub
'end 2014/04/23

'Modify By Sindy 2014/5/27 從account中的acc_fun Move過來 AccAutoNo,AccSaveAutoNo,DeleteCheck
'*************************************************
'  電腦自動給號(傳票號碼)
'
'*************************************************
'Modified by Lydia 2023/10/17 +bolNoTitle=編號開頭是否加上編號，bolNoMonth=編號中間是否加上月份
'Public Function AccAutoNo(InputItem As String, InputLength As Integer, Optional intYear As Integer = 0, Optional intMonth As Integer = 0) As String
Public Function AccAutoNo(ByVal InputItem As String, ByVal InputLength As Integer, Optional ByVal intYear As Integer = 0, Optional ByVal intMonth As Integer = 0, _
        Optional ByVal bolNoTitle As Boolean = False, Optional ByVal bolNoMonth As Boolean = False) As String
Dim adoaccnum As New ADODB.Recordset
Dim strItem As String, strYes As String
   'Added by Lydia 2015/06/24 將商標委查單(查名單)的編號加入
   If Left(InputItem, 1) = "H" Then
        strItem = InputItem
   Else
        If Len(InputItem) > 1 Then
           strItem = Mid(InputItem, 2, 1)
        Else
           strItem = InputItem
        End If
   End If
   
   adoaccnum.CursorLocation = adUseClient
   If intYear <> 0 Then
      adoaccnum.Open "select * from acc1r0 where a1r01 = '" & InputItem & "' and a1r02 = " & (intYear + 1911) & " and a1r03 = " & intMonth & "", adoTaie, adOpenStatic, adLockReadOnly
      If adoaccnum.RecordCount = 0 Then
         'Added by Lydia 2015/06/24 比對自動編號年度
         If Left(InputItem, 1) = "H" Then
            'Modified by Lydia 2023/10/17
            'AccAutoNo = strItem & CompAutoNumberYear(CStr(intYear)) & IIf(intMonth < 10, "0" & intMonth, intMonth) & ZeroBeforeNo("0", InputLength)
            AccAutoNo = IIf(bolNoTitle = False, strItem, "") & CompAutoNumberYear(CStr(intYear)) & IIf(bolNoMonth = False, IIf(intMonth < 10, "0" & intMonth, intMonth), "") & ZeroBeforeNo("0", InputLength)
         Else
            'Modified by Lydia 2023/10/17
            'AccAutoNo = strItem & IIf(intYear < 100, "0" & intYear, intYear) & IIf(intMonth < 10, "0" & intMonth, intMonth) & ZeroBeforeNo("0", InputLength)
            AccAutoNo = IIf(bolNoTitle = False, strItem, "") & IIf(intYear < 100, "0" & intYear, intYear) & IIf(bolNoMonth = False, IIf(intMonth < 10, "0" & intMonth, intMonth), "") & ZeroBeforeNo("0", InputLength)
         End If
      Else
         'Added by Lydia 2015/06/24
         If Left(InputItem, 1) = "H" Then
            'Modified by Lydia 2023/10/17
            'AccAutoNo = strItem & CompAutoNumberYear(CStr(intYear)) & IIf(intMonth < 10, "0" & intMonth, intMonth) & ZeroBeforeNo(str(adoaccnum.Fields("a1r04").Value), InputLength)
            AccAutoNo = IIf(bolNoTitle = False, strItem, "") & CompAutoNumberYear(CStr(intYear)) & IIf(bolNoMonth = False, IIf(intMonth < 10, "0" & intMonth, intMonth), "") & ZeroBeforeNo(str(adoaccnum.Fields("a1r04").Value), InputLength)
         Else
            'Modified by Lydia 2023/10/17
            'AccAutoNo = strItem & IIf(intYear < 100, "0" & intYear, intYear) & IIf(intMonth < 10, "0" & intMonth, intMonth) & ZeroBeforeNo(str(adoaccnum.Fields("a1r04").Value), InputLength)
            AccAutoNo = IIf(bolNoTitle = False, strItem, "") & IIf(intYear < 100, "0" & intYear, intYear) & IIf(bolNoMonth = False, IIf(intMonth < 10, "0" & intMonth, intMonth), "") & ZeroBeforeNo(str(adoaccnum.Fields("a1r04").Value), InputLength)
         End If
      End If

   Else
      adoaccnum.Open "select * from acc1r0 where a1r01 = '" & InputItem & "'", adoTaie, adOpenStatic, adLockReadOnly
      'Modified by Lydia 2015/06/24
'      If adoaccnum.RecordCount = 0 Then
'         AccAutoNo = strItem & Mid(strSrvDate(2), 1, 3) & ZeroBeforeNo("0", InputLength)
'      Else
'         If adoaccnum.Fields("a1r02").Value <> Val(Mid(strSrvDate(1), 1, 4)) Then
'            AccAutoNo = strItem & Mid(strSrvDate(2), 1, 3) & ZeroBeforeNo("0", InputLength)
'         Else
'            AccAutoNo = strItem & Mid(strSrvDate(2), 1, 3) & ZeroBeforeNo(str(adoaccnum.Fields("a1r04").Value), InputLength)
'         End If
'      End If
      If Left(InputItem, 1) = "H" Then
         'Modified by Lydia 2023/10/17
         'AccAutoNo = strItem & CompAutoNumberYear(Mid(strSrvDate(2), 1, 3))
         AccAutoNo = IIf(bolNoTitle = False, strItem, "") & CompAutoNumberYear(Mid(strSrvDate(2), 1, 3))
      Else
         'Modified by Lydia 2023/10/17
         'AccAutoNo = strItem & Mid(strSrvDate(2), 1, 3)
         AccAutoNo = IIf(bolNoTitle = False, strItem, "") & Mid(strSrvDate(2), 1, 3)
      End If
      If adoaccnum.RecordCount = 0 Then
         AccAutoNo = AccAutoNo & ZeroBeforeNo("0", InputLength)
      Else
         If adoaccnum.Fields("a1r02").Value <> Val(Mid(strSrvDate(1), 1, 4)) Then
            AccAutoNo = AccAutoNo & ZeroBeforeNo("0", InputLength)
         Else
            AccAutoNo = AccAutoNo & ZeroBeforeNo(str(adoaccnum.Fields("a1r04").Value), InputLength)
         End If
      End If
      
   End If
   adoaccnum.Close
End Function

'*************************************************
'  電腦給號存檔(傳票號碼)
'
'*************************************************
Public Function AccSaveAutoNo(InputItem As String, InputNo As String, Optional intYear As Integer = 0, Optional intMonth As Integer = 0) As String
Dim adoaccnum As New ADODB.Recordset

   adoaccnum.CursorLocation = adUseClient
   If intYear <> 0 Then
      adoaccnum.Open "select * from acc1r0 where a1r01 = '" & InputItem & "' and a1r02 = " & (intYear + 1911) & " and a1r03 = " & intMonth & "", adoTaie, adOpenStatic, adLockReadOnly
      If adoaccnum.RecordCount = 0 Then
         '2012/3/30 MODIFY BY SONIA  3/30輸4月傳票會錯
         'adoTaie.Execute "insert into acc1r0 (a1r01, a1r02, a1r03, a1r04) values ('" & InputItem & "', '" & Mid(strSrvDate(1), 1, 4) & "', '" & Mid(strSrvDate(1), 5, 2) & "', '" & InputNo & "')"
         '2012/12/19 modify by sonia 101/12/19輸102/1/2會錯
         'adoTaie.Execute "insert into acc1r0 (a1r01, a1r02, a1r03, a1r04) values ('" & InputItem & "', '" & Mid(strSrvDate(1), 1, 4) & "', '" & intMonth & "', '" & InputNo & "')"
         adoTaie.Execute "insert into acc1r0 (a1r01, a1r02, a1r03, a1r04) values ('" & InputItem & "', '" & (intYear + 1911) & "', '" & intMonth & "', '" & InputNo & "')"
      Else
         adoTaie.Execute "UPDATE ACC1R0 SET A1R04 = " & InputNo & " WHERE A1R01 = '" & InputItem & "' and a1r02 = " & (intYear + 1911) & " and a1r03 = " & intMonth & ""
      End If
   Else
      adoaccnum.Open "select * from acc1r0 where a1r01 = '" & InputItem & "'", adoTaie, adOpenStatic, adLockReadOnly
      If adoaccnum.RecordCount = 0 Then
         adoTaie.Execute "insert into acc1r0 (a1r01, a1r02, a1r03, a1r04) values ('" & InputItem & "', '" & Mid(strSrvDate(1), 1, 4) & "', '" & Mid(strSrvDate(1), 5, 2) & "', '" & InputNo & "')"
      Else
         adoTaie.Execute "UPDATE ACC1R0 SET A1R01 = '" & InputItem & "', A1R02 = '" & Mid(strSrvDate(1), 1, 4) & "', A1R03 = '" & Mid(strSrvDate(1), 5, 2) & "', A1R04 = '" & InputNo & "' WHERE A1R01 = '" & InputItem & "'"
      End If
   End If
   AccSaveAutoNo = MsgText(602)
   adoaccnum.Close
End Function
'*************************************************
'  刪除資料檢核
'
'*************************************************
Public Function DeleteCheck(strSql As String) As String
Dim adoDeleteCheck As New ADODB.Recordset

   adoDeleteCheck.CursorLocation = adUseClient
   adoDeleteCheck.Open strSql, adoTaie, adOpenStatic, adLockReadOnly
   If adoDeleteCheck.RecordCount = 0 Then
      MsgBox MsgText(28), , MsgText(5)
      DeleteCheck = MsgText(603)
   Else
      DeleteCheck = MsgText(602)
   End If
   adoDeleteCheck.Close
End Function

'Add By Sindy 2014/5/28 檢查是否有暫收款
Public Function PUB_ChkTemporaryReceipts(ByVal strCP01 As String, ByVal strCP02 As String _
                                       , ByVal strCP03 As String, ByVal strCP04 As String) As Boolean
Dim strSql As String
Dim rsTmp As ADODB.Recordset
Dim strNo As String, strID As String, strAmt As String
Dim strIDnm As String 'Add By Sindy 2015/2/4 代理人名稱
   
   PUB_ChkTemporaryReceipts = False
   
   If Left(Pub_StrUserSt03, 2) = "P2" Then 'Add By Sindy 2014/6/5 +if 商標處人員才需檢查是否有暫收款
      '1.檢查該案號之所有請款單，不管是否結清，抓每筆請款單的A1K03，A1K27，A1K28，找出所有編號
      strSql = "select A1K03 from acc1k0" & _
               " where a1k13='" & strCP01 & "' and a1k14='" & strCP02 & "' and a1k15='" & strCP03 & "' and a1k16='" & strCP04 & "'" & _
               " Union select A1K27 from acc1k0" & _
               " where a1k13='" & strCP01 & "' and a1k14='" & strCP02 & "' and a1k15='" & strCP03 & "' and a1k16='" & strCP04 & "'" & _
               " Union select A1K28 from acc1k0" & _
               " where a1k13='" & strCP01 & "' and a1k14='" & strCP02 & "' and a1k15='" & strCP03 & "' and a1k16='" & strCP04 & "'"
      Set rsTmp = New ADODB.Recordset
      rsTmp.CursorLocation = adUseClient
      rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      strNo = ""
      If rsTmp.RecordCount > 0 Then
         rsTmp.MoveFirst
         Do While Not rsTmp.EOF
            strNo = strNo & ",'" & rsTmp.Fields(0) & "'"
            rsTmp.MoveNext
         Loop
         strNo = Mid(strNo, 2)
         rsTmp.Close
         '分別檢查ACC120的A1203，再逐筆檢查每一暫收款，若有不存在於ACC130(未退費)且不存在於ACC1P0的a1p23，
         '表示未沖平，則彈訊息提醒使用者"Yxxxx(編號)有暫收款，請考慮是否可沖帳？"
         strSql = "select a1203,a1204,sum(a1207) from acc120,acc130,acc1p0" & _
                  " where a1203 in(" & strNo & ")" & _
                  " and a1201=a1303(+) and a1303 is null" & _
                  " and a1201=a1p23(+) and a1p23 is null" & _
                  " group by a1203,a1204" & _
                  " order by a1203,a1204"
         Set rsTmp = New ADODB.Recordset
         rsTmp.CursorLocation = adUseClient
         rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
         strNo = ""
         If rsTmp.RecordCount > 0 Then
            PUB_ChkTemporaryReceipts = True
            rsTmp.MoveFirst
            Do While Not rsTmp.EOF
               'Modify By Sindy 2015/2/4 編號後加顯示6個中文名稱
               If strID <> "" And strID <> rsTmp.Fields(0) Then
                  strNo = strNo & "," & strID & ":" & strIDnm & "（" & Mid(strAmt, 2) & "）"
                  strAmt = "": strIDnm = ""
               End If
               strID = rsTmp.Fields(0)
               If strIDnm = "" Then
                  If Left(strID, 1) = "Y" Then
                     strIDnm = GetPrjName1(strID)
                  Else 'X
                     strIDnm = GetPrjPeople1(strID)
                  End If
                  If strIDnm <> "" Then strIDnm = Left(strIDnm, 6)
               End If
               '2015/2/4 END
               strAmt = strAmt & "、" & "幣別:" & rsTmp.Fields(1) & " 金額:" & rsTmp.Fields(2)
               'Modify By Sindy 2014/7/1 宋若蘭說,顯示的訊息只有原暫收款的幣別及外幣金額,再加(約NTD....元) 例:N10200356
               If Trim(rsTmp.Fields(1)) <> "" Then
                  strAmt = strAmt & " (約NTD " & Format(PUB_GetUSXRate_1(strSrvDate(2), rsTmp.Fields(1)) * rsTmp.Fields(2), "#,##0") & "元)"
               End If
               '2014/7/1 END
               rsTmp.MoveNext
            Loop
            'Modify By Sindy 2015/2/4 編號後加顯示6個中文名稱
            strNo = strNo & "," & strID & ":" & strIDnm & "（" & Mid(strAmt, 2) & "）"
            '2015/2/4 END
            strNo = Mid(strNo, 2)
         End If
      End If
      rsTmp.Close
      
      If PUB_ChkTemporaryReceipts = True Then
         MsgBox strNo & "有暫收款，若可沖帳請通知財務處！", vbExclamation
      End If
   End If
   
   Set rsTmp = Nothing
End Function

'Add by Sindy 2014/7/4 檢查是否有總委任書
'strCaseNo:本所案號
'strCaseID:申請案號
'Modify By Sindy 2025/9/11 , Optional ByVal strApplCaseNo As String = "": 傳入要比對申請人是否一致的案號
'                          , Optional ByRef strChkPA165Err As String = "": 回傳錯誤訊息
Public Function PUB_ChkPA165IsY(ByVal strNo As String, Optional ByRef strCaseNo As String = "", _
   Optional ByRef strCaseID As String = "", _
   Optional ByVal strApplCaseNo As String = "", Optional ByRef strChkPA165Err As String = "") As Boolean
Dim rsTmp As ADODB.Recordset
Dim strTmp As String, intA As Integer 'Added by Lydia 2024/05/15
Dim strApplNo1 As String, strApplNo2 As String 'Add By Sindy 2025/9/11

   PUB_ChkPA165IsY = False
   strCaseNo = "": strCaseID = ""
   If Trim(strNo) = "" Then
      Exit Function
   Else
      'Modiofy By Sindy 2024/7/16 mark,9碼要一樣 ex:X83268001 (P-125858), X83268000 (P-133864)
      'strNo = Left(strNo & "00000000", 8)
      strNo = Left(strNo & "000000000", 9)     'modify by sonia 2024/7/17 要補滿9碼P-133730僅傳入X7461302
   End If
   'Modiofy By Sindy 2024/7/16 mark,取消抓前8碼
'   strTmp = "SELECT PA01,PA02,PA03,PA04,PA11 FROM PATENT WHERE PA09='000' and substr(PA26,1,8)='" & strNo & "' and pa165='Y'" & _
'               " union SELECT PA01,PA02,PA03,PA04,PA11 FROM PATENT WHERE PA09='000' and substr(PA27,1,8)='" & strNo & "' and pa165='Y'" & _
'               " union SELECT PA01,PA02,PA03,PA04,PA11 FROM PATENT WHERE PA09='000' and substr(PA28,1,8)='" & strNo & "' and pa165='Y'" & _
'               " union SELECT PA01,PA02,PA03,PA04,PA11 FROM PATENT WHERE PA09='000' and substr(PA29,1,8)='" & strNo & "' and pa165='Y'" & _
'               " union SELECT PA01,PA02,PA03,PA04,PA11 FROM PATENT WHERE PA09='000' and substr(PA30,1,8)='" & strNo & "' and pa165='Y'"
   strTmp = "SELECT PA01,PA02,PA03,PA04,PA11,PA26||PA27||PA28||PA29||PA30 FROM PATENT WHERE PA09='000' and PA26='" & strNo & "' and pa165='Y'" & _
            " union SELECT PA01,PA02,PA03,PA04,PA11,PA26||PA27||PA28||PA29||PA30 FROM PATENT WHERE PA09='000' and PA27='" & strNo & "' and pa165='Y'" & _
            " union SELECT PA01,PA02,PA03,PA04,PA11,PA26||PA27||PA28||PA29||PA30 FROM PATENT WHERE PA09='000' and PA28='" & strNo & "' and pa165='Y'" & _
            " union SELECT PA01,PA02,PA03,PA04,PA11,PA26||PA27||PA28||PA29||PA30 FROM PATENT WHERE PA09='000' and PA29='" & strNo & "' and pa165='Y'" & _
            " union SELECT PA01,PA02,PA03,PA04,PA11,PA26||PA27||PA28||PA29||PA30 FROM PATENT WHERE PA09='000' and PA30='" & strNo & "' and pa165='Y'"
   intA = 1
   Set rsTmp = ClsLawReadRstMsg(intA, strTmp)
   If intA = 1 Then
      PUB_ChkPA165IsY = True
      strCaseNo = rsTmp.Fields(0) & "-" & rsTmp.Fields(1) & "-" & rsTmp.Fields(2) & "-" & rsTmp.Fields(3)
      strCaseID = "" & rsTmp.Fields("PA11") 'Modify By Sindy 2015/1/13 +"" &
      'Add By Sindy 2025/9/11 5個申請人
      If "" & rsTmp.Fields(5) <> "" Then
         strApplNo1 = Trim("" & rsTmp.Fields(5))
         strApplNo1 = Left(strApplNo1, 1) & Replace(Mid(strApplNo1, 2), "X", ",X")
      End If
      '2025/9/11 END
   End If
   'Modify By Sindy 2025/9/11 傳入要比對申請人是否一致的案號
   If strApplCaseNo <> "" Then
      strExc(7) = SystemNumber(strApplCaseNo, 1)
      strExc(8) = SystemNumber(strApplCaseNo, 2)
      strExc(9) = SystemNumber(strApplCaseNo, 3)
      strExc(10) = SystemNumber(strApplCaseNo, 4)
      strTmp = "SELECT PA01,PA02,PA03,PA04,PA11,PA26||PA27||PA28||PA29||PA30 FROM PATENT WHERE PA01='" & strExc(7) & "' and PA02='" & strExc(8) & "' and PA03='" & strExc(9) & "' and PA04='" & strExc(10) & "'"
      intA = 1
      Set rsTmp = ClsLawReadRstMsg(intA, strTmp)
      If intA = 1 Then
         '5個申請人
         If "" & rsTmp.Fields(5) <> "" Then
            strApplNo2 = Trim("" & rsTmp.Fields(5))
            strApplNo2 = Left(strApplNo2, 1) & Replace(Mid(strApplNo2, 2), "X", ",X")
         End If
         If strApplNo1 <> strApplNo2 Then
            strExc(1) = "總委任書 " & strCaseNo & " ( " & strApplNo1 & " )與本案申請人( " & strApplNo2 & " )不一致，委任書請重新編輯再送件，並重新設立總委任書的註記！"
            If InStr(strChkPA165Err, strExc(1)) = 0 Then
               strChkPA165Err = IIf(strChkPA165Err <> "", strChkPA165Err & vbCrLf, "") & strExc(1)
            End If
         End If
      End If
   End If
   '2025/9/11 END
   
   Set rsTmp = Nothing
End Function

'Add by Amy 2014/08/14 確認同一天沒有其他有規費的發文
Public Function ChkOneDayHasCP84(pCP01 As String, pCP02 As String, pCP03 As String, pCP04 As String) As Boolean
    Dim RsQ As New ADODB.Recordset, strQuery  As String, intQ As Integer
    
    ChkOneDayHasCP84 = False
    strQuery = "Select 1 From CaseProgress " & _
                    "Where cp01='" & pCP01 & "' And cp02='" & pCP02 & "' And cp03='" & pCP03 & "' And cp04='" & pCP04 & "' " & _
                    "And cp84>0 And cp27=" & strSrvDate(1)
    intQ = 1
  
    Set RsQ = ClsLawReadRstMsg(intQ, strQuery)
    If intQ = 0 Then
        ChkOneDayHasCP84 = True
    End If
    Set RsQ = Nothing
End Function

'Added by Morgan 2014/1/17
'Modify By Sindy 2014/8/28 原此函數在aacc_fun裡,但Casher也會用到,因此才搬移過來
'Modifby by Amy 2014/09/24 +intChoose
'Modify by Amy 2019/07/23 +cu178 零稅率
Public Function PUB_GetTaxNo(ByVal PTitle As String, Optional ByVal intChoose As Integer = 0, _
                             Optional ByRef cu158 As String, Optional ByRef cu15 As String, Optional ByRef cu178 As String) As String
   Dim stSQL As String, intR As Integer
   Dim rsQuery As ADODB.Recordset
   Dim CUField As String, A420Field As String 'Add by Amy 2014/09/24
   
   'Add by Amy 2014/09/24
   'Modify By Sindy 2015/7/13 +抓個人或公司
   'Modify by Amy 2019/07/23 +零稅率
   Select Case intChoose
        Case 0 '統一編號欄位
            CUField = "cu11,cu158,cu15,cu178"
            A420Field = "a4202,a4216,to_number(a4219),a4226"
        Case 1 '境外公司欄位
            CUField = "cu158,cu15,cu178"
            A420Field = "a4216,to_number(a4219),a4226"
        Case Else
   End Select
   
   'Modify By Sindy 2024/1/23 抓統編是需要排除個人 and cu15<>'0', 因其他值不可排除, 所以SQL拆開抓值
   'Modify By Sindy 2025/1/23 +設為對造 or cu80='設為對造'
   'Modify By Sindy 2025/6/27 +or cu80='其他' or cu80='業務自行處理' or cu80='國內同業' or cu80='解除對造' or cu80='不得代理專利' or cu80='不得代理商標' or cu80='設為對造'
   '                          改抓常變數
   stSQL = "select cu11 from customer where (cu04='" & ChgSQL(PTitle) & "' or upper(rtrim(cu05||' '||cu88||' '||cu89||' '||cu90))=upper('" & ChgSQL(PTitle) & "') or upper(cu06)=upper('" & ChgSQL(PTitle) & "'))" & _
           " and (cu80 is null or instr('" & 客戶及代理人可讀取的狀態 & "',cu80)>0)" & _
           " and cu02='0' and cu15<>'0'" & _
    " union select a4202 from acc420 where a4201='" & ChgSQL(PTitle) & "' and A4202<>'04150022' and a4219<>'0'"
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      PUB_GetTaxNo = "" & rsQuery(0)
   End If
   '2024/1/23 END
   
   'Modify By Sindy 2014/3/25 若A4202='04150022'者視為空值
   'Modify By Sindy 2014/8/15 +and (cu80 is null or cu80='其他' or cu80='業務自行處理') and cu02='0'
   'Modify by Amy 2014/09/24 依intChoose 抓取不同欄位
   'stSQL = "select cu11 from customer where cu04='" & pTitle & "' and (cu80 is null or cu80='其他' or cu80='業務自行處理') and cu02='0' and cu15<>'0'" & _
   ' " union select a4202 from acc420 where a4201='" & pTitle & "' and A4202<>'04150022'"
   'Modify By Sindy 2017/4/18 and A4202<>'04150022'==>and (A4202<>'04150022' or A4202 is null) 改語法不然抓不到資料
   'Modify By Sindy 2019/11/18 +  or upper(rtrim(cu05||' '||cu88||' '||cu89||' '||cu90))=upper('" & ChgSQL(PTitle) & "') or upper(cu06)=upper('" & ChgSQL(PTitle) & "')) 增加英文和日文名稱查詢
   'Modify By Sindy 2022/9/8 + or cu80='國內同業' or cu80='解除對造'
   'Modify By Sindy 2023/2/24 針對客戶狀態CU80的控制要再加不得代理專利、不得代理商標。
   'Modify By Sindy 2024/1/23 不可排除個人 and cu15<>'0'
   'Modify By Sindy 2025/1/23 +設為對造 or cu80='設為對造'
   'Modify By Sindy 2025/6/27 +or cu80='其他' or cu80='業務自行處理' or cu80='國內同業' or cu80='解除對造' or cu80='不得代理專利' or cu80='不得代理商標' or cu80='設為對造'
   '                          改抓常變數
   stSQL = "select " & CUField & " from customer where (cu04='" & ChgSQL(PTitle) & "' or upper(rtrim(cu05||' '||cu88||' '||cu89||' '||cu90))=upper('" & ChgSQL(PTitle) & "') or upper(cu06)=upper('" & ChgSQL(PTitle) & "'))" & _
           " and (cu80 is null or instr('" & 客戶及代理人可讀取的狀態 & "',cu80)>0)" & _
           " and cu02='0'" & _
    " union select " & A420Field & " from acc420 where a4201='" & ChgSQL(PTitle) & "' and (A4202<>'04150022' or A4202 is null)"
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      'PUB_GetTaxNo = "" & rsQuery(0) 'Modify By Sindy 2024/1/23 mark,程式改在上面抓值
      'Add By Sindy 2015/7/13
      'Modify by Amy 2019/07/24 +零稅率
      If intChoose = 0 Then
         cu158 = "" & rsQuery(1)
         cu15 = "" & rsQuery(2)
         cu178 = "" & rsQuery(3)
      Else
         PUB_GetTaxNo = "" & rsQuery(0) 'Add By Sindy 2024/2/2
         cu158 = "" & rsQuery(0)
         cu15 = "" & rsQuery(1)
         cu178 = "" & rsQuery(2)
      End If
      'end 2019/07/24
      '2015/7/13 END
   End If
   Set rsQuery = Nothing
End Function

'Add By Sindy 2014/8/28 若為主管,其所帶的人員ID
'Modify By Sindy 2015/2/5 , objCbo As Object==>, Optional objCbo As Object
'Add By Sindy 2016/8/17 + Optional bolQuyAreaEmp As Boolean = False : True代表可以查詢同單位的人員案件資料
'Modified by Lydia 2020/06/08 增加特殊權限 strGetKind
'Modify by Amy 2021/02/23 +strFormName
Public Sub Pub_SetSAManageEmpCombo(StrST01 As String, Optional objCbo As Object, Optional bolClear As Boolean = True, _
                                   Optional ByRef strUseSales As String, Optional bolQuyAreaEmp As Boolean = False, Optional strGetKind As String, Optional strFormName As String = "")
Dim strText As String
Dim strST05 As String
Dim ii As Integer
Dim EmpstrSql As String
Dim strWhere As String 'Add by Amy 2021/02/23
Dim intA As Integer, rsAD As New ADODB.Recordset 'Added by Lydia 2024/05/15

   If bolClear = True Then
      If TypeName(objCbo) <> "Nothing" Then 'Modify By Sindy 2015/2/5 + if
         objCbo.Clear
      End If
   End If
   
   'Modified by Morgan 2016/11/4 和秀玲討論改抓1年內離職,因若業務離職超過3個月,主管會無法做寄件確認 Ex.P114117(AA5013879)
   'strDate = DBDATE(DateAdd("m", -3, Format(strSrvDate(1), "####/##/##")))
   strDate = DBDATE(CompDate(0, -1, strSrvDate(1)))
   
   strUseSales = ""
   EmpstrSql = ""
   strST05 = PUB_GetST05(strUserNum)
   'Add By Sindy 2013/12/18 暫時的智權人員ID其部門主管
   'Modified by Lydia 2020/06/08 +st15
   EmpstrSql = "select st01,st02,st15 from acc090,staff where substr(a0901,1,1)='S'" & _
            " and substr(st01,1,1)<'6'" & _
            " and st03=a0901" & _
            " and st01<>'001-1'" & _
            " and a0908='" & strUserNum & "'"
   '2013/12/18 END
   
  '*** Memo 若有增加表單請於下方列示,方便知道修改影響之程式 ***
  'Add by Amy 2023/02/10 從下面搬上來,結案單抓區主管不需判斷 and (st04='1' or st51>=" & strDate & ") ex:T-170359 69004已離職主管無法結案
   strWhere = " and (st04='1' or st51>=" & strDate & ") "
   Select Case UCase(strFormName)
        Case "FRM090127" '查覆區
        Case "FRM090202_3" '專利／商標會稿
        Case "FRM210144", "FRM210145" '寄發文件,寄件查詢
            If Pub_StrUserSt15 = "S15" Then
                EmpstrSql = EmpstrSql & " union select st01,st02,st15 from staff where st01 like '1005%'"
            End If
        Case "FRM210133" '結案單
             strWhere = ""
        Case Else
            'SetEmpDutyCombo 函數
   End Select
   
   'modify by sonia 2016/7/1 可能為帶人主管也可能是區主管,72014姿如為M71主管也是S29,20012帶人主管;帶人主管判斷改寫法
   ''檢查是否有帶人的權限
   'If strST05 = "SA" Then
   '   EmpstrSql = EmpstrSql & " union select st01,st02 from staff where (st52='" & strST01 & "' or st53='" & strST01 & "' or st54='" & strST01 & "' or st55='" & strST01 & "') and (st04='1' or st51>=" & strDate & ")"
   '   '中三區人員可單獨下68096看期限
   '   If Pub_StrUserSt15 = "S23" Then
   '      EmpstrSql = EmpstrSql & " union select st01,st02 from staff where st01='68096'"
   '   End If
   '   '北五區人員可單獨下10051看期限
   '   If Pub_StrUserSt15 = "S15" Then
   '      EmpstrSql = EmpstrSql & " union select st01,st02 from staff where st01='10051'"
   '   End If
   'ElseIf Mid(Pub_StrUserSt15, 1, 1) <> "S" And (strST05 = "21" Or strST05 = "26" Or strST05 = "28") And PUB_GetStaffST16(strUserNum) <> "" Then
   '   EmpstrSql = EmpstrSql & " union select st01,st02 from staff where st01<>'" & strUserNum & "' and st15='" & Pub_StrUserSt15 & "' and st16='" & PUB_GetStaffST16(strUserNum) & "' and (st04='1' or st51>=" & strDate & ") and substr(st01,4,1)<>'9'"
   'Else '區主管
   '   EmpstrSql = EmpstrSql & " union select st01,st02 from staff,acc090 where a0908='" & strUserNum & "' and a0901=st15 and st01<>'" & strUserNum & "' and (st04='1' or st51>=" & strDate & ") AND ST01>'1' AND ST01<'F' and substr(st01,4,1)<>'9'"
   'End If
   '72014姿如為M71主管也是S29,20012帶人主管;帶人主管判斷改寫法
   '檢查是否有帶人的權限
   If PUB_GetST05Limits(strUserNum) = True Then
       'Modified by Lydia 2020/06/08 +st15
      EmpstrSql = EmpstrSql & " union select st01,st02,st15 from staff where (st52='" & StrST01 & "' or st53='" & StrST01 & "' or st54='" & StrST01 & "' or st55='" & StrST01 & "') and (st04='1' or st51>=" & strDate & ")"
      '中三區人員可單獨下68096看期限
      If Pub_StrUserSt15 = "S23" Then
         EmpstrSql = EmpstrSql & " union select st01,st02,st15 from staff where st01='68096'"
      End If
      'Mark by Amy 2023/02/10 往上搬
'      '北五區人員可單獨下10051看期限
'      If Pub_StrUserSt15 = "S15" Then
'         EmpstrSql = EmpstrSql & " union select st01,st02,st15 from staff where st01='10051'"
'      End If
   End If
   If Mid(Pub_StrUserSt15, 1, 1) <> "S" And (strST05 = "21" Or strST05 = "26" Or strST05 = "28") And PUB_GetStaffST16(strUserNum) <> "" Then
       'Modified by Lydia 2020/06/08 +st15
      EmpstrSql = EmpstrSql & " union select st01,st02,st15 from staff where st01<>'" & strUserNum & "' and st15='" & Pub_StrUserSt15 & "' and st16='" & PUB_GetStaffST16(strUserNum) & "' and (st04='1' or st51>=" & strDate & ") and substr(st01,4,1)<>'9'"
   End If
   '區主管
   'Modified by Lydia 2020/06/08 +st15
   'Memo by Amy 2023/02/10 往上搬 'Modify by Amy 2021/02/23 結案單抓區主管不需判斷 and (st04='1' or st51>=" & strDate & ") ex:T-170359 69004已離職主管無法結案
   'Modify by Amy 2022/05/03 排除st01開頭為W,W1001的案子魏經理要可結案 ex:T-175266
   EmpstrSql = EmpstrSql & " union select st01,st02,st15 from staff,acc090 where a0908='" & strUserNum & "' and a0901=st15 and st01<>'" & strUserNum & "' " & strWhere & " AND ((ST01>'1' AND ST01<'F') Or Substr(st01,1,1)='W') And substr(st01,4,1)<>'9'"
   'end 2021/02/23
   'end 2016/7/1
   'Add By Sindy 2016/8/17 可以查詢同單位的人員案件資料
   If bolQuyAreaEmp = True And Mid(Pub_StrUserSt15, 1, 1) = "S" Then
       'Modified by Lydia 2020/06/08 +st15
      EmpstrSql = EmpstrSql & " union select st01,st02,st15 from staff where st15='" & Pub_StrUserSt15 & "' and st01<>'" & strUserNum & "' and (st04='1' or st51>=" & strDate & ") AND ST01>'6' AND ST01<'F' and substr(st01,4,1)<>'9'"
   End If
   '2016/8/17 END
   'Added by Lydia 2020/06/08 增加特殊權限
   If strGetKind = "AREA" Then
       strText = Pub_GetSpecMan("全所智權部主管")
       If strText <> "" And InStr(strText, strUserNum) > 0 Then
            EmpstrSql = EmpstrSql & " union select st01,st02,st15 from staff where st15>='S00' and st15<='S49' and (st04='1' or st51>=" & strDate & ") AND ST01>'1' AND ST01<'F' and substr(st01,4,1)<>'9'"
       End If
       strText = Pub_GetSpecMan("北所智權部主管")
       If strText <> "" And InStr(strText, strUserNum) > 0 Then
            EmpstrSql = EmpstrSql & " union select st01,st02,st15 from staff where st15>='S10' and st15<='S19' and (st04='1' or st51>=" & strDate & ") AND ST01>'1' AND ST01<'F' and substr(st01,4,1)<>'9'"
       End If
       strText = Pub_GetSpecMan("中所智權部主管")
       If strText <> "" And InStr(strText, strUserNum) > 0 Then
            EmpstrSql = EmpstrSql & " union select st01,st02,st15 from staff where st15>='S20' and st15<='S29' and (st04='1' or st51>=" & strDate & ") AND ST01>'1' AND ST01<'F' and substr(st01,4,1)<>'9'"
       End If
   End If
   'end 2020/06/08
   
   'Added by Lydia 2020/06/08 增加特殊權限
   If strGetKind = "AREA" Then
       EmpstrSql = EmpstrSql & " order by st15, st01 "
   Else
   'end 2020/06/08
       EmpstrSql = EmpstrSql & " order by st01"
   End If 'Added by Lydia 2020/06/08
   
   intA = 1
   Set rsAD = ClsLawReadRstMsg(intA, EmpstrSql)
   If intA = 1 Then
      With rsAD
         .MoveFirst
         Do While Not .EOF
            If Not IsNull(rsAD.Fields(0)) Then
               strUseSales = strUseSales & ",'" & Trim(rsAD.Fields(0)) & "'"
               'Modified by Lydia 2020/06/08
               'strText = Trim(rsad.Fields(0)) & " " & GetPrjSalesNM(Trim(rsad.Fields(0)))
               strText = Trim(rsAD.Fields(0)) & " " & rsAD.Fields(1)
               If TypeName(objCbo) <> "Nothing" Then 'Modify By Sindy 2015/2/5 + if
                  'Modify By Sindy 2015/12/21
                  For ii = 0 To objCbo.ListCount - 1
                     If InStr(objCbo.List(ii), Trim(rsAD.Fields(0))) = 1 Then
                        Exit For
                     End If
                  Next
                  If ii = objCbo.ListCount Then
                  '2015/12/21 END
                     objCbo.AddItem strText
                  End If
               End If
            End If
            .MoveNext
         Loop
      End With
   End If
   If strUseSales <> "" Then
      strUseSales = Mid(strUseSales, 2)
   End If
   Set rsAD = Nothing 'Added by Lydia 2024/05/15
End Sub

'Modify By Sindy 2014/9/3 原在各個程式裡改為共用
Public Function PUB_StripNulls(OriginalStr As String) As String
    If (InStr(OriginalStr, Chr(0)) > 0) Then
        OriginalStr = Left(OriginalStr, InStr(OriginalStr, Chr(0)) - 1)
    End If
    PUB_StripNulls = OriginalStr
End Function
'找檔案,回傳第一個找到的路徑
Public Function PUB_FindFirstFileAPI(path As String, SearchStr As String) As String
    Dim FileName As String ' Walking filename variable...
    Dim DirName As String ' SubDirectory Name
    Dim dirNames() As String ' Buffer for directory name entries
    Dim nDir As Integer ' Number of directories in this path
    Dim i As Integer ' For-loop counter...
    Dim hSearch As Long ' Search Handle
    Dim WFD As WIN32_FIND_DATA
    Dim Cont As Integer
    Dim bolGotIt As Boolean
    
    If Right(path, 1) <> "\" Then path = path & "\"
    ' Search for subdirectories.
    nDir = 0
    ReDim dirNames(nDir)
    Cont = True
    hSearch = FindFirstFile(path & "*", WFD)
    'If hSearch <> INVALID_HANDLE_VALUE Then
    If hSearch <> -1 Then
        Do While Cont
        DirName = PUB_StripNulls(WFD.cFileName)
        ' Ignore the current and encompassing directories.
        If (DirName <> ".") And (DirName <> "..") Then
            ' Check for directory with bitwise comparison.
            If GetFileAttributes(path & DirName) And FILE_ATTRIBUTE_DIRECTORY Then
                dirNames(nDir) = DirName
                nDir = nDir + 1
                ReDim Preserve dirNames(nDir)
            End If
        End If
        Cont = FindNextFile(hSearch, WFD) 'Get next subdirectory.
        Loop
        Cont = FindClose(hSearch)
    End If
    ' Walk through this directory and sum file sizes.
    hSearch = FindFirstFile(path & SearchStr, WFD)
    Cont = True
    'If hSearch <> INVALID_HANDLE_VALUE Then
    If hSearch <> -1 Then
        Do While Cont
            FileName = PUB_StripNulls(WFD.cFileName)
            If (FileName <> ".") And (FileName <> "..") Then
                PUB_FindFirstFileAPI = PUB_FindFirstFileAPI & path & FileName
                bolGotIt = True
                Exit Do
            End If
            Cont = FindNextFile(hSearch, WFD) ' Get next file
        Loop
        Cont = FindClose(hSearch)
    End If
    ' If there are sub-directories...
    If nDir > 0 And bolGotIt = False Then
        ' Recursively walk into them...
        For i = 0 To nDir - 1
            PUB_FindFirstFileAPI = PUB_FindFirstFileAPI & PUB_FindFirstFileAPI(path & dirNames(i) & "\", SearchStr)
            If PUB_FindFirstFileAPI <> "" Then Exit For
        Next i
    End If
End Function
'讀取PDF的AcroRd32.exe檔案位置
Public Function PUB_SetFileAssociation(Optional sFile As String) As String
Dim i As Integer, s2 As String
Dim bNewFile As Boolean, ff1 As Integer
Dim strReaderPath As String

'預設用 Reader,找不到才檢查關聯設定

'Added by Morgan 2017/10/24 考慮會有不同版本的 Reader, 甚至同時有 Adobe 完整版
'64位元
strReaderPath = Dir("C:\Program Files (x86)\Adobe\*Reader*", vbDirectory)
If strReaderPath <> "" Then
   strReaderPath = PUB_FindFirstFileAPI("C:\Program Files (x86)\Adobe\" & strReaderPath & "\", "AcroRd32.exe")
End If
'32位元
If strReaderPath = "" Then
   strReaderPath = Dir("C:\Program Files\Adobe\*Reader*", vbDirectory)
   If strReaderPath <> "" Then
      strReaderPath = PUB_FindFirstFileAPI("C:\Program Files\Adobe\" & strReaderPath & "\", "AcroRd32.exe")
   End If
End If
'end 2017/10/24

If strReaderPath = "" Then
   strReaderPath = PUB_FindFirstFileAPI("C:\Program Files\Adobe\", "AcroRd32.exe")
End If

If strReaderPath <> "" Then PUB_SetFileAssociation = strReaderPath: Exit Function

'Check if the file exists
If sFile = "" Then
   sFile = "test.pdf"
End If

If Dir(sFile) = "" Or sFile = "" Then
   If ff1 > 0 Then Close #ff1
   ff1 = FreeFile
   Open sFile For Output As #ff1
   Close #ff1
   bNewFile = True
End If

If Dir(sFile) = "" Or sFile = "" Then
   MsgBox "檔案不存在!", vbCritical, "PDF 檔關聯檢查"
   Exit Function
End If

'Create a buffer
's2 = String(MAX_FILENAME_LEN, 32)
s2 = String(260, 32)
'Retrieve the name and handle of the executable, associated with this file
i = FindExecutable(sFile, vbNullString, s2)
If i > 32 Then
   PUB_SetFileAssociation = Left$(s2, InStr(s2, Chr$(0)) - 1)
Else
   MsgBox "PDF 檔關聯不存在，請確認是否有安裝相關應用程式 !", "PDF 檔關聯檢查"
End If

If bNewFile = True Then
   Kill sFile
End If
End Function
'2014/9/3 END

'Add By Sindy 2014/9/4 檢查該案號是否有應收帳款(ACC1K0及ACC0K0)未收
Public Function PUB_ChkReceivables(strCaseNo As String) As Boolean
Dim rsQuery As ADODB.Recordset
Dim strCP01 As String, strCP02 As String, strCP03 As String, strCP04 As String
Dim strTmp As String, intA As Integer 'Added by Lydia 2024/05/15

   PUB_ChkReceivables = False
   strCP01 = SystemNumber(strCaseNo, 1)
   strCP02 = SystemNumber(strCaseNo, 2)
   strCP03 = SystemNumber(strCaseNo, 3)
   strCP04 = SystemNumber(strCaseNo, 4)
      
   strTmp = "select a1k01 from acc1k0" & _
            " where a1k13='" & strCP01 & "' and a1k14='" & strCP02 & "' and a1k15='" & strCP03 & "' and a1k16='" & strCP04 & "'" & _
              " and nvl(a1k12,0)=0 and a1k25 is null and a1k29 is null" & _
            " union " & _
            "select a0k01 from acc0k0,acc0j0" & _
            " where a0j02='" & strCP01 & strCP02 & strCP03 & strCP04 & "' and a0j13=a0k01(+)" & _
              " and nvl(a0k09,0)=0 and a0k37 is null" & _
            " order by 1 asc"
   intA = 1
   Set rsQuery = ClsLawReadRstMsg(intA, strTmp)
   If intA = 1 Then
      'modify by sonia 2014/9/30 未判斷是否有值
      'PUB_ChkReceivables = True
      If rsQuery.Fields(0) <> "" Then PUB_ChkReceivables = True
   End If
   
   Set rsQuery = Nothing
End Function

'Add By Sindy 2014/9/18
'將Doc檔轉成HTML檔
Public Function PUB_DocToHtml(ByVal p_Name As String, ByVal strCaseNo As String, ByRef strHtmlPathName As String) As Boolean
Dim g_WordAp As Word.Application 'Add By Sindy 2014/9/23
   
On Error GoTo ErrHnd
   
   strHtmlPathName = App.path & "\$$" & strCaseNo & "LetterTemp.htm"
   If TypeName(g_WordAp) <> "Application" Then
      Set g_WordAp = New Word.Application
   End If
   
   With g_WordAp
      .Visible = True
      .Documents.Open p_Name
      'Word 2007 以上
      If Val(.Version) >= 12 Then
         .ActiveDocument.SaveAs strHtmlPathName, FileFormat:=8
      Else
         .ActiveDocument.SaveAs strHtmlPathName, FileFormat:=100
      End If
      .Selection.PageSetup.LeftMargin = .CentimetersToPoints(2)
      .Selection.PageSetup.RightMargin = .CentimetersToPoints(2)
      .Selection.PageSetup.TopMargin = .CentimetersToPoints(2)
      .Selection.PageSetup.BottomMargin = .CentimetersToPoints(2)
      .Selection.ParagraphFormat.DisableLineHeightGrid = True
      .ActiveDocument.Save
      .ActiveDocument.Close wdDoNotSaveChanges
   End With
   g_WordAp.Quit wdDoNotSaveChanges
   Set g_WordAp = Nothing
      
   PUB_DocToHtml = True
   Exit Function
   
ErrHnd:

   Select Case Err.Number
      Case 91:
         g_WordAp.Documents.Open p_Name
         Resume Next
      Case 462:
         Set g_WordAp = New Word.Application
         g_WordAp.Documents.Open p_Name
         Resume Next
      Case Else:
         MsgBox "錯誤 : " & Err.Description, vbCritical
         Exit Function
   End Select
End Function

'Modify By Sindy 2014/9/18
'從撰寫信函Move過來
'國家英文名(要和 basLetter 同步修改)
Public Function PUB_GetNationEngNameForLet(pCode As String) As String
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   
   stSQL = "select decode(na01,'000','Taiwan','020','PRC',decode(instr('101,201',na01),0,null,'the ')||initcap(NA04)) from nation where na01='" & pCode & "'"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      PUB_GetNationEngNameForLet = "" & rsQuery(0)
   End If
   Set rsQuery = Nothing
End Function

'Modify By Sindy 2014/9/18
'從撰寫信函Move過來
Public Function PUB_GetEngPatKindName(sPTM01 As String, sPTM02 As String) As String
On Error GoTo ErrHnd

   strSql = "select PTM05 from patenttrademarkmap where PTM01='" & sPTM01 & "' AND PTM02='" & sPTM02 & "'"
   CheckOC
   With adoRecordset
      .CursorLocation = adUseClient
      .Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      '若有資料
      If .RecordCount > 0 Then
         PUB_GetEngPatKindName = " " & .Fields(0)
         If PUB_GetEngPatKindName = " Patent" Then PUB_GetEngPatKindName = ""
      End If
   End With
   
ErrHnd:
   If Err.Number <> 0 Then MsgBox Err.Description, vbCritical
End Function

'Add by Amy 2014/10/02 確認同一天收文日沒有其他程序已發文
Public Function ChkOneDayHasCP27(pCP01 As String, pCP02 As String, pCP03 As String, pCP04 As String, pCP05 As String) As Boolean
    Dim RsQ As New ADODB.Recordset, strQuery  As String, intQ As Integer
    
    ChkOneDayHasCP27 = False
    strQuery = "Select 1 From CaseProgress " & _
                    "Where cp01='" & pCP01 & "' And cp02='" & pCP02 & "' And cp03='" & pCP03 & "' And cp04='" & pCP04 & "' " & _
                    "And cp05=" & pCP05 & " And cp27 is not null"
    intQ = 1
  
    Set RsQ = ClsLawReadRstMsg(intQ, strQuery)
    If RsQ.RecordCount > 0 Then
        ChkOneDayHasCP27 = True
    End If
    Set RsQ = Nothing
End Function

'********************************
'Add by Lydia 2014/10/31
'開放外專程序人員可進入專利處系統操作FMP寰華案件，但非此類案件時外專程序人員不可操作。
'iMsg=>Input 0:有訊息 1:無訊息
'iFsys=> 0:表單使用權限判斷, 1:Case權限判斷, 2:是否寰華案件判斷
'iFT00=>等級判斷(N3=程式權限)
'iFT01~iFT04=本所案號(iFT01="CHANGE_SQL"=>使用傳入的SQL判斷)
'FMP2open 判斷是否為外專,   FMP2openSQL 傳SQL條件，使用時原表單SQL的對應table別名設f0(例:caseprogress, patent)
'********************************
Public Function PUB_FMPtoCheck(ByRef iMsg As Integer, ByVal iFsys As Integer, ByVal iFT00 As String, Optional ByVal iFT01 As String, Optional iFT02 As String, Optional iFT03 As String, Optional iFT04 As String) As Boolean
   Dim mStrSql As String
   Dim rsA As New ADODB.Recordset
   
   '------用於判斷是否為外專和預設條件
   PUB_FMPtoCheck = False
   'Modified by Lydia 2017/05/03 單純拿來判斷寰華案,則不變更全域變數
   'FMP2open = False  '是否為外專
   If iFsys <> 2 Then FMP2open = False
   
   FMP2openSQL = ""
   
   'Added by Lydia 2017/06/22 判斷系統別
   If iFsys = 2 And (iFT01 <> "CHANGE_SQL" And iFT01 <> "P" And iFT01 <> "PS") Then
      Exit Function
   End If
   'end 2017/06/22
   
   'Modified by Lydia 2015/01/12 只判斷外專
'  If UCase(App.EXEName) <> "PATPRO" And UCase(App.EXEName) <> "TEPATPRO" Then Exit Function  '增加判斷是否為內專程式
   'Modified by Lydia 2015/10/26 寰華案定義改為:新案發文人員為外專程序者
   'FMP2openSQL = " and exists (select * from caseprogress f1 where f1.CP31='Y' and SUBSTR(f1.CP12,1,1) = 'F' and f1.CP44='Y53374000' and f0.CP01=f1.CP01 and f0.CP02=f1.CP02 and f0.CP03=f1.CP03 and f0.CP04=f1.CP04 )  "
   'Modified by Lydia 2020/03/16 改成常數
   'FMP2openSQL = " and exists (select f1.* from caseprogress f1,staff t01 where f1.CP31='Y' and SUBSTR(f1.CP12,1,1) = 'F' and f1.CP44='Y53374000' and f0.CP01=f1.CP01 and f0.CP02=f1.CP02 and f0.CP03=f1.CP03 and f0.CP04=f1.CP04 " & _
                 " and f1.cp83=t01.st01(+) and (t01.st03='F22' or t01.st03 is null) )  "
   FMP2openSQL = FMP2openSqlCont
   mStrSql = " and CP01 in ('P','PS') and CP31='Y' and SUBSTR(CP12,1,1) = 'F' and CP44='Y53374000' "
   strSql = ""
   'Modified by Lydia 2016/07/12 +外專32
   If iFT00 = "31" Or iFT00 = "33" Or iFT00 = "34" Or iFT00 = "32" Then
      'Modified by Lydia 2015/01/12 只判斷外專
      'Modified by Lydia 2017/05/03 單純拿來判斷寰華案,則不變更全域變數
      'If UCase(App.EXEName) = "PATPRO" Or UCase(App.EXEName) = "TEPATPRO" Then FMP2open = True
      'Modified by Lydia 2020/07/02 因為原本控制外專人員在Patpro有限制，反而在Patpro1反而不受限；改成不限制exe，只針對外專人員+P案。
      'If iFsys <> 2 And (UCase(App.EXEName) = "PATPRO" Or UCase(App.EXEName) = "TEPATPRO") Then FMP2open = True
      If iFsys <> 2 Then FMP2open = True
   Else
      'Modified by Lydia 2014/12/29 新增非FMP寰華權限,不可看寰華案->回傳SQL
      If iFT01 = "INVERSE_SQL" Then
        FMP2openSQL = Replace(FMP2openSQL, "exists", "not exists")
      Else
        FMP2openSQL = ""
      End If
   End If
   
   If iFsys = 0 Then '判斷表單是否限制使用權限
      If FMP2open = False Then Exit Function
   Else
   
      If iFsys = 1 Then 'case權限判斷
         If FMP2open = False Then Exit Function  '非外專
      End If
   
      'Added by Lydia 2020/07/02 因為原本控制外專人員在Patpro有限制，反而在Patpro1反而不受限；改成不限制exe，只針對外專人員+P案。
      If FMP2open = True And iFT01 <> "CHANGE_SQL" And iFT01 <> "P" Then
           PUB_FMPtoCheck = True
           Exit Function
      End If
      'end 2020/07/02
      
      '------用於判斷各案是否可以使用
      If iFT01 = "CHANGE_SQL" Then '使用傳入的SQL判斷
         'mStrSql = " select f0.CP01, f0.CP02, f0.CP03, f0.CP04, f0.CP05, f0.CP09, f0.CP10, f0.CP12 " & _
                   " from caseprogress f0 where  f0.CP09='" & iFT01 & "' " & FMP2openSQL
         mStrSql = iFT02
      Else                   '案號
         If Len(iFT03) = 0 Then iFT03 = "0"
         If Len(iFT04) = 0 Then iFT04 = "00"
         'Modified by Lydia 2015/10/26 寰華案定義改為:新案發文人員為外專程序者
'         mStrSql = " select CP01,CP02,CP03,CP04,CP05,CP09,CP10,CP12 from caseprogress " & _
'                   " where CP01='" & iFT01 & "' and CP02='" & iFT02 & "' and CP03='" & iFT03 & "' and CP04='" & iFT04 & "' " & mStrSql
         mStrSql = " select CP01,CP02,CP03,CP04,CP05,CP09,CP10,CP12 from caseprogress,staff " & _
                   " where CP01='" & iFT01 & "' and CP02='" & iFT02 & "' and CP03='" & iFT03 & "' and CP04='" & iFT04 & "' " & _
                   " and cp83=st01(+) and (st03='F22' or st03 is null) " & mStrSql

      End If
      
      rsA.CursorLocation = adUseClient
      rsA.Open mStrSql, cnnConnection, adOpenStatic, adLockReadOnly
      If rsA.RecordCount = 0 Then
         If iMsg = 0 Then
            MsgBox "權限不足 !", vbInformation
         End If
         mStrSql = "N"
      End If
      '------用於判斷各案是否可以使用
   End If
   If rsA.State <> adStateClosed Then rsA.Close
   Set rsA = Nothing
   If mStrSql = "N" Then Exit Function
          
   PUB_FMPtoCheck = True

End Function

'Removed by Moragn 2014/11/6 basStart,aacc_start 移來
Public Sub PUB_SetStaffVar()
Dim strTmp As String, intA As Integer, rsAD As New ADODB.Recordset 'Added by Lydia 2024/05/15

   If strUserNum <> "" Then
      'Modified by Morgan 2023/12/18 +ST93
      strTmp = "Select ST06,ST03,ST05,ST17,ST15,ST11,ST93 From Staff Where ST01='" & strUserNum & "'"
      intA = 1
      Set rsAD = ClsLawReadRstMsg(intA, strTmp)
      If intA = 1 Then
         pub_strUserOffice = "" & rsAD.Fields("ST06")
         Pub_StrUserSt03 = "" & rsAD.Fields("ST03")
         Pub_StrUserSt93 = "" & rsAD.Fields("ST93") 'Added by Morgan 2023/12/18 新部門
         Pub_StrUserSt17 = "" & rsAD.Fields("ST17")
         Pub_StrUserSt15 = "" & rsAD.Fields("ST15")
         Pub_strUserST05 = "" & rsAD.Fields("ST05") 'Add by Lydia 2014/10/31 使用者等級
         strGroup = "" & rsAD.Fields("ST11") '直接改使用者群組
         Pub_strUserST11 = "" & rsAD.Fields("ST11") '後面的程式遇到可改用此變數
      End If
   End If
   
   Set rsAD = Nothing 'Added by Lydia 2024/05/15
End Sub

'Add By Sindy 2015/3/19
'依員工編號抓取員工姓名 或 依員工姓名抓取員工編號
Public Function ByInputGetST01or02(ByVal strInput As String, _
                                   ByRef StrST01 As String, ByRef strST02 As String, _
                                   Optional ByVal bolShowMsg As Boolean = True) As Boolean
Dim strText As String
   
   ByInputGetST01or02 = True
   StrST01 = strInput
   strST02 = ""
   If strInput <> "" Then
      '先依員工編號抓取員工姓名
      If IsNumeric(Mid(Trim(strInput), 2, 4)) Then
         'Modify by Amy 2025/01/10 避免傳入資料為員編+姓名,故取前5碼
         'strText = GetPrjSalesNM(strInput)
         strText = GetPrjSalesNM(Mid(strInput, 1, 5))
         If strText <> "" Then
            'strST01 = Trim(strInput)
            StrST01 = Mid(Trim(strInput), 1, 5)
         'end 2025/01/10
            strST02 = strText
            Exit Function
         End If
      End If
      '依員工姓名抓取員工編號
      strText = GetPrjSalesNM_2(Trim(strInput))
      If strText <> "" Then
         StrST01 = strText
         strST02 = Trim(strInput)
         Exit Function
      End If
      ByInputGetST01or02 = False
      If bolShowMsg = True Then
         MsgBox "輸入的員工資料有誤，查無資料！", vbExclamation + vbOKOnly
      End If
   End If
End Function

'Add by Amy 2015/04/15 依平台編號檢查是否有客戶平台權限(使用者為空值,大家都可看)
Public Function PUB_ChkCustWebLimit(strCW01 As String, strUser) As Boolean
    Dim stSQL As String, intR As Integer, adoRst As ADODB.Recordset
    Dim strCD06 As String
    
    PUB_ChkCustWebLimit = False
    
    'Modiby by Amy 2015/06/09 修改權限-未設帳號或有帳號使用者為空都可看
    stSQL = "Select Nvl(cd06,'User') cd06 From CustWeb,CustWebId " & _
             "Where cw01=cd01(+) And cw01='" & strCW01 & "' " & _
             "order by cd05 asc,cd03 asc"
    intR = 1
    Set adoRst = ClsLawReadRstMsg(intR, stSQL)
    If intR = 1 Then
        Do While Not adoRst.EOF
            If Not IsNull(adoRst.Fields("cd06")) Then
                strCD06 = strCD06 & "," & adoRst.Fields("cd06")
            End If
            adoRst.MoveNext
        Loop
    End If
    If InStr(strCD06, "User") > 0 Or InStr(strCD06, strUser) > 0 Or Pub_StrUserSt03 = "M51" Then
        PUB_ChkCustWebLimit = True
    End If
    'end 2015/06/09
    
    Set adoRst = Nothing
End Function
'Modified by Lydia 2015/07/20 提實審期間(frm040303改共用)
Public Function Pub_Get416Period(iPA08 As String, iPA09 As String) As String
   Dim stSQL As String, adoRst As ADODB.Recordset, intR As Integer, stCol As String
   Dim iNo As Integer
   Select Case iPA08
      Case "1"
         stCol = "na27"
      Case "2"
         stCol = "na29"
      Case Else
         stCol = "na31"
   End Select
   stSQL = "select " & stCol & " from nation where na01='" & iPA09 & "'"
   intR = 1
   Set adoRst = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      If Not IsNull(adoRst(0)) Then
         If adoRst(0) Mod 12 = 0 Then
            iNo = adoRst(0) / 12
            Pub_Get416Period = PUB_ChgNumber2Chinese(Format(iNo)) & "年"
         Else
            iNo = adoRst(0)
            Pub_Get416Period = PUB_ChgNumber2Chinese(Format(iNo)) & "個月"
         End If
      End If
   End If
   Set adoRst = Nothing
End Function

'Modfiy by Amy 2015/12/02
'Modify by Amy 2025/07/01 +國籍stNation
'取代地址欄縣市改制及臺字修改
Public Function ReplaceAddrTW(strAddr As String, Optional ByVal bolAll As Boolean = True, Optional ByVal stNation As String) As String
    Dim strFind() As Variant, strReplace() As Variant
    Dim ii As Integer
    Dim bolRunRep As Boolean 'Add by Amy 2025/07/01
    
    'Modify by Amy 2025/07/01 +if
    '     X90619 客戶維護時,地址國籍大陸,聯絡地址為中國浙江省台州市溫嶺市大溪區高速公路道口一級公路北側-->無法改成大溪鎮
    If stNation < "010" Then
      If bolAll = True Then
          strFind = Array("台灣", "台北", "台中", "台南", "台東", "釣魚台", "中華民國台", "臺中港路", "臺中路")
          strReplace = Array("臺灣", "臺北", "臺中", "臺南", "臺東", "釣魚臺", "中華民國臺", "台中港路", "台中路")
          bolRunRep = True
      Else
          '舊客戶資料更新時不取代路名
          strFind = Array("台灣", "台北", "台中", "台南", "台東", "釣魚台", "中華民國台")
          strReplace = Array("臺灣", "臺北", "臺中", "臺南", "臺東", "釣魚臺", "中華民國臺")
          bolRunRep = True
      End If
    End If
    
    ReplaceAddrTW = Replace(strAddr, "　", "＠~") '第1碼為全型空白不截掉, 怕特殊用途
    ReplaceAddrTW = PUB_ChangeZIPToSir(ReplaceAddrTW) '逐字將半型改為全型
    If Left(ReplaceAddrTW, 1) = " " Then ReplaceAddrTW = Left(ReplaceAddrTW, 2) '第1碼空白截掉
    ReplaceAddrTW = ReplaceAddr(ReplaceAddrTW, 3, stNation) 'Modify by Amy 2025/07/01 +stNation
    
    'Modify by Amy 2025/07/01 +if
    If bolRunRep = True Then
      For ii = 0 To UBound(strReplace)
          If bolAll = True Then
              ReplaceAddrTW = Replace(ReplaceAddrTW, strFind(ii), strReplace(ii))
          Else
              '舊客戶資料更新時只取代前幾個字
              ReplaceAddrTW = Replace(Left(ReplaceAddrTW, Len(strFind(ii))), strFind(ii), strReplace(ii)) & Mid(ReplaceAddrTW, Len(strFind(ii)) + 1)
          End If
      Next ii
    End If
   
    ReplaceAddrTW = Replace(ReplaceAddrTW, "＠~", "　") '還原第1碼為全型空白不截掉, 怕特殊用途
    ReplaceAddrTW = Replace(ReplaceAddrTW, "＠∼", "　") '還原第1碼為全型空白不截掉, 怕特殊用途
End Function

'以字串抓取 郵局郵遞區號資料檔 PostZipData
'FindStr:尋找的字串 / intStr:取n個字尋找
'bolIsMany:是否為多筆
'intZip:回傳Zip 取幾個字 (會轉全型)/ strCountryCode:回傳國籍
'stField:尋找欄位
'stGetData:回傳某欄位 Ex:pzd03(若要回傳,需回傳的欄位名稱)
Public Function GetPostZip(FindStr As String, F_intStr As Integer, Optional intZIP As Integer = 3, Optional ByRef strCountryCode As String = "", Optional ByRef bolIsMany As Boolean = False, _
                        Optional ByVal stField As String = "Pzd02||Pzd03", Optional ByRef stGetData As String = "") As String
    Dim RsQ As New ADODB.Recordset, ii As Integer
    Dim strQ As String, stBackData As String, stOldCountry As String
    Dim strWhere As String 'Add by Amy 2023/03/10
    
    GetPostZip = "": strCountryCode = "": bolIsMany = False
    
    If intZIP = 0 Then
        strQ = "Pzd01"
    Else
        strQ = "SubStr(pzd01,1," & intZIP & ") as Pzd01"
    End If
    'Add by Amy 2023/03/10 stField可用And 語法
    strWhere = "Where "
    If Left(UCase(stField), 4) = "AND " Then
       strWhere = strWhere & Replace(UCase(stField), "AND ", "")
    Else
        strWhere = strWhere & "SubStr(" & stField & ",1," & F_intStr & ")=rtrim('" & ChgSQL(FindStr) & " ') "
    End If
    
    '***若資料可能有xx工業區請先 使用ReplaceIndArea將其取代後再呼叫此函數查詢
    'rtrim(字串+半型空白) 避免造字當掉
    'Modify by Amy 2023/03/10 stField可用Where 語法
    strQ = "Select Distinct " & strQ & ",Pzd11" & IIf(stGetData = "", "", "," & stGetData) & " From PostZipData " & _
              strWhere
    RsQ.CursorLocation = adUseClient
    RsQ.Open strQ, cnnConnection, adOpenStatic, adLockReadOnly
    
    If RsQ.RecordCount > 0 Then
        If RsQ.RecordCount > 1 Then
            bolIsMany = True
        ElseIf RsQ.RecordCount = 1 Then
            '回傳資料
            If stGetData <> MsgText(601) Then stBackData = "" & RsQ.Fields(2)
        End If
        For ii = 0 To RsQ.RecordCount - 1
            GetPostZip = GetPostZip & PUB_ChangeZIPToSir("" & RsQ.Fields("Pzd01")) & ","
            If stOldCountry <> "" & RsQ.Fields("Pzd11") Then
                strCountryCode = strCountryCode & "" & RsQ.Fields("Pzd11") & ","
            End If
            stOldCountry = "" & RsQ.Fields("Pzd11")
            RsQ.MoveNext
        Next ii
        If stGetData <> MsgText(601) Then stGetData = stBackData
        GetPostZip = Mid(GetPostZip, 1, Len(GetPostZip) - 1)
        strCountryCode = Mid(strCountryCode, 1, Len(strCountryCode) - 1)
    End If
    RsQ.Close
End Function

'檢查地址欄縣市改制及臺字,回傳ZipCode/CountryCode
'Modify by Amy 2015/10/22 +stFormName 特殊Form使用
'Modify by Amy 2016/01/05 +stAddr for 不改地址欄但需檢查(如:地址沒區 +區後檢查)
'Add by Amy 2017/06/07 +intTW:0-錯誤/1-彈訊息確認是台灣地址/3-ZipCode確認是台灣地址/99-非台灣不必檢查
'Modify By Sindy 2021/7/16 改為用 Object 型態
'Public Function CheckTaiwanAddr_Tai(ByRef objTxt As TextBox, ByRef objZipTxt As TextBox, ByVal strNation As String, Optional strLabel As String, Optional ByRef stZipCode As String, Optional ByRef stCountryCode As String, _
'    Optional ShowMsg As Boolean = True, Optional stFormName As String = "", Optional stAddr As String = "", Optional ByRef intTW As Integer) As Boolean
'Modify by Amy 2024/06/24 +objTab1/objTab2 頁籤
'Modify by Amy 2024/08/29 +stFormN
Public Function CheckTaiwanAddr_Tai(ByRef objTxt As Object, ByRef objZipTxt As Object, ByVal strNation As String, Optional strLabel As String, Optional ByRef stZipCode As String, Optional ByRef stCountryCode As String, _
    Optional ShowMsg As Boolean = True, Optional stFormName As String = "", Optional stAddr As String = "", Optional ByRef intTW As Integer, Optional ByRef objTab1 As Object, Optional ByRef objTab2 As Object, Optional ByVal stFormN As String) As Boolean

    Dim strTp As String, strTmp As String
    Dim strZipCode As String, strCountryCode As String
    Dim intTabIdx As Integer 'Add by Amy 2024/06/24
    
    CheckTaiwanAddr_Tai = True: stZipCode = "": stCountryCode = ""
    'Modify by Amy 2024/06/18 +intTW,讓接洽單可依地址判斷是否為台灣 for 檢查身份證號
    If strNation > "010" Then intTW = 99: Exit Function '國籍非台灣不必檢查
    
    'Add by Amy 2024/08/29 修改程式需確認下列表單是否都要改
    Select Case UCase(stFormN)
      Case "FRM140401" '客戶檔維護
      Case "FRM210101_1" '智權客戶資料修改
      Case "FRM210101_2" '智權接洽人修改
      Case "FRM090801" '接洽單
      Case "FRM090801_NEW" '電子接洽單
    End Select
    
    If stAddr <> MsgText(601) Then
        strTp = stAddr
    Else
        strTp = objTxt.Text
    End If
    
    'Mark by Amy 2024/08/29 接洽單電子化後需檢查才能與櫃台新客戶建檔一致
    'If InStr(strTp, "信箱") > 0 Then intTW = 20: Exit Function '郵政信箱不檢查
    
     '*** 檢查 地址格式 ***
    strTmp = ""
    'Modify by Amy 2015/11/30 去除中華民國、台灣省、台灣
    If Mid(strTp, 1, 4) = "中華民國" Then strTp = Mid(strTp, 5)
    If Mid(strTp, 1, 3) = "臺灣省" Or Mid(strTp, 1, 3) = "台灣省" Then strTp = Mid(strTp, 4)
    If Mid(strTp, 1, 2) = "臺灣" Or Mid(strTp, 1, 2) = "台灣" Then strTp = Mid(strTp, 3)
        
    If Mid(strTp, 1, 3) = "臺北市" Or Mid(strTp, 1, 3) = "新北市" Or Mid(strTp, 1, 3) = "桃園市" Or Mid(strTp, 1, 3) = "臺中市" Or Mid(strTp, 1, 3) = "臺南市" Or Mid(strTp, 1, 3) = "高雄市" _
        Or Mid(strTp, 1, 3) = "基隆市" Or Mid(strTp, 1, 3) = "新竹市" Or Mid(strTp, 1, 3) = "嘉義市" Then
        'xx市xx區
        'Modify by Amy 2020/09/10 +7個字查
        If Mid(strTp, 7, 1) <> "區" And Mid(strTp, 6, 1) <> "區" And Mid(strTp, 5, 1) <> "區" Then
            strTmp = "格式應為 xx市xx區！"
        End If
    ElseIf InStr(strTp, "釣魚臺") > 0 Then
    Else
        '其他縣市 xx縣xx市(鄉)(鎮)
        'Modify by Amy 2020/09/10 +7個字查
        'Modify by Amy 2021/03/15 +7個字查「鄉」 ex:臺東縣太麻里鄉
         If Mid(strTp, 7, 1) <> "區" And Mid(strTp, 6, 1) <> "市" And Mid(strTp, 5, 1) <> "市" And Mid(strTp, 7, 1) <> "鄉" And Mid(strTp, 6, 1) <> "鄉" And Mid(strTp, 5, 1) <> "鄉" And Mid(strTp, 6, 1) <> "鎮" And Mid(strTp, 5, 1) <> "鎮" Then
            strTmp = "格式應為 xx縣xx市(鄉)(鎮)！"
         End If
    End If
    If strTmp <> MsgText(601) Then
        'Add by Amy 2015/10/22 +ShowMsg/stFormName
        If ShowMsg = True Then
            Select Case UCase(stFormName)
                'Modify By Sindy 2022/9/16 + frm090801_New
                Case "FRM090801", "FRM090801_NEW"
                    '地址格式可能無法修改,故加此判斷
                    If objTxt.Enabled = True Then
                        'Add by Amy 2024/06/24 加頁籤
                        If objTab1 Is Nothing = False Then objTab1.Tab = 1
                        If objTab2 Is Nothing = False Then objTab2.Tab = (objTxt.Index - 27) / 16
                        'Add by Amy 2017/06/06 避免輸錯需重新輸入,故再彈是否是台灣地址訊息
                        If MsgBox(strLabel & "是臺灣地址嗎？", vbYesNo + vbCritical) = vbYes Then
                            MsgBox strLabel & strTmp, , MsgText(5)
                            objTxt.SetFocus
                            intTW = 1
                        Else
                            intTW = 99
                        End If
                    Else
                        MsgBox strLabel & strTmp & "請通知檔案室修改！", , MsgText(5)
                    End If
                Case Else
                    MsgBox strLabel & strTmp, , MsgText(5)
                    objTxt.SetFocus
            End Select
        End If
        'end 2015/10/22
        stZipCode = "格式錯誤"
        CheckTaiwanAddr_Tai = False
        Exit Function
    End If
    
    '抓取臺灣地址郵遞區號
    'Modify by Amy 2020/09/10 +7個字查
    strZipCode = GetPostZip(Left(strTp, 7), 7, , strCountryCode)
    If strZipCode = "" Then
    strZipCode = GetPostZip(Left(strTp, 6), 6, , strCountryCode)
        If strZipCode = "" Then
            strZipCode = GetPostZip(Left(strTp, 5), 5, , strCountryCode)
            If strZipCode = "" Then
                'Add by Amy 2015/10/22 +ShowMsg/stFormName
                If ShowMsg = True Then
                    Select Case UCase(stFormName)
                        'Modify By Sindy 2022/9/16 + frm090801_New
                        Case "FRM090801", "FRM090801_NEW"
                            strTmp = strLabel & "臺灣地址格式不正確,郵遞區號無法帶出要自行輸入郵遞區號嗎？"
                            If MsgBox(strTmp, vbYesNo + vbCritical) = vbNo Then
                                 If objTxt.Enabled = True Then
                                    'Add by Amy 2024/06/24 加頁籤
                                    If objTab1 Is Nothing = False Then objTab1.Tab = 1
                                    If objTab2 Is Nothing = False Then objTab2.Tab = (objTxt.Index - 27) / 16
                                    objTxt.SetFocus '地址格式可能無法修改,故加此判斷
                                Else
                                    MsgBox "請通知檔案室修改！" & strLabel, , MsgText(5)
                                End If
                            Else
                                objZipTxt.SetFocus
                            End If
                        Case Else
                            '地址格式不正確,無法帶出郵遞區號詢問
                            strTmp = strLabel & "臺灣地址格式不正確,郵遞區號無法帶出要自行輸入郵遞區號嗎？"
                            If MsgBox(strTmp, vbYesNo + vbCritical) = vbNo Then
                                objTxt.SetFocus
                            Else
                                objZipTxt.SetFocus
                            End If
                    End Select
                End If
                'end 2015/10/22
                CheckTaiwanAddr_Tai = False
                Exit Function
            End If '5個字
        End If '6個字
    End If '7個字
    
    stZipCode = strZipCode
    stCountryCode = strCountryCode
    
End Function
'end 2015/12/02

'Add by Amy 2015/11/27 臺灣地址查詢使用
Public Function ReplaceTWNo(strFind As String) As String
    Dim stNo1(), stNo2(), stDuan1(), stDuan2()
    Dim stTP(2) As String
    Dim stNewWord As String
    
    Dim intTenGet As Integer, ii As Integer, jj As Integer
    
    If strFind = MsgText(601) Then Exit Function
    
    stNo1 = Array("０", "１", "２", "３", "４", "５", "６", "７", "８", "９")
    stNo2 = Array("十", "一", "二", "三", "四", "五", "六", "七", "八", "九")
    stDuan1 = Array("１０段", "１段", "２段", "３段", "４段", "５段", "６段", "７段", "８段", "９段")
    stDuan2 = Array("十段", "一段", "二段", "三段", "四段", "五段", "六段", "七段", "八段", "九段")
    
    '先將數字轉為全型
    strFind = PUB_ChangeZIPToSir(strFind)
    ii = 1
    '將所有數字全部取代為國字(資料庫 除「段」前數是為全型數字,其他都是數字的國字)
    Do While ii <= Len(strFind)
        stTP(0) = Mid(strFind, ii, 1)
        If IsNumeric(stTP(0)) Then
            '最後一個字直接取代
            If ii = Len(strFind) Then
                For jj = 1 To UBound(stNo1)
                    If stTP(0) = stNo1(jj) Then
                        stTP(0) = stNo2(jj)
                        Exit For
                    End If
                Next jj
                ii = ii + 1
            '不是最後一個字
            Else
                '3位數(０不需取代)
                If IsNumeric(Mid(strFind, ii + 1, 1)) And ii + 1 <> Len(strFind) _
                  And IsNumeric(Mid(strFind, ii + 2, 1)) And ii + 2 <> Len(strFind) Then
                    For jj = 1 To UBound(stNo1)
                        If stTP(0) = stNo1(jj) Then
                            stTP(0) = Replace(stTP(0), stNo1(jj), stNo2(jj))
                            Exit For
                        End If
                    Next jj
                    stTP(1) = Mid(strFind, ii + 1, 1)
                    For jj = 1 To UBound(stNo1)
                        If stTP(1) = stNo1(jj) Then
                            stTP(1) = Replace(stTP(1), stNo1(jj), stNo2(jj))
                            Exit For
                        End If
                    Next jj
                    stTP(2) = Mid(strFind, ii + 2, 1)
                    For jj = 1 To UBound(stNo1)
                        If stTP(2) = stNo1(jj) Then
                            stTP(2) = Replace(stTP(2), stNo1(jj), stNo2(jj))
                            Exit For
                        End If
                    Next jj
                    stTP(0) = stTP(0) & stTP(1) & stTP(2)
                    ii = ii + 3
                '2位數
                ElseIf IsNumeric(Mid(strFind, ii + 1, 1)) And ii + 1 <> Len(strFind) Then
                    If stTP(0) & Mid(strFind, ii + 1, 1) = "１０" Then
                        stTP(0) = "十"
                    ElseIf stTP(0) = "１" Then
                        '取代個位數
                        stTP(1) = Mid(strFind, ii + 1, 1)
                        For jj = 1 To UBound(stNo1)
                            If stTP(1) = stNo1(jj) Then
                                stTP(1) = Replace(stTP(1), stNo1(jj), stNo2(jj))
                                Exit For
                            End If
                        Next jj
                        stTP(0) = "十" & stTP(1)
                    ElseIf Mid(strFind, ii + 1, 1) = "０" Then
                        '取代十位數
                        For jj = 1 To UBound(stNo1)
                            If stTP(0) = stNo1(jj) Then
                                stTP(0) = Replace(stTP(0), stNo1(jj), stNo2(jj))
                                Exit For
                            End If
                        Next jj
                        stTP(0) = stTP(0) & "十"
                    Else
                        '中間加 "十" 字
                        For jj = 1 To UBound(stNo1)
                            If stTP(0) = stNo1(jj) Then
                                stTP(0) = Replace(stTP(0), stNo1(jj), stNo2(jj))
                                Exit For
                            End If
                        Next jj
                        stTP(1) = Mid(strFind, ii + 1, 1)
                        For jj = 1 To UBound(stNo1)
                            If stTP(1) = stNo1(jj) Then
                                stTP(1) = Replace(stTP(1), stNo1(jj), stNo2(jj))
                                Exit For
                            End If
                        Next jj
                        stTP(0) = stTP(0) & "十" & stTP(1)
                    End If
                    ii = ii + 2
                '1位數
                Else
                    For jj = 1 To UBound(stNo1)
                        If stTP(0) = stNo1(jj) Then
                            stTP(0) = Replace(stTP(0), stNo1(jj), stNo2(jj))
                            Exit For
                        End If
                    Next jj
                    ii = ii + 1
                End If
            End If
        '不是數字
        Else
            ii = ii + 1
        End If
        stNewWord = stNewWord & stTP(0)
    Loop
    strFind = stNewWord
    
    '改回正常「段」
    For ii = 0 To UBound(stDuan2)
        strFind = Replace(strFind, stDuan2(ii), stDuan1(ii))
    Next ii
      
    ReplaceTWNo = strFind
End Function
'end 2015/11/27

'Add by Amy 2015/09/02 從basFunction 搬過來,因 Account-acc_fun也有但其中一隻有另一隻未更新
'Memo by Amy 2020/03/1/ 有改需確認GetDevelopP 是否也要改
'Modify By Sindy 2021/7/16 改為用 Object 型態
'Public Sub PUB_SetUserList(p_Listbox As ListBox, p_stNums As String)
'Modified by Lydia 2021/12/14 +bForm2 是否為Form 2.0元件
Public Sub PUB_SetUserList(p_Listbox As Object, p_stNums As String, Optional ByVal bForm2 As Boolean = False)
   Dim arrID, stSQL As String, intR As Integer, rstTmp As ADODB.Recordset
   Dim intA As Integer 'Added by Lydia 2024/05/15
   p_Listbox.Clear
   If p_stNums <> "" Then
      stSQL = "select st01,st02 from staff where instr('" & p_stNums & "',st01)>0"
      intR = 1
      Set rstTmp = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         arrID = Split(p_stNums, ",")
         With rstTmp
         '照原順序排
         For intR = UBound(arrID) To LBound(arrID) Step -1
            .MoveFirst
            Do While Not .EOF
               If .Fields("st01") = arrID(intR) Then
                  p_Listbox.AddItem "" & .Fields(1), 0
                  'Added by Lydia 2021/12/14 Form 2.0的ListBox沒有ItemData
                  If bForm2 = True Then
                      '保留
                  Else
                  'end 2021/12/14
                      '2012/2/14 MODIFY BY SONIA 員工編號已可非數字需做轉換
                      p_Listbox.ItemData(0) = PUB_Id2Num(.Fields(0)) '員工編號
                  End If 'Added by Lydia 2021/12/14
                  .MoveLast
               End If
               .MoveNext
            Loop
         Next
         End With
      End If
   End If
   Set rstTmp = Nothing
End Sub
'end 2015/09/02

'ADD BY SONIA 2015/9/21 原承辦人為外專程序時,承辦人改為操作人員
Public Function GetFCPUser(strCP14 As String) As String
Dim Rs As New ADODB.Recordset
Dim stSQL As String, intR As Integer

   GetFCPUser = strCP14
   stSQL = "SELECT ST03 FROM STAFF WHERE ST01='" & strCP14 & "' AND ST03='F22'"
   intR = 1
   Set Rs = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      GetFCPUser = strUserNum
   End If
   Rs.Close
End Function
'END 2015/9/21

'Added by Morgan 2015/9/24
'檢查翻譯費用是否超過比例
Public Function PUB_ChkTranslationFee(pDocNo As String, Optional pAmount As Double = 0, Optional pIsPaying As Boolean = True, Optional pBillNo As String) As Boolean
   Dim stSQL As String, intR As Integer, stCP14 As String, stCP13 As String, stMsg As String, stCaseNo As String, stSubj As String
   Dim rsQuery As ADODB.Recordset
   Dim dblPay As Double, dblGet As Double, iRateLimit As Integer, dblRate As Double
   Dim stBMan As String 'Added by Morgan 2019/5/31 帳單輸入人員
   Dim stFaNo As String, stTO As String, stCC As String 'Added by Morgan 2019/7/5
   Dim stEP09 As String 'Added by Morgan 2019/9/16
   Dim stDnNo As String 'Added by Morgan 2021/7/29
   
   PUB_ChkTranslationFee = True
   
   '支出
   If pIsPaying Then
      dblPay = pAmount
      'Modified by Morgan 2019/5/29 +打字費03
      'Modified by Morgan 2019/7/5 +請款對象
      'Modified by Morgan 2021/7/29 +請款單號
      'Modified by Morgan 2023/2/4 +CP01,CP02,CP03,CP04
      stSQL = "select max(cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04)) CaseNo" & _
         " ,cp13,cp14,sum(a1l05-nvl(a1l07,0)) DebAmt,max(a1k28) FaNo,max(cp60) DnNo,cp01,cp02,cp03,cp04" & _
         " from caseprogress, acc1l0,acc1k0 where cp09='" & pDocNo & "'" & _
         " and cp10='201' and cp60>'X' and cp12='F23' and cp14 like 'F%'" & _
         " and a1l01(+)=cp60 and a1l04 in ('201','03') and a1k01(+)=cp60" & _
         " group by cp13,cp14,cp01,cp02,cp03,cp04"
      intR = 1
      Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         '本所案號
         stCaseNo = rsQuery("CaseNo")
         '智權人員
         'Modified by Morgan 2023/2/4
         'stCP13 = rsQuery("cp13")
         stCP13 = PUB_GetFCPSalesNo(rsQuery("cp01"), rsQuery("cp02"), rsQuery("cp03"), rsQuery("cp04"))
         'end 2023/2/4
         '翻譯人員
         stCP14 = rsQuery("cp14")
         '請款金額
         dblGet = rsQuery("DebAmt")
         '請款對象
         stFaNo = rsQuery("FaNo")
         'Added by Morgan 2021/7/29
         '請款單號
         stDnNo = rsQuery("DnNo")
         'end 2021/7/29
      End If
      
   '請款
   Else
      stDnNo = pDocNo 'Added by Morgan 2021/7/29
      
      dblGet = pAmount
      'Added by Morgan 2019/5/29 計算比例要含打字費,改用請款單號抓明細
      If dblGet = 0 Then
         stSQL = "select nvl(sum(a1l05-nvl(a1l07,0)),0) DebAmt from acc1l0" & _
            " where a1l01='" & pDocNo & "' and a1l04 in ('201','03')"
         intR = 1
         Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
         If intR = 1 Then
            dblGet = rsQuery("DebAmt")
         End If
      End If
      'end 2019/5/29
      
      'Modified by Morgan 2019/9/16 +EP09
      'Modified by Morgan 2022/1/13 +CP13
      'Modified by Morgan 2023/2/4 +CP01,CP02,CP03,CP04
      stSQL = "select cp01||'-'||cp02||decode(cp03||cp04,'000','','-'||cp03||'-'||cp04) CaseNo,cp09,cp61,cp14,ep09,cp13,cp01,cp02,cp03,cp04" & _
         " from caseprogress,engineerprogress where cp60='" & pDocNo & "' and cp10='201' and cp60>'X' and cp12='F23' and cp14 like 'F%' and ep02(+)=cp09"
      intR = 1
      Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         'Modified by Morgan 2023/2/4
         'stCP13 = rsQuery("cp13") '智權人員 Added by Morgan 2022/1/13
         stCP13 = PUB_GetFCPSalesNo(rsQuery("cp01"), rsQuery("cp02"), rsQuery("cp03"), rsQuery("cp04"))
         'end 2023/2/4
         stCaseNo = rsQuery("CaseNo")
         stCP14 = rsQuery("cp14")
         stEP09 = "" & rsQuery("ep09") 'Added by Morgan 2019/9/16
         If Not IsNull(rsQuery.Fields("cp61")) Then
            'Modified by Morgan 2019/5/31 +帳單輸入人員
            stSQL = "select round(a1506*nvl(a1906,a2103)) PayAmt,nvl(a1519,a1516) BMan from acc151, acc150, acc190,(select a2102,mod(max(a2101*1000+a2103),1000) a2103 from acc210 group by a2102) x" & _
               " where axf01='" & rsQuery("cp61") & "' and axf02='" & rsQuery("cp09") & "' and a1501(+)=axf01 and a1902(+)=a1501 and a2102(+)=a1505"
            intR = 1
            Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
            If intR = 1 Then
               dblPay = rsQuery(0)
               stBMan = "" & rsQuery(1)
            End If
         Else
            'Modified by Morgan 2019/9/16
            stSQL = "select * from transfee, staff_payrate" & _
               " where tf01='" & rsQuery("cp09") & "' and (tf02>0 or tf21>0) and spr01(+)='" & rsQuery("cp14") & "'"
            intR = 1
            Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
            If intR = 1 Then
               
               With rsQuery
               'Modified by Morgan 2017/2/13 改用函數
               'Added by Morgan 2019/9/16 108.8.15 以後完稿案件改以原文字數計算翻譯費並取消中文打字費
               stBMan = "B1007"  'modify by sonia 2022/10/25 70004->B1007
               If Val(stEP09) >= 20190815 Then
                  dblPay = PUB_GetTransFeeNew(Val("" & .Fields("TF21")), IIf("" & .Fields("TF27") = "1", Val("" & .Fields("TF15")), Val("" & .Fields("TF16"))), Val("" & .Fields("TF05")), Val("" & .Fields("TF06")), Val("" & .Fields("TF18")))
               Else
               'end 2019/9/16
                  dblPay = PUB_GetTransFee(Val("" & .Fields("TF02")), Val("" & .Fields("TF03")), Val("" & .Fields("TF04")), Val("" & .Fields("SPR02")), Val("" & .Fields("SPR03")), Val("" & .Fields("SPR04")), Val("" & .Fields("TF05")), Val("" & .Fields("TF06")), Val("" & .Fields("TF18")), Val("" & .Fields("TF21")), Val("" & .Fields("SPR11")))
               End If 'Added by Morgan 2019/9/16
               End With
            End If
         End If
      End If
   End If
   
   If dblPay > 0 And dblGet > 0 Then
'Modified by Morgan 2021/7/29 改寫函數檢查以便前端翻譯分案時能共用
'      'Added by Morgan 2020/6/1 請款對象Y53983、Y54678、Y55001、 Y55311000 Roehm GmbH IP Management適用於Evonik之固定請款金額翻譯費支出金額  佔請款金額 比例提高至55%--婉莘(外專需求)
'      If pIsPaying Then
'         stSQL = "select a1k28 from caseprogress,acc1k0 where cp09='" & pDocNo & "' and a1k01(+)=cp60"
'      Else
'         stSQL = "select a1k28 from acc1k0 where a1k01='" & pDocNo & "'"
'      End If
'      'Modified by Morgan 2020/8/13 +Y53825000--婉莘
'      'Modified by Morgan 2020/10/29 +Y55358000 Evonik Industries AG--婉莘
'      'Modified by Morgan 2021/5/27 +Y45814010,Y33268010 BASF(110/6/1以後請款適用)--婉莘,劉興杰
'      stSQL = stSQL & " and (instr('Y53983000,Y54678000,Y55001000,Y55311000,Y53825000,Y55358000',a1k28)>0 or (a1k02>=1100601 and instr('Y45814010,Y33268010',a1k28)>0))"
'      intR = 1
'      Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
'      If intR = 1 Then
'         iRateLimit = 55
'      Else
'      'end 2020/6/1
'
'         'Modified by Morgan 2019/5/29
'         '改日文35%,英文及德文等40%,取消特殊翻譯人員--婧瑄
'         'stSQL = Pub_GetSpecMan("特殊翻譯人員")
'         'If InStr(stSQL, stCP14) > 0 Then
'         '   iRateLimit = 60
'         'Else
'         '   iRateLimit = 50
'         'End If
'
'         'Modified by Morgan 2019/8/26 統一改 30% --婧瑄
'         'iRateLimit = 35
'         'If pIsPaying Then
'         '   stSQL = "select tf27 from transfee where tf01='" & pDocNo & "' and tf27 is not null"
'         'Else
'         '   stSQL = "select tf27 from caseprogress,transfee where cp60='" & pDocNo & "' and cp10='201' and tf01(+)=cp09 and tf27 is not null"
'         'End If
'         'intR = 1
'         'Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
'         'If intR = 1 Then
'         '   If rsQuery(0) = "2" Then
'         '      iRateLimit = 35
'         '   Else
'         '      iRateLimit = 40
'         '   End If
'         'End If
'         iRateLimit = 30
'         'Added by Morgan 2019/9/27
'         '若申請人或代理人或請款對象為特定的固定報價客戶時比例設 40% --婉莘(外專需求)
'         If pIsPaying Then
'            stSQL = "select cp60 from caseprogress,patent,acc1k0 where cp09='" & pDocNo & "' and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04 and a1k01(+)=cp60"
'         Else
'            stSQL = "select a1k01 from acc1k0,patent where a1k01='" & pDocNo & "' and pa01(+)=a1k13 and pa02(+)=a1k14 and pa03(+)=a1k15 and pa04(+)=a1k16" & _
'               ""
'         End If
'         stSQL = stSQL & " and exists(select * from addressa4list where aal01='FCPxtr' and instr(pa26||pa27||pa28||pa29||pa30||pa75||a1k28,aal04)>0)"
'         intR = 1
'         Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
'         If intR = 1 Then
'            iRateLimit = 40
'         End If
'         'end 2019/9/27
'         'end 2019/8/26
'         'end 2019/5/29
'      End If 'Added by Morgan 2020/6/1
      iRateLimit = PUB_GetTransFeeRate(, , , , stDnNo)
'end 2021/7/29
         
      'Added by Morgan 2019/8/2
      '帳單輸入加判斷若通知信未發則先刪除(有可能輸錯案號)
      If pIsPaying Then
         stSQL = "delete mailcache where mc01='" & strUserNum & "'" & _
            " and mc03=to_char(sysdate,'yyyymmdd') and mc05 is null" & _
            " and instr(mc07,'翻譯費支出金額')>0 and instr(mc08,'(帳單編號:" & pBillNo & ")')>0"
         cnnConnection.Execute stSQL, intR
      End If
      'end 2019/8/2
      'Modified by Morgan 2019/10/9
      'intR = Round(100 * dblPay / dblGet)
      dblRate = Trunc(100 * dblPay / dblGet, 2)
      'end 2019/10/9
      If dblRate >= iRateLimit Then
         stMsg = stCaseNo & "翻譯費支出金額 ( " & Format(dblPay, "#,###") & " ) 佔請款金額 ( " & Format(dblGet, "#,###") & " ) 比例" & dblRate & "%，已達" & iRateLimit & "%(含)以上，"
         'Modified by Morgan 2016/12/1
         'If MsgBox(stMsg & vbCrLf & vbCrLf & "請確認金額是否正確？", vbYesNo + vbExclamation + vbDefaultButton2, "翻譯費請款與支出檢查") = vbNo Then
         'Modified by Morgan 2022/1/13 調整請款的訊息並改為提醒後繼續 --敏莉
         'If MsgBox(stMsg & vbCrLf & vbCrLf & IIf(pIsPaying, "請確認金額是否正確？", "是否已與承辦確認金額正確？"), vbYesNo + vbExclamation + vbDefaultButton2, "翻譯費請款與支出檢查") = vbNo Then
         If pIsPaying Then
            If MsgBox(stMsg & vbCrLf & vbCrLf & "請確認金額是否正確？", vbYesNo + vbExclamation + vbDefaultButton2, "翻譯費請款與支出檢查") = vbNo Then
               PUB_ChkTranslationFee = False
            End If
            
         'Removed by Morgan 2025/4/15 移到下面並增加判斷是否已有相同的通知
         'Else
         '   MsgBox stMsg & vbCrLf & vbCrLf & "將自動發mail通知財務處及承辦確認金額。", vbExclamation, "翻譯費請款與支出檢查"
         End If
         'end 2022/1/13
         
         If PUB_ChkTranslationFee = True Then
            'EMail給承辦人
            If pIsPaying Then
               'Modified by Morgan 2019/7/5 --婉莘
               '請款對象為 Y54047 (The Boeing Company) 或 Evonik (Y53983、Y54678、Y55001) 為投標或定契約客戶外專要排除，財務處決定改通知婉莘作後續稽核
               'Modified by Morgan 2019/10/1 固定報價客戶改仍通知承辦但比例設定 40 %
               'If stFaNo = "Y54047000" Or stFaNo = "Y53983000" Or stFaNo = "Y54678000" Or stFaNo = "Y55001000" Then
               '   stTO = "A2008"
               '   stCC = ""
               'Else
                  stTO = stCP13
                  'Added by Morgan 2022/11/24 88003退休暫改CC總經理
                  If strSrvDate(1) >= 20221130 Then
                     stCC = "94007;81040"
                  Else
                  'end 2022/11/24
                     stCC = "88003;81040"
                  End If 'Added by Morgan 2022/11/24
               'End If
               'end 2019/10/1
               
               'Modified by Morgan 2019/5/29 +CC給閻副所及王文安協理--婧瑄
               'Modified by Lydia 2019/07/03 改成mailcache-- 因為婉莘的電腦在Frmacc2152輸入發email後,回到Frmacc2150無法觸發FormActive
               'PUB_SendMail strUserNum, stCP13, "", stMsg & "請確認請款金額是否正確！", "如旨", , , , , , "88003;81040"
               stSQL = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08,mc09)" & _
                  " values('" & strUserNum & "','" & stTO & "',to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss')" & _
                  ",'" & stMsg & "請確認請款金額是否正確！" & "','如旨','" & stCC & "')"
               cnnConnection.Execute stSQL, intR
            'Added by Morgan 2019/5/31
            'EMail給帳單輸入人員
            ElseIf stBMan <> "" Then
               stSubj = stMsg & "請確認帳單金額是否正確！"
               
               'Added by Morgan 2025/4/15 若已通知過相同內容則不再重複(請款單可能會重複修改明細)--敏莉
               stSQL = "select * from mailcache where mc01='" & strUserNum & "' and mc02='" & stBMan & "' and mc07='" & ChgSQL(stSubj) & "'"
               intR = 1
               Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
               If intR = 0 Then
               'end 2025/4/15
               
                  'Modified by Lydia 2019/07/03 改成mailcache
                  'PUB_SendMail strUserNum, stBMan, "", stMsg & "請確認帳單金額是否正確！", "如旨"
                  'Modified by Morgan 2022/1/13 +CC給承辦
                  'Modified by Morgan 2023/2/20 +CC給承辦主管--敏莉
                  stCC = stCP13 & ";" & PUB_GetFCPProSup(stCP13)
                  stSQL = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08,mc09)" & _
                     " values('" & strUserNum & "','" & stBMan & "',to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss')" & _
                     ",'" & ChgSQL(stSubj) & "','如旨','" & stCC & "')"
                  cnnConnection.Execute stSQL, intR
                  
               'Added by Morgan 2025/4/15
                  MsgBox stMsg & vbCrLf & vbCrLf & "將自動發mail通知財務處及承辦確認金額。", vbExclamation, "翻譯費請款與支出檢查"
               End If
               'end 2025/4/15
            End If
         End If
      End If
   End If
   Set rsQuery = Nothing
End Function

'Add By Sindy 2013/6/17
'Modify By Sindy 2015/12/14 + Optional ByRef bolFileExist As Boolean = False
'Modify By Sindy 2020/4/13 + Optional ByVal strSavePath As String = "" : 指定存放範本的位置
Public Function PUB_GetSampleFile(ByVal pFileName As String, ByVal pFileCode As String, _
                                  Optional ByRef bolFileExist As Boolean = False, _
                                  Optional ByVal strSavePath As String = "") As Boolean
   Dim stAttPath As String
   Dim lngSize As Long
   Dim iFileNo As Integer
   Dim bytes() As Byte
   Dim strTmp As String, intA As Integer, rsAD As New ADODB.Recordset 'Added by Lydia 2024/05/15
   
On Error GoTo ErrHnd
   
   PUB_GetSampleFile = False
   'Add By Sindy 2020/4/13
   If strSavePath <> "" Then
      If Right(Trim(strSavePath), 1) <> "\" Then 'Modify By Sindy 2021/6/21
         stAttPath = strSavePath & "\" & pFileName
      Else
         stAttPath = strSavePath & pFileName
      End If
   Else
   '2020/4/13 END
      stAttPath = App.path & "\" & pFileName
   End If
   '檔案已存在時刪除再重新下載
   If Dir(stAttPath) <> "" Then
      Kill stAttPath
      'PUB_GetSampleFile = True
      'Exit Function
   End If
   
   strTmp = "select * from ImgByteFile where ibf01=" & CNULL(SystemNumber(pFileCode, 1)) & _
               " and ibf02=" & CNULL(SystemNumber(pFileCode, 2)) & _
               " and ibf03=" & CNULL(SystemNumber(pFileCode, 3)) & _
               " and ibf04=" & CNULL(SystemNumber(pFileCode, 4))
   intA = 1
   Set rsAD = ClsLawReadRstMsg(intA, strTmp)
   If intA = 1 Then
      'Add By Sindy 2017/8/10
'      If "" & rsad.Fields("IBF15") <> "" Then
         PUB_GetSampleFile = PUB_GetFtpFile(rsAD.Fields("IBF15"), stAttPath, UCase("ImgByteFile"))
'      Else
'      '2017/8/10 END
'         With rsad
'            lngSize = Val(.Fields("ibf13").Value)
'            ReDim bytes(lngSize)
'            If lngSize > 0 Then bytes() = .Fields("ibf14").GetChunk(lngSize)
'         End With
'         iFileNo = FreeFile
'         Open stAttPath For Binary Access Write As #iFileNo
'         If lngSize > 0 Then Put #iFileNo, , bytes()
'         Close #iFileNo
'         'pFileName = stAttPath
'         PUB_GetSampleFile = True
'      End If
   End If
   
   Set rsAD = Nothing 'Added by Lydia 2024/05/15
   Exit Function
   
ErrHnd:
   MsgBox Err.Description, vbCritical
   If Err.Number = 70 Then bolFileExist = True 'Add By Sindy 2015/12/14
   If iFileNo > 0 Then Close #iFileNo
End Function

'Add by Amy 2015/11/11 取代工業區
Public Function ReplaceIndArea(stAddr As String, Optional ByRef stBackWord As String = "") As String
    Dim oldAddr As String
    
    'Memo by Amy 2015/11/24 不加 臺中工業區 因會抓錯zip (ex:台中市台中工業區６路５號 會抓成６路一街的zip)
    'Memo by Amy 2015/11/24 不加 台塑工業園區->路名(ex:雲林縣麥寮鄉台塑工業園區１之１號)
    
    ReplaceIndArea = stAddr
    
    If stBackWord <> MsgText(601) Then oldAddr = stAddr
    ReplaceIndArea = Replace(ReplaceIndArea, "大武崙工業區", "") '基隆市安樂區
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "大武崙工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "龍德工業區", "") '宜蘭縣蘇澳鎮
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "龍德工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "瑞芳工業區", "") '郵局資料-xx路瑞芳工業區
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "瑞芳工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "新北產業園區", "")
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "新北產業園區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "土城工業區", "")
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "土城工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "樹林工業區", "") '新北市樹林區
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "樹林工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "林口第二工業區", "") '林口工二工業區不需截(郵局路名:林口工二工業區工三路)
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "林口第二工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "林口工三工業區", "")
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "林口工三工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "華亞科技園區", "") '桃園縣龜山鄉
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "林口工三工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "觀音工業區", "") '桃園市觀音區
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "觀音工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "大園工業區", "") '桃園市大園區
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "大園工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "平鎮工業區", "") '桃園市平鎮區
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "平鎮工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "幼獅工業區", "") '桃園市楊梅區/臺中市大甲區
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "幼獅工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "中壢工業區", "") '桃園縣中壢市
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "中壢工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "湖口工業區", "") '新竹縣湖口鄉
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "湖口工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "竹南工業區", "") '苗栗縣
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "竹南工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "銅鑼工業區", "") '苗栗縣
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "銅鑼工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "大里工業區", "") '臺中市太平區
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "大里工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "梧棲工業區", "") '臺中市梧棲區
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "梧棲工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "大新工業區", "") '彰化縣田中鎮
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "大新工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "彰濱工業區", "") '彰化縣鹿港鎮/線西鄉
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "彰濱工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "全興工業區", "") '彰化縣伸港鄉
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "全興工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "福興工業區", "") '彰化縣福興鄉
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "福興工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "竹山工業區", "") '南投縣竹山鎮
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "竹山工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "南崗工業區", "") '南投縣南投市
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "南崗工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "南崗擴大工業區", "") '南投縣南投市
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "南崗擴大工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "豐田工業區", "") '雲林縣大埤鄉
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "豐田工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "斗六工業區", "") '雲林縣斗六市
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "斗六工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "朴子工業區", "") '嘉義縣朴子市
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "朴子工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "義竹工業區", "") '嘉義縣義竹鄉
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "義竹工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "民雄工業區", "") '嘉義縣民雄鄉
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "民雄工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "頭橋工業區", "") '嘉義縣民雄鄉
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "頭橋工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "嘉太工業區", "") '嘉義縣太保市
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "嘉太工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "保安工業區", "") '臺南市仁德區
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "保安工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "永康工業區", "") '臺南市永康區
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "永康工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "安平工業區", "") '臺南市南區
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "安平工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "官田工業區", "") '臺南市官田區
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "官田工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "邱永漢工業區區", "") '臺南市新市區
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "邱永漢工業區區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "科學工業區南科", "") '臺南市善化區
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "科學工業區南科": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "和順工業區", "") '臺南市
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "和順工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "新營工業區", "") '臺南市新營區
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "新營工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "灣裡工業區", "") '臺南市
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "灣裡工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "大發工業區", "") '高雄市大寮區
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "大發工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "萬大工業區", "") '高雄市大寮區
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "萬大工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "臨海工業區", "") '高雄市小港區
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "臨海工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "本洲工業區", "") '高雄市岡山區
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "本洲工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "屏東工業區", "") '屏東縣屏東市
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "屏東工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "內埔工業區", "") '屏東縣內埔鄉
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "內埔工業區": Exit Function

    '若地址內有五股工業區、五股工業園區、龜山工業區、龜山工業園區者先把該字樣取消
    ReplaceIndArea = Replace(ReplaceIndArea, "五股工業區", "")
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "五股工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "五股工業園區", "")
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "五股工業園區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "龜山工業區", "")
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "龜山工業區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "龜山工業園區", "")
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "龜山工業園區": Exit Function
    '若地址有新竹市科學工業園區、新竹市科學園區者先把該字樣換成新竹市
    ReplaceIndArea = Replace(ReplaceIndArea, "新竹市科學工業園區", "新竹市")
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "科學工業園區": Exit Function
    ReplaceIndArea = Replace(ReplaceIndArea, "新竹市科學園區", "新竹市")
    If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "科學園區": Exit Function
    '若地址有新竹科學工業園區、新竹科學園區者，先檢查是否有’市’或’縣’，若有，則取消新竹科學工業園區、新竹科學園區字樣
    '若無，則只以’新竹’+取消科學工業園區、科學園區字樣的地址抓SUB(PZD02,1,2)來比對
    If InStr(ReplaceIndArea, "新竹科學工業園區") > 0 Then
        If InStr(ReplaceIndArea, "市") > 0 Or InStr(ReplaceIndArea, "縣") > 0 Then
            ReplaceIndArea = Replace(ReplaceIndArea, "新竹科學工業園區", "")
            If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "新竹科學工業園區": Exit Function
        Else
            ReplaceIndArea = Replace(ReplaceIndArea, "科學工業園區", "")
            If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "科學工業園區": Exit Function
        End If
    End If
    If InStr(ReplaceIndArea, "新竹科學園區") > 0 Then
        If InStr(ReplaceIndArea, "市") > 0 Or InStr(ReplaceIndArea, "縣") > 0 Then
            ReplaceIndArea = Replace(ReplaceIndArea, "新竹科學園區", "")
            If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "新竹科學園區": Exit Function
        Else
            ReplaceIndArea = Replace(ReplaceIndArea, "科學園區", "")
            If stBackWord <> MsgText(601) Then If ReplaceIndArea <> oldAddr Then stBackWord = "科學園區": Exit Function
        End If
    End If
    
End Function

'Add by Amy 2015/12/02 臺灣地址查詢郵遞區號
'intChoose:1-前6、5碼查 / 2-段、路、街、巷
Public Function GetZipCode_Tai(intChoose As Integer, ByRef stAddr As String, Optional ByRef intGet As Integer = 0, Optional ByRef bolMany As Boolean = False, Optional ByRef stNewAera As String = "", Optional ByRef stCountryCode As String = "") As String
    stAddr = ReplaceAddrTW(stAddr)
    '以地址前6、5碼查
    If intChoose = 1 Then
        GetZipCode_Tai = GetPostZip(Left(stAddr, 6), 6, , stCountryCode, bolMany)
        If GetZipCode_Tai = MsgText(601) Then GetZipCode_Tai = GetPostZip(Left(stAddr, 5), 5, , stCountryCode, bolMany)
        Exit Function
    End If
    '以 路/街名查
    If intChoose = 2 Or intChoose = 3 Then
        stNewAera = "Pzd03"
        If InStr(stAddr, "段") > 0 Then
            If IsNumeric(Left(ReplaceTWNo(Mid(stAddr, InStr(stAddr, "段") - 1, 2)), 1)) = True Then
                If intChoose = 2 Then
                    GetZipCode_Tai = GetPostZip(Left(ReplaceTWNo(stAddr), InStr(stAddr, "段")), InStr(stAddr, "段"), , stCountryCode, bolMany, "pzd02||pzd04", stNewAera)
                Else
                    GetZipCode_Tai = GetPostZip(Left(ReplaceTWNo(stAddr), InStr(stAddr, "段")), InStr(stAddr, "段"), , stCountryCode, bolMany, "pzd02||pzd03||pzd04", stNewAera)
                End If
                intGet = InStr(stAddr, "段")
                If GetZipCode_Tai <> MsgText(601) Then Exit Function
            End If
        End If
        If InStr(stAddr, "路") > 0 Then
            If intChoose = 2 Then
                GetZipCode_Tai = GetPostZip(Left(ReplaceTWNo(stAddr), InStr(stAddr, "路")), InStr(stAddr, "路"), , stCountryCode, bolMany, "pzd02||pzd04", stNewAera)
            Else
                GetZipCode_Tai = GetPostZip(Left(ReplaceTWNo(stAddr), InStr(stAddr, "路")), InStr(stAddr, "路"), , stCountryCode, bolMany, "pzd02||pzd04", stNewAera)
            End If
            If GetZipCode_Tai = MsgText(601) Then GetZipCode_Tai = GetPostZip(Left(ReplaceTWNo(stAddr), InStr(stAddr, "路")), InStr(stAddr, "路"), , stCountryCode, bolMany, "pzd02||pzd03||pzd04", stNewAera)
            intGet = InStr(stAddr, "路")
            If GetZipCode_Tai <> MsgText(601) Then Exit Function
        End If
        If InStr(stAddr, "街") > 0 Then
            If intChoose = 2 Then
                GetZipCode_Tai = GetPostZip(Left(ReplaceTWNo(stAddr), InStr(stAddr, "街")), InStr(stAddr, "街"), , stCountryCode, bolMany, "pzd02||pzd04", stNewAera)
            Else
                GetZipCode_Tai = GetPostZip(Left(ReplaceTWNo(stAddr), InStr(stAddr, "街")), InStr(stAddr, "街"), , stCountryCode, bolMany, "pzd02||pzd04", stNewAera)
            End If
            If GetZipCode_Tai = MsgText(601) Then GetZipCode_Tai = GetPostZip(Left(ReplaceTWNo(stAddr), InStr(stAddr, "街")), InStr(stAddr, "街"), , stCountryCode, bolMany, "pzd02||pzd03||pzd04", stNewAera)
            intGet = InStr(stAddr, "街")
            If GetZipCode_Tai <> MsgText(601) Then Exit Function
        End If
         If InStr(stAddr, "巷") > 0 Then
            If intChoose = 2 Then
                GetZipCode_Tai = GetPostZip(Left(ReplaceTWNo(stAddr), InStr(stAddr, "巷")), InStr(stAddr, "巷"), , stCountryCode, bolMany, "pzd02||pzd04", stNewAera)
            Else
                GetZipCode_Tai = GetPostZip(Left(ReplaceTWNo(stAddr), InStr(stAddr, "巷")), InStr(stAddr, "巷"), , stCountryCode, bolMany, "pzd02||pzd04", stNewAera)
            End If
            If GetZipCode_Tai = MsgText(601) Then GetZipCode_Tai = GetPostZip(Left(ReplaceTWNo(stAddr), InStr(stAddr, "巷")), InStr(stAddr, "巷"), , stCountryCode, bolMany, "pzd02||pzd03||pzd04", stNewAera)
            intGet = InStr(stAddr, "巷")
            If GetZipCode_Tai <> MsgText(601) Then Exit Function
        End If
    End If
End Function

'抓取A0b01(會計過帳日)/A0b05(業績輸入關閉年月)
'Modify by Amy 2016/02/23 +stComp
Public Function GetA0b01(ByRef stA0b05 As String, Optional ByVal stComp As String = "") As String
    Dim rsTmp As New ADODB.Recordset
    Dim strSql As String
    
    If stComp <> MsgText(601) Then strSql = strSql & "Where a0b04='" & stComp & "' "
    
    strSql = "Select * From Acc0b0 " & strSql
    rsTmp.CursorLocation = adUseClient
    rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
    If rsTmp.RecordCount > 0 Then
        GetA0b01 = "" & rsTmp.Fields("A0b01")
        stA0b05 = "" & rsTmp.Fields("A0b05")
    End If
    rsTmp.Close
    Set rsTmp = Nothing
End Function

'帶人主管所帶的人員List
'Modify by Amy 2025/05/06 +intGet:1-全部 / 2-只抓st52 / 3-只抓st53 / 4-只抓st54 / 5-只抓st55
Public Function GetST52List(ByVal stNo As String, Optional ByVal intGet As Integer = 1) As String
    Dim Rs As New ADODB.Recordset
    Dim strQ As String
    Dim strQ_F As String, i As Integer, intS As Integer, intE As Integer 'Add by Amy 2025/05/06
    
    GetST52List = ""
    If intGet = 1 Then
      intS = 2
      intE = 5
    Else
      intS = intGet
      intE = intGet
    End If
   
   'Modify by Amy 2025/05/06
'    strQ = "Select * From (" & _
'    "Select st01 From Staff Where st52='" & stNo & "' And st01>'6' And SubStr(st01,1,1)<'F' And SubStr(st01,4,1)<>'9' " & _
'    "Union Select st01 From Staff Where st53='" & stNo & "' And st01>'6' And SubStr(st01,1,1)<'F' And SubStr(st01,4,1)<>'9' " & _
'    "Union Select st01 From Staff Where st54='" & stNo & "' And st01>'6' And SubStr(st01,1,1)<'F' And SubStr(st01,4,1)<>'9'  " & _
'    "Union Select st01 From Staff Where st55='" & stNo & "' And st01>'6' And SubStr(st01,1,1)<'F' And SubStr(st01,4,1)<>'9' " & _
'              ") Order by st01"
              
   strQ_F = "Select st01 From Staff Where ST5X='" & stNo & "' And st01>'6' And SubStr(st01,1,1)<'F' And SubStr(st01,4,1)<>'9' "
   For i = intS To intE
      If intGet = 1 And i > 2 Then
         strQ = strQ & " Union "
      End If
      strQ = strQ & Replace(strQ_F, "ST5X", "ST5" & i)
   Next i
   If intGet = 1 Then
      strQ = "Select * From (" & strQ & ") Order by st01"
   End If
   
   Rs.CursorLocation = adUseClient
   Rs.Open strQ, cnnConnection, adOpenStatic, adLockReadOnly
   If Rs.RecordCount > 0 Then
      Do While Not Rs.EOF
         GetST52List = GetST52List & ",'" & Rs.Fields("st01") & "'"
         Rs.MoveNext
      Loop
      GetST52List = Mid(GetST52List, 2)
   End If
   Rs.Close
End Function

'依部門代號取得區主管人員
'Modify by Amy 2021/11/11
'intChoose:0-抓a0908 / 1-先抓a0918 再抓a0908 / 2-抓a0924
Public Function GetDeptMan(ByVal stA0901 As String, Optional ByVal intChoose As Integer = 0) As String
    Dim Rs As New ADODB.Recordset
    Dim intQ As Integer, stQ As String
    Dim stField As String 'Add by Amy 2023/12/20
    
    'Modify by Amy 2021/11/11 +intChoose
    GetDeptMan = ""
    stField = "a0908 "
    
    'Modify by Amy 2024/01/04 +新部門
    If intChoose = 2 Then
      stQ = "Select a0924 as a0908 From Acc090New Where a0921='" & stA0901 & "'"
    Else
      If intChoose = 1 Then stField = "Nvl(a0918,a0908) "
      stQ = "Select " & stField & " as a0908 From Acc090 Where a0901='" & stA0901 & "'"
    End If
    
    intQ = 1
    Set Rs = ClsLawReadRstMsg(intQ, stQ)
    If intQ = 1 Then
        GetDeptMan = "" & Rs.Fields(0) 'Modify by Amy 2016/11/14 解null會錯
    End If
    Set Rs = Nothing
End Function
'end 2016/01/12

'Add by Amy 2016/01/14 依員編取得區主管管理區別List
'Modify by Amy 2021/07/08 +stWhere 限制登入部門 ex:文雄可能為北四區或顧問服務組
'Modify by Amy 2021/07/08 +stBackVal:回傳欄位 / +intChoose:1-F編號 st14/2-特殊/3-一般
Public Function GetDeptList(intChoose As Integer, ByVal stA0908 As String, Optional ByVal stWhere As String = "", Optional ByRef stBackVal As String = "") As String
    Dim Rs As New ADODB.Recordset, stQ As String, intQ As Integer
    'Add by Amy 2021/07/08
    Dim i As Integer, bolBackVal As Boolean, stAllFNo As String, stField As String
    Dim arrTmp

    'Mark by Amy 2021/07/08 改變數名stA0901->stWhere
    'If stA0901 <> MsgText(601) Then stQ = " And a0901='" & stA0901 & "' " 'Add by Amy 2019/10/24

    'Modify by Amy 2021/07/08 +intChoose及stBackVal
    If stBackVal <> MsgText(601) Then
        bolBackVal = True
        stField = "," & stBackVal
        stBackVal = ""
    End If
    'Modify by Amy 2021/07/08 改stWhere變數名
    If intChoose = 1 Then
        '取得F編號
        arrTmp = Split(智權點數實績與結餘特殊員編, ";")
        For i = LBound(arrTmp) To UBound(arrTmp)
            If Left(arrTmp(i), 1) = "F" Then
                stAllFNo = stAllFNo & "," & arrTmp(i)
            End If
        Next
        If stAllFNo <> MsgText(601) Then stAllFNo = Mid(stAllFNo, 2)
        '取得 st14 部門
        stQ = "Select Distinct a0901" & stField & " From Staff,Acc090 Where st14='" & stA0908 & "' " & stWhere & _
                 "And st01 in('" & Replace(stAllFNo, ",", "','") & "') And st15=a0901(+) "
    ElseIf intChoose = 2 Then
        '登入人員為特殊輸入員編之區主管
        stQ = "Select Distinct a0901 From Staff,Acc090 Where a0908='" & stA0908 & "' " & stWhere & _
                 "And st01 in ('" & Replace(智權點數實績與結餘特殊員編, ";", "','") & "') And st15=a0901(+)"
    'intChoose=3.一般
    Else
        'Modify by Amy 2021/10/07 +智權點數實績與結餘輸入部門
        stQ = "Select a0901 From Acc090 Where a0908='" & stA0908 & "' And SubStr(a0901,1,1) in('" & Replace(智權點數實績與結餘輸入部門, ",", "','") & "') " & stWhere
    End If
    'end 2021/07/08
    'Add by Amy 2025/08/04 以部門排序,智權部排前面-秀玲
    stQ = stQ & " Order by Decode(Substr(a0901,1,1),'S',2,1) ,a0901 Desc"
    intQ = 1
    Set Rs = ClsLawReadRstMsg(intQ, stQ)
    If intQ = 1 Then
        Rs.MoveFirst
        Do While Not Rs.EOF
            GetDeptList = GetDeptList & ",'" & Rs.Fields(0) & "'"
            'Add by Amy 2021/07/08 回傳欄位
            If bolBackVal = True Then
                stBackVal = stBackVal & ",'" & Rs.Fields(1) & "'"
            End If
            Rs.MoveNext
        Loop
        If GetDeptList <> MsgText(601) Then GetDeptList = Mid(GetDeptList, 2)
        If stBackVal <> MsgText(601) Then stBackVal = Mid(stBackVal, 2) 'Add by Amy 2021/07/08
    End If
    Set Rs = Nothing
End Function

'Add By Sindy 2015/12/10 從Frmacc44t0搬至此處,變共用func : 以收據抬頭抓客戶資料
'Modify By Sindy 2016/11/17 + Optional ByRef m_CU168 As String 每月提醒代填繳款書 Y.提醒
'Modify By Sindy 2016/12/1 + , Optional ByRef m_CU169 As String, Optional ByRef m_CU170 As String, _
   Optional ByRef m_CU171 As String, Optional ByRef m_CU11 As String
'Modify By Sindy 2017/3/10 + Optional ByRef m_CU58 As String 聯絡人1
'Modify By Sindy 2017/3/16 + Optional ByRef m_CU172 As String 不寄發扣繳核對資料
'Modify By Sindy 2017/3/24 + Optional ByRef m_CU173 As String 收據是否列印統一編號
'Modify By Sindy 2018/1/15 過濾掉CU13業務人員是離職的資料
'Modify By Sindy 2018/1/16 + Optional ByRef m_ManyRowCUid As String 回傳多筆ID
'Modify By Sindy 2018/1/9 + Optional ByRef m_CU13Id As String 智權人員ID
'Modify By Sindy 2019/12/18 + Optional ByRef m_CU181 As String 繳款書代填方式:1.每筆代繳2.單筆收據稅額超過2000元
'Modify by Amy 2023/05/22 +Optional ByVal stFormN As String
Public Function GetTitleCustData(ByVal strTitleNm As String, ByVal strCustNo As String, ByVal strA0K01 As String, _
   Optional ByRef m_CU01 As String, Optional ByRef m_CU02 As String, Optional ByRef m_CU15 As String, _
   Optional ByRef m_CU115 As String, Optional ByRef m_CU20 As String, Optional ByRef m_CU116 As String, _
   Optional ByRef m_CU117 As String, Optional ByRef m_CU118 As String, Optional ByRef m_CU16 As String, _
   Optional ByRef m_CU18 As String, Optional ByRef m_CU04 As String, Optional ByRef m_CU158 As String, _
   Optional ByRef m_CU22 As String, Optional ByRef m_CU80 As String, Optional ByRef m_CU30 As String, _
   Optional ByRef m_CU31 As String, Optional ByRef m_CU159 As String, Optional ByRef m_CU12 As String, _
   Optional ByRef m_CU13 As String, Optional ByVal bolQuyCustTitle As Boolean = True, _
   Optional ByRef m_CU168 As String, Optional ByRef m_CU169 As String, Optional ByRef m_CU170 As String, _
   Optional ByRef m_CU171 As String, Optional ByRef m_CU11 As String, Optional ByRef m_CU58 As String, _
   Optional ByRef m_CU172 As String, Optional ByRef m_CU173 As String, Optional ByRef m_ManyRowCUid As String, _
   Optional ByRef m_CU13Id As String, Optional ByRef m_CU181 As String, Optional ByVal stFormN As String) As Boolean
   
Dim adoquery As New ADODB.Recordset
Dim Rs As New ADODB.Recordset
Dim ii As Integer, k As Integer
Dim strSqlcu As String, strSqlfa As String, strOldTitleNm As String
Dim bolTitleAndNo As Boolean, bolNo As Boolean 'Add by Amy 2023/05/22 Run抬頭+編號/Run 編號
Dim strTmp As String, intA As Integer, rsAD As New ADODB.Recordset 'Added by Lydia 2024/05/15

   GetTitleCustData = False
   m_ManyRowCUid = "" 'Add By Sindy 2018/1/16
   m_CU01 = "": m_CU02 = ""
   m_CU15 = "": m_CU115 = "": m_CU20 = "": m_CU116 = "": m_CU117 = ""
   m_CU118 = "": m_CU16 = "": m_CU18 = ""
   m_CU04 = "" 'Add By Sindy 2015/2/17
   m_CU158 = "" 'Add By Sindy 2015/12/10
   m_CU22 = "": m_CU80 = "": m_CU30 = ""
   m_CU31 = "": m_CU159 = "": m_CU12 = ""
   m_CU13 = "": m_CU13Id = ""
   strOldTitleNm = "" 'Add By Sindy 2016/1/28
   m_CU168 = "" 'Add By Sindy 2016/11/17
   m_CU181 = "" 'Add By Sindy 2019/12/18
   'Add By Sindy 2016/12/1
   m_CU169 = "": m_CU170 = "": m_CU171 = "": m_CU11 = ""
   '2016/12/1 END
   m_CU58 = "" 'Add By Sindy 2017/3/10
   m_CU172 = "" 'Add By Sindy 2017/3/16
   m_CU173 = "" 'Add By Sindy 2017/3/24
   
   'Add by Amy 2023/05/22
   bolTitleAndNo = True: bolNo = True
   Select Case UCase(stFormN)
      Case "FRMACC11T0", "FRMACC1440"
        If bolQuyCustTitle = False Then
            bolNo = False
        End If
      
   End Select
   'end 2023/05/22
   
   strTitleNm = Trim(ChgSQL(strTitleNm)) 'Add By Sindy 2016/12/19
   
   'Add By Sindy 2015/12/10
   If strA0K01 <> "" Then
      strTmp = "select a0k03,a0k04 from acc0k0 where a0k01='" & strA0K01 & "'" & _
                  " union " & _
                  "select a1k03 a0k03,a1k35 a0k04 from acc1k0 where a1k01='" & strA0K01 & "'"
      intA = 1
      Set adoquery = ClsLawReadRstMsg(intA, strTmp)
      If intA = 1 Then
         strTitleNm = Trim(adoquery.Fields("a0k04"))
         strCustNo = adoquery.Fields("a0k03")
      End If
   End If
   '2015/12/10 END
   
   '先以收據抬頭抓客戶檔
   'Modify By Sindy 2015/6/30 取消 CU158.境外公司 的控制
   'Modify By Sindy 2015/12/10 + cu158
'   strtmp = "select cu115,cu01,cu02,cu20,cu116,cu117,cu118,nvl(cu16,cu22) cu16,cu18,DECODE(CU15,'0','台端','1','貴公司','貴單位') cu15,nvl(cu04,nvl(cu05||' '||cu88||' '||cu89||' '||cu90,cu06)) cu04,cu158" & _
'               " from (select min(cu01||cu02) CUID from customer where ('" & strTitleNm & "'=cu04 or '" & strTitleNm & "'=cu05||' '||cu88||' '||cu89||' '||cu90 or '" & strTitleNm & "'=cu06) and cu02='0') Y,customer,staff,acc090" & _
'               " where substr(Y.CUID,1,8)=cu01(+) and substr(Y.CUID,9,1)=cu02(+) and Y.CUID is not null" & _
'               " and cu13=st01(+) and cu12=a0901(+)"
   'Modify By Sindy 2016/1/7 用收據抬頭抓資料時,只抓到1筆才使用
   If bolQuyCustTitle = True Then '只用收據抬頭抓資料
      For ii = 1 To 3
         If ii = 1 Then
            strSqlcu = "'" & strTitleNm & "'=rtrim(ltrim(cu04))"
            strSqlfa = "'" & strTitleNm & "'=rtrim(ltrim(fa04))"
         ElseIf ii = 2 Then
            strSqlcu = "'" & strTitleNm & "'=rtrim(ltrim(cu05||' '||cu88||' '||cu89||' '||cu90))"
            strSqlfa = "'" & strTitleNm & "'=rtrim(ltrim(fa05||' '||fa63||' '||fa64||' '||fa65))"
         ElseIf ii = 3 Then
            strSqlcu = "'" & strTitleNm & "'=rtrim(ltrim(cu06))"
            strSqlfa = "'" & strTitleNm & "'=rtrim(ltrim(fa06))"
         End If
         For k = 1 To 2
            If k = 1 Then
               'Modify By Sindy 2018/1/15 過濾掉CU13業務人員是離職的資料
               'Modify By Sindy 2018/1/23 不過濾掉CU13業務人員是離職的資料,但先抓在職者資料
               'Modify By Sindy 2022/9/8 + or cu80='國內同業' or cu80='解除對造'
               'Modify By Sindy 2023/2/24 針對客戶狀態CU80的控制要再加不得代理專利、不得代理商標。
               'Modify By Sindy 2025/1/23 +設為對造 or cu80='設為對造'
               'Modify By Sindy 2025/6/27 +or cu80='其他' or cu80='業務自行處理' or cu80='國內同業' or cu80='解除對造' or cu80='不得代理專利' or cu80='不得代理商標' or cu80='設為對造'
               '                          改抓常變數
               strTmp = "select cu115,cu01,cu02,cu20,cu116,cu117," & _
                           "cu118,nvl(cu16,nvl(cu17,cu22)) cu16,cu18,DECODE(CU15,'0','台端','1','貴公司','貴單位') cu15," & _
                           "nvl(cu04,nvl(cu05||' '||cu88||' '||cu89||' '||cu90,cu06)) cu04,cu158,st02,a0902,CU22,CU80,CU30,CU31,CU159,CU12,CU13,CU168,CU169,CU170,CU171,CU11" & _
                           ",nvl(cu58,nvl(cu59,cu114||' '||cu60)) as ConMan,cu172,cu173,CU181" & _
                           " from (select cu01||cu02 CUID from customer where " & strSqlcu & " and cu02='0'" & _
                           " and (cu80 is null or instr('" & 客戶及代理人可讀取的狀態 & "',cu80)>0)) Y,customer,staff,acc090" & _
                           " where substr(Y.CUID,1,8)=cu01(+) and substr(Y.CUID,9,1)=cu02(+) and Y.CUID is not null and cu13=st01(+) and cu12=a0901(+)" & _
                           " order by st04 asc,cu01||cu02 asc"
            Else
               'Modify By Sindy 2022/9/8 + or fa69='國內同業' or fa69='解除對造'
               'Modify By Sindy 2023/2/24 針對客戶狀態CU80的控制要再加不得代理專利、不得代理商標。
               'Modify By Sindy 2025/1/23 +設為對造 or fa69='設為對造'
               'Modify By Sindy 2025/6/27 +or fa69='其他' or fa69='業務自行處理' or fa69='國內同業' or fa69='解除對造' or fa69='不得代理專利' or fa69='不得代理商標' or fa69='設為對造'
               '                          改抓常變數
               strTmp = "select fa79 cu115,fa01 cu01,fa02 cu02,fa16 cu20,fa80 cu116,fa81 cu117," & _
                           "fa82 cu118,nvl(fa12,fa13) cu16,fa14 cu18,'貴公司' cu15," & _
                           "nvl(fa04,nvl(fa05||' '||fa63||' '||fa64||' '||fa65,fa06)) cu04,'' cu158,'' st02,'' a0902,'' CU22,fa69 CU80,'' CU30,'' CU31,fa118 CU159,'' CU12,'' CU13,'' CU168,'' CU169,'' CU170,'' CU171,'' CU11" & _
                           ",nvl(fa07,nvl(fa08,fa78||' '||fa09)) as ConMan,'' cu172,'' cu173,'' CU181" & _
                           " from (select fa01||fa02 CUID from fagent where " & strSqlfa & " and fa02='0'" & _
                           " and (fa69 is null or instr('" & 客戶及代理人可讀取的狀態 & "',fa69)>0)) Y,fagent" & _
                           " where substr(Y.CUID,1,8)=fa01(+) and substr(Y.CUID,9,1)=fa02(+) and Y.CUID is not null" & _
                           " order by fa01||fa02 asc"
            End If
            '2016/1/7 END
            intA = 1
            Set adoquery = ClsLawReadRstMsg(intA, strTmp)
            'Modify By Sindy 2018/1/4 + Or bolCanManyRow = True : 多筆資料一樣取得資料
            'If inta = 1 And (adoquery.RecordCount = 1 Or bolCanManyRow = True) Then
            If intA = 1 Then 'Modify By Sindy 2018/1/5 多筆一樣要抓值
               adoquery.MoveFirst 'Add By Sindy 2018/1/16
               'Modify By Sindy 2019/5/22 個人且名稱小於等於三個字的，用客戶編號抓客戶資料
               'Modify By Sindy 2019/11/5 不管長度
               'If adoquery.Fields("cu15") = "台端" And Len(strTitleNm) <= 3 Then
               If adoquery.Fields("cu15") = "台端" Then
                  'GoTo gotoExit
                  'Modify By Sindy 2019/11/5 增加判斷個人在台一系統裡只有一筆時,就可直接讀取資料(因個人容易同名)
                  If adoquery.RecordCount = 1 Then
                     strTmp = "select a4201" & _
                                 " from acc420" & _
                                 " where '" & strTitleNm & "'=rtrim(ltrim(a4201))"
                     intA = 1
                     Set Rs = ClsLawReadRstMsg(intA, strTmp)
                     If intA = 1 Then
                        GoTo gotoExit
                     End If
                  Else
                     GoTo gotoExit
                  End If
                  '2019/11/5 END
               End If
               '2019/5/22 END
               m_CU01 = "" & adoquery.Fields("cu01")
               m_CU02 = "" & adoquery.Fields("cu02")
               m_CU15 = "" & adoquery.Fields("cu15")
               m_CU115 = "" & adoquery.Fields("cu115")
               m_CU20 = "" & adoquery.Fields("cu20")
               m_CU116 = "" & adoquery.Fields("cu116")
               m_CU117 = "" & adoquery.Fields("cu117")
               m_CU118 = "" & adoquery.Fields("cu118")
               m_CU16 = "" & adoquery.Fields("cu16")
               m_CU18 = "" & adoquery.Fields("cu18")
               m_CU04 = "" & adoquery.Fields("cu04") 'Add By Sindy 2015/2/17
               m_CU158 = "" & adoquery.Fields("cu158") 'Add By Sindy 2015/12/10
               'Add By Sindy 2016/1/8
               m_CU22 = "" & adoquery.Fields("CU22")
               m_CU80 = "" & adoquery.Fields("CU80")
               m_CU30 = "" & adoquery.Fields("cu30")
               m_CU31 = "" & adoquery.Fields("CU31")
               m_CU159 = "" & adoquery.Fields("CU159")
               m_CU12 = "" & adoquery.Fields("a0902")
               m_CU13 = "" & adoquery.Fields("st02")
               m_CU13Id = "" & adoquery.Fields("cu13") 'Add By Sindy 2018/1/9
               '2016/1/8 END
               m_CU168 = "" & adoquery.Fields("CU168") 'Add By Sindy 2016/11/17
               m_CU181 = "" & adoquery.Fields("CU181") 'Add By Sindy 2019/12/18
               'Add By Sindy 2016/12/1
               m_CU169 = IIf("" & adoquery.Fields("CU169") = "1", "C", "" & adoquery.Fields("CU169"))
               If m_CU169 = "C" Then '客戶
                  m_CU170 = IIf(InStr(m_CU31, m_CU30) > 0, m_CU31, m_CU30 & m_CU31)
                  m_CU171 = strTitleNm
               ElseIf m_CU169 = "3" Then '特殊
                  m_CU170 = "" & adoquery.Fields("CU170")
                  m_CU171 = "" & adoquery.Fields("CU171")
               End If
               m_CU11 = "" & adoquery.Fields("CU11")
               '2016/12/1 END
               m_CU58 = "" & adoquery.Fields("ConMan") 'Add By Sindy 2017/3/10
               m_CU172 = "" & adoquery.Fields("CU172") 'Add By Sindy 2017/3/16
               m_CU173 = "" & adoquery.Fields("CU173") 'Add By Sindy 2017/3/24
               m_ManyRowCUid = "," & m_CU01 & m_CU02 'Add By Sindy 2018/1/16
               GetTitleCustData = True
               GoTo ContinueRun
            End If
         Next k
      Next ii
      
      'Add By Sindy 2015/6/9
      '再讀收據抬頭基本資料檔
      'Modify By Sindy 2015/6/30 取消 a4216.境外公司 的控制(and a4216 is null)
      'Modify By Sindy 2015/12/10 + a4216
      'Modify By Sindy 2015/12/10 + a4224
      'Modify By Sindy 2017/3/24 + a4225
      strTmp = "select a4201,a4204,a4205,a4203,a4217,a4206,st02,a4218,DECODE(a4219,'0','台端','1','貴公司','貴單位') a4219,a4216,a0902,a4220,a4221,a4222,a4223,a4202,a4207,a4224,a4225,a4228" & _
                  " from acc420,staff,acc090" & _
                  " where '" & strTitleNm & "'=rtrim(ltrim(a4201)) and a4206=st01(+) and st15=a0901(+)"
      intA = 1
      Set adoquery = ClsLawReadRstMsg(intA, strTmp)
      If intA = 1 Then
         adoquery.MoveFirst 'Add By Sindy 2018/1/16
         'Modify By Sindy 2019/5/22 個人且名稱小於等於三個字的，用客戶編號抓客戶資料
         'Modify By Sindy 2019/11/5 不管長度
         'If adoquery.Fields("a4219") = "台端" And Len(strTitleNm) <= 3 Then
         If adoquery.Fields("a4219") = "台端" Then
            'GoTo gotoExit
            'Modify By Sindy 2019/11/5 增加判斷個人在台一系統裡只有一筆時,就可直接讀取資料(因個人容易同名)
            If adoquery.RecordCount > 1 Then
               GoTo gotoExit
            End If
         End If
         '2019/5/22 END
         m_CU01 = ""
         m_CU02 = ""
         m_CU15 = "" & adoquery.Fields("a4219")
         m_CU115 = "" & adoquery.Fields("a4218")
         m_CU20 = ""
         m_CU116 = ""
         m_CU117 = ""
         m_CU118 = ""
         m_CU16 = "" & adoquery.Fields("a4204")
         m_CU18 = "" & adoquery.Fields("a4205")
         m_CU04 = "" & adoquery.Fields("a4201")
         m_CU158 = "" & adoquery.Fields("a4216") 'Add By Sindy 2015/12/10
         'Add By Sindy 2016/1/8
         m_CU22 = ""
         m_CU80 = ""
         m_CU30 = ""
         m_CU31 = "" & adoquery.Fields("a4203")
         m_CU159 = "" & adoquery.Fields("a4217")
         m_CU12 = "" & adoquery.Fields("a0902")
         m_CU13 = "" & adoquery.Fields("st02")
         m_CU13Id = "" & adoquery.Fields("a4206") 'Add By Sindy 2018/1/9
         '2016/1/8 END
         m_CU168 = "" & adoquery.Fields("a4220") 'Add By Sindy 2016/11/17
         m_CU181 = "" & adoquery.Fields("a4228") 'Add By Sindy 2019/12/18
         'Add By Sindy 2016/12/1
         m_CU169 = IIf("" & adoquery.Fields("a4221") = "1", "T", "" & adoquery.Fields("a4221"))
         If m_CU169 = "T" Then '收據抬頭
            m_CU170 = "" & adoquery.Fields("a4203")
            m_CU171 = strTitleNm
         ElseIf m_CU169 = "3" Then '特殊
            m_CU170 = "" & adoquery.Fields("a4222")
            m_CU171 = "" & adoquery.Fields("a4223")
         End If
         m_CU11 = "" & adoquery.Fields("a4202")
         '2016/12/1 END
         m_CU58 = "" & adoquery.Fields("a4207") 'Add By Sindy 2017/3/10
         m_CU172 = "" & adoquery.Fields("a4224") 'Add By Sindy 2017/3/16
         m_CU173 = "" & adoquery.Fields("a4225") 'Add By Sindy 2017/3/24
         GetTitleCustData = True
         GoTo ContinueRun
      End If
      '2015/6/9 END
      
      'Add By Sindy 2016/1/27 開收據之後,客戶才變更名稱；康立為:X72444001 所以要抓 康霈:X72444
      For ii = 1 To 3
         If ii = 1 Then
            strSqlcu = "'" & strTitleNm & "'=rtrim(ltrim(cu04))"
            strSqlfa = "'" & strTitleNm & "'=rtrim(ltrim(fa04))"
         ElseIf ii = 2 Then
            strSqlcu = "'" & strTitleNm & "'=rtrim(ltrim(cu05||' '||cu88||' '||cu89||' '||cu90))"
            strSqlfa = "'" & strTitleNm & "'=rtrim(ltrim(fa05||' '||fa63||' '||fa64||' '||fa65))"
         ElseIf ii = 3 Then
            strSqlcu = "'" & strTitleNm & "'=rtrim(ltrim(cu06))"
            strSqlfa = "'" & strTitleNm & "'=rtrim(ltrim(fa06))"
         End If
         For k = 1 To 2
            If k = 1 Then
               'Modify By Sindy 2018/1/15 過濾掉CU13業務人員是離職的資料
               'Modify By Sindy 2018/1/23 不過濾掉CU13業務人員是離職的資料,但先抓在職者資料
               'Modify By Sindy 2022/9/8 + or cu80='國內同業' or cu80='解除對造'
               'Modify By Sindy 2023/2/24 針對客戶狀態CU80的控制要再加不得代理專利、不得代理商標。
               'Modify By Sindy 2025/1/23 +設為對造 or cu80='設為對造'
               'Modify By Sindy 2025/6/27 +or cu80='其他' or cu80='業務自行處理' or cu80='國內同業' or cu80='解除對造' or cu80='不得代理專利' or cu80='不得代理商標' or cu80='設為對造'
               '                          改抓常變數
               strTmp = "select cu01||'0'," & IIf(ii = 1, "cu04", IIf(ii = 2, "cu05||' '||cu88||' '||cu89||' '||cu90", "cu06")) & _
                           " from (select cu01||'0' CUID from customer where " & strSqlcu & _
                           " and (cu80 is null or instr('" & 客戶及代理人可讀取的狀態 & "',cu80)>0)) Y,customer,staff,acc090" & _
                           " where substr(Y.CUID,1,8)=cu01(+) and substr(Y.CUID,9,1)=cu02(+) and Y.CUID is not null and cu13=st01(+) and cu12=a0901(+)" & _
                           " order by st04 asc,cu01||cu02 asc"
            Else
               'Modify By Sindy 2022/9/8 + or fa69='國內同業' or fa69='解除對造'
               'Modify By Sindy 2023/2/24 針對客戶狀態CU80的控制要再加不得代理專利、不得代理商標。
               'Modify By Sindy 2025/1/23 +設為對造 or fa69='設為對造'
               'Modify By Sindy 2025/6/27 +or fa69='其他' or fa69='業務自行處理' or fa69='國內同業' or fa69='解除對造' or fa69='不得代理專利' or fa69='不得代理商標' or fa69='設為對造'
               '                          改抓常變數
               strTmp = "select fa01||'0'," & IIf(ii = 1, "fa04", IIf(ii = 2, "fa05||' '||fa63||' '||fa64||' '||fa65", "fa06")) & _
                           " from (select fa01||'0' CUID from fagent where " & strSqlfa & _
                           " and (fa69 is null or instr('" & 客戶及代理人可讀取的狀態 & "',fa69)>0)) Y,fagent" & _
                           " where substr(Y.CUID,1,8)=fa01(+) and substr(Y.CUID,9,1)=fa02(+) and Y.CUID is not null" & _
                           " order by fa01||fa02 asc"
            End If
            intA = 1
            Set adoquery = ClsLawReadRstMsg(intA, strTmp)
            'Modify By Sindy 2018/1/4 + Or bolCanManyRow = True : 多筆資料一樣取得資料
            'If inta = 1 And (adoquery.RecordCount = 1 Or bolCanManyRow = True) Then
            If intA = 1 Then 'Modify By Sindy 2018/1/5 多筆一樣要抓值
               strOldTitleNm = strTitleNm '*** 先記錄原收據抬頭
               strCustNo = adoquery.Fields(0)
               strTitleNm = Trim(adoquery.Fields(1)) '***
               GoTo gotoExit
            End If
         Next k
      Next ii
      '2016/1/27 END
   End If
   
gotoExit:
   
   'Modify By Sindy 2015/1/19
   '再以客戶編號抓客戶檔
   'Modify By Sindy 2015/6/30 取消 CU158.境外公司 的控制
   'Modify By Sindy 2015/12/10 + cu158
'         strtmp = "select cu115,cu01,cu02,cu20,cu116,cu117,cu118,nvl(cu16,cu22) cu16,cu18,DECODE(CU15,'0','台端','1','貴公司','貴單位') cu15,nvl(cu04,nvl(cu05||' '||cu88||' '||cu89||' '||cu90,cu06)) cu04,cu158" & _
'                     " from customer,staff,acc090" & _
'                     " where substr('" & strCustNo & "',1,8)=cu01(+) and substr('" & strCustNo & "',9,1)=cu02(+)" & _
'                     " and cu13=st01(+) and cu12=a0901(+)"
   'Modify By Sindy 2016/1/7 用收據抬頭+客戶編號抓資料
   If strCustNo <> "" And bolTitleAndNo = True Then
      For ii = 1 To 3
         If ii = 1 Then
            strSqlcu = "'" & strTitleNm & "'=rtrim(ltrim(cu04))"
            strSqlfa = "'" & strTitleNm & "'=rtrim(ltrim(fa04))"
         ElseIf ii = 2 Then
            strSqlcu = "'" & strTitleNm & "'=rtrim(ltrim(cu05||' '||cu88||' '||cu89||' '||cu90))"
            strSqlfa = "'" & strTitleNm & "'=rtrim(ltrim(fa05||' '||fa63||' '||fa64||' '||fa65))"
         ElseIf ii = 3 Then
            strSqlcu = "'" & strTitleNm & "'=rtrim(ltrim(cu06))"
            strSqlfa = "'" & strTitleNm & "'=rtrim(ltrim(fa06))"
         End If
         For k = 1 To 2
            If k = 1 Then
               'Modify By Sindy 2018/1/15 過濾掉CU13業務人員是離職的資料
               'Modify By Sindy 2018/1/23 不過濾掉CU13業務人員是離職的資料,但先抓在職者資料
               'Modify By Sindy 2022/9/8 + or cu80='國內同業' or cu80='解除對造'
               'Modify By Sindy 2023/2/24 針對客戶狀態CU80的控制要再加不得代理專利、不得代理商標。
               'Modify By Sindy 2025/1/23 +設為對造 or cu80='設為對造'
               'Modify By Sindy 2025/6/27 +or cu80='其他' or cu80='業務自行處理' or cu80='國內同業' or cu80='解除對造' or cu80='不得代理專利' or cu80='不得代理商標' or cu80='設為對造'
               '                          改抓常變數
               strTmp = "select cu115,cu01,cu02,cu20,cu116,cu117," & _
                           "cu118,nvl(cu16,nvl(cu17,cu22)) cu16,cu18,DECODE(CU15,'0','台端','1','貴公司','貴單位') cu15," & _
                           "nvl(cu04,nvl(cu05||' '||cu88||' '||cu89||' '||cu90,cu06)) cu04,cu158,st02,a0902,CU22,CU80,CU30,CU31,CU159,CU12,CU13,CU168,CU169,CU170,CU171,CU11" & _
                           ",nvl(cu58,nvl(cu59,cu114||' '||cu60)) as ConMan,cu172,cu173,CU181" & _
                           " from customer,staff,acc090" & _
                           " where " & strSqlcu & " and cu02='0'" & _
                           " and (cu80 is null or instr('" & 客戶及代理人可讀取的狀態 & "',cu80)>0)" & _
                           " and substr('" & strCustNo & "',1,8)=cu01 and substr('" & strCustNo & "',9,1)=cu02 and cu13=st01(+) and cu12=a0901(+)" & _
                           " order by st04 asc,cu01||cu02 asc"
            Else
               'Modify By Sindy 2022/9/8 + or fa69='國內同業' or fa69='解除對造'
               'Modify By Sindy 2023/2/24 針對客戶狀態CU80的控制要再加不得代理專利、不得代理商標。
               'Modify By Sindy 2025/1/23 +設為對造 or fa69='設為對造'
               'Modify By Sindy 2025/6/27 +or fa69='其他' or fa69='業務自行處理' or fa69='國內同業' or fa69='解除對造' or fa69='不得代理專利' or fa69='不得代理商標' or fa69='設為對造'
               '                          改抓常變數
               strTmp = "select fa79 cu115,fa01 cu01,fa02 cu02,fa16 cu20,fa80 cu116,fa81 cu117," & _
                           "fa82 cu118,nvl(fa12,fa13) cu16,fa14 cu18,'貴公司' cu15," & _
                           "nvl(fa04,nvl(fa05||' '||fa63||' '||fa64||' '||fa65,fa06)) cu04,'' cu158,'' st02,'' a0902,'' CU22,fa69 CU80,'' CU30,'' CU31,fa118 CU159,'' CU12,'' CU13,'' CU168,'' CU169,'' CU170,'' CU171,'' CU11" & _
                           ",nvl(fa07,nvl(fa08,fa78||' '||fa09)) as ConMan,'' cu172,'' cu173,'' CU181" & _
                           " from fagent" & _
                           " where " & strSqlfa & " and fa02='0'" & _
                           " and (fa69 is null or instr('" & 客戶及代理人可讀取的狀態 & "',fa69)>0)" & _
                           " and substr('" & strCustNo & "',1,8)=fa01 and substr('" & strCustNo & "',9,1)=fa02" & _
                           " order by fa01||fa02 asc"
            End If
            intA = 1
            Set adoquery = ClsLawReadRstMsg(intA, strTmp)
            If intA = 1 Then
               adoquery.MoveFirst 'Add By Sindy 2018/1/16
               m_CU01 = "" & adoquery.Fields("cu01")
               m_CU02 = "" & adoquery.Fields("cu02")
               m_CU15 = "" & adoquery.Fields("cu15")
               m_CU115 = "" & adoquery.Fields("cu115")
               m_CU20 = "" & adoquery.Fields("cu20")
               m_CU116 = "" & adoquery.Fields("cu116")
               m_CU117 = "" & adoquery.Fields("cu117")
               m_CU118 = "" & adoquery.Fields("cu118")
               m_CU16 = "" & adoquery.Fields("cu16")
               m_CU18 = "" & adoquery.Fields("cu18")
               'Modify By Sindy 2016/1/28
               If strOldTitleNm <> "" Then
                  m_CU04 = strOldTitleNm
               Else
               '2016/1/28 END
                  m_CU04 = "" & adoquery.Fields("cu04") 'Add By Sindy 2015/2/17
               End If
               m_CU158 = "" & adoquery.Fields("cu158") 'Add By Sindy 2015/12/10
               'Add By Sindy 2016/1/8
               m_CU22 = "" & adoquery.Fields("CU22")
               m_CU80 = "" & adoquery.Fields("CU80")
               m_CU30 = "" & adoquery.Fields("cu30")
               m_CU31 = "" & adoquery.Fields("CU31")
               m_CU159 = "" & adoquery.Fields("CU159")
               m_CU12 = "" & adoquery.Fields("a0902")
               m_CU13 = "" & adoquery.Fields("st02")
               m_CU13Id = "" & adoquery.Fields("cu13") 'Add By Sindy 2018/1/9
               '2016/1/8 END
               m_CU168 = "" & adoquery.Fields("CU168") 'Add By Sindy 2016/11/17
               m_CU181 = "" & adoquery.Fields("CU181") 'Add By Sindy 2019/12/18
               'Add By Sindy 2016/12/1
               m_CU169 = IIf("" & adoquery.Fields("CU169") = "1", "C", "" & adoquery.Fields("CU169"))
               If m_CU169 = "C" Then '客戶
                  m_CU170 = IIf(InStr(m_CU31, m_CU30) > 0, m_CU31, m_CU30 & m_CU31)
                  m_CU171 = IIf(strOldTitleNm <> "", strOldTitleNm, strTitleNm)
               ElseIf m_CU169 = "3" Then '特殊
                  m_CU170 = "" & adoquery.Fields("CU170")
                  m_CU171 = "" & adoquery.Fields("CU171")
               End If
               m_CU11 = "" & adoquery.Fields("CU11")
               '2016/12/1 END
               m_CU58 = "" & adoquery.Fields("ConMan") 'Add By Sindy 2017/3/10
               m_CU172 = "" & adoquery.Fields("CU172") 'Add By Sindy 2017/3/16
               m_CU173 = "" & adoquery.Fields("CU173") 'Add By Sindy 2017/3/24
               m_ManyRowCUid = "," & m_CU01 & m_CU02 'Add By Sindy 2018/1/16
               GetTitleCustData = True
               GoTo ContinueRun
            End If
         Next k
      Next ii
      
      'Modify by Amy 2023/05/22 +if bolNo = True
      If bolNo = True Then
        'Add By Sindy 2019/11/5 張耀升/X06158000
        '以客戶編號抓資料
        If Left(strCustNo, 1) = "X" Then
           'Modify By Sindy 2022/9/8 + or cu80='國內同業' or cu80='解除對造'
           'Modify By Sindy 2023/2/24 針對客戶狀態CU80的控制要再加不得代理專利、不得代理商標。
           'Modify By Sindy 2025/1/23 +設為對造 or cu80='設為對造'
           'Modify By Sindy 2025/6/27 +or cu80='其他' or cu80='業務自行處理' or cu80='國內同業' or cu80='解除對造' or cu80='不得代理專利' or cu80='不得代理商標' or cu80='設為對造'
           '                          改抓常變數
           strTmp = "select cu115,cu01,cu02,cu20,cu116,cu117," & _
                       "cu118,nvl(cu16,nvl(cu17,cu22)) cu16,cu18,DECODE(CU15,'0','台端','1','貴公司','貴單位') cu15," & _
                       "nvl(cu04,nvl(cu05||' '||cu88||' '||cu89||' '||cu90,cu06)) cu04,cu158,st02,a0902,CU22,CU80,CU30,CU31,CU159,CU12,CU13,CU168,CU169,CU170,CU171,CU11" & _
                       ",nvl(cu58,nvl(cu59,cu114||' '||cu60)) as ConMan,cu172,cu173,CU181" & _
                       " from customer,staff,acc090" & _
                       " where cu02='0' and (cu80 is null or instr('" & 客戶及代理人可讀取的狀態 & "',cu80)>0)" & _
                       " and substr('" & strCustNo & "',1,8)=cu01 and substr('" & strCustNo & "',9,1)=cu02 and cu13=st01(+) and cu12=a0901(+)" & _
                       " order by st04 asc,cu01||cu02 asc"
        Else
           'Modify By Sindy 2022/9/8 + or fa69='國內同業' or fa69='解除對造'
           'Modify By Sindy 2023/2/24 針對客戶狀態CU80的控制要再加不得代理專利、不得代理商標。
           'Modify By Sindy 2025/1/23 +設為對造 or fa69='設為對造'
           'Modify By Sindy 2025/6/27 +or fa69='其他' or fa69='業務自行處理' or fa69='國內同業' or fa69='解除對造' or fa69='不得代理專利' or fa69='不得代理商標' or fa69='設為對造'
           '                          改抓常變數
           strTmp = "select fa79 cu115,fa01 cu01,fa02 cu02,fa16 cu20,fa80 cu116,fa81 cu117," & _
                       "fa82 cu118,nvl(fa12,fa13) cu16,fa14 cu18,'貴公司' cu15," & _
                       "nvl(fa04,nvl(fa05||' '||fa63||' '||fa64||' '||fa65,fa06)) cu04,'' cu158,'' st02,'' a0902,'' CU22,fa69 CU80,'' CU30,'' CU31,fa118 CU159,'' CU12,'' CU13,'' CU168,'' CU169,'' CU170,'' CU171,'' CU11" & _
                       ",nvl(fa07,nvl(fa08,fa78||' '||fa09)) as ConMan,'' cu172,'' cu173,'' CU181" & _
                       " from fagent" & _
                       " where fa02='0' and (fa69 is null or instr('" & 客戶及代理人可讀取的狀態 & "',fa69)>0)" & _
                       " and substr('" & strCustNo & "',1,8)=fa01 and substr('" & strCustNo & "',9,1)=fa02" & _
                       " order by fa01||fa02 asc"
        End If
        intA = 1
        Set adoquery = ClsLawReadRstMsg(intA, strTmp)
        If intA = 1 Then
           adoquery.MoveFirst
           m_CU01 = "" & adoquery.Fields("cu01")
           m_CU02 = "" & adoquery.Fields("cu02")
           m_CU15 = "" & adoquery.Fields("cu15")
           m_CU115 = "" & adoquery.Fields("cu115")
           m_CU20 = "" & adoquery.Fields("cu20")
           m_CU116 = "" & adoquery.Fields("cu116")
           m_CU117 = "" & adoquery.Fields("cu117")
           m_CU118 = "" & adoquery.Fields("cu118")
           m_CU16 = "" & adoquery.Fields("cu16")
           m_CU18 = "" & adoquery.Fields("cu18")
           If strOldTitleNm <> "" Then
              m_CU04 = strOldTitleNm
           Else
              m_CU04 = "" & adoquery.Fields("cu04") 'Add By Sindy 2015/2/17
           End If
           m_CU158 = "" & adoquery.Fields("cu158") 'Add By Sindy 2015/12/10
           m_CU22 = "" & adoquery.Fields("CU22")
           m_CU80 = "" & adoquery.Fields("CU80")
           m_CU30 = "" & adoquery.Fields("cu30")
           m_CU31 = "" & adoquery.Fields("CU31")
           m_CU159 = "" & adoquery.Fields("CU159")
           m_CU12 = "" & adoquery.Fields("a0902")
           m_CU13 = "" & adoquery.Fields("st02")
           m_CU13Id = "" & adoquery.Fields("cu13") 'Add By Sindy 2018/1/9
           m_CU168 = "" & adoquery.Fields("CU168") 'Add By Sindy 2016/11/17
           m_CU181 = "" & adoquery.Fields("CU181") 'Add By Sindy 2019/12/18
           m_CU169 = IIf("" & adoquery.Fields("CU169") = "1", "C", "" & adoquery.Fields("CU169"))
           If m_CU169 = "C" Then '客戶
              m_CU170 = IIf(InStr(m_CU31, m_CU30) > 0, m_CU31, m_CU30 & m_CU31)
              m_CU171 = IIf(strOldTitleNm <> "", strOldTitleNm, strTitleNm)
           ElseIf m_CU169 = "3" Then '特殊
              m_CU170 = "" & adoquery.Fields("CU170")
              m_CU171 = "" & adoquery.Fields("CU171")
           End If
           m_CU11 = "" & adoquery.Fields("CU11")
           m_CU58 = "" & adoquery.Fields("ConMan") 'Add By Sindy 2017/3/10
           m_CU172 = "" & adoquery.Fields("CU172") 'Add By Sindy 2017/3/16
           m_CU173 = "" & adoquery.Fields("CU173") 'Add By Sindy 2017/3/24
           m_ManyRowCUid = "," & m_CU01 & m_CU02 'Add By Sindy 2018/1/16
           GetTitleCustData = True
           GoTo ContinueRun
        End If
      End If
   End If
   
ContinueRun:
   
   'Add By Sindy 2018/1/16 記錄多筆CUid
   If m_ManyRowCUid <> "" Then
      adoquery.MoveNext
      Do While Not adoquery.EOF
         m_ManyRowCUid = m_ManyRowCUid & "," & adoquery.Fields("cu01") & adoquery.Fields("cu02")
         adoquery.MoveNext
      Loop
      m_ManyRowCUid = Mid(m_ManyRowCUid, 2)
   End If
   
   'Add By Sindy 2016/12/2
   If m_CU169 = "2" Then '會計師
      If m_CU01 <> "" And m_CU02 <> "" Then
         strTmp = "select A4913,nvl(a4912,'')||decode(nvl(a4912,null),null,'','~')||nvl(a4902,'') as A49Name from ACC490 where A4901='" & m_CU01 & m_CU02 & "'"
      Else
         strTmp = "select A4913,nvl(a4912,'')||decode(nvl(a4912,null),null,'','~')||nvl(a4902,'') as A49Name from ACC490 where A4901='" & IIf(strOldTitleNm <> "", strOldTitleNm, Trim(strTitleNm)) & "'"
      End If
      intA = 1
      Set rsAD = ClsLawReadRstMsg(intA, strTmp)
      If intA = 1 Then
         m_CU170 = "" & rsAD.Fields("A4913")
         m_CU171 = "" & rsAD.Fields("A49Name")
      End If
   End If
   '2016/12/2 END
   
   'Add By Sindy 2018/1/9
   '智權人員若已離職改抓最後收據之a0k20
   If m_CU13Id <> "" Then
      If ChkStaffST04(m_CU13Id, False) = True Then '已離職
         strTmp = "select a0k20,st02,a0k01 from acc0k0,staff where a0k01=(select max(a0k01) from acc0k0 where a0k04='" & strTitleNm & "' and a0k20 is not null)" & _
                     " and a0k20=st01(+) and st04='1'" & _
                     " order by a0k01 desc"
         intA = 1
         Set rsAD = ClsLawReadRstMsg(intA, strTmp)
         If intA = 1 Then
            m_CU13Id = "" & rsAD.Fields("a0k20")
            m_CU13 = "" & rsAD.Fields("st02")
         End If
      End If
   End If
   '2018/1/9 END
   
   adoquery.Close
   Set adoquery = Nothing
   Set Rs = Nothing
   Set rsAD = Nothing 'Added by Lydia 2024/05/15
End Function

'Movie by Lydia 2016/03/18 從basPublic搬來
'Add By Sindy 2016/1/30 解析多個收受者:員工編號轉員工姓名
'Modify By Sindy 2017/10/20 + , Optional bolShowID As Boolean = False
'Modified by Lydia 2024/07/05 + 是否顯示()
Public Function PUB_ReadUserData(strUser As String, Optional bolShowID As Boolean = False, Optional strShowSignal As String = "") As String
Dim tmpArr As Variant
Dim strTempName As String
Dim j As Integer
Dim stBMark As String, stEMark As String 'Added by Lydia 2024/07/05

   'Modified by Morgan 2020/5/13 +可用逗號區隔
   'tmpArr = Split(strUser, ";")
   If InStr(strUser, ",") > 0 Then
      tmpArr = Split(strUser, ",")
   Else
      tmpArr = Split(strUser, ";")
   End If
   'end 2020/5/13
   'Added by Lydia 2024/07/05
   If strShowSignal = "1" Then
      '因為Pub_SendMail解析需要加空白來區分編號和名稱
      stBMark = " ("
      stEMark = ") "
   End If
   'end 2024/07/05
   
   PUB_ReadUserData = ""
   For j = 0 To UBound(tmpArr)
      If tmpArr(j) <> "" Then
         strTempName = ""
         If Len(tmpArr(j)) = 5 And InStr(tmpArr(j), "@") = 0 Then '員工編號
            strTempName = GetPrjSalesNM(CStr(tmpArr(j)))
         End If
         If strTempName <> "" Then
            'Modify By Sindy 2017/10/20 + & IIf(bolShowID = True, tmpArr(j), "")
            'Modified by Lydia 2024/07/05 + stBMark,stEMark
            PUB_ReadUserData = PUB_ReadUserData & IIf(Len(PUB_ReadUserData) > 0, ",", "") & IIf(bolShowID = True, tmpArr(j), "") & stBMark & strTempName & stEMark
         Else
            PUB_ReadUserData = PUB_ReadUserData & IIf(Len(PUB_ReadUserData) > 0, ",", "") & tmpArr(j)
         End If
      End If
   Next j
End Function

'Add by Amy 2016/03/31 從acc2490搬過來修改並加bolONo是否取分所案號
Public Function GetYourRefNo1(stCaseNo1 As String, stCaseNo2 As String, stCaseNo3 As String, stCaseNo4 As String, Optional bolONo As Boolean = False) As String
    Dim Rs As ADODB.Recordset
    Dim strQuery As String
    Dim intR As Integer
    Dim strField As String
    
    GetYourRefNo1 = ""
    If stCaseNo1 = "" Then Exit Function
    
    Select Case stCaseNo1
        Case "CFP", "FCP", "P"  '專利
            If bolONo = True Then
                strField = "Nvl(PA77,PA47)"
            Else
                strField = "PA77"
            End If
            strQuery = "Select " & strField & " YourR From Patent Where PA01 = '" & stCaseNo1 & "' and PA02 = '" & stCaseNo2 & "' and PA03 = '" & stCaseNo3 & "' and PA04 = '" & stCaseNo4 & "' "
        Case "CFT", "FCT", "T", "TF"  '商標
            If bolONo = True Then
                strField = "Nvl(TM45,TM34)"
            Else
                strField = "TM45"
            End If
            strQuery = "Select " & strField & " YourR From TradeMark Where TM01 = '" & stCaseNo1 & "' and TM02 = '" & stCaseNo2 & "' and TM03 = '" & stCaseNo3 & "' and TM04 = '" & stCaseNo4 & "' "
        'modify by sonia 2019/7/31 +ACS系統類別
        Case "CFL", "FCL", "L", "LIN", "ACS" '法務
            If bolONo = True Then
                strField = "Nvl(LC23,LC16)"
            Else
                strField = "LC23"
            End If
            strQuery = "Select " & strField & " YourR From LawCase Where LC01 = '" & stCaseNo1 & "' and LC02 = '" & stCaseNo2 & "' and LC03 = '" & stCaseNo3 & "' and LC04 = '" & stCaseNo4 & "' "
        Case Else  '服務
            If bolONo = True Then
                strField = "Nvl(SP27,SP28)"
            Else
                strField = "SP27"
            End If
            strQuery = "Select " & strField & " YourR From ServicePractice Where SP01 = '" & stCaseNo1 & "' and SP02 = '" & stCaseNo2 & "' and SP03 = '" & stCaseNo3 & "' and SP04 = '" & stCaseNo4 & "' "
    End Select
    intR = 1
    Set Rs = ClsLawReadRstMsg(intR, strQuery)
    If intR = 1 Then
        GetYourRefNo1 = "" & Rs.Fields("YourR")
    End If
    Set Rs = Nothing
End Function

'Added by Lydia 2016/05/27 檢查定稿暫存檔的程序報價點數和是否需主管簽核案件和主管簽核點數
'Modified by Lydia +智權人員報價mLcv06
Public Function PUB_GetLCV04LCV10(ByVal sNP02 As String, ByVal sNP03 As String, ByVal sNP04 As String, ByVal sNP05 As String, ByVal sNP07 As String, ByRef mLcv04 As String, ByRef mLcv10 As String, Optional ByRef mLc17 As String, Optional ByRef mLcv09 As String, Optional ByRef mLcv06 As String) As Boolean
Dim strC1 As String, strC2 As String
Dim rsCD As New ADODB.Recordset
Dim intC As Integer

PUB_GetLCV04LCV10 = False
mLcv04 = "" '程序報價點數
mLcv09 = "" '簽核主管
mLcv10 = "" '簽核點數
mLc17 = ""  '是否需主管簽核

sNP04 = Left(sNP04 & "0", 1)
sNP05 = Left(sNP05 & "00", 2)

If InStr("605,606,607", sNP07) = 0 Then
   Exit Function
End If
   
   '無合併定稿
   strC1 = "select 1 srt, np01,np22,lc03,lc17,lc13 from nextprogress n,lettercache l where np02='" & sNP02 & "' and np03='" & sNP03 & "' and np04='" & sNP04 & "' and np05='" & sNP05 & "' and np07='" & sNP07 & "' and np06 is null " & _
           "and np01=lc01(+) and np22=lc02(+) and lc13 is not null "
   '有合併定稿，抓代表的費用項目(一個月內)
   strC1 = strC1 & "union select 2 srt, np01,np22,lc03,lc17,lc13 from nextprogress n,lettercache l where np02='" & sNP02 & "' and np03='" & sNP03 & "' and np04='" & sNP04 & "' and np05='" & sNP05 & "' " & _
           "and instr('605,606,607',np07) > 0 and np07<>'" & sNP07 & "' " & _
           "and np01=lc01(+) and np22=lc02(+) and lc13>=" & CompDate(1, -1, strSrvDate(1)) & " order by srt,lc13 desc "
   intC = 1
   Set rsCD = ClsLawReadRstMsg(intC, strC1)
   If intC = 1 Then
      If "" & rsCD.Fields("lc03") <> "" Then
         PUB_GetLCV04LCV10 = True
         mLc17 = "" & rsCD.Fields("lc17")
         Select Case sNP07
            Case "605": strC2 = "年費"
            Case "606": strC2 = "維持費"
            Case "607": strC2 = "延展費"
         End Select
         '1.有合併定稿;  2.無合併定稿,預設用費用
         'Modified by Lydia 2016/11/17 EPC進入國家階段的抓法不同,所以除了合併定稿外,其他直接抓點數合計(ex.CFP-18085)
         'strC1 = "select 1 srt,lcv04,lcv09,lcv10 from lettercachevar where lcv01='" & rsCD.Fields("np01") & "' and lcv02='" & rsCD.Fields("np22") & "' and lcv03='" & strC2 & "點數" & "' " & _
                 "union select 2 srt,lcv04,lcv09,lcv10 from lettercachevar where lcv01='" & rsCD.Fields("np01") & "' and lcv02='" & rsCD.Fields("np22") & "' and lcv03='費用點數' " & _
                 "order by srt "
         'Modified by Lydia 2018/06/04 + lcv06
         strC1 = "select 1 srt,lcv04,lcv09,lcv10,lcv06 from lettercachevar where lcv01='" & rsCD.Fields("np01") & "' and lcv02='" & rsCD.Fields("np22") & "' and lcv03='" & strC2 & "點數" & "' " & _
                 "union select 2 srt,lcv04,lcv09,lcv10,lcv06 from lettercachevar where lcv01='" & rsCD.Fields("np01") & "' and lcv02='" & rsCD.Fields("np22") & "' and instr(lcv03,'點數合計') > 0  " & _
                 "order by srt "
         intC = 1
         Set rsCD = ClsLawReadRstMsg(intC, strC1)
         If intC = 1 Then
            mLcv04 = "" & rsCD.Fields("lcv04")
            mLcv09 = "" & rsCD.Fields("lcv09")
            mLcv10 = "" & rsCD.Fields("lcv10")
            mLcv06 = "" & rsCD.Fields("lcv06") 'Added by Lydia 2018/06/04
         End If
      End If
   End If
End Function
'end 2016/05/27

'Add By Sindy 2016/6/22 檢查是否有查看開庭紀要及電子筆錄的權限
Public Function PUB_GetLimitToBRIEF(ByVal strCP01 As String, ByVal strCP02 As String, _
                                    ByVal strCP03 As String, ByVal strCP04 As String, _
                                    Optional ByVal strCP09 As String = "") As Boolean
Dim bolReadY As Boolean
Dim strST11 As String
Dim Rs As ADODB.Recordset
Dim varTmp As Variant
Dim ii As Integer
Dim strTmp As String, intA As Integer, rsAD As New ADODB.Recordset 'Added by Lydia 2024/05/15

   PUB_GetLimitToBRIEF = False
   'Modified by Morgan 2018/12/11 非法務案沒有開庭紀要不必限制 Ex:CFP-29129 IDS 有摘要翻譯檔名為 CFP29129.214.TW201634441A.ENGLISH.BRIEF.EXPLANATION.PDF
   'If strCP01 <> "L" And strCP01 <> "FCL" And strCP01 <> "CFL" Then
   If strCP01 <> "L" And strCP01 <> "LA" And strCP01 <> "FCL" And strCP01 <> "CFL" And strCP01 <> "LIN" Then
      PUB_GetLimitToBRIEF = True
   'end 2018/12/11
      Exit Function
   End If
   
   strTmp = "SELECT ST11 FROM Staff " & _
                "WHERE ST01 = '" & strUserNum & "' "
   intA = 1
   Set rsAD = ClsLawReadRstMsg(intA, strTmp)
   strST11 = ""
   If intA = 1 Then
      strST11 = "" & rsAD.Fields("ST11")
   End If
   
   bolReadY = False
   strTmp = "SELECT cp13,st52,st53,st54,st55,a0908 FROM caseprogress,staff,acc090 " & _
                "WHERE cp01='" & strCP01 & "' and cp02='" & strCP02 & "' and cp03='" & strCP03 & "' and cp04='" & strCP04 & "' " & _
                  "and cp13=st01(+) and st03=a0901(+) "
   If strCP09 <> "" Then
      '因卷宗區會有可能是傳入本所案號或總收文號
      If InStr(strCP09, "-") = 0 Then '總收文號
'         If InStr(strCP09, ",") > 0 Then '多個文號
'            strtmp = strtmp & "and cp09 in(" & strCP09 & ") "
'         Else
'            strtmp = strtmp & "and cp09=" & strCP09
'         End If
         'Modify By Sindy 2021/10/15 改語法
         If InStr(UCase(strCP09), UCase("from")) = 0 Then
            strTmp = strTmp & " and " & strCP09
         End If
      End If
   End If
   intA = 1
   Set rsAD = ClsLawReadRstMsg(intA, strTmp)
   If intA = 1 Then
      rsAD.MoveFirst
      '本案相關人員
      Do While Not rsAD.EOF
         If strUserNum = "" & rsAD.Fields("cp13") Or _
            strUserNum = "" & rsAD.Fields("st52") Or _
            strUserNum = "" & rsAD.Fields("st53") Or _
            strUserNum = "" & rsAD.Fields("st54") Or _
            strUserNum = "" & rsAD.Fields("st55") Or _
            strUserNum = "" & rsAD.Fields("a0908") Then
            bolReadY = True
            Exit Do
         End If
         rsAD.MoveNext
      Loop
      
      'Modify By Sindy 2020/5/12 增加檢查案源檔的介紹人及介紹人主管
      strTmp = "SELECT cp13,st52,st53,st54,st55,a0908,LOS04 FROM caseprogress,staff,acc090,LawOfficeSource " & _
                   "WHERE cp01='" & strCP01 & "' and cp02='" & strCP02 & "' and cp03='" & strCP03 & "' and cp04='" & strCP04 & "' " & _
                     "and LOS06(+)=cp09 " & _
                     "and substr(LOS04,1,5)=st01(+) and st03=a0901(+) "
      If strCP09 <> "" Then
         '因卷宗區會有可能是傳入本所案號或總收文號
         If InStr(strCP09, "-") = 0 Then '總收文號
'            If InStr(strCP09, ",") > 0 Then '多個文號
'               strtmp = strtmp & "and cp09 in(" & strCP09 & ") "
'            Else
'               strtmp = strtmp & "and cp09=" & strCP09
'            End If
            'Modify By Sindy 2021/10/15 改語法
            If InStr(UCase(strCP09), UCase("from")) = 0 Then
               strTmp = strTmp & " and " & strCP09
            End If
         End If
      End If
      intA = 1
      Set rsAD = ClsLawReadRstMsg(intA, strTmp)
      If intA = 1 Then
         rsAD.MoveFirst
         Do While Not rsAD.EOF
            If InStr("" & rsAD.Fields("LOS04"), strUserNum) > 0 Or _
               strUserNum = "" & rsAD.Fields("st52") Or _
               strUserNum = "" & rsAD.Fields("st53") Or _
               strUserNum = "" & rsAD.Fields("st54") Or _
               strUserNum = "" & rsAD.Fields("st55") Or _
               strUserNum = "" & rsAD.Fields("a0908") Then
               bolReadY = True
               Exit Do
            End If
            '若多個介紹人時,要逐一檢查
            If InStr("" & rsAD.Fields("LOS04"), ",") > 0 Then
               varTmp = Split("" & rsAD.Fields("LOS04"), ",")
               For ii = 1 To UBound(varTmp)
                  strTmp = "SELECT st52,st53,st54,st55,a0908 FROM staff,acc090 " & _
                              "WHERE '" & varTmp(ii) & "'=st01(+) and st03=a0901(+) "
                  intA = 1
                  Set Rs = ClsLawReadRstMsg(intA, strTmp)
                  If intA = 1 Then
                     If strUserNum = varTmp(ii) Or _
                        strUserNum = "" & Rs.Fields("st52") Or _
                        strUserNum = "" & Rs.Fields("st53") Or _
                        strUserNum = "" & Rs.Fields("st54") Or _
                        strUserNum = "" & Rs.Fields("st55") Or _
                        strUserNum = "" & Rs.Fields("a0908") Then
                        bolReadY = True
                        Exit Do
                     End If
                  End If
               Next ii
            End If
            
            rsAD.MoveNext
         Loop
      End If
      '2020/5/12 END
   End If
   
   If PUB_GetST05(strUserNum) = "00" Or PUB_GetST05(strUserNum) = "01" Or PUB_GetST05(strUserNum) = "09" Or _
      ((strCP01 = "L" Or strCP01 = "LA") And strST11 = "G1") Or _
      ((strCP01 = "CFL" Or strCP01 = "FCL" Or strCP01 = "LIN") And strST11 = "F1") Or _
      bolReadY = True Then
      PUB_GetLimitToBRIEF = True
   End If
   'Added by Lydia 2024/05/14
   Set Rs = Nothing
   Set rsAD = Nothing
   
End Function
'end 2016/6/22

'Add by Amy 2016/07/12
'取得項次 從frmacc4120 搬過來
Public Function GetSeqNo(stAx201 As String, stAx202 As String) As String
    '取得項次
    Dim adoMax As New ADODB.Recordset
    Dim strQ As String
    
    strQ = "Select Nvl(Max(ax203),0) From Acc021 Where ax201 = '" & stAx201 & "' and ax202 = '" & stAx202 & "'"
    If adoMax.State = adStateOpen Then adoMax.Close
    adoMax.CursorLocation = adUseClient
    adoMax.Open strQ, adoTaie, adOpenStatic, adLockReadOnly
    If adoMax.RecordCount <> 0 Then
       GetSeqNo = ZeroBeforeNo(Val(adoMax.Fields(0).Value), 3)
    Else
       GetSeqNo = ZeroBeforeNo(0, 3)
    End If
    adoMax.Close
End Function

'傳入年月取得Acc0b1之期末實績或結餘傳票起迄編號
Public Function bolAcc0b1(ByVal intChoose As Integer, ByVal stDate As String, ByRef stAcc0b1() As String) As Boolean
    Dim RsQ As New ADODB.Recordset
    Dim strQ As String
    Dim intQ As Integer, ii As Integer

    bolAcc0b1 = False
    For ii = LBound(stAcc0b1) To UBound(stAcc0b1)
        stAcc0b1(ii) = MsgText(601)
    Next ii
    
    Select Case intChoose
        Case 0
            strQ = "*"
        Case 1 '實績
            '            起號   迄號   轉撥    回轉起 回轉迄
            strQ = "Axb04,Axb05,Axb06,Axb07,Axb08"
        Case 2 '結餘
            '            起號   迄號   轉撥    回轉起 回轉迄
            strQ = "Axb09,Axb10,Axb11,Axb12,Axb13"
        'Add by Amy 2017/04/21
        Case 3
            'Modify by Amy 2017/09/29 +Axb15
            '非當月結餘轉撥傳票號碼,傳票日
            strQ = "Axb14,Axb15"
        'Add by Amy 2017/04/24
        Case 4 '實績期末保留傳票日期
            strQ = "Axb02"
        Case 5 '結餘期末保留傳票日期
            strQ = "Axb03"
        'end 2017/04/24
        'Add by Amy 2017/10/20
        Case 6 '實績轉撥傳票號碼
            strQ = "Axb06"
        Case 7 '結餘轉撥傳票號碼
            strQ = "Axb11"
        'end 2017/10/20
        Case 8 'Add by Amy 2021/09/08 有修改結餘資料
            strQ = "Axb16"
        Case 9 'Add by Amy 2023/04/14ACS實績期末傳票號碼
            strQ = "Axb17"
    End Select

    strQ = "Select " & strQ & " From Acc0B1 Where Axb01=" & stDate
    intQ = 1
    Set RsQ = ClsLawReadRstMsg(intQ, strQ)
    If intQ = 1 Then
        If RsQ.EOF = False Then
            bolAcc0b1 = True
            For ii = LBound(stAcc0b1) To UBound(stAcc0b1)
                'Modify by Amy 2021/09/08 +有修改結餘資料
                If intChoose = 8 Or intChoose = 9 Then
                    stAcc0b1(LBound(stAcc0b1)) = "" & RsQ.Fields(0)
                'Modify by Amy 2017/04/25
                ElseIf intChoose <= 3 Then
                    stAcc0b1(ii) = "" & RsQ.Fields(IIf(LBound(stAcc0b1) > 0, ii - Int(LBound(stAcc0b1)), ii))
                Else
                    stAcc0b1(ii) = "" & RsQ.Fields(Int(LBound(stAcc0b1)) - ii)
                End If
            Next ii
        End If
    End If
    RsQ.Close
    
End Function
'end 2016/07/12

'Add by Amy 2016/07/13 傳入西元日期取得上個月最後一個工作日
'Modify by Amy 2018/09/12 +bolChinaY
Public Function GetPreMonLastDate(ByVal stDate As String, Optional ByVal bolChinaY As Boolean = True) As String
    Dim stTemp As String
    
    If Mid(stDate, 5, 2) = "01" Then
        stTemp = Val(Mid(stDate, 1, 4)) - 1 & "12"
    Else
        stTemp = Val(Mid(stDate, 1, 6)) - 1
    End If
    'Modify by Amy 2018/09/12
    GetPreMonLastDate = GetMonthStdDay(stTemp, 1)
    If bolChinaY = True Then
        GetPreMonLastDate = Val(GetPreMonLastDate) - 19110000
    End If
    'end 2018/09/12
End Function

'Modify by Amy 2016/07/14 +修改傳入參數(可傳員編)
Public Function ChkPLimit(intChoose As Integer, stNo1 As String, Optional stNo2 As String = "") As Boolean
    Dim stQ As String, stQ2 As String
    Dim intR As Integer
    Dim rsAD As New ADODB.Recordset 'Added by Lydia 2024/05/15
    
    ChkPLimit = False
    Select Case intChoose
        Case 1
            stQ2 = "st01 in (select cu13 from customer where cu01='" & stNo1 & "' and cu02='" & stNo2 & "') "
        Case 2
            stQ2 = "st01='" & stNo1 & "' "
    End Select
   
    stQ = "Select count(*) From Staff " & _
                      "Where " & stQ2 & _
                      "and st04='2' and (st52='" & strUserNum & "' or st53='" & strUserNum & "' or st54='" & strUserNum & "' or st55='" & strUserNum & "') "
   'end 2016/07/14
    intR = 1
    Set rsAD = ClsLawReadRstMsg(intR, stQ)
    If intR = 1 Then
       If rsAD.Fields(0) > 0 Then
          ChkPLimit = True
       End If
    End If
    Set rsAD = Nothing 'Added by Lydia 2024/05/15
End Function
'end 2016/07/13

'Added by Lydia 2016/08/02 檢查是否有中文/英文
Public Function PUB_CheckStrNEC(ByVal inputS As String, Optional ByVal iTyp As String = "C") As Boolean
Dim iX As Integer
Dim dCod As Double
    
    PUB_CheckStrNEC = False
    
    If Len(Trim(inputS)) = 0 Then Exit Function
    
    For iX = 1 To Len(inputS)
       'Modify by Amy 2022/03/31 原:Asc 導致 UniCode 的Asc會是?的Ascii
       dCod = AscW(Mid(inputS, iX, 1))
       'Modified by by Lydia 2017/03/03 只能有數字
       'If iTyp = "C" And dCod <= 0 Then '中文(雙字元）
       If iTyp = "N" And (dCod < 48 Or dCod > 57) Then
          Exit Function
       'Modifed by Lydia 2022/03/31 AscW值:英文 >0，中文 >255
       'ElseIf iTyp = "C" And dCod <= 0 Then '中文(雙字元）
       ElseIf iTyp = "C" And dCod > 255 Then '中文(雙字元）
       'end 2017/03/03
          PUB_CheckStrNEC = True
          Exit Function
       ElseIf iTyp = "E" And dCod > 0 And dCod < 255 Then '英文(含數字和符號)
          PUB_CheckStrNEC = True
          Exit Function
       End If
    Next
    
    'Added by Lydia 2017/03/03
    If iTyp = "N" Then PUB_CheckStrNEC = True

End Function

'Add by Amy 2016/08/16 確認是否有收文放棄專利權(429)且已發文或已通知專利權公告作廢(1606)
Public Function ChkP429Or1606(ByVal stCP01 As String, ByVal stCP02 As String, ByVal stCP03 As String, ByVal stCP04 As String, ByVal stNation As String) As String
    Dim RsQ As New ADODB.Recordset
    Dim strQ As String
    
    ChkP429Or1606 = ""
    'Add by Amy 2017/08/01 +大陸一案兩請新型不需彈訊息(可收文年費控制) ex:P-109094
    If stNation = "020" Then
        strQ = "Select 1 From Patent,CaseMap Where PA01='" & stCP01 & "' And PA02='" & stCP02 & "' And PA03='" & stCP03 & "' And PA04='" & stCP04 & "' And PA08='2' " & _
                   "And ((CM01='" & stCP01 & "' And CM02='" & stCP02 & "' And CM03='" & stCP03 & "' And CM04='" & stCP04 & "' ) " & _
                   "Or (CM05='" & stCP01 & "' And CM06='" & stCP02 & "' And CM07='" & stCP03 & "' And CM08='" & stCP04 & "' ) ) And CM10='3' "
        If RsQ.State <> adStateClosed Then RsQ.Close
        RsQ.CursorLocation = adUseClient
        RsQ.Open strQ, cnnConnection, adOpenStatic, adLockReadOnly
        If RsQ.RecordCount > 0 Then
            Exit Function
        End If
    End If
    'end 2017/08/01
    
    strQ = "Select " & IIf(stNation = "000", "CPM03", "CPM04") & " From CaseProgress,CasePropertyMap " & _
                "Where CP01='" & stCP01 & "' And CP02='" & stCP02 & "' And CP03='" & stCP03 & "' And CP04='" & stCP04 & "' " & _
                "And (CP10='429' And CP27 Is not null Or CP10='1606') And CP01=CPM01(+) And CP10=CPM02(+)"
    If RsQ.State <> adStateClosed Then RsQ.Close
    RsQ.CursorLocation = adUseClient
    RsQ.Open strQ, cnnConnection, adOpenStatic, adLockReadOnly
    If RsQ.RecordCount > 0 Then
        ChkP429Or1606 = "" & RsQ.Fields(0)
    End If
    
    RsQ.Close
    Set RsQ = Nothing
End Function

'Add by Amy 2016/08/17 傳入客戶編號/系統別/國家代碼抓取相對應收據公司別
'Modify by Amy 2016/08/19 +stCmpName 參數,回傳收據公司別名稱
'Modify by Amy 2016/08/25 +stFromName 參數
'Modify by Amy 2024/11/04 +intChoose 0:全部/1:只抓對應欄位 及 stReceiptField:對應收據公司別欄位
Public Function GetReceiptCmp(ByVal stCU01 As String, ByVal stCU02 As String, ByVal SysKind As String, ByVal stCountry As String, Optional ByVal bolChgVal As Boolean = True, Optional ByRef stCmpName As String = "", Optional ByVal stFormName As String = "" _
  , Optional ByVal intChoose As Integer = 0, Optional ByRef stReceiptField As String = "") As String
    Dim RsQ As New ADODB.Recordset
    Dim strQ As String, strField As String, strRCmp As String
    Dim intQ As Integer
    
    strRCmp = ""
    stReceiptField = "" 'Add by Amy 2024/11/04
    
    'Modify by Amy 2016/09/01 修正系統別抓的欄位 原:用InStr(SysKind, "P")>0
    Select Case SysKind
        Case "P", "CFP", "FCP"
            If stCountry = 台灣國家代號 Then
                strField = "cu160"
            Else
                strField = "cu161"
            End If
        Case "T", "TF", "CFT", "FCT"
            If stCountry = 台灣國家代號 Then
                strField = "cu162"
            Else
                strField = "cu163"
            End If
        Case Else
            If stCountry = 台灣國家代號 Then
                strField = "cu164"
            Else
                strField = "cu165"
            End If
    End Select
    'end 2016/09/01
    'Add by Amy 2024/11/04 只抓收據公司別(出名公司)只抓對應欄位
    stReceiptField = strField
    If intChoose = 1 Then Exit Function
    'end 2024/11/04
    
    strQ = "Select " & strField & " From Customer Where CU01='" & stCU01 & "' And CU02='" & stCU02 & "' "
    intQ = 1
    Set RsQ = ClsLawReadRstMsg(intQ, strQ)
    If intQ = 1 Then
        strRCmp = "" & RsQ.Fields(0)
        If bolChgVal = True And strRCmp <> MsgText(601) Then
            'Modify by Amy 2016/08/25 +stFormName
            'Modify By Sindy 2022/9/16 + And UCase(stFormName) <> "FRM090801_NEW"
            If UCase(stFormName) <> "FRM090801" And UCase(stFormName) <> "FRM090801_NEW" And Left(UCase(stFormName), 9) <> "FRM210114" Then
                If InStr(SysKind, "T") = 0 Then
                    Select Case strRCmp
                        Case "1"
                           strRCmp = "T"
                        Case "2"
                            strRCmp = ""
                    End Select
                Else
                    If strRCmp <> "J" Then strRCmp = ""
                End If
            End If
        End If
        'Add by Amy 2016/08/19
        'Modify by Amy 2016/08/25 +stFormName
        If stCmpName <> MsgText(601) Then
            stCmpName = ""
            'Add by Amy 2016/09/01 +"FRM090801"判斷
            'Modify By Sindy 2022/9/16 + FRM090801_NEW
            If UCase(stFormName) = "FRM090801" Or UCase(stFormName) = "FRM090801_NEW" Then
               'Added by Morgan 2020/3/24
               If strSrvDate(1) >= 智慧所更名日 Then
                  If strRCmp <> "" Then
                     stCmpName = CompNameQuery(strRCmp, "4")
                  End If
               Else
               'end 2020/3/24
               
                  Select Case strRCmp
                      Case "1"
                          stCmpName = "專利商標"
                      Case "2"
                          stCmpName = "專利法律"
                      Case "J"
                          stCmpName = "智權公司"
                  End Select
                  
               End If 'Added by Morgan 2020/3/24
            
            Else
                'Modified by Morgan 2020/3/24 Amy說應該沒有只傳公司名稱沒傳公司別的情形
                'Select Case strRCmp
                '    Case "1"
                '        stCmpName = "台一國際專利商標事務所"
                '    Case "2"
                '        stCmpName = "台一國際專利法律事務所"
                '    Case "J"
                '        stCmpName = "台一智權股份有限公司"
                '    Case Else
                '        If Left(UCase(stFormName), 9) <> "FRM210114" Then
                '            If InStr(SysKind, "T") = 0 Or (InStr(SysKind, "T") > 0 And strRCmp = "2") Then
                '                stCmpName = "台一國際專利法律事務所"
                '            Else
                '                stCmpName = "台一國際專利商標事務所"
                '            End If
                '        End If
                'End Select
                If strRCmp <> "" Then
                  stCmpName = CompNameQuery(strRCmp)
                End If
                'end 2020/3/24
            End If
            'end 2016/09/01
        End If
        'end 2016/08/25
    End If
    GetReceiptCmp = strRCmp
    Set RsQ = Nothing
End Function

'Added by Morgan 2016/9/10 (P-108013)
'臺灣一案兩請新型案是否不可收文年費:True=不可收文
Public Function PUB_TwDualCaseUtyNoAdd605(ByVal stCP01 As String, ByVal stCP02 As String, ByVal stCP03 As String, ByVal stCP04 As String, Optional ByVal stNation As String = "000") As Boolean
    Dim rsQuery As ADODB.Recordset
    Dim stSQL As String, intQ As Integer
        
    If stNation = "000" Then
      '臺灣發明案已公告且有發文擇一申復時新型案不可收文年費--玲玲
      stSQL = "select cm01,cm02,cm03,cm04" & _
         " from (select cm01,cm02,cm03,cm04,cm05,cm06,cm07,cm08 from casemap where cm01='" & stCP01 & "' and cm02='" & stCP02 & "' and cm03='" & stCP03 & "' and cm04='" & stCP04 & "' and cm10='3'" & _
         " union select cm05,cm06,cm07,cm08,cm01,cm02,cm03,cm04 from casemap where cm05='" & stCP01 & "' and cm06='" & stCP03 & "' and cm07='" & stCP03 & "' and cm08='" & stCP04 & "' and cm10='3'" & _
         ") X where exists(select * from patent where pa01=cm01 and pa02=cm02 and pa03=cm03 and pa04=cm04 and pa08='2' and pa09='000')" & _
         " and exists(select * from patent where pa01=cm05 and pa02=cm06 and pa03=cm07 and pa04=cm08 and pa14>0)" & _
         " and exists(select * from caseprogress where cp01=cm05 and cp02=cm06 and cp03=cm07 and cp04=cm08 and cp10='239' and cp27>0)"
      intQ = 1
      Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
      If intQ = 1 Then
         PUB_TwDualCaseUtyNoAdd605 = True
      End If
    End If
End Function

'Added by Morgan 2016/10/21
'檢查輸入法是否有載入:LayOutNo=輸入法代碼
Private Function IsImeLoaded(LayOutNo As Long) As Boolean
    Dim hkb5(24) As Long
    Dim i As Integer
    Dim LayOutCount As Long
    Dim bolLoaded As Boolean
    
    LayOutCount = GetKeyboardLayoutList(25, hkb5(0))
    For i = 0 To LayOutCount - 1
      If hkb5(i) = LayOutNo Then
         IsImeLoaded = True
         Exit For
      End If
    Next i
End Function

'Added by Lydia 2016/10/28 新增地址條A4清單記錄,並回傳目前筆數
Public Function PUB_AddAddressA4List(ByVal strInNo As String, Optional ByRef strTal As String) As Boolean
Dim strTtmp As String
Dim rsB As New ADODB.Recordset
Dim inX As Integer
    
    If strInNo <> "" Then
       'Modified by Lydia 2016/11/04 改成可跨日列印,所以不限日期
       'strTtmp = "insert into addressa4list (aal01,aal02,aal03,aal04) select '" & strUserNum & "'," & strSrvDate(1) & ",(nvl(max(aal03),0) + 1),'" & strInNo & "' " & _
                 "from addressa4list where aal01='" & strUserNum & "' and aal02=" & strSrvDate(1)
       strTtmp = "insert into addressa4list (aal01,aal02,aal03,aal04) select '" & strUserNum & "'," & strSrvDate(1) & ",(nvl(max(aal03),0) + 1),'" & strInNo & "' " & _
                 "from addressa4list where aal01='" & strUserNum & "' "
       cnnConnection.Execute strTtmp, inX
       PUB_AddAddressA4List = True
    End If
    
    strTal = ""
    'Modified by Lydia 2016/11/04 改成可跨日列印,所以不限日期
    'strTtmp = "select count(*) cnt1 from addressa4list where aal01='" & strUserNum & "' and aal02=" & strSrvDate(1)
    strTtmp = "select count(*) cnt1 from addressa4list where aal01='" & strUserNum & "' "
    inX = 1
    Set rsB = ClsLawReadRstMsg(inX, strTtmp)
    If inX = 1 Then
       strTal = "" & rsB.Fields("cnt1")
    End If
    
    Exit Function
End Function
 
'Add by Amy 2016/11/10 取得圖書/借閱記錄序號
Public Function GetSerialNo_Lib(ByVal intChoose As Integer) As String
    Dim rsA As New ADODB.Recordset
    Dim stQ As String
    
    GetSerialNo_Lib = ""
    If intChoose = 0 Then
        '抓BooksData(圖書基本資料)流水號
        stQ = "Select NVL(MAX(BK01),0) as stNo From BooksData "
    Else
        '抓LoanRecord(借閱記錄)流水號
        stQ = "Select NVL(MAX(LR01),0) as stNo From LoanRecord "
    End If
    rsA.CursorLocation = adUseClient
    rsA.Open stQ, cnnConnection, adOpenStatic, adLockReadOnly
    
    If intChoose = 0 Then
        If Val(Format(Val(rsA("StNo")) + 1, "0000")) >= 10000 Then
            MsgBox "圖書基本資料編碼已不符使用，請洽資訊人員，謝謝！"
        Else
            GetSerialNo_Lib = Format(Val(rsA("StNo")) + 1, "0000")
        End If
    Else
        'Modify by Amy 2016/11/17
        If intChoose = 1 Then
            If Val(rsA("StNo")) = 0 Then
                GetSerialNo_Lib = Left(strSrvDate(2), 3) & Format(Val(rsA("StNo")) + 1, "0000")
            ElseIf Val(Left(rsA("StNo"), 3)) >= 199 Then
                MsgBox "此借閱記錄年度編碼已不符使用，請洽資訊人員，謝謝！"
            ElseIf Val(Mid(rsA("StNo"), 4)) >= 9999 Then
                MsgBox "此借閱記錄編碼已不符使用，請洽資訊人員，謝謝！"
            Else
                GetSerialNo_Lib = Format(Val(rsA("StNo")) + 1, "0000000")
            End If
        Else
            GetSerialNo_Lib = "" & rsA("StNo")
        End If
        'end 2016/11/17
    End If
    
    rsA.Close
    Set rsA = Nothing
End Function

'Add by Amy 2016/11/11 判斷是否有圖書借閱記錄需簽核
Public Function GetLoanRecordApply() As Boolean
    Dim RsQ As New ADODB.Recordset
    Dim strQ As String
    
    GetLoanRecordApply = False
    strQ = "Select * From BooksData,LoanRecord a Where BK10='" & strUserNum & "' And BK01=LR03(+) " & _
                "And LR06 is null And LR02>='1' And  LR02<='W' " & _
                "And Not Exists(Select * From LoanRecord b Where a.LR03=b.LR03(+) And (LR02='Y' Or LR02='Z') " & _
                "And LR01=(Select Max(LR01) as LR01 From LoanRecord Where b.LR03=LR03)) "
                
    RsQ.CursorLocation = adUseClient
    RsQ.Open strQ, cnnConnection, adOpenStatic, adLockReadOnly
    If RsQ.RecordCount > 0 Then
        GetLoanRecordApply = True
    End If
    RsQ.Close
    Set RsQ = Nothing
End Function

'Add By Sindy 2016/12/9 組合業務備註
Public Function PUB_GetApplCU125(strCaseNo As String) As String
Dim RsQ As New ADODB.Recordset
Dim strQ As String
Dim ii As Integer
Dim strAppl As String
    
   PUB_GetApplCU125 = ""
   For ii = 1 To 5
      strAppl = ""
      If ii = 1 Then strAppl = GetPrjPeopleNum1(strCaseNo)
      If ii = 2 Then strAppl = GetPrjPeopleNum2(strCaseNo)
      If ii = 3 Then strAppl = GetPrjPeopleNum3(strCaseNo)
      If ii = 4 Then strAppl = GetPrjPeopleNum4(strCaseNo)
      If ii = 5 Then strAppl = GetPrjPeopleNum5(strCaseNo)
      If strAppl <> "" Then
         strQ = "Select NVL(CU04,DECODE(CU05,NULL,CU06,CU05||' '||CU88||' '||CU89||' '||CU90)),cu125 From customer" & _
                " where cu01='" & Left(strAppl, 8) & "' and cu02='" & Right(strAppl, 1) & "'"
         RsQ.CursorLocation = adUseClient
         RsQ.Open strQ, cnnConnection, adOpenStatic, adLockReadOnly
         If RsQ.RecordCount > 0 Then
            If Not IsNull(RsQ.Fields(1)) = True Then
               PUB_GetApplCU125 = PUB_GetApplCU125 & "申請人" & ii & "(" & RsQ.Fields(0) & ")：" & CheckStr(RsQ.Fields(1)) & vbCrLf
            End If
         End If
         RsQ.Close
      End If
   Next ii
   
   Set RsQ = Nothing
End Function

'Modified by Morgan 2016/12/15 從basStart,aacc_start 移來
'Add By Sindy 2010/10/1
Public Sub CheckExeFileDateTime()
Dim MyPath As String
Dim MyName As String
Dim lpReOpenBuff As OFSTRUCT
Dim FileHandle As Long
Dim FileInfo As BY_HANDLE_FILE_INFORMATION
Dim tZone As TIME_ZONE_INFORMATION
Dim bias As Long
Dim ft As SYSTEMTIME
Dim tmpDate As Date
Dim tmpI As Integer
Dim tmpFileList() As String
Dim ArrFileStr As Variant
Dim strFL03 As String
Dim strContent As String
Dim CompDate As Date
Dim mailYes As Boolean  '2010/10/11 add by sonia
Dim StrSQLa As String
Dim strFilelistDate As String 'Added by Morgan 2016/12/15
Dim intA As Integer, rsAD As New ADODB.Recordset  'Added by Lydia 2024/05/15

On Error GoTo ErrHand
   
   mailYes = False
   'Modify By Sindy 2016/10/24 過版程式已改寫，同時上傳各分所FTP-Server了，所以不用限制時間==>105/10/28 取消,還是要鎖下午4點
   If ServerTime < "160000" Then
      MyPath = App.path & "\"
      If InStr(UCase(Pub_GetModuleFileName), "VB6.EXE") <> 0 Then
         MyName = "te" & App.EXEName & ".exe"
      Else
         MyName = App.EXEName & ".exe"
      End If
      '取得Server執行檔產生時間
      StrSQLa = "SELECT to_char(fl03) FROM filelist WHERE upper(fl01)='" & UCase(MyName) & "' "
      intA = 1
      Set rsAD = ClsLawReadRstMsg(intA, StrSQLa)
      If intA = 1 Then
         strFL03 = "" & Trim(rsAD(0))
      End If
      If strFL03 <> "" And FileExists(MyPath & MyName) = True Then
         CompDate = CDate(Left(strFL03, 4) & "-" & Mid(strFL03, 5, 2) & "-" & Mid(strFL03, 7, 2) & " " & Mid(strFL03, 9, 2) & ":" & Mid(strFL03, 11, 2) & ":" & Right(strFL03, 2))
         CompDate = DateAdd("n", -1, CompDate)
         '取得Client執行檔產生時間
         FileHandle = OpenFile(MyPath & MyName, lpReOpenBuff, OF_READ)
         GetFileInformationByHandle FileHandle, FileInfo
         CloseHandle FileHandle
         Call GetTimeZoneInformation(tZone)
         bias = tZone.bias
         FileTimeToSystemTime FileInfo.ftLastWriteTime, ft
         tmpDate = CDate(ft.wYear & "-" & ft.wMonth & "-" & ft.wDay & " " & ft.wHour & ":" & ft.wMinute & ":" & ft.wSecond) - TimeSerial(0, bias, 0)
         If Format(tmpDate, "YYYYMMDDHHmmss") < Format(CompDate, "YYYYMMDDHHmmss") Then
'Modified by Morgan 2018/8/27 改都要發Mail(FTP已改為同步更新且多人系統也已不再使用)
'            'Modify By Sindy 2011/2/21
'            If ChkWorkDay(strSrvDate(1)) = True Then
'            '2011/2/21 End
'               '2010/10/11 add by sonia 若server版本是下午16:00以後的,北所一律發信,分所只判斷日期
'               If Mid(Format(CompDate, "YYYYMMDDHHmmss"), 9) > "160000" Then
'                  'Modify by Morgan 2011/5/30 改 16:00 以後都判斷日期不同才發信(多人系統很容易有人在使用中而不更新)
'                  'If pub_strUserOffice = "1" Then
'                  '   mailYes = True
'                  'ElseIf Left(Format(tmpDate, "YYYYMMDDHHmmss"), 8) <> Left(Format(CompDate, "YYYYMMDDHHmmss"), 8) Then
'                  '   mailYes = True
'                  'End If
'                  If Left(Format(tmpDate, "YYYYMMDDHHmmss"), 8) <> Left(Format(CompDate, "YYYYMMDDHHmmss"), 8) Then
'                     mailYes = True
'                  End If
'                  'end 2011/5/30
'               Else
'               '2010/10/11 end
'                  mailYes = True
'               End If
'            End If
            mailYes = True
'end 2018/8/27
         End If
      End If
   End If
    
   '2010/10/11 add by sonia 由上面改下來一起發
   If mailYes = True Then
      'Added by Morgan 2016/12/15
      '取得 filelist.lst 產生時間
      FileHandle = OpenFile(MyPath & "filelist.lst", lpReOpenBuff, OF_READ)
      If FileHandle > 0 Then
         GetFileInformationByHandle FileHandle, FileInfo
         CloseHandle FileHandle
         Call GetTimeZoneInformation(tZone)
         bias = tZone.bias
         FileTimeToSystemTime FileInfo.ftLastWriteTime, ft
         'Modified by Morgan 2017/1/9
         'strFilelistDate = CDate(ft.wYear & "-" & ft.wMonth & "-" & ft.wDay & " " & ft.wHour & ":" & ft.wMinute & ":" & ft.wSecond) - TimeSerial(0, bias, 0)
         strFilelistDate = Format(CDate(ft.wYear & "-" & ft.wMonth & "-" & ft.wDay & " " & ft.wHour & ":" & ft.wMinute & ":" & ft.wSecond) - TimeSerial(0, bias, 0), "YYYY/MM/DD HH:mm:ss")
      Else
         strFilelistDate = "無法取得！"
      End If
      'end 2016/12/15
      strContent = "Dear Sirs," & vbCrLf & vbCrLf & _
                        "執行檔名稱：" & MyName & " 時間比對不一致" & vbCrLf & vbCrLf & _
                        "Client：" & Format(tmpDate, "YYYY/MM/DD　HH:mm:ss") & vbCrLf & vbCrLf & _
                        "Server：" & Format(CompDate, "YYYY/MM/DD　HH:mm:ss") & vbCrLf & vbCrLf & _
                        "FileList：" & Replace(strFilelistDate, " ", "　") & vbCrLf & vbCrLf & _
                        "使用者所別：" & IIf(pub_strUserOffice = "1", "北所", IIf(pub_strUserOffice = "2", "中所", IIf(pub_strUserOffice = "3", "南所", IIf(pub_strUserOffice = "4", "高所", pub_strUserOffice)))) & vbCrLf & vbCrLf & _
                        "Ip Address：" & GetLocalIP & vbCrLf & vbCrLf & _
                        "電腦　名稱：" & PUB_ReadHostName & vbCrLf
      'Modify By Sindy 2023/7/25 改抓 Pub_GetSpecMan("程式管理人員") & ";" & GetDeptMan("M51")
      PUB_SendMail strUserNum, Pub_GetSpecMan("程式管理人員") & ";" & GetDeptMan("M51"), "", "使用者執行檔版本錯誤", strContent, , , , , , , , , , , False
   End If
   '2010/10/11 end
    Set rsAD = Nothing 'Added by Lydia 2024/05/15
    
ErrHand:
   
   If Err.Number <> 0 Then
      WLog Err.Description
   End If
   
End Sub

'cancel by sonia 2019/4/18
''Add by Amy 2016/12/29
''傳入員編若為系統特殊人員 MCTF0X人員,則回傳其oCode
'Public Function GetMCTF0XCode(stID As String) As String
'    Dim RsQ As New ADODB.Recordset
'    Dim strQ As String
'
'    GetMCTF0XCode = ""
'
'    strQ = "Select Distinct oCode From setSpecMan Where InStr(oMan,'" & stID & "')>0 And SubStr(oCode,1,4)='MCTF' "
'
'    RsQ.CursorLocation = adUseClient
'    RsQ.Open strQ, cnnConnection, adOpenStatic, adLockReadOnly
'    If RsQ.RecordCount <> 0 And RsQ.RecordCount > 0 Then
'        GetMCTF0XCode = "" & RsQ.Fields("oCode")
'    End If
'    RsQ.Close
'End Function
'end 2019/4/18

'add by sonia 2019/3/15
'傳入屬於MCTF0X小組人員之員工編號,回傳其所屬所有oCode,因為MCTF01及MCTF04都有鄭天雲A4021
Public Function GetMCTF0XAllCode(stID As String) As String
Dim RsQ As New ADODB.Recordset
Dim strQ As String
    
   GetMCTF0XAllCode = ""
   
   strQ = "Select Distinct oCode From setSpecMan Where InStr(oMan,'" & stID & "')>0 And SubStr(oCode,1,4)='MCTF' "
   
   RsQ.CursorLocation = adUseClient
   RsQ.Open strQ, cnnConnection, adOpenStatic, adLockReadOnly
   If RsQ.RecordCount <> 0 And RsQ.RecordCount > 0 Then
      Do While RsQ.EOF = False
         If GetMCTF0XAllCode = "" Then
            GetMCTF0XAllCode = "" & Left(RsQ.Fields("oCode"), 6) 'Modify By Sindy 2021/11/24
         Else
            GetMCTF0XAllCode = GetMCTF0XAllCode & "','" & Left(RsQ.Fields("oCode"), 6) 'Modify By Sindy 2021/11/24
         End If
         RsQ.MoveNext
      Loop
   End If
   RsQ.Close
End Function
'end 2019/3/15

'傳入客戶編號判斷cu13是否與傳入員編為同一業務區(含MCFT0X判斷)
'modify by sonia 2021/11/25 +本所案號及FC代理人(MCTF案以FC代理人判斷)
'Modified by Lydia 2022/09/20 stCusNo, stUser 設定為byVal
'Modify By Sindy 2023/2/2 回傳抓到的智權人員:Optional ByRef stCu12 As String, Optional ByRef stCU13 As String
Public Function ChkSameCuArea(ByVal stCusNo As String, ByVal stUser As String, _
   Optional ByRef pCP01 As String, Optional ByRef pCP02 As String, Optional ByRef pCP03 As String, Optional ByRef pCP04 As String, _
   Optional ByRef pFaNo As String, Optional ByRef stCu12 As String, Optional ByRef stCU13 As String) As Boolean
'Dim stCu12 As String, stCU13 As String
Dim stST15 As String
'add by sonia 2021/11/25
Dim StrSQLa As String
Dim rsA As New ADODB.Recordset
'end 2021/11/25
    
    ChkSameCuArea = False
    'Add by Amy 2017/01/04
    'Modify by Amy 2021/12/22 +Trim(pFaNo)為空
    If (Trim(stCusNo) = MsgText(601) And Trim(pFaNo) = MsgText(601)) Or Trim(stUser) = MsgText(601) Then Exit Function
    stCusNo = GetNewFagent(stCusNo)
    'end 2017/01/04
    
    stCu12 = GetCuSales(stCusNo, stCU13)
   'add by sonia 2021/12/13 先檢查否則非MCT之客戶就不能共用，T-237214
   'modify by Sindy 2023/2/15 +Left(GetStaffDepartment(stUser), 2) = "P2"條件
   'modify by sonia 必須客戶檔也是MCT客戶才做此段，否則MCT人員收文T-245735(客戶智權人員為丁浚評)則不會發郵件通知
   'If pFaNo <> "" And Left(GetStaffDepartment(stUser), 2) = "P2" Then
   If pFaNo <> "" And Left(GetStaffDepartment(stUser), 2) = "P2" And Left(stCu12, 2) = "P2" Then
       pFaNo = Left(pFaNo & "000000000", 9) '補滿9碼
       StrSQLa = "Select fa120 From fagent Where fa01='" & Left(pFaNo, 8) & "' AND fa02='0' "
       If rsA.State <> adStateClosed Then rsA.Close
       Set rsA = Nothing
       rsA.CursorLocation = adUseClient
       rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
       'Modify By Sindy 2023/2/3 因要回傳智權人員資料 + And "" & rsA.Fields(0).Value <> ""
       If rsA.RecordCount > 0 And "" & rsA.Fields(0).Value <> "" Then
          stCU13 = "" & rsA.Fields(0).Value
          stCu12 = GetSalesArea(stCU13) 'Add By Sindy 2023/2/2
       End If
       If rsA.State <> adStateClosed Then rsA.Close
       Set rsA = Nothing
   End If
   'end 2021/12/13
    'modify by sonia 2021/12/29 +Left(GetStaffDepartment(stUser), 2) = "P2"條件
    'If Left(stCU13, 4) = "MCTF" Then
    If Left(stCU13, 4) = "MCTF" And Left(GetStaffDepartment(stUser), 2) = "P2" Then
        'modify by sonia 2019/3/11 改反向檢查,因為MCTF01及MCTF04都有鄭天雲A4021
        'If GetMCTF0XCode(stUser) = stCU13 Then ChkSameCuArea = True
        '2021/11/25 add by sonia 無pFaNo抓案件之FC代理人
        If pFaNo = "" Then
            StrSQLa = "Select pa75 From Patent Where pa01='" & pCP01 & "' AND pa02='" & pCP02 & "' AND pa03='" & pCP03 & "'AND pa04='" & pCP04 & "' " & _
                     "union Select tm44 From trademark Where tm01='" & pCP01 & "' AND tm02='" & pCP02 & "' AND tm03='" & pCP03 & "'AND tm04='" & pCP04 & "' " & _
                     "union Select sp26 From ServicePractice Where sp01='" & pCP01 & "' AND sp02='" & pCP02 & "' AND sp03='" & pCP03 & "'AND sp04='" & pCP04 & "' " & _
                     "union Select lc22 From lawcase Where lc01='" & pCP01 & "' AND lc02='" & pCP02 & "' AND lc03='" & pCP03 & "'AND lc04='" & pCP04 & "' "
            If rsA.State <> adStateClosed Then rsA.Close
            Set rsA = Nothing
            rsA.CursorLocation = adUseClient
            rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
            If rsA.RecordCount > 0 Then
               pFaNo = "" & rsA.Fields(0).Value
            End If
            If rsA.State <> adStateClosed Then rsA.Close
            Set rsA = Nothing
        End If
        If pFaNo <> "" Then
            pFaNo = Left(pFaNo & "000000000", 9) '補滿9碼
            StrSQLa = "Select fa120 From fagent Where fa01='" & Left(pFaNo, 8) & "' AND fa02='0' "
            If rsA.State <> adStateClosed Then rsA.Close
            Set rsA = Nothing
            rsA.CursorLocation = adUseClient
            rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
            'Modify By Sindy 2023/2/3 因要回傳智權人員資料 + And "" & rsA.Fields(0).Value <> ""
            If rsA.RecordCount > 0 And "" & rsA.Fields(0).Value <> "" Then
               stCU13 = "" & rsA.Fields(0).Value
               stCu12 = GetSalesArea(stCU13) 'Add By Sindy 2023/2/2
            End If
            If rsA.State <> adStateClosed Then rsA.Close
            Set rsA = Nothing
        End If
        'end 2021/11/25
        If ChkMCTF0XSales(stCU13, stUser) = True Then ChkSameCuArea = True
    ElseIf stCu12 = GetST15(stUser) Then
        ChkSameCuArea = True
    End If
End Function
'end 2016/12/29

'add by sonia 2019/3/8
'傳入MCTF0X及收文人員,檢查系統特殊設定人員是否為該組人員收文
Public Function ChkMCTF0XSales(stCU13 As String, stSales As String) As Boolean
Dim RsQ As New ADODB.Recordset
Dim strQ As String
    
   ChkMCTF0XSales = False
   strQ = "Select * From setSpecMan Where oCode='" & stCU13 & "' and InStr(oMan,'" & stSales & "')>0 "
   RsQ.CursorLocation = adUseClient
   RsQ.Open strQ, cnnConnection, adOpenStatic, adLockReadOnly
   If RsQ.RecordCount <> 0 And RsQ.RecordCount > 0 Then
      ChkMCTF0XSales = True
   End If
   RsQ.Close
End Function
'end 2019/3/8

'Add by Amy 2017/01/06 傳入客戶or代理人編號抓取相關資料
Public Function GetCusORFagentData(ByVal strNo As String, ByVal stField As String, ByRef stData() As String) As Boolean
    Dim strQ As String, RsQ As New ADODB.Recordset
    Dim ii As Integer
 
On Error GoTo ErrHand
    GetCusORFagentData = False
    
    For ii = 0 To UBound(stData)
        stData(ii) = ""
    Next ii
    
    strNo = ChangeCustomerL(strNo)
    If Left(strNo, 1) = 客戶編號 Then
        strQ = "Select " & stField & _
                  " From Customer Where cu01='" & Left(strNo, 8) & "' and cu02='" & Right(strNo, 1) & "'"
    ElseIf Left(strNo, 1) = 代理人編號 Then
        strQ = "Select " & stField & _
                  " From Fagent Where fa01='" & Left(strNo, 8) & "' and fa02='" & Right(strNo, 1) & "'"
    Else
        Exit Function
    End If
    RsQ.CursorLocation = adUseClient
    RsQ.Open strQ, cnnConnection
    If RsQ.RecordCount > 0 Then
        For ii = 0 To UBound(stData)
            stData(ii) = "" & RsQ.Fields(ii)
        Next ii
        GetCusORFagentData = True
    End If
    RsQ.Close
    Exit Function
    
ErrHand:
    MsgBox Err.Description
End Function

'Added by Lydia 2017/01/12 傳入本所案號,若為集體設計案之母案,傳出子案資料的語法
Public Function Pub_GetCFPQuery105(ByVal pCP01 As String, ByVal pCP02 As String, ByVal pCP03 As String, ByVal pCP04 As String) As String
   Pub_GetCFPQuery105 = "select cp01,cp02,cp03,cp04,cp09 from caseprogress,patent where cp01='" & pCP01 & "' and cp02='" & pCP02 & "' and cp04='" & pCP04 & "' " & _
                       "and cp159=0 and cp158>0 and cp10='105' and pa01(+)=cp01 and pa02(+)=cp02 and pa03(+)=cp03 and pa04(+)=cp04 and pa57 is null " & _
                       "and (cp01,cp02) in (select b.pa01,b.pa02 from patent b where b.pa01=cp01 and b.pa02=cp02 and b.pa08='3' and b.pa03='0' and b.pa57 is null ) " & _
                       "order by cp03 "
End Function

'Add by Amy 2017/03/10 T字頭案件且申請國家為台灣且為商標處(P2字頭)且非巨京(96030/96029)之客戶,更新客戶智權人員為MCTF
'm_SysKind:系統別/m_FaNo: 代理人/m_Nation:申請國家
'm_Apply():申請人
'm_St03:收文業務區
'bolUpd:回傳是否有更新客戶檔 'Add by Amy 2017/03/15
'stMsg:回傳錯誤訊息 'Add by Amy 2019/06/26
Public Function UpdMCTF_Cu13(ByVal m_SysKind As String, ByVal m_FaNo As String, ByVal m_Nation As String, ByRef stApply As Variant, Optional ByVal m_ST03 As String = "", Optional ByRef bolUpd As Boolean = False, _
                                                    Optional ByRef stMsg As String = "") As Boolean
    Dim i As Integer
    Dim bolData As Boolean
    Dim strUpd As String
    Dim stFaData(0) As String, stCuData(1) As String
    Dim bolMsg As Boolean 'Add by Amy 2019/06/26
    
On Error GoTo ErrHand

    UpdMCTF_Cu13 = False
    'Add by Amy 2019/06/26
    If stMsg <> MsgText(601) Then
        bolMsg = True
        stMsg = ""
    End If
    'Modify by Amy 2017/03/22 拿掉 And m_Nation = "000" 申請國家為台灣之判斷 (X39289040 為MCTF但要收申請國家為大陸的案件)
    'Modify by Amy 2018/08/08 原:T字頭,改為系統別有T的案件 ex:CFT-019873
    'Modify by Amy 2018/10/15 因外法使用,拿掉系統別 原: InStr(m_SysKind, "T") > 0
    If m_FaNo <> MsgText(601) And Trim(stApply(0)) <> MsgText(601) Then
        'Modify by Amy 2018/10/15 因外法使用加系統別(商標需為P2部門)
        If m_ST03 = MsgText(601) Or (InStr(m_SysKind, "T") > 0 And Left(m_ST03, 2) = "P2") Then
            bolData = GetCusORFagentData(m_FaNo, "FA120", stFaData())
            If stFaData(0) <> MsgText(601) And Left(stFaData(0), 4) = "MCTF" Then
                For i = LBound(stApply) To UBound(stApply)
                    bolData = GetCusORFagentData(stApply(i), "CU12,CU13", stCuData())
                    '代理人管控智權人員與客戶檔智權人員不同,非巨京且業務區為P2開頭,才更新客戶智權人員
                    'Modify by Amy 2017/03/21 原判斷有收文業務區判斷收文業務區,無則判斷客戶業務區 改 客戶檔業務區為P2開頭,才更新客戶智權人員
                    'Modify by Amy 2017/03/24 +客戶已是MCTF也更新 ex:106/03/24 改 Y49031010 為MCTF03 但客戶X58262已於106/02/23 先改為 MCTF03 故T-156006/007下一程序不會更新
                    'Modify by Amy 2018/10/15 因外法使用加系統別(商標需為P2部門)
                    If (stFaData(0) <> stCuData(1) Or Left(stCuData(1), 4) = "MCTF") And stCuData(1) <> "96030" And stCuData(1) <> "96029" And ((InStr(m_SysKind, "T") > 0 And Left(stCuData(0), 2) = "P2") Or InStr(m_SysKind, "T") = 0) Then
                        If stFaData(0) <> stCuData(1) Then
                            strUpd = "Update Customer Set CU12='" & ChgSQL(PUB_GetST03(stFaData(0))) & "', CU13='" & ChgSQL(stFaData(0)) & "' " & _
                                        "Where CU01='" & Mid(stApply(i), 1, 8) & "' And CU02='" & Mid(stApply(i), 9, 1) & "' "
                            Pub_SeekTbLog strUpd
                            cnnConnection.Execute strUpd
                        End If
                        bolUpd = True 'Add by Amy 2017/03/15
                    End If
                Next i
            End If
        
        End If
    End If
    UpdMCTF_Cu13 = True
    Exit Function
    
ErrHand:
    UpdMCTF_Cu13 = False
    If bolMsg = True Then stMsg = Err.Description 'Add by Amy 2019/06/26
End Function

'Modify by Amy 2017/03/15 +stCaseNo本所案號(無符號)
'Modify by Amy 2019/06/26 +stMsg
Public Function UpdMCTF_NP(ByVal stFaNo As String, ByVal stFa120 As String, Optional ByVal stCaseNo As String = "", Optional ByRef stMsg As String = "")
    Dim ii As Integer
    Dim bolData As Boolean
    Dim RsQ As New ADODB.Recordset, RsN As New ADODB.Recordset
    Dim strQ As String, stUpd As String, stAllApp As String
    Dim stApply As Variant, stTranP As Variant
    'Modify by Amy 2017/03/15
    Dim bolUpdCus As Boolean '是否有更新客戶檔
    Dim strWhereT As String, strWhereS As String
    Dim bolMsg As Boolean 'Add by Amy 2019/06/26
    
  On Error GoTo ErrHand
    
    'Add by Amy 2019/06/26
    If stMsg <> MsgText(601) Then
        bolMsg = True
        stMsg = ""
    End If
    
    If stCaseNo <> MsgText(601) Then
        strWhereT = " And TM01='" & Mid(stCaseNo, 1, Len(stCaseNo) - 9) & "' And TM02='" & Mid(stCaseNo, (Len(stCaseNo) - 9) + 1, 6) & _
                            "' And TM03='" & Mid(stCaseNo, (Len(stCaseNo) - 3) + 1, 1) & "' And TM04='" & Mid(stCaseNo, (Len(stCaseNo) - 2) + 1, 2) & "' "
        strWhereS = " And SP01='" & Mid(stCaseNo, 1, Len(stCaseNo) - 9) & "' And SP02='" & Mid(stCaseNo, (Len(stCaseNo) - 9) + 1, 6) & _
                            "' And SP03='" & Mid(stCaseNo, (Len(stCaseNo) - 3) + 1, 1) & "' And SP04='" & Mid(stCaseNo, (Len(stCaseNo) - 2) + 1, 2) & "' "
    Else
        strWhereT = "  And TM44='" & stFaNo & "' And TM44 is not Null"
        strWhereS = "  And SP26='" & stFaNo & "' And SP26 is not Null"
    End If
    '抓商標基本檔及服務業務基本檔之FC代理人(T字頭案件且申請國家為台灣)
    'Modify by Amy 2017/03/22 拿掉申請國家為台灣之判斷 (X39289040 為MCTF但要收申請國家為大陸的案件)
    'strQ = "Select Distinct TM01 as SysKind,TM02 as C2,TM03 as C3,TM04 as C4,TM23 as A1,TM78 as A2,TM79 as A3,TM80 as A4,TM81 as A5,CP55 as P1,CP93 as P2,CP94 as P3,CP95 as P4,CP96 as P5 " & _
                    "From TradeMark,CaseProgress Where SubStr(TM01,1,1)='T' And TM10='000' And TM01=CP01(+) And TM02=CP02(+) And TM03=CP03(+) And TM04=CP04(+) " & strWhereT & _
                " Union Select Distinct SP01 as SysKind,SP02 as C2,SP03 as C3,SP04 as C4,SP08 as A1,SP58 as A2,SP59 as A3,SP65 as A4,SP66 as A5,CP55 as P1,CP93 as P2,CP94 as P3,CP95 as P4,CP96 as P5 " & _
                    "From ServicePractice,CaseProgress Where SubStr(SP01,1,1)='T' And SP09='000' And SP08 is not null And SP01=CP01(+) And SP02=CP02(+) And SP03=CP03(+) And SP04=CP04(+) " & strWhereS
    'Modify by Amy 2018/08/08 原抓T字頭,改抓有系統別有T的案件 ex:X79362 T-214593
    strQ = "Select Distinct TM01 as SysKind,TM02 as C2,TM03 as C3,TM04 as C4,TM23 as A1,TM78 as A2,TM79 as A3,TM80 as A4,TM81 as A5,CP55 as P1,CP93 as P2,CP94 as P3,CP95 as P4,CP96 as P5 " & _
                    "From TradeMark,CaseProgress Where InStr(TM01,'T')>0 And TM01=CP01(+) And TM02=CP02(+) And TM03=CP03(+) And TM04=CP04(+) " & strWhereT & _
                " Union Select Distinct SP01 as SysKind,SP02 as C2,SP03 as C3,SP04 as C4,SP08 as A1,SP58 as A2,SP59 as A3,SP65 as A4,SP66 as A5,CP55 as P1,CP93 as P2,CP94 as P3,CP95 as P4,CP96 as P5 " & _
                    "From ServicePractice,CaseProgress Where InStr(SP01,'T')>0 And SP08 is not null And SP01=CP01(+) And SP02=CP02(+) And SP03=CP03(+) And SP04=CP04(+) " & strWhereS
    If RsQ.State <> adStateClosed Then RsQ.Close
    RsQ.CursorLocation = adUseClient
    RsQ.Open strQ, cnnConnection, adOpenStatic, adLockReadOnly
    With RsQ
        If .RecordCount > 0 Then
            .MoveFirst
            Do While .EOF = False
                '組申請人1~5
                For ii = 1 To 5
                    If IsNull(.Fields("A" & ii)) = True Then
                        Exit For
                    Else
                        stAllApp = stAllApp & "," & .Fields("A" & ii)
                    End If
                Next ii
                If stAllApp <> MsgText(601) Then
                    stApply = Split(Mid(stAllApp, 2), ",")
                    '更新客戶檔智權人員(申請人)
                    If UpdMCTF_Cu13(.Fields("SysKind"), stFaNo, "000", stApply, , bolUpdCus) = False Then GoTo ErrHand
                End If
                'Modify by Amy 2017/03/15 +if 個案不需更新移轉人/讓與人
                If stCaseNo = MsgText(601) Then
                    '組移轉人/讓與人
                    stAllApp = ""
                    For ii = 1 To 5
                        If IsNull(.Fields("P" & ii)) = True Then
                            Exit For
                        Else
                            stAllApp = stAllApp & "," & .Fields("P" & ii)
                        End If
                    Next ii
                    If stAllApp <> MsgText(601) Then
                        stTranP = Split(Mid(stAllApp, 2), ",")
                        '更新客戶檔智權人員(移轉人/讓與人)
                        If UpdMCTF_Cu13(.Fields("SysKind"), stFaNo, "000", stTranP, , bolUpdCus) = False Then GoTo ErrHand
                    End If
                End If
                
                'If bolUpdCus = True Then   'cancel by sonia 2023/10/23 否則申請人非MCTF的案件不會更新下一程序期限
                    '抓案件下一程序未續辦,更新智權人員(strNpSqlOfNoSalesDuty)及管制期限(未更新才需更新)
                    strQ = "Select  NP01,NP07, NP10,NP22 From NextProgress Where NP06 Is Null " & _
                            "And NP02='" & .Fields("SysKind") & "' And NP03='" & .Fields("C2") & "' And NP04='" & .Fields("C3") & "' And NP05='" & .Fields("C4") & "' "
                    If RsN.State <> adStateClosed Then RsN.Close
                    RsN.CursorLocation = adUseClient
                    RsN.Open strQ, cnnConnection, adOpenStatic, adLockReadOnly
                    If RsN.RecordCount > 0 Then
                        Do While RsN.EOF = False
                            stUpd = "Update Nextprogress Set NP10='" & stFa120 & "' Where NP01='" & RsN.Fields("NP01") & "' And NP07='" & RsN.Fields("NP07") & "' And NP22=" & RsN.Fields("NP22") & strNpSqlOfNoSalesDuty
                            cnnConnection.Execute "begin user_data.user_notrigger:=1; end;" '控制來函期限通知的 Trigger 不被觸發
                            cnnConnection.Execute stUpd
                            cnnConnection.Execute "begin user_data.user_notrigger:=0; end;"
                            RsN.MoveNext
                        Loop
                    End If
                'End If                     'cancel by sonia 2023/10/23
                'end 2017/03/15
                .MoveNext
            Loop
        End If
    End With
    'end 2017/03/15
    UpdMCTF_NP = True
    Exit Function
    
ErrHand:
    UpdMCTF_NP = False
    If bolMsg = True Then stMsg = Err.Description 'Add by  Amy 2019/06/26
End Function
'end 2017/03/10

'Add by Amy 2017/04/27 取得Acc0b1之Axb02或Axb03資料
'Modify by Amy 2017/09/14 加stAxb01參數
Public Function GetAxb0203(ByVal intChoose As Integer, Optional ByVal stAxb01 As String = "") As String
    Dim RsQ As New ADODB.Recordset
    Dim strQ As String
    Dim intQ As Integer
    Dim stWhere As String 'Add by Amy 2017/09/14
    
    GetAxb0203 = ""
    Select Case intChoose
        '最大筆Axb01之Axb02
        Case 1
            strQ = "Axb02"
        '最大筆Axb01之Axb03
        Case 2
            strQ = "Axb03"
    End Select
    
    'Modify by Amy 2017/09/14
    If stAxb01 <> MsgText(601) Then stWhere = "Where Axb01=" & Val(stAxb01)
    strQ = "Select " & strQ & " From Acc0B1 " & stWhere & " Order by Axb01 Desc "
    'end 2017/09/14
    intQ = 1
    Set RsQ = ClsLawReadRstMsg(intQ, strQ)
    If intQ = 1 Then
        GetAxb0203 = "" & RsQ.Fields(0)
    End If
    
    RsQ.Close
End Function

'Add By Sindy 2017/5/15 檢查收據抬頭是否存在
'Modify By Sindy 2019/9/18 + , Optional bolShowMsg As Boolean = True
Public Function PUB_ChkTitleNmExist(strTitle As String, Optional bolShowMsg As Boolean = True) As String
Dim strTmp As String, intA As Integer, rsAD As New ADODB.Recordset 'Added by Lydia 2024/05/15

   PUB_ChkTitleNmExist = ""
   strTmp = "select cu11,cu158" & _
            " From customer" & _
            " where (upper(cu04)=upper('" & ChgSQL(strTitle) & "') or upper(rtrim(cu05||' '||cu88||' '||cu89||' '||cu90))=upper('" & ChgSQL(strTitle) & "') or upper(cu06)=upper('" & ChgSQL(strTitle) & "'))" & _
            " and cu15<>'0'"
   intA = 1
   Set rsAD = ClsLawReadRstMsg(intA, strTmp)
   If intA = 1 Then
      'Add By Sindy 2019/9/18
      If "" & rsAD.Fields("cu11") = "" Then
         PUB_ChkTitleNmExist = "無統編"
         If "" & rsAD.Fields("cu158") = "" And bolShowMsg = True Then
            MsgBox "此收據抬頭，沒有統編，請檢查是否為境外公司!!", vbInformation
         End If
      Else
      '2019/9/18 END
         PUB_ChkTitleNmExist = "" & rsAD.Fields("cu11")
      End If
   Else
      '若A4202='04150022'者視為空值
      'and A4202<>'04150022'==>and (A4202<>'04150022' or A4202 is null) 改語法不然抓不到資料
      'Modify By Sindy 2020/11/11 + ,a4219
      strTmp = "select a4202,a4216,a4219" & _
               " From acc420" & _
               " where upper(a4201)=upper('" & ChgSQL(strTitle) & "') and (A4202<>'04150022' or A4202 is null)"
      intA = 1
      Set rsAD = ClsLawReadRstMsg(intA, strTmp)
      If intA = 1 Then
         'Add By Sindy 2019/9/18
         If "" & rsAD.Fields("a4202") = "" Then
            PUB_ChkTitleNmExist = "無統編"
            'Modify By Sindy 2020/11/11 + And "" & rsad.Fields("a4219") <> "0" :若判讀抬頭為個人(含特殊收據抬頭) 請略過本訊息不要提醒沒有統編
            If ("" & rsAD.Fields("a4216") = "" And bolShowMsg = True) And _
               "" & rsAD.Fields("a4219") <> "0" Then
               MsgBox "此收據抬頭，沒有統編，請檢查是否為境外公司!!", vbInformation
            End If
         Else
         ''2019/9/18 END
            PUB_ChkTitleNmExist = "" & rsAD.Fields("a4202")
         End If
      Else
         strTmp = "select cu11,cu158" & _
                  " From customer" & _
                  " where (upper(cu04)=upper('" & ChgSQL(strTitle) & "') or upper(rtrim(cu05||' '||cu88||' '||cu89||' '||cu90))=upper('" & ChgSQL(strTitle) & "') or upper(cu06)=upper('" & ChgSQL(strTitle) & "'))"
         intA = 1
         Set rsAD = ClsLawReadRstMsg(intA, strTmp)
         If intA = 0 Then
            MsgBox "此為新的收據抬頭，請聯絡智權同仁提供基本資料以利建檔!!", vbInformation
         'Add By Sindy 2019/9/17
         Else
            'Add By Sindy 2019/9/18
            If "" & rsAD.Fields("cu11") = "" Then
               PUB_ChkTitleNmExist = "無統編"
               '公司才需要彈此訊息
'               If "" & rsad.Fields("cu158") = "" And bolShowMsg = True Then
'                  MsgBox "此收據抬頭，沒有統編，請檢查是否為境外公司!!", vbInformation
'               End If
            Else
            '2019/9/18 END
               PUB_ChkTitleNmExist = "" & rsAD.Fields("cu11")
            End If
         '2019/9/17 END
         End If
      End If
   End If
   Set rsAD = Nothing 'Added by Lydia 2024/05/15
End Function

'Add by Amy 2017/09/22 判斷自動轉傳票資料是否更新
'intChoose:1-實績/2-結餘/3-實績轉撥/4-結餘轉撥
Public Function bolAutoVoucherNS(ByVal intChoose As Integer, ByVal stYearMon As String, ByVal stAxb_S As String, Optional ByVal stAxb_E As String = "") As Boolean
    Dim rsTmp As New ADODB.Recordset
    Dim intQ As Integer
    Dim stQ As String, stField As String, stWhere As String
    Dim stSPDT As String
    
    bolAutoVoucherNS = False
    
    'Modify by Amy 2018/06/13 時間可能5碼造成判斷錯誤
    Select Case intChoose
        Case 1 '實績
            stField = "SP17-19110000||Decode(length(SP18),5,'0'||SP18,SP18)"
            stWhere = "And A0202>='" & stAxb_S & "' And A0202<='" & stAxb_E & "' "
        Case 2 '結餘
            stField = "SP38-19110000||Decode(length(SP39),5,'0'||SP39,SP39)"
            stWhere = "And A0202>='" & stAxb_S & "' And A0202<='" & stAxb_E & "' "
        Case 3 '實績轉撥
            stField = "SP22-19110000||Decode(length(SP23),5,'0'||SP23,SP23)"
            stWhere = "And A0202='" & stAxb_S & "' "
        Case 4 '結餘轉撥
            stField = "SP43-19110000||Decode(length(SP44),5,'0'||SP44,SP44)"
            stWhere = "And A0202='" & stAxb_S & "' "
    End Select
    
    stQ = "Select Max(" & stField & ") as DT From SalesPoint " & _
          "Where SP01=" & stYearMon + 191100 & " Having Max(" & stField & ") is not null"
    intQ = 1
    Set rsTmp = ClsLawReadRstMsg(intQ, stQ)
    If intQ = 1 Then
        stSPDT = "" & rsTmp.Fields("DT")
    End If
    rsTmp.Close
    
    '判斷傳票修改日是否小於SalesPoint 總經理欄修改日
    stQ = "Select A0206||Decode(length(A0207),5,'0'||A0207,A0207) as DT From Acc020 Where A0201='1' " & stWhere & _
              "And A0206||Decode(length(A0207),5,'0'||A0207,A0207)<" & Val(stSPDT) & " And A0209||A0210 is null " & _
     "Union Select A0209||Decode(length(A0210),5,'0'||A0210,A0210) as DT From Acc020 Where A0201='1' " & stWhere & _
              "And A0209||Decode(length(A0210),5,'0'||A0210,A0210)<" & Val(stSPDT) & " And A0209||A0210 is not null "
    'end 2018/06/13
    
    intQ = 1
    Set rsTmp = ClsLawReadRstMsg(intQ, stQ)
    If intQ = 1 Then
        bolAutoVoucherNS = True
    End If
    rsTmp.Close
End Function

'*************************************************
'Add By Sindy 2016/11/28
'列印財務地址條
'*************************************************
Public Sub PUB_PrintAccAddress(strAddr As String, strCustName As String)
   Dim intCounter As Integer
   Dim intLine As Integer
   
   'XP自定紙張需手動設定並將印表機預設為該紙張
   '9x
   If pub_OS = "1" Then
      Printer.Height = 2880
      Printer.Width = 13000
   Else
      Printer.PaperSize = PUB_GetPaperSize(2)
   End If
   'Modified by Lydia 2022/02/11 因為無直式信封,所以改為橫式
   'Printer.Font = "@新細明體"
   Printer.Font = "新細明體"
   Printer.FontSize = 12
   
   '地址
   Printer.CurrentX = 100
   Printer.CurrentY = 300 + 2200 * intCounter
   If strAddr = "" Then
      Printer.Print ""
   Else
      '控制折行
      'PUB_PrintAddress strAddr, intCounter, 0
      PUB_PrintAddress strAddr, intCounter, intLine
   End If
   '收件人
   Printer.CurrentX = 100
   'Printer.CurrentY = 1000 + 2200 * intCounter
   Printer.CurrentY = 900 + 2200 * intCounter + 300 * intLine
   If strCustName = "" Then
      Printer.Print ""
   Else
      'Printer.Print "　　　" & strCustName & MsgText(104)
      '控制折行
      PUB_PrintAccTitle strCustName & MsgText(104), intCounter, intLine
   End If
   'Printer.NewPage
   
   Printer.Font = "新細明體"
   Printer.EndDoc
End Sub

'Add by Morgan 2005/9/28
'列印地址(控制跳行)
'p_Address:地址,p_iCounter:第幾張貼紙
Public Sub PUB_PrintAddress(ByVal p_Address As String, ByVal p_iCounter As Integer, ByRef p_iLine As Integer)
Dim strPTmp1 As String
   
   Const iWidth As Integer = 4560
   
   p_Address = Trim(p_Address)
   If Printer.TextWidth(p_Address) > iWidth Then
      strPTmp1 = ""
      Do While p_Address <> Empty
         If Printer.TextWidth(strPTmp1 & Left(p_Address, 1)) > iWidth Then
            Printer.CurrentX = 100
            Printer.CurrentY = 150 + 2200 * p_iCounter + 300 * p_iLine
            Printer.Print strPTmp1
            strPTmp1 = ""
            p_iLine = p_iLine + 1
         End If
         strPTmp1 = strPTmp1 & Left(p_Address, 1)
         p_Address = Mid(p_Address, 2)
      Loop
      If strPTmp1 <> "" Then
         Printer.CurrentX = 100
         Printer.CurrentY = 150 + 2200 * p_iCounter + 300 * p_iLine
         Printer.Print strPTmp1
      End If
   Else
      Printer.CurrentX = 100
      Printer.CurrentY = 150 + 2200 * p_iCounter + 300 * p_iLine
      Printer.Print p_Address
   End If
End Sub

'*************************************************
'Add By Sindy 2016/11/28
'列印收據抬頭(控制跳行)
'p_Title:收據抬頭,p_iCounter:第幾張貼紙
'*************************************************
Public Sub PUB_PrintAccTitle(ByVal p_Title As String, ByVal p_iCounter As Integer, ByRef p_iLine As Integer)
Dim strPTmp1 As String
Dim varTitle As Variant
Dim ii As Integer
   
   Const iWidth As Integer = 4560
   
   p_Title = Trim(p_Title)
   varTitle = Split(p_Title, "~")
   For ii = 0 To UBound(varTitle)
      p_Title = varTitle(ii)
      If Printer.TextWidth(p_Title) > iWidth Then
         strPTmp1 = ""
         Do While p_Title <> Empty
            If Printer.TextWidth(strPTmp1 & Left(p_Title, 1)) > iWidth Then
               Printer.CurrentX = 600 '100
               Printer.CurrentY = 900 + 2200 * p_iCounter + 300 * p_iLine
               Printer.Print strPTmp1
               strPTmp1 = ""
               p_iLine = p_iLine + 1
            End If
            strPTmp1 = strPTmp1 & Left(p_Title, 1)
            p_Title = Mid(p_Title, 2)
         Loop
         If strPTmp1 <> "" Then
            Printer.CurrentX = 600 '100
            Printer.CurrentY = 900 + 2200 * p_iCounter + 300 * p_iLine
            Printer.Print strPTmp1
         End If
      Else
         Printer.CurrentX = 600 '100
         Printer.CurrentY = 900 + 2200 * p_iCounter + 300 * p_iLine
         Printer.Print p_Title
         p_iLine = p_iLine + 1
      End If
   Next ii
End Sub

'Add by Amy 2017/10/12 自動產生傳票不可與傳票輸入程式同時操作
'Modify by Amy 2021/09/17 stExclude 排除表單名稱
'Modify by Amy 2021/09/22 bolShowMsg 顯示訊息
Public Function TranNoLock(ByVal stFormN As String, Optional ByVal stExclude As String = "", Optional ByVal bolShowMsg As Boolean = True) As Boolean
    Dim RsQ As New ADODB.Recordset
    Dim stQ As String, stMsg As String, stTmp As String
    Dim intQ As Integer
    Dim i As Integer, arrTmp 'Add by Amy 2021/09/17
    Dim stChkFormN As String 'Add by Amy 2023/04/11
    
    TranNoLock = False
    'Moidfy by Amy 2021/09/17 +stExclude
    If stExclude <> MsgText(601) Then
        If InStr(stExclude, ",") > 0 Then
            arrTmp = Split(stExclude, ",")
            For i = LBound(arrTmp) To UBound(arrTmp)
                 stQ = " And Upper(LR01)<>'" & UCase(arrTmp(i)) & "' "
            Next i
        Else
            stQ = " And Upper(LR01)<>'" & UCase(stExclude) & "' "
        End If
    End If
    'Modify by Amy 2021/09/22 +Frmacc41K0
    'Modify by Amy 2022/06/07 +Frmacc4350/Frmacc4170_1 避免傳票空號-秀玲
    'Modify by Amy 2023/04/11 +Frmacc41L0
    stChkFormN = "'FRMACC4120','FRMACC41G0','FRMACC41H0','FRMACC41J0','FRMACC41K0','FRMACC41L0','FRMACC4350','FRMACC4170_1'"
    stQ = "Select ST02,LR01 From LockRec,Staff " & _
          "Where Upper(LR01) In (" & stChkFormN & ") " & _
          stQ & "And st01(+)=LR02"
    'end 2021/09/17
    intQ = 1
    
    Set RsQ = ClsLawReadRstMsg(intQ, stQ)
    If intQ = 1 Then
        Do While Not RsQ.EOF
            stTmp = ""
            Select Case UCase(RsQ.Fields("LR01"))
                Case "FRMACC4120"
                    stTmp = "傳票輸入"
                'Add by Amy 2022/06/07
                Case "FRMACC4170_1"
                    stTmp = "每月固定傳票資料-非分攤"
                Case "FRMACC41G0"
                    stTmp = "智權期末實績保留傳票產生"
                Case "FRMACC41H0"
                    stTmp = "智權期末結餘保留傳票產生"
                Case "FRMACC41J0"
                    stTmp = "非當月結餘轉撥傳票產生(隱藏版人員)"
                'Add by Amy 2021/09/22
                Case "FRMACC41K0"
                    stTmp = "智權期末結餘保留資料刪除"
                'Add by Amy 2023/04/11 ACS待分潤
                Case "FRMACC41L0"
                    stTmp = "ACS待分潤"
                'Add by Amy 2022/06/07
                Case "FRMACC4350"
                    stTmp = "應收/付轉傳票作業"
            End Select
            stMsg = stMsg & "【" & stTmp & "】正被【" & RsQ.Fields("ST02") & "】使用中，請確認！" & vbCrLf
            RsQ.MoveNext
        Loop
        If stMsg <> MsgText(601) Then
            'Modify by Amy 2021/09/22 +bolShowMsg
            If bolShowMsg = True Then MsgBox stMsg
            Exit Function
        End If
    End If
    Call PUB_GetLock(stFormN, "")
    TranNoLock = True
End Function

'Move by Lydia 2017/10/18 抓員工的案件第一職代，若無改抓人事第一職代(從frm06010610移過來)
Public Function GetABS001_17(ByVal stUser As String) As String
Dim intB As Integer, rsBD As New ADODB.Recordset
    
    GetABS001_17 = ""
    If stUser = "" Then Exit Function
    
    strSql = "SELECT B0117 A01,S1.ST04 A02,B0102 B01,S2.ST04 B02 FROM ABS001,STAFF S1,STAFF S2 WHERE B0101='" & stUser & "' AND B0117=S1.ST01(+) AND B0102=S2.ST01(+) "
    intB = 1
    Set rsBD = ClsLawReadRstMsg(intB, strSql)
    If intB = 1 Then
        If "" & rsBD.Fields("A02") = "1" Then
            GetABS001_17 = "" & rsBD.Fields("A01")
        ElseIf "" & rsBD.Fields("B02") = "1" Then
            GetABS001_17 = "" & rsBD.Fields("B01")
        End If
    End If
    
    Set rsBD = Nothing
End Function

'Add by Amy 2017/11/13 傳入本所案號及案件性質,判斷此是否是未發文未取消收文之進度,並傳回本所期限/法定期限/總收文號/承辦人
Public Function ChkSameCaseProgress(ByVal stCP01 As String, ByVal stCP02 As String, ByVal stCP03 As String, ByVal stCP04 As String, ByVal stCP10 As String, _
                                    ByRef stCP06 As String, ByRef stCP07 As String, ByRef stCP09 As String, ByRef stCP14 As String) As Boolean
    Dim RsQ As New ADODB.Recordset
    Dim stQ As String
    Dim intQ As Integer
    
    ChkSameCaseProgress = False: stCP06 = "": stCP07 = "": stCP14 = ""
    stQ = "Select CP06,CP07,CP09,CP14 From CaseProgress " & _
          "Where CP01='" & stCP01 & "' And CP02='" & stCP02 & "' And CP03='" & stCP03 & "' And CP04='" & stCP04 & "' " & _
          "And CP10='" & stCP10 & "' And CP158=0 And CP159=0 "
    intQ = 1
    Set RsQ = ClsLawReadRstMsg(intQ, stQ)
    If intQ = 1 Then
        ChkSameCaseProgress = True
        stCP06 = "" & RsQ.Fields("CP06")
        stCP07 = "" & RsQ.Fields("CP07")
        stCP09 = "" & RsQ.Fields("CP09")
        stCP14 = "" & RsQ.Fields("CP14")
    End If
    RsQ.Close
End Function

'Add by Amy 2018/01/23 合約權限
'bolAssert:是否為維護權限
'Modify by Amy +參數 stCT05:C-國內機密/F-國外機密
Public Function ChkContractLimit(ByVal bolAssert As Boolean, Optional ByVal stCU01 As String = "", Optional ByVal bolMsg As Boolean = False _
        , Optional ByVal stCT05 As String = "") As Boolean
    Dim j As Integer, stTP As String, strMsg As String
    Dim stLimitNo As Variant
    Dim stLimitP As String, stA0908 As String, stSales As String 'Modify by Amy 2021/07/01 原:stA0909->stA0908
    
    ChkContractLimit = False
    '電腦中心
    If Pub_StrUserSt03 = "M51" Then ChkContractLimit = True: Exit Function
    
    '維護/查看權限
    '取得有frm075008此表單權限人員
    stLimitP = GetFormAssertP("frm075008")
    If bolAssert = True And stLimitP = MsgText(601) Then Exit Function
    
    If stLimitP <> MsgText(601) Then
        stLimitNo = Split(stLimitP, ",")
        '若操作人員為上述表單權限人員之職代則可維護
        For j = LBound(stLimitNo) To UBound(stLimitNo)
            If InStr(GetSOAgent(1, strUserNum), stLimitNo(j)) > 0 Then
                ChkContractLimit = True: Exit Function
            End If
        Next j
    End If
        
    '機密權限(查看)
    If bolAssert = False Then
        '系統特殊人員-總經理員編
        If InStr(Pub_GetSpecMan("總經理員工編號"), strUserNum) > 0 Then
            ChkContractLimit = True: Exit Function
        'add by sonia 2019/2/13 職稱-11(所長)
        ElseIf GetStaffST20(strUserNum) = "所長" Then
            ChkContractLimit = True: Exit Function
        'end 2019/2/13
        '員工等級-08(主秘)
        ElseIf PUB_GetST05(strUserNum) = "08" Then
            ChkContractLimit = True: Exit Function
        '員工部門-L01/L02/F31/P31
        'Modify By Sindy 2020/3/31 Pub_StrUserSt03 = "L01" Or Pub_StrUserSt03 = "L02" => Left(Pub_StrUserSt03, 1) = "L"
        ElseIf Left(Pub_StrUserSt03, 1) = "L" Or Pub_StrUserSt03 = "F31" Or Pub_StrUserSt03 = "P31" Then
            ChkContractLimit = True: Exit Function
        Else
            'Modify by Amy 2019/05/08 +if 因增加代理人合約
            If Left(stCU01, 1) = "X" Or stCT05 = "C" Then
                stA0908 = "Y" 'Modify by Amy 2021/07/01 原:stA0909->stA0908
                '目前智權人員及其主管
                'Modify by Amy 2021/07/01 原:stA0909->stA0908
                stTP = GetCuSales(stCU01, stSales, stA0908)
                If Left(stSales, 4) = "MCTF" Then
                    'modify by sonia 2019/3/15 改用ChkMCTF0XSales
                    'If GetMCTF0XCode(strUserNum) = stSales Or InStr(Pub_GetSpecMan("MCTM", False), strUserNum) > 0 Then
                    If ChkMCTF0XSales(stSales, strUserNum) = True Or InStr(Pub_GetSpecMan("MCTM", False), strUserNum) > 0 Then
                        ChkContractLimit = True: Exit Function
                    End If
                'Modify by Amy 2021/07/01 原:stA0909->stA0908
                ElseIf stSales = strUserNum Or stA0908 = strUserNum Then
                    ChkContractLimit = True: Exit Function
                End If
                
                '建立合約當下之智權人員及其主管
                'Modify by Amy 2021/07/01 原:stA0909->stA0908
                stSales = GetContractSales(stCU01, stA0908)
                If InStr(Left(stSales, 4), "MCTF") > 0 Then
                    'modify by sonia 2019/3/15 改用ChkMCTF0XSales
                    'If InStr(GetMCTF0XCode(strUserNum), stSales) Or InStr(Pub_GetSpecMan("MCTM", False), strUserNum) > 0 Then
                    If InStr(GetMCTF0XAllCode(strUserNum), stSales) Or InStr(Pub_GetSpecMan("MCTM", False), strUserNum) > 0 Then
                        ChkContractLimit = True: Exit Function
                    End If
                'Modify by Amy 2021/07/01 原:stA0909->stA0908
                ElseIf InStr(stSales, strUserNum) > 0 Or InStr(stA0908, strUserNum) > 0 Then
                    ChkContractLimit = True: Exit Function
                End If
            End If
            
            '國外機密(stCT05=F)
            '操作人員 員工部門(st03)為外專承辦(F23)或業務展處(F41)及其st52~55人員或等級(st05)為2字頭(外商承辦)但不是CFT+CFC承辦 可看
            If stCT05 = "F" Then
                If ChkContractLimit_Foreign(strUserNum) = True Then
                    ChkContractLimit = True: Exit Function
                End If
            End If
            'end 2019/05/08
        End If
    End If
    
    If bolMsg = True Then
        If bolAssert = True Then
            strMsg = "無此維護權限..."
        Else
            strMsg = "此為機密無權限可看..."
        End If
        MsgBox strMsg, , "警告!!"
    End If
End Function

'傳入表單取得何人有限權
Public Function GetFormAssertP(ByVal stFormName As String) As String
    Dim RsQ As New ADODB.Recordset
    Dim strQ As String, strSR01 As String
    Dim intQ As Integer
    
    GetFormAssertP = ""
    strQ = "Select SR01 From Staff_Right Where Upper(SR02)='" & UCase(stFormName) & "' "
    intQ = 1
    Set RsQ = ClsLawReadRstMsg(intQ, strQ)
    If intQ = 1 Then
        RsQ.MoveFirst
        Do While RsQ.EOF = False
            strSR01 = "," & RsQ.Fields("SR01")
            RsQ.MoveNext
        Loop
        GetFormAssertP = Mid(strSR01, 2)
    End If
    RsQ.Close
End Function

'傳入客戶編號或合約編號,傳回合約建立時之智權人員及其主管
'Modify by Amy 2021/07/01 stA0909變數改stA0908
Public Function GetContractSales(ByVal stNo As String, Optional ByRef stA0908 As String = "") As String
    Dim RsQ As New ADODB.Recordset
    Dim strQ As String, stKeyField As String
    Dim intQ As Integer
    
    'Modify by Amy 2021/07/01 stA0909->stA0908
    GetContractSales = "": stA0908 = ""
    If stNo = MsgText(601) Then Exit Function
    
    If stNo = "X" Then
        stKeyField = "CT01"
    Else
        stKeyField = "CT02"
    End If
    'Modify by Amy 2021/07/01 A0909->A0908
    strQ = "Select Distinct CT06,ST15,A0908 From Contract,Staff,Acc090 " & _
               "Where " & stKeyField & "='" & stNo & "' And CT06=ST01(+) And ST15=a0901(+)"
    intQ = 1
    Set RsQ = ClsLawReadRstMsg(intQ, strQ)
    If intQ = 1 Then
        RsQ.MoveFirst
        '同客戶編號多智權人員,組字串回傳
        Do While RsQ.EOF = False
            GetContractSales = GetContractSales & "," & RsQ.Fields("CT06")
            If "" & RsQ.Fields("A0908") <> MsgText(601) Then
                If InStr(stA0908, "" & RsQ.Fields("A0908")) = 0 Then
                    stA0908 = stA0908 & "," & RsQ.Fields("A0908")
                End If
            End If
            RsQ.MoveNext
        Loop
        GetContractSales = Mid(GetContractSales, 2)
        If stA0908 <> MsgText(601) Then stA0908 = Mid(stA0908, 2)
    End If
    'end 2021/07/01
    RsQ.Close
End Function
'end 2018/01/23

'Modify by Amy 2018/04/09 判斷是否有智權及承辦人員相同且為P12部門之未發文未取消收文之B類911補收款資料
Public Function Pub_B911NotPay(ByVal stCP01 As String, ByVal stCP02 As String, ByVal stCP03 As String, ByVal stCP04 As String) As Boolean
    Dim RsQ As New ADODB.Recordset
    Dim strQ As String, intQ As Integer
    
    Pub_B911NotPay = False
    'Modified by Morgan 2024/10/4 +P非台灣也要管控且不必再限制智權人員=承辦人(程序) --郭
    'strQ = "Select * From CaseProgress,Staff Where cp01='" & stCP01 & "' And cp02='" & stCP02 & "' And cp03='" & stCP03 & "' And cp04='" & stCP04 & "' " & _
            "And cp13=st01(+) And cp10='911' And cp14=cp13 And st03='P12' And cp158=0 And cp159=0 And cp09>'B' And cp09<'C' "
   strQ = "Select * From CaseProgress Where cp01='" & stCP01 & "' And cp02='" & stCP02 & "' And cp03='" & stCP03 & "' And cp04='" & stCP04 & "' " & _
         " And cp10='911' And cp158=0 And cp159=0 And cp09>'B' And cp09<'C' "
   'end 2024/10/4
      
    intQ = 1
    Set RsQ = ClsLawReadRstMsg(intQ, strQ)
    If intQ = 1 Then
        Pub_B911NotPay = True
    End If
End Function

'Add By Sindy 2018/5/25
'檢查是否為FMP案件
'Modified by Morgan 2021/2/2 改規則,+strPA09
Public Function PUB_ChkIsFMP(ByVal strPA01 As String, ByVal strPA02 As String, ByVal strPA03 As String, ByVal strPA04 As String, Optional ByVal strPA09 As String) As Boolean
Dim rsTmp As New ADODB.Recordset
Dim strSql As String
Dim intQ As Integer, strCP13 As String, strCP12 As String 'Added by Morgan 2021/2/2

   PUB_ChkIsFMP = False
   If strPA01 = "P" Then
      'Modified by Morgan 2021/2/2
      'strSql = "SELECT CP09,CP10,CP31,CP12,PA09 FROM CaseProgress,Patent " & _
               "WHERE CP01 = '" & strPA01 & "' AND " & _
                     "CP02 = '" & strPA02 & "' AND " & _
                     "CP03 = '" & strPA03 & "' AND " & _
                     "CP04 = '" & strPA04 & "' AND " & _
                     "CP31 = 'Y' AND CP01=PA01(+) AND CP02=PA02(+) AND CP03=PA03(+) AND CP04=PA04(+)"
      'rsTmp.CursorLocation = adUseClient
      'rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
      'If rsTmp.RecordCount > 0 Then
      '   rsTmp.MoveFirst
      '   If Left(rsTmp.Fields("CP12"), 1) = "F" And "" & rsTmp.Fields("PA09") <> "000" Then
      '      PUB_ChkIsFMP = True
      '   End If
      'End If
      'rsTmp.Close
      If strPA09 = "" Then
         strSql = "select pa09 from patent where pa01='" & strPA01 & "' and pa02='" & strPA02 & "' and pa03='" & strPA03 & "' and pa04='" & strPA04 & "'"
         intQ = 1
         Set rsTmp = ClsLawReadRstMsg(intQ, strSql)
         If intQ = 1 Then
            strPA09 = rsTmp("pa09")
         End If
      End If
      If strPA09 <> "000" Then
         strCP13 = PUB_GetAKindSalesNo(strPA01, strPA02, strPA03, strPA04)
         strCP12 = GetSalesArea(strCP13)
         If Left(strCP12, 1) = "F" Then
            PUB_ChkIsFMP = True
         End If
      End If
      'end 2021/2/2
   End If
   
   Set rsTmp = Nothing
End Function

'Add by Amy 2018/06/28 取得進度檔非程序的承辦人且發文日發文時間最大且不是D類-結案單T字頭用
Public Function GetLastCP14(ByVal stCP01 As String, ByVal stCP02 As String, ByVal stCP03 As String, ByVal stCP04 As String, ByVal stCP09 As String) As String
    Dim RsQ As New ADODB.Recordset
    Dim strQ As String, strWhere As String
    
    GetLastCP14 = ""
    'Modify by Amy 2018/08/27 原抓部門P2開頭
    strWhere = "CP01='" & stCP01 & "' And CP02='" & stCP02 & "' And CP03='" & stCP03 & "' And CP04='" & stCP04 & "' " & _
                      "And CP14=ST01(+) And ST03<>'P22' And SubStr(CP09,1,1)<>'D' And CP09<>'" & stCP09 & "' "
    'Modified by Morgan 2022/10/27 改抓最後收文，因為來函不發紙本會上111111。Ex:T-198838--嘉雯
    'strQ = "Select CP14 From CaseProgress,Staff Where " & strWhere & " And CP27||CP82=" & _
               "(Select Max(CP27||CP82) From CaseProgress,Staff Where " & strWhere & " )"
    strQ = "Select CP14 From CaseProgress,Staff Where " & strWhere & " And CP05||CP09=" & _
               "(Select Max(CP05||CP09) From CaseProgress,Staff Where " & strWhere & " )"
    RsQ.CursorLocation = adUseClient
    RsQ.Open strQ, cnnConnection, adOpenStatic, adLockReadOnly
    If RsQ.RecordCount > 0 Then
        GetLastCP14 = "" & RsQ.Fields("cp14")
    End If
    RsQ.Close
End Function

'Add by Amy 2018/07/16 判斷ImgByteFile是否有圖-案件用
'Modify by Amy 2018/07/24 +RsCount
'Modify by Amy 2018/07/25 +bolOldColor
'Modify by Amy 2018/08/03 +stIBF05:0-全部/1-黑白/2-彩色圖
'Modify By Sindy 2023/6/14 , Optional ByRef stIBF06 As String : 格式
Public Function ChkImgByteFile(ByVal stIBF01 As String, ByVal stIBF02 As String, ByVal stIBF03 As String, ByVal stIBF04 As String, _
                              Optional ByRef RsCount As Integer = 0, Optional ByVal bolOldColor As Boolean = False, _
                              Optional ByVal stIBF05 As String = "0", Optional ByRef stIBF06 As String) As Boolean
    Dim RsQ As New ADODB.Recordset
    Dim strQ As String
    
    ChkImgByteFile = False
    'Modify by Amy 2018/07/25 +bolOldColor
    strQ = "and ibf05 in('1' ,'2')"
    'Modify by Amy 2018/08/03
    If bolOldColor = True Then
        strQ = "and ibf05='1' and ibf06 in ('2','4') "
    ElseIf stIBF05 = "1" Then
        strQ = "and ibf05='1' "
    ElseIf stIBF05 = "2" Then
        strQ = "and ibf05='2' "
    End If
    'end 2018/08/03
    'Modify By Sindy 2018/10/31 TF馬德里商標圖檔-子案的圖同母案
    '固定都以IBF01=tm01 AND IBF02=substr(tm02,1,5)||'0' AND IBF03='0' AND IBF04='00' 去抓代表圖
    If stIBF01 = "TF" Then
      strQ = "Select * From ImgByteFile Where ibf01='" & stIBF01 & "' and ibf02='" & Mid(stIBF02, 1, 5) & "0" & "' And ibf03='0' And ibf04='00' " & _
                   strQ
    Else
    '2018/10/31 END
      strQ = "Select * From ImgByteFile Where ibf01='" & stIBF01 & "' and ibf02='" & stIBF02 & "' and ibf03='" & stIBF03 & "' and ibf04='" & stIBF04 & "' " & _
                   strQ
    End If
    'end 2018/07/25
                
    RsQ.CursorLocation = adUseClient
    RsQ.Open strQ, cnnConnection, adOpenStatic, adLockReadOnly
    RsCount = Val(RsQ.RecordCount) 'Add by Amy 2018/07/24
    If RsQ.RecordCount > 0 Then
        ChkImgByteFile = True
        stIBF06 = "" & RsQ.Fields("ibf06") 'Add By Sindy 2023/6/14
    End If
    RsQ.Close
End Function
    
'Add by Amy 2018/07/18 取得結案單補看人員
'Modify by Amy 2021/06/29 +strCP13,strCP01,strCP02,strCP03,strCP04
'Modify by Amy 2025/05/26 +strCP10 案件性質,strF0202_2 結案單程序人員,strOpt 操作人員
'Modify by Amy 2026/06/26 +strSP09 申請國家
Public Function GetF0202_3(ByVal strCP01 As String, ByVal strCP02 As String, ByVal strCP03 As String, ByVal strCP04 As String, _
  Optional ByVal strCP10 As String = "", Optional ByVal strF0202_2 As String = "", Optional ByVal strOpt As String, Optional ByVal strSP09 As String = "") As String
Dim IsFMPY53374 As Boolean 'Add by Amy 2025/05/26

    GetF0202_3 = ""
    'P/PS走P流程;CFP/CPS走CFP流程;CFT/CFC/S 走CFT流程;T字頭走T流程
    Select Case strCP01
        Case "P", "PS"
            'Modify by Amy 2025/05/26 +if FMP寰華案,由外專程序結案
            If strSrvDate(1) >= FCP結案單電子化啟用日 Then
               IsFMPY53374 = PUB_FMPtoCheck(1, 2, PUB_GetST05(strOpt), strCP01, strCP02, strCP03, strCP04) 'FMP寰華案件
            End If
            If IsFMPY53374 = True Then
               If strF0202_2 = MsgText(601) Then
                  '取得案件之程序人員
                  'Modify by Amy 2025/06/05 +IsFMPY53374 ex:閉卷抓補看人員發信會抓錯 ex:P-117408
                  strF0202_2 = Left(GetSignOffEmp("NP", strCP01, strCP02, "", strCP01 & "-" & strCP02 & "-" & strCP03 & "-" & strCP04, , , IsFMPY53374), 5)
               End If
               GetF0202_3 = PUB_GetFCPProSup(strF0202_2) '程序人員的二級主管
            Else
               'Modified by Morgan 2025/2/21
               'GetF0202_3 = "73022" 'Modify by Amy 2018/07/24 游登銘
               pub_PMan = Pub_GetSpecMan("專利處特定編號")
               GetF0202_3 = Right(pub_PMan, 5)
               'end 2025/2/21
            End If
            'end 2025/05/26
        Case "CFP", "CPS"
            'Modify By Sindy 2022/12/6
            'GetF0202_3 = "71011" '王錦寬
            GetF0202_3 = "99050" '李柏翰
            '2022/12/6 END
        Case "CFT", "CFC", "S"
            'Modify by Amy 2025/06/26 +if strSP09 申請國家
            If strCP01 = "S" And strSP09 = "" Then strSP09 = GetPrjNation1(strCP01 & "-" & strCP02 & "-" & strCP03 & "-" & strCP04)
            If strCP01 = "S" And strSP09 = "000" Then
               If strF0202_2 = MsgText(601) Then
                  '取得案件之程序人員
                  strF0202_2 = Left(GetSignOffEmp("NP", strCP01, strCP02, "", strCP01 & "-" & strCP02 & "-" & strCP03 & "-" & strCP04, strCP10), 5)
               End If
               'Memo by Amy 2025/06/26 同FCT [非爭議]案規則
               GetF0202_3 = PUB_GetFCPProSup(strF0202_2) '程序人員的二級主管
            Else
               'Modify by Amy 2021/06/29 改抓GetCFTSt16Manager
               'GetF0202_3 = "68005" '陳鳳英
               GetF0202_3 = GetCFTSt16Manager(strCP01, strCP02, strCP03, strCP04)
            End If
        'Add by Amy 2025/05/26 FC結案單
        Case "FCP", "FG"
            If strF0202_2 = MsgText(601) Then
               '取得案件之程序人員
               strF0202_2 = Left(GetSignOffEmp("NP", strCP01, strCP02, "", strCP01 & "-" & strCP02 & "-" & strCP03 & "-" & strCP04), 5)
            End If
            GetF0202_3 = PUB_GetFCPProSup(strF0202_2) '程序人員的二級主管
        Case "FCT"
            'FCT爭議案 (原:內商結114/7/2 秀玲詢問後,全部改回外商結,但補看人員維持內商主管補看)
            'Modify By Sindy 2025/7/28 FCT案727分析不屬於爭議案 + And InStr(FCT_NotTMdebate, strCP10) = 0
            If InStr(TMdebate, strCP10) > 0 And InStr(FCT_NotTMdebate, strCP10) = 0 Then
               GetF0202_3 = Pub_GetSpecMan("內商爭議案程序主管")
            Else
               '上線時,詢問FCT程序
               If strF0202_2 = MsgText(601) Then
                  '取得案件之程序人員
                  strF0202_2 = Left(GetSignOffEmp("NP", strCP01, strCP02, "", strCP01 & "-" & strCP02 & "-" & strCP03 & "-" & strCP04, strCP10), 5)
               End If
               GetF0202_3 = PUB_GetFCPProSup(strF0202_2) '程序人員的二級主管
            End If
         'end 2025/05/26
        Case Else
            If Left(strCP01, 1) = "T" Then
               'Modify By Sindy 2021/11/10 MCT案->96003.沈佳穎,非MCT案->86048.林承慧
               If strSrvDate(1) >= 20211115 Then
                  If Mid(PUB_GetAKindSalesNo(strCP01, strCP02, strCP03, strCP04), 1, 4) = "MCTF" Then
                     GetF0202_3 = "96003" '沈佳穎
                  Else
                     GetF0202_3 = "86048" '林承慧
                  End If
               Else
               '2021/11/10 END
                  GetF0202_3 = "69008" '林純貞
               End If
            End If
   End Select
End Function
'end 2021/06/29

'Add by Amy 2018/10/12 選單權限
Public Function GetMenuLimit(ByVal stFormName As String, Optional ByVal bolOpenM51 As Boolean = True, Optional bolMsg As Boolean = True) As Boolean
    Dim RsQ As ADODB.Recordset
    Dim strQ As String, strWhere As String, strTp As String
    Dim intQ As Integer
    
    GetMenuLimit = False
    Select Case UCase(stFormName)
        Case "FRM140419"
            strTp = Pub_GetSpecMan("兼職業務拓展處人員")
            If bolOpenM51 = True Then
                strWhere = " And st03 in('F41','M51') "
            Else
                strWhere = " And st03='F41' "
            End If
            strQ = "Select st01 From Staff Where  st04='1' and substr(st01,4,1)<>'9' and substr(st01,1,1) <> 'F' " & strWhere & "Order by st01 "
    End Select
    intQ = 1
    Set RsQ = ClsLawReadRstMsg(intQ, strQ)
    If intQ = 1 Then
        RsQ.MoveFirst
        Do While Not RsQ.EOF
            strTp = strTp & ";" & RsQ.Fields("st01")
            RsQ.MoveNext
        Loop
    End If
    If InStr(strTp, strUserNum) > 0 Then
        GetMenuLimit = True
    Else
        If bolMsg = True Then MsgBox "無此使用權限...", , "警告!!"
    End If
End Function
    
'add by sonia 2018/11/6 檢查是否為業務開拓小組成員
Public Function IsUserDeptTeam(ByVal strProgId As String, Optional ByVal bShowMsg As Boolean = False) As Boolean
' 讀取員工檔的Recordset
Dim rsStaff As ADODB.Recordset
Dim m_Team As String

   ' 預設值為False
   IsUserDeptTeam = False
   
On Error GoTo ERRORSECTION
   ' 讀取業務拓展小組成員
   m_Team = Pub_GetSpecMan("業務拓展小組成員")
   If InStr(m_Team, strUserNum) > 0 Then
      IsUserDeptTeam = True
      Exit Function
   End If
   
   '非業務拓展小組成員再抓是否為00,01權限
   strSql = "SELECT ST05 FROM STAFF WHERE ST01 = '" & Trim(strUserNum) & "'"
   Set rsStaff = New ADODB.Recordset
   rsStaff.CursorLocation = adUseClient
   rsStaff.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If rsStaff.RecordCount > 0 Then
      If IsNull(rsStaff.Fields("ST05").Value) Then
         IsUserDeptTeam = False
      Else
         ' 等級編號為00的員工擁有執行所有作業及功能的權限,總經理權限(等級01),可使用所有程式,但維護程式只有查詢功能
         'modify by sonia 2023/3/9 加等級05總經理秘書(業拓郵件請作)
         If rsStaff.Fields("ST05").Value = "00" Or rsStaff.Fields("ST05").Value = "01" Or rsStaff.Fields("ST05").Value = "05" Then
            IsUserDeptTeam = True
            rsStaff.Close
            Set rsStaff = Nothing
            Exit Function
         Else
            'modify by sonia 2019/1/2 又增加個人權限
            'IsUserDeptTeam = False
            If CheckUse(strProgId, strExec, False) = True Then
               IsUserDeptTeam = True
            Else
               IsUserDeptTeam = False
            End If
            'end 2019/1/2
         End If
      End If
   End If
   rsStaff.Close
   
   ' 顯示訊息提示使用者
   If IsUserDeptTeam = False Then
      If bShowMsg Then
         MsgBox "您沒有使用該項作業的權限...", vbOKOnly + vbCritical, "警告!!"
      End If
   End If
   
   ' 清除所佔用的資源
   Set rsStaff = Nothing
   Exit Function

' 發生錯誤時設定回傳為False
ERRORSECTION:
   IsUserDeptTeam = False
   Exit Function
End Function
'end 2018/11/6

'Added by Lydia 2018/12/25 將數字轉換(1,2,3,4)為excel檔的橫軸座標(A,B,C,D)
Public Function Pub_NumberToSystem26(ByVal intNum As Integer) As String
   Dim intRema As Integer
   Dim intBase As Integer
   Dim strTemp As String
   
   intBase = 64 '大寫A
   '超過26開始為AA
   Do While intNum > 0
         intRema = intNum Mod 26          '取餘數
         If intRema = 0 Then intRema = 26
         strTemp = Chr(intBase + intRema) & strTemp
         intNum = (intNum - intRema) \ 26 '取商數
   Loop
   Pub_NumberToSystem26 = strTemp
End Function

'Add By Sindy 2019/1/10 員工分機號碼
'Modified by Lydia 2021/09/09 +英文別名 strED04
Public Function Pub_GetStaffExtn(ByVal StrST01 As String, Optional ByRef strED04 As String) As String
Dim RsQ As New ADODB.Recordset
Dim strQ As String, intQ As Integer
   
   Pub_GetStaffExtn = ""
   strED04 = "" 'Added by Lydia 2021/09/09
   'Modified by Lydia 2021/09/09 +ed04 英文別名
   strQ = "Select ed01,ed04 From ExtensionData Where ed02='" & StrST01 & "'"
   intQ = 1
   Set RsQ = ClsLawReadRstMsg(intQ, strQ)
   If intQ = 1 Then
      Pub_GetStaffExtn = "" & RsQ.Fields("ed01")
      strED04 = "" & RsQ.Fields("ed04") 'Added by Lydia 2021/09/09 英文別名
   End If
End Function

'Add by Amy 2019/02/11 參考frm140112_1.ChkValidate修改
'stMsg傳入需回傳欄位
Public Function ChkReservation(pRoom As String, pDate As String, pFromTime As String, pToTime As String, Optional bolEdit As Boolean _
   , Optional pOldRoom As String, Optional pOldDate As String, Optional pOldFromTime As String, Optional ByRef stMsg As String = "", Optional ByVal stRR20 As String = "") As Boolean
   Dim strCon As String
   Dim bolReturn As Boolean, i As Integer
   Dim strRR As String, strRD As String, strTp As String
   Dim strF1 As String, strF2 As String
   Dim strTmp As String, intA As Integer, rsAD As New ADODB.Recordset 'Added by Lydia 2024/05/15
   
  strF1 = "mr02,rr02,rr03,rr04": strF2 = Replace(strF1, ",rr02", ",rd04 as rr02")
   If stMsg <> MsgText(601) Then
        bolReturn = True
        stMsg = ""
   End If
   If bolEdit Then
      strCon = " and not (rr01=" & pOldRoom & " and rr02=" & pOldDate & " and rr03=" & pOldFromTime & ")"
   End If
   
   '排除已取消者
   strCon = strCon & " and rr18=0"
   'Add by Amy 2019/03/04 排除教育訓練編號
   If stRR20 <> MsgText(601) Then strCon = strCon & " And (rr20<>" & Val(stRR20) & " Or rr20 is null)"
  
   If pRoom <> MsgText(601) Then
        strRR = strRR & " And rr01=" & pRoom
        strRD = strRD & " And rd01=" & pRoom
   End If
   '檢查預約是否有重疊(允許pRoom可以為空白,查所有會議室)
   strTmp = "select " & strF1 & " from RoomReservation,MeetingRoom" & _
      " where rr02=" & pDate & " and " & pFromTime & ">=rr03 and " & pFromTime & "<rr04 and rr05='N' And rr01=mr01(+) And mr04='1' " & strCon & strRR & _
      " union select " & strF1 & " from RoomReservation,MeetingRoom" & _
      " where rr02=" & pDate & " and " & pToTime & ">rr03 and " & pToTime & "<=rr04 and rr05='N' And rr01=mr01(+) And mr04='1' " & strCon & strRR & _
      " union select " & strF1 & " from RoomReservation,MeetingRoom" & _
      " where rr02=" & pDate & " and " & pFromTime & "<rr03 and " & pToTime & ">=rr04 and rr05='N' And rr01=mr01(+) And mr04='1'" & strCon & strRR & _
      " union select " & strF2 & " from RoomResDetail,RoomReservation,MeetingRoom" & _
      " where rd04=" & pDate & " and rd05 is null And rd01=mr01(+) And mr04='1' " & strRD & _
      " and rr01(+)=rd01 and rr02(+)=rd02 and rr03(+)=rd03 and " & pFromTime & ">=rr03 and " & pFromTime & "<rr04" & strCon & _
      " union select " & strF2 & " from RoomResDetail,RoomReservation,MeetingRoom" & _
      " where rd04=" & pDate & " and rd05 is null And rd01=mr01(+) And mr04='1' " & strRD & _
      " and rr01(+)=rd01 and rr02(+)=rd02 and rr03(+)=rd03 and " & pToTime & ">rr03 and " & pToTime & "<=rr04" & strCon & _
      " union select " & strF2 & " from RoomResDetail,RoomReservation,MeetingRoom" & _
      " where rd04=" & pDate & " and rd05 is null And rd01=mr01(+) And mr04='1' " & strRD & _
      " and rr01(+)=rd01 and rr02(+)=rd02 and rr03(+)=rd03 and " & pFromTime & "<rr03 and " & pToTime & ">=rr04" & strCon
   
   intA = 1
   Set rsAD = ClsLawReadRstMsg(intA, strTmp)
   If intA = 0 Then
      ChkReservation = True
   Else
      If bolReturn = True Then
            Do While rsAD.EOF = False
                For i = 0 To rsAD.Fields.Count - 1
                   
                    If i > 1 Then
                        strTp = strTp & "," & Format(rsAD.Fields(i), "00:00")
                    ElseIf pRoom <> MsgText(601) And i <> 0 Then
                        strTp = strTp & "," & rsAD.Fields(i)
                    End If
                Next i
                If strTp <> MsgText(601) Then
                    stMsg = stMsg & ";" & Mid(strTp, 2)
                    strTp = ""
                End If
                rsAD.MoveNext
            Loop
            If stMsg <> MsgText(601) Then stMsg = Mid(stMsg, 2)
      End If
   End If
   rsAD.Close
End Function

'add by sonia 2019/2/14 讀取律師名單,pST04有傳才判斷是否在職
Public Function GetLawerList(Optional pST04 As String) As String
Dim rsTmp As New ADODB.Recordset
Dim strSql As String
Dim s_Listno As String  'add by sonia 2019/5/20

   GetLawerList = "": s_Listno = ""
   '76012桂所長的部門由L01改管理部,故加個人編號
   'modify by sonia 2019/5/20 加入系統特殊設定人員,98020江郁仁律師職稱改協理(部門仍掛F31)
   'strSql = "SELECT ST01,ST02 FROM STAFF WHERE (ST03 ='L01' OR ST20='13' OR ST01='76012') "
   'If pST04 <> "" Then strSql = strSql & " AND ST04='1' "
   'strSql = strSql & "ORDER BY ST01"
   'rsTmp.CursorLocation = adUseClient
   'rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   'If rsTmp.EOF = False Then
   '   Do While rsTmp.EOF = False
   '      If Not IsNull(rsTmp.Fields("ST01")) Then
   '         GetLawerList = GetLawerList & rsTmp.Fields("ST01") & "," & IIf(IsNull(rsTmp.Fields("ST02")), "", rsTmp.Fields("ST02")) & ";"
   '      End If
   '      rsTmp.MoveNext
   '   Loop
   'End If
   'rsTmp.Close
   
   '部門為法務部律師L01或職稱為律師13之名單
   strSql = "SELECT ST01 FROM STAFF WHERE (ST03 ='L01' OR ST20='13') "
   If pST04 <> "" Then strSql = strSql & " AND ST04='1' "
   strSql = strSql & "ORDER BY ST01"
   rsTmp.CursorLocation = adUseClient
   rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If rsTmp.EOF = False Then
      Do While rsTmp.EOF = False
         If Not IsNull(rsTmp.Fields("ST01")) Then
            s_Listno = s_Listno & rsTmp.Fields("ST01") & ","
         End If
         rsTmp.MoveNext
      Loop
   End If
   rsTmp.Close
   
   '部門非法務部律師L01或職稱非律師13之名單
   strSql = "select oMan FROM SetSpecMan where ocode='非法務部律師名單'"
   rsTmp.CursorLocation = adUseClient
   rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If rsTmp.EOF = False Then
      s_Listno = s_Listno & rsTmp.Fields("oMan")
   End If
   rsTmp.Close
   
   '排序並加姓名
   s_Listno = Replace(s_Listno, ";", ",")
   s_Listno = Replace(s_Listno, ",", "','")
   strSql = "SELECT ST01,ST02 FROM STAFF WHERE ST01 in ('" & s_Listno & "') "
   If pST04 <> "" Then strSql = strSql & " AND ST04='1' "
   strSql = strSql & "ORDER BY ST01"
   rsTmp.CursorLocation = adUseClient
   rsTmp.Open strSql, cnnConnection, adOpenStatic, adLockReadOnly
   If rsTmp.EOF = False Then
      Do While rsTmp.EOF = False
         If Not IsNull(rsTmp.Fields("ST01")) Then
            GetLawerList = GetLawerList & rsTmp.Fields("ST01") & "," & IIf(IsNull(rsTmp.Fields("ST02")), "", rsTmp.Fields("ST02")) & ";"
         End If
         rsTmp.MoveNext
      Loop
   End If
   rsTmp.Close
   'end 2019/5/20
   
   Set rsTmp = Nothing
End Function
'end 2019/2/14

'Add by Amy 2019/02/15 教育訓練是否是預約會議室
'Modify by Amy 2019/03/04 回傳日期/開始結束時間
'Modify by Amy 2019/09/05 +bolOnlyRR:只查詢RoomReservation
Public Function ChkHasRR20(ByVal stNo As String, Optional ByRef stRR01 As String = "", Optional ByRef stRR02 As String = "", Optional ByRef stRR03 As String = "", Optional ByRef stRR04 As String = "", _
                                                Optional ByVal bolOnlyRR As Boolean = True) As Boolean
    Dim RsQ As New ADODB.Recordset
    Dim strQ As String, intQ As Integer
   
    ChkHasRR20 = False
    If bolOnlyRR = False Then
        strQ = "Select SN22 as RR01,SN05 as RR02,SN06 as RR03,SN07 as RR04 From Seminar Where SN01=" & stNo & " "
    End If
    strQ = "Select  RR01,RR02,RR03,RR04 From RoomReservation Where RR20=" & stNo & _
                IIf(strQ <> "", " Union " & strQ, "")
    intQ = 1
    Set RsQ = ClsLawReadRstMsg(intQ, strQ)
    If intQ = 1 Then
        ChkHasRR20 = True
        stRR01 = "" & RsQ.Fields("RR01")
        stRR02 = "" & RsQ.Fields("RR02")
        stRR03 = "" & RsQ.Fields("RR03")
        stRR04 = "" & RsQ.Fields("RR04")
    End If
    RsQ.Close
End Function

'Add by Amy 2019/03/06 傳入西元日期取得當週之起日或迄日
'bolStartDate:True-傳回起日/False-傳回迄日
'intWorkDay:0-週一/1-往後抓工作日/2-往前抓工作日
'bolNoAdd:True-剔除補班工作天
'bolYYYY:True-回傳西元年/False-民國年
Public Function GetWeekDate(ByVal stDate As String, ByVal bolStartDate As Boolean, intWorkDay As Integer, _
                                 Optional bolNoAdd As Boolean = False, Optional bolYYYY As Boolean = True) As String
    Dim RsQ As New ADODB.Recordset
    Dim strQ As String, stTmp As String
    Dim intQ As Integer
    
    stTmp = Weekday(ChangeWStringToWDateString(stDate))
    
    stTmp = ChangeWDateStringToWString(DateAdd("d", (2 - Val(stTmp)), Format(stDate, "####-##-##")))
    '工作日
    If intWorkDay > 0 Then
        If ChkWorkDay(stTmp) = False Then
            stTmp = PUB_GetWorkDay1(CDbl(stTmp), IIf(intWorkDay = 2, True, False), bolNoAdd)
        End If
    End If
    If bolStartDate = True Then
        GetWeekDate = Val(stTmp) - IIf(bolYYYY = True, 0, 19110000)
        Exit Function
    End If
   
    '當週工作日=週一至週六
    strQ = "Select Max(WD01) From WorkDay " & _
               "Where WD01>=" & Val(stTmp) & _
               " And WD01<=" & Val(ChangeWDateStringToWString(DateAdd("d", 5, Format(stTmp, "####-##-##"))))
    RsQ.CursorLocation = adUseClient
    RsQ.Open strQ, cnnConnection, adOpenStatic, adLockReadOnly
    If RsQ.RecordCount > 0 Then
        stTmp = "" & RsQ.Fields(0)
        '工作日
        If intWorkDay > 0 Then
            If ChkWorkDay(stTmp) = False Then
                stTmp = PUB_GetWorkDay1(CDbl(stTmp), IIf(intWorkDay = 2, True, False), bolNoAdd)
            End If
        End If
    End If
    RsQ.Close
    GetWeekDate = Val(stTmp) - IIf(bolYYYY = True, 0, 19110000)
End Function

'Move by Amy 2019/04/10 從basPublic搬過來
'Added by Lydia 2019/02/12 讀取資料夾中符合的檔案名稱(多筆),依照日期做排序用||區隔檔案名稱
Public Function PUB_GetFileListOrderby(ByVal pFilePath As String, ByVal pFileType As String, Optional ByVal bolDesc As Boolean = True) As String
Dim intR As Integer
Dim strMid As String
Dim strMList As String, strMListTime As String
Dim arrTmp01 As Variant, arrTmp02 As Variant
Dim oFileSys As New FileSystemObject
Dim oFile
Dim iX As Integer, iY As Integer
Dim vTemp

    If pFilePath = "" Or pFileType = "" Then Exit Function
    PUB_GetFileListOrderby = ""
    
On Error GoTo ErrHand01
    If Dir(pFilePath, vbDirectory) = "" Then
         MsgBox pFilePath & vbCrLf & "資料夾不存在！"
         Exit Function
    End If
        
    strMid = Dir(pFilePath & "\" & pFileType)
    Do While strMid <> ""
        If UCase(strMid) <> "THUMBS.DB" Then   'Added by Lydia 2020/04/29跳過Thumbs.db
            intR = intR + 1
            strMList = strMList & strMid & "||"
            Set oFile = oFileSys.GetFile(pFilePath & "\" & strMid)
            strMListTime = strMListTime & Format(oFile.DateLastModified, "YYYYMMDD") & "||"
        End If 'Added by Lydia 2020/04/29
        strMid = Dir()
    Loop
    
    If intR = 1 Then '單筆
        PUB_GetFileListOrderby = Mid(strMList, 1, Len(strMList) - 2)
    ElseIf intR > 1 Then  '多筆->排序
        arrTmp01 = Split(strMList, "||")
        arrTmp02 = Split(strMListTime, "||")
        '排序
        For iX = 0 To UBound(arrTmp02)
           If arrTmp02(iX) <> "" Then
                For iY = iX + 1 To UBound(arrTmp02)
                  If arrTmp02(iY) <> "" Then
                    '統一由小到大排序
                    If arrTmp02(iX) > arrTmp02(iY) Then
                       '日期
                       vTemp = arrTmp02(iX)
                       arrTmp02(iX) = arrTmp02(iY)
                       arrTmp02(iY) = vTemp
                       '檔名
                       vTemp = arrTmp01(iX)
                       arrTmp01(iX) = arrTmp01(iY)
                       arrTmp01(iY) = vTemp
                    End If
                  End If
                Next iY
           End If
        Next iX
 
        strMid = ""
        If bolDesc = False Then '由小到大
            For iX = 0 To UBound(arrTmp02)
               If arrTmp02(iX) <> "" Then
                  strMid = strMid & arrTmp01(iX) & "||"
               End If
            Next iX
        Else
            For iX = UBound(arrTmp02) To 0 Step -1 '由大到小
               If arrTmp02(iX) <> "" Then
                  strMid = strMid & arrTmp01(iX) & "||"
               End If
            Next iX
        End If
        PUB_GetFileListOrderby = Mid(strMid, 1, Len(strMid) - 2)
    End If
    
    Exit Function
    
ErrHand01:
    If Err.Number <> 0 Then
         '全部錯誤訊息統一
         MsgBox "無法讀取" & pFilePath & "，請通知電腦中心！", vbCritical
         Resume Next
    End If
End Function

'Add by Amy 2019/04/30  傳入人員判斷是否有國外機密權限
Public Function ChkContractLimit_Foreign(ByVal stUser As String) As Boolean
    Dim RsQ As New ADODB.Recordset
    Dim StrSQLa As String
    Dim intQ As Integer
    
    ChkContractLimit_Foreign = False
    
    '員工部門(st03)為外專承辦(F23)或業務展處(F41)及其st52~55人員或等級(st05)為2字頭(外商承辦)但不是CFT+CFC承辦及其st52~55人員
    StrSQLa = "Select st01 From Staff Where (st03='F23' or st03='F41') And st01='" & stUser & "' " & _
    "Union Select '" & stUser & "' From Staff Where (st03='F23' or st03='F41') And (st52='" & stUser & "' or st53='" & stUser & "' or st54='" & stUser & "' or st55='" & stUser & "') " & _
    "Union Select st01 From Staff Where SubStr(st05,1,1)='2' And st05<>'23' And st01='" & stUser & "' " & _
    "Union Select '" & stUser & "' From Staff Where SubStr(st05,1,1)='2' And st05<>'23' And (st52='" & stUser & "' or st53='" & stUser & "' or st54='" & stUser & "' or st55='" & stUser & "') "
    
    intQ = 1
    Set RsQ = ClsLawReadRstMsg(intQ, StrSQLa)
    If intQ = 1 Then
        ChkContractLimit_Foreign = True
    End If
    RsQ.Close
End Function

'Add by Amy 2019/06/26 傳入代理人編號抓取案件基本檔之案件 or 案號 ,更新當日AB類收文之收文MCTF組別
Public Function UpdCP161(ByVal stCode As String, ByVal stFA120_N As String, Optional ByRef stMsg As String = "") As Boolean
    Dim stQ As String
    Dim bolMsg As Boolean
    Dim arrCode
    
On Error GoTo ErrHand
    
    UpdCP161 = False
    If stMsg <> MsgText(601) Then
        bolMsg = True
        stMsg = ""
    End If
    arrCode = Split(stCode, ";")
    stQ = "And cp13 in ('" & Replace(Pub_GetSpecMan("MCTMember"), ";", "','") & "') And cp01 is not null " & _
             "And cp66=" & strSrvDate(1) & " And cp09<'C' "
            
    '案號
    If UBound(arrCode) > 1 Then
        stQ = "Select cp09 From CaseProgress " & _
                "Where cp01='" & arrCode(0) & "' And cp02='" & arrCode(1) & "' And cp03='" & arrCode(2) & "' And cp04='" & arrCode(3) & "' " & stQ
    '代理人編號
    Else
        stQ = "Select cp09 From CaseProgress,(" & _
                   "Select tm01 tm01,tm02 tm02,tm03 tm03,tm04 tm04 From TradeMark Where tm44='" & arrCode(0) & "' " & _
        "Union Select lc01,lc02,lc03,lc04 From LawCase Where lc22='" & arrCode(0) & "' " & _
        "Union Select sp01,sp02,sp03,sp04 From ServicePractice Where sp26='" & arrCode(0) & "') " & _
                  "Where tm01=cp01(+) And tm02=cp02(+) And tm03=cp03(+) And tm04=cp04(+) " & stQ
    End If
    stQ = "Update CaseProgress Set cp161='" & stFA120_N & "' Where cp09 in (" & stQ & ")"
    
    cnnConnection.Execute stQ
    UpdCP161 = True
    Exit Function
    
ErrHand:
    UpdCP161 = False
    If bolMsg = True Then stMsg = Err.Description
End Function
'end 2019/06/26

'Modify By Sindy 2020/5/21 從frm100101_19 Move過來,改成共用函數
'檢查(國內往來記錄)維護權限
'Modified by Lydia 2019/09/10 +傳入客戶編號,建檔人
'Modified by Lydia 2019/10/18 取消QPGMR的判斷
'If CheckModifyLimit(rsad("SAno"), p_stCust, p_COR06) = False Then
'If CheckModifyLimit(rsad("SAno"), p_stCust, "") = False Then
'p_SAno=智權人員/開發人員
'Modified by Lydia 2020/11/03 +是否判斷特殊設定
Public Function PUB_CheckModifyLimit_frm100101_19(p_SAno As String, bCustNo As String, bCOR06 As String, ByVal bolSpec As Boolean) As Boolean
Dim strTmp As String, intA As Integer, rsAD As New ADODB.Recordset 'Added by Lydia 2024/05/15

   'Add by Sindy 2020/5/22
   'S和W單位不可以輸入Y的往來記錄
   If Left(bCustNo, 1) = "Y" And _
      (Left(Pub_StrUserSt03, 1) = "S" Or Left(Pub_StrUserSt03, 1) = "W") Then
      PUB_CheckModifyLimit_frm100101_19 = False
      MsgBox "無操作權限 !!!", vbInformation
      GoTo EXITSUB
   ElseIf Left(bCustNo, 1) = "Y" Then
      If bCOR06 = strUserNum Or bCOR06 = "" Then
         PUB_CheckModifyLimit_frm100101_19 = True
         GoTo EXITSUB
      End If
   Else
      'bCOR06 = "" 'Remove by Lydia 2020/11/03
   End If
   '2020/5/22 END
   
   '開放M51及01,09等級權限
   If Pub_StrUserSt03 = "M51" Or Pub_strUserST05 = "01" Or Pub_strUserST05 = "09" Then
      PUB_CheckModifyLimit_frm100101_19 = True
      GoTo EXITSUB
   End If
   
   'Add by Amy 2017/08/11 +MCTF 權限控制
   If Left(p_SAno, 4) = "MCTF" Then
        'MCTF人員
        If InStr(Replace(Pub_GetSpecMan(p_SAno, False), ";", ","), strUserNum) > 0 Then
            PUB_CheckModifyLimit_frm100101_19 = True
            GoTo EXITSUB
        'MCTF主管
        ElseIf InStr(Replace(Pub_GetSpecMan("MCTM", False), ";", ","), strUserNum) > 0 Then
            PUB_CheckModifyLimit_frm100101_19 = True
            GoTo EXITSUB
        End If
   End If
   
   'Added by Lydia 2020/11/11 開放69005簡協理可新增所有智權部客戶之記錄，該記錄僅限本人可修改。
   'Modify By Sindy 2022/5/4 簡協理改為抓系統特殊設定「全所智權部主管」
   If InStr(Pub_GetSpecMan("全所智權部主管"), strUserNum) > 0 Then
      If (bCOR06 = "ADD" And Left(PUB_GetStaffST15(p_SAno, 1), 1) = "S") Or strUserNum = bCOR06 Then
          PUB_CheckModifyLimit_frm100101_19 = True '可新增所有智權部客戶
          GoTo EXITSUB
      End If
   End If
   'Modify By Sindy 2022/5/4 簡協理改為抓系統特殊設定「全所智權部主管」
   If InStr(Pub_GetSpecMan("全所智權部主管"), bCOR06) > 0 And strUserNum <> bCOR06 Then '該記錄僅限本人可修改
       MsgBox "無操作權限 !!!", vbInformation 'Added by Lydia 2020/12/01
       PUB_CheckModifyLimit_frm100101_19 = False
       GoTo EXITSUB
   End If
   'end 2020/11/11
   
   '須為開發者或其案件主管, 方可維護此筆資料
   'Modified by Lydia 2019/09/10 +整批匯入Create ID->QPGMR開放給全部人員查詢
   'Modified by Lydia 2020/11/03 可查詢/維護人員: p_SAno客戶智權人員、bCOR06原建檔人員 ; ex.簡協理原本在S15，後來成為智權部主管S00，客戶全部轉給其他智權人員
   'If strUserNum = p_SAno Or bCOR06 = "QPGMR" Then
   If strUserNum = p_SAno Or (bCOR06 <> "" And (bCOR06 = "QPGMR" Or bCOR06 = strUserNum)) Then
      PUB_CheckModifyLimit_frm100101_19 = True
      GoTo EXITSUB
   Else
      'Modified by Lydia 2020/11/03 ST03改成收文部門ST15
      'strtmp = "SELECT A0908 FROM STAFF,ACC090 " & _
                         "WHERE ST03=A0901(+) and ST01= '" & p_SAno & "' "
      strTmp = "SELECT A0908,A0901 FROM STAFF,ACC090 " & _
                         "WHERE ST15=A0901(+) and ST01= '" & p_SAno & "' "
      intA = 1
      Set rsAD = ClsLawReadRstMsg(intA, strTmp)
      If intA = 1 Then
         If strUserNum = rsAD(0) Then
            PUB_CheckModifyLimit_frm100101_19 = True
            GoTo EXITSUB
         End If
         'Added by Lydia 2020/11/03 特殊設定名單內人員可查詢收文部門ST15為SXX部門人員的往來記錄
         If Left("" & rsAD(1), 1) = "S" And bolSpec = True Then
            If InStr(Replace(Pub_GetSpecMan("國內智權部往來記錄查詢人員", False), ";", ","), strUserNum) > 0 Then
               PUB_CheckModifyLimit_frm100101_19 = True
               GoTo EXITSUB
            End If
         End If
         'end 2020/11/03
      End If
      'add by sonia 2017/10/17 帶人主管也可以看 82026可看X37109
      strTmp = "SELECT ST52,ST53,ST54,ST55 FROM STAFF " & _
                  "WHERE ST01= '" & p_SAno & "' "
      intA = 1
      Set rsAD = ClsLawReadRstMsg(intA, strTmp)
      If intA = 1 Then
         If strUserNum = "" & rsAD(0) Then
            PUB_CheckModifyLimit_frm100101_19 = True
            GoTo EXITSUB
         ElseIf strUserNum = "" & rsAD(1) Then
            PUB_CheckModifyLimit_frm100101_19 = True
            GoTo EXITSUB
         ElseIf strUserNum = "" & rsAD(2) Then
            PUB_CheckModifyLimit_frm100101_19 = True
            GoTo EXITSUB
         ElseIf strUserNum = "" & rsAD(3) Then
            PUB_CheckModifyLimit_frm100101_19 = True
            GoTo EXITSUB
         End If
      End If
      'end 2017/10/17
   End If
   
   'Added by Lydia 2019/09/10 若客戶存在於待活化客戶檔，開放同一所別所有人都可查詢往來記錄
   If bCustNo <> "" And Left(bCustNo, 1) = "X" Then
        strTmp = "select ocu01,st06 from oldcustomer,customer,staff " & _
                         "where ocu01='" & Mid(ChangeCustomerL(bCustNo), 1, 8) & "' and ocu01=cu01 and cu02='0' and nvl(ocu03,0)=0 and cu13=st01(+) "
        intA = 1
        Set rsAD = ClsLawReadRstMsg(intA, strTmp)
        If intA = 1 Then
           If pub_strUserOffice = "" & rsAD("st06") Then
               PUB_CheckModifyLimit_frm100101_19 = True
               GoTo EXITSUB
           End If
        End If
   End If
   
   PUB_CheckModifyLimit_frm100101_19 = False
   'MsgBox "無查詢權限 !!!", vbInformation
   MsgBox "無操作權限 !!!", vbInformation
   
'Added by Lydia 2024/05/15
EXITSUB:
   Set rsAD = Nothing
'end 2024/05/15

End Function

'Modify By Sindy 2020/5/21 從frm100101_19 Move過來,改成共用函數
'Modified by Lydia 2019/09/10 +建檔人p_COR06
'Modified by Lydia 2020/11/03  建檔人改成必傳(COR06或ADD新增用) ; 是否判斷特殊設定bolSpec
'Public Function PUB_GetCustData_frm100101_19(p_stCust As String, Optional ByVal p_COR06 As String, _
   Optional ByRef p_Cor03Name As String = "") As Boolean
'Memo by Lydia 2020/11/03 用於檢查往來記錄的維護權限；其次用在往來記錄的往來對象COR03檢查
Public Function PUB_GetCustData_frm100101_19(ByVal p_stCust As String, ByVal p_COR06 As String, ByVal bolSpec As Boolean, _
    Optional ByRef p_Cor03Name As String = "") As Boolean
Dim strTmp As String, intA As Integer, rsAD As New ADODB.Recordset 'Added by Lydia 2024/05/15

   'Add by Sindy 2020/5/22
   'S和W單位不可以輸入Y的往來記錄
   If Left(p_stCust, 1) = "Y" And _
      (Left(Pub_StrUserSt03, 1) = "S" Or Left(Pub_StrUserSt03, 1) = "W") Then
      PUB_GetCustData_frm100101_19 = False
      MsgBox "往來對象必須為 X 或 R 開頭", vbCritical + vbOKOnly, "檢核資料"
      GoTo EXITSUB
   End If
   '2020/5/22 END
   
   PUB_GetCustData_frm100101_19 = False
   Select Case Left(p_stCust, 1)
      Case "X"
         '2009/5/14 modify by sonia 開放M51權限
         'modify by sonia 2015/6/5 開放01,09等級權限
         'strtmp = "select cu64,cu04,rtrim(cu05||' '||cu88||' '||cu89||' '||cu90) cu05,cu06,CU10 N3 from customer where cu01='" & Left(p_stCust, 8) & "' and cu02='" & Right(p_stCust, 1) & "' and cu13 ='" & strUserNum & "' "
         'modify by sonia 2017/8/11 為判斷權限+cu13
         'Modify by Amy 2017/08/11 cu02固定0-秀玲
         'strtmp = "select cu64,cu04,rtrim(cu05||' '||cu88||' '||cu89||' '||cu90) cu05,cu06,CU10 N3,cu13 SAno from customer where cu01='" & Left(p_stCust, 8) & "' and cu02='" & Right(p_stCust, 1) & "' "
         strTmp = "select cu64,cu04,rtrim(cu05||' '||cu88||' '||cu89||' '||cu90) cu05,cu06,CU10 N3,cu13 SAno from customer where cu01='" & Left(p_stCust, 8) & "' and cu02='0' "
         'cancel by sonia 2017/8/11 移到下面再判斷權限
         'If Pub_StrUserSt03 <> "M51" And Pub_strUserST05 <> "01" And Pub_strUserST05 <> "09" Then
         '   strtmp = strtmp & " and cu13 ='" & strUserNum & "' "
         'End If
         'end 2017/8/11
         '2009/5/14 end
      'Add By Sindy 2020/5/22
      Case "Y"
         strTmp = "select fa31,fa04,rtrim(fa05||' '||fa63||' '||fa64||' '||fa65) fa05,fa06,FA10 N3,FA120 SAno from fagent where fa01='" & Left(p_stCust, 8) & "' and fa02='0' "
      '2020/5/22 END
      Case "R"
         '2009/5/14 modify by sonia 開放M51權限
         'modify by sonia 2015/6/5 開放01,09等級權限
         'strtmp = "select '',poc03,'','',poc04 N3 from potcustomer1 where poc01='" & Left(p_stCust, 8) & "' and poc02='" & Right(p_stCust, 1) & "' and poc13 like '%" & strUserNum & "%' "
         'modify by sonia 2017/8/11 為判斷權限+poc13
         'strtmp = "select '',NVL(POC03,NVL(RTRIM(POC23||' '||POC24||' '||POC25||' '||POC26),POC27)),'','',poc04 N3,poc13 SAno from potcustomer1 where poc01='" & Left(p_stCust, 8) & "' and poc02='" & Right(p_stCust, 1) & "' "
         strTmp = "select '',NVL(POC03,NVL(RTRIM(POC23||' '||POC24||' '||POC25||' '||POC26),POC27)),'','',poc04 N3,poc13 SAno from potcustomer1 where poc01='" & Left(p_stCust, 8) & "' and poc02='0' "
         'cancel by sonia 2017/8/11 移到下面再判斷權限
         'If Pub_StrUserSt03 <> "M51" And Pub_strUserST05 <> "01" And Pub_strUserST05 <> "09" Then
         '   strtmp = strtmp & " and poc13 like '%" & strUserNum & "%' "
         'End If
         'end 2017/8/11
         '2009/5/14 end
      Case Else
         'Modify By Sindy 2020/5/22
         'MsgBox "往來對象必須為 X 或 R 開頭", vbCritical + vbOKOnly, "檢核資料"
         MsgBox "往來對象必須為 X、Y 或 R 開頭", vbCritical + vbOKOnly, "檢核資料"
         '2020/5/22 END
         GoTo EXITSUB
   End Select
   intA = 1
   Set rsAD = ClsLawReadRstMsg(intA, strTmp)
   p_Cor03Name = ""
   If intA = 1 Then
      For intA = 1 To 3
         If Not IsNull(rsAD(intA)) Then
            p_Cor03Name = rsAD(intA)
            Exit For
         End If
      Next
      'add by sonia 2017/8/11 檢查權限
      'Modified by Lydia 2019/09/10 +傳入客戶編號,建檔人
      'Modified by Lydia 2019/10/18 取消QPGMR的判斷
      'If CheckModifyLimit(rsad("SAno"), p_stCust, p_COR06) = False Then
      'Modified by Lydia 2020/11/03 +判斷特殊設定
      'If PUB_CheckModifyLimit_frm100101_19("" & rsad("SAno"), p_stCust, p_COR06) = False Then
      If PUB_CheckModifyLimit_frm100101_19("" & rsAD("SAno"), p_stCust, p_COR06, bolSpec) = False Then
         GoTo EXITSUB
      End If
      'end 2017/8/11
   Else
      MsgBox "往來對象輸入錯誤！"
      GoTo EXITSUB
   End If
   
   PUB_GetCustData_frm100101_19 = True
   
'Added by Lydia 2024/05/15
EXITSUB:
   Set rsAD = Nothing
'end 2024/05/15
End Function

'Add By Sindy 2009/04/30
'檢查(國外往來記錄)維護權限
'Modified by Lydia 2019/06/18
'Private Function CheckModifyLimit(strChkID As String, bModify As Boolean) As Boolean
'Private Function CheckModifyLimit(strChkID As String, strModify As String) As Boolean
'Modify By Sindy 2019/7/15 改共用函數 + , strChkID2 As String
'strChkID:Create ID
'strChkID2:接洽同仁
'Modify By Sindy 2019/7/25 strChkID As String => strPCU51 As String
'Modify By Sindy 2024/10/1 要傳入strChkID加判斷
Public Function PUB_CheckModifyLimit_frm140402(strPCU51 As String, strChkID As String) As Boolean
   
   PUB_CheckModifyLimit_frm140402 = True
   'Modify By Sindy 2019/7/25
   'If Trim(strUserNum) = "" Or Trim(strChkID) = "" Then Exit Function
   If Trim(strUserNum) = "" Or Trim(strPCU51) = "" Then Exit Function
   '2019/7/25 END
   If Trim(Pub_StrUserSt03) = "M51" Then Exit Function '但M51不受限制
   
   'Added by Lydia 2019/06/18 修改為67002新增的資料只能67002維護,
   '   其他人新增的資料除了67002以外都可以維護 ;
   '   另外99047從國外部調到管理部,先前的規則會令國外部人員無法修改99047新增的資料
   'Modify By Sindy 2019/7/25
'   If (strUserNum = "67002" And strChkID = strUserNum) Or _
'      (strChkID <> "67002" And strUserNum <> "67002") Then
   'Modify By Sindy 2024/10/1 C=國內權限:判斷建檔人員可維護
   '                          F=國外權限:有作業權限者可維護
'   If (strUserNum = "67002" And strPCU51 = "C") Or _
'      (strUserNum <> "67002" And strPCU51 = "F") Then
   'If (strUserNum = strChkID And strPCU51 = "C") Then
   If strPCU51 = "C" Then
      If strUserNum <> strChkID Then
         PUB_CheckModifyLimit_frm140402 = False
         MsgBox "無操作權限 !!!", vbInformation
         Exit Function
   '2019/7/25 END
      End If
   Else 'F
      If CheckUse("frm140402", strExec, False) = False And _
         CheckUse("frm140404", strExec, False) = False Then
         PUB_CheckModifyLimit_frm140402 = False
         MsgBox "您沒有維護此筆潛在客戶的往來記錄權限！"
         Exit Function
      End If
   End If
'   MsgBox "無操作權限 !!!", vbInformation
'   PUB_CheckModifyLimit_frm140402 = False
'   Exit Function
   'end 2019/06/18
   '2024/10/1 END
   
'   '依LoginUser和輸入人員之部門第一碼判斷部門權限, 不同部門資料不可修改, 但可查詢
'   strExc(0) = "SELECT A.ST03,B.ST03 FROM STAFF A,STAFF B " & _
'                      "WHERE A.ST01 = '" & strUserNum & "' " & _
'                           "AND B.ST01 = '" & Trim(strChkID) & "' "
'   intI = 1
'   Set RsTemp = ClsLawReadRstMsg(intI, strExc(0))
'   If intI = 1 Then
''      If bModify = True Then
''         If Trim(RsTemp(0)) = Trim(RsTemp(1)) Then Exit Function
''      Else
'         If Left(Trim(RsTemp(0)), 1) = Left(Trim(RsTemp(1)), 1) Then Exit Function
''      End If
'   Else
'      Exit Function
'   End If
'
'   PUB_CheckModifyLimit_frm140402 = False
'   'Remove by Lydia 2019/06/18
'   'If bModify = True Then
'   '   MsgBox "無修改權限 !!!", vbInformation
'   'End If
End Function

'Add By Sindy 2009/05/12
'Modified by Lydia 2014/12/4 增加國內潛在客戶查詢，並回傳客戶名稱
'Public Function PUB_GetCustData(p_stCust As String, Optional strName As String) As Boolean
'Modified by Lydia 2020/12/30 +定稿語文 strLanguageType
Public Function PUB_GetCustData(p_stCust As String, Optional strName As String, Optional ByRef lName As String, Optional ByRef strLanguageType As String) As Boolean
'Dim strName As String
Dim strChkEmp As String 'Add By Sindy 2019/7/15
Dim strPCU51 As String 'Add By Sindy 2019/7/26
Dim strTmp As String, intA As Integer, rsAD As New ADODB.Recordset 'Added by Lydia 2024/05/15

   'Modify By Sindy 2021/3/25 + 平台往來記錄
   '平台編號會是4位的流水號
   If Left(p_stCust, 1) = "X" Or Left(p_stCust, 1) = "Y" Or Left(p_stCust, 1) = "R" Then
   '2021/3/25 END
      p_stCust = ChangeCustomerL(p_stCust) 'Added by Lydia 2020/12/30
   End If
   
   PUB_GetCustData = False
   
   Select Case Left(p_stCust, 1)
      Case "X"
         'Modified by Lydia 2020/12/30 +CU64 as LanType
         strTmp = "select cu64,cu04,rtrim(cu05||' '||cu88||' '||cu89||' '||cu90) cu05,cu06,CU10 N3,CU81,CU64 as LanType " & _
                          "from customer where cu01='" & Left(p_stCust, 8) & "' and cu02='" & Right(p_stCust, 1) & "'"
      Case "Y"
         'Modified by Lydia 2020/12/30 +FA31 as LanType
         strTmp = "select fa31,fa04,rtrim(fa05||' '||fa63||' '||fa64||' '||fa65) fa05,fa06,FA10 N3,FA46,FA31 as LanType " & _
                          "from fagent where fa01='" & Left(p_stCust, 8) & "' and fa02='" & Right(p_stCust, 1) & "'"
      Case "R"
        'Modified by Lydia 2014/12/4 增加國內潛在客戶查詢
        ' strtmp = "select pcu36,pcu08,rtrim(pcu03||' '||pcu04||' '||pcu05||' '||pcu06) pcu03,pcu07,PCU09 N3,PCU41 from potcustomer where pcu01='" & Left(p_stCust, 8) & "' and pcu02='" & Right(p_stCust, 1) & "'"
         'Modify By Sindy 2019/7/26 + ,PCU51
         'Modified by Lydia 2020/12/30
         'strtmp = "select pcu36,pcu08,rtrim(pcu03||' '||pcu04||' '||pcu05||' '||pcu06) pcu03,pcu07,PCU09 N3,PCU41,PCU51 from potcustomer where pcu01='" & Left(p_stCust, 8) & "' and pcu02='" & Right(p_stCust, 1) & "' " & _
                     "union select '1',poc03,poc03,' ' pcu07, poc04 N3,poc17,'' from potcustomer1 where poc01='" & Left(p_stCust, 8) & "' and poc02='" & Right(p_stCust, 1) & "' "
         strTmp = "select pcu36,pcu08,rtrim(pcu03||' '||pcu04||' '||pcu05||' '||pcu06) pcu03,pcu07,PCU09 N3,PCU41,PCU51,PCU36 as LanType " & _
                           "from potcustomer " & _
                           "where pcu01='" & Left(p_stCust, 8) & "' and pcu02='" & Right(p_stCust, 1) & "' "
         strTmp = strTmp & "union select '1',poc03,poc03,' ' pcu07, poc04 N3,poc17,'','' as LanType " & _
                           "from potcustomer1 " & _
                           "where poc01='" & Left(p_stCust, 8) & "' and poc02='" & Right(p_stCust, 1) & "' "
      Case Else
         'Modify By Sindy 2021/3/25 + 平台往來記錄
         '平台編號會是4位的流水號
         If Len(p_stCust) = 4 And IsNumeric(p_stCust) = True Then
            strTmp = "select CW03,cw12 pcu08,cw12 pcu03,cw12 pcu07,'' N3,cw06,'' as LanType " & _
                           "from CustWeb " & _
                           "where CW01='" & p_stCust & "' "
         Else
         '2021/3/25 END
            MsgBox "往來對象必須為 X、Y 或 R 開頭，或是4碼平台編號。", vbCritical + vbOKOnly, "檢核資料"
            GoTo EXITSUB
         End If
   End Select
   intA = 1
   Set rsAD = ClsLawReadRstMsg(intA, strTmp)
   'lbl1 = ""
   If intA = 1 Then
      'Modify By Sindy 2021/3/25 + 平台往來記錄
      '平台編號會是4位的流水號
      If Len(p_stCust) = 4 And IsNumeric(p_stCust) = True Then
         If rsAD.Fields("CW03") <> "7" Then
            MsgBox "往來對象輸入錯誤！平台往來記錄只開放【媒介平台】"
            GoTo EXITSUB
         End If
      End If
      
      'Modified by Lydia 2014/12/4 回傳客戶名稱
      If Len(lName) > 0 Then
         If Left(p_stCust, 1) = "X" Then
            'Modified by Lydia 2015/12/14 + ""
            lName = "" & rsAD!cu05
         ElseIf Left(p_stCust, 1) = "Y" Then
            'Modified by Lydia 2015/12/14 + ""
            lName = "" & rsAD!FA05
         Else
            If IsNull(rsAD!pcu08) Then
              lName = "" & rsAD!pcu03
            Else
              lName = "" & rsAD!pcu08
            End If
         End If
         PUB_GetCustData = True
         GoTo EXITSUB
      End If
      
      'Added by Lydia 2020/12/30 Y編號:英文>中文>日文
      strLanguageType = "" & rsAD.Fields("LanType")
      If Left(p_stCust, 1) = "Y" Then
           strName = "" & rsAD.Fields(2)
           If strName = "" Then
               strName = IIf("" & rsAD.Fields(1) <> "", "" & rsAD.Fields(1), "" & rsAD.Fields(3))
           End If
      Else
      'end 2020/12/30
            For intA = 1 To 3
               If Not IsNull(rsAD(intA)) Then
                  strName = rsAD(intA)
                  Exit For
               End If
            Next
      End If 'Addded by Lydia 2020/12/30
      
      If Left(p_stCust, 1) = "R" Then
         '依LoginUser和輸入人員之部門第一碼判斷部門權限, 相同者才可輸入查詢
         '但M51不受限制
         '2010/8/10 modify by sonia 林特助94007不受限(於frm140404之SR10='Y')
         'strtmp = "SELECT A.ST03,B.ST03 FROM STAFF A,STAFF B " & _
                            "WHERE A.ST01 = '" & strUserNum & "' " & _
                                 "AND B.ST01 = '" & Trim(rsad(5)) & "' "
         strChkEmp = Trim(rsAD(5)) 'Add By Sindy 2019/7/15
         strPCU51 = Trim("" & rsAD("pcu51")) 'Add By Sindy 2019/7/26
         strTmp = "SELECT A.ST03,B.ST03,NVL(R1.SR10,R2.SR10) FROM STAFF A,STAFF B,STAFF_RIGHT R1,STAFF_RIGHT R2 " & _
                            "WHERE A.ST01 = '" & strUserNum & "' AND B.ST01 = '" & strChkEmp & "' " & _
                            "AND A.ST01=R1.SR01(+) AND 'frm140404'=R1.SR02(+) AND A.ST05=R2.SR01(+) AND 'frm140404'=R2.SR02(+) "
         intA = 1
         Set rsAD = ClsLawReadRstMsg(intA, strTmp)
         If intA = 1 Then
            If Trim(rsAD(0)) <> "M51" And _
               Left(Trim(rsAD(0)), 1) <> Left(Trim(rsAD(1)), 1) Then
                  '2010/8/10 MODIFY BY SONIA
                  'MsgBox "您沒有維護此筆潛在客戶的往來記錄權限！"
                  'goto exitsub
                  If "" & rsAD(2) <> "Y" Then
                     'Add By Sindy 2019/7/15
                     'Modify By Sindy 2019/7/26
                     'If PUB_CheckModifyLimit_frm140402(strChkEmp, "M") = False Then
                     If PUB_CheckModifyLimit_frm140402(strPCU51, strChkEmp) = False Then
                     '2019/7/26 END
                     '2019/7/15 END
                        'MsgBox "您沒有維護此筆潛在客戶的往來記錄權限！"
                        GoTo EXITSUB
                     End If
                  End If
                  '2010/8/10 END
            End If
         End If
      End If
   Else
      MsgBox "無此往來對象，輸入錯誤！"
      GoTo EXITSUB
   End If
   'lbl1 = strName
   
   PUB_GetCustData = True
   
'Added by Lydia 2024/05/15
EXITSUB:
   Set rsAD = Nothing
'end 2024/05/15
End Function

'Added by Morgan 2019/7/15
'檢查是否獨立水單客戶(自 Frmacc2170.ProcessData 抽出)
'pCaseNo=本所案號(CFPXXXXXXXXX),pCustNo=客戶編號
Public Function PUB_ChkNoMergePayCust(pCaseNo As String, Optional pCustNo As String) As Boolean
   Dim strCustNo As String
   If pCustNo <> "" Then
      strCustNo = pCustNo
   Else
      strCustNo = PUB_GetCustNo(pCaseNo)
   End If
   If strCustNo <> "" Then
      '2013/3/12 MODIFY BY SONIA 加入 X6383801中國醫藥大學
      'MODIFY BY SONIA 2014/3/28 顏永堅3/25郵件所列大學及其關係企業都要加
      'If Left(adopatent.Fields("pa26").Value, 8) = "X6321900" Or Left(adopatent.Fields("pa26").Value, 8) = "X4398806" Or Left(adopatent.Fields("pa26").Value, 8) = "X6383801" Then
      'modify by sonia 2017/4/10 婉莘要求加X69534彩豐精技   2017/5/15陳德發及郭雅娟要求取消
      'modify by sonia 2017/4/27 高國碩要求X60149改為只要母號,關係企業不要'modify by sonia 2017/10/11 張詠翔要求取消X6014900
      If Left(strCustNo, 6) = "X44551" Or Left(strCustNo, 6) = "X62079" _
         Or Left(strCustNo, 6) = "X43988" Or Left(strCustNo, 6) = "X63219" Or Left(strCustNo, 6) = "X62319" _
         Or Left(strCustNo, 6) = "X60498" Or Left(strCustNo, 6) = "X62702" Or Left(strCustNo, 6) = "X63838" Then
         PUB_ChkNoMergePayCust = True
         
      'modify by sonia 2020/7/20 茹曣加X79919000
      'modify by sonia 2020/11/24 魏裕仁加X43714050   '2021/1/5取消   '2021/4/19再次加入
      'modify by sonia 2021/3/17 顧服組黃教威加5編號X69365010(長庚醫療財團法人嘉義長庚紀念醫院),X54243070(國立台灣大學),X80847020(財團法人國家實驗研究院),X83983000(盧彥蓓),X83984000(林致廷)
      'modify by sonia 2021/9/28 顧服組的客戶X38805030資策會--郭雅娟
      'modify by sonia 2021/10/1 婉莘取得魏裕仁同意，X43714050水單可合併，但要以是以請款單的日期對照台銀的匯率作為請款費用，故僅此處取消
      'Modified by Morgan 2023/2/22 +X69365000、X69365020、X69365050、X69365060、X69365070、X69365080--黃教威
      'modify by sonia 2024/6/13 +X82532010--瑞婷
      ElseIf Left(strCustNo, 8) = "X6901101" Or Left(strCustNo, 8) = "X6073801" Or Left(strCustNo, 8) = "X7991900" Or _
             Left(strCustNo, 8) = "X6936500" Or Left(strCustNo, 8) = "X6936501" Or Left(strCustNo, 8) = "X6936502" Or _
             Left(strCustNo, 8) = "X6936505" Or Left(strCustNo, 8) = "X6936506" Or Left(strCustNo, 8) = "X6936507" Or _
             Left(strCustNo, 8) = "X6936508" Or Left(strCustNo, 8) = "X5424307" Or Left(strCustNo, 8) = "X8084702" Or _
             Left(strCustNo, 8) = "X8398300" Or Left(strCustNo, 8) = "X8398400" Or _
             Left(strCustNo, 8) = "X3880503" Or Left(strCustNo, 8) = "X8253201" Then
         PUB_ChkNoMergePayCust = True
      End If
   End If
End Function

'Added by Morgan 2019/7/17
'抓外專工程師主管, 日文組要抓第二、三級主管
'注意:basFunction : PUB_IPDept_ToSortOutSub_F21
'     basPublic:  PUB_SettingFCeMail ...有相似的規則, 若規則異動, 上面2個函數要一併檢查是否需要調整
'Modified by Lydia 2021/04/15 只抓三級主管(副理)bolThird
'Modified by Lydia 2022/12/21 不抓特定主管bolJumpEx
'Modify By Sindy 2023/5/12 , Optional ByVal bolGetSt52 As Boolean = False : 要抓二級主管 'Memo by Lydia 2025/08/15 非日文組傳bolThird=False,bolGetSt52=True，回傳所有主管
Public Function PUB_GetFCPEngSup(pEngNo As String, Optional ByVal bolThird As Boolean = False, _
   Optional ByVal bolJumpEx As Boolean = False, Optional ByVal bolGetSt52 As Boolean = False) As String
   
Dim stSQL As String, intQ As Integer
Dim rsQuery As ADODB.Recordset
  
   'Modify By Sindy 2020/2/10 + ,st16,st52
   'Modified by Lydia 2020/02/10 + st53 三級主管
   'Modified by Morgan 2020/12/8 取消主管為本人時改抓職代設定(目前已不適用，Ex:P-123287承辦人88003王協理會抓到89020陳怡如)--淑華
   'stSQL = "select decode(oMan,st01,B0102,oMan) ES,st16,st52,st53 from staff s1,SetSpecMan,ABS001" & _
      " where st01='" & pEngNo & "' and OCODE(+)=decode(st16,'1','T','2','R','3','S','4','T1') and B0101(+)=st01
   'Modified by Lydia 2022/05/12 + st54,st55
   'Modified by Lydia 2022/09/08 判斷主管是否在職; ex.FCP-61585實審通知1202從PUB_GetFCPPromoterNo=>PUB_GetSpecCP14到這裡
   'stSQL = "select oMan ES,st16,st52,st53,st54,st55 from staff s1,SetSpecMan,ABS001" & _
      " where st01='" & pEngNo & "' and OCODE(+)=decode(st16,'1','T','2','R','3','S','4','T1') and B0101(+)=st01"
   stSQL = "select oMan ES,s1.st16,s1.st52,b2.st04 as st52_t,s1.st53,b3.st04 as st53_t,s1.st54,b4.st04 as st54_t,s1.st55, b5.st04 as st55_t " & _
                "from staff s1,SetSpecMan,ABS001 ,staff b2, staff b3,staff b4, staff b5 " & _
                "where s1.st01='" & pEngNo & "' and OCODE(+)=decode(s1.st16,'1','T','2','R','3','S','4','T1') and B0101(+)=s1.st01 " & _
                "and s1.st52=b2.st01(+) and s1.st53=b3.st01(+) and s1.st54=b4.st01(+) and s1.st55=b5.st01(+) "
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      'Modify By Sindy 2020/2/10 + 日文組要抓二級主管
      'Modified by Lydia 2021/04/15 +判斷只抓三級主管(副理) bolThird
      'Modify By Sindy 2023/5/12 + Or bolGetSt52 = True
      '                          工程師撰寫信若由主任判發的信，outlook郵件信尾署名及主旨
      '                          皆帶判發主任名(原程式皆帶該組副理)，故請調整英文組三組, 撰寫信函發FC郵件（工程師署名）:要抓二級主管
      If "" & rsQuery("st16") = "3" Or bolThird = True Or bolGetSt52 = True Then
         'Added by Lydia 2021/04/15 只抓三級主管(副理)
         If bolThird = True Then
            'Modified by Lydia 2022/05/12 因為日文組的層級又多一層
            'If "" & rsQuery.Fields("st53") <> "" Then
            'Modified by Lydia 2022/09/08 判斷在職人員 => "" & rsQuery.Fields("st54_t") = "1"
            If "" & rsQuery.Fields("st54") <> "" And "" & rsQuery.Fields("st54_t") = "1" Then
                 PUB_GetFCPEngSup = "" & rsQuery("st54")
            'Modified by Lydia 2022/09/08 判斷在職人員 => "" & rsQuery.Fields("st53_t") = "1"
            ElseIf "" & rsQuery.Fields("st53") <> "" And "" & rsQuery.Fields("st53_t") = "1" Then
            'end 2022/05/12
                 PUB_GetFCPEngSup = "" & rsQuery("st53")
            'Modified by Lydia 2022/09/08 判斷在職人員
            'Else
            ElseIf "" & rsQuery.Fields("st52") <> "" And "" & rsQuery.Fields("st52_t") = "1" Then
                 PUB_GetFCPEngSup = "" & rsQuery("st52")
            End If
         Else
         'end 2021/04/15
            If "" & rsQuery.Fields("st52") <> "" And "" & rsQuery.Fields("st52_t") = "1" Then 'Added by Lydia 2022/09/08 判斷在職人員
                PUB_GetFCPEngSup = "" & rsQuery("st52")
            End If 'Added by Lydia 2022/09/08
            'Added by Lydia 2020/02/10 與Sharon確認過:一併通知三級主管
            'Modified by Lydia 2022/09/08 判斷在職人員 => "" & rsQuery.Fields("st53_t") = "1"
            If "" & rsQuery.Fields("st53") <> "" And "" & rsQuery.Fields("st53_t") = "1" Then
                PUB_GetFCPEngSup = PUB_GetFCPEngSup & IIf(PUB_GetFCPEngSup <> "", ";", "") & rsQuery.Fields("st53")
            End If
            'end 2020/02/10
            'Added by Lydia 2022/05/12 因為日文組的層級又多一層
            'Modified by Lydia 2022/09/08 判斷在職人員 => "" & rsQuery.Fields("st54_t") = "1"
            If "" & rsQuery.Fields("st54") <> "" And "" & rsQuery.Fields("st54_t") = "1" Then
                PUB_GetFCPEngSup = PUB_GetFCPEngSup & IIf(PUB_GetFCPEngSup <> "", ";", "") & rsQuery.Fields("st54")
            End If
            'end 2022/05/12
         End If 'Added by Lydia 2021/04/15
      End If
      If PUB_GetFCPEngSup = "" Then
      '2020/2/10 END
         PUB_GetFCPEngSup = "" & rsQuery(0)
      End If
      'Added by Lydia 2022/12/21 外專日文組通知信一律加OWen(系統特殊設定S); bolJumpEx=命名作業完成通知排除Owen
      If "" & rsQuery.Fields("st16") = "3" And InStr(PUB_GetFCPEngSup, "" & rsQuery.Fields("ES")) = 0 And bolJumpEx = False Then
         PUB_GetFCPEngSup = PUB_GetFCPEngSup & IIf(PUB_GetFCPEngSup <> "", ";", "") & rsQuery.Fields("ES")
      End If
      'end 2022/12/21
   End If
   Set rsQuery = Nothing
End Function

'Added by Morgan 2019/7/17
'抓外專程序主管(二級管制人)
'Modify By Sindy 2023/8/18 +, Optional bolFindA0908 As Boolean = False
Public Function PUB_GetFCPProSup(pProcNo As String, Optional bolFindA0908 As Boolean = False) As String
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   
   stSQL = "select st52 from staff where st01='" & pProcNo & "' and st52 is not null"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      PUB_GetFCPProSup = "" & rsQuery(0)
   End If
   'Add By Sindy 2023/8/18 沒有抓到二級管制人時,再加抓部門主管
   If bolFindA0908 = True And PUB_GetFCPProSup = "" Then
      stSQL = "select a0908 from acc090 where a0901='" & PUB_GetST03(pProcNo) & "' and a0908 is not null"
      intQ = 1
      Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
      If intQ = 1 Then
         PUB_GetFCPProSup = "" & rsQuery(0)
      End If
   End If
   '2023/8/18 END
   
   Set rsQuery = Nothing
End Function

'Mark by Amy 2024/06/14 目前由盟立下載電子檔,交由業務處理,故不需再印地址條
''Add by Amy 2019/07/26 傳入客戶編號/收據抬頭,取得客戶或抬頭地址(從補開/請款單及發票列印 PrintAddress合併修改)
''bolBusinessAddr:True 只回傳營業地址
'Public Function GetInvoiceAddress(ByVal stCusNo As String, ByVal stInvTitle As String, ByVal bolBusinessAddr As Boolean, Optional ByRef stCU179 As String = "") As String
'    Dim RsQ As New ADODB.Recordset
'    Dim intQ As Integer
'    Dim strQ As String
'
'    GetInvoiceAddress = "": stCU179 = ""
'    '收據抬頭為3個字以下(含3個字)以客戶編號為主
'    If Len(Trim(stInvTitle)) <= 3 Then
'        strQ = "Select cu01,cu02,cu04,cu112,cu23,cu30,cu31,cu179 From Customer " & _
'                    "Where cu01='" & Left(Trim(stCusNo), 8) & "' and cu02='" & Mid(Trim(stCusNo), 9, 1) & "' "
'        intQ = 1
'        Set RsQ = ClsLawReadRstMsg(intQ, strQ)
'        If intQ = 1 Then
'            '聯絡地址優先
'            If Trim("" & RsQ.Fields("cu31")) <> "" And bolBusinessAddr = False Then
'                GetInvoiceAddress = Trim("" & RsQ.Fields("cu30")) & " " & Trim("" & RsQ.Fields("cu31"))
'            '再來中文地址
'            ElseIf Trim("" & RsQ.Fields("cu23")) <> "" Then
'                GetInvoiceAddress = Trim("" & RsQ.Fields("cu112")) & " " & Trim("" & RsQ.Fields("cu23"))
'            End If
'            stCU179 = "" & RsQ.Fields("cu179")
'        End If
'    '收據抬頭抓客戶檔之CU04
'    Else
'        '以收據抬頭抓客戶檔之CU04,若有資料則顯示中文地址(不使用Trim,否則遇有造字可能會錯)
'        '若不存在,再抓收據抬頭資料檔acc420的地址
'        'Modify By Sindy 2022/9/8 + or cu80='國內同業' or cu80='解除對造'
'        'Modify By Sindy 2023/2/24 針對客戶狀態CU80的控制要再加不得代理專利、不得代理商標。
'        strQ = "Select cu01,cu02,cu04,cu112,cu23,cu30,cu31,cu179 From Customer " & _
'                    "Where cu04='" & stInvTitle & "' and (cu80 is null or cu80='其他' or cu80='業務自行處理' or cu80='國內同業' or cu80='解除對造' or cu80='不得代理專利' or cu80='不得代理商標') and cu02=0"
'        intQ = 1
'        Set RsQ = ClsLawReadRstMsg(intQ, strQ)
'        '客戶資料
'        If intQ = 1 Then
'            '聯絡地址優先
'            If Trim("" & RsQ.Fields("cu31")) <> "" And bolBusinessAddr = False Then
'                GetInvoiceAddress = Trim("" & RsQ.Fields("cu30")) & " " & Trim("" & RsQ.Fields("cu31"))
'            '再來中文地址
'            ElseIf Trim("" & RsQ.Fields("cu23")) <> "" Then
'                GetInvoiceAddress = Trim("" & RsQ.Fields("cu112")) & " " & Trim("" & RsQ.Fields("cu23"))
'            End If
'            stCU179 = "" & RsQ.Fields("cu179")
'        '收據抬頭
'        Else
'            '收據抬頭不使用Trim,否則遇有造字可能會錯
'            strQ = "Select * From acc420 Where a4201='" & stInvTitle & "' "
'            intQ = 1
'            Set RsQ = ClsLawReadRstMsg(intQ, strQ)
'            If intQ = 1 Then
'                '郵寄地址優先
'                If Trim("" & RsQ.Fields("a4203")) <> "" And bolBusinessAddr = False Then
'                    GetInvoiceAddress = Trim("" & RsQ.Fields("a4203"))
'                '再來營業地址
'                ElseIf Trim("" & RsQ.Fields("a4215")) <> "" Then
'                    GetInvoiceAddress = Trim("" & RsQ.Fields("a4215"))
'                End If
'                stCU179 = "" & RsQ.Fields("a4227")
'            End If
'        End If
'    End If
'    Set RsQ = Nothing
'End Function

'Add by Amy 2018/03/27 +回傳Excel欄位
Public Function GetFieldStr(ByVal intAdd As Integer, ByVal intField As Integer) As String
    Dim intDiv As Integer, intMod As Integer
    
    GetFieldStr = ""
    If intAdd + intField > 90 Then
        intDiv = intAdd \ 26 - 1
        intMod = intAdd Mod 26
        GetFieldStr = Chr(intDiv + intField) & Chr(intMod + intField)
    Else
        GetFieldStr = Chr(intAdd + intField)
    End If
End Function

'Added by Lydia 2019/08/06 設定系統之案件屬性
'Modify By Sindy 2021/7/16 改為用 Object 型態
'Public Sub PUB_SetCasePTM(ByVal p01 As String, Optional ByRef P02 As String, Optional ByRef p_Combo As ComboBox, Optional ByRef p_Pty As String)
Public Sub PUB_SetCasePTM(ByVal p01 As String, Optional ByRef p02 As String, Optional ByRef p_Combo As Object, Optional ByRef p_Pty As String)
Dim strCon As String
Dim intB As Integer
Dim rsB1 As New ADODB.Recordset
   
   If p01 = "" Then Exit Sub
   
   If p01 <> "" Then strCon = strCon & "and ptm01='" & p01 & "' "
   If p02 <> "" Then strCon = strCon & "and ptm02='" & p02 & "' "
   'Added by Lydia 2020/06/12 清空下拉選單
   If TypeName(p_Combo) <> "Nothing" Then
      p_Combo.Clear
   Else
      p_Pty = ""
   End If
   
   strCon = "select ptm02,ptm03 from patenttrademarkmap where " & Mid(strCon, 4) & " order by ptm02 asc"
   intB = 1
   Set rsB1 = ClsLawReadRstMsg(intB, strCon)
   If intB = 1 Then
      rsB1.MoveFirst
      Do While Not rsB1.EOF
         If TypeName(p_Combo) <> "Nothing" Then
            p_Combo.AddItem rsB1.Fields("ptm03")
         Else
            p_Pty = p_Pty & rsB1.Fields("ptm03") & ","
         End If
         rsB1.MoveNext
      Loop
   End If
   Set rsB1 = Nothing
   
   Exit Sub
End Sub

'Added by Lydia 2018/07/12 取得所有FCP工程師主管編號(含F編號)
'Move by Lydia 2019/08/15 從basPublic移過來
Public Function Pub_GetSt16Man(ByVal bolFNo As Boolean) As String
Dim rsA1 As New ADODB.Recordset
Dim intA As Integer, strA1 As String
Dim strTp As String

   strA1 = "select Oman from setSpecMan where ocode in ('R','S','T','T1') "
   intA = 1
   Set rsA1 = ClsLawReadRstMsg(intA, strA1)
   If intA = 1 Then strTp = rsA1.GetString(adClipString, , , ",")
   '取得工程師主管的外翻編號(F)
   If bolFNo = True Then
        strA1 = "select sim02 from staff_idmap,staff where sim01 in (" & GetAddStr(strTp) & ")  and st01=sim02 and st04='1' "
        Set rsA1 = ClsLawReadRstMsg(intA, strA1)
        If intA = 1 Then strA1 = rsA1.GetString(adClipString, , , ",")
        strTp = strTp & strA1
   End If
   Pub_GetSt16Man = strTp
End Function

'Add by Amy 2019/08/27 傳入部門代號取得「該區」員工編號 ex:北一區 10011 (2022/05/18 已改為區無效編號 ex:10019)
Public Function GetAreaEmpNo(ByVal stDeptNo As String, Optional ByRef stName As String = "") As String
    Dim RsQ As New ADODB.Recordset
    Dim strQ As String
    Dim intQ As Integer, bolBackName As Boolean
    
    GetAreaEmpNo = ""
    If stName <> MsgText(601) Then
        bolBackName = True
        stName = ""
    End If
   
    'Modify by Amy 2022/04/18
    strQ = "*"
    'Modify by Amy 2022/05/18
    If strSrvDate(1) >= 無效客戶轉智權人員啟用日 Then
        strQ = "Nvl(A0919,A0909) as a0909,a0902"
    End If
    strQ = "Select " & strQ & " From Acc090 Where a0901='" & stDeptNo & "' "
    'end 2022/04/18
    intQ = 1
    Set RsQ = ClsLawReadRstMsg(intQ, strQ)
    If intQ = 1 Then
        GetAreaEmpNo = "" & RsQ.Fields("a0909")
        If bolBackName = True Then stName = "" & RsQ.Fields("a0902")
    End If
    Set RsQ = Nothing
End Function

'Added by Morgan 2019/11/12
'計算專用期止日/年費期限/延展費期限
'pStartDate:起算日
'pYears:年度
'pReduceOneDay:是否要減1天 Y=要 N/空=不要
'Modified by Morgan 2019/12/3 考慮年非整數情形 pYears 改 Single,加月計算
'Modified by Morgan 2019/12/4 pReduceOneDay 取消預設,改判斷 Y=要
Public Function PUB_GetEndDate(ByVal pStartDate As String, ByVal pYears As Single, ByVal pReduceOneDay As String, Optional ByVal pNation As String) As String
   Dim stDate As String
   Dim stTmp As String, iYear As Integer, iMonth As Integer
         
   pStartDate = DBDATE(pStartDate) '轉西元
   
   iYear = Trunc(pYears) '年
   stDate = CompDate(0, iYear, pStartDate)
   
   iMonth = 12 * (pYears - iYear) '月
   If iMonth > 0 Then
      stDate = CompDate(1, iMonth, stDate)
   End If
     
   '台灣案若起算為月底時對應的期限也是月底 Ex:20190228+1年=20200229
   If pNation = "000" Then
      stTmp = CompDate(2, 1, pStartDate)
      If Mid(stTmp, 5, 2) <> Mid(pStartDate, 5, 2) Then
         stDate = CompDate(2, -1, Left(CompDate(1, 1, stDate), 6) & "01")
      End If
   End If
   
   If pReduceOneDay = "Y" Then
      '20190228+1年-1天 = 20200228
      '20200229+1年-1天 = 20210228
      If Right(stDate, 2) >= Right(pStartDate, 2) Then
         PUB_GetEndDate = CompDate(2, -1, stDate)
      Else
         PUB_GetEndDate = stDate
      End If
   Else
      PUB_GetEndDate = stDate
   End If
End Function

'Added by Morgan 2019/11/20
'修正發 EMail 時若列的第1個字元為"."寄送時會被吃掉問題
Public Function PUB_FixFirstDot(pText As String) As String
   Dim arr() As String, ii As Integer, stNew As String
   arr = Split(pText, vbCrLf)
   stNew = ""
   For ii = LBound(arr) To UBound(arr)
      If Left(arr(ii), 1) = "." Then
         arr(ii) = "." & arr(ii)
      End If
      stNew = stNew & IIf(stNew = "", "", vbCrLf) & arr(ii)
   Next
   PUB_FixFirstDot = stNew
End Function

'Added by Morgan 2019/11/20
'依系統別取得簽名檔代碼
Public Function PUB_GetSignID(pSys As String) As Integer
   If pSys = "P" Or pSys = "PS" Then
      PUB_GetSignID = 1 'patent-中文
   ElseIf pSys = "CFP" Or pSys = "CPS" Then
      PUB_GetSignID = 2 'patent-英文
   'Added by Morgan 2020/1/13
   ElseIf pSys = "T" Then
      PUB_GetSignID = 4 'tm-中文
   'end 2020/1/13
   'Add By Sindy 2020/4/27 + 管理部
   ElseIf pSys = "" And Left(Pub_StrUserSt03, 1) = "M" Then
      PUB_GetSignID = 5 'Account-中文
   '2020/4/27 END
   Else
      PUB_GetSignID = 3 'ipdept-英文
   End If
End Function

'Added by Morgan 2019/11/21
'Modified by Morgan 2022/3/24 +pUTF8
Public Function PUB_GetContentMIME(pContent As String, pSignId As Integer, Optional pPicBody As String, Optional pUTF8 As Boolean = False) As String
   Dim stMime As String, strSignFile As String, strSignHead As String, strSignBody As String, strSignAtt As String
   Dim iCompPicId As Integer '公司圖檔代碼 Added by Morgan 2020/1/13
   Dim iBodyId As Integer 'Added by Morgan 2020/3/27
   Dim stHTML As String
   
      
   '注意:若加下面純文字內容時,OUTLOOK顯示會不正常,故有簽名時不帶
   If pSignId > 0 Then
      stMime = "Content-Type: multipart/related;" & vbCrLf
      stMime = stMime & vbTab & "boundary=" & Chr$(34) & cBoundaryB & Chr$(34) & ";" & vbCrLf
      stMime = stMime & vbTab & "type=""text/html""" & vbCrLf & vbCrLf
   Else
      stMime = "Content-Type: multipart/alternative;" & vbCrLf
      stMime = stMime & vbTab & "boundary=" & Chr$(34) & cBoundaryB & Chr$(34) & vbCrLf & vbCrLf
      
      stMime = stMime & cDASH2 & cBoundaryB & vbCrLf
      stMime = stMime & "Content-Type: text/plain;" & vbCrLf
      'Modified by Morgan 2022/3/24  +utf-8
      'stMIME = stMIME & vbTab & cCharset & cCTEnc & vbCrLf
      If pUTF8 Then
         stMime = stMime & vbTab & "charset=""utf-8""" & vbCrLf & "Content-Transfer-Encoding: base64" & vbCrLf & vbCrLf
         '-- send text blurb:
         stMime = stMime & ConvertToBase64(TextBlurb(), False, True, True) & vbCrLf & vbCrLf
      Else
         stMime = stMime & vbTab & cCharset & cCTEnc & vbCrLf
         '-- send text blurb:
         stMime = stMime & TextBlurb()
      End If
   End If
                  
   stMime = stMime & cDASH2 & cBoundaryB & vbCrLf
   stMime = stMime & "Content-Type: text/html;" & vbCrLf
   'Modified by Morgan 2022/3/24  +utf-8
   'stMIME = stMIME & vbTab & cCharset & cCTEnc & vbCrLf & vbCrLf
   If pUTF8 Then
      stMime = stMime & vbTab & "charset=""utf-8""" & vbCrLf & "Content-Transfer-Encoding: base64" & vbCrLf & vbCrLf
   Else
      stMime = stMime & vbTab & cCharset & cCTEnc & vbCrLf & vbCrLf
   End If
   'end 2022/3/24
   
   'Modified by Morgan 2022/3/24
   'HTML內容另外寫變數以便編碼
   stHTML = "<!DOCTYPE HTML PUBLIC ""-//W3C//DTD HTML 4.0 Transitional//EN"">" & vbCrLf
   stHTML = stHTML & "<HTML><HEAD>" & vbCrLf
   If pUTF8 Then
      stHTML = stHTML & "<META HTTP-EQUIV=""Content-Type"" CONTENT=""text/html; charset=utf-8"">" & vbCrLf
      stHTML = stHTML & "<TITLE id=3DridTitle>TAI E INTERNATIONAL PATENT & LAW OFFICE</TITLE>" & vbCrLf & vbCrLf
      stHTML = stHTML & "<STYLE>BODY {" & vbCrLf
      stHTML = stHTML & vbTab & "MARGIN-TOP: 25px; FONT-SIZE: 10pt; MARGIN-LEFT: 10px; COLOR: #0033cc; FONT-FAMILY: 新細明體-ExtB,Arial " & vbCrLf
      stHTML = stHTML & "}" & vbCrLf
      stHTML = stHTML & "</STYLE>" & vbCrLf & vbCrLf
      stHTML = stHTML & "<META content=""MSHTML 6.00.2800.1578"" name=GENERATOR>"
   
   Else
      stHTML = stHTML & "<META HTTP-EQUIV=3D""Content-Type"" CONTENT=3D""text/html; =" & vbCrLf & "charset=3DBig5"">" & vbCrLf
      stHTML = stHTML & "<TITLE id=3DridTitle>TAI E INTERNATIONAL PATENT & LAW OFFICE</TITLE>" & vbCrLf & vbCrLf
      stHTML = stHTML & "<STYLE>BODY {" & vbCrLf
      stHTML = stHTML & vbTab & "MARGIN-TOP: 25px; FONT-SIZE: 10pt; MARGIN-LEFT: 10px; COLOR: #0033cc; FONT-FAMILY: " & ConvertToQp("細明體") & "," & ConvertToQp("Arial") & " " & vbCrLf
      stHTML = stHTML & "}" & vbCrLf
      stHTML = stHTML & "</STYLE>" & vbCrLf & vbCrLf
      stHTML = stHTML & "<META content=3D""MSHTML 6.00.2800.1578"" name=3DGENERATOR>"
   End If
   
   If pSignId > 0 Then
      strSignFile = App.path & "\$SignHead.txt"
      'Added by Morgan 2022/3/29 UTF8用base64編碼,不必轉QP碼
      If pUTF8 Then
         If PUB_ReadDB2File(strSignFile, 85) = True Then
            strSignHead = PUB_ReadTextFile(strSignFile)
            stHTML = stHTML & strSignHead & vbCrLf
         End If
      Else
      'end 2022/3/29
      
         If PUB_ReadDB2File(strSignFile, 60) = True Then
            strSignHead = PUB_ReadTextFile(strSignFile)
            strSignHead = PUB_FixFirstDot(strSignHead)
            stHTML = stHTML & strSignHead & vbCrLf
      End If
   End If
   End If
   stHTML = stHTML & "</HEAD>" & vbCrLf
   
   If pUTF8 Then
      stHTML = stHTML & "<BODY id=ridBody bgColor=#ffffff>" & vbCrLf
   Else
      stHTML = stHTML & "<BODY id=3DridBody bgColor=3D#ffffff>" & vbCrLf
   End If
   
   stHTML = stHTML & "<DIV>"
   If pSignId = 0 Then
      stHTML = stHTML & pContent
   'Modified by Morgan 2020/1/13 +4
   'Modified by Morgan 2020/12/23 +5
   ElseIf pSignId = 1 Or pSignId = 4 Or pSignId = 5 Then
      '中文:標楷體 14pt
      If pUTF8 Then
         stHTML = stHTML & "<span style=""font-size:14.0pt;font-family:標楷體,Arial"">" & vbCrLf & pContent & vbCrLf & "</span>"
      Else
         stHTML = stHTML & "<span style=3D""font-size:14.0pt;font-family:" & ConvertToQp("標楷體") & "," & ConvertToQp("Arial") & """>" & vbCrLf & PUB_FixFirstDot(pContent) & vbCrLf & "</span>"
      End If
   Else
      '英文:Times New Roman 12pt
      'Added by Morgan 2022/3/24 UTF8用base64編碼,不必轉QP碼
      If pUTF8 Then
         stHTML = stHTML & "<span style=""font-size:12pt;font-family:&quot;Times New Roman&quot;,&quot;serif&quot;"">" & vbCrLf & pContent & vbCrLf & "</span>"
      Else
      'end 2022/3/24
         stHTML = stHTML & "<span style=3D""font-size:12pt;font-family:&quot;Times New Roman&quot;,&quot;serif&quot;"">" & vbCrLf & PUB_FixFirstDot(pContent) & vbCrLf & "</span>"
      End If
   End If
   stHTML = stHTML & "</DIV>" & vbCrLf & vbCrLf
   
   stHTML = stHTML & pPicBody

   If pSignId > 0 Then
     strSignFile = App.path & "\$SignBody.txt"
     
     'Modified by Morgan 2020/3/27
     'If PUB_ReadDB2File(strSignFile, 60 + pSignId) = True Then
     'Modified by Morgan 2020/12/23
     'If pSignId = 4 Then
     '    If strSrvDate(1) >= 智慧所更名日 Then
     '       iBodyId = 85
     '    Else
     '       iBodyId = 60 + pSignId
     '    End If
     'Else
     '    iBodyId = 60 + pSignId
     'End If
     iBodyId = 60 + pSignId
     'end 2020/12/23
     If pUTF8 Then
         If iBodyId = 61 Then
            iBodyId = 70
         ElseIf iBodyId = 62 Then
            iBodyId = 71
         ElseIf iBodyId = 63 Then
            iBodyId = 74
         ElseIf iBodyId = 64 Then
            iBodyId = 75
         Else
            iBodyId = 90
         End If
     End If
     
     If PUB_ReadDB2File(strSignFile, iBodyId) = True Then
     'end 2020/3/27
         strSignBody = PUB_ReadTextFile(strSignFile)
         'Added by Morgan 2022/3/29 UTF8用base64編碼,不必轉QP碼
         If pUTF8 Then
            stHTML = stHTML & strSignBody & vbCrLf
         Else
         'end 2022/3/29
         
            strSignBody = PUB_FixFirstDot(strSignBody)
            stHTML = stHTML & strSignBody & vbCrLf
            
         End If
      End If
   End If
   stHTML = stHTML & "</BODY></HTML>" & vbCrLf & vbCrLf
   If pUTF8 Then
      stMime = stMime & ConvertToBase64(stHTML, False, True, True) & vbCrLf & vbCrLf
   Else
      stMime = stMime & stHTML
   End If
   'end 2022/3/24

   '落款圖檔
   If pSignId > 0 Then
      'Modified by Morgan 2020/12/23
      'If strSrvDate(1) >= 智慧所更名日 Then
      '   iCompPicId = 84
      'Else
      '   If pSignId = 4 Then
      '       iCompPicId = 65 '專利商標
      '   Else
      '       iCompPicId = 57 '專利法律
      '   End If
      'End If
      iCompPicId = 84
      'end 2020/12/23
      
      strSignFile = App.path & "\$SignAttPic1.txt"
      If PUB_ReadDB2File(strSignFile, iCompPicId) = True Then
         strSignAtt = PUB_ReadTextFile(strSignFile)
         stMime = stMime & cDASH2 & cBoundaryB & vbCrLf
         stMime = stMime & strSignAtt & vbCrLf & vbCrLf
      End If
      
      strSignFile = App.path & "\$SignAttPic2.txt"
      If PUB_ReadDB2File(strSignFile, 58) = True Then
         strSignAtt = PUB_ReadTextFile(strSignFile)
         stMime = stMime & cDASH2 & cBoundaryB & vbCrLf
         stMime = stMime & strSignAtt & vbCrLf & vbCrLf
      End If
   End If
   stMime = stMime & cDASH2 & cBoundaryB & cDASH2 & vbCrLf & vbCrLf
   
   PUB_GetContentMIME = stMime
End Function

'Added by Sindy 2019/12/2
'*************************************************
'  電腦自動給號 By 日期
'
'*************************************************
Public Function AutoNoByDate(InputItem As String, InputLength As Integer, Optional intTrans As Integer = 0) As String
Dim adoaccnum As New ADODB.Recordset
Dim strYes As String

'避免相同連線作做2次 transation
Dim BolTransOk As Boolean

   If intTrans = 0 Then
      BolTransOk = True
   Else
      BolTransOk = False
   End If

On Error GoTo TransErr
   
   If adoTaie.ConnectionString = "" Then Set adoTaie = cnnConnection
   
   If BolTransOk = True Then
      adoTaie.BeginTrans
   End If
   
   InputItem = Trim(InputItem)
   adoTaie.Execute "update autonumberdate set aud03 = aud03 where aud01 = '" & InputItem & "'"
   adoaccnum.CursorLocation = adUseClient
   adoaccnum.Open "select * from autonumberdate where aud01 = '" & InputItem & "'", adoTaie, adOpenStatic, adLockReadOnly
   If adoaccnum.RecordCount = 0 Then
      AutoNoByDate = 0
   Else
      If adoaccnum.Fields("aud02").Value <> Val(strSrvDate(1)) Then
         AutoNoByDate = 0
      Else
         AutoNoByDate = adoaccnum.Fields("aud03").Value
      End If
   End If
   If Len(InputItem) > 0 Then
      AutoNoByDate = InputItem & ZeroBeforeNo(str(AutoNoByDate), InputLength)
      strYes = SaveAutoNoByDate(InputItem, Mid(AutoNoByDate, 2, InputLength))
   End If
   adoaccnum.Close
   
   If BolTransOk Then
      adoTaie.CommitTrans
   End If
   
   '避免相同連線作做2次 transation
   Exit Function
   
TransErr:
   If Err.Number = -2147168237 Then
      BolTransOk = False
      Resume Next
   End If
End Function

'Added by Sindy 2019/12/2
'*************************************************
'  電腦給號存檔 By 日期
'
'*************************************************
Public Function SaveAutoNoByDate(InputItem, InputNo As String) As String
Dim adoaccnum As New ADODB.Recordset
   adoaccnum.CursorLocation = adUseClient
   adoaccnum.Open "select * from autonumberDate where aud01 = '" & InputItem & "'", cnnConnection, adOpenDynamic, adLockBatchOptimistic
   If adoaccnum.RecordCount = 0 Then
      adoaccnum.AddNew
      adoaccnum.Fields("aud01").Value = InputItem
   End If
   adoaccnum.Fields("aud02").Value = strSrvDate(1)
   adoaccnum.Fields("aud03").Value = InputNo
   adoaccnum.UpdateBatch
   adoaccnum.Close
   SaveAutoNoByDate = "Y"
End Function

'Add By Sindy 2019/12/4 傳入檔案路徑，開啟Word
Public Function PUB_OpenWord(pDoc As String) As Boolean

   Dim iResumeCnt As Integer
   
On Error GoTo ErrHnd
   
   If TypeName(g_WordAp) <> "Application" Then
      Set g_WordAp = New Word.Application
   End If
   
   g_WordAp.Documents.Open pDoc
   g_WordAp.Visible = True
   PUB_OpenWord = True
   Exit Function
   
ErrHnd:
   'Resume
   If Err.Number <> 0 Then
      If iResumeCnt > 3 Then
         MsgBox "錯誤 : " & Err.Description, vbCritical
      Else
         iResumeCnt = iResumeCnt + 1
         Select Case Err.Number
            Case 91:
               g_WordAp.Documents.add
               Resume Next
            Case 462:
               Set g_WordAp = New Word.Application
               Resume
            Case Else:
               MsgBox "錯誤 : " & Err.Description, vbCritical
         End Select
      End If
   End If
End Function

'Add by Amy 2020/01/08 傳入本所號(無-、追加案號或多國多類碼未輸)回傳系統別
Public Function InputCaseGetSys(ByVal stCase As String) As String
    Dim ii As Integer
    Dim stTP As String
    
    For ii = 1 To Len(stCase)
        stTP = Mid(UCase(stCase), ii, 1)
        If Asc(stTP) >= 65 And Asc(stTP) <= 90 Then
            InputCaseGetSys = InputCaseGetSys & stTP
        ElseIf IsNumeric(stTP) Then
            Exit For
        End If
    Next ii
End Function

'Add By Sindy 2020/1/17
'Modify By Sindy 2020/1/21 + , Optional strChkKeyWord As String = ""
Public Function PUB_ChkFormIsClose(strFormName As String, Optional strChkKeyWord As String = "") As Boolean
Dim nFrm As Form
   
   PUB_ChkFormIsClose = True
   'Add By Sindy 2017/9/19
   '檢查表單是否已開啟，若是，則關閉
   For Each nFrm In Forms
      If StrComp(nFrm.Name, strFormName, vbTextCompare) = 0 Then
         If strChkKeyWord <> "" Then '檢查是否有KeyWord存在,若存在則不關閉視窗,顯示在最上層
            If InStr(nFrm.Caption, strChkKeyWord) > 0 Then
               nFrm.ZOrder
               PUB_ChkFormIsClose = False
               Exit Function
            End If
         End If
         Unload nFrm
         'Add By Sindy 2020/1/17 有資料要儲存,尚需處理...
         If strSaveConfirm = "Y" Then
            nFrm.ZOrder
            PUB_ChkFormIsClose = False
            Exit Function
         Else
         '2020/1/17 END
            Exit For
         End If
      End If
   Next
   '2017/9/19 END
End Function

'Add by Amy 2020/02/07 顯示星期
Public Function GetWeekDay(pDate As Date) As String
   Select Case Format(pDate, "w")
      Case 1
         GetWeekDay = "星期日"
      Case 2
         GetWeekDay = "星期一"
      Case 3
         GetWeekDay = "星期二"
      Case 4
         GetWeekDay = "星期三"
      Case 5
         GetWeekDay = "星期四"
      Case 6
         GetWeekDay = "星期五"
      Case 7
         GetWeekDay = "星期六"
   End Select
End Function

'Added by Lydia 2019/08/21 判斷檔案是否存在, 超過時間就繼續(Memo by Lydia 2020/02/15 從frmacc2450搬來)
'Modified by Lydia 2020/09/10 是否彈訊息bolMsg
Public Function PUB_ChkFileStatus(ByVal pFilePath As String, Optional ByVal bolMsg As Boolean = False, Optional ByRef strOutErr As String = "") As Boolean
'國外付款明細表(8/13)發email出現PDFCreator的無法預期錯誤。
'可能原因 1.pdf檔案還在存檔中
'　　　　 2. Chrome開太多，佔資源
'pFilePath : 完整路徑含檔案名稱
Dim iRound As Integer
Dim tmpArr1 As Variant
Dim intA As Integer
Dim strMsg As String
Dim bChkAll As Boolean 'Added by Lydia 2020/09/10 全部檔案是否完成存檔

    If pFilePath = "" Then Exit Function
    
    PUB_ChkFileStatus = False
    '判斷是否多個檔案
    If InStr(pFilePath, "*") > 0 Then
        tmpArr1 = Split(pFilePath, "*")
    Else
        tmpArr1 = Split(pFilePath, ";")
    End If
        
    bChkAll = True 'Added by Lydia 2020/09/10
    DoEvents
    Sleep 1000

On Error GoTo EXITSUB 'Added by Lydia 2020/10/08

    For intA = 0 To UBound(tmpArr1)
        If tmpArr1(intA) <> "" Then
            If InStr(tmpArr1(intA), "\") = 0 Then
                'Memo by Lydia 2020/09/10 重新整理
                If bolMsg = False Then
                    strOutErr = strOutErr & "＆" & tmpArr1(intA) & "檔案路徑不完整，產生附件失敗！"
                Else
                    MsgBox "檔案路徑不完整：" & tmpArr1(intA), vbInformation, "檢查檔案"
                End If
                GoTo JumpToNext
                'end 2020/09/10
            End If
            
            '判斷檔案是否存在(限15秒)
            'Memo by Lydia 2020/01/15 改成30秒; ex. 彈$$Y3439900A10900035和$$Y20951020A10900116尚未存檔完畢
            iRound = 0
            Do While iRound < 15
                strMsg = Dir(tmpArr1(intA))
                If strMsg = "" Then
                   DoEvents
                   'Modified by Lydia 2020/01/15 改成30秒
                   'Sleep 1000
                   Sleep 2000
                Else
                   Exit Do
                End If
                iRound = iRound + 1
            Loop
            
            If strMsg = "" Then
                'Modified by Lydia 2020/09/10 增加判斷
                'MsgBox tmpArr1(intA) & "檔案尚未存檔完畢，請稍候！", vbInformation, "檢查檔案"
                bChkAll = False
                If bolMsg = False Then
                    strOutErr = strOutErr & "＆" & tmpArr1(intA) & "檔案尚未存檔完畢，產生附件失敗！"
                Else
                    MsgBox tmpArr1(intA) & "檔案尚未存檔完畢，產生附件失敗！", vbInformation, "檢查檔案"
                End If
                'end 2020/09/10
            End If
        End If
        
JumpToNext:  'Added by Lydia 2020/09/10
    Next intA
        
    'Added by Lydia 2020/09/10 增加判斷
    If bChkAll = False Then
         PUB_ChkFileStatus = False
    Else
    'end 2020/09/10
         PUB_ChkFileStatus = True
    End If 'Added by Lydia 2020/09/10
    
    Exit Function
    
EXITSUB:
    'Added by Lydia 2020/10/08 國外付款明細表frmacc2450在10/7發生”Not Found”錯誤
    If Err.Number = 70 Or Err.Number = -2147217406 Then '70.沒有使用權限; 2147217406.沒有檔案
        If bolMsg = False Then
            strOutErr = strOutErr & "＆" & tmpArr1(intA) & "檔案尚未存檔完畢，產生附件失敗！"
        Else
            MsgBox tmpArr1(intA) & "檔案尚未存檔完畢，產生附件失敗！", vbInformation, "檢查檔案"
        End If
    ElseIf Err.Number <> 0 Then
        If bolMsg = False Then
            strOutErr = strOutErr & "＆" & tmpArr1(intA) & "檔案檢查失敗：" & Err.Description
        Else
            MsgBox tmpArr1(intA) & tmpArr1(intA) & "檔案檢查失敗：" & vbCrLf & Err.Description, vbInformation, "檢查檔案"
        End If
    End If
    'end 2020/10/08
End Function

'Add by Sindy 2020/12/31 原始檔及卷宗區特殊權限
'回傳:
'm_LimitType:Quy.可查詢
'            Dow.可下載(因PDF、WORD等軟體之另存新檔及列印功能無法由系統控制，先取消)
'm_RecvNo:可下載的文號
'Modify By Sindy 2022/7/18 + , Optional ByRef m_MsgTxt As String = ""
Public Function PUB_ChkCPPAndCPFLimits_Spec(m_CP01 As String, m_CP02 As String, m_CP03 As String, m_CP04 As String, _
   ByRef m_LimitType As String, ByRef m_RecvNo As String, Optional ByRef m_MsgTxt As String = "") As Boolean
Dim intQ As Integer, stSQL As String
Dim rsQuery As New ADODB.Recordset
Dim bolW20Emp As Boolean, bolY10Emp As Boolean
'Dim strCP14 As String, strCP29 As String   'cancel by sonia 2025/7/9發現沒用到
Dim strCon As String
   
   PUB_ChkCPPAndCPFLimits_Spec = False: m_LimitType = "": m_RecvNo = ""
   m_MsgTxt = "智財報告書" 'Add By Sindy 2022/7/18
   
   '是否為創新業務部人員(部門W20人員及W20主管)
   'modify by sonia 2025/7/9 市場開發組YXX(新部門代號)已自顧服組分出來，ACS案由開發組承辦案件時開發組所有人員都有權限，但顧服組承辦案件，開發組人員不能看；顧服組可看所有ACS案件。故改用新部門ST93代號判斷
   'bolW20Emp = False
   'stSQL = "SELECT st01 FROM staff WHERE (substr(st03,1,2)='W2' OR substr(st15,1,2)='W2') AND st04='1' AND st01='" & strUserNum & "'" & _
   '        " union SELECT a0908 FROM acc090 WHERE a0901='W20' and a0908='" & strUserNum & "'"
   'intQ = 1
   'Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   'If intQ = 1 Then
   '   bolW20Emp = True
   'End If
   '顧服組
   bolW20Emp = False
   stSQL = "SELECT st01 FROM staff WHERE substr(st93,1,1)='W' AND st04='1' AND st01='" & strUserNum & "'" & _
           " union SELECT a0924 FROM acc090new WHERE substr(a0921,1,1)='W' and a0924='" & strUserNum & "'"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      bolW20Emp = True
   End If
   '開發組
   bolY10Emp = False
   stSQL = "SELECT st01 FROM staff WHERE substr(st93,1,1)='Y' AND st04='1' AND st01='" & strUserNum & "'" & _
           " union SELECT a0924 FROM acc090new WHERE substr(a0921,1,1)='Y' and a0924='" & strUserNum & "'"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      bolY10Emp = True
   End If
   'end 2025/7/9
   
   'ACS案件有收文智財報告書(案件性質代號：103開頭)，
   '及其相關卷號若有收文「智財協作」(專利代號967（P,CFP）、商標代號737（CFT,T）、法務代號7601（L）)的案件
   '，針對ACS及其相關卷號做管控
   'Modify By Sindy 2022/7/18 ACS案件性質113(專利布局分析)、TIPS相關案件性質(101、1012、1013、102、1021、124)
   '                          ，內容皆涉及客戶的技術機密以及營業秘密，客戶都要求保密，本所系統範圍配合須進行查閱限制。
   If m_CP01 = "ACS" Then
      'Modified by Lydia 2025/10/23 針對TIPS專案相關案件性質【區塊2】，進行系統卷宗區及原始檔區之閱覽權限設定
      'stSQL = "select cp01,cp02,cp03,cp04,cp09,cp10,cp13,cp14,cp29 from caseprogress" & _
              " where CP01='" & m_CP01 & "' and CP02='" & m_CP02 & "'" & _
              " and CP03='" & m_CP03 & "' and CP04='" & m_CP04 & "'" & _
              " and substr(CP10,1,3) in('103','101','102','113','124')"
      stSQL = "select cp01,cp02,cp03,cp04,cp09,cp10,cp13,cp14,cp29 from caseprogress" & _
              " where CP01='" & m_CP01 & "' and CP02='" & m_CP02 & "'" & _
              " and CP03='" & m_CP03 & "' and CP04='" & m_CP04 & "'" & _
              " and CP10 in (" & ACSforTIPSstep & IIf(ACSforTIPSAdd <> "", "," & ACSforTIPSAdd, "") & ")"
      intQ = 1
      Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
      If intQ = 1 Then
         PUB_ChkCPPAndCPFLimits_Spec = True
         'Modify By Sindy 2022/7/18
         If Left(rsQuery.Fields("cp10"), 3) = "103" Then
            m_MsgTxt = "智財報告書"
         ElseIf Left(rsQuery.Fields("cp10"), 3) = "113" Then
            m_MsgTxt = "專利布局分析"
         ElseIf Left(rsQuery.Fields("cp10"), 3) = "101" Or Left(rsQuery.Fields("cp10"), 3) = "102" _
            Or Left(rsQuery.Fields("cp10"), 3) = "124" Then
            m_MsgTxt = "-TIPS"
         End If
         '2022/7/18 END
         
         'ACS案件之原始檔及卷宗區，僅開放創新業務部人員(部門W20人員及W20主管) 可下載；
         '系統特殊設定「智財報告書相關案查詢特殊人員」可查詢。
         If bolW20Emp = True Then
            m_LimitType = "Quy" '"Dow"
         ElseIf InStr(Pub_GetSpecMan("智財報告書相關案查詢特殊人員"), strUserNum) > 0 Then
            m_LimitType = "Quy"
         'add by sonia 2025/7/9 判斷承辦人是不是開發組
         ElseIf Left(Trim(PUB_GetST93(rsQuery.Fields("cp14"))), 1) = "Y" And bolY10Emp = True Then
            m_LimitType = "Quy"
         'end 2025/7/9
         End If
      End If
   Else
      'modify by sonia 2022/1/13 P,CFP改PS,CPS、T,CFT改TT,S，但資料還沒改故改加入PS,CPS,TT,S
      'strCon = " and ((cp01 in('P','CFP') and cp10='967') or (cp01 in('T','CFT') and cp10='737') or (cp01='L' and cp10='7601'))"
      strCon = " and ((cp01 in('P','CFP','PS','CPS') and cp10='967') or (cp01 in('T','CFT','TT','S') and cp10='737') or (cp01='L' and cp10='7601'))"
'      stSQL = "select cp01,cp09,cp10,cp13,cp14,cp29 from CaseRelation1,caseprogress where CR01='" & m_CP01 & "' and CR02='" & m_CP02 & "' and CR03='" & m_CP03 & "' and CR04='" & m_CP04 & "'" & _
'              " and cr05=cp01(+) and cr06=cp02(+) and cr07=cp03(+) and cr08=cp04(+)" & _
'              strCon
'      stSQL = stSQL & "union select cp01,cp09,cp10,cp13,cp14,cp29 from CaseRelation1,caseprogress where CR05='" & m_CP01 & "' and CR06='" & m_CP02 & "' and CR07='" & m_CP03 & "' and CR08='" & m_CP04 & "'" & _
'              " and cr01=cp01(+) and cr02=cp02(+) and cr03=cp03(+) and cr04=cp04(+)" & _
'              strCon
'      stSQL = stSQL & "union select cp01,cp09,cp10,cp13,cp14,cp29 from caseprogress where CP01='" & m_CP01 & "' and CP02='" & m_CP02 & "' and CP03='" & m_CP03 & "' and CP04='" & m_CP04 & "'" & _
'              strCon
      stSQL = "select cp01,cp02,cp03,cp04,cp09,cp10,cp13,cp14,cp29 from caseprogress" & _
              " where CP01='" & m_CP01 & "' and CP02='" & m_CP02 & "'" & _
              " and CP03='" & m_CP03 & "' and CP04='" & m_CP04 & "'" & _
              strCon
      intQ = 1
      Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
      If intQ = 1 Then
         PUB_ChkCPPAndCPFLimits_Spec = True
         '相關卷號案件之原始檔及卷宗區，僅開放創新業務部人員(部門W20人員及W20主管) 可下載；
         '系統特殊設定「智財報告書相關案查詢特殊人員」可查詢。
         If bolW20Emp = True Then
            m_LimitType = "Quy" '"Dow"
         ElseIf InStr(Pub_GetSpecMan("智財報告書相關案查詢特殊人員"), strUserNum) > 0 Then
            m_LimitType = "Quy"
         End If
         '專利案承辦人、商標案承辦人、法務承辦人及協辦人員僅可下載該承辦案件文件。
         rsQuery.MoveFirst
         Do While Not rsQuery.EOF
            If rsQuery.Fields("cp14") = strUserNum Or rsQuery.Fields("cp29") = strUserNum Then
               m_LimitType = "Quy"
               m_RecvNo = m_RecvNo & "," & rsQuery.Fields("cp09")
            End If
            rsQuery.MoveNext
         Loop
         If m_RecvNo <> "" Then m_RecvNo = Mid(m_RecvNo, 2)
         
         'add by sonia 2025/7/9 操作人員為開發組才檢查相關ACS案件之承辦人，若為開發組人員則開發組所有人員都有權限看智財協作資料
         If bolY10Emp = True Then
            'Modified by Lydia 2025/10/23 針對TIPS專案相關案件性質【區塊2】，進行系統卷宗區及原始檔區之閱覽權限設定
            'stSQL = "select cp01,cp02,cp03,cp04,cp09,cp10,cp13,cp14,cp29,st93 from caseprogress,Caserelation1,staff" & _
                    " where Cr01='" & m_CP01 & "' and Cr02='" & m_CP02 & "' and Cr03='" & m_CP03 & "' and Cr04='" & m_CP04 & "' And 'ACS'=Cr05 " & _
                    " and cr05=cp01(+) and cr06=cp02(+) and cr07=cp03(+) and cr08=cp04(+) and Substr(Cp10,1,3) In ('103','101','102','113','124') and cp14=st01(+)"
            stSQL = "select cp01,cp02,cp03,cp04,cp09,cp10,cp13,cp14,cp29,st93 from caseprogress,Caserelation1,staff" & _
                    " where Cr01='" & m_CP01 & "' and Cr02='" & m_CP02 & "' and Cr03='" & m_CP03 & "' and Cr04='" & m_CP04 & "' And 'ACS'=Cr05 " & _
                    " and cr05=cp01(+) and cr06=cp02(+) and cr07=cp03(+) and cr08=cp04(+) and CP10 in (" & ACSforTIPSstep & IIf(ACSforTIPSAdd <> "", "," & ACSforTIPSAdd, "") & ") and cp14=st01(+)"
            intQ = 1
            Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
            If intQ = 1 Then
               If Left(Trim(rsQuery.Fields("st93")), 1) = "Y" Then m_LimitType = "Quy"
            End If
         End If
         'end 2025/7/9
      End If
   End If
   
   Set rsQuery = Nothing
End Function

'Add by Sindy 2020/3/16
'卷宗區及原始檔區的權限-檢查可新增刪除的權限
Public Function PUB_ChkCPPAndCPFLimits(m_CP01 As String, m_CP02 As String, m_CP03 As String, m_CP04 As String, _
   m_CP13 As String) As String
Dim strTmp As String, intA As Integer, rsAD As New ADODB.Recordset 'Added by Lydia 2024/05/15
'Dim strST05 As String
'Dim tmpVar1 As Variant, inJ As Integer 'Add By Sindy 2017/2/9

'身份：A.業務助理 S.智權人員 C.電腦中心 E.承辦人/工程師
'      F.程序人員 P.繪圖人員 W.檔案室 T.打字室
   PUB_ChkCPPAndCPFLimits = ""
   
   'Add By Sindy 2020/11/19
   '特殊處理:
   If m_CP01 = "ACS" Then
      '77027.美珍 A4023.文雄 W20.顧服組 W00.創新業務部主管
      If strUserNum = "77027" Or strUserNum = "A4023" Or _
         PUB_GetST03(strUserNum) = "W20" Or PUB_GetST03(strUserNum) = "W00" Then
         
         PUB_ChkCPPAndCPFLimits = "F" '程序人員
         Exit Function
      End If
   End If
   '2020/11/19 END
   
   '業務助理(部門M71.管理部分所或等級S1.業務助理)
   strTmp = "select st01,st02,st06 from staff where (st03='M71' or st05='S1') and st04='1'" & _
               " and substr(st01,1,1) in(" & ST01CodeNum1 & ")" & _
               " and st01='" & strUserNum & "'"
   intA = 1
   Set rsAD = ClsLawReadRstMsg(intA, strTmp)
   If intA = 1 Then
      If rsAD.Fields("st06") = PUB_GetST06(m_CP13) Then '業務助理與智權人員的所別要一致才能幫忙增減電子檔
         PUB_ChkCPPAndCPFLimits = "A" '業務助理
      End If
   End If
   'Add By Sindy 2023/2/4 因為敏惠和夏慧珠都是總務借調智權部的業務助理，所以ST05都不是S1，
   '                      故增加系統特殊設定「北所業務助理人員」可以操作北所智權人員案件之卷宗區權限，權限同S1。
   If InStr(Pub_GetSpecMan("北所業務助理人員"), strUserNum) > 0 Then
      PUB_ChkCPPAndCPFLimits = "A" '業務助理
   End If
   '2023/2/4 END
   
   If m_CP13 = strUserNum Then
      PUB_ChkCPPAndCPFLimits = "S" '智權人員
   'Modify By Sindy 2016/7/12 + 智權人員主管
   ElseIf m_CP13 <> "" Then
      '智權人員主管
      strTmp = "select s1.st01 from staff s1,acc090" & _
                  " where s1.st01='" & m_CP13 & "' and st15=A0901(+)" & _
                  " and (A0908='" & strUserNum & "' or s1.st52='" & strUserNum & "' or s1.st53='" & strUserNum & "' or s1.st54='" & strUserNum & "' or s1.st55='" & strUserNum & "')"
      intA = 1
      Set rsAD = ClsLawReadRstMsg(intA, strTmp)
      If intA = 1 Then
         PUB_ChkCPPAndCPFLimits = "S" '智權人員
      End If
   '2016/7/12 END
   End If
   '承辦人/工程師
   strTmp = "select cp09 from caseprogress" & _
               " where cp01='" & m_CP01 & "' and cp02='" & m_CP02 & "' and cp03='" & m_CP03 & "' and cp04='" & m_CP04 & "'" & _
               " and cp14='" & strUserNum & "'"
   intA = 1
   Set rsAD = ClsLawReadRstMsg(intA, strTmp)
   If intA = 1 Then
      PUB_ChkCPPAndCPFLimits = "E" '承辦人/工程師
   'Modify By Sindy 2016/7/12 + 判斷CFT承辦人及承辦人主管
   ElseIf m_CP01 = "CFT" Then
      strTmp = "select tm01,s1.st01 from trademark,nation,staff s1" & _
                  " where tm01='" & m_CP01 & "' and tm02='" & m_CP02 & "' and tm03='" & m_CP03 & "' and tm04='" & m_CP04 & "'" & _
                  " and tm10=na01(+)" & _
                  " and na69=s1.st01(+)" & _
                  " and (na69='" & strUserNum & "' or s1.st52='" & strUserNum & "' or s1.st53='" & strUserNum & "' or s1.st54='" & strUserNum & "' or s1.st55='" & strUserNum & "')"
      intA = 1
      Set rsAD = ClsLawReadRstMsg(intA, strTmp)
      If intA = 1 Then
         PUB_ChkCPPAndCPFLimits = "E" '承辦人/工程師
      End If
   'Modify By Sindy 2016/7/12 + 承辦人主管
   Else
      strTmp = "select cp09,s1.st01 from caseprogress,staff s1,acc090" & _
                  " where cp01='" & m_CP01 & "' and cp02='" & m_CP02 & "' and cp03='" & m_CP03 & "' and cp04='" & m_CP04 & "'" & _
                  " and cp14=s1.st01(+) and st15=A0901(+)" & _
                  " and (A0908='" & strUserNum & "' or s1.st52='" & strUserNum & "' or s1.st53='" & strUserNum & "' or s1.st54='" & strUserNum & "' or s1.st55='" & strUserNum & "')"
      intA = 1
      Set rsAD = ClsLawReadRstMsg(intA, strTmp)
      If intA = 1 Then
         PUB_ChkCPPAndCPFLimits = "E" '承辦人/工程師
      End If
   '2016/7/12 END
   End If
   
   'Add By Sindy 2015/7/27 檔案室
   strTmp = "select SR01 from staff_right,staff where upper(sr02)=upper('frm010033') and st01='" & strUserNum & "' and st05=SR01(+)"
   intA = 1
   Set rsAD = ClsLawReadRstMsg(intA, strTmp)
   If intA = 1 Then
      PUB_ChkCPPAndCPFLimits = "W" '檔案室
   End If
   '2015/7/27 END
   
   If Pub_StrUserSt03 = "M51" Then
      PUB_ChkCPPAndCPFLimits = "C" '電腦中心
   'Added by Lydia 2020/03/03
   ElseIf Pub_StrUserSt03 = "M13" Then
      PUB_ChkCPPAndCPFLimits = "T" '打字室: T
   '2020/03/03 END
   ElseIf Pub_StrUserSt03 = "P13" And (m_CP01 = "P" Or m_CP01 = "CFP" Or m_CP01 = "PS" Or m_CP01 = "CPS") Then
      PUB_ChkCPPAndCPFLimits = "P" '繪圖人員: P
   Else
      'Modify By Sindy 2015/10/2
'      '只有P,CFP程序人員可新增或刪除
'      If Pub_StrUserSt03 = "P12" Then
'         strST05 = PUB_GetST05(strUserNum)
'         '73.內專程序主管
'         '75.內專程序
'         '83.CFP程序主管
'         '85.CFP程序
'         If ((m_CP01 = "P" Or m_CP01 = "PS") And (strST05 = "73" Or strST05 = "75" Or strST05 = "83")) Or _
'            ((m_CP01 = "CFP" Or m_CP01 = "CPS") And (strST05 = "73" Or strST05 = "83" Or strST05 = "85")) Then
'            PUB_ChkCPPandCPFLimits = "F" '程序人員
'         End If
'      End If
     
      '程序單位均可新增或刪除電子檔
      'Modify By Sindy 2017/2/9 + ST05=L1,53
      '                         及增加可操作的系統別限制
      'Modify By Sindy 2017/6/7 開放外專承辦同於程序的權限
      'Modify By Sindy 2015/10/2 程序單位均可新增或刪除電子檔
      'Modify By Sindy 2014/3/11 增加繪圖人員可以新增,刪除原始檔
      'Modify By Sindy 2017/8/16 + 可新增,刪除原始檔區的部門
      'P12.專利處程序
      'P22.商標處程序
      'F12.外商程序
      'F22.外專程序
      'F23.外專承辦
      'L1.法務 53.投資法律
      'Modify By Sindy 2020/7/23 開放 F11.外商承辦 同於程序的權限
      If Pub_StrUserSt03 = "P12" Or Pub_StrUserSt03 = "P22" Or _
         Pub_StrUserSt03 = "F12" Or Pub_StrUserSt03 = "F22" Or _
         Pub_StrUserSt03 = "F23" Or Pub_StrUserSt03 = "F11" Or _
         Pub_strUserST05 = "L1" Or Pub_strUserST05 = "53" Then
         'Modify By Sindy 2019/4/10 Mark,不用管系統別外層應該都已控制好權限
'         tmpVar1 = Split(Systemkind_g, ",") '系統別權限
'         For inJ = 0 To UBound(tmpVar1)
'            If Trim(tmpVar1(inJ)) <> "" Then
'               If Trim(tmpVar1(inJ)) = m_CP01 Then
                  PUB_ChkCPPAndCPFLimits = "F" '程序人員
'                  Exit For
'               End If
'            End If
'         Next inJ
'         'add by sonia 2017/7/27 外專程序可操作大陸寰華P案
'         FMP2open = PUB_FMPtoCheck(1, 0, Pub_strUserST05)
'         If FMP2open = True Then
'            PUB_ChkCPPandCPFLimits = "F" '程序人員
'         End If
'         'end 2017/7/27
      End If
      '2015/10/2 END
   End If
   
   Set rsAD = Nothing 'Added by Lydia 2024/05/15
End Function

'Add by Amy 2020/03/16 抓潛在客戶開發人員
'Memo by Amy 2020/03/18 有改需確認 PUB_SetUserList是否也改)
Public Function GetDevelopP(pNo As String) As String
    Dim rsA As New ADODB.Recordset
    Dim strA As String
    Dim intA As Integer, ii As Integer
    Dim arrID 'Add by Amy 2020/03/18
    
    GetDevelopP = ""
    If InStr(pNo, ",") > 0 Then
        strA = "And st01 in('" & Replace(pNo, ",", "','") & "') "
    Else
        strA = "And st01='" & pNo & "' "
    End If
    strA = "Select st02,st01 From Staff Where 1=1 " & strA
    intA = 1
    Set rsA = ClsLawReadRstMsg(intA, strA)
    If intA = 1 Then
        'Modfiy by Amy 2020/03/19 照原順序排
        arrID = Split(pNo, ",")
        For ii = UBound(arrID) To LBound(arrID) Step -1
            rsA.MoveFirst
            Do While Not rsA.EOF
                If rsA.Fields("st01") = arrID(ii) Then
                    GetDevelopP = rsA.Fields("st02") & "," & GetDevelopP
                    rsA.MoveLast
                End If
                rsA.MoveNext
            Loop
        Next ii
    End If
    If GetDevelopP <> MsgText(601) Then
        GetDevelopP = Mid(GetDevelopP, 1, Val(Len(GetDevelopP)) - 1)
    End If
    Set rsA = Nothing
End Function

'Add by Amy 2020/03/31 抓取作帳公司-aacc_fun搬過來
Public Function GetBookKeepCmp() As String
    Dim RsQ As New ADODB.Recordset
    Dim intQ As Integer
    Dim stQ As String, stTmp As String
    
    GetBookKeepCmp = ""
    stQ = "Select a0801 From Acc080 Where a0827='Y' Order by a0801"
    intQ = 1
    Set RsQ = ClsLawReadRstMsg(intQ, stQ)
    If intQ = 1 Then
        RsQ.MoveFirst
        Do While Not RsQ.EOF
            stTmp = stTmp & "," & RsQ.Fields("a0801")
            RsQ.MoveNext
        Loop
    End If
    If stTmp <> MsgText(601) Then
        GetBookKeepCmp = Mid(stTmp, 2)
    End If
    Set RsQ = Nothing
End Function

'公司別下拉選單-有名稱(總帳使用)
'bolSpecCmp:抓組合作帳公司
'IsAbbr:抓縮寫
'bolUseAll:顯示「全部」
'stDef:預設
'Add by Amy 2020/03/27
' intIdx: 下拉選單起始 / stSign:區隔符號
'Modify By Sindy 2021/7/16 改為用 Object 型態
'Public Sub Pub_SetCboCmp(objCbo As ComboBox, bolSpecCmp As Boolean, IsAbbr As Boolean, bolUseAll As Boolean, _
'                Optional ByRef stDef As String = "", Optional ByVal intIdx As Integer = 0, Optional ByVal stSign As String = "")
'Modify by Amy 2023/02/21 +NotShowCmp 不顯示的公司別,多筆以「;」分隔
Public Sub Pub_SetCboCmp(objCbo As Object, bolSpecCmp As Boolean, IsAbbr As Boolean, bolUseAll As Boolean, _
                Optional ByRef stDef As String = "", Optional ByVal intIdx As Integer = 0, Optional ByVal stSign As String = "", Optional ByVal NotShowCmp As String = "")
    Dim RsQ As New ADODB.Recordset
    Dim j As Integer, intQ As Integer, intC As Integer
    Dim stQ As String, stNo As String, stCmpN As String, stDefCmp As String
    Dim arrTmp
    
    If intIdx = 0 Then objCbo.Clear
    If stDef <> MsgText(601) Then stDefCmp = stDef: stDef = ""
    'Modify  by Amy 2020/03/27+ intIdx/stSign
    If stSign = MsgText(601) Then stSign = "　"
    If bolUseAll = True Then
        objCbo.AddItem "全部", intIdx
        intIdx = intIdx + 1
    End If
    'end 2020/03/27
    arrTmp = Split(Mid(組合作帳公司, 2), ",")
    
    'Add by Amy 2023/02/21 +不顯示的公司別
    If NotShowCmp <> MsgText(601) Then
        stQ = "And a0801 not in('" & Replace(NotShowCmp, ";", "','") & "') "
    End If
   
    'Modify by Amy 2020/03/27 +BName
    stQ = "Select a0801,Decode(a0801,'1',AName,a0802) a0802,a0803,a0804,Decode(a0801,'1',BName,a0820) a0820 From Acc080 " & _
           ",(Select '1' ANo,a0802 AName,a0820 BName From Acc080 Where a0801='2' ) " & _
            "Where a0801=ANo(+) And a0827='Y' " & stQ & " Order by a0801"
    intQ = 1
    Set RsQ = ClsLawReadRstMsg(intQ, stQ)
    If intQ = 1 Then
        RsQ.MoveFirst
        Do While Not RsQ.EOF
            stNo = "" & RsQ.Fields("a0801")
            stCmpN = "" & RsQ.Fields("a0802")
            If IsAbbr = True Then
                stCmpN = "" & RsQ.Fields("a0820")
            End If
            'Moidfy by Amy 2020/03/27
            objCbo.AddItem stNo & stSign & stCmpN, intIdx '原:objCbo.AddItem stNo & "　" & stCmpN
            intIdx = intIdx + 1
            'end 2020/03/27
            '組合作帳公司,只顯示縮寫
            If bolSpecCmp = True And arrTmp(LBound(arrTmp)) <> MsgText(601) Then
                For j = LBound(arrTmp) To UBound(arrTmp)
                    If InStr(arrTmp(j), stNo) > 0 Then
                        '未有符號(空白)
                        If InStr(arrTmp(j), stSign) = 0 Then 'Moidfy by Amy 2020/03/27 原:"　"
                            arrTmp(j) = arrTmp(j) & stSign & RsQ.Fields("a0820") 'Moidfy by Amy 2020/03/27 原:arrTmp(j) = arrTmp(j) & "　" & RsQ.Fields("a0820")
                        Else
                            arrTmp(j) = arrTmp(j) & " / " & RsQ.Fields("a0820")
                        End If
                    End If
                Next j
            End If
            '預設為作帳公司
            If stDefCmp <> MsgText(601) And InStr(stDefCmp, ",") = 0 Then
                If stDefCmp = stNo Then
                    stDefCmp = stDefCmp & stSign & stCmpN 'Moidfy by Amy 2020/03/27 原: stDefCmp = stDefCmp & "　" & stCmpN
                End If
            End If
            RsQ.MoveNext
        Loop
    End If
   
    '非只抓作帳資料,需加入組合作帳公司
    If bolSpecCmp = True And arrTmp(LBound(arrTmp)) <> MsgText(601) Then
        For j = LBound(arrTmp) To UBound(arrTmp)
            objCbo.AddItem arrTmp(j), intIdx 'Moidify by Amy 2020/03/27 +intIdx
            intIdx = intIdx + 1
            '預設為組合作帳公司
            If stDefCmp <> MsgText(601) And stDefCmp = Mid(arrTmp(j), 1, Val(InStr(arrTmp(j), stSign)) - 1) Then   'Moidfy by Amy 2020/03/27 原:"　"
                stDefCmp = arrTmp(j)
            End If
        Next j
    End If
    '回傳預設
    If stDefCmp <> MsgText(601) Then
        stDef = stDefCmp
        objCbo = stDef
    End If
    Set RsQ = Nothing
End Sub

'公司別下拉選單-只有編號(總帳使用)
'Modify By Sindy 2021/7/16 改為用 Object 型態
'Public Sub Pub_SetCboCmpNo(objCbo As ComboBox, bolUseSpec As Boolean)
Public Sub Pub_SetCboCmpNo(objCbo As Object, bolUseSpec As Boolean)
    Dim j As Integer
    Dim arrTmp
    
    objCbo.Clear
    If bolUseSpec = True Then objCbo.AddItem ""
    arrTmp = Split(GetBookKeepCmp, ",")
    For j = LBound(arrTmp) To UBound(arrTmp)
        objCbo.AddItem arrTmp(j)
    Next j
End Sub

Public Function GetAccReportCmpN(stCmpNo As String, Optional ByVal IsAbbr As Boolean = True, Optional ByVal SpecShowAll As Boolean = True, Optional ByVal stSign As String = "　") As String
    Dim strCmp As String, ii As Integer
    'Modify by Amy 2020/04/16
    Dim arrCmp
    
    strCmp = stCmpNo
    If InStr(strCmp, stSign) > 0 Then
        strCmp = Mid(strCmp, 1, Val(InStr(strCmp, stSign)) - 1)
    End If
    'end 2020/04/16
    If SpecShowAll = True And Trim(stCmpNo) = MsgText(601) Then
        GetAccReportCmpN = A0802Query("2", IsAbbr) & "/" & A0802Query("J", IsAbbr) & "/" & A0802Query("L", IsAbbr)
    'Add by Amy 2020/04/16 加有組合公司別
    ElseIf InStr(strCmp, "+") > 0 Then
        arrCmp = Split(strCmp, "+")
        For ii = LBound(arrCmp) To UBound(arrCmp)
            GetAccReportCmpN = GetAccReportCmpN & "/" & A0802Query("" & arrCmp(ii), IsAbbr)
        Next ii
        GetAccReportCmpN = Mid(GetAccReportCmpN, 2)
    Else
        GetAccReportCmpN = A0802Query(strCmp, IsAbbr)
    End If
End Function
'end 2020/03/31

'Added by Lydia 2020/04/08 檢查案件或智權人員是否為法務部
Public Function PUB_ChkSalesL(ByVal pSysNo As String, ByVal pSalesNo As String) As Boolean
Dim bolStaffL As Boolean
    
    If pSysNo = "" Or pSalesNo = "" Then
        PUB_ChkSalesL = True
        Exit Function
    End If
    
    bolStaffL = PUB_ChkLCompStaff(pSalesNo)
    pSysNo = UCase(pSysNo)
    
    '智慧所更名日起法務案instr(系統類別,'L')=0之智權人員只能是法律所人員
    If strSrvDate(1) >= 智慧所更名日 And InStr(pSysNo, "L") > 0 And pSalesNo <> "" Then
       If bolStaffL = False Then
            MsgBox "智權人員非法律所人員不可收文！", , "注意！"
            Exit Function
       End If
    End If
    '控制法律所人員不可收文法務,顧問以外之案件
    If bolStaffL = True And InStr(pSysNo, "L") = 0 Then
            MsgBox "法律所人員不可收文法務、顧問以外之案件！", , "注意！"
            Exit Function
    End If
    
    PUB_ChkSalesL = True
    
End Function

'Added by Morgan 2020/5/5
'儲存本次路徑
'Modify By Sindy 2021/7/16 改為用 Object 型態
'Public Function PUB_SavePath(txtPath As TextBox, FormName As String)
Public Function PUB_SavePath(txtPath As Object, FormName As String)
   If txtPath.Tag <> txtPath.Text Then
      SaveSetting "TAIE", "P", UCase(FormName) & "Dir", txtPath
   End If
End Function

'Added by Morgan 2020/5/5
'讀取前次設定路徑
'Modify By Sindy 2021/7/16 改為用 Object 型態
'Public Function PUB_ReadPath(txtPath As TextBox, FormName As String)
Public Function PUB_ReadPath(txtPath As Object, FormName As String)
   txtPath.Text = GetSetting("TAIE", "P", UCase(FormName) & "Dir", "")
   txtPath.Tag = txtPath.Text
   If txtPath <> "" Then
      If PUB_ChkDir(txtPath) = False Then
         MsgBox "路徑 [ " & txtPath & " ] 不存在，請重新設定！", vbCritical
         txtPath = "C:\"
      End If
   Else
      txtPath = "C:\"
   End If
End Function

'Added by Morgan 2020/5/5
'用 7z.exe 檔案解壓
Public Function PUB_UnZipFile(pZipFile As String, pToPath As String) As Boolean
   Dim program_name As String, program_path As String
   Dim process_id As Long
   Dim process_handle As Long

   program_name = "C:\Program Files\7-Zip\7z.exe"
   '檢查執行檔
   If Dir(program_name) = "" Then
      MsgBox "未安裝 7-Zip 程式，解壓縮檔產生失敗！。"
      Exit Function
   End If
    
On Error GoTo ShellError
              
   process_id = Shell("""" & program_name & """ x """ & pZipFile & """ -o""" & pToPath & """", vbNormalNoFocus)
    
    On Error GoTo 0

    ' Wait for the program to finish.
    ' Get the process handle.
    process_handle = OpenProcess(SYNCHRONIZE, 0, process_id)
    If process_handle <> 0 Then
        WaitForSingleObject process_handle, INFINITE
        CloseHandle process_handle
    End If
    Exit Function

ShellError:
    MsgBox " " & _
        program_name & vbCrLf & _
        Err.Description, vbOKOnly Or vbExclamation, _
        "Error"
End Function

'Add by Amy 2020/05/18 確認是否有商標延展結案之資料
'Modify by Amy 2024/09/06 +stData
Public Function ChkT102Inform(ByVal stNP01 As String, ByVal stNP22 As String, Optional ByRef stData As String = "") As Boolean
    Dim RsQ As New ADODB.Recordset
    Dim stQ As String, intQ As Integer, stField As String 'Add by Amy 2024/09/06 +stField
    
    ChkT102Inform = False
    'Modify by Amy 2024/09/06 +stData
    stField = "*"
    If stData <> MsgText(601) Then
      stField = stData
      stData = ""
    End If
    stQ = "Select " & stField & " From T102Inform Where ti02='" & stNP01 & "' And ti04='" & stNP22 & "' "
    'end 2024/09/06
    intQ = 1
    Set RsQ = ClsLawReadRstMsg(intQ, stQ)
    If intQ = 1 Then
        stData = "" & RsQ.Fields(0) 'Add by Amy 2024/09/06
        ChkT102Inform = True
    End If
    Set RsQ = Nothing
End Function

'Add by Sindy 2020/7/29 智權部程式,檢查部門欄位
'intErrCol : 0.txtSales 1.txtSalesArea 2.txtSalesArea1
'Modify By Sindy 2021/7/16 改為用 Object 型態
'Public Function PUB_ChkFormSalesDept(strQPerson As String, otxtSales As TextBox, _
'   otxtSalesArea As TextBox, otxtSalesArea1 As TextBox, _
'   intErrCol As Integer) As Boolean
'Modify By Sindy 2025/8/11 +, Optional otxtZone As Object
Public Function PUB_ChkFormSalesDept(strQPerson As String, otxtSales As Object, _
   otxtSalesArea As Object, otxtSalesArea1 As Object, _
   intErrCol As Integer, Optional otxtZone As Object) As Boolean
Dim stST05 As String
Dim sttxtSales As String
   
   stST05 = PUB_GetST05(strQPerson)
   sttxtSales = otxtSales.Text
   
    '2005/7/5 ADD BY SONIA 林永生71003檢查業務區範圍
   If strQPerson = "71003" Then
      If otxtSalesArea < "S2" Or otxtSalesArea > "S29" Then
         MsgBox "業務區起始條件錯誤！只可查中所業務區", vbExclamation
         intErrCol = 1
         PUB_ChkFormSalesDept = False
         Exit Function
      End If
      If otxtSalesArea1 < "S2" Or otxtSalesArea1 > "S29" Then
         MsgBox "業務區迄止條件錯誤！只可查中所業務區", vbExclamation
         intErrCol = 2
         PUB_ChkFormSalesDept = False
         Exit Function
      End If
   End If
   'add by sonia 2016/6/15 柄佑82026可看中所全部或自已
   'Modify By Sindy 2025/8/11 除了原有可看中所智權部所有人權限外，
   '   再開放專利國內部所有成員的資料且不限制所別；但智權部資料僅能查中所。
   If strQPerson = "82026" Then
      If otxtSalesArea = "" Then
         'Modify By Sindy 2025/3/21
         'otxtSalesArea = "S21"
         otxtSalesArea = "S20"
         '2025/3/21 END
         otxtSalesArea1 = "S29"
      End If
'      If otxtSalesArea <> "P11" Or otxtSalesArea1 <> "P11" Then
'         If otxtSalesArea < "S2" Or otxtSalesArea > "S29" Then
'            MsgBox "業務區起始條件錯誤！只可查中所業務區", vbExclamation
'            intErrCol = 1
'            PUB_ChkFormSalesDept = False
'            Exit Function
'         End If
'         If otxtSalesArea1 < "S2" Or otxtSalesArea1 > "S29" Then
'            MsgBox "業務區迄止條件錯誤！只可查中所業務區", vbExclamation
'            intErrCol = 2
'            PUB_ChkFormSalesDept = False
'            Exit Function
'         End If
'      Else
'         If Trim(otxtSales) <> strQPerson Then
'            MsgBox "查專利處工程師時只可查自己的資料", vbExclamation
'            intErrCol = 0
'            PUB_ChkFormSalesDept = False
'            Exit Function
'         End If
'      End If
      If Left(otxtSalesArea, 1) = "P" Then
         If otxtSalesArea < "P1" Or otxtSalesArea > "P19" Then
            MsgBox "業務區起始條件錯誤！只可查專利國內部業務區", vbExclamation
            intErrCol = 1
            PUB_ChkFormSalesDept = False
            Exit Function
         End If
         If otxtSalesArea1 < "P1" Or otxtSalesArea1 > "P19" Then
            MsgBox "業務區迄止條件錯誤！只可查專利國內部業務區", vbExclamation
            intErrCol = 2
            PUB_ChkFormSalesDept = False
            Exit Function
         End If
         If TypeName(otxtZone) <> "Nothing" Then
            otxtZone = ""
         End If
      Else
         If otxtSalesArea < "S2" Or otxtSalesArea > "S29" Then
            MsgBox "業務區起始條件錯誤！只可查中所業務區", vbExclamation
            intErrCol = 1
            PUB_ChkFormSalesDept = False
            Exit Function
         End If
         If otxtSalesArea1 < "S2" Or otxtSalesArea1 > "S29" Then
            MsgBox "業務區迄止條件錯誤！只可查中所業務區", vbExclamation
            intErrCol = 2
            PUB_ChkFormSalesDept = False
            Exit Function
         End If
         If TypeName(otxtZone) <> "Nothing" Then
            otxtZone = pub_strUserOffice
         End If
      End If
      '2025/8/11 END
   End If
   'Added by Lydia 2020/06/15 簡協理可看所有智權人員
   'Modify By Sindy 2020/8/24 + And sttxtSales <> "W1001" : 不鎖業務區起始
   'Modify By Sindy 2022/5/4 簡協理改為抓系統特殊設定「全所智權部主管」
   If InStr(Pub_GetSpecMan("全所智權部主管"), strQPerson) > 0 And sttxtSales <> "W1001" Then
      If Left(otxtSalesArea, 1) <> "S" Then
         MsgBox "業務區起始條件錯誤！只可查智權部", vbExclamation
         intErrCol = 1
         PUB_ChkFormSalesDept = False 'Add By Sindy 2020/7/14
         Exit Function
      End If
      If Left(otxtSalesArea1, 1) <> "S" Then
         MsgBox "業務區迄止條件錯誤！只可查智權部", vbExclamation
         intErrCol = 2
         PUB_ChkFormSalesDept = False 'Add By Sindy 2020/7/14
         Exit Function
      End If
   End If
   'end 2020/06/15
   
   '2005/11/29 ADD BY SONIA 簡金泉69005檢查業務區範圍
'Removed by Morgan 2019/12/31 杜主秘說加開簡協理69005可看全所
'   If strQPerson = "69005" Then
'      If otxtSalesArea < "S1" Or otxtSalesArea > "S19" Then
'         MsgBox "業務區起始條件錯誤！只可查北所業務區", vbExclamation
'         intErrCol = 1
'         PUB_ChkFormSalesDept = False
'         Exit Function
'      End If
'      If otxtSalesArea1 < "S1" Or otxtSalesArea1 > "S19" Then
'         MsgBox "業務區迄止條件錯誤！只可查北所業務區", vbExclamation
'         intErrCol = 2
'         PUB_ChkFormSalesDept = False
'         Exit Function
'      End If
'   End If
'end 2019/12/31
   
'    'add by nickc 2008/01/18 加入外商主管  可以輸入相同組別的
'    If (stST05 = "21" Or stST05 = "26" Or stST05 = "28") Then
'        If Trim(otxtSales) = "" Then
'            MsgBox "智權人員不可以空白！", vbExclamation, "操作錯誤！"
'            intErrCol = 0
'            PUB_ChkFormSalesDept = False
'            Exit Function
'        End If
'        If PUB_GetStaffST16(strQPerson) <> PUB_GetStaffST16(sttxtSales) Then
'            MsgBox "僅可以輸入相同組別的智權人員！", vbExclamation, "操作錯誤！"
'            intErrCol = 0
'            PUB_ChkFormSalesDept = False
'            Exit Function
'        End If
'    End If
    
   If otxtSalesArea > otxtSalesArea1 Then
      MsgBox "業務區範圍條件錯誤！", vbExclamation
      intErrCol = 1
      PUB_ChkFormSalesDept = False
      Exit Function
   End If
   
   PUB_ChkFormSalesDept = True
End Function

'Modify By Sindy 2020/7/28 Set Form畫面上的欄位值 : 來自於 frm100123.期限資料查詢
'strSalesArea, strSalesArea1 : 可查詢的部門區間; (檢查查詢權限時會使用到:PUB_ChkSalePerLimit)
'bolQSelf : frm210137.業績點數統計 - 判斷是查自己,會顯示不同的作業名稱
'm_strAuthorityCon : frm12040152.接洽記錄單查詢／列印 - 權限控制條件
'm_intSpecSet : frm090638.商標未發文原因註記 - 特殊設定
'Modify By Sindy 2021/7/16 改為用 Object 型態
'Modify By Sindy 2023/5/15 + , Optional ByVal bolFirstLoad As Boolean = False : 第一次載入Form,預設值
'                            , Optional ByRef otxtStarDate As Object : 回傳起始日期
'Modify By Sindy 2025/3/17 + Optional ByVal strFormNm As String = "" : 傳入Form Name; 若有特殊檢查條件
Public Function PUB_SetFormSaleDept(strQPerson As String, Optional otxtZone As Object, _
   Optional otxtSalesArea As Object, Optional otxtSalesArea1 As Object, Optional otxtSales As Object, _
   Optional ByRef bolSpecMan As Boolean = False, Optional ByRef strSpecCode As String = "", _
   Optional ByRef strSalesArea As String, Optional ByRef strSalesArea1 As String, _
   Optional ByRef bolQSelf As Boolean = False, Optional ByRef m_strAuthorityCon As String = "", _
   Optional ByRef m_intSpecSet As Integer = 0, Optional ByVal bolFirstLoad As Boolean = False, _
   Optional ByRef otxtStarDate As Object, Optional ByVal strFormNm As String = "") As Boolean
   
Dim stST05 As String
Dim stST15 As String
Dim stST52List As String, stIdList As String
Dim strTmp(1 To 3) As String 'Added by Lydia 2024/05/15
Dim bolSetFRM As Boolean 'Add By Sindy 2025/3/18
   
   stST15 = PUB_GetStaffST15(strQPerson, 1)
   stST05 = PUB_GetST05(strQPerson)
   
   If TypeName(otxtZone) <> "Nothing" Then otxtZone.Enabled = False
   If TypeName(otxtSalesArea) <> "Nothing" Then otxtSalesArea.Enabled = False
   If TypeName(otxtSalesArea1) <> "Nothing" Then otxtSalesArea1.Enabled = False
   If TypeName(otxtSales) <> "Nothing" Then
      otxtSales.Enabled = False
      otxtSales = strQPerson 'Add By Sindy 2025/3/19
   End If
   
   'Add By Sindy 2025/3/18 針對特定作業,開放某些人員操作
   bolSetFRM = False
   If UCase(strFormNm) = "FRM210104" Or _
      UCase(strFormNm) = "FRM210122" Or UCase(strFormNm) = "FRM210105" Or UCase(strFormNm) = "FRM210146" Then
      'Modify By Sindy 2025/5/13 +、N1 +C1、
      If InStr("C1、C2、CM、CS、KM、NM、S1、T9、N1", stST05) > 0 Then
         strSql = "select min(st15),max(st15) from staff where st06 in(select st06 from staff where st01='" & strQPerson & "')" & _
                  " and st04='1' and substr(st15,1,1)='S'" & _
                  " order by st15 asc"
         intI = 1
         Set RsTemp = ClsLawReadRstMsg(intI, strSql)
         If intI = 1 Then
            strSalesArea = "" & RsTemp.Fields(0)
            strSalesArea1 = "" & RsTemp.Fields(1)
         End If
      End If
      If UCase(strFormNm) = "FRM210104" Then
         '分所財務人員可看該所全部
         If (stST05 = "CM" Or stST05 = "C1" Or stST05 = "NM" Or stST05 = "KM") Then
            If TypeName(otxtZone) <> "Nothing" Then otxtZone = pub_strUserOffice
            If TypeName(otxtSalesArea) <> "Nothing" Then otxtSalesArea = strSalesArea
            If TypeName(otxtSalesArea1) <> "Nothing" Then otxtSalesArea1 = strSalesArea1
            If TypeName(otxtSales) <> "Nothing" Then otxtSales.Enabled = True
            bolSetFRM = True
         '郭雅娟也可看專利處 2014/8/15
         ElseIf strQPerson = "79075" Then
            If TypeName(otxtZone) <> "Nothing" Then
               otxtZone = ""
               otxtZone.Enabled = True
            End If
            strSalesArea = "P10"
            strSalesArea1 = "P19"
            If TypeName(otxtSalesArea) <> "Nothing" Then otxtSalesArea = strSalesArea
            If TypeName(otxtSalesArea1) <> "Nothing" Then otxtSalesArea1 = strSalesArea1
            If TypeName(otxtSales) <> "Nothing" Then otxtSales.Enabled = True
            bolSetFRM = True
         End If
      'Modify By Sindy 2025/3/17 + 請款作業及應收查詢frm210146
      '  調整權限:杜協理這次的需求，僅開放請款作業及應收查詢(frm210146及frm210122)，
      '           其他功能維持不開放(但上方的暫收款查詢frm210105也要一併改)：
      '           開放等級為C2、CM、CS、KM、NM、S1、T9的人員可以查詢該所智權部人員(ST15為S開頭)的資料。
      ElseIf UCase(strFormNm) = "FRM210122" Or UCase(strFormNm) = "FRM210105" Or UCase(strFormNm) = "FRM210146" Then
         'If PUB_GetST03(strQPer) = "M71" Then
         'Modify By Sindy 2025/5/13 +、N1 +C1、
         If InStr("C1、C2、CM、CS、KM、NM、S1、T9、N1", stST05) > 0 Then
            If TypeName(otxtZone) <> "Nothing" Then otxtZone = pub_strUserOffice
            If TypeName(otxtSalesArea) <> "Nothing" Then otxtSalesArea = strSalesArea
            If TypeName(otxtSalesArea1) <> "Nothing" Then otxtSalesArea1 = strSalesArea1
            If TypeName(otxtSales) <> "Nothing" Then otxtSales.Enabled = True: otxtSales.Enabled = True
            bolSetFRM = True
         End If
      End If
   End If
   '2025/3/18 End
   
If bolSetFRM = False Then
   Select Case strQPerson
      '2005/9/12 ADD BY SONIA
      '外商陳經理可看全所CFT,FCT,S,CFC
      Case "68005"
         If TypeName(otxtSalesArea) <> "Nothing" Then
            otxtSalesArea.Enabled = True
            otxtSalesArea = stST15
         End If
         If TypeName(otxtSalesArea1) <> "Nothing" Then
            otxtSalesArea1.Enabled = True
            otxtSalesArea1 = stST15
         End If
         strSalesArea = "F10"
         strSalesArea1 = "F12"
         m_strAuthorityCon = " and CRL07 in ('CFT','FCT','S','CFC')"
         m_intSpecSet = 1
         If TypeName(otxtSales) <> "Nothing" Then otxtSales.Enabled = True
      '2005/9/10 END
'cancel by sonia 2014/6/9
'      '2005/9/8 ADD BY SONIA
'      '蔣律師可看中所全部
'      Case "79037"
'         otxtZone = pub_strUserOffice
'         otxtSalesArea.Enabled = True
'         otxtSalesArea1.Enabled = True
'         otxtSales.Enabled = True
'         otxtSalesArea = "S2"
'         otxtSalesArea1 = "S29"
'end 2014/6/9
      '2005/9/8 END
      'add by sonia 2016/6/7 柄佑可看中所全部但業務區仍預設自已部門
      Case "82026"
         If TypeName(otxtZone) <> "Nothing" Then otxtZone = pub_strUserOffice
         If TypeName(otxtSalesArea) <> "Nothing" Then
            otxtSalesArea.Enabled = True
            otxtSalesArea = stST15
         End If
         If TypeName(otxtSalesArea1) <> "Nothing" Then
            otxtSalesArea1.Enabled = True
            otxtSalesArea1 = stST15
         End If
         'Modify By Sindy 2025/3/21
'         strSalesArea = "S21"
'         strSalesArea1 = "S24"
         'Modify By Sindy 2025/8/11 除了原有可看中所智權部所有人權限外，
         '   再開放專利國內部所有成員的資料且不限制所別；但智權部資料僅能查中所。
         If TypeName(otxtSalesArea) <> "Nothing" Then
            strSalesArea = otxtSalesArea
         End If
         If Left(strSalesArea, 1) = "P" Then
            strSalesArea = "P10"
            strSalesArea1 = "P19"
            'If TypeName(otxtZone) <> "Nothing" Then otxtZone = ""
         Else
         '2025/8/11 END
            strSalesArea = "S20"
            strSalesArea1 = "S29"
            'If TypeName(otxtZone) <> "Nothing" Then otxtZone = pub_strUserOffice
         End If
         '2025/3/21 END
         If TypeName(otxtSales) <> "Nothing" Then otxtSales.Enabled = True
      'end 2016/6/7
      
'      '小真,杜副總可看全部
'      'modify by sonia 2014/6/9 +美珍77027
'      'Modify by Amy 2015/02/03 拿掉美珍 改寫至特殊人員(總經理業務工作代理人員)
'      Case "65001", "68006"
'         If TypeName(otxtZone) <> "Nothing" Then otxtZone.Enabled = True
'         If TypeName(otxtSalesArea) <> "Nothing" Then otxtSalesArea.Enabled = True
'         If TypeName(otxtSalesArea1) <> "Nothing" Then otxtSalesArea1.Enabled = True
'         If TypeName(otxtSales) <> "Nothing" Then otxtSales.Enabled = True
'         'Add by Morgan 2005/7/4 副總預設所有智權人員
'         If strQPerson = "68006" Then
'            If TypeName(otxtSalesArea) <> "Nothing" Then otxtSalesArea = "S"
'            If TypeName(otxtSalesArea1) <> "Nothing" Then otxtSalesArea1 = "S99"
'         End If
      
      '杜燕文,劉大愛可看S31
      'modify by sonia 2016/8/22劉大愛78007改為蘇嫄媛79053
      Case "79053"
         If TypeName(otxtZone) <> "Nothing" Then otxtZone = pub_strUserOffice
         If TypeName(otxtSalesArea) <> "Nothing" Then otxtSalesArea = "S31"
         If TypeName(otxtSalesArea1) <> "Nothing" Then otxtSalesArea1 = "S31"
         strSalesArea = "S31"
         strSalesArea1 = "S31"
         m_strAuthorityCon = " and st15 = 'S31'"
         m_intSpecSet = 1
         If TypeName(otxtSales) <> "Nothing" Then otxtSales.Enabled = True

      '王協理可看專利處
      'memo by Lydia 2023/04/24 修改王副總退休之相關控制; 5/1加入李柏翰99050
      Case "71011"
JumpToDef: 'Added by Lydia 2023/04/24
         '2007/10/17 CANCEL BY SONIA
         'If TypeName(otxtZone) <> "Nothing" Then otxtZone = pub_strUserOffice
         If TypeName(otxtSalesArea) <> "Nothing" Then otxtSalesArea = "P10"
         If TypeName(otxtSalesArea1) <> "Nothing" Then otxtSalesArea1 = "P19"
         strSalesArea = "P10"
         strSalesArea1 = "P19"
         m_strAuthorityCon = " and st15>='P10' and st15<='P19'"
         m_intSpecSet = 1
         If TypeName(otxtSales) <> "Nothing" Then otxtSales.Enabled = True
         
      '葉經理,林經理可看商標處
      'modify by sonia 2016/2/24 +69008
      'Case "67002", "69008"
      Case "69008"
         '2007/10/17 CANCEL BY SONIA
         'If TypeName(otxtZone) <> "Nothing" Then otxtZone = pub_strUserOffice
         If TypeName(otxtSalesArea) <> "Nothing" Then otxtSalesArea = "P20"
         If TypeName(otxtSalesArea1) <> "Nothing" Then otxtSalesArea1 = "P29"
         strSalesArea = "P20"
         strSalesArea1 = "P29"
         m_strAuthorityCon = " and st15>='P20' and st15<='P29'"
         m_intSpecSet = 1
         If TypeName(otxtSales) <> "Nothing" Then otxtSales.Enabled = True
       
      'Add By Sindy 2021/11/10
      '江協理可看內外商
      Case "98020"
         If TypeName(otxtSalesArea) <> "Nothing" Then otxtSalesArea = "F10" '"P20"
         If TypeName(otxtSalesArea1) <> "Nothing" Then otxtSalesArea1 = "P29"
         strSalesArea = "F10" '"P20"
         strSalesArea1 = "P29"
         m_strAuthorityCon = " and ((st15>='P20' and st15<='P29') or (st15>='F10' and st15<='F12'))"
         m_intSpecSet = 1
         If TypeName(otxtSales) <> "Nothing" Then otxtSales.Enabled = True
         
      Case Else
         '杜燕文,劉大愛可看S31
         'Modify By Sindy 2022/5/9 杜經理此權限只使用到 20220513
         If strQPerson = "74018" And strSrvDate(1) < 20220514 Then
            If TypeName(otxtZone) <> "Nothing" Then otxtZone = pub_strUserOffice
            If TypeName(otxtSalesArea) <> "Nothing" Then otxtSalesArea = "S31"
            If TypeName(otxtSalesArea1) <> "Nothing" Then otxtSalesArea1 = "S31"
            strSalesArea = "S31"
            strSalesArea1 = "S31"
            m_strAuthorityCon = " and st15 = 'S31'"
            m_intSpecSet = 1
            If TypeName(otxtSales) <> "Nothing" Then otxtSales.Enabled = True
         'Added by Lydia 2023/04/24 修改王副總退休之相關控制; 5/1加入李柏翰99050
         ElseIf strSrvDate(1) >= "20230501" And strQPerson = "99050" Then
            GoTo JumpToDef
         'end 2023/04/24
         Else
            'Add by Amy 2016/01/06 各區主管 抓A0908; 各區主管,因有承辦資料不可抓st05
            If GetDeptMan(stST15) = strUserNum Then
                m_intSpecSet = 3
            End If
            
            Select Case stST05
               '電腦中心,財務,總經理看全部
               '2015/7/28 MODIFY BY SONIA +主任秘書(等級08)可看全部
               Case "00", "01", "08"
                  If TypeName(otxtZone) <> "Nothing" Then otxtZone.Enabled = True
                  If TypeName(otxtSalesArea) <> "Nothing" Then otxtSalesArea.Enabled = True
                  If TypeName(otxtSalesArea1) <> "Nothing" Then otxtSalesArea1.Enabled = True
                  If TypeName(otxtSales) <> "Nothing" Then otxtSales.Enabled = True
               '分所財務人員可看該所全部
   '            Case "C1", "NM", "KM"
   '               otxtZone = pub_strUserOffice
   '               otxtSalesArea.Enabled = True
   '               otxtSalesArea1.Enabled = True
   '               otxtSales.Enabled = True
                  
               '各區主管
               Case "SM"
                  If TypeName(otxtZone) <> "Nothing" Then otxtZone = pub_strUserOffice
                  '2005/7/5 ADD BY SONIA
                  If TypeName(otxtSalesArea) <> "Nothing" Then otxtSalesArea.Locked = True
                  If TypeName(otxtSalesArea1) <> "Nothing" Then otxtSalesArea1.Locked = True
                  '2005/7/5 END
   '               '原羅文旭72009可兼看中一區,94/7/1只可看S22
   '               '2005/7/5林永生71003可看中所全部,但預設S23
   '               If strQPerson = "71003" Then
   '                  If TypeName(otxtSalesArea) <> "Nothing" Then
   '                     otxtSalesArea = "S23"
   '                     '2005/7/5 ADD BY SONIA
   '                     otxtSalesArea.Locked = False
   '                     otxtSalesArea.Enabled = True
   '                  ElseIf TypeName(otxtSalesArea1) <> "Nothing" Then
   '                     otxtSalesArea1 = "S23"
   '                     '2005/7/5 ADD BY SONIA
   '                     otxtSalesArea1.Locked = False
   '                     otxtSalesArea1.Enabled = True
   '                  End If
   '                  strSalesArea = "S23"
   '                  strSalesArea1 = "S23"
   '                  m_strAuthorityCon = " and st15 like 'S2%'"
   '               End If
                  
                  strSalesArea = stST15
                  strSalesArea1 = stST15
                  m_strAuthorityCon = " and st15='" & Pub_StrUserSt15 & "'"
                  '2006/11/29 ADD BY SONIA簡協理可看北所全部但預設S15
                  'Modify By Sindy 2022/5/4 簡協理改為抓系統特殊設定「全所智權部主管」
                  If InStr(Pub_GetSpecMan("全所智權部主管"), strQPerson) > 0 Then
                     'Add by Sindy 2021/8/10 簡協理可看全智權部
                     If TypeName(otxtZone) <> "Nothing" Then
                        otxtZone = pub_strUserOffice
                        otxtZone.Enabled = True '開放所別
                     End If
                     '2021/8/10 END
                     If TypeName(otxtSalesArea) <> "Nothing" Then
                        otxtSalesArea = stST15 '"S15"
                        otxtSalesArea.Locked = False
                        otxtSalesArea.Enabled = True
                     End If
                     If TypeName(otxtSalesArea1) <> "Nothing" Then
                        otxtSalesArea1 = stST15 '"S15"
                        otxtSalesArea1.Locked = False
                        otxtSalesArea1.Enabled = True
                     End If
                     'Modified by Morgan 2019/12/30 杜主秘說加開簡協理69005可看全所
                     'strSalesArea = "S10"
                     'strSalesArea1 = "S19"
                     strSalesArea = "S00"
                     strSalesArea1 = "S99"
                     m_intSpecSet = 1
                     'end 2019/12/30
                     'Removed by Morgan 2019/12/31 杜主秘說加開簡協理69005可看全所
                     'm_strAuthorityCon = " and st15 like 'S1%'"
                     'end 2019/12/31
                     'Added by Lydia 2023/01/07 電子收文接洽單查詢：協理可看全智權部
                     m_strAuthorityCon = " and st15 like 'S%'"
                  '2006/11/29 END
                  Else
                     If TypeName(otxtSalesArea) <> "Nothing" Then otxtSalesArea = stST15
                     If TypeName(otxtSalesArea1) <> "Nothing" Then otxtSalesArea1 = stST15
                  End If
                  If TypeName(otxtSales) <> "Nothing" Then otxtSales.Enabled = True
               
               'add by nickc 2008/01/18  加入外商主管  王宗珮、洪琬姿、葉易雲
               Case "21", "26", "28"
                  If TypeName(otxtZone) <> "Nothing" Then otxtZone = pub_strUserOffice
                  If TypeName(otxtSalesArea) <> "Nothing" Then otxtSalesArea = stST15
                  If TypeName(otxtSalesArea1) <> "Nothing" Then otxtSalesArea1 = stST15
                  If TypeName(otxtSales) <> "Nothing" Then
'                     otxtSales = strQPerson
                     otxtSales.Enabled = True
                  End If
                  m_strAuthorityCon = " and st15='" & Pub_StrUserSt15 & "' and st16='" & PUB_GetStaffST16(strUserNum) & "'"
               '其他只能看自己
               Case Else
                  strSalesArea = stST15
                  strSalesArea1 = stST15
                  
                  If TypeName(otxtZone) <> "Nothing" Then otxtZone = pub_strUserOffice
                  If TypeName(otxtSalesArea) <> "Nothing" Then otxtSalesArea = stST15
                  If TypeName(otxtSalesArea1) <> "Nothing" Then otxtSalesArea1 = stST15
'                  If TypeName(otxtSales) <> "Nothing" Then otxtSales = strQPerson
                  
                  stST52List = GetST52List(strQPerson)
                  stIdList = PUB_GetSalesList(strQPerson, , , , , strTmp(2), strTmp(3))
                  'Added by Lydia 2017/07/25 多使用者權限,則增加部門範圍
                  'Add By Sindy 2025/3/19
                  If strTmp(3) <> "" And strTmp(3) > strSalesArea1 Then
                     strSalesArea1 = strTmp(3)
                  End If
                  '2025/3/19 END
                  If TypeName(otxtSalesArea1) <> "Nothing" Then
                     'strtmp(1) = PUB_GetSalesList(strQPerson, , , , , strtmp(2), strtmp(3))
                     If strTmp(3) <> "" And strTmp(3) > otxtSalesArea1 Then
                        otxtSalesArea1 = strTmp(3)
                     End If
                  End If
                  'end 2017/07/25
                  
   '               If (stIdList = MsgText(601) Or sCount(Replace(stIdList, "'", ""), strQPerson, ",") = 1) And _
   '                  stST52List = MsgText(601) Then
                  If (stIdList = MsgText(601) Or Replace(stIdList, "'", "") = strQPerson) And _
                     stST52List = MsgText(601) Then
                      bolQSelf = True
                  ElseIf stIdList <> MsgText(601) Then
                      m_intSpecSet = 6
                  End If
                  If stST52List <> MsgText(601) Then stIdList = stIdList & "," & stST52List: m_intSpecSet = 5
                  
                  bolQSelf = True 'frm210137:判斷是查自己,會顯示不同的作業名稱
            End Select
         End If
   End Select
   'Add By Sindy 2009/05/12
   '若操作人員的ST05=SA且在職員工的ST52有該編號存在,此類人員稱之為帶人主管,開放智權人員欄位可輸入
   'If PUB_GetST05(strUserNum) = "SA" Then '智權人員:帶人主管
   If stST05 <> "00" Then
      If PUB_GetST05Limits(strQPerson) = True Then
         If m_strAuthorityCon = "" Then 'Added by Lydia 2023/01/07 電子收文接洽單查詢：特定主管已先設定
            m_strAuthorityCon = " and '" & strUserNum & "' in (st01,st52,st53,st54,st55)"
         End If 'Added by Lydia 2023/01/07
         If TypeName(otxtSales) <> "Nothing" Then otxtSales.Enabled = True
      End If
   End If
   '2011/8/5 add by sonia 中三區人員可單獨下68096看期限
   If PUB_GetStaffST15(strQPerson, "1") = "S23" Then
      If TypeName(otxtSales) <> "Nothing" Then otxtSales.Enabled = True
   End If
   '2011/8/5 end
   '2013/5/14 add by sonia 北五區人員可單獨下10051看期限
   If PUB_GetStaffST15(strQPerson, "1") = "S15" Then
      If TypeName(otxtSales) <> "Nothing" Then otxtSales.Enabled = True
   End If
   '2013/5/14 end
   '2021/10/12 add by Sindy 顧問服務組人員可單獨下W2001看期限
   If PUB_GetStaffST15(strQPerson, "1") = "W20" Then
      If TypeName(otxtSales) <> "Nothing" Then otxtSales.Enabled = True
   End If
   '2021/10/12 end
   
   'Add by Amy 2015/02/03 +總經理業務工作代理人員
   If CheckLevel(strQPerson, "總經理業務工作代理人員") = True Then
      bolSpecMan = True: m_intSpecSet = 4
      strSpecCode = "總經理業務工作代理人員"
   'Modify by Amy 2014/05/15 開放專利處部份智權同仁資料給彥葶代為處理
   ElseIf CheckLevel(strQPerson, "A8") = True Then
      bolSpecMan = True: m_intSpecSet = 4
      strSpecCode = "A8"
   End If
   If bolSpecMan = True Then
      'Add by Amy 2015/02/03 +總經理業務工作代理人員
      If InStr(strSpecCode, "總經理業務工作代理人員") > 0 Then
         If TypeName(otxtZone) <> "Nothing" Then otxtZone.Enabled = True
         If TypeName(otxtSalesArea) <> "Nothing" Then
            otxtSalesArea.Enabled = True
            otxtSalesArea = ""
         End If
         If TypeName(otxtSalesArea1) <> "Nothing" Then
            otxtSalesArea1.Enabled = True
            otxtSalesArea1 = ""
         End If
         If TypeName(otxtSales) <> "Nothing" Then otxtSales.Enabled = True
      End If
      If InStr(strSpecCode, "A8") > 0 Then
         If TypeName(otxtSales) <> "Nothing" Then
            otxtSales.Enabled = True
            otxtSales = ""
         End If
      End If
   Else
'      If TypeName(otxtSales) <> "Nothing" Then otxtSales = strQPerson
   End If
   'end 2014/05/15
End If

'cancel by sonia 2024/9/27
'   'Add By Sindy 2023/5/16
'   If bolFirstLoad = True Then '第一次載入Form,預設值
'      If InStr(Pub_GetSpecMan("P1004管理人員"), strQPerson) > 0 Then
'         If TypeName(otxtSales) <> "Nothing" Then otxtSales.Text = "P1004"
'         If TypeName(otxtStarDate) <> "Nothing" Then otxtStarDate.Text = "111112" '回傳起始日期
'         If TypeName(otxtSalesArea) <> "Nothing" Then otxtSalesArea.Text = PUB_GetStaffST15("P1004", "1")
'         If TypeName(otxtSalesArea1) <> "Nothing" Then otxtSalesArea1.Text = PUB_GetStaffST15("P1004", "1")
'      End If
'   End If
'   '2023/5/16 END
'end 2024/9/27
   
   'Add By Sindy 2016/5/6 記錄原操作人可以查詢的業務區及所別
   If TypeName(otxtZone) <> "Nothing" Then otxtZone.Tag = otxtZone
   If TypeName(otxtSalesArea) <> "Nothing" Then otxtSalesArea.Tag = otxtSalesArea
   If TypeName(otxtSalesArea1) <> "Nothing" Then otxtSalesArea1.Tag = otxtSalesArea1
   '2016/5/6 END
End Function

'Add By Sindy 2023/9/6 智權部作業畫面上員工欄位值和Login的人員權限; Login的人員是否有其操作的權限
'Modify By Sindy 2024/9/19 + , Optional ByVal strFormNm As String = "": 傳入Form Name; 若有特殊檢查條件
Public Function PUB_txtSales_Limit(otxtSales As Object, m_strListPer As String, Optional otxtZone As Object, _
   Optional otxtSalesArea As Object, Optional otxtSalesArea1 As Object, _
   Optional ByRef bolSpecMan As Boolean = False, Optional ByRef strSpecCode As String, _
   Optional lblSalesName As Object, Optional ByVal strFormNm As String = "") As Boolean
   
Dim arrPer As Variant
Dim idx As Integer
Dim strSalesArea As String, strSalesArea1 As String
Dim bolChkBase As Boolean 'Add By Sindy 2024/9/19
Dim stST05 As String 'Add By Sindy 2024/9/19
   
   PUB_txtSales_Limit = False '預設值
   stST05 = PUB_GetST05(strUserNum) 'Add By Sindy 2024/9/19
   
   otxtSales.Text = Trim(otxtSales.Text) 'add by sonia 2016/6/7
   If Trim(otxtSales) = "" Then
      lblSalesName = ""
   End If
   'Add By Sindy 2025/8/11 為了檢查82026林柄佑權限,不同部門而增加的程式段
   If TypeName(otxtSalesArea) <> "Nothing" Then strSalesArea = otxtSalesArea
   If TypeName(otxtSalesArea1) <> "Nothing" Then strSalesArea1 = otxtSalesArea1
   '2025/8/11 END
   
   'Add By Sindy 2024/9/19 基礎檢查(LoginID和輸入欲查詢的人員)過不了,就先檢查職代問題
   'Modify By Sindy 2025/3/17 + strFormNm
   bolChkBase = PUB_ChkSalePerLimit(CStr(otxtSales.Text), strUserNum, False, bolSpecMan, strSpecCode, strSalesArea, strSalesArea1, , strFormNm)
   If bolChkBase = False Then
   '2024/9/19 END
      'Add By Sindy 2016/5/4 檢查是否為職代操作
      If otxtSales.Text <> strUserNum And m_strListPer <> "" Then
         '可以代休假人員查詢他的期限資料
         'Modify by Amy 2020/03/25 +txtSales<>"",避免清空將業務區也清空,可查全部
         If InStr(m_strListPer, otxtSales.Text) > 0 And otxtSales.Text <> "" Then
            If TypeName(otxtZone) <> "Nothing" Then otxtZone = PUB_GetST06(Trim(otxtSales))
            If TypeName(otxtSalesArea) <> "Nothing" Then otxtSalesArea = PUB_GetStaffST15(Trim(otxtSales), "1")
            If TypeName(otxtSalesArea1) <> "Nothing" Then otxtSalesArea1 = PUB_GetStaffST15(Trim(otxtSales), "1")
            PUB_txtSales_Limit = True '權限符合
            Exit Function
         Else
            '限只能在該區範圍內查詢
            If PUB_GetStaffST15(CStr(otxtSales.Text), 1) = PUB_GetStaffST15(strUserNum, 1) Then
               '該區若為區主管的職代,主管休假,可查詢同區人員資料
               arrPer = Split(m_strListPer, ";")
               For idx = 0 To UBound(arrPer) - 1
                  'Modify By Sindy 2025/3/17 + strFormNm
                  If PUB_ChkSalePerLimit(CStr(otxtSales.Text), CStr(arrPer(idx)), , bolSpecMan, strSpecCode, strSalesArea, strSalesArea1, , strFormNm) = False Then
                     Exit Function
                  'Add By Sindy 2020/6/11
                  Else
                     GoTo RunExit
                  End If
                  '2020/6/11 END
               Next idx
            End If
         End If
      End If
   End If
   
   If bolChkBase = True Then
      GoTo RunExit
   Else
      'Modify By Sindy 2025/3/17 + strFormNm
      If PUB_ChkSalePerLimit(CStr(otxtSales.Text), strUserNum, , bolSpecMan, strSpecCode, strSalesArea, strSalesArea1, , strFormNm) = False Then
         Exit Function
      End If
   End If
   
RunExit:
'   'Modify By Sindy 2020/7/15 + And txtSalesArea <> ""
'   strExc(10) = ""
'   If TypeName(otxtSalesArea) <> "Nothing" Then
'      strExc(10) = otxtSalesArea.Text
'   End If
   
   '跨部門; 例如:姿如72014 strSalesArea=M71 strSalesArea1=S21
   '智權人員為空白時,部門起迄不可跨部門
   If Left(strSalesArea, 1) <> Left(strSalesArea1, 1) And otxtSales = "" Then
      strSalesArea1 = strSalesArea
   End If
   
   If TypeName(otxtZone) <> "Nothing" And otxtSales <> "" Then otxtZone = PUB_GetST06(Trim(otxtSales))
   
   'If otxtSales <> "" And strSalesArea <> "" And strExc(10) <> "" Then 'And otxtSalesArea <> ""
   'Modify By Sindy 2025/3/21
   If strSalesArea <> "" Then
'      If TypeName(otxtSalesArea) <> "Nothing" Then otxtSalesArea.Text = strSalesArea
'      If TypeName(otxtSalesArea1) <> "Nothing" Then otxtSalesArea1.Text = strSalesArea1
      If TypeName(otxtSalesArea) <> "Nothing" Then
         If otxtSalesArea.Text = "" Then
            otxtSalesArea.Text = strSalesArea
         Else
            If Not (otxtSalesArea.Text >= strSalesArea And otxtSalesArea.Text <= strSalesArea1) Then
               otxtSalesArea.Text = strSalesArea
            End If
         End If
      End If
   End If
   If strSalesArea1 <> "" Then
      If TypeName(otxtSalesArea1) <> "Nothing" Then
         If otxtSalesArea1.Text = "" Then
            otxtSalesArea1.Text = strSalesArea1
         Else
            If Not (otxtSalesArea1.Text >= strSalesArea And otxtSalesArea1.Text <= strSalesArea1) Then
               otxtSalesArea1.Text = strSalesArea1
            End If
         End If
      End If
   End If
   '2025/3/21 END
   
   PUB_txtSales_Limit = True '權限符合
   Exit Function
End Function

'Modify By Sindy 2016/5/6 將查詢權限剔出來檢查 : 來自於 frm100123.期限資料查詢
'strPerson:當事人
'strQPer:欲查詢人員
'Modify By Sindy 2023/9/6 + Optional ByVal strMsgChkTxt As String = ""
'Modify By Sindy 2025/3/17 + Optional ByVal strFormNm As String = "" : 指定某作業開放的權限
Public Function PUB_ChkSalePerLimit(strPerson As String, strQPer As String, Optional ShowMsg As Boolean = True, _
   Optional ByRef bolSpecMan As Boolean = False, Optional ByRef strSpecCode As String, _
   Optional ByRef strSalesArea As String, Optional ByRef strSalesArea1 As String, _
   Optional ByVal strMsgChkTxt As String = "", Optional ByVal strFormNm As String = "") As Boolean
   
Dim strDept As String
Dim strDept1 As String
Dim stST05 As String
   
   stST05 = PUB_GetST05(strQPer)
   PUB_ChkSalePerLimit = False '無權限
   'Add By Sindy 2025/8/11
   If strUserNum = "82026" Then
      strDept = strSalesArea
      strDept1 = strSalesArea1
   End If
   '2025/8/11 END
   strSalesArea = "": strSalesArea1 = "" 'Add By Sindy 2020/6/11
   'Add By Sindy 2020/7/28 取得查詢人員可以查詢的部門區間
   'Modify By Sindy 2025/3/19 Mark
'   'Add By Sindy 2023/9/6
'   If strSpecCode <> "" Then
'      'Modify By Sindy 2025/3/18 +strFormNm
'      Call PUB_SetFormSaleDept(strQPer, , , , , bolSpecMan, strSpecCode, , , , , , , , strFormNm)
'   End If
'   '2023/9/6 END
   '2025/3/19 END
   'Modify By Sindy 2023/9/6 strQPer 改為 strPerson
   'Modify By Sindy 2025/3/18 +strFormNm
   'Modify By Sindy 2025/3/19 strPerson 改為 strQPer: 人員空白時,才能抓到有權限查詢的起迄部門
   Call PUB_SetFormSaleDept(strQPer, , , , , bolSpecMan, strSpecCode, strDept, strDept1, , , , , , strFormNm)
   strSalesArea = strDept 'Add By Sindy 2025/3/19
   strSalesArea1 = strDept1 'Add By Sindy 2025/3/19
   
   'Modify by Amy 2014/05/15
   If bolSpecMan = True Then
      'Modify by Amy 2019/02/12 +總經理業務工作代理人員,可處理總經理員工編號
      If InStr(strSpecCode, "A8") > 0 Or InStr(strSpecCode, "總經理業務工作代理人") > 0 Then
         'Add by Sindy 2020/7/28 + strPerson = ""
         'Modify by Sindy 2020/8/12 + And InStr(strSpecCode, "總經理業務工作代理人") > 0
         If strPerson = "" And InStr(strSpecCode, "總經理業務工作代理人") > 0 Then
            If ShowMsg = True Then
               MsgBox "您無權限查詢所有人資料！請輸入欲查詢智權人員之員工編號！", vbExclamation, "操作錯誤！"
            End If
            Exit Function
         Else
         '2020/7/28 END
            '開放專利處部份智權(A7)同仁資料給彥葶(A8)代為處理
            If InStr(strSpecCode, "A8") > 0 And (InStr(Pub_GetSpecMan("A7"), strPerson) > 0 Or strPerson = strQPer) Then
               PUB_ChkSalePerLimit = True
               GoTo ExitEnd
            'Add by Amy 2019/02/12 +總經理業務工作代理人,可處理總經理員工編號
            ElseIf InStr(strSpecCode, "總經理業務工作代理人") > 0 And (InStr(Pub_GetSpecMan("總經理員工編號"), strPerson) > 0 Or _
                                                                       strPerson = strQPer) Then
               PUB_ChkSalePerLimit = True
               GoTo ExitEnd
            Else
               If ShowMsg = True Then
                  MsgBox "您無權限查此" & IIf(strMsgChkTxt = "案件", "案件", "人") & "資料！", vbExclamation, "操作錯誤！"
               End If
               Exit Function
            End If
         End If
      End If
   End If
   'end 2014/05/15
   
   'Modify By Sindy 2009/05/12
   '若為帶人主管權限時,檢查其輸入的智權人員之第二級期限管制人是否為操作人員
   'Modify By Sindy 2016/5/6 And txtSales.Enabled = True 取消
   'modify by sonia 2016/6/6 帶人主管條件改寫法
   'If Trim(strPerson) <> "" And PUB_GetST05(strQPer) = "SA" Then
   'If Trim(strPerson) <> "" And PUB_GetST05Limits(strUserNum) = True Then
   'Modify By Sindy 2020/7/1 開放北一區魏經理75007可查詢W1001之智權工作資料;
   '                         檢查是否為帶人主管時，取消PUB_GetST05(strUserNum) = "SA"及PUB_GetST05(strUserNum) <> "SM"
   'If Trim(strPerson) <> "" And (PUB_GetST05Limits(strUserNum) = True And PUB_GetST05(strUserNum) <> "SM") Then
   'If Trim(strPerson) <> "" And PUB_GetST05Limits(strUserNum) = True Then
   'Modify By Sindy 2020/7/14
   If Trim(strPerson) <> "" Then
   '2020/7/14 END
      'Modify By Sindy 2014/8/28
      'If txtSales <> strUserNum And PUB_GetST52(txtSales) <> strUserNum Then
      If strPerson <> strQPer And PUB_GetST52(strPerson, strQPer) = False Then
      '2014/8/28 END
         '2020/7/15  +主任秘書(等級08)可看全部
         '電腦中心,財務,總經理看全部
         If PUB_GetST05(strUserNum) = "00" Or PUB_GetST05(strUserNum) = "01" Or PUB_GetST05(strUserNum) = "08" Then
            PUB_ChkSalePerLimit = True
            GoTo ExitEnd
         End If
         'add by sonia 2020/7/6 SM檢查是否同區(因為上面開放魏經理看W1001取消PUB_GetST05(strUserNum) <> "SM"而造成主管不能看個人)
         If PUB_GetST05(strUserNum) = "SM" And PUB_GetStaffST15(Trim(strPerson), "1") = PUB_GetStaffST15(Trim(strQPer), "1") Then
            PUB_ChkSalePerLimit = True
            GoTo ExitEnd
         End If
         'end 2020/7/6
         '簡協理可以看智權部同仁資料
         'Modify By Sindy 2022/5/4 簡協理改為抓系統特殊設定「全所智權部主管」
         If Mid(PUB_GetStaffST15(Trim(strPerson), "1"), 1, 1) = "S" And InStr(Pub_GetSpecMan("全所智權部主管"), strQPer) > 0 Then
            PUB_ChkSalePerLimit = True '有權限
            GoTo ExitEnd
         End If
         
         'Add By Sindy 2022/5/12
         '王副總可看專利處
         'Modifed by Lydia 2023/04/24 修改王副總退休之相關控制; 5/1加入李柏翰99050
         'If strQPer = "71011" And Mid(PUB_GetStaffST15(Trim(strPerson), "1"), 1, 2) = "P1" Then
         If (strQPer = "71011" Or (strSrvDate(1) >= "20230501" And strQPer = "99050")) And Mid(PUB_GetStaffST15(Trim(strPerson), "1"), 1, 2) = "P1" Then
            PUB_ChkSalePerLimit = True '有權限
            GoTo ExitEnd
         End If
         '2022/5/12 END
         
         'Add By Sindy 2021/11/10
         '江協理可看內外商
         If strQPer = "98020" And _
            (Mid(PUB_GetStaffST15(Trim(strPerson), "1"), 1, 2) = "P2" Or Mid(PUB_GetStaffST15(Trim(strPerson), "1"), 1, 2) = "F1") Then
            PUB_ChkSalePerLimit = True '有權限
            GoTo ExitEnd
         End If
         '2021/11/10 END
         
         '2011/8/5 add by sonia 中三區人員可單獨下68096看期限
         If PUB_GetStaffST15(strQPer, "1") = "S23" Then
            If strPerson = "68096" Then
               PUB_ChkSalePerLimit = True '有權限
               GoTo ExitEnd
            'Add By Sindy 2021/1/14
            Else
               If ShowMsg = True Then
                  MsgBox "您無查詢權限！", vbExclamation, "操作錯誤！"
               End If
               Exit Function
            End If
            '2021/1/14 END
         End If
         '2011/8/5 end
         
         '2013/5/14 add by sonia 北五區人員可單獨下10051看期限
         If PUB_GetStaffST15(strQPer, "1") = "S15" Then
            If strPerson = "10051" Then
               PUB_ChkSalePerLimit = True '有權限
               GoTo ExitEnd
            'Add By Sindy 2021/1/14 北五區同仁不可以互相查詢了
            Else
               If ShowMsg = True Then
                  MsgBox "您無查詢權限！", vbExclamation, "操作錯誤！"
               End If
               Exit Function
            End If
            '2021/1/14 END
         End If
         '2013/5/14 end
         
         '2021/10/12 add by Sindy 顧問服務組人員可單獨下W2001看期限
         If PUB_GetStaffST15(strQPer, "1") = "W20" Then
            If strPerson = "W2001" Then
               PUB_ChkSalePerLimit = True '有權限
               GoTo ExitEnd
            'Add By Sindy 2021/1/14 北五區同仁不可以互相查詢了
            Else
               If ShowMsg = True Then
                  MsgBox "您無查詢權限！", vbExclamation, "操作錯誤！"
               End If
               Exit Function
            End If
            '2021/1/14 END
         End If
         '2021/10/12 end
         
'         'Add By Sindy 2020/7/28 有限制可以查詢的部門區間: (北五區.S15?)
'         If PUB_GetStaffST15(Trim(strPerson), "1") >= strDept And PUB_GetStaffST15(Trim(strPerson), "1") <= strDept1 Then
'            PUB_ChkSalePerLimit = True '有權限
'            GoTo ExitEnd
'         End If
           
         'Add By Sindy 2024/9/19 特殊檢查條件
         If UCase(strFormNm) = "FRM210104" Then
            'Modify By Sindy 2020/8/6 特別的權限
            '分所財務人員可看該所全部
            If (stST05 = "CM" Or stST05 = "C1" Or stST05 = "NM" Or stST05 = "KM") And _
               PUB_GetST06(strPerson) = PUB_GetST06(strQPer) Then
               PUB_ChkSalePerLimit = True '有權限
               GoTo ExitEnd
            '郭雅娟也可看專利處 2014/8/15
            ElseIf strQPer = "79075" Then
               If PUB_GetST03(strPerson) >= strSalesArea And PUB_GetST03(strPerson) <= strSalesArea1 Then
                  PUB_ChkSalePerLimit = True '有權限
                  GoTo ExitEnd
               End If
            End If
            '2020/8/6 END
         '2024/9/19 END
         'Add By Sindy 2021/6/2 客戶應收帳款查詢frm210122、暫收款查詢frm210105：開放分所管理人員(部門M71)可查詢該所人員資料
         'Modify By Sindy 2025/3/17 + 請款作業及應收查詢frm210146
         '  調整權限:杜協理這次的需求，僅開放請款作業及應收查詢(frm210146及frm210122)，
         '           其他功能維持不開放(但上方的暫收款查詢frm210105也要一併改)：
         '           開放等級為C2、CM、CS、KM、NM、S1、T9的人員可以查詢該所智權部人員(ST15為S開頭)的資料。
         'Modify By Sindy 2025/4/2 增加開放 FRM210101_1客戶資料修改
         ElseIf UCase(strFormNm) = "FRM210122" Or UCase(strFormNm) = "FRM210105" Or UCase(strFormNm) = "FRM210146" Or UCase(strFormNm) = "FRM210101_1" Then
         '2025/3/17 END
            'If PUB_GetST03(strQPer) = "M71" Then
            'Modify By Sindy 2025/5/13 +、N1 +C1、
            If InStr("C1、C2、CM、CS、KM、NM、S1、T9、N1", stST05) > 0 Then
               'Modify By Sindy 2025/4/17 取消此條件限制: And Left(PUB_GetStaffST15(strPerson, "1"), 1) = "S"
               If PUB_GetST06(strPerson) = PUB_GetST06(strQPer) Then
                  PUB_ChkSalePerLimit = True '有權限
                  GoTo ExitEnd
               End If
            End If
         End If
         '2021/6/2 End
         
         If Mid(PUB_GetStaffST15(Trim(strQPer), "1"), 1, 1) <> "S" Then
      '      chkNP.Enabled = False
      '      chkNP.Value = 0
             'add by nickc 2008/01/18 加入外商主管  可以輸入相同組別的
             'If (stST05 = "21" Or stST05 = "26" Or stST05 = "28") And Trim(strPerson) <> "" Then
            If (stST05 = "21" Or stST05 = "26" Or stST05 = "28") Then
               If PUB_GetStaffST16(strQPer) <> PUB_GetStaffST16(strPerson) Then
                  If ShowMsg = True Then
                     'Modify By Sindy 2023/9/6
                     If strMsgChkTxt = "案件" Then
                        MsgBox "您無查詢權限！", vbExclamation, "操作錯誤！"
                     Else
                     '2023/9/6 END
                        MsgBox "僅可以輸入相同組別的智權人員！", vbExclamation, "操作錯誤！"
                     End If
                  End If
                  Exit Function
               Else
                  PUB_ChkSalePerLimit = True '有權限
                  GoTo ExitEnd
               End If
            End If
            'Modify By Sindy 2023/5/26 開放專利處部份人員(A7)之智權工作給A8代為處理
            If InStr(Pub_GetSpecMan("A7"), strPerson) > 0 And InStr(Pub_GetSpecMan("A8"), strQPer) > 0 Then
               PUB_ChkSalePerLimit = True '有權限
               GoTo ExitEnd
            Else
            '2023/5/26 END
               If PUB_GetStaffST15(strQPer, "1") <> PUB_GetStaffST15(strPerson, "1") And _
                  GetDeptMan(PUB_GetStaffST15(Trim(strPerson), "1")) <> strQPer Then
                  If ShowMsg = True Then
                     'Modify By Sindy 2023/9/6
                     If strMsgChkTxt = "案件" Then
                        MsgBox "您無查詢權限！", vbExclamation, "操作錯誤！"
                     Else
                     '2023/9/6 END
                        MsgBox "僅可以輸入相同部門的智權人員！", vbExclamation, "操作錯誤！"
                     End If
                 End If
                  Exit Function
   '            Else
   '               PUB_ChkSalePerLimit = True '有權限
   '               GoTo ExitEnd
               End If
            End If
         End If
         
         'Add By Sindy 2020/7/14 區主管可以看該部門人員資料
         If GetDeptMan(PUB_GetStaffST15(Trim(strPerson), "1")) = strQPer Then
            PUB_ChkSalePerLimit = True
            GoTo ExitEnd
         End If
         '2020/7/14 END
         
         If ShowMsg = True Then
            MsgBox "您無查詢權限！", vbExclamation, "操作錯誤！"
         End If
         Exit Function
      Else
         'txtZone = PUB_GetST06(Trim(txtSales)) 'Remove by Morgan 2010/9/24
         'Modify By Sindy 2020/6/11
         'txtSalesArea = PUB_GetStaffST15(Trim(strPerson), "1")
         'txtSalesArea1 = PUB_GetStaffST15(Trim(strPerson), "1")
'         strSalesArea = PUB_GetStaffST15(Trim(strPerson), "1")
'         strSalesArea1 = PUB_GetStaffST15(Trim(strPerson), "1")
         'Add By Sindy 2021/11/10 江協理為跨部門主管,查自己的資料時,部門放到可查詢的最大區間
         If Not (strPerson = "98020" And strQPer = "98020") Then
         '2021/11/10 END
            strDept = PUB_GetStaffST15(Trim(strPerson), "1") 'Add by Sindy 2020/8/24
            strDept1 = PUB_GetStaffST15(Trim(strPerson), "1") 'Add by Sindy 2020/8/24
         End If
         PUB_ChkSalePerLimit = True '有權限
         GoTo ExitEnd
         '2020/6/11 END
      End If
   Else
      'Add By Sindy 2021/11/10 江協理沒有輸入要查看的人員編號時,部門放到可查詢的最大區間
      If strQPer = "98020" Then
         strSalesArea = strDept
         strSalesArea1 = strDept1
      End If
      '2021/11/10 END
   End If
   
   '2011/8/9 add by sonia 主管才可不輸入智權人員查詢
   If PUB_GetST05(strQPer) = "SA" And strPerson = "" Then
      If ShowMsg = True Then
         MsgBox "您無權限查詢所有人資料！請輸入欲查詢智權人員之員工編號！", vbExclamation, "操作錯誤！"
      End If
      Exit Function
   '2011/8/9 end
'   Else
'       chkNP.Enabled = True
'   Else
'      If ShowMsg = True Then
'         MsgBox "您無權限查詢資料！", vbExclamation, "操作錯誤！"
'      End If
'      Exit Function
   End If
   
   'add by nickc 2008/01/18 加入外商主管  可以輸入相同組別的
   'Modify By Sindy 2021/8/31 只有等級11.外商主管,可以輸入不同組別的同仁做查詢
   'If (stST05 = "21" Or stST05 = "26" Or stST05 = "28") Then
   If Left(PUB_GetStaffST15(strQPer, 1), 2) = "F1" And stST05 <> "11" Then
   '2021/8/31 END
      If Trim(strPerson) = "" Then
         If ShowMsg = True Then
            MsgBox "智權人員不可以空白！", vbExclamation, "操作錯誤！"
         End If
         Exit Function
      End If
'      If PUB_GetStaffST16(strQPer) <> PUB_GetStaffST16(strPerson) Then
'         If ShowMsg = True Then
'            MsgBox "僅可以輸入相同組別的智權人員！", vbExclamation, "操作錯誤！"
'         End If
'         Exit Function
'      End If
   End If
   
   PUB_ChkSalePerLimit = True '有權限
ExitEnd:
   If PUB_ChkSalePerLimit = True And Trim(strPerson) <> "" Then '有權限,查詢個人
      'Modify By Sindy 2020/8/6
      'If strDept <> "" Then
      'Modify By Sindy 2021/11/10 + 江協理為跨部門主管,查自己的資料時,部門放到可查詢的最大區間
      If strDept <> "" And (strPerson <> strQPer Or (strPerson = "98020" And strQPer = "98020")) Then
      '2020/8/6 END
         strSalesArea = strDept
         strSalesArea1 = strDept1
      Else
         strSalesArea = PUB_GetStaffST15(Trim(strPerson), "1")
         strSalesArea1 = PUB_GetStaffST15(Trim(strPerson), "1")
      End If
   End If
End Function


'Added by Morgan 2020/8/14
'取得EPC子案指定國註冊費發文代理人(抓核准報價時設定的代理人)
Public Function PUB_GetAgentList(pPA01 As String, pPA02 As String, pPA03 As String, pCountry As String) As String
   Dim stSQL As String, intQ As Integer
   Dim ii As Integer, pa04 As String, strAgentList As String
   Dim rsQuery As ADODB.Recordset
   Dim arrCountry() As String
   
   arrCountry = Split(pCountry, ",")
   For ii = 0 To UBound(arrCountry)
      pa04 = GetPA04(pPA01, pPA02, pPA03, Format(arrCountry(ii)))
      stSQL = "select cp44,cp116 from caseprogress" & _
         " where cp01='" & pPA01 & "' and cp02='" & pPA02 & "' and cp03='" & pPA03 & "' and cp04='" & pa04 & "'" & _
         " and cp10='1001' and cp44 is not null"
      intQ = 1
      Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
      If intQ = 1 Then
         strAgentList = strAgentList & "," & rsQuery("cp44")
         If Not IsNull(rsQuery("cp116")) Then
            strAgentList = strAgentList & "-" & rsQuery("cp116")
         End If
      Else
         strAgentList = strAgentList & ","
      End If
   Next
   PUB_GetAgentList = Mid(strAgentList, 2)
End Function

'Add by Amy 2020/08/28 大陸身份證檢查
'大陸的身份證為18碼，舊的身份證是15碼
'15碼身份證號碼中,"出生年份"欄位是2碼,轉換時需要補入"19",表示20世紀；15碼身份證無最後一碼校驗碼(不考慮,因由15碼升至18碼自1999年10月1日至2000年換發完成)
'大陸身份證格式：6碼地址編碼(省2碼+市2碼+縣2碼)+西元年8碼生日+3碼順序碼(第17碼奇數=男性，偶數=女性)+1碼校驗碼
Public Function CheckPRCID(ByVal stID As String) As Boolean
    Dim ii As Integer, intSum As Integer, intIdx As Integer
    Dim stVerifyCode '校驗碼

    CheckPRCID = False

    stVerifyCode = Array("1", "0", "X", "9", "8", "7", "6", "5", "4", "3", "2") '校驗碼

    '最後一碼可能不是數字,但其他要為數字
    If Not IsNumeric(Mid$(stID, 1, Len(stID) - 1)) Then CheckPRCID = False: Exit Function

    For ii = 0 To 16
        '權重係數= 2 ^ (17 - ii) Mod 11
        intSum = intSum + (2 ^ (17 - ii) Mod 11) * Mid(stID, ii + 1, 1)
    Next ii
    intIdx = intSum Mod 11

    If Right$(stID, 1) = stVerifyCode(intIdx) Then
        CheckPRCID = True
    End If
End Function

'Add by Sindy 2020/9/11
'intType=0 : 已收文點數
'intType=1 : 已收文未收款點數
'Modified by Lydia 2021/07/22 bolCntSales 以智權人員加總
'Modify by Amy 2022/06/29 +intChoose:0-全部/1-不包含ACS/2-只顯示ACS
'Modify by Amy 2023/11/16 +strFormN:表單/strField:欄位/bolSqlOnly:只傳語法
'Modify by Amy 2024/03/29 +intDecimalPlaces 回傳的小數位,預設2位
Public Function PUB_CountCP18(intType As Integer, strDateS As String, strDateE As String, _
   Optional strDeptS As String, Optional strDeptE As String, Optional strSales As String, _
   Optional ByRef strMsSql As String, Optional ByVal bolCntDay As Boolean, Optional ByVal bolCntSales As Boolean, Optional intChoose As Integer = 0, _
   Optional ByVal strFormN As String = "", Optional ByVal strField As String = "", Optional ByVal bolSqlOnly As Boolean = False, Optional ByVal intDecimalPlaces As Integer = 2) As Double
Dim strA1 As String, intA As Integer, rsAD As New ADODB.Recordset
Dim strConCP As String, strConCP_C1 As String, strConA0k As String, strConST As String
Dim strCol0 As String, strGroup0 As String, strCol1 As String, strGroup1 As String, strConA0k02 As String, strConCP05 As String
Dim strTB As String, strWhere As String 'Add by Amy 2021/02/19
Dim strTB2(1) As String, strWhere2(1) As String 'Add by Amy 2022/06/29
Dim strConA0k_TT As String, strGrp0K0 As String, strVTB(2) As String, strVTBWhr(2) As String, strVTBGrp(2) As String, strDTB(2) As String 'Add by Amy 2024/02/29
   
   PUB_CountCP18 = 0
   'Memo by Amy 2024/02/29 目前無時間測其他相關程式,故先試Run 業績達成日報表(SalesPoint有資料抓其部門,否則以ST15為主)
   'Add by Amy 2024/04/17 整理用到的表單
   '若舊程式不使用,將strCol1 = ",st15" 改至 Select Case UCase(strFormN)前,拿掉"FRM210107" 及"FRM210113" 及"FRM210137" 的strCol1 = ",st15"
   Select Case UCase(strFormN)
      Case "AUTOBATCHDAY-STRMENU64"
      Case "FRM210103" '每日點數輸入
      Case "FRM210104" '點數輸入作業及查詢
      Case "FRM210107" '業績達成日報表
         strCol1 = ",st15"
      Case "FRM210113" '各區業務工作報告統計
         strCol1 = ",st15"
      Case "FRM210137" '業績點數統計
         strCol1 = ",st15"
      Case "FRM210150" '智權部工作報告
   End Select
   If bolSqlOnly = True Then strMsSql = "" 'Add by Amy 2023/11/16 +只回傳語法
   
   'Modify by Amy 2023/11/16 從[已收文點數]搬上來,讓[已收文未收款點]數也使用
   'Modify by Amy 2022/08/02 要與「點數輸入作業及查詢」之「業績點數統計」按鈕的結果相同,不管人員何時調部門，一律以現在歸屬的部門(st15)計算-杜燕文協理
   strTB = ",Staff"
   
'****** 已收文點數 ******
If intType = 0 Then
   'Modify by Amy 2024/02/29 +業績達成日報表Run 新程式
   'Modify by Amy 2024/04/17 +各區業務工作報告統計
   'Modify by Amy 2024/04/19 +業績點數統計
   If UCase(strFormN) = "FRM210107" Or UCase(strFormN) = "FRM210113" Or UCase(strFormN) = "FRM210137" Then
      '不包含ACS
      If intChoose = 1 Then
         strConCP = strConCP & " and cp01<>'ACS' "
      '只顯示ACS
      ElseIf intChoose = 2 Then
        strConCP = strConCP & " and cp01='ACS' "
      End If
      '部門代號
      If strDeptS <> MsgText(601) Or strDeptE <> MsgText(601) Then
         If strDeptS <> MsgText(601) Then
            strConCP = strConCP & " And ST15||''>='" & strDeptS & "' "
         End If
         If strDeptE <> MsgText(601) Then
            strConCP = strConCP & " And ST15||''<='" & strDeptE & "' "
         End If
         strCol0 = "st15,"
         strGroup0 = " group by st15"
      End If
      '智權人員
      If strSales <> MsgText(601) Then
         If strSales >= "F4104" And strSales <= "F4107" Then
            strCol0 = ""
            strGroup0 = ""
            Select Case strSales
                Case "F4104" '專利國外部
                    strWhere = "<>'2' "
                Case "F4105" '專利日本部
                    strWhere = "='2' "
                Case "F4106" 'FCT英文組
                    strWhere = "<>'4' "
                Case "F4107" 'FCT日文組
                    strWhere = "='4' "
            End Select
            strWhere = " And Nvl(ST16,'0')" & strWhere & " "
         'P2005(MCT)
         ElseIf strSales = "P2005" Then
            strConCP = strConCP & " and SubStr(cp161,1,3)='MCT' "
         'P1005(MCP)
         ElseIf strSales = "P1005" Then
            strConCP = strConCP & " and cp13='79075' "
         Else
            strConCP = strConCP & " and cp13='" & strSales & "' "
            strCol0 = "st15,cp13,"
            strGroup0 = " group by st15,cp13"
         End If
      End If
      If bolCntDay = True Then
         strCol0 = "cp13,cp05-19110000 cp05,"
         strGroup0 = " group by cp13,cp05-19110000"
      End If
      '以智權人員加總
      If bolCntSales = True Then
        '以現在歸屬的部門(st15)計算-杜燕文協理
         strCol0 = "st15, cp13,"
         strGroup0 = " group by st15, cp13"
      End If
      '業績達成日報表,舊資料抓SP48部門 'Memo 收文智權不會是F410X/PXXXX
      'Modify by Amy 2024/04/17 +各區業務工作報告統計
      'Modify by Amy 2024/04/19 +業績點數統計
      If UCase(strFormN) = "FRM210107" Or UCase(strFormN) = "FRM210113" Or UCase(strFormN) = "FRM210137" Then
         'Modify by Amy 2024/04/22 +FRM210137(業績點數統計)
         If UCase(strFormN) = "FRM210113" Or UCase(strFormN) = "FRM210137" Then
            strCol0 = "cp13,"
            strGroup0 = " Group by cp13"
         End If
         If Left(strDeptS, 1) = "S" Or Left(strDeptS, 1) = "W" Then
            strTB = strTB & ",SalesPoint"
            strWhere = strWhere & " And cp13=SP02(+) And " & Left(DBDATE(strDateS), 6) & "=SP01(+) "
            If UCase(strFormN) = "FRM210107" Then
               strCol0 = "st15,"
               strGroup0 = " Group by ST15"
            End If
      'end 2024/04/17
            strCol1 = ",Decode(SP48,null,ST15,SP48) as st15"
            strConCP = Replace(UCase(strConCP), "ST15||", "Decode(SP48,null,ST15,SP48)||")
         End If
      End If
      
      '已收文點數(點數結算日當月1日至點數結算日),取消收文的也要算(銷案不銷帳)
      '1.CP16有null 值導致資料算不正確 ex:AB1011386(CFP-032707),原TO_CHAR(xxx,'99999D9')) CP18A,小數位與「業績點數統計」不一致,改一致-秀玲
      '2.st15 現在歸屬的部門(st15)計算-杜燕文協理
      'Modify by Amy 2024/03/29 原:99999.00改以小數3位算完再回傳intDecimalPlaces位數-秀玲 Ex:1130318 日報表(FRM210107) MCT 累計收文金額 449.19 與sum(cp18) 446.8 差2.39,因小數位計算不同
      strA1 = "select " & strCol0 & "Round(sum(cp18a)," & intDecimalPlaces & ") 收文點數 from" & _
              "(SELECT CP01,CP02,CP03,CP04,CP05,CP09,CP10,cp12,cp13,cp158,cp159,CP16,CP17,CP18,A1U07,A1U09,(Nvl(CP16,0)-NVL(A1U07,0)-NVL(A1U09,0)) CP16A," & _
              "TO_CHAR(((Nvl(CP16,0)-NVL(A1U07,0)-NVL(A1U09,0))-(NVL(CP17,0)-NVL(A1U09,0)))/1000,'99999.000') CP18A" & strCol1 & " FROM CASEPROGRESS,"
      '每一收文號之銷退資料 (要與「點數輸入作業及查詢」之「業績點數統計」按鈕的結果相同-秀玲)
      strA1 = strA1 & _
                 "(select a1u03,sum(a1u07) a1u07,sum(a1u09) a1u09 from acc1u0 where nvl(a1u07,0)+nvl(a1u09,0)>0 and a1u03 in" & _
                    "(SELECT CP09 FROM CASEPROGRESS" & strTB & " WHERE cp05>=" & DBDATE(strDateS) & " and cp05<=" & DBDATE(strDateE) & strWhere & strConCP & " And CP13=ST01(+) and ((cp159>0 and cp60 is not null) or cp159=0) ) " & _
                    "group by a1u03" & _
                 ")" & strTB & " WHERE cp05>=" & DBDATE(strDateS) & " and cp05<=" & DBDATE(strDateE) & strConCP & " and ((cp159>0 and cp60 is not null) or cp159=0)  " & _
              "and cp09=a1u03(+) And CP13=ST01(+) " & strWhere & _
              ") where cp18A<>0 "
      strA1 = strA1 & strGroup0
   
   Else
   '** 舊程式 **
      'Add by Amy 2022/06/29
      '不包含ACS
      If intChoose = 1 Then
         strConCP = strConCP & " and cp01<>'ACS' "
      '只顯示ACS
      ElseIf intChoose = 2 Then
        strConCP = strConCP & " and cp01='ACS' "
      End If
      'end 2022/06/29
      '部門代號
      'Modify by Amy 2022/08/02 要與「點數輸入作業及查詢」之「業績點數統計」按鈕的結果相同,不管人員何時調部門，一律以現在歸屬的部門(st15)計算-杜燕文協理
      strTB = ",Staff"
      If strDeptS <> MsgText(601) Or strDeptE <> MsgText(601) Then
         If strDeptS <> MsgText(601) Then
            'strConCP = strConCP & " and cp12>='" & strDeptS & "' "
            strConCP = strConCP & " And ST15||''>='" & strDeptS & "' "
         End If
         If strDeptE <> MsgText(601) Then
            'strConCP = strConCP & " and cp12<='" & strDeptE & "' "
            strConCP = strConCP & " And ST15||''<='" & strDeptE & "' "
         End If
'         strCol0 = "cp12,"
'         strGroup0 = " group by cp12"
         strCol0 = "st15,"
         strGroup0 = " group by st15"
      End If
      '智權人員
      If strSales <> MsgText(601) Then
         'Add by Amy 2021/02/19 +if
         If strSales >= "F4104" And strSales <= "F4107" Then
            strCol0 = ""
            strGroup0 = ""
            'strTB = ",Staff" '2022/08/02 往上搬
            Select Case strSales
                Case "F4104" '專利國外部
                    strWhere = "<>'2' "
                Case "F4105" '專利日本部
                    strWhere = "='2' "
                Case "F4106" 'FCT英文組
                    strWhere = "<>'4' "
                Case "F4107" 'FCT日文組
                    strWhere = "='4' "
            End Select
            'strWhere = " And CP13=ST01(+) And Nvl(ST16,'0')" & strWhere & " "
            strWhere = " And Nvl(ST16,'0')" & strWhere & " "
         'Add by Amy 2021/03/12 +P2005(MCT)
         ElseIf strSales = "P2005" Then
            strConCP = strConCP & " and SubStr(cp161,1,3)='MCT' "
         'Add by Amy 2023/06/01 +P1005(MCP)
         ElseIf strSales = "P1005" Then
            strConCP = strConCP & " and cp13='79075' "
         Else
            strConCP = strConCP & " and cp13='" & strSales & "' "
'            strCol0 = "cp12,cp13,"
'            strGroup0 = " group by cp12,cp13"
            strCol0 = "st15,cp13,"
            strGroup0 = " group by st15,cp13"
         End If
      End If
      'end 2022/08/02
      If bolCntDay = True Then
         strCol0 = "cp13,cp05-19110000 cp05,"
         strGroup0 = " group by cp13,cp05-19110000"
      End If
      'Added by Lydia 2021/07/22 以智權人員加總
      If bolCntSales = True Then
        'Modify by Amy 2022/08/02 現在歸屬的部門(st15)計算-杜燕文協理
'         strCol0 = "cp12, cp13,"
'         strGroup0 = " group by cp12, cp13"
         strCol0 = "st15, cp13,"
         strGroup0 = " group by st15, cp13"
      End If
      'end 2021/07/22
      
      '已收文點數(點數結算日當月1日至點數結算日),取消收文的也要算(銷案不銷帳)
      'Modify by Amy 2022/08/02 1.CP16有null 值導致資料算不正確 ex:AB1011386(CFP-032707),原TO_CHAR(xxx,'99999D9')) CP18A,小數位與「業績點數統計」不一致,改一致-秀玲
      '                                             2.st15 現在歸屬的部門(st15)計算-杜燕文協理
      'Modify by Amy 2024/03/29 原:99999.00改以小數3位算完再回傳intDecimalPlaces位數-秀玲 Ex:1130318 日報表(FRM210107) MCT 累計收文金額 449.19 與sum(cp18) 446.8 差2.39,因小數位計算不同
      strA1 = "select " & strCol0 & "Round(sum(cp18a)," & intDecimalPlaces & ") 收文點數 from" & _
              "(SELECT CP01,CP02,CP03,CP04,CP05,CP09,CP10,cp12,cp13,cp158,cp159,CP16,CP17,CP18,A1U07,A1U09,(Nvl(CP16,0)-NVL(A1U07,0)-NVL(A1U09,0)) CP16A," & _
              "TO_CHAR(((Nvl(CP16,0)-NVL(A1U07,0)-NVL(A1U09,0))-(NVL(CP17,0)-NVL(A1U09,0)))/1000,'99999.000') CP18A,ST15 FROM CASEPROGRESS,"
                 '每一收文號之銷退資料
      'Modify By Sindy 2021/2/19 CP60 IS NULL的資料若已取消收文則不列入
      '+ and ((cp159>0 and cp60 is not null) or cp159=0)
      'Modify by Amy 2021/02/19 子查詢也加strTB及strWhere
      'Modify by Amy 2022/08/02 原:and (cp158>19221111 or cp158=0),要與「點數輸入作業及查詢」之「業績點數統計」按鈕的結果相同-秀玲
      strA1 = strA1 & _
                 "(select a1u03,sum(a1u07) a1u07,sum(a1u09) a1u09 from acc1u0 where nvl(a1u07,0)+nvl(a1u09,0)>0 and a1u03 in" & _
                    "(SELECT CP09 FROM CASEPROGRESS" & strTB & " WHERE cp05>=" & DBDATE(strDateS) & " and cp05<=" & DBDATE(strDateE) & strWhere & strConCP & " And CP13=ST01(+) and ((cp159>0 and cp60 is not null) or cp159=0) ) " & _
                    "group by a1u03" & _
                 ")" & strTB & " WHERE cp05>=" & DBDATE(strDateS) & " and cp05<=" & DBDATE(strDateE) & strConCP & " and ((cp159>0 and cp60 is not null) or cp159=0)  " & _
              "and cp09=a1u03(+) And CP13=ST01(+) " & strWhere & _
              ") where cp18A<>0 "
      strA1 = strA1 & strGroup0
   '** End 舊程式 **
   End If
   'end 2024/02/29
      strMsSql = strA1
      If bolSqlOnly = True Then Exit Function 'Add by Amy 2024/02/29
      intA = 1
      Set rsAD = ClsLawReadRstMsg(intA, strA1)
      If intA = 1 Then
         PUB_CountCP18 = CDbl(Val("" & rsAD.Fields("收文點數")))
      End If
'****** End 已收文點數 (intType=0) ******
Else
'****** 已收文未收款 (intType=1) ******
   'Memo by Amy 2024/02/29 目前無時間測其他相關程式,故先試Run 業績達成日報表(SalesPoint有資料抓其部門,否則以ST15為主)
   If UCase(strFormN) = "FRM210107" Then strCol1 = "" '若舊程式不使用,將此句 If UCase(strFormN) = "FRM210107" Then 保留 strCol1 = ""
   
   If UCase(strFormN) = "FRM210107" Then
      '不包含ACS
      If intChoose = 1 Then
         strWhere = " And Exists(Select a0j13 From acc0j0 Where a0j13=a0k01 And Substr(a0j02,1,3)<>'ACS') "
         strTB2(0) = ",CaseProgress"
         strTB2(1) = ",CaseProgress c2"
         strWhere2(0) = " And a1u03=cp09 And cp01<>'ACS' " '原: And a1u03=cp09(+),抓S10-S99資會抓很久
         strWhere2(1) = " And los06=c2.cp09(+) And c2.cp01<> 'ACS' "
         strConCP_C1 = strConCP_C1 & " And c2.cp01<> 'ACS' "
      '只顯示ACS
      ElseIf intChoose = 2 Then
         strWhere = " And Exists(Select a0j13 From acc0j0 Where a0j13=a0k01 And Substr(a0j02,1,3)='ACS') "
         strTB2(0) = ",CaseProgress"
         strTB2(1) = ",CaseProgress c2"
         strWhere2(0) = " And a1u03=cp09 And cp01='ACS' " '原: And a1u03=cp09(+),抓S10-S99資會抓很久
         strWhere2(1) = " And los06=c2.cp09(+) And c2.cp01='ACS' "
         strConCP_C1 = strConCP_C1 & " And c2.cp01= 'ACS' "
      End If
      '日期區間
      If Val(strDateS) > 0 Then
         strConA0k02 = " and a0k02>=" & strDateS
         strConCP05 = " and c1.cp05>=" & DBDATE(strDateS)
      End If
      If Val(strDateE) > 0 Then
         strConA0k02 = strConA0k02 & " and a0k02<=" & strDateE
         strConCP05 = strConCP05 & " and c1.cp05<=" & DBDATE(strDateE)
      End If
      '部門代號
      '人員會調部門,故不判斷收據部門(a0k22) ex:77043 郭少鈞 條件下S21會抓不到S23部門的資料
      If strDeptS <> "" Or strDeptE <> "" Then
         If strDeptS <> "" Then
               strConCP_C1 = strConCP_C1 & " and c1.cp12>='" & strDeptS & "'"
               strConST = strConST & " and st15>='" & strDeptS & "'"
         End If
         If strDeptE <> "" Then
            strConCP_C1 = strConCP_C1 & " and c1.cp12<='" & strDeptE & "'"
            strConST = strConST & " and st15<='" & strDeptE & "'"
         End If
         strCol1 = "st15,"
         strGroup1 = " group by st15"
      End If
      '智權人員
      If strSales <> "" Then
         strConCP_C1 = strConCP_C1 & " and c1.cp13='" & strSales & "'"
         strConA0k = strConA0k & " and a0k20='" & strSales & "'"
         strConST = strConST & " and st01='" & strSales & "'"
         strCol1 = "st15,A0K20,"
         strGroup1 = " group by st15,A0K20"
      End If
      If bolCntDay = True Then
         strCol1 = "A0K20,a0k02,"
         strGroup1 = " group by A0K20,a0k02"
      End If
      '以智權人員加總
      If bolCntSales = True Then
         strCol1 = "st15, a0k20,"
         strGroup1 = " group by st15,a0k20"
      End If
      
      '避免正常收據和案源條件修改時有不一致,故整理相同語法
      Select Case UCase(strFormN)
         Case "FRM210107" '業績達成日報表,舊資料[無法]抓SP48部門,因此支不會傳入日期,無法知道當下屬於哪個部門
            If Left(strDeptS, 1) = "S" Or Left(strDeptS, 1) = "W" Then
               strCol1 = "ST15,"
               strGroup1 = " Group by ST15 "
            End If
            '抓業績達成日報表會很慢,調整語法,因為共函數怕影響其他支先針對這支調整
            strVTBWhr(1) = " And st01(+)=axd01 And axd01(+)=a4401 And axd02(+)=a4402 And axd03(+)=a4403 "
         Case Else
            strVTBWhr(1) = " And st01=axd01(+) And axd01=a4401(+) And axd02=a4402(+) And axd03=a4403(+) "
      End Select
      '每一收文號之銷退資料
      '原抓a0k22部門,因人員會調部門,故不判斷收據部門,抓目前部門 ex:畫面條件下 77043 於S23的期間時,仍歸於目前(11211月)的部門S21-秀玲
      strDTB(0) = "Select a0k01 From acc0k0 " & strTB & _
                            " Where Nvl(a0k09,0) = 0  And (Nvl(a0k06,0)+Nvl(a0k07,0)) > (Nvl(a0k17,0)+Nvl(a0k18,0)) And a0k20=st01(+) " & strConA0k02 & strConA0k & _
                            strConST
                            
      strVTB(0) = "Select a1u02,Sum(a1u04) a1u04,Sum(a1u05) a1u05,Sum(a1u07) a1u07,Sum(a1u08) a1u08,Sum(a1u09) a1u09,Sum(a1u10) a1u10 " & _
                           " From Acc1u0"
      strVTBWhr(0) = " And Nvl(a1u04, 0) + Nvl(a1u05, 0) + Nvl(a1u07, 0) + Nvl(a1u08, 0) + Nvl(a1u09, 0) + Nvl(a1u10, 0) > 0"
      strVTBGrp(0) = " Group by a1u02"
      '已繳款但財務未收款
      strVTB(1) = "Select axd04,Sum(axd06) axd06 From acc441,acc440" & strTB
      strVTBWhr(1) = " And axd01 is not null And a4416 is null " & strVTBWhr(1) & strConST
      strVTBGrp(1) = " Group by axd04"
      '案源TT-999999
      strVTBWhr(2) = " And c1.cp01='TT' And c1.cp02='999999'  And c1.cp09=los10(+) "
      strVTB(2) = "Select distinct c1.cp13 cp13,a0j13 From caseprogress c1,lawofficesource,caseprogress c2,acc0j0 " & _
                           " Where los06=c2.cp09(+) And Nvl(c2.cp79,0)>0 And c2.cp09=a0j01(+) " & strVTBWhr(2) & strConCP_C1
      '收據條件
      strConA0k = strConA0k & "And Nvl(a0k09,0) = 0 And (Nvl(a0k06,0)+Nvl(a0k07,0)) > (Nvl(a0k17,0)+Nvl(a0k18,0)) " & _
                                                        "And a0k01=a1u02(+) And a0k01=axd04(+) "
      strConA0k_TT = strConA0k_TT & "And Nvl(a0k09,0) = 0 And (Nvl(a0k06,0)+Nvl(a0k07,0)) > (Nvl(a0k17,0)+Nvl(a0k18,0)) " & _
                                                        "And a0k01=a1u02(+) And a0k01=axd04(+) "
      strGrp0K0 = " Group by a0k01,a0k32,a0k02,a0k03,XXX,a0k22,Nvl(a0k06,0),Nvl(a0k07,0),axd06"
                           
      '已收文未收款(自古早至strDateE,frm210107-業績達成日報表,不會傳入日期,因不管收據日期只要是[未收款]都列入計算)
      strA1 = "(Select A0K20,Sum(a0k06-paypnt-Nvl(axd06,0)) RECPNT From" & _
                  "(Select a0k01,a0k32,a0k02,a0k03,a0k20,a0k22,Nvl(a0k06,0) as a0k06,Nvl(a0k07,0) as a0k07," & _
      " Sum(Nvl(a1u04,0))+Sum(Nvl(a1u07,0))-Sum(Nvl(a1u08,0))+Sum(Nvl(a1u05,0))+Sum(Nvl(a1u09,0))-Sum(Nvl(a1u10,0)) pay," & _
      " Sum(Nvl(a1u04,0))+Sum(Nvl(a1u07,0))-Sum(Nvl(a1u08,0)) paypnt,axd06 " & _
                  "From Acc0k0"
      '每一收文號之銷退資料
      strA1 = strA1 & ",(" & strVTB(0) & strTB2(0) & " Where 1=1 " & strVTBWhr(0) & strWhere2(0) & " And a1u02 in ( " & strDTB(0) & " ) " & strVTBGrp(0) & ")"
      '已繳款但財務未收款
      strA1 = strA1 & ",(" & strVTB(1) & strTB2(0) & " Where 1=1 " & strVTBWhr(1) & Replace(strWhere2(0), "a1u03=", "axd05=") & strVTBGrp(1) & ") "
      '正常收據,但不含案源分潤收據(A0K03<>'X82357000')
      strA1 = strA1 & "Where A0K03<>'X82357000' " & strConA0k02 & strConA0k & strWhere & Replace(strGrp0K0, "XXX", "a0k20") & _
                  " ) Where Nvl(a0k06,0) > paypnt+Nvl(axd06,0) Group by a0k20 )"
      '案源收據
      strA1 = strA1 & " Union " & _
                  "(Select cp13 a0k20,Sum(a0k06-paypnt-Nvl(axd06,0)) RECPNT From" & _
                  "(Select a0k01,a0k32,a0k02,a0k03,cp13,a0k22,Nvl(a0k06,0) as a0k06,Nvl(a0k07,0) as a0k07," & _
      " Sum(Nvl(a1u04,0))+Sum(Nvl(a1u07,0))-Sum(Nvl(a1u08,0))+Sum(Nvl(a1u05,0))+Sum(Nvl(a1u09,0))-Sum(Nvl(a1u10,0)) pay," & _
      " Sum(Nvl(a1u04,0))+Sum(Nvl(a1u07,0))-Sum(Nvl(a1u08,0)) paypnt,axd06 " & _
                  "From Acc0k0,(" & strVTB(0) & ",caseprogress c1,lawofficesource" & strTB2(1) & " Where 1=1 " & strVTBWhr(0) & strVTBWhr(2) & strWhere2(1) & " And los06=a1u03(+) " & strVTBGrp(0) & ")" & _
                                           ",(" & strVTB(1) & strTB2(1) & " Where 1=1 " & strVTBWhr(1) & Replace(strWhere2(1), "los06=", "axd05=") & strVTBGrp(1) & ") " & _
                                           ",(" & strVTB(2) & ") j " & _
                  "Where  j.a0j13=a0k01(+) " & strConA0k02 & strConA0k_TT & Replace(strGrp0K0, "XXX", "cp13") & _
       "  ) Where Nvl(a0k06,0) > paypnt+Nvl(axd06,0) Group by cp13 ) "
      'strConA0k,案源不串a0k22-->未收款要有此條件
      'Memo 原抓a0k22部門,使用 And st01(+)=a0k20,改不串a0k22後使用 And st01(+)=a0k20抓資料會很慢,故改為And st01=a0k20(+)
      'Modify by Amy 2024/03/29 最後原有判斷 st04='1',導致 下1130328 魏天立經理(75007)的未收款未加入,清查所有使用此函數程式後,秀玲說把只抓在職拿掉
      strA1 = "Select " & strCol1 & "Sum(RECPNT) 未收款 From (" & strA1 & ")" & strTB & " Where st01=a0k20(+) " & strConST & " " & strGroup1
  
   Else
   '** 舊程式 **
      'Add by Amy 2022/06/29
      '不包含ACS
      If intChoose = 1 Then
         strWhere = " And Exists(Select a0j13 From acc0j0 Where a0j13=a0k01 And Substr(a0j02,1,3)<>'ACS') "
         strTB2(0) = ",CaseProgress"
         strTB2(1) = ",CaseProgress c2"
         strWhere2(0) = " And a1u03=cp09(+) And cp01<>'ACS' "
         strWhere2(1) = " And los06=c2.cp09(+) And c2.cp01<> 'ACS' "
         strConCP_C1 = strConCP_C1 & " And c2.cp01<> 'ACS' "
      '只顯示ACS
      ElseIf intChoose = 2 Then
         strWhere = " And Exists(Select a0j13 From acc0j0 Where a0j13=a0k01 And Substr(a0j02,1,3)='ACS') "
         strTB2(0) = ",CaseProgress"
         strTB2(1) = ",CaseProgress c2"
         strWhere2(0) = " And a1u03=cp09(+) And cp01='ACS' "
         strWhere2(1) = " And los06=c2.cp09(+) And c2.cp01='ACS' "
         strConCP_C1 = strConCP_C1 & " And c2.cp01= 'ACS' "
      End If
      'end 2022/06/29
      '日期區間
      If Val(strDateS) > 0 Then
         strConA0k02 = " and a0k02>=" & strDateS
         strConCP05 = " and c1.cp05>=" & DBDATE(strDateS)
      End If
      If Val(strDateE) > 0 Then
         strConA0k02 = strConA0k02 & " and a0k02<=" & strDateE
         strConCP05 = strConCP05 & " and c1.cp05<=" & DBDATE(strDateE)
      End If
      '部門代號
      If strDeptS <> "" Or strDeptE <> "" Then
         If strDeptS <> "" Then
            strConCP_C1 = strConCP_C1 & " and c1.cp12>='" & strDeptS & "'"
            strConA0k = strConA0k & " and a0k22>='" & strDeptS & "'"
            strConST = strConST & " and st15>='" & strDeptS & "'"
         End If
         If strDeptE <> "" Then
            strConCP_C1 = strConCP_C1 & " and c1.cp12<='" & strDeptE & "'"
           strConA0k = strConA0k & " and a0k22<='" & strDeptE & "'"
            strConST = strConST & " and st15<='" & strDeptE & "'"
         End If
         strCol1 = "st15,"
         strGroup1 = " group by st15"
      End If
      '智權人員
      If strSales <> "" Then
         strConCP_C1 = strConCP_C1 & " and c1.cp13='" & strSales & "'"
         strConA0k = strConA0k & " and a0k20='" & strSales & "'"
         strConST = strConST & " and st01='" & strSales & "'"
         strCol1 = "st15,A0K20,"
         strGroup1 = " group by st15,A0K20"
      End If
      If bolCntDay = True Then
         strCol1 = "A0K20,a0k02,"
         strGroup1 = " group by A0K20,a0k02"
      End If
      'Added by Lydia 2021/07/22 以智權人員加總
      If bolCntSales = True Then
         strCol1 = "st15, a0k20,"
         strGroup1 = " group by st15,a0k20"
      End If
      'end 2021/07/22
      
      '已收文未收款(自古早至點數結算日)
      'Modify by Amy 2024/03/29 最後原有判斷 st04='1',導致 下1130328 魏天立經理(75007)的未收款未加入,清查所有使用此函數程式後,秀玲說把只抓在職拿掉
      strA1 = "select " & strCol1 & "sum(RECPNT) 未收款 from staff,("
      '正常收據,但不含案源分潤收據(A0K03<>'X82357000')
      'Modify by Amy 2022/06/29 +過濾ACS及非ACS
      strA1 = strA1 & _
      "(SELECT A0K20,sum(a0k06-paypnt-nvl(axd06,0)) RECPNT FROM" & _
      " (select a0k01,a0k32,a0k02,a0k03,a0k20,a0k22,nvl(a0k06,0) as a0k06,nvl(a0k07,0) as a0k07," & _
      " sum(nvl(a1u04,0))+sum(nvl(a1u07,0))-sum(nvl(a1u08,0))+sum(nvl(a1u05,0))+sum(nvl(a1u09,0))-sum(nvl(a1u10,0)) pay," & _
      " sum(nvl(a1u04,0))+sum(nvl(a1u07,0))-sum(nvl(a1u08,0)) paypnt,axd06 from acc0k0,"
         '每一收文號之銷退資料
         strA1 = strA1 & _
         " (select a1u02,sum(a1u04) a1u04,sum(a1u05) a1u05,sum(a1u07) a1u07,sum(a1u08) a1u08,sum(a1u09) a1u09,sum(a1u10) a1u10 from acc1u0" & strTB2(0) & _
         " Where nvl(a1u04, 0) + nvl(a1u05, 0) + nvl(a1u07, 0) + nvl(a1u08, 0) + nvl(a1u09, 0) + nvl(a1u10, 0) > 0" & strWhere2(0) & _
         " and a1u02 in (select a0k01 from acc0k0 where 1=1" & strConA0k02 & strConA0k & " and nvl(a0k09,0) = 0 and (nvl(a0k06,0)+nvl(a0k07,0)) > (nvl(a0k17,0)+nvl(a0k18,0))) group by a1u02),"
         '已繳款但財務未收款
         strA1 = strA1 & _
         " (select axd04,sum(axd06) axd06 from staff,acc441,acc440" & strTB2(0) & " where st01=axd01(+)" & strConST & " and axd01 is not null and axd01=a4401(+) and axd02=a4402(+)" & _
         " and axd03=a4403(+) and a4416 is null " & Replace(strWhere2(0), "a1u03=", "axd05=") & " group by axd04)" & _
      " where 1=1" & strConA0k02 & strConA0k & " AND A0K03<>'X82357000' and nvl(a0k09,0) = 0 and (nvl(a0k06,0)+nvl(a0k07,0)) > (nvl(a0k17,0)+nvl(a0k18,0))" & _
      " and a0k01=a1u02(+) and a0k01=axd04(+)" & strWhere & _
      " group by a0k01,a0k32,a0k02,a0k03,a0k20,a0k22,nvl(a0k06,0),nvl(a0k07,0),axd06)" & _
      " where nvl(a0k06,0) > paypnt+nvl(axd06,0) group by a0k20)"
      strA1 = strA1 & " Union "
      '案源收據
      'Modified by Lydia 2021/08/25 因為法務收文較晚，收據也會比較晚開，所以拿掉TT案的收文日條件；ex.E11018772收據日期在8/13(30點)，但是TT收文號AB0033103的收文日在8/9，所以每日累計frm210104抓不到案源的金額
               'c1.cp01='TT' and c1.cp02='999999'" & strConCP05 & " => c1.cp01='TT' and c1.cp02='999999'
      strA1 = strA1 & _
      "(SELECT cp13 a0k20,sum(a0k06-paypnt-nvl(axd06,0)) RECPNT FROM" & _
      " (select a0k01,a0k32,a0k02,a0k03,cp13,a0k22,nvl(a0k06,0) as a0k06,nvl(a0k07,0) as a0k07," & _
      " sum(nvl(a1u04,0))+sum(nvl(a1u07,0))-sum(nvl(a1u08,0))+sum(nvl(a1u05,0))+sum(nvl(a1u09,0))-sum(nvl(a1u10,0)) pay," & _
      " sum(nvl(a1u04,0))+sum(nvl(a1u07,0))-sum(nvl(a1u08,0)) paypnt,axd06 from acc0k0," & _
        "(select distinct c1.cp13 cp13,a0j13 from caseprogress c1,lawofficesource,caseprogress c2,acc0j0" & _
        " where c1.cp01='TT' and c1.cp02='999999' and c1.cp09=los10(+) and los06=c2.cp09(+) and nvl(c2.cp79,0)>0" & _
        " and c2.cp09=a0j01(+)" & strConCP_C1 & _
        " ) j,"
         '每一收文號之銷退資料
         strA1 = strA1 & _
         " (select a1u02,sum(a1u04) a1u04,sum(a1u05) a1u05,sum(a1u07) a1u07,sum(a1u08) a1u08,sum(a1u09) a1u09,sum(a1u10) a1u10" & _
         " from acc1u0,caseprogress c1,lawofficesource" & strTB2(1) & _
         " where c1.cp01='TT' and c1.cp02='999999'  and c1.cp09=los10(+) and los06=a1u03(+)" & strWhere2(1) & _
         " and nvl(a1u04,0)+nvl(a1u05,0)+nvl(a1u07,0)+nvl(a1u08,0)+nvl(a1u09,0)+nvl(a1u10,0)>0" & _
        " group by a1u02),"
         '已繳款但財務未收款
         strA1 = strA1 & _
         "(select axd04,sum(axd06) axd06 from staff,acc441,acc440" & strTB2(1) & _
         " where st01=axd01(+)" & strConST & " and axd01 is not null and axd01=a4401(+) and axd02=a4402(+)" & Replace(strWhere2(1), "los06=", "axd05=") & _
         " and axd03=a4403(+) and a4416 is null group by axd04)" & _
      " where j.a0j13=a0k01(+)" & strConA0k02 & " and nvl(a0k09,0) = 0 and (nvl(a0k06,0)+nvl(a0k07,0)) > (nvl(a0k17,0)+nvl(a0k18,0))" & _
      " and a0k01=a1u02(+) and a0k01=axd04(+)" & _
      " group by a0k01,a0k32,a0k02,a0k03,cp13,a0k22,nvl(a0k06,0),nvl(a0k07,0),axd06)" & _
      " where nvl(a0k06,0) > paypnt+nvl(axd06,0) group by cp13)" & _
      ") where st01(+)=a0k20 " & strConST & " " & strGroup1
      'end 2022/06/29
   '** End 舊程式 **
   End If
   'end 2024/02/29
      intA = 1
      strMsSql = strA1 'Added by Lydia 2021/07/22 回傳語法
      If bolSqlOnly = True Then Exit Function 'Add by Amy 2024/02/29
      Set rsAD = ClsLawReadRstMsg(intA, strA1)
      If intA = 1 Then
         '已收文未收款點數
         'Modify by Amy 2024/02/29 加新程式避免有null值,故加 if
         If Not IsNull(rsAD.Fields("未收款")) Then
            PUB_CountCP18 = CDbl("" & rsAD.Fields("未收款") / 1000)
         End If
      End If
End If
   
Set rsAD = Nothing
End Function

'Add by Amy 2020/10/15 +是否有往來記錄資料
Public Function PUB_ChkContactRecord(ByVal stKey As String) As Boolean
    Dim RsQ As New ADODB.Recordset, strQ As String, intQ As Integer
    Dim Key1 As String, strWhere As String 'Add by Amy 2023/08/31 '與frm100101_15一致
    
    PUB_ChkContactRecord = False
    
   'Add by Amy 2023/08/31 聯絡人也會有資料
   If Mid(stKey, 10, 1) = "-" Then
      strKey1 = Mid(stKey, 11)
      strWhere = " And Instr(cr04,'" & strKey1 & "')>0"
   End If
    
    stKey = Replace(stKey, "平台", "") 'Add By Sindy 2021/3/25 ex:stKey=平台0002
    'Modify by Amy 2023/08/31 編號取8個字並加strWhere
    strQ = "Select CR01 From ContactRecord Where SUBSTR(cr03,1,8)='" & Left(stKey, 8) & "' " & strWhere & _
    "Union Select COR01 From ContactRecord1 Where SUBSTR(cor03,1,8)='" & Left(stKey, 8) & "' " & Replace(strWhere, "cr04", "cor04")
        
    intQ = 1
    Set RsQ = ClsLawReadRstMsg(intQ, strQ)
    If intQ = 1 Then
        PUB_ChkContactRecord = True
    End If
    Set RsQ = Nothing
End Function

'Added by Morgan 2020/11/12
'以電子公文發文號抓智慧局發文日
Public Function PUB_GetEDocDate(pDocNo As String) As String
   Dim rsQuery As ADODB.Recordset
   Dim stSQL As String, intQ As Integer
   
   stSQL = "Select ed08 From edocument Where ed01='" & pDocNo & "'"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
       PUB_GetEDocDate = "" & rsQuery(0)
   End If
   Set rsQuery = Nothing
End Function

'Add by Amy 2020/11/16 判斷CFT/CFP 延展或延展(英國)是否同時皆未解除期限
Public Function ChkNPScalable(ByVal stNationNo As String, ByVal stNP02 As String, stNP03 As String, stNP04 As String, stnp05 As String, stNP07 As String, Optional ByRef stMsg As String) As Boolean
    Dim RsQ As New ADODB.Recordset
    Dim stQ As String, intQ As Integer
    
    ChkNPScalable = False
    If stNP02 <> "CFT" And stNP02 <> "CFP" Then Exit Function
    If stNationNo <> "239" Then Exit Function
    
    If stNP02 = "CFT" Then
        If stNP07 = "102" Then
            stQ = "110"
        Else
            stQ = "102"
        End If
    'CFP
    Else
        If stNP07 = "607" Then
            stQ = "613"
        Else
            stQ = "607"
        End If
    End If
    stQ = " And NP07='" & stQ & "' "
    
    stQ = "Select NP06,Nvl(Decode('" & stNationNo & "','000',CPM03,CPM04),np07) CP10N From NextProgress,CasePropertyMap " & _
            "Where np02='" & stNP02 & "' And np03='" & stNP03 & "' And np04='" & stNP04 & "' And np05='" & stnp05 & "' " & stQ & _
            " And np06 is null And np02=cpm01(+) And np07=cpm02(+)"
    intQ = 1
    Set RsQ = ClsLawReadRstMsg(intQ, stQ)
    If intQ = 1 Then
        If IsNull(RsQ.Fields("NP06")) Then
            ChkNPScalable = True
            stMsg = "" & RsQ.Fields("CP10N")
        End If
    End If
    Set RsQ = Nothing
End Function
'Added by Morgan 2020/12/8
'依法限計算英國繳費年度 pYr:回傳下次繳費年度
Public Function PUB_GetUKYr(np09 As String, np02 As String, np03 As String, np04 As String, np05 As String, Optional ByRef pYr As String) As String
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   
   stSQL = "select pa10 from patent where pa01='" & np02 & "' and pa02='" & np03 & "' and pa03='" & np04 & "' and pa04='" & np05 & "' and pa09='239' and pa10>0"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      pYr = Left(np09, 4) - Left(rsQuery(0), 4)
      PUB_GetUKYr = "繳費次數：" & PUB_GetYF15("239", "3", "Y0000000", "607", CDbl(pYr))
   End If
End Function
'Added by Morgan 2020/12/8
'依法限更新脫歐英國案繳費紀錄
Public Sub PUB_UpdUkPayYr(np09 As String, np02 As String, np03 As String, np04 As String, np05 As String)
   Dim stSQL As String, intQ As Integer
   Dim rsQuery As ADODB.Recordset
   Dim stYr As String, stPA72 As String, stPA73 As String
   Dim arrYr() As String, arrDt() As String
   
   '有繳費年度且已繳下次年度時要更新
   stSQL = "select pa10,pa72,pa73 from patent where pa01='" & np02 & "' and pa02='" & np03 & "' and pa03='" & np04 & "' and pa04='" & np05 & "' and pa09='201' and pa10>0 and pa72 is not null"
   intQ = 1
   Set rsQuery = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      arrYr = Split(rsQuery("pa72"), ",")
      arrDt = Split(rsQuery("pa73"), ",")
      intQ = UBound(arrYr)
      stYr = Left(np09, 4) - Left(rsQuery(0), 4)
      If Val(arrYr(intQ)) >= Val(stYr) Then
         stPA72 = "": stPA73 = ""
         For intQ = LBound(arrYr) To UBound(arrYr)
            If Val(arrYr(intQ)) >= Val(stYr) Then Exit For
            
            If stPA72 <> "" Then stPA72 = stPA72 & ","
            stPA72 = stPA72 & arrYr(intQ)
            If stPA73 <> "" Then stPA73 = stPA73 & ","
            stPA73 = stPA73 & arrDt(intQ)
         Next
         stSQL = "update patent set pa72='" & stPA72 & "',pa73='" & stPA73 & "' where pa01='" & np02 & "' and pa02='" & np03 & "' and pa03='" & np04 & "' and pa04='" & np05 & "'"
         cnnConnection.Execute stSQL, intQ
      End If
   End If
End Sub

'Add by Amy 2020/12/14 從frm140113搬過來
'intChoose:1-FormSet(抓預設資料)/2-取得SC03(顯示之部門名稱)/3-副本收受者為部門之取代為通知主管
Public Function GetSeminarContactSql(ByVal intChoose As Integer, ByVal stDeptNo As String, ByVal IsOpen As Boolean, Optional ByVal stWhere As String = "", Optional ByVal stUserNo As String = "") As String
    Dim strQ As String
    
    GetSeminarContactSql = ""
    If stUserNo = MsgText(601) Then stUserNo = strUserNum
    If intChoose <= 2 Then
        strQ = "And SC01='" & Left(stDeptNo, 2) & "' "
        'Modify by Amy 2020/12/22 +智權部只抓1碼
        If Left(stDeptNo, 1) = "S" Then
            strQ = "And SC01='" & Left(stDeptNo, 1) & "' "
        '非公開(外專(F2字頭) 公開/非公開都抓非公開部門名稱)
        ElseIf ((intChoose = 1 And IsOpen = False) Or intChoose = 2) And Left(stDeptNo, 2) = "F2" Then
            If Left(stDeptNo, 3) = "F21" Then
                'F21部門需抓組別
                strQ = "And SC01='" & stDeptNo & PUB_GetStaffST16(stUserNo) & "' "
            Else
                strQ = "And SC01='" & Left(stDeptNo, 3) & "' "
            End If
        End If
    End If
    GetSeminarContactSql = "Select * From SeminarContact " & _
                                           "Where SC02='" & IIf(IsOpen = True, "0", "1") & "' " & strQ & " " & stWhere
End Function

'Add by Amy 2020/01/08 從frm210152/frmacc43c0搬過來合併 確認點數輸入是否都已做主管確認
'strYM:欲確認之西元年月
'strFormN:表單名
'strCon:條件 'Add by Amy 2021/07/08
Public Function ChkPointAcceptSql(strYM As String, strFormN As String, Optional ByVal intChoose As Integer = 0, Optional ByVal strCon As String = "") As String
    Dim strField As String, strQ As String, strWhere As String
   
    ChkPointAcceptSql = ""
    If strFormN = MsgText(601) Then
        ChkPointAcceptSql = "表單名稱為空,請洽電腦中心！"
        Exit Function
    End If
    
    Select Case UCase(strFormN)
        Case "FRM210152"
            strField = "sp48"
            strQ = "SalesPoint"
        Case "FRMACC43C0"
            'Modify by Amy 2021/05/06 bug-會顯示很多資料
            strField = "a0902,st02,sp48"
            strQ = "SalesPoint,Acc090,staff"
            strWhere = " And sp48=a0901(+) and sp02=st01(+) "
        'Add by Amy 2021/02/09
        Case "FRMACC41J0"
            strField = "sp45"
            strQ = "SalesPoint"
    End Select
    
    'Modify by Amy 2021/02/09 +9 且將 "And sp45 is null " 加入1及2語法中
    Select Case intChoose
        Case 0 '全部需輸入之部門
            'Modify by Amy 2021/05/06 +Replace(...,"'P'","") +P2005部門
            'Modify by Amy 2022/01/04 開放後又關閉會將不需輸入的人員寫入,導致關閉時檢查主管未確認而無法「關閉」 ex:11012月 F11 A6034
            'strWhere = strWhere & " And (SubStr(sp48,1,1) In ('" & Replace(Replace(智權點數實績與結餘輸入部門, ",P", ""), ",", "','") & "') Or SP48='P20') And sp45 is null "
            strWhere = strWhere & " And (SubStr(sp48,1,1)='S' Or sp02 In('" & Replace(智權點數實績與結餘特殊員編, ";", "','") & "') ) And sp45 is null "
        Case 2 '中所
            strWhere = strWhere & " And SubStr(sp48,1,2)='S2' And sp48<>'S29' And sp45 is null "
        Case 9
             strWhere = strWhere & strCon 'Add by Amy 2021/07/08
    End Select
    'end 2021/02/09
    
    'Memo by Amy 2021/01/07 10051/20091...st06小於6也可能要確認,因瑞婷過帳後才發現有69005結餘轉撥給10051沒輸隱藏版
    'Modify by Amy 2021/02/09 "And sp45 is null" 往上搬
    ChkPointAcceptSql = "Select Distinct " & strField & " From " & strQ & " Where sp01=" & Val(strYM) & " " & strWhere
                                       
End Function

'Added by Morgan 2021/1/8
'開啟商標監控系統連結
Public Sub PUB_OpenTMMonitor(Optional pID As String, Optional pName As String, Optional pRole As String)
   Dim hLocalFile As Long
   Dim strWebAddr As String
   Dim strID As String, strName As String, strRole As String
   
   If pID = "" Then
      strID = strUserNum
      strName = strUserName
      If Pub_StrUserSt03 = "M51" Then
         strRole = "1"
      Else
         strRole = "2"
      End If
   Else
      strID = pID
      strName = pName
      strRole = pRole
   End If
   
   '系統管理員、一般使用者、案件協助者
   If strRole = "1" Then
      strRole = "系統管理員"
   ElseIf strRole = "2" Then
      strRole = "一般使用者"
   ElseIf strRole = "3" Then
      strRole = "案件協助者"
   End If
   
   'Modified by Morgan 2024/8/12 IP改抓系統特殊設定
   'strWebAddr = "http://192.168.1.11/LogIn?ID=" & strID & "&NAME=" & UTF8_URLEncoding(strName) & "&role=" & UTF8_URLEncoding(strRole)
   strWebAddr = "http://" & Pub_GetSpecMan("TMMoniterIP") & "/LogIn?ID=" & strID & "&NAME=" & UTF8_URLEncoding(strName) & "&role=" & UTF8_URLEncoding(strRole)
   'end 2024/8/12
   'Modified by Morgan 2021/4/15 改指定用Chrome開啟--經理
   'ShellExecute hLocalFile, "open", strWebAddr, vbNullString, vbNullString, 1
   PUB_OpenURL strWebAddr, 1
   'end 2021/4/15
End Sub
'Added by Morgan 2021/1/8 轉貼網頁程式碼
'URL UTF-8中文轉碼
Public Function UTF8_URLEncoding(szInput As String) As String
    Dim uch As String, szRet As String
    Dim wch As String
    Dim x As Integer
    Dim nAsc As Long
    If szInput = "" Then
        UTF8_URLEncoding = szInput
        Exit Function
    End If
    For x = 1 To Len(szInput)
        wch = Mid(szInput, x, 1)
        nAsc = AscW(wch)

        If nAsc < 0 Then nAsc = nAsc + 65536

        If (nAsc And &HFF80) = 0 Then
            szRet = szRet & URLEncode(wch)
        Else
            If (nAsc And &HF000) = 0 Then
                uch = "%" & Hex(((nAsc \ 2 ^ 6)) Or &HC0) & Hex(nAsc And &H3F Or &H80)
                szRet = szRet & uch
            Else
                uch = "%" & Hex((nAsc \ 2 ^ 12) Or &HE0) & "%" & _
                Hex((nAsc \ 2 ^ 6) And &H3F Or &H80) & "%" & _
                Hex(nAsc And &H3F Or &H80)
                szRet = szRet & uch
            End If
        End If
    Next
    UTF8_URLEncoding = szRet
End Function

'Added by Morgan 2021/1/8 轉貼網頁程式碼
'URL 英數字轉碼
Public Function URLEncode(ByRef Text As String) As String
    Const Hex = "0123456789ABCDEF"
    Dim lngA As Long, lngChar As Long
    URLEncode = Text
    For lngA = LenB(URLEncode) - 1 To 1 Step -2
        lngChar = Asc(MidB$(URLEncode, lngA, 2))
        Select Case lngChar
            Case 48 To 57, 65 To 90, 97 To 122
            Case 32
                MidB$(URLEncode, lngA, 2) = "+"
            Case Else
                URLEncode = LeftB$(URLEncode, lngA - 1) & "%" & Mid$(Hex, (lngChar And &HF0) \ &H10 + 1, 1) & Mid$(Hex, (lngChar And &HF&) + 1, 1) & MidB$(URLEncode, lngA + 2)
        End Select
    Next lngA
End Function

'Add by Amy 2021/03/04 由basStart搬過來
Public Sub ToolShow()
   With Forms(0)
   .Toolbar1.Visible = True
   .StatusBar1.Visible = True
   End With
End Sub

'Added by Morgan 2021/4/15
'開啟網址
'pURL:網址, pBrowserID:瀏覽器 0=系統預設, 1=Chrome, 2=IE
Public Sub PUB_OpenURL(ByVal pURL As String, Optional pBrowserID As Integer = 0)
    Dim sBrowserPath As String, sBrowserName As String
    Dim sTmp As String
    Dim sProgramFiles As String
    Dim bNotFound As Boolean
    
    If pBrowserID = 0 Then
      ShellExecute 0, "open", pURL, vbNullString, vbNullString, 1
    Else
      If pBrowserID = 1 Then
         sBrowserName = "\Google\Chrome\Application\chrome.exe"
      Else
         sBrowserName = "\Internet Explorer\iexplore.exe"
      End If
      '
      ' check for 32/64 bit version
      '
      sProgramFiles = Environ("ProgramFiles")
      sBrowserPath = sProgramFiles & sBrowserName
      If Dir$(sBrowserPath) = vbNullString Then
          ' if not found, search for 32bit version
          sProgramFiles = Environ("ProgramFiles(x86)")
          If sProgramFiles > vbNullString Then
              sBrowserPath = sProgramFiles & sBrowserName
              If Dir$(sBrowserPath) = vbNullString Then
                  bNotFound = True
              End If
          Else
              bNotFound = True
          End If
      End If
      If bNotFound = True Then
         If pBrowserID = 1 Then
            MsgBox "chrome.exe not found"
         Else
            MsgBox "iexplore.exe not found"
         End If
         'Exit Sub
         ShellExecute 0, "open", pURL, vbNullString, vbNullString, 1
      Else
         ShellExecute 0, "open", sBrowserPath, pURL, vbNullString, 1
      End If
      
   End If

End Sub

'Add by Amy 2021/03/26 取得收款點數(國外部用)
'stFormN:表單名稱
'stDateS/stDateE:日期起迄
'stDeptS/stDeptE:部門起迄
'stSales:業務人員
'stSysKind:系統別
'bolProF:是專業點數 'Add by Amy 2021/04/08
'Add by Amy 2021/05/12
'intChoose:0-全部/1-當月實績/2-當月結餘/3-實績轉撥/4-結餘轉撥/5-結餘+轉撥/9-FCT爭議
'intCmp: 公司別
'strAccNo:會計科目
Public Function Pub_GetAccRecePayAmt(stFormN As String, stDateS As String, stDateE As String, Optional stDeptS As String = "", Optional stDeptE As String = "", Optional stSales As String = "", Optional stSysKind As String = "", Optional stSalesMan As String = "", Optional bolProF As Boolean = False, Optional intChoose As Integer = 0, Optional strCmp As String = "", Optional strAccNo As String = "")
    Dim i As Integer, intRun As Integer, strA1K01A1P23 As String
    Dim strField(3) As String, strVTB(6) As String, strWhere(2) As String, strSalesArea As String, straccSales As String, str1P0Sales As String, strAccSys As String, strSys As String
    'Add by Amy 2021/04/08
    Const FDollar As String = "###,###,###.000"
    Dim rsA As New ADODB.Recordset, strA As String, intA As Integer
    Dim strF As String, strKey As String, str1N0F As String, strSql As String, StrStaff As String
    Dim strProVal As String, strReceVal As String, strPercent As String
    Dim strF2 As String, strGroup As String 'Add by Amy 2021/04/27
    Dim intDivisor As Integer, strAccWhere As String, str1P0Where As String  'Add by Amy 2021/05/04
    Dim intExe(1) As Long 'Modify by Amy 2022/01/13 原:Integer,因跑三年比較可能資料過多會錯 'Add by Amy 2021/06/07
    Dim strVTB0 As String  'Add by Amy 2021/11/03 過濾案源資料語法
    Dim rsA2 As New ADODB.Recordset, strA2 As String, intA2 As Integer 'Add by Amy 2021/11/08
    Dim ii As Long 'Add by Amy 2022/01/13 因跑三年比較可能資料過多會錯
    
    intDivisor = 1 'Add by Amy 2021/05/12
    intRun = 1
    '日期
    If stDateS <> MsgText(601) And stDateE <> MsgText(601) Then
        '期間包含1100101 需以a1k01串a1p23
        If (1100101 >= Val(stDateS) And 1100101 <= Val(stDateE)) Or Val(stDateS) >= 1100101 Then
            intRun = 2
            strA1K01A1P23 = "  And NEW.a1k01=a1p23(+) "
            If Val(stDateS) >= 1100101 Then
                intRun = 1
                strWhere(0) = strWhere(0) & " And a0y02 >= " & Val(stDateS) & " "
                strWhere(0) = strWhere(0) & " And a0y02 <= " & Val(stDateE) & " "
            Else
                strWhere(0) = strWhere(0) & " And a0y02 >= 1100101 "
                strWhere(0) = strWhere(0) & " And a0y02 <= " & Val(stDateE) & " "
            End If
        Else
            strWhere(0) = strWhere(0) & " And a0y02 >= " & Val(stDateS) & " "
            strWhere(0) = strWhere(0) & " And a0y02 <= " & Val(stDateE) & " "
        End If
    Else
        '起日
        If stDateS <> MsgText(601) And stDateS <> MsgText(29) Then
            strWhere(0) = strWhere(0) & " And a0y02 >= " & Val(stDateS) & " "
        End If
        '迄日
        If stDateE <> MsgText(601) And stDateE <> MsgText(29) Then
            strWhere(0) = strWhere(0) & " And a0y02 <= " & Val(stDateE) & " "
        End If
    End If
    
    'Modify by Amy 2021/06/09 專業點數明細表-秘書(FrmAcc44r0Sec)及FC專業收款明細表(frmacc24n0)不需限制部門
    'Modify by Amy 2021/08/26 原:UCase(stFormN) = UCase("FrmAcc44r0Sec")
    If InStr(UCase(stFormN), "SEC") > 0 Or UCase(stFormN) = UCase("FrmAcc24n0") Then
        '因11005月 TT-000205 內商收文但專業點數給外商黃咸達 比財務實績與結餘分析表少 5,189.4元
        '已限制會計科目,故拿掉部門才能抓到TT-000205
    Else
        '部門 起
        If stDeptS <> MsgText(601) Then
            strSalesArea = strSalesArea & " And cp12>='" & stDeptS & "' "
        End If
        '部門 迄
        If stDeptE <> MsgText(601) Then
            strSalesArea = strSalesArea & " And cp12<='" & stDeptE & "' "
        End If
    End If
    
    '業務
    If stSales = MsgText(601) Then
        'Modify by Amy 2021/05/25 專業點數明細表-秘書(FrmAcc44r0Sec)及FC專業收款明細表(frmacc24n0)不需限制ax209
        'ex:1公司D110041543 項次002/005 417204 智權人員85026
        'Modify by Amy 2021/08/26 原:UCase(stFormN) = UCase("FrmAcc44r0Sec"),因 FrmAcc42a0 也用到
        If InStr(UCase(stFormN), "SEC") > 0 Or UCase(stFormN) = UCase("FrmAcc24n0") Then
        '非個人時再加印財務調整傳票
        ElseIf Mid(stDeptS, 1, 2) = "F1" And Mid(stDeptE, 1, 2) = "F4" Then
            straccSales = " And ax209 in ('F4101','F4102','F4103','F4104','F4105','F4106','F4107') "
            str1P0Sales = " And a1p16 in ('F4101','F4102','F4103','F4104','F4105','F4106','F4107') "
        ElseIf stDeptS <> MsgText(601) Then
            Select Case Mid(stDeptS, 1, 2)
                Case "F3"
                    straccSales = " And ax209='F4101' "
                    str1P0Sales = " And a1p16='F4101' "
                Case "F2"
                    straccSales = " And ax209 in ('F4102','F4104','F4105') "
                    str1P0Sales = " And a1p16 in ('F4102','F4104','F4105') "
                Case "F1"
                    straccSales = " And ax209 in ('F4103','F4106','F4107') "
                    str1P0Sales = " And a1p16 in ('F4103','F4106','F4107') "
            End Select
        End If
    Else
        straccSales = " And ax209='" & stSales & "' "
    End If
    '系統別
    If stSysKind <> MsgText(601) Then
        strSys = " And a1k13 in('" & Replace(stSysKind, ",", "','") & "') "
        strAccSys = " And SubStr(ax214,1,Length(ax214) - 9) in('" & Replace(stSysKind, ",", "','") & "') "
    End If
    'Add by Amy 2021/05/04
    '公司別
    'Modify by Amy 2021/05/25 +FC專業收款明細表(frmacc24n0)不需限制 ax209
    'Modify by Amy 2021/08/26 原:UCase(stFormN) = UCase("FrmAcc44r0Sec")
    If InStr(UCase(stFormN), "SEC") > 0 Or UCase(stFormN) = UCase("FrmAcc24n0") Then
        strAccWhere = strAccWhere & " And ax201<>'L' "
        str1P0Where = str1P0Where & " And a1p01<>'L' "
    ElseIf strCmp <> MsgText(601) Then
        If InStr(strCmp, "+") > 0 Then
            strAccWhere = strAccWhere & " And A0201 In ('" & Replace(strCmp, "+", "','") & "') "
            str1P0Where = str1P0Where & " And a1p01 In ('" & Replace(strCmp, "+", "','") & "') "
        Else
            strAccWhere = strAccWhere & " And A0201='" & strCmp & "' "
            str1P0Where = str1P0Where & " And a1p01='" & strCmp & "' "
        End If
    End If
    
    Select Case intChoose
        Case 1 '當月實績
            strAccWhere = strAccWhere & " And (ax213 Is Null or InStr(ax213||' ','結餘')=0) And InStr(ax212,'轉撥')=0 "
        Case 2 '當月結餘
            strAccWhere = strAccWhere & " And InStr(ax213||' ','結餘')>0 And InStr(ax212,'轉撥')=0 "
        Case 3 '實績轉撥
            strAccWhere = strAccWhere & " And (ax213 Is Null or InStr(ax213||' ','結餘')=0) And InStr(ax212,'轉撥')>0 "
        Case 4 '結餘轉撥
            strAccWhere = strAccWhere & " And InStr(ax213||' ','結餘')>0 And InStr(ax212,'轉撥')>0 "
        Case 5 '結餘+轉撥
            strAccWhere = strAccWhere & " And (InStr(ax213||' ','結餘')>0 Or InStr(ax212,'轉撥')>0) "
        Case 9 'FCT爭議 'Add by Amy 2021/08/18
    End Select
    
    '會計科目
    If strAccNo <> MsgText(601) Then
        If InStr(strAccNo, ",") > 0 Then
            strAccWhere = strAccWhere & " And ax205 In ('" & Replace(strAccNo, ",", "','") & "') "
            str1P0Where = str1P0Where & " And a1p05 In ('" & Replace(strAccNo, ",", "','") & "') "
        Else
            strAccWhere = strAccWhere & " And ax205='" & strAccNo & "' "
            str1P0Where = str1P0Where & " And a1p05='" & strAccNo & "' "
        End If
    'Modify by Amy 2021/05/25 +FC專業收款明細表(frmacc24n0)不需限制 ax209
    'Modify by Amy 2021/08/26 原:UCase(stFormN) = UCase("FrmAcc44r0Sec")
    ElseIf InStr(UCase(stFormN), "SEC") > 0 Or UCase(stFormN) = UCase("FrmAcc24n0") Then
        'Add by Amy 2021/08/18 +intChoose = 9-FCT爭議(for FrmAcc24n0)
        If intChoose = 9 Then
            strAccWhere = strAccWhere & " And ax205='417202' "
            str1P0Where = str1P0Where & " And a1p05='417202' "
        '商標
        ElseIf Mid(stDeptS, 1, 2) = "F1" Then
            strAccWhere = strAccWhere & " And ((SubStr(ax205,1,4)='4172' And ax205<>'417202' And ax205<>'417203') Or (ax205='417202' And ax204='FCT'))"
            'Modify by Amy 2021/11/23 bug-原:ax204
            str1P0Where = str1P0Where & " And ((SubStr(a1p05,1,4)='4172' And a1p05<>'417202' And a1p05<>'417203') Or (a1p05='417202' And a1p06='FCT'))"
        '專利
        ElseIf Mid(stDeptS, 1, 2) = "F2" Then
            strAccWhere = strAccWhere & " And ax205 In('417101','417102','417104','417105','417109')"
            str1P0Where = str1P0Where & " And a1p05 In('417101','417102','417104','417105','417109')"
        End If
    End If
    'end 2021/05/25
    
    '固定欄位
    strField(0) = ",ax201,ax202,st16,st70"
    '本所案號欄
    strField(1) = ",a1k13,a1k14,a1k15,a1k16"
    strField(2) = ",SubStr(ax214, 1, Length(ax214) - 9) a1k13,SubStr(ax214, Length(ax214) - 8, 6) a1k14,SubStr(ax214, Length(ax214) - 2, 1) a1k15,SubStr(ax214, Length(ax214) - 1, 2) a1k16"
    '子查詢欄位
    strField(3) = "Max(cp05||cp09) as cp,a1k01,a1k09,a1k11,a1k13,a1k14,a1k15,a1k16,a1k30"
    
    'Add by Amy 2021/04/08 +專業收款資料欄位
    StrStaff = " And cp13=st01(+) "
    If bolProF = True Then
        strSql = ",cp09,'' as R022,'' as R023"
        str1N0F = ",a1n04,a1n05 "
        StrStaff = " And a1n04=st01(+) "
    Else
        '業務點數部門可不輸,故限制F部門
        StrStaff = StrStaff & " And SubStr(cp12,1,1)='F' "
    End If
    strSql = strSql & ",'" & strUserNum & "','" & stFormN & "' "
    'end 2021/04/08
    
    'Modify by Amy 2021/04/28 +R027及ax203 將所有傳票資料顯示,因1公司D110032572為FCL-010922 收文部門非國外部,與「智權人員實績與結餘分析表」實績+結餘 值不合
    'Modify by Amy 2021/05/04 +strAccWhere,str1p0Where
    For i = intRun To 1 Step -1
        '第1句：國外收款點數串得到CP09
        '*** 國外收款點數(串得到CP09) ***
        strWhere(1) = strWhere(0)
        If intRun = 2 And i = 1 Then
            strWhere(1) = Replace(strWhere(1), ">= " & 1100101, ">= " & Val(stDateS))
            strWhere(1) = Replace(strWhere(1), "<= " & Val(stDateE), "< " & 1100101)
        End If
        strWhere(1) = strWhere(1) & strSalesArea & strSys
        'Modify by Amy 2021/11/05 1公司D110100888 項次003 FCL-010933 重覆計算,秀玲:先改專業
        If bolProF = True Then
            'Modify by Amy 2024/09/05 11308月 FCL-011011 同一天收文2道,但案源只有1筆資料,導致第1及第2句都抓到1公司D113082163重覆算,原:cp09=los06(+)
             strVTB0 = " And Not Exists(Select * From LawOfficeSource,Staff Where cp162=los15(+) And los04 is not null And los04=st01(+) )"

        End If
        'Modify by Amy 2021/04/15 同一請款單多個收款單號,導致 專業點數 更新資料時會錯誤
        '子查詢語法(同一張傳票同一個業務可能拆成兩個項次 ex:A7002 1公司 D110021223-請款單號為同一個,造成 a0y04及 a0z04重覆加總)
        strVTB(0) = "Select " & strField(3) & ",a0y02,a0y04,a0z04,a0z02,a0z01 From Acc0z0,Acc0y0,Acc1k0,CaseProgress " & _
                                " Where a0z01(+)= a0y01 And a0z04<>0 And a0z02=a1k01(+) And a0z02=cp60(+) " & strWhere(1) & strVTB0 & _
                                " Group by " & Mid(strField(3), Val(InStr(strField(3), "as cp,")) + 6) & ",a0y02,a0y04,a0z04,a0z02,a0z01"
               
        'Add by Amy 2021/04/08 +專業收款資料
        If bolProF = True Then
            strF = Replace(strField(3), "Max(cp05||cp09) as cp", "") & str1N0F
            '以收款資料為主,若 Acc1n0無資料時仍需出現 ex:X10916390
            strVTB(0) = "Select Decode(a1n03,' ',cp,Decode(a1n03,null,cp,'00000000'||a1n03)) as cp" & strF & ",a0y02,a0y04,a0z04,a0z02,a0z01 " & _
                                "From Acc1n0,(" & strVTB(0) & ") Where  a1k01=a1n01(+) And ((a1n01 Is Not Null and a1n02='2') Or a1n01 is null) "
        End If
        strF = strField(0) & Replace(strField(1), ",", ",a.") & Replace(str1N0F, ",a1n04,a1n05", ",''||a.a1n04 as a1n04,''||a.a1n05 as a1n05") & strSql & ",a.a0z01,ax203"
        strF2 = strField(0) & strField(1) & str1N0F & ",ax203"
        strGroup = " Group By st16,st70,cp13,cp09,a1k01,a1k09,a1k11,a1k13,a1k14,a1k15,a1k16,a1k30,a0y02,ax201,ax202,ax203,a0z01 " & str1N0F
        If bolProF = True Then
            strF = strF & ",'1' as R028"
        Else
            strF = strF & ",'3' as R028"
        End If
        'Modify by Amy 2021/11/24 +語法來源,以利抓帳
        strVTB(1) = "Select cp13,ax207,a.a1k01,a.a1k09,a.a1k11,a.a1k30,a.a0y02,a0y04,a0z04" & strF & ",'1' as Source From " & _
                            "(Select cp09,a1k01,cp13,Sum(ax207) as ax207,a1k09,a1k11,a1k30,a0y02,a0z01" & strF2 & _
                            " From CaseProgress, Acc1p0, Acc021, Staff,(" & strVTB(0) & ") NEW " & _
                            " Where  cp09(+)=SubStr(NEW.cp,9,9) " & StrStaff & "" & strKey & stSalesMan & _
                            " And NEW.a0z01=a1p04(+) And NEW.a0z04=a1p21(+) And SubStr(a1P05,1,1) IN ('4','7') " & _
                            " And NEW.a1k13||NEW.a1k14||NEW.a1k15||NEW.a1k16=a1p17(+) " & str1P0Where & str1P0Sales & strA1K01A1P23 & _
                            " And a1p01=ax201(+) And a1p22=ax202(+) And a1p17=ax214(+) And SubStr(ax205,1,1) IN ('4','7') And a1p03=ax203(+) " & _
                            strAccWhere & strGroup & _
                            ") a,(" & strVTB(0) & ") b Where a.cp09=SubStr(b.cp,9,9) And a.a1k01=b.a1k01 And a.a0z01=b.a0z01 "
        '*** End 國外收款點數(串得到CP09) ***
        
        '第2句：法律所介紹案源(110/01加入)
        '*** 法律所介紹案源 ***
        strWhere(1) = strWhere(0)
        If intRun = 2 And i = 1 Then
            strWhere(1) = Replace(strWhere(1), ">= " & 1100101, ">= " & Val(stDateS))
            strWhere(1) = Replace(strWhere(1), "<= " & Val(stDateE), "< " & 1100101)
        End If
        strWhere(1) = strWhere(0) & Replace(strSalesArea, "cp12", "st15") & strSys
        
        '子查詢語法
        strVTB(0) = "Select " & strField(3) & ",a0y02,a0y04,a0z04,a0z02,a0z01 From Acc0z0,Acc0y0,Acc1k0,CaseProgress,LawOfficeSource,Staff " & _
                            " Where a0z01(+)=a0y01 And a0z04<>0 And a0z02=a1k01(+) And a0z02=cp60(+) And cp09=los06(+) And los04 is not null And los04=st01(+) " & strWhere(1) & _
                            " Group by " & Mid(strField(3), Val(InStr(strField(3), "as cp,")) + 6) & ",a0y02,a0y04,a0z04,a0z02,a0z01"
        'Add by Amy 2021/04/08 +專業收款資料
        If bolProF = True Then
            strF = Replace(strField(3), "Max(cp05||cp09) as cp", "") & str1N0F
            strVTB(0) = "Select Decode(a1n03,' ',cp,Decode(a1n03,null,cp,'00000000'||a1n03)) as cp" & strF & ",a0y02,a0y04,a0z04,a0z02,a0z01 " & _
                                "From Acc1n0,(" & strVTB(0) & ") Where  a1k01=a1n01(+) And ((a1n01 Is Not Null and a1n02='2') Or a1n01 is null)  "
        End If
        strF = Replace(strField(1), ",", ",a.") & Replace(str1N0F, ",a1n04,a1n05", ",''||a.a1n04 as a1n04,''||a.a1n05 as a1n05") & strSql & ",a.a0z01,ax203"
        strF2 = strField(0) & strField(1) & str1N0F & ",ax203"
        strGroup = " Group By st16,st70,los04,cp09,a1k01,a1k09,a1k11,a1k13,a1k14,a1k15,a1k16,a1k30,a0y02,a0y04,a0z04,ax201,ax202,ax203,a0z01 " & str1N0F
        If bolProF = True Then
            strF = strF & ",'1' as R028"
        Else
            strF = strF & ",'3' as R028"
        End If
        'Modify by Amy 2021/11/24 +語法來源,以利抓帳
        strVTB(2) = "Select cp13,ax207,a.a1k01,a.a1k09,a.a1k11,a.a1k30,a.a0y02,a0y04,a0z04" & strField(0) & strF & ",'2' as Source From " & _
                            "(Select cp09,a1k01,los04 as cp13,Sum(ax207) as ax207,a1k09,a1k11,a1k30,a0y02,a0z01" & strF2 & _
                            " From CaseProgress, Acc1p0, Acc021, Staff, LawOfficeSource,(" & strVTB(0) & ") NEW " & _
                            " Where cp09(+)=SubStr(NEW.cp,9,9) And cp09=los06(+) And los04 is not null And los04=st01(+) " & IIf(stSalesMan = "", "", Replace(stSalesMan, "cp13", "los04")) & _
                            " And NEW.a0z01=a1p04(+) And NEW.a0z04=a1p21(+) And SubStr(a1P05,1,1) IN ('4','7') " & _
                            " And NEW.a1k13||NEW.a1k14||NEW.a1k15||NEW.a1k16=a1p17(+) " & str1P0Where & str1P0Sales & strA1K01A1P23 & _
                            " And a1p01=ax201(+) And a1p22=ax202(+) And a1p17=ax214(+) And SubStr(ax205,1,1) IN ('4','7') And a1p03=ax203(+) " & _
                            strAccWhere & strGroup & _
                            ") a,(" & strVTB(0) & ") b Where a.cp09=SubStr(b.cp,9,9) And a.a1k01=b.a1k01 And a.a0z01=b.a0z01 "
        '*** End 法律所介紹案源 ***
        
    
        '第3句：傳票有但無ACC1P0
        '*** 傳票有但無ACC1P0,可能是扣點數 ***
        strWhere(1) = Replace(strWhere(0), "a0y02", "a1p18")
        strWhere(2) = Replace(strWhere(0), "a0y02", "a0205")
        If intRun = 2 And i = 1 Then
            strWhere(1) = Replace(strWhere(1), ">= " & 1100101, ">= " & Val(stDateS))
            strWhere(1) = Replace(strWhere(1), "<= " & Val(stDateE), "< " & 1100101)
            strWhere(2) = Replace(strWhere(2), ">= " & 1100101, ">= " & Val(stDateS))
            strWhere(2) = Replace(strWhere(2), "<= " & Val(stDateE), "< " & 1100101)
        End If
        strWhere(2) = strWhere(2) & straccSales & strAccSys
        strF = strField(0) & strField(2)
        'Add by Amy 2021/04/08 +專業收款資料
        If bolProF = True Then
            strF = strF & ",ax209 as a1n04,'' as a1n05,'' as cp09,''||(ax207-ax206) as R022,''||(ax207-ax206)/1000 as R023,'" & strUserNum & "','" & stFormN & "' "
            'Modify by Amy 2021/06/18 原:ax209 as cp13
            strF = "'' as cp13,ax207-ax206 as ax207,ax201||ax202 as a1k01,0 as a1k09,0 as a1k11,0 as a1k30,a0205 as a0y02,1 as a0y04,ax207-ax206 as a0z04" & strF & ",'' as a0z01,ax203,'1' as R028 "
        Else
            strF = "ax209 as cp13,ax207-ax206 as ax207,'' as a1k01,0 as a1k09,0 as a1k11,0 as a1k30,a0205 as a0y02,1 as a0y04,ax207-ax206 as a0z04" & strF & ",'" & strUserNum & "','" & stFormN & "','' as a0z01,ax203,'3' as R028  "
            'Add by Amy 2021/05/18 從strVTB(3)搬過來,專業點數明細表-秘書(FrmAcc44r0Sec)及FC專業收款明細表(frmacc24n0)不需限制 ax209
            strWhere(2) = strWhere(2) & " And SubStr(st15,1,1)='F' "
        End If
        
        'Modify by Amy 2021/05/04 排除會計科目4191/4192/4194
        'Modify by Amy 2021/11/24 +語法來源,以利抓帳
        'Modify by Amy 2021/11/25 把str1P0Where條件放入ACC1P0的語法中(不能放外層)造成X11003106 D110050993 FCT-046341 重覆算
        strVTB(3) = "Select " & strF & ",'3' as Source" & _
                            " From Acc020, Acc021, Staff," & _
                                "(Select * From Acc1p0 Where a1p02 IN ('F','K') " & strWhere(1) & str1P0Where & ")" & _
                            " Where a0201=ax201(+) And a0202=ax202(+) And SubStr(ax205,1,1) IN ('4','7') And Not( ax205='4191' or ax205='4192' or ax205='4194') And InStr(ax212,'保留')=0 " & strAccWhere & _
                            " And a0201=a1p01(+) And a0202=a1p22(+) And a1p04 is null And ax209=st01(+) " & strWhere(2)
        '*** End 傳票有但無ACC1P0 ***
        
        '第4句：國外收款點數串不到CP09
        '*** 國外收款點數(串不到CP09) ***
        strWhere(2) = Replace(strWhere(0), "a0y02", "a0205")
        If intRun = 2 And i = 1 Then
            strWhere(2) = Replace(strWhere(2), ">= " & 1100101, ">= " & Val(stDateS))
            strWhere(2) = Replace(strWhere(2), "<= " & Val(stDateE), "< " & 1100101)
        End If
        strWhere(2) = strWhere(2) & straccSales & strAccSys
        strF = strField(0) & strField(2)
        'Add by Amy 2021/04/08 +專業收款資料
        If bolProF = True Then
            strF = strF & ",ax209 as a1n04,'' as a1n05,'' as cp09,''||(ax207-ax206) as R022,''||(ax207-ax206)/1000 as R023,'" & strUserNum & "','" & stFormN & "' "
            'Modify by Amy 2021/06/18 原:ax209 as cp13
            strF = "'' as cp13,ax207-ax206 as ax207,ax201||ax202 as a1k01,0 as a1k09,0 as a1k11,0 as a1k30,a0205 as a0y02,1 as a0y04,ax207-ax206 as a0z04" & strF & ",'' as a0z01,ax203,'1' as R028 "
        Else
            strF = "ax209 as cp13,ax207-ax206 as ax207,'' as a1k01,0 as a1k09,0 as a1k11,0 as a1k30,a0205 as a0y02,1 as a0y04,ax207-ax206 as a0z04" & strF & ",'" & strUserNum & "','" & stFormN & "' ,'' as a0z01,ax203,'3' as R028 "
            'Add by Amy 2021/05/18 從strVTB(4)搬過來,專業點數明細表-秘書(FrmAcc44r0Sec)及FC專業收款明細表(frmacc24n0)不需限制 ax209
            strWhere(2) = strWhere(2) & " And SubStr(st15,1,1)='F' "
        End If
        
        'Modify by Amy 2021/05/04 排除會計科目4191/4192/4194
        'Modify by Amy 2021/11/03 原:And 'F'=a1p02 並加a1p01 is null,因1公司傳票D110102063 (10/29) 項次018/024 收款單號F11009985 ACS-000108 智權W2001 資料沒抓到,因會科雖是417109 但a1p02='A',業務可能值重覆先不加-秀玲
        'Modify by Amy 2021/11/23 原:And 'F'=a1p02(+) ...,造成X11003106 D110050993 FCT-046341 重覆算(前面語法已抓),改抓acc1p0資料時獨立先抓
        'Modify by Amy 2021/11/24 +語法來源,以利抓帳
        'Modify by Amy 2021/12/01 因11/23改成F'=a1p02(+) 後資料仍有與傳票有但無ACC1P0(strVTB(3))重覆,故秀玲重新整理語法,並將此句改回 'F'=a1p02
        strVTB(0) = "Select * From Acc1p0 Where A1p02 In ('F','K') " & strWhere(1) & str1P0Sales & str1P0Where
        strVTB(4) = "Select " & strF & ",'4' as Source" & _
                            " From Acc020, Acc021, Acc1p0, Acc0z0, Acc1k0, CaseProgress, Staff" & _
                            " Where a0201=ax201(+) And a0202=ax202(+) And SubStr(ax205,1,1) IN ('4','7') And Not( ax205='4191' or ax205='4192' or ax205='4194') And instr(ax212,'保留')=0 " & strAccWhere & _
                            " And ax201=a1p01(+) And ax202=a1p22(+) And 'F'=a1p02 And ax214=a1p17(+) And ax209=a1p16(+) And a1p04=a0z01(+) And a1p21=a0z04(+) " & _
                            " And a0z02=a1k01(+) And a1k01=cp60(+) And cp09 is null And ax209=st01(+) " & strWhere(2)
        '*** End 國外收款點數(串不到CP09)***
        
        '第5句：抵帳收款FC案
        '*** 抵帳收款FC案 ***
        strWhere(1) = Replace(strWhere(0), "a0y02", "a1h02")
        If intRun = 2 And i = 1 Then
            strWhere(1) = Replace(strWhere(1), ">= " & 1100101, ">= " & Val(stDateS))
            strWhere(1) = Replace(strWhere(1), "<= " & Val(stDateE), "< " & 1100101)
        End If
        strWhere(1) = strWhere(1) & strSalesArea & strSys
        
        '子查詢語法
        strVTB(0) = "Select " & strField(3) & ",a1h02,a1g02,a1k08,a1h01 From Acc1h0, Acc1g0, Acc1k0, CaseProgress " & _
                            " Where a1h01=a1g01(+) And a1h01=a1k17(+) And a1k01 = cp60(+) " & strWhere(1) & _
                            "Group By " & Mid(strField(3), Val(InStr(strField(3), "as cp,")) + 6) & ",a1h02,a1g02,a1k08,a1k01,a1h01"
        'Add by Amy 2021/04/08 +專業收款資料
        If bolProF = True Then
            strF = Replace(strField(3), "Max(cp05||cp09) as cp", "") & str1N0F
            strVTB(0) = "Select Decode(a1n03,' ',cp,Decode(a1n03,null,cp,'00000000'||a1n03)) as cp" & strF & ",a1h02,a1g02,a1k08,a1h01 " & _
                                "From Acc1n0,(" & strVTB(0) & ") Where  a1k01=a1n01(+) And ((a1n01 Is Not Null and a1n02='2') Or a1n01 is null) "
        End If
        strF = strField(0) & Replace(strField(1), ",", ",a.") & Replace(str1N0F, ",a1n04,a1n05", ",''||a.a1n04 as a1n04,''||a.a1n05 as a1n05") & strSql & ",'' as a0z01,ax203 "
        strF2 = strField(0) & strField(1) & str1N0F & ",ax203"
        strGroup = " Group By st16,st70,cp13,cp09,a1k01,a1k09,a1k11,a1k13,a1k14,a1k15,a1k16,a1k30,a1h02,a1g02,a1k08,ax201,ax202,ax203" & str1N0F
        If bolProF = True Then
            strF = strF & ",'1' as R028"
        Else
            strF = strF & ",'3' as R028"
        End If
        'Modify by Amy 2021/11/24 +語法來源,以利抓帳
        strVTB(5) = "Select cp13,ax207,a.a1k01,a.a1k09,a.a1k11,a.a1k30,a.a0y02,a1g02 as a0y04,a1k08 as a0z04" & strF & ",'5' as Source From " & _
                            "(Select cp09,a1k01,cp13,Sum(ax207) as ax207,a1k09,a1k11,a1k30,a1h02 as a0y02" & strF2 & _
                            " From CaseProgress, Acc1p0, Acc021, Staff,(" & strVTB(0) & ") NEW " & _
                            " Where cp09(+)=SubStr(NEW.cp,9,9) And NEW.a1h01=a1p04(+) And SubStr(a1P05,1,1) IN ('4','7') And a1k01=a1p23 " & StrStaff & "" & stSalesMan & _
                            " And a1p01=ax201(+) And a1p22=ax202(+) And a1p17=ax214(+) " & str1P0Where & str1P0Sales & " And SubStr(ax205,1,1) IN ('4','7') And a1p03=ax203(+) " & _
                            strAccWhere & strGroup & _
                            ") a,(" & strVTB(0) & ") b Where a.cp09=SubStr(b.cp,9,9) And a.a1k01=b.a1k01 "
        '*** End 抵帳收款FC案 ***
        
        '第6句：抵帳結匯FC案(110/01加入)
        '*** 抵帳結匯FC案 ***
        strWhere(1) = Replace(strWhere(0), "a0y02", "a1i03")
        If intRun = 2 And i = 1 Then
            strWhere(1) = Replace(strWhere(1), ">= " & 1100101, ">= " & Val(stDateS))
            strWhere(1) = Replace(strWhere(1), "<= " & Val(stDateE), "< " & 1100101)
        End If
        strWhere(1) = strWhere(1) & strSalesArea & strSys
        
        '子查詢語法(計算金額以Acc1g0之匯率為主)
        'Modify by Amy 2021/09/10 +Acc1h0 避免重複計算 因D110081274 X11001675/2512/2366 抵帳收款FC案會出現,此也出現
        strVTB(0) = "Select " & strField(3) & ",a1i03,a1g03,a1k08,a1i01 From Acc1i0, Acc1g0,Acc1h0,Acc1k0,CaseProgress " & _
                            " Where a1i01=a1g01(+) And a1g01=a1h01(+) And a1h01 is null And a1i01=a1k17(+) And a1k01=cp60(+) " & strWhere(1) & _
                            " Group By " & Mid(strField(3), Val(InStr(strField(3), "as cp,")) + 6) & ",a1i03,a1g03,a1k08,a1i01"
        'Add by Amy 2021/04/08 +專業收款資料
        If bolProF = True Then
            strF = Replace(strField(3), "Max(cp05||cp09) as cp", "") & str1N0F
            strVTB(0) = "Select Decode(a1n03,' ',cp,Decode(a1n03,null,cp,'00000000'||a1n03)) as cp" & strF & ",a1i03,a1g03,a1k08,a1i01 " & _
                                "From Acc1n0,(" & strVTB(0) & ") Where  a1k01=a1n01(+) And ((a1n01 Is Not Null and a1n02='2') Or a1n01 is null) "
        End If
        strF = strField(0) & Replace(strField(1), ",", ",a.") & Replace(str1N0F, ",a1n04,a1n05", ",''||a.a1n04 as a1n04,''||a.a1n05 as a1n05") & strSql & ",'' as a0z01,ax203"
        strF2 = strField(0) & strField(1) & str1N0F & ",ax203"
        strGroup = " Group By st16,st70,cp13,cp09,a1k01,a1k09,a1k11,a1k13,a1k14,a1k15,a1k16,a1k30,a1i03,a1g03,a1k08,ax201,ax202,ax203" & str1N0F
        If bolProF = True Then
            strF = strF & ",'1' as R028"
        Else
            strF = strF & ",'3' as R028"
        End If
        'Modify by Amy 2021/04/22 +strA1K01A1P23 不串導致 D110031155 傳票資料會抓錯
        'Modify by Amy 2021/11/24 +語法來源,以利抓帳
        strVTB(6) = "Select cp13,ax207,a.a1k01,a.a1k09,a.a1k11,a.a1k30,a.a0y02,a1g03 as a0y04,a1k08 as a0z04" & strF & ",'6' as Source From " & _
                            "(Select cp09,a1k01,cp13,Sum(ax207) as ax207,a1k09,a1k11,a1k30,a1i03 as a0y02" & strF2 & _
                            " From CaseProgress, Acc1p0, Acc021, Staff,(" & strVTB(0) & ") NEW " & _
                            " Where cp09(+)=SubStr(NEW.cp,9,9) And NEW.a1i01=a1p04(+) And SubStr(a1P05,1,1) IN ('4','7') " & StrStaff & stSalesMan & _
                            " And NEW.a1k13||NEW.a1k14||NEW.a1k15||NEW.a1k16=a1p17(+) " & str1P0Where & str1P0Sales & strA1K01A1P23 & _
                            " And a1p01=ax201(+) And a1p22=ax202(+) And a1p17=ax214(+) And SubStr(ax205,1,1) IN ('4','7') And a1p03=ax203(+) " & _
                            strAccWhere & strGroup & _
                            ") a,(" & strVTB(0) & ") b Where a.cp09=SubStr(b.cp,9,9) And a.a1k01=b.a1k01 "
        '*** End 抵帳結匯FC案 ***
                            
        Pub_GetAccRecePayAmt = Pub_GetAccRecePayAmt & IIf(intRun = 2 And i = 1, " Union ", "") & _
                                                    strVTB(1) & " Union " & strVTB(2) & " Union " & strVTB(3) & " Union " & strVTB(4) & " Union " & strVTB(5) & " Union " & strVTB(6)
        strA1K01A1P23 = ""
    Next i
    'end 2021/05/12
    'end 2021/04/28
    
    'Modify by Amy 2021/04/28 收款點數也寫入暫存檔,因1公司D110032572為FCL-010922 收文部門非國外部與財務處報表不合
    '刪除暫存檔
    strSql = "Delete From Accrpt115 Where ID='" & strUserNum & "' And FormN='" & stFormN & "' "
    cnnConnection.Execute strSql, ii
    
    'Modify  by Amy 2022/01/13 原:cnnConnection.Execute strSql, i 因跑三年比較可能資料過多會錯
    '*** 收款點數 ***
    If bolProF = False Then
        '資料寫入暫存檔
        'Modify by Amy 2021/11/24 +語法來源,以利抓帳
        strSql = "Insert into Accrpt115 (R001,R002,R003,R004,R005,R006,R007,R008,R009,R010,R011,R012,R013,R014,R015,R016,R017,ID,FormN,R024,R027,R028,R029) " & _
                      Pub_GetAccRecePayAmt
        cnnConnection.Execute strSql, ii

        '新增列印資料
        strSql = "Insert into Accrpt115 (R001,R002,R003,R004,R005,R006,R007,R008,R009,R010,R011,R012,R013,R014,R015,R016,R017,R018,R019,R020,R024,ID,FormN,R028) " & _
                    "Select R001,Sum(R002),R003,R004,R005,R006,R007,R008,R009,R010,R011,R012,R013,R014,R015,R016,R017,R018,R019,R020,R024,'" & strUserNum & "','" & stFormN & "','4' " & _
                    "From Accrpt115 Where ID='" & strUserNum & "' And FormN='" & stFormN & "' And R028='3' " & _
                    "Group by R001,R003,R004,R005,R006,R007,R008,R009,R010,R011,R012,R013,R014,R015,R016,R017,R018,R019,R020,R024 "
        cnnConnection.Execute strSql, ii

        '** 業務點數 新增 智權點數實績與結餘分析表之F41XX 實績+結餘 傳票不存在於Accrpt115者 (此處改下面 專業點數 也需確認是否要改)**
        'Add by Amy 2021/04/29 ex:11003月 X11003018 1公司D110032572 項次6 FCL-010922 智權點數實績與結餘分析表有抓但Acc24c0沒,故加入智權點數實績與結餘分析表有但Acc24c0沒的資料
        'Modify by Amy 2021/05/06 系統類別條件改至外層抓
        'Modify by Amy 2021/05/24 與專業點數明細表-秘書(FrmAcc44r0Sec)及FC專業收款明細表(frmacc24n0)不同「需限制」ax209,要可和智權點數實績與結餘分析表核對FCP/FCT合計 實績+結餘
        '                                              ex:11002月 J公司D110020042 不列入(智權點數實績與結餘分析表列於個人,但Acc24c0於 2021/05/21將限制ax209拿掉後會多4點,故再加回限制ax209)
        'Modify by Amy 2021/06/03 要可抓單日 ex:1100528
        strSql = "Select ax201,ax202,ax203,Sum(ax207) as ax207,ax209,ax214,a0205 From (" & _
                        GetPoint(1.3, stDateS, stDateE, stDeptS, stDeptE, stSales, False, "Pub_GetAccRecePayAmt", True, stSysKind) & _
                     " Union all " & _
                        GetPoint(1.4, stDateS, stDateE, stDeptS, stDeptE, stSales, False, "Pub_GetAccRecePayAmt", True, stSysKind) & _
                     " ) Where 1=1 " & strAccSys & straccSales & " Group by ax201,ax202,ax203,ax209,ax214,a0205 "
        strSql = Replace(strSql, "And InStr(ax212,'轉撥')=0", "And InStr(ax212,'轉撥')=0" & strAccWhere)
        'end 2021/06/03
        
        'Modify by Amy 2021/06/15 +st16(R012),st70(R013)
        'Modfiy by Amy 2022/02/10 +And FormN='" & stFormN & "' "
        strSql = "Insert into Accrpt115(R001,R002,R003,R004,R005,R006,R007,R008,R009,R010,R011,R012,R013,R014,R015,R016,R017,ID,FormN,R028) " & _
                    "Select ax209,ax207,ax201||ax202,0,0,0,a0205,1,ax207,ax201,ax202,st16,st17" & _
                              ",SubStr(ax214, 1, length(ax214) - 9),SubStr(ax214, length(ax214) - 8, 6),SubStr(ax214, length(ax214) - 2, 1),SubStr(ax214, length(ax214) - 1, 2),'" & strUserNum & "','" & stFormN & "','4' " & _
                    "From Staff,(" & strSql & "),(Select Distinct R010,R011,R027,R002 From Accrpt115 Where R028='3' And ID='" & strUserNum & "' And FormN='" & stFormN & "' ) " & _
                    "Where ax201=R010(+) And ax202=R011(+) And ax203=R027(+) And ax209=st01(+) And ax207-Nvl(R002,0)<>0 "
        cnnConnection.Execute strSql, ii
        '** End 新增 智權點數實績與結餘分析表之F41XX 實績+結餘 傳票不存在於Accrpt115者 **

        '更新 非 請款單之 已收金額=外幣金額*匯率
        strSql = "Update Accrpt115 a Set R022=R008*R009,R023=R008*R009/1000,R025=Round(R008*R009,2) Where ID='" & strUserNum & "' And FormN='" & stFormN & "' And R028='4' And (R003 is Null Or SubStr(R003,1,1)<>'X' )"
        cnnConnection.Execute strSql, ii

        '更新 請款單之 外幣金額*匯率=已收台幣金額(a1k30),則 已收金額=外幣金額*匯率-規費
        strSql = "Update Accrpt115 a Set R025=Round(R008*R009-R004,2) Where ID='" & strUserNum & "' And FormN='" & stFormN & "' And R028='4' And SubStr(R003,1,1)='X' " & _
                    "And R006=Round(R008*R009,2) "
        cnnConnection.Execute strSql, ii
        
'        '更新 同 請款單之 兩張不同收款單,最小收文號可扣規費之資料 已收金額=外幣金額*匯率-規費 ex:X11001685 兩張不同收款單
'        strSql = "Select R003||Min(R024) From Accrpt115 Where ID='" & strUserNum & "' And FormN='" & stFormN & "' And R028='2' " & _
'                    "And R003 In(Select R003 From(Select  Distinct R003,R024  From Accrpt115 Where ID='" & strUserNum & "' And FormN='" & stFormN & "' And R028='2' And SubStr(R003,1,1)='X' And R025 is null) Group by R003 Having Count(R003)>1 ) " & _
'                    "And SubStr(R003,1,1)='X' And R025 is null And R008*R009-R004>=0 Group by R003 "
'
'        strSql = "Update Accrpt115 a Set R022=Round(R008*R009,2)*(R019/R021),R023=(R008*R009-R004)/1000,R025=Round(R008*R009-R004,2) Where ID='" & strUserNum & "' And FormN='" & stFormN & "' And R028='2' " & _
'                    " And R003||R024 In (" & strSql & ") And SubStr(R003,1,1)='X' And R025 is null "
'        cnnConnection.Execute strSql, ii

        '更新 其他請款單之 已收金額=外幣金額*匯率
        strSql = "Update Accrpt115 Set R025=Round(R008*R009,2) Where ID='" & strUserNum & "' And FormN='" & stFormN & "' And R028='4' And SubStr(R003,1,1)='X' And R025 is null "
        cnnConnection.Execute strSql, ii
        
        '更新只有一筆X單號之已收金額及已收點數
        strSql = "Update Accrpt115 Set R022=R008*R009,R023=R025/1000 Where ID='" & strUserNum & "' And FormN='" & stFormN & "' And R028='4' " & _
                     "And SubStr(R003,1,1)='X' And (R022 is null Or R023 is null) And R025 is not null " & _
                     "And R003 In (Select R003 From accrpt115 a Where ID='" & strUserNum & "'  And FormN='" & stFormN & "' And R028='4' And SubStr(R003,1,1)='X' And (R022 is null Or R023 is null) Group by R003 Having Count(R003)=1) "
        cnnConnection.Execute strSql, ii
        
        '*** 同請款單 多筆資料 ***
        '個人已收金額(R022)=(外幣金額*匯率)
        '個人已收點數(R023)=已收金額(R025若需扣規費則已扣除)/1000
        strSql = "Update Accrpt115 Set R022=Round(R008*R009,2),R023=R025/1000 Where ID='" & strUserNum & "' And FormN='" & stFormN & "' And R028='4' " & _
                     "And SubStr(R003,1,1)='X' And (R022 is null Or R023 is null) "
        cnnConnection.Execute strSql, ii
        
        '*** 已收金額>0但已收點數<0,則 已收點數=0 (此處有改需看下方「專業」部分是否也需修改) ***
        'Add by Amy 2021/06/18 ex:11005月 X10914134 FCP-061932
        strSql = "Update Accrpt115 a Set R023=0 Where ID='" & strUserNum & "' And FormN='" & stFormN & "' And R028='4' And R022>0 And R023<0 "
        cnnConnection.Execute strSql, ii
        '*** end 已收金額>0但已收點數<0,則 已收點數=0  ***
    End If
    '*** End 收款點數 ***
    'end 2021/04/28
    
    '*** 專業點數 ***
    'Add by Amy 2021/04/08 專利工程師組別-基本檔 pa150/sp79/ 商標組別-以 單號抓 a1n03總收文號再抓其進度之智權人員之組別
    'Modify by Amy 2021/04/27 +R027 (ax203 項次)/R028
    If bolProF = True Then
        '資料寫入暫存檔
        'Modify by Amy 2021/04/15 +R024 (a0z01 M單號)
        'Modify by Amy 2021/11/24 +語法來源,以利抓帳
        strSql = "Insert into Accrpt115 (R001,R002,R003,R004,R005,R006,R007,R008,R009,R010,R011,R012,R013,R014,R015,R016,R017,R018,R019,R020,R022,R023,ID,FormN,R024,R027,R028,R029) " & _
                     Pub_GetAccRecePayAmt
        cnnConnection.Execute strSql, ii
      
        'Add by Amy 2021/06/15 請款單沒有可分配人員者原找cp13,改抓ax209,因為收款匯差金額比規費多，收款傳票才會有收入科目(與業務收款不同,因frmacc24c0以業務角度，抓CP13故不需改)
        '                                        ex11005月 A5023(洪培堯) X11000118 1公司D110051628 005項
        strSql = "Select st16 From Acc021,Staff Where R010=ax201 And R011=ax202 And R027=ax203 And ax209=st01"
        strSql = "Update Accrpt115 Set R018=(Select ax209 From Acc021 Where R010=ax201 And R011=ax202 And R027=ax203),R012=(" & strSql & "),R013=(" & Replace(strSql, "st16", "st70") & ") " & _
                  " Where ID='" & strUserNum & "' And FormN='" & stFormN & "' And R028='1' And R018 is null "
        cnnConnection.Execute strSql, ii
        
        '新增列印資料
        'Modify by Amy 2021/06/07 分配點數人員為商標處者,此請款單之已收點數=R023(已收點數),並刪除商標處人員且會計科目為 417202
        '                                             ex:1100501-1100531 X11005145 FCT-046187 P2001 不顯示,同X單號之對應之藍含青財務點數顯示已收金額
        If Left(stDeptS, 2) = "F1" Then
            strSql = "Insert into Accrpt115 (R001,R002,R003,R004,R005,R006,R007,R008,R009,R010,R011,R012,R013,R014,R015,R016,R017,R018,R019,R020,R024,ID,FormN,R028) " & _
                        "Select R001,Sum(R002),R003,R004,R005,R006,R007,R008,R009,R010,R011,R012,R013,R014,R015,R016,R017,R018,R019,R020,R024,'" & strUserNum & "','" & stFormN & "','2' " & _
                        "From Accrpt115,Staff,Acc021 Where ID='" & strUserNum & "' And FormN='" & stFormN & "' And R028='1' " & _
                        "And R018=st01(+) And Substr(st15,1,2)||ax205<>'P2417202' And R010=ax201(+) And R011=ax202(+) And R027=ax203(+) " & _
                        "Group by R001,R003,R004,R005,R006,R007,R008,R009,R010,R011,R012,R013,R014,R015,R016,R017,R018,R019,R020,R024 "
            cnnConnection.Execute strSql, intExe(0)
            
            strSql = "Insert into Accrpt115 (R001,R002,R003,R004,R005,R006,R007,R008,R009,R010,R011,R012,R013,R014,R015,R016,R017,R018,R019,R020,R024,R027,ID,FormN,R028) " & _
                        "Select R001,Sum(R002),R003,R004,R005,R006,R007,R008,R009,R010,R011,R012,R013,R014,R015,R016,R017,R018,R019,R020,R024,R027,'" & strUserNum & "','" & stFormN & "','2' " & _
                        "From Accrpt115,Staff,Acc021 Where ID='" & strUserNum & "' And FormN='" & stFormN & "' And R028='1' " & _
                        "And R018=st01(+) And Substr(st15,1,2)||ax205='P2417202' And R010=ax201(+) And R011=ax202(+) And R027=ax203(+) " & _
                        "Group by R001,R003,R004,R005,R006,R007,R008,R009,R010,R011,R012,R013,R014,R015,R016,R017,R018,R019,R020,R024,R027 "
            cnnConnection.Execute strSql, intExe(1)
          
        Else
            strSql = "Insert into Accrpt115 (R001,R002,R003,R004,R005,R006,R007,R008,R009,R010,R011,R012,R013,R014,R015,R016,R017,R018,R019,R020,R024,ID,FormN,R028) " & _
                        "Select R001,Sum(R002),R003,R004,R005,R006,R007,R008,R009,R010,R011,R012,R013,R014,R015,R016,R017,R018,R019,R020,R024,'" & strUserNum & "','" & stFormN & "','2' " & _
                        "From Accrpt115 Where ID='" & strUserNum & "' And FormN='" & stFormN & "' And R028='1' " & _
                        "Group by R001,R003,R004,R005,R006,R007,R008,R009,R010,R011,R012,R013,R014,R015,R016,R017,R018,R019,R020,R024 "
            cnnConnection.Execute strSql, intExe(0)
        End If
        
        If intExe(0) + intExe(1) <> 0 Then
            '** 專業點數 新增 智權點數實績與結餘分析表之F41XX 實績+結餘 傳票不存在於Accrpt115者 (此處改上面 業務點數 也需確認是否要改)**
            'Add by Amy 2021/04/29 ex:11003月 X11003018 D110032572 項次6 FCL-010922 智權點數實績與結餘分析表有抓但Acc24c0沒,故加入智權點數實績與結餘分析表有但Acc24c0沒的資料
            '                                              因怕也未列到的情況,故此(專業點數)也加
            'Modify by Amy 2021/05/06 系統類別條件改至外層抓
            'Modify by Amy 2021/05/25 專業點數明細表-秘書(FrmAcc44r0Sec)及FC專業收款明細表(frmacc24n0)「不需限制」ax209
            '                                              ex:1公司D110041543 項次002/005 417204 因限制ax2009,導致 85026 點數沒顯示,故全部語法改不限制ax209,此筆資料會出現於「收款資料」語法中
            'Modify by Amy 2021/06/03 要可抓單日 ex:1100528
            strSql = "Select ax201,ax202,ax203,Sum(ax207) as ax207,ax209,ax214,a0205 From (" & _
                            GetPoint(1.3, stDateS, stDateE, stDeptS, stDeptE, stSales, False, "Pub_GetAccRecePayAmt", True, stSysKind) & _
                            " Union all " & _
                            GetPoint(1.4, stDateS, stDateE, stDeptS, stDeptE, stSales, False, "Pub_GetAccRecePayAmt", True, stSysKind) & _
                            " ) Where 1=1" & strAccSys & " Group by ax201,ax202,ax203,ax209,ax214,a0205 "
            strSql = Replace(strSql, "And InStr(ax212,'轉撥')=0", "And InStr(ax212,'轉撥')=0" & strAccWhere)
            'end 2021/06/03
            
            'Modify by Amy 2021/06/15 +st16(R012),st70(R013)
            strSql = "Insert into Accrpt115(R002,R003,R004,R005,R006,R007,R008,R009,R010,R011,R012,R013,R014,R015,R016,R017,R018,ID,FormN,R028) " & _
                        "Select ax207,ax201||ax202,0,0,0,a0205,1,ax207,ax201,ax202,st16,st70" & _
                                ",SubStr(ax214, 1, length(ax214) - 9),SubStr(ax214, length(ax214) - 8, 6),SubStr(ax214, length(ax214) - 2, 1),SubStr(ax214, length(ax214) - 1, 2),ax209,'" & strUserNum & "','" & stFormN & "','2' " & _
                        "From Staff,(" & strSql & "),(Select Distinct R010,R011,R027,R002 From Accrpt115 Where R028='1' And ID='" & strUserNum & "' And FormN='" & stFormN & "' ) " & _
                        "Where ax201=R010(+) And ax202=R011(+) And ax203=R027(+) And ax209=st01(+) And ax207-Nvl(R002,0)<>0 "
            cnnConnection.Execute strSql, ii
            '** End 新增 智權點數實績與結餘分析表之F41XX 實績+結餘 傳票不存在於Accrpt115者 **
            
            '更新無分配比例資料
            strSql = "Update Accrpt115 Set R019=1,R021=1 Where ID='" & strUserNum & "' And FormN='" & stFormN & "' And R028='2' And R019 is null "
            cnnConnection.Execute strSql, ii
            
            '更新總點數R021
            strSql = "Update Accrpt115 Set R021=(Select Sum(a1n05) From Acc1n0 Where a1n01=R003 And a1n02='2' Group by a1n01) " & _
                            "Where ID='" & strUserNum & "' And FormN='" & stFormN & "' And R028='2' And R021 is null "
            cnnConnection.Execute strSql, ii
            
            'Modify by Amy 2021/04/26 +R025
            '更新 非 請款單之 已收金額=外幣金額*匯率
            strSql = "Update Accrpt115 a Set R022=R008*R009,R023=R008*R009/1000,R025=Round(R008*R009,2) Where ID='" & strUserNum & "' And FormN='" & stFormN & "' And R028='2' And SubStr(R003,1,1)<>'X' "
            cnnConnection.Execute strSql, ii
            
            '更新 請款單之 外幣金額*匯率=已收台幣金額(a1k30),則 已收金額=外幣金額*匯率-規費
            strSql = "Update Accrpt115 a Set R025=Round(R008*R009-R004,2) Where ID='" & strUserNum & "' And FormN='" & stFormN & "' And R028='2' And SubStr(R003,1,1)='X' " & _
                        "And R006=Round(R008*R009,2) "
            cnnConnection.Execute strSql, ii
        
    '        '更新 同 請款單之 兩張不同收款單,最小收文號可扣規費之資料 已收金額=外幣金額*匯率-規費 ex:X11001685 兩張不同收款單
    '        strSql = "Select R003||Min(R024) From Accrpt115 Where ID='" & strUserNum & "' And FormN='" & stFormN & "' And R028='2' " & _
    '                    "And R003 In(Select R003 From(Select  Distinct R003,R024  From Accrpt115 Where ID='" & strUserNum & "' And FormN='" & stFormN & "' And R028='2' And SubStr(R003,1,1)='X' And R025 is null) Group by R003 Having Count(R003)>1 ) " & _
    '                    "And SubStr(R003,1,1)='X' And R025 is null And R008*R009-R004>=0 Group by R003 "
    '
    '        strSql = "Update Accrpt115 a Set R022=Round(R008*R009,2)*(R019/R021),R023=(R008*R009-R004)/1000,R025=Round(R008*R009-R004,2) Where ID='" & strUserNum & "' And FormN='" & stFormN & "' And R028='2' " & _
    '                    " And R003||R024 In (" & strSql & ") And SubStr(R003,1,1)='X' And R025 is null "
    '        cnnConnection.Execute strSql, ii
        
            '更新只有一筆X單號之已收金額及已收點數(R025 is null)
            strSql = "Update Accrpt115 Set R022=R008*R009,R023=R008*R009/1000,R025=Round(R008*R009,2) Where ID='" & strUserNum & "' And FormN='" & stFormN & "' And R028='2' " & _
                            "And SubStr(R003,1,1)='X' And R025 is null " & _
                            "And R003 In (Select R003 From accrpt115 a Where ID='" & strUserNum & "'  And FormN='" & stFormN & "' And R028='2' And SubStr(R003,1,1)='X' And R025 is null Group by R003 Having Count(R003)=1) "
            cnnConnection.Execute strSql, ii
            '更新只有一筆X單號之已收金額及已收點數(R023/R022 is null)
            strSql = "Update Accrpt115 Set R022=R008*R009,R023=R025/1000 Where ID='" & strUserNum & "' And FormN='" & stFormN & "' And R028='2' " & _
                            "And SubStr(R003,1,1)='X' And (R022 is null Or R023 is null) And R025 is not null " & _
                            "And R003 In (Select R003 From accrpt115 a Where ID='" & strUserNum & "'  And FormN='" & stFormN & "' And R028='2' And SubStr(R003,1,1)='X' And (R022 is null Or R023 is null) And R025 is not null Group by R003 Having Count(R003)=1) "
            cnnConnection.Execute strSql, ii
            
            '更新 其他請款單 R025 資料
            strSql = "Update Accrpt115 a Set R025=Round(R008*R009,2) Where ID='" & strUserNum & "' And FormN='" & stFormN & "' And R028='2' " & _
                        "And SubStr(R003,1,1)='X' And R025 is null "
            cnnConnection.Execute strSql, ii
            
            '*** 同請款單 多筆資料 ***
            '更新多筆分配人員之已收金額及已收點數(不含點數最大者)
            '抓取同請款單最小收文號之最大點數
            strSql = "Select R003||R020||Max(R019) From Accrpt115  Where ID='" & strUserNum & "'  And FormN='" & stFormN & "' And R028='2' And SubStr(R003,1,1)='X' And (R022 is null Or R023 is null) " & _
                            "And R003||R020 In (Select R003||Min(R020) From Accrpt115  Where ID='" & strUserNum & "'  And FormN='" & stFormN & "' And R028='2' And SubStr(R003,1,1)='X' And (R022 is null Or R023 is null) Group by R003 " & _
                            ") Group by R003,R020 "
            
            '個人已收金額(R022)=(外幣金額*匯率)*(個人分配點數/X單號總點數)
            '個人已收點數(R023)=已收金額(R025若需扣規費則已扣除)/1000
            'Modify by Amy 2021/09/03 因資料量過多(三年資料),導致過濾很慢
            If UCase(stFormN) = UCase("Frmacc42a0Sec") Then
                '先改狀態,以利更新(同請款單最小收文號之最大點數,狀態先改為25)
                strSql = "Update Accrpt115 Set R028=R028||'5' Where ID='" & strUserNum & "' And FormN='" & stFormN & "' And R028='2' And SubStr(R003,1,1)='X' And (R022 is null Or R023 is null) And R003||R020||R019 In (" & strSql & ") "
                cnnConnection.Execute strSql, ii
                
                strSql = "Update Accrpt115 Set R022=Round(R008*R009,2)*(R019/R021),R023=R025*(R019/R021)/1000 Where ID='" & strUserNum & "' And FormN='" & stFormN & "' And SubStr(R028,1,1)='2' " & _
                                "And SubStr(R003,1,1)='X' And (R022 is null Or R023 is null) " & _
                                "And Length(R028)=1 "
                cnnConnection.Execute strSql, ii
                
                '改回狀態
                strSql = "Update Accrpt115 Set R028=SubStr(R028,1,1) Where ID='" & strUserNum & "' And FormN='" & stFormN & "' And R028='25' And SubStr(R003,1,1)='X' And (R022 is null Or R023 is null) "
                cnnConnection.Execute strSql, ii
            Else
                strSql = "Update Accrpt115 Set R022=Round(R008*R009,2)*(R019/R021),R023=R025*(R019/R021)/1000 Where ID='" & strUserNum & "' And FormN='" & stFormN & "' And R028='2' " & _
                                "And SubStr(R003,1,1)='X' And (R022 is null Or R023 is null) " & _
                                "And R003||R020||R019 Not In (" & strSql & ") "
                cnnConnection.Execute strSql, ii
            End If
            
            '更新 同 請款單 同收款單 2人以上之同分配點數人員(不含員編最小者) ex:X10916314
            strSql = "Update Accrpt115 Set R022=Round(R008*R009,2)*(R019/R021),R023=R025*(R019/R021)/1000 Where ID='" & strUserNum & "' And FormN='" & stFormN & "' And R028='2' " & _
                            "And SubStr(R003,1,1)='X' And (R022 is null Or R023 is null) " & _
                            "And R003||R024||R018 In (Select R003||R024||Max(R018) From Accrpt115 a Where ID='" & strUserNum & "'  And FormN='" & stFormN & "' And R028='2' " & _
                                                                "And SubStr(R003,1,1)='X' And (R022 is null Or R023 is null) Group by R003,R024,R019 Having Count(R003||R024||R019)>1 ) "
            cnnConnection.Execute strSql, ii
            
            '更新 其他請款單 多筆資料
            strSql = "Select R003 From Accrpt115 a Where ID='" & strUserNum & "'  And FormN='" & stFormN & "' And R028='2' And SubStr(R003,1,1)='X' And (R022 is null Or R023 is null) Group by R003 Having Count(R003)>1 "
            strSql = "Update Accrpt115 a Set R022=Round(R008*R009,2)*(R019/R021),R023=R008*R009/1000 Where ID='" & strUserNum & "' And FormN='" & stFormN & "' And R028='2' " & _
                        "And SubStr(R003,1,1)='X' And (R022 is null Or R023 is null) And R003 in (" & strSql & ")"
            cnnConnection.Execute strSql, ii
            '*** End 同請款單 多筆資料 ***
            
            '抓取同筆請款最大分配者資料,因有差額需加於分配於分配點最大者
            strA = "Select R018 as a1n04,R003 as a1k01,R020 as cp09,R024 as InvNo,R001 as cp13,R008 as a0y04,R009 as a0z04,R019 as a1n05,NowR023,R021 as AllPoint,R025,AllR022 " & _
                        "From Accrpt115,(Select R003 as XNo,Sum(R022) as AllR022,Sum(R023) as NowR023 From Accrpt115 Where ID='" & strUserNum & "' And FormN='" & stFormN & "' And R028='2' Group by R003) " & _
                        "Where ID='" & strUserNum & "' And FormN='" & stFormN & "' And R028='2' And R003=XNo(+) And (R022 is null Or R023 is null) Order by r003,r019,R024 "
            intA = 1
            Set rsA = ClsLawReadRstMsg(intA, strA)
            If intA = 1 Then
                Do While rsA.EOF = False
                    '*** 更新同筆請款最後一筆資料***
                    strSql = "": strPercent = 1
                    
                    '可能無分配點數資料 ex:1100115 X10916390
                    If "" & rsA.Fields("a1n04") = MsgText(601) And "" & rsA.Fields("cp13") = MsgText(601) Then
                        strSql = " And R018 is null And R001 is null "
                    Else
                        If "" & rsA.Fields("a1n04") <> MsgText(601) Then
                            strSql = strSql & " And R018='" & rsA.Fields("a1n04") & "' "
                        End If
                        If "" & rsA.Fields("cp13") <> MsgText(601) Then
                                strSql = strSql & " And R001='" & rsA.Fields("cp13") & "' "
                        End If
                    End If
                    If "" & rsA.Fields("InvNo") <> MsgText(601) Then
                        strSql = strSql & " And R024='" & rsA.Fields("InvNo") & "' "
                    End If
                        
                    If Val("" & rsA.Fields("AllPoint")) <> 0 Then
                        strPercent = Val("" & rsA.Fields("a1n05")) / Val("" & rsA.Fields("AllPoint"))
                    End If
                    '已收金額=已收總金額-已分配總金額
                    strReceVal = Round(Val("" & rsA.Fields("a0y04")) * Val("" & rsA.Fields("a0z04")), 2) - Val("" & rsA.Fields("AllR022"))
                    '已收點數=(已收金額(扣規費)-(已分配總點數*1000))/1000
                    strProVal = Round((Val("" & rsA.Fields("R025")) - (Val("" & rsA.Fields("NowR023")) * 1000)) / 1000, 3)
                    
                    strSql = "Update Accrpt115 Set R022=" & strReceVal & ",R023=" & strProVal & " " & _
                                "Where ID='" & strUserNum & "' And FormN='" & stFormN & "' And R028='2' And R003='" & rsA.Fields("a1k01") & "' " & _
                                "And R020='" & rsA.Fields("cp09") & "' " & strSql
                    cnnConnection.Execute strSql, ii
                    
                    rsA.MoveNext
                Loop
            End If
            'end 抓取同筆請款最大分配者資料,因有差額需加於分配於分配點最大者
            
            '更新財務數點數 R026
            'Modify by Amy 2021/08/26 +Frmacc42a0Sec
            If UCase(stFormN) = "FRMACC44R0SEC" Or UCase(stFormN) = "FRMACC42A0SEC" Then intDivisor = 1
            strSql = "Update Accrpt115 a Set R026=(R002*(R019/R021))/" & intDivisor & " Where ID='" & strUserNum & "' And FormN='" & stFormN & "' And R028='2' "
            cnnConnection.Execute strSql, ii
            
            '*** 已收金額>0但已收點數<0,則 已收點數=0 (此處有改需看上方「業務」部分是否也需修改) ***
            'Add by Amy 2021/06/18 ex:11005月 X10914134 FCP-061932
            strSql = "Update Accrpt115 a Set R023=0 Where ID='" & strUserNum & "' And FormN='" & stFormN & "' And R028='2' And R022>0 And R023<0 "
            cnnConnection.Execute strSql, ii
            '*** end 已收金額>0但已收點數<0,則 已收點數=0  ***
            
            'Add by Amy 2021/06/07 分配點數人員為商標處者,此請款單之已收點數=R023(已收點數),並刪除商標處人員且會計科目為 417202
            '                                         ex:1100501-1100531 X11005145 D110051745 FCT-046187 P2001 不顯示,同X單號之對應之藍含青財務點數顯示已收金額
            'Modify by Amy 2021/08/18 +intChoose <> 9,因FCT爭議不可排除(for frmacc24n0-FCT爭議)
            If Left(stDeptS, 2) = "F1" And intChoose <> 9 Then
                strAccWhere = "Select Distinct R003||R010||R011||R024,R003,R024 From Accrpt115,Staff " & _
                                        "Where ID='" & strUserNum & "' And FormN='" & stFormN & "' And R028='2' " & _
                                        "And R018=st01(+) And Substr(st15,1,2)='P2' And R027 is not null "
                'Modify by Amy 2021/11/08 11010月 M11004546 (1公司 D110101432 項次002/003) X11013692 屬於案源B2資料應扣除給律師之費用,而智慧所收再給法律所之金額又以整數算(L公司 D110100067 金額差420)
                '                                             故改抓 Acc1p0 之4字頭(已扣除規費及給律師之費用)
                'strSql = "Update Accrpt115 b Set R026=R023*1000 Where ID='" & strUserNum & "' And R028='2' And R003||R010||R011||R024 In(" & strAccWhere & ") "

                intA = 1
                Set rsA = ClsLawReadRstMsg(intA, strAccWhere)
                If intA = 1 Then
                    rsA.MoveFirst
                    Do While rsA.EOF = False
                        strA2 = "Select * From CaseProgress,LawOfficeSource Where cp60='" & rsA.Fields("R003") & "' And cp09=Los01(+) And Los02='B2' "
                        intA2 = 1
                        Set rsA2 = ClsLawReadRstMsg(intA2, strA2)
                        If intA2 = 1 Then
                            'Modify by Amy 2022/07/07 +a1p23條件 因11106月 FCT040946(1公司 傳票D111062261) M11102749 有不是請款單X11105165 的資料,造成計算不正確
                            strSql = "(Select Sum(a1p08-a1p07) From Acc1p0 Where a1p04='" & rsA.Fields("R024") & "' And a1p23='" & rsA.Fields("R003") & "' " & _
                                         "And SubStr(a1p05,1,1)='4' )*(R019/R021) "
                        Else
                            strSql = "R023*1000"
                        End If
                        'Modfiy by Amy 2022/02/10 +And FormN='" & stFormN & "'
                         strSql = "Update Accrpt115 b Set R026=" & strSql & " Where ID='" & strUserNum & "' And FormN='" & stFormN & "' And R028='2' And R003||R010||R011||R024='" & rsA.Fields(0) & "' "
                        cnnConnection.Execute strSql, ii
                        rsA.MoveNext
                    Loop
                End If
                'end 2021/11/08
                
                '刪除會計科目為417202 且是內商部門
                strSql = "Delete From Accrpt115 Where ID='" & strUserNum & "' And FormN='" & stFormN & "' And R028='2' And R027 is not null "
                cnnConnection.Execute strSql, ii
            End If
            'end 2021/06/07
            'end 2021/04/26
        
            '*** Memo 2021/06/16 抓取組別 ***
            '「有」分配點數的抓分配人員的ST16，無ST16時：
            '   •專利抓案件工程師組別，無組別時才抓CP13之ST16，再無則為其他；
            '   •商標抓CP13之ST16，若無則為其他；
            '「無」分配點數時或是ACC021無ACC1P0時，以AX209之ST16，無ST16：
            '  •有本所案號時：
            '      □專利抓案件工程師組別，無組別時才抓CP13之ST16，再無則為其他；
            '      □商標抓CP13之ST16，若無則為其他；
            '  •無本所案號時列其他
            
            '「有」分配點數人員之st16(R012)於抓資料時,直接寫入暫存檔 ,再判斷「無」分配點數人員(R018)將更新為 ax209,並更新其 st16(R012)/st70(R013)
            '若「專利」先抓專利工程師組別,專利無組別或商標者抓CP13之ST16
            
            '*** 更新 專利 資料 ***
            '工程師組別
            'Modify by Amy 2021/06/10 +判斷st16(R012)為空值才更新,先抓分配人員組別,沒才抓案件工程師組別 ex:邱祐誠(日文組)  P-121524-0-00(化學組)   X11003735   110/05/04 應顯示於日文組
            strSql = "Update Accrpt115 Set R012=(Select pa150 From Patent Where R014=pa01(+) And R015=pa02(+) And R016=pa03(+) And R017=pa04(+)) " & _
                        "Where ID='" & strUserNum & "' And FormN='" & stFormN & "' And R028='2' And R014 in ('P','FCP','CFP') And R012 is null "
            cnnConnection.Execute strSql, ii
            
            strSql = "Update Accrpt115 Set R012=(Select sp79 From ServicePractice Where R014=sp01(+) And R015=sp02(+) And R016=sp03(+) And R017=sp04(+)) " & _
                        "Where ID='" & strUserNum & "' And FormN='" & stFormN & "' And R028='2' And R014 in ('PS','FG','CPS') And R012 is null "
            cnnConnection.Execute strSql, ii
            'end 2021/06/10
            '*** End 更新 專利 資料 ***
         
'            '取得系統別
'            strA = "Select sk01 From SystemKind Where (SK02=2 or sk02=6 ) Order by sk01"
'            intA = 1
'            Set rsA = ClsLawReadRstMsg(intA, strA)
'            If intA = 1 Then
'                Do While rsA.EOF = False
'                    strSysKind = strSysKind & "," & rsA.Fields("sk01")
'                    rsA.MoveNext
'                Loop
'                If strSysKind <> MsgText(601) Then strSysKind = Mid(strSysKind, 2)
'            End If
                
            '分配人員(a1n04) 沒組別者抓 cp13人員(R001)之組別
            'Modify by Amy 2021/04/15 +更新 st70
            'Modify by Amy 2021/06/16 原:And SubStr(R003,1,1)='X' And R014 In ('" & Replace(strSysKind, ",", "','") & "')  限制系統別改不限制
            strSql = "Update Accrpt115 Set R012=(Select st16 From Staff Where R001=st01 ),R013=(Select st70 From Staff Where R001=st01) " & _
                        "Where ID='" & strUserNum & "' And FormN='" & stFormN & "' And R028='2' And R012 is null "
            cnnConnection.Execute strSql, ii
            '*** End Memo 2021/06/16 抓取組別 ***
            
        End If 'intExe(0) + intExe(1)<>0
    End If 'bolProF = True
    'end 2021/04/08
    '*** End 專業點數 ***
  
    '不同表單回傳不同欄位
    strGroup = ""
    Select Case UCase(stFormN)
        'Add by Amy 2021/04/30
        Case "FRMACC24C0"
            'Memo 收款點數更新「專利工程師組別」寫於Frmacc24c0中
            strF = "R001 as cp13,R002 as ax207,R003 as a1k01,R004 as a1k09,R005 as a1k11,R006 as a1k30,R007 as a0y02,R008 as a0y04,R009 as a0z04,R010 as ax201, R011 as ax202" & _
                     ",R012 as st16,R013 as st70,R014 as a1k13,R015 as a1k14,R016 as a1k15,R017 as a1k16,R024 as a0z01,R022 as ReceVal,R023 as ProVal,R025 as Amt "
        Case "FRMACC24N0"
            'Modify by Amy 2021/04/12 +st70/cp13
            strF = "R018 as a1n04,R014 as a1k13,R015 as a1k14,R016 as a1k15,R017 as a1k16,R003 as a1k01,R007 as DDate,R022 as ReceVal,R023 as ProVal,R026 as AccPoint " & _
                    ",R012 as StaffGroup,R013 as Sst70,R001 as cp13 "
        'Add by Amy 2021/05/04
        'Modify by Amy 2021/08/26 +Frmacc42a0SEC
        Case "FRMACC44R0SEC", "FRMACC42A0SEC"
            '商標
            If Left(stDeptS, 2) = "F1" Then
                'R012為null->分配人員R018->收文人員R001
                strF = ",Decode(Nvl(R012,Nvl(R018,R001)),'F4106','2','F4107','4',R012) as st16"
            '專利
            Else
                'R012為null->分配人員R018
                'Modify by Amy 2021/06/11 原:Decode(R012,null,Decode(Nvl(R018,R001),'F4105','3','4'),'3','3','4') as st16
                'ex:11005 FCP-064653 X11004312 分配人員F4102 pa150=Null 應歸於專利國外部
                strF = ",Decode(R012,null,Decode(R018,'F4105','3','4'),R012) as st16"
            End If
            strF = "R026 as ax207,R003 as a1k01,R004 as a1k09,R005 as a1k11,R006 as a1k30,R007 as a0y02,R008 as a0y04,R009 as a0z04,R010 as ax201, R011 as ax202" & _
                      strF & ",R014 as a1k13,R015 as a1k14,R016 as a1k15,R017 as a1k16 "
        Case Else
            strF = "R001 as cp13,R002 as ax207,R003 as a1k01,R004 as a1k09,R005 as a1k11,R006 as a1k30,R007 as DDate,R008 as ExChangeR,R009 as FAmt,R010 as ax201" & _
                     ",R011 as ax202,R012 as StaffGroup,R013 as Sst70,R014 as a1k13,R015 as a1k14,R016 as a1k15,R017 as a1k16,R018 as a1n04,R019 as a1n05,R020 as cp09" & _
                     ",R021 as AllPoint,R022 as ReceVal,R023 as ProVal,R026 as AccPoint "
    End Select
    If bolProF = True Then
        strA = "And R028='2' "
    Else
        strA = "And R028='4' "
    End If
    Pub_GetAccRecePayAmt = "Select " & strF & " From Accrpt115 Where ID='" & strUserNum & "' And FormN='" & stFormN & "' " & strA
    'end 2021/04/27
End Function

'Add By Sindy 2021/6/9
Public Function Pub_EMPTelNumbrandName(strTransUser As String, strSymbol As String) As String
Dim strST02 As String, strST22 As String
   
   strST02 = GetPrjSalesNM(strTransUser, strST22)
   If strST02 <> "" Then
      'ex: #545 楊小姐
      Pub_EMPTelNumbrandName = strSymbol & IIf(strSymbol <> "", Pub_GetStaffExtn(strTransUser), "") & " " & Mid(strST02, 1, 1) & IIf(strST22 = "F", "小姐", "先生")
   Else
      Pub_EMPTelNumbrandName = strTransUser
   End If
End Function

'Add by Amy 2021/06/28 取得CFT組別之主管
'Modify by Amy 2021/06/29 原傳strSystem,strNA01,strCP13,本所案號,strNA01 函數抓 strCP13 若有例外可傳入,否則由函數抓-與Morgan討論結果
Public Function GetCFTSt16Manager(ByVal strCP01 As String, ByVal strCP02 As String, ByVal strCP03 As String, ByVal strCP04 As String, Optional ByVal strCP13 As String = "") As String
    Dim RsQ As New ADODB.Recordset, intQ As Integer
    Dim strQ As String, strNA69 As String, strStaffGroup As String
    Dim strNA01 As String 'Add by Amy 2021/06/29
    
    GetCFTSt16Manager = ""
    
    'Modify by Amy 2021/06/29
    If strCP01 <> "CFT" And strCP01 <> "CFC" And strCP01 <> "S" Then Exit Function
    
    strNA01 = GetPrjNation1(strCP01 & "-" & strCP02 & "-" & strCP03 & "-" & strCP04)
    '智權人員
    If strCP13 = MsgText(601) Then
        strCP13 = PUB_GetAKindSalesNo(strCP01, strCP02, strCP03, strCP04)
    End If
    
    If strCP01 = "CFC" And strNA01 = "101" Then
        '此有改需確認 GetSignOffEmp 是否有改
        strNA69 = Pub_GetSpecMan("CFC案承辦人")
    Else
        '此有改需確認 GetSignOffEmp 是否有改
        Call GetNA69("", strNA01, strCP13, strNA69, strCP01, strCP02, strCP03, strCP04)
    End If
    'end 2021/06/29
    
    '抓取人員組別
    strQ = "Select * From Staff Where st01='" & strNA69 & "' "
    intQ = 1
    Set RsQ = ClsLawReadRstMsg(intQ, strQ)
    If intQ = 1 Then
        strStaffGroup = "" & RsQ.Fields("st16") & RsQ.Fields("st70")
    End If
    '抓取人員組別之系統特殊設定
    If strStaffGroup <> MsgText(601) Then
        strStaffGroup = "CFT" & strStaffGroup
        GetCFTSt16Manager = Pub_GetSpecMan(strStaffGroup)
    End If
    '抓取特殊設定(琬姿及May抓自己)
    If GetCFTSt16Manager = MsgText(601) Then
        strQ = "Select Distinct oMan From setSpecMan Where oCode Like 'CFT6%' And oMan='" & strNA69 & "' "
        intQ = 1
        Set RsQ = ClsLawReadRstMsg(intQ, strQ)
        If intQ = 1 Then
            GetCFTSt16Manager = "" & RsQ.Fields("oMan")
        End If
    End If
    '無任何設定通知秀玲
    If GetCFTSt16Manager = MsgText(601) Then
        GetCFTSt16Manager = Pub_GetSpecMan("程式管理人員")
    End If
   
    Set RsQ = Nothing
End Function

'Add by Amy 2021/07/20 江郁仁是否請假一整天,職代發葉易雲(78011)
Public Function Set98020Ag() As String
    Dim bolIsRest As Boolean, bolRest1Day As Boolean '是請假/是請假一整天
    
    Set98020Ag = ""
    bolIsRest = CheckIsPersonRest("98020", strSrvDate(1), Left(Right("000000" & ServerTime, 6), 2) & ":" & Mid(Right("000000" & ServerTime, 6), 3, 2), , bolRest1Day)
    If bolIsRest = True And bolRest1Day = True Then
        Set98020Ag = ";98020;78011"
    End If
End Function

'Added by Morgan 2021/7/28
'取得翻譯費警示比例(支出/請款)
'In: pPA01~pPA04=本所案號, pDnNo=請款單號
'Out: pIsHigher=是否高於標準(固定報價客戶會有折扣會設較高的比例)
'Modified by Lydia 2021/07/29 例外控制客戶pExcept
Public Function PUB_GetTransFeeRate(Optional ByVal pPA01 As String, Optional ByVal pPA02 As String, Optional ByVal pPA03 As String, Optional ByVal pPA04 As String, _
                    Optional ByVal pDnNo As String, Optional ByRef pIsHigher As Boolean = False, Optional ByVal pExcept As Boolean = False) As Integer
   Dim stSQL As String, intQ As Integer
   Dim rstQ As ADODB.Recordset
   Dim strDNCuNo As String
   
   PUB_GetTransFeeRate = 30 '預設
   
   '請款對象
   If pDnNo <> "" Then '有請款單號
      stSQL = "select a1k28 DnCuNo,a1k13,a1k14,a1k15,a1k16 from acc1k0 where a1k01='" & pDnNo & "'"
   Else
      '未請款抓預設請款對象
      stSQL = "select Nvl(PA88, Nvl(FA30, Nvl(CU57, Nvl(PA75, PA26)))) DnCuNo" & _
         " from patent,customer,fagent where pa01='" & pPA01 & "'" & _
         " and pa02='" & pPA02 & "' and pa03='" & pPA03 & "' and pa04='" & pPA04 & "'" & _
         " and cu01(+)=substr(pa26,1,8) and cu02(+)=substr(pa26,9)" & _
         " and fa01(+)=substr(pa75,1,8) and fa02(+)=substr(pa75,9)"
   End If
   intQ = 1
   Set rstQ = ClsLawReadRstMsg(intQ, stSQL)
   If intQ = 1 Then
      strDNCuNo = "" & rstQ("DnCuNo") '請款對象
      '55% (請款對象)
      'Modified by Morgan 2023/2/22 +Y55640 Evonik Superabsorber GmbH
      'Modified by Lydia 2023/12/08 +Y55912 Evonik Oxeno GmbH & Co. KG  ----婉莘
      If strDNCuNo <> "" And InStr("Y53983000,Y54678000,Y55001000,Y55311000,Y53825000,Y55358000,Y45814010,Y33268010,Y55640000,Y55912000", Left(strDNCuNo, 8)) > 0 Then
         pIsHigher = True
         PUB_GetTransFeeRate = 55
      
      'Added by Morgan 2022/4/13
      ElseIf Left(strDNCuNo, 8) = "Y2304500" Then
         pIsHigher = True
         PUB_GetTransFeeRate = 35
      'end 2022/4/13
      
      '40% (申請人、代理人、請款對象)
      Else
         
         If pDnNo <> "" Then
            pPA01 = "" & rstQ("a1k13")
            pPA02 = "" & rstQ("a1k14")
            pPA03 = "" & rstQ("a1k15")
            pPA04 = "" & rstQ("a1k16")
         End If
         
         stSQL = "select * from patent where pa01='" & pPA01 & "' and pa02='" & pPA02 & "' and pa03='" & pPA03 & "' and pa04='" & pPA04 & "'" & _
            " and exists (select * from addressa4list where aal01='FCPxtr' and instr(pa26||pa27||pa28||pa29||pa30||pa75||'" & strDNCuNo & "',substr(aal04,1,8))>0)"
         intQ = 1
         Set rstQ = ClsLawReadRstMsg(intQ, stSQL)
         If intQ = 1 Then
            pIsHigher = True
            PUB_GetTransFeeRate = 40
         End If
      End If

   End If
   'Added by Lydia 2021/07/29 例外控制客戶;
          'Y46013000 Murgitroyd & Company 因此客戶案件量較大，仍有需交由外翻或翻譯社，故Y46013000此編號只設定以下第1點在外專翻譯分案作業畫面帶入符號*，第2點在分案frm060101_1不控制承辦人編號
   If pIsHigher = True And pExcept = True Then
      'Modified by Lydia 2021/08/09 修正當時email輸錯Y編號, 並且放大範圍為Murgitroyd案設定
      'If InStr("Y46013000,", Left(strDNCuNo, 8)) > 0 Then
      stSQL = Pub_GetSpecMan("外專MURGITROYD設定")
      If InStr(stSQL, Left(strDNCuNo, 8)) > 0 Then
           PUB_GetTransFeeRate = 0
      End If
      'Added by Lydia 2021/09/27 增加特殊設定：外專翻譯分案例外
      stSQL = "select oman from setspecman where ocode='外專翻譯分案例外' and instr(oman," & CNULL(pPA01 & pPA02 & pPA03 & pPA04) & ") > 0 "
      intQ = 1
      Set rstQ = ClsLawReadRstMsg(intQ, stSQL)
      If intQ = 1 Then
          PUB_GetTransFeeRate = 0
      End If
      'end 2021/09/27
   End If
   'end 2021/07/29
End Function


'Add by Amy 2021/08/24 抓取專業點數 (從 Frmacc44r0-秘書用 搬過來,Frmacc42a0也用)
'Modify by Amy 2021/08/25 +stCmp 公司別
Public Sub ProPoint(ByVal stFormN As String, ByVal stYear As String, ByVal stMonth As String, Optional ByVal stWhere1 As String = "", Optional ByVal stWhere2 As String = "", Optional ByVal stCmp As String = "")
    Dim RsQ As New ADODB.Recordset
    Dim StrSQLa As String, strQ As String, intQ As Integer
    Dim i As Integer, intRun As Integer, stWhere As String, stCmd As String 'Add by Amy 2021/08/25
    Dim intExe As Integer 'Add by Amy 2021/09/09
    
    'Modify by Amy 2021/09/30 +if
    If UCase(stFormN) = UCase("Frmacc44r0") Then
        'add by sonia 2016/1/30 6個其他專業部之法務收入科目410110,411107,417203,417103,413102,412102先更新R001='ZZZ',並R006=R004以便GetLawValue計算
        StrSQLa = "update AccRpt44r0 set r001='ZZZ',R006=R004 Where ID='" & strUserNum & "' And R002 IN ('410110','411107','417203','417103','412102','413102') And R001<>'ZZZ' And FormN='" & stFormN & "' "
        cnnConnection.Execute StrSQLa
        'end 2016/1/30
               
        If Val(stYear) < 105 Then '105年以前的資料才要抓法務案, 105年起法務案已改至上面6個科目
            '法務案件抓取資料
            'StrSQLa = "Select '" & strUserNum & "' ,'ZZZ' As No, ax205 As AccNo,Decode(ax214,null,null,SubStr(ax214,1,length(ax214)-9)||'-'||SubStr(ax214,(length(ax214)-9)+1,6) ||'-'||SubStr(ax214,(length(ax214)-3)+1,1)||'-'||SubStr(ax214,(length(ax214)-2)+1,2)) As CaseName," & _
                            "ax206,ax207,ax207-ax206,lc47 From acc020, acc021,LawCase Where ax201=a0201(+) And ax202=a0202(+) " & _
                            "And SubStr(ax214,1,length(ax214)-9)=lc01(+) And SubStr(ax214,(length(ax214)-9)+1,6)=lc02(+) And SubStr(ax214,(length(ax214)-3)+1,1)=lc03(+) And SubStr(ax214,(length(ax214)-2)+1,2)=lc04(+) " & _
                            "And SubStr(ax205,1,4) In('4141','4161','4181') " & stWhere2
            'ADD BY SONIA 2015/9/17 外專外商收文外法案件,科目已改417101或417201,但此報表要歸FCP-法務或FCT-法務
            'modify by sonia 2016/1/26 +6個其他專業部之法務收入科目410110,411107,417203,417103,413102,412102
            StrSQLa = "Select '" & strUserNum & "', '" & stFormN & "' ,'ZZZ' As No, ax205 As AccNo,Decode(ax214,null,null,SubStr(ax214,1,length(ax214)-9)||'-'||SubStr(ax214,(length(ax214)-9)+1,6) ||'-'||SubStr(ax214,(length(ax214)-3)+1,1)||'-'||SubStr(ax214,(length(ax214)-2)+1,2)) As CaseName," & _
                            "ax206,ax207,ax207-ax206,lc47 From acc020, acc021,LawCase Where ax201=a0201(+) And ax202=a0202(+) " & _
                            "And SubStr(ax214,1,length(ax214)-9)=lc01(+) And SubStr(ax214,(length(ax214)-9)+1,6)=lc02(+) And SubStr(ax214,(length(ax214)-3)+1,1)=lc03(+) And SubStr(ax214,(length(ax214)-2)+1,2)=lc04(+) " & _
                            "And (SubStr(ax205,1,4) In('4141','4161','4181') OR (AX205 IN ('417101','417201','410110','411107','417203','417103','413102','412102') And SUBSTR(AX214,1,LENGTH(AX214)-9) IN ('FCL','CFL','LIN'))) " & stWhere2
            StrSQLa = "Insert Into AccRpt44r0 (ID,FormN,R001,R002,R003,R004,R005,R006,R007) " & StrSQLa
            cnnConnection.Execute StrSQLa
            '以Temp檔中之417101,417201之金額去扣417101,417201餘額,以免重覆計算
            StrSQLa = "Update AccRpt44r0 A Set A.R004=(Select A.R004 - NVL(Sum(B.R005),0)+NVL(Sum(B.R004),0) From AccRpt44r0 B Where A.ID=B.ID And A.R002=B.R002 And B.R001='ZZZ' And FormN='" & stFormN & "' ) " & _
                          "Where A.ID='" & strUserNum & "' And A.R002 in ('417101','417201') And A.R001<>'ZZZ' And FormN='" & stFormN & "' "
            cnnConnection.Execute StrSQLa
            'END 2015/9/17
        'Add by Amy 2020/06/04 4141/4161/4181 且非L公司列於一般法務
        'Modify by Amy 2021/01/29 bug 原:Val(Text3) >= 109 And Val(Text4) >= 4
        ElseIf Val(stYear & stMonth) >= 10904 Then
            StrSQLa = "Select '" & strUserNum & "', '" & stFormN & "' ,'ZZZ' As No, ax205 As AccNo,Decode(ax214,null,null,SubStr(ax214,1,length(ax214)-9)||'-'||SubStr(ax214,(length(ax214)-9)+1,6) ||'-'||SubStr(ax214,(length(ax214)-3)+1,1)||'-'||SubStr(ax214,(length(ax214)-2)+1,2)) As CaseName," & _
                            "ax206,ax207,ax207-ax206,lc47 From acc020, acc021,LawCase Where ax201=a0201(+) And ax202=a0202(+) " & _
                            "And SubStr(ax214,1,length(ax214)-9)=lc01(+) And SubStr(ax214,(length(ax214)-9)+1,6)=lc02(+) And SubStr(ax214,(length(ax214)-3)+1,1)=lc03(+) And SubStr(ax214,(length(ax214)-2)+1,2)=lc04(+) " & _
                            "And SubStr(ax205,1,4) In('4141','4161','4181') And ax201<>'L' " & stWhere2
            StrSQLa = "Insert Into AccRpt44r0 (ID,FormN,R001,R002,R003,R004,R005,R006,R007) " & StrSQLa
            cnnConnection.Execute StrSQLa, intQ
            'Add by Amy 2021/05/03 無一般法務資料,將值設0
            If intQ = 0 Then
                StrSQLa = "Update Accrpt44r0 Set R004=0,R005=0,R006=0 Where ID='" & strUserNum & "' And SubStr(R002,1,4) In ('4141','4161','4181') And FormN='" & stFormN & "' "
                cnnConnection.Execute StrSQLa, intQ
            End If
        End If
    End If 'UCase(stFormN) = UCase("Frmacc44r0")
    
    'Modify by Amy 2021/02/26
    '*** 11001月後,顯示實績點數 ***
    'Modify by Amy 2021/08/25 Frmacc42a0 都使用新格式(與 Frmacc44r0-秘書 不同)
    intRun = 1
    If Val(stYear & Format(stMonth, "00")) >= 11001 Then
        '抓取結餘或轉撥資料(含實績轉撥)
        'Add by Amy 2021/09/30 +if
        If UCase(stFormN) = UCase("Frmacc42a0") Then
            'Memo by Amy 2021/10/08 FCT收入-爭議全部列於商標國內專業合計不合理,故於專業達成分佈情況(當月實際達) 拆開,2021/09/30增加之程式可不需要了,故刪除
            'Memo by Amy 2021/09/30 Frmacc42a0專業達成分佈情況(當月實際達)成寫入Accrpt44r0已是排除結餘或轉撥資料
            '                                            但FCT收入-爭議抓417202 TOT值,需再抓傳票資料扣除FCT部門值,故加 if
            Exit Sub
        Else
            StrSQLa = "Select Sum(ax207-ax206) a From Acc020,Acc021 Where ID='" & strUserNum & "' And Length(R002)=6 and InStr(R002,'T')=0 and R002=ax205(+) " & stWhere2 & " And a0201=ax201(+) And a0202=ax202(+) And (InStr(ax213||' ','結餘')>0 or InStr(ax212,'轉撥')>0) Group by R002"
            StrSQLa = "Update Accrpt44r0 Set R008=(" & StrSQLa & ") Where ID='" & strUserNum & "' And Length(R002)=6 and InStr(R002,'T')=0 And FormN='" & stFormN & "' "
            cnnConnection.Execute StrSQLa
        End If
        
        'Add by Amy 2021/05/03 新增保留
        'Modify by Amy 2021/08/25 Frmacc42a0共用
        '公司別
        If stCmp <> MsgText(601) Then
            If InStr(stCmp, "+") > 0 Then
                stCmp = stCmp & " And a0403 In ('" & Replace(stCmp, "+", "','") & "') "
            Else
                stCmp = stCmp & " And a0403 ='" & stCmp & "'"
            End If
        End If
        'If UCase(stFormN) = UCase("Frmacc42a0") Then intRun = 3 'Mark by Amy 2021/09/30 1100826婧瑄:只需顯示實績
        
        'P/CFP/T/CFT 保留/結餘- 4191/4194之部門
        For i = 1 To intRun
            If intRun = 2 Then
                stWhere = " And a0401 In(" & stYear & "," & Val(stYear) - 1 & "," & Val(stYear) - 2 & ") And a0402=" & stMonth & " "
            ElseIf intRun = 3 Then
                stWhere = " And a0401 In(" & stYear & "," & Val(stYear) - 1 & "," & Val(stYear) - 2 & ") And a0402>=1 And a0402<=" & stMonth & " "
            End If
            'Modify by Amy 2021/05/24 會科 4191 11004月有T,故不可全算於P
            'Modify by Amy 2021/09/09 11008月發現D110082572 項次003 4191 部門為W ( 因為會影響秘書專業點數報表,故由W改為P部門),為避免有非TOT資料未顯示,造成秘書專業點數不合故修改 原:a0404 In('P','CFP','T','CFT')
            'Modify by Amy 2022/01/06 11012月增加M0101 D110122441~444 4191 部門為W  會影響秘書專業點數報表,故 4191 or 4194 W部門,列於 創新業務部 - ACS
            strQ = "Select Decode(a0404,'P','4111','CFP','413101','T','4101','CFT','4121','W','420101',a0404) as AccNo,Sum(Nvl(a0408,0)) as a0408 " & _
                        "From Acc040 Where (a0405='4194' Or a0405='4191') And a0404<>'TOT' " & stWhere & stCmp & stWhere1 & _
                        " Group By Decode(a0404,'P','4111','CFP','413101','T','4101','CFT','4121','W','420101',a0404)  "
        'end 2021/08/25
            intQ = 1
            Set RsQ = ClsLawReadRstMsg(intQ, strQ)
            If intQ = 1 Then
                RsQ.MoveFirst
                Do While RsQ.EOF = False
                    StrSQLa = "Update Accrpt44r0 Set R009=" & Val(RsQ.Fields("a0408")) & " Where ID='" & strUserNum & "' And R002='" & RsQ.Fields("AccNo") & "' And FormN='" & stFormN & "' "
                    'Modify by Amy 2021/09/09 有值無更新資料者彈訊息
                    cnnConnection.Execute StrSQLa, intExe
                    If intExe = 0 And Val(RsQ.Fields("a0408")) <> 0 Then
                        MsgBox "會計科目4194 或4191 部門[" & RsQ.Fields("AccNo") & "] 無法列示" & vbCrLf & _
                                      "會造成全所合計不正確!"
                    End If
                    'end 2021/09/09
                    RsQ.MoveNext
                Loop
            End If
        Next i
    End If
    '*** End 11001月後,顯示實績點數 ***
End Sub

'Add by Amy 2021/08/24 抓取F41XX專業點數 (從 Frmacc44r0-秘書用 搬過來,Frmacc42a0也用)
'Add by Amy 2021/05/03 新增F41XX
'Modify by Amy 2021/08/27 +IsPeriod 是起迄(for Frmacc42a0)
Public Sub InsF41XX(ByVal stFormN As String, stDs As String, stDe As String, Optional ByVal IsPeriod As Boolean = False)
    Dim RsQ As New ADODB.Recordset, intQ As Integer
    Dim strQ As String, strIns As String, strFix As String, strFixD As String, strTp As String
    Dim stFCPAll(1) As String, stFCP(1) As String, stFCPSp(1) As String 'FCP所有/結餘+轉撥/保留
    Dim stFCTAll(1) As String, stFCT(1) As String, stFCTSp(1) As String 'FCT所有/結餘+轉撥/保留
    Dim stYM As String 'Add by Amy 2021/08/27 傳票年月
    Dim strQ1 As String, stFCPAll_m(1) As String, stFCP_m(1) As String, stFCPSp_m(1) As String, stFCTAll_m(1) As String, stFCT_m(1) As String, stFCTSp_m(1) As String 'Add by Amy 2021/09/03
   
'Modify by Amy 2021/08/27 +FormN/傳票年月
stYM = stDs '寫入暫存檔之年月
If IsPeriod = True Then
    '是結束寫入月份為13 (for Frmacc42a0)
    stYM = Val(Left(Val(stDe) + 191100, 4)) - 1911 & "13"
End If
strFix = "Insert Into Accrpt44r0 (ID,FormN,R010,R001,R002,R003,R004,R008,R009) Values "
'end 2021/08/27

'Add by Amy 2021/09/03 +if 專業達成點數分佈情況(當月實際達成)-工作表3,11001年後才執行,否則耗時
If UCase(stFormN) <> UCase("Frmacc42a0") Or (UCase(stFormN) = UCase("Frmacc42a0") And Val(stYM) + 191100 >= 202101) Then
    '*** 專利 ***
    '所有Ax207
    'Modify by Amy 2021/05/18 原:Decode(st16,'3','F4104','F4105') 歸錯
    'Modify by Amy 2021/06/11 11005 FCP-064653 X11004312 分配人員F4102 pa150=Null 應歸於專利國外部
    strQ1 = Pub_GetAccRecePayAmt(stFormN & "Sec", stDs & "01", stDe & "31", "F21", "F29", , , , True)
    'Add by Amy 2021/09/03 專業達成點數分佈情況(當月實際達成)-工作表3,需更新當月
    If UCase(stFormN) = UCase("Frmacc42a0") Then
        strQ = "Select Decode(st16,'3','F4105','F4104') as FNo,Sum(ax207) as ax207 " & _
                  "From (" & strQ1 & " And SubStr(R011,1,6)='D" & Format(stDe, "000") & "') " & _
                  "Group by Decode(st16,'3','F4105','F4104') Order by FNo "
        intQ = 1
        Set RsQ = ClsLawReadRstMsg(intQ, strQ)
        If intQ = 1 Then
            Do While Not RsQ.EOF
                If "" & RsQ.Fields("FNo") = "F4104" Then
                    stFCPAll_m(0) = "" & RsQ.Fields("ax207")
                Else
                    stFCPAll_m(1) = "" & RsQ.Fields("ax207")
                End If
                
                RsQ.MoveNext
            Loop
        End If
    End If
    'end 2021/09/03
    strQ = "Select Decode(st16,'3','F4105','F4104') as FNo,Sum(ax207) as ax207 From (" & strQ1 & ") Group by Decode(st16,'3','F4105','F4104') Order by FNo "
    intQ = 1
    Set RsQ = ClsLawReadRstMsg(intQ, strQ)
    If intQ = 1 Then
        Do While Not RsQ.EOF
            If "" & RsQ.Fields("FNo") = "F4104" Then
                stFCPAll(0) = "" & RsQ.Fields("ax207")
            Else
                stFCPAll(1) = "" & RsQ.Fields("ax207")
            End If
            
            RsQ.MoveNext
        Loop
    End If
   
    '結餘+轉撥
    strQ1 = Pub_GetAccRecePayAmt(stFormN & "Sec", stDs & "01", stDe & "31", "F21", "F29", , , , True, 5)
    'Add by Amy 2021/09/03 專業達成點數分佈情況(當月實際達成)-工作表3,需更新當月
    If UCase(stFormN) = UCase("Frmacc42a0") Then
        strQ = "Select Decode(st16,'3','F4105','F4104') as FNo,Sum(ax207) as ax207 " & _
                   "From (" & strQ1 & " And SubStr(R011,1,6)='D" & Format(stDe, "000") & "') " & _
                   "Group by Decode(st16,'3','F4105','F4104') Order by FNo "
        If RsQ.State = adStateOpen Then RsQ.Close
        intQ = 1
        Set RsQ = ClsLawReadRstMsg(intQ, strQ)
        If intQ = 1 Then
            Do While Not RsQ.EOF
                If "" & RsQ.Fields("FNo") = "F4104" Then
                    stFCPSp_m(0) = "" & RsQ.Fields("ax207")
                Else
                    stFCPSp_m(1) = "" & RsQ.Fields("ax207")
                End If
                RsQ.MoveNext
            Loop
        End If
    End If
    'end 2021/09/03
    'Modify by Amy 2021/05/18 原:Decode(st16,'3','F4104','F4105') 歸錯
    'Modify by Amy 2021/06/11 11005 FCP-064653 X11004312 分配人員F4102 pa150=Null 應歸於專利國外部
    strQ = "Select Decode(st16,'3','F4105','F4104') as FNo,Sum(ax207) as ax207 From (" & strQ1 & ") Group by Decode(st16,'3','F4105','F4104') Order by FNo "
    If RsQ.State = adStateOpen Then RsQ.Close
    intQ = 1
    Set RsQ = ClsLawReadRstMsg(intQ, strQ)
    If intQ = 1 Then
        Do While Not RsQ.EOF
            If "" & RsQ.Fields("FNo") = "F4104" Then
                stFCPSp(0) = "" & RsQ.Fields("ax207")
            Else
                stFCPSp(1) = "" & RsQ.Fields("ax207")
            End If
            RsQ.MoveNext
        Loop
    End If
    
    '保留-抓傳票資料
    'Add by Amy 2021/09/03 專業達成點數分佈情況(當月實際達成)-工作表3,需更新當月
    If UCase(stFormN) = UCase("Frmacc42a0") Then
        strQ = GetPoint(1.3, stDe, stDe, , , "F4104", True, stFormN, True) & _
        " Union all " & GetPoint(1.3, stDe, stDe, , , "F4105", True, stFormN, True)
        strTp = "And ax205='4192' And ax204='FCP'"
        strQ = Replace(strQ, "And Not( ax205='4191' or ax205='4192' or ax205='4194')", strTp)
        strQ = Replace(strQ, "And (ax213 Is Null or InStr(ax213||' ','結餘')=0) And InStr(ax212,'轉撥')=0", "And ax201<>'L'")
        intQ = 1
        Set RsQ = ClsLawReadRstMsg(intQ, strQ)
        If intQ = 1 Then
            Do While Not RsQ.EOF
                If "" & RsQ.Fields("V30") = "F4104" Then
                    stFCP_m(0) = "" & RsQ.Fields("V31")
                Else
                    stFCP_m(1) = "" & RsQ.Fields("V31")
                End If
                RsQ.MoveNext
            Loop
        End If
    End If
    'end 2021/09/03
    strQ = GetPoint(1.3, stDs, stDe, , , "F4104", True, stFormN, True) & _
    " Union all " & GetPoint(1.3, stDs, stDe, , , "F4105", True, stFormN, True)
    strTp = "And ax205='4192' And ax204='FCP'"
    strQ = Replace(strQ, "And Not( ax205='4191' or ax205='4192' or ax205='4194')", strTp)
    strQ = Replace(strQ, "And (ax213 Is Null or InStr(ax213||' ','結餘')=0) And InStr(ax212,'轉撥')=0", "And ax201<>'L'")
    intQ = 1
    Set RsQ = ClsLawReadRstMsg(intQ, strQ)
    If intQ = 1 Then
        Do While Not RsQ.EOF
            If "" & RsQ.Fields("V30") = "F4104" Then
                stFCP(0) = "" & RsQ.Fields("V31")
            Else
                stFCP(1) = "" & RsQ.Fields("V31")
            End If
            RsQ.MoveNext
        Loop
    End If
End If 'UCase(stFormN) <> UCase("Frmacc42a0") Or (UCase(stFormN) = UCase("Frmacc42a0") And Val(stYM) + 191100 >= 202101)
'end 2021/09/03

'Modify by Amy 2021/08/27 +FormN/傳票年月
strFixD = "'" & strUserNum & "','" & stFormN & "','" & stYM & "','99'"

'Add by Amy 2021/09/03 專業達成點數分佈情況(當月實際達成)-工作表3,需更新當月
If UCase(stFormN) = UCase("Frmacc42a0") Then
    'F4104 國外部
    strIns = strFix & "(" & Replace(strFixD, stYM, stDe) & ",'F4104'," & CNULL(StaffQuery("F4104")) & "," & Val(stFCPAll_m(0)) & "," & Val(stFCPSp_m(0)) & " ," & Val(stFCP_m(0)) & ")"
    cnnConnection.Execute strIns
    'F4105 日文部
    strIns = strFix & "(" & Replace(strFixD, stYM, stDe) & ",'F4105'," & CNULL(StaffQuery("F4105")) & "," & Val(stFCPAll_m(1)) & "," & Val(stFCPSp_m(1)) & "," & Val(stFCP_m(1)) & ")"
    cnnConnection.Execute strIns
End If
'                                                       R002           R003                                                R004                                        R008                                        R009
'F4104 國外部
strIns = strFix & "(" & strFixD & ",'F4104'," & CNULL(StaffQuery("F4104")) & "," & Val(stFCPAll(0)) & "," & Val(stFCPSp(0)) & " ," & Val(stFCP(0)) & ")"
cnnConnection.Execute strIns
'F4105 日文部
strIns = strFix & "(" & strFixD & ",'F4105'," & CNULL(StaffQuery("F4105")) & "," & Val(stFCPAll(1)) & "," & Val(stFCPSp(1)) & "," & Val(stFCP(1)) & ")"
cnnConnection.Execute strIns
'*** End 專利 ***
    
'Add by Amy 2021/09/03 +if 專業達成點數分佈情況(當月實際達成)-工作表3,11001年後才執行,否則耗時
If UCase(stFormN) <> UCase("Frmacc42a0") Or (UCase(stFormN) = UCase("Frmacc42a0") And Val(stYM) + 191100 >= 202101) Then
     '*** 商標 ***
    '所有Ax207
    strQ1 = Pub_GetAccRecePayAmt(stFormN & "Sec", stDs & "01", stDe & "31", "F11", "F19", , , , True)
    'Add by Amy 2021/09/03 專業達成點數分佈情況(當月實際達成)-工作表3,需更新當月
    If UCase(stFormN) = UCase("Frmacc42a0") Then
        strQ = "Select Decode(st16,'4','F4107','F4106') as FNo,Sum(ax207) as ax207 " & _
                  "From (" & strQ1 & " And SubStr(R011,1,6)='D" & Format(stDe, "000") & "') " & _
                  "Group by Decode(st16,'4','F4107','F4106') Order by FNo "
        intQ = 1
        Set RsQ = ClsLawReadRstMsg(intQ, strQ)
        If intQ = 1 Then
            Do While Not RsQ.EOF
                If "" & RsQ.Fields("FNo") = "F4106" Then
                    stFCTAll_m(0) = "" & RsQ.Fields("ax207")
                Else
                    stFCTAll_m(1) = "" & RsQ.Fields("ax207")
                End If
                RsQ.MoveNext
            Loop
        End If
    End If
    'end 2021/09/03
    'Modify by Amy 2021/06/11 原:Decode(st16,'2','F4106','F4107') 有F4103歸英文組
    strQ = "Select Decode(st16,'4','F4107','F4106') as FNo,Sum(ax207) as ax207 From (" & strQ1 & ") Group by Decode(st16,'4','F4107','F4106') Order by FNo "
    intQ = 1
    Set RsQ = ClsLawReadRstMsg(intQ, strQ)
    If intQ = 1 Then
        Do While Not RsQ.EOF
            If "" & RsQ.Fields("FNo") = "F4106" Then
                stFCTAll(0) = "" & RsQ.Fields("ax207")
            Else
                stFCTAll(1) = "" & RsQ.Fields("ax207")
            End If
            RsQ.MoveNext
        Loop
    End If
    '結餘+轉撥
    strQ1 = Pub_GetAccRecePayAmt(stFormN & "Sec", stDs & "01", stDe & "31", "F11", "F19", , , , True, 5)
    'Add by Amy 2021/09/03 專業達成點數分佈情況(當月實際達成)-工作表3,需更新當月
    If UCase(stFormN) = UCase("Frmacc42a0") Then
        strQ = "Select Decode(st16,'4','F4107','F4106') as FNo,Sum(ax207) as ax207 " & _
                  "From (" & strQ1 & " And SubStr(R011,1,6)='D" & Format(stDe, "000") & "') " & _
                  "Group by Decode(st16,'4','F4107','F4106') Order by FNo "
        If RsQ.State = adStateOpen Then RsQ.Close
        intQ = 1
        Set RsQ = ClsLawReadRstMsg(intQ, strQ)
        If intQ = 1 Then
            Do While Not RsQ.EOF
                If "" & RsQ.Fields("FNo") = "F4106" Then
                    stFCTSp_m(0) = "" & RsQ.Fields("ax207")
                Else
                    stFCTSp_m(1) = "" & RsQ.Fields("ax207")
                End If
                RsQ.MoveNext
            Loop
        End If
    End If
    'end 2021/09/03
    'Modify by Amy 2021/06/11 原:Decode(st16,'2','F4106','F4107') 有F4103歸英文組
    strQ = "Select Decode(st16,'4','F4107','F4106') as FNo,Sum(ax207) as ax207 From (" & strQ1 & ") Group by Decode(st16,'4','F4107','F4106') Order by FNo "
    If RsQ.State = adStateOpen Then RsQ.Close
    intQ = 1
    Set RsQ = ClsLawReadRstMsg(intQ, strQ)
    If intQ = 1 Then
        Do While Not RsQ.EOF
            If "" & RsQ.Fields("FNo") = "F4106" Then
                stFCTSp(0) = "" & RsQ.Fields("ax207")
            Else
                stFCTSp(1) = "" & RsQ.Fields("ax207")
            End If
            RsQ.MoveNext
        Loop
    End If
    
    '保留-抓傳票資料
    'Add by Amy 2021/09/03 專業達成點數分佈情況(當月實際達成)-工作表3,需更新當月
    If UCase(stFormN) = UCase("Frmacc42a0") Then
        strQ = GetPoint(1.3, stDs, stDe, , , "F4106", True, stFormN, True) & _
        " Union all " & GetPoint(1.3, stDe, stDe, , , "F4107", True, stFormN, True)
        strTp = "And ax205='4192' And ax204='FCT'"
        strQ = Replace(strQ, "And Not( ax205='4191' or ax205='4192' or ax205='4194')", strTp)
        strQ = Replace(strQ, "And (ax213 Is Null or InStr(ax213||' ','結餘')=0) And InStr(ax212,'轉撥')=0", "And ax201<>'L'")
        intQ = 1
        Set RsQ = ClsLawReadRstMsg(intQ, strQ)
        If intQ = 1 Then
            Do While Not RsQ.EOF
                If "" & RsQ.Fields("V30") = "F4106" Then
                    stFCT_m(0) = "" & RsQ.Fields("V31")
                Else
                    stFCT_m(1) = "" & RsQ.Fields("V31")
                End If
                RsQ.MoveNext
            Loop
        End If
    End If
    'end 2021/09/03
    strQ = GetPoint(1.3, stDs, stDe, , , "F4106", True, stFormN, True) & _
    " Union all " & GetPoint(1.3, stDs, stDe, , , "F4107", True, stFormN, True)
    strTp = "And ax205='4192' And ax204='FCT'"
    strQ = Replace(strQ, "And Not( ax205='4191' or ax205='4192' or ax205='4194')", strTp)
    strQ = Replace(strQ, "And (ax213 Is Null or InStr(ax213||' ','結餘')=0) And InStr(ax212,'轉撥')=0", "And ax201<>'L'")
    intQ = 1
    Set RsQ = ClsLawReadRstMsg(intQ, strQ)
    If intQ = 1 Then
        Do While Not RsQ.EOF
            If "" & RsQ.Fields("V30") = "F4106" Then
                stFCT(0) = "" & RsQ.Fields("V31")
            Else
                stFCT(1) = "" & RsQ.Fields("V31")
            End If
            RsQ.MoveNext
        Loop
    End If
End If 'UCase(stFormN) <> UCase("Frmacc42a0") Or (UCase(stFormN) = UCase("Frmacc42a0") And Val(stYM) + 191100 >= 202101)
'end 2021/09/03
   
'Modify by Amy 2021/08/27 +FormN/傳票年月
strFixD = "'" & strUserNum & "','" & stFormN & "','" & stYM & "','39'"

'Add by Amy 2021/09/03 專業達成點數分佈情況(當月實際達成)-工作表3,需更新當月
If UCase(stFormN) = UCase("Frmacc42a0") Then
    'F4106 英文組
    strIns = strFix & "(" & Replace(strFixD, stYM, stDe) & ",'F4106'," & CNULL(Replace(StaffQuery("F4106"), "ＦＣＴ", "FCT")) & "," & Val(stFCTAll_m(0)) & "," & Val(stFCTSp_m(0)) & "," & Val(stFCT_m(0)) & ")"
    cnnConnection.Execute strIns
    'F4107 日文組
    strIns = strFix & "(" & Replace(strFixD, stYM, stDe) & ",'F4107'," & CNULL(Replace(StaffQuery("F4107"), "ＦＣＴ", "FCT")) & "," & Val(stFCTAll_m(1)) & "," & Val(stFCTSp_m(1)) & "," & Val(stFCT_m(1)) & ")"
    cnnConnection.Execute strIns
End If
'Modify by Amy 2021/05/13 ＦＣＴ改半型-美珍
'                                                       R002           R003                                                                                                    R004                                  R008                                  R009
'F4106 英文組
strIns = strFix & "(" & strFixD & ",'F4106'," & CNULL(Replace(StaffQuery("F4106"), "ＦＣＴ", "FCT")) & "," & Val(stFCTAll(0)) & "," & Val(stFCTSp(0)) & "," & Val(stFCT(0)) & ")"
cnnConnection.Execute strIns
'F4107 日文組
strIns = strFix & "(" & strFixD & ",'F4107'," & CNULL(Replace(StaffQuery("F4107"), "ＦＣＴ", "FCT")) & "," & Val(stFCTAll(1)) & "," & Val(stFCTSp(1)) & "," & Val(stFCT(1)) & ")"
cnnConnection.Execute strIns
'*** End 商標 ***

Set RsQ = Nothing
End Sub

'Add by Amy 2021/09/17 從frm210152搬過來修改
Public Function GetMaxSP01(Optional ByVal bolNotTW As Boolean = False) As String
    Dim RsQ As New ADODB.Recordset
    Dim strQ As String
    Dim intQ As Integer
    
    GetMaxSP01 = ""
    strQ = "-191100"
    If bolNotTW = True Then strQ = ""
    
    strQ = "Select Max(SP01" & strQ & ") as SP01 From SalesPoint "
    intQ = 1
    Set RsQ = ClsLawReadRstMsg(intQ, strQ)
    If intQ = 1 Then
        GetMaxSP01 = "" & RsQ.Fields("SP01")
    End If
    RsQ.Close
    Set RsQ = Nothing
End Function

'Add by Amy 2021/09/22 結餘資料有修改寫Tag (Axb16)
'Modify by Amy 2022/06/09 +stMsg (空白=show訊息,有值=回傳訊息)
Public Function WirteAxb16(ByVal stYM As String, ByVal stVal As String, Optional ByRef stMsg As String = "") As Boolean
    Dim stCmd As String, intRun As Integer
    Dim bolShowMsg As Boolean 'Add by Amy 2022/06/09
    
    'Modify by Amy 2022/06/09
    bolShowMsg = True
    If stMsg <> MsgText(601) Then bolShowMsg = False: stMsg = ""
    'end 2022/06/09
    WirteAxb16 = False
    If stYM = MsgText(601) Then
        'Modify by Amy 2022/06/09 +bolShowMsg
        stMsg = "寫入結餘資料Tag年月為空,請洽電腦中心"
        If bolShowMsg = True Then MsgBox stMsg, , "警告！"
        'end 2022/06/09
        Exit Function
    End If
    stCmd = "Update Acc0b1 Set Axb16=" & CNULL(stVal) & " Where Axb01=" & Val(stYM) '民國年月
    cnnConnection.Execute stCmd, intRun
    If intRun > 0 Then
        WirteAxb16 = True
    Else
        'Modify by Amy 2022/06/09 +bolShowMsg
        stMsg = "寫入結餘資料Tag有誤,請洽電腦中心"
        If bolShowMsg = True Then MsgBox stMsg, , "警告！"
        'end 2022/06/09
        Exit Function
    End If
End Function

'Add by Amy 2021/09/22 抓取客戶/代理人名稱,stCU13="Y",回傳智權人員
Public Function ChkCusAgent(ByVal stNo As String, ByRef stName As String, Optional ByRef stCU13 As String = "") As Boolean
    Dim rsTmp As New ADODB.Recordset
    Dim stQ As String, intQ As Integer
    
    ChkCusAgent = False: stName = ""
    intQ = 1

    stQ = "Select Nvl(CU04,Nvl(CU05,CU06)),CU13 From Customer Where CU01='" & stNo & "' And CU02='0' " & _
    "Union Select NVL(fa04,Decode(fa05,null,fa06,fa05||' '||fa63||' '||fa64||' '||fa65)),'' From FAgent Where FA01='" & stNo & "' And FA02='0' "
    Set rsTmp = ClsLawReadRstMsg(intQ, stQ)
    
    If intQ = 1 Then
        '中->英->日
        stName = "" & rsTmp.Fields(0)
        If stCU13 = "Y" Then
            stCU13 = "" & rsTmp.Fields(1)
        End If
        ChkCusAgent = True
    End If
    
    Set rsTmp = Nothing
End Function

'Add by Amy 2021/09/23 實績保留傳票產生後,又新增/修改實績傳票(當月實績)
'intChoose-1:傳入實績保留傳票起迄 / 2:抓取實績保留傳票起迄
'stVoucher_ACS:ACS期末實績傳票號碼 'Modify by Amy 2023/04/17
Public Function HasActualP(ByVal intChoose As Integer, ByVal stYM As String, Optional ByVal stVoucher_S As String = "", Optional ByVal stVoucher_E As String = "", Optional ByVal stVoucher_ACS As String = "") As Boolean
    Dim rsTmp As New ADODB.Recordset, intQ As Integer
    Dim strAxb(4 To 8) As String
    Dim strQ As String, strWhere As String, stAccDT As String, stSPDT As String
    Dim strAxb17(0) As String 'Add by Amy 2023/04/17
    
    HasActualP = False
    
    If intChoose = 2 Then
        Call bolAcc0b1(1, stYM, strAxb()) '抓取實績保留傳票起迄
        stVoucher_S = strAxb(4)
        stVoucher_E = strAxb(5)
        'Add by Amy 2023/04/17 ACS期末實績傳票號碼
        Call bolAcc0b1(9, stYM, strAxb17())
        stVoucher_ACS = strAxb17(0)
        'end 2023/04/17
    End If
    If stVoucher_S = MsgText(601) Then Exit Function
    
    'Modify by Amy 2023/04/17 +if
    If stVoucher_ACS = MsgText(601) Then
        strWhere = " And A0201='1' And A0202>='" & stVoucher_S & "' And A0202<='" & stVoucher_E & "' "
    Else
        strWhere = " And A0201='1' And ((A0202>='" & stVoucher_S & "' And A0202<='" & stVoucher_E & "') Or A0202='" & stVoucher_ACS & "') "
    End If
    
    '取得實績保留傳票修改時間(期末傳票都做在1公司)
    strQ = "Select Max(Decode(A0209||A0210,null,A0206||Decode(length(A0207),5,'0'||A0207,A0207),A0209||Decode(length(A0210),5,'0'||A0210,A0210))) as DT " & _
               "From Acc020 Where " & Mid(strWhere, 5)
    intQ = 1
    Set rsTmp = ClsLawReadRstMsg(intQ, strQ)
    If intQ = 1 Then
        stAccDT = "" & rsTmp.Fields("DT")
    End If
    rsTmp.Close
    'Memo 取得智權輸入實績轉撥不會從傳票輸入產生(不需判斷)
       
    '實績傳票資料最晚新增or修改時間
    strQ = Replace(GetPoint(1.3, stYM, stYM, , , , , , True), "Group by ax209", "")
    strQ = Replace(strQ, "ax209 V30, Sum(ax207-ax206) V31", "ax201,ax202,Decode(Nvl(A0209,0),0,A0206||DECODE(length(A0207),5,'0'||A0207,A0207),A0209||DECODE(length(A0210),5,'0'||A0210,A0210)) as DT")
    'Modify by Amy 2023/04/17 ACS當月收款可能做 1 or J公司傳票
    'strQ = strQ & " And A0201='1' And A0202 Not In(Select A0201||A0202 From Acc020 Where " & Mid(strWhere, 5) & ") "
    strQ = strQ & " And A0201<>'L' And A0201||A0202 Not In(Select A0201||A0202 From Acc020 Where A0201='1' " & strWhere & ") " & _
              " And Decode(Nvl(A0209,0),0,A0206||DECODE(length(A0207),5,'0'||A0207,A0207),A0209||DECODE(length(A0210),5,'0'||A0210,A0210)) >'" & stAccDT & "' "

    intQ = 1
    Set rsTmp = ClsLawReadRstMsg(intQ, strQ)
    If intQ = 1 Then
        HasActualP = True
    End If
    rsTmp.Close
End Function

'Add by Amy 2021/10/04 從客戶案件總簿搬過來
'抓取 A類最新進度的案件性質 GetCaseProgress_NewA(申請國家,系統別,流水號,追加號,多國碼)
Public Function GetCaseProgress_NewA(ByRef AppCountry As String, ByRef Str01 As String, ByRef Str02 As String, ByRef Str03 As String, ByRef Str04 As String) As String
    Dim strField As String
    Dim strTmp As String, intA As Integer, rsAD As New ADODB.Recordset 'Added by Lydia 2024/05/15
    
    GetCaseProgress_NewA = ""
    
    If AppCountry = "000" Then
        strField = "NVL(Nvl(cpm03,Nvl(CPM10,CPM13)),CP10) CP10Name "
    Else
        strField = "NVL(Nvl(cpm04,Nvl(CPM10,CPM13)),CP10) CP10Name "
    End If
    
    'Modify by Amy 2021/10/07 原以CP09 Desc排序,改抓收文號最小(彥葶Run資策會報表)-秀玲:總簿也改
    strTmp = "Select " & strField & ",CP09 From CaseProgress,CasePropertyMap Where CP09 <'B' And Cp57 is null " & _
                     "And CP01='" & Str01 & "' And CP02='" & Str02 & "' And CP03='" & Str03 & "' And CP04='" & Str04 & "' " & _
                     "And CP01=CPM01(+) And CP10=CPM02(+) Order by CP05 Desc,CP09 Asc"
    intA = 1
   Set rsAD = ClsLawReadRstMsg(intA, strTmp)
   If intA = 1 Then
        rsAD.MoveFirst
        GetCaseProgress_NewA = rsAD.Fields("CP10Name") & PUB_GetRelateCasePropertyName(rsAD.Fields("CP09"), "1")
   End If
   Set rsAD = Nothing 'Added by Lydia 2024/05/15

End Function

'Added by Lydia 2021/11/11 若為內商離職人員特別區分通知人員
Public Function PUB_GetManP2(ByVal pST01 As String) As String
Dim intQ As Integer, stQuery As String
Dim rsQ1 As New ADODB.Recordset
   
    PUB_GetManP2 = ""
    stQuery = "select st04,st15,st05,a0908 From staff, acc090 where st01='" & pST01 & "' and st15=a0901(+) "
    intQ = 1
    Set rsQ1 = ClsLawReadRstMsg(intQ, stQuery)
    If intQ = 1 Then
        If "" & rsQ1.Fields("st04") = "1" Then
             PUB_GetManP2 = pST01
        Else
             If Left("" & rsQ1.Fields("st15"), 2) = "P2" Then
                If "" & rsQ1.Fields("st05") = "93" Then '程序人員93->林桂英
                     PUB_GetManP2 = "79041"
                ElseIf "" & rsQ1.Fields("st05") = "95" Then  '商申人員95->林嘉雯
                     PUB_GetManP2 = "84027"
                ElseIf "" & rsQ1.Fields("st05") = "97" Then '商爭人員97->林承慧
                     PUB_GetManP2 = "86048"
                Else
                     PUB_GetManP2 = "" & rsQ1.Fields("a0908")
                End If
             Else
                 PUB_GetManP2 = "" & rsQ1.Fields("a0908")
             End If
        End If
    End If
    Set rsQ1 = Nothing
End Function

'Add by Amy 2021/11/11 非S部門之每月點數需輸之員編
Public Function GetInputPointData(ByVal intChoose As Integer, ByVal stNo As String, Optional ByRef stDeptList As String = "", Optional ByRef intCnt As Integer = 0) As Boolean
    Dim RsQ As New ADODB.Recordset
    Dim intQ As Integer, strQ As String
    
    GetInputPointData = False: stDeptList = "": intCnt = 0
    
    strQ = " And a0901=st15(+) And st01 In('" & Replace(智權點數實績與結餘特殊員編, ";", "','") & "') "
    strQ = "Select a0901 From Acc090,Staff Where a0918='" & stNo & "' " & strQ & _
    "Union Select a0901 From Acc090,Staff Where a0908='" & stNo & "' " & strQ
   'Modify by Amy 2025/08/04 以部門排序,智權部排前面-秀玲
    strQ = "Select * From (" & strQ & ") Order by Decode(Substr(a0901,1,1),'S',2,1) ,a0901 Desc"
            
    intQ = 1
    Set RsQ = ClsLawReadRstMsg(intQ, strQ)
    If intQ = 1 Then
        GetInputPointData = True
        intCnt = RsQ.RecordCount
        Do While Not RsQ.EOF
            stDeptList = stDeptList & ";" & RsQ.Fields(0)
            RsQ.MoveNext
        Loop
        If stDeptList <> MsgText(601) Then
            stDeptList = Mid(stDeptList, 2)
        End If
    End If
    Set RsQ = Nothing
End Function

'Add by Amy 2021/11/12 抓取每月點數輸入ST14設定
'intChoose:1-登入者為「智權點數實績與結餘特殊員編」輸入者,傳回資料
'                2-以部門抓取需輸入之員編
'intDeptCnt:回傳部門筆數
'stInputDept:回傳部門
'stInputID:回傳需輸入之員編
'bolDeptNoRepeat:不抓重覆部門'Add by Amy 2021/11/16
Public Function GetInputPointST14Data(intChoose As Integer, stNo As String, Optional ByRef intDeptCnt As Integer, Optional ByRef stInputDept As String, Optional ByRef stInputID As String, Optional ByVal bolDeptNoRepeat As Boolean = False) As Boolean
    Dim RsQ As New ADODB.Recordset
    Dim intQ As Integer, strQ As String, strWhere As String
    
    GetInputPointST14Data = False: intDeptCnt = 0: stInputDept = "": stInputID = ""
    
    strWhere = " And InStr(st14,'" & stNo & "')>0 "
    If intChoose = 2 Then
        strWhere = " And st15='" & stNo & "' "
    End If
    'Modify by Amy 2025/08/04 以部門排序,智權部排前面-秀玲
    strQ = "Select st15,st01,st14 From Staff Where st01 In('" & Replace(智權點數實績與結餘特殊員編, ";", "','") & "') " & strWhere & _
               " Order by Decode(Substr(st15,1,1),'S',2,1) ,st15 Desc"
            
    intQ = 1
    Set RsQ = ClsLawReadRstMsg(intQ, strQ)
    If intQ = 1 Then
        GetInputPointST14Data = True
        If bolDeptNoRepeat = False Then intDeptCnt = RsQ.RecordCount  'Modify by Amy 2021/11/16
        Do While Not RsQ.EOF
            'Add by Amy 2021/11/16 +部門重覆不抓
            If bolDeptNoRepeat = False Or (bolDeptNoRepeat = True And InStr(stInputDept, ";" & RsQ.Fields("st15")) = 0) Then
                stInputDept = stInputDept & ";" & RsQ.Fields("st15")
                intDeptCnt = intDeptCnt + 1
            End If
            stInputID = stInputID & ";" & RsQ.Fields("st01")
            RsQ.MoveNext
        Loop
        If stInputDept <> MsgText(601) Then
            stInputDept = Mid(stInputDept, 2)
            stInputID = Mid(stInputID, 2)
        End If
    End If
    Set RsQ = Nothing
End Function

'Added by Morgan 2022/1/7
'移除 2.0 ListBox 被選取的項目並回傳剩餘項目的編號字串
'pItemDataStr:原列項目的編號字串
Public Function PUB_RemoveListBox2(pListBox As Object, pItemDataStr As String) As String
   Dim idx As Integer, strTmp As String
   If pListBox.ListCount > 0 Then
      strTmp = "," & pItemDataStr
      For idx = pListBox.ListCount - 1 To 0 Step -1
         If pListBox.Selected(idx) = True Then
            strTmp = Replace(strTmp, "," & PUB_GetItemData(pItemDataStr, idx), "")
            pListBox.RemoveItem idx
            'Added by Morgan 2022/1/11 因若屬性為單選時會自動選取上一個項目會導致全部被刪除，故移除後需將索引設為-1(無勾選)
            If pListBox.MultiSelect = 0 Then
               pListBox.ListIndex = -1
               Exit For
            End If
            'end 2022/1/11
         End If
      Next
      'Added by Lydia 2022/04/18 已無選取項
      If strTmp = "," Then
          PUB_RemoveListBox2 = ""
      Else
      'end 2022/04/18
          PUB_RemoveListBox2 = Mid(strTmp, 2)
      End If   'Added by Lydia 2022/04/18
   End If
End Function

'Added by Morgan 2022/3/14
'修正TextBox2.0顯示異常問題
Public Sub PUB_RefreshText(pTextBox As MSForms.TextBox)
   Dim iPos As Integer
   If pTextBox <> "" And pTextBox.Enabled = True Then
      iPos = pTextBox.SelStart
      If iPos < Len(pTextBox) Then
         pTextBox.SelLength = Len(pTextBox) - iPos
         pTextBox.SelStart = 0
         pTextBox.SelStart = iPos
      End If
   End If
End Sub

'Add by Amy 2022/04/12 傳票列印用(從Account aacc_fun搬過來加Finance傳票)
'以Excel 列印傳票
Public Function PrintVoucherExcel(stFromN As String, stCmp As String, stNo1 As String, stNo2 As String, Optional ByVal stCmpN As String = "") As Boolean
    Dim stField, intWidth
    Dim Ado020 As New ADODB.Recordset
    Dim Xls As New Excel.Application, Wks As New Worksheet
    Dim strWkName As String '工作表名稱為中文
    Dim lngAllCnt As Long
    Dim stQ As String, stWhere As String, strFileName As String, strText As String, stCmpName As String, stOldVNo As String
    Dim i As Integer, j As Integer, intTitle(1) As Integer, intField As Integer, intTmp As Integer, intR As Integer, intCnt As Integer
    Dim bolPrinter As Boolean, strFontSize As Variant
    Dim stMaxAx203 As String 'Add by Amy 2022/02/07 最後一筆明細序號
    Dim strFormat As String 'Add by Amy 2022/03/18
    Dim strShowField As String 'Add by Amy 2022/04/12 框線顯示起始欄
   
On Error GoTo ErrHand
   
    PrintVoucherExcel = False
    If UCase(stFromN) = UCase("Finance") Then
        ReDim stField(5): ReDim intWidth(5)
        stField = Array(" ", "會 計 科 目", "部門", "借 方 金 額", "貸 方 金 額", "摘　　　　要")
        intWidth = Array(2, 24.25, 5.5, 13.25, 13.25, 32)
        stCmpName = stCmpN
        stWhere = " And a0301='" & stCmp & "' And a0302>='" & stNo1 & "' And a0302<='" & stNo2 & "' "
        stQ = "Select * From Acc030 Where 1=1 " & stWhere
    Else
        ReDim stField(4): ReDim intWidth(4)
        stField = Array("會 計 科 目", "部門", "借 方 金 額", "貸 方 金 額", "摘　　　　要")
        intWidth = Array(26.25, 5.5, 13.25, 13.25, 32)
        stCmpName = A0802Query(stCmp)
        stWhere = " And a0201='" & stCmp & "' And a0202>='" & stNo1 & "' And a0202<='" & stNo2 & "' "
        stQ = "Select * From Acc020 Where 1=1 " & stWhere
    End If
    
    If Ado020.State = adStateOpen Then Ado020.Close
    Ado020.CursorLocation = adUseClient
    Ado020.Open stQ, adoTaie, adOpenStatic, adLockReadOnly
    If Ado020.RecordCount = 0 Then
        Exit Function
    Else
        lngAllCnt = Ado020.RecordCount '以傳票號記錄總筆數
    End If
    
    If UCase(stFromN) = UCase("Finance") Then
        stQ = "Select * From (" & _
                 "Select a0302 as VNo,a0305+19110000 as VDate,ax315,a0102 as AccName,ax304 as Dep,ax306 as Debit,ax307 as Credit,ax312 as Memo,ax303 as ax203 " & _
                 "From Acc030,Acc031,Acc011 Where 1=1 " & stWhere & " And a0301=ax301(+) And a0302=ax302(+) And  ax305=a0101(+) " & _
        "Union Select a0302 as VNo,a0305+19110000 as VDate,'' as ax315,'ZZZ' as AccName,'' as Dep,Sum(ax306) as Debit,Sum(ax307) as Credit,'' as Memo,'999999' as ax203 " & _
                  "From Acc030,Acc031 Where 1=1 " & stWhere & " And a0301=ax301(+) And a0302=ax302(+) Group by a0302,a0305 " & _
               ") Order by VNo,ax203"
    Else
        stQ = "Select * From (" & _
                 "Select a0202 as VNo,a0205+19110000 as VDate,a0102 as AccName,ax204 as Dep,ax206 as Debit,ax207 as Credit,ax212 as Memo,ax203 " & _
                 "From Acc020,Acc021,Acc010 Where 1=1 " & stWhere & " And a0201=ax201(+) And a0202=ax202(+) And  ax205=a0101(+) " & _
        "Union Select a0202 as VNo,a0205+19110000 as VDate,'ZZZ' as AccName,'' as Dep,Sum(ax206) as Debit,Sum(ax207) as Credit,'' as Memo,'999999' as ax203 " & _
                  "From Acc020,Acc021 Where 1=1 " & stWhere & " And a0201=ax201(+) And a0202=ax202(+) Group by a0202,a0205 " & _
               ") Order by VNo,ax203"
    End If
    If Ado020.State = adStateOpen Then Ado020.Close
    Ado020.CursorLocation = adUseClient
    Ado020.Open stQ, adoTaie, adOpenStatic, adLockReadOnly
    If Ado020.RecordCount = 0 Then
        MsgBox "讀取傳票資料有誤,請洽電腦中心"
        Exit Function
    End If
    
    intField = 65:  intR = 1
    If UCase(stFromN) = UCase("Finance") Then strFileName = "Finance-"
    strFileName = "傳票資料列印-" & strFileName & stCmp & MsgText(43)
    If Dir(strExcelPath & strFileName) = MsgText(601) Then
        If Dir(Mid(strExcelPath, 1, Len(strExcelPath) - 1), vbDirectory) = MsgText(601) Then
            MkDir strExcelPath
       End If
    Else
       Kill strExcelPath & strFileName
    End If
    Xls.Workbooks.add
    '工作表名稱改為中文
    If strWkName = MsgText(601) Then strWkName = Left(Xls.Worksheets(1).Name, Len(Xls.Worksheets(1).Name) - 1)
    Set Wks = Xls.Worksheets(strWkName & "1")
    Xls.Visible = False
    If Val(Xls.Version) < 12 Then
        Xls.Workbooks(1).SaveAs FileName:=strExcelPath & strFileName, FileFormat:=-4143
    Else
        Xls.Workbooks(1).SaveAs FileName:=strExcelPath & strFileName, FileFormat:=56
    End If
    
    '*** 畫表格 ***
    With Wks
        '設定
        .PageSetup.Orientation = xlPortrait '直印
        .PageSetup.Zoom = 100 '縮放比例為100%,列印頁面水平置中
        .PageSetup.CenterHorizontally = True
        
        .PageSetup.HeaderMargin = Application.InchesToPoints(0) '頁首
        .PageSetup.FooterMargin = Application.InchesToPoints(0) '頁尾
        .PageSetup.TopMargin = Xls.InchesToPoints(0) '上
        .PageSetup.BottomMargin = Xls.InchesToPoints(0) '下
        .PageSetup.LeftMargin = Xls.InchesToPoints(0.4) '左邊界
        .PageSetup.RightMargin = Xls.InchesToPoints(0.4) '右邊界
            
        strShowField = Chr(VoucherGetValue("會 計 科 目", stField) + intField)
        
        For i = 0 To 1
            If i = 0 Then
                intTmp = intR '上表起始列
            Else
                intTmp = intR + 25 '下表起始列
            End If
            .Range(strShowField & intTmp).Font.Size = 20
            .Range(strShowField & intTmp).Value = stCmpName
            .Range(strShowField & intTmp & ":" & Chr(UBound(stField) + intField) & intTmp).HorizontalAlignment = xlCenter
            .Range(strShowField & intTmp & ":" & Chr(UBound(stField) + intField) & intTmp).MergeCells = True
            intTmp = intTmp + 1: intTitle(i) = intTmp
            
            .Range(strShowField & intTmp).Font.Size = 20
            'Mark by Amy 2024/07/18 底線會壓在字上,故不使用
            '.Range(strShowField & intTmp).Font.Underline = xlUnderlineStyleSingle '底線
            .Range(strShowField & intTmp).Value = "會計傳票"
            .Range(strShowField & intTmp & ":" & Chr(UBound(stField) + intField) & intTmp).HorizontalAlignment = xlCenter
            .Range(strShowField & intTmp & ":" & Chr(UBound(stField) + intField) & intTmp).MergeCells = True
            intTmp = intTmp + 1: intTitle(i) = intTmp
            
            '日期
            .Range(strShowField & intTmp).Font.Size = 12
            .Range(strShowField & intTmp & ":" & Chr(VoucherGetValue("貸 方 金 額", stField) + intField) & intTmp).HorizontalAlignment = xlRight
            .Range(strShowField & intTmp & ":" & Chr(VoucherGetValue("貸 方 金 額", stField) + intField) & intTmp).MergeCells = True
            '傳票號
            .Range(Chr(VoucherGetValue("摘　　　　要", stField) + intField) & intTmp).Font.Size = 16
            .Range(Chr(VoucherGetValue("摘　　　　要", stField) + intField) & intTmp).HorizontalAlignment = xlRight
            intTmp = intTmp + 1: intTitle(i) = intTmp
        Next i
        
        For i = LBound(stField) To UBound(stField)
            .Columns(Chr(intField + i) & ":" & Chr(intField + i)).ColumnWidth = intWidth(i)
            .Range(Chr(intField + i) & intTitle(0)).Value = stField(i)
            .Range(Chr(intField + i) & intTitle(0)).HorizontalAlignment = xlCenter
            If intField + i >= Val(Asc(strShowField)) Then
                .Range(Chr(intField + i) & intTitle(0)).Borders(xlEdgeBottom).LineStyle = xlDot '虛線
                .Range(Chr(intField + i) & intTitle(0)).Borders(xlEdgeBottom).Weight = xlThin
            End If
            .Range(Chr(intField + i) & intTitle(1)).Value = stField(i)
            .Range(Chr(intField + i) & intTitle(1)).HorizontalAlignment = xlCenter
            If intField + i >= Val(Asc(strShowField)) Then
                .Range(Chr(intField + i) & intTitle(1)).Borders(xlEdgeBottom).LineStyle = xlDot
                .Range(Chr(intField + i) & intTitle(1)).Borders(xlEdgeBottom).Weight = xlThin
            End If
        Next i
    End With
   
    '畫框
    For i = 0 To 1
        With Wks.Range(strShowField & intTitle(i) & ":" & Chr(UBound(stField) + intField) & intTitle(i) + 17)
            .Font.Size = 10
            .Borders(xlEdgeTop).LineStyle = xlDot
            .Borders(xlEdgeTop).Weight = xlThin
            .Borders(xlEdgeBottom).LineStyle = xlDot
            .Borders(xlEdgeBottom).Weight = xlThin
            .Borders(xlEdgeLeft).LineStyle = xlDot
            .Borders(xlEdgeLeft).Weight = xlThin
            .Borders(xlEdgeRight).LineStyle = xlDot
            .Borders(xlEdgeRight).Weight = xlThin
            .Borders(xlInsideVertical).LineStyle = xlDot
            .Borders(xlInsideVertical).Weight = xlThin
        End With
        intTmp = intTitle(i) + 17
        Wks.Range(strShowField & intTmp).Font.Size = 12
        Wks.Range(strShowField & intTmp).Value = "合　　　　計"
        Wks.Range(strShowField & intTmp & ":" & Chr(VoucherGetValue("部門", stField) + intField) & intTmp).HorizontalAlignment = xlCenter
        Wks.Range(strShowField & intTmp & ":" & Chr(VoucherGetValue("部門", stField) + intField) & intTmp).MergeCells = True
        Wks.Range(strShowField & intTmp & ":" & Chr(UBound(stField) + intField) & intTmp).Borders(xlEdgeTop).LineStyle = xlDot
        Wks.Range(strShowField & intTmp & ":" & Chr(UBound(stField) + intField) & intTmp).Borders(xlEdgeTop).Weight = xlThin
        intTmp = intTitle(i) + 18
        Wks.Range(strShowField & intTmp).Font.Size = 12
        Wks.Range(strShowField & intTmp).Value = "　　　　　　　核准　　　　　　　　　　會計　　　　　　出納　　　　　　　　製單"
        Wks.Range(strShowField & intTmp & ":" & Chr(UBound(stField) + intField) & intTmp).HorizontalAlignment = xlLeft
        Wks.Range(strShowField & intTmp & ":" & Chr(UBound(stField) + intField) & intTmp).MergeCells = True
        '表與表間空行
        Wks.Range(Chr(intField) & intTmp + 1 & ":" & Chr(UBound(stField) + intField) & intTmp + 2).RowHeight = 14
        '下表表頭起始位置調此列
        If i = 0 Then
            '財務 Excel 2010
            Wks.Range(Chr(intField) & intTmp + 3 & ":" & Chr(UBound(stField) + intField) & intTmp + 3).RowHeight = 35
        End If
    Next i
    '*** End 畫表格 ***
    intR = intTitle(0) + 1
    Ado020.MoveFirst
    With Wks
        Do While Ado020.EOF = False
            '取得傳票明細最大序號
            If stOldVNo <> "" & Ado020.Fields("VNo") Then
                'Modify by Amy 2022/04/12 +iif 讓帳務也可用
                stMaxAx203 = GetMaxAx203(stCmp, Ado020.Fields("VNo"), IIf(stFromN = "Finance", False, True))
            End If
            
            If "" & Ado020.Fields("ax203") <> "999999" Then
'**********  明　　　　　　　　　　　　細　**********
                '印日期/傳票號
                If intR = intTitle(0) + 1 Or intR = intTitle(1) + 1 Then
                    intTmp = intTitle(0) - 1
                    If intR = intTitle(1) + 1 Then intTmp = intTitle(1) - 1
                    
                    strText = "" & Ado020.Fields("VDate")
                    strText = "中華民國" & Left(strText, 4) - 1911 & "年" & Mid(strText, 5, 2) & "月" & Right(strText, 2) & "日"
                    .Range(Chr(VoucherGetValue("會 計 科 目", stField) + intField) & intTmp).Value = strText
                    
                    strText = "No：" & Ado020.Fields("VNo")
                    .Range(Chr(VoucherGetValue("摘　　　　要", stField) + intField) & intTmp).Value = strText
                End If
                '資料
                For i = LBound(stField) To UBound(stField)
                    strFontSize = 10
                    strFormat = "" 'Add by Amy  2022/03/18 直接設定Format(strText, FDollar) 會失效 ex:J公司D111030114 項次002 金額30
                    strText = "" & Ado020.Fields(i + 2)
                    Select Case stField(i)
                        Case " "
                        Case "會 計 科 目"
                            If "" & Ado020.Fields("Credit") <> "0" Then
                                '貸方內縮
                                strText = "　　" & strText
                            End If
                            If Len(strText) > 11 Then '瑞興銀行乙存(智慧所)
                                strFontSize = 9
                            End If
                        Case "部門"
                        Case "借 方 金 額", "貸 方 金 額"
                            'Modify by Amy 2022/03/18 直接設定Format(strText, FDollar) 會失效
                            strFormat = "#,##0.00_ "
                            If strText <> "0" Then
                                'strText = Format(strText, FDollar)
                            'end 2022/03/18
                            'Add by Amy 2022/01/28 等於0不印
                            Else
                                strText = ""
                            End If
                        Case "摘　　　　要"
                            'Modify By Sindy 2024/5/23 mark; Excal會自動不列印超過欄位長度的文字,所以不用截字
                            '只是欄位邊會因被字壓到線條,會有點沒印出線條的感覺,給財務處看過,OK!
'                            strText = StrToStr(strText, 18)
'                            If Len(strText) > 30 Then '肆/美無痕生物科技股份有 1090601^ /1公司D111040490
'                                strFontSize = 9
'                            End If
                            '2024/5/23 END
                    End Select
                    .Range(Chr(intField + i) & intR).Font.Size = strFontSize
                    .Range(Chr(intField + i) & intR).Value = strText
                    .Range(Chr(intField + i) & intR).WrapText = False 'Add by Amy 2024/10/17 避免格式跑掉,一律不換行 ex:1公司 D11300963
                    'Add by Amy 2022/03/18 直接設定Format(strText, FDollar) 會失效
                    If strFormat <> MsgText(601) And strText <> MsgText(601) Then
                        .Range(Chr(intField + i) & intR).NumberFormatLocal = strFormat
                    'Add by Amy 2022/04/12 作帳公司別,置中(帳務作帳公司別有值,表「未轉換」)
                    ElseIf stField(i) = " " Then
                        .Range(Chr(intField + i) & intR).HorizontalAlignment = xlCenter
                    End If
                    'end 2022/03/18
                Next i
            Else
'**********  合　　　　　　　　　　　　計　**********
                If intR >= 1 And intR <= 20 Then
                    intTmp = intTitle(0) + 17
                Else
                    intTmp = intTitle(1) + 17
                End If
                strText = "" & Ado020.Fields("Debit")
                'Modify by Amy  2022/03/18 直接設定Format(strText, FDollar) 會失效 ex:J公司D111030114 項次002 金額30
                strFormat = "#,##0.00_ "
                'If strText <> 0 Then strText = Format(strText, FDollar)
                .Range(Chr(VoucherGetValue("借 方 金 額", stField) + intField) & intTmp).Value = strText
                If strText <> 0 Then .Range(Chr(VoucherGetValue("借 方 金 額", stField) + intField) & intTmp).NumberFormatLocal = strFormat
                
                strText = "" & Ado020.Fields("Credit")
                'If strText <> 0 Then strText = Format(strText, FDollar)
                .Range(Chr(VoucherGetValue("貸 方 金 額", stField) + intField) & intTmp).Value = strText
                 If strText <> 0 Then .Range(Chr(VoucherGetValue("貸 方 金 額", stField) + intField) & intTmp).NumberFormatLocal = strFormat
                 'end 2022/03/18
               
                '不同傳票號換表格印
                If intR >= 1 And intR <= 20 Then
                    If "" & Ado020.Fields("VNo") = stNo2 Then
                        bolPrinter = True
                    End If
                Else
                    bolPrinter = True
                End If
'**********  End 合　　　　　　　　　　　　計　**********
            End If
            
            intTmp = intR
            '不是合計,判斷列
            If "" & Ado020.Fields("ax203") <> "999999" Then
                If intR = 20 Then
                    'Modify by Amy 2022/02/08 +if 上表已寫至Excel的20列且為最後一筆項次,不可先設定至下表
                    If stMaxAx203 = "" & Ado020.Fields("ax203") Then
                        intR = intR - 1
                    Else
                        intR = intTitle(1) '下表表頭
                    End If
                ElseIf intR = 45 Then
                    'Add by Amy 2022/02/07 下表已寫至Excel的45列且為最後一筆項次,不可先印
                    If stMaxAx203 <> "" & Ado020.Fields("ax203") Then
                        intR = intTitle(0)  '上表表頭
                        bolPrinter = True
                    End If
                End If
            '合計
            Else
                If intR >= 1 And intR <= 20 Then
                    intR = intTitle(1) '下表表頭
                Else
                    intR = intTitle(0)  '上表表頭
                End If
            End If
            
            '*** 列印->清資料 ***
            If bolPrinter = True Then
                '最後一筆只有印上表,下表要清空
                If "" & Ado020.Fields("VNo") = stNo2 And intTmp >= 1 And intTmp <= 20 Then
                    intTmp = intTitle(1) + 20
                    .Range(Chr(intField) & intTitle(0) + 20 & ":" & Chr(UBound(stField) + intField) & intTmp).ClearContents
                    With Wks.Range(Chr(intField) & intTitle(0) + 20 & ":" & Chr(UBound(stField) + intField) & intTmp)
                        .Borders(xlEdgeTop).LineStyle = xlNone '無框線
                        .Borders(xlEdgeBottom).LineStyle = xlNone
                        .Borders(xlEdgeLeft).LineStyle = xlNone
                        .Borders(xlEdgeRight).LineStyle = xlNone
                        .Borders(xlInsideVertical).LineStyle = xlNone
                        .Borders(xlInsideHorizontal).LineStyle = xlNone
                    End With
               'Modify by Amy 2024/10/17 原intTitle(1) + 19
                    Wks.PageSetup.PrintArea = "$A$1:$" & Chr(UBound(stField) + intField) & intTitle(0) + 18 '設定列印範圍(只印上表)
                Else
                    Wks.PageSetup.PrintArea = "$A$1:$" & Chr(UBound(stField) + intField) & intTitle(1) + 18 '設定列印範圍
                'end 2024/10/17
                End If
                Xls.Workbooks(1).Save
                .PrintOut Copies:=1, Collate:=True
                
                'Modify by Amy 2022/02/08 最後一筆多頁,也需要清表內資料
                If "" & Ado020.Fields("VNo") <> stNo2 Or ("" & Ado020.Fields("VNo") = stNo2 And stMaxAx203 <> "" & Ado020.Fields("ax203")) Then
                    '清表內資料
                    For i = 0 To 1
                        If i = 0 Then
                            intTmp = intTitle(0) + 1
                        Else
                            intTmp = intTitle(1) + 1
                        End If
                        intTmp = intTmp + 15
                        .Range(Chr(intField) & intTitle(i) + 1 & ":" & Chr(UBound(stField) + intField) & intTmp).ClearContents
                        .Range(Chr(VoucherGetValue("借 方 金 額", stField) + intField) & intTmp + 1 & ":" & Chr(VoucherGetValue("貸 方 金 額", stField) + intField) & intTmp + 1).Value = ""
                    Next i
                End If
                bolPrinter = False
            End If
            '*** End 列印->清資料 ***
            
            intR = intR + 1
            stOldVNo = "" & Ado020.Fields("VNo")
            Ado020.MoveNext
        Loop
        Xls.Workbooks(1).Save
    End With
    Xls.Workbooks.Close
    Xls.Quit
    Set Wks = Nothing
    Set Xls = Nothing
    PrintVoucherExcel = True
    Exit Function
   
ErrHand:
    Xls.Workbooks(1).Save
    Xls.Workbooks.Close
    Xls.Quit
    Set Wks = Nothing
    Set Xls = Nothing
    MsgBox Err.Description
End Function

Public Function VoucherGetValue(pFindN As String, ByRef strFieldN) As Integer
    Dim jj As Integer
 
    For jj = LBound(strFieldN) To UBound(strFieldN)
        If UCase(strFieldN(jj)) = UCase(pFindN) Then
            VoucherGetValue = jj
            Exit For
        End If
    Next jj
End Function

'取得傳票明細筆數-從Account aacc_fun搬過來修改('Add by Amy 2022/02/07)
Public Function GetMaxAx203(stCmp As String, stNo As String, Optional ByVal IsAccount = True) As String
    Dim RsQ As New ADODB.Recordset
    Dim stSQL As String, intQ As Integer
    
    If IsAccount = True Then
        stSQL = "Select Max(ax203) From Acc021 Where ax201='" & stCmp & "' And ax202='" & stNo & "' "
    Else
        stSQL = "Select Max(ax303) From Acc031 Where ax301='" & stCmp & "' And ax302='" & stNo & "' "
    End If
    intQ = 1
    Set RsQ = ClsLawReadRstMsg(intQ, stSQL)
    If intQ = 1 Then
        GetMaxAx203 = "" & RsQ.Fields(0)
    End If
    Set RsQ = Nothing
End Function
'end 2022/04/12

'Add by Amy 2022/05/17 從Account-aacc_fun搬過來
'Added by Morgan 2013/12/26
'J公司未開發票者建立發票
'Modify by Amy 2022/05/09 +stFormN,stData1,stData2,stCU158,stCU15,stMsg '表單名/傳入欄位,回傳資料/傳入發票欄位,回傳發票資料/境外公司回傳Y/個人或公司/回傳訊息
Public Sub PUB_InvProc(pNo As String, Optional pInvDate As String, Optional pRecNo As String, Optional ByRef pInvNo As String, _
  Optional ByVal stFormN As String = "", Optional ByRef stData1 As String, Optional ByRef stData2 As String, Optional ByRef stCU158 As String, Optional ByRef stCU15 As String, Optional ByRef stMsg As String)
   Dim stSQL As String, intR As Integer, stInvDate As String, stA4303 As String, stA4304 As String, stA4305 As String
   Dim rsQuery  As ADODB.Recordset
   Dim stCU178 As String 'Add by Amy 2019/07/24 零稅率
   Dim ii As Integer, jj As Integer, stA0K04, stA4323 As String, stAmt As String, stTax As String, stField1, stField2 'Add by Amy 2022/05/09
   Dim stSysKind As String 'Add by Amy 2022/08/29
   
   'Modify by Amy 2022/05/09 +if 將請款單開立發票作業OpenTable搬過來修改,避免有沒改到的部分
   stMsg = ""
   If stData1 <> MsgText(601) Then stField1 = Split(stData1, ","): stData1 = ""
   If stData2 <> MsgText(601) Then stField2 = Split(stData2, ","): stData2 = ""
   If UCase(stFormN) = UCase("Frmacc1127") Then
        'Amy 2022/05/09 Amt改為Net,Sindy 2020/11/11 加 J公司請款單之收文條件
        stSQL = "Select sqldatet(a0k02) a0k02,a0k03,a0k04,a0k20,st02,sum(nvl(a0k06,0))+sum(nvl(a0k07,0)) - sum(nvl(A1uAmt,0)) Net,a0k11,a0k09,cp01,cp10" & _
                     " From acc0k0, staff, (select a1u02,sum(nvl(a1u07,0))+sum(nvl(a1u09,0)) A1uAmt from acc1u0 where a1u02='" & pNo & "' group by a1u02)" & _
                      ",acc0j0,caseprogress" & _
                     " Where a0k01='" & pNo & "' and a0k20=st01(+) and a0k01=a1u02(+) and a0j13=a0k01 and a0j01=cp09" & _
                     " Group by a0k02,a0k03,a0k04,a0k20,st02,a0k11,a0k09,cp01,cp10"
   Else
        'Modify by Amy 2022/08/29 +SubStr(a0j02,1,length(a0j02) - 9) as cp01
'        stSQL = "select a0k04" & _
'           " from acc0k0,acc431 where a0k01='" & pNo & "' and a0k11='J' and axc02(+)=a0k01 and axc01 is null"
        stSQL = "select Distinct a0k04,SubStr(a0j02,1,length(a0j02) - 9) as cp01" & _
           " from acc0k0,acc431,Acc0j0 where a0k01='" & pNo & "' and a0k11='J' and axc02(+)=a0k01 and axc01 is null and a0j13(+)=a0k01"
        'Added by Morgan 2020/11/10 J公司請款單之收文若為ACS案且案件性質706代收代付時，不可開立發票
        stSQL = stSQL & " and not exists(select * from acc0j0,caseprogress where a0j13=a0k01 and cp09(+)=a0j01 and cp01='ACS' and cp10='706')"
        'end 2020/11/10
   End If

   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      'Add by Amy 2022/05/09 請款單開立發票作業 若不是J公司跳離
      If UCase(stFormN) = UCase("Frmacc1127") Then
        stA0K04 = rsQuery.Fields("a0k04")
        stAmt = "" & rsQuery.Fields("Net")
        stTax = Val(stAmt) - Round((Val(stAmt) / 1.05), 0)
        If "" & rsQuery.Fields("a0k11") <> "J" Then
            stMsg = "非J公司請款單!!"
            Set rsQuery = Nothing
            Exit Sub
        'J公司回傳資料
        Else
            For ii = 0 To rsQuery.Fields.Count - 1
                For jj = LBound(stField1) To UBound(stField1)
                    If UCase(rsQuery.Fields(ii).Name) = UCase(stField1(jj)) Then
                        stData1 = stData1 & "," & rsQuery.Fields(ii)
                    End If
                Next jj
            Next ii
            If stData1 <> MsgText(601) Then stData1 = Mid(stData1, 2)
        End If
        'ACS案706.代收代付 彈訊息
        If UCase(stFormN) = UCase("Frmacc1127") Then
            If Val(rsQuery.Fields("a0k09")) > 0 Then
                stMsg = "此請款單已作廢!!"
            End If
            If rsQuery.Fields("cp01") = "ACS" And rsQuery.Fields("cp10") = "706" Then
                stMsg = "ACS案且案件性質706.代收代付，不可開立發票!!"
                Set rsQuery = Nothing
                Exit Sub
            End If
        End If
      End If
      'end 2022/05/09
      stSysKind = "" & rsQuery.Fields("cp01") 'Add by Amy 2022/08/29
      'Modify by Amy 2022/05/09 +if
      If UCase(stFormN) = UCase("Frmacc1127") Then
        '發票資料(欄位要照順序,避免沒抓到)
        'Modify by Amy 2022/08/29 +a4326
        stSQL = "select a4301,sqldatet(a4302) a4302,a4303,a4304,a4305,a4317,Decode(a4319,111111,'',sqldatet(a4319)) a4319,a4323,a4326" & _
                  " From acc431,acc430" & _
                  " where axc02='" & pNo & "'" & _
                  " and axc01=a4301"
      Else
        'Modify by Amy 2019/07/24 +stCU178
        stA4303 = PUB_GetTaxNo("" & rsQuery.Fields(0), , , , stCU178) '統編
        stSQL = "select max(nvl(a0k06,0)+nvl(a0k07,0))-nvl(sum(a1u07),0)-nvl(sum(a1u09),0) Net" & _
           " from acc0k0,acc1u0 where a0k01='" & pNo & "' and a1u02(+)=a0k01"
      End If
      intR = 1
      Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         With rsQuery
        'Modify by Amy 2022/05/09 +if
         If UCase(stFormN) = UCase("Frmacc1127") Then
            '*** J公司回傳「發票」資料 ***
            For ii = 0 To rsQuery.Fields.Count - 1
                For jj = LBound(stField2) To UBound(stField2)
                    If UCase(rsQuery.Fields(ii).Name) = UCase(stField2(jj)) Then
                        stData2 = stData2 & "," & rsQuery.Fields(ii)
                    End If
                Next jj
            Next ii
            If stData2 <> MsgText(601) Then stData2 = Mid(stData2, 2)
            '*** End J公司回傳「發票」資料 ***
         Else
            '2014/12/2 modify by sonia 個人無稅額
            'stA4304 = Round(.Fields("Net") / 1.05)
            'stA4305 = .Fields("Net") - Val(stA4304)
            'Modify By Sindy 2017/1/9
            'If stA4303 <> "" Then
            'Modified by Morgan 2022/5/6
            'If stA4303 <> "" And stA4303 <> "00000000" Then
            If stA4303 <> "" And stA4303 <> "00000000" And stCU178 <> "Y" Then
            'end 2022/5/6
            '2017/1/9 END
               stA4304 = Round(.Fields("Net") / 1.05)
               stA4305 = .Fields("Net") - Val(stA4304)
            Else
               stA4304 = .Fields("Net")
               stA4305 = 0
            End If
            '2014/12/2 end
            stInvDate = pInvDate
            pInvNo = GetInvNewNo(stInvDate)
            stSQL = "insert into acc431(axc01,axc02,axc03) values('" & pInvNo & "','" & pNo & "','" & pRecNo & "')"
            adoTaie.Execute stSQL, intR
            
            'Modify by Amy 2019/07/24 +a4323/stCU178 零稅率
            'Modify by Amy 2022/08/29 +a4326
            stSQL = "insert into acc430(a4301,a4302,a4303,a4304,a4305,a4306,a4311,a4312,a4313,a4323,a4326)" & _
               " values( '" & pInvNo & "'," & stInvDate & ",'" & stA4303 & "'," & stA4304 & "," & stA4305 & ",0,'" & strUserNum & "'," & strSrvDate(2) & ",to_char(sysdate,'hh24miss')" & _
               "," & CNULL(ChgSQL(stCU178)) & ",'" & ChgSQL(Pub_GetInvRemark(stFormN, stSysKind & "OOOOOOOOO")) & "')"
            adoTaie.Execute stSQL, intR
         End If
         End With
      '無發票或請款收款資料
      Else
         If UCase(stFormN) = UCase("Frmacc1127") Then
            stA4303 = PUB_GetTaxNo(stA0K04, , stCU158, stCU15, stCU178)
            If stA4303 <> MsgText(601) And stA4303 <> "00000000" And stCU178 <> "Y" Then
               stA4304 = Val(stAmt) - Val(stTax)
               stA4305 = stTax
            Else
               stA4304 = stAmt
               stA4305 = 0
            End If
            For jj = LBound(stField2) To UBound(stField2)
                If UCase(stField2(jj)) = UCase("A4303") Then
                    stData2 = stData2 & "," & stA4303 '統編
                ElseIf UCase(stField2(jj)) = UCase("A4304") Then
                    stData2 = stData2 & "," & stA4304 '銷售額
                ElseIf UCase(stField2(jj)) = UCase("A4305") Then
                    stData2 = stData2 & "," & stA4305 '稅額
                ElseIf UCase(stField2(jj)) = UCase("A4323") Then
                    stData2 = stData2 & "," & stCU178 '零稅率
                'Add by Amy 2022/08/29
                ElseIf UCase(stField2(jj)) = UCase("A4326") Then
                    stData2 = stData2 & "," & Pub_GetInvRemark(stFormN, stSysKind & "OOOOOOOOO")
                Else
                    stData2 = stData2 & ","
                End If
            Next jj
            If stData2 <> MsgText(601) Then stData2 = Mid(stData2, 2)
         End If
      End If
   'Add by Amy 2022/05/09
   Else
        If UCase(stFormN) = UCase("Frmacc1127") Then
            stMsg = "無此請款單編號!!"
        End If
   'end 2022/05/09
   End If
   Set rsQuery = Nothing
End Sub


'Add by Amy 2022/08/29 取得發票備註
'stCaseNo:案號
'stInvNo:發票號碼
Public Function Pub_GetInvRemark(stFromN As String, stCaseNo As String, Optional ByVal stInvNo As String = "", Optional ByVal IsUpload As Boolean = False, Optional ByVal stA4326 As String = "") As String
    Dim RsQ As New ADODB.Recordset, strQ As String, intQ As Integer
    Dim HasInv As Boolean, stSysKind As String '有發票/系統別
    
    stSysKind = Mid(stCaseNo, 1, Len(stCaseNo) - 9)
    '發票備註維護作業
    If UCase(stFromN) = UCase("Frmacc1128") Then
        HasInv = True
        Pub_GetInvRemark = stA4326
        If IsUpload = True Then
            Exit Function
        End If
    '發票上傳作業
    ElseIf UCase(stFromN) = UCase("Frmacc11t0") Then
        HasInv = True
        Pub_GetInvRemark = stA4326
    '請款單開立發票作業/國內收款
    ElseIf UCase(stFromN) = UCase("Frmacc1127") Or UCase(stFromN) = UCase("Frmacc1151") Then
        If stInvNo <> MsgText(601) Then HasInv = True
    Else
        If stInvNo <> MsgText(601) Then
            strQ = "Select * From Acc430 Where a4301='" & stInvNo & "' "
        
            intQ = 1
            Set RsQ = ClsLawReadRstMsg(intQ, strQ)
            If intQ = 1 Then
                HasInv = True
                '發票已上傳
                If "" & RsQ.Fields("a4319") <> MsgText(601) Then
                    Pub_GetInvRemark = "" & RsQ.Fields("a4326")
                    Exit Function
                '發票未上傳
                Else
                    Pub_GetInvRemark = "" & RsQ.Fields("a4326")
                End If
            End If
            Set RsQ = Nothing
        End If
    End If
    
    Select Case UCase(stFromN)
        Case UCase("Frmacc1127"), UCase("Frmacc1151") '請款單開立發票作業/國內收款
            '未有發票
            If HasInv = False Then
                'ACS 案 預設空白
                If stSysKind = "ACS" Then
                    Pub_GetInvRemark = "空白"
                Else
                    Pub_GetInvRemark = "系統預設"
                End If
            End If
        Case UCase("Frmacc1128") '發票備註維護作業
            '1. 保留系統預設值輸「系統預設」
            '2. 不需備註欄輸「空白」二字
            '3. 其他內容請自行輸入
        Case UCase("Frmacc11t0") '發票上傳作業
            If Pub_GetInvRemark = "系統預設" Then
                '預設案件名稱
                Pub_GetInvRemark = CaseNameShow(stSysKind, Mid(stCaseNo, Len(stCaseNo) - 8, 6), Mid(stCaseNo, Len(stCaseNo) - 2, 1), Mid(stCaseNo, Len(stCaseNo) - 1, Len(stCaseNo)), 1)
            ElseIf Pub_GetInvRemark = "空白" Then
                Pub_GetInvRemark = ""
            End If
    End Select
End Function

'Added by Morgan 2023/6/26
'最後收文工程師
Public Function PUB_GetLastEng(ByVal pa01 As String, ByVal pa02 As String, ByVal pa03 As String, ByVal pa04 As String, ByRef EngNo As String, Optional bMsg As Boolean = True) As Boolean
   Dim strQ As String, intQ As Integer
   Dim rstQ As ADODB.Recordset
   
   EngNo = ""
   strQ = "select cp14,st02,st04,st03 from patent,caseprogress,staff" & _
      " where pa01='" & pa01 & "' and pa02='" & pa02 & "' and pa03='" & pa03 & "' and pa04='" & pa04 & "'" & _
      " and cp01(+)=pa01 and cp02(+)=pa02 and cp03(+)=pa03 and cp04(+)=pa04 and cp14 is not null and cp57 is null" & _
      " and st01(+)=cp14 and (st03 in ('P10','P11') or st03 like 'F%') order by cp05 desc"
   intQ = 1
   Set rstQ = ClsLawReadRstMsg(intQ, strQ)
   If intQ = 1 Then
      If rstQ("st04") = "2" Then
         If bMsg Then MsgBox "承辦人(" & rstQ("cp14") & " " & rstQ("st02") & ")已離職！", vbExclamation
      ElseIf Left(rstQ("st03"), 1) = "F" Then
         If bMsg Then MsgBox "承辦人(" & rstQ("cp14") & " " & rstQ("st02") & ")為國外部工程師！", vbExclamation
      Else
         EngNo = rstQ("cp14")
         PUB_GetLastEng = True
      End If
   End If
End Function

'Added by Morgan 2023/7/5
'專利國內部P案之B類收文之案件性質203主動修正、204  修正、205申復、206補充說明,請將本所期限調整為收文日起算7個工作日--郭
'另外,A/B類的擇一申復也請調整為收文日起算7個工作日,因為此案件性質應該也是要盡快提出申請
'Removed by Morgan 2023/8/1 取消-郭
'Public Function PUB_GetPBRecCP06(ByVal pOldCP06 As String, ByVal pCP01 As String, ByVal pCP10 As String, Optional ByVal pFMP As Boolean = False, Optional ByVal pCP05 As String, Optional ByVal pTWFormat As Boolean = False) As String
'   Dim strDate As String, strNewCP06 As String
'
'   strNewCP06 = pOldCP06
'   If pCP01 = "P" And pFMP = False And pCP10 = "203" Or pCP10 = "204" Or pCP10 = "205" Or pCP10 = "206" Or pCP10 = "239" Then
'      If pCP05 = "" Then
'         pCP05 = strSrvDate(1)
'      End If
'     strDate = CompWorkDay(7, CompDate(2, 1, pCP05), 0)
'     If Val(strDate) < Val(DBDATE(pOldCP06)) Or Val(pOldCP06) = 0 Then
'         strNewCP06 = strDate
'         If pTWFormat Then
'            strNewCP06 = TransDate(strNewCP06, 1)
'         End If
'     End If
'   End If
'   PUB_GetPBRecCP06 = strNewCP06
'End Function

'Added by Morgan 2017/1/4
'同步本機與DB的日期時間
Public Function PUB_SyncClientDateTime(Optional pErrInform As Boolean = False) As Boolean
   Dim strContent As String
   Dim iRetry As Integer
   Dim sTime As String, sTime1 As String
   
   'Modified by Morgan 2017/12/11 +重試3次並加錯誤訊息
On Error GoTo ErrHnd
   Date = Format(strSrvDate(1), "####/##/##")
   'Modified by Morgan 2019/11/4 沒有時(HH,凌晨1點以前)會錯
   'time = Format(ServerTime, "##:##:##")
   'Modified by Morgan 2021/9/2
   'time = Format(ServerTime, "00:00:00")
   sTime1 = ServerTime
   sTime = sTime1
   Do While (sTime1 = sTime)
      Sleep 50
      sTime = ServerTime
   Loop
   time = Format(ServerTime, "00:00:00")
   'end 2019/114
   PUB_SyncClientDateTime = True
   Exit Function
   
ErrHnd:
   If iRetry < 2 Then
      iRetry = iRetry + 1
      Resume
   End If
   If pErrInform Then
      strContent = "Dear Sirs," & vbCrLf & vbCrLf & _
         "發生此問題的原因為：" & vbCrLf & _
         "　　WIN7以上的使用者控制(UAC)過高，導致無法順利完成，必須降低UAC.." & vbCrLf & vbCrLf & _
         "修正步驟:" & vbCrLf & _
         "　　以管理者帳號登入-->控制台-->使用者帳戶-->變更使用者帳戶控制-->降至最低(不要通知)-->重新開機" & vbCrLf & vbCrLf & _
         "（註：修正完成後，重新開機才生效）" & vbCrLf & vbCrLf & vbCrLf & _
         "電腦　名稱：" & PUB_ReadHostName & vbCrLf & _
         "使用者所別：" & IIf(pub_strUserOffice = "1", "北所", IIf(pub_strUserOffice = "2", "中所", IIf(pub_strUserOffice = "3", "南所", IIf(pub_strUserOffice = "4", "高所", pub_strUserOffice)))) & vbCrLf & _
         "執行檔名稱：" & App.EXEName & vbCrLf & _
         "Ip Address：" & GetLocalIP & vbCrLf & _
         "錯誤　訊息：" & Err.Description & "(" & Err.Number & ")" & vbCrLf & vbCrLf
         
      'Modify By Sindy 2023/7/25 改抓 GetDeptMan("M51") & ";" & Pub_GetSpecMan("程式管理人員")
      PUB_SendMail strUserNum, GetDeptMan("M51") & ";" & Pub_GetSpecMan("程式管理人員") & ";92012", "", "無法同步本機與DB的日期時間！請降低帳戶控制設定(UAC)", strContent, , , , , , , , , , , False
   End If

End Function

'Add By Sindy 2018/9/5
'Modify By Sindy 2019/4/29 ex:CFP-30337 exciplex;5,7spiroTB-010-ET;PNFL-001-001-ET
'Modify By Sindy 2024/2/2 + Optional bolHalfType As Boolean = False
'                         ex:P-131866 客戶案件案號為2023-W65＊9-001-F 存電子檔名是符號要全型才能命名成功,反過來解析DB資料時要變回半型
Public Function PUB_FilterEFileSymbol(strTextData As String, _
   Optional bolHalfType As Boolean = False) As String
   
   'Add By Sindy 2024/2/2
   '轉半型
   If bolHalfType = True Then
      strTextData = Replace(strTextData, "／", "/")
      strTextData = Replace(strTextData, "＼", "\")
      strTextData = Replace(strTextData, "：", ":")
      strTextData = Replace(strTextData, "＊", "*")
      strTextData = Replace(strTextData, "？", "?")
      strTextData = Replace(strTextData, "＜", "<")
      strTextData = Replace(strTextData, "＞", ">")
      strTextData = Replace(strTextData, "｜", "|")
      strTextData = Replace(strTextData, "；", ";")
   '2024/2/2 END
   '轉全型
   Else
      strTextData = Replace(strTextData, "/", "／")
      strTextData = Replace(strTextData, "\", "＼")
      strTextData = Replace(strTextData, ":", "：")
      strTextData = Replace(strTextData, "*", "＊")
      strTextData = Replace(strTextData, "?", "？")
      strTextData = Replace(strTextData, "<", "＜")
      strTextData = Replace(strTextData, ">", "＞")
      strTextData = Replace(strTextData, "|", "｜")
      strTextData = Replace(strTextData, ";", "；") 'Add By Sindy 2019/4/29 加 ; 且遇到這些特殊符號(保留字)轉全型
   End If
   PUB_FilterEFileSymbol = strTextData
End Function

'Add by Amy 2023/10/13 從basUpdate 搬過來
'Modify by Amy 2023/01/30 傳入客戶號編號取得其案件資料(Add 2023/01/16)
'stOrgNo:客戶編號起 /stNo2:客戶編號迄
'stSys:系統別
'IsLaw:是法務專用 /bolShowPCT:顯示PCT案
'stF1:傳入需顯示欄位(非固定)
'stCPWhere:傳入進度條件/stNation_S:傳入國籍(起)/stNation_E:傳入國籍(迄)
Public Function Pub_GetCusCaseSql(ByVal stFormN As String, ByVal stOrgNo As String, ByVal stSys As String, ByVal IsLaw As Boolean, ByVal bolShowPCT As Boolean, _
                            Optional ByVal stF1 As String = "", Optional ByVal stCPWhere As String = "", Optional ByVal stNation_S As String = "", Optional ByVal stNation_E As String = "") As String
    Dim strBWhere(1 To 5) As String, strBWhere_Fix(1 To 5) As String, strBAll(1 To 5) As String, strSQLCP As String '基本檔Where條件/基本檔Where條件(固定)/基本檔/進度條件
    Dim strFilter(1 To 2) As String, strFilterW(1 To 2) As String, strField(1 To 5) As String, strSysKind As String, strTB As String, strSqlNation As String
    Dim SeColPA As String, SeColTM As String, SeColSP As String, SeColLC As String, SeColHC As String
    Dim IsXNo As Boolean, bolRunTran As Boolean '是客戶/需Run 移轉人/移轉申請人
    Dim ii As Integer, strTp(5) As String, intRunS As Integer, intRunE As Integer
    Dim stNo1 As String, stNo2 As String, strContactNo As String 'Add by Amy 2023/10/13 編號起/編號起/接洽人編號
    
    'Add by Amy 2024/12/10 目前使用之表單
    Select Case UCase(stFormN)
      Case "FRM100102_2" '以申請人查詢
      Case "FRM100114_2"
    End Select
    
    IsXNo = False: bolRunTran = False: intRunS = 0: intRunE = 0
    
    '利益衝突案件:於後面增加欄位
    SeColTM = " ,tm23 as cust01,tm78 as cust02,tm79 as cust03,tm80 as cust04,tm81 as cust05,tm44 as fcno "
    SeColPA = " ,pa26 as cust01,pa27 as cust02,pa28 as cust03,pa29 as cust04,pa30 as cust05,pa75 as fcno "
    SeColSP = " ,sp08 as cust01,sp58 as cust02,sp59 as cust03,sp65 as cust04,sp66 as cust05,sp26 as fcno "
    SeColLC = " ,lc11 as cust01,lc43 as cust02,lc44 as cust03,lc45 as cust04,lc46 as cust05,lc22 as fcno "
    SeColHC = " ,hc05 as cust01,hc24 as cust02,hc25 as cust03,hc26 as cust04,hc27 as cust05,'' as fcno "
    
   'Add by Amy 2023/10/13 接洽人
   stNo1 = stOrgNo
   If Mid(stOrgNo, 10, 1) = "-" Then
      strContactNo = Mid(stOrgNo, 11)
      'Modiy by Amy 2024/12/10 原 Left(stOrgNo, 9) ex:申請人查詢->曾->按「案件」鈕,會沒資料(應有4筆)
      stNo1 = Left(stOrgNo, 8) & "0"
      stNo2 = Left(stOrgNo, 8) & "9"
   Else
      stNo1 = ChangeCustomerL(stNo1)
      stNo2 = stNo1
   End If
   
    '系統別
    If stSys = "ALL" Then
        strSysKind = GetAllSysKind(, stSys)
    Else
        strSysKind = stSys
    End If
    If stSys <> "" Then pub_QL05 = pub_QL05 & ";系統類別：" & strSysKind 'Add By Sindy 2025/8/13
    '傳入的國籍條件
    If stNation_S <> MsgText(601) And stNation_E <> MsgText(601) Then
        If stNation_S = stNation_E Then
            strSqlNation = " And stNation='" & stNation_S & "' "
        Else
            strSqlNation = " And stNation>='" & stNation_S & "' And stNation<='" & stNation_E & "' "
        End If
        pub_QL05 = pub_QL05 & ";申請國家：" & stNation_S & "-" & stNation_E 'Add By Sindy 2025/8/13
    ElseIf stNation_S <> MsgText(601) Then
        strSqlNation = " And stNation>='" & stNation_S & "' "
        pub_QL05 = pub_QL05 & ";申請國家：" & stNation_S 'Add By Sindy 2025/8/13
    ElseIf stNation_E <> MsgText(601) Then
        strSqlNation = " And stNation<='" & stNation_E & "' "
        pub_QL05 = pub_QL05 & ";申請國家：" & stNation_E 'Add By Sindy 2025/8/13
    End If
    '傳入的CP條件
    If stCPWhere <> MsgText(601) Then
        strSQLCP = strSQLCP & stCPWhere
    End If
    
    Select Case UCase(stFormN)
        'Modify by Amy 2023/01/18 +潛在客戶
        Case UCase("frm100102_1"), UCase("frm100114_1"), UCase("frm140407"), UCase("frm210130")
            If Left(stNo1, 1) = 客戶編號 Then
                IsXNo = True
            End If
            
        Case UCase("frm100102_2")
    '** 申請人查詢**
            IsXNo = True
            
            '案件鈕:不是 法務專用
            If IsLaw = False Then
                '商標
                'Modify by Amy 2023/03/06 Nvl(EState,'') 改為Decode(tm136,'1',Decode(tm21,null,Decode(cp10,'717','e'),'e'))
                'Modify by Amy 2023/03/17 strSQLCP有值需另外過濾,否則可能抓不到資料 +E1.
                strField(1) = "' ' AS V,Decode(tm28,'1','','N')||tm01||'-'||tm02||'-'||tm03||'-'||tm04||Decode(tm29,'Y','＊','')||Decode(length(Nvl(tm57,'')),Null,'','●')||Decode(tm128,'Y','◎','A','□','')||Decode(tm136,'1',Decode(tm21,null,Decode(E1.cp10,'717','e'),'e')) AS 本所案號 ,Decode(length(Nvl(tm73,'')),Null,'','●')||tm34 AS 分所號 ,Nvl(tm05,Nvl(tm06,tm07)) AS 案件名稱,na03 AS 申請國家,tm12 AS 申請案號 ," & SQLDate("tm11") & " AS 申請日 ,tm15 AS 審定專利號數,Decode(tm16,'1','准','2','駁',' ') AS 准駁 " & _
                                    ",Nvl(C1.cu04,Nvl(C1.cu05||C1.cu88||C1.cu89||C1.cu90,C1.cu06)) AS 申請人1,Nvl(tm09,' ') AS 商品類別,Decode(tm21,Null,'','','',(SubStr(tm21,1,4)||'/'||SubStr(tm21,5,2)||'/'||SubStr(tm21,7,2)))||'-'||Decode(tm22,Null,'','','',(SubStr(tm22,1,4)||'/'||SubStr(tm22,5,2)||'/'||SubStr(tm22,7,2))) AS 專用期間, ' '  AS 專利公告號, ' ' AS 最近已繳年度" & _
                                    ",Nvl(C2.cu04,Nvl(C2.cu05||C2.cu88||C2.cu89||C2.cu90,C2.cu06)) AS 申請人2,Nvl(C3.cu04,Nvl(C3.cu05||C3.cu88||C3.cu89||C3.cu90,C3.cu06)) AS 申請人3,Nvl(C4.cu04,Nvl(C4.cu05||C4.cu88||C4.cu89||C4.cu90,C4.cu06)) AS 申請人4,Nvl(C5.cu04,Nvl(C5.cu05||C5.cu88||C5.cu89||C5.cu90,C5.cu06)) AS 申請人5" & _
                                    ",tm01||'-'||tm02||'-'||tm03||'-'||tm04||Decode(tm29,'Y','＊','')||Decode(length(Nvl(tm57,'')),Null,'','●')||Decode(tm128,'Y','◎','A','□','') as FSort,Decode(tm123,Null,C1.cu01||C1.cu127,C1.cu01||tm123) CNT" & SeColTM
                '專利
                'Modify by Amy 2023/03/06 Nvl(EState,'') 改為 Decode(pa178,'1',Decode(pa24,null,Decode(cp10,'601','e'),'e'))
                'Modify by Amy 2023/03/17 strSQLCP有值需另外過濾,否則可能抓不到資料 +E1.
                strField(2) = "' ' AS V,Decode(pa23,'1','','N')||pa01||'-'||pa02||'-'||pa03||'-'||pa04||Decode(pa57,'Y','＊','')||Decode(length(Nvl(pa108,'')),Null,'','●')||Decode(pa165,'Y','＃','')||Decode(pa178,'1',Decode(pa24,null,Decode(E1.cp10,'601','e'),'e')) AS 本所案號 ,Decode(length(Nvl(pa136,'')),Null,'','●')||pa47 AS 分所號 ,Nvl(pa05,Nvl(pa06,pa07)) AS 案件名稱,na03 AS 申請國家,pa11 AS 申請案號 ," & SQLDate("pa10") & " AS 申請日 ,pa22 AS 審定專利號數,Decode(pa16,'1','准','2','駁',' ') AS 准駁 " & _
                                    ",Nvl(C1.cu04,Nvl(C1.cu05||C1.cu88||C1.cu89||C1.cu90,C1.cu06)) AS 申請人1,' ' AS 商品類別,Decode(pa24,Null,'','','',(SubStr(pa24,1,4)||'/'||SubStr(pa24,5,2)||'/'||SubStr(pa24,7,2)))||'-'||Decode(pa25,Null,'','','',(SubStr(pa25,1,4)||'/'||SubStr(pa25,5,2)||'/'||SubStr(pa25,7,2))) AS 專用期間, Nvl(pa15,pa13) AS 專利公告號," & stF1 & " AS 最近已繳年度" & _
                                    ",Nvl(C2.cu04,Nvl(C2.cu05||C2.cu88||C2.cu89||C2.cu90,C2.cu06)) AS 申請人2,Nvl(C3.cu04,Nvl(C3.cu05||C3.cu88||C3.cu89||C3.cu90,C3.cu06)) AS 申請人3,Nvl(C4.cu04,Nvl(C4.cu05||C4.cu88||C4.cu89||C4.cu90,C4.cu06)) AS 申請人4,Nvl(C5.cu04,Nvl(C5.cu05||C5.cu88||C5.cu89||C5.cu90,C5.cu06)) AS 申請人5" & _
                                    ",pa01||'-'||pa02||'-'||pa03||'-'||pa04||Decode(pa57,'Y','＊','')||Decode(length(Nvl(pa108,'')),Null,'','●') as FSort,Decode(pa149,Null,C1.cu01||C1.cu127,C1.cu01||pa149) CNT" & SeColPA
                '服務業務
                strField(3) = "' ' AS V,sp01||'-'||sp02||'-'||sp03||'-'||sp04||Decode(sp15,'Y','＊','')||Decode(length(Nvl(sp61,'')),Null,'','●')  AS 本所案號 , Decode(length(Nvl(sp68,'')),Null,'','●')||sp28 AS 分所號 ,Nvl(sp05,Nvl(sp06,sp07)) AS 案件名稱,na03 AS 申請國家,sp11 AS 申請案號 ," & SQLDate("sp10") & " AS 申請日 ,Nvl(sp14,sp13) AS 審定專利號數,' ' AS 准駁 " & _
                                    ",Nvl(C1.cu04,Nvl(C1.cu05||C1.cu88||C1.cu89||C1.cu90,C1.cu06)) AS 申請人1,Nvl(sp73,'') AS 商品類別,Decode(sp20,Null,'','','',(SubStr(sp20,1,4)||'/'||SubStr(sp20,5,2)||'/'||SubStr(sp20,7,2)))||'-'||Decode(sp21,Null,'','','',(SubStr(sp21,1,4)||'/'||SubStr(sp21,5,2)||'/'||SubStr(sp21,7,2))) AS 專用期間, ' '  AS 專利公告號, ' ' AS 最近已繳年度" & _
                                    ",Nvl(C2.cu04,Nvl(C2.cu05||C2.cu88||C2.cu89||C2.cu90,C2.cu06)) AS 申請人2,Nvl(C3.cu04,Nvl(C3.cu05||C3.cu88||C3.cu89||C3.cu90,C3.cu06)) AS 申請人3,Nvl(C4.cu04,Nvl(C4.cu05||C4.cu88||C4.cu89||C4.cu90,C4.cu06)) AS 申請人4,Nvl(C5.cu04,Nvl(C5.cu05||C5.cu88||C5.cu89||C5.cu90,C5.cu06)) AS 申請人5" & _
                                    ",sp01||'-'||sp02||'-'||sp03||'-'||sp04||Decode(sp15,'Y','＊','')||Decode(length(Nvl(sp61,'')),Null,'','●')  as FSort,Decode(sp78,Null,C1.cu01||C1.cu127,C1.cu01||sp78) CNT" & SeColSP
                '法務
                strField(4) = "' ' AS V,lc01||'-'||lc02||'-'||lc03||'-'||lc04||Decode(lc08,'Y','＊','')||Decode(length(Nvl(lc34,'')),Null,'','●')   AS 本所案號 , Decode(length(Nvl(lc36,'')),Null,'','●')||lc16 AS 分所號 ,Nvl(lc05,Nvl(lc06,lc07)) AS 案件名稱,na03 AS 申請國家,' ' AS 申請案號 , ' ' AS 申請日 ,' ' AS 審定專利號數,' ' AS 准駁 " & _
                                    ",Nvl(c1.cu04,Nvl(c1.cu05||c1.cu88||c1.cu89||c1.cu90,c1.cu06)) AS 申請人1,' ' AS 商品類別,'-' AS 專用期間, ' '  AS 專利公告號, ' ' AS 最近已繳年度" & _
                                    ",Nvl(c2.cu04,Nvl(c2.cu05||c2.cu88||c2.cu89||c2.cu90,c2.cu06)) AS 申請人2, Nvl(c3.cu04,Nvl(c3.cu05||c3.cu88||c3.cu89||c3.cu90,c3.cu06)) AS 申請人3, Nvl(c4.cu04,Nvl(c4.cu05||c4.cu88||c4.cu89||c4.cu90,c4.cu06)) AS 申請人4, Nvl(c5.cu04,Nvl(c5.cu05||c5.cu88||c5.cu89||c5.cu90,c5.cu06)) AS 申請人5" & _
                                    ", lc01||'-'||lc02||'-'||lc03||'-'||lc04||Decode(lc08,'Y','＊','')||Decode(length(Nvl(lc34,'')),Null,'','●') as FSort,Decode(lc42,Null,c1.cu01||c1.cu127,c1.cu01||lc42) CNT" & SeColLC
                '顧問
                strField(5) = "' ' AS V,hc01||'-'||hc02||'-'||hc03||'-'||hc04||Decode(hc09,'Y','＊','')||Decode(length(Nvl(hc19,'')),Null,'','●')  AS 本所案號 , Decode(length(Nvl(hc20,'')),Null,'','●')||hc07 AS 分所號 ,hc06 AS 案件名稱,'台灣' AS 申請國家,' ' AS 申請案號 , ' ' AS 申請日 ,' ' AS 審定專利號數,' ' AS 准駁 " & _
                                    ",Nvl(c1.cu04,Nvl(c1.cu05||c1.cu88||c1.cu89||c1.cu90,c1.cu06)) AS 申請人1,' ' AS 商品類別,'-' AS 專用期間, ' '  AS 專利公告號, ' ' AS 最近已繳年度" & _
                                    ",Nvl(c2.cu04,Nvl(c2.cu05||c2.cu88||c2.cu89||c2.cu90,c2.cu06)) AS 申請人2, Nvl(c3.cu04,Nvl(c3.cu05||c3.cu88||c3.cu89||c3.cu90,c3.cu06)) AS 申請人3, Nvl(c4.cu04,Nvl(c4.cu05||c4.cu88||c4.cu89||c4.cu90,c4.cu06)) AS 申請人4, Nvl(c5.cu04,Nvl(c5.cu05||c5.cu88||c5.cu89||c5.cu90,c5.cu06)) AS 申請人5" & _
                                    ", hc01||'-'||hc02||'-'||hc03||'-'||hc04||Decode(hc09,'Y','＊','')||Decode(length(Nvl(hc19,'')),Null,'','●')  as FSort,Decode(hc23,Null,c1.cu01||c1.cu127,c1.cu01||hc23) CNT" & SeColHC
            '法務進度鈕:法務專用
            Else
                '法務
                strField(4) = "' ' AS V,lc01||'-'||lc02||'-'||lc03||'-'||lc04||Decode(lc08,'Y','＊','')||Decode(length(Nvl(lc34,'')),null,'','●')   AS 本所案號 , Decode(length(Nvl(lc36,'')),null,'','●')||lc16 AS 分所號 ,Decode(lc52,'Y',CP.CP64||'('||Nvl(Decode(lc15,'000',CPM03,CPM04),CP.CP10)||')',lc05||' '||lc06||' '||lc07) AS 案件名稱 ,Nvl(CP.CP40,Nvl(CP.CP50,Decode(CP.CP56,CU01||CU02,CU04))) as 相關人" & _
                                    ", sqldatet(CP.cp05) AS 收文日,s2.st02 as 承辦人,s3.st02 as 協辦人員,sqldatet(CP.cp27) as 發文日,sqldatet(CP.cp46) as 回執日,s1.st02 as 智權人員,Nvl(cpm03,cpm04) AS 案件性質,na03 AS 申請國家,sqldatet(CP.cp57) as 取消收文日," & stF1 & " as 代理人,lc01||'-'||lc02||'-'||lc03||'-'||lc04||Decode(lc08,'Y','＊','')||Decode(length(Nvl(lc34,'')),null,'','●') as FSort,CP.CP09,CU01||CU127 CNT" & SeColLC
                '顧問
                strField(5) = "' ' AS V,hc01||'-'||hc02||'-'||hc03||'-'||hc04||Decode(hc09,'Y','＊','')||Decode(length(Nvl(hc19,'')),Null,'','●')  AS 本所案號 , Decode(length(Nvl(hc20,'')),Null,'','●')||hc07 AS 分所號 ,Decode(CP.cp10,'0',(sqldatet(CP.cp53)||'-'||sqldatet(CP.cp54))||' ',CP.CP64) AS 案件名稱 ,Nvl(CP.CP40,Nvl(CP.CP50,Decode(CP.CP56,CU01||CU02,CU04))) as 相關人" & _
                                    ", sqldatet(CP.cp05) AS 收文日,s2.st02 as 承辦人,s3.st02 as 協辦人員,sqldatet(CP.cp27) as 發文日,sqldatet(CP.cp46) as 回執日,s1.st02 as 智權人員,Nvl(cpm03,cpm04) AS 案件性質,'台灣' AS 申請國家,sqldatet(CP.cp57) as 取消收文日," & stF1 & " as 代理人,hc01||'-'||hc02||'-'||hc03||'-'||hc04||Decode(hc09,'Y','＊','')||Decode(length(Nvl(hc19,'')),Null,'','●')  as FSort,CP.CP09,CU01||CU127 CNT" & SeColHC
            End If
            
'** End 申請人查詢 **
        Case UCase("frm100114_2")
'** 代理人查詢 **
            '案件鈕:不是 法務專用
            If IsLaw = False Then
                '商標
                strField(1) = "' ' AS V,Decode(tm28,'1','','N')||tm01||'-'||tm02||'-'||tm03||'-'||tm04||Decode(tm29,'Y','＊','')||Decode(Length(Nvl(tm57,'')),Null,'','●') AS 本所案號,Decode(Length(Nvl(tm73,'')),Null,'','●')||tm34 as 分所號,Nvl(tm05,Nvl(tm06,tm07)) AS 案件名稱,na03 AS 申請國家,tm12 AS 申請案號,tm15 AS 審定號專利號數,Decode(tm16,'1','准','2','駁',' ') AS 目前准駁,Nvl(tm09,' ') AS 商品類別,Decode(tm21,Null,'','','',(SubStr(tm21,1,4)||'/'||SubStr(tm21,5,2)||'/'||SubStr(tm21,7,2)))||'-'||Decode(tm22,Null,'','','',(SubStr(tm22,1,4)||'/'||SubStr(tm22,5,2)||'/'||SubStr(tm22,7,2))) AS 專用期間" & _
                                ",Nvl(C1.cu04,Decode(C1.cu05,Null,C1.cu06,C1.cu05||' '||C1.cu88||' '||C1.cu89||' '||C1.cu90)) AS 申請人1,Nvl(C2.cu04,Decode(C2.cu05,Null,C2.cu06,C2.cu05||' '||C2.cu88||' '||C2.cu89||' '||C2.cu90)) AS 申請人2,Nvl(C3.cu04,Decode(C3.cu05,Null,C3.cu06,C3.cu05||' '||C3.cu88||' '||C3.cu89||' '||C3.cu90)) AS 申請人3,Nvl(C4.cu04,Decode(C4.cu05,Null,C4.cu06,C4.cu05||' '||C4.cu88||' '||C4.cu89||' '||C4.cu90)) AS 申請人4,Nvl(C5.cu04,Decode(C5.cu05,Null,C5.cu06,C5.cu05||' '||C5.cu88||' '||C5.cu89||' '||C5.cu90)) AS 申請人5,tm01||'-'||tm02||'-'||tm03||'-'||tm04 as FSort" & SeColTM
                '專利
                strField(2) = "' ' AS V,Decode(pa23,'1','','N')||pa01||'-'||pa02||'-'||pa03||'-'||pa04||Decode(pa57,'Y','＊','')||Decode(Length(Nvl(pa108,'')),Null,'','●')  AS 本所案號,Decode(Length(Nvl(pa136,'')),Null,'','●')||pa47 as 分所號,Nvl(pa05,Nvl(pa06,pa07)) AS 案件名稱,na03 AS 申請國家,pa11 AS 申請案號,pa22 AS 審定號專利號數,Decode(pa16,'1','准','2','駁',' ') AS 目前准駁,' ' AS 商品類別,Decode(pa24,Null,'','','',(SubStr(pa24,1,4)||'/'||SubStr(pa24,5,2)||'/'||SubStr(pa24,7,2)))||'-'||Decode(pa25,Null,'','','',(SubStr(pa25,1,4)||'/'||SubStr(pa25,5,2)||'/'||SubStr(pa25,7,2))) AS 專用期間" & _
                                ",Nvl(C1.cu04,Decode(C1.cu05,Null,C1.cu06,C1.cu05||' '||C1.cu88||' '||C1.cu89||' '||C1.cu90)) AS 申請人1,Nvl(C2.cu04,Decode(C2.cu05,Null,C2.cu06,C2.cu05||' '||C2.cu88||' '||C2.cu89||' '||C2.cu90)) AS 申請人2,Nvl(C3.cu04,Decode(C3.cu05,Null,C3.cu06,C3.cu05||' '||C3.cu88||' '||C3.cu89||' '||C3.cu90)) AS 申請人3,Nvl(C4.cu04,Decode(C4.cu05,Null,C4.cu06,C4.cu05||' '||C4.cu88||' '||C4.cu89||' '||C4.cu90)) AS 申請人4,Nvl(C5.cu04,Decode(C5.cu05,Null,C5.cu06,C5.cu05||' '||C5.cu88||' '||C5.cu89||' '||C5.cu90)) AS 申請人5,pa01||'-'||pa02||'-'||pa03||'-'||pa04 as FSort" & SeColPA
                '服務業務
                strField(3) = "' ' AS V,sp01||'-'||sp02||'-'||sp03||'-'||sp04||Decode(sp15,'Y','＊','')||Decode(Length(Nvl(sp61,'')),Null,'','●')  AS 本所案號,Decode(Length(Nvl(sp68,'')),Null,'','●')||sp28 as 分所號,Nvl(sp05,Nvl(sp06,sp07)) AS 案件名稱,na03 AS 申請國家,sp11 AS 申請案號,sp14 AS 審定號專利號數,' ' AS 目前准駁,Nvl(sp73,'') AS商品類別,Decode(sp20,Null,'','','',(SubStr(sp20,1,4)||'/'||SubStr(sp20,5,2)||'/'||SubStr(sp20,7,2)))||'-'||Decode(sp21,Null,'','','',(SubStr(sp21,1,4)||'/'||SubStr(sp21,5,2)||'/'||SubStr(sp21,7,2))) AS 專用期間" & _
                                ",Nvl(C1.cu04,Decode(C1.cu05,Null,C1.cu06,C1.cu05||' '||C1.cu88||' '||C1.cu89||' '||C1.cu90)) AS 申請人1,Nvl(C2.cu04,Decode(C2.cu05,Null,C2.cu06,C2.cu05||' '||C2.cu88||' '||C2.cu89||' '||C2.cu90)) AS 申請人2,Nvl(C3.cu04,Decode(C3.cu05,Null,C3.cu06,C3.cu05||' '||C3.cu88||' '||C3.cu89||' '||C3.cu90)) AS 申請人3,Nvl(C4.cu04,Decode(C4.cu05,Null,C4.cu06,C4.cu05||' '||C4.cu88||' '||C4.cu89||' '||C4.cu90)) AS 申請人4,Nvl(C5.cu04,Decode(C5.cu05,Null,C5.cu06,C5.cu05||' '||C5.cu88||' '||C5.cu89||' '||C5.cu90)) AS 申請人5,sp01||'-'||sp02||'-'||sp03||'-'||sp04 as FSort" & SeColSP
                '法務
                strField(4) = "' ' AS V,lc01||'-'||lc02||'-'||lc03||'-'||lc04||Decode(lc08,'Y','＊','')||Decode(Length(Nvl(lc34,'')),Null,'','●')   AS 本所案號,Decode(Length(Nvl(lc36,'')),Null,'','●')||lc16 as 分所號,Nvl(lc05,Nvl(lc06,lc07)) AS 案件名稱,na03 AS 申請國家,' ' AS 申請案號,' ' AS 審定號專利號數,' ' AS 目前准駁,' ' AS 商品類別,'-' AS 專用期間" & _
                                ",Nvl(C1.cu04,Decode(C1.cu05,Null,C1.cu06,C1.cu05||' '||C1.cu88||' '||C1.cu89||' '||C1.cu90)) AS 申請人1,Nvl(C2.cu04,Decode(C2.cu05,Null,C2.cu06,C2.cu05||' '||C2.cu88||' '||C2.cu89||' '||C2.cu90)) AS 申請人2,Nvl(C3.cu04,Decode(C3.cu05,Null,C3.cu06,C3.cu05||' '||C3.cu88||' '||C3.cu89||' '||C3.cu90)) AS 申請人3,Nvl(C4.cu04,Decode(C4.cu05,Null,C4.cu06,C4.cu05||' '||C4.cu88||' '||C4.cu89||' '||C4.cu90)) AS 申請人4,Nvl(C5.cu04,Decode(C5.cu05,Null,C5.cu06,C5.cu05||' '||C5.cu88||' '||C5.cu89||' '||C5.cu90)) AS 申請人5,lc01||'-'||lc02||'-'||lc03||'-'||lc04 as FSort" & SeColLC
            '法務進度鈕:法務專用
            Else
                '法務
                strField(4) = "' ' AS V,lc01||'-'||lc02||'-'||lc03||'-'||lc04||Decode(lc08,'Y','＊','')||Decode(length(Nvl(lc34,'')),Null,'','●')   AS 本所案號,Decode(length(Nvl(lc36,'')),Null,'','●')||lc16 as 分所號,Nvl(lc05,Nvl(lc06,lc07)) AS 案件名稱,na03 AS 申請國家, ' ' AS 申請日 ,' ' AS 准駁, Nvl(C1.cu04,Decode(C1.cu05,Null,C1.cu06,C1.cu05||' '||C1.cu88||' '||C1.cu89||' '||C1.cu90)) AS 當事人1, sqldatet(CP.cp05) AS 收文日 ,Nvl(cpm03,cpm04) AS 案件性質,s1.st02 as 智權人員,s2.st02 as 承辦人" & _
                                    ",sqldatet(CP.cp06) as 本所期限,sqldatet(CP.cp07) as 法定期限,sqldatet(CP.cp27) as 發文日,sqldatet(CP.cp57) as 取消收文日," & stF1 & " as 代理人,Decode(CP.cp24,'1','准','2','駁',' ') AS 結果,Nvl(CP.CP40,Nvl(CP.CP50,Decode(CP.CP56,C0.cu01||C0.cu02,C0.cu04))) as 相關人,CP.cp64 AS 進度備註,lc01||'-'||lc02||'-'||lc03||'-'||lc04||Decode(lc08,'Y','＊','')||Decode(length(Nvl(lc34,'')),Null,'','●') as FSort" & SeColLC
            End If
'** End 代理人查詢 **
    End Select

    If IsXNo = True Then
'*** X編號 [會 Run 案件基本檔申請人1-5 及 移轉人/移轉申請人CPXX (bolRunTran=True)] ***
        bolRunTran = True
        intRunS = 1: intRunE = 5
        
        '** Memo 顯示 e 符號過濾語法 **
        'Modify by Amy 2023/03/06 bug-FCP-064401 該案無專用期且無領證發文,不應加e,避免未來資料多跑的慢優化語法
        'T、FCT已有專用期間者,或無專用期但進度檔商標之註冊費717已發文
'        strFilter(1) = ",(" & _
'                            "Select tm01 as Ecp01,tm02 as Ecp02,tm03 as Ecp03,tm04 as Ecp04,'e' as EState From TradeMark " & _
'                            "Where tm136='1' And Tm04='00' And (tm21 is not null or (tm21 is null And Exists (Select * From CaseProgress Where cp01 in(" & SQLGrpStr2("", 2) & ") And cp10='717' And cp158<>0 And tm01=cp01(+) And tm02=cp02(+) And tm03=cp03(+) And tm04=cp04(+) )  )) " & _
'                            ")"
'        strFilterW(1) = " And tm01=Ecp01(+) And tm02=Ecp02(+) And tm03=Ecp03(+) And tm04=Ecp04(+) "
        'Modif by Amy 2023/03/17 strSQLCP有值需另外過濾,否則可能抓不到資料 ex:X77088 收文日:1120317~1120317
        strFilter(1) = ",CaseProgress E1"
        strFilterW(1) = Replace(Replace(Replace(專利進度註冊費已發文語法, "cp", "E1.cp"), "601", "717"), "pa", "tm")
        'end 2023/03/17
        
        'P、FCP已有專用期間者,或無專用期但進度檔專利之領證601已發文
'        strFilter(2) = ",(" & _
'                            "Select pa01 as Ecp01,pa02 as Ecp02,pa03 as Ecp03,pa04 as Ecp04,'e' as EState From Patent " & _
'                            "Where pa178='1' And pa04='00' And (pa24 is not null or (pa24 is null And Exists (Select * From CaseProgress Where cp01 in(" & SQLGrpStr2("", 1) & ") And cp10='601' And cp158<>0 And pa01=cp01(+) And pa02=cp02(+) And pa03=cp03(+) And pa04=cp04(+) )  )) " & _
'                            ")"
'        strFilterW(2) = " And pa01=Ecp01(+) And pa02=Ecp02(+) And pa03=Ecp03(+) And pa04=Ecp04(+) "
        'Modif by Amy 2023/03/17 strSQLCP有值需另外過濾,否則可能抓不到資料 ex:X77088 收文日:1120317~1120317
        strFilter(2) = ",CaseProgress E1"
        strFilterW(2) = Replace(專利進度註冊費已發文語法, "cp", "E1.cp")
        'end 2023/03/17
        'end 2023/03/06
        '** End Memo 顯示 e 符號過濾語法 **
        
        If stNo1 = stNo2 Then
            strBWhere(1) = " And TM23='" & stNo1 & "' "
            strBWhere(2) = " And PA26='" & stNo1 & "' "
            strBWhere(3) = " And SP08='" & stNo1 & "' "
            strBWhere(4) = " And LC11='" & stNo1 & "' "
            strBWhere(5) = " And HC05='" & stNo1 & "' "
        Else
            strBWhere(1) = " And TM23>='" & stNo1 & "' And TM23<='" & stNo2 & "' "
            strBWhere(2) = " And PA26>='" & stNo1 & "' And PA26<='" & stNo2 & "' "
            strBWhere(3) = " And SP08>='" & stNo1 & "' And SP08<='" & stNo2 & "' "
            strBWhere(4) = " And LC11>='" & stNo1 & "' And LC11<='" & stNo2 & "' "
            strBWhere(5) = " And HC05>='" & stNo1 & "' And HC05<='" & stNo2 & "' "
        End If
            
        For ii = 1 To 5
            strBWhere(ii) = strBWhere(ii) & "And Base01 in(" & GetAddStr(strSysKind) & ") And Base04='00' "
            If ii <> 5 Then
                strBWhere(ii) = strBWhere(ii) & strSqlNation
            End If
        Next ii
    Else
'*** Y編號 [會 Run 案件基本檔FC代理人 及 進度代理人 CP44] ***
        intRunS = 1: intRunE = 1
        strBWhere(1) = " And TM44='" & stNo1 & "' "
        strBWhere(2) = " And PA75='" & stNo1 & "' "
        strBWhere(3) = " And SP26='" & stNo1 & "' "
        strBWhere(4) = " And LC22='" & stNo1 & "' "
        For ii = 1 To 4
            strBWhere(ii) = strBWhere(ii) & "And Base01 in(" & GetAddStr(strSysKind) & ") " & strSqlNation
        Next ii
    End If
    
    '申請/代理人查詢
    If UCase(stFormN) = UCase("frm100102_2") Or UCase(stFormN) = UCase("frm100114_2") Then
        '案件鈕:不是 法務專用
        If IsLaw = False Then
            strTB = ",Customer c1,Customer c2,Customer c3,Customer c4,Customer c5"
            
            '商標
            strBWhere_Fix(1) = "And SubStr(tm23,1,8)=C1.cu01(+) And Decode(SubStr(tm23,9,1),Null,'0',SubStr(tm23,9,1))=C1.cu02(+) " & _
                                            "And SubStr(tm78,1,8)=C2.cu01(+) And Decode(SubStr(tm78,9,1),Null,'0',SubStr(tm78,9,1))=C2.cu02(+) " & _
                                            "And SubStr(tm79,1,8)=C3.cu01(+) And Decode(SubStr(tm79,9,1),Null,'0',SubStr(tm79,9,1))=C3.cu02(+) " & _
                                            "And SubStr(tm80,1,8)=C4.cu01(+) And Decode(SubStr(tm80,9,1),Null,'0',SubStr(tm80,9,1))=C4.cu02(+) " & _
                                            "And SubStr(tm81,1,8)=C5.cu01(+) And Decode(SubStr(tm81,9,1),Null,'0',SubStr(tm81,9,1))=C5.cu02(+) "
            '專利
            strBWhere_Fix(2) = "And SubStr(pa26,1,8)=C1.cu01(+) And Decode(SubStr(pa26,9,1),Null,'0',SubStr(pa26,9,1))=C1.cu02(+) " & _
                                            "And SubStr(pa27,1,8)=C2.cu01(+) And Decode(SubStr(pa27,9,1),Null,'0',SubStr(pa27,9,1))=C2.cu02(+) " & _
                                            "And SubStr(pa28,1,8)=C3.cu01(+) And Decode(SubStr(pa28,9,1),Null,'0',SubStr(pa28,9,1))=C3.cu02(+) " & _
                                            "And SubStr(pa29,1,8)=C4.cu01(+) And Decode(SubStr(pa29,9,1),Null,'0',SubStr(pa29,9,1))=C4.cu02(+) " & _
                                            "And SubStr(pa30,1,8)=C5.cu01(+) And Decode(SubStr(pa30,9,1),Null,'0',SubStr(pa30,9,1))=C5.cu02(+) "
            '服務業務
            strBWhere_Fix(3) = "And SubStr(sp08,1,8)=C1.cu01(+) And Decode(SubStr(sp08,9,1),Null,'0',SubStr(sp08,9,1))=C1.cu02(+) " & _
                                            "And SubStr(sp58,1,8)=C2.cu01(+) And Decode(SubStr(sp58,9,1),Null,'0',SubStr(sp58,9,1))=C2.cu02(+) " & _
                                            "And SubStr(sp59,1,8)=C3.cu01(+) And Decode(SubStr(sp59,9,1),Null,'0',SubStr(sp59,9,1))=C3.cu02(+) " & _
                                            "And SubStr(sp65,1,8)=C4.cu01(+) And Decode(SubStr(sp65,9,1),Null,'0',SubStr(sp65,9,1))=C4.cu02(+) " & _
                                            "And SubStr(sp66,1,8)=C5.cu01(+) And Decode(SubStr(sp66,9,1),Null,'0',SubStr(sp66,9,1))=C5.cu02(+) "
            '法務
            strBWhere_Fix(4) = "And SubStr(lc11,1,8)=C1.cu01(+) And Decode(SubStr(lc11,9,1),Null,'0',SubStr(lc11,9,1))=C1.cu02(+) " & _
                                            "And SubStr(lc43,1,8)=C2.cu01(+) And Decode(SubStr(lc43,9,1),Null,'0',SubStr(lc43,9,1))=C2.cu02(+) " & _
                                            "And SubStr(lc44,1,8)=C3.cu01(+) And Decode(SubStr(lc44,9,1),Null,'0',SubStr(lc44,9,1))=C3.cu02(+) " & _
                                            "And SubStr(lc45,1,8)=C4.cu01(+) And Decode(SubStr(lc45,9,1),Null,'0',SubStr(lc45,9,1))=C4.cu02(+) " & _
                                            "And SubStr(lc46,1,8)=C5.cu01(+) And Decode(SubStr(lc46,9,1),Null,'0',SubStr(lc46,9,1))=C5.cu02(+) "
            '顧問
            strBWhere_Fix(5) = "And SubStr(hc05,1,8)=C1.cu01(+) And Decode(SubStr(hc05,9,1),Null,'0',SubStr(hc05,9,1))=C1.cu02(+) " & _
                                            "And SubStr(hc24,1,8)=C2.cu01(+) And Decode(SubStr(hc24,9,1),Null,'0',SubStr(hc24,9,1))=C2.cu02(+) " & _
                                            "And SubStr(hc25,1,8)=C3.cu01(+) And Decode(SubStr(hc25,9,1),Null,'0',SubStr(hc25,9,1))=C3.cu02(+) " & _
                                            "And SubStr(hc26,1,8)=C4.cu01(+) And Decode(SubStr(hc26,9,1),Null,'0',SubStr(hc26,9,1))=C4.cu02(+) " & _
                                            "And SubStr(hc27,1,8)=C5.cu01(+) And Decode(SubStr(hc27,9,1),Null,'0',SubStr(hc27,9,1))=C5.cu02(+) "
    
        '法務進度鈕:法務專用
        Else
            strTB = ",Customer C0,Staff s1,Staff s2,Staff s3,Fagent,SystemKind"
            
            '法務
            strBWhere_Fix(4) = "And SubStr(CP.CP56,1,8)=C0.cu01(+) And Decode(SubStr(CP.CP56,9,1),Null,'0',SubStr(CP.CP56,9,1))=C0.cu02(+) " & _
                                            "And CP.cp13=s1.st01(+) And CP.cp14=s2.st01(+) And CP.cp29=s3.st01(+) " & _
                                            "And SubStr(CP.cp44,1,8) = fa01(+) And SubStr(CP.cp44,9,1)=fa02(+) And CP.cp01=cpm01(+) And CP.cp10=cpm02(+) And CP.cp01=sk01(+) "
            '顧問
            strBWhere_Fix(5) = "And SubStr(CP.CP56,1,8)=C0.cu01(+) And Decode(SubStr(CP.CP56,9,1),Null,'0',SubStr(CP.CP56,9,1))=C0.cu02(+) " & _
                                            "And CP.cp13=s1.st01(+) And CP.cp14=s2.st01(+) And CP.cp29=s3.st01(+) " & _
                                            "And SubStr(CP.cp44,1,8) = fa01(+) And SubStr(CP.cp44,9,1)=fa02(+) And CP.cp01=cpm01(+) And CP.cp10=cpm02(+) And CP.cp01=sk01(+) "
            '代理人查詢->案件鈕(不用抓顧問資料)
            If UCase(stFormN) = UCase("frm100114_2") Then
                 strTB = strTB & ",Customer C1"
                 strBWhere_Fix(4) = strBWhere_Fix(4) & "And SubStr(LC11,1,8)=C1.cu01(+) And Decode(SubStr(LC11,9,1),Null,'0',SubStr(LC11,9,1))=C1.cu02(+) "
            End If
        End If
        
        '顯示 PCT案
        If bolShowPCT = True Then
            strField(1) = Replace(UCase(strField(1)), "TM15 AS 審定專利號數", "'' as PCT")
            strField(2) = Replace(UCase(strField(2)), "PA22 AS 審定專利號數", "pa46 as PCT")
            strField(3) = Replace(UCase(strField(3)), "NVL(SP14,SP13) AS 審定專利號數", "'' as PCT")
            strField(4) = Replace(UCase(strField(4)), "' ' AS 審定專利號數", "'' as PCT")
            strField(5) = Replace(UCase(strField(5)), "' ' AS 審定專利號數", "'' as PCT")
        End If
    '只查是否有案件(查詢第一畫面用)
    Else
        For ii = 1 To 5
            strField(ii) = "CP.cp01,CP.cp02,CP.cp03,CP.cp04 "
        Next ii
    End If
    
    If intRunE = 0 Then
        Pub_GetCusCaseSql = ""
        MsgBox "intR=0(不會執行),程式有誤！請洽電腦中心！"
        Exit Function
    End If
    
    For ii = intRunS To intRunE
        If ii = 2 Then strTp(0) = " Union "
        '申請人
        If IsXNo = True Then
            Select Case ii
                Case 1
                    strBWhere(1) = Replace(Replace(UCase(strBWhere(1)), UCase("Base0"), "TM0"), UCase("stNation"), "TM10") '商標
                    strBWhere(2) = Replace(Replace(UCase(strBWhere(2)), UCase("Base0"), "PA0"), UCase("stNation"), "PA09") '專利
                    strBWhere(3) = Replace(Replace(UCase(strBWhere(3)), UCase("Base0"), "SP0"), UCase("stNation"), "SP09") '服務業務
                    strBWhere(4) = Replace(Replace(UCase(strBWhere(4)), UCase("Base0"), "LC0"), UCase("stNation"), "LC15") '法務
                    strBWhere(5) = Replace(UCase(strBWhere(5)), UCase("Base0"), "HC0") '顧問
                    strTp(1) = strBWhere(1)
                    strTp(2) = strBWhere(2)
                    strTp(3) = strBWhere(3)
                    strTp(4) = strBWhere(4)
                    strTp(5) = strBWhere(5)
                Case 2
                    strTp(1) = Replace(strBWhere(1), "TM23", "TM78")
                    strTp(2) = Replace(strBWhere(2), "PA26", "PA27")
                    strTp(3) = Replace(strBWhere(3), "SP08", "SP58")
                    strTp(4) = Replace(strBWhere(4), "LC11", "LC43")
                    strTp(5) = Replace(strBWhere(5), "HC05", "HC24")
                Case 3
                    strTp(1) = Replace(strBWhere(1), "TM23", "TM79")
                    strTp(2) = Replace(strBWhere(2), "PA26", "PA28")
                    strTp(3) = Replace(strBWhere(3), "SP08", "SP59")
                    strTp(4) = Replace(strBWhere(4), "LC11", "LC44")
                    strTp(5) = Replace(strBWhere(5), "HC05", "HC25")
                Case 4
                    strTp(1) = Replace(strBWhere(1), "TM23", "TM80")
                    strTp(2) = Replace(strBWhere(2), "PA26", "PA29")
                    strTp(3) = Replace(strBWhere(3), "SP08", "SP65")
                    strTp(4) = Replace(strBWhere(4), "LC11", "LC45")
                    strTp(5) = Replace(strBWhere(5), "HC05", "HC26")
                Case 5
                    strTp(1) = Replace(strBWhere(1), "TM23", "TM81")
                    strTp(2) = Replace(strBWhere(2), "PA26", "PA30")
                    strTp(3) = Replace(strBWhere(3), "SP08", "SP66")
                    strTp(4) = Replace(strBWhere(4), "LC11", "LC46")
                    strTp(5) = Replace(strBWhere(5), "HC05", "HC27")
            End Select
        '代理人
        Else
            '基本檔代理人
            If ii = 1 Then
                strBWhere(1) = Replace(Replace(UCase(strBWhere(1)), UCase("Base0"), "TM0"), UCase("stNation"), "TM10") '商標
                strBWhere(2) = Replace(Replace(UCase(strBWhere(2)), UCase("Base0"), "PA0"), UCase("stNation"), "PA09") '專利
                strBWhere(3) = Replace(Replace(UCase(strBWhere(3)), UCase("Base0"), "SP0"), UCase("stNation"), "SP09") '服務業務
                strBWhere(4) = Replace(Replace(UCase(strBWhere(4)), UCase("Base0"), "LC0"), UCase("stNation"), "LC15") '法務
                strTp(1) = strBWhere(1)
                strTp(2) = strBWhere(2)
                strTp(3) = strBWhere(3)
                strTp(4) = strBWhere(4)
            End If
        End If
        
    '*** 不是法務專用 ***
        If IsLaw = False Then
            '商標
            strBAll(1) = strBAll(1) & strTp(0) & "Select Distinct " & strField(1) & "From TradeMark,CaseProgress CP,Nation" & strTB & strFilter(1) & " " & _
                            "Where tm01=CP.cp01(+) And tm02=CP.cp02(+) And tm03=CP.cp03(+) And tm04=CP.cp04(+) And tm10=na01(+) " & strTp(1) & _
                            strBWhere_Fix(1) & " " & strSQLCP & " " & strFilterW(1)
            '專利
            strBAll(2) = strBAll(2) & strTp(0) & "Select Distinct " & strField(2) & "From Patent,CaseProgress CP,Nation" & strTB & strFilter(2) & " " & _
                            "Where pa01=CP.cp01(+) And pa02=CP.cp02(+) And pa03=CP.cp03(+) And pa04=CP.cp04(+) And pa09=na01(+) " & strTp(2) & _
                            strBWhere_Fix(2) & " " & strSQLCP & " " & strFilterW(2)
            '服務業務
            strBAll(3) = strBAll(3) & strTp(0) & "Select Distinct " & strField(3) & "From ServicePractice,CaseProgress CP,Nation" & strTB & " " & _
                            "Where sp01=CP.cp01(+) And sp02=CP.cp02(+) And sp03=CP.cp03(+) And sp04=CP.cp04(+) And sp09=na01(+) " & strTp(3) & _
                             strBWhere_Fix(3) & " " & strSQLCP & " "
                        
        End If
    '*** End 不是法務專用 ***
        '法務
        strBAll(4) = strBAll(4) & strTp(0) & "Select Distinct " & strField(4) & "From LawCase,CaseProgress CP,Nation" & strTB & ",CasePropertyMap " & _
                        "Where lc01=CP.cp01(+) And lc02=CP.cp02(+) And lc03=CP.cp03(+) And lc04=CP.cp04(+) And lc15=na01(+) " & strTp(4) & _
                        strBWhere_Fix(4) & " " & strSQLCP & " And CP.cp01=cpm01(+) And CP.cp10=cpm02(+) "
        '顧問
        strBAll(5) = strBAll(5) & strTp(0) & "Select Distinct " & strField(5) & "From HireCase,CaseProgress CP" & strTB & IIf(IsLaw = True, ",CasePropertyMap ", " ") & _
                        "Where hc01=CP.cp01(+) And hc02=CP.cp02(+) And hc03=CP.cp03(+) And hc04=CP.cp04(+) " & strTp(5) & " " & _
                        strBWhere_Fix(5) & " " & strSQLCP
      
    Next ii

    
'*** 移轉人/移轉申請人 ***
    If bolRunTran = True Then
        '申請人查詢
        If UCase(stFormN) = UCase("frm100102_2") Then
            '案件鈕:不是法務專用
            If IsLaw = False Then
                strTB = ",Customer c1,Customer c2,Customer c3,Customer c4,Customer c5,Customer c6"
                
                'CP55 移轉人(讓與人) 1/CP56移轉申請人(讓與申請人)1/CP89~CP92移轉申請人(讓與申請人)2~5/CP93~CP96移轉人(讓與人)2~5
                'Modify by Amy 2024/12/11 原 Replace(Replace(strField(1), ",Decode(tm28,'1','','N')", ",'△'||Decode(tm28,'1','','N')"), ",Decode(tm123,Null,C1.cu01||C1.cu127,C1.cu01||tm123) CNT", ",C1.cu01||C1.cu127 CNT")
                ' ex:查蘇小姐 勾 X4049000-04->按案件鈕->不應出現 CFP-010825 (為X4049000-01案件)
                strField(1) = Replace(strField(1), ",Decode(tm28,'1','','N')", ",'△'||Decode(tm28,'1','','N')")
                strField(2) = Replace(strField(2), ",Decode(pa23,'1','','N')", ",'△'||Decode(pa23,'1','','N')")
                strField(3) = Replace(strField(3), ",sp01||'-'||sp02||'-'||sp03||'-'||sp04", ",'△'||sp01||'-'||sp02||'-'||sp03||'-'||sp04")
                strField(4) = Replace(strField(4), ",lc01||'-'||lc02||'-'||lc03||'-'||lc04", ",'△'||lc01||'-'||lc02||'-'||lc03||'-'||lc04")
                strField(5) = Replace(strField(5), ",hc01||'-'||hc02||'-'||hc03||'-'||hc04", ",'△'||hc01||'-'||hc02||'-'||hc03||'-'||hc04")
            End If
        End If
        For ii = 1 To 5
            'Modify by Amy 2023/03/06 +CP.
            If stNo1 = stNo2 Then
                strBWhere(ii) = " And CP.CP55='" & stNo1 & "' "
            Else
                strBWhere(ii) = " And CP.CP55>='" & stNo1 & "' And CP.CP55<='" & stNo2 & "' "
            End If
            '申請人查詢
            If UCase(stFormN) = UCase("frm100102_2") Then
                '案件鈕:不是法務專用
                If IsLaw = False Then
                    strBWhere(ii) = strBWhere(ii) & " And SubStr(CP.CP55,1,8)=C6.cu01(+) And Decode(SubStr(CP.CP55,9,1),Null,'0',SubStr(CP.CP55,9,1))=C6.cu02(+) "
                '法務進度鈕:法務專用
                Else
                    strBWhere(ii) = strBWhere(ii) & " And SubStr(CP.CP56,1,8)=C0.cu01(+) And Decode(SubStr(CP.CP56,9,1),Null,'0',SubStr(CP.CP56,9,1))=C0.cu02(+) "
                End If
            End If
            'end 2023/03/09
            strBWhere(ii) = strBWhere(ii) & "And Base01 in(" & GetAddStr(strSysKind) & ") "
            If ii <> 5 Then
                strBWhere(ii) = strBWhere(ii) & strSqlNation
            End If
        Next ii
        'Modify by Amy 2024/12/11 +if 接洽人編號,下列條件只抓8碼
        '   ex:申請人查詢 曾 選X4049000-01 ->按「案件」鈕 CFP-010825 不應出現兩筆(一筆為cp56抓到的資料),改以8碼抓資料才會過濾掉
        If InStr(stOrgNo, "-") > 0 Then
          strBWhere(1) = strBWhere(1) & "And (SubStr(TM23,1,8)<>'" & Left(stNo1, 8) & "' Or TM23 Is Null) And (SubStr(TM78,1,8)<>'" & Left(stNo1, 8) & "' Or TM78 Is Null) And (SubStr(TM79,1,8)<>'" & Left(stNo1, 8) & "' Or TM79 Is Null) And (SubStr(TM80,1,8)<>'" & Left(stNo1, 8) & "' Or TM80 Is Null) And (SubStr(TM81,1,8)<>'" & Left(stNo1, 8) & "' Or TM81 Is Null) "
          strBWhere(2) = strBWhere(2) & "And (SubStr(PA26,1,8)<>'" & Left(stNo1, 8) & "' Or PA26 Is Null) And (SubStr(PA27,1,8)<>'" & Left(stNo1, 8) & "' Or PA27 Is Null) And (SubStr(PA28,1,8)<>'" & Left(stNo1, 8) & "' Or PA28 Is Null) And (SubStr(PA29,1,8)<>'" & Left(stNo1, 8) & "' Or PA29 Is Null) And (SubStr(PA30,1,8)<>'" & Left(stNo1, 8) & "' Or PA30 Is Null) "
          strBWhere(3) = strBWhere(3) & "And (SubStr(SP08,1,8)<>'" & Left(stNo1, 8) & "' Or SP08 Is Null ) And (SubStr(SP58,1,8)<>'" & Left(stNo1, 8) & "' Or SP58 Is Null) And (SubStr(SP59,1,8)<>'" & Left(stNo1, 8) & "' Or SP59 Is Null) And (SubStr(SP65,1,8)<>'" & Left(stNo1, 8) & "' Or SP65 Is Null) And (SubStr(SP66,1,8)<>'" & Left(stNo1, 8) & "' Or SP66 Is Null)"
          strBWhere(4) = strBWhere(4) & "And (SubStr(LC11,1,8)<>'" & Left(stNo1, 8) & "' Or LC11 Is Null) And (SubStr(LC43,1,8)<>'" & Left(stNo1, 8) & "' Or LC43 Is Null) And (SubStr(LC44,1,8)<>'" & Left(stNo1, 8) & "' Or LC44 Is Null) And (SubStr(LC45,1,8)<>'" & Left(stNo1, 8) & "' Or LC45 Is Null) And (SubStr(LC46,1,8)<>'" & Left(stNo1, 8) & "' Or LC46 Is Null) "
          strBWhere(5) = strBWhere(5) & "And (SubStr(HC05,1,8)<>'" & Left(stNo1, 8) & "' Or HC05 Is Null) And (SubStr(HC24,1,8)<>'" & Left(stNo1, 8) & "' Or HC24 Is Null) And (SubStr(HC25,1,8)<>'" & Left(stNo1, 8) & "' Or HC25 Is Null) And (SubStr(HC26,1,8)<>'" & Left(stNo1, 8) & "' Or HC26 Is Null) And (SubStr(HC27,1,8)<>'" & Left(stNo1, 8) & "' Or HC27 Is Null) "
        Else
          strBWhere(1) = strBWhere(1) & "And (TM23<>'" & stNo1 & "' Or TM23 Is Null) And (TM78<>'" & stNo1 & "' Or TM78 Is Null) And (TM79<>'" & stNo1 & "' Or TM79 Is Null) And (TM80<>'" & stNo1 & "' Or TM80 Is Null) And (TM81<>'" & stNo1 & "' Or TM81 Is Null) "
          strBWhere(2) = strBWhere(2) & "And (PA26<>'" & stNo1 & "' Or PA26 Is Null) And (PA27<>'" & stNo1 & "' Or PA27 Is Null) And (PA28<>'" & stNo1 & "' Or PA28 Is Null) And (PA29<>'" & stNo1 & "' Or PA29 Is Null) And (PA30<>'" & stNo1 & "' Or PA30 Is Null) "
          strBWhere(3) = strBWhere(3) & "And (SP08<>'" & stNo1 & "' Or SP08 Is Null ) And (SP58<>'" & stNo1 & "' Or SP58 Is Null) And (SP59<>'" & stNo1 & "' Or SP59 Is Null) And (SP65<>'" & stNo1 & "' Or SP65 Is Null) And (SP66<>'" & stNo1 & "' Or SP66 Is Null)"
          strBWhere(4) = strBWhere(4) & "And (LC11<>'" & stNo1 & "' Or LC11 Is Null) And (LC43<>'" & stNo1 & "' Or LC43 Is Null) And (LC44<>'" & stNo1 & "' Or LC44 Is Null) And (LC45<>'" & stNo1 & "' Or LC45 Is Null) And (LC46<>'" & stNo1 & "' Or LC46 Is Null) "
          strBWhere(5) = strBWhere(5) & "And (HC05<>'" & stNo1 & "' Or HC05 Is Null) And (HC24<>'" & stNo1 & "' Or HC24 Is Null) And (HC25<>'" & stNo1 & "' Or HC25 Is Null) And (HC26<>'" & stNo1 & "' Or HC26 Is Null) And (HC27<>'" & stNo1 & "' Or HC27 Is Null) "
        End If
        'end 2024/12/11
        
        strBWhere(1) = Replace(Replace(UCase(strBWhere(1)), UCase("Base0"), "TM0"), UCase("stNation"), "TM10")
        strBWhere(2) = Replace(Replace(UCase(strBWhere(2)), UCase("Base0"), "PA0"), UCase("stNation"), "PA09")
        strBWhere(3) = Replace(Replace(UCase(strBWhere(3)), UCase("Base0"), "SP0"), UCase("stNation"), "SP09")
        strBWhere(4) = Replace(Replace(UCase(strBWhere(4)), UCase("Base0"), "LC0"), UCase("stNation"), "LC15")
        strBWhere(5) = Replace(UCase(strBWhere(5)), UCase("Base0"), "HC0")
        
        '原條件(CP158>0 OR CP159=0),否則未發文CP158=0且已取消收文CP159>0也會出現 ex:X28819010查案件,不應該帶出CFT-011352-秀玲
        'X75109010不應查出P-115659/P-115660,已發文但是後來有取消收文-秀玲
        'Modify by Amy 2023/03/06 +CP.
        strSQLCP = strSQLCP & "And CP.CP159=0 "
        
'        'Add by Amy 2023/03/06 e符號語法優化,避免未來資料多跑的慢
'        strFilter(1) = ",CaseProgress E1"
'        strFilter(2) = ",CaseProgress E1"
'        strFilterW(1) = Replace(Replace(Replace(專利進度註冊費已發文語法, "cp", "E1.cp"), "601", "717"), "pa", "tm")
'        strFilterW(2) = Replace(專利進度註冊費已發文語法, "cp", "E1.cp")
'
'        strField(1) = Replace(UCase(strField(1)), UCase("Decode(cp10,'717','e')"), UCase("Decode(E1.cp10,'717','e')"))
'        strField(2) = Replace(UCase(strField(2)), UCase("Decode(cp10,'601','e')"), UCase("Decode(E1.cp10,'601','e')"))
'        'end 2023/03/06
        
        '案件鈕:不是法務專用
        If IsLaw = False Then
            For ii = 0 To 10
                Select Case ii
                    Case 0 'CP55 移轉人(讓與人) 1
                        strTp(1) = strBWhere(1)
                        strTp(2) = strBWhere(2)
                        strTp(3) = strBWhere(3)
                    Case 1 'CP56 移轉申請人(讓與申請人)1
                        strTp(1) = Replace(strBWhere(1), "CP55", "CP56")
                        strTp(2) = Replace(strBWhere(2), "CP55", "CP56")
                        strTp(3) = Replace(strBWhere(3), "CP55", "CP56")
                    Case 2 'CP72 被授權人
                        strTp(1) = Replace(strBWhere(1), "CP55", "CP72")
                        strTp(2) = Replace(strBWhere(2), "CP55", "CP72")
                        strTp(3) = Replace(strBWhere(3), "CP55", "CP72")
                    Case Else   'CP89~96 CP89~CP92移轉申請人(讓與申請人)2~5/CP93~CP96移轉人(讓與人)2~5
                        strTp(1) = Replace(strBWhere(1), "CP55", "CP" & 86 + ii)
                        strTp(2) = Replace(strBWhere(2), "CP55", "CP" & 86 + ii)
                        strTp(3) = Replace(strBWhere(3), "CP55", "CP" & 86 + ii)
                End Select
                
                'Modify by Amy 2023/03/06 +CP.
                '商標
                strBAll(1) = strBAll(1) & strTp(0) & "Select Distinct " & strField(1) & "From TradeMark,CaseProgress CP,Nation" & strTB & strFilter(1) & " " & _
                                "Where CP.cp01=tm01(+) And CP.cp02=tm02(+) And CP.cp03=tm03(+) And CP.cp04=tm04(+) And tm10=na01(+) " & strTp(1) & _
                                strBWhere_Fix(1) & " " & strSQLCP & " " & strFilterW(1)
                '專利
                strBAll(2) = strBAll(2) & strTp(0) & "Select " & strField(2) & "From Patent,CaseProgress CP,Nation" & strTB & strFilter(2) & " " & _
                                "Where CP.cp01=pa01(+) And CP.cp02=pa02(+) And CP.cp03=pa03(+) And CP.cp04=pa04(+) And pa09=na01(+) " & strTp(2) & _
                                strBWhere_Fix(2) & " " & strSQLCP & " " & strFilterW(2)
                '服務業務
                strBAll(3) = strBAll(3) & strTp(0) & "Select Distinct " & strField(3) & "From ServicePractice,CaseProgress CP,Nation" & strTB & " " & _
                                "Where CP.cp01=sp01(+) And CP.cp02=sp02(+) And CP.cp03=sp03(+) And CP.cp04=sp04(+) And sp09=na01(+) " & strTp(3) & _
                                strBWhere_Fix(3) & " " & strSQLCP
                'end 2023/03/06
            Next ii
        End If 'End 案件鈕:不是法務專用
        
        For ii = 1 To 3
            Select Case ii
                Case 1 'CP55 移轉人(讓與人) 1
                    strTp(4) = strBWhere(4)
                    strTp(5) = strBWhere(5)
                Case 2 'CP56 移轉申請人(讓與申請人)1
                    strTp(4) = Replace(strBWhere(4), "CP55", "CP56")
                    strTp(5) = Replace(strBWhere(5), "CP55", "CP56")
                Case 3 'CP72 被授權人
                    strTp(4) = Replace(strBWhere(4), "CP55", "CP72")
                    strTp(5) = Replace(strBWhere(5), "CP55", "CP72")
            End Select
            '法務
            strBAll(4) = strBAll(4) & strTp(0) & "Select " & strField(4) & "From LawCase,CaseProgress CP,Nation" & strTB & ",CasePropertyMap " & _
                                "Where CP.cp01=lc01(+) And CP.cp02=lc02(+) And CP.cp03=lc03(+) And CP.cp04=lc04(+) And lc15=na01(+) " & strTp(4) & _
                                strBWhere_Fix(4) & strSQLCP & " And cp01=cpm01(+) And cp10=cpm02(+) "
            '顧問
            strBAll(5) = strBAll(5) & strTp(0) & "Select " & strField(5) & "From HireCase,CaseProgress CP" & strTB & IIf(IsLaw = True, ",CasePropertyMap ", " ") & _
                                "Where CP.cp01=hc01(+) And CP.cp02=hc02(+) And CP.cp03=hc03(+) And CP.cp04=hc04(+) " & strTp(5) & _
                                strBWhere_Fix(5) & strSQLCP & "And CP.cp01=hc01(+) And CP.cp02=hc02(+) And CP.cp03=hc03(+) And CP.cp04=hc04(+) "
        Next ii
    End If
'*** End 移轉人/移轉申請人 ***

'*** 查進度檔代理人 CP44 ***
    If IsXNo = False Then
        strTp(0) = " Union "
        For ii = 1 To 4
            strTp(ii) = " And CP44='" & stNo1 & "' "
        Next ii
        strTp(1) = strTp(1) & " And CP01 in(" & SQLGrpStr(strSysKind, 2) & ") " & Replace(UCase(strSqlNation), UCase("stNation"), "TM10")
        strTp(2) = strTp(2) & " And CP01 in(" & SQLGrpStr(strSysKind, 1) & ") " & Replace(UCase(strSqlNation), UCase("stNation"), "PA09")
        strTp(3) = strTp(3) & " And CP01 in(" & SQLGrpStr(strSysKind, 5) & ") " & Replace(UCase(strSqlNation), UCase("stNation"), "SP09")
        strTp(4) = strTp(4) & " And CP01 in(" & SQLGrpStr(strSysKind, 3) & ") " & Replace(UCase(strSqlNation), UCase("stNation"), "LC15")
        '不是 法務專用
        If IsLaw = False Then
            '商標
            strBAll(1) = strBAll(1) & strTp(0) & "Select Distinct " & strField(1) & "From TradeMark,CaseProgress CP,Nation" & strTB & " " & _
                            "Where CP.cp01=tm01(+) And CP.cp02=tm02(+) And CP.cp03=tm03(+) And CP.cp04=tm04(+) And tm10=na01(+) " & strTp(1) & _
                            strBWhere_Fix(1) & " " & strSQLCP
            '專利
            strBAll(2) = strBAll(2) & strTp(0) & "Select Distinct " & strField(2) & "From Patent,CaseProgress CP,Nation" & strTB & " " & _
                            "Where CP.cp01=pa01(+) And CP.cp02=pa02(+) And CP.cp03=pa03(+) And CP.cp04=pa04(+) And pa09=na01(+) " & strTp(2) & _
                            strBWhere_Fix(2) & " " & strSQLCP
            '服務業務
            strBAll(3) = strBAll(3) & strTp(0) & "Select Distinct " & strField(3) & "From ServicePractice,CaseProgress CP,Nation" & strTB & " " & _
                            "Where CP.cp01=sp01(+) And CP.cp02=sp02(+) And CP.cp03=sp03(+) And CP.cp04=sp04(+) And sp09=na01(+) " & strTp(3) & _
                             strBWhere_Fix(3) & " " & strSQLCP & " "
        End If
        '法務
        strBAll(4) = strBAll(4) & strTp(0) & "Select Distinct " & strField(4) & "From LawCase,CaseProgress CP,Nation" & strTB & ",CasePropertyMap " & _
                        "Where CP.cp01=lc01(+) And CP.cp02=lc02(+) And CP.cp03=lc03(+) And CP.cp04=lc04(+) And lc15=na01(+) " & strTp(4) & _
                        strBWhere_Fix(4) & " " & strSQLCP & " And CP.cp01=cpm01(+) And CP.cp10=cpm02(+) "
                         
    End If
'*** End 查進度檔代理人 CP44 ***
    
    '申請人
    If IsXNo = True Then
        If IsLaw = False Then
            Pub_GetCusCaseSql = strBAll(1) & " Union " & strBAll(2) & " Union " & strBAll(3) & " Union " & strBAll(4) & " Union " & strBAll(5)
        Else
            Pub_GetCusCaseSql = strBAll(4) & " Union " & strBAll(5)
        End If
    '代理人
    Else
        If IsLaw = False Then
            Pub_GetCusCaseSql = strBAll(1) & " Union " & strBAll(2) & " Union " & strBAll(3) & " Union " & strBAll(4)
        Else
            Pub_GetCusCaseSql = strBAll(4)
        End If
    End If
End Function

'Add by Amy 2023/08/25 依共同查詢Grid狀態設定顏色
'intChoose:0-未選取(依狀態設定顏色)/1-選取/2-複製
Public Sub SetMSGridColorQCus(intChoose As Integer, stFormN As String, ByRef GrdTp As MSHFlexGrid, arrCol() As String, Optional bolNoCase As Boolean = False)
   Dim i As Integer, intStart As Integer, intEnd As Integer
   
   'X 或 Y 編號若 無案件 編號顯示▼
   If bolNoCase = True Then
      If Left(GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "編號")), 1) = 客戶編號 Or Left(GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "編號")), 1) = 代理人編號 Then
         If ChkXYCase(stFormN, Left(GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "編號")), 9)) = False And InStr(GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "編號")), "▼") = 0 Then
            GrdTp.col = GetColVal(arrCol, "編號")
            GrdTp.Text = GrdTp.Text & "▼"
         End If
      End If
   End If
   '未選取(依狀態設定顏色) or 複製(設回原本顏色)
   If intChoose = 0 Or intChoose = 2 Then
      intStart = 0: intEnd = GrdTp.Cols - 1
      '複製(設回原本顏色)
      If intChoose = 2 Then
         intStart = GetColVal(arrCol, "編號")
         intEnd = intStart
      End If
      For i = intStart To intEnd
         GrdTp.col = i
         '未選取(依狀態設定顏色)
         If intChoose = 0 And i = GetColVal(arrCol, "編號") Then
         Else
            GrdTp.CellBackColor = QBColor(15) '先設回
         End If
'****** 設定整列 ******
         '待活化客戶且非舊名稱
         'Modify by Amy 2023/09/19 舊名稱也要顯示黃色,拿掉 And Right(GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "編號")), 1) <> "＊"
         If GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "待活化客戶")) = "0" Then
            GrdTp.CellBackColor = vbYellow '整列底 黃色
         '不得代理資料表 or 對造
         ElseIf Right(GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "編號")), 1) = "♁" Or GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "狀態")) = "對造" Then
            GrdTp.CellBackColor = &H8080FF '整列底 紅色
         'Add by Amy 2023/12/12 狀態 為「風險警示」顯示 整列底 紫色
         ElseIf GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "狀態")) = "風險警示" Then
            GrdTp.CellBackColor = RGB(147, 112, 219) '紫色
         '編號為Y/X/R 且 客戶狀態 為 解散/廢止/撤銷/死亡 顯示黑底
         ElseIf (Left(GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "編號")), 1) = "Y" Or Left(GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "編號")), 1) = "X" Or Left(GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "編號")), 1) = "R") _
           And (GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "狀態")) = "解散" Or GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "狀態")) = "廢止" _
           Or GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "狀態")) = "撤銷" Or GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "狀態")) = "死亡") Then
            GrdTp.CellBackColor = &H0 '整列底 黑色
            GrdTp.CellForeColor = &HFF00FF '粉紅色 字
         End If
'****** End 設定整列 ******
      Next i
'****** 設定單欄 ******
      If intChoose = 0 Then GrdTp.col = GetColVal(arrCol, "編號")
      '呆帳
      If Right(GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "編號")), 1) = "$" Then
         GrdTp.CellBackColor = &HFF& '編號欄 紅色底
      '針對CW03=7.媒介平台,顯示橘色 ex:Questel
      ElseIf Left(GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "編號")), 1) = "平" And GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "案件性質")) = "7" Then
         GrdTp.CellBackColor = &H80FF& '編號欄 橘色底
      End If
      '未選取(依狀態設定顏色) 且狀態為不得代理
      If intChoose = 0 And GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "狀態")) = "不得代理" Then
         GrdTp.col = GetColVal(arrCol, "狀態")
         GrdTp.CellBackColor = &H8080FF '狀態欄 紅色底
      End If
'****** End 設定單欄 ******
   '選取(勾選)
   ElseIf intChoose = 1 Then
      For i = 0 To GrdTp.Cols - 1
         If i <> GetColVal(arrCol, "編號") And _
           ((i = GetColVal(arrCol, "名稱") And Right(GrdTp.TextMatrix(GrdTp.MouseRow, GetColVal(arrCol, "編號")), 1) = "♁") _
           Or (i = GetColVal(arrCol, "狀態") And GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "狀態")) = "不得代理")) = False Then
            GrdTp.col = i
            GrdTp.CellBackColor = &HFFC0C0 '整列底 藍色
         End If
      Next i
   End If

End Sub

'取得欄位對應位置 Modify by Amy 2023/10/24 原:Private
'Modify by Amy 2024/01/08 +intStart
Public Function GetColVal(arrCol() As String, pFieldN As String, Optional ByVal intStart As Integer = 1) As Integer
    Dim jj As Integer
 
    For jj = intStart To UBound(arrCol)
        If UCase(arrCol(jj)) = UCase(pFieldN) Then
            GetColVal = jj
            Exit For
        End If
    Next jj
End Function

'傳入之X/Y編號是否有案件(從申請人查詢搬過來）
Public Function ChkXYCase(stFormN As String, stNo As String) As Boolean
    Dim RsQ As New ADODB.Recordset, intQ As Integer, stQ As String
    
    ChkXYCase = False
    'Modify by Amy 2023/10/13 於共用函數判斷取聯絡人編號,原:Pub_GetCusCaseSql(stFormN, stNo,stNo, …)
    stQ = Pub_GetCusCaseSql(stFormN, stNo, "ALL", False, False)
    intQ = 1
    Set RsQ = ClsLawReadRstMsg(intQ, stQ)
    If intQ = 1 Then
        ChkXYCase = True
    End If
    Set RsQ = Nothing
End Function

'共同查詢-客戶按鈕
'stQType:查詢類別 1.收文/2.發文
'stDateS/stDateE:收文日(申請人/代理人 案件資料、法務進度 用) OR 往來日期(潛在客戶 往來寄錄 用) 起/迄
'stCp10S/stCp10E:案件性質 起/迄
'stApplyCountryS/stApplyCountryE:申請國家 起/迄
'ChkPCT=true:顯示PCT 案
'bolNoCase=True:顯示無案件
'stOfficialLetter=N:不含來函資料(CP09<'C')-申請人查詢 用
'm_bolPrintRight=True '可列印名條(申請人查詢 用)
'stCRType:往來類別(潛在客戶查詢 用)
'StCondition:比對方式(列印對造資料 用)
Public Sub PubShowNextForm(ByVal cmdState As Integer, oForm As Form, ByRef GrdTp As MSHFlexGrid, arrCol() As String, bolNoCase As Boolean, _
 Optional ByVal ChkPCT As Boolean = False, Optional ByVal stSysKind As String = "", Optional ByVal stQType As String = "", _
 Optional ByVal stDateS As String = "", Optional ByVal stDateE As String = "", Optional ByVal stCP10S As String = "", Optional ByVal stCP10E As String = "", _
 Optional ByVal stApplyCountryS As String = "", Optional ByVal stApplyCountryE As String = "", _
 Optional ByVal stOfficialLetter As String = "", Optional ByVal m_bolPrintRight As Boolean = False, Optional ByVal stCRType As String = "", Optional ByVal stCondition As String = "")
   Dim i As Integer, j As Integer, idx1 As Integer, idx2 As Integer, strTmp As String
   Dim strCaseNo As String, bA4Print As Variant, bolShowNext As Boolean '本所案號(for 對造)/是否列印A4名條選項/顯示表單
   Dim nFrm As Form
   Dim strEx(0 To 10) As String, intA As Integer, rsAD As New ADODB.Recordset 'Added by Lydia 2024/05/15
   
   If cmdState = 99 Then GoTo EXITSUB '電腦中心人員操作[查詢置換字]鈕,結束時不應該再執行上次存留cmdState變數,故設cmdState = 99為不執行
   '以 申請人查詢 案鈕為主
'    Select Case cmdState
'      Case 0 '申請人/代理人/潛在客戶資料
'      Case 1 '案件資料
'      Case 2 '關係企業
'      Case 3 '結束
'      Case 4 '地址條(只有申請人查詢有-不會傳入)
'      Case 5 '專利相關案(只有申請人查詢有)
'      Case 6 '相關多申請人(只有申請人查詢有)
'      Case 7 '法務進度
'      Case 8 '往來記錄
'      Case 9 '接洽人/聯絡人
'      Case 10 '列印對造資料
'      Case 11 '以申請人查最近(一個月)以內的寄送資料
'      Case 12 '寄發信函-往來記錄
'      Case 13 '案件統計(只有代理人查詢有)
'   End Select
   bolShowNext = False
   idx1 = 2 '關係企業 鈕
   idx2 = 8 '往來記錄 鈕
   Select Case oForm.Name
      Case "frm100114_1" '代理人查詢
         idx2 = 6 '往來記錄
         '回上一頁(被Grid遮住)/結束
         If cmdState = 3 Or cmdState = 4 Then
            cmdState = 3
         '法務進度
         ElseIf cmdState = 5 Then
            cmdState = 7
         '往來記錄
         ElseIf cmdState = 6 Then
            cmdState = 8
         '聯絡人
         ElseIf cmdState = 7 Then
            cmdState = 9
         '列印對造
         ElseIf cmdState = 8 Then
            cmdState = 10
         '案件統計
         ElseIf cmdState = 9 Then
            cmdState = 13
         '寄發信函
         ElseIf cmdState = 10 Then
            cmdState = 12
         End If
      Case "frm140407" '國外潛在客戶查詢
         idx1 = 1 '關係企業
         idx2 = 4 '往來記錄 鈕
         '聯絡人
         If cmdState = 0 Then
            cmdState = 9
         '關係企業
         ElseIf cmdState = 1 Then
            cmdState = 2
         '潛在客戶資料
         ElseIf cmdState = 2 Then
            cmdState = 0
         '往來記錄
         ElseIf cmdState = 4 Then
            cmdState = 8
         '列印對造
         ElseIf cmdState = 5 Then
            cmdState = 10
         End If
      Case "frm210130" '國內潛在客戶查詢
         idx1 = 1 '關係企業
         idx2 = 4 '往來記錄
         '關係企業
         If cmdState = "1" Then
            cmdState = 2
         '潛在客戶資料
         ElseIf cmdState = "2" Then
            cmdState = 0
         '往來記錄
         ElseIf cmdState = "4" Then
            cmdState = 8
         '列印對造
         ElseIf cmdState = 5 Then
            cmdState = 10
         End If
   End Select
   
   If cmdState = 2 Then
      strEx(9) = "" '勾選清單
   End If
   
   '不是 結束/列印對造資料/寄發信函-往來記錄
   If cmdState <> 3 And cmdState <> 10 And cmdState <> 12 Then
      oForm.Enabled = False
      For i = 1 To GrdTp.Rows - 1
         strTmp = ""
         GrdTp.col = 0
         GrdTp.row = i
         '已勾選
         If Trim(GrdTp.Text) = "V" Then
            GrdTp.Text = ""
            '設定Grid顏色
            Call SetMSGridColorQCus(0, oForm.Name, GrdTp, arrCol, bolNoCase)
            GrdTp.col = 1
            If Not IsNull(GrdTp.Text) Then
               If cmdState <> 2 Then
                  If cmdState = 11 And Left(Pub_RplStr(GrdTp.Text), 1) <> "X" Then
                  Else
                     If fnSaveParentForm(oForm) = False Then
                        oForm.Enabled = True
                        GoTo EXITSUB
                     End If
                  End If
               End If
               Screen.MousePointer = vbHourglass
               Select Case cmdState
                  Case 0 '申請人/代理人/潛在客戶 資料
                     '判斷第一碼切不同畫面
                     strTmp = Pub_RplStr(GrdTp.Text)
                     Select Case Left(strTmp, 1)
                        Case "X" '申請人
                           If Mid(strTmp, 10, 1) = "-" Then
                              strTmp = Left(strTmp, 9)
                           End If
                           Set nFrm = Forms(0).GetForm("frm100101_11")
                           If Not nFrm Is Nothing Then
                              nFrm.Show
                              nFrm.Tag = strTmp
                              nFrm.StrMenu
                           End If
                        Case "Y" '代理人
                           '[非]代理人查詢進入者,需判斷有權限的才能查代理人的資料
                           If oForm.Name <> "frm100114_1" Then
                              If bolFNation = True Then
                                 bolShowNext = True
                              End If
                           Else
                              bolShowNext = True
                           End If
                           If bolShowNext = True Then
                              If Mid(strTmp, 10, 1) = "-" Then
                                 strTmp = Left(strTmp, 9)
                              End If
                              Set nFrm = Forms(0).GetForm("frm100101_10")
                              If Not nFrm Is Nothing Then
                                 nFrm.Show
                                 nFrm.Tag = strTmp
                                 nFrm.StrMenu
                              End If
                           Else
                              oForm.Show
                              MsgBox "您無查詢國外代理人資料權限！", vbInformation
                           End If
                        Case "R" '潛在客戶
                           '判斷是國外或是國內
                           strEx(0) = "select * from potcustomer where pcu01(+)='" & Left(strTmp, 8) & "' and pcu02(+)='" & Mid(strTmp, 9, 1) & "' "
                           intA = 1
                           Set rsAD = ClsLawReadRstMsg(intA, strEx(0))
                           strEx(2) = ""
                           If intA = 1 Then
                              strEx(2) = "" & rsAD.Fields(0)
                           End If
                           If strEx(2) <> "" Then '國外
                              Set nFrm = Forms(0).GetForm("frm100101_14")
                           Else '國內
                              Set nFrm = Forms(0).GetForm("frm100101_21")
                           End If
                           If Not nFrm Is Nothing Then
                              nFrm.Show
                              nFrm.Tag = strTmp
                              nFrm.StrMenu
                           End If
                        Case "平" '客戶端平台帳號
                           '改以平台編號抓權限
                           If PUB_ChkCustWebLimit(GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "收文日")), strUserNum) = True Then
                              Set nFrm = Forms(0).GetForm("frm100101_27")
                              If Not nFrm Is Nothing Then
                                 nFrm.Show
                                 nFrm.Tag = Trim(GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "收文日")))
                                 nFrm.StrMenu
                              End If
                           Else
                              oForm.Show
                              MsgBox "您無權限查詢此客戶端平台帳號！", vbInformation
                           End If
                        Case Else
                           '不得代理案件之客戶或代理人
                           If InStr(strTmp, "-") = 0 Then
                              Set nFrm = Forms(0).GetForm("frm100101_25")
                           '投資法務開拓客戶資料
                           Else
                              Set nFrm = Forms(0).GetForm("frm100101_22")
                           End If
                           If Not nFrm Is Nothing Then
                              nFrm.Show
                              nFrm.Tag = strTmp
                              nFrm.StrMenu
                           End If
                     End Select
                  Case 1, 7 '1.案件資料/7.法務進度
                     '本所案號抓案件資料
                     If cmdState = 1 _
                      And (GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "狀態")) = "對造" Or GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "狀態")) = "其他相關人") Then
                           strCaseNo = Pub_RplStr(GrdTp.Text)
                           strTmp = GetPrjPeopleNum1(strCaseNo)
                     Else
                        strTmp = Pub_RplStr(GrdTp.Text)
                     End If
                     Select Case Left(strTmp, 1)
                        Case "X" '申請人
                           Set nFrm = Forms(0).GetForm("frm100102_2")
                        Case "Y" '代理人
                           '[非]代理人查詢進入者,需判斷有權限的才能查代理人的資料
                           If oForm.Name <> "frm100114_1" Then
                              If bolFNation = True Then
                                 bolShowNext = True
                              End If
                           Else
                              bolShowNext = True
                           End If
                           If bolShowNext = True Then
                              Set nFrm = Forms(0).GetForm("frm100114_2")
                           Else
                              oForm.Show
                              MsgBox "您無查詢國外代理人" & IIf(cmdState = 7, "法務進度", "案件") & "資料權限！", vbInformation
                           End If
                        Case "R" '潛在客戶
                           oForm.Show
                           MsgBox "該編號為潛在客戶不會有" & IIf(cmdState = 7, "法務進度", "案件") & "資料！", vbInformation
                       Case Else
                        oForm.Show
                        '不得代理 或 按[法務進度]鈕且狀態為[對造] Or[其他相關人] 彈訊息
                        If GrdTp.TextMatrix(i, GetColVal(arrCol, "狀態")) = "不得代理" Or _
                          (cmdState = 7 And (GrdTp.TextMatrix(i, GetColVal(arrCol, "狀態")) = "對造" Or GrdTp.TextMatrix(i, GetColVal(arrCol, "狀態")) = "其他相關人")) Then
                           MsgBox "該編號為不會有" & IIf(cmdState = 7, "法務進度", "案件") & "資料！", vbInformation
                        End If
                     End Select
                     If Not nFrm Is Nothing Then
                        nFrm.Show
                        nFrm.Tag = strTmp
                        'Modify by Amy 2025/04/29 直接設定會錯
                        'nFrm.ChkPCT.Value = ChkPCT
                        If ChkPCT = True Then
                           nFrm.ChkPCT.Value = vbChecked
                        End If
                        'end 2025/04/29
                        '法務進度
                        If cmdState = 7 Then nFrm.bolIsL = True
                        '案件資料且有案號
                        If cmdState = 1 And strCaseNo <> MsgText(601) Then
                           nFrm.m_CaseNo = strCaseNo
                           nFrm.StrMenu4 '對造資料
                        Else
                           '為使查詢案件畫面共用條件改參數方式傳遞且查詢結果改與代理人查詢相同
                           nFrm.m_Sys = stSysKind
                           nFrm.m_Type = stQType
                           nFrm.m_Date1 = stDateS
                           nFrm.m_Date2 = stDateE
                           nFrm.m_Pty1 = stCP10S
                           nFrm.m_Pty2 = stCP10E
                           '申請人查詢
                           If oForm.Name = "frm100102_1" Then
                              nFrm.m_CKind = stOfficialLetter
                           End If
                           nFrm.m_Cty1 = stApplyCountryS
                           nFrm.m_Cty2 = stApplyCountryE
                           nFrm.StrMenu
                        End If
                     End If
                  Case 2 '關係企業
                     '檢查國內外權限
                     If CheckSR12(Pub_RplStr(GrdTp.Text)) = True Then
                        j = PUB_GetR100114_1(IIf(strEx(9) = "", True, False), oForm.Name, Pub_RplStr(GrdTp.Text))
                        strEx(9) = strEx(9) & IIf(strEx(9) <> "", ",", "") & Pub_RplStr(GrdTp.Text)
                        oForm.cmdOK(idx1).Enabled = False '關係企業 鈕
                     End If
                  Case 5 '專利相關案
                     Set nFrm = Forms(0).GetForm("frm100101_h")
                     If Not nFrm Is Nothing Then
                        nFrm.Show
                        nFrm.KeyString = Pub_RplStr(GrdTp.Text)
                        nFrm.SearchKind = "客戶編號"
                        nFrm.StrMenu
                     End If
                  Case 6 '相關多申請人
                     Set nFrm = Forms(0).GetForm("frm100102_4")
                     If Not nFrm Is Nothing Then
                        nFrm.Show
                        nFrm.KeyString = Pub_RplStr(GrdTp.Text)
                        nFrm.StrMenu
                     End If
                  Case 8 '往來記錄
                     strTmp = Pub_RplStr(GrdTp.Text)
                     '客戶檔
                     strEx(3) = "select cu12,cu13 from customer where cu01(+)='" & Left(strTmp, 8) & "' and cu02(+)='" & Mid(strTmp, 9, 1) & "' "
                     intA = 1
                     Set rsAD = ClsLawReadRstMsg(intA, strEx(3))
                     strEx(4) = ""
                     If intA = 1 Then
                        strEx(4) = "" & rsAD.Fields("cu12")
                     End If
                     '國外潛在客戶檔
                     strEx(0) = "select * from potcustomer where pcu01(+)='" & Left(strTmp, 8) & "' and pcu02(+)='" & Mid(strTmp, 9, 1) & "' "
                     intA = 1
                     Set rsAD = ClsLawReadRstMsg(intA, strEx(0))
                     strEx(2) = ""
                     If intA = 1 Then
                        strEx(2) = "" & rsAD.Fields(0)
                     End If
                     Set nFrm = Forms(0).GetForm("frm100101_15")
                     If Not nFrm Is Nothing Then
                        nFrm.Show
                        '國外潛在客戶
                        If oForm.Name = "frm140407" Or oForm.Name = "frm210130" Then
                           nFrm.CRdateF = stDateS
                           nFrm.CRdateT = IIf(Len(stDateE) <= 0, "", IIf(Len(stDateE) <= 0, (ServerDate - 19110000), stDateE))
                           If oForm.Name = "frm140407" Then nFrm.CRtype = stCRType
                        End If
                        nFrm.Tag = strTmp
                        'Modify by Amy 2023/11/03 +bolFNation(同 國外代理人權限)-秀玲
                        'Modify By Sindy 2025/9/1 ex:R12194 國內潛在客戶
                        If Left(strTmp, 1) = "R" And strEx(2) = "" Then
                           nFrm.m_quyDataKind = 1 '國內
                           nFrm.StrMenu2
                        '2025/9/1 END
                        ElseIf strEx(2) <> "" Or _
                           (Left(Trim(strTmp), 1) = "Y" And Left(Pub_StrUserSt03, 1) = "F") Or Left(Trim(strEx(4)), 1) = "F" Or bolFNation = True _
                           Or Left(Trim(strTmp), 1) = "平" Then '國外
                           nFrm.m_quyDataKind = 0 '國外
                           nFrm.StrMenu
                        Else
                           nFrm.m_quyDataKind = 1 '國內
                           nFrm.StrMenu2
                        End If
                     End If
                  Case 9 '接洽人/聯絡人
                     strTmp = Pub_RplStr(GrdTp.Text)
                     Select Case Left(strTmp, 1)
                        Case "R" '潛在客戶
                           'Add By Sindy 2025/8/28
                           '判斷是國外或是國內
                           strEx(0) = "select * from potcustomer where pcu01(+)='" & Left(strTmp, 8) & "' and pcu02(+)='" & Mid(strTmp, 9, 1) & "' "
                           intA = 1
                           Set rsAD = ClsLawReadRstMsg(intA, strEx(0))
                           strEx(2) = ""
                           If intA = 1 Then
                              strEx(2) = "" & rsAD.Fields(0)
                           End If
                           If strEx(2) = "" Then '國內
                              MsgBox "國內潛在客戶無聯絡人資料 !!!"
                              Screen.MousePointer = vbDefault
                              oForm.Enabled = True
                              oForm.Show
                              GoTo EXITSUB
                           Else
                           '2025/8/28 END
                              Set nFrm = Forms(0).GetForm("frm100101_14")
                              If Not nFrm Is Nothing Then
                                 nFrm.Show
                                 nFrm.Tag = strTmp
                                 'Modify By Sindy 2025/8/28
                                 'nFrm.StrMenu
                                 Call nFrm.StrMenu("1")
                                 '2025/8/28 END
                              End If
                           End If
                        Case Else
                           strEx(2) = "F"
                           If Left(strTmp, 1) = "X" Then
                              strEx(0) = "select st03 from customer,staff where cu01(+)='" & Left(strTmp, 8) & "' and cu02(+)='" & Mid(strTmp, 9, 1) & "' and st01(+)=cu13"
                              intA = 1
                              Set rsAD = ClsLawReadRstMsg(intA, strEx(0))
                              If intA = 1 Then
                                 strEx(2) = "" & rsAD.Fields(0)
                              End If
                           End If
                           If Left(strEx(2), 1) = "F" Then
                              Set nFrm = Forms(0).GetForm("frm100101_17")
                              If Not nFrm Is Nothing Then
                                 nFrm.Show
                                 nFrm.Tag = strTmp
                                 nFrm.StrMenu
                              End If
                           Else
                              Set nFrm = Forms(0).GetForm("frm100101_18")
                              If Not nFrm Is Nothing Then
                                 nFrm.Show
                                 '申請人查詢
                                 If oForm.Name = "frm100102_1" Then
                                    nFrm.SetParent oForm
                                    'Mark by Lydia 2024/03/13
                                    'nFrm.Label2(1).Visible = False
                                    'nFrm.Combo1.Visible = False
                                    'end 2024/03/13
                                    nFrm.CmdOk1(1).Visible = False
                                    'Memo by Amy 2023/09/01 申請人查詢 名條 鈕名稱有修改,此處也要改
                                    nFrm.CmdOk1(2).Caption = "國內A4名條"
                                    nFrm.CmdOk1(2).Enabled = m_bolPrintRight
                                 End If
                                 nFrm.Tag = strTmp
                                 nFrm.StrMenu
                              End If
                           End If
                     End Select
                  Case 11 '以申請人查最近(一個月)以內的寄送資料
                     strTmp = Pub_RplStr(GrdTp.Text)
                     If Left(Trim(strTmp), 1) = "X" Then
                        If Mid(strTmp, 10, 1) = "-" Then
                           strTmp = Left(strTmp, 9)
                        End If
                        Set nFrm = Forms(0).GetForm("frm210145")
                        If Not nFrm Is Nothing Then
                           nFrm.intWorkItem = 0
                           nFrm.Show
                           nFrm.Tag = strTmp
                           nFrm.lblAppl = GrdTp.TextMatrix(i, GetColVal(arrCol, "編號")) & GrdTp.TextMatrix(i, GetColVal(arrCol, "名稱"))
                           nFrm.QueryData (False)
                        End If
                     End If
                  Case 13 '案件統計(只有代理人查詢有)
                     strTmp = Pub_RplStr(GrdTp.Text)
                     Select Case Left(strTmp, 1)
                        Case "Y" '代理人
                           If Mid(strEx(1), 10, 1) = "-" Then
                              strTmp = Left(strTmp, 9)
                           End If
                           Set nFrm = Forms(0).GetForm("frm100114_6")
                           If Not nFrm Is Nothing Then
                              nFrm.Show
                              nFrm.Tag = strTmp
                              nFrm.StrMenu
                           End If
                        Case Else
                           oForm.Show
                           MsgBox "只有代理人,有案件統計功能！", vbInformation
                     End Select
                     
                  Case Else
               End Select
               Screen.MousePointer = vbDefault
               If cmdState <> 2 Then
                  oForm.cmdOK(idx2).BackColor = &H8000000F '往來記錄 鈕
                  oForm.Enabled = True
                  GoTo EXITSUB
               End If
            End If 'Not IsNull(GrdTp.Text)
         End If '"V"
      Next i
   End If 'cmdState <> 3/4/10/12
   
   Screen.MousePointer = vbHourglass
   Select Case cmdState
      Case 2 '關係企業
         '關聯企業改成模組,暫存R100114_1
         If j > 1 Then oForm.StrMenu1
      Case 3 '結束
         '申請人查詢 結束 時跑列印A4名條清單
         If oForm.Name = "frm100102_1" Then
            If PUB_AddAddressA4List("", strEx(0)) Then
            End If
            If Val(strEx(0)) > 0 Then
               bA4Print = MsgBox("尚有" & strEx(0) & "張國內A4名條未列印，現在是否要印？ (是:列印，否:下次列印，取消:刪除A4名條)", vbInformation + vbYesNoCancel)
               If bA4Print = 6 Then  '列印
                  Set nFrm = Forms(0).GetForm("frm083014")
                  If Not nFrm Is Nothing Then
                     nFrm.iStiu = 1
                     nFrm.Show
                     oForm.Hide
                  End If
               ElseIf bA4Print = 2 Then '取消
                  cnnConnection.Execute "delete from AddressA4List where aal01='" & strUserNum & "' "
               End If
            End If
         End If
         Screen.MousePointer = vbDefault
         If oForm.Name = "frm140407" Or oForm.Name = "frm210130" Then
            Unload oForm
         Else
            fnCloseAllFrm100
         End If
         GoTo EXITSUB
      Case 10 '列印對造資料
         Select Case UCase(PUB_OpponentExcel_A4(oForm.Name, oForm.Caption, stCondition))
            Case "NO DATA"
               MsgBox "無對造資料可列印!!"
            Case "PRINT OK"
               MsgBox "對造資料列印完成!!"
            Case "SAVE OK"
               MsgBox "檔案已產生!!"
            Case Else
         End Select
      Case 12 '寄發信函-往來記錄
         For i = 1 To GrdTp.Rows - 1
            If GrdTp.TextMatrix(i, GetColVal(arrCol, "V")) = "V" Then
               GrdTp.col = 0
               GrdTp.row = i
               GrdTp.Text = ""
               '設定Grid顏色
               Call SetMSGridColorQCus(0, oForm.Name, GrdTp, arrCol, bolNoCase)
               strTmp = Trim(Pub_RplStr(GrdTp.TextMatrix(i, GetColVal(arrCol, "編號"))))
               If GrdTp.TextMatrix(i, GetColVal(arrCol, "狀態")) = "不得代理" Or _
                 GrdTp.TextMatrix(i, GetColVal(arrCol, "狀態")) = "對造" Or GrdTp.TextMatrix(i, GetColVal(arrCol, "狀態")) = "其他相關人" Then
                  MsgBox "該編號為不會有[寄發信函-往來記錄]資料！", vbInformation
               ElseIf Len(strTmp) = 9 Or (Len(strTmp) = 12 And InStr(strTmp, "-") > 0) Then
                  Set nFrm = Forms(0).GetForm("frm880022")
               End If
               If Not nFrm Is Nothing Then
                  oForm.Hide
                  Set nFrm.m_PrevF = oForm
                  nFrm.m_strNo = Left(strTmp, 9)
                  nFrm.m_PCC02 = IIf(InStr(strTmp, "-") > 0, Right(strTmp, 2), "")
                  If nFrm.QueryData = True Then
                     nFrm.Show
                  End If
               End If
               Screen.MousePointer = vbDefault
               oForm.Enabled = True
               GoTo EXITSUB
            End If
         Next i
      Case Else
   End Select
   oForm.cmdOK(idx2).BackColor = &H8000000F
   Screen.MousePointer = vbDefault
   oForm.Enabled = True
   
'Added by Lydia 2024/05/15
EXITSUB:
   Set rsAD = Nothing
'end 2024/05/15
End Sub
'end 2023/08/25

'Add By Sindy 2023/9/4
Public Function ShowLblCU144(strCU144 As String) As String
   ShowLblCU144 = "(N:不開發票)"
   Select Case strCU144
      Case "A"
         ShowLblCU144 = "(A:開立發票請款)"
      Case "B"
         ShowLblCU144 = "(B:等通知後再開立發票請款)"
   End Select
End Function

'Add by Amy 2023/09/19 列印對造資料(以Excel 直接列印)
Public Function PUB_OpponentExcel_A4(stFormN As String, stRepTitle As String, stCondition As String, Optional ByVal IsPrint As Boolean = True) As String
   Dim RsQ As New ADODB.Recordset, strQ As String, intQ As Integer, i As Integer, IsOpen As Boolean
   Dim strFileName As String, intRow As Integer, intField As Integer, intTitleR As Integer
   Dim xlsApp, WksAp, arrField() As String, arrWidth()
   
On Error GoTo Hand

   Select Case stFormN
      Case "frm100102_1" '申請人查詢
         If InStr(stRepTitle, "(") > 0 Then
            stRepTitle = Mid(stRepTitle, 1, Val(InStr(stRepTitle, "(")) - 1)
         End If
      Case "frm100114_1" '代理人查詢
      Case "frm140407" '國外潛在客戶查詢
      Case "frm210130" '國內潛在客戶查詢
   End Select
   
   PUB_OpponentExcel_A4 = "No Data": IsOpen = False
   ReDim arrField(6): ReDim arrWidth(6)
   arrField(0) = "本所案號": arrField(1) = "名　稱": arrField(2) = "智權人員": arrField(3) = "狀　態": arrField(4) = "總收文號"
   arrField(5) = "案件性質": arrField(6) = "收文日"
   arrWidth = Array(15, 20, 10, 11, 10, 19, 10)
   
   '只印對造資料,若對造資料之案號有其他關係人也需印出
   strQ = "Select R021001 as CaseNo,SubStr(R021002,1,InStr(R021002,'@@')-1) as CaseName,R021003 as Sales" & _
                     ",Decode(R021004,'1','對造','其他相關人') as State,R021006 as CP09,R021007 as CP10Name,R021008 as CP05 " & _
                 "From R100102_1 Where ID='" & strUserNum & "@" & stFormN & "'  " & _
                     "And R021001 in(Select Distinct R021001 From R100102_1 Where ID='" & strUserNum & "@" & stFormN & "' And R021004='1') " & _
                 "Order by CaseName,CaseNo,CP05 "
   intQ = 1
   Set RsQ = ClsLawReadRstMsg(intQ, strQ)
   If intQ = 1 Then
      strFileName = "$$" & stRepTitle & "*.*"
      If Dir(strExcelPath & strFileName) <> MsgText(601) Then
          Kill strExcelPath & strFileName
      End If
      strFileName = "$$" & stRepTitle & ACDate(ServerDate) & ServerTime & MsgText(43)
      
      Set xlsApp = New Excel.Application
      xlsApp.Visible = False
      IsOpen = True
      xlsApp.SheetsInNewWorkbook = 3 '預設工作表數量
      xlsApp.Workbooks.add
      Set WksAp = xlsApp.Worksheets(1)
      xlsApp.DisplayAlerts = False '把Excel的警告訊息關掉
      WksAp.Activate
      
      intField = 65: intRow = 1
      '設定表頭
      WksAp.Range(Chr(intField) & intRow).Font.Size = 18
      WksAp.Range(Chr(intField) & intRow).Font.Name = "標楷體"
      WksAp.Range(Chr(intField) & intRow).Font.Bold = True
      WksAp.Range(Chr(intField) & intRow).Value = stRepTitle
      WksAp.Range(Chr(intField) & intRow & ":" & Chr(UBound(arrField) + intField) & intRow).HorizontalAlignment = xlCenter
      WksAp.Range(Chr(intField) & intRow & ":" & Chr(UBound(arrField) + intField) & intRow).MergeCells = True
      intRow = intRow + 1
      WksAp.Range(Chr(intField) & intRow).Font.Size = 12
      WksAp.Range(Chr(intField) & intRow).Font.Name = "標楷體"
      WksAp.Range(Chr(intField) & intRow).Font.Bold = True
      WksAp.Range(Chr(intField) & intRow).Value = "名稱：" & stCondition
      WksAp.Range(Chr(intField) & intRow & ":" & Chr(UBound(arrField) + intField) & intRow).HorizontalAlignment = xlCenter
      WksAp.Range(Chr(intField) & intRow & ":" & Chr(UBound(arrField) + intField) & intRow).MergeCells = True
      intRow = intRow + 1
      WksAp.Range(Chr(UBound(arrField) + intField) & intRow).Font.Size = 10
      WksAp.Range(Chr(UBound(arrField) + intField) & intRow).Font.Bold = True
      WksAp.Range(Chr(UBound(arrField) + intField) & intRow).Value = "<對造資料>"
      intRow = intRow + 1
      WksAp.Range(Chr(intField) & intRow).Font.Size = 12
      WksAp.Range(Chr(intField) & intRow).Value = "列印人員：" & StaffQuery(strUserNum)
      WksAp.Range(Chr((UBound(arrField) - 1) + intField) & intRow).Value = "查詢日期：" & ChangeTStringToTDateString(strSrvDate(2))
      WksAp.Range(Chr((UBound(arrField) - 1) + intField) & intRow & ":" & Chr(UBound(arrField) + intField) & intRow).HorizontalAlignment = xlRight
      WksAp.Range(Chr((UBound(arrField) - 1) + intField) & intRow & ":" & Chr(UBound(arrField) + intField) & intRow).MergeCells = True
      intRow = intRow + 1
      '設定欄位名稱
      For i = LBound(arrField) To UBound(arrField)
         WksAp.Range(Chr(i + intField) & intRow).Value = arrField(i)
         WksAp.Range(Chr(i + intField) & intRow).Font.Bold = True
         WksAp.Columns(Chr(i + intField) & ":" & Chr(i + intField)).ColumnWidth = arrWidth(i)
         WksAp.Range(Chr(i + intField) & intRow).HorizontalAlignment = xlCenter
      Next i
      WksAp.Range(Chr(intField) & intRow & ":" & Chr(UBound(arrField) + intField) & intRow).Borders(xlEdgeBottom).Weight = xlHairline
      WksAp.Range(Chr(intField) & intRow & ":" & Chr(UBound(arrField) + intField) & intRow).Borders(xlEdgeBottom).LineStyle = xlContinuous
      intTitleR = intRow
      intRow = intRow + 1
      
      RsQ.MoveFirst
      Do While RsQ.EOF = False
         For i = LBound(arrField) To UBound(arrField)
            If i = GetColVal(arrField, "收文日") Then
               WksAp.Range(Chr(i + intField) & intRow).Value = ChangeTStringToTDateString(Val(RsQ.Fields(i)) - 19110000)
               WksAp.Range(Chr(i + intField) & intRow).HorizontalAlignment = xlRight
            Else
               WksAp.Range(Chr(i + intField) & intRow).Value = "" & RsQ.Fields(i)
               WksAp.Range(Chr(i + intField) & intRow).HorizontalAlignment = xlLeft
            End If
         Next i
         intRow = intRow + 1
         RsQ.MoveNext
      Loop
      
      'Excel字型大小設定
      With WksAp.Range(Chr(intField) & intTitleR + 1 & ":" & Chr(UBound(arrField) + intField) & intRow - 1)
         .Font.Name = "新細明體"
         .Font.Size = 11
      End With
      '設定
      WksAp.PageSetup.PaperSize = 9 'A4
      WksAp.PageSetup.Orientation = wdOrientLandscape '直印
      WksAp.PageSetup.CenterHorizontally = True '版面設定->邊界->水平置中
      WksAp.PageSetup.PrintTitleRows = "$1:$" & intTitleR '設定固定列印表頭
      WksAp.PageSetup.TopMargin = xlsApp.InchesToPoints(0.5) '上
      WksAp.PageSetup.BottomMargin = xlsApp.InchesToPoints(0.5) '下
      WksAp.PageSetup.LeftMargin = xlsApp.InchesToPoints(0) '左邊界
      WksAp.PageSetup.RightMargin = xlsApp.InchesToPoints(0) '右邊界
      
      If IsPrint = True Then xlsApp.Workbooks(1).PrintOut
      If Val(xlsApp.Version) < 12 Then
         xlsApp.Workbooks(1).SaveAs FileName:=strExcelPath & strFileName, FileFormat:=-4143
      Else
         xlsApp.Workbooks(1).SaveAs FileName:=strExcelPath & strFileName, FileFormat:=56
      End If
      xlsApp.Workbooks.Close
      xlsApp.Quit
      Set xlsApp = Nothing
      If IsPrint = True Then
         PUB_OpponentExcel_A4 = "Print OK"
      Else
         PUB_OpponentExcel_A4 = "Save OK"
      End If
   End If
   
Hand:
   If Err.Number = 0 Then
      Exit Function
   End If
   PUB_OpponentExcel_A4 = "Err"
   MsgBox Err.Description & vbCrLf & "請洽電腦中心", , MsgText(5)
   Screen.MousePointer = vbDefault
   If IsOpen = True Then
      If Val(xlsApp.Version) < 12 Then
         xlsApp.Workbooks(1).SaveAs FileName:=strExcelPath & strFileName, FileFormat:=-4143
      Else
         xlsApp.Workbooks(1).SaveAs FileName:=strExcelPath & strFileName, FileFormat:=56
      End If
      xlsApp.Workbooks.Close
      xlsApp.Quit
   End If
   Set xlsApp = Nothing
End Function

'Add by Amy 2023/09/26 共同查詢-依狀態顯示智權人員
Public Sub UpdQuerySales(stFormN As String, ByRef GrdTp As MSHFlexGrid, arrCol() As String)
   Dim stNo As String, stSysKind As String, stUpd As String
   
On Error GoTo Hand
   Select Case stFormN
      Case "frm100102_1" '申請人查詢
      Case "frm100114_1" '代理人查詢
      Case "frm140407" '國外潛在客戶查詢
      Case "frm210130" '國內潛在客戶查詢
   End Select
   
   '待活化客戶
   If GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "待活化客戶")) = "0" Then
      'Modified by Lydia 2023/11/30 待活化客戶調整啟用日=>"20231201"
      If strSrvDate(1) >= "20231201" Then GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "智權人員")) = "待活化客戶"
   '對造,其他相關人
   ElseIf GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "狀態")) = "對造" Or GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "狀態")) = "其他相關人" Then
      '依案號抓智權人員
      stNo = Pub_RplStr(GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "編號")))
      stSysKind = SystemNumber(stNo, 1)
      Select Case stSysKind
         Case "FCP", "FG"
            GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "智權人員")) = GetPrjSalesNM(PUB_GetFCPSalesNo(stSysKind, SystemNumber(stNo, 2), SystemNumber(stNo, 3), SystemNumber(stNo, 4)))
         Case "FCL", "LIN"
            GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "智權人員")) = GetPrjSalesNM(PUB_GetFCLSalesNo(stSysKind, SystemNumber(stNo, 2), SystemNumber(stNo, 3), SystemNumber(stNo, 4)))
         Case "FCT"
            GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "智權人員")) = GetPrjSalesNM(PUB_GetFCTSalesNo(stSysKind, SystemNumber(stNo, 2), SystemNumber(stNo, 3), SystemNumber(stNo, 4)))
         Case "S"
            If GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "申請國家")) = "000" Then
               GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "智權人員")) = GetPrjSalesNM(PUB_GetFCTSalesNo(stSysKind, SystemNumber(stNo, 2), SystemNumber(stNo, 3), SystemNumber(stNo, 4)))
            Else
               GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "智權人員")) = GetPrjSalesNM(PUB_GetAKindSalesNo(stSysKind, SystemNumber(stNo, 2), SystemNumber(stNo, 3), SystemNumber(stNo, 4)))
            End If
         Case Else
            GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "智權人員")) = GetPrjSalesNM(PUB_GetAKindSalesNo(stSysKind, SystemNumber(stNo, 2), SystemNumber(stNo, 3), SystemNumber(stNo, 4)))
      End Select
      GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "案件性質")) = GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "案件性質")) & PUB_GetRelateCasePropertyName(GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "總收文號")), "1")
      '更新智權人員至暫存檔
      stUpd = "Update R100102_1 Set R021003='" & GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "智權人員")) & "' Where R021014='" & stSysKind & "' And R021015='" & SystemNumber(stNo, 2) & "' And R021016='" & SystemNumber(stNo, 3) & "' And R021017='" & SystemNumber(stNo, 4) & "' "
      cnnConnection.Execute stUpd
   '潛在客戶編號(R)
   ElseIf Left(GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "編號")), 1) = "R" Then
      GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "智權人員")) = GetDevelopP(GrdTp.TextMatrix(GrdTp.row, GetColVal(arrCol, "智權人員")))
   Else
   End If
   
Hand:
   If Err.Number = 0 Then Exit Sub
   MsgBox Err.Description & vbCrLf & "請洽電腦中心", , MsgText(5)
End Sub

'Add by Amy 2023/08/17 傳入字串判斷是否為查詢置換字
Public Function ChkQuryChangetxt(ByVal stVal As String, ByRef stBackTxt As String) As Boolean
'Modify by Amy 2023/10/03 改顯示組合字
'   Dim rsA As ADODB.Recordset, intA As Integer, intCount As Integer, ii As Integer
'   Dim sta As String, stTP As String, arrSW01() As String, arrSW02() As String
'
'   ChkQuryChangetxt = False
'   stTP = stVal: intCount = 0
'   sta = "Select SW01,SW02 From SpecWord Where SW03='2' Order by SW01"
'   intA = 1
'   Set rsA = ClsLawReadRstMsg(intA, sta)
'   If intA = 1 Then
'      ReDim arrSW01(rsA.RecordCount - 1)
'      ReDim arrSW02(rsA.RecordCount - 1)
'      rsA.MoveFirst
'      Do While Not rsA.EOF
'         arrSW01(intCount) = rsA.Fields("SW01")
'         arrSW02(intCount) = rsA.Fields("SW02")
'         intCount = intCount + 1
'         rsA.MoveNext
'      Loop
'      For ii = LBound(arrSW01) To UBound(arrSW01)
'         If InStr(stVal, arrSW01(ii)) > 0 Then
'            ChkQuryChangetxt = True
'            stTP = Replace(stTP, arrSW01(ii), arrSW02(ii))
'         ElseIf InStr(stVal, arrSW02(ii)) > 0 Then
'            ChkQuryChangetxt = True
'            stTP = Replace(stTP, arrSW02(ii), arrSW01(ii))
'         End If
'      Next ii
'      If stTP <> MsgText(601) Then stBackTxt = stTP
'   End If
'
'   Set rsA = Nothing
   stBackTxt = ""
   ChkQuryChangetxt = ChkQuryChgTxt(stVal, stBackTxt)
End Function

'Add by Amy 2023/10/03 傳入字串若為[查詢置換字],傳出組合字串
Public Function ChkQuryChgTxt(ByVal stOrg As String, ByRef stBackTxt As String) As Boolean
   Dim rsA As ADODB.Recordset, intA As Integer, sta As String, stVal As String, stWhere As String
   Dim stReplace As String, stRep1 As String, stRep2 As String, stRep3 As String, stTP(2) As String
   Dim ii As Integer, jj As Integer, kk As Integer, mm As Integer, intAllCnt As Integer, intCnt As Integer
   Dim arrReplace() As String, arrTmp, arrChg, arrRepTxt
   Dim intStart As Integer 'Add by  Amy 2023/10/26
   
On Error GoTo Hand
   ChkQuryChgTxt = False
   stVal = Pub_GetField("Dual", "1=1", "ReplaceSign(TO_MULTI_BYTE(Upper('" & ChgSQL(stOrg) & "')),'1')") '先取代符號
  
   '不含符號,每個字判斷是否取代
   For ii = 1 To Len(stVal)
      stRep1 = Mid(stVal, ii, 1) '原始資料
      stRep2 = Pub_GetField("Dual", "1=1", "ReplaceQChgTxt(TO_MULTI_BYTE(Upper('" & ChgSQL(stRep1) & "')))") '顯示相對應的所有字
      If InStr(stRep2, stRep1) = 0 Then
         stRep2 = stRep2 & ";" & stRep1
      End If
      arrRepTxt = Split(stRep2, ";")
      'Modify by Amy 2023/10/26 從下面搬上來,第一個字[不]屬於換字,需寫入變數中 ex:查 南臺 只出現[,台,臺]
      stWhere = "": stRep3 = ""
      stRep3 = stRep3 & "," & stRep1 '原始字寫入
      For jj = LBound(arrRepTxt) To UBound(arrRepTxt)
         stWhere = stWhere & "Or Instr(SW01,'" & arrRepTxt(jj) & "')>0 Or Instr(SW02,'" & arrRepTxt(jj) & "')>0 "
      Next jj
      If stWhere <> MsgText(601) Then stWhere = "And (" & Mid(stWhere, 3) & ")"
      
      sta = "Select SW01,SW02 From SpecWord Where SW03='2' " & stWhere & " Order by SW02 "
      intA = 1
      Set rsA = ClsLawReadRstMsg(intA, sta)
      If intA = 1 Then
         rsA.MoveFirst
         ChkQuryChgTxt = True
         'stRep3 = "":stRep3 = stRep3 & "," & stRep1 '原始字寫入
      'end 2023/10/26
         Do While Not rsA.EOF
            stTP(0) = rsA.Fields("SW01")
            If InStr(stRep3, stTP(0)) = 0 Then
               stRep3 = stRep3 & "-" & stTP(0)
            End If
            stTP(0) = rsA.Fields("SW02")
            If InStr(stRep3, stTP(0)) = 0 Then
               stRep3 = stRep3 & "-" & stTP(0)
            End If
            rsA.MoveNext
         Loop
      End If
      stReplace = stReplace & stRep3
   Next ii
   intAllCnt = 0: stRep1 = "": stRep2 = ""
   ReDim arrReplace(intAllCnt)
   arrReplace(intAllCnt) = stOrg
   intCnt = intAllCnt '目前使用之陣列數
   intAllCnt = intAllCnt + 1 '所有陣列數
   
   If ChkQuryChgTxt = True Then
      arrTmp = Split(Mid(stReplace, 2), ",")
      intStart = LBound(arrTmp)
      For ii = 1 To Len(arrReplace(0))
         stTP(0) = Mid(arrReplace(0), ii, 1)
         'Mark by Amy 2024/03/20 ex:長庚醫療財團法人台北長庚紀念醫院/國立台灣大學 ,有替換字,但顯示空白
'         If ii = 1 Then
'            stTP(1) = "" '第一個字
'         Else
'            stTP(1) = Mid(arrReplace(0), 1, ii - 1) '不是第一個字,記錄前一個字
'         End If
         stTP(2) = Mid(arrReplace(0), ii + 1) '記錄第n個字(不含)之後的字
         'Modify by Amy 2023/10/26 第一個字[不]屬於換字,需寫入變數中
         '計算組合陣列數
         For jj = intStart To UBound(arrTmp)
            If InStr(arrTmp(jj), "-") = 0 Then
               '不需換字則跳一下個字
               intStart = intStart + 1
               'Add by Amy 2024/03/20 替換字非位於第一個字,跑回圈時未將前面的字更新至變數中 ex:長庚醫療財團法人台北長庚紀念醫院/國立台灣大學
               jj = UBound(arrTmp)
            Else
               If stTP(0) = Left(arrTmp(jj), 1) Then
                  stRep1 = Mid(arrTmp(jj), 3) '要取代的字
                  arrChg = Split(stTP(0) & "-" & stRep1, "-")
                  'arrReplace=原本的字+目前要取代的字
                  intAllCnt = intAllCnt * (UBound(arrChg) + 1)
                  ReDim Preserve arrReplace(intAllCnt)
                  If jj = LBound(arrTmp) Then
                     For kk = LBound(arrChg) To UBound(arrChg)
                        intCnt = intCnt + 1
                        arrReplace(intCnt) = arrChg(kk) & stTP(2)
                        stRep2 = stRep2 & "," & arrReplace(kk + 1)
                     Next kk
                  Else
                     'For mm = LBound(arrReplace) + 1 To intCnt
            'end 2023/10/26
                     For mm = LBound(arrReplace) To intCnt
                        stRep3 = Mid(arrReplace(mm), 1, ii - 1) '取ii-1個字+第ii個字組合
                        For kk = LBound(arrChg) To UBound(arrChg)
                           If InStr(stRep2, stRep3 & arrChg(kk) & stTP(2)) = 0 Then
                              intCnt = intCnt + 1
                              arrReplace(intCnt) = stRep3 & arrChg(kk) & stTP(2)
                              stRep2 = stRep2 & "," & stRep3 & arrChg(kk) & stTP(2)
                           End If
                        Next
                     Next mm
                  End If
                  Exit For
               End If 'stTP(0) = Left(arrTmp(jj), 1)
            End If 'InStr(arrTmp(jj), "-") = 0
         Next jj
      Next ii
      
      Call Sort(arrReplace, UBound(arrReplace) - 1)
      stTP(0) = ""
      For ii = LBound(arrReplace) + 1 To UBound(arrReplace)
         If Len(stTP(0) & arrReplace(ii)) > 31 Then
            stBackTxt = stBackTxt & stTP(0) & vbCrLf '換行
            stTP(0) = ""
         End If
         stTP(0) = stTP(0) & "," & arrReplace(ii)
      Next ii
      If stBackTxt & stTP(0) <> MsgText(601) Then
         stBackTxt = stBackTxt & stTP(0)
      End If
   End If
   
Hand:
   Set rsA = Nothing
   If Err.Number = 0 Then Exit Function
   ChkQuryChgTxt = False
   stBackTxt = " 查詢：" & stOrg & " 有誤 " & vbCrLf & _
                         "(錯誤-" & Err.Description & ")"
   PUB_SendMail "QPGMR", "A2004", "", "[ChkQuryChgTxt]函數查詢有誤", strUserNum & " " & _
                              GetStaffName(strUserNum) & stBackTxt
   stBackTxt = stBackTxt & vbCrLf & " 請洽電腦中心"
   MsgBox stBackTxt, , MsgText(5)
End Function

'Memo by Amy 2023/10/03 從basPublic搬過來
Public Sub Sort(a, max)
 Dim sort_ok As Boolean, i As Integer
   Do
      sort_ok = True
      For i = 1 To max
         If a(i) > a(i + 1) Then
            Swap a(i), a(i + 1)
            sort_ok = False
         End If
      Next
   Loop Until sort_ok
End Sub

Private Sub Swap(x, y)
 Dim temp
   temp = x
   x = y
   y = temp
End Sub
'end 2023/10/13
 
'Added by Lydia 2023/11/08 外專判斷上一道工程師案件性質是否已經請款，有關主動修正的例外判斷; 請同時compile : 內專、外專、每日批次
Public Function PUB_ChkFCPtoDNUPLsub(ByVal pCP01 As String, ByVal pCP02 As String, ByVal pCP03 As String, ByVal pCP04 As String, ByVal pCP09 As String, ByVal pCP10 As String, ByVal pCP60 As String, ByVal pCP158 As String) As Boolean
Dim intR As Integer, strR1 As String
Dim rsRead As New ADODB.Recordset

   If pCP01 <> "P" And pCP01 <> "FCP" And pCP60 = "" And Val(pCP158) = 0 Then Exit Function
   
   'Added by Lydia 2023/12/01 (寰華案)因為案件性質有多種，所以判斷與新案同一發文日當作請款程序完成
   If pCP01 = "P" Then
      strR1 = "select cp09,cp60 from caseprogress where cp01='" & pCP01 & "' and cp02='" & pCP02 & "' and cp03='" & pCP03 & "' and cp04='" & pCP04 & "' and (cp31='Y' or cp10 in ('101','102','103','307')) and cp158='" & pCP158 & "' and cp159=0 "
      intR = 1
      Set rsRead = ClsLawReadRstMsg(intR, strR1)
      If intR = 1 Then
         PUB_ChkFCPtoDNUPLsub = True
      End If
      'Added by Lydia 2024/01/05 增加寰華案（228）呈國際階段修正內容的判斷
      '1. 先判斷是否和新案、新案翻譯（含檢視中說、核對中說格式、製作中說）同一發文日，則當作請款程序完成
      '2. 若都不同天，則要正常發未完程請款流程之mail
      If pCP10 = "228" And Val(pCP158) > 0 And PUB_ChkFCPtoDNUPLsub = False Then
         strR1 = "select cp09,cp60 from caseprogress where cp01='" & pCP01 & "' and cp02='" & pCP02 & "' and cp03='" & pCP03 & "' and cp04='" & pCP04 & "' and cp10 in ('201','209','210','235') and cp158='" & pCP158 & "' and cp159=0 "
         intR = 1
         Set rsRead = ClsLawReadRstMsg(intR, strR1)
         If intR = 1 Then
            PUB_ChkFCPtoDNUPLsub = True
         End If
      End If
      'end 2024/01/05
   End If
   
   'Modified by Lydia 2023/12/01 +And PUB_ChkFCPtoDNUPLsub = False
   If pCP10 = "203" And PUB_ChkFCPtoDNUPLsub = False Then
      '不發mail的例外：若主動修正(203)的請款單號和新案（101,102,103）or 新案翻譯(201)/檢視中說(209) /核對中說格式(235)的請款單號相同，則不發=>和中說一起送，就不是程序E
      strR1 = "select cp09,cp60 from caseprogress where cp01='" & pCP01 & "' and cp02='" & pCP02 & "' and cp03='" & pCP03 & "' and cp04='" & pCP04 & "' and (cp31='Y' or cp10 in ('101','102','103','201','209','210','235')) and cp60='" & pCP60 & "' and cp159=0 "
      intR = 1
      Set rsRead = ClsLawReadRstMsg(intR, strR1)
      If intR = 1 Then
         PUB_ChkFCPtoDNUPLsub = True
      End If
      '增加主動修正的判斷：若主動修正的發文日和新案翻譯（含檢視中說、核對中說格式、製作中說）同一天，則不發此mail; ex.FCP-069760,FCP-069774
      If Val(pCP158) > 0 And PUB_ChkFCPtoDNUPLsub = False Then
         strR1 = "select cp09,cp60 from caseprogress where cp01='" & pCP01 & "' and cp02='" & pCP02 & "' and cp03='" & pCP03 & "' and cp04='" & pCP04 & "' and cp10 in ('201','209','210','235') and cp158='" & pCP158 & "' and cp159=0 "
        intR = 1
         Set rsRead = ClsLawReadRstMsg(intR, strR1)
         If intR = 1 Then
            PUB_ChkFCPtoDNUPLsub = True
         End If
      End If
   End If
   
   'Added by Lydia 2024/06/28 當案件性質為421「申請技術報告」有產生帳單編號的時候，稽核請多判斷一道「核發-申請技術報告」，當這兩道都沒有「寄請款函」，再通知程序。Ex.FCP-069544
   If pCP10 = "421" And PUB_ChkFCPtoDNUPLsub = False Then
      '不發mail的例外：若主動修正(203)的請款單號和新案（101,102,103）or 新案翻譯(201)/檢視中說(209) /核對中說格式(235)的請款單號相同，則不發=>和中說一起送，就不是程序E
      'Modified by Lydia 2025/01/16 改成模組取得語法;AND (UPPER(CPP02) LIKE '%.REPDN.%' OR UPPER(CPP02) LIKE '%.DNUPL.%' ) >> PUB_GetFCPforDNsql
      strR1 = "SELECT CPP01, CPP02 FROM CASEPAPERPDF B WHERE CPP01 IN (SELECT CP09 FROM CASEPROGRESS WHERE CP60='" & pCP60 & "' " & _
              "UNION SELECT CP09 FROM CASEPROGRESS WHERE CP43='" & pCP09 & "' AND CP10='1008') " & _
              "AND NVL(CPP10,'N') <> 'D' " & PUB_GetFCPforDNsql
      intR = 1
      Set rsRead = ClsLawReadRstMsg(intR, strR1)
      If intR = 1 Then
         PUB_ChkFCPtoDNUPLsub = True
      End If
   End If
   
   'Added by Lydia 2025/08/06 若"（926）核對已准專利"和"（601）領證及繳年費"為同一請款單號，則不發mail
   If pCP10 = "926" And PUB_ChkFCPtoDNUPLsub = False Then
      '不發mail的例外：若主動修正(203)的請款單號和新案（101,102,103）or 新案翻譯(201)/檢視中說(209) /核對中說格式(235)的請款單號相同，則不發=>和中說一起送，就不是程序E
      strR1 = "select cp09,cp60 from caseprogress where cp01='" & pCP01 & "' and cp02='" & pCP02 & "' and cp03='" & pCP03 & "' and cp04='" & pCP04 & "' and cp10='601' and cp60='" & pCP60 & "' and cp159=0 "
      intR = 1
      Set rsRead = ClsLawReadRstMsg(intR, strR1)
      If intR = 1 Then
         PUB_ChkFCPtoDNUPLsub = True
      End If
   End If
   
   Set rsRead = Nothing
End Function



'Add by Amy 2023/12/12 風險檢查語法(共同查詢用)
'intChoose:1-編號/2-ID/3-國籍
'IsNoAdvertise:是查「不得宣傳」
Public Function GetSearchRiskChkSql(ByVal intChoose As Integer, ByVal strFormN As String, ByVal stFind As String, Optional ByVal IsNoAdvertise As Boolean = False) As String
   Dim ii As Integer, jj As Integer
   Dim stVTB As String, stF(1) As String, stDTB As String, stWhere As String, stTemp As String
   Dim stTP(4) As String, stMTp(4) As String
   
   'Memo 共同查詢 用程式有改 [frm100102_1 申請人/frm100114_1 代理人/frm140407 國外潛在客戶/frm210130 國內潛在客戶] 都要測
   stF(0) = "' ' AS V,RCL01 AS 編號,名稱,NA03 AS 國籍,ST02 AS 智權人員,Decode(RCL24,null,'風險警示','') as 狀態, Decode(RCL24,null,'','撤銷日期：'||sqldatet(RCL24)||'；')||RCL23 as 備註" & _
                  ",' ' as 申請國家,'' as 總收文號,'' as 案件性質,'' as 收文日,'' AS 關聯編號,'' AS 關聯名稱,'' AS 關聯關係,'' AS 關聯說明,'' AS OrgN"
   
   Select Case UCase(strFormN)
      Case "FRM100102_1" '申請人查詢
         
      Case "FRM100114_1" '代理人查詢
         '名稱依國籍顯示,國籍 台灣/香港/大陸 名稱抓中-->英-->日, 否則抓英-->中-->日
         stF(1) = ",Decode(Sign(InStr('000,001,002,003,004,005,006,007,008,009,013,020',RCL08)),1,Nvl(RCL02,Decode(RCL03,null,RCL07,RCL03||' '||RCL04||' '||RCL05||' '||RCL06)),Decode(RCL03,null,Nvl(RCL02,RCL07),RCL03||' '||RCL04||' '||RCL05||' '||RCL06)) as 名稱"
      Case "FRM140407" '國外潛在客戶查詢
         '多「類別」欄
         stF(0) = Replace(UCase(stF(0)), "ST02 AS 智權人員,", "ST02 AS 智權人員,' ' AS 類別,")
      Case "FRM140419" '
         stF(0) = "RCL01 as FNo,'' as MailAddr,RCL22 as SalesNo,RCL21 as SalesAreaNo,RCL02 as FName,'X' as sField"
      Case "FRM210130" '國內潛在客戶查詢
   End Select
   '代理人查詢會依國籍顯示名稱,其他查詢 抓中-->英-->日
   If stF(1) = MsgText(601) And UCase(strFormN) <> "FRM140419" Then
      stF(1) = ",Nvl(RCL02,Decode(RCL03,null,RCL07,RCL03||' '||RCL04||' '||RCL05||' '||RCL06)) as 名稱"
   End If
   '依表單顯示名稱欄位
   If UCase(strFormN) <> "FRM140419" Then
      stF(0) = Replace(stF(0), ",名稱", stF(1))
   End If
   
   Select Case intChoose
      Case 1 '編號
          stWhere = "And RCL01='" & IIf(Len(Trim(stFind)) >= 5, Trim(stFind), Format(Trim(stFind), "00000")) & "' "
      Case 2 'ID
         stDTB = ",(Select Distinct RCL01 as A1 From Customer Where InStr(RCL17,'" & ChgSQL(Trim(stFind)) & "')>=1 ) A"
         stWhere = "And RCL01=A.A1 "
      Case 3 '國籍
         stWhere = "And InStr(RCL08, '" & Trim(stFind) & "') = 1 "
      Case Else
         
   End Select
  
   stVTB = "Select " & stF(0) & " From RiskCheckList,Nation,Staff" & stDTB & " Where RCL08=na01(+) And RCL22=st01(+) " & stWhere
   GetSearchRiskChkSql = stVTB
   
End Function

'Add by Amy 2023/12/27
'intChoose:1-初始化欄位陣列 / 2-更新欄位內容 / 99-清空m_FieldList資料
'stFromN:表單名 / m_FieldList:資料陣列 / Ado:資料集
Public Sub Pub_InitialField(ByVal intChoose As Integer, ByVal stFormN As String, ByRef m_FieldList() As FIELDITEM, Optional ado As ADODB.Recordset)
   Dim idx As Integer, intEnd As Integer, strTmp As String
   
   intEnd = UBound(m_FieldList)
   Select Case UCase(stFormN)
      Case "FRM12040163" '風險檢查對象
      Case "FRM160001" '員工基本資料
   End Select

   If intChoose = 1 Then
'*** 初始化欄位陣列 ***
      For idx = 1 To intEnd
         m_FieldList(idx - 1).fiName = ado.Fields(idx - 1).Name
         m_FieldList(idx - 1).fiOldData = Empty
         m_FieldList(idx - 1).fiNewData = Empty
      Next idx
'*** End 初始化欄位陣列 ***
   ElseIf intChoose = 2 Then
'*** 更新欄位內容 ***
      For idx = 1 To intEnd
         If m_FieldList(idx - 1).fiName <> Empty Then
            If IsNull(ado.Fields(m_FieldList(idx - 1).fiName)) = False Then
               m_FieldList(idx - 1).fiOldData = ado.Fields(m_FieldList(idx - 1).fiName)
               m_FieldList(idx - 1).fiNewData = ado.Fields(m_FieldList(idx - 1).fiName)
            End If
         Else
            m_FieldList(idx - 1).fiOldData = Empty
            m_FieldList(idx - 1).fiNewData = Empty
         End If
      Next idx
'*** End 更新欄位內容 ***
   Else
'*** 99-清空m_FieldList資料 ***
      For idx = 1 To intEnd
         m_FieldList(idx - 1).fiOldData = Empty
         m_FieldList(idx - 1).fiNewData = Empty
      Next idx
   End If
End Sub

'設定欄位的內容
Public Sub Pub_SetFieldNewData(ByVal stFormN As String, ByRef m_FieldList() As FIELDITEM, ByVal strName As String, Optional ByVal strData As String = "#==#")
   Dim ii As Integer, intEnd As Integer
    
   intEnd = UBound(m_FieldList)
   Select Case UCase(stFormN)
      Case "FRM12040163" '風險檢查對象
      Case "FRM160001" '員工基本資料
   End Select
   
   For ii = 1 To intEnd
      If strName = m_FieldList(ii - 1).fiName Then
         If strData = "#==#" Then
            m_FieldList(ii - 1).fiNewData = m_FieldList(ii - 1).fiOldData
         Else
            m_FieldList(ii - 1).fiNewData = strData
         End If
         Exit For
      End If
   Next ii
End Sub

'以FIELDITEM欄位 回傳 更新/修改  語法
'int_EditMode:1-新增 / 2-修改
'stFromN:表單名 / m_FieldList:資料陣列 / Ado:資料集 / stTBN:資料表名 / stNotChkFieldN:不需判斷欄位(多筆以;區隔 ex:CU80;CU85)
Public Function Pub_GetFieldItemSql(ByVal int_EditMode As Integer, ByVal stFormN As String, ByRef m_FieldList() As FIELDITEM, stTBN As String, stKey As String, Optional ByVal stNotChkFieldN As String = "") As String
   Dim ii As Integer, intStart As Integer, arrNoChk
   Dim idx As Integer, intEnd As Integer, bDifference As Boolean, bFirst As Boolean, strSql As String, strValues As String, strTmp As String
   
   Pub_GetFieldItemSql = ""
   intEnd = UBound(m_FieldList)
   Select Case UCase(stFormN)
      Case "FRM12040163" '風險檢查對象
      Case "FRM160001" '員工基本資料
   End Select
   
   intStart = Empty
   If stNotChkFieldN <> MsgText(601) Then
      arrNoChk = Split(stNotChkFieldN, ";")
      intStart = LBound(arrNoChk)
   End If
   
   bFirst = True:   bDifference = False
   For idx = 1 To intEnd
      strTmp = Empty
      If m_FieldList(idx - 1).fiOldData <> m_FieldList(idx - 1).fiNewData Then
         strTmp = m_FieldList(idx - 1).fiName
         '[有] 不需判斷的欄位,排除
         If intStart <> Empty Then
            For ii = intStart To UBound(arrNoChk)
               If strTmp = arrNoChk(ii) Then
                  strTmp = Empty
                  intStart = intStart + 1
                  Exit For
               End If
            Next ii
         End If
         '修改
         If int_EditMode = 2 And strTmp <> Empty Then
            strTmp = strTmp & " = '" & ChgSQL(m_FieldList(idx - 1).fiNewData) & "'"
         End If
      End If
      If strTmp <> Empty Then
         bDifference = True
         If bFirst = True Then
            strSql = strSql & strTmp
            bFirst = False
         Else
            strSql = strSql & "," & strTmp
         End If
      End If
   Next idx
   
   '不同
   If bDifference = True Then
      '新增
      If int_EditMode = 1 Then
         intStart = Empty
         If stNotChkFieldN <> MsgText(601) Then
            intStart = LBound(arrNoChk)
         End If
         bFirst = True
         For idx = 1 To intEnd
            strTmp = Empty
            If m_FieldList(idx - 1).fiOldData <> m_FieldList(idx - 1).fiNewData Then
               strTmp = "'" & ChgSQL(m_FieldList(idx - 1).fiNewData) & "'"
               '[有] 不需判斷的欄位,排除
               If intStart <> Empty Then
                  For ii = intStart To UBound(arrNoChk)
                     If strTmp = arrNoChk(ii) Then
                        strTmp = Empty
                        intStart = intStart + 1
                        Exit For
                     End If
                  Next ii
               End If
               If strTmp <> Empty Then
                  If bFirst = True Then
                     strValues = strValues & strTmp
                     bFirst = False
                  Else
                     strValues = strValues & "," & strTmp
                  End If
               End If
            End If
         Next idx
         If bDifference = True Then
            strSql = "Insert Into " & stTBN & " (" & strSql & ")  Values (" & strValues & ")"
         End If
      '修改
      Else
         strSql = "Update " & stTBN & " Set " & strSql & " Where RCL01='" & stKey & "' "
      End If
   End If
   Pub_GetFieldItemSql = strSql
End Function

'取得部門(新)
Public Function PUB_GetST93(strUserNum As String) As String
   Dim StrSQLa As String
   Dim rsA As New ADODB.Recordset
   
   PUB_GetST93 = ""
   StrSQLa = "Select ST93 From Staff Where ST01='" & strUserNum & "' "
   rsA.CursorLocation = adUseClient
   rsA.Open StrSQLa, cnnConnection, adOpenStatic, adLockReadOnly
   If rsA.RecordCount > 0 Then
       PUB_GetST93 = "" & rsA.Fields(0).Value
   End If
   If rsA.State <> adStateClosed Then rsA.Close
   Set rsA = Nothing
End Function

'傳入員工編號回傳其帶人主管List
'stF:查詢欄位
Public Function GetST52SelfList(stST01 As String, Optional ByVal stF As String = "st52") As String
   Dim rsA As New ADODB.Recordset, sta As String, intA As Integer, ii As Integer
   
   GetST52SelfList = ""
   sta = "Select " & stF & " From Staff Where st01='" & stST01 & "'"
   intA = 1
   Set rsA = ClsLawReadRstMsg(intA, sta)
   If intA = 1 Then
      For ii = 0 To rsA.Fields.Count - 1
         If IsNull(rsA.Fields(ii)) = False Then GetST52SelfList = GetST52SelfList & "," & rsA.Fields(ii)
      Next ii
      If GetST52SelfList <> MsgText(601) Then GetST52SelfList = Mid(GetST52SelfList, 2)
   End If
   Set rsA = Nothing
End Function

'傳入資料表及欄位,自動取得編號
Public Function GetNextAutoNo(ByVal stTB As String, stField As String, Optional ByVal stCon As String = "") As String
   Dim rsA As New ADODB.Recordset, intA As Integer, ii As Integer, sta As String, stWhere As String, stTmp(2) As String
   
   GetNextAutoNo = ""
   
   If stCon <> MsgText(601) Then stWhere = " Where " & stCon
   
   sta = "Select Max(" & stField & ") From " & stTB & stWhere
   intA = 1
   Set rsA = ClsLawReadRstMsg(intA, sta)
   If intA = 1 Then
      If IsNull(rsA.Fields(0).Value) Then
         GetNextAutoNo = 1
      Else
         stTmp(0) = rsA.Fields(0).Value
         'Memo 年月不判斷則自行處理
         For ii = 1 To Len(stTmp(0))
            stTmp(1) = Mid(stTmp(0), ii, 1)
            If IsNumeric(stTmp(1)) = False Then
               stTmp(2) = stTmp(2) & stTmp(1)
            Else
               Exit For
            End If
         Next ii
         stTmp(0) = Replace(stTmp(0), stTmp(2), "")
         GetNextAutoNo = stTmp(2) & Val(stTmp(0)) + 1
      End If
   Else
      GetNextAutoNo = 1
   End If
   Set rsA = Nothing
End Function

'Added by Lydia 2024/01/15 檢查尚在顧問聘任期間的客戶是否已設定顧問專用信箱CU199
Public Function Pub_GetChkCU199(ByVal pType As String, ByVal pCon1 As String, ByVal bolMailCache As Boolean) As String
Dim strMid As String, strCon As String
Dim intQ As Integer, rsQD As New ADODB.Recordset

   If pType = "1" Then  '1=收文號
      strCon = " and cp09='" & pCon1 & "'"
   Else   '2=指定日期尚在顧問聘任期間
      strCon = " and cp53<=" & DBDATE(pCon1) & " and cp54>=" & DBDATE(pCon1) & " "
   End If
   
   '顧問聘任(LA案收文0,ACS案收文112)
   strMid = " select cp01,cp02,cp03,cp04,cp05,cp09,cp10,nvl(los04,cp13) as cp13,cp53,cp54,nvl(lc05,nvl(lc06,lc07)) as casename,lc11 as c01,lc43 as c02,lc44 as c03,lc45 as c04,lc46 as c05" & _
      " ,decode(ct1.cu01,null,'',decode(nvl(ct1.cu153,'Y'),'Y',decode(ct1.cu199,null,'WA','無信箱','NO','OK') ,'N')) as c01a" & _
      " ,decode(ct2.cu01,null,'',decode(nvl(ct2.cu153,'Y'),'Y',decode(ct2.cu199,null,'WA','無信箱','NO','OK') ,'N')) as c02a" & _
      " ,decode(ct3.cu01,null,'',decode(nvl(ct3.cu153,'Y'),'Y',decode(ct3.cu199,null,'WA','無信箱','NO','OK') ,'N')) as c03a" & _
      " ,decode(ct4.cu01,null,'',decode(nvl(ct4.cu153,'Y'),'Y',decode(ct4.cu199,null,'WA','無信箱','NO','OK') ,'N')) as c04a" & _
      " ,decode(ct5.cu01,null,'',decode(nvl(ct5.cu153,'Y'),'Y',decode(ct5.cu199,null,'WA','無信箱','NO','OK') ,'N')) as c05a" & _
      " from caseprogress, lawcase, customer ct1, customer ct2, customer ct3, customer ct4, customer ct5,lawofficesource" & _
      " where cp01||cp10 in ('LA0','ACS112') and cp02<>'999999' and cp159=0" & strCon & _
      " and cp01=lc01(+) and cp02=lc02(+) and cp03=lc03(+) and cp04=lc04(+) and lc01 is not null" & _
      " and substr(lc11,1,8)=ct1.cu01(+) and substr(lc11,9,1)=ct1.cu02(+)" & _
      " and substr(lc43,1,8)=ct2.cu01(+) and substr(lc43,9,1)=ct2.cu02(+)" & _
      " and substr(lc44,1,8)=ct3.cu01(+) and substr(lc44,9,1)=ct3.cu02(+)" & _
      " and substr(lc45,1,8)=ct4.cu01(+) and substr(lc45,9,1)=ct4.cu02(+)" & _
      " and substr(lc46,1,8)=ct5.cu01(+) and substr(lc46,9,1)=ct5.cu02(+) and cp162=los15(+)"
   strMid = strMid & " Union" & _
      " select cp01,cp02,cp03,cp04,cp05,cp09,cp10,nvl(los04,cp13) as cp13,cp53,cp54,hc06 as casename,hc05 as c01,hc24 as c02,hc25 as c03,hc26 as c04,hc27 as c05" & _
      " ,decode(ct1.cu01,null,'',decode(nvl(ct1.cu153,'Y'),'Y',decode(ct1.cu199,null,'WA','無信箱','NO','OK') ,'N')) as c01a" & _
      " ,decode(ct2.cu01,null,'',decode(nvl(ct2.cu153,'Y'),'Y',decode(ct2.cu199,null,'WA','無信箱','NO','OK') ,'N')) as c02a" & _
      " ,decode(ct3.cu01,null,'',decode(nvl(ct3.cu153,'Y'),'Y',decode(ct3.cu199,null,'WA','無信箱','NO','OK') ,'N')) as c03a" & _
      " ,decode(ct4.cu01,null,'',decode(nvl(ct4.cu153,'Y'),'Y',decode(ct4.cu199,null,'WA','無信箱','NO','OK') ,'N')) as c04a" & _
      " ,decode(ct5.cu01,null,'',decode(nvl(ct5.cu153,'Y'),'Y',decode(ct5.cu199,null,'WA','無信箱','NO','OK') ,'N')) as c05a" & _
      " from caseprogress, hirecase, customer ct1, customer ct2, customer ct3, customer ct4, customer ct5,lawofficesource" & _
      " where cp01||cp10 in ('LA0','ACS112') and cp02<>'999999' and cp159=0" & strCon & _
      " and cp01=hc01(+) and cp02=hc02(+) and cp03=hc03(+) and cp04=hc04(+) and hc01 is not null" & _
      " and substr(hc05,1,8)=ct1.cu01(+) and substr(hc05,9,1)=ct1.cu02(+)" & _
      " and substr(hc24,1,8)=ct2.cu01(+) and substr(hc24,9,1)=ct2.cu02(+)" & _
      " and substr(hc25,1,8)=ct3.cu01(+) and substr(hc25,9,1)=ct3.cu02(+)" & _
      " and substr(hc26,1,8)=ct4.cu01(+) and substr(hc26,9,1)=ct4.cu02(+)" & _
      " and substr(hc27,1,8)=ct5.cu01(+) and substr(hc27,9,1)=ct5.cu02(+) and cp162=los15(+)"
      
   Pub_GetChkCU199 = "select vtb1.*, st15 ,nvl(a0924,a0908) as a0908 from (" & strMid & ") vtb1, staff, acc090, acc090new" & _
      " where instr(c01a||c02a||c03a||c04a||c05a,'WA') > 0 and cp13=st01(+) and st15=a0901(+) and st93=a0921(+)" & _
      " order by cp13,cp01,cp02,cp03,cp04"
   If bolMailCache = True Then
      intQ = 1
      Set rsQD = ClsLawReadRstMsg(intQ, Pub_GetChkCU199)
      If intQ = 1 Then
         If ("" & rsQD.Fields("c01") <> "" And "" & rsQD.Fields("c01a") = "WA") Or ("" & rsQD.Fields("c02") <> "" And "" & rsQD.Fields("c02a") = "WA") Or ("" & rsQD.Fields("c03") <> "" And "" & rsQD.Fields("c03a") = "WA") _
            Or ("" & rsQD.Fields("c04") <> "" And "" & rsQD.Fields("c04a") = "WA") Or ("" & rsQD.Fields("c05") <> "" And "" & rsQD.Fields("c05a") = "WA") Then
            strMid = "insert into mailcache(mc01,mc02,mc03,mc04,mc07,mc08,mc09,mc13)" & _
                  " values( '" & strUserNum & "','" & rsQD.Fields("cp13") & "',to_char(sysdate,'yyyymmdd'),to_char(sysdate,'hh24miss')" & _
                  ",'" & rsQD.Fields("cp01") & "-" & rsQD.Fields("cp02") & IIf(rsQD.Fields("cp03") & rsQD.Fields("cp04") = "000", "", "-" & rsQD.Fields("cp03") & "-" & rsQD.Fields("cp04")) & "客戶尚未設定顧問專用信箱，請與客戶確認後補上設定！' " & _
                  ", '" & vbCrLf & vbCrLf & "請進入承辦人系統->智權部->其他->客戶資料修改，選擇其他頁籤在顧問專用信箱輸入Email或無信箱。" & vbCrLf & vbCrLf & "',null,'" & rsQD.Fields("cp09") & "')"
            cnnConnection.Execute strMid
         End If
      End If
   End If
   Set rsQD = Nothing
End Function

'Add by Amy 2024/01/26
'風險檢查對象需管控之專利及商標部分案件性質需 發信 or 管控
'intChoose:0-全部 /1-只判斷CPM /1.1-回傳要發信的系統別+案件性質/1.2 只判斷CPM,若有專利903(專利調查),回傳 系統別+903
'                    2-只判斷風險檢查對象
'stCaseCPM:傳入案件性質 / stName:名稱(多筆;區隔 ex:中-台一;英-Taie)
'stBackTxt:回傳資料
'stCon: 其他傳入的條件
Public Function ChkRiskData(ByVal intChoose As Double, ByVal stFormN As String, Optional ByVal stSysKind As String, Optional ByVal stCaseCPM As String, _
  Optional ByVal stName As String, Optional ByRef stBackTxt As String = "", Optional ByVal stField As String, Optional ByVal intEditMode As Integer = 0, _
  Optional ByVal stCon As String = "") As Boolean
   Dim RsQ As New ADODB.Recordset, stQ As String, intQ As Integer, ii As Integer, jj As Integer, stCPM As String, stWhere As String, stOrderBy As String
   Dim bolCPM As Boolean, bolSqlOnly As Boolean, bolShowRCLField As Boolean, IsOrgName As Boolean
   Dim stFindTxt As String, stSign As String, stFieldAll As String, stSpecField(0) As String
   Dim stTmp(4) As String, stTxt(2) As String, arrChkCPM, arrTmp, arrTmp2, arrOrgN

   ChkRiskData = False: stBackTxt = ""
   stSign = "=" '以=比對
   IsOrgName = True '傳入為原始資料
   bolShowRCLField = True '顯示風險檢查對象 中/英/日 欄位
   bolSqlOnly = False '只回傳語法
   
   Select Case UCase(stFormN)
      '設定風險檢查對象之潛在客戶已收文列表
      Case UCase("AutoBatchDay-StrMenu127"), UCase("AutoBatchDay-StrMenu130")
         If Fix(intChoose) = 1 Then
            If stSysKind = "P" Then
               stWhere = "And (InStr(CPM01, 'P') > 0 Or CPM01 = 'FG') "
            Else
               stWhere = "And InStr(CPM01, 'T') > 0 "
            End If
            stOrderBy = " Order by CPM01 "
         ElseIf intChoose = 2 Then
            bolSqlOnly = True
            IsOrgName = False
            If strSrvDate(1) < 風險警示啟用日 Then
               stSign = ">"
            End If
         End If
      '接洽單-對造資料
      Case "FRM090801_14"
         If Fix(intChoose) = 1 Then
            stWhere = "And CPM01='" & stSysKind & "' "
         ElseIf intChoose = 2 Then
            stOrderBy = " Order by INTField"
         End If
      '電子接洽單
      Case "FRM090801_NEW"
         stWhere = "And CPM01='" & stSysKind & "' "
         If Fix(intChoose) = 1 Then
            stOrderBy = " Order by CPM02"
         End If
      '風險檢查對象資料維護
      Case "FRM12040163"
         If intChoose = 2 Then
            '會傳入stField / intEditMode
            stOrderBy = "Order by Sort"
         End If
      'Modify by 2024/05/21 +國內外潛在客戶
      '客戶檔維護
      Case "FRM140401", "FRM140402", "FRM210128_1"
         'Memo 國外潛客維護若為對造[不]可存檔 /國內潛客維護若為對造後[加字可]存檔
         If intChoose = 2 Then
            stSign = "="
            bolSqlOnly = True
         End If
   End Select

   If intChoose = 0 Or Fix(intChoose) = 1 Then
      If InStr(stSysKind, "P") > 0 Or stSysKind = "FG" Then
         '舉發(803),舉發答辯(804),第三人技術報告(807),第三方意見(809),異同分析(906),專利調查(903)
         stCPM = "803,804,807,809,906,903"
      ElseIf InStr(stSysKind, "T") > 0 Then
         '異議(601),其答辯(602),評定(603),其答辯(604),廢止(605),其答辯(606)
         stCPM = "601,602,603,604,605,606"
      End If
      If stCPM = MsgText(601) Then Exit Function

      stQ = "Select CPM01,CPM02 From CasePropertyMap Where  CPM02 in('" & Replace(stCPM, ",", "','") & "') " & _
                  stWhere & stOrderBy
      intQ = 1
      Set RsQ = ClsLawReadRstMsg(intQ, stQ)
      If intQ = 1 Then
         ReDim arrChkCPM(RsQ.RecordCount - 1)
         ii = 0: stTmp(0) = ""
         RsQ.MoveFirst
         Do While RsQ.EOF = False
            stTmp(0) = stTmp(0) & "," & RsQ.Fields("CPM01") & RsQ.Fields("CPM02")
            arrChkCPM(ii) = RsQ.Fields("CPM02")
            ii = ii + 1
            RsQ.MoveNext
         Loop
         
         If intChoose <> 1.1 Then
            stTmp(3) = ""
            For ii = LBound(arrChkCPM) To UBound(arrChkCPM)
               If InStr(stCaseCPM, arrChkCPM(ii)) > 0 Then
                  bolCPM = True
                  '專利903(專利調查),回傳 系統別+903
                  If intChoose = 1.2 Then
                     If (InStr(stSysKind, "P") > 0 Or InStr(stSysKind, "FG") > 0) And InStr(arrChkCPM(ii), "903") > 0 Then
                        stTmp(3) = stTmp(3) & "," & stSysKind & arrChkCPM(ii)
                     End If
                  Else
                     Exit For
                  End If
               End If
            Next ii
         End If
      End If
      
      If bolCPM = False Or Fix(intChoose) = 1 Then
         ChkRiskData = bolCPM
         '回傳系統別+案件性質
         If intChoose = 1.1 Then
            stBackTxt = Mid(stTmp(0), 2)
         '回傳比對到的 系統別+案件性質
         ElseIf intChoose = 1.2 Then
            stBackTxt = Mid(stTmp(3), 2)
         End If
         Set RsQ = Nothing
         Exit Function
      End If
   End If

   If intChoose = 0 Or Fix(intChoose) = 2 Then
      stQ = "": stWhere = "": stTmp(0) = "": stTmp(2) = "": stTmp(3) = ""
      '中英日★區隔
      arrTmp = Split(Replace(stName, "<BR>", ""), "★") '[中-名稱★英-名稱]英文名稱會有[,]不可用,區分
      '風險檢查對象資料中是否已有資料-中英日
      For ii = LBound(arrTmp) To UBound(arrTmp)
         stTxt(0) = arrTmp(ii)
         stTmp(0) = Replace(Replace(Replace(stTxt(0), "中-", ""), "英-", ""), "日-", "")  '[去]符號的名稱
         stTxt(0) = Replace(Replace(stTxt(0), stTmp(0), ""), "-", "") '傳入欄位 中/英/日
         If IsOrgName = True Then
            stTxt(1) = stTmp(0)    '[有]符號的名稱
            stTmp(0) = Pub_GetField("Dual", "1=1", "ReplaceSign(TO_MULTI_BYTE(Upper('" & ChgSQL(stTmp(0)) & "')))")
         End If
         
         arrTmp2 = Split(stTmp(0), "☆") '多個名稱用☆區分
         If IsOrgName = True Then
            arrOrgN = Split(stTxt(1), "☆")
         End If
         
         For jj = LBound(arrTmp2) To UBound(arrTmp2)
            stFindTxt = arrTmp2(jj) '[沒]符號的名稱
            If IsOrgName = True Then
               stSpecField(0) = ",'" & ChgSQL(arrOrgN(jj)) & "' as INTTxt" '顯示原始字([有]符號的名稱)
            Else
               stSpecField(0) = ",Decode(RCL33,'" & ChgSQL(stFindTxt) & "',RCL02,Decode(RCL34,'" & ChgSQL(stFindTxt) & "',RTrim(RCL03||' '||RCL04||' '||RCL05||' '||RCL06),Decode(RCL35,'" & ChgSQL(stFindTxt) & "',RCL07,null))) as INTTxt"
            End If
            '使用=尋找
            If stSign = "=" Then
               stFieldAll = ",Decode(RCL33,'" & ChgSQL(stFindTxt) & "','中',Decode(RCL34,'" & ChgSQL(stFindTxt) & "','英',Decode(RCL35,'" & ChgSQL(stFindTxt) & "','日',null))) as RCLField"
               stFieldAll = "RiskCheckList.*,ST02,'" & stTxt(0) & "' as INTField" & stFieldAll & stSpecField(0) & stField

               If stQ <> MsgText(601) Then stQ = stQ & " Union "
               stQ = stQ & "Select " & stFieldAll & " From RiskCheckList,Staff  Where RCL24 is null And RCL27=ST01(+) " & stCon & _
                                       "And (RCL33='" & stFindTxt & "' Or RCL34='" & stFindTxt & "' Or RCL35='" & stFindTxt & "') "
            '使用Instr尋找
            Else
               stFieldAll = "RiskCheckList.*,ST02,'" & stTxt(0) & "' as INTField" & stSpecField(0) & stField
               If stQ <> MsgText(601) Then stQ = stQ & " Union "
               stQ = stQ & "Select " & stFieldAll & ",'中' as RCLField From RiskCheckList,Staff  Where RCL24 is null And RCL27=ST01(+) " & stCon & _
                                    "And Instr(RCL33,'" & stFindTxt & "')>0 "
               stQ = stQ & " Union Select " & stFieldAll & ",'英' as RCLField From RiskCheckList,Staff  Where RCL24 is null And RCL27=ST01(+) " & stCon & _
                                       "And Instr(RCL34,'" & stFindTxt & "')>0 "
               stQ = stQ & " Union Select " & stFieldAll & ",'日' as RCLField From RiskCheckList,Staff  Where RCL24 is null And RCL27=ST01(+) " & stCon & _
                                       "And Instr(RCL35,'" & stFindTxt & "')>0 "

            End If
         Next jj
         
      Next ii
      stQ = stQ & stOrderBy
      If bolSqlOnly = True Then stBackTxt = stQ: Exit Function
      intQ = 1
      Set RsQ = ClsLawReadRstMsg(intQ, stQ)
      If intQ = 1 Then
         stTmp(0) = "": stTmp(1) = "": stTmp(2) = "": stTmp(3) = ""
         RsQ.MoveFirst
         Do While RsQ.EOF = False
            stTmp(4) = "": stTxt(1) = ""
            If "" & RsQ.Fields("INTField") <> MsgText(601) Then
               If InStr(stTmp(0), RsQ.Fields("INTField")) = 0 Then
                  stTxt(0) = "[" & RsQ.Fields("INTField") & "] " '傳入的中/英/日 字樣
               End If
            End If
            
            '傳入為原始字,直接抓語法串出的欄位
            If IsOrgName = True Then
               stTmp(4) = RsQ.Fields("INTTxt")
            '傳入[非]原始字,抓原始欄
            ElseIf bolShowRCLField = True Then
               Select Case "" & RsQ.Fields("RCLField")
                  Case "中"
                     stTmp(1) = "" & RsQ.Fields("RCL02")
                  Case "英"
                     stTmp(4) = "" & RsQ.Fields("RCL03")
                     If Not IsNull(RsQ.Fields("RCL04")) Then
                        stTmp(4) = stTmp(4) & RsQ.Fields("RCL04")
                        If Not IsNull(RsQ.Fields("RCL05")) Then
                           stTmp(4) = stTmp(4) & RsQ.Fields("RCL05")
                           If Not IsNull(RsQ.Fields("RCL06")) Then
                              stTmp(4) = stTmp(4) & RsQ.Fields("RCL06")
                           End If
                        End If
                     End If
                  Case "日"
                     stTmp(4) = "" & RsQ.Fields("RCL07")
                  Case Else
                     stTmp(4) = "" & RsQ.Fields("INTTxt")
               End Select
            End If
            If UCase(stFormN) = "FRM12040163" Then '風險檢查對象資料維護
               If intEditMode = 1 And RsQ.Fields("Sort") = 1 Then
                  stTmp(0) = stTmp(0) & "<br>名稱：" & stTmp(4) & vbCrLf & _
                                       "您已建於[風險檢查對象名單]" & vbCrLf
                  stTxt(1) = vbCrLf & "故不可重覆建立！" & vbCrLf
               Else
                  If InStr(stTmp(0), "<br>名稱：" & stTmp(4)) = 0 Then
                     stTmp(0) = stTmp(0) & "<br>名稱：" & stTmp(4)
                  End If
                  stTmp(0) = stTmp(0) & " [" & RsQ.Fields("ST02") & "] 同仁已建於[風險檢查對象名單]" & vbCrLf
               End If
            Else
               If InStr(stTmp(0), "<br>名稱：") = 0 Then
                  stTmp(0) = stTmp(0) & "<br>名稱："
               End If
               stTmp(0) = stTmp(0) & stTmp(4) & "存在於" & vbCrLf
            End If
                        
            stTmp(0) = stTmp(0) & "編號 [" & RsQ.Fields("RCL01") & "] "
            If bolShowRCLField = True Then
               stTmp(0) = stTmp(0) & "的 " & RsQ.Fields("RCLField") & " 文欄位"
            End If
            If stTxt(1) <> MsgText(601) Then
               stTmp(0) = stTmp(0) & stTxt(1)
            End If
            stTmp(0) = stTmp(0) & vbCrLf
            If InStr(stTmp(0), "不可重覆建立") > 0 Then Exit Do
            RsQ.MoveNext
         Loop
         ChkRiskData = True
         stBackTxt = Mid(stTmp(0), 5)
      End If
   End If
   Set RsQ = Nothing
End Function

'身份證/統編檢查
'intChoose:0-全部 / 1-只檢查身份證 / 2-只檢查統一編號 / 9-[非]台灣大陸 or 國籍不確定 只能輸8個0(境外公司),不可輸8個6(台灣 身份證/統編 補輸用)
'obj:跳下一個欄位,因按了「是」Focus還在身份證/統編欄位上,會一直觸發上面「檢查有誤,…」訊息無法跳離
'intCuType:0-未傳入個人或公司 / 1-個人 / 2-公司 'Add by Amy 2024/04/24
'加 objTab1 / objTab2 :切頁籤 'Add by Amy 2024/06/24
Public Function Pub_CheckIDAll(intChoose As Integer, stFormN As String, stID As String, Optional ByVal stNA01 As String = "", Optional ByVal stAddMsg As String = "", _
  Optional ByRef obj As Object, Optional intCuType As Integer = 0, Optional ByRef objTab1 As Object, Optional ByRef objTab2 As Object) As Boolean
   Dim ii As Integer, stMsg As String, stMsgFix As String, intLenID As Integer, bolChkNation(1) As Boolean
   Dim stSkip As String, IsAllSame As Boolean, stTP(1) As String 'Add by Amy 2024/03/28 略過的檢查編號,多個以;區隔 / 編號全是同一個數字
   Dim intTab2 As Integer 'Add by Amy 2024/06/24
   
   Pub_CheckIDAll = False
   intLenID = GetTextLength(stID)
   stMsgFix = "正確請按「是」, 欲修改請按「否」回前畫面！"
   Select Case UCase(stFormN)
      Case "FRM090801_NEW" '接洽單
         'Add by Amy 2024/06/24
         'stSkip = "00000000;66666666" 'Mark by Amy 2024/12/16 8個0 Or 8個6 改至後面判斷
         If InStr(stAddMsg, "申請人") > 0 Then
            intTab2 = Val(Replace(stAddMsg, "申請人", "")) - 1
         End If
      Case "FRM090801_14" '接洽單-對造資料
         If intLenID = 10 Then
            bolChkNation(0) = True
         ElseIf intLenID = 18 Then
            bolChkNation(1) = True
         End If
      Case "FRM12040163" '風險檢查資料維護
         stSkip = "00000000" 'Add by Amy 2024/04/24
      Case "FRM140401" '客戶檔維護
         'stSkip = "00000000;66666666" 'Mark by Amy 2024/12/16 8個0 Or 8個6 改至後面判斷
   End Select
   
   '編號中有空白 or 換行
   If InStr(Replace(Replace(Replace(stID, " ", "★"), "　", "★"), vbCrLf, "★"), "★") > 0 Then
      MsgBox stAddMsg & " 身份證/統一編號" & vbCrLf & "不可有空白或換行符號", , "輸入有誤"
      Exit Function
   End If
   
   'Modify by Amy 2024/04/24 先以國籍,國籍不是 台灣/大陸不需檢查
   'Modify by Amy 2024/12/16 台灣/大陸可輸8個[0]-境外公司;台灣才可輸8個[6]-台灣 身份證/統編 補輸用
   If stNA01 <> MsgText(601) Then
      If Left(stNA01, 3) < "010" Then
         bolChkNation(0) = True
         stSkip = "00000000;66666666"
      ElseIf Left(stNA01, 3) = "020" Then
         bolChkNation(1) = True
         stSkip = "00000000"
      ElseIf UCase(stFormN) <> "FRM12040163" Then '風險檢查資料維護
         'stID = "00000000" '國籍不是 台灣/大陸不需檢查,設8個0跳過
         stSkip = "00000000"
         intChoose = 9
      End If
   End If
   'end 2024/12/16
   'end 2024/04/24
   
   'Add by Amy 2024/03/28 略過不檢查
   If stSkip <> MsgText(601) Then
      If InStr(";" & stSkip & ";", ";" & stID & ";") > 0 Then
         Pub_CheckIDAll = True: Exit Function
      End If
   End If
   
   '客戶檔檢查編號不可全是同一個數字
   stTP(0) = "": stTP(1) = "": stMsg = ""
   'Modify by Amy 2024/06/24 +FRM090801_New
   If UCase(stFormN) = "FRM140401" Or UCase(stFormN) = "FRM090801_NEW" Then
      stTP(0) = "1": stTP(1) = Mid(stID, 1, 1)
      For ii = 2 To Len(stID)
         If stTP(1) = Mid(stID, ii, 1) Then
            stTP(0) = Val(stTP(0)) + 1
         End If
      Next ii
      If Val(stTP(0)) = Len(stID) Then
         stMsg = " 身份證/統一編號" & vbCrLf & "不可為同一個數字" & vbCrLf & vbCrLf
         'Modify by Amy 2024/12/18 以國籍區分訊息
         '台灣
         If bolChkNation(0) = True Then
            stMsg = stMsg & "PS.境外公司,請輸8個[0]" & vbCrLf & _
                                             "    身份證/統編 後補,請輸8個[6]"
         '[非]台灣
         Else
            stMsg = stMsg & "PS.境外公司,請輸8個[0]"
         End If
         'end 2024/12/18
         MsgBox stAddMsg & stMsg, , "輸入有誤"
         Exit Function
      End If
   End If
   'Modify by Amy 2024/12/26 ex:[非]台灣輸非正確碼數要可以過
   If intChoose = 9 Then Pub_CheckIDAll = True: Exit Function
   'end 2024/12/16
   'end 2024/03/28
   'Modify by Amy 2024/04/24 +intCuType
   'Memo by Amy ii:0-檢查 台灣 身份證/1- 台灣 統編/3-大陸 身份證/4-大陸 社會信用代碼/5-大陸 身份證 or 社會信用代碼/9-長度不對不檢查
   ii = -1
'*** 檢查字數 ***
   stMsg = ""
   '[無]國籍
   If stNA01 = MsgText(601) Then
      'Modify by Amy 2024/08/14 +大陸 社會信用代碼
      If intLenID <> 10 And intLenID <> 18 And intLenID <> 8 Then
         'Memo Len(stID) 不小心輸到中文才不會是Double
         stMsg = "台灣 身分證字號 10 碼 / 台灣 統一編號 8碼 / 大陸 身分證字號 及 社會信用代碼 都為18 碼 " & vbCrLf
      '未傳入個人或公司 or 個人 且長度10,檢查[台灣 身份證]
      ElseIf (intCuType = 0 Or intCuType = 1) And intLenID = 10 Then
         ii = 0
      '未傳入個人或公司 or 公司 且長度8,檢查[台灣 統編]
      ElseIf (intCuType = 0 Or intCuType = 2) And intLenID = 8 Then
         ii = 1
      '長度18,檢查[大陸 身份證 or 社會信用代碼]
      ElseIf intLenID = 18 Then
         '大陸 身份證
         If intCuType = 1 Then
            ii = 3
         '大陸 社會信用代碼 (公司)
         ElseIf intCuType = 2 Then
            ii = 4
         Else
            ii = 5
         End If
      End If
      'end 2024/08/14
   '國籍[台灣]
   ElseIf bolChkNation(0) = True Then
      '未傳入個人or公司 或 傳入為[個人] 且長度為10,檢查[台灣身份證]
      If (intCuType = 0 Or intCuType = 1) And intLenID = 10 Then
         ii = 0
      '未傳入個人or公司 或 傳入為[公司] 且長度為8,檢查[台灣統編]
      ElseIf (intCuType = 0 Or intCuType = 2) And intLenID = 8 Then
         ii = 1
      Else
         '傳入為[個人] 且長度[不是]10
         If intCuType = 1 And intLenID <> 10 Then
            stMsg = "台灣 身分證字號 10 碼 " & vbCrLf
         '傳入為[公司] 且長度[不是]8
         ElseIf intCuType = 2 And intLenID <> 8 Then
            stMsg = "台灣 統一編號 8碼 " & vbCrLf
         Else
            stMsg = "台灣 身分證字號 10 碼 / 統一編號 8碼" & vbCrLf
         End If
      End If
   '國籍為[大陸]
   ElseIf bolChkNation(1) = True Then
      stMsg = ""
      'Modify by Amy 2024/08/14 +大陸 社會信用代碼
      '長度18,檢查[大陸 身份證 or 社會信用代碼]
      If intLenID = 18 Then
         '大陸 身份證
         If intCuType = 1 Then
            ii = 3
         '大陸 社會信用代碼 (公司)
         ElseIf intCuType = 2 Then
            'ii = 9 '大陸統編尚未有檢查規則,先跳過
            ii = 4
         Else
            ii = 5
         End If
      Else
         If intCuType = 1 Then
            stMsg = "大陸 身分證字號 18 碼 " & vbCrLf
         ElseIf intCuType = 2 Then
            stMsg = "大陸 社會信用代碼 為18 碼 " & vbCrLf
         Else
            stMsg = "大陸 身分證字號 及 社會信用代碼 都為 18 碼 " & vbCrLf
         End If
      End If
      'end 2024/08/14
   End If
   If stMsg <> MsgText(601) Then
      'Add by Amy 2024/06/24 加頁籤
      If objTab1 Is Nothing = False Then objTab1.Tab = 1
      If objTab2 Is Nothing = False Then objTab2.Tab = intTab2
      stMsg = Replace(stMsg, " / ", vbCrLf) & stAddMsg & "目前輸入為 [" & Len(stID) & "] 碼" & vbCrLf & stMsgFix
      If MsgBox(stMsg, vbYesNo + vbCritical) = vbNo Then
         Exit Function
      Else
         ii = 9
      End If
   End If
   If ii = -1 Then
      If intLenID = 10 Then
         ii = 0
      ElseIf intLenID = 8 Then
         ii = 1
      ElseIf intLenID = 18 Then
         'Modify by Amy 2024/08/14 +大陸 社會信用代碼
         ii = 5
         '大陸 身份證
         If intCuType = 1 Then
            ii = 3
         '大陸 社會信用代碼 (公司)
         ElseIf intCuType = 2 Then
            ii = 4
         End If
         'end 2024/08/14
      End If
   End If
'*** End 檢查字數 ***
   
   If ii >= -1 And ii < 9 Then
      stMsg = ""
      '長度正確才依長度檢查
      If CheckID(ii, stID) = False Then
         Select Case ii
            Case 0
               stMsg = "台灣 身分證字號"
            Case 1
               stMsg = "統一編號"
            Case 3
               stMsg = "大陸 身分證字號"
            'Add by Amy 2024/08/14
            Case 4 '大陸 社會信用代碼
               stMsg = "大陸 社會信用代碼"
            Case 5 '大陸 編號檢查
               stMsg = "大陸 社會信用代碼 及 身分證字號"
         End Select
          'Add by Amy 2024/06/24 加頁籤
         If objTab1 Is Nothing = False Then objTab1.Tab = 1
         If objTab2 Is Nothing = False Then objTab2.Tab = intTab2
         If MsgBox(IIf(stAddMsg <> "", stAddMsg & " ", "") & stMsg & "檢查有誤" & vbCrLf & stMsgFix, vbYesNo + vbCritical) = vbNo Then
            Exit Function
         ElseIf TypeName(obj) <> "Nothing" Then
            obj.SetFocus
         End If
      End If
   End If 'ii >= -1 And ii < 9
   'end 2024/04/24
   Pub_CheckIDAll = True
End Function

'Add By Sindy 2016/7/26 依工程師組別,以下拉方式預設該組之工程師名單(依員工編號大小)供分案者點選,若無,就不顯示名單
Public Sub Frm060101_1_SetCboCP14(strCP10 As String, strPA150, CboCP14 As Object, Optional ByVal strInterval As String = "")
   If Not (strCP10 = "201" Or strCP10 = "927") Then '201.新案翻譯;927.其他翻譯除外
Dim strTmp As String, intA As Integer, rsAD As New ADODB.Recordset 'Added by Lydia 2024/05/15

      If strPA150 = "" Then
         CboCP14.Clear
      Else
         CboCP14.Clear
         'Modified by Lydia 2019/08/02 排除F4102 (FCP年費不續辦)
         'modify by sonia 2021/1/22 再排除F4104,F4105  94099
         'Modify By Sindy 2024/3/5 and substr(st01,4,1)<>'9' 改為 and st01<>'94099'
         strTmp = "select st01,st02 from staff" & _
                  " where st03='F21' and st04='1' and substr(st01,1)>='6' and substr(st01,1)<'F'" & _
                  " and st01<>'94099' and st01<>'F4102' and st01<>'F4104' and st01<>'F4105' " & _
                  " and st16='" & strPA150 & "'" & _
                  " order by st01 desc"
         intA = 1
         Set rsAD = ClsLawReadRstMsg(intA, strTmp)
         If intA = 1 Then
            With rsAD
               rsAD.MoveFirst
               Do While rsAD.EOF = False
                  If Trim(strInterval) = "" Then
                     CboCP14.AddItem Trim(rsAD.Fields("st01")) & " " & Trim(rsAD.Fields("st02"))
                  Else
                     CboCP14.AddItem Trim(rsAD.Fields("st01")) & " " & Trim(strInterval) & " " & Trim(rsAD.Fields("st02"))
                  End If
                  rsAD.MoveNext
               Loop
            End With
         End If
      End If
   End If
   Set rsAD = Nothing 'Added by Lydia 2024/05/15

End Sub

'Added by Morgan 2024/1/19
'Modified by Morgan 2024/3/12 改全域函數(單筆與整批請款共用)
Public Function PUB_GetRate(pDate As String, pA1K18 As String, pA1K28 As String, pSys As String, pAppNo As String) As String
   Dim stRate As String
   Dim stSaleZone As String, stSaleNo As String
   
   'Added by Morgan 2021/8/10 +Y51345北京正理商標事務所並預設匯率為 1/0.036=27.77(兩位後面捨去) -- 桂英
   If pA1K28 = "Y51345000" And pA1K18 = "USD" Then
      PUB_GetRate = 27.77
   'Added by Morgan 2022/11/8  --黃咸達/孫季仙
   ElseIf pAppNo = "X55070010" And pA1K18 = "USD" And pSys = "FCT" Then
      PUB_GetRate = 26.5
   'Added by Morgan 2024/1/17 加坡代理人SPRUSON & FERGUSON (AISA) PTE LTD (Y21071)商標案件固定請款匯率為USD1.00 = NTD28.39(若申請人為X55070010則申請人設定優先) --洪琬姿
   'Modified by Morgan 2024/5/28 +S--宜儒
   ElseIf pA1K28 = "Y21071000" And (pSys = "FCT" Or pSys = "S") And DBDATE(pDate) >= "20240117" And DBDATE(pDate) <= "20241231" Then
      PUB_GetRate = 28.39
   Else
   'end 2021/8/10
   
      'Added by Morgan 2025/8/13
      'MCP案件預設「預估結匯匯率」× 0.97 --韻丞/郭
      'Modified by Morgan 2025/10/1 台幣除外 --韻丞
      If InStr(pSys, "P") > 0 And pA1K18 <> "NTD" Then
         stSaleZone = GetCuSales(pAppNo, stSaleNo)
         If stSaleNo = "79075" Then
            PUB_GetRate = Round(PUB_GetAcc210(2, pA1K18, pDate) * 0.97, 2)
         End If
      End If
      'end 2025/8/13
      
      If PUB_GetRate = "" Then
         PUB_GetRate = PUB_GetUSXRate_1(pDate, pA1K18)
      End If
   End If 'Added by Morgan 2021/8/10
End Function

'Added by Morgan 2024/3/21
'Y55766德國專利局帳單防呆檢查 1.不可有電子檔 2.金額非整數提醒可繼續
Public Function PUB_Y55766BillCheck(pA1501 As String, pA1503 As String, pA1506 As String) As Boolean
   Dim stSQL As String, intR As Integer
   Dim rsQuery As ADODB.Recordset
   
   PUB_Y55766BillCheck = True
   If ChangeCustomerL(pA1503) = "Y55766000" Then
      stSQL = "select * from acc152 where ayf01 = '" & pA1501 & "'"
      intR = 1
      Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
      If intR = 1 Then
         MsgBox "付款對象德國專利局，請再次確認！" & vbCrLf & vbCrLf & "※帳單有電子檔", vbExclamation
         PUB_Y55766BillCheck = False
      ElseIf pA1506 <> Trunc(pA1506) Then
         If MsgBox("付款對象德國專利局，請再次確認！" & vbCrLf & vbCrLf & "※帳單金額(" & pA1506 & ")非整數是否要繼續？", vbExclamation + vbYesNo + vbDefaultButton2) = vbNo Then
            PUB_Y55766BillCheck = False
         End If
      End If
   End If
End Function

'Add By Sindy 2024/3/26 將作業置前端
Public Sub SetFormZOrder(oFormName As String)
Dim oForm As Object

   If PUB_CheckFormExist(oFormName, oForm) = True Then
      oForm.ZOrder
   End If
End Sub

'Added by Lydia 2024/04/22  代理人案件查詢->客戶/代理人案件統計的「案件往來」語法
'Modified by Lydia 2024/05/24 增加P/T案的區域統計語法 pSqlAreaNow,pSQLAreaPass
'Modified by Lydia 2025/09/19 + pStrTotKind => 增加選擇統計類別：1-新申請案、2-案件數(原本的統計方式)
Public Sub Pub_frm100114_6_StrMenu(ByVal pUserNo As String, ByVal pFrmName As String, ByVal pKeyNo As String, ByRef pSqlCon As String, _
           ByRef pSqlNow As String, ByRef pSQLpass As String, Optional ByRef pSqlAreaNow As String, Optional ByRef pSQLAreaPass As String, Optional ByVal pStrTotKind As String = "2")
Dim strExSql As String, intE As Integer
Dim strAreaSql As String 'Added by Lydia 2024/05/24
Dim strConX As String 'Added by Lydia 2025/08/15
Dim strPA As String, strNewPA As String, strTM As String, strNewTM  As String 'Added by Lydia 2025/09/19

   pSqlNow = ""
   pSQLpass = ""
   pKeyNo = ChangeCustomerL(pKeyNo)
   'Added by Lydia 2024/05/24
   pSqlAreaNow = ""
   pSQLAreaPass = ""
   'end 2024/05/24
   
   'Added by Lydia 2025/09/19
   If pStrTotKind = "1" Then
      strPA = SQLGrpStr("", 1)
      strPA = Replace(strPA, ",' '", "")
      strTM = SQLGrpStr("", 2)
      strTM = Replace(strTM, ",' '", "")
      strNewPA = "and (cp01 in (" & strPA & ") and " & PUB_GetForNewCaseSql("1") & ") "
      strNewTM = "and (cp01 in (" & strTM & ") " & PUB_GetForNewCaseSql("2") & ") "
      strPA = "AND (" & Mid(strNewPA, 4) & " OR " & Mid(strNewTM, 4) & ") "  '合併用在CF案
   End If
   'end 2025/09/19
   
   '清除暫存檔
   cnnConnection.Execute "DELETE FROM R100114_6 WHERE ID='" & pUserNo & "' AND FORMID = '" & pFrmName & "' "
   'Modified by Lydia 2025/08/15 增加對FCP,FCT案的管制，同時增加排除的案件性質:催審期限;
   ' 排除特定案件性質如下：回覆代理人、不續辦、取消收文、更換FC代理人、閉卷、催審、催公開、催提申、催收達、催款。
   'pSqlCon = "AND CP44 IS NOT NULL AND CP158>19221111 AND CP09<'C' AND CP01||CP10 NOT IN ('P902','P907','P913','P925','P937','CFP902','CFP907','CFP913','CFP925','CFP937','T703','T704','T718','T720','T726','TF703','TF704','TF718','TF720','TF726','CFT703','CFT704','CFT718','CFT720','CFT726')"
   'Modified by Lydia 2025/09/17 改成常數
   'pSqlCon = "AND CP44 IS NOT NULL AND CP158>19221111 AND CP09<'C' AND CP01||CP10 NOT IN ('P411','P902','P907','P913','P925','P937','P954','CFP411','CFP902','CFP907','CFP913','CFP925','CFP937','CFP952','CFP953','CFP954','CFP997','CFP998','CFP999','FCP411','FCP902','FCP907','FCP913','FCP925','FCP937','T305','T703','T704','T718','T720','T726','TF305','TF703','TF704','TF718','TF726','TF997','TF998','CFT305','CFT703','CFT704','CFT718','CFT720','CFT726','CFT901','CFT997','CFT998','FCT305','FCT703','FCT704','FCT718','FCT720','FCT726','FCT901')"
   pSqlCon = "AND CP44 IS NOT NULL AND CP158>19221111 AND CP09<'C' AND CP01||CP10 NOT IN (" & cntFAnotCP10tot & ") "
   strConX = Mid(pSqlCon, InStr(pSqlCon, "AND CP01||CP10"))
   'end 2025/08/15
   strExSql = "INSERT INTO R100114_6 (ID,FORMID,PNO,C01,C02,C03,C04,MINCP09,MAXCP09) " & _
               "SELECT '" & pUserNo & "','" & pFrmName & "','" & Left(pKeyNo, 8) & "',CP01,CP02,CP03,CP04,MIN(CP27||CP09||CP44) MINCP09,MAX(CP27||CP09||CP44) MAXCP09 FROM CASEPROGRESS " & _
               "   WHERE (CP01,CP02,CP03,CP04) IN (SELECT DISTINCT CP01,CP02,CP03,CP04 FROM CASEPROGRESS,PATENT,TRADEMARK WHERE CP158>19221111 " & _
               "   AND CP158<>NVL(NVL(TM30,PA58),0) AND CP44 LIKE '" & Left(pKeyNo, 8) & "%' AND CP04='00' AND CP09<'C' AND CP01=PA01(+) AND CP02=PA02(+) AND CP03=PA03(+) AND CP04=PA04(+) " & _
               "   AND CP01=TM01(+) AND CP02=TM02(+) AND CP03=TM03(+) AND CP04=TM04(+) AND CP44||' '<>PA75||TM44||' ') " & pSqlCon & _
               "   GROUP BY CP01,CP02,CP03,CP04"
   cnnConnection.Execute strExSql, intE


'------------------現在案件屬於該編號
   '1.現代理人：系統類別+歷年案件數（括弧內為近三年案件數）
   '2.現代理人之定義：從申請時委辦本所或是後續程序將案件轉至本所的現代理人
   '3.近三年之定義為：以2018/11/27查詢為例，近三年之定義為2015/11/27~2018/11/27
   '代理人
   If Left(pKeyNo, 1) = "Y" Then
      '現代理人
      strExSql = "SELECT CP01,COUNT(*)||'('||SUM(NEW)||')' FROM ("
      strAreaSql = "SELECT CP01T AS CP01,COUNT(*)||'('||SUM(NEW)||')' FROM (" 'Added by Lydia 2024/05/24 P/T案的區域統計語法
      '專利FC代理人  FCP-055795應抓105/11/16案件轉至本所,不可抓11/11/11分割
      'Modified by Lydia 2018/11/27 改為以系統當日起往前推3年的案件數(ex.2018/11/27~2015/11/27)
      'strexsql = strexsql & "SELECT DECODE(CP01,'CFP','FCFP','P',DECODE(PA09,'000',CP01,'FMP'),CP01) CP01,CP02,CP03,CP04,CP05,CP09,CP10,CP27,CP57,DECODE(SUBSTR(CP05,1,4),TO_CHAR(SYSDATE,'YYYY'),1,TO_CHAR(ADD_MONTHS(SYSDATE,-12),'YYYY'),1,TO_CHAR(ADD_MONTHS(SYSDATE,-24),'YYYY'),1,0) NEW " & _
                        "FROM CASEPROGRESS,PATENT WHERE CP09 IN " & _
                        "(SELECT SUBSTR(MIN(CP05||CP09),9) FROM CASEPROGRESS,PATENT WHERE PA75 LIKE '" & Left(pkeyno, 8) & "%' AND PA01=CP01(+) AND PA02=CP02(+) AND PA03=CP03(+) AND PA04=CP04(+) AND CP09<'C' " & _
                        "AND CP05>19221111 AND (CP158>19221111 OR (CP158=0 AND CP159=0)) GROUP BY CP01,CP02,CP03,CP04) AND PA01(+)=CP01 AND PA02(+)=CP02 AND PA03(+)=CP03 AND PA04(+)=CP04 "
      'Modified by Lydia 2019/01/02 P-120097,P-120098都是發文當天就閉卷，應該不能列入計算件數。
      'strexsql = strexsql & "SELECT DECODE(CP01,'CFP','FCFP','P',DECODE(PA09,'000',CP01,'FMP'),CP01) CP01,CP02,CP03,CP04,CP05,CP09,CP10,CP27,CP57,DECODE(SIGN((TO_CHAR(SYSDATE,'YYYYMMDD') - CP05)-30001),-1,1,0) NEW " & _
                        "FROM CASEPROGRESS,PATENT WHERE CP09 IN " & _
                        "(SELECT SUBSTR(MIN(CP05||CP09),9) FROM CASEPROGRESS,PATENT WHERE PA75 LIKE '" & Left(pkeyno, 8) & "%' AND PA01=CP01(+) AND PA02=CP02(+) AND PA03=CP03(+) AND PA04=CP04(+) AND CP09<'C' " & _
                        "AND CP05>19221111 AND (CP158>19221111 OR (CP158=0 AND CP159=0)) GROUP BY CP01,CP02,CP03,CP04) AND PA01(+)=CP01 AND PA02(+)=CP02 AND PA03(+)=CP03 AND PA04(+)=CP04 "
      'Modified by Lydia 2025/08/15 + strConX
      'Modified by Lydia 2025/09/19 + strNewPA
      strExSql = strExSql & "SELECT DECODE(CP01,'CFP','FCFP','P',DECODE(PA09,'000',CP01,'FMP'),CP01) CP01,CP02,CP03,CP04,CP05,CP09,CP10,CP27,CP57,DECODE(SIGN((TO_CHAR(SYSDATE,'YYYYMMDD') - CP05)-30001),-1,1,0) NEW " & _
                        "FROM CASEPROGRESS,PATENT WHERE CP09 IN " & _
                        "(SELECT SUBSTR(MIN(CP05||CP09),9) FROM CASEPROGRESS,PATENT WHERE PA75 LIKE '" & Left(pKeyNo, 8) & "%' AND PA01=CP01(+) AND PA02=CP02(+) AND PA03=CP03(+) AND PA04=CP04(+) AND CP09<'C' " & _
                        "AND CP05>19221111 AND ((CP158>19221111 AND CP158<>NVL(PA58,0)) OR (CP158=0 AND CP159=0)) " & strConX & strNewPA & " GROUP BY CP01,CP02,CP03,CP04) AND PA01(+)=CP01 AND PA02(+)=CP02 AND PA03(+)=CP03 AND PA04(+)=CP04 "
      'Added by Lydia 2024/05/24 P/T案的區域統計語法
      'Modified by Lydia 2025/08/15 + strConX
      'Modified by Lydia 2025/09/19 + strNewPA
      strAreaSql = strAreaSql & "SELECT DECODE(PA09,'000','P台灣','P非台灣') AS CP01T,CP01,CP02,CP03,CP04,CP05,CP09,CP10,CP27,CP57,DECODE(SIGN((TO_CHAR(SYSDATE,'YYYYMMDD') - CP05)-30001),-1,1,0) NEW " & _
                        "FROM CASEPROGRESS,PATENT WHERE CP09 IN " & _
                        "(SELECT SUBSTR(MIN(CP05||CP09),9) FROM CASEPROGRESS,PATENT WHERE PA75 LIKE '" & Left(pKeyNo, 8) & "%' AND PA01=CP01(+) AND PA02=CP02(+) AND PA03=CP03(+) AND PA04=CP04(+) AND CP09<'C' " & _
                        "AND CP05>19221111 AND ((CP158>19221111 AND CP158<>NVL(PA58,0)) OR (CP158=0 AND CP159=0)) " & strConX & strNewPA & " GROUP BY CP01,CP02,CP03,CP04) AND PA01(+)=CP01 AND PA02(+)=CP02 AND PA03(+)=CP03 AND PA04(+)=CP04 "

      '商標FC代理人
      'Modified by Lydia 2018/11/27 改為以系統當日起往前推3年的案件數(ex.2018/11/27~2015/11/27)
      'strexsql = strexsql & "Union SELECT DECODE(CP01,'CFT','FCFT','T',DECODE(TM10,'000',CP01,'FMT'),CP01) CP01,CP02,CP03,CP04,CP05,CP09,CP10,CP27,CP57,DECODE(SUBSTR(CP05,1,4),TO_CHAR(SYSDATE,'YYYY'),1,TO_CHAR(ADD_MONTHS(SYSDATE,-12),'YYYY'),1,TO_CHAR(ADD_MONTHS(SYSDATE,-24),'YYYY'),1,0) NEW " & _
                        "FROM CASEPROGRESS,TRADEMARK WHERE CP09 IN " & _
                        "(SELECT SUBSTR(MIN(CP05||CP09),9) FROM CASEPROGRESS,TRADEMARK WHERE TM44 LIKE '" & Left(pkeyno, 8) & "%' AND TM01=CP01(+) AND TM02=CP02(+) AND TM03=CP03(+) AND TM04=CP04(+) AND CP09<'C' " & _
                        "AND CP05>19221111 AND (CP158>19221111 OR (CP158=0 AND CP159=0)) GROUP BY CP01,CP02,CP03,CP04) AND TM01(+)=CP01 AND TM02(+)=CP02 AND TM03(+)=CP03 AND TM04(+)=CP04 "
      'Modified by Lydia 2019/01/02 P-120097,P-120098都是發文當天就閉卷，應該不能列入計算件數。
      'strexsql = strexsql & "Union SELECT DECODE(CP01,'CFT','FCFT','T',DECODE(TM10,'000',CP01,'FMT'),CP01) CP01,CP02,CP03,CP04,CP05,CP09,CP10,CP27,CP57,DECODE(SIGN((TO_CHAR(SYSDATE,'YYYYMMDD') - CP05)-30001),-1,1,0) NEW " & _
                        "FROM CASEPROGRESS,TRADEMARK WHERE CP09 IN " & _
                        "(SELECT SUBSTR(MIN(CP05||CP09),9) FROM CASEPROGRESS,TRADEMARK WHERE TM44 LIKE '" & Left(pkeyno, 8) & "%' AND TM01=CP01(+) AND TM02=CP02(+) AND TM03=CP03(+) AND TM04=CP04(+) AND CP09<'C' " & _
                        "AND CP05>19221111 AND (CP158>19221111 OR (CP158=0 AND CP159=0)) GROUP BY CP01,CP02,CP03,CP04) AND TM01(+)=CP01 AND TM02(+)=CP02 AND TM03(+)=CP03 AND TM04(+)=CP04 "
      'Modified by Lydia 2025/08/15 + strConX
      'Modified by Lydia 2025/09/19 + strNewTM
      strExSql = strExSql & "Union SELECT DECODE(CP01,'CFT','FCFT','T',DECODE(TM10,'000',CP01,'FMT'),CP01) CP01,CP02,CP03,CP04,CP05,CP09,CP10,CP27,CP57,DECODE(SIGN((TO_CHAR(SYSDATE,'YYYYMMDD') - CP05)-30001),-1,1,0) NEW " & _
                        "FROM CASEPROGRESS,TRADEMARK WHERE CP09 IN " & _
                        "(SELECT SUBSTR(MIN(CP05||CP09),9) FROM CASEPROGRESS,TRADEMARK WHERE TM44 LIKE '" & Left(pKeyNo, 8) & "%' AND TM01=CP01(+) AND TM02=CP02(+) AND TM03=CP03(+) AND TM04=CP04(+) AND CP09<'C' " & _
                        "AND CP05>19221111 AND ((CP158>19221111 AND CP158<>NVL(TM30,0)) OR (CP158=0 AND CP159=0)) " & strConX & strNewTM & " GROUP BY CP01,CP02,CP03,CP04) AND TM01(+)=CP01 AND TM02(+)=CP02 AND TM03(+)=CP03 AND TM04(+)=CP04 "
      'Added by Lydia 2024/05/24 P/T案的區域統計語法
      'Modified by Lydia 2025/08/15 + strConX
      'Modified by Lydia 2025/09/19 + strNewTM
      strAreaSql = strAreaSql & "Union SELECT DECODE(TM10,'000','T台灣','T非台灣') AS CP01T,CP01,CP02,CP03,CP04,CP05,CP09,CP10,CP27,CP57,DECODE(SIGN((TO_CHAR(SYSDATE,'YYYYMMDD') - CP05)-30001),-1,1,0) NEW " & _
                        "FROM CASEPROGRESS,TRADEMARK WHERE CP09 IN " & _
                        "(SELECT SUBSTR(MIN(CP05||CP09),9) FROM CASEPROGRESS,TRADEMARK WHERE TM44 LIKE '" & Left(pKeyNo, 8) & "%' AND TM01=CP01(+) AND TM02=CP02(+) AND TM03=CP03(+) AND TM04=CP04(+) AND CP09<'C' " & _
                        "AND CP05>19221111 AND ((CP158>19221111 AND CP158<>NVL(TM30,0)) OR (CP158=0 AND CP159=0)) " & strConX & strNewTM & " GROUP BY CP01,CP02,CP03,CP04) AND TM01(+)=CP01 AND TM02(+)=CP02 AND TM03(+)=CP03 AND TM04(+)=CP04 "
                        
      '專利及商標CF代理人(子案不算)
      'Modified by Lydia 2018/11/27 改為以系統當日起往前推3年的案件數(ex.2018/11/27~2015/11/27)
      'strexsql = strexsql & "Union SELECT CP01,CP02,CP03,CP04,CP05,CP09,CP10,CP27,CP57,DECODE(SUBSTR(CP27,1,4),TO_CHAR(SYSDATE,'YYYY'),1,TO_CHAR(ADD_MONTHS(SYSDATE,-12),'YYYY'),1,TO_CHAR(ADD_MONTHS(SYSDATE,-24),'YYYY'),1,0) NEW " & _
                        "FROM CASEPROGRESS WHERE CP09 IN (SELECT SUBSTR(MAXCP09,9,9) FROM " & _
                        "(SELECT CP01,CP02,CP03,CP04,MIN(CP27||CP09||CP44) MINCP09,MAX(CP27||CP09||CP44) MAXCP09 FROM CASEPROGRESS WHERE (CP01,CP02,CP03,CP04) IN " & _
                        "(SELECT DISTINCT CP01,CP02,CP03,CP04 FROM CASEPROGRESS,PATENT,TRADEMARK WHERE CP158>19221111 AND CP44 LIKE '" & Left(pkeyno, 8) & "%' AND CP04='00' AND CP09<'C' " & _
                        "AND CP01=PA01(+) AND CP02=PA02(+) AND CP03=PA03(+) AND CP04=PA04(+) AND CP01=TM01(+) AND CP02=TM02(+) AND CP03=TM03(+) AND CP04=TM04(+) " & _
                        "AND CP44||' '<>PA75||TM44||' ') " & _
                        "AND CP158>19221111 AND CP09<'C' AND CP01||CP10 NOT IN ('P902','P907','P913','P925','P937','CFP902','CFP907','CFP913','CFP925','CFP937','T703','T704','T718','T720','T726','TF703','TF704','TF718','TF720','TF726','CFT703','CFT704','CFT718','CFT720','CFT726') " & _
                        "GROUP BY CP01,CP02,CP03,CP04)) AND CP44 LIKE '" & Left(pkeyno, 8) & "%') "
      'Modified by Lydia 2019/01/02 P-120097,P-120098都是發文當天就閉卷，應該不能列入計算件數。
      'strexsql = strexsql & "Union SELECT CP01,CP02,CP03,CP04,CP05,CP09,CP10,CP27,CP57,DECODE(SIGN((TO_CHAR(SYSDATE,'YYYYMMDD') - CP27)-30001),-1,1,0) NEW " & _
                        "FROM CASEPROGRESS WHERE CP09 IN (SELECT SUBSTR(MAXCP09,9,9) FROM " & _
                        "(SELECT CP01,CP02,CP03,CP04,MIN(CP27||CP09||CP44) MINCP09,MAX(CP27||CP09||CP44) MAXCP09 FROM CASEPROGRESS WHERE (CP01,CP02,CP03,CP04) IN " & _
                        "(SELECT DISTINCT CP01,CP02,CP03,CP04 FROM CASEPROGRESS,PATENT,TRADEMARK WHERE CP158>19221111 AND CP44 LIKE '" & Left(pkeyno, 8) & "%' AND CP04='00' AND CP09<'C' " & _
                        "AND CP01=PA01(+) AND CP02=PA02(+) AND CP03=PA03(+) AND CP04=PA04(+) AND CP01=TM01(+) AND CP02=TM02(+) AND CP03=TM03(+) AND CP04=TM04(+) " & _
                        "AND CP44||' '<>PA75||TM44||' ') " & _
                        "AND CP158>19221111 AND CP09<'C' AND CP01||CP10 NOT IN ('P902','P907','P913','P925','P937','CFP902','CFP907','CFP913','CFP925','CFP937','T703','T704','T718','T720','T726','TF703','TF704','TF718','TF720','TF726','CFT703','CFT704','CFT718','CFT720','CFT726') " & _
                        "GROUP BY CP01,CP02,CP03,CP04)) AND CP44 LIKE '" & Left(pkeyno, 8) & "%') "
      'Modified by Lydia 2019/05/06 現在案件屬於Y編號
      'strexsql = strexsql & "Union SELECT CP01,CP02,CP03,CP04,CP05,CP09,CP10,CP27,CP57,DECODE(SIGN((TO_CHAR(SYSDATE,'YYYYMMDD') - CP27)-30001),-1,1,0) NEW " & _
                        "FROM CASEPROGRESS WHERE CP09 IN (SELECT SUBSTR(MAXCP09,9,9) FROM " & _
                        "(SELECT CP01,CP02,CP03,CP04,MIN(CP27||CP09||CP44) MINCP09,MAX(CP27||CP09||CP44) MAXCP09 FROM CASEPROGRESS WHERE (CP01,CP02,CP03,CP04) IN " & _
                        "(SELECT DISTINCT CP01,CP02,CP03,CP04 FROM CASEPROGRESS,PATENT,TRADEMARK WHERE CP158>19221111 AND CP158<>NVL(NVL(TM30,PA58),0) AND CP44 LIKE '" & Left(pkeyno, 8) & "%' AND CP04='00' AND CP09<'C' " & _
                        "AND CP01=PA01(+) AND CP02=PA02(+) AND CP03=PA03(+) AND CP04=PA04(+) AND CP01=TM01(+) AND CP02=TM02(+) AND CP03=TM03(+) AND CP04=TM04(+) " & _
                        "AND CP44||' '<>PA75||TM44||' ') " & _
                        "AND CP158>19221111 AND CP09<'C' AND CP01||CP10 NOT IN ('P902','P907','P913','P925','P937','CFP902','CFP907','CFP913','CFP925','CFP937','T703','T704','T718','T720','T726','TF703','TF704','TF718','TF720','TF726','CFT703','CFT704','CFT718','CFT720','CFT726') " & _
                        "GROUP BY CP01,CP02,CP03,CP04)) AND CP44 LIKE '" & Left(pkeyno, 8) & "%') "
         'Modified by Lydia 2025/08/15 限專利,商標案
         'strExSql = strExSql & "Union SELECT CP01,CP02,CP03,CP04,CP05,CP09,CP10,CP27,CP57,DECODE(SIGN((TO_CHAR(SYSDATE,'YYYYMMDD') - CP27)-30001),-1,1,0) NEW " & _
                        "FROM CASEPROGRESS WHERE CP09 IN (SELECT SUBSTR(MINCP09,9,9) FROM " & _
                        "(SELECT CP01,CP02,CP03,CP04,MIN(CP27||CP09||CP44) MINCP09 FROM CASEPROGRESS WHERE (CP01,CP02,CP03,CP04) IN " & _
                        "(SELECT C01,C02,C03,C04 FROM R100114_6 WHERE ID='" & pUserNo & "' AND FORMID='" & pFrmName & "' AND INSTR(MAXCP09,'" & Left(pKeyNo, 8) & "') > 0 AND PNO='" & Left(pKeyNo, 8) & "' ) " & _
                        "AND CP44 LIKE '" & Left(pKeyNo, 8) & "%' " & pSqlCon & _
                        " GROUP BY CP01,CP02,CP03,CP04)) "
         'Added by Lydia 2025/09/19
         If pStrTotKind = "1" Then '選擇統計方式：1-新申請案，不用另外分析案件已轉它所。
            strExSql = strExSql & "Union SELECT CP01,CP02,CP03,CP04,CP05,CP09,CP10,CP27,CP57,DECODE(SIGN((TO_CHAR(SYSDATE,'YYYYMMDD') - CP27)-30001),-1,1,0) NEW " & _
                           "FROM CASEPROGRESS,PATENT,TRADEMARK WHERE CP09 IN (SELECT SUBSTR(MINCP09,9,9) FROM " & _
                           "(SELECT CP01,CP02,CP03,CP04,MIN(CP27||CP09||CP44) MINCP09 FROM CASEPROGRESS WHERE (CP01,CP02,CP03,CP04) IN " & _
                           "(SELECT C01,C02,C03,C04 FROM R100114_6 WHERE ID='" & pUserNo & "' AND FORMID='" & pFrmName & "' AND INSTR(MINCP09,'" & Left(pKeyNo, 8) & "') > 0 AND PNO='" & Left(pKeyNo, 8) & "' ) " & _
                           "AND CP44 LIKE '" & Left(pKeyNo, 8) & "%' " & pSqlCon & strPA & _
                           " GROUP BY CP01,CP02,CP03,CP04)) AND CP01=PA01(+) AND CP02=PA02(+) AND CP03=PA03(+) AND CP04=PA04(+) AND CP01=TM01(+) AND CP02=TM02(+) AND CP03=TM03(+) AND CP04=TM04(+) AND PA01||TM01 IS NOT NULL "
            'P/T案的區域統計語法
            strAreaSql = strAreaSql & "Union SELECT DECODE(PA01,NULL,DECODE(TM01,NULL,CP01,DECODE(TM10,'000','T台灣','T非台灣')),DECODE(PA09,'000','P台灣','P非台灣')) AS CP01T,CP01,CP02,CP03,CP04,CP05,CP09,CP10,CP27,CP57,DECODE(SIGN((TO_CHAR(SYSDATE,'YYYYMMDD') - CP27)-30001),-1,1,0) NEW " & _
                           "FROM CASEPROGRESS,PATENT,TRADEMARK WHERE CP09 IN (SELECT SUBSTR(MINCP09,9,9) FROM " & _
                           "(SELECT CP01,CP02,CP03,CP04,MIN(CP27||CP09||CP44) MINCP09 FROM CASEPROGRESS WHERE (CP01,CP02,CP03,CP04) IN " & _
                           "(SELECT C01,C02,C03,C04 FROM R100114_6 WHERE ID='" & pUserNo & "' AND FORMID='" & pFrmName & "' AND INSTR(MINCP09,'" & Left(pKeyNo, 8) & "') > 0 AND PNO='" & Left(pKeyNo, 8) & "' ) " & _
                           "AND CP44 LIKE '" & Left(pKeyNo, 8) & "%' " & pSqlCon & strPA & _
                           " GROUP BY CP01,CP02,CP03,CP04)) AND CP01=PA01(+) AND CP02=PA02(+) AND CP03=PA03(+) AND CP04=PA04(+) AND CP01=TM01(+) AND CP02=TM02(+) AND CP03=TM03(+) AND CP04=TM04(+) AND PA01||TM01 IS NOT NULL "
         
         Else
         'end 2025/09/19
            strExSql = strExSql & "Union SELECT CP01,CP02,CP03,CP04,CP05,CP09,CP10,CP27,CP57,DECODE(SIGN((TO_CHAR(SYSDATE,'YYYYMMDD') - CP27)-30001),-1,1,0) NEW " & _
                           "FROM CASEPROGRESS,PATENT,TRADEMARK WHERE CP09 IN (SELECT SUBSTR(MINCP09,9,9) FROM " & _
                           "(SELECT CP01,CP02,CP03,CP04,MIN(CP27||CP09||CP44) MINCP09 FROM CASEPROGRESS WHERE (CP01,CP02,CP03,CP04) IN " & _
                           "(SELECT C01,C02,C03,C04 FROM R100114_6 WHERE ID='" & pUserNo & "' AND FORMID='" & pFrmName & "' AND INSTR(MAXCP09,'" & Left(pKeyNo, 8) & "') > 0 AND PNO='" & Left(pKeyNo, 8) & "' ) " & _
                           "AND CP44 LIKE '" & Left(pKeyNo, 8) & "%' " & pSqlCon & _
                           " GROUP BY CP01,CP02,CP03,CP04)) AND CP01=PA01(+) AND CP02=PA02(+) AND CP03=PA03(+) AND CP04=PA04(+) AND CP01=TM01(+) AND CP02=TM02(+) AND CP03=TM03(+) AND CP04=TM04(+) AND PA01||TM01 IS NOT NULL "
            'Added by Lydia 2024/05/24 P/T案的區域統計語法
            'Modified by Lydia 2025/08/15 +AND PA01||TM01 IS NOT NULL
            strAreaSql = strAreaSql & "Union SELECT DECODE(PA01,NULL,DECODE(TM01,NULL,CP01,DECODE(TM10,'000','T台灣','T非台灣')),DECODE(PA09,'000','P台灣','P非台灣')) AS CP01T,CP01,CP02,CP03,CP04,CP05,CP09,CP10,CP27,CP57,DECODE(SIGN((TO_CHAR(SYSDATE,'YYYYMMDD') - CP27)-30001),-1,1,0) NEW " & _
                           "FROM CASEPROGRESS,PATENT,TRADEMARK WHERE CP09 IN (SELECT SUBSTR(MINCP09,9,9) FROM " & _
                           "(SELECT CP01,CP02,CP03,CP04,MIN(CP27||CP09||CP44) MINCP09 FROM CASEPROGRESS WHERE (CP01,CP02,CP03,CP04) IN " & _
                           "(SELECT C01,C02,C03,C04 FROM R100114_6 WHERE ID='" & pUserNo & "' AND FORMID='" & pFrmName & "' AND INSTR(MAXCP09,'" & Left(pKeyNo, 8) & "') > 0 AND PNO='" & Left(pKeyNo, 8) & "' ) " & _
                           "AND CP44 LIKE '" & Left(pKeyNo, 8) & "%' " & pSqlCon & _
                           " GROUP BY CP01,CP02,CP03,CP04)) AND CP01=PA01(+) AND CP02=PA02(+) AND CP03=PA03(+) AND CP04=PA04(+) AND CP01=TM01(+) AND CP02=TM02(+) AND CP03=TM03(+) AND CP04=TM04(+) AND PA01||TM01 IS NOT NULL "
         End If 'Added by Lydia 2025/09/19
   '申請人
   Else
      'Added by Lydia 2023/06/07 Owen製作下周日本關西地區拜訪客戶之排程表,其中有申請人,暫時參考代理人的寫法
      strExSql = "SELECT CP01,COUNT(*)||'('||SUM(NEW)||')' FROM ("
      '專利
      'Modified by Lydia 2025/08/15 +strConX
      'Modified by Lydia 2025/09/19 + strNewPA
      strExSql = strExSql & "SELECT DECODE(CP01,'CFP','FCFP','P',DECODE(PA09,'000',CP01,'FMP'),CP01) CP01,CP02,CP03,CP04,CP05,CP09,CP10,CP27,CP57,DECODE(SIGN((TO_CHAR(SYSDATE,'YYYYMMDD') - CP05)-30001),-1,1,0) NEW " & _
                        "FROM CASEPROGRESS,PATENT WHERE CP09 IN " & _
                        "(SELECT SUBSTR(MIN(CP05||CP09),9) FROM CASEPROGRESS,PATENT WHERE INSTR(PA26||PA27||PA28||PA29||PA30,'" & Left(pKeyNo, 8) & "') > 0 AND PA01=CP01(+) AND PA02=CP02(+) AND PA03=CP03(+) AND PA04=CP04(+) AND CP09<'C' " & _
                        "AND CP05>19221111 AND ((CP158>19221111 AND CP158<>NVL(PA58,0)) OR (CP158=0 AND CP159=0)) " & strConX & strNewPA & " GROUP BY CP01,CP02,CP03,CP04) AND PA01(+)=CP01 AND PA02(+)=CP02 AND PA03(+)=CP03 AND PA04(+)=CP04 "
      '商標
      'Modified by Lydia 2025/08/15 +strConX
      'Modified by Lydia 2025/09/19 + strNewTM
      strExSql = strExSql & "Union SELECT DECODE(CP01,'CFT','FCFT','T',DECODE(TM10,'000',CP01,'FMT'),CP01) CP01,CP02,CP03,CP04,CP05,CP09,CP10,CP27,CP57,DECODE(SIGN((TO_CHAR(SYSDATE,'YYYYMMDD') - CP05)-30001),-1,1,0) NEW " & _
                        "FROM CASEPROGRESS,TRADEMARK WHERE CP09 IN " & _
                        "(SELECT SUBSTR(MIN(CP05||CP09),9) FROM CASEPROGRESS,TRADEMARK WHERE INSTR(TM23||TM78||TM79||TM80||TM81,'" & Left(pKeyNo, 8) & "') > 0 AND TM01=CP01(+) AND TM02=CP02(+) AND TM03=CP03(+) AND TM04=CP04(+) AND CP09<'C' " & _
                        "AND CP05>19221111 AND ((CP158>19221111 AND CP158<>NVL(TM30,0)) OR (CP158=0 AND CP159=0)) " & strConX & strNewTM & " GROUP BY CP01,CP02,CP03,CP04) AND TM01(+)=CP01 AND TM02(+)=CP02 AND TM03(+)=CP03 AND TM04(+)=CP04 "
      'end 2023/06/07
      'Added by Lydia 2024/05/24 P/T案的區域統計語法
      strAreaSql = "SELECT CP01T AS CP01,COUNT(*)||'('||SUM(NEW)||')' FROM ("
      '專利
      'Modified by Lydia 2025/08/15 +strConX
      'Modified by Lydia 2025/09/19 + strNewPA
      strAreaSql = strAreaSql & "SELECT DECODE(PA09,'000','P台灣','P非台灣') AS CP01T,CP01,CP02,CP03,CP04,CP05,CP09,CP10,CP27,CP57,DECODE(SIGN((TO_CHAR(SYSDATE,'YYYYMMDD') - CP05)-30001),-1,1,0) NEW " & _
                        "FROM CASEPROGRESS,PATENT WHERE CP09 IN " & _
                        "(SELECT SUBSTR(MIN(CP05||CP09),9) FROM CASEPROGRESS,PATENT WHERE INSTR(PA26||PA27||PA28||PA29||PA30,'" & Left(pKeyNo, 8) & "') > 0 AND PA01=CP01(+) AND PA02=CP02(+) AND PA03=CP03(+) AND PA04=CP04(+) AND CP09<'C' " & _
                        "AND CP05>19221111 AND ((CP158>19221111 AND CP158<>NVL(PA58,0)) OR (CP158=0 AND CP159=0)) " & strConX & strNewPA & " GROUP BY CP01,CP02,CP03,CP04) AND PA01(+)=CP01 AND PA02(+)=CP02 AND PA03(+)=CP03 AND PA04(+)=CP04 "
      '商標
      'Modified by Lydia 2025/08/15 +strConX
      'Modified by Lydia 2025/09/19 + strNewTM
      strAreaSql = strAreaSql & "Union SELECT DECODE(TM10,'000','T台灣','T非台灣') AS CP01T,CP01,CP02,CP03,CP04,CP05,CP09,CP10,CP27,CP57,DECODE(SIGN((TO_CHAR(SYSDATE,'YYYYMMDD') - CP05)-30001),-1,1,0) NEW " & _
                        "FROM CASEPROGRESS,TRADEMARK WHERE CP09 IN " & _
                        "(SELECT SUBSTR(MIN(CP05||CP09),9) FROM CASEPROGRESS,TRADEMARK WHERE INSTR(TM23||TM78||TM79||TM80||TM81,'" & Left(pKeyNo, 8) & "') > 0 AND TM01=CP01(+) AND TM02=CP02(+) AND TM03=CP03(+) AND TM04=CP04(+) AND CP09<'C' " & _
                        "AND CP05>19221111 AND ((CP158>19221111 AND CP158<>NVL(TM30,0)) OR (CP158=0 AND CP159=0)) " & strConX & strNewTM & " GROUP BY CP01,CP02,CP03,CP04) AND TM01(+)=CP01 AND TM02(+)=CP02 AND TM03(+)=CP03 AND TM04(+)=CP04 "
      'end 2024/05/24
   End If
   'Modified by Lydia 2019/05/06
   'strexsql = strexsql & "GROUP BY CP01 ORDER BY 1 "
   strExSql = strExSql & " ) GROUP BY CP01 ORDER BY 1 "
   pSqlNow = strExSql
   
   'Added by Lydia 2024/05/24
   strAreaSql = strAreaSql & " ) GROUP BY CP01T ORDER BY 1 "
   pSqlAreaNow = strAreaSql
   'end 2024/05/24
   
'------------------曾經案件屬於該編號
   '4.案件如已更代或申請人已變動，則以系統類別*呈現此種狀況中其為原代理人或原申請人的案件數
   '代理人
   If pStrTotKind = "2" Then 'Added by Lydia 2025/09/19 選擇統計方式：2-案件數，才需要分析過去案件
      If Left(pKeyNo, 1) = "Y" Then
         '原代理人
         strExSql = "SELECT CP01||'*',COUNT(*)||'('||SUM(NEW)||')' FROM ("
         strAreaSql = "SELECT CP01T AS CP01,COUNT(*)||'('||SUM(NEW)||')' FROM (" 'Added by Lydia 2024/05/24 P/T案的區域統計語法
         '專利FC代理人
         'Modified by Lydia 2018/11/27 改為以系統當日起往前推3年的案件數(ex.2018/11/27~2015/11/27)
         'strexsql = strexsql & "SELECT DECODE(CP01,'CFP','FCFP','P',DECODE(PA09,'000',CP01,'FMP'),CP01) CP01,CP02,CP03,CP04,CP05,CP09,CP10,CP27,CP57,DECODE(SUBSTR(CP05,1,4),TO_CHAR(SYSDATE,'YYYY'),1,TO_CHAR(ADD_MONTHS(SYSDATE,-12),'YYYY'),1,TO_CHAR(ADD_MONTHS(SYSDATE,-24),'YYYY'),1,0) NEW " & _
                           "FROM CASEPROGRESS,PATENT WHERE CP09 IN " & _
                           " (SELECT SUBSTR(MIN(CP05||CP09),9) FROM CASEPROGRESS,PATENT WHERE CP139 LIKE '" & Left(pkeyno, 8) & "%' AND PA01(+)=CP01 AND PA02(+)=CP02 AND PA03(+)=CP03 AND PA04(+)=CP04 AND PA01 IS NOT NULL AND CP09<'C' " & _
                           "    AND SUBSTR(CP139,1,8)<>SUBSTR(PA75,1,8) AND CP05>19221111 AND (CP158>19221111 OR (CP158=0 AND CP159=0)) GROUP BY CP01,CP02,CP03,CP04) AND PA01(+)=CP01 AND PA02(+)=CP02 AND PA03(+)=CP03 AND PA04(+)=CP04 "
         'Modified by Lydia 2019/01/02 P-120097,P-120098都是發文當天就閉卷，應該不能列入計算件數。
         'strexsql = strexsql & "SELECT DECODE(CP01,'CFP','FCFP','P',DECODE(PA09,'000',CP01,'FMP'),CP01) CP01,CP02,CP03,CP04,CP05,CP09,CP10,CP27,CP57,DECODE(SIGN((TO_CHAR(SYSDATE,'YYYYMMDD') - CP05)-30001),-1,1,0) NEW " & _
                           "FROM CASEPROGRESS,PATENT WHERE CP09 IN " & _
                           " (SELECT SUBSTR(MIN(CP05||CP09),9) FROM CASEPROGRESS,PATENT WHERE CP139 LIKE '" & Left(pkeyno, 8) & "%' AND PA01(+)=CP01 AND PA02(+)=CP02 AND PA03(+)=CP03 AND PA04(+)=CP04 AND PA01 IS NOT NULL AND CP09<'C' " & _
                           "    AND SUBSTR(CP139,1,8)<>SUBSTR(PA75,1,8) AND CP05>19221111 AND (CP158>19221111 OR (CP158=0 AND CP159=0)) GROUP BY CP01,CP02,CP03,CP04) AND PA01(+)=CP01 AND PA02(+)=CP02 AND PA03(+)=CP03 AND PA04(+)=CP04 "
         'Modified by Lydia 2025/08/15 +strConX
         strExSql = strExSql & "SELECT DECODE(CP01,'CFP','FCFP','P',DECODE(PA09,'000',CP01,'FMP'),CP01) CP01,CP02,CP03,CP04,CP05,CP09,CP10,CP27,CP57,DECODE(SIGN((TO_CHAR(SYSDATE,'YYYYMMDD') - CP05)-30001),-1,1,0) NEW " & _
                           "FROM CASEPROGRESS,PATENT WHERE CP09 IN " & _
                           " (SELECT SUBSTR(MIN(CP05||CP09),9) FROM CASEPROGRESS,PATENT WHERE CP139 LIKE '" & Left(pKeyNo, 8) & "%' AND PA01(+)=CP01 AND PA02(+)=CP02 AND PA03(+)=CP03 AND PA04(+)=CP04 AND PA01 IS NOT NULL AND CP09<'C' " & _
                           "    AND SUBSTR(CP139,1,8)<>SUBSTR(PA75,1,8) AND CP05>19221111 AND ((CP158>19221111 AND CP158<>NVL(PA58,0)) OR (CP158=0 AND CP159=0)) " & strConX & " GROUP BY CP01,CP02,CP03,CP04) AND PA01(+)=CP01 AND PA02(+)=CP02 AND PA03(+)=CP03 AND PA04(+)=CP04 "
         'Added by Lydia 2024/05/24 P/T案的區域統計語法
         'Modified by Lydia 2025/08/15 +strConX
         strAreaSql = strAreaSql & "SELECT DECODE(PA09,'000','P台灣','P非台灣') AS CP01T,CP01,CP02,CP03,CP04,CP05,CP09,CP10,CP27,CP57,DECODE(SIGN((TO_CHAR(SYSDATE,'YYYYMMDD') - CP05)-30001),-1,1,0) NEW " & _
                           "FROM CASEPROGRESS,PATENT WHERE CP09 IN " & _
                           " (SELECT SUBSTR(MIN(CP05||CP09),9) FROM CASEPROGRESS,PATENT WHERE CP139 LIKE '" & Left(pKeyNo, 8) & "%' AND PA01(+)=CP01 AND PA02(+)=CP02 AND PA03(+)=CP03 AND PA04(+)=CP04 AND PA01 IS NOT NULL AND CP09<'C' " & _
                           "    AND SUBSTR(CP139,1,8)<>SUBSTR(PA75,1,8) AND CP05>19221111 AND ((CP158>19221111 AND CP158<>NVL(PA58,0)) OR (CP158=0 AND CP159=0)) " & strConX & " GROUP BY CP01,CP02,CP03,CP04) AND PA01(+)=CP01 AND PA02(+)=CP02 AND PA03(+)=CP03 AND PA04(+)=CP04 "
         
         '商標FC代理人
         'Modified by Lydia 2018/11/27 改為以系統當日起往前推3年的案件數(ex.2018/11/27~2015/11/27)
         'strexsql = strexsql & "Union SELECT DECODE(CP01,'CFT','FCFT','T',DECODE(TM10,'000',CP01,'FMT'),CP01) CP01,CP02,CP03,CP04,CP05,CP09,CP10,CP27,CP57,DECODE(SUBSTR(CP05,1,4),TO_CHAR(SYSDATE,'YYYY'),1,TO_CHAR(ADD_MONTHS(SYSDATE,-12),'YYYY'),1,TO_CHAR(ADD_MONTHS(SYSDATE,-24),'YYYY'),1,0) NEW " & _
                           "FROM CASEPROGRESS,TRADEMARK WHERE CP09 IN " & _
                           " (SELECT SUBSTR(MIN(CP05||CP09),9) FROM CASEPROGRESS,TRADEMARK WHERE CP139 LIKE '" & Left(pkeyno, 8) & "%' AND TM01(+)=CP01 AND TM02(+)=CP02 AND TM03(+)=CP03 AND TM04(+)=CP04 AND TM01 IS NOT NULL AND CP09<'C' " & _
                           "     AND SUBSTR(CP139,1,8)<>SUBSTR(TM44,1,8) AND CP05>19221111 AND (CP158>19221111 OR (CP158=0 AND CP159=0)) GROUP BY CP01,CP02,CP03,CP04) AND TM01(+)=CP01 AND TM02(+)=CP02 AND TM03(+)=CP03 AND TM04(+)=CP04 "
         'Modified by Lydia 2019/01/02 P-120097,P-120098都是發文當天就閉卷，應該不能列入計算件數。
         'strexsql = strexsql & "Union SELECT DECODE(CP01,'CFT','FCFT','T',DECODE(TM10,'000',CP01,'FMT'),CP01) CP01,CP02,CP03,CP04,CP05,CP09,CP10,CP27,CP57,DECODE(SIGN((TO_CHAR(SYSDATE,'YYYYMMDD') - CP05)-30001),-1,1,0) NEW " & _
                           "FROM CASEPROGRESS,TRADEMARK WHERE CP09 IN " & _
                           " (SELECT SUBSTR(MIN(CP05||CP09),9) FROM CASEPROGRESS,TRADEMARK WHERE CP139 LIKE '" & Left(pkeyno, 8) & "%' AND TM01(+)=CP01 AND TM02(+)=CP02 AND TM03(+)=CP03 AND TM04(+)=CP04 AND TM01 IS NOT NULL AND CP09<'C' " & _
                           "     AND SUBSTR(CP139,1,8)<>SUBSTR(TM44,1,8) AND CP05>19221111 AND (CP158>19221111 OR (CP158=0 AND CP159=0)) GROUP BY CP01,CP02,CP03,CP04) AND TM01(+)=CP01 AND TM02(+)=CP02 AND TM03(+)=CP03 AND TM04(+)=CP04 "
         'Modified by Lydia 2025/08/15 +strConX
         strExSql = strExSql & "Union SELECT DECODE(CP01,'CFT','FCFT','T',DECODE(TM10,'000',CP01,'FMT'),CP01) CP01,CP02,CP03,CP04,CP05,CP09,CP10,CP27,CP57,DECODE(SIGN((TO_CHAR(SYSDATE,'YYYYMMDD') - CP05)-30001),-1,1,0) NEW " & _
                           "FROM CASEPROGRESS,TRADEMARK WHERE CP09 IN " & _
                           " (SELECT SUBSTR(MIN(CP05||CP09),9) FROM CASEPROGRESS,TRADEMARK WHERE CP139 LIKE '" & Left(pKeyNo, 8) & "%' AND TM01(+)=CP01 AND TM02(+)=CP02 AND TM03(+)=CP03 AND TM04(+)=CP04 AND TM01 IS NOT NULL AND CP09<'C' " & _
                           "     AND SUBSTR(CP139,1,8)<>SUBSTR(TM44,1,8) AND CP05>19221111 AND ((CP158>19221111 AND CP158<>NVL(TM30,0)) OR (CP158=0 AND CP159=0)) " & strConX & " GROUP BY CP01,CP02,CP03,CP04) AND TM01(+)=CP01 AND TM02(+)=CP02 AND TM03(+)=CP03 AND TM04(+)=CP04 "
         'Added by Lydia 2024/05/24 P/T案的區域統計語法
         'Modified by Lydia 2025/08/15 +strConX
         strAreaSql = strAreaSql & "Union SELECT DECODE(TM10,'000','T台灣','T非台灣') AS CP01T,CP01,CP02,CP03,CP04,CP05,CP09,CP10,CP27,CP57,DECODE(SIGN((TO_CHAR(SYSDATE,'YYYYMMDD') - CP05)-30001),-1,1,0) NEW " & _
                           "FROM CASEPROGRESS,TRADEMARK WHERE CP09 IN " & _
                           " (SELECT SUBSTR(MIN(CP05||CP09),9) FROM CASEPROGRESS,TRADEMARK WHERE CP139 LIKE '" & Left(pKeyNo, 8) & "%' AND TM01(+)=CP01 AND TM02(+)=CP02 AND TM03(+)=CP03 AND TM04(+)=CP04 AND TM01 IS NOT NULL AND CP09<'C' " & _
                           "     AND SUBSTR(CP139,1,8)<>SUBSTR(TM44,1,8) AND CP05>19221111 AND ((CP158>19221111 AND CP158<>NVL(TM30,0)) OR (CP158=0 AND CP159=0)) " & strConX & " GROUP BY CP01,CP02,CP03,CP04) AND TM01(+)=CP01 AND TM02(+)=CP02 AND TM03(+)=CP03 AND TM04(+)=CP04 "
                           
         '專利及商標CF代理人(子案不算)
         'Modified by Lydia 2018/11/27 改為以系統當日起往前推3年的案件數(ex.2018/11/27~2015/11/27)
         'strexsql = strexsql & "Union SELECT CP01,CP02,CP03,CP04,CP05,CP09,CP10,CP27,CP57,DECODE(SUBSTR(CP27,1,4),TO_CHAR(SYSDATE,'YYYY'),1,TO_CHAR(ADD_MONTHS(SYSDATE,-12),'YYYY'),1,TO_CHAR(ADD_MONTHS(SYSDATE,-24),'YYYY'),1,0) NEW " & _
                           "FROM CASEPROGRESS WHERE CP09 IN " & _
                           " (SELECT SUBSTR(MINCP09,9,9) FROM " & _
                           " (SELECT CP01,CP02,CP03,CP04,MIN(CP27||CP09||CP44) MINCP09,MAX(CP27||CP09||CP44) MAXCP09 FROM CASEPROGRESS WHERE (CP01,CP02,CP03,CP04) IN " & _
                           " 　(SELECT DISTINCT CP01,CP02,CP03,CP04 FROM CASEPROGRESS,PATENT,TRADEMARK WHERE CP158>19221111 AND CP44 LIKE '" & Left(pkeyno, 8) & "%' AND CP04='00' AND CP09<'C' " & _
                           "      AND CP01=PA01(+) AND CP02=PA02(+) AND CP03=PA03(+) AND CP04=PA04(+) AND CP01=TM01(+) AND CP02=TM02(+) AND CP03=TM03(+) AND CP04=TM04(+) AND CP44||' '<>PA75||TM44||' ') " & _
                           "  AND CP158>19221111 AND CP09<'C' " & _
                           "  AND CP01||CP10 NOT IN ('P902','P907','P913','P925','P937','CFP902','CFP907','CFP913','CFP925','CFP937','T703','T704','T718','T720','T726','TF703','TF704','TF718','TF720','TF726','CFT703','CFT704','CFT718','CFT720','CFT726') " & _
                           "  GROUP BY CP01,CP02,CP03,CP04) WHERE SUBSTR(MINCP09,18)<>SUBSTR(MAXCP09,18) " & _
                           ") AND CP44 LIKE '" & Left(pkeyno, 8) & "%')"
         'Modified by Lydia 2019/01/02 P-120097,P-120098都是發文當天就閉卷，應該不能列入計算件數。
         'strexsql = strexsql & "Union SELECT CP01,CP02,CP03,CP04,CP05,CP09,CP10,CP27,CP57,DECODE(SIGN((TO_CHAR(SYSDATE,'YYYYMMDD') - CP27)-30001),-1,1,0) NEW " & _
                           "FROM CASEPROGRESS WHERE CP09 IN " & _
                           " (SELECT SUBSTR(MINCP09,9,9) FROM " & _
                           " (SELECT CP01,CP02,CP03,CP04,MIN(CP27||CP09||CP44) MINCP09,MAX(CP27||CP09||CP44) MAXCP09 FROM CASEPROGRESS WHERE (CP01,CP02,CP03,CP04) IN " & _
                           " 　(SELECT DISTINCT CP01,CP02,CP03,CP04 FROM CASEPROGRESS,PATENT,TRADEMARK WHERE CP158>19221111 AND CP44 LIKE '" & Left(pkeyno, 8) & "%' AND CP04='00' AND CP09<'C' " & _
                           "      AND CP01=PA01(+) AND CP02=PA02(+) AND CP03=PA03(+) AND CP04=PA04(+) AND CP01=TM01(+) AND CP02=TM02(+) AND CP03=TM03(+) AND CP04=TM04(+) AND CP44||' '<>PA75||TM44||' ') " & _
                           "  AND CP158>19221111 AND CP09<'C' " & _
                           "  AND CP01||CP10 NOT IN ('P902','P907','P913','P925','P937','CFP902','CFP907','CFP913','CFP925','CFP937','T703','T704','T718','T720','T726','TF703','TF704','TF718','TF720','TF726','CFT703','CFT704','CFT718','CFT720','CFT726') " & _
                           "  GROUP BY CP01,CP02,CP03,CP04) WHERE SUBSTR(MINCP09,18)<>SUBSTR(MAXCP09,18) " & _
                           ") AND CP44 LIKE '" & Left(pkeyno, 8) & "%')"
         'Modified by Lydia 2019/05/06 現在案件不屬於Y編號
         'strexsql = strexsql & "Union SELECT CP01,CP02,CP03,CP04,CP05,CP09,CP10,CP27,CP57,DECODE(SIGN((TO_CHAR(SYSDATE,'YYYYMMDD') - CP27)-30001),-1,1,0) NEW " & _
                           "FROM CASEPROGRESS WHERE CP09 IN " & _
                           " (SELECT SUBSTR(MINCP09,9,9) FROM " & _
                           " (SELECT CP01,CP02,CP03,CP04,MIN(CP27||CP09||CP44) MINCP09,MAX(CP27||CP09||CP44) MAXCP09 FROM CASEPROGRESS WHERE (CP01,CP02,CP03,CP04) IN " & _
                           " 　(SELECT DISTINCT CP01,CP02,CP03,CP04 FROM CASEPROGRESS,PATENT,TRADEMARK WHERE CP158>19221111 AND CP158<>NVL(NVL(TM30,PA58),0) AND CP44 LIKE '" & Left(pkeyno, 8) & "%' AND CP04='00' AND CP09<'C' " & _
                           "      AND CP01=PA01(+) AND CP02=PA02(+) AND CP03=PA03(+) AND CP04=PA04(+) AND CP01=TM01(+) AND CP02=TM02(+) AND CP03=TM03(+) AND CP04=TM04(+) AND CP44||' '<>PA75||TM44||' ') " & _
                           "  AND CP158>19221111 AND CP09<'C' " & _
                           "  AND CP01||CP10 NOT IN ('P902','P907','P913','P925','P937','CFP902','CFP907','CFP913','CFP925','CFP937','T703','T704','T718','T720','T726','TF703','TF704','TF718','TF720','TF726','CFT703','CFT704','CFT718','CFT720','CFT726') " & _
                           "  GROUP BY CP01,CP02,CP03,CP04) WHERE SUBSTR(MINCP09,18)<>SUBSTR(MAXCP09,18) " & _
                           ") AND CP44 LIKE '" & Left(pkeyno, 8) & "%')"
         'Modified by Lydia 2025/08/15 限專利,商標案
         'strExSql = strExSql & "Union SELECT CP01,CP02,CP03,CP04,CP05,CP09,CP10,CP27,CP57,DECODE(SIGN((TO_CHAR(SYSDATE,'YYYYMMDD') - CP27)-30001),-1,1,0) NEW " & _
                           "FROM CASEPROGRESS WHERE CP09 IN (SELECT SUBSTR(MINCP09,9,9) FROM " & _
                           "(SELECT CP01,CP02,CP03,CP04,MIN(CP27||CP09||CP44) MINCP09 FROM CASEPROGRESS WHERE (CP01,CP02,CP03,CP04) IN " & _
                           "(SELECT C01,C02,C03,C04 FROM R100114_6 WHERE ID='" & pUserNo & "' AND FORMID='" & pFrmName & "' AND INSTR(MAXCP09,'" & Left(pKeyNo, 8) & "') = 0 AND PNO='" & Left(pKeyNo, 8) & "' ) " & _
                           "AND CP44 LIKE '" & Left(pKeyNo, 8) & "%' " & pSqlCon & _
                           " GROUP BY CP01,CP02,CP03,CP04)) "
         strExSql = strExSql & "Union SELECT CP01,CP02,CP03,CP04,CP05,CP09,CP10,CP27,CP57,DECODE(SIGN((TO_CHAR(SYSDATE,'YYYYMMDD') - CP27)-30001),-1,1,0) NEW " & _
                           "FROM CASEPROGRESS,PATENT,TRADEMARK WHERE CP09 IN (SELECT SUBSTR(MINCP09,9,9) FROM " & _
                           "(SELECT CP01,CP02,CP03,CP04,MIN(CP27||CP09||CP44) MINCP09 FROM CASEPROGRESS WHERE (CP01,CP02,CP03,CP04) IN " & _
                           "(SELECT C01,C02,C03,C04 FROM R100114_6 WHERE ID='" & pUserNo & "' AND FORMID='" & pFrmName & "' AND INSTR(MAXCP09,'" & Left(pKeyNo, 8) & "') = 0 AND PNO='" & Left(pKeyNo, 8) & "' ) " & _
                           "AND CP44 LIKE '" & Left(pKeyNo, 8) & "%' " & pSqlCon & _
                           " GROUP BY CP01,CP02,CP03,CP04)) AND CP01=PA01(+) AND CP02=PA02(+) AND CP03=PA03(+) AND CP04=PA04(+) AND CP01=TM01(+) AND CP02=TM02(+) AND CP03=TM03(+) AND CP04=TM04(+) AND PA01||TM01 IS NOT NULL "
         'Added by Lydia 2024/05/24 P/T案的區域統計語法
         'Modified by Lydia 2025/08/15 +AND PA01||TM01 IS NOT NULL
         strAreaSql = strAreaSql & "Union SELECT DECODE(PA01,NULL,DECODE(TM01,NULL,CP01,DECODE(TM10,'000','T台灣','T非台灣')),DECODE(PA09,'000','P台灣','P非台灣')) AS CP01T,CP01,CP02,CP03,CP04,CP05,CP09,CP10,CP27,CP57,DECODE(SIGN((TO_CHAR(SYSDATE,'YYYYMMDD') - CP27)-30001),-1,1,0) NEW " & _
                           "FROM CASEPROGRESS,PATENT,TRADEMARK WHERE CP09 IN (SELECT SUBSTR(MINCP09,9,9) FROM " & _
                           "(SELECT CP01,CP02,CP03,CP04,MIN(CP27||CP09||CP44) MINCP09 FROM CASEPROGRESS WHERE (CP01,CP02,CP03,CP04) IN " & _
                           "(SELECT C01,C02,C03,C04 FROM R100114_6 WHERE ID='" & pUserNo & "' AND FORMID='" & pFrmName & "' AND INSTR(MAXCP09,'" & Left(pKeyNo, 8) & "') = 0 AND PNO='" & Left(pKeyNo, 8) & "' ) " & _
                           "AND CP44 LIKE '" & Left(pKeyNo, 8) & "%' " & pSqlCon & _
                           " GROUP BY CP01,CP02,CP03,CP04)) AND CP01=PA01(+) AND CP02=PA02(+) AND CP03=PA03(+) AND CP04=PA04(+) AND CP01=TM01(+) AND CP02=TM02(+) AND CP03=TM03(+) AND CP04=TM04(+) AND PA01||TM01 IS NOT NULL "
      '申請人
      Else
         'Added by Lydia 2023/06/07 抓曾經是的案件
         strExSql = "SELECT CP01||'*',COUNT(*)||'('||SUM(NEW)||')' FROM ("
         '專利
         'Modified by Lydia 2025/08/15 +strConX
         strExSql = strExSql & "SELECT DECODE(CP01,'CFP','FCFP','P',DECODE(PA09,'000',CP01,'FMP'),CP01) CP01,CP02,CP03,CP04,CP05,CP09,CP10,CP27,CP57,DECODE(SIGN((TO_CHAR(SYSDATE,'YYYYMMDD') - CP05)-30001),-1,1,0) NEW " & _
                           "FROM CASEPROGRESS,PATENT WHERE CP09 IN " & _
                           " (SELECT SUBSTR(MIN(CP05||CP09),9) FROM CASEPROGRESS,PATENT WHERE INSTR(CP55||CP93||CP94||CP95||CP96,'" & Left(pKeyNo, 8) & "') > 0 AND PA01(+)=CP01 AND PA02(+)=CP02 AND PA03(+)=CP03 AND PA04(+)=CP04 AND PA01 IS NOT NULL AND CP09<'C' " & _
                           " AND INSTR(PA26||PA27||PA28||PA29||PA30,'" & Left(pKeyNo, 8) & "') = 0 AND SUBSTR(CP139,1,8)<>SUBSTR(PA75,1,8) AND CP05>19221111 AND ((CP158>19221111 AND CP158<>NVL(PA58,0)) OR (CP158=0 AND CP159=0)) " & strConX & " GROUP BY CP01,CP02,CP03,CP04) AND PA01(+)=CP01 AND PA02(+)=CP02 AND PA03(+)=CP03 AND PA04(+)=CP04 "
         '商標
         'Modified by Lydia 2025/08/15 +strConX
         strExSql = strExSql & "Union SELECT DECODE(CP01,'CFT','FCFT','T',DECODE(TM10,'000',CP01,'FMT'),CP01) CP01,CP02,CP03,CP04,CP05,CP09,CP10,CP27,CP57,DECODE(SIGN((TO_CHAR(SYSDATE,'YYYYMMDD') - CP05)-30001),-1,1,0) NEW " & _
                           "FROM CASEPROGRESS,TRADEMARK WHERE CP09 IN " & _
                           " (SELECT SUBSTR(MIN(CP05||CP09),9) FROM CASEPROGRESS,TRADEMARK WHERE INSTR(CP55||CP93||CP94||CP95||CP96,'" & Left(pKeyNo, 8) & "') > 0 AND TM01(+)=CP01 AND TM02(+)=CP02 AND TM03(+)=CP03 AND TM04(+)=CP04 AND TM01 IS NOT NULL AND CP09<'C' " & _
                           " AND INSTR(TM23||TM78||TM79||TM80||TM81,'" & Left(pKeyNo, 8) & "') = 0 AND SUBSTR(CP139,1,8)<>SUBSTR(TM44,1,8) AND CP05>19221111 AND ((CP158>19221111 AND CP158<>NVL(TM30,0)) OR (CP158=0 AND CP159=0)) " & strConX & " GROUP BY CP01,CP02,CP03,CP04) AND TM01(+)=CP01 AND TM02(+)=CP02 AND TM03(+)=CP03 AND TM04(+)=CP04 "
         'end 2023/06/07
         'Added by Lydia 2024/05/24 P/T案的區域統計語法
         strAreaSql = "SELECT CP01T||'*' AS CP01,COUNT(*)||'('||SUM(NEW)||')' FROM ("
         '專利
         'Modified by Lydia 2025/08/15 +strConX
         strAreaSql = strAreaSql & "SELECT DECODE(PA09,'000','P台灣','P非台灣') AS CP01T,CP01,CP02,CP03,CP04,CP05,CP09,CP10,CP27,CP57,DECODE(SIGN((TO_CHAR(SYSDATE,'YYYYMMDD') - CP05)-30001),-1,1,0) NEW " & _
                           "FROM CASEPROGRESS,PATENT WHERE CP09 IN " & _
                           " (SELECT SUBSTR(MIN(CP05||CP09),9) FROM CASEPROGRESS,PATENT WHERE INSTR(CP55||CP93||CP94||CP95||CP96,'" & Left(pKeyNo, 8) & "') > 0 AND PA01(+)=CP01 AND PA02(+)=CP02 AND PA03(+)=CP03 AND PA04(+)=CP04 AND PA01 IS NOT NULL AND CP09<'C' " & _
                           " AND INSTR(PA26||PA27||PA28||PA29||PA30,'" & Left(pKeyNo, 8) & "') = 0 AND SUBSTR(CP139,1,8)<>SUBSTR(PA75,1,8) AND CP05>19221111 AND ((CP158>19221111 AND CP158<>NVL(PA58,0)) OR (CP158=0 AND CP159=0)) " & strConX & " GROUP BY CP01,CP02,CP03,CP04) AND PA01(+)=CP01 AND PA02(+)=CP02 AND PA03(+)=CP03 AND PA04(+)=CP04 "
         '商標
         'Modified by Lydia 2025/08/15 +strConX
         strAreaSql = strAreaSql & "Union SELECT DECODE(TM10,'000','T台灣','T非台灣') AS CP01T,CP01,CP02,CP03,CP04,CP05,CP09,CP10,CP27,CP57,DECODE(SIGN((TO_CHAR(SYSDATE,'YYYYMMDD') - CP05)-30001),-1,1,0) NEW " & _
                           "FROM CASEPROGRESS,TRADEMARK WHERE CP09 IN " & _
                           " (SELECT SUBSTR(MIN(CP05||CP09),9) FROM CASEPROGRESS,TRADEMARK WHERE INSTR(CP55||CP93||CP94||CP95||CP96,'" & Left(pKeyNo, 8) & "') > 0 AND TM01(+)=CP01 AND TM02(+)=CP02 AND TM03(+)=CP03 AND TM04(+)=CP04 AND TM01 IS NOT NULL AND CP09<'C' " & _
                           " AND INSTR(TM23||TM78||TM79||TM80||TM81,'" & Left(pKeyNo, 8) & "') = 0 AND SUBSTR(CP139,1,8)<>SUBSTR(TM44,1,8) AND CP05>19221111 AND ((CP158>19221111 AND CP158<>NVL(TM30,0)) OR (CP158=0 AND CP159=0)) " & strConX & " GROUP BY CP01,CP02,CP03,CP04) AND TM01(+)=CP01 AND TM02(+)=CP02 AND TM03(+)=CP03 AND TM04(+)=CP04 "
         'end 2024/05/24
      End If
      'Modified by Lydia 2019/05/06
      'strexsql = strexsql & "GROUP BY CP01 ORDER BY 1 "
      strExSql = strExSql & " ) GROUP BY CP01 ORDER BY 1 "
      pSQLpass = strExSql
   
      'Added by Lydia 2024/05/24
      strAreaSql = strAreaSql & " ) GROUP BY CP01T ORDER BY 1 "
      pSQLAreaPass = strAreaSql
      'end 2024/05/24
   End If 'Added by Lydia 2025/09/19 選擇統計方式：2-案件數，才需要分析過去案件

End Sub

'Added by Morgan 2024/6/7
'虛編號對應的正式員工號
Public Function PUB_GetRealUserNo(pNo) As String
   Dim stSQL As String, intR As Integer
   Dim rsQuery As ADODB.Recordset
   
   PUB_GetRealUserNo = pNo
   'Modified by Morgan 2024/6/7 改抓內部郵件收件編號(第1人)--秀玲
   'stSQL = "select st01 from staff where st26 in (select st26 from staff where st01='" & pNo & "') and st01<'F' and st01>'6' and substr(st01,4,1)<>'9' and st04='1'"
   stSQL = "select substr(st14,1,5) from staff where st01='" & pNo & "'"
   'end 2024/6/7
   intR = 1
   Set rsQuery = ClsLawReadRstMsg(intR, stSQL)
   If intR = 1 Then
      PUB_GetRealUserNo = rsQuery(0)
   End If
   Set rsQuery = Nothing
End Function

'Add by Amy 2024/08/14 法人和其他組織統一社會信用代碼編碼規則(國家標准GB32100—2015)
Public Function CheckGB32100(ByVal stID As String) As Boolean
   Dim ii As Integer, jj As Integer, intVal As Integer, stVal As String, stSum As String, stFindWord As String
   Dim stCorrespondingVal '對應值(10-30)
  
   CheckGB32100 = False
   If Len(stID) <> 18 Then Exit Function
    
   '數值1-9對應值為1-9
   '英文對應值（不使用I、O、Z、S、V）
   '                                                     10   11   12   13   14   15   16   17   18  19   20   21    22   23   24   25   26   27    28    29   30
   stCorrespondingVal = Array("A", "B", "C", "D", "E", "F", "G", "H", "J", "K", "L", "M", "N", "P", "Q", "R", "T", "U", "W", "X", "Y")
           
   For ii = 0 To 16
      '第18位校驗碼= 31 - Mod (Sum(第n個序位對應值 * 加權),31)
      '加權= Mod (3^(第n個序位-1),31) ,n從1開始
      stVal = Mid(stID, ii + 1, 1)
      intVal = 99
      '1-9數字對應值為數字本身
      If IsNumeric(stVal) Then
         intVal = Val(stVal)
      '[非]數字找出對應值
      Else
         For jj = 10 To 30
            If stVal = stCorrespondingVal(jj - 10) Then
               intVal = jj
               Exit For
            End If
         Next jj
         '找不到對應值
         If intVal = 99 Then Exit For
      End If
      stSum = Val(stSum) + intVal * ((3 ^ ii) Mod 31)
   Next ii
   If intVal = 99 Then Exit Function
   
   stSum = 31 - (Val(stSum) Mod 31)
    
   If Val(stSum) >= 10 Then
      '找出對應文字
      For ii = 10 To 30
         If ii = Val(stSum) Then
            stFindWord = stCorrespondingVal(ii - 10)
         End If
      Next ii
   Else
      stFindWord = stSum
   End If
   
   '確認最後一碼檢查碼是否正確 ex:91350100M000100Y43
   If Mid(stID, 18, 1) = stFindWord Then
      CheckGB32100 = True
   End If
End Function

'Add by Amy 2024/10/23 判斷[轉PDF程式主機] 是否已產生資料檔
'intChoose:0-抓當日有檔案/1-抓 C:\EInvoice\ 是否有資料
Public Function ChkXml(intChoose As Integer, ByVal stPath As String, Optional ByVal stFileN As String = "") As Boolean
   Dim stDate As String, stYear As String, stMon As String
   
   ChkXml = False
   
   If stFileN = MsgText(601) Then
      stFileN = "*.*"
   ElseIf InStr(stFileN, "*") = 0 Then
      stFileN = stFileN & "*.*"
   End If
   
   If intChoose = 0 Then
      stYear = Mid(strSrvDate(1), 1, 4)
      stMon = Mid(strSrvDate(1), 5, 2)
      stDate = Mid(strSrvDate(1), 7, 2)
   End If
   '抓當日Success or Error 資料夾是否有資料
   If intChoose = 0 Then
      If Dir(stPath & stYear, vbDirectory) <> MsgText(601) Then
         If Dir(stPath & stYear & "\" & stMon, vbDirectory) <> MsgText(601) Then
            If Dir(stPath & stYear & "\" & stMon & "\" & stDate, vbDirectory) <> MsgText(601) Then
               If Dir(stPath & stYear & "\" & stMon & "\" & stDate & "\" & stFileN) <> MsgText(601) Then
                  ChkXml = True
               End If
            End If
         End If
      End If
   '抓C:\EInvoice\ 是否有資料
   ElseIf intChoose = 1 Then
      If Dir(stPath & IIf(Right(stPath, 1) = "\", "", "\") & stFileN) <> MsgText(601) Then
         ChkXml = True
      End If
   End If
End Function

'Add by Amy 2024/11/29 來所原因及介紹者相關資料檢查(從代理人維護搬過來修改,避免有未改到的)
'intChoose:0-全部檢查/1-只檢查XYS02(介紹者編號)/2-只檢查「來所原因」由 11其他,改為04 or 05
'stXYS02:傳入8碼X or Y or R 編號 /stDevDate:開發日 / stCreDate:建檔日
Public Function ChkXYSourceReason(intChoose As Integer, ByVal stFormN As String, stEditMode As Integer, stSource As String, stXYS02 As String, _
  Optional ByVal stSource_Old As String, Optional ByVal stDevDate As String, Optional ByVal stCreDate As String, Optional ByVal stXYS03 As String, _
  Optional ByVal stChkNo As String, Optional ByRef stXYSName As String) As String
   Dim stChkDate As String, stMsg As String, stNo As String, stName As String
   
   ChkXYSourceReason = ""
   stXYSName = ""
   
   stChkDate = 代理人來源啟用日
   Select Case UCase(stFormN)
      Case "FRM050705" '國外代理人資料維護
      Case "FRM140402" '潛在客戶資料維護
      Case "FRM140402_2" '潛在客戶轉客戶或代理人作業
   End Select
   
'*** 全部檢查 ***
   If intChoose = 0 Then
      '潛在客戶資料維護(FRM140402) 來所原因 不用必填-Widen
      If UCase(stFormN) <> "FRM140402" Then
         '新增
         If stEditMode = 1 Then
            If stSource = MsgText(601) Then
               ChkXYSourceReason = "來所原因 不可為空！"
               Exit Function
            End If
         '修改
         ElseIf stEditMode = 2 Then
            '開發日及建檔日大於代理人來源啟用日(舊資料不補),來所原因 必輸
           If stSource = MsgText(601) And Val(stDevDate) >= Val(stChkDate) And Val(stCreDate) >= Val(stChkDate) Then
               ChkXYSourceReason = "來所原因 不可為空！"
               Exit Function
           End If
         End If
      End If
      '「來所原因」為 04其他申請人介紹 或 05其他事務所介紹,[介紹者編號] 或 [其他說明]欄,擇一必填 (Amy 2023/07/12改,原[介紹者編號] 必填)
      If Left(stSource, 2) = "04" Or Left(stSource, 2) = "05" Then
         If stXYS02 = MsgText(601) And stXYS03 = MsgText(601) Then
            ChkXYSourceReason = "來所原因 為「" & stSource & "」" & vbCrLf & _
                                 "介紹者編號 或 其他說明 不可為空！"
            Exit Function
         End If
      '「來所原因」為 11其他,其他說明 必填
      ElseIf Left(stSource, 2) = "11" And stXYS03 = MsgText(601) Then
         ChkXYSourceReason = "來所原因 為「" & stSource & "」" & vbCrLf & _
                                 "其他說明 不可為空！"
         Exit Function
      End If
   End If
'*** End 全部檢查 ***
'*** 只檢查XYS02 ***
   If (intChoose = 0 Or intChoose = 1) And stXYS02 <> MsgText(601) Then
      '避免用貼的超過8碼
      If Len(stXYS02) > 8 Then
         ChkXYSourceReason = "介紹者編號 長度只允許8碼"
         Exit Function
      End If
      '來所原因:04 其他申請人介紹
      If Left(stSource, 2) = "04" And Left(stXYS02, 1) <> 客戶編號 And Left(stXYS02, 1) <> "R" Then
         ChkXYSourceReason = "來所原因 為「" & stSource & "」" & vbCrLf & _
                              "只可為" & 客戶編號 & " 或 R 編號！"
         Exit Function
      '來所原因:05 其他代理人介紹
      ElseIf Left(stSource, 2) = "05" And Left(stXYS02, 1) <> 代理人編號 And Left(stXYS02, 1) <> "R" Then
         ChkXYSourceReason = "來所原因 為「" & stSource & "」" & vbCrLf & _
                              "只可為" & 代理人編號 & " 或 R 編號！"
         Exit Function
      End If
      stNo = stXYS02 '因為會回傳9碼資料,故使用
      If Left(stXYS02, 1) = 代理人編號 Then
         stMsg = "代理人編號"
         Call ClsPDGetAgent(stNo, stName, , True)
      ElseIf Left(stXYS02, 1) = 客戶編號 Then
         stMsg = "客戶編號"
         stName = GetCustomerName(stNo, 1)
      '可輸R編號 (2023/07/12 加)
      ElseIf Left(stNo, 1) = "R" Then
         stMsg = "潛在客戶編號"
         stName = GetPotCustomerName(1, stNo)
      End If
      '介紹者編號應該不會是自己 (2024/11/29 測潛在客戶時,介紹者編號輸錯成自己的編號)
      If stChkNo <> MsgText(601) Then
         If stXYS02 = Left(stChkNo, 8) Then
            ChkXYSourceReason = "[介紹者編號]與此[" & stMsg & "]相同" & vbCrLf & "請確認！"
            Exit Function
         End If
      End If
      stXYSName = stName
      If stName = MsgText(601) Then
         ChkXYSourceReason = "[介紹者編號]不存在,請確認！"
         Exit Function
      End If
   End If
'*** End 只檢查XYS02 ***
'*** 只檢查「來所原因」由 11其他,改為04 or 05 ***
'Memo 檢查全部時,若需檢查此,請另寫一句區分(參看frm140402)
   If intChoose = 2 Then
      '「來所原因」由 11其他,改為04 or 05(可能其他說明不為空-上述條件)且介紹者編號為空彈訊息提醒(介紹者編號可空,但其他說明不可空)-秀玲 (Amy 2023/07/20加)
      If stSource_Old = "11" And (Left(stSource, 2) = "04" Or Left(stSource, 2) = "05") And stXYS02 = MsgText(601) Then
         ChkXYSourceReason = "來所原因 由「11.其他」改為「" & stSource & "」" & vbCrLf & _
                           "介紹者編號為空,確定不輸？" & vbCrLf & _
                           "確定[不輸]介紹者編號,請按「是」,繼續" & vbCrLf & _
                           "　　[要輸]介紹者編號,請按「否」,回前畫面"
         Exit Function
      End If
   End If
'*** End 只檢查「來所原因」由 11其他,改為04 or 05 ***
End Function

'設定 來所原因 下拉選單
'intChoose:0-全部 /1-回傳編號+名稱
'                    6-[新增]時/7-[修改]時,開放 來所原因 欄 /8-[查詢]時,設定 來所原因 相關欄位/9-依來所原因,設定開放欄位
'stData:傳入條件,回傳 資料
Public Sub Pub_SetCboComeSource(intChoose As Integer, stFormN As String, Optional ByRef objCboS As Object, Optional ByRef stBackData As String = "" _
  , Optional ByRef objXYS02 As Object, Optional ByRef objXYS03 As Object)
   Dim RsQ As New ADODB.Recordset, intQ As Integer, stQ As String, stWhere As String
   
   Select Case UCase(stFormN)
      Case "FRM050705" '國外代理人資料維護
      Case "FRM140402" '潛在客戶資料維護
         stWhere = stWhere & "And AC02<>'10' "
      Case "FRM140402_2" '潛在客戶轉客戶或代理人作業
   End Select
   
   If intChoose >= 6 Then
'*** 來所原因 相關欄是否 Locked ***
      Select Case intChoose
         '[新增]時
         Case 6
            objCboS.Locked = False
            objXYS02.Locked = True
            objXYS03.Locked = True
         '[修改]時 Or 依來所原因,設定開放欄位
         Case 7, 9
            'Memo 修改時由11.其他,改成其餘選項(原輸的[其他說明]欄資料不清),再改回11.其他欄位要避免被鎖住
            '              只有 來所原因 為04/05/11才開放輸[其他說明]欄
            If intChoose = 7 Then
               objCboS.Locked = False
            End If
            objXYS02.Locked = True
            objXYS03.Locked = True
            '來所原因為04.其他申請人介紹 或05.其他事務所介紹,開放[介紹者編號]及[其他說明]欄,且擇一必輸
            If Left(objCboS.Text, 2) = "04" Or Left(objCboS.Text, 2) = "05" Then
               objXYS02.Locked = False
               objXYS03.Locked = False
            '來所原因為11.其他,開放 其他說明 欄
            ElseIf Left(objCboS.Text, 2) = "11" Then
               objXYS03.Locked = False
            End If
         '[查詢]時,設定來所原因相關欄位
         Case 8
            objCboS.Locked = True
            objXYS02.Locked = True
            objXYS03.Locked = True
      End Select
'*** End 來所原因 相關欄是否 Locked ***
   Else
      If stBackData <> MsgText(601) Then
         stWhere = stWhere & stBackData & " "
         stBackData = ""
      End If
      'AC02=10:Y編號轉R編號
      stQ = "Select AC02||' '||AC03 From AllCode Where AC01='13' " & stWhere & _
                  "Order by AC02 "
      intQ = 1
      Set RsQ = ClsLawReadRstMsg(intQ, stQ)
      If intQ = 1 Then
         RsQ.MoveFirst
         If intChoose = 1 Then
            stBackData = "" & RsQ.Fields(0)
         Else
            objCboS.Clear
            objCboS.AddItem ""
            Do While Not RsQ.EOF
               objCboS.AddItem RsQ.Fields(0)
               RsQ.MoveNext
            Loop
         End If
      End If
      Set RsQ = Nothing
   End If
End Sub
'end 2024/11/29

'Added by Lydia 2025/01/16 外專用來判斷是否已有請款函寄出，檢查卷宗區檔案是否有符合的副檔名的記錄SQL
Public Function PUB_GetFCPforDNsql(Optional ByVal pType As String = "0", Optional ByRef pSQL2) As String
Dim tmpArr1 As Variant
Dim intR As Integer, strTmp1 As String, strTmp2 As String
   
   strTmp1 = Pub_GetSpecMan("外專請款函預設副檔名")
   pSQL2 = ""
   PUB_GetFCPforDNsql = ""
   If strTmp1 <> "" Then
      tmpArr1 = Split(strTmp1, ";")
      
      For intR = LBound(tmpArr1) To UBound(tmpArr1)
         If Trim(tmpArr1(intR)) <> "" Then
            If pType = "1" Then '每日批次frmAutoBatchDay
               PUB_GetFCPforDNsql = PUB_GetFCPforDNsql & ",SUM(DECODE(SIGN(INSTR(UPPER(CPP02),'." & UCase(Trim(tmpArr1(intR))) & ".')),0,0,1)) R" & intR + 1
               pSQL2 = pSQL2 & IIf(pSQL2 <> "", "+", "") & "R" & intR + 1
            Else
               PUB_GetFCPforDNsql = PUB_GetFCPforDNsql & IIf(PUB_GetFCPforDNsql <> "", " OR", "") & " UPPER(CPP02) LIKE '%." & UCase(Trim(tmpArr1(intR))) & ".%'"
            End If
         End If
      Next intR
      If PUB_GetFCPforDNsql <> "" Then
         If pType = "1" Then
            pSQL2 = " AND " & pSQL2 & "=0"
         Else
            PUB_GetFCPforDNsql = " AND (" & PUB_GetFCPforDNsql & ")"
         End If
      End If
   End If
End Function

'Add by Amy 2025/03/20 傳入內容有#()#特殊符號前後框住,則依權限顯示 or 不顯示
'intType:回傳0-無特殊符號 /1-有特殊符號,有權限 /2-有特殊符號,無權限
Public Function ChkLimitAndReplace(ByVal stFormN As String, ByVal stTxt As String, ByVal stCR19 As String, _
  Optional ByRef intType As Integer, Optional ByVal stCR12 As String) As String
   Dim RsQ As ADODB.Recordset, intQ As Integer, stQ As String, stAreaMan As String
   Dim stRepTxt As String, bolShowOrg As Boolean, stTP(1) As String
   
   Select Case stFormN
      Case "frm100101_16" '往來記錄資料查詢
      Case "frm140404" '往來記錄維護
         '維護有修改權限必需看到原始字串(含符號)
         bolShowOrg = True
   End Select
   
   ChkLimitAndReplace = stTxt
   intType = 0
   '無特殊符號 顯示
   If InStr(stTxt, "#(") = 0 And InStr(stTxt, ")#") = 0 Then
      Exit Function
   Else
      '有特殊符號,先設[無權限]
      intType = 2
   End If
   
'*** 權限判斷 ***
   '總經理 顯示
   If InStr(Pub_GetSpecMan("總經理員工編號", False) & ",", strUserNum) > 0 Then
      intType = 1
   End If
   '所長 顯示
   If InStr(Pub_GetSpecMan("所長員工編號", False) & ",", strUserNum) > 0 Then
      intType = 1
   End If
   '建立者-維護用
   If stCR12 <> MsgText(601) Then
      If InStr(stCR12 & ",", strUserNum) > 0 Then
         intType = 1
      End If
   End If
   
   '接洽同仁(stCR19)及接洽同仁的部門最高主管 顯示
   '部門最高主管:以接洽同仁之ST93抓ACC090NEW之A0925(人事部門)，再以A0925讀ACC090NEW之A0921抓出其A0924
   'Select ST01,ST02,ST93,S.A0925 as 人事部門,SM.a0921 as 大部門,SM.A0924 '測式用
   stQ = "Select Distinct SM.A0924 From Staff,Acc090New S,Acc090New SM " & _
               "Where st01 in('" & Replace(stCR19, ",", "','") & "') " & _
               "And ST93=S.A0921(+) And S.A0925=SM.A0921(+) " & _
               "Order by A0924 "
   intQ = 1
   Set RsQ = ClsLawReadRstMsg(intQ, stQ)
   If intQ = 1 Then
      RsQ.MoveFirst
      Do While Not RsQ.EOF
         If InStr(stCR19, "" & RsQ.Fields("A0924")) = 0 Then
            stAreaMan = stAreaMan & "," & RsQ.Fields("A0924")
         End If
      RsQ.MoveNext
      Loop
   End If
   If InStr(stCR19 & stAreaMan & ",", strUserNum) > 0 Then
      intType = 1
   End If
   Set RsQ = Nothing
'*** End 權限判斷 ***

   '維護有修改權限必需看到原始字串(含符號)
   If intType = 1 And bolShowOrg = True Then Exit Function
   
   stRepTxt = ""
   If intType = 2 Then stRepTxt = "***" '不顯示
   stTP(0) = stTxt
   Do
      stTP(1) = Mid(stTP(0), InStr(stTP(0), "#("))
      stTP(1) = Mid(stTP(1), 1, Val(InStr(stTP(1), ")#")) + 1)
      '不顯示,取代成 ***
      If stRepTxt <> MsgText(601) Then
         stTP(0) = Replace(stTP(0), stTP(1), stRepTxt)
      Else
         stTP(0) = Replace(stTP(0), stTP(1), Replace(Replace(stTP(1), "#(", ""), ")#", ""))
      End If
      
      If InStr(stTP(0), "#(") = 0 And InStr(stTP(0), ")#") = 0 Then
         Exit Do
      End If
   Loop
   ChkLimitAndReplace = stTP(0)
End Function

'Modify By Sindy 2025/4/11 從frm010007(GetTotalFeeLOS01)搬過來,改成共用函數
'Added by Lydia 2020/06/01 法律所案源收文：抓P/T案收文的費用和規費(總計)
Public Sub PUB_GetCaseFee_000(ByVal pKeyNo As String, _
         ByRef pFee1 As String, ByRef pFee2 As String, ByRef pOfficalFee As String, _
         Optional ByVal strCP01 As String = "", Optional ByVal strCP10 As String = "")
'pKeyNo : 總收文號
'pFee1, pFee2 : 費用起迄
'pOfficalFee: 規費
Dim strQ1 As String, intQ As Integer
Dim RsQ As New ADODB.Recordset

   pFee1 = "0": pFee2 = "0": pOfficalFee = "0"
   
   'Add By Sindy 2025/4/11
   '有傳入總收文號抓系統別和案件性質
   '沒有總收文號才以傳入的值做檢查
   If pKeyNo <> "" Then
      strQ1 = "select cp01,cp10 from caseprogress where cp09='" & pKeyNo & "'"
      intQ = 1
      Set RsQ = ClsLawReadRstMsg(intQ, strQ1)
      If intQ = 1 Then
         strCP01 = "" & RsQ.Fields("cp01")
         strCP10 = "" & RsQ.Fields("cp10")
      End If
   End If
   If strCP01 = "" Or strCP10 = "" Then Exit Sub
   '2025/4/11 END
   
   'Modify By Sindy 2025/4/11 +casefee2
   strQ1 = "select '4',cf201,cf202,cf203,cf204,cf205,nvl(cf206,0) cnt1,nvl(cf207,0) cnt2,nvl(cf208,0) cnt3 from casefee2" & _
           " where cf201='" & strCP01 & "' and cf202='000' and cf203='" & strCP10 & "' and cf204='0' and cf205='0'" & _
           " and cf210=(select max(cf210) from casefee2 where cf201='" & strCP01 & "' and cf202='000' and cf203='" & strCP10 & "' and cf204='0' and cf205='0' and cf210<=" & strSrvDate(1) & ")"
   strQ1 = strQ1 & " Union " & _
           "select '5',cf01,cf02,cf03,'0','0',nvl(cf06,0) cnt1,nvl(cf07,0) cnt2,nvl(cf08,0) cnt3 from casefee" & _
           " where cf01='" & strCP01 & "' and cf02='000' and cf03='" & strCP10 & "'"
   strQ1 = strQ1 & " order by 1,2,3,4,5,6"
   '2025/4/11 END
   intQ = 1
   Set RsQ = ClsLawReadRstMsg(intQ, strQ1)
   If intQ = 1 Then
       pFee1 = "" & RsQ.Fields("cnt1")
       pFee2 = "" & RsQ.Fields("cnt2")
       pOfficalFee = "" & RsQ.Fields("cnt3")
   End If
   Set RsQ = Nothing
End Sub

'Add by Amy 2025/04/16 FCT結案單明細
Public Function Pub_SaveCloseDetail_FCT(ByVal stKey As String, ByVal stFormN As String, ByRef GrdTp As MSHFlexGrid, arrCol() As String, stDate As String, stTime As String, ByRef stMsg As String) As Boolean
   Dim obj As Object, ii As Integer, jj As Integer, stCCD(3 To 7) As String, stCmd As String
   Dim intCol As Integer 'Add by Amy 2025/08/18
   
 On Error GoTo ErrHand
   Pub_SaveCloseDetail_FCT = False: stMsg = ""
   
   Select Case UCase(stFormN)
      Case "FRM210133_F" 'FC結案單-承辦用
   End Select
   
   stCmd = "Delete From CloseCaseDetail Where CCD01=" & CNULL(stKey) & " And CCD02='1' "
   '請款項目
   If GrdTp.Rows > 1 Then
      intCol = GetColVal(arrCol, "代號")
      '新增 or 刪除 都先全刪再新增
      cnnConnection.Execute stCmd
         
      For ii = 1 To GrdTp.Rows - 1
         If GrdTp.TextMatrix(ii, intCol) <> "" Then
            For jj = LBound(arrCol) To UBound(arrCol)
               Select Case jj
                  Case GetColVal(arrCol, "順序")
                     stCCD(3) = GrdTp.TextMatrix(ii, jj)
                  Case GetColVal(arrCol, "代號")
                     stCCD(4) = GrdTp.TextMatrix(ii, jj)
                  Case GetColVal(arrCol, "金額")
                     'Modify by Amy 2025/09/30 資料有加Format需拿掉再存
                     stCCD(5) = Format(GrdTp.TextMatrix(ii, jj), "###0")
                  Case GetColVal(arrCol, "折扣")
                     stCCD(6) = GrdTp.TextMatrix(ii, jj)
                  Case GetColVal(arrCol, "備註")
                     stCCD(7) = GrdTp.TextMatrix(ii, jj)
               End Select
            Next jj
            stCmd = "Insert Into CloseCaseDetail (CCD01,CCD02,CCD03,CCD04,CCD05,CCD06,CCD07) Values" & _
                              "('" & stKey & "','1','" & stCCD(3) & "','" & stCCD(4) & "'," & stCCD(5) & _
                              "," & CNULL(stCCD(6)) & "," & CNULL(ChgSQL(stCCD(7))) & ")"
            cnnConnection.Execute stCmd
         End If
      Next ii
   End If
  
   Pub_SaveCloseDetail_FCT = True
   
ErrHand:
   If Err.Number <> 0 Then
      stMsg = Err.Description
   End If
End Function

'Add by Amy 2025/04/16 FCP結案單明細
'Modify by Amy 2025/07/10 +stAllDDC03:回傳所有聯絡項目之勾選
'Modify by Amy 2025/08/08 +stCtrlDate/stNotPay_CP '管制催款日/發文未請款案件性質
Public Function Pub_SaveCloseDetail_FCP(ByVal stKey As String, ByVal stFormN As String, ByVal stClose As String, objChk1 As Object, stNotPay As String, _
  objChk2 As Object, stMemo As String, stDate As String, stTime As String, ByRef stMsg As String, ByRef stAllCCD03 As String, stCtrlDate As String, stNotPay_CP As String) As Boolean
   Dim obj1 As Object, obj2 As Object, stCCD03 As String, stCCD07 As String, stCmd As String
   Dim stCCD08 As String 'Add by Amy 2025/08/08

 On Error GoTo ErrHand
   Pub_SaveCloseDetail_FCP = False: stMsg = ""
   stAllCCD03 = "" 'Add by Amy 2025/07/10
   
   Select Case UCase(stFormN)
      Case "FRM210133_F" 'FC結案單-承辦用
   End Select

   stCmd = "Delete From CloseCaseDetail Where CCD01=" & CNULL(stKey) & " And CCD02='2' "
   cnnConnection.Execute stCmd

   For Each obj1 In objChk1
      If obj1.Value = vbChecked Then
         stCCD03 = Format(obj1.Index, "00")
         stAllCCD03 = stAllCCD03 & "," & stCCD03 'Add by Amy 2025/07/10
         If stCCD03 = "03" And Trim(stNotPay) <> MsgText(601) Then
            stCCD07 = stNotPay
            stCCD08 = stCtrlDate 'Add by Amy 2025/08/08
         End If
         'Modify by Amy 2025/08/08 +CCD08 管制催款日 (for 有勾 未付帳款 (有值) 及 輸 管制催款日,於程序操作完 解除期限/閉卷 後加行事曆)
         stCmd = "Insert Into CloseCaseDetail (CCD01,CCD02,CCD03,CCD07,CCD08) Values" & _
                           "('" & stKey & "','2','" & stCCD03 & "'," & CNULL(ChgSQL(stCCD07)) & "," & CNULL(stCCD08) & ")"
         cnnConnection.Execute stCmd
      End If
   Next
   
   If stClose = "Y" Then
      '閉卷
      For Each obj2 In objChk2
         If obj2.Value = vbChecked Then
            stCCD03 = Format(obj2.Index, "00")
            stAllCCD03 = stAllCCD03 & "," & stCCD03 'Add by Amy 2025/07/10
            stCmd = "Insert Into CloseCaseDetail (CCD01,CCD02,CCD03) Values" & _
                              "('" & stKey & "','2','" & stCCD03 & "')"
            cnnConnection.Execute stCmd
         End If
      Next
   Else
      '不續辦
      For Each obj2 In objChk2
         If obj2.Value = vbChecked Then
            stCCD03 = Format(obj2.Index, "00")
            stAllCCD03 = stAllCCD03 & "," & stCCD03 'Add by Amy 2025/07/10
            stCmd = "Insert Into CloseCaseDetail (CCD01,CCD02,CCD03) Values" & _
                            "('" & stKey & "','2','" & stCCD03 & "')"
            cnnConnection.Execute stCmd
         End If
      Next
   End If
   
   '聯絡項目 頁籤
   'Add by Amy 2025/08/08 該案已發文未請款 有資料  CCD03=98
   If Trim(stNotPay_CP) <> "" Then
      stCmd = "Insert Into CloseCaseDetail (CCD01,CCD02,CCD03,CCD07) Values" & _
                           "('" & stKey & "','2','98'," & CNULL(ChgSQL(stNotPay_CP)) & ")"
      cnnConnection.Execute stCmd
   End If
   '其他說明 有輸 CCD03=99
   If Trim(stMemo) <> MsgText(601) Then
      stCmd = "Insert Into CloseCaseDetail (CCD01,CCD02,CCD03,CCD07) Values" & _
                           "('" & stKey & "','2','99'," & CNULL(ChgSQL(stMemo)) & ")"
      cnnConnection.Execute stCmd
   End If
   'Add by Amy 2025/07/10 回傳所有CCD03(不含99)
   If stAllCCD03 <> "" Then stAllCCD03 = Mid(stAllCCD03, 2)
   Pub_SaveCloseDetail_FCP = True

ErrHand:
   If Err.Number <> 0 Then
      stMsg = Err.Description
   End If
End Function

'抓FC結案單明細資料
'intChoose:1-請款項目/2-指示程序項目
'Modify by Amy 2025/07/19 +stCCD08/stNotPay_CP
Public Function Pub_QueryFCCloseDetail(intChoose As Integer, ByVal stFormN As String, ByVal stKey, ByVal stSysKind As String, ByRef stMsg As String _
  , Optional ByRef GrdTp As MSHFlexGrid, Optional objChk1 As Object, Optional ByRef objChk2 As Object, Optional ByRef objChk3 As Object _
  , Optional ByRef stNotPay As String, Optional ByRef stMemo As String, Optional ByRef stCCD08 As String, Optional ByRef stNotPay_CP As String) As Boolean
   Dim rsD As New ADODB.Recordset, intD As Integer, stD As String, ii As Integer
   Dim obj1 As Object, obj2 As Object, obj3 As Object
   Dim stCCD03 As String, stCCD07 As String
   
On Error GoTo ErrHnd
   
   Pub_QueryFCCloseDetail = False
   
   Select Case UCase(stFormN)
      Case "FRM210133_F" 'FC結案單-承辦用
      Case "FRM210147_1"
      Case "FRM210148_1"
      Case "FRM210149_1"
   End Select
   
   If intChoose = 1 Then
      'Add by Amy 2025/08/13 不是國外部結案單,從第一畫面勾選多筆資料進入_1避免資料殘留
      If UCase(stFormN) <> "FRM210133_F" Then
         GrdTp.Clear
      End If
      
      '請款項目
      stD = "Select ccd03,ccd04,a1j03,ccd05,ccd06,ccd07 " & _
                  "From CloseCaseDetail,Acc1j0 Where CCD01='" & stKey & "' And CCD02='1' " & _
                  "And a1j01(+) = '" & stSysKind & "' and ccd04=a1j02(+) Order by CCD03 "
      intD = 1
      Set rsD = ClsLawReadRstMsg(intD, stD)
      If intD = 0 Then
         stMsg = "無資料!!"
         Pub_QueryFCCloseDetail = True
      Else
         Set GrdTp.Recordset = rsD
         Pub_QueryFCCloseDetail = True
      End If
      Exit Function
   End If
   
   stNotPay = "": stMemo = "": stCCD08 = "": stNotPay_CP = ""
   If intChoose = 2 Then
       'Add by Amy 2025/08/13 不是國外部結案單,從第一畫面勾選多筆資料進入_1避免資料殘留
      If UCase(stFormN) <> "FRM210133_F" Then
         For Each obj1 In objChk1
            obj1.Value = vbUnchecked
         Next
         For Each obj2 In objChk2
            obj2.Value = vbUnchecked
         Next
         For Each obj3 In objChk3
            obj3.Value = vbUnchecked
         Next
      End If
   
      '指示程序項目
      stD = "Select * From CloseCaseDetail Where CCD01='" & stKey & "' And CCD02='2' Order by CCD03 "
      intD = 1
      Set rsD = ClsLawReadRstMsg(intD, stD)
      If intD = 1 Then
         rsD.MoveFirst
         Do While rsD.EOF = False
            stCCD03 = "" & rsD.Fields("CCD03")
            Select Case Left(stCCD03, 1)
               Case "0"
                  For Each obj1 In objChk1
                     If obj1.Index = Val(stCCD03) Then
                        obj1.Value = vbChecked
                        'Memo by Amy 2025/08/08 未付帳款(原存 未付帳款 及 已發文未請款 資料),因後續要加行事曆(顯示 未付帳款),故將欄位拆開
                        If obj1.Index = 3 Then
                           stNotPay = "" & rsD.Fields("CCD07")
                           stCCD08 = "" & rsD.Fields("CCD08") 'Add by Amy 2025/08/08 管制催款日
                        End If
                     End If
                  Next
               Case "1"
                  For Each obj2 In objChk2
                     If obj2.Index = Val(stCCD03) Then
                        obj2.Value = vbChecked
                     End If
                  Next
               Case "2"
                  For Each obj3 In objChk3
                     If obj3.Index = Val(stCCD03) Then
                        obj3.Value = vbChecked
                     End If
                  Next
               Case Else
                  'Add by Amy 2025/08/08 原 未付帳款 存 未付帳款 及 已發文未請款 資料,於程序操作完 解除期限/閉卷 後加行事曆(顯示 未付帳款),故將欄位拆開
                  '該案未請款
                  If stCCD03 = "98" Then
                     stNotPay_CP = "" & rsD.Fields("CCD07")
                  End If
                  'end 2025/08/08
                  '其他說明
                  If stCCD03 = "99" Then
                     stMemo = "" & rsD.Fields("CCD07")
                  End If
            End Select
         
            rsD.MoveNext
         Loop
         Pub_QueryFCCloseDetail = True
      End If
   End If
   
ErrHnd:
   If Err.Number <> 0 Then stMsg = Err.Description
   Set rsD = Nothing
End Function

'設定結案原因
'intFCState:0-非FC/1-FC商標/2-FC專利
'stROR01:傳入代碼,回傳代碼+名稱
Public Sub Pub_SetCloseReason(intFCState As Integer, stFormN As String, Optional ByRef obj As Object, Optional ByRef stROR01 As String = "")
   Dim RsQ As New ADODB.Recordset
   Dim intQ As Integer, stQ As String, stField As String, stWhere As String, stTP As String, stKey As String
   
   Select Case UCase(stFormN)
      Case "FRM110101_2", "FRM110103_3"  '解除期限/閉卷
         If intFCState = 1 And strSrvDate(1) < FCT結案單電子化啟用日 Then
            intFCState = "99"
         ElseIf intFCState = 2 And strSrvDate(1) < FCP結案單電子化啟用日 Then
            intFCState = "99"
         End If
      Case "FRM210133_F" 'FC結案單-承辦用
      Case "FRM210147_1" '案件簽核作業明細-個人用
      Case "FRM210148_1" '案件簽核作業明細-主管用
      Case "FRM210149_1" '待處理區明細
   End Select
   
   Select Case intFCState
      Case 0 '非FC用(智權部結案單)
         stField = ",ROR02"
         stWhere = "And (ROR01<='11' Or ROR01>='99') "
      Case 1 '商標
         stField = ",Nvl(ROR03,ROR02) as ROR02"
         stWhere = "And ROR01 in('02','04','05','10','15','16','19','20','21','22','99') "
      Case 2 '專利
         stField = ",Nvl(ROR04,ROR02) as ROR02"
         stWhere = "And ROR01 in('02','04','05','06','09','10','11','13','14','15','23','99') "
      Case 99
         stField = ",ROR02"
   End Select
   If UCase(stFormN) = "FRM110101_2" Or UCase(stFormN) = "FRM110103_3" Then
      '解除期限/閉卷 抓全部
      stWhere = ""
   End If
   If stROR01 <> MsgText(601) Then
      stKey = stROR01: stROR01 = ""
      stWhere = "And ROR01='" & stKey & "' "
   End If
  
   stQ = "Select ROR01" & stField & " From ReasonoFrelief Where 1=1 " & stWhere & " Order by ROR01 "
   intQ = 1
   Set RsQ = ClsLawReadRstMsg(intQ, stQ)
   If intQ = 1 Then
      Do While RsQ.EOF = False
         stTP = RsQ.Fields("ROR02")
         If stKey = MsgText(601) Then
            If UCase(stFormN) = "FRM110101_2" Or UCase(stFormN) = "FRM110103_3" _
              Or UCase(stFormN) = "FRM210148_1" Or UCase(stFormN) = "FRM210149_1" Then
               obj.AddItem "" & RsQ("ROR01") & "--" & stTP
            Else
               stTP = stTP & " (代號" & RsQ.Fields("ROR01") & ")"
               obj(Val(RsQ.Fields("ROR01"))).Caption = stTP
            End If
         Else
            stROR01 = "" & RsQ.Fields("ROR02")
         End If
 
         RsQ.MoveNext
      Loop
   End If
   
   Set RsQ = Nothing
End Sub

'設定FC結案單-907/913 狀態
Public Function Pub_SetCloseCboState(stFormN As String, Optional ByRef Cbo1 As Object, Optional ByRef Cbo2 As Object _
  , Optional ByVal stFindSql As String = "") As String
   Dim RsQ As New ADODB.Recordset, ii As Integer, intQ As Integer, stQ As String, stWhere As String
   
   Select Case UCase(stFormN)
      Case "FRM210133_F" 'FC結案單-承辦用
      Case "FRM210147_1" '案件簽核作業明細-個人用
      Case "FRM210148_1" '案件簽核作業明細-主管用
      Case "FRM210149_1" '待處理區明細
   End Select
   
   Pub_SetCloseCboState = ""
   If UCase(stFormN) = "FRM210133_F" Then
      Cbo1.AddItem ""
      Cbo2.AddItem ""
   End If
   
   'Modify by Amy 2025/07/29 +AC02
   stQ = "Select AC02||'.'||AC03,AC02 From AllCode Where AC01='RR' " & stFindSql & "Order by AC02 "
   intQ = 1
   Set RsQ = ClsLawReadRstMsg(intQ, stQ)
   If intQ = 1 Then
      Do While RsQ.EOF = False
         If UCase(stFormN) = "FRM210133_F" Then
            Cbo1.AddItem "" & RsQ.Fields(0)
            '*** 閉卷 下拉選單 ***
            'Modify by Amy 2025/07/29 +if,不出現「01.銷年費管制」,因有勾選項目「請銷本所年費期限管制」-Kimi
            'Modify by Amy 2025/07/31 +「07.銷香港註冊期限管制」,閉卷不出現-Anny
            'Modify by Amy 2025/08/04 +「08.銷主動補正期限管制」,閉卷不出現-Kimi
            If "" & RsQ.Fields("AC02") <> "01" And "" & RsQ.Fields("AC02") <> "07" And "" & RsQ.Fields("AC02") <> "08" Then
               Cbo2.AddItem "" & RsQ.Fields(0)
            End If
         Else
            Pub_SetCloseCboState = "" & RsQ.Fields(0)
         End If
         RsQ.MoveNext
      Loop
   End If
   
   Set RsQ = Nothing
End Function

'設定FC結案單-聯絡項目
Public Sub Pub_GetFCPContactItem(stFormN As String, ByRef Chk1 As Object, ByRef Chk2 As Object, ByRef Chk3 As Object)
   Dim obj1 As Object, obj2 As Object, obj3 As Object
   Dim RsQ As New ADODB.Recordset, intQ As Integer, stQ_Fix As String, stQ As String
   Dim idx As Integer, stTP As String

   Select Case UCase(stFormN)
      Case "FRM210133_F" 'FC結案單-承辦用
      Case "FRM210147_1" '案件簽核作業明細-個人用
      Case "FRM210148_1" '案件簽核作業明細-主管用
      Case "FRM210149_1" '待處理區明細
   End Select
   
'*** 依代碼設定資料 ***
   stQ_Fix = "Select Replace(AC03,'不續辦請款','') as AC03,AC02 From AllCode Where AC01='RD' "
   '都有 項目
   stQ = stQ_Fix & " And SubStr(AC02,1,1)='0' "
   intQ = 1
   Set RsQ = ClsLawReadRstMsg(intQ, stQ)
   If intQ = 1 Then
      RsQ.MoveFirst
      Do While RsQ.EOF = False
         idx = Val(RsQ.Fields("AC02"))
         Chk1(idx).Caption = "" & RsQ.Fields("AC03")
         RsQ.MoveNext
      Loop
   End If
      
   '不續辦 項目
   stQ = stQ_Fix & " And SubStr(AC02,1,1)='1' "
   intQ = 1
   Set RsQ = ClsLawReadRstMsg(intQ, stQ)
   If intQ = 1 Then
      RsQ.MoveFirst
      Do While RsQ.EOF = False
         idx = Val(RsQ.Fields("AC02"))
         Chk2(idx).Caption = "" & RsQ.Fields("AC03")
         RsQ.MoveNext
      Loop
   End If
   
   '閉卷 項目
   stQ = stQ_Fix & " And SubStr(AC02,1,1)='2' "
   intQ = 1
   Set RsQ = ClsLawReadRstMsg(intQ, stQ)
   If intQ = 1 Then
      RsQ.MoveFirst
      Do While RsQ.EOF = False
         idx = Val(RsQ.Fields("AC02"))
         Chk3(idx).Caption = "" & RsQ.Fields("AC03")
         RsQ.MoveNext
      Loop
   End If
   Set RsQ = Nothing
End Sub

'傳入案號、案件性質 讀取 請款對象相關資料-FC結案單用
'intState:1-目前請款設定,FC商標 用/2-未付帳款 資訊,FC專利 用/3-比對結案單與目前請款單設定有不同回傳訊息
'Modify by Amy 2025/08/14 +stTM56/stTM69
Public Sub Pub_GetCloseA1KData(intState As Integer, stFormN As String, A1k13 As String, A1k14 As String, A1k15 As String, A1k16 As String, ByRef stA1K As String _
  , Optional ByVal stCP10 As String, Optional ByRef stA1K04 As String, Optional ByRef stA1K27 As String, Optional ByRef stA1K28 As String _
  , Optional ByRef stTM56 As String, Optional ByRef stTM69 As String, Optional ByVal stF0301 As String, Optional ByRef stCCM20Back As String _
  , Optional ByRef stBackData As String)
'Add by Amy 2025/11/12
Dim RsQ As New ADODB.Recordset, intQ As Integer, strQ As String, strShowMsg As String
Dim stCCM19 As String, stCCM20 As String, stCCM21 As String, stCCM22 As String, stCCM23 As String, stCCM24 As String
    
   Select Case UCase(stFormN)
      Case "FRM210133_INV" '案件未付帳款/請款單 資訊-結案單用
      Case "FRM210133_F" 'FC結案單-承辦用
      Case "FRM210147_1" '案件簽核-個人用
      Case "FRM210148_1" '案件簽核-主管用
      Case "FRM210149" '待處理區
      Case "FRM210149_1" '待處理區明細
      Case "FRMACC21h1" 'Add by Amy 2025/10/21
   End Select
   
   stA1K04 = "": stA1K27 = "": stA1K28 = ""
   stTM56 = "": stTM69 = "" 'Add by Amy 2025/08/14
   stCCM20Back = "": stBackData = "" 'Add by Amy 2025/11/12
   
   '目前請款設定 (目前 FC商標用)
   If intState = 1 Or intState = 3 Then
      stA1K = "" '帳款是否已清a1k29
      stA1K27 = PUB_GetA1K27(A1k13, A1k14, A1k15, A1k16, stCP10) '列印對象
      stA1K28 = PUB_GetA1K28(A1k13, A1k14, A1k15, A1k16, stCP10) '請款對象
      '固定請款對象
      stTM56 = Pub_GetField("TradeMark", "tm01='" & A1k13 & "' And tm02='" & A1k14 & "' And tm03='" & A1k15 & "' And tm04='" & A1k16 & "'", "TM56")
      '固定列印對象
      stTM69 = Pub_GetField("TradeMark", "tm01='" & A1k13 & "' And tm02='" & A1k14 & "' And tm03='" & A1k15 & "' And tm04='" & A1k16 & "'", "TM69")
      '列印申請人
      stA1K04 = PUB_GetA1K04(A1k13, A1k14, A1k15, A1k16, stA1K28, stCP10)
      'Add by Amy 2025/11/12 比對結案單與目前請款單設定有不同回傳訊息
      If intState = 3 Then
         strQ = "Select * From CloseCaseMain Where CCM01='" & stF0301 & "' "
         Set RsQ = ClsLawReadRstMsg(intQ, strQ)
         If intQ = 1 Then
            stCCM19 = "" & RsQ.Fields("CCM19") '是否合併列印
            stCCM20 = "" & RsQ.Fields("CCM20") '是否列印申請人
            stCCM21 = "" & RsQ.Fields("CCM21") '請款對象
            stCCM22 = "" & RsQ.Fields("CCM22") '列印對象
            stCCM23 = "" & RsQ.Fields("CCM23") '固定請款對象
            stCCM24 = "" & RsQ.Fields("CCM24") '固定列印對象
            If stA1K04 <> stCCM20 Then
               stCCM20Back = stCCM20
               strShowMsg = strShowMsg & ";．列印申請人"
            End If
            If stCCM19 <> "" Then strShowMsg = strShowMsg & ";．合併列印請款單"
            If stA1K28 <> stCCM21 Then strShowMsg = strShowMsg & ";．請款對象 需設為" & stCCM21 & "(原:" & IIf(stA1K28 = "", "空", stA1K28) & ")"
            If stA1K27 <> stCCM22 Then strShowMsg = strShowMsg & ";．列印對象 需設為" & stCCM22 & "(原:" & IIf(stA1K27 = "", "空", stA1K27) & ")"
            If stTM56 <> stCCM23 Then strShowMsg = strShowMsg & ";．固定請款對象 需設為" & stCCM23 & "(原:" & IIf(stTM56 = "", "空", stTM56) & ")"
            If stTM69 <> stCCM24 Then strShowMsg = strShowMsg & ";．固定列印對象 需設為" & stCCM24 & "(原:" & IIf(stTM69 = "", "空", stTM69) & ")"
            stBackData = strShowMsg
         End If
      End If
   '未付帳款 資訊 (目前 FC專利用)
   ElseIf intState = 2 Then
      stA1K = PUB_GetNotPayA1K(" And a1k13='" & A1k13 & "' and a1k14='" & A1k14 & "' and a1k15='" & A1k15 & "' and a1k16='" & A1k16 & "'")
   End If
End Sub

'Add by Amy 2025/04/30 結案單請款項目Grid欄位設定
'stSetAlignCol:回傳需靠右之欄位 'Add by Amy 2025/11/03
Public Sub Pub_SetCloseGridAmtWidth(ByVal stFormN As String, ByRef GrdTp As MSHFlexGrid, arrTpCol() As String, arrColWidth() As String, _
  Optional ByVal IsFirst As Boolean = False, Optional ByRef stSetAlignCol As String)
   Dim i As Integer, stField As String, stWidth As String
   Dim j As Integer, stSetCol As String, arrSetCol 'Add by Amy 2025/10/15
   
   Select Case UCase(stFormN)
      Case "FRM210133_F" 'FC結案單-承辦用
      Case "FRM210147_1" '案件簽核-個人用
      Case "FRM210148_1" '案件簽核-主管用
         'Memo 外商結案前一筆若為舊結案單資料,後一筆為FCT資料時,可能未設定欄位名稱,而造成錯誤
         IsFirst = True 'Add by Amy 2025/08/28
      Case "FRM210149_1" '待處理區
         IsFirst = True  'Add by Amy 2025/08/28
   End Select
   
   GrdTp.Visible = False
   stSetAlignCol = "" 'Add by Amy 2025/11/03
   If IsFirst = True Then
      stField = "順序,代號,請款項目,金額,折扣,備註"
      stWidth = "450,700,1500,1500,900,3100"
      arrTpCol = Split(stField, ",")
      arrColWidth = Split(stWidth, ",")
   End If
   FixGrid GrdTp
   GrdTp.Cols = UBound(arrTpCol) + 1
   GrdTp.row = 0
   For i = 0 To GrdTp.Cols - 1
      GrdTp.col = i
      GrdTp.Text = arrTpCol(i)
      GrdTp.ColWidth(i) = Val(arrColWidth(i))
      GrdTp.CellAlignment = flexAlignCenterCenter
      'Add by Amy 2025/10/15 金額欄靠右對齊
      If GrdTp.Text = "金額" Or GrdTp.Text = "折扣" Then
         stSetCol = stSetCol & ";" & i
      End If
      'end 2025/10/15
   Next i

   'Add by Amy 2025/10/15 金額欄靠右對齊
   If stSetCol <> "" Then
      stSetCol = Mid(stSetCol, 2)
      stSetAlignCol = stSetCol 'Add by Amy 2025/11/03
      arrSetCol = Split(stSetCol, ";")
      For i = 1 To GrdTp.Rows - 1
         GrdTp.row = i
         For j = LBound(arrSetCol) To UBound(arrSetCol)
            GrdTp.col = arrSetCol(j)
            GrdTp.CellAlignment = flexAlignRightCenter
         Next j
      Next i
   End If
   'end 2025/10/15
   GrdTp.Visible = True
End Sub

'Add by Amy 2025/05/27 傳入結案單編號/案號確認是否要請款
'Modify by Amy 2025/07/10 +stY53374=Y:是寰華 /stBackData:傳入資料,依表單回傳資料
Public Function Pub_ChkCloseInvoce(stFormN As String, ByVal stCCD01 As String, ByVal stCNo1 As String, ByVal stCNo2 As String, ByVal stCNo3 As String, ByVal stCNo4 As String _
  , Optional ByVal stY53374 As String = "", Optional ByRef stBackData As String = "") As Boolean
   Dim RsQ As New ADODB.Recordset, intQ As Integer, stQ As String, stWhr As String
   Dim stChkCode As String, stInputCode As String, IsEng As Boolean, IsPro As Boolean 'Add by Amy 2025/07/10
   
   stChkCode = "01,14,15,22"
   Select Case UCase(stFormN)
      Case "FRM110101_2" '解除期限
      Case "FRM110103_3" '閉卷
      Case "FRM210133_F" '國外部結案單 'Add by Amy 2025/07/10
   End Select
   
   Pub_ChkCloseInvoce = False
   'Modify by Amy 2025/07/10 +CFP 及 國外部結案單,避免有未改到統一於此判斷
   If stCNo1 <> "FCP" And stCNo1 <> "P" And stCNo1 <> "FG" And stCNo1 <> "CFP" Then Exit Function
  
   If stBackData <> "" Then
      stInputCode = stBackData
      stBackData = ""
   End If
   
   'P[非]寰華 及 CFP-[內專]程序結, 於解除期限 or 閉卷,不需出Outlook草稿
   If UCase(stFormN) = "FRM110101_2" Or UCase(stFormN) = "FRM110103_3" Then
      If stCNo1 = "CFP" Or (stCNo1 = "P" And PUB_FMPtoCheck(1, 2, Pub_strUserST05, stCNo1, stCNo2, stCNo3, stCNo4) = False) Then
         Exit Function
      End If
   End If
   'P[非]寰華 及 CFP-[內專]程序結,於國外部結案單,出Outlook草稿,故其他 系統別 跳離開
   If UCase(stFormN) = "FRM210133_F" And Not (stCNo1 = "CFP" Or (stCNo1 = "P" And stY53374 = "N")) Then
      Exit Function
   End If
   'end 2025/07/10
   
   'Modify by Amy 2025/07/10 +if 國外部結案(避免有未改到統一於此判斷) ,並增加 不續辦.未獲指示(14) 及 不續辦.已獲指示(15)
   '內專程序結案(P[非]寰華及CFP案, 於 結案單 送出，出Outlook)：
   '     勾選「D/N run C 類工程師報告」-->寄工程師+承辦
   '              「閉卷請款」、不續辦之「未獲指示」or「已獲指示」-->只寄承辦(自己操作,寄給自己)
   '外專程序結案(於 解除期限/閉卷 送出，出Outlook)：
   '     勾選「D/N run C 類工程師報告」 或 「閉卷請款」-->寄工程師+承辦
   '              「閉卷請款」、不續辦之「未獲指示」or「已獲指示」-->只寄承辦
   
   '國外部結案單出草稿
   If UCase(stFormN) = "FRM210133_F" Then
      'D/N run C 類工程師報告
      If InStr(stInputCode, "01") > 0 Then
         '寄 工程師+承辦
         IsEng = True
         IsPro = True
         Pub_ChkCloseInvoce = True
      '不續辦.未獲指示(14) / 不續辦.已獲指示(15) / 閉卷請款(22)
      ElseIf InStr(stInputCode, "14") > 0 Or InStr(stInputCode, "15") > 0 Or InStr(stInputCode, "22") > 0 Then
         IsPro = True '寄 承辦
         Pub_ChkCloseInvoce = True
      End If
   Else
      'D/N run C 類工程師報告(01) / 閉卷請款(22) / 不續辦.未獲指示(14) / 不續辦.已獲指示(15),為要 請款項目
      stWhr = " And CCD02='2' And CCD03 in ('" & Replace(stChkCode, ",", "','") & "')"
      stQ = "Select * From CloseCaseDetail Where CCD01='" & stCCD01 & "' " & stWhr & " Order by CCD03 "
      intQ = 1
      Set RsQ = ClsLawReadRstMsg(intQ, stQ)
      If intQ = 1 Then
         RsQ.MoveFirst
         Pub_ChkCloseInvoce = True
         Do While RsQ.EOF = False
            'Memo by Amy 2025/07/10 結案單出Outlook使用
            If UCase(stFormN) = "FRM110101_2" Or UCase(stFormN) = "FRM110103_3" Then
               '有「C 類工程師報告」->寄 工程師+承辦 /「閉卷請款 」、不續辦「未獲指示」及「已獲指示」 ->寄承辦
               '若有「C 類工程師報告+其他項目->兩者都寄
               If RsQ.Fields("CCD03") = "01" Then
                  '寄 工程師+承辦
                  IsPro = True
                  IsEng = True
               Else
                  IsPro = True
               End If
            End If
            RsQ.MoveNext
         Loop
      End If
      'end 2025/07/10
      Set RsQ = Nothing
   End If
   '解除期限 / 閉卷 / 國外部結案單
   If UCase(stFormN) = "FRM110101_2" Or UCase(stFormN) = "FRM110103_3" Or UCase(stFormN) = "FRM210133_F" Then
      If IsEng = True And IsPro = True Then
         stBackData = "0" '寄 工程師+承辦
      ElseIf IsPro = True Then
         stBackData = "1"  '寄 承辦
      End If
   End If
End Function

'Add by Amy 2025/06/02 解除期限 或 閉卷 開Ourlook通知信-外專用
'Modify by Amy 2025/07/09 +傳入 stType:"0" 寄 工程師+承辦 / "1"  '寄 承辦
Public Function Pub_CloseOutLook(ByVal stFormN As String, ByVal stCCM01 As String, ByVal stCNo1 As String, ByVal stCNo2 As String, ByVal stCNo3 As String, ByVal stCNo4 As String, _
  ByVal stNation As String, ByVal stCP10 As String, stType As String, ByRef stMsg As String) As Boolean
   Dim RsQ As New ADODB.Recordset, intQ As Integer, strQ As String, strCP10n As String
   Dim objOutLook As Object, objMail As Object
   Dim strTo As String, strCC As String, strAttach As String, strSubject As String, strToEng As String, strCCEng As String
   Dim strContent As String, strContent_E As String, strContent_S As String
   Dim strSales As String, strSalesST52 As String '承辦人員/承辦主管
   Dim strEngineer As String, strEngineerN As String, strESt03 As String, IsLeave As Boolean '工程師編號/工程師姓名/部門/離職
   Dim strEngineerMan As String '工程師主管編號
   Dim IsFMPY53374 As Boolean '寰華
   
    'Memo  P非寰 及 CFP(內專結) 於「國外部結案單」送出時產生,其他於外專程序 解除期限/閉卷 送出時產生
    '              出Outlook草稿規則 參閱 Pub_ChkCloseInvoce函數
    Select Case UCase(stFormN)
      Case "FRM110101_2" '解除期限
      Case "FRM110103_3" '閉卷
      Case "FRM210133_F" '國外部結案單
   End Select
   
   Pub_CloseOutLook = False: stMsg = ""
   strCP10n = GetCaseTypeName(stCNo1, stCP10, 0)
   '寄 工程師+承辦
   If stType = "0" Then
      'Modify by Amy 2025/07/10 工程師抓該案號進度中最近的C類CP14工程師 語法,改至共用函數
      strQ = GetCClassCP14Sql(stCNo1, stCNo2, stCNo3, stCNo4)
      intQ = 1
      Set RsQ = ClsLawReadRstMsg(intQ, strQ)
      If intQ = 0 Then
         stMsg = "無C類來函掛工程師,不需出草稿！"
         Set RsQ = Nothing
         Exit Function
      Else
         RsQ.MoveFirst
         If "" & RsQ.Fields("ST04") = "2" Then IsLeave = True
         strEngineer = "" & RsQ.Fields("CP14")
         strEngineerN = "" & RsQ.Fields("ST02")
      End If
   End If
   
   '請款通知函(只有FCP才有-參考Patpro1->報表列印->對外通知函->請款通知函)
   If stCNo1 = "FCP" And Pub_CloseInvLetter(stFormN, stCNo1, stCNo2, stCNo3, stCNo4, stCP10, stMsg) = False Then
      If stMsg = "" Then
         stMsg = "請款通知函產生失敗(Pub_CloseOutLook:CP10-" & stCP10 & ")" & vbCrLf & _
                           "請洽電腦中心！"
      End If
      Set RsQ = Nothing
      Exit Function
   End If
   
   'Modify by Amy 2025/07/29 各層級工程師主管都要
   'strEngineerMan = PUB_GetFCPEngSup(strEngineer, True)
   strEngineerMan = PUB_GetFCPEngSup(strEngineer, , , True)
   
   strSales = ShowCurrCP13(stCNo1, stCNo2, stCNo3, stCNo4, stNation) '承辦人員
   strSalesST52 = PUB_GetFCPProSup(strSales) 'FC承辦人員2級主管
   If stCNo1 = "P" Then
      IsFMPY53374 = PUB_FMPtoCheck(1, 2, PUB_GetST05(strSales), stCNo1, stCNo2, stCNo3, stCNo4) 'FMP寰華案件
   End If
   
   'Memo by Amy 2025/07/10 統一寄件內容
   '     勾選「D/N run C 類工程師報告」寄工程師+承辦
   '             「閉卷請款」、不續辦之「未獲指示」or「已獲指示」，只寄承辦 (內專結,承辦操作結案單,會寄給自己)-Anny:還是寄給自己,才能追蹤
   '主旨
   If stType = "1" Then
      '寄 承辦
      strSubject = "【已" & strCP10n & "_需" & strCP10n & "請款】請提供C類金額給承辦 " & _
                              "Our Ref: " & stCNo1 & "-" & stCNo2 & IIf(stCNo3 & stCNo4 = "000", "", "-" & stCNo3 & "-" & stCNo4) & _
                              " [INCOM." & stCP10 & "(" & strCP10n & ")]"
   Else
      '寄 工程師+承辦 (解除期限 / 閉卷 若自行勾選「出Outlook草稿」都帶
      strSubject = "【已" & strCP10n & "_需" & strCP10n & "請款】1. 請提供C類金額 2. " & strCP10n & "請款 " & _
                              "Our Ref: " & stCNo1 & "-" & stCNo2 & IIf(stCNo3 & stCNo4 = "000", "", "-" & stCNo3 & "-" & stCNo4) & _
                              " [INCOM." & stCP10 & "(" & strCP10n & ")]"
      '工程師離職,收受者給其主管;否則收受者給工程師,cc其主管
      If IsLeave = True Then
         strToEng = ";" & strEngineerMan
         strContent_E = "To: " & GetPrjSalesNM(strEngineerMan) & vbCrLf & _
                                    "  請提供C類金額給承辦"
      Else
         strToEng = ";" & strEngineer '工程師
         strCCEng = ";" & strEngineerMan  '工程師主管
         strContent_E = "To: " & strEngineerN & vbCrLf & _
                                    "  請提供C類金額給承辦"
      End If
   End If
   
   strTo = strSales & strToEng '承辦人員
   strCC = strSalesST52  '承辦主管
   strCC = strCC & strCCEng & "; backup" 'backup寫於最後-Sindy
   'To:承辦內文
   strContent_S = "To: " & GetPrjSalesNM(strSales) & vbCrLf & _
                                 "  1.定稿已產生" & vbCrLf & _
                                 "  2.待工程師提供金額，請進行請款"
   
   '有內容及收件者才需要呼叫Outlook草稿
   If (strContent_E <> "" Or strContent_S <> "") And strTo <> "" Then
      '呼叫新郵件：
      Set objOutLook = CreateObject("Outlook.Application")
      Set objMail = objOutLook.CreateItem(0)
      
      '轉HTML格式
      strContent = Replace(strContent, "新細明體", "Times New Roman")
      '&nbsp; 不換行空格 /&thinsp; 窄空格/空白&nbsp; /&emsp; 全形空格/&ensp; 半形空格
      If strContent_E <> "" Then
         strContent = Replace(strContent_E, " ", "&thinsp;") & "<BR>" & "<BR>"
      End If
      strContent = strContent & Replace(strContent_S, " ", "&thinsp;")
      strContent = Replace(strContent, vbCrLf, "<BR>")
      
      With objMail
         .To = strTo
         .cc = strCC
         If strAttach <> "" Then
            .Attachments.add strAttach '加附件
         End If
         .Subject = strSubject
         .HTMLBody = strContent
         .Display
      End With
      
      Pub_CloseOutLook = True '草稿產生成功
      Set objMail = Nothing
      Set objOutLook = Nothing
   End If
   Set RsQ = Nothing
End Function

'FC結案後產生請款通知函
Public Function Pub_CloseInvLetter(ByVal stFormN As String, ByVal stCNo1 As String, ByVal stCNo2 As String, ByVal stCNo3 As String, ByVal stCNo4 As String _
    , ByVal stCP10 As String, ByRef stErr As String)
   Dim nFrm As Form, nFrm1 As Form, nFrm2 As Form
On Error GoTo ErrHnd
   
   Pub_CloseInvLetter = False
   If Not (stCNo1 = "FCP" And (stCP10 = "907" Or stCP10 = "913")) Then Pub_CloseInvLetter = True: Exit Function
    
    Select Case UCase(stFormN)
      Case "FRM110101_2" '解除期限
      Case "FRM110103_3" '閉卷
   End Select
   
   Set nFrm1 = Forms(0).GetForm("frm060306_5")
   Set nFrm2 = Forms(0).GetForm("frm060306")
   '檢查表單是否已開啟，若是，則關閉
   For Each nFrm In Forms
      If StrComp(nFrm.Name, "frm060306_5", vbTextCompare) = 0 Then
         Set nFrm1 = Forms(0).GetForm("frm060306_5")
         Unload nFrm1
      End If
      If StrComp(nFrm.Name, "frm060306", vbTextCompare) = 0 Then
         Set nFrm2 = Forms(0).GetForm("frm060306")
         Unload nFrm2
         Exit For
      End If
   Next
   
   nFrm2.Show
   nFrm2.Text1.Text = stCNo1
   nFrm2.Text2.Text = stCNo2
   nFrm2.Text3.Text = stCNo3
   nFrm2.Text4.Text = stCNo4
   nFrm2.m_quyAnyCP10 = stCP10
   nFrm2.Command1_Click '尋找
   If nFrm2.MSHFlexGrid1.Rows >= 2 Then
      nFrm2.MSHFlexGrid1.TextMatrix(1, 0) = "v"
      Call nFrm2.cmdok_Click(1) '確定
      nFrm1.Show
      Call nFrm1.cmdok_Click(0) 'frm060306_5 確定
      Unload nFrm2
   End If
   Pub_CloseInvLetter = True
   Exit Function
   
ErrHnd:
   If Err.Number <> 0 Then
      stErr = "請款通知函產生失敗！(Pub_CloseInvLetter)" & vbCrLf & _
                     Err.Description & vbCrLf & "請洽電腦中心！"
   End If
End Function

'Add by Amy 2025/06/05 傳入欲檢查之案號,判斷FC案兩案之代理人、申請人是否相同
'intChoose:0-確認代理人、申請人是否相同(都檢查完才顯示訊息)/1-只確認代理人/2-只確認申請人
'intMsgType:0-回傳訊息/1-回傳[是否]訊息
'stCaseNo1~4:目前要檢查之案號
'stCaseNo1_Pre~4:前一筆之案號
'stBackData:intMsgType=0時,回傳訊息/intMsgType=1時,回傳是否型態
'stAgNo_Pre:傳入前一筆案號代理人編號(有傳入不需再重抓資料)
'stAllApplyNo_Pre:傳入前一筆案號申請人編號1-5 ,以;區隔(有傳入不需再重抓資料)
Public Function ChkAgentAndApplySame(intChoose As Integer, intMsgType As Integer, stFormN As String, ByVal stCaseNo1 As String, ByVal stCaseNo2 As String, ByVal stCaseNo3 As String, ByVal stCaseNo4 As String, _
 ByVal stCaseNo1_Pre As String, ByVal stCaseNo2_Pre As String, ByVal stCaseNo3_Pre As String, ByVal stCaseNo4_Pre As String, _
 Optional ByRef stBackData As String, Optional ByVal stAgNo_Pre As String = "", Optional ByVal stAllApplyNo_Pre As String = "") As Boolean
   Dim RsQ As New ADODB.Recordset, intQ As Integer, i As Integer, strQ As String, strWhrP As String, strWhrS As String
   Dim bolAgSame As Boolean, bolApplySame As Boolean
   Dim stShowMsg1 As String, stMsgAll As String, stMsg1 As String, stMsg2 As String, intE As Integer
   Dim stAllCaseNo As String, stAgNo As String, stAllApplyNo As String, arrApplyNo_Pre
   
   Select Case UCase(stFormN)
      Case "FRM010001" '多案收文
      Case "FRM210133_F" '國外部結案單
   End Select
   
   ChkAgentAndApplySame = False
   stBackData = ""
   If stCaseNo1 = "" Then stBackData = "傳入之系統別為空,請洽電腦中心！": Exit Function
   If (intChoose = 0 Or intChoose = 1) And stAgNo_Pre = "" And stCaseNo1_Pre = "" Then
      stBackData = "未傳入[前筆]代理人編號或案號,請洽電腦中心！"
      Exit Function
   End If
   If (intChoose = 0 Or intChoose = 1) And stAllApplyNo_Pre = "" And stCaseNo1_Pre = "" Then
      stBackData = "未傳入[前筆]申請人編號或案號,請洽電腦中心！"
      Exit Function
   End If
   
   stBackData = "": intE = 0
   stAllCaseNo = "與此案號「" & stCaseNo1 & "-" & stCaseNo2 & IIf(stCaseNo3 & stCaseNo4 = "000", "", stCaseNo3 & "-" & stCaseNo4) & "」"
   
   If intChoose = 0 Or intChoose = 1 Then
      If stAgNo_Pre = "" Then intE = 1
      '是否同FC代理人
      For i = intE To 0 Step -1
         '抓前一筆
         If i = 1 Then
            strWhrP = "And pa01='" & stCaseNo1_Pre & "' And pa02='" & stCaseNo2_Pre & "' And pa03='" & stCaseNo3_Pre & "' And pa04='" & stCaseNo4_Pre & "' "
            strWhrS = "And sp01='" & stCaseNo1_Pre & "' And sp02='" & stCaseNo2_Pre & "' And sp03='" & stCaseNo3_Pre & "' And sp04='" & stCaseNo4_Pre & "' "
         Else
            strWhrP = "And pa01='" & stCaseNo1 & "' And pa02='" & stCaseNo2 & "' And pa03='" & stCaseNo3 & "' And pa04='" & stCaseNo4 & "' "
            strWhrS = "And sp01='" & stCaseNo1 & "' And sp02='" & stCaseNo2 & "' And sp03='" & stCaseNo3 & "' And sp04='" & stCaseNo4 & "' "
         End If
         strQ = "Select pa75 as FCAgNo From Patent Where 1=1 " & strWhrP & _
         " Union Select sp26 as FCAgNo From ServicePractice Where 1=1 " & strWhrS
         intQ = 1
         Set RsQ = ClsLawReadRstMsg(intQ, strQ)
         If intQ = 1 Then
            If i = 1 Then
               stAgNo_Pre = "" & RsQ.Fields("FCAgNo") '前一筆
               If Replace(stAgNo_Pre, ";", "") = "" Then stAgNo_Pre = "空"
            Else
               stAgNo = "" & RsQ.Fields("FCAgNo")
               If Replace(stAgNo, ";", "") = "" Then stAgNo = "空"
            End If
         Else
            '抓前一筆
            If i = 1 Then
               stMsg1 = stCaseNo1_Pre & "-" & stCaseNo2_Pre & IIf(stCaseNo3_Pre & stCaseNo4_Pre = "000", "", stCaseNo3_Pre & "-" & stCaseNo4_Pre)
            Else
               stMsg1 = stCaseNo1 & "-" & stCaseNo2 & IIf(stCaseNo3 & stCaseNo4 = "000", "", stCaseNo3 & "-" & stCaseNo4)
            End If
            stBackData = stMsg1 & " 無此案號資料！"
            Exit For
         End If
      Next i
      If stBackData <> "" Then Set RsQ = Nothing: Exit Function '無案號先跳離
      
      'Memo by Amy 參看frm010001.Command1 修改-與Sindy 討論後改為FC代理人不同就彈
      '                             因發現sp26 有FC代理人資料為空,若判斷第1筆有資料才判斷第2筆,會有沒彈訊息的狀況(第1筆沒代理人,第2筆有代理人不會彈)
      stShowMsg1 = "代理人為「YYYYYYYYY」" & vbCrLf
      If stAgNo_Pre = "空" Then
         stMsg1 = "無代理人"
      Else
         stMsg1 = Replace(stShowMsg1, "YYYYYYYYY", stAgNo_Pre)
      End If
      
      If stAgNo_Pre = stAgNo Then
         bolAgSame = True
      ElseIf intChoose = 1 Then
         stMsgAll = "第一筆案號" & stMsg1 & vbCrLf & _
                              stAllCaseNo & "FC代理人不同"
         If intMsgType = 1 Then
            stBackData = MsgBox(stMsgAll & vbCrLf & _
                                       "確定要繼續嗎？" & vbCrLf & _
                                       "是：繼續" & vbCrLf & _
                                       "否：回前畫面", vbInformation + vbYesNo + vbDefaultButton2)
         Else
            stBackData = stMsgAll & "！"
         End If
      End If
      '只查代理人立即回饋訊息,先跳離
      If intChoose = 1 Then
         ChkAgentAndApplySame = bolAgSame
         Set RsQ = Nothing
         Exit Function
      End If
   End If
   
   intE = 0
   If intChoose = 0 Or intChoose = 2 Then
      If stAllApplyNo_Pre = "" Then
         intE = 1
      End If
      '是否同申請人
      For i = intE To 0 Step -1
         strQ = "Select pa26||';'||pa27||';'||pa28||';'||pa29||';'||pa30 as ApplyNo From Patent Where 1=1 " & strWhrP & _
         " Union Select sp08||';'||sp58||';'||sp59||';'||sp65||';'||sp66 as ApplyNo From ServicePractice Where 1=1 " & strWhrS
         intQ = 1
         Set RsQ = ClsLawReadRstMsg(intQ, strQ)
         If intQ = 1 Then
            If i = 1 Then
               stAllApplyNo_Pre = "" & RsQ.Fields("ApplyNo") '前一筆
            Else
               stAllApplyNo = "" & RsQ.Fields("ApplyNo")
            End If
         Else
            '抓前一筆
            If i = 1 Then
               stMsgAll = stCaseNo1_Pre & "-" & stCaseNo2_Pre & IIf(stCaseNo3_Pre & stCaseNo4_Pre = "000", "", stCaseNo3_Pre & "-" & stCaseNo4_Pre)
            Else
               stMsgAll = stCaseNo1 & "-" & stCaseNo2 & IIf(stCaseNo3 & stCaseNo4 = "000", "", stCaseNo3 & "-" & stCaseNo4)
            End If
            stBackData = stMsgAll & " 無此案號資料！"
            Exit For
         End If
      Next i
      If stBackData <> "" Then Set RsQ = Nothing: Exit Function '無案號先跳離
      
      If stAllApplyNo_Pre = stAllApplyNo Then bolApplySame = True
      '只查申請人立即回饋訊息,先跳離
      If intChoose = 2 Then
         ChkAgentAndApplySame = bolApplySame
         Set RsQ = Nothing
         Exit Function
      End If
      
      '代理人與申請人都相同 直接跳離
      If intChoose = 0 And bolAgSame = True And bolApplySame = True Then
         ChkAgentAndApplySame = bolApplySame
         Set RsQ = Nothing
         Exit Function
      End If
       
      'Memo by Amy 參看frm010001.Command1 修改-FG案申請人可能為空 ex:FG-001521,避免第1筆沒申請人,第2筆有申請人不會彈,故只要不同就彈
      stShowMsg1 = "申請人N為「XXXXXXXX」" & vbCrLf
      bolApplySame = True
      arrApplyNo_Pre = Split(stAllApplyNo_Pre, ";")
      For i = LBound(arrApplyNo_Pre) To UBound(arrApplyNo_Pre)
         If InStr(stAllApplyNo, arrApplyNo_Pre(i)) = 0 Then
            bolApplySame = False
         End If
         If arrApplyNo_Pre(i) <> "" Then
            stMsg2 = stMsg2 & ";" & Replace(Replace(stShowMsg1, "N", i + 1), "XXXXXXXX", arrApplyNo_Pre(i))
         End If
      Next i
      If stMsg2 <> "" Then stMsg2 = Mid(stMsg2, 2)
      
      '只查申請人且需判斷內容
      If intChoose = 2 Then
         ChkAgentAndApplySame = bolApplySame
         stMsgAll = "第一筆案號" & stMsg2 & vbCrLf & _
                              stAllCaseNo & "申請人不同"
         If bolApplySame = False Then
            If intMsgType = 1 Then
               stBackData = MsgBox(stMsgAll & vbCrLf & _
                                          "確定要繼續嗎？" & vbCrLf & _
                                          "是：繼續" & vbCrLf & _
                                          "否：回前畫面", vbInformation + vbYesNo + vbDefaultButton2)
            Else
               stBackData = stMsgAll & "！"
            End If
         End If
      Else
         If bolAgSame = False Then stMsgAll = "第一筆案號" & stMsg1
         If bolApplySame = False Then
            If InStr(stMsgAll, "第一筆案號") = 0 Then stMsgAll = "第一筆案號" & vbCrLf
            stMsgAll = stMsgAll & stMsg2
         End If
         stMsgAll = stMsgAll & stAllCaseNo & "不同"
         If intMsgType = 1 Then
            stBackData = MsgBox(stMsgAll & vbCrLf & _
                                    "確定要繼續嗎？" & vbCrLf & _
                                    "是：繼續" & vbCrLf & _
                                    "否：回前畫面", vbInformation + vbYesNo + vbDefaultButton2)
         Else
            stBackData = stMsgAll & "！"
         End If
      End If
   End If
   
End Function

'Added by Lydia 2023/02/21 內專分案作業：是否為寰華案
'Move by Lydia 2025/06/20 從basFunction搬過來
Public Function PUB_GetFMP2toP(ByVal pCP01 As String, ByVal pCP02 As String, ByVal pCP03 As String, ByVal pCP04 As String) As Boolean
Dim intQ As Integer, strQuery As String
Dim rsQD As New ADODB.Recordset
    
    PUB_GetFMP2toP = False
    'PUB_FMPtoCheck(0, 2, Pub_StrUserSt03, pa(1), pa(2), pa(3), pa(4)) '參考用;因為分案時有可能新案尚未發文,所以拿掉發文條件
    strQuery = "select CP01,CP02,CP03,CP04,CP05,CP09,CP10,CP12 from caseprogress  where CP01='" & pCP01 & "' and CP02='" & pCP02 & "' and CP03='" & pCP03 & "' and CP04='" & pCP04 & "' and CP01 in ('P','PS') and CP31='Y' and SUBSTR(CP12,1,1) = 'F' and CP44='Y53374000' "
    intQ = 1
    Set rsQD = ClsLawReadRstMsg(intQ, strQuery)
    If intQ = 1 Then
        PUB_GetFMP2toP = True
    End If
    Set rsQD = Nothing
End Function

'Add by Amy 2025/07/10 傳入案號抓進度中最近的C類CP14工程師
Public Function GetCClassCP14Sql(ByVal stCNo1 As String, ByVal stCNo2 As String, ByVal stCNo3 As String, ByVal stCNo4 As String) As String
   GetCClassCP14Sql = "Select CP09,CP14,ST04,ST02 From CaseProgress,Staff " & _
                     "Where CP01='" & stCNo1 & "' And CP02='" & stCNo2 & "' And CP03='" & stCNo3 & "' And CP04='" & stCNo4 & "' " & _
                     "And CP09>'C' And CP09<'D' And ST03='F21' And CP14=ST01(+) Order by CP09 Desc"
End Function

'Add by Amy 2025/07/28 傳入結案單號 判斷是否有下列資料
'intChoose:1-未付帳款(ccm03=03) /2-後續准駁簡單報告(ccm03=16 /pa89=Y)
Public Function ChkCCD03(intChoose As Integer, ByVal stFormN As String, ByVal stKey As String, Optional ByRef stBackData As String, Optional ByRef stCCD08 As String) As Boolean
   Dim RsQ As New ADODB.Recordset, intQ As Integer, strQ As String, strWhr As String
   
    ChkCCD03 = False: stBackData = "": stCCD08 = ""
    Select Case UCase(stFormN)
      Case "FRM110101_2" '解除期限
         If intChoose = 1 Then
            strWhr = "And CCD03='03' "
         Else
            strWhr = "And CCD03='16' "
         End If
         strWhr = strWhr & "And CCD01='" & stKey & "' And CCD02='2' "
      Case "FRM110103_3" '閉卷
         'Memo 後續准駁簡單報告 -外專目前只做於 解除期限
         'Add by Amy 2025/08/08 未付帳款
         strWhr = "And CCD01='" & stKey & "' And CCD02='2' And CCD03='03' "
      Case UCase("PUB_CloseRestoreLimit"), UCase("PUB_CloseFlowDataDel")
         'Add by Amy 2025/08/08 未付帳款-行事曆 還原
         strWhr = "And CCD01='" & stKey & "' And CCD02='2' And CCD03='03' " & _
                          "And CCD01=SC20(+) And SC20 is not null "
   End Select
   
   'Modify by Amy 2025/08/11 +if PUB_CloseRestoreLimit,PUB_CloseFlowDataDel
   If UCase(stFormN) = UCase("PUB_CloseRestoreLimit") Or UCase(stFormN) = UCase("PUB_CloseFlowDataDel") Then
      strQ = "Select * From CloseCaseDetail,Staff_Calendar Where 1=1 " & strWhr
   '[非] 解除期限 抓 後續准駁簡單報告 資料,需抓 案件基本檔pa89
   ElseIf intChoose = 2 And UCase(stFormN) <> "FRM110101_2" Then
      strQ = "Select * From Patent Where pa89='Y' " & strWhr
   Else
      strQ = "Select * From CloseCaseDetail Where 1=1 " & strWhr
   End If
   intQ = 1
   Set RsQ = ClsLawReadRstMsg(intQ, strQ)
   If intQ = 1 Then
      '未付帳款
      If intChoose = 1 Then
         stBackData = "" & RsQ.Fields("CCD07") '說明
         'Add by Amy 2025/08/08 結案單有勾 未付帳款 及有輸 管制催款日,於外專程序操作完 解除期限/閉卷 後加行事曆
         stCCD08 = "" & RsQ.Fields("CCD08") '管制催款日
         '未付帳款 且 管制催款日 都有值才回傳True
         If stBackData <> "" And stCCD08 <> "" Then
            ChkCCD03 = True
         End If
         'end 2025/08/08
      Else
         ChkCCD03 = True
      End If
   End If
   Set RsQ = Nothing
End Function

'Add by Amy 2025/08/15 顯示 /開啟 請款項目鈕or Show資訊
'intChoose=0-傳入結案單號,設定是否顯示按鈕 /1-傳入案號(有-),開啟 請款項目 資訊
Public Sub Pub_CloseShowfrm210133_INV(intChoose As Integer, stFormN As String, stKey As String, Optional ByRef cmdObj As Object)
   Dim RsQ As New ADODB.Recordset, intQ As Integer, strQ As String, arrCaseNo
   Dim nxtFrm As Form
   
   Select Case UCase(stFormN)
      Case "FRM210133_F" 'FC結案單-承辦用
      Case "FRM210147_1"
      Case "FRM210148_1"
      Case "FRM210149_1"
   End Select
   
   '顯示 請款項目 鈕
   If intChoose = 0 Then
      cmdObj.Visible = False
      strQ = "Select * From CloseCaseMain,CaseProgress Where CCM01='" & stKey & "' And CCM01=CP140(+) "
      intQ = 1
      Set RsQ = ClsLawReadRstMsg(intQ, strQ)
      If intQ = 1 Then
         If "" & RsQ.Fields("CP140") = "" Then cmdObj.Visible = True
      End If
   '開啟 請款項目 資訊
   Else
      arrCaseNo = Split(stKey, "-")
      If PUB_CheckFormExist("frm210133_INV") = True Then
         Unload Forms(0).GetForm("frm210133_INV")
      End If
      'mdiMain的GetForm 可能未寫到,避免程式出錯,Nothing先離開(只是按鈕無作用,程式不會錯)
      If TypeName(Forms(0).GetForm("frm210133_INV")) = "Nothing" Then Exit Sub
      
      Set nxtFrm = Forms(0).GetForm("frm210133_INV")
      nxtFrm.intQuery = 2
      Call nxtFrm.doQuery(arrCaseNo(0), arrCaseNo(1), arrCaseNo(2), arrCaseNo(3))
      nxtFrm.Show
      nxtFrm.ZOrder 0
   End If
End Sub

'Add by Amy 2025/08/18 解除期限 或 閉卷 開Ourlook通知信-外商用
Public Function Pub_CloseOutLook_T(ByVal stFormN As String, ByVal stCCM01 As String, ByVal stCNo1 As String, ByVal stCNo2 As String, ByVal stCNo3 As String, ByVal stCNo4 As String, _
  ByVal stNation As String, ByVal stCP10 As String, stType As String, ByRef stMsg As String) As Boolean
   Dim strCP10n As String, strSales As String, strSalesST52 As String
   Dim objOutLook As Object, objMail As Object
   Dim strTo As String, strCC As String, strAttach As String, strSubject As String, strContent As String
      
    Select Case UCase(stFormN)
      Case "FRM110101_2" '解除期限
      Case "FRM110103_3" '閉卷
   End Select
   
   Pub_CloseOutLook_T = False: stMsg = ""
   strCP10n = GetCaseTypeName(stCNo1, stCP10, 0)
   
   strSales = ShowCurrCP13(stCNo1, stCNo2, stCNo3, stCNo4, stNation) '承辦人員
   strSalesST52 = PUB_GetFCPProSup(strSales) 'FC承辦人員2級主管
  
   
   strTo = strSales  '承辦人員
   If strTo <> strSalesST52 And strSalesST52 <> "" Then strCC = strSalesST52 & ";" '承辦主管
   strCC = strCC & "backup" 'backup寫於最後-Sindy
   'To:承辦內文(放空值,由人員自行輸入-湘)
   strContent = ""
   
   '有內容及收件者才需要呼叫Outlook草稿
   If strTo <> "" Then
      '呼叫新郵件：
      Set objOutLook = CreateObject("Outlook.Application")
      Set objMail = objOutLook.CreateItem(0)
      
      strSubject = "【" & strCP10n & "請款】" & _
                              "Our Ref: " & stCNo1 & "-" & stCNo2 & IIf(stCNo3 & stCNo4 = "000", "", "-" & stCNo3 & "-" & stCNo4) & _
                              " [INCOM]"
      '轉HTML格式
      strContent = Replace(strContent, "新細明體", "Times New Roman")
      '&nbsp; 不換行空格 /&thinsp; 窄空格/空白&nbsp; /&emsp; 全形空格/&ensp; 半形空格
      
      With objMail
         .To = strTo
         .cc = strCC
         If strAttach <> "" Then
            .Attachments.add strAttach '加附件
         End If
         .Subject = strSubject
         .HTMLBody = strContent
         .Display
      End With
      
      Pub_CloseOutLook_T = True '草稿產生成功
      Set objMail = Nothing
      Set objOutLook = Nothing
   End If
End Function

'Add by Amy 2025/08/27 判斷是否有FC代理人
'判斷是否有FC代理人,回傳0-無FC代理人 /1-有FC代理人 /9-無此案號/98-不進[國外]結案單/99-不進[國內]結案單
Public Function Pub_ChkFCAg(ByVal stFormN As String, ByVal stCNo1 As String, stCNo2 As String, stCNo3 As String, stCNo4 As String _
, ByRef stClose As String, ByRef stMsg As String) As Integer
   Dim RsQ As New ADODB.Recordset, intQ As Integer, intAns As Integer
   Dim stQ As String, stMsg_Fix1 As String, stMsg_Fix2 As String, stNation As String
   
   Select Case UCase(stFormN)
      Case "MDIMAIN"
         stMsg_Fix1 = ",不會沖銷信件"
         stMsg_Fix2 = "回系統收件區"
      Case "FRM210133_2" '案號輸入
         stMsg_Fix2 = "回案號輸入畫面"
   End Select
   
   Pub_ChkFCAg = 0
   stClose = "": stMsg = ""
   stQ = "Select CaseN,A.NA03 as ApplyNation,Nation,sClose,CU10" & _
               ",sApply,NVL(CU04,Decode(CU05,null,CU06,CU05||' '||CU88||' '||CU89||' '||CU90)) as CName,CU10,C.NA03 as CNA03" & _
               ",FCAg,Decode(FA05,null,Nvl(FA04,FA06),FA05||' '||FA63||' '||FA64||' '||FA65) as AName,FA10,F.NA03 as FNA03 " & _
               "From(" & _
                         "Select TM05||TM06||TM07 as CaseN,TM23 as sApply,TM10 as Nation,TM29 as sClose,TM44 as FCAg From Trademark " & _
                         "Where TM01='" & stCNo1 & "' And TM02='" & stCNo2 & "' And TM03='" & stCNo3 & "' And TM04='" & stCNo4 & "' " & _
            "Union Select SP05||SP06||SP07 as CaseN,SP08 as sApply,SP09 as Nation,SP15 as sClose,SP26 as FCAg From Servicepractice " & _
                         "Where SP01='" & stCNo1 & "' And SP02='" & stCNo2 & "' And SP03='" & stCNo3 & "' And SP04='" & stCNo4 & "' " & _
            "),Nation A,Customer,Nation C,Nation F,FAgent " & _
            "Where SubStr(sApply,1,8)=CU01(+) And Decode(SubStr(sApply,9,1),'','0',SubStr(sApply,9,1))=CU02(+) And CU10=C.NA01(+) " & _
            "And SubStr(FCAg,1,8)=FA01(+) And Decode(SubStr(FCAg,9,1),'','0',SubStr(FCAg,9,1))=FA02(+) And FA10=F.NA01(+) " & _
            "And Nation=A.NA01(+) "
   intQ = 1
   Set RsQ = ClsLawReadRstMsg(intQ, stQ)
   If intQ = 1 Then
      If "" & RsQ.Fields("FCAg") <> "" Then Pub_ChkFCAg = 1
      stClose = "" & RsQ.Fields("sClose")
      stNation = "" & RsQ.Fields("Nation")
   Else
      Pub_ChkFCAg = 9
   End If
   
   If Pub_ChkFCAg = 9 Then
      stMsg = "無此案號！"
   ElseIf stClose = "Y" Then
      stMsg = "此案號已閉卷！"
   '[無]FC代理人 且為 FCT or S台灣案
   ElseIf Pub_ChkFCAg = 0 And (stCNo1 = "FCT" Or (stCNo1 = "S" And stNation = "000")) Then
      '外商承辦之案件都會有FC代理人,故國內結案單程式不修改,[無]FC代理人再看到時情況該如何處理-秀玲
      '秀玲:印紙本 讓程序補上 FC代理人,且信件不沖銷代表異常,讓User操作變麻煩才有警覺
      intAns = MsgBox("此案號無FC代理人" & stMsg_Fix1 & vbCrLf & _
                                 "確定進入[國內結案單]畫面印結案單？" & vbCrLf & _
                                 "是：進入國內結案單畫面" & vbCrLf & _
                                 "否：" & stMsg_Fix2, vbYesNo + vbDefaultButton2 + vbQuestion)
      If intAns = vbNo Then
         Pub_ChkFCAg = 99 '不進國內結案單
      End If
   '[有]FC代理人
   ElseIf Pub_ChkFCAg = 1 And (stCNo1 = "CFT" Or stCNo1 = "CFC" Or (stCNo1 = "S" And stNation <> "000")) Then
      intAns = MsgBox("此案號有FC代理人" & stMsg_Fix1 & vbCrLf & _
                                 "確定進入[國外結案單]？" & vbCrLf & _
                                 "【註】簽核人員與國內結案單不同" & vbCrLf & _
                                 "是：進入國外結案單畫面" & vbCrLf & _
                                 "否：" & stMsg_Fix2, vbYesNo + vbDefaultButton2 + vbQuestion)
      If intAns = vbNo Then
         Pub_ChkFCAg = 98 '不進國外結案單
      End If
   End If
   Set RsQ = Nothing
End Function

'Add by Amy 2025/10/01 請款項目設定顏色
'intChoose:0-還原顏色/1-讀取CCM資料設定顏色/2-比對不同設定顏色(單筆)/9-抓全部 資料
Public Sub Pub_CloseSetA1KDataColor(intChoose As Integer, stFormN As String, stCaseNo1 As String, stCaseNo2 As String, stCaseNo3 As String, stCaseNo4 As String, stNP07 As String, _
 TxtCtrl As Variant, TxtNo1 As Integer, TxtNo2 As Integer)
   Dim ii As Integer, intS As Integer, intE As Integer, stData As String
   Dim o_A1K04 As String, o_A1K27 As String, o_A1K28 As String, o_A1K29 As String, o_TM56 As String, o_TM69 As String '目前系統設定

   Select Case UCase(stFormN)
      Case "FRM210133_F" 'FC結案單-承辦用
      Case "FRM210147_1"
      Case "FRM210148_1"
      Case "FRM210149_1"
   End Select
   
   If intChoose <> 0 Then
      Call Pub_GetCloseA1KData(1, stFormN, stCaseNo1, stCaseNo2, stCaseNo3, stCaseNo4, o_A1K29, stNP07, o_A1K04, o_A1K27, o_A1K28, o_TM56, o_TM69)
   End If
   '抓全部 資料
   If intChoose = 9 Then
      TxtCtrl(0) = o_A1K29 '帳款已清
      TxtCtrl(1) = o_A1K04 '列印申請人
      TxtCtrl(2) = "" '合併列印請款單
      TxtCtrl(3) = o_A1K28 '請款對象
      TxtCtrl(4) = o_TM56 '固定請款對象
      TxtCtrl(5) = o_A1K27 '列印對象
      TxtCtrl(6) = o_TM69 '固定列印對象
   ElseIf intChoose = 0 Then
      For ii = TxtNo1 To TxtNo2
         TxtCtrl(ii).BackColor = &H80000005
      Next ii
   Else
      For ii = TxtNo1 To TxtNo2
         Select Case ii
            Case 1 '列印申請人
               stData = o_A1K04
            Case 2 '合併列印請款單
               stData = ""
            Case 3 '請款對象
               stData = o_A1K28
            Case 4 '固定請款對象
               stData = o_TM56
            Case 5 '列印對象
               stData = o_A1K27
            Case 6 '固定列印對象
               stData = o_TM69
         End Select
         TxtCtrl(ii).BackColor = &H80000005
         '資料與目前不同,顯示顏色
         If TxtCtrl(ii) <> stData And TxtCtrl(ii) <> "" Then
             TxtCtrl(ii).BackColor = &HC0C0FF
         End If
      Next ii
   End If
End Sub

'Added by Lydia 2019/01/10 判斷新申請案發文日
Public Function Pub_GetCP31toCP27(ByVal pN01 As String, ByVal pN02 As String, ByVal pN03 As String, ByVal pN04 As String) As String
Dim strC1 As String
Dim intC As Integer
Dim rsC As New ADODB.Recordset

    If pN01 = "" Or pN02 = "" Then Exit Function
    
    strC1 = "select cp09, cp27 from caseprogress where cp01='" & pN01 & "' and cp02= '" & pN02 & "' and cp03='" & Left(pN03 & "0", 1) & "' and cp04='" & Left(pN04 & "00", 2) & "' " & _
               " and cp10 in (" & GetAddStr(NewCasePtyList) & ") and cp159=0 "
    intC = 1
    Set rsC = ClsLawReadRstMsg(intC, strC1)
    If intC = 1 Then
       Pub_GetCP31toCP27 = "" & rsC.Fields("cp27")
    End If
    Set rsC = Nothing
End Function

'Add by Amy 2025/11/12 將Acc21H0.AdodcRefresh 語法搬過來共用
'stChoose-0:抓取目前未請款資料/1:抓取結案單請款項目/1.1結案單請款項目只有 703 or 704/2:比對結案單及國外請款資料 請款項目前3碼總金額
Public Function GetAcc21H0Sql(ByVal stChoose As String, ByVal stFormN As String, stF0301 As String, Optional ByVal stCaseNo As String = "", _
  Optional ByVal stCP10 As String = "", Optional ByVal stWhr As String = "", Optional ByVal stInvNo As String = "", Optional ByVal stItemNo As String) As String
   Dim stFixWhr As String, stFixWhr2 As String, stField As String, arrCaseNo
   
   stField = ""
   Select Case UCase(stFormN)
      Case "PUB_OPEN21H0" '函數
         If stChoose = "0" Then
            stField = "cp140,"
         End If
      Case "FRMACC21H0" '請款單輸入
      Case "FRMACC21H1", "CHKANDSETCCDITEM" '請款單內容
   End Select
   
   If stChoose = "0" Then
      If InStr(stCaseNo, "-") > 0 Then arrCaseNo = Split(stCaseNo, "-")
   
      stFixWhr = "And CP01='" & arrCaseNo(0) & "' And CP02='" & arrCaseNo(1) & "' And CP03='" & arrCaseNo(2) & "' And CP04='" & arrCaseNo(3) & "' "
      stFixWhr2 = "CP01=PA01 And CP02=PA02 And CP03=PA03 And CP04=PA04 "
      '2007/7/4 MODIFY BY SONIA 201 加 CP57 IS NULL
      '2007/10/11 modify by sonia 加210同201未發文也可請款
      '2007/12/4  modify by sonia 加209,223同201未發文也可請款
      'Modify by Morgan 2011/3/25 +P 案未發文也可請款
      '2011/6/17 modify by sonia FCT的601異議未發文也可請款
      '2012/1/5 modify by sonia +CFP 案未發文也可請款
      '2015/1/6 modify by sonia +外商收文A類有收費者都可未發文請款
      'Modified by Lydia 2015/10/05  + 1008
      'Modified by Morgan 2019/8/8 decode(pa09, '020', cpm04, cpm03)->decode(pa09, '000', cpm03, cpm04) ,Ex:香港 110標準專利紀錄請求
      'Modified by Morgan 2019/12/11 加926未發文也可請款--葉敏莉
      'Modified by Morgan 2019/12/13 +cp10
      'Modified by Morgan 2021/4/16 +GetRelateCasePropertyName
      'Modify by Amy 2025/10/02 從Acc21H0.AdodcRefresh 語法搬過來微調(加stFixWhr/stFixWhr2/stField)
      GetAcc21H0Sql = "select " & stField & "cp09, nvl(cp05 - 19110000, 0) Rdate, decode(pa09, '000', cpm03, cpm04)||Decode(CP10,'1001',A.A1,'1002',A.A1,'1008',A.A1,'')||GetRelateCasePropertyName(cp09,'1') as cpm03, st02, nvl(pa75,pa26) as pa75, cp45, nvl(cp27 - 19110000, 0) Sdate, cp60, cp01, cp02, cp03, cp04, cp17, cp16, cp05,cp10 " & _
                           "From Patent,caseprogress,  casepropertymap, staff, nation, (Select ' - '||decode(pa09, '000', cpm03, cpm04) As A1, CP09 As A2 From Patent, Caseprogress, CasePropertyMap Where " & stFixWhr2 & "And CP01=CPM01 And CP10=CPM02 " & Replace(stFixWhr, "CP", "PA") & ") A " & _
                           "Where " & stFixWhr2 & "and cp01 = cpm01 and cp10 = cpm02 and cp14 = st01 (+) and pa09 = na01 (+) And CP43=A.A2(+) " & stFixWhr & " and (cp60 is null or cp60 = '') and (cp27 is not null and cp27 <> 0) and cp20 is null  union " & _
            "select " & stField & "cp09, nvl(cp05 - 19110000, 0) Rdate, decode(pa09, '000', cpm03, cpm04)||Decode(CP10,'1001',A.A1,'1002',A.A1,'1008',A.A1,'')||GetRelateCasePropertyName(cp09,'1') as cpm03, st02, nvl(pa75,pa26) as pa75, cp45, nvl(cp27 - 19110000, 0) Sdate, cp60, cp01, cp02, cp03, cp04, cp17, cp16, cp05,cp10 " & _
                           "From Patent,caseprogress,  casepropertymap, staff, nation, (Select ' - '||decode(pa09, '000', cpm03, cpm04) As A1, CP09 As A2 From Patent, Caseprogress, CasePropertyMap Where " & stFixWhr2 & "And CP01=CPM01 And CP10=CPM02 " & Replace(stFixWhr, "CP", "PA") & ") A " & _
                           "Where " & stFixWhr2 & "and cp01 = cpm01 and cp10 = cpm02 and cp14 = st01 (+) and pa09 = na01 (+) And CP43=A.A2(+) " & stFixWhr & " and (cp60 is null or cp60 = '') and ((((cp01='P' or cp01='CFP') and substr(nvl(cp12,'S'),1,1)<>'F') or cp10 = '201' or cp10 = '209' or cp10 = '210' or cp10 = '223' or cp10 = '926') and cp27 is null AND CP57 IS NULL) and cp20 is null union " & _
            "select " & stField & "cp09, nvl(cp05 - 19110000, 0) Rdate, decode(tm10, '000', cpm03, cpm04)||Decode(CP10,'1001',A.A1,'1002',A.A1,'1003',A.A1,'1004',A.A1,'1008',A.A1,'')||GetRelateCasePropertyName(cp09,'1') as cpm03, st02, nvl(tm44,tm23) as pa75, cp45, nvl(cp27 - 19110000, 0) Sdate, cp60, cp01, cp02, cp03, cp04, cp17, cp16, cp05,cp10 " & _
                           "From Trademark,caseprogress,  casepropertymap, staff, nation, (Select ' - '||decode(tm10, '000', cpm03, cpm04) As A1, CP09 As A2 From Trademark, Caseprogress, CasePropertyMap Where " & Replace(stFixWhr2, "PA", "TM") & "And CP01=CPM01 And CP10=CPM02 " & Replace(stFixWhr, "CP", "TM") & ") A " & _
                           "Where " & Replace(stFixWhr2, "PA", "TM") & "and cp01 = cpm01 and cp10 = cpm02 and cp14 = st01 (+) and tm10 = na01 (+) And CP43=A.A2(+) " & stFixWhr & " and (cp60 is null or cp60 = '') and (cp27 is not null and cp27 <> 0) and cp20 is null  union " & _
            "select " & stField & "cp09, nvl(cp05 - 19110000, 0) Rdate, decode(tm10, '000', cpm03, cpm04)||Decode(CP10,'1001',A.A1,'1002',A.A1,'1003',A.A1,'1004',A.A1,'1008',A.A1,'')||GetRelateCasePropertyName(cp09,'1') as cpm03, st02, nvl(tm44,tm23) as pa75, cp45, nvl(cp27 - 19110000, 0) Sdate, cp60, cp01, cp02, cp03, cp04, cp17, cp16, cp05,cp10 " & _
                           "From Trademark,caseprogress, casepropertymap, staff, nation, (Select ' - '||decode(tm10, '000', cpm03, cpm04) As A1, CP09 As A2 From Trademark, Caseprogress, CasePropertyMap Where " & Replace(stFixWhr2, "PA", "TM") & "And CP01=CPM01 And CP10=CPM02 " & Replace(stFixWhr, "CP", "TM") & ") A " & _
                           "Where " & Replace(stFixWhr2, "PA", "TM") & "and cp01 = cpm01 and cp10 = cpm02 and cp14 = st01 (+) and tm10 = na01 (+) And CP43=A.A2(+) " & stFixWhr & " and (cp60 is null or cp60 = '') and (cp01='FCT' and cp10 = '601') and cp27 is null AND CP57 IS NULL and cp20 is null  union " & _
            "select " & stField & "cp09, nvl(cp05 - 19110000, 0) Rdate, decode(tm10, '000', cpm03, cpm04)||Decode(CP10,'1001',A.A1,'1002',A.A1,'1003',A.A1,'1004',A.A1,'1008',A.A1,'')||GetRelateCasePropertyName(cp09,'1') as cpm03, st02, nvl(tm44,tm23) as pa75, cp45, nvl(cp27 - 19110000, 0) Sdate, cp60, cp01, cp02, cp03, cp04, cp17, cp16, cp05,cp10 " & _
                           "From Trademark,caseprogress, casepropertymap, staff, nation, (Select ' - '||decode(tm10, '000', cpm03, cpm04) As A1, CP09 As A2 From Trademark, Caseprogress, CasePropertyMap Where " & Replace(stFixWhr2, "PA", "TM") & "And CP01=CPM01 And CP10=CPM02 " & Replace(stFixWhr, "CP", "TM") & ") A " & _
                           "Where " & Replace(stFixWhr2, "PA", "TM") & "and cp01 = cpm01 and cp10 = cpm02 and cp14 = st01 (+) and tm10 = na01 (+) And CP43=A.A2(+) " & stFixWhr & " and (cp60 is null or cp60 = '') and (substr(cp12,1,2)='F1' and cp09<'B' and nvl(cp16,0)>0) AND CP57 IS NULL and cp20 is null  union " & _
            "select " & stField & "cp09, nvl(cp05 - 19110000, 0) Rdate, decode(lc15, '000', cpm03, cpm04)||GetRelateCasePropertyName(cp09,'1') as cpm03, st02, nvl(lc22,lc11) as pa75, cp45, nvl(cp27 - 19110000, 0) Sdate, cp60, cp01, cp02, cp03, cp04, cp17, cp16, cp05,cp10 " & _
                           "From Lawcase,caseprogress,  casepropertymap, staff, nation " & _
                           "Where " & Replace(stFixWhr2, "PA", "LC") & "and cp01 = cpm01 and cp10 = cpm02 and cp14 = st01 (+) and lc15 = na01 (+) " & stFixWhr & " and (cp60 is null or cp60 = '') and (cp27 is not null and cp27 <> 0) and cp20 is null  union " & _
            "select " & stField & "cp09, nvl(cp05 - 19110000, 0) Rdate, decode(sp09, '000', cpm03, cpm04)||GetRelateCasePropertyName(cp09,'1') as cpm03, st02, nvl(sp26,sp08) as pa75, cp45, nvl(cp27 - 19110000, 0) Sdate, cp60, cp01, cp02, cp03, cp04, cp17, cp16, cp05,cp10 " & _
                           "From Servicepractice,caseprogress,  casepropertymap, staff, nation " & _
                           "Where " & Replace(stFixWhr2, "PA", "SP") & "and cp01 = cpm01 and cp10 = cpm02 and cp14 = st01 (+) and sp09 = na01 (+) " & stFixWhr & " and (cp60 is null or cp60 = '') and (cp27 is not null and cp27 <> 0) and cp20 is null  union " & _
            "select " & stField & "cp09, nvl(cp05 - 19110000, 0) Rdate, decode(sp09, '000', cpm03, cpm04)||GetRelateCasePropertyName(cp09,'1') as cpm03, st02, nvl(sp26,sp08) as pa75, cp45, nvl(cp27 - 19110000, 0) Sdate, cp60, cp01, cp02, cp03, cp04, cp17, cp16, cp05,cp10 " & _
                           "From Servicepractice,caseprogress,  casepropertymap, staff, nation " & _
                           "Where " & Replace(stFixWhr2, "PA", "SP") & "and cp01 = cpm01 and cp10 = cpm02 and cp14 = st01 (+) and sp09 = na01 (+) " & stFixWhr & " and (cp60 is null or cp60 = '') and (substr(cp12,1,2)='F1' and cp09<'B' and nvl(cp16,0)>0) and cp20 is null "
            
            If UCase(stFormN) = "FRMACC21H0" Then GetAcc21H0Sql = GetAcc21H0Sql & "order by cp05 desc, cp09 desc"
   '抓傳入請款項目前3碼(stCP10)取得結案單請款項目
   ElseIf Left(stChoose, 1) = "1" Then
      stFixWhr = "And CCD01='" & stF0301 & "' And CCD02='1' "
      If UCase(stFormN) = "PUB_OPEN21H0" Then
         If stCP10 = "703" Or stCP10 = "704" Then
            GetAcc21H0Sql = "Select CCD01,'" & stCP10 & "' as CCD04,Sum(CCD05) as Total,1 as Sort From CloseCaseDetail " & _
                                             "Where 1=1 " & stFixWhr & "And (SubStr(CCD04,1,3)='" & stCP10 & "' Or length(CCD04)<3) Group by ccd01 "
         End If
      ElseIf UCase(stFormN) = "FRMACC21H1" Or UCase(stFormN) = "CHKANDSETCCDITEM" Then
         '只有請1道且不是703/704
         If stChoose = "1.1" Then
            GetAcc21H0Sql = "Select * From CloseCaseDetail " & _
                                             "Where 1=1 " & stFixWhr & " " & stWhr & _
                                             "And Not Exists(Select * From CloseCaseDetail Where 1=1 " & stFixWhr & " And (SubStr(CCD04,1,3)='703' Or SubStr(CCD04,1,3)='704') ) "
         '102-延期會自動產生請款項目[02],避免結案單 703/704 也請[02],故結案單2碼項目算於 703/704金額中,以利比對案件性質之總金額
         ElseIf stCP10 = "703" Or stCP10 = "704" Then
            GetAcc21H0Sql = "Select * From CloseCaseDetail " & _
                                             "Where 1=1 " & stFixWhr & " And (SubStr(CCD04,1,3)='" & stCP10 & "' Or Length(CCD04)<3) " & stWhr
         ElseIf UCase(stFormN) = "CHKANDSETCCDITEM" Then
            GetAcc21H0Sql = "Select * From CloseCaseDetail " & _
                                             "Where 1=1 " & stFixWhr & " And Substr(CCD04,1,3)='" & stCP10 & "' And Length(CCD04)>=3 " & stWhr
         Else
             GetAcc21H0Sql = "Select * From CloseCaseDetail,CaseProgress " & _
                                             "Where 1=1 " & stFixWhr & " And Substr(CCD04,1,3)='" & stCP10 & "' And Length(CCD04)>=3 " & _
                                             "And ccd04=cp10 " & stWhr
         End If
         If stChoose <> "1.1" Then GetAcc21H0Sql = GetAcc21H0Sql & "Order by Decode(length(CCD04),3,1,2) "
      End If
   '比對結案單及國外請款資料 請款項目前3碼總金額
   ElseIf stChoose = "2" Then
      stFixWhr = "And CCD01='" & stF0301 & "' And CCD02='1' "
      If stCP10 = "703" Or stCP10 = "704" Then
         stWhr = stFixWhr & "And (SubStr(CCD04,1,3)='" & stCP10 & "' Or length(CCD04)<3) "
      Else
         stWhr = stFixWhr & "And SubStr(CCD04,1,3)='" & stCP10 & "' "
      End If
      stFixWhr2 = "And A1L01='" & stInvNo & "' "
      
      GetAcc21H0Sql = "Select CCDAmt,A1LAmt From " & _
                                             "(Select '" & stCP10 & "' as cp10,Sum(CCD05) as CCDAmt From CloseCaseDetail " & _
                                             "Where 1=1 " & stWhr & " )" & _
                                             ",(Select '" & stCP10 & "' as ItemNo,Sum(A1L05) as A1LAmt From Acc1L0 " & _
                                             "Where A1L02 in('" & Replace(stItemNo, ",", "','") & "') " & stFixWhr2 & ") " & _
                                         "Where cp10=ItemNo(+) "
   End If
End Function

'Add by Amy 2025/11/12 以[國外結案單]請款項目 比對 國外請款資料 請款項目總金額不相同
'stChoose:0-全部總額 /1-比對請款項目前3碼
Public Function ChkCCDAndAcc1L0NotSame(stChoose As String, ByVal stForm As String, ByVal stF0301 As String, ByVal stInvNo As String, ByRef stBackMsg As String _
, Optional ByVal stItem As String, Optional ByVal stCP10 As String) As Boolean
   Dim RsQ As New ADODB.Recordset, intQ As Integer, strQ As String
   
On Error GoTo ErrHand

   ChkCCDAndAcc1L0NotSame = False
'*** 全部總額 ***
   If stChoose = "0" Then
      strQ = "Select * From(Select Sum(A1L05) as A1L05 From Acc1L0 Where A1l01='" & stInvNo & "' )" & _
                                        ",(Select Sum(ccd05) As ccd05 From Closecasedetail Where ccd01='" & stF0301 & "' And ccd02='1' ) "
      intQ = 1
      Set RsQ = ClsLawReadRstMsg(intQ, strQ)
      If intQ = 1 Then
         If Val("" & RsQ.Fields("A1L05")) <> Val(RsQ.Fields("CCD05")) Then
            stBackMsg = "．結案單請款項目總額與請款單總金額與不符"
         End If
      End If
   End If
'*** End 全部總額 ***
  
 '*** 比對請款項目前3碼 ***
   If stChoose = "1" Then
      '102-延期會自動產生請款項目[02],避免結案單 703/704 也請[02],故結案單2碼項目算於 703/704金額中,以利比對案件性質之總金額
      strQ = GetAcc21H0Sql("2", "ChkCCDAndAcc1L0NotSame", stF0301, , stCP10, , stInvNo, stItem)
      intQ = 1
      Set RsQ = ClsLawReadRstMsg(intQ, strQ)
      If intQ = 1 Then
         If "" & RsQ.Fields("CCDAmt") <> "" & RsQ.Fields("A1LAmt") Then
            If stCP10 = "703" Or stCP10 = "704" Then
   
            '不是 703/704 回傳訊息
            Else
               ChkCCDAndAcc1L0NotSame = True
               stBackMsg = "．" & stCP10 & "-" & "結案單金額->" & RsQ.Fields("CCDAmt") & ";進度檔金額->" & RsQ.Fields("A1LAmt")
            End If
         End If
      End If
   End If
'*** End 比對請款項目前3碼 ***

ErrHand:
   If Err.Number <> 0 Then
      ChkCCDAndAcc1L0NotSame = True
      stBackMsg = "ChkCCDAndAcc1L0NotSame 函數有誤-案件性質(" & stCP10 & ")" & vbCrLf & _
                              Err.Description & vbCrLf & "請洽電腦中心"
   End If
   Set RsQ = Nothing
End Function

